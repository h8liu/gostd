<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword">package</span>&nbsp;<span class="ident">cipher</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">import</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;errors&#34;</span><br>
<span class="lineno">10</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;AEAD&nbsp;is&nbsp;a&nbsp;cipher&nbsp;mode&nbsp;providing&nbsp;authenticated&nbsp;encryption&nbsp;with&nbsp;associated</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">AEAD</span>&nbsp;<span class="keyword">interface</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;NonceSize&nbsp;returns&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;nonce&nbsp;that&nbsp;must&nbsp;be&nbsp;passed&nbsp;to&nbsp;Seal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;and&nbsp;Open.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">NonceSize</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Overhead&nbsp;returns&nbsp;the&nbsp;maximum&nbsp;difference&nbsp;between&nbsp;the&nbsp;lengths&nbsp;of&nbsp;a</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;plaintext&nbsp;and&nbsp;ciphertext.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Overhead</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Seal&nbsp;encrypts&nbsp;and&nbsp;authenticates&nbsp;plaintext,&nbsp;authenticates&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;additional&nbsp;data&nbsp;and&nbsp;appends&nbsp;the&nbsp;result&nbsp;to&nbsp;dst,&nbsp;returning&nbsp;the&nbsp;updated</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;slice.&nbsp;The&nbsp;nonce&nbsp;must&nbsp;be&nbsp;NonceSize()&nbsp;bytes&nbsp;long&nbsp;and&nbsp;unique&nbsp;for&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;time,&nbsp;for&nbsp;a&nbsp;given&nbsp;key.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;plaintext&nbsp;and&nbsp;dst&nbsp;may&nbsp;alias&nbsp;exactly&nbsp;or&nbsp;not&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Seal</span><span class="op">(</span><span class="ident">dst</span><span class="op">,</span>&nbsp;<span class="ident">nonce</span><span class="op">,</span>&nbsp;<span class="ident">plaintext</span><span class="op">,</span>&nbsp;<span class="ident">data</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Open&nbsp;decrypts&nbsp;and&nbsp;authenticates&nbsp;ciphertext,&nbsp;authenticates&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;additional&nbsp;data&nbsp;and,&nbsp;if&nbsp;successful,&nbsp;appends&nbsp;the&nbsp;resulting&nbsp;plaintext</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;to&nbsp;dst,&nbsp;returning&nbsp;the&nbsp;updated&nbsp;slice.&nbsp;The&nbsp;nonce&nbsp;must&nbsp;be&nbsp;NonceSize()</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;bytes&nbsp;long&nbsp;and&nbsp;both&nbsp;it&nbsp;and&nbsp;the&nbsp;additional&nbsp;data&nbsp;must&nbsp;match&nbsp;the</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;value&nbsp;passed&nbsp;to&nbsp;Seal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;ciphertext&nbsp;and&nbsp;dst&nbsp;may&nbsp;alias&nbsp;exactly&nbsp;or&nbsp;not&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Open</span><span class="op">(</span><span class="ident">dst</span><span class="op">,</span>&nbsp;<span class="ident">nonce</span><span class="op">,</span>&nbsp;<span class="ident">ciphertext</span><span class="op">,</span>&nbsp;<span class="ident">data</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;gcmFieldElement&nbsp;represents&nbsp;a&nbsp;value&nbsp;in&nbsp;GF(2¹²⁸).&nbsp;In&nbsp;order&nbsp;to&nbsp;reflect&nbsp;the&nbsp;GCM</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;standard&nbsp;and&nbsp;make&nbsp;getUint64&nbsp;suitable&nbsp;for&nbsp;marshaling&nbsp;these&nbsp;values,&nbsp;the&nbsp;bits</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;are&nbsp;stored&nbsp;backwards.&nbsp;For&nbsp;example:</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;the&nbsp;coefficient&nbsp;of&nbsp;x⁰&nbsp;can&nbsp;be&nbsp;obtained&nbsp;by&nbsp;v.low&nbsp;&gt;&gt;&nbsp;63.</span><br>
<span class="lineno">45</span><span class="comment">//&nbsp;&nbsp;&nbsp;the&nbsp;coefficient&nbsp;of&nbsp;x⁶³&nbsp;can&nbsp;be&nbsp;obtained&nbsp;by&nbsp;v.low&nbsp;&amp;&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;the&nbsp;coefficient&nbsp;of&nbsp;x⁶⁴&nbsp;can&nbsp;be&nbsp;obtained&nbsp;by&nbsp;v.high&nbsp;&gt;&gt;&nbsp;63.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;the&nbsp;coefficient&nbsp;of&nbsp;x¹²⁷&nbsp;can&nbsp;be&nbsp;obtained&nbsp;by&nbsp;v.high&nbsp;&amp;&nbsp;1.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">gcmFieldElement</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">low</span><span class="op">,</span>&nbsp;<span class="ident">high</span>&nbsp;<span class="ident">uint64</span><br>
<span class="lineno">50</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;gcm&nbsp;represents&nbsp;a&nbsp;Galois&nbsp;Counter&nbsp;Mode&nbsp;with&nbsp;a&nbsp;specific&nbsp;key.&nbsp;See</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;http://csrc.nist.gov/groups/ST/toolkit/BCM/documents/proposedmodes/gcm/gcm-revised-spec.pdf</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">gcm</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cipher</span>&nbsp;<span class="ident">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;productTable&nbsp;contains&nbsp;the&nbsp;first&nbsp;sixteen&nbsp;powers&nbsp;of&nbsp;the&nbsp;key,&nbsp;H.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;However,&nbsp;they&nbsp;are&nbsp;in&nbsp;bit&nbsp;reversed&nbsp;order.&nbsp;See&nbsp;NewGCM.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">productTable</span>&nbsp;<span class="op">[</span><span class="num">16</span><span class="op">]</span><span class="ident">gcmFieldElement</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;NewGCM&nbsp;returns&nbsp;the&nbsp;given&nbsp;128-bit,&nbsp;block&nbsp;cipher&nbsp;wrapped&nbsp;in&nbsp;Galois&nbsp;Counter&nbsp;Mode.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">NewGCM</span><span class="op">(</span><span class="ident">cipher</span>&nbsp;<span class="ident">Block</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">AEAD</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">cipher</span><span class="op">.</span><span class="ident">BlockSize</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">gcmBlockSize</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;cipher:&nbsp;NewGCM&nbsp;requires&nbsp;128-bit&nbsp;block&nbsp;cipher&#34;</span><span class="op">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">key</span>&nbsp;<span class="op">[</span><span class="ident">gcmBlockSize</span><span class="op">]</span><span class="builtintype">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cipher</span><span class="op">.</span><span class="ident">Encrypt</span><span class="op">(</span><span class="ident">key</span><span class="op">[</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">key</span><span class="op">[</span><span class="op">:</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">g</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">gcm</span><span class="op">{</span><span class="ident">cipher</span><span class="op">:</span>&nbsp;<span class="ident">cipher</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;We&nbsp;precompute&nbsp;16&nbsp;multiples&nbsp;of&nbsp;|key|.&nbsp;However,&nbsp;when&nbsp;we&nbsp;do&nbsp;lookups</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;into&nbsp;this&nbsp;table&nbsp;we&#39;ll&nbsp;be&nbsp;using&nbsp;bits&nbsp;from&nbsp;a&nbsp;field&nbsp;element&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;therefore&nbsp;the&nbsp;bits&nbsp;will&nbsp;be&nbsp;in&nbsp;the&nbsp;reverse&nbsp;order.&nbsp;So&nbsp;normally&nbsp;one</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;would&nbsp;expect,&nbsp;say,&nbsp;4*key&nbsp;to&nbsp;be&nbsp;in&nbsp;index&nbsp;4&nbsp;of&nbsp;the&nbsp;table&nbsp;but&nbsp;due&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;this&nbsp;bit&nbsp;ordering&nbsp;it&nbsp;will&nbsp;actually&nbsp;be&nbsp;in&nbsp;index&nbsp;0010&nbsp;(base&nbsp;2)&nbsp;=&nbsp;2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">x</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">gcmFieldElement</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">getUint64</span><span class="op">(</span><span class="ident">key</span><span class="op">[</span><span class="op">:</span><span class="num">8</span><span class="op">]</span><span class="op">)</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">getUint64</span><span class="op">(</span><span class="ident">key</span><span class="op">[</span><span class="num">8</span><span class="op">:</span><span class="op">]</span><span class="op">)</span><span class="op">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">g</span><span class="op">.</span><span class="ident">productTable</span><span class="op">[</span><span class="ident">reverseBits</span><span class="op">(</span><span class="num">1</span><span class="op">)</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">x</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">2</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">16</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="num">2</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">g</span><span class="op">.</span><span class="ident">productTable</span><span class="op">[</span><span class="ident">reverseBits</span><span class="op">(</span><span class="ident">i</span><span class="op">)</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">gcmDouble</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">g</span><span class="op">.</span><span class="ident">productTable</span><span class="op">[</span><span class="ident">reverseBits</span><span class="op">(</span><span class="ident">i</span><span class="op">/</span><span class="num">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">g</span><span class="op">.</span><span class="ident">productTable</span><span class="op">[</span><span class="ident">reverseBits</span><span class="op">(</span><span class="ident">i</span><span class="op">+</span><span class="num">1</span><span class="op">)</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">gcmAdd</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">g</span><span class="op">.</span><span class="ident">productTable</span><span class="op">[</span><span class="ident">reverseBits</span><span class="op">(</span><span class="ident">i</span><span class="op">)</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">x</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">g</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword">const</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">gcmBlockSize</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">gcmTagSize</span>&nbsp;&nbsp;&nbsp;<span class="op">=</span>&nbsp;<span class="num">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">gcmNonceSize</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">12</span><br>
<span class="lineno">95</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="ident">gcm</span><span class="op">)</span>&nbsp;<span class="ident">NonceSize</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">gcmNonceSize</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="ident">gcm</span><span class="op">)</span>&nbsp;<span class="ident">Overhead</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">gcmTagSize</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">g</span>&nbsp;<span class="op">*</span><span class="ident">gcm</span><span class="op">)</span>&nbsp;<span class="ident">Seal</span><span class="op">(</span><span class="ident">dst</span><span class="op">,</span>&nbsp;<span class="ident">nonce</span><span class="op">,</span>&nbsp;<span class="ident">plaintext</span><span class="op">,</span>&nbsp;<span class="ident">data</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">nonce</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">gcmNonceSize</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;cipher:&nbsp;incorrect&nbsp;nonce&nbsp;length&nbsp;given&nbsp;to&nbsp;GCM&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ret</span><span class="op">,</span>&nbsp;<span class="ident">out</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">sliceForAppend</span><span class="op">(</span><span class="ident">dst</span><span class="op">,</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">plaintext</span><span class="op">)</span><span class="op">+</span><span class="ident">gcmTagSize</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;See&nbsp;GCM&nbsp;spec,&nbsp;section&nbsp;7.1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">counter</span><span class="op">,</span>&nbsp;<span class="ident">tagMask</span>&nbsp;<span class="op">[</span><span class="ident">gcmBlockSize</span><span class="op">]</span><span class="builtintype">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">copy</span><span class="op">(</span><span class="ident">counter</span><span class="op">[</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">nonce</span><span class="op">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">counter</span><span class="op">[</span><span class="ident">gcmBlockSize</span><span class="op">-</span><span class="num">1</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">g</span><span class="op">.</span><span class="ident">cipher</span><span class="op">.</span><span class="ident">Encrypt</span><span class="op">(</span><span class="ident">tagMask</span><span class="op">[</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">counter</span><span class="op">[</span><span class="op">:</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">gcmInc32</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">counter</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">g</span><span class="op">.</span><span class="ident">counterCrypt</span><span class="op">(</span><span class="ident">out</span><span class="op">,</span>&nbsp;<span class="ident">plaintext</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">counter</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">g</span><span class="op">.</span><span class="ident">auth</span><span class="op">(</span><span class="ident">out</span><span class="op">[</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">plaintext</span><span class="op">)</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">out</span><span class="op">[</span><span class="op">:</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">plaintext</span><span class="op">)</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">data</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">tagMask</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">ret</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">errOpen</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;cipher:&nbsp;message&nbsp;authentication&nbsp;failed&#34;</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">g</span>&nbsp;<span class="op">*</span><span class="ident">gcm</span><span class="op">)</span>&nbsp;<span class="ident">Open</span><span class="op">(</span><span class="ident">dst</span><span class="op">,</span>&nbsp;<span class="ident">nonce</span><span class="op">,</span>&nbsp;<span class="ident">ciphertext</span><span class="op">,</span>&nbsp;<span class="ident">data</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">nonce</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">gcmNonceSize</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;cipher:&nbsp;incorrect&nbsp;nonce&nbsp;length&nbsp;given&nbsp;to&nbsp;GCM&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">ciphertext</span><span class="op">)</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">gcmTagSize</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">errOpen</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tag</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">ciphertext</span><span class="op">[</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">ciphertext</span><span class="op">)</span><span class="op">-</span><span class="ident">gcmTagSize</span><span class="op">:</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ciphertext</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">ciphertext</span><span class="op">[</span><span class="op">:</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">ciphertext</span><span class="op">)</span><span class="op">-</span><span class="ident">gcmTagSize</span><span class="op">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;See&nbsp;GCM&nbsp;spec,&nbsp;section&nbsp;7.1.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">counter</span><span class="op">,</span>&nbsp;<span class="ident">tagMask</span>&nbsp;<span class="op">[</span><span class="ident">gcmBlockSize</span><span class="op">]</span><span class="builtintype">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">copy</span><span class="op">(</span><span class="ident">counter</span><span class="op">[</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">nonce</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">counter</span><span class="op">[</span><span class="ident">gcmBlockSize</span><span class="op">-</span><span class="num">1</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">g</span><span class="op">.</span><span class="ident">cipher</span><span class="op">.</span><span class="ident">Encrypt</span><span class="op">(</span><span class="ident">tagMask</span><span class="op">[</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">counter</span><span class="op">[</span><span class="op">:</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">gcmInc32</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">counter</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">expectedTag</span>&nbsp;<span class="op">[</span><span class="ident">gcmTagSize</span><span class="op">]</span><span class="builtintype">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">g</span><span class="op">.</span><span class="ident">auth</span><span class="op">(</span><span class="ident">expectedTag</span><span class="op">[</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">ciphertext</span><span class="op">,</span>&nbsp;<span class="ident">data</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">tagMask</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">subtle</span><span class="op">.</span><span class="ident">ConstantTimeCompare</span><span class="op">(</span><span class="ident">expectedTag</span><span class="op">[</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">tag</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">errOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ret</span><span class="op">,</span>&nbsp;<span class="ident">out</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">sliceForAppend</span><span class="op">(</span><span class="ident">dst</span><span class="op">,</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">ciphertext</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">g</span><span class="op">.</span><span class="ident">counterCrypt</span><span class="op">(</span><span class="ident">out</span><span class="op">,</span>&nbsp;<span class="ident">ciphertext</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">counter</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">ret</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment">//&nbsp;reverseBits&nbsp;reverses&nbsp;the&nbsp;order&nbsp;of&nbsp;the&nbsp;bits&nbsp;of&nbsp;4-bit&nbsp;number&nbsp;in&nbsp;i.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">reverseBits</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">(</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="num">2</span><span class="op">)</span>&nbsp;<span class="op">&amp;</span>&nbsp;<span class="num">0xc</span><span class="op">)</span>&nbsp;<span class="op">|</span>&nbsp;<span class="op">(</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">&gt;&gt;</span>&nbsp;<span class="num">2</span><span class="op">)</span>&nbsp;<span class="op">&amp;</span>&nbsp;<span class="num">0x3</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">(</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="num">1</span><span class="op">)</span>&nbsp;<span class="op">&amp;</span>&nbsp;<span class="num">0xa</span><span class="op">)</span>&nbsp;<span class="op">|</span>&nbsp;<span class="op">(</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">&gt;&gt;</span>&nbsp;<span class="num">1</span><span class="op">)</span>&nbsp;<span class="op">&amp;</span>&nbsp;<span class="num">0x5</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">i</span><br>
<span class="lineno">165</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;gcmAdd&nbsp;adds&nbsp;two&nbsp;elements&nbsp;of&nbsp;GF(2¹²⁸)&nbsp;and&nbsp;returns&nbsp;the&nbsp;sum.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">gcmAdd</span><span class="op">(</span><span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="op">*</span><span class="ident">gcmFieldElement</span><span class="op">)</span>&nbsp;<span class="ident">gcmFieldElement</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Addition&nbsp;in&nbsp;a&nbsp;characteristic&nbsp;2&nbsp;field&nbsp;is&nbsp;just&nbsp;XOR.</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">gcmFieldElement</span><span class="op">{</span><span class="ident">x</span><span class="op">.</span><span class="ident">low</span>&nbsp;<span class="op">^</span>&nbsp;<span class="ident">y</span><span class="op">.</span><span class="ident">low</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">high</span>&nbsp;<span class="op">^</span>&nbsp;<span class="ident">y</span><span class="op">.</span><span class="ident">high</span><span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;gcmDouble&nbsp;returns&nbsp;the&nbsp;result&nbsp;of&nbsp;doubling&nbsp;an&nbsp;element&nbsp;of&nbsp;GF(2¹²⁸).</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">gcmDouble</span><span class="op">(</span><span class="ident">x</span>&nbsp;<span class="op">*</span><span class="ident">gcmFieldElement</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">double</span>&nbsp;<span class="ident">gcmFieldElement</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">msbSet</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">high</span><span class="op">&amp;</span><span class="num">1</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Because&nbsp;of&nbsp;the&nbsp;bit-ordering,&nbsp;doubling&nbsp;is&nbsp;actually&nbsp;a&nbsp;right&nbsp;shift.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">double</span><span class="op">.</span><span class="ident">high</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">high</span>&nbsp;<span class="op">&gt;&gt;</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">double</span><span class="op">.</span><span class="ident">high</span>&nbsp;<span class="op">|=</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">low</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="num">63</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">double</span><span class="op">.</span><span class="ident">low</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">low</span>&nbsp;<span class="op">&gt;&gt;</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;If&nbsp;the&nbsp;most-significant&nbsp;bit&nbsp;was&nbsp;set&nbsp;before&nbsp;shifting&nbsp;then&nbsp;it,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;conceptually,&nbsp;becomes&nbsp;a&nbsp;term&nbsp;of&nbsp;x^128.&nbsp;This&nbsp;is&nbsp;greater&nbsp;than&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;irreducible&nbsp;polynomial&nbsp;so&nbsp;the&nbsp;result&nbsp;has&nbsp;to&nbsp;be&nbsp;reduced.&nbsp;The</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;irreducible&nbsp;polynomial&nbsp;is&nbsp;1+x+x^2+x^7+x^128.&nbsp;We&nbsp;can&nbsp;subtract&nbsp;that&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;eliminate&nbsp;the&nbsp;term&nbsp;at&nbsp;x^128&nbsp;which&nbsp;also&nbsp;means&nbsp;subtracting&nbsp;the&nbsp;other</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;four&nbsp;terms.&nbsp;In&nbsp;characteristic&nbsp;2&nbsp;fields,&nbsp;subtraction&nbsp;==&nbsp;addition&nbsp;==</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;XOR.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">msbSet</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">double</span><span class="op">.</span><span class="ident">low</span>&nbsp;<span class="op">^=</span>&nbsp;<span class="num">0xe100000000000000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">gcmReductionTable</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">uint16</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0x0000</span><span class="op">,</span>&nbsp;<span class="num">0x1c20</span><span class="op">,</span>&nbsp;<span class="num">0x3840</span><span class="op">,</span>&nbsp;<span class="num">0x2460</span><span class="op">,</span>&nbsp;<span class="num">0x7080</span><span class="op">,</span>&nbsp;<span class="num">0x6ca0</span><span class="op">,</span>&nbsp;<span class="num">0x48c0</span><span class="op">,</span>&nbsp;<span class="num">0x54e0</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0xe100</span><span class="op">,</span>&nbsp;<span class="num">0xfd20</span><span class="op">,</span>&nbsp;<span class="num">0xd940</span><span class="op">,</span>&nbsp;<span class="num">0xc560</span><span class="op">,</span>&nbsp;<span class="num">0x9180</span><span class="op">,</span>&nbsp;<span class="num">0x8da0</span><span class="op">,</span>&nbsp;<span class="num">0xa9c0</span><span class="op">,</span>&nbsp;<span class="num">0xb5e0</span><span class="op">,</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;mul&nbsp;sets&nbsp;y&nbsp;to&nbsp;y*H,&nbsp;where&nbsp;H&nbsp;is&nbsp;the&nbsp;GCM&nbsp;key,&nbsp;fixed&nbsp;during&nbsp;NewGCM.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">g</span>&nbsp;<span class="op">*</span><span class="ident">gcm</span><span class="op">)</span>&nbsp;<span class="ident">mul</span><span class="op">(</span><span class="ident">y</span>&nbsp;<span class="op">*</span><span class="ident">gcmFieldElement</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">z</span>&nbsp;<span class="ident">gcmFieldElement</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">2</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">word</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">y</span><span class="op">.</span><span class="ident">high</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">word</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">y</span><span class="op">.</span><span class="ident">low</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Multiplication&nbsp;works&nbsp;by&nbsp;multiplying&nbsp;z&nbsp;by&nbsp;16&nbsp;and&nbsp;adding&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;one&nbsp;of&nbsp;the&nbsp;precomputed&nbsp;multiples&nbsp;of&nbsp;H.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">64</span><span class="op">;</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="num">4</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">msw</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">high</span>&nbsp;<span class="op">&amp;</span>&nbsp;<span class="num">0xf</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">high</span>&nbsp;<span class="op">&gt;&gt;=</span>&nbsp;<span class="num">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">high</span>&nbsp;<span class="op">|=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">low</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="num">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">low</span>&nbsp;<span class="op">&gt;&gt;=</span>&nbsp;<span class="num">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">low</span>&nbsp;<span class="op">^=</span>&nbsp;<span class="ident">uint64</span><span class="op">(</span><span class="ident">gcmReductionTable</span><span class="op">[</span><span class="ident">msw</span><span class="op">]</span><span class="op">)</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="num">48</span><br>
<span class="lineno"></span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;the&nbsp;values&nbsp;in&nbsp;|table|&nbsp;are&nbsp;ordered&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;little-endian&nbsp;bit&nbsp;positions.&nbsp;See&nbsp;the&nbsp;comment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;in&nbsp;NewGCM.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">g</span><span class="op">.</span><span class="ident">productTable</span><span class="op">[</span><span class="ident">word</span><span class="op">&amp;</span><span class="num">0xf</span><span class="op">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">low</span>&nbsp;<span class="op">^=</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">low</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">high</span>&nbsp;<span class="op">^=</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">high</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">word</span>&nbsp;<span class="op">&gt;&gt;=</span>&nbsp;<span class="num">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">*</span><span class="ident">y</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;updateBlocks&nbsp;extends&nbsp;y&nbsp;with&nbsp;more&nbsp;polynomial&nbsp;terms&nbsp;from&nbsp;blocks,&nbsp;based&nbsp;on</span><br>
<span class="lineno">235</span><span class="comment">//&nbsp;Horner&#39;s&nbsp;rule.&nbsp;There&nbsp;must&nbsp;be&nbsp;a&nbsp;multiple&nbsp;of&nbsp;gcmBlockSize&nbsp;bytes&nbsp;in&nbsp;blocks.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">g</span>&nbsp;<span class="op">*</span><span class="ident">gcm</span><span class="op">)</span>&nbsp;<span class="ident">updateBlocks</span><span class="op">(</span><span class="ident">y</span>&nbsp;<span class="op">*</span><span class="ident">gcmFieldElement</span><span class="op">,</span>&nbsp;<span class="ident">blocks</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">blocks</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">y</span><span class="op">.</span><span class="ident">low</span>&nbsp;<span class="op">^=</span>&nbsp;<span class="ident">getUint64</span><span class="op">(</span><span class="ident">blocks</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">y</span><span class="op">.</span><span class="ident">high</span>&nbsp;<span class="op">^=</span>&nbsp;<span class="ident">getUint64</span><span class="op">(</span><span class="ident">blocks</span><span class="op">[</span><span class="num">8</span><span class="op">:</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">g</span><span class="op">.</span><span class="ident">mul</span><span class="op">(</span><span class="ident">y</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">blocks</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">blocks</span><span class="op">[</span><span class="ident">gcmBlockSize</span><span class="op">:</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span><span class="comment">//&nbsp;update&nbsp;extends&nbsp;y&nbsp;with&nbsp;more&nbsp;polynomial&nbsp;terms&nbsp;from&nbsp;data.&nbsp;If&nbsp;data&nbsp;is&nbsp;not&nbsp;a</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;multiple&nbsp;of&nbsp;gcmBlockSize&nbsp;bytes&nbsp;long&nbsp;then&nbsp;the&nbsp;remainder&nbsp;is&nbsp;zero&nbsp;padded.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">g</span>&nbsp;<span class="op">*</span><span class="ident">gcm</span><span class="op">)</span>&nbsp;<span class="ident">update</span><span class="op">(</span><span class="ident">y</span>&nbsp;<span class="op">*</span><span class="ident">gcmFieldElement</span><span class="op">,</span>&nbsp;<span class="ident">data</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fullBlocks</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">(</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">data</span><span class="op">)</span>&nbsp;<span class="op">&gt;&gt;</span>&nbsp;<span class="num">4</span><span class="op">)</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="num">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">g</span><span class="op">.</span><span class="ident">updateBlocks</span><span class="op">(</span><span class="ident">y</span><span class="op">,</span>&nbsp;<span class="ident">data</span><span class="op">[</span><span class="op">:</span><span class="ident">fullBlocks</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">data</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">fullBlocks</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">partialBlock</span>&nbsp;<span class="op">[</span><span class="ident">gcmBlockSize</span><span class="op">]</span><span class="builtintype">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">copy</span><span class="op">(</span><span class="ident">partialBlock</span><span class="op">[</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">data</span><span class="op">[</span><span class="ident">fullBlocks</span><span class="op">:</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">g</span><span class="op">.</span><span class="ident">updateBlocks</span><span class="op">(</span><span class="ident">y</span><span class="op">,</span>&nbsp;<span class="ident">partialBlock</span><span class="op">[</span><span class="op">:</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;gcmInc32&nbsp;treats&nbsp;the&nbsp;final&nbsp;four&nbsp;bytes&nbsp;of&nbsp;counterBlock&nbsp;as&nbsp;a&nbsp;big-endian&nbsp;value</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;and&nbsp;increments&nbsp;it.</span><br>
<span class="lineno">260</span><span class="keyword">func</span>&nbsp;<span class="ident">gcmInc32</span><span class="op">(</span><span class="ident">counterBlock</span>&nbsp;<span class="op">*</span><span class="op">[</span><span class="num">16</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">gcmBlockSize</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="ident">gcmBlockSize</span><span class="op">-</span><span class="num">4</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">--</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">counterBlock</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">counterBlock</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;sliceForAppend&nbsp;takes&nbsp;a&nbsp;slice&nbsp;and&nbsp;a&nbsp;requested&nbsp;number&nbsp;of&nbsp;bytes.&nbsp;It&nbsp;returns&nbsp;a</span><br>
<span class="lineno">270</span><span class="comment">//&nbsp;slice&nbsp;with&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;given&nbsp;slice&nbsp;followed&nbsp;by&nbsp;that&nbsp;many&nbsp;bytes&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;second&nbsp;slice&nbsp;that&nbsp;aliases&nbsp;into&nbsp;it&nbsp;and&nbsp;contains&nbsp;only&nbsp;the&nbsp;extra&nbsp;bytes.&nbsp;If&nbsp;the</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;original&nbsp;slice&nbsp;has&nbsp;sufficient&nbsp;capacity&nbsp;then&nbsp;no&nbsp;allocation&nbsp;is&nbsp;performed.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">sliceForAppend</span><span class="op">(</span><span class="ident">in</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">head</span><span class="op">,</span>&nbsp;<span class="ident">tail</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">total</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">in</span><span class="op">)</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">n</span><span class="op">;</span>&nbsp;<span class="builtinfunc">cap</span><span class="op">(</span><span class="ident">in</span><span class="op">)</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="ident">total</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">head</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">in</span><span class="op">[</span><span class="op">:</span><span class="ident">total</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">head</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">total</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">copy</span><span class="op">(</span><span class="ident">head</span><span class="op">,</span>&nbsp;<span class="ident">in</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tail</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">head</span><span class="op">[</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">in</span><span class="op">)</span><span class="op">:</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;counterCrypt&nbsp;crypts&nbsp;in&nbsp;to&nbsp;out&nbsp;using&nbsp;g.cipher&nbsp;in&nbsp;counter&nbsp;mode.</span><br>
<span class="lineno">285</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">g</span>&nbsp;<span class="op">*</span><span class="ident">gcm</span><span class="op">)</span>&nbsp;<span class="ident">counterCrypt</span><span class="op">(</span><span class="ident">out</span><span class="op">,</span>&nbsp;<span class="ident">in</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">counter</span>&nbsp;<span class="op">*</span><span class="op">[</span><span class="ident">gcmBlockSize</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">mask</span>&nbsp;<span class="op">[</span><span class="ident">gcmBlockSize</span><span class="op">]</span><span class="builtintype">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">in</span><span class="op">)</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="ident">gcmBlockSize</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">g</span><span class="op">.</span><span class="ident">cipher</span><span class="op">.</span><span class="ident">Encrypt</span><span class="op">(</span><span class="ident">mask</span><span class="op">[</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">counter</span><span class="op">[</span><span class="op">:</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">gcmInc32</span><span class="op">(</span><span class="ident">counter</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">xorWords</span><span class="op">(</span><span class="ident">out</span><span class="op">,</span>&nbsp;<span class="ident">in</span><span class="op">,</span>&nbsp;<span class="ident">mask</span><span class="op">[</span><span class="op">:</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">out</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">out</span><span class="op">[</span><span class="ident">gcmBlockSize</span><span class="op">:</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">in</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">in</span><span class="op">[</span><span class="ident">gcmBlockSize</span><span class="op">:</span><span class="op">]</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">in</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">g</span><span class="op">.</span><span class="ident">cipher</span><span class="op">.</span><span class="ident">Encrypt</span><span class="op">(</span><span class="ident">mask</span><span class="op">[</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">counter</span><span class="op">[</span><span class="op">:</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">gcmInc32</span><span class="op">(</span><span class="ident">counter</span><span class="op">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">xorBytes</span><span class="op">(</span><span class="ident">out</span><span class="op">,</span>&nbsp;<span class="ident">in</span><span class="op">,</span>&nbsp;<span class="ident">mask</span><span class="op">[</span><span class="op">:</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;auth&nbsp;calculates&nbsp;GHASH(ciphertext,&nbsp;additionalData),&nbsp;masks&nbsp;the&nbsp;result&nbsp;with</span><br>
<span class="lineno">305</span><span class="comment">//&nbsp;tagMask&nbsp;and&nbsp;writes&nbsp;the&nbsp;result&nbsp;to&nbsp;out.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">g</span>&nbsp;<span class="op">*</span><span class="ident">gcm</span><span class="op">)</span>&nbsp;<span class="ident">auth</span><span class="op">(</span><span class="ident">out</span><span class="op">,</span>&nbsp;<span class="ident">ciphertext</span><span class="op">,</span>&nbsp;<span class="ident">additionalData</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">tagMask</span>&nbsp;<span class="op">*</span><span class="op">[</span><span class="ident">gcmTagSize</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="ident">gcmFieldElement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">g</span><span class="op">.</span><span class="ident">update</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">y</span><span class="op">,</span>&nbsp;<span class="ident">additionalData</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">g</span><span class="op">.</span><span class="ident">update</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">y</span><span class="op">,</span>&nbsp;<span class="ident">ciphertext</span><span class="op">)</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">y</span><span class="op">.</span><span class="ident">low</span>&nbsp;<span class="op">^=</span>&nbsp;<span class="ident">uint64</span><span class="op">(</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">additionalData</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="op">*</span>&nbsp;<span class="num">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">y</span><span class="op">.</span><span class="ident">high</span>&nbsp;<span class="op">^=</span>&nbsp;<span class="ident">uint64</span><span class="op">(</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">ciphertext</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="op">*</span>&nbsp;<span class="num">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">g</span><span class="op">.</span><span class="ident">mul</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">y</span><span class="op">)</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">putUint64</span><span class="op">(</span><span class="ident">out</span><span class="op">,</span>&nbsp;<span class="ident">y</span><span class="op">.</span><span class="ident">low</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">putUint64</span><span class="op">(</span><span class="ident">out</span><span class="op">[</span><span class="num">8</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">y</span><span class="op">.</span><span class="ident">high</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">xorWords</span><span class="op">(</span><span class="ident">out</span><span class="op">,</span>&nbsp;<span class="ident">out</span><span class="op">,</span>&nbsp;<span class="ident">tagMask</span><span class="op">[</span><span class="op">:</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno">320</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">getUint64</span><span class="op">(</span><span class="ident">data</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="ident">uint64</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">uint64</span><span class="op">(</span><span class="ident">data</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span><span class="op">&lt;&lt;</span><span class="num">56</span>&nbsp;<span class="op">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">uint64</span><span class="op">(</span><span class="ident">data</span><span class="op">[</span><span class="num">1</span><span class="op">]</span><span class="op">)</span><span class="op">&lt;&lt;</span><span class="num">48</span>&nbsp;<span class="op">|</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">uint64</span><span class="op">(</span><span class="ident">data</span><span class="op">[</span><span class="num">2</span><span class="op">]</span><span class="op">)</span><span class="op">&lt;&lt;</span><span class="num">40</span>&nbsp;<span class="op">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">uint64</span><span class="op">(</span><span class="ident">data</span><span class="op">[</span><span class="num">3</span><span class="op">]</span><span class="op">)</span><span class="op">&lt;&lt;</span><span class="num">32</span>&nbsp;<span class="op">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">uint64</span><span class="op">(</span><span class="ident">data</span><span class="op">[</span><span class="num">4</span><span class="op">]</span><span class="op">)</span><span class="op">&lt;&lt;</span><span class="num">24</span>&nbsp;<span class="op">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">uint64</span><span class="op">(</span><span class="ident">data</span><span class="op">[</span><span class="num">5</span><span class="op">]</span><span class="op">)</span><span class="op">&lt;&lt;</span><span class="num">16</span>&nbsp;<span class="op">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">uint64</span><span class="op">(</span><span class="ident">data</span><span class="op">[</span><span class="num">6</span><span class="op">]</span><span class="op">)</span><span class="op">&lt;&lt;</span><span class="num">8</span>&nbsp;<span class="op">|</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">uint64</span><span class="op">(</span><span class="ident">data</span><span class="op">[</span><span class="num">7</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">r</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">putUint64</span><span class="op">(</span><span class="ident">out</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="ident">uint64</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">out</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">byte</span><span class="op">(</span><span class="ident">v</span>&nbsp;<span class="op">&gt;&gt;</span>&nbsp;<span class="num">56</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">out</span><span class="op">[</span><span class="num">1</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">byte</span><span class="op">(</span><span class="ident">v</span>&nbsp;<span class="op">&gt;&gt;</span>&nbsp;<span class="num">48</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">out</span><span class="op">[</span><span class="num">2</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">byte</span><span class="op">(</span><span class="ident">v</span>&nbsp;<span class="op">&gt;&gt;</span>&nbsp;<span class="num">40</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">out</span><span class="op">[</span><span class="num">3</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">byte</span><span class="op">(</span><span class="ident">v</span>&nbsp;<span class="op">&gt;&gt;</span>&nbsp;<span class="num">32</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">out</span><span class="op">[</span><span class="num">4</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">byte</span><span class="op">(</span><span class="ident">v</span>&nbsp;<span class="op">&gt;&gt;</span>&nbsp;<span class="num">24</span><span class="op">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">out</span><span class="op">[</span><span class="num">5</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">byte</span><span class="op">(</span><span class="ident">v</span>&nbsp;<span class="op">&gt;&gt;</span>&nbsp;<span class="num">16</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">out</span><span class="op">[</span><span class="num">6</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">byte</span><span class="op">(</span><span class="ident">v</span>&nbsp;<span class="op">&gt;&gt;</span>&nbsp;<span class="num">8</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">out</span><span class="op">[</span><span class="num">7</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">byte</span><span class="op">(</span><span class="ident">v</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span>
</div>
</body>
</html>
