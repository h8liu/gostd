<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html" class="current">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8106032">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8106087">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8106141">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="8106192">package</span>&nbsp;<span class="ident" id="8106200">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8106205">import</span>&nbsp;<span class="op" id="8106212">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8106215">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8106222">&#34;io&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8106228">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8106239">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8106250">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8106258">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8106269">&#34;time&#34;</span><br>
<span class="lineno">15</span><span class="op" id="8106276">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8106279">func</span>&nbsp;<span class="ident" id="8106284">BenchmarkTCP4OneShot</span><span class="op" id="8106304">(</span><span class="ident" id="8106305">b</span>&nbsp;<span class="op" id="8106307">*</span><span class="ident" id="8106308">testing</span><span class="op" id="8106315">.</span><span class="ident" id="8106316">B</span><span class="op" id="8106317">)</span>&nbsp;<span class="op" id="8106319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8106322">benchmarkTCP</span><span class="op" id="8106334">(</span><span class="ident" id="8106335">b</span><span class="op" id="8106336">,</span>&nbsp;<span class="builtintype" id="8106338">false</span><span class="op" id="8106343">,</span>&nbsp;<span class="builtintype" id="8106345">false</span><span class="op" id="8106350">,</span>&nbsp;<span class="string" id="8106352">&#34;127.0.0.1:0&#34;</span><span class="op" id="8106365">)</span><br>
<span class="lineno"></span><span class="op" id="8106367">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="8106370">func</span>&nbsp;<span class="ident" id="8106375">BenchmarkTCP4OneShotTimeout</span><span class="op" id="8106402">(</span><span class="ident" id="8106403">b</span>&nbsp;<span class="op" id="8106405">*</span><span class="ident" id="8106406">testing</span><span class="op" id="8106413">.</span><span class="ident" id="8106414">B</span><span class="op" id="8106415">)</span>&nbsp;<span class="op" id="8106417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8106420">benchmarkTCP</span><span class="op" id="8106432">(</span><span class="ident" id="8106433">b</span><span class="op" id="8106434">,</span>&nbsp;<span class="builtintype" id="8106436">false</span><span class="op" id="8106441">,</span>&nbsp;<span class="builtintype" id="8106443">true</span><span class="op" id="8106447">,</span>&nbsp;<span class="string" id="8106449">&#34;127.0.0.1:0&#34;</span><span class="op" id="8106462">)</span><br>
<span class="lineno"></span><span class="op" id="8106464">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="8106467">func</span>&nbsp;<span class="ident" id="8106472">BenchmarkTCP4Persistent</span><span class="op" id="8106495">(</span><span class="ident" id="8106496">b</span>&nbsp;<span class="op" id="8106498">*</span><span class="ident" id="8106499">testing</span><span class="op" id="8106506">.</span><span class="ident" id="8106507">B</span><span class="op" id="8106508">)</span>&nbsp;<span class="op" id="8106510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8106513">benchmarkTCP</span><span class="op" id="8106525">(</span><span class="ident" id="8106526">b</span><span class="op" id="8106527">,</span>&nbsp;<span class="builtintype" id="8106529">true</span><span class="op" id="8106533">,</span>&nbsp;<span class="builtintype" id="8106535">false</span><span class="op" id="8106540">,</span>&nbsp;<span class="string" id="8106542">&#34;127.0.0.1:0&#34;</span><span class="op" id="8106555">)</span><br>
<span class="lineno"></span><span class="op" id="8106557">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8106560">func</span>&nbsp;<span class="ident" id="8106565">BenchmarkTCP4PersistentTimeout</span><span class="op" id="8106595">(</span><span class="ident" id="8106596">b</span>&nbsp;<span class="op" id="8106598">*</span><span class="ident" id="8106599">testing</span><span class="op" id="8106606">.</span><span class="ident" id="8106607">B</span><span class="op" id="8106608">)</span>&nbsp;<span class="op" id="8106610">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8106613">benchmarkTCP</span><span class="op" id="8106625">(</span><span class="ident" id="8106626">b</span><span class="op" id="8106627">,</span>&nbsp;<span class="builtintype" id="8106629">true</span><span class="op" id="8106633">,</span>&nbsp;<span class="builtintype" id="8106635">true</span><span class="op" id="8106639">,</span>&nbsp;<span class="string" id="8106641">&#34;127.0.0.1:0&#34;</span><span class="op" id="8106654">)</span><br>
<span class="lineno"></span><span class="op" id="8106656">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8106659">func</span>&nbsp;<span class="ident" id="8106664">BenchmarkTCP6OneShot</span><span class="op" id="8106684">(</span><span class="ident" id="8106685">b</span>&nbsp;<span class="op" id="8106687">*</span><span class="ident" id="8106688">testing</span><span class="op" id="8106695">.</span><span class="ident" id="8106696">B</span><span class="op" id="8106697">)</span>&nbsp;<span class="op" id="8106699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8106702">if</span>&nbsp;<span class="op" id="8106705">!</span><span class="ident" id="8106706">supportsIPv6</span>&nbsp;<span class="op" id="8106719">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8106723">b</span><span class="op" id="8106724">.</span><span class="ident" id="8106725">Skip</span><span class="op" id="8106729">(</span><span class="string" id="8106730">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="8106753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8106756">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8106759">benchmarkTCP</span><span class="op" id="8106771">(</span><span class="ident" id="8106772">b</span><span class="op" id="8106773">,</span>&nbsp;<span class="builtintype" id="8106775">false</span><span class="op" id="8106780">,</span>&nbsp;<span class="builtintype" id="8106782">false</span><span class="op" id="8106787">,</span>&nbsp;<span class="string" id="8106789">&#34;[::1]:0&#34;</span><span class="op" id="8106798">)</span><br>
<span class="lineno"></span><span class="op" id="8106800">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="8106803">func</span>&nbsp;<span class="ident" id="8106808">BenchmarkTCP6OneShotTimeout</span><span class="op" id="8106835">(</span><span class="ident" id="8106836">b</span>&nbsp;<span class="op" id="8106838">*</span><span class="ident" id="8106839">testing</span><span class="op" id="8106846">.</span><span class="ident" id="8106847">B</span><span class="op" id="8106848">)</span>&nbsp;<span class="op" id="8106850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8106853">if</span>&nbsp;<span class="op" id="8106856">!</span><span class="ident" id="8106857">supportsIPv6</span>&nbsp;<span class="op" id="8106870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8106874">b</span><span class="op" id="8106875">.</span><span class="ident" id="8106876">Skip</span><span class="op" id="8106880">(</span><span class="string" id="8106881">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="8106904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8106907">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8106910">benchmarkTCP</span><span class="op" id="8106922">(</span><span class="ident" id="8106923">b</span><span class="op" id="8106924">,</span>&nbsp;<span class="builtintype" id="8106926">false</span><span class="op" id="8106931">,</span>&nbsp;<span class="builtintype" id="8106933">true</span><span class="op" id="8106937">,</span>&nbsp;<span class="string" id="8106939">&#34;[::1]:0&#34;</span><span class="op" id="8106948">)</span><br>
<span class="lineno">45</span><span class="op" id="8106950">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8106953">func</span>&nbsp;<span class="ident" id="8106958">BenchmarkTCP6Persistent</span><span class="op" id="8106981">(</span><span class="ident" id="8106982">b</span>&nbsp;<span class="op" id="8106984">*</span><span class="ident" id="8106985">testing</span><span class="op" id="8106992">.</span><span class="ident" id="8106993">B</span><span class="op" id="8106994">)</span>&nbsp;<span class="op" id="8106996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8106999">if</span>&nbsp;<span class="op" id="8107002">!</span><span class="ident" id="8107003">supportsIPv6</span>&nbsp;<span class="op" id="8107016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8107020">b</span><span class="op" id="8107021">.</span><span class="ident" id="8107022">Skip</span><span class="op" id="8107026">(</span><span class="string" id="8107027">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="8107050">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8107053">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8107056">benchmarkTCP</span><span class="op" id="8107068">(</span><span class="ident" id="8107069">b</span><span class="op" id="8107070">,</span>&nbsp;<span class="builtintype" id="8107072">true</span><span class="op" id="8107076">,</span>&nbsp;<span class="builtintype" id="8107078">false</span><span class="op" id="8107083">,</span>&nbsp;<span class="string" id="8107085">&#34;[::1]:0&#34;</span><span class="op" id="8107094">)</span><br>
<span class="lineno"></span><span class="op" id="8107096">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8107099">func</span>&nbsp;<span class="ident" id="8107104">BenchmarkTCP6PersistentTimeout</span><span class="op" id="8107134">(</span><span class="ident" id="8107135">b</span>&nbsp;<span class="op" id="8107137">*</span><span class="ident" id="8107138">testing</span><span class="op" id="8107145">.</span><span class="ident" id="8107146">B</span><span class="op" id="8107147">)</span>&nbsp;<span class="op" id="8107149">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8107152">if</span>&nbsp;<span class="op" id="8107155">!</span><span class="ident" id="8107156">supportsIPv6</span>&nbsp;<span class="op" id="8107169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8107173">b</span><span class="op" id="8107174">.</span><span class="ident" id="8107175">Skip</span><span class="op" id="8107179">(</span><span class="string" id="8107180">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="8107203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8107206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8107209">benchmarkTCP</span><span class="op" id="8107221">(</span><span class="ident" id="8107222">b</span><span class="op" id="8107223">,</span>&nbsp;<span class="builtintype" id="8107225">true</span><span class="op" id="8107229">,</span>&nbsp;<span class="builtintype" id="8107231">true</span><span class="op" id="8107235">,</span>&nbsp;<span class="string" id="8107237">&#34;[::1]:0&#34;</span><span class="op" id="8107246">)</span><br>
<span class="lineno"></span><span class="op" id="8107248">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="8107251">func</span>&nbsp;<span class="ident" id="8107256">benchmarkTCP</span><span class="op" id="8107268">(</span><span class="ident" id="8107269">b</span>&nbsp;<span class="op" id="8107271">*</span><span class="ident" id="8107272">testing</span><span class="op" id="8107279">.</span><span class="ident" id="8107280">B</span><span class="op" id="8107281">,</span>&nbsp;<span class="ident" id="8107283">persistent</span><span class="op" id="8107293">,</span>&nbsp;<span class="ident" id="8107295">timeout</span>&nbsp;<span class="builtintype" id="8107303">bool</span><span class="op" id="8107307">,</span>&nbsp;<span class="ident" id="8107309">laddr</span>&nbsp;<span class="builtintype" id="8107315">string</span><span class="op" id="8107321">)</span>&nbsp;<span class="op" id="8107323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8107326">const</span>&nbsp;<span class="ident" id="8107332">msgLen</span>&nbsp;<span class="op" id="8107339">=</span>&nbsp;<span class="num" id="8107341">512</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8107346">conns</span>&nbsp;<span class="op" id="8107352">:=</span>&nbsp;<span class="ident" id="8107355">b</span><span class="op" id="8107356">.</span><span class="ident" id="8107357">N</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8107360">numConcurrent</span>&nbsp;<span class="op" id="8107374">:=</span>&nbsp;<span class="ident" id="8107377">runtime</span><span class="op" id="8107384">.</span><span class="ident" id="8107385">GOMAXPROCS</span><span class="op" id="8107395">(</span><span class="op" id="8107396">-</span><span class="num" id="8107397">1</span><span class="op" id="8107398">)</span>&nbsp;<span class="op" id="8107400">*</span>&nbsp;<span class="num" id="8107402">2</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8107405">msgs</span>&nbsp;<span class="op" id="8107410">:=</span>&nbsp;<span class="num" id="8107413">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8107416">if</span>&nbsp;<span class="ident" id="8107419">persistent</span>&nbsp;<span class="op" id="8107430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8107434">conns</span>&nbsp;<span class="op" id="8107440">=</span>&nbsp;<span class="ident" id="8107442">numConcurrent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8107458">msgs</span>&nbsp;<span class="op" id="8107463">=</span>&nbsp;<span class="ident" id="8107465">b</span><span class="op" id="8107466">.</span><span class="ident" id="8107467">N</span>&nbsp;<span class="op" id="8107469">/</span>&nbsp;<span class="ident" id="8107471">conns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8107479">if</span>&nbsp;<span class="ident" id="8107482">msgs</span>&nbsp;<span class="op" id="8107487">==</span>&nbsp;<span class="num" id="8107490">0</span>&nbsp;<span class="op" id="8107492">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8107497">msgs</span>&nbsp;<span class="op" id="8107502">=</span>&nbsp;<span class="num" id="8107504">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8107508">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8107512">if</span>&nbsp;<span class="ident" id="8107515">conns</span>&nbsp;<span class="op" id="8107521">&gt;</span>&nbsp;<span class="ident" id="8107523">b</span><span class="op" id="8107524">.</span><span class="ident" id="8107525">N</span>&nbsp;<span class="op" id="8107527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8107532">conns</span>&nbsp;<span class="op" id="8107538">=</span>&nbsp;<span class="ident" id="8107540">b</span><span class="op" id="8107541">.</span><span class="ident" id="8107542">N</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8107546">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8107549">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8107552">sendMsg</span>&nbsp;<span class="op" id="8107560">:=</span>&nbsp;<span class="keyword" id="8107563">func</span><span class="op" id="8107567">(</span><span class="ident" id="8107568">c</span>&nbsp;<span class="ident" id="8107570">Conn</span><span class="op" id="8107574">,</span>&nbsp;<span class="ident" id="8107576">buf</span>&nbsp;<span class="op" id="8107580">[</span><span class="op" id="8107581">]</span><span class="builtintype" id="8107582">byte</span><span class="op" id="8107586">)</span>&nbsp;<span class="builtintype" id="8107588">bool</span>&nbsp;<span class="op" id="8107593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8107597">n</span><span class="op" id="8107598">,</span>&nbsp;<span class="ident" id="8107600">err</span>&nbsp;<span class="op" id="8107604">:=</span>&nbsp;<span class="ident" id="8107607">c</span><span class="op" id="8107608">.</span><span class="ident" id="8107609">Write</span><span class="op" id="8107614">(</span><span class="ident" id="8107615">buf</span><span class="op" id="8107618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8107622">if</span>&nbsp;<span class="ident" id="8107625">n</span>&nbsp;<span class="op" id="8107627">!=</span>&nbsp;<span class="builtinfunc" id="8107630">len</span><span class="op" id="8107633">(</span><span class="ident" id="8107634">buf</span><span class="op" id="8107637">)</span>&nbsp;<span class="op" id="8107639">||</span>&nbsp;<span class="ident" id="8107642">err</span>&nbsp;<span class="op" id="8107646">!=</span>&nbsp;<span class="ident" id="8107649">nil</span>&nbsp;<span class="op" id="8107653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8107658">b</span><span class="op" id="8107659">.</span><span class="ident" id="8107660">Logf</span><span class="op" id="8107664">(</span><span class="string" id="8107665">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8107683">,</span>&nbsp;<span class="ident" id="8107685">err</span><span class="op" id="8107688">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8107693">return</span>&nbsp;<span class="builtintype" id="8107700">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8107708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8107712">return</span>&nbsp;<span class="builtintype" id="8107719">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8107725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8107728">recvMsg</span>&nbsp;<span class="op" id="8107736">:=</span>&nbsp;<span class="keyword" id="8107739">func</span><span class="op" id="8107743">(</span><span class="ident" id="8107744">c</span>&nbsp;<span class="ident" id="8107746">Conn</span><span class="op" id="8107750">,</span>&nbsp;<span class="ident" id="8107752">buf</span>&nbsp;<span class="op" id="8107756">[</span><span class="op" id="8107757">]</span><span class="builtintype" id="8107758">byte</span><span class="op" id="8107762">)</span>&nbsp;<span class="builtintype" id="8107764">bool</span>&nbsp;<span class="op" id="8107769">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8107773">for</span>&nbsp;<span class="ident" id="8107777">read</span>&nbsp;<span class="op" id="8107782">:=</span>&nbsp;<span class="num" id="8107785">0</span><span class="op" id="8107786">;</span>&nbsp;<span class="ident" id="8107788">read</span>&nbsp;<span class="op" id="8107793">!=</span>&nbsp;<span class="builtinfunc" id="8107796">len</span><span class="op" id="8107799">(</span><span class="ident" id="8107800">buf</span><span class="op" id="8107803">)</span><span class="op" id="8107804">;</span>&nbsp;<span class="op" id="8107806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8107811">n</span><span class="op" id="8107812">,</span>&nbsp;<span class="ident" id="8107814">err</span>&nbsp;<span class="op" id="8107818">:=</span>&nbsp;<span class="ident" id="8107821">c</span><span class="op" id="8107822">.</span><span class="ident" id="8107823">Read</span><span class="op" id="8107827">(</span><span class="ident" id="8107828">buf</span><span class="op" id="8107831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8107836">read</span>&nbsp;<span class="op" id="8107841">+=</span>&nbsp;<span class="ident" id="8107844">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8107849">if</span>&nbsp;<span class="ident" id="8107852">err</span>&nbsp;<span class="op" id="8107856">!=</span>&nbsp;<span class="ident" id="8107859">nil</span>&nbsp;<span class="op" id="8107863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8107869">b</span><span class="op" id="8107870">.</span><span class="ident" id="8107871">Logf</span><span class="op" id="8107875">(</span><span class="string" id="8107876">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8107893">,</span>&nbsp;<span class="ident" id="8107895">err</span><span class="op" id="8107898">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8107904">return</span>&nbsp;<span class="builtintype" id="8107911">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8107920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8107924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8107928">return</span>&nbsp;<span class="builtintype" id="8107935">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8107941">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8107944">ln</span><span class="op" id="8107946">,</span>&nbsp;<span class="ident" id="8107948">err</span>&nbsp;<span class="op" id="8107952">:=</span>&nbsp;<span class="ident" id="8107955">Listen</span><span class="op" id="8107961">(</span><span class="string" id="8107962">&#34;tcp&#34;</span><span class="op" id="8107967">,</span>&nbsp;<span class="ident" id="8107969">laddr</span><span class="op" id="8107974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8107977">if</span>&nbsp;<span class="ident" id="8107980">err</span>&nbsp;<span class="op" id="8107984">!=</span>&nbsp;<span class="ident" id="8107987">nil</span>&nbsp;<span class="op" id="8107991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8107995">b</span><span class="op" id="8107996">.</span><span class="ident" id="8107997">Fatalf</span><span class="op" id="8108003">(</span><span class="string" id="8108004">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8108023">,</span>&nbsp;<span class="ident" id="8108025">err</span><span class="op" id="8108028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8108031">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8108034">defer</span>&nbsp;<span class="ident" id="8108040">ln</span><span class="op" id="8108042">.</span><span class="ident" id="8108043">Close</span><span class="op" id="8108048">(</span><span class="op" id="8108049">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8108052">serverSem</span>&nbsp;<span class="op" id="8108062">:=</span>&nbsp;<span class="builtinfunc" id="8108065">make</span><span class="op" id="8108069">(</span><span class="keyword" id="8108070">chan</span>&nbsp;<span class="builtintype" id="8108075">bool</span><span class="op" id="8108079">,</span>&nbsp;<span class="ident" id="8108081">numConcurrent</span><span class="op" id="8108094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8108097">//&nbsp;Acceptor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8108111">go</span>&nbsp;<span class="keyword" id="8108114">func</span><span class="op" id="8108118">(</span><span class="op" id="8108119">)</span>&nbsp;<span class="op" id="8108121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8108125">for</span>&nbsp;<span class="op" id="8108129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8108134">c</span><span class="op" id="8108135">,</span>&nbsp;<span class="ident" id="8108137">err</span>&nbsp;<span class="op" id="8108141">:=</span>&nbsp;<span class="ident" id="8108144">ln</span><span class="op" id="8108146">.</span><span class="ident" id="8108147">Accept</span><span class="op" id="8108153">(</span><span class="op" id="8108154">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8108159">if</span>&nbsp;<span class="ident" id="8108162">err</span>&nbsp;<span class="op" id="8108166">!=</span>&nbsp;<span class="ident" id="8108169">nil</span>&nbsp;<span class="op" id="8108173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8108179">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8108188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8108193">serverSem</span>&nbsp;<span class="op" id="8108203">&lt;-</span>&nbsp;<span class="builtintype" id="8108206">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8108214">//&nbsp;Server&nbsp;connection.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8108239">go</span>&nbsp;<span class="keyword" id="8108242">func</span><span class="op" id="8108246">(</span><span class="ident" id="8108247">c</span>&nbsp;<span class="ident" id="8108249">Conn</span><span class="op" id="8108253">)</span>&nbsp;<span class="op" id="8108255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8108261">defer</span>&nbsp;<span class="keyword" id="8108267">func</span><span class="op" id="8108271">(</span><span class="op" id="8108272">)</span>&nbsp;<span class="op" id="8108274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8108281">c</span><span class="op" id="8108282">.</span><span class="ident" id="8108283">Close</span><span class="op" id="8108288">(</span><span class="op" id="8108289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8108296">&lt;-</span><span class="ident" id="8108298">serverSem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8108312">}</span><span class="op" id="8108313">(</span><span class="op" id="8108314">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8108320">if</span>&nbsp;<span class="ident" id="8108323">timeout</span>&nbsp;<span class="op" id="8108331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8108338">c</span><span class="op" id="8108339">.</span><span class="ident" id="8108340">SetDeadline</span><span class="op" id="8108351">(</span><span class="ident" id="8108352">time</span><span class="op" id="8108356">.</span><span class="ident" id="8108357">Now</span><span class="op" id="8108360">(</span><span class="op" id="8108361">)</span><span class="op" id="8108362">.</span><span class="ident" id="8108363">Add</span><span class="op" id="8108366">(</span><span class="ident" id="8108367">time</span><span class="op" id="8108371">.</span><span class="ident" id="8108372">Hour</span><span class="op" id="8108376">)</span><span class="op" id="8108377">)</span>&nbsp;<span class="comment" id="8108379">//&nbsp;Not&nbsp;intended&nbsp;to&nbsp;fire.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8108408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8108414">var</span>&nbsp;<span class="ident" id="8108418">buf</span>&nbsp;<span class="op" id="8108422">[</span><span class="ident" id="8108423">msgLen</span><span class="op" id="8108429">]</span><span class="builtintype" id="8108430">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8108439">for</span>&nbsp;<span class="ident" id="8108443">m</span>&nbsp;<span class="op" id="8108445">:=</span>&nbsp;<span class="num" id="8108448">0</span><span class="op" id="8108449">;</span>&nbsp;<span class="ident" id="8108451">m</span>&nbsp;<span class="op" id="8108453">&lt;</span>&nbsp;<span class="ident" id="8108455">msgs</span><span class="op" id="8108459">;</span>&nbsp;<span class="ident" id="8108461">m</span><span class="op" id="8108462">++</span>&nbsp;<span class="op" id="8108465">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8108472">if</span>&nbsp;<span class="op" id="8108475">!</span><span class="ident" id="8108476">recvMsg</span><span class="op" id="8108483">(</span><span class="ident" id="8108484">c</span><span class="op" id="8108485">,</span>&nbsp;<span class="ident" id="8108487">buf</span><span class="op" id="8108490">[</span><span class="op" id="8108491">:</span><span class="op" id="8108492">]</span><span class="op" id="8108493">)</span>&nbsp;<span class="op" id="8108495">||</span>&nbsp;<span class="op" id="8108498">!</span><span class="ident" id="8108499">sendMsg</span><span class="op" id="8108506">(</span><span class="ident" id="8108507">c</span><span class="op" id="8108508">,</span>&nbsp;<span class="ident" id="8108510">buf</span><span class="op" id="8108513">[</span><span class="op" id="8108514">:</span><span class="op" id="8108515">]</span><span class="op" id="8108516">)</span>&nbsp;<span class="op" id="8108518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8108526">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8108537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8108543">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8108548">}</span><span class="op" id="8108549">(</span><span class="ident" id="8108550">c</span><span class="op" id="8108551">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8108555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8108558">}</span><span class="op" id="8108559">(</span><span class="op" id="8108560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8108563">clientSem</span>&nbsp;<span class="op" id="8108573">:=</span>&nbsp;<span class="builtinfunc" id="8108576">make</span><span class="op" id="8108580">(</span><span class="keyword" id="8108581">chan</span>&nbsp;<span class="builtintype" id="8108586">bool</span><span class="op" id="8108590">,</span>&nbsp;<span class="ident" id="8108592">numConcurrent</span><span class="op" id="8108605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8108608">for</span>&nbsp;<span class="ident" id="8108612">i</span>&nbsp;<span class="op" id="8108614">:=</span>&nbsp;<span class="num" id="8108617">0</span><span class="op" id="8108618">;</span>&nbsp;<span class="ident" id="8108620">i</span>&nbsp;<span class="op" id="8108622">&lt;</span>&nbsp;<span class="ident" id="8108624">conns</span><span class="op" id="8108629">;</span>&nbsp;<span class="ident" id="8108631">i</span><span class="op" id="8108632">++</span>&nbsp;<span class="op" id="8108635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8108639">clientSem</span>&nbsp;<span class="op" id="8108649">&lt;-</span>&nbsp;<span class="builtintype" id="8108652">true</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8108659">//&nbsp;Client&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8108683">go</span>&nbsp;<span class="keyword" id="8108686">func</span><span class="op" id="8108690">(</span><span class="op" id="8108691">)</span>&nbsp;<span class="op" id="8108693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8108698">defer</span>&nbsp;<span class="keyword" id="8108704">func</span><span class="op" id="8108708">(</span><span class="op" id="8108709">)</span>&nbsp;<span class="op" id="8108711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8108717">&lt;-</span><span class="ident" id="8108719">clientSem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8108732">}</span><span class="op" id="8108733">(</span><span class="op" id="8108734">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8108739">c</span><span class="op" id="8108740">,</span>&nbsp;<span class="ident" id="8108742">err</span>&nbsp;<span class="op" id="8108746">:=</span>&nbsp;<span class="ident" id="8108749">Dial</span><span class="op" id="8108753">(</span><span class="string" id="8108754">&#34;tcp&#34;</span><span class="op" id="8108759">,</span>&nbsp;<span class="ident" id="8108761">ln</span><span class="op" id="8108763">.</span><span class="ident" id="8108764">Addr</span><span class="op" id="8108768">(</span><span class="op" id="8108769">)</span><span class="op" id="8108770">.</span><span class="ident" id="8108771">String</span><span class="op" id="8108777">(</span><span class="op" id="8108778">)</span><span class="op" id="8108779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8108784">if</span>&nbsp;<span class="ident" id="8108787">err</span>&nbsp;<span class="op" id="8108791">!=</span>&nbsp;<span class="ident" id="8108794">nil</span>&nbsp;<span class="op" id="8108798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8108804">b</span><span class="op" id="8108805">.</span><span class="ident" id="8108806">Logf</span><span class="op" id="8108810">(</span><span class="string" id="8108811">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8108828">,</span>&nbsp;<span class="ident" id="8108830">err</span><span class="op" id="8108833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8108839">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8108849">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8108854">defer</span>&nbsp;<span class="ident" id="8108860">c</span><span class="op" id="8108861">.</span><span class="ident" id="8108862">Close</span><span class="op" id="8108867">(</span><span class="op" id="8108868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8108873">if</span>&nbsp;<span class="ident" id="8108876">timeout</span>&nbsp;<span class="op" id="8108884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8108890">c</span><span class="op" id="8108891">.</span><span class="ident" id="8108892">SetDeadline</span><span class="op" id="8108903">(</span><span class="ident" id="8108904">time</span><span class="op" id="8108908">.</span><span class="ident" id="8108909">Now</span><span class="op" id="8108912">(</span><span class="op" id="8108913">)</span><span class="op" id="8108914">.</span><span class="ident" id="8108915">Add</span><span class="op" id="8108918">(</span><span class="ident" id="8108919">time</span><span class="op" id="8108923">.</span><span class="ident" id="8108924">Hour</span><span class="op" id="8108928">)</span><span class="op" id="8108929">)</span>&nbsp;<span class="comment" id="8108931">//&nbsp;Not&nbsp;intended&nbsp;to&nbsp;fire.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8108959">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8108964">var</span>&nbsp;<span class="ident" id="8108968">buf</span>&nbsp;<span class="op" id="8108972">[</span><span class="ident" id="8108973">msgLen</span><span class="op" id="8108979">]</span><span class="builtintype" id="8108980">byte</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8108988">for</span>&nbsp;<span class="ident" id="8108992">m</span>&nbsp;<span class="op" id="8108994">:=</span>&nbsp;<span class="num" id="8108997">0</span><span class="op" id="8108998">;</span>&nbsp;<span class="ident" id="8109000">m</span>&nbsp;<span class="op" id="8109002">&lt;</span>&nbsp;<span class="ident" id="8109004">msgs</span><span class="op" id="8109008">;</span>&nbsp;<span class="ident" id="8109010">m</span><span class="op" id="8109011">++</span>&nbsp;<span class="op" id="8109014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8109020">if</span>&nbsp;<span class="op" id="8109023">!</span><span class="ident" id="8109024">sendMsg</span><span class="op" id="8109031">(</span><span class="ident" id="8109032">c</span><span class="op" id="8109033">,</span>&nbsp;<span class="ident" id="8109035">buf</span><span class="op" id="8109038">[</span><span class="op" id="8109039">:</span><span class="op" id="8109040">]</span><span class="op" id="8109041">)</span>&nbsp;<span class="op" id="8109043">||</span>&nbsp;<span class="op" id="8109046">!</span><span class="ident" id="8109047">recvMsg</span><span class="op" id="8109054">(</span><span class="ident" id="8109055">c</span><span class="op" id="8109056">,</span>&nbsp;<span class="ident" id="8109058">buf</span><span class="op" id="8109061">[</span><span class="op" id="8109062">:</span><span class="op" id="8109063">]</span><span class="op" id="8109064">)</span>&nbsp;<span class="op" id="8109066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8109073">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8109083">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8109088">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8109092">}</span><span class="op" id="8109093">(</span><span class="op" id="8109094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8109097">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8109100">for</span>&nbsp;<span class="ident" id="8109104">i</span>&nbsp;<span class="op" id="8109106">:=</span>&nbsp;<span class="num" id="8109109">0</span><span class="op" id="8109110">;</span>&nbsp;<span class="ident" id="8109112">i</span>&nbsp;<span class="op" id="8109114">&lt;</span>&nbsp;<span class="ident" id="8109116">numConcurrent</span><span class="op" id="8109129">;</span>&nbsp;<span class="ident" id="8109131">i</span><span class="op" id="8109132">++</span>&nbsp;<span class="op" id="8109135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8109139">clientSem</span>&nbsp;<span class="op" id="8109149">&lt;-</span>&nbsp;<span class="builtintype" id="8109152">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8109159">serverSem</span>&nbsp;<span class="op" id="8109169">&lt;-</span>&nbsp;<span class="builtintype" id="8109172">true</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8109178">}</span><br>
<span class="lineno"></span><span class="op" id="8109180">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8109183">func</span>&nbsp;<span class="ident" id="8109188">BenchmarkTCP4ConcurrentReadWrite</span><span class="op" id="8109220">(</span><span class="ident" id="8109221">b</span>&nbsp;<span class="op" id="8109223">*</span><span class="ident" id="8109224">testing</span><span class="op" id="8109231">.</span><span class="ident" id="8109232">B</span><span class="op" id="8109233">)</span>&nbsp;<span class="op" id="8109235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8109238">benchmarkTCPConcurrentReadWrite</span><span class="op" id="8109269">(</span><span class="ident" id="8109270">b</span><span class="op" id="8109271">,</span>&nbsp;<span class="string" id="8109273">&#34;127.0.0.1:0&#34;</span><span class="op" id="8109286">)</span><br>
<span class="lineno">160</span><span class="op" id="8109288">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8109291">func</span>&nbsp;<span class="ident" id="8109296">BenchmarkTCP6ConcurrentReadWrite</span><span class="op" id="8109328">(</span><span class="ident" id="8109329">b</span>&nbsp;<span class="op" id="8109331">*</span><span class="ident" id="8109332">testing</span><span class="op" id="8109339">.</span><span class="ident" id="8109340">B</span><span class="op" id="8109341">)</span>&nbsp;<span class="op" id="8109343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8109346">if</span>&nbsp;<span class="op" id="8109349">!</span><span class="ident" id="8109350">supportsIPv6</span>&nbsp;<span class="op" id="8109363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8109367">b</span><span class="op" id="8109368">.</span><span class="ident" id="8109369">Skip</span><span class="op" id="8109373">(</span><span class="string" id="8109374">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="8109397">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8109400">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8109403">benchmarkTCPConcurrentReadWrite</span><span class="op" id="8109434">(</span><span class="ident" id="8109435">b</span><span class="op" id="8109436">,</span>&nbsp;<span class="string" id="8109438">&#34;[::1]:0&#34;</span><span class="op" id="8109447">)</span><br>
<span class="lineno"></span><span class="op" id="8109449">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8109452">func</span>&nbsp;<span class="ident" id="8109457">benchmarkTCPConcurrentReadWrite</span><span class="op" id="8109488">(</span><span class="ident" id="8109489">b</span>&nbsp;<span class="op" id="8109491">*</span><span class="ident" id="8109492">testing</span><span class="op" id="8109499">.</span><span class="ident" id="8109500">B</span><span class="op" id="8109501">,</span>&nbsp;<span class="ident" id="8109503">laddr</span>&nbsp;<span class="builtintype" id="8109509">string</span><span class="op" id="8109515">)</span>&nbsp;<span class="op" id="8109517">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8109520">//&nbsp;The&nbsp;benchmark&nbsp;creates&nbsp;GOMAXPROCS&nbsp;client/server&nbsp;pairs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8109578">//&nbsp;Each&nbsp;pair&nbsp;creates&nbsp;4&nbsp;goroutines:&nbsp;client&nbsp;reader/writer&nbsp;and&nbsp;server&nbsp;reader/writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8109661">//&nbsp;The&nbsp;benchmark&nbsp;stresses&nbsp;concurrent&nbsp;reading&nbsp;and&nbsp;writing&nbsp;to&nbsp;the&nbsp;same&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8109743">//&nbsp;Such&nbsp;pattern&nbsp;is&nbsp;used&nbsp;in&nbsp;net/http&nbsp;and&nbsp;net/rpc.</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8109794">b</span><span class="op" id="8109795">.</span><span class="ident" id="8109796">StopTimer</span><span class="op" id="8109805">(</span><span class="op" id="8109806">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8109810">P</span>&nbsp;<span class="op" id="8109812">:=</span>&nbsp;<span class="ident" id="8109815">runtime</span><span class="op" id="8109822">.</span><span class="ident" id="8109823">GOMAXPROCS</span><span class="op" id="8109833">(</span><span class="num" id="8109834">0</span><span class="op" id="8109835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8109838">N</span>&nbsp;<span class="op" id="8109840">:=</span>&nbsp;<span class="ident" id="8109843">b</span><span class="op" id="8109844">.</span><span class="ident" id="8109845">N</span>&nbsp;<span class="op" id="8109847">/</span>&nbsp;<span class="ident" id="8109849">P</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8109852">W</span>&nbsp;<span class="op" id="8109854">:=</span>&nbsp;<span class="num" id="8109857">1000</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8109864">//&nbsp;Setup&nbsp;P&nbsp;client/server&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8109903">clients</span>&nbsp;<span class="op" id="8109911">:=</span>&nbsp;<span class="builtinfunc" id="8109914">make</span><span class="op" id="8109918">(</span><span class="op" id="8109919">[</span><span class="op" id="8109920">]</span><span class="ident" id="8109921">Conn</span><span class="op" id="8109925">,</span>&nbsp;<span class="ident" id="8109927">P</span><span class="op" id="8109928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8109931">servers</span>&nbsp;<span class="op" id="8109939">:=</span>&nbsp;<span class="builtinfunc" id="8109942">make</span><span class="op" id="8109946">(</span><span class="op" id="8109947">[</span><span class="op" id="8109948">]</span><span class="ident" id="8109949">Conn</span><span class="op" id="8109953">,</span>&nbsp;<span class="ident" id="8109955">P</span><span class="op" id="8109956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8109959">ln</span><span class="op" id="8109961">,</span>&nbsp;<span class="ident" id="8109963">err</span>&nbsp;<span class="op" id="8109967">:=</span>&nbsp;<span class="ident" id="8109970">Listen</span><span class="op" id="8109976">(</span><span class="string" id="8109977">&#34;tcp&#34;</span><span class="op" id="8109982">,</span>&nbsp;<span class="ident" id="8109984">laddr</span><span class="op" id="8109989">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8109992">if</span>&nbsp;<span class="ident" id="8109995">err</span>&nbsp;<span class="op" id="8109999">!=</span>&nbsp;<span class="ident" id="8110002">nil</span>&nbsp;<span class="op" id="8110006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8110010">b</span><span class="op" id="8110011">.</span><span class="ident" id="8110012">Fatalf</span><span class="op" id="8110018">(</span><span class="string" id="8110019">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8110038">,</span>&nbsp;<span class="ident" id="8110040">err</span><span class="op" id="8110043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8110046">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8110049">defer</span>&nbsp;<span class="ident" id="8110055">ln</span><span class="op" id="8110057">.</span><span class="ident" id="8110058">Close</span><span class="op" id="8110063">(</span><span class="op" id="8110064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8110067">done</span>&nbsp;<span class="op" id="8110072">:=</span>&nbsp;<span class="builtinfunc" id="8110075">make</span><span class="op" id="8110079">(</span><span class="keyword" id="8110080">chan</span>&nbsp;<span class="builtintype" id="8110085">bool</span><span class="op" id="8110089">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8110092">go</span>&nbsp;<span class="keyword" id="8110095">func</span><span class="op" id="8110099">(</span><span class="op" id="8110100">)</span>&nbsp;<span class="op" id="8110102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8110106">for</span>&nbsp;<span class="ident" id="8110110">p</span>&nbsp;<span class="op" id="8110112">:=</span>&nbsp;<span class="num" id="8110115">0</span><span class="op" id="8110116">;</span>&nbsp;<span class="ident" id="8110118">p</span>&nbsp;<span class="op" id="8110120">&lt;</span>&nbsp;<span class="ident" id="8110122">P</span><span class="op" id="8110123">;</span>&nbsp;<span class="ident" id="8110125">p</span><span class="op" id="8110126">++</span>&nbsp;<span class="op" id="8110129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8110134">s</span><span class="op" id="8110135">,</span>&nbsp;<span class="ident" id="8110137">err</span>&nbsp;<span class="op" id="8110141">:=</span>&nbsp;<span class="ident" id="8110144">ln</span><span class="op" id="8110146">.</span><span class="ident" id="8110147">Accept</span><span class="op" id="8110153">(</span><span class="op" id="8110154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8110159">if</span>&nbsp;<span class="ident" id="8110162">err</span>&nbsp;<span class="op" id="8110166">!=</span>&nbsp;<span class="ident" id="8110169">nil</span>&nbsp;<span class="op" id="8110173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8110179">b</span><span class="op" id="8110180">.</span><span class="ident" id="8110181">Errorf</span><span class="op" id="8110187">(</span><span class="string" id="8110188">&#34;Accept&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8110207">,</span>&nbsp;<span class="ident" id="8110209">err</span><span class="op" id="8110212">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8110218">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8110228">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8110233">servers</span><span class="op" id="8110240">[</span><span class="ident" id="8110241">p</span><span class="op" id="8110242">]</span>&nbsp;<span class="op" id="8110244">=</span>&nbsp;<span class="ident" id="8110246">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8110250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8110254">done</span>&nbsp;<span class="op" id="8110259">&lt;-</span>&nbsp;<span class="builtintype" id="8110262">true</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8110268">}</span><span class="op" id="8110269">(</span><span class="op" id="8110270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8110273">for</span>&nbsp;<span class="ident" id="8110277">p</span>&nbsp;<span class="op" id="8110279">:=</span>&nbsp;<span class="num" id="8110282">0</span><span class="op" id="8110283">;</span>&nbsp;<span class="ident" id="8110285">p</span>&nbsp;<span class="op" id="8110287">&lt;</span>&nbsp;<span class="ident" id="8110289">P</span><span class="op" id="8110290">;</span>&nbsp;<span class="ident" id="8110292">p</span><span class="op" id="8110293">++</span>&nbsp;<span class="op" id="8110296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8110300">c</span><span class="op" id="8110301">,</span>&nbsp;<span class="ident" id="8110303">err</span>&nbsp;<span class="op" id="8110307">:=</span>&nbsp;<span class="ident" id="8110310">Dial</span><span class="op" id="8110314">(</span><span class="string" id="8110315">&#34;tcp&#34;</span><span class="op" id="8110320">,</span>&nbsp;<span class="ident" id="8110322">ln</span><span class="op" id="8110324">.</span><span class="ident" id="8110325">Addr</span><span class="op" id="8110329">(</span><span class="op" id="8110330">)</span><span class="op" id="8110331">.</span><span class="ident" id="8110332">String</span><span class="op" id="8110338">(</span><span class="op" id="8110339">)</span><span class="op" id="8110340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8110344">if</span>&nbsp;<span class="ident" id="8110347">err</span>&nbsp;<span class="op" id="8110351">!=</span>&nbsp;<span class="ident" id="8110354">nil</span>&nbsp;<span class="op" id="8110358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8110363">b</span><span class="op" id="8110364">.</span><span class="ident" id="8110365">Fatalf</span><span class="op" id="8110371">(</span><span class="string" id="8110372">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8110389">,</span>&nbsp;<span class="ident" id="8110391">err</span><span class="op" id="8110394">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8110398">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8110402">clients</span><span class="op" id="8110409">[</span><span class="ident" id="8110410">p</span><span class="op" id="8110411">]</span>&nbsp;<span class="op" id="8110413">=</span>&nbsp;<span class="ident" id="8110415">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8110418">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8110421">&lt;-</span><span class="ident" id="8110423">done</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8110430">b</span><span class="op" id="8110431">.</span><span class="ident" id="8110432">StartTimer</span><span class="op" id="8110442">(</span><span class="op" id="8110443">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8110447">var</span>&nbsp;<span class="ident" id="8110451">wg</span>&nbsp;<span class="ident" id="8110454">sync</span><span class="op" id="8110458">.</span><span class="ident" id="8110459">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8110470">wg</span><span class="op" id="8110472">.</span><span class="ident" id="8110473">Add</span><span class="op" id="8110476">(</span><span class="num" id="8110477">4</span>&nbsp;<span class="op" id="8110479">*</span>&nbsp;<span class="ident" id="8110481">P</span><span class="op" id="8110482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8110485">for</span>&nbsp;<span class="ident" id="8110489">p</span>&nbsp;<span class="op" id="8110491">:=</span>&nbsp;<span class="num" id="8110494">0</span><span class="op" id="8110495">;</span>&nbsp;<span class="ident" id="8110497">p</span>&nbsp;<span class="op" id="8110499">&lt;</span>&nbsp;<span class="ident" id="8110501">P</span><span class="op" id="8110502">;</span>&nbsp;<span class="ident" id="8110504">p</span><span class="op" id="8110505">++</span>&nbsp;<span class="op" id="8110508">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8110512">//&nbsp;Client&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8110532">go</span>&nbsp;<span class="keyword" id="8110535">func</span><span class="op" id="8110539">(</span><span class="ident" id="8110540">c</span>&nbsp;<span class="ident" id="8110542">Conn</span><span class="op" id="8110546">)</span>&nbsp;<span class="op" id="8110548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8110553">defer</span>&nbsp;<span class="ident" id="8110559">wg</span><span class="op" id="8110561">.</span><span class="ident" id="8110562">Done</span><span class="op" id="8110566">(</span><span class="op" id="8110567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8110572">var</span>&nbsp;<span class="ident" id="8110576">buf</span>&nbsp;<span class="op" id="8110580">[</span><span class="num" id="8110581">1</span><span class="op" id="8110582">]</span><span class="builtintype" id="8110583">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8110591">for</span>&nbsp;<span class="ident" id="8110595">i</span>&nbsp;<span class="op" id="8110597">:=</span>&nbsp;<span class="num" id="8110600">0</span><span class="op" id="8110601">;</span>&nbsp;<span class="ident" id="8110603">i</span>&nbsp;<span class="op" id="8110605">&lt;</span>&nbsp;<span class="ident" id="8110607">N</span><span class="op" id="8110608">;</span>&nbsp;<span class="ident" id="8110610">i</span><span class="op" id="8110611">++</span>&nbsp;<span class="op" id="8110614">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8110620">v</span>&nbsp;<span class="op" id="8110622">:=</span>&nbsp;<span class="builtintype" id="8110625">byte</span><span class="op" id="8110629">(</span><span class="ident" id="8110630">i</span><span class="op" id="8110631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8110637">for</span>&nbsp;<span class="ident" id="8110641">w</span>&nbsp;<span class="op" id="8110643">:=</span>&nbsp;<span class="num" id="8110646">0</span><span class="op" id="8110647">;</span>&nbsp;<span class="ident" id="8110649">w</span>&nbsp;<span class="op" id="8110651">&lt;</span>&nbsp;<span class="ident" id="8110653">W</span><span class="op" id="8110654">;</span>&nbsp;<span class="ident" id="8110656">w</span><span class="op" id="8110657">++</span>&nbsp;<span class="op" id="8110660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8110667">v</span>&nbsp;<span class="op" id="8110669">*=</span>&nbsp;<span class="ident" id="8110672">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8110678">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8110684">buf</span><span class="op" id="8110687">[</span><span class="num" id="8110688">0</span><span class="op" id="8110689">]</span>&nbsp;<span class="op" id="8110691">=</span>&nbsp;<span class="ident" id="8110693">v</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8110699">_</span><span class="op" id="8110700">,</span>&nbsp;<span class="ident" id="8110702">err</span>&nbsp;<span class="op" id="8110706">:=</span>&nbsp;<span class="ident" id="8110709">c</span><span class="op" id="8110710">.</span><span class="ident" id="8110711">Write</span><span class="op" id="8110716">(</span><span class="ident" id="8110717">buf</span><span class="op" id="8110720">[</span><span class="op" id="8110721">:</span><span class="op" id="8110722">]</span><span class="op" id="8110723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8110729">if</span>&nbsp;<span class="ident" id="8110732">err</span>&nbsp;<span class="op" id="8110736">!=</span>&nbsp;<span class="ident" id="8110739">nil</span>&nbsp;<span class="op" id="8110743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8110750">b</span><span class="op" id="8110751">.</span><span class="ident" id="8110752">Errorf</span><span class="op" id="8110758">(</span><span class="string" id="8110759">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8110777">,</span>&nbsp;<span class="ident" id="8110779">err</span><span class="op" id="8110782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8110789">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8110800">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8110805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8110809">}</span><span class="op" id="8110810">(</span><span class="ident" id="8110811">clients</span><span class="op" id="8110818">[</span><span class="ident" id="8110819">p</span><span class="op" id="8110820">]</span><span class="op" id="8110821">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8110826">//&nbsp;Pipe&nbsp;between&nbsp;server&nbsp;reader&nbsp;and&nbsp;server&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8110877">pipe</span>&nbsp;<span class="op" id="8110882">:=</span>&nbsp;<span class="builtinfunc" id="8110885">make</span><span class="op" id="8110889">(</span><span class="keyword" id="8110890">chan</span>&nbsp;<span class="builtintype" id="8110895">byte</span><span class="op" id="8110899">,</span>&nbsp;<span class="num" id="8110901">128</span><span class="op" id="8110904">)</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8110909">//&nbsp;Server&nbsp;reader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8110929">go</span>&nbsp;<span class="keyword" id="8110932">func</span><span class="op" id="8110936">(</span><span class="ident" id="8110937">s</span>&nbsp;<span class="ident" id="8110939">Conn</span><span class="op" id="8110943">)</span>&nbsp;<span class="op" id="8110945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8110950">defer</span>&nbsp;<span class="ident" id="8110956">wg</span><span class="op" id="8110958">.</span><span class="ident" id="8110959">Done</span><span class="op" id="8110963">(</span><span class="op" id="8110964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8110969">var</span>&nbsp;<span class="ident" id="8110973">buf</span>&nbsp;<span class="op" id="8110977">[</span><span class="num" id="8110978">1</span><span class="op" id="8110979">]</span><span class="builtintype" id="8110980">byte</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8110988">for</span>&nbsp;<span class="ident" id="8110992">i</span>&nbsp;<span class="op" id="8110994">:=</span>&nbsp;<span class="num" id="8110997">0</span><span class="op" id="8110998">;</span>&nbsp;<span class="ident" id="8111000">i</span>&nbsp;<span class="op" id="8111002">&lt;</span>&nbsp;<span class="ident" id="8111004">N</span><span class="op" id="8111005">;</span>&nbsp;<span class="ident" id="8111007">i</span><span class="op" id="8111008">++</span>&nbsp;<span class="op" id="8111011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8111017">_</span><span class="op" id="8111018">,</span>&nbsp;<span class="ident" id="8111020">err</span>&nbsp;<span class="op" id="8111024">:=</span>&nbsp;<span class="ident" id="8111027">s</span><span class="op" id="8111028">.</span><span class="ident" id="8111029">Read</span><span class="op" id="8111033">(</span><span class="ident" id="8111034">buf</span><span class="op" id="8111037">[</span><span class="op" id="8111038">:</span><span class="op" id="8111039">]</span><span class="op" id="8111040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8111046">if</span>&nbsp;<span class="ident" id="8111049">err</span>&nbsp;<span class="op" id="8111053">!=</span>&nbsp;<span class="ident" id="8111056">nil</span>&nbsp;<span class="op" id="8111060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8111067">b</span><span class="op" id="8111068">.</span><span class="ident" id="8111069">Errorf</span><span class="op" id="8111075">(</span><span class="string" id="8111076">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8111093">,</span>&nbsp;<span class="ident" id="8111095">err</span><span class="op" id="8111098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8111105">return</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8111116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8111122">pipe</span>&nbsp;<span class="op" id="8111127">&lt;-</span>&nbsp;<span class="ident" id="8111130">buf</span><span class="op" id="8111133">[</span><span class="num" id="8111134">0</span><span class="op" id="8111135">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8111140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8111144">}</span><span class="op" id="8111145">(</span><span class="ident" id="8111146">servers</span><span class="op" id="8111153">[</span><span class="ident" id="8111154">p</span><span class="op" id="8111155">]</span><span class="op" id="8111156">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8111161">//&nbsp;Server&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8111181">go</span>&nbsp;<span class="keyword" id="8111184">func</span><span class="op" id="8111188">(</span><span class="ident" id="8111189">s</span>&nbsp;<span class="ident" id="8111191">Conn</span><span class="op" id="8111195">)</span>&nbsp;<span class="op" id="8111197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8111202">defer</span>&nbsp;<span class="ident" id="8111208">wg</span><span class="op" id="8111210">.</span><span class="ident" id="8111211">Done</span><span class="op" id="8111215">(</span><span class="op" id="8111216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8111221">var</span>&nbsp;<span class="ident" id="8111225">buf</span>&nbsp;<span class="op" id="8111229">[</span><span class="num" id="8111230">1</span><span class="op" id="8111231">]</span><span class="builtintype" id="8111232">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8111240">for</span>&nbsp;<span class="ident" id="8111244">i</span>&nbsp;<span class="op" id="8111246">:=</span>&nbsp;<span class="num" id="8111249">0</span><span class="op" id="8111250">;</span>&nbsp;<span class="ident" id="8111252">i</span>&nbsp;<span class="op" id="8111254">&lt;</span>&nbsp;<span class="ident" id="8111256">N</span><span class="op" id="8111257">;</span>&nbsp;<span class="ident" id="8111259">i</span><span class="op" id="8111260">++</span>&nbsp;<span class="op" id="8111263">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8111269">v</span>&nbsp;<span class="op" id="8111271">:=</span>&nbsp;<span class="op" id="8111274">&lt;-</span><span class="ident" id="8111276">pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8111285">for</span>&nbsp;<span class="ident" id="8111289">w</span>&nbsp;<span class="op" id="8111291">:=</span>&nbsp;<span class="num" id="8111294">0</span><span class="op" id="8111295">;</span>&nbsp;<span class="ident" id="8111297">w</span>&nbsp;<span class="op" id="8111299">&lt;</span>&nbsp;<span class="ident" id="8111301">W</span><span class="op" id="8111302">;</span>&nbsp;<span class="ident" id="8111304">w</span><span class="op" id="8111305">++</span>&nbsp;<span class="op" id="8111308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8111315">v</span>&nbsp;<span class="op" id="8111317">*=</span>&nbsp;<span class="ident" id="8111320">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8111326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8111332">buf</span><span class="op" id="8111335">[</span><span class="num" id="8111336">0</span><span class="op" id="8111337">]</span>&nbsp;<span class="op" id="8111339">=</span>&nbsp;<span class="ident" id="8111341">v</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8111347">_</span><span class="op" id="8111348">,</span>&nbsp;<span class="ident" id="8111350">err</span>&nbsp;<span class="op" id="8111354">:=</span>&nbsp;<span class="ident" id="8111357">s</span><span class="op" id="8111358">.</span><span class="ident" id="8111359">Write</span><span class="op" id="8111364">(</span><span class="ident" id="8111365">buf</span><span class="op" id="8111368">[</span><span class="op" id="8111369">:</span><span class="op" id="8111370">]</span><span class="op" id="8111371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8111377">if</span>&nbsp;<span class="ident" id="8111380">err</span>&nbsp;<span class="op" id="8111384">!=</span>&nbsp;<span class="ident" id="8111387">nil</span>&nbsp;<span class="op" id="8111391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8111398">b</span><span class="op" id="8111399">.</span><span class="ident" id="8111400">Errorf</span><span class="op" id="8111406">(</span><span class="string" id="8111407">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8111425">,</span>&nbsp;<span class="ident" id="8111427">err</span><span class="op" id="8111430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8111437">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8111448">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8111453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8111458">s</span><span class="op" id="8111459">.</span><span class="ident" id="8111460">Close</span><span class="op" id="8111465">(</span><span class="op" id="8111466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8111470">}</span><span class="op" id="8111471">(</span><span class="ident" id="8111472">servers</span><span class="op" id="8111479">[</span><span class="ident" id="8111480">p</span><span class="op" id="8111481">]</span><span class="op" id="8111482">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8111487">//&nbsp;Client&nbsp;reader.</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8111507">go</span>&nbsp;<span class="keyword" id="8111510">func</span><span class="op" id="8111514">(</span><span class="ident" id="8111515">c</span>&nbsp;<span class="ident" id="8111517">Conn</span><span class="op" id="8111521">)</span>&nbsp;<span class="op" id="8111523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8111528">defer</span>&nbsp;<span class="ident" id="8111534">wg</span><span class="op" id="8111536">.</span><span class="ident" id="8111537">Done</span><span class="op" id="8111541">(</span><span class="op" id="8111542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8111547">var</span>&nbsp;<span class="ident" id="8111551">buf</span>&nbsp;<span class="op" id="8111555">[</span><span class="num" id="8111556">1</span><span class="op" id="8111557">]</span><span class="builtintype" id="8111558">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8111566">for</span>&nbsp;<span class="ident" id="8111570">i</span>&nbsp;<span class="op" id="8111572">:=</span>&nbsp;<span class="num" id="8111575">0</span><span class="op" id="8111576">;</span>&nbsp;<span class="ident" id="8111578">i</span>&nbsp;<span class="op" id="8111580">&lt;</span>&nbsp;<span class="ident" id="8111582">N</span><span class="op" id="8111583">;</span>&nbsp;<span class="ident" id="8111585">i</span><span class="op" id="8111586">++</span>&nbsp;<span class="op" id="8111589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8111595">_</span><span class="op" id="8111596">,</span>&nbsp;<span class="ident" id="8111598">err</span>&nbsp;<span class="op" id="8111602">:=</span>&nbsp;<span class="ident" id="8111605">c</span><span class="op" id="8111606">.</span><span class="ident" id="8111607">Read</span><span class="op" id="8111611">(</span><span class="ident" id="8111612">buf</span><span class="op" id="8111615">[</span><span class="op" id="8111616">:</span><span class="op" id="8111617">]</span><span class="op" id="8111618">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8111624">if</span>&nbsp;<span class="ident" id="8111627">err</span>&nbsp;<span class="op" id="8111631">!=</span>&nbsp;<span class="ident" id="8111634">nil</span>&nbsp;<span class="op" id="8111638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8111645">b</span><span class="op" id="8111646">.</span><span class="ident" id="8111647">Errorf</span><span class="op" id="8111653">(</span><span class="string" id="8111654">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8111671">,</span>&nbsp;<span class="ident" id="8111673">err</span><span class="op" id="8111676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8111683">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8111694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8111699">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8111704">c</span><span class="op" id="8111705">.</span><span class="ident" id="8111706">Close</span><span class="op" id="8111711">(</span><span class="op" id="8111712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8111716">}</span><span class="op" id="8111717">(</span><span class="ident" id="8111718">clients</span><span class="op" id="8111725">[</span><span class="ident" id="8111726">p</span><span class="op" id="8111727">]</span><span class="op" id="8111728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8111731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8111734">wg</span><span class="op" id="8111736">.</span><span class="ident" id="8111737">Wait</span><span class="op" id="8111741">(</span><span class="op" id="8111742">)</span><br>
<span class="lineno"></span><span class="op" id="8111744">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="keyword" id="8111747">type</span>&nbsp;<span class="ident" id="8111752">resolveTCPAddrTest</span>&nbsp;<span class="keyword" id="8111771">struct</span>&nbsp;<span class="op" id="8111778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8111781">net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8111795">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8111803">litAddrOrName</span>&nbsp;<span class="builtintype" id="8111817">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8111825">addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8111839">*</span><span class="ident" id="8111840">TCPAddr</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8111849">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8111863">error</span><br>
<span class="lineno"></span><span class="op" id="8111869">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8111872">var</span>&nbsp;<span class="ident" id="8111876">resolveTCPAddrTests</span>&nbsp;<span class="op" id="8111896">=</span>&nbsp;<span class="op" id="8111898">[</span><span class="op" id="8111899">]</span><span class="ident" id="8111900">resolveTCPAddrTest</span><span class="op" id="8111918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8111921">{</span><span class="string" id="8111922">&#34;tcp&#34;</span><span class="op" id="8111927">,</span>&nbsp;<span class="string" id="8111929">&#34;127.0.0.1:0&#34;</span><span class="op" id="8111942">,</span>&nbsp;<span class="op" id="8111944">&amp;</span><span class="ident" id="8111945">TCPAddr</span><span class="op" id="8111952">{</span><span class="ident" id="8111953">IP</span><span class="op" id="8111955">:</span>&nbsp;<span class="ident" id="8111957">IPv4</span><span class="op" id="8111961">(</span><span class="num" id="8111962">127</span><span class="op" id="8111965">,</span>&nbsp;<span class="num" id="8111967">0</span><span class="op" id="8111968">,</span>&nbsp;<span class="num" id="8111970">0</span><span class="op" id="8111971">,</span>&nbsp;<span class="num" id="8111973">1</span><span class="op" id="8111974">)</span><span class="op" id="8111975">,</span>&nbsp;<span class="ident" id="8111977">Port</span><span class="op" id="8111981">:</span>&nbsp;<span class="num" id="8111983">0</span><span class="op" id="8111984">}</span><span class="op" id="8111985">,</span>&nbsp;<span class="ident" id="8111987">nil</span><span class="op" id="8111990">}</span><span class="op" id="8111991">,</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8111994">{</span><span class="string" id="8111995">&#34;tcp4&#34;</span><span class="op" id="8112001">,</span>&nbsp;<span class="string" id="8112003">&#34;127.0.0.1:65535&#34;</span><span class="op" id="8112020">,</span>&nbsp;<span class="op" id="8112022">&amp;</span><span class="ident" id="8112023">TCPAddr</span><span class="op" id="8112030">{</span><span class="ident" id="8112031">IP</span><span class="op" id="8112033">:</span>&nbsp;<span class="ident" id="8112035">IPv4</span><span class="op" id="8112039">(</span><span class="num" id="8112040">127</span><span class="op" id="8112043">,</span>&nbsp;<span class="num" id="8112045">0</span><span class="op" id="8112046">,</span>&nbsp;<span class="num" id="8112048">0</span><span class="op" id="8112049">,</span>&nbsp;<span class="num" id="8112051">1</span><span class="op" id="8112052">)</span><span class="op" id="8112053">,</span>&nbsp;<span class="ident" id="8112055">Port</span><span class="op" id="8112059">:</span>&nbsp;<span class="num" id="8112061">65535</span><span class="op" id="8112066">}</span><span class="op" id="8112067">,</span>&nbsp;<span class="ident" id="8112069">nil</span><span class="op" id="8112072">}</span><span class="op" id="8112073">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8112077">{</span><span class="string" id="8112078">&#34;tcp&#34;</span><span class="op" id="8112083">,</span>&nbsp;<span class="string" id="8112085">&#34;[::1]:1&#34;</span><span class="op" id="8112094">,</span>&nbsp;<span class="op" id="8112096">&amp;</span><span class="ident" id="8112097">TCPAddr</span><span class="op" id="8112104">{</span><span class="ident" id="8112105">IP</span><span class="op" id="8112107">:</span>&nbsp;<span class="ident" id="8112109">ParseIP</span><span class="op" id="8112116">(</span><span class="string" id="8112117">&#34;::1&#34;</span><span class="op" id="8112122">)</span><span class="op" id="8112123">,</span>&nbsp;<span class="ident" id="8112125">Port</span><span class="op" id="8112129">:</span>&nbsp;<span class="num" id="8112131">1</span><span class="op" id="8112132">}</span><span class="op" id="8112133">,</span>&nbsp;<span class="ident" id="8112135">nil</span><span class="op" id="8112138">}</span><span class="op" id="8112139">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8112142">{</span><span class="string" id="8112143">&#34;tcp6&#34;</span><span class="op" id="8112149">,</span>&nbsp;<span class="string" id="8112151">&#34;[::1]:65534&#34;</span><span class="op" id="8112164">,</span>&nbsp;<span class="op" id="8112166">&amp;</span><span class="ident" id="8112167">TCPAddr</span><span class="op" id="8112174">{</span><span class="ident" id="8112175">IP</span><span class="op" id="8112177">:</span>&nbsp;<span class="ident" id="8112179">ParseIP</span><span class="op" id="8112186">(</span><span class="string" id="8112187">&#34;::1&#34;</span><span class="op" id="8112192">)</span><span class="op" id="8112193">,</span>&nbsp;<span class="ident" id="8112195">Port</span><span class="op" id="8112199">:</span>&nbsp;<span class="num" id="8112201">65534</span><span class="op" id="8112206">}</span><span class="op" id="8112207">,</span>&nbsp;<span class="ident" id="8112209">nil</span><span class="op" id="8112212">}</span><span class="op" id="8112213">,</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8112217">{</span><span class="string" id="8112218">&#34;tcp&#34;</span><span class="op" id="8112223">,</span>&nbsp;<span class="string" id="8112225">&#34;[::1%en0]:1&#34;</span><span class="op" id="8112238">,</span>&nbsp;<span class="op" id="8112240">&amp;</span><span class="ident" id="8112241">TCPAddr</span><span class="op" id="8112248">{</span><span class="ident" id="8112249">IP</span><span class="op" id="8112251">:</span>&nbsp;<span class="ident" id="8112253">ParseIP</span><span class="op" id="8112260">(</span><span class="string" id="8112261">&#34;::1&#34;</span><span class="op" id="8112266">)</span><span class="op" id="8112267">,</span>&nbsp;<span class="ident" id="8112269">Port</span><span class="op" id="8112273">:</span>&nbsp;<span class="num" id="8112275">1</span><span class="op" id="8112276">,</span>&nbsp;<span class="ident" id="8112278">Zone</span><span class="op" id="8112282">:</span>&nbsp;<span class="string" id="8112284">&#34;en0&#34;</span><span class="op" id="8112289">}</span><span class="op" id="8112290">,</span>&nbsp;<span class="ident" id="8112292">nil</span><span class="op" id="8112295">}</span><span class="op" id="8112296">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8112299">{</span><span class="string" id="8112300">&#34;tcp6&#34;</span><span class="op" id="8112306">,</span>&nbsp;<span class="string" id="8112308">&#34;[::1%911]:2&#34;</span><span class="op" id="8112321">,</span>&nbsp;<span class="op" id="8112323">&amp;</span><span class="ident" id="8112324">TCPAddr</span><span class="op" id="8112331">{</span><span class="ident" id="8112332">IP</span><span class="op" id="8112334">:</span>&nbsp;<span class="ident" id="8112336">ParseIP</span><span class="op" id="8112343">(</span><span class="string" id="8112344">&#34;::1&#34;</span><span class="op" id="8112349">)</span><span class="op" id="8112350">,</span>&nbsp;<span class="ident" id="8112352">Port</span><span class="op" id="8112356">:</span>&nbsp;<span class="num" id="8112358">2</span><span class="op" id="8112359">,</span>&nbsp;<span class="ident" id="8112361">Zone</span><span class="op" id="8112365">:</span>&nbsp;<span class="string" id="8112367">&#34;911&#34;</span><span class="op" id="8112372">}</span><span class="op" id="8112373">,</span>&nbsp;<span class="ident" id="8112375">nil</span><span class="op" id="8112378">}</span><span class="op" id="8112379">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8112383">{</span><span class="string" id="8112384">&#34;&#34;</span><span class="op" id="8112386">,</span>&nbsp;<span class="string" id="8112388">&#34;127.0.0.1:0&#34;</span><span class="op" id="8112401">,</span>&nbsp;<span class="op" id="8112403">&amp;</span><span class="ident" id="8112404">TCPAddr</span><span class="op" id="8112411">{</span><span class="ident" id="8112412">IP</span><span class="op" id="8112414">:</span>&nbsp;<span class="ident" id="8112416">IPv4</span><span class="op" id="8112420">(</span><span class="num" id="8112421">127</span><span class="op" id="8112424">,</span>&nbsp;<span class="num" id="8112426">0</span><span class="op" id="8112427">,</span>&nbsp;<span class="num" id="8112429">0</span><span class="op" id="8112430">,</span>&nbsp;<span class="num" id="8112432">1</span><span class="op" id="8112433">)</span><span class="op" id="8112434">,</span>&nbsp;<span class="ident" id="8112436">Port</span><span class="op" id="8112440">:</span>&nbsp;<span class="num" id="8112442">0</span><span class="op" id="8112443">}</span><span class="op" id="8112444">,</span>&nbsp;<span class="ident" id="8112446">nil</span><span class="op" id="8112449">}</span><span class="op" id="8112450">,</span>&nbsp;<span class="comment" id="8112452">//&nbsp;Go&nbsp;1.0&nbsp;behavior</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8112472">{</span><span class="string" id="8112473">&#34;&#34;</span><span class="op" id="8112475">,</span>&nbsp;<span class="string" id="8112477">&#34;[::1]:0&#34;</span><span class="op" id="8112486">,</span>&nbsp;<span class="op" id="8112488">&amp;</span><span class="ident" id="8112489">TCPAddr</span><span class="op" id="8112496">{</span><span class="ident" id="8112497">IP</span><span class="op" id="8112499">:</span>&nbsp;<span class="ident" id="8112501">ParseIP</span><span class="op" id="8112508">(</span><span class="string" id="8112509">&#34;::1&#34;</span><span class="op" id="8112514">)</span><span class="op" id="8112515">,</span>&nbsp;<span class="ident" id="8112517">Port</span><span class="op" id="8112521">:</span>&nbsp;<span class="num" id="8112523">0</span><span class="op" id="8112524">}</span><span class="op" id="8112525">,</span>&nbsp;<span class="ident" id="8112527">nil</span><span class="op" id="8112530">}</span><span class="op" id="8112531">,</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8112541">//&nbsp;Go&nbsp;1.0&nbsp;behavior</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8112562">{</span><span class="string" id="8112563">&#34;tcp&#34;</span><span class="op" id="8112568">,</span>&nbsp;<span class="string" id="8112570">&#34;:12345&#34;</span><span class="op" id="8112578">,</span>&nbsp;<span class="op" id="8112580">&amp;</span><span class="ident" id="8112581">TCPAddr</span><span class="op" id="8112588">{</span><span class="ident" id="8112589">Port</span><span class="op" id="8112593">:</span>&nbsp;<span class="num" id="8112595">12345</span><span class="op" id="8112600">}</span><span class="op" id="8112601">,</span>&nbsp;<span class="ident" id="8112603">nil</span><span class="op" id="8112606">}</span><span class="op" id="8112607">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8112611">{</span><span class="string" id="8112612">&#34;http&#34;</span><span class="op" id="8112618">,</span>&nbsp;<span class="string" id="8112620">&#34;127.0.0.1:0&#34;</span><span class="op" id="8112633">,</span>&nbsp;<span class="ident" id="8112635">nil</span><span class="op" id="8112638">,</span>&nbsp;<span class="ident" id="8112640">UnknownNetworkError</span><span class="op" id="8112659">(</span><span class="string" id="8112660">&#34;http&#34;</span><span class="op" id="8112666">)</span><span class="op" id="8112667">}</span><span class="op" id="8112668">,</span><br>
<span class="lineno"></span><span class="op" id="8112670">}</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span><span class="keyword" id="8112673">func</span>&nbsp;<span class="ident" id="8112678">init</span><span class="op" id="8112682">(</span><span class="op" id="8112683">)</span>&nbsp;<span class="op" id="8112685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8112688">if</span>&nbsp;<span class="ident" id="8112691">ifi</span>&nbsp;<span class="op" id="8112695">:=</span>&nbsp;<span class="ident" id="8112698">loopbackInterface</span><span class="op" id="8112715">(</span><span class="op" id="8112716">)</span><span class="op" id="8112717">;</span>&nbsp;<span class="ident" id="8112719">ifi</span>&nbsp;<span class="op" id="8112723">!=</span>&nbsp;<span class="ident" id="8112726">nil</span>&nbsp;<span class="op" id="8112730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8112734">index</span>&nbsp;<span class="op" id="8112740">:=</span>&nbsp;<span class="ident" id="8112743">fmt</span><span class="op" id="8112746">.</span><span class="ident" id="8112747">Sprintf</span><span class="op" id="8112754">(</span><span class="string" id="8112755">&#34;%v&#34;</span><span class="op" id="8112759">,</span>&nbsp;<span class="ident" id="8112761">ifi</span><span class="op" id="8112764">.</span><span class="ident" id="8112765">Index</span><span class="op" id="8112770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8112774">resolveTCPAddrTests</span>&nbsp;<span class="op" id="8112794">=</span>&nbsp;<span class="builtinfunc" id="8112796">append</span><span class="op" id="8112802">(</span><span class="ident" id="8112803">resolveTCPAddrTests</span><span class="op" id="8112822">,</span>&nbsp;<span class="op" id="8112824">[</span><span class="op" id="8112825">]</span><span class="ident" id="8112826">resolveTCPAddrTest</span><span class="op" id="8112844">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8112849">{</span><span class="string" id="8112850">&#34;tcp6&#34;</span><span class="op" id="8112856">,</span>&nbsp;<span class="string" id="8112858">&#34;[fe80::1%&#34;</span>&nbsp;<span class="op" id="8112870">+</span>&nbsp;<span class="ident" id="8112872">ifi</span><span class="op" id="8112875">.</span><span class="ident" id="8112876">Name</span>&nbsp;<span class="op" id="8112881">+</span>&nbsp;<span class="string" id="8112883">&#34;]:3&#34;</span><span class="op" id="8112888">,</span>&nbsp;<span class="op" id="8112890">&amp;</span><span class="ident" id="8112891">TCPAddr</span><span class="op" id="8112898">{</span><span class="ident" id="8112899">IP</span><span class="op" id="8112901">:</span>&nbsp;<span class="ident" id="8112903">ParseIP</span><span class="op" id="8112910">(</span><span class="string" id="8112911">&#34;fe80::1&#34;</span><span class="op" id="8112920">)</span><span class="op" id="8112921">,</span>&nbsp;<span class="ident" id="8112923">Port</span><span class="op" id="8112927">:</span>&nbsp;<span class="num" id="8112929">3</span><span class="op" id="8112930">,</span>&nbsp;<span class="ident" id="8112932">Zone</span><span class="op" id="8112936">:</span>&nbsp;<span class="ident" id="8112938">zoneToString</span><span class="op" id="8112950">(</span><span class="ident" id="8112951">ifi</span><span class="op" id="8112954">.</span><span class="ident" id="8112955">Index</span><span class="op" id="8112960">)</span><span class="op" id="8112961">}</span><span class="op" id="8112962">,</span>&nbsp;<span class="ident" id="8112964">nil</span><span class="op" id="8112967">}</span><span class="op" id="8112968">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8112973">{</span><span class="string" id="8112974">&#34;tcp6&#34;</span><span class="op" id="8112980">,</span>&nbsp;<span class="string" id="8112982">&#34;[fe80::1%&#34;</span>&nbsp;<span class="op" id="8112994">+</span>&nbsp;<span class="ident" id="8112996">index</span>&nbsp;<span class="op" id="8113002">+</span>&nbsp;<span class="string" id="8113004">&#34;]:4&#34;</span><span class="op" id="8113009">,</span>&nbsp;<span class="op" id="8113011">&amp;</span><span class="ident" id="8113012">TCPAddr</span><span class="op" id="8113019">{</span><span class="ident" id="8113020">IP</span><span class="op" id="8113022">:</span>&nbsp;<span class="ident" id="8113024">ParseIP</span><span class="op" id="8113031">(</span><span class="string" id="8113032">&#34;fe80::1&#34;</span><span class="op" id="8113041">)</span><span class="op" id="8113042">,</span>&nbsp;<span class="ident" id="8113044">Port</span><span class="op" id="8113048">:</span>&nbsp;<span class="num" id="8113050">4</span><span class="op" id="8113051">,</span>&nbsp;<span class="ident" id="8113053">Zone</span><span class="op" id="8113057">:</span>&nbsp;<span class="ident" id="8113059">index</span><span class="op" id="8113064">}</span><span class="op" id="8113065">,</span>&nbsp;<span class="ident" id="8113067">nil</span><span class="op" id="8113070">}</span><span class="op" id="8113071">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8113075">}</span><span class="op" id="8113076">...</span><span class="op" id="8113079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8113082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8113085">if</span>&nbsp;<span class="ident" id="8113088">ips</span><span class="op" id="8113091">,</span>&nbsp;<span class="ident" id="8113093">err</span>&nbsp;<span class="op" id="8113097">:=</span>&nbsp;<span class="ident" id="8113100">LookupIP</span><span class="op" id="8113108">(</span><span class="string" id="8113109">&#34;localhost&#34;</span><span class="op" id="8113120">)</span><span class="op" id="8113121">;</span>&nbsp;<span class="ident" id="8113123">err</span>&nbsp;<span class="op" id="8113127">==</span>&nbsp;<span class="ident" id="8113130">nil</span>&nbsp;<span class="op" id="8113134">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="8113137">len</span><span class="op" id="8113140">(</span><span class="ident" id="8113141">ips</span><span class="op" id="8113144">)</span>&nbsp;<span class="op" id="8113146">&gt;</span>&nbsp;<span class="num" id="8113148">1</span>&nbsp;<span class="op" id="8113150">&amp;&amp;</span>&nbsp;<span class="ident" id="8113153">supportsIPv4</span>&nbsp;<span class="op" id="8113166">&amp;&amp;</span>&nbsp;<span class="ident" id="8113169">supportsIPv6</span>&nbsp;<span class="op" id="8113182">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8113186">resolveTCPAddrTests</span>&nbsp;<span class="op" id="8113206">=</span>&nbsp;<span class="builtinfunc" id="8113208">append</span><span class="op" id="8113214">(</span><span class="ident" id="8113215">resolveTCPAddrTests</span><span class="op" id="8113234">,</span>&nbsp;<span class="op" id="8113236">[</span><span class="op" id="8113237">]</span><span class="ident" id="8113238">resolveTCPAddrTest</span><span class="op" id="8113256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8113261">{</span><span class="string" id="8113262">&#34;tcp&#34;</span><span class="op" id="8113267">,</span>&nbsp;<span class="string" id="8113269">&#34;localhost:5&#34;</span><span class="op" id="8113282">,</span>&nbsp;<span class="op" id="8113284">&amp;</span><span class="ident" id="8113285">TCPAddr</span><span class="op" id="8113292">{</span><span class="ident" id="8113293">IP</span><span class="op" id="8113295">:</span>&nbsp;<span class="ident" id="8113297">IPv4</span><span class="op" id="8113301">(</span><span class="num" id="8113302">127</span><span class="op" id="8113305">,</span>&nbsp;<span class="num" id="8113307">0</span><span class="op" id="8113308">,</span>&nbsp;<span class="num" id="8113310">0</span><span class="op" id="8113311">,</span>&nbsp;<span class="num" id="8113313">1</span><span class="op" id="8113314">)</span><span class="op" id="8113315">,</span>&nbsp;<span class="ident" id="8113317">Port</span><span class="op" id="8113321">:</span>&nbsp;<span class="num" id="8113323">5</span><span class="op" id="8113324">}</span><span class="op" id="8113325">,</span>&nbsp;<span class="ident" id="8113327">nil</span><span class="op" id="8113330">}</span><span class="op" id="8113331">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8113336">{</span><span class="string" id="8113337">&#34;tcp4&#34;</span><span class="op" id="8113343">,</span>&nbsp;<span class="string" id="8113345">&#34;localhost:6&#34;</span><span class="op" id="8113358">,</span>&nbsp;<span class="op" id="8113360">&amp;</span><span class="ident" id="8113361">TCPAddr</span><span class="op" id="8113368">{</span><span class="ident" id="8113369">IP</span><span class="op" id="8113371">:</span>&nbsp;<span class="ident" id="8113373">IPv4</span><span class="op" id="8113377">(</span><span class="num" id="8113378">127</span><span class="op" id="8113381">,</span>&nbsp;<span class="num" id="8113383">0</span><span class="op" id="8113384">,</span>&nbsp;<span class="num" id="8113386">0</span><span class="op" id="8113387">,</span>&nbsp;<span class="num" id="8113389">1</span><span class="op" id="8113390">)</span><span class="op" id="8113391">,</span>&nbsp;<span class="ident" id="8113393">Port</span><span class="op" id="8113397">:</span>&nbsp;<span class="num" id="8113399">6</span><span class="op" id="8113400">}</span><span class="op" id="8113401">,</span>&nbsp;<span class="ident" id="8113403">nil</span><span class="op" id="8113406">}</span><span class="op" id="8113407">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8113412">{</span><span class="string" id="8113413">&#34;tcp6&#34;</span><span class="op" id="8113419">,</span>&nbsp;<span class="string" id="8113421">&#34;localhost:7&#34;</span><span class="op" id="8113434">,</span>&nbsp;<span class="op" id="8113436">&amp;</span><span class="ident" id="8113437">TCPAddr</span><span class="op" id="8113444">{</span><span class="ident" id="8113445">IP</span><span class="op" id="8113447">:</span>&nbsp;<span class="ident" id="8113449">IPv6loopback</span><span class="op" id="8113461">,</span>&nbsp;<span class="ident" id="8113463">Port</span><span class="op" id="8113467">:</span>&nbsp;<span class="num" id="8113469">7</span><span class="op" id="8113470">}</span><span class="op" id="8113471">,</span>&nbsp;<span class="ident" id="8113473">nil</span><span class="op" id="8113476">}</span><span class="op" id="8113477">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8113481">}</span><span class="op" id="8113482">...</span><span class="op" id="8113485">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8113488">}</span><br>
<span class="lineno"></span><span class="op" id="8113490">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8113493">func</span>&nbsp;<span class="ident" id="8113498">TestResolveTCPAddr</span><span class="op" id="8113516">(</span><span class="ident" id="8113517">t</span>&nbsp;<span class="op" id="8113519">*</span><span class="ident" id="8113520">testing</span><span class="op" id="8113527">.</span><span class="ident" id="8113528">T</span><span class="op" id="8113529">)</span>&nbsp;<span class="op" id="8113531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8113534">for</span>&nbsp;<span class="ident" id="8113538">_</span><span class="op" id="8113539">,</span>&nbsp;<span class="ident" id="8113541">tt</span>&nbsp;<span class="op" id="8113544">:=</span>&nbsp;<span class="keyword" id="8113547">range</span>&nbsp;<span class="ident" id="8113553">resolveTCPAddrTests</span>&nbsp;<span class="op" id="8113573">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8113577">addr</span><span class="op" id="8113581">,</span>&nbsp;<span class="ident" id="8113583">err</span>&nbsp;<span class="op" id="8113587">:=</span>&nbsp;<span class="ident" id="8113590">ResolveTCPAddr</span><span class="op" id="8113604">(</span><span class="ident" id="8113605">tt</span><span class="op" id="8113607">.</span><span class="ident" id="8113608">net</span><span class="op" id="8113611">,</span>&nbsp;<span class="ident" id="8113613">tt</span><span class="op" id="8113615">.</span><span class="ident" id="8113616">litAddrOrName</span><span class="op" id="8113629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8113633">if</span>&nbsp;<span class="ident" id="8113636">err</span>&nbsp;<span class="op" id="8113640">!=</span>&nbsp;<span class="ident" id="8113643">tt</span><span class="op" id="8113645">.</span><span class="ident" id="8113646">err</span>&nbsp;<span class="op" id="8113650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8113655">t</span><span class="op" id="8113656">.</span><span class="ident" id="8113657">Fatalf</span><span class="op" id="8113663">(</span><span class="string" id="8113664">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8113699">,</span>&nbsp;<span class="ident" id="8113701">tt</span><span class="op" id="8113703">.</span><span class="ident" id="8113704">net</span><span class="op" id="8113707">,</span>&nbsp;<span class="ident" id="8113709">tt</span><span class="op" id="8113711">.</span><span class="ident" id="8113712">litAddrOrName</span><span class="op" id="8113725">,</span>&nbsp;<span class="ident" id="8113727">err</span><span class="op" id="8113730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8113734">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8113738">if</span>&nbsp;<span class="op" id="8113741">!</span><span class="ident" id="8113742">reflect</span><span class="op" id="8113749">.</span><span class="ident" id="8113750">DeepEqual</span><span class="op" id="8113759">(</span><span class="ident" id="8113760">addr</span><span class="op" id="8113764">,</span>&nbsp;<span class="ident" id="8113766">tt</span><span class="op" id="8113768">.</span><span class="ident" id="8113769">addr</span><span class="op" id="8113773">)</span>&nbsp;<span class="op" id="8113775">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8113780">t</span><span class="op" id="8113781">.</span><span class="ident" id="8113782">Fatalf</span><span class="op" id="8113788">(</span><span class="string" id="8113789">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;=&nbsp;%#v,&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="8113829">,</span>&nbsp;<span class="ident" id="8113831">tt</span><span class="op" id="8113833">.</span><span class="ident" id="8113834">net</span><span class="op" id="8113837">,</span>&nbsp;<span class="ident" id="8113839">tt</span><span class="op" id="8113841">.</span><span class="ident" id="8113842">litAddrOrName</span><span class="op" id="8113855">,</span>&nbsp;<span class="ident" id="8113857">addr</span><span class="op" id="8113861">,</span>&nbsp;<span class="ident" id="8113863">tt</span><span class="op" id="8113865">.</span><span class="ident" id="8113866">addr</span><span class="op" id="8113870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8113874">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8113878">if</span>&nbsp;<span class="ident" id="8113881">err</span>&nbsp;<span class="op" id="8113885">==</span>&nbsp;<span class="ident" id="8113888">nil</span>&nbsp;<span class="op" id="8113892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8113897">str</span>&nbsp;<span class="op" id="8113901">:=</span>&nbsp;<span class="ident" id="8113904">addr</span><span class="op" id="8113908">.</span><span class="ident" id="8113909">String</span><span class="op" id="8113915">(</span><span class="op" id="8113916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8113921">addr1</span><span class="op" id="8113926">,</span>&nbsp;<span class="ident" id="8113928">err</span>&nbsp;<span class="op" id="8113932">:=</span>&nbsp;<span class="ident" id="8113935">ResolveTCPAddr</span><span class="op" id="8113949">(</span><span class="ident" id="8113950">tt</span><span class="op" id="8113952">.</span><span class="ident" id="8113953">net</span><span class="op" id="8113956">,</span>&nbsp;<span class="ident" id="8113958">str</span><span class="op" id="8113961">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8113966">if</span>&nbsp;<span class="ident" id="8113969">err</span>&nbsp;<span class="op" id="8113973">!=</span>&nbsp;<span class="ident" id="8113976">nil</span>&nbsp;<span class="op" id="8113980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8113986">t</span><span class="op" id="8113987">.</span><span class="ident" id="8113988">Fatalf</span><span class="op" id="8113994">(</span><span class="string" id="8113995">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;[from&nbsp;%q]:&nbsp;%v&#34;</span><span class="op" id="8114033">,</span>&nbsp;<span class="ident" id="8114035">tt</span><span class="op" id="8114037">.</span><span class="ident" id="8114038">net</span><span class="op" id="8114041">,</span>&nbsp;<span class="ident" id="8114043">str</span><span class="op" id="8114046">,</span>&nbsp;<span class="ident" id="8114048">tt</span><span class="op" id="8114050">.</span><span class="ident" id="8114051">litAddrOrName</span><span class="op" id="8114064">,</span>&nbsp;<span class="ident" id="8114066">err</span><span class="op" id="8114069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8114074">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8114079">if</span>&nbsp;<span class="op" id="8114082">!</span><span class="ident" id="8114083">reflect</span><span class="op" id="8114090">.</span><span class="ident" id="8114091">DeepEqual</span><span class="op" id="8114100">(</span><span class="ident" id="8114101">addr1</span><span class="op" id="8114106">,</span>&nbsp;<span class="ident" id="8114108">addr</span><span class="op" id="8114112">)</span>&nbsp;<span class="op" id="8114114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8114120">t</span><span class="op" id="8114121">.</span><span class="ident" id="8114122">Fatalf</span><span class="op" id="8114128">(</span><span class="string" id="8114129">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;[from&nbsp;%q]&nbsp;=&nbsp;%#v,&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="8114179">,</span>&nbsp;<span class="ident" id="8114181">tt</span><span class="op" id="8114183">.</span><span class="ident" id="8114184">net</span><span class="op" id="8114187">,</span>&nbsp;<span class="ident" id="8114189">str</span><span class="op" id="8114192">,</span>&nbsp;<span class="ident" id="8114194">tt</span><span class="op" id="8114196">.</span><span class="ident" id="8114197">litAddrOrName</span><span class="op" id="8114210">,</span>&nbsp;<span class="ident" id="8114212">addr1</span><span class="op" id="8114217">,</span>&nbsp;<span class="ident" id="8114219">addr</span><span class="op" id="8114223">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8114228">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8114232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8114235">}</span><br>
<span class="lineno"></span><span class="op" id="8114237">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span><span class="keyword" id="8114240">var</span>&nbsp;<span class="ident" id="8114244">tcpListenerNameTests</span>&nbsp;<span class="op" id="8114265">=</span>&nbsp;<span class="op" id="8114267">[</span><span class="op" id="8114268">]</span><span class="keyword" id="8114269">struct</span>&nbsp;<span class="op" id="8114276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8114279">net</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8114285">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8114293">laddr</span>&nbsp;<span class="op" id="8114299">*</span><span class="ident" id="8114300">TCPAddr</span><br>
<span class="lineno"></span><span class="op" id="8114308">}</span><span class="op" id="8114309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8114312">{</span><span class="string" id="8114313">&#34;tcp4&#34;</span><span class="op" id="8114319">,</span>&nbsp;<span class="op" id="8114321">&amp;</span><span class="ident" id="8114322">TCPAddr</span><span class="op" id="8114329">{</span><span class="ident" id="8114330">IP</span><span class="op" id="8114332">:</span>&nbsp;<span class="ident" id="8114334">IPv4</span><span class="op" id="8114338">(</span><span class="num" id="8114339">127</span><span class="op" id="8114342">,</span>&nbsp;<span class="num" id="8114344">0</span><span class="op" id="8114345">,</span>&nbsp;<span class="num" id="8114347">0</span><span class="op" id="8114348">,</span>&nbsp;<span class="num" id="8114350">1</span><span class="op" id="8114351">)</span><span class="op" id="8114352">}</span><span class="op" id="8114353">}</span><span class="op" id="8114354">,</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8114357">{</span><span class="string" id="8114358">&#34;tcp4&#34;</span><span class="op" id="8114364">,</span>&nbsp;<span class="op" id="8114366">&amp;</span><span class="ident" id="8114367">TCPAddr</span><span class="op" id="8114374">{</span><span class="op" id="8114375">}</span><span class="op" id="8114376">}</span><span class="op" id="8114377">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8114380">{</span><span class="string" id="8114381">&#34;tcp4&#34;</span><span class="op" id="8114387">,</span>&nbsp;<span class="ident" id="8114389">nil</span><span class="op" id="8114392">}</span><span class="op" id="8114393">,</span><br>
<span class="lineno"></span><span class="op" id="8114395">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8114398">func</span>&nbsp;<span class="ident" id="8114403">TestTCPListenerName</span><span class="op" id="8114422">(</span><span class="ident" id="8114423">t</span>&nbsp;<span class="op" id="8114425">*</span><span class="ident" id="8114426">testing</span><span class="op" id="8114433">.</span><span class="ident" id="8114434">T</span><span class="op" id="8114435">)</span>&nbsp;<span class="op" id="8114437">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8114440">if</span>&nbsp;<span class="ident" id="8114443">testing</span><span class="op" id="8114450">.</span><span class="ident" id="8114451">Short</span><span class="op" id="8114456">(</span><span class="op" id="8114457">)</span>&nbsp;<span class="op" id="8114459">||</span>&nbsp;<span class="op" id="8114462">!</span><span class="op" id="8114463">*</span><span class="ident" id="8114464">testExternal</span>&nbsp;<span class="op" id="8114477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8114481">t</span><span class="op" id="8114482">.</span><span class="ident" id="8114483">Skip</span><span class="op" id="8114487">(</span><span class="string" id="8114488">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="8114529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8114532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8114536">for</span>&nbsp;<span class="ident" id="8114540">_</span><span class="op" id="8114541">,</span>&nbsp;<span class="ident" id="8114543">tt</span>&nbsp;<span class="op" id="8114546">:=</span>&nbsp;<span class="keyword" id="8114549">range</span>&nbsp;<span class="ident" id="8114555">tcpListenerNameTests</span>&nbsp;<span class="op" id="8114576">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8114580">ln</span><span class="op" id="8114582">,</span>&nbsp;<span class="ident" id="8114584">err</span>&nbsp;<span class="op" id="8114588">:=</span>&nbsp;<span class="ident" id="8114591">ListenTCP</span><span class="op" id="8114600">(</span><span class="ident" id="8114601">tt</span><span class="op" id="8114603">.</span><span class="ident" id="8114604">net</span><span class="op" id="8114607">,</span>&nbsp;<span class="ident" id="8114609">tt</span><span class="op" id="8114611">.</span><span class="ident" id="8114612">laddr</span><span class="op" id="8114617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8114621">if</span>&nbsp;<span class="ident" id="8114624">err</span>&nbsp;<span class="op" id="8114628">!=</span>&nbsp;<span class="ident" id="8114631">nil</span>&nbsp;<span class="op" id="8114635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8114640">t</span><span class="op" id="8114641">.</span><span class="ident" id="8114642">Fatalf</span><span class="op" id="8114648">(</span><span class="string" id="8114649">&#34;ListenTCP&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8114671">,</span>&nbsp;<span class="ident" id="8114673">err</span><span class="op" id="8114676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8114680">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8114684">defer</span>&nbsp;<span class="ident" id="8114690">ln</span><span class="op" id="8114692">.</span><span class="ident" id="8114693">Close</span><span class="op" id="8114698">(</span><span class="op" id="8114699">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8114703">la</span>&nbsp;<span class="op" id="8114706">:=</span>&nbsp;<span class="ident" id="8114709">ln</span><span class="op" id="8114711">.</span><span class="ident" id="8114712">Addr</span><span class="op" id="8114716">(</span><span class="op" id="8114717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8114721">if</span>&nbsp;<span class="ident" id="8114724">a</span><span class="op" id="8114725">,</span>&nbsp;<span class="ident" id="8114727">ok</span>&nbsp;<span class="op" id="8114730">:=</span>&nbsp;<span class="ident" id="8114733">la</span><span class="op" id="8114735">.</span><span class="op" id="8114736">(</span><span class="op" id="8114737">*</span><span class="ident" id="8114738">TCPAddr</span><span class="op" id="8114745">)</span><span class="op" id="8114746">;</span>&nbsp;<span class="op" id="8114748">!</span><span class="ident" id="8114749">ok</span>&nbsp;<span class="op" id="8114752">||</span>&nbsp;<span class="ident" id="8114755">a</span><span class="op" id="8114756">.</span><span class="ident" id="8114757">Port</span>&nbsp;<span class="op" id="8114762">==</span>&nbsp;<span class="num" id="8114765">0</span>&nbsp;<span class="op" id="8114767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8114772">t</span><span class="op" id="8114773">.</span><span class="ident" id="8114774">Fatalf</span><span class="op" id="8114780">(</span><span class="string" id="8114781">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;non-zero&nbsp;port&nbsp;number&#34;</span><span class="op" id="8114842">,</span>&nbsp;<span class="ident" id="8114844">la</span><span class="op" id="8114846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8114850">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8114853">}</span><br>
<span class="lineno">375</span><span class="op" id="8114855">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8114858">func</span>&nbsp;<span class="ident" id="8114863">TestIPv6LinkLocalUnicastTCP</span><span class="op" id="8114890">(</span><span class="ident" id="8114891">t</span>&nbsp;<span class="op" id="8114893">*</span><span class="ident" id="8114894">testing</span><span class="op" id="8114901">.</span><span class="ident" id="8114902">T</span><span class="op" id="8114903">)</span>&nbsp;<span class="op" id="8114905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8114908">if</span>&nbsp;<span class="ident" id="8114911">testing</span><span class="op" id="8114918">.</span><span class="ident" id="8114919">Short</span><span class="op" id="8114924">(</span><span class="op" id="8114925">)</span>&nbsp;<span class="op" id="8114927">||</span>&nbsp;<span class="op" id="8114930">!</span><span class="op" id="8114931">*</span><span class="ident" id="8114932">testExternal</span>&nbsp;<span class="op" id="8114945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8114949">t</span><span class="op" id="8114950">.</span><span class="ident" id="8114951">Skip</span><span class="op" id="8114955">(</span><span class="string" id="8114956">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="8114997">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8115000">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8115003">if</span>&nbsp;<span class="op" id="8115006">!</span><span class="ident" id="8115007">supportsIPv6</span>&nbsp;<span class="op" id="8115020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8115024">t</span><span class="op" id="8115025">.</span><span class="ident" id="8115026">Skip</span><span class="op" id="8115030">(</span><span class="string" id="8115031">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="8115054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8115057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8115060">ifi</span>&nbsp;<span class="op" id="8115064">:=</span>&nbsp;<span class="ident" id="8115067">loopbackInterface</span><span class="op" id="8115084">(</span><span class="op" id="8115085">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8115088">if</span>&nbsp;<span class="ident" id="8115091">ifi</span>&nbsp;<span class="op" id="8115095">==</span>&nbsp;<span class="ident" id="8115098">nil</span>&nbsp;<span class="op" id="8115102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8115106">t</span><span class="op" id="8115107">.</span><span class="ident" id="8115108">Skip</span><span class="op" id="8115112">(</span><span class="string" id="8115113">&#34;loopback&nbsp;interface&nbsp;not&nbsp;found&#34;</span><span class="op" id="8115143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8115146">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8115149">laddr</span>&nbsp;<span class="op" id="8115155">:=</span>&nbsp;<span class="ident" id="8115158">ipv6LinkLocalUnicastAddr</span><span class="op" id="8115182">(</span><span class="ident" id="8115183">ifi</span><span class="op" id="8115186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8115189">if</span>&nbsp;<span class="ident" id="8115192">laddr</span>&nbsp;<span class="op" id="8115198">==</span>&nbsp;<span class="string" id="8115201">&#34;&#34;</span>&nbsp;<span class="op" id="8115204">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8115208">t</span><span class="op" id="8115209">.</span><span class="ident" id="8115210">Skip</span><span class="op" id="8115214">(</span><span class="string" id="8115215">&#34;ipv6&nbsp;unicast&nbsp;address&nbsp;on&nbsp;loopback&nbsp;not&nbsp;found&#34;</span><span class="op" id="8115259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8115262">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8115266">type</span>&nbsp;<span class="ident" id="8115271">test</span>&nbsp;<span class="keyword" id="8115276">struct</span>&nbsp;<span class="op" id="8115283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8115287">net</span><span class="op" id="8115290">,</span>&nbsp;<span class="ident" id="8115292">addr</span>&nbsp;&nbsp;<span class="builtintype" id="8115298">string</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8115307">nameLookup</span>&nbsp;<span class="builtintype" id="8115318">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8115324">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8115327">var</span>&nbsp;<span class="ident" id="8115331">tests</span>&nbsp;<span class="op" id="8115337">=</span>&nbsp;<span class="op" id="8115339">[</span><span class="op" id="8115340">]</span><span class="ident" id="8115341">test</span><span class="op" id="8115345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8115349">{</span><span class="string" id="8115350">&#34;tcp&#34;</span><span class="op" id="8115355">,</span>&nbsp;<span class="string" id="8115357">&#34;[&#34;</span>&nbsp;<span class="op" id="8115361">+</span>&nbsp;<span class="ident" id="8115363">laddr</span>&nbsp;<span class="op" id="8115369">+</span>&nbsp;<span class="string" id="8115371">&#34;%&#34;</span>&nbsp;<span class="op" id="8115375">+</span>&nbsp;<span class="ident" id="8115377">ifi</span><span class="op" id="8115380">.</span><span class="ident" id="8115381">Name</span>&nbsp;<span class="op" id="8115386">+</span>&nbsp;<span class="string" id="8115388">&#34;]:0&#34;</span><span class="op" id="8115393">,</span>&nbsp;<span class="builtintype" id="8115395">false</span><span class="op" id="8115400">}</span><span class="op" id="8115401">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8115405">{</span><span class="string" id="8115406">&#34;tcp6&#34;</span><span class="op" id="8115412">,</span>&nbsp;<span class="string" id="8115414">&#34;[&#34;</span>&nbsp;<span class="op" id="8115418">+</span>&nbsp;<span class="ident" id="8115420">laddr</span>&nbsp;<span class="op" id="8115426">+</span>&nbsp;<span class="string" id="8115428">&#34;%&#34;</span>&nbsp;<span class="op" id="8115432">+</span>&nbsp;<span class="ident" id="8115434">ifi</span><span class="op" id="8115437">.</span><span class="ident" id="8115438">Name</span>&nbsp;<span class="op" id="8115443">+</span>&nbsp;<span class="string" id="8115445">&#34;]:0&#34;</span><span class="op" id="8115450">,</span>&nbsp;<span class="builtintype" id="8115452">false</span><span class="op" id="8115457">}</span><span class="op" id="8115458">,</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8115461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8115464">switch</span>&nbsp;<span class="ident" id="8115471">runtime</span><span class="op" id="8115478">.</span><span class="ident" id="8115479">GOOS</span>&nbsp;<span class="op" id="8115484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8115487">case</span>&nbsp;<span class="string" id="8115492">&#34;darwin&#34;</span><span class="op" id="8115500">,</span>&nbsp;<span class="string" id="8115502">&#34;freebsd&#34;</span><span class="op" id="8115511">,</span>&nbsp;<span class="string" id="8115513">&#34;openbsd&#34;</span><span class="op" id="8115522">,</span>&nbsp;<span class="string" id="8115524">&#34;netbsd&#34;</span><span class="op" id="8115532">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8115536">tests</span>&nbsp;<span class="op" id="8115542">=</span>&nbsp;<span class="builtinfunc" id="8115544">append</span><span class="op" id="8115550">(</span><span class="ident" id="8115551">tests</span><span class="op" id="8115556">,</span>&nbsp;<span class="op" id="8115558">[</span><span class="op" id="8115559">]</span><span class="ident" id="8115560">test</span><span class="op" id="8115564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8115569">{</span><span class="string" id="8115570">&#34;tcp&#34;</span><span class="op" id="8115575">,</span>&nbsp;<span class="string" id="8115577">&#34;[localhost%&#34;</span>&nbsp;<span class="op" id="8115591">+</span>&nbsp;<span class="ident" id="8115593">ifi</span><span class="op" id="8115596">.</span><span class="ident" id="8115597">Name</span>&nbsp;<span class="op" id="8115602">+</span>&nbsp;<span class="string" id="8115604">&#34;]:0&#34;</span><span class="op" id="8115609">,</span>&nbsp;<span class="builtintype" id="8115611">true</span><span class="op" id="8115615">}</span><span class="op" id="8115616">,</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8115621">{</span><span class="string" id="8115622">&#34;tcp6&#34;</span><span class="op" id="8115628">,</span>&nbsp;<span class="string" id="8115630">&#34;[localhost%&#34;</span>&nbsp;<span class="op" id="8115644">+</span>&nbsp;<span class="ident" id="8115646">ifi</span><span class="op" id="8115649">.</span><span class="ident" id="8115650">Name</span>&nbsp;<span class="op" id="8115655">+</span>&nbsp;<span class="string" id="8115657">&#34;]:0&#34;</span><span class="op" id="8115662">,</span>&nbsp;<span class="builtintype" id="8115664">true</span><span class="op" id="8115668">}</span><span class="op" id="8115669">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8115673">}</span><span class="op" id="8115674">...</span><span class="op" id="8115677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8115680">case</span>&nbsp;<span class="string" id="8115685">&#34;linux&#34;</span><span class="op" id="8115692">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8115696">tests</span>&nbsp;<span class="op" id="8115702">=</span>&nbsp;<span class="builtinfunc" id="8115704">append</span><span class="op" id="8115710">(</span><span class="ident" id="8115711">tests</span><span class="op" id="8115716">,</span>&nbsp;<span class="op" id="8115718">[</span><span class="op" id="8115719">]</span><span class="ident" id="8115720">test</span><span class="op" id="8115724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8115729">{</span><span class="string" id="8115730">&#34;tcp&#34;</span><span class="op" id="8115735">,</span>&nbsp;<span class="string" id="8115737">&#34;[ip6-localhost%&#34;</span>&nbsp;<span class="op" id="8115755">+</span>&nbsp;<span class="ident" id="8115757">ifi</span><span class="op" id="8115760">.</span><span class="ident" id="8115761">Name</span>&nbsp;<span class="op" id="8115766">+</span>&nbsp;<span class="string" id="8115768">&#34;]:0&#34;</span><span class="op" id="8115773">,</span>&nbsp;<span class="builtintype" id="8115775">true</span><span class="op" id="8115779">}</span><span class="op" id="8115780">,</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8115785">{</span><span class="string" id="8115786">&#34;tcp6&#34;</span><span class="op" id="8115792">,</span>&nbsp;<span class="string" id="8115794">&#34;[ip6-localhost%&#34;</span>&nbsp;<span class="op" id="8115812">+</span>&nbsp;<span class="ident" id="8115814">ifi</span><span class="op" id="8115817">.</span><span class="ident" id="8115818">Name</span>&nbsp;<span class="op" id="8115823">+</span>&nbsp;<span class="string" id="8115825">&#34;]:0&#34;</span><span class="op" id="8115830">,</span>&nbsp;<span class="builtintype" id="8115832">true</span><span class="op" id="8115836">}</span><span class="op" id="8115837">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8115841">}</span><span class="op" id="8115842">...</span><span class="op" id="8115845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8115848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8115851">for</span>&nbsp;<span class="ident" id="8115855">_</span><span class="op" id="8115856">,</span>&nbsp;<span class="ident" id="8115858">tt</span>&nbsp;<span class="op" id="8115861">:=</span>&nbsp;<span class="keyword" id="8115864">range</span>&nbsp;<span class="ident" id="8115870">tests</span>&nbsp;<span class="op" id="8115876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8115880">ln</span><span class="op" id="8115882">,</span>&nbsp;<span class="ident" id="8115884">err</span>&nbsp;<span class="op" id="8115888">:=</span>&nbsp;<span class="ident" id="8115891">Listen</span><span class="op" id="8115897">(</span><span class="ident" id="8115898">tt</span><span class="op" id="8115900">.</span><span class="ident" id="8115901">net</span><span class="op" id="8115904">,</span>&nbsp;<span class="ident" id="8115906">tt</span><span class="op" id="8115908">.</span><span class="ident" id="8115909">addr</span><span class="op" id="8115913">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8115917">if</span>&nbsp;<span class="ident" id="8115920">err</span>&nbsp;<span class="op" id="8115924">!=</span>&nbsp;<span class="ident" id="8115927">nil</span>&nbsp;<span class="op" id="8115931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8115936">//&nbsp;It&nbsp;might&nbsp;return&nbsp;&#34;LookupHost&nbsp;returned&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8115982">//&nbsp;suitable&nbsp;address&#34;&nbsp;error&nbsp;on&nbsp;some&nbsp;platforms.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8116031">t</span><span class="op" id="8116032">.</span><span class="ident" id="8116033">Logf</span><span class="op" id="8116037">(</span><span class="string" id="8116038">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8116057">,</span>&nbsp;<span class="ident" id="8116059">err</span><span class="op" id="8116062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8116067">continue</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8116078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8116082">defer</span>&nbsp;<span class="ident" id="8116088">ln</span><span class="op" id="8116090">.</span><span class="ident" id="8116091">Close</span><span class="op" id="8116096">(</span><span class="op" id="8116097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8116101">if</span>&nbsp;<span class="ident" id="8116104">la</span><span class="op" id="8116106">,</span>&nbsp;<span class="ident" id="8116108">ok</span>&nbsp;<span class="op" id="8116111">:=</span>&nbsp;<span class="ident" id="8116114">ln</span><span class="op" id="8116116">.</span><span class="ident" id="8116117">Addr</span><span class="op" id="8116121">(</span><span class="op" id="8116122">)</span><span class="op" id="8116123">.</span><span class="op" id="8116124">(</span><span class="op" id="8116125">*</span><span class="ident" id="8116126">TCPAddr</span><span class="op" id="8116133">)</span><span class="op" id="8116134">;</span>&nbsp;<span class="op" id="8116136">!</span><span class="ident" id="8116137">ok</span>&nbsp;<span class="op" id="8116140">||</span>&nbsp;<span class="op" id="8116143">!</span><span class="ident" id="8116144">tt</span><span class="op" id="8116146">.</span><span class="ident" id="8116147">nameLookup</span>&nbsp;<span class="op" id="8116158">&amp;&amp;</span>&nbsp;<span class="ident" id="8116161">la</span><span class="op" id="8116163">.</span><span class="ident" id="8116164">Zone</span>&nbsp;<span class="op" id="8116169">==</span>&nbsp;<span class="string" id="8116172">&#34;&#34;</span>&nbsp;<span class="op" id="8116175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8116180">t</span><span class="op" id="8116181">.</span><span class="ident" id="8116182">Fatalf</span><span class="op" id="8116188">(</span><span class="string" id="8116189">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;zone&nbsp;identifier&#34;</span><span class="op" id="8116245">,</span>&nbsp;<span class="ident" id="8116247">la</span><span class="op" id="8116249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8116253">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8116258">done</span>&nbsp;<span class="op" id="8116263">:=</span>&nbsp;<span class="builtinfunc" id="8116266">make</span><span class="op" id="8116270">(</span><span class="keyword" id="8116271">chan</span>&nbsp;<span class="builtintype" id="8116276">int</span><span class="op" id="8116279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8116283">go</span>&nbsp;<span class="ident" id="8116286">transponder</span><span class="op" id="8116297">(</span><span class="ident" id="8116298">t</span><span class="op" id="8116299">,</span>&nbsp;<span class="ident" id="8116301">ln</span><span class="op" id="8116303">,</span>&nbsp;<span class="ident" id="8116305">done</span><span class="op" id="8116309">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8116314">c</span><span class="op" id="8116315">,</span>&nbsp;<span class="ident" id="8116317">err</span>&nbsp;<span class="op" id="8116321">:=</span>&nbsp;<span class="ident" id="8116324">Dial</span><span class="op" id="8116328">(</span><span class="ident" id="8116329">tt</span><span class="op" id="8116331">.</span><span class="ident" id="8116332">net</span><span class="op" id="8116335">,</span>&nbsp;<span class="ident" id="8116337">ln</span><span class="op" id="8116339">.</span><span class="ident" id="8116340">Addr</span><span class="op" id="8116344">(</span><span class="op" id="8116345">)</span><span class="op" id="8116346">.</span><span class="ident" id="8116347">String</span><span class="op" id="8116353">(</span><span class="op" id="8116354">)</span><span class="op" id="8116355">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8116359">if</span>&nbsp;<span class="ident" id="8116362">err</span>&nbsp;<span class="op" id="8116366">!=</span>&nbsp;<span class="ident" id="8116369">nil</span>&nbsp;<span class="op" id="8116373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8116378">t</span><span class="op" id="8116379">.</span><span class="ident" id="8116380">Fatalf</span><span class="op" id="8116386">(</span><span class="string" id="8116387">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8116404">,</span>&nbsp;<span class="ident" id="8116406">err</span><span class="op" id="8116409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8116413">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8116417">defer</span>&nbsp;<span class="ident" id="8116423">c</span><span class="op" id="8116424">.</span><span class="ident" id="8116425">Close</span><span class="op" id="8116430">(</span><span class="op" id="8116431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8116435">if</span>&nbsp;<span class="ident" id="8116438">la</span><span class="op" id="8116440">,</span>&nbsp;<span class="ident" id="8116442">ok</span>&nbsp;<span class="op" id="8116445">:=</span>&nbsp;<span class="ident" id="8116448">c</span><span class="op" id="8116449">.</span><span class="ident" id="8116450">LocalAddr</span><span class="op" id="8116459">(</span><span class="op" id="8116460">)</span><span class="op" id="8116461">.</span><span class="op" id="8116462">(</span><span class="op" id="8116463">*</span><span class="ident" id="8116464">TCPAddr</span><span class="op" id="8116471">)</span><span class="op" id="8116472">;</span>&nbsp;<span class="op" id="8116474">!</span><span class="ident" id="8116475">ok</span>&nbsp;<span class="op" id="8116478">||</span>&nbsp;<span class="op" id="8116481">!</span><span class="ident" id="8116482">tt</span><span class="op" id="8116484">.</span><span class="ident" id="8116485">nameLookup</span>&nbsp;<span class="op" id="8116496">&amp;&amp;</span>&nbsp;<span class="ident" id="8116499">la</span><span class="op" id="8116501">.</span><span class="ident" id="8116502">Zone</span>&nbsp;<span class="op" id="8116507">==</span>&nbsp;<span class="string" id="8116510">&#34;&#34;</span>&nbsp;<span class="op" id="8116513">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8116518">t</span><span class="op" id="8116519">.</span><span class="ident" id="8116520">Fatalf</span><span class="op" id="8116526">(</span><span class="string" id="8116527">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;zone&nbsp;identifier&#34;</span><span class="op" id="8116583">,</span>&nbsp;<span class="ident" id="8116585">la</span><span class="op" id="8116587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8116591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8116595">if</span>&nbsp;<span class="ident" id="8116598">ra</span><span class="op" id="8116600">,</span>&nbsp;<span class="ident" id="8116602">ok</span>&nbsp;<span class="op" id="8116605">:=</span>&nbsp;<span class="ident" id="8116608">c</span><span class="op" id="8116609">.</span><span class="ident" id="8116610">RemoteAddr</span><span class="op" id="8116620">(</span><span class="op" id="8116621">)</span><span class="op" id="8116622">.</span><span class="op" id="8116623">(</span><span class="op" id="8116624">*</span><span class="ident" id="8116625">TCPAddr</span><span class="op" id="8116632">)</span><span class="op" id="8116633">;</span>&nbsp;<span class="op" id="8116635">!</span><span class="ident" id="8116636">ok</span>&nbsp;<span class="op" id="8116639">||</span>&nbsp;<span class="op" id="8116642">!</span><span class="ident" id="8116643">tt</span><span class="op" id="8116645">.</span><span class="ident" id="8116646">nameLookup</span>&nbsp;<span class="op" id="8116657">&amp;&amp;</span>&nbsp;<span class="ident" id="8116660">ra</span><span class="op" id="8116662">.</span><span class="ident" id="8116663">Zone</span>&nbsp;<span class="op" id="8116668">==</span>&nbsp;<span class="string" id="8116671">&#34;&#34;</span>&nbsp;<span class="op" id="8116674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8116679">t</span><span class="op" id="8116680">.</span><span class="ident" id="8116681">Fatalf</span><span class="op" id="8116687">(</span><span class="string" id="8116688">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;zone&nbsp;identifier&#34;</span><span class="op" id="8116744">,</span>&nbsp;<span class="ident" id="8116746">ra</span><span class="op" id="8116748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8116752">}</span><br>
<span class="lineno">440</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8116757">if</span>&nbsp;<span class="ident" id="8116760">_</span><span class="op" id="8116761">,</span>&nbsp;<span class="ident" id="8116763">err</span>&nbsp;<span class="op" id="8116767">:=</span>&nbsp;<span class="ident" id="8116770">c</span><span class="op" id="8116771">.</span><span class="ident" id="8116772">Write</span><span class="op" id="8116777">(</span><span class="op" id="8116778">[</span><span class="op" id="8116779">]</span><span class="builtintype" id="8116780">byte</span><span class="op" id="8116784">(</span><span class="string" id="8116785">&#34;TCP&nbsp;OVER&nbsp;IPV6&nbsp;LINKLOCAL&nbsp;TEST&#34;</span><span class="op" id="8116815">)</span><span class="op" id="8116816">)</span><span class="op" id="8116817">;</span>&nbsp;<span class="ident" id="8116819">err</span>&nbsp;<span class="op" id="8116823">!=</span>&nbsp;<span class="ident" id="8116826">nil</span>&nbsp;<span class="op" id="8116830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8116835">t</span><span class="op" id="8116836">.</span><span class="ident" id="8116837">Fatalf</span><span class="op" id="8116843">(</span><span class="string" id="8116844">&#34;Conn.Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8116867">,</span>&nbsp;<span class="ident" id="8116869">err</span><span class="op" id="8116872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8116876">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8116880">b</span>&nbsp;<span class="op" id="8116882">:=</span>&nbsp;<span class="builtinfunc" id="8116885">make</span><span class="op" id="8116889">(</span><span class="op" id="8116890">[</span><span class="op" id="8116891">]</span><span class="builtintype" id="8116892">byte</span><span class="op" id="8116896">,</span>&nbsp;<span class="num" id="8116898">32</span><span class="op" id="8116900">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8116904">if</span>&nbsp;<span class="ident" id="8116907">_</span><span class="op" id="8116908">,</span>&nbsp;<span class="ident" id="8116910">err</span>&nbsp;<span class="op" id="8116914">:=</span>&nbsp;<span class="ident" id="8116917">c</span><span class="op" id="8116918">.</span><span class="ident" id="8116919">Read</span><span class="op" id="8116923">(</span><span class="ident" id="8116924">b</span><span class="op" id="8116925">)</span><span class="op" id="8116926">;</span>&nbsp;<span class="ident" id="8116928">err</span>&nbsp;<span class="op" id="8116932">!=</span>&nbsp;<span class="ident" id="8116935">nil</span>&nbsp;<span class="op" id="8116939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8116944">t</span><span class="op" id="8116945">.</span><span class="ident" id="8116946">Fatalf</span><span class="op" id="8116952">(</span><span class="string" id="8116953">&#34;Conn.Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8116975">,</span>&nbsp;<span class="ident" id="8116977">err</span><span class="op" id="8116980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8116984">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8116989">&lt;-</span><span class="ident" id="8116991">done</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8116997">}</span><br>
<span class="lineno"></span><span class="op" id="8116999">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8117002">func</span>&nbsp;<span class="ident" id="8117007">TestTCPConcurrentAccept</span><span class="op" id="8117030">(</span><span class="ident" id="8117031">t</span>&nbsp;<span class="op" id="8117033">*</span><span class="ident" id="8117034">testing</span><span class="op" id="8117041">.</span><span class="ident" id="8117042">T</span><span class="op" id="8117043">)</span>&nbsp;<span class="op" id="8117045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8117048">defer</span>&nbsp;<span class="ident" id="8117054">runtime</span><span class="op" id="8117061">.</span><span class="ident" id="8117062">GOMAXPROCS</span><span class="op" id="8117072">(</span><span class="ident" id="8117073">runtime</span><span class="op" id="8117080">.</span><span class="ident" id="8117081">GOMAXPROCS</span><span class="op" id="8117091">(</span><span class="num" id="8117092">4</span><span class="op" id="8117093">)</span><span class="op" id="8117094">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8117097">ln</span><span class="op" id="8117099">,</span>&nbsp;<span class="ident" id="8117101">err</span>&nbsp;<span class="op" id="8117105">:=</span>&nbsp;<span class="ident" id="8117108">Listen</span><span class="op" id="8117114">(</span><span class="string" id="8117115">&#34;tcp&#34;</span><span class="op" id="8117120">,</span>&nbsp;<span class="string" id="8117122">&#34;127.0.0.1:0&#34;</span><span class="op" id="8117135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8117138">if</span>&nbsp;<span class="ident" id="8117141">err</span>&nbsp;<span class="op" id="8117145">!=</span>&nbsp;<span class="ident" id="8117148">nil</span>&nbsp;<span class="op" id="8117152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8117156">t</span><span class="op" id="8117157">.</span><span class="ident" id="8117158">Fatalf</span><span class="op" id="8117164">(</span><span class="string" id="8117165">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8117184">,</span>&nbsp;<span class="ident" id="8117186">err</span><span class="op" id="8117189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8117192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8117195">const</span>&nbsp;<span class="ident" id="8117201">N</span>&nbsp;<span class="op" id="8117203">=</span>&nbsp;<span class="num" id="8117205">10</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8117209">var</span>&nbsp;<span class="ident" id="8117213">wg</span>&nbsp;<span class="ident" id="8117216">sync</span><span class="op" id="8117220">.</span><span class="ident" id="8117221">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8117232">wg</span><span class="op" id="8117234">.</span><span class="ident" id="8117235">Add</span><span class="op" id="8117238">(</span><span class="ident" id="8117239">N</span><span class="op" id="8117240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8117243">for</span>&nbsp;<span class="ident" id="8117247">i</span>&nbsp;<span class="op" id="8117249">:=</span>&nbsp;<span class="num" id="8117252">0</span><span class="op" id="8117253">;</span>&nbsp;<span class="ident" id="8117255">i</span>&nbsp;<span class="op" id="8117257">&lt;</span>&nbsp;<span class="ident" id="8117259">N</span><span class="op" id="8117260">;</span>&nbsp;<span class="ident" id="8117262">i</span><span class="op" id="8117263">++</span>&nbsp;<span class="op" id="8117266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8117270">go</span>&nbsp;<span class="keyword" id="8117273">func</span><span class="op" id="8117277">(</span><span class="op" id="8117278">)</span>&nbsp;<span class="op" id="8117280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8117285">for</span>&nbsp;<span class="op" id="8117289">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8117295">c</span><span class="op" id="8117296">,</span>&nbsp;<span class="ident" id="8117298">err</span>&nbsp;<span class="op" id="8117302">:=</span>&nbsp;<span class="ident" id="8117305">ln</span><span class="op" id="8117307">.</span><span class="ident" id="8117308">Accept</span><span class="op" id="8117314">(</span><span class="op" id="8117315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8117321">if</span>&nbsp;<span class="ident" id="8117324">err</span>&nbsp;<span class="op" id="8117328">!=</span>&nbsp;<span class="ident" id="8117331">nil</span>&nbsp;<span class="op" id="8117335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8117342">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8117352">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8117358">c</span><span class="op" id="8117359">.</span><span class="ident" id="8117360">Close</span><span class="op" id="8117365">(</span><span class="op" id="8117366">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8117371">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8117376">wg</span><span class="op" id="8117378">.</span><span class="ident" id="8117379">Done</span><span class="op" id="8117383">(</span><span class="op" id="8117384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8117388">}</span><span class="op" id="8117389">(</span><span class="op" id="8117390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8117393">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8117396">attempts</span>&nbsp;<span class="op" id="8117405">:=</span>&nbsp;<span class="num" id="8117408">10</span>&nbsp;<span class="op" id="8117411">*</span>&nbsp;<span class="ident" id="8117413">N</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8117416">fails</span>&nbsp;<span class="op" id="8117422">:=</span>&nbsp;<span class="num" id="8117425">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8117428">d</span>&nbsp;<span class="op" id="8117430">:=</span>&nbsp;<span class="op" id="8117433">&amp;</span><span class="ident" id="8117434">Dialer</span><span class="op" id="8117440">{</span><span class="ident" id="8117441">Timeout</span><span class="op" id="8117448">:</span>&nbsp;<span class="num" id="8117450">200</span>&nbsp;<span class="op" id="8117454">*</span>&nbsp;<span class="ident" id="8117456">time</span><span class="op" id="8117460">.</span><span class="ident" id="8117461">Millisecond</span><span class="op" id="8117472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8117475">for</span>&nbsp;<span class="ident" id="8117479">i</span>&nbsp;<span class="op" id="8117481">:=</span>&nbsp;<span class="num" id="8117484">0</span><span class="op" id="8117485">;</span>&nbsp;<span class="ident" id="8117487">i</span>&nbsp;<span class="op" id="8117489">&lt;</span>&nbsp;<span class="ident" id="8117491">attempts</span><span class="op" id="8117499">;</span>&nbsp;<span class="ident" id="8117501">i</span><span class="op" id="8117502">++</span>&nbsp;<span class="op" id="8117505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8117509">c</span><span class="op" id="8117510">,</span>&nbsp;<span class="ident" id="8117512">err</span>&nbsp;<span class="op" id="8117516">:=</span>&nbsp;<span class="ident" id="8117519">d</span><span class="op" id="8117520">.</span><span class="ident" id="8117521">Dial</span><span class="op" id="8117525">(</span><span class="string" id="8117526">&#34;tcp&#34;</span><span class="op" id="8117531">,</span>&nbsp;<span class="ident" id="8117533">ln</span><span class="op" id="8117535">.</span><span class="ident" id="8117536">Addr</span><span class="op" id="8117540">(</span><span class="op" id="8117541">)</span><span class="op" id="8117542">.</span><span class="ident" id="8117543">String</span><span class="op" id="8117549">(</span><span class="op" id="8117550">)</span><span class="op" id="8117551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8117555">if</span>&nbsp;<span class="ident" id="8117558">err</span>&nbsp;<span class="op" id="8117562">!=</span>&nbsp;<span class="ident" id="8117565">nil</span>&nbsp;<span class="op" id="8117569">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8117574">fails</span><span class="op" id="8117579">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8117584">}</span>&nbsp;<span class="keyword" id="8117586">else</span>&nbsp;<span class="op" id="8117591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8117596">c</span><span class="op" id="8117597">.</span><span class="ident" id="8117598">Close</span><span class="op" id="8117603">(</span><span class="op" id="8117604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8117608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8117611">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8117614">ln</span><span class="op" id="8117616">.</span><span class="ident" id="8117617">Close</span><span class="op" id="8117622">(</span><span class="op" id="8117623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8117626">wg</span><span class="op" id="8117628">.</span><span class="ident" id="8117629">Wait</span><span class="op" id="8117633">(</span><span class="op" id="8117634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8117637">if</span>&nbsp;<span class="ident" id="8117640">fails</span>&nbsp;<span class="op" id="8117646">&gt;</span>&nbsp;<span class="ident" id="8117648">attempts</span><span class="op" id="8117656">/</span><span class="num" id="8117657">9</span>&nbsp;<span class="op" id="8117659">{</span>&nbsp;<span class="comment" id="8117661">//&nbsp;see&nbsp;issues&nbsp;7400&nbsp;and&nbsp;7541</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8117691">t</span><span class="op" id="8117692">.</span><span class="ident" id="8117693">Fatalf</span><span class="op" id="8117699">(</span><span class="string" id="8117700">&#34;too&nbsp;many&nbsp;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8117726">,</span>&nbsp;<span class="ident" id="8117728">fails</span><span class="op" id="8117733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8117736">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8117739">if</span>&nbsp;<span class="ident" id="8117742">fails</span>&nbsp;<span class="op" id="8117748">&gt;</span>&nbsp;<span class="num" id="8117750">0</span>&nbsp;<span class="op" id="8117752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8117756">t</span><span class="op" id="8117757">.</span><span class="ident" id="8117758">Logf</span><span class="op" id="8117762">(</span><span class="string" id="8117763">&#34;#&nbsp;of&nbsp;failed&nbsp;Dials:&nbsp;%v&#34;</span><span class="op" id="8117786">,</span>&nbsp;<span class="ident" id="8117788">fails</span><span class="op" id="8117793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8117796">}</span><br>
<span class="lineno"></span><span class="op" id="8117798">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="keyword" id="8117801">func</span>&nbsp;<span class="ident" id="8117806">TestTCPReadWriteMallocs</span><span class="op" id="8117829">(</span><span class="ident" id="8117830">t</span>&nbsp;<span class="op" id="8117832">*</span><span class="ident" id="8117833">testing</span><span class="op" id="8117840">.</span><span class="ident" id="8117841">T</span><span class="op" id="8117842">)</span>&nbsp;<span class="op" id="8117844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8117847">if</span>&nbsp;<span class="ident" id="8117850">testing</span><span class="op" id="8117857">.</span><span class="ident" id="8117858">Short</span><span class="op" id="8117863">(</span><span class="op" id="8117864">)</span>&nbsp;<span class="op" id="8117866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8117870">t</span><span class="op" id="8117871">.</span><span class="ident" id="8117872">Skip</span><span class="op" id="8117876">(</span><span class="string" id="8117877">&#34;skipping&nbsp;malloc&nbsp;count&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="8117914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8117917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8117920">ln</span><span class="op" id="8117922">,</span>&nbsp;<span class="ident" id="8117924">err</span>&nbsp;<span class="op" id="8117928">:=</span>&nbsp;<span class="ident" id="8117931">Listen</span><span class="op" id="8117937">(</span><span class="string" id="8117938">&#34;tcp&#34;</span><span class="op" id="8117943">,</span>&nbsp;<span class="string" id="8117945">&#34;127.0.0.1:0&#34;</span><span class="op" id="8117958">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8117961">if</span>&nbsp;<span class="ident" id="8117964">err</span>&nbsp;<span class="op" id="8117968">!=</span>&nbsp;<span class="ident" id="8117971">nil</span>&nbsp;<span class="op" id="8117975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8117979">t</span><span class="op" id="8117980">.</span><span class="ident" id="8117981">Fatalf</span><span class="op" id="8117987">(</span><span class="string" id="8117988">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8118007">,</span>&nbsp;<span class="ident" id="8118009">err</span><span class="op" id="8118012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8118015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8118018">defer</span>&nbsp;<span class="ident" id="8118024">ln</span><span class="op" id="8118026">.</span><span class="ident" id="8118027">Close</span><span class="op" id="8118032">(</span><span class="op" id="8118033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8118036">var</span>&nbsp;<span class="ident" id="8118040">server</span>&nbsp;<span class="ident" id="8118047">Conn</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8118053">errc</span>&nbsp;<span class="op" id="8118058">:=</span>&nbsp;<span class="builtinfunc" id="8118061">make</span><span class="op" id="8118065">(</span><span class="keyword" id="8118066">chan</span>&nbsp;<span class="builtintype" id="8118071">error</span><span class="op" id="8118076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8118079">go</span>&nbsp;<span class="keyword" id="8118082">func</span><span class="op" id="8118086">(</span><span class="op" id="8118087">)</span>&nbsp;<span class="op" id="8118089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8118093">var</span>&nbsp;<span class="ident" id="8118097">err</span>&nbsp;<span class="builtintype" id="8118101">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8118109">server</span><span class="op" id="8118115">,</span>&nbsp;<span class="ident" id="8118117">err</span>&nbsp;<span class="op" id="8118121">=</span>&nbsp;<span class="ident" id="8118123">ln</span><span class="op" id="8118125">.</span><span class="ident" id="8118126">Accept</span><span class="op" id="8118132">(</span><span class="op" id="8118133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8118137">errc</span>&nbsp;<span class="op" id="8118142">&lt;-</span>&nbsp;<span class="ident" id="8118145">err</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8118150">}</span><span class="op" id="8118151">(</span><span class="op" id="8118152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8118155">client</span><span class="op" id="8118161">,</span>&nbsp;<span class="ident" id="8118163">err</span>&nbsp;<span class="op" id="8118167">:=</span>&nbsp;<span class="ident" id="8118170">Dial</span><span class="op" id="8118174">(</span><span class="string" id="8118175">&#34;tcp&#34;</span><span class="op" id="8118180">,</span>&nbsp;<span class="ident" id="8118182">ln</span><span class="op" id="8118184">.</span><span class="ident" id="8118185">Addr</span><span class="op" id="8118189">(</span><span class="op" id="8118190">)</span><span class="op" id="8118191">.</span><span class="ident" id="8118192">String</span><span class="op" id="8118198">(</span><span class="op" id="8118199">)</span><span class="op" id="8118200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8118203">if</span>&nbsp;<span class="ident" id="8118206">err</span>&nbsp;<span class="op" id="8118210">!=</span>&nbsp;<span class="ident" id="8118213">nil</span>&nbsp;<span class="op" id="8118217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8118221">t</span><span class="op" id="8118222">.</span><span class="ident" id="8118223">Fatalf</span><span class="op" id="8118229">(</span><span class="string" id="8118230">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8118247">,</span>&nbsp;<span class="ident" id="8118249">err</span><span class="op" id="8118252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8118255">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8118258">if</span>&nbsp;<span class="ident" id="8118261">err</span>&nbsp;<span class="op" id="8118265">:=</span>&nbsp;<span class="op" id="8118268">&lt;-</span><span class="ident" id="8118270">errc</span><span class="op" id="8118274">;</span>&nbsp;<span class="ident" id="8118276">err</span>&nbsp;<span class="op" id="8118280">!=</span>&nbsp;<span class="ident" id="8118283">nil</span>&nbsp;<span class="op" id="8118287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8118291">t</span><span class="op" id="8118292">.</span><span class="ident" id="8118293">Fatalf</span><span class="op" id="8118299">(</span><span class="string" id="8118300">&#34;Accept&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8118319">,</span>&nbsp;<span class="ident" id="8118321">err</span><span class="op" id="8118324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8118327">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8118330">defer</span>&nbsp;<span class="ident" id="8118336">server</span><span class="op" id="8118342">.</span><span class="ident" id="8118343">Close</span><span class="op" id="8118348">(</span><span class="op" id="8118349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8118352">var</span>&nbsp;<span class="ident" id="8118356">buf</span>&nbsp;<span class="op" id="8118360">[</span><span class="num" id="8118361">128</span><span class="op" id="8118364">]</span><span class="builtintype" id="8118365">byte</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8118371">mallocs</span>&nbsp;<span class="op" id="8118379">:=</span>&nbsp;<span class="ident" id="8118382">testing</span><span class="op" id="8118389">.</span><span class="ident" id="8118390">AllocsPerRun</span><span class="op" id="8118402">(</span><span class="num" id="8118403">1000</span><span class="op" id="8118407">,</span>&nbsp;<span class="keyword" id="8118409">func</span><span class="op" id="8118413">(</span><span class="op" id="8118414">)</span>&nbsp;<span class="op" id="8118416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8118420">_</span><span class="op" id="8118421">,</span>&nbsp;<span class="ident" id="8118423">err</span>&nbsp;<span class="op" id="8118427">:=</span>&nbsp;<span class="ident" id="8118430">server</span><span class="op" id="8118436">.</span><span class="ident" id="8118437">Write</span><span class="op" id="8118442">(</span><span class="ident" id="8118443">buf</span><span class="op" id="8118446">[</span><span class="op" id="8118447">:</span><span class="op" id="8118448">]</span><span class="op" id="8118449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8118453">if</span>&nbsp;<span class="ident" id="8118456">err</span>&nbsp;<span class="op" id="8118460">!=</span>&nbsp;<span class="ident" id="8118463">nil</span>&nbsp;<span class="op" id="8118467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8118472">t</span><span class="op" id="8118473">.</span><span class="ident" id="8118474">Fatalf</span><span class="op" id="8118480">(</span><span class="string" id="8118481">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8118499">,</span>&nbsp;<span class="ident" id="8118501">err</span><span class="op" id="8118504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8118508">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8118512">_</span><span class="op" id="8118513">,</span>&nbsp;<span class="ident" id="8118515">err</span>&nbsp;<span class="op" id="8118519">=</span>&nbsp;<span class="ident" id="8118521">io</span><span class="op" id="8118523">.</span><span class="ident" id="8118524">ReadFull</span><span class="op" id="8118532">(</span><span class="ident" id="8118533">client</span><span class="op" id="8118539">,</span>&nbsp;<span class="ident" id="8118541">buf</span><span class="op" id="8118544">[</span><span class="op" id="8118545">:</span><span class="op" id="8118546">]</span><span class="op" id="8118547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8118551">if</span>&nbsp;<span class="ident" id="8118554">err</span>&nbsp;<span class="op" id="8118558">!=</span>&nbsp;<span class="ident" id="8118561">nil</span>&nbsp;<span class="op" id="8118565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8118570">t</span><span class="op" id="8118571">.</span><span class="ident" id="8118572">Fatalf</span><span class="op" id="8118578">(</span><span class="string" id="8118579">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8118596">,</span>&nbsp;<span class="ident" id="8118598">err</span><span class="op" id="8118601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8118605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8118608">}</span><span class="op" id="8118609">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8118612">if</span>&nbsp;<span class="ident" id="8118615">mallocs</span>&nbsp;<span class="op" id="8118623">&gt;</span>&nbsp;<span class="num" id="8118625">0</span>&nbsp;<span class="op" id="8118627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8118631">t</span><span class="op" id="8118632">.</span><span class="ident" id="8118633">Fatalf</span><span class="op" id="8118639">(</span><span class="string" id="8118640">&#34;Got&nbsp;%v&nbsp;allocs,&nbsp;want&nbsp;0&#34;</span><span class="op" id="8118663">,</span>&nbsp;<span class="ident" id="8118665">mallocs</span><span class="op" id="8118672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8118675">}</span><br>
<span class="lineno"></span><span class="op" id="8118677">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="8118680">func</span>&nbsp;<span class="ident" id="8118685">TestTCPStress</span><span class="op" id="8118698">(</span><span class="ident" id="8118699">t</span>&nbsp;<span class="op" id="8118701">*</span><span class="ident" id="8118702">testing</span><span class="op" id="8118709">.</span><span class="ident" id="8118710">T</span><span class="op" id="8118711">)</span>&nbsp;<span class="op" id="8118713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8118716">const</span>&nbsp;<span class="ident" id="8118722">conns</span>&nbsp;<span class="op" id="8118728">=</span>&nbsp;<span class="num" id="8118730">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8118733">const</span>&nbsp;<span class="ident" id="8118739">msgLen</span>&nbsp;<span class="op" id="8118746">=</span>&nbsp;<span class="num" id="8118748">512</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8118753">msgs</span>&nbsp;<span class="op" id="8118758">:=</span>&nbsp;<span class="builtintype" id="8118761">int</span><span class="op" id="8118764">(</span><span class="num" id="8118765">1e4</span><span class="op" id="8118768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8118771">if</span>&nbsp;<span class="ident" id="8118774">testing</span><span class="op" id="8118781">.</span><span class="ident" id="8118782">Short</span><span class="op" id="8118787">(</span><span class="op" id="8118788">)</span>&nbsp;<span class="op" id="8118790">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8118794">msgs</span>&nbsp;<span class="op" id="8118799">=</span>&nbsp;<span class="num" id="8118801">1e2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8118806">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8118810">sendMsg</span>&nbsp;<span class="op" id="8118818">:=</span>&nbsp;<span class="keyword" id="8118821">func</span><span class="op" id="8118825">(</span><span class="ident" id="8118826">c</span>&nbsp;<span class="ident" id="8118828">Conn</span><span class="op" id="8118832">,</span>&nbsp;<span class="ident" id="8118834">buf</span>&nbsp;<span class="op" id="8118838">[</span><span class="op" id="8118839">]</span><span class="builtintype" id="8118840">byte</span><span class="op" id="8118844">)</span>&nbsp;<span class="builtintype" id="8118846">bool</span>&nbsp;<span class="op" id="8118851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8118855">n</span><span class="op" id="8118856">,</span>&nbsp;<span class="ident" id="8118858">err</span>&nbsp;<span class="op" id="8118862">:=</span>&nbsp;<span class="ident" id="8118865">c</span><span class="op" id="8118866">.</span><span class="ident" id="8118867">Write</span><span class="op" id="8118872">(</span><span class="ident" id="8118873">buf</span><span class="op" id="8118876">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8118880">if</span>&nbsp;<span class="ident" id="8118883">n</span>&nbsp;<span class="op" id="8118885">!=</span>&nbsp;<span class="builtinfunc" id="8118888">len</span><span class="op" id="8118891">(</span><span class="ident" id="8118892">buf</span><span class="op" id="8118895">)</span>&nbsp;<span class="op" id="8118897">||</span>&nbsp;<span class="ident" id="8118900">err</span>&nbsp;<span class="op" id="8118904">!=</span>&nbsp;<span class="ident" id="8118907">nil</span>&nbsp;<span class="op" id="8118911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8118916">t</span><span class="op" id="8118917">.</span><span class="ident" id="8118918">Logf</span><span class="op" id="8118922">(</span><span class="string" id="8118923">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8118941">,</span>&nbsp;<span class="ident" id="8118943">err</span><span class="op" id="8118946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8118951">return</span>&nbsp;<span class="builtintype" id="8118958">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8118966">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8118970">return</span>&nbsp;<span class="builtintype" id="8118977">true</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8118983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8118986">recvMsg</span>&nbsp;<span class="op" id="8118994">:=</span>&nbsp;<span class="keyword" id="8118997">func</span><span class="op" id="8119001">(</span><span class="ident" id="8119002">c</span>&nbsp;<span class="ident" id="8119004">Conn</span><span class="op" id="8119008">,</span>&nbsp;<span class="ident" id="8119010">buf</span>&nbsp;<span class="op" id="8119014">[</span><span class="op" id="8119015">]</span><span class="builtintype" id="8119016">byte</span><span class="op" id="8119020">)</span>&nbsp;<span class="builtintype" id="8119022">bool</span>&nbsp;<span class="op" id="8119027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8119031">for</span>&nbsp;<span class="ident" id="8119035">read</span>&nbsp;<span class="op" id="8119040">:=</span>&nbsp;<span class="num" id="8119043">0</span><span class="op" id="8119044">;</span>&nbsp;<span class="ident" id="8119046">read</span>&nbsp;<span class="op" id="8119051">!=</span>&nbsp;<span class="builtinfunc" id="8119054">len</span><span class="op" id="8119057">(</span><span class="ident" id="8119058">buf</span><span class="op" id="8119061">)</span><span class="op" id="8119062">;</span>&nbsp;<span class="op" id="8119064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8119069">n</span><span class="op" id="8119070">,</span>&nbsp;<span class="ident" id="8119072">err</span>&nbsp;<span class="op" id="8119076">:=</span>&nbsp;<span class="ident" id="8119079">c</span><span class="op" id="8119080">.</span><span class="ident" id="8119081">Read</span><span class="op" id="8119085">(</span><span class="ident" id="8119086">buf</span><span class="op" id="8119089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8119094">read</span>&nbsp;<span class="op" id="8119099">+=</span>&nbsp;<span class="ident" id="8119102">n</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8119107">if</span>&nbsp;<span class="ident" id="8119110">err</span>&nbsp;<span class="op" id="8119114">!=</span>&nbsp;<span class="ident" id="8119117">nil</span>&nbsp;<span class="op" id="8119121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8119127">t</span><span class="op" id="8119128">.</span><span class="ident" id="8119129">Logf</span><span class="op" id="8119133">(</span><span class="string" id="8119134">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8119151">,</span>&nbsp;<span class="ident" id="8119153">err</span><span class="op" id="8119156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8119162">return</span>&nbsp;<span class="builtintype" id="8119169">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8119178">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8119182">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8119186">return</span>&nbsp;<span class="builtintype" id="8119193">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8119199">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8119203">ln</span><span class="op" id="8119205">,</span>&nbsp;<span class="ident" id="8119207">err</span>&nbsp;<span class="op" id="8119211">:=</span>&nbsp;<span class="ident" id="8119214">Listen</span><span class="op" id="8119220">(</span><span class="string" id="8119221">&#34;tcp&#34;</span><span class="op" id="8119226">,</span>&nbsp;<span class="string" id="8119228">&#34;127.0.0.1:0&#34;</span><span class="op" id="8119241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8119244">if</span>&nbsp;<span class="ident" id="8119247">err</span>&nbsp;<span class="op" id="8119251">!=</span>&nbsp;<span class="ident" id="8119254">nil</span>&nbsp;<span class="op" id="8119258">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8119262">t</span><span class="op" id="8119263">.</span><span class="ident" id="8119264">Fatalf</span><span class="op" id="8119270">(</span><span class="string" id="8119271">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8119290">,</span>&nbsp;<span class="ident" id="8119292">err</span><span class="op" id="8119295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8119298">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8119301">defer</span>&nbsp;<span class="ident" id="8119307">ln</span><span class="op" id="8119309">.</span><span class="ident" id="8119310">Close</span><span class="op" id="8119315">(</span><span class="op" id="8119316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8119319">//&nbsp;Acceptor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8119333">go</span>&nbsp;<span class="keyword" id="8119336">func</span><span class="op" id="8119340">(</span><span class="op" id="8119341">)</span>&nbsp;<span class="op" id="8119343">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8119347">for</span>&nbsp;<span class="op" id="8119351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8119356">c</span><span class="op" id="8119357">,</span>&nbsp;<span class="ident" id="8119359">err</span>&nbsp;<span class="op" id="8119363">:=</span>&nbsp;<span class="ident" id="8119366">ln</span><span class="op" id="8119368">.</span><span class="ident" id="8119369">Accept</span><span class="op" id="8119375">(</span><span class="op" id="8119376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8119381">if</span>&nbsp;<span class="ident" id="8119384">err</span>&nbsp;<span class="op" id="8119388">!=</span>&nbsp;<span class="ident" id="8119391">nil</span>&nbsp;<span class="op" id="8119395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8119401">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8119410">}</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8119415">//&nbsp;Server&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8119440">go</span>&nbsp;<span class="keyword" id="8119443">func</span><span class="op" id="8119447">(</span><span class="ident" id="8119448">c</span>&nbsp;<span class="ident" id="8119450">Conn</span><span class="op" id="8119454">)</span>&nbsp;<span class="op" id="8119456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8119462">defer</span>&nbsp;<span class="ident" id="8119468">c</span><span class="op" id="8119469">.</span><span class="ident" id="8119470">Close</span><span class="op" id="8119475">(</span><span class="op" id="8119476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8119482">var</span>&nbsp;<span class="ident" id="8119486">buf</span>&nbsp;<span class="op" id="8119490">[</span><span class="ident" id="8119491">msgLen</span><span class="op" id="8119497">]</span><span class="builtintype" id="8119498">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8119507">for</span>&nbsp;<span class="ident" id="8119511">m</span>&nbsp;<span class="op" id="8119513">:=</span>&nbsp;<span class="num" id="8119516">0</span><span class="op" id="8119517">;</span>&nbsp;<span class="ident" id="8119519">m</span>&nbsp;<span class="op" id="8119521">&lt;</span>&nbsp;<span class="ident" id="8119523">msgs</span><span class="op" id="8119527">;</span>&nbsp;<span class="ident" id="8119529">m</span><span class="op" id="8119530">++</span>&nbsp;<span class="op" id="8119533">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8119540">if</span>&nbsp;<span class="op" id="8119543">!</span><span class="ident" id="8119544">recvMsg</span><span class="op" id="8119551">(</span><span class="ident" id="8119552">c</span><span class="op" id="8119553">,</span>&nbsp;<span class="ident" id="8119555">buf</span><span class="op" id="8119558">[</span><span class="op" id="8119559">:</span><span class="op" id="8119560">]</span><span class="op" id="8119561">)</span>&nbsp;<span class="op" id="8119563">||</span>&nbsp;<span class="op" id="8119566">!</span><span class="ident" id="8119567">sendMsg</span><span class="op" id="8119574">(</span><span class="ident" id="8119575">c</span><span class="op" id="8119576">,</span>&nbsp;<span class="ident" id="8119578">buf</span><span class="op" id="8119581">[</span><span class="op" id="8119582">:</span><span class="op" id="8119583">]</span><span class="op" id="8119584">)</span>&nbsp;<span class="op" id="8119586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8119594">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8119605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8119611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8119616">}</span><span class="op" id="8119617">(</span><span class="ident" id="8119618">c</span><span class="op" id="8119619">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8119623">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8119626">}</span><span class="op" id="8119627">(</span><span class="op" id="8119628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8119631">done</span>&nbsp;<span class="op" id="8119636">:=</span>&nbsp;<span class="builtinfunc" id="8119639">make</span><span class="op" id="8119643">(</span><span class="keyword" id="8119644">chan</span>&nbsp;<span class="builtintype" id="8119649">bool</span><span class="op" id="8119653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8119656">for</span>&nbsp;<span class="ident" id="8119660">i</span>&nbsp;<span class="op" id="8119662">:=</span>&nbsp;<span class="num" id="8119665">0</span><span class="op" id="8119666">;</span>&nbsp;<span class="ident" id="8119668">i</span>&nbsp;<span class="op" id="8119670">&lt;</span>&nbsp;<span class="ident" id="8119672">conns</span><span class="op" id="8119677">;</span>&nbsp;<span class="ident" id="8119679">i</span><span class="op" id="8119680">++</span>&nbsp;<span class="op" id="8119683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8119687">//&nbsp;Client&nbsp;connection.</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8119711">go</span>&nbsp;<span class="keyword" id="8119714">func</span><span class="op" id="8119718">(</span><span class="op" id="8119719">)</span>&nbsp;<span class="op" id="8119721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8119726">defer</span>&nbsp;<span class="keyword" id="8119732">func</span><span class="op" id="8119736">(</span><span class="op" id="8119737">)</span>&nbsp;<span class="op" id="8119739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8119745">done</span>&nbsp;<span class="op" id="8119750">&lt;-</span>&nbsp;<span class="builtintype" id="8119753">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8119761">}</span><span class="op" id="8119762">(</span><span class="op" id="8119763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8119768">c</span><span class="op" id="8119769">,</span>&nbsp;<span class="ident" id="8119771">err</span>&nbsp;<span class="op" id="8119775">:=</span>&nbsp;<span class="ident" id="8119778">Dial</span><span class="op" id="8119782">(</span><span class="string" id="8119783">&#34;tcp&#34;</span><span class="op" id="8119788">,</span>&nbsp;<span class="ident" id="8119790">ln</span><span class="op" id="8119792">.</span><span class="ident" id="8119793">Addr</span><span class="op" id="8119797">(</span><span class="op" id="8119798">)</span><span class="op" id="8119799">.</span><span class="ident" id="8119800">String</span><span class="op" id="8119806">(</span><span class="op" id="8119807">)</span><span class="op" id="8119808">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8119813">if</span>&nbsp;<span class="ident" id="8119816">err</span>&nbsp;<span class="op" id="8119820">!=</span>&nbsp;<span class="ident" id="8119823">nil</span>&nbsp;<span class="op" id="8119827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8119833">t</span><span class="op" id="8119834">.</span><span class="ident" id="8119835">Logf</span><span class="op" id="8119839">(</span><span class="string" id="8119840">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8119857">,</span>&nbsp;<span class="ident" id="8119859">err</span><span class="op" id="8119862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8119868">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8119878">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8119883">defer</span>&nbsp;<span class="ident" id="8119889">c</span><span class="op" id="8119890">.</span><span class="ident" id="8119891">Close</span><span class="op" id="8119896">(</span><span class="op" id="8119897">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8119902">var</span>&nbsp;<span class="ident" id="8119906">buf</span>&nbsp;<span class="op" id="8119910">[</span><span class="ident" id="8119911">msgLen</span><span class="op" id="8119917">]</span><span class="builtintype" id="8119918">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8119926">for</span>&nbsp;<span class="ident" id="8119930">m</span>&nbsp;<span class="op" id="8119932">:=</span>&nbsp;<span class="num" id="8119935">0</span><span class="op" id="8119936">;</span>&nbsp;<span class="ident" id="8119938">m</span>&nbsp;<span class="op" id="8119940">&lt;</span>&nbsp;<span class="ident" id="8119942">msgs</span><span class="op" id="8119946">;</span>&nbsp;<span class="ident" id="8119948">m</span><span class="op" id="8119949">++</span>&nbsp;<span class="op" id="8119952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8119958">if</span>&nbsp;<span class="op" id="8119961">!</span><span class="ident" id="8119962">sendMsg</span><span class="op" id="8119969">(</span><span class="ident" id="8119970">c</span><span class="op" id="8119971">,</span>&nbsp;<span class="ident" id="8119973">buf</span><span class="op" id="8119976">[</span><span class="op" id="8119977">:</span><span class="op" id="8119978">]</span><span class="op" id="8119979">)</span>&nbsp;<span class="op" id="8119981">||</span>&nbsp;<span class="op" id="8119984">!</span><span class="ident" id="8119985">recvMsg</span><span class="op" id="8119992">(</span><span class="ident" id="8119993">c</span><span class="op" id="8119994">,</span>&nbsp;<span class="ident" id="8119996">buf</span><span class="op" id="8119999">[</span><span class="op" id="8120000">:</span><span class="op" id="8120001">]</span><span class="op" id="8120002">)</span>&nbsp;<span class="op" id="8120004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8120011">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8120021">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8120026">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8120030">}</span><span class="op" id="8120031">(</span><span class="op" id="8120032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8120035">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8120038">for</span>&nbsp;<span class="ident" id="8120042">i</span>&nbsp;<span class="op" id="8120044">:=</span>&nbsp;<span class="num" id="8120047">0</span><span class="op" id="8120048">;</span>&nbsp;<span class="ident" id="8120050">i</span>&nbsp;<span class="op" id="8120052">&lt;</span>&nbsp;<span class="ident" id="8120054">conns</span><span class="op" id="8120059">;</span>&nbsp;<span class="ident" id="8120061">i</span><span class="op" id="8120062">++</span>&nbsp;<span class="op" id="8120065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8120069">&lt;-</span><span class="ident" id="8120071">done</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8120077">}</span><br>
<span class="lineno"></span><span class="op" id="8120079">}</span>
</div>
</body>
</html>
