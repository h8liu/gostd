<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>compress/lzw</h2>
<ul>
<li><a href="/gostd/compress/lzw/reader.go.html">reader.go</a></li>
<li><a href="/gostd/compress/lzw/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/compress/lzw/writer.go.html">writer.go</a></li>
<li><a href="/gostd/compress/lzw/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5625462">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5625517">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5625571">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5625622">//&nbsp;Package&nbsp;lzw&nbsp;implements&nbsp;the&nbsp;Lempel-Ziv-Welch&nbsp;compressed&nbsp;data&nbsp;format,</span><br>
<span class="lineno"></span><span class="comment" id="5625693">//&nbsp;described&nbsp;in&nbsp;T.&nbsp;A.&nbsp;Welch,&nbsp;``A&nbsp;Technique&nbsp;for&nbsp;High-Performance&nbsp;Data</span><br>
<span class="lineno"></span><span class="comment" id="5625762">//&nbsp;Compression&#39;&#39;,&nbsp;Computer,&nbsp;17(6)&nbsp;(June&nbsp;1984),&nbsp;pp&nbsp;8-19.</span><br>
<span class="lineno"></span><span class="comment" id="5625818">//</span><br>
<span class="lineno"></span><span class="comment" id="5625821">//&nbsp;In&nbsp;particular,&nbsp;it&nbsp;implements&nbsp;LZW&nbsp;as&nbsp;used&nbsp;by&nbsp;the&nbsp;GIF&nbsp;and&nbsp;PDF&nbsp;file</span><br>
<span class="lineno">10</span><span class="comment" id="5625889">//&nbsp;formats,&nbsp;which&nbsp;means&nbsp;variable-width&nbsp;codes&nbsp;up&nbsp;to&nbsp;12&nbsp;bits&nbsp;and&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="5625962">//&nbsp;two&nbsp;non-literal&nbsp;codes&nbsp;are&nbsp;a&nbsp;clear&nbsp;code&nbsp;and&nbsp;an&nbsp;EOF&nbsp;code.</span><br>
<span class="lineno"></span><span class="comment" id="5626021">//</span><br>
<span class="lineno"></span><span class="comment" id="5626024">//&nbsp;The&nbsp;TIFF&nbsp;file&nbsp;format&nbsp;uses&nbsp;a&nbsp;similar&nbsp;but&nbsp;incompatible&nbsp;version&nbsp;of&nbsp;the&nbsp;LZW</span><br>
<span class="lineno"></span><span class="comment" id="5626099">//&nbsp;algorithm.&nbsp;See&nbsp;the&nbsp;golang.org/x/image/tiff/lzw&nbsp;package&nbsp;for&nbsp;an</span><br>
<span class="lineno">15</span><span class="comment" id="5626164">//&nbsp;implementation.</span><br>
<span class="lineno"></span><span class="keyword" id="5626183">package</span>&nbsp;<span class="ident" id="5626191">lzw</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5626196">//&nbsp;TODO(nigeltao):&nbsp;check&nbsp;that&nbsp;PDF&nbsp;uses&nbsp;LZW&nbsp;in&nbsp;the&nbsp;same&nbsp;way&nbsp;as&nbsp;GIF,</span><br>
<span class="lineno"></span><span class="comment" id="5626263">//&nbsp;modulo&nbsp;LSB/MSB&nbsp;packing&nbsp;order.</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="5626297">import</span>&nbsp;<span class="op" id="5626304">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5626307">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5626316">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5626326">&#34;fmt&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5626333">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="5626338">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5626341">//&nbsp;Order&nbsp;specifies&nbsp;the&nbsp;bit&nbsp;ordering&nbsp;in&nbsp;an&nbsp;LZW&nbsp;data&nbsp;stream.</span><br>
<span class="lineno"></span><span class="keyword" id="5626400">type</span>&nbsp;<span class="ident" id="5626405">Order</span>&nbsp;<span class="builtintype" id="5626411">int</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="5626416">const</span>&nbsp;<span class="op" id="5626422">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5626425">//&nbsp;LSB&nbsp;means&nbsp;Least&nbsp;Significant&nbsp;Bits&nbsp;first,&nbsp;as&nbsp;used&nbsp;in&nbsp;the&nbsp;GIF&nbsp;file&nbsp;format.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5626501">LSB</span>&nbsp;<span class="ident" id="5626505">Order</span>&nbsp;<span class="op" id="5626511">=</span>&nbsp;<span class="ident" id="5626513">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5626519">//&nbsp;MSB&nbsp;means&nbsp;Most&nbsp;Significant&nbsp;Bits&nbsp;first,&nbsp;as&nbsp;used&nbsp;in&nbsp;the&nbsp;TIFF&nbsp;and&nbsp;PDF</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5626590">//&nbsp;file&nbsp;formats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5626608">MSB</span><br>
<span class="lineno"></span><span class="op" id="5626612">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5626615">const</span>&nbsp;<span class="op" id="5626621">(</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5626624">maxWidth</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5626643">=</span>&nbsp;<span class="num" id="5626645">12</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5626649">decoderInvalidCode</span>&nbsp;<span class="op" id="5626668">=</span>&nbsp;<span class="num" id="5626670">0xffff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5626678">flushBuffer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5626697">=</span>&nbsp;<span class="num" id="5626699">1</span>&nbsp;<span class="op" id="5626701">&lt;&lt;</span>&nbsp;<span class="ident" id="5626704">maxWidth</span><br>
<span class="lineno"></span><span class="op" id="5626713">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="5626716">//&nbsp;decoder&nbsp;is&nbsp;the&nbsp;state&nbsp;from&nbsp;which&nbsp;the&nbsp;readXxx&nbsp;method&nbsp;converts&nbsp;a&nbsp;byte</span><br>
<span class="lineno"></span><span class="comment" id="5626786">//&nbsp;stream&nbsp;into&nbsp;a&nbsp;code&nbsp;stream.</span><br>
<span class="lineno"></span><span class="keyword" id="5626816">type</span>&nbsp;<span class="ident" id="5626821">decoder</span>&nbsp;<span class="keyword" id="5626829">struct</span>&nbsp;<span class="op" id="5626836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5626839">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5626848">io</span><span class="op" id="5626850">.</span><span class="ident" id="5626851">ByteReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5626863">bits</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5626872">uint32</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5626880">nBits</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5626889">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5626895">width</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5626904">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5626910">read</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5626919">func</span><span class="op" id="5626923">(</span><span class="op" id="5626924">*</span><span class="ident" id="5626925">decoder</span><span class="op" id="5626932">)</span>&nbsp;<span class="op" id="5626934">(</span><span class="builtintype" id="5626935">uint16</span><span class="op" id="5626941">,</span>&nbsp;<span class="builtintype" id="5626943">error</span><span class="op" id="5626948">)</span>&nbsp;<span class="comment" id="5626950">//&nbsp;readLSB&nbsp;or&nbsp;readMSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5626973">litWidth</span>&nbsp;<span class="builtintype" id="5626982">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5627013">//&nbsp;width&nbsp;in&nbsp;bits&nbsp;of&nbsp;literal&nbsp;codes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5627048">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5627057">error</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5627065">//&nbsp;The&nbsp;first&nbsp;1&lt;&lt;litWidth&nbsp;codes&nbsp;are&nbsp;literal&nbsp;codes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5627116">//&nbsp;The&nbsp;next&nbsp;two&nbsp;codes&nbsp;mean&nbsp;clear&nbsp;and&nbsp;EOF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5627159">//&nbsp;Other&nbsp;valid&nbsp;codes&nbsp;are&nbsp;in&nbsp;the&nbsp;range&nbsp;[lo,&nbsp;hi]&nbsp;where&nbsp;lo&nbsp;:=&nbsp;clear&nbsp;+&nbsp;2,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5627230">//&nbsp;with&nbsp;the&nbsp;upper&nbsp;bound&nbsp;incrementing&nbsp;on&nbsp;each&nbsp;code&nbsp;seen.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5627287">//&nbsp;overflow&nbsp;is&nbsp;the&nbsp;code&nbsp;at&nbsp;which&nbsp;hi&nbsp;overflows&nbsp;the&nbsp;code&nbsp;width.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5627350">//&nbsp;last&nbsp;is&nbsp;the&nbsp;most&nbsp;recently&nbsp;seen&nbsp;code,&nbsp;or&nbsp;decoderInvalidCode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5627414">clear</span><span class="op" id="5627419">,</span>&nbsp;<span class="ident" id="5627421">eof</span><span class="op" id="5627424">,</span>&nbsp;<span class="ident" id="5627426">hi</span><span class="op" id="5627428">,</span>&nbsp;<span class="ident" id="5627430">overflow</span><span class="op" id="5627438">,</span>&nbsp;<span class="ident" id="5627440">last</span>&nbsp;<span class="builtintype" id="5627445">uint16</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5627454">//&nbsp;Each&nbsp;code&nbsp;c&nbsp;in&nbsp;[lo,&nbsp;hi]&nbsp;expands&nbsp;to&nbsp;two&nbsp;or&nbsp;more&nbsp;bytes.&nbsp;For&nbsp;c&nbsp;!=&nbsp;hi:</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5627525">//&nbsp;&nbsp;&nbsp;suffix[c]&nbsp;is&nbsp;the&nbsp;last&nbsp;of&nbsp;these&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5627569">//&nbsp;&nbsp;&nbsp;prefix[c]&nbsp;is&nbsp;the&nbsp;code&nbsp;for&nbsp;all&nbsp;but&nbsp;the&nbsp;last&nbsp;byte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5627624">//&nbsp;&nbsp;&nbsp;This&nbsp;code&nbsp;can&nbsp;either&nbsp;be&nbsp;a&nbsp;literal&nbsp;code&nbsp;or&nbsp;another&nbsp;code&nbsp;in&nbsp;[lo,&nbsp;c).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5627697">//&nbsp;The&nbsp;c&nbsp;==&nbsp;hi&nbsp;case&nbsp;is&nbsp;a&nbsp;special&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5627737">suffix</span>&nbsp;<span class="op" id="5627744">[</span><span class="num" id="5627745">1</span>&nbsp;<span class="op" id="5627747">&lt;&lt;</span>&nbsp;<span class="ident" id="5627750">maxWidth</span><span class="op" id="5627758">]</span><span class="builtintype" id="5627759">uint8</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5627766">prefix</span>&nbsp;<span class="op" id="5627773">[</span><span class="num" id="5627774">1</span>&nbsp;<span class="op" id="5627776">&lt;&lt;</span>&nbsp;<span class="ident" id="5627779">maxWidth</span><span class="op" id="5627787">]</span><span class="builtintype" id="5627788">uint16</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5627797">//&nbsp;output&nbsp;is&nbsp;the&nbsp;temporary&nbsp;output&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5627840">//&nbsp;Literal&nbsp;codes&nbsp;are&nbsp;accumulated&nbsp;from&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5627904">//&nbsp;Non-literal&nbsp;codes&nbsp;decode&nbsp;to&nbsp;a&nbsp;sequence&nbsp;of&nbsp;suffixes&nbsp;that&nbsp;are&nbsp;first</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5627974">//&nbsp;written&nbsp;right-to-left&nbsp;from&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;buffer&nbsp;before&nbsp;being&nbsp;copied</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5628047">//&nbsp;to&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5628079">//&nbsp;It&nbsp;is&nbsp;flushed&nbsp;when&nbsp;it&nbsp;contains&nbsp;&gt;=&nbsp;1&lt;&lt;maxWidth&nbsp;bytes,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5628136">//&nbsp;so&nbsp;that&nbsp;there&nbsp;is&nbsp;always&nbsp;room&nbsp;to&nbsp;decode&nbsp;an&nbsp;entire&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5628195">output</span>&nbsp;<span class="op" id="5628202">[</span><span class="num" id="5628203">2</span>&nbsp;<span class="op" id="5628205">*</span>&nbsp;<span class="num" id="5628207">1</span>&nbsp;<span class="op" id="5628209">&lt;&lt;</span>&nbsp;<span class="ident" id="5628212">maxWidth</span><span class="op" id="5628220">]</span><span class="builtintype" id="5628221">byte</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5628227">o</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5628234">int</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5628241">//&nbsp;write&nbsp;index&nbsp;into&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5628269">toRead</span>&nbsp;<span class="op" id="5628276">[</span><span class="op" id="5628277">]</span><span class="builtintype" id="5628278">byte</span>&nbsp;<span class="comment" id="5628283">//&nbsp;bytes&nbsp;to&nbsp;return&nbsp;from&nbsp;Read</span><br>
<span class="lineno"></span><span class="op" id="5628312">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5628315">//&nbsp;readLSB&nbsp;returns&nbsp;the&nbsp;next&nbsp;code&nbsp;for&nbsp;&#34;Least&nbsp;Significant&nbsp;Bits&nbsp;first&#34;&nbsp;data.</span><br>
<span class="lineno">85</span><span class="keyword" id="5628389">func</span>&nbsp;<span class="op" id="5628394">(</span><span class="ident" id="5628395">d</span>&nbsp;<span class="op" id="5628397">*</span><span class="ident" id="5628398">decoder</span><span class="op" id="5628405">)</span>&nbsp;<span class="ident" id="5628407">readLSB</span><span class="op" id="5628414">(</span><span class="op" id="5628415">)</span>&nbsp;<span class="op" id="5628417">(</span><span class="builtintype" id="5628418">uint16</span><span class="op" id="5628424">,</span>&nbsp;<span class="builtintype" id="5628426">error</span><span class="op" id="5628431">)</span>&nbsp;<span class="op" id="5628433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5628436">for</span>&nbsp;<span class="ident" id="5628440">d</span><span class="op" id="5628441">.</span><span class="ident" id="5628442">nBits</span>&nbsp;<span class="op" id="5628448">&lt;</span>&nbsp;<span class="ident" id="5628450">d</span><span class="op" id="5628451">.</span><span class="ident" id="5628452">width</span>&nbsp;<span class="op" id="5628458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5628462">x</span><span class="op" id="5628463">,</span>&nbsp;<span class="ident" id="5628465">err</span>&nbsp;<span class="op" id="5628469">:=</span>&nbsp;<span class="ident" id="5628472">d</span><span class="op" id="5628473">.</span><span class="ident" id="5628474">r</span><span class="op" id="5628475">.</span><span class="ident" id="5628476">ReadByte</span><span class="op" id="5628484">(</span><span class="op" id="5628485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5628489">if</span>&nbsp;<span class="ident" id="5628492">err</span>&nbsp;<span class="op" id="5628496">!=</span>&nbsp;<span class="ident" id="5628499">nil</span>&nbsp;<span class="op" id="5628503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5628508">return</span>&nbsp;<span class="num" id="5628515">0</span><span class="op" id="5628516">,</span>&nbsp;<span class="ident" id="5628518">err</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5628524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5628528">d</span><span class="op" id="5628529">.</span><span class="ident" id="5628530">bits</span>&nbsp;<span class="op" id="5628535">|=</span>&nbsp;<span class="builtintype" id="5628538">uint32</span><span class="op" id="5628544">(</span><span class="ident" id="5628545">x</span><span class="op" id="5628546">)</span>&nbsp;<span class="op" id="5628548">&lt;&lt;</span>&nbsp;<span class="ident" id="5628551">d</span><span class="op" id="5628552">.</span><span class="ident" id="5628553">nBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5628561">d</span><span class="op" id="5628562">.</span><span class="ident" id="5628563">nBits</span>&nbsp;<span class="op" id="5628569">+=</span>&nbsp;<span class="num" id="5628572">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5628575">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5628578">code</span>&nbsp;<span class="op" id="5628583">:=</span>&nbsp;<span class="builtintype" id="5628586">uint16</span><span class="op" id="5628592">(</span><span class="ident" id="5628593">d</span><span class="op" id="5628594">.</span><span class="ident" id="5628595">bits</span>&nbsp;<span class="op" id="5628600">&amp;</span>&nbsp;<span class="op" id="5628602">(</span><span class="num" id="5628603">1</span><span class="op" id="5628604">&lt;&lt;</span><span class="ident" id="5628606">d</span><span class="op" id="5628607">.</span><span class="ident" id="5628608">width</span>&nbsp;<span class="op" id="5628614">-</span>&nbsp;<span class="num" id="5628616">1</span><span class="op" id="5628617">)</span><span class="op" id="5628618">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5628621">d</span><span class="op" id="5628622">.</span><span class="ident" id="5628623">bits</span>&nbsp;<span class="op" id="5628628">&gt;&gt;=</span>&nbsp;<span class="ident" id="5628632">d</span><span class="op" id="5628633">.</span><span class="ident" id="5628634">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5628641">d</span><span class="op" id="5628642">.</span><span class="ident" id="5628643">nBits</span>&nbsp;<span class="op" id="5628649">-=</span>&nbsp;<span class="ident" id="5628652">d</span><span class="op" id="5628653">.</span><span class="ident" id="5628654">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5628661">return</span>&nbsp;<span class="ident" id="5628668">code</span><span class="op" id="5628672">,</span>&nbsp;<span class="ident" id="5628674">nil</span><br>
<span class="lineno"></span><span class="op" id="5628678">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="comment" id="5628681">//&nbsp;readMSB&nbsp;returns&nbsp;the&nbsp;next&nbsp;code&nbsp;for&nbsp;&#34;Most&nbsp;Significant&nbsp;Bits&nbsp;first&#34;&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="5628754">func</span>&nbsp;<span class="op" id="5628759">(</span><span class="ident" id="5628760">d</span>&nbsp;<span class="op" id="5628762">*</span><span class="ident" id="5628763">decoder</span><span class="op" id="5628770">)</span>&nbsp;<span class="ident" id="5628772">readMSB</span><span class="op" id="5628779">(</span><span class="op" id="5628780">)</span>&nbsp;<span class="op" id="5628782">(</span><span class="builtintype" id="5628783">uint16</span><span class="op" id="5628789">,</span>&nbsp;<span class="builtintype" id="5628791">error</span><span class="op" id="5628796">)</span>&nbsp;<span class="op" id="5628798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5628801">for</span>&nbsp;<span class="ident" id="5628805">d</span><span class="op" id="5628806">.</span><span class="ident" id="5628807">nBits</span>&nbsp;<span class="op" id="5628813">&lt;</span>&nbsp;<span class="ident" id="5628815">d</span><span class="op" id="5628816">.</span><span class="ident" id="5628817">width</span>&nbsp;<span class="op" id="5628823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5628827">x</span><span class="op" id="5628828">,</span>&nbsp;<span class="ident" id="5628830">err</span>&nbsp;<span class="op" id="5628834">:=</span>&nbsp;<span class="ident" id="5628837">d</span><span class="op" id="5628838">.</span><span class="ident" id="5628839">r</span><span class="op" id="5628840">.</span><span class="ident" id="5628841">ReadByte</span><span class="op" id="5628849">(</span><span class="op" id="5628850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5628854">if</span>&nbsp;<span class="ident" id="5628857">err</span>&nbsp;<span class="op" id="5628861">!=</span>&nbsp;<span class="ident" id="5628864">nil</span>&nbsp;<span class="op" id="5628868">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5628873">return</span>&nbsp;<span class="num" id="5628880">0</span><span class="op" id="5628881">,</span>&nbsp;<span class="ident" id="5628883">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5628889">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5628893">d</span><span class="op" id="5628894">.</span><span class="ident" id="5628895">bits</span>&nbsp;<span class="op" id="5628900">|=</span>&nbsp;<span class="builtintype" id="5628903">uint32</span><span class="op" id="5628909">(</span><span class="ident" id="5628910">x</span><span class="op" id="5628911">)</span>&nbsp;<span class="op" id="5628913">&lt;&lt;</span>&nbsp;<span class="op" id="5628916">(</span><span class="num" id="5628917">24</span>&nbsp;<span class="op" id="5628920">-</span>&nbsp;<span class="ident" id="5628922">d</span><span class="op" id="5628923">.</span><span class="ident" id="5628924">nBits</span><span class="op" id="5628929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5628933">d</span><span class="op" id="5628934">.</span><span class="ident" id="5628935">nBits</span>&nbsp;<span class="op" id="5628941">+=</span>&nbsp;<span class="num" id="5628944">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5628947">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5628950">code</span>&nbsp;<span class="op" id="5628955">:=</span>&nbsp;<span class="builtintype" id="5628958">uint16</span><span class="op" id="5628964">(</span><span class="ident" id="5628965">d</span><span class="op" id="5628966">.</span><span class="ident" id="5628967">bits</span>&nbsp;<span class="op" id="5628972">&gt;&gt;</span>&nbsp;<span class="op" id="5628975">(</span><span class="num" id="5628976">32</span>&nbsp;<span class="op" id="5628979">-</span>&nbsp;<span class="ident" id="5628981">d</span><span class="op" id="5628982">.</span><span class="ident" id="5628983">width</span><span class="op" id="5628988">)</span><span class="op" id="5628989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5628992">d</span><span class="op" id="5628993">.</span><span class="ident" id="5628994">bits</span>&nbsp;<span class="op" id="5628999">&lt;&lt;=</span>&nbsp;<span class="ident" id="5629003">d</span><span class="op" id="5629004">.</span><span class="ident" id="5629005">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5629012">d</span><span class="op" id="5629013">.</span><span class="ident" id="5629014">nBits</span>&nbsp;<span class="op" id="5629020">-=</span>&nbsp;<span class="ident" id="5629023">d</span><span class="op" id="5629024">.</span><span class="ident" id="5629025">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5629032">return</span>&nbsp;<span class="ident" id="5629039">code</span><span class="op" id="5629043">,</span>&nbsp;<span class="ident" id="5629045">nil</span><br>
<span class="lineno"></span><span class="op" id="5629049">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="keyword" id="5629052">func</span>&nbsp;<span class="op" id="5629057">(</span><span class="ident" id="5629058">d</span>&nbsp;<span class="op" id="5629060">*</span><span class="ident" id="5629061">decoder</span><span class="op" id="5629068">)</span>&nbsp;<span class="ident" id="5629070">Read</span><span class="op" id="5629074">(</span><span class="ident" id="5629075">b</span>&nbsp;<span class="op" id="5629077">[</span><span class="op" id="5629078">]</span><span class="builtintype" id="5629079">byte</span><span class="op" id="5629083">)</span>&nbsp;<span class="op" id="5629085">(</span><span class="builtintype" id="5629086">int</span><span class="op" id="5629089">,</span>&nbsp;<span class="builtintype" id="5629091">error</span><span class="op" id="5629096">)</span>&nbsp;<span class="op" id="5629098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5629101">for</span>&nbsp;<span class="op" id="5629105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5629109">if</span>&nbsp;<span class="builtinfunc" id="5629112">len</span><span class="op" id="5629115">(</span><span class="ident" id="5629116">d</span><span class="op" id="5629117">.</span><span class="ident" id="5629118">toRead</span><span class="op" id="5629124">)</span>&nbsp;<span class="op" id="5629126">&gt;</span>&nbsp;<span class="num" id="5629128">0</span>&nbsp;<span class="op" id="5629130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5629135">n</span>&nbsp;<span class="op" id="5629137">:=</span>&nbsp;<span class="builtinfunc" id="5629140">copy</span><span class="op" id="5629144">(</span><span class="ident" id="5629145">b</span><span class="op" id="5629146">,</span>&nbsp;<span class="ident" id="5629148">d</span><span class="op" id="5629149">.</span><span class="ident" id="5629150">toRead</span><span class="op" id="5629156">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5629161">d</span><span class="op" id="5629162">.</span><span class="ident" id="5629163">toRead</span>&nbsp;<span class="op" id="5629170">=</span>&nbsp;<span class="ident" id="5629172">d</span><span class="op" id="5629173">.</span><span class="ident" id="5629174">toRead</span><span class="op" id="5629180">[</span><span class="ident" id="5629181">n</span><span class="op" id="5629182">:</span><span class="op" id="5629183">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5629188">return</span>&nbsp;<span class="ident" id="5629195">n</span><span class="op" id="5629196">,</span>&nbsp;<span class="ident" id="5629198">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5629204">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5629208">if</span>&nbsp;<span class="ident" id="5629211">d</span><span class="op" id="5629212">.</span><span class="ident" id="5629213">err</span>&nbsp;<span class="op" id="5629217">!=</span>&nbsp;<span class="ident" id="5629220">nil</span>&nbsp;<span class="op" id="5629224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5629229">return</span>&nbsp;<span class="num" id="5629236">0</span><span class="op" id="5629237">,</span>&nbsp;<span class="ident" id="5629239">d</span><span class="op" id="5629240">.</span><span class="ident" id="5629241">err</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5629247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5629251">d</span><span class="op" id="5629252">.</span><span class="ident" id="5629253">decode</span><span class="op" id="5629259">(</span><span class="op" id="5629260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5629263">}</span><br>
<span class="lineno"></span><span class="op" id="5629265">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="comment" id="5629268">//&nbsp;decode&nbsp;decompresses&nbsp;bytes&nbsp;from&nbsp;r&nbsp;and&nbsp;leaves&nbsp;them&nbsp;in&nbsp;d.toRead.</span><br>
<span class="lineno"></span><span class="comment" id="5629333">//&nbsp;read&nbsp;specifies&nbsp;how&nbsp;to&nbsp;decode&nbsp;bytes&nbsp;into&nbsp;codes.</span><br>
<span class="lineno"></span><span class="comment" id="5629383">//&nbsp;litWidth&nbsp;is&nbsp;the&nbsp;width&nbsp;in&nbsp;bits&nbsp;of&nbsp;literal&nbsp;codes.</span><br>
<span class="lineno"></span><span class="keyword" id="5629434">func</span>&nbsp;<span class="op" id="5629439">(</span><span class="ident" id="5629440">d</span>&nbsp;<span class="op" id="5629442">*</span><span class="ident" id="5629443">decoder</span><span class="op" id="5629450">)</span>&nbsp;<span class="ident" id="5629452">decode</span><span class="op" id="5629458">(</span><span class="op" id="5629459">)</span>&nbsp;<span class="op" id="5629461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5629464">//&nbsp;Loop&nbsp;over&nbsp;the&nbsp;code&nbsp;stream,&nbsp;converting&nbsp;codes&nbsp;into&nbsp;decompressed&nbsp;bytes.</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5629537">for</span>&nbsp;<span class="op" id="5629541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5629545">code</span><span class="op" id="5629549">,</span>&nbsp;<span class="ident" id="5629551">err</span>&nbsp;<span class="op" id="5629555">:=</span>&nbsp;<span class="ident" id="5629558">d</span><span class="op" id="5629559">.</span><span class="ident" id="5629560">read</span><span class="op" id="5629564">(</span><span class="ident" id="5629565">d</span><span class="op" id="5629566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5629570">if</span>&nbsp;<span class="ident" id="5629573">err</span>&nbsp;<span class="op" id="5629577">!=</span>&nbsp;<span class="ident" id="5629580">nil</span>&nbsp;<span class="op" id="5629584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5629589">if</span>&nbsp;<span class="ident" id="5629592">err</span>&nbsp;<span class="op" id="5629596">==</span>&nbsp;<span class="ident" id="5629599">io</span><span class="op" id="5629601">.</span><span class="ident" id="5629602">EOF</span>&nbsp;<span class="op" id="5629606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5629612">err</span>&nbsp;<span class="op" id="5629616">=</span>&nbsp;<span class="ident" id="5629618">io</span><span class="op" id="5629620">.</span><span class="ident" id="5629621">ErrUnexpectedEOF</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5629641">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5629646">d</span><span class="op" id="5629647">.</span><span class="ident" id="5629648">err</span>&nbsp;<span class="op" id="5629652">=</span>&nbsp;<span class="ident" id="5629654">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5629661">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5629670">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5629674">switch</span>&nbsp;<span class="op" id="5629681">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5629685">case</span>&nbsp;<span class="ident" id="5629690">code</span>&nbsp;<span class="op" id="5629695">&lt;</span>&nbsp;<span class="ident" id="5629697">d</span><span class="op" id="5629698">.</span><span class="ident" id="5629699">clear</span><span class="op" id="5629704">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5629709">//&nbsp;We&nbsp;have&nbsp;a&nbsp;literal&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5629739">d</span><span class="op" id="5629740">.</span><span class="ident" id="5629741">output</span><span class="op" id="5629747">[</span><span class="ident" id="5629748">d</span><span class="op" id="5629749">.</span><span class="ident" id="5629750">o</span><span class="op" id="5629751">]</span>&nbsp;<span class="op" id="5629753">=</span>&nbsp;<span class="builtintype" id="5629755">uint8</span><span class="op" id="5629760">(</span><span class="ident" id="5629761">code</span><span class="op" id="5629765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5629770">d</span><span class="op" id="5629771">.</span><span class="ident" id="5629772">o</span><span class="op" id="5629773">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5629779">if</span>&nbsp;<span class="ident" id="5629782">d</span><span class="op" id="5629783">.</span><span class="ident" id="5629784">last</span>&nbsp;<span class="op" id="5629789">!=</span>&nbsp;<span class="ident" id="5629792">decoderInvalidCode</span>&nbsp;<span class="op" id="5629811">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5629817">//&nbsp;Save&nbsp;what&nbsp;the&nbsp;hi&nbsp;code&nbsp;expands&nbsp;to.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5629858">d</span><span class="op" id="5629859">.</span><span class="ident" id="5629860">suffix</span><span class="op" id="5629866">[</span><span class="ident" id="5629867">d</span><span class="op" id="5629868">.</span><span class="ident" id="5629869">hi</span><span class="op" id="5629871">]</span>&nbsp;<span class="op" id="5629873">=</span>&nbsp;<span class="builtintype" id="5629875">uint8</span><span class="op" id="5629880">(</span><span class="ident" id="5629881">code</span><span class="op" id="5629885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5629891">d</span><span class="op" id="5629892">.</span><span class="ident" id="5629893">prefix</span><span class="op" id="5629899">[</span><span class="ident" id="5629900">d</span><span class="op" id="5629901">.</span><span class="ident" id="5629902">hi</span><span class="op" id="5629904">]</span>&nbsp;<span class="op" id="5629906">=</span>&nbsp;<span class="ident" id="5629908">d</span><span class="op" id="5629909">.</span><span class="ident" id="5629910">last</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5629918">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5629922">case</span>&nbsp;<span class="ident" id="5629927">code</span>&nbsp;<span class="op" id="5629932">==</span>&nbsp;<span class="ident" id="5629935">d</span><span class="op" id="5629936">.</span><span class="ident" id="5629937">clear</span><span class="op" id="5629942">:</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5629947">d</span><span class="op" id="5629948">.</span><span class="ident" id="5629949">width</span>&nbsp;<span class="op" id="5629955">=</span>&nbsp;<span class="num" id="5629957">1</span>&nbsp;<span class="op" id="5629959">+</span>&nbsp;<span class="builtintype" id="5629961">uint</span><span class="op" id="5629965">(</span><span class="ident" id="5629966">d</span><span class="op" id="5629967">.</span><span class="ident" id="5629968">litWidth</span><span class="op" id="5629976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5629981">d</span><span class="op" id="5629982">.</span><span class="ident" id="5629983">hi</span>&nbsp;<span class="op" id="5629986">=</span>&nbsp;<span class="ident" id="5629988">d</span><span class="op" id="5629989">.</span><span class="ident" id="5629990">eof</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5629997">d</span><span class="op" id="5629998">.</span><span class="ident" id="5629999">overflow</span>&nbsp;<span class="op" id="5630008">=</span>&nbsp;<span class="num" id="5630010">1</span>&nbsp;<span class="op" id="5630012">&lt;&lt;</span>&nbsp;<span class="ident" id="5630015">d</span><span class="op" id="5630016">.</span><span class="ident" id="5630017">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5630026">d</span><span class="op" id="5630027">.</span><span class="ident" id="5630028">last</span>&nbsp;<span class="op" id="5630033">=</span>&nbsp;<span class="ident" id="5630035">decoderInvalidCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5630057">continue</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5630068">case</span>&nbsp;<span class="ident" id="5630073">code</span>&nbsp;<span class="op" id="5630078">==</span>&nbsp;<span class="ident" id="5630081">d</span><span class="op" id="5630082">.</span><span class="ident" id="5630083">eof</span><span class="op" id="5630086">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5630091">d</span><span class="op" id="5630092">.</span><span class="ident" id="5630093">flush</span><span class="op" id="5630098">(</span><span class="op" id="5630099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5630104">d</span><span class="op" id="5630105">.</span><span class="ident" id="5630106">err</span>&nbsp;<span class="op" id="5630110">=</span>&nbsp;<span class="ident" id="5630112">io</span><span class="op" id="5630114">.</span><span class="ident" id="5630115">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5630122">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5630131">case</span>&nbsp;<span class="ident" id="5630136">code</span>&nbsp;<span class="op" id="5630141">&lt;=</span>&nbsp;<span class="ident" id="5630144">d</span><span class="op" id="5630145">.</span><span class="ident" id="5630146">hi</span><span class="op" id="5630148">:</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5630153">c</span><span class="op" id="5630154">,</span>&nbsp;<span class="ident" id="5630156">i</span>&nbsp;<span class="op" id="5630158">:=</span>&nbsp;<span class="ident" id="5630161">code</span><span class="op" id="5630165">,</span>&nbsp;<span class="builtinfunc" id="5630167">len</span><span class="op" id="5630170">(</span><span class="ident" id="5630171">d</span><span class="op" id="5630172">.</span><span class="ident" id="5630173">output</span><span class="op" id="5630179">)</span><span class="op" id="5630180">-</span><span class="num" id="5630181">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5630186">if</span>&nbsp;<span class="ident" id="5630189">code</span>&nbsp;<span class="op" id="5630194">==</span>&nbsp;<span class="ident" id="5630197">d</span><span class="op" id="5630198">.</span><span class="ident" id="5630199">hi</span>&nbsp;<span class="op" id="5630202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5630208">//&nbsp;code&nbsp;==&nbsp;hi&nbsp;is&nbsp;a&nbsp;special&nbsp;case&nbsp;which&nbsp;expands&nbsp;to&nbsp;the&nbsp;last&nbsp;expansion</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5630280">//&nbsp;followed&nbsp;by&nbsp;the&nbsp;head&nbsp;of&nbsp;the&nbsp;last&nbsp;expansion.&nbsp;To&nbsp;find&nbsp;the&nbsp;head,&nbsp;we&nbsp;walk</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5630357">//&nbsp;the&nbsp;prefix&nbsp;chain&nbsp;until&nbsp;we&nbsp;find&nbsp;a&nbsp;literal&nbsp;code.</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5630411">c</span>&nbsp;<span class="op" id="5630413">=</span>&nbsp;<span class="ident" id="5630415">d</span><span class="op" id="5630416">.</span><span class="ident" id="5630417">last</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5630426">for</span>&nbsp;<span class="ident" id="5630430">c</span>&nbsp;<span class="op" id="5630432">&gt;=</span>&nbsp;<span class="ident" id="5630435">d</span><span class="op" id="5630436">.</span><span class="ident" id="5630437">clear</span>&nbsp;<span class="op" id="5630443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5630450">c</span>&nbsp;<span class="op" id="5630452">=</span>&nbsp;<span class="ident" id="5630454">d</span><span class="op" id="5630455">.</span><span class="ident" id="5630456">prefix</span><span class="op" id="5630462">[</span><span class="ident" id="5630463">c</span><span class="op" id="5630464">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5630470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5630476">d</span><span class="op" id="5630477">.</span><span class="ident" id="5630478">output</span><span class="op" id="5630484">[</span><span class="ident" id="5630485">i</span><span class="op" id="5630486">]</span>&nbsp;<span class="op" id="5630488">=</span>&nbsp;<span class="builtintype" id="5630490">uint8</span><span class="op" id="5630495">(</span><span class="ident" id="5630496">c</span><span class="op" id="5630497">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5630503">i</span><span class="op" id="5630504">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5630511">c</span>&nbsp;<span class="op" id="5630513">=</span>&nbsp;<span class="ident" id="5630515">d</span><span class="op" id="5630516">.</span><span class="ident" id="5630517">last</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5630525">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5630530">//&nbsp;Copy&nbsp;the&nbsp;suffix&nbsp;chain&nbsp;into&nbsp;output&nbsp;and&nbsp;then&nbsp;write&nbsp;that&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5630596">for</span>&nbsp;<span class="ident" id="5630600">c</span>&nbsp;<span class="op" id="5630602">&gt;=</span>&nbsp;<span class="ident" id="5630605">d</span><span class="op" id="5630606">.</span><span class="ident" id="5630607">clear</span>&nbsp;<span class="op" id="5630613">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5630619">d</span><span class="op" id="5630620">.</span><span class="ident" id="5630621">output</span><span class="op" id="5630627">[</span><span class="ident" id="5630628">i</span><span class="op" id="5630629">]</span>&nbsp;<span class="op" id="5630631">=</span>&nbsp;<span class="ident" id="5630633">d</span><span class="op" id="5630634">.</span><span class="ident" id="5630635">suffix</span><span class="op" id="5630641">[</span><span class="ident" id="5630642">c</span><span class="op" id="5630643">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5630649">i</span><span class="op" id="5630650">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5630657">c</span>&nbsp;<span class="op" id="5630659">=</span>&nbsp;<span class="ident" id="5630661">d</span><span class="op" id="5630662">.</span><span class="ident" id="5630663">prefix</span><span class="op" id="5630669">[</span><span class="ident" id="5630670">c</span><span class="op" id="5630671">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5630676">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5630681">d</span><span class="op" id="5630682">.</span><span class="ident" id="5630683">output</span><span class="op" id="5630689">[</span><span class="ident" id="5630690">i</span><span class="op" id="5630691">]</span>&nbsp;<span class="op" id="5630693">=</span>&nbsp;<span class="builtintype" id="5630695">uint8</span><span class="op" id="5630700">(</span><span class="ident" id="5630701">c</span><span class="op" id="5630702">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5630707">d</span><span class="op" id="5630708">.</span><span class="ident" id="5630709">o</span>&nbsp;<span class="op" id="5630711">+=</span>&nbsp;<span class="builtinfunc" id="5630714">copy</span><span class="op" id="5630718">(</span><span class="ident" id="5630719">d</span><span class="op" id="5630720">.</span><span class="ident" id="5630721">output</span><span class="op" id="5630727">[</span><span class="ident" id="5630728">d</span><span class="op" id="5630729">.</span><span class="ident" id="5630730">o</span><span class="op" id="5630731">:</span><span class="op" id="5630732">]</span><span class="op" id="5630733">,</span>&nbsp;<span class="ident" id="5630735">d</span><span class="op" id="5630736">.</span><span class="ident" id="5630737">output</span><span class="op" id="5630743">[</span><span class="ident" id="5630744">i</span><span class="op" id="5630745">:</span><span class="op" id="5630746">]</span><span class="op" id="5630747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5630752">if</span>&nbsp;<span class="ident" id="5630755">d</span><span class="op" id="5630756">.</span><span class="ident" id="5630757">last</span>&nbsp;<span class="op" id="5630762">!=</span>&nbsp;<span class="ident" id="5630765">decoderInvalidCode</span>&nbsp;<span class="op" id="5630784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5630790">//&nbsp;Save&nbsp;what&nbsp;the&nbsp;hi&nbsp;code&nbsp;expands&nbsp;to.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5630831">d</span><span class="op" id="5630832">.</span><span class="ident" id="5630833">suffix</span><span class="op" id="5630839">[</span><span class="ident" id="5630840">d</span><span class="op" id="5630841">.</span><span class="ident" id="5630842">hi</span><span class="op" id="5630844">]</span>&nbsp;<span class="op" id="5630846">=</span>&nbsp;<span class="builtintype" id="5630848">uint8</span><span class="op" id="5630853">(</span><span class="ident" id="5630854">c</span><span class="op" id="5630855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5630861">d</span><span class="op" id="5630862">.</span><span class="ident" id="5630863">prefix</span><span class="op" id="5630869">[</span><span class="ident" id="5630870">d</span><span class="op" id="5630871">.</span><span class="ident" id="5630872">hi</span><span class="op" id="5630874">]</span>&nbsp;<span class="op" id="5630876">=</span>&nbsp;<span class="ident" id="5630878">d</span><span class="op" id="5630879">.</span><span class="ident" id="5630880">last</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5630888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5630892">default</span><span class="op" id="5630899">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5630904">d</span><span class="op" id="5630905">.</span><span class="ident" id="5630906">err</span>&nbsp;<span class="op" id="5630910">=</span>&nbsp;<span class="ident" id="5630912">errors</span><span class="op" id="5630918">.</span><span class="ident" id="5630919">New</span><span class="op" id="5630922">(</span><span class="string" id="5630923">&#34;lzw:&nbsp;invalid&nbsp;code&#34;</span><span class="op" id="5630942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5630947">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5630956">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5630960">d</span><span class="op" id="5630961">.</span><span class="ident" id="5630962">last</span><span class="op" id="5630966">,</span>&nbsp;<span class="ident" id="5630968">d</span><span class="op" id="5630969">.</span><span class="ident" id="5630970">hi</span>&nbsp;<span class="op" id="5630973">=</span>&nbsp;<span class="ident" id="5630975">code</span><span class="op" id="5630979">,</span>&nbsp;<span class="ident" id="5630981">d</span><span class="op" id="5630982">.</span><span class="ident" id="5630983">hi</span><span class="op" id="5630985">+</span><span class="num" id="5630986">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5630990">if</span>&nbsp;<span class="ident" id="5630993">d</span><span class="op" id="5630994">.</span><span class="ident" id="5630995">hi</span>&nbsp;<span class="op" id="5630998">&gt;=</span>&nbsp;<span class="ident" id="5631001">d</span><span class="op" id="5631002">.</span><span class="ident" id="5631003">overflow</span>&nbsp;<span class="op" id="5631012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5631017">if</span>&nbsp;<span class="ident" id="5631020">d</span><span class="op" id="5631021">.</span><span class="ident" id="5631022">width</span>&nbsp;<span class="op" id="5631028">==</span>&nbsp;<span class="ident" id="5631031">maxWidth</span>&nbsp;<span class="op" id="5631040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5631046">d</span><span class="op" id="5631047">.</span><span class="ident" id="5631048">last</span>&nbsp;<span class="op" id="5631053">=</span>&nbsp;<span class="ident" id="5631055">decoderInvalidCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5631077">}</span>&nbsp;<span class="keyword" id="5631079">else</span>&nbsp;<span class="op" id="5631084">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5631090">d</span><span class="op" id="5631091">.</span><span class="ident" id="5631092">width</span><span class="op" id="5631097">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5631104">d</span><span class="op" id="5631105">.</span><span class="ident" id="5631106">overflow</span>&nbsp;<span class="op" id="5631115">&lt;&lt;=</span>&nbsp;<span class="num" id="5631119">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5631124">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5631128">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5631132">if</span>&nbsp;<span class="ident" id="5631135">d</span><span class="op" id="5631136">.</span><span class="ident" id="5631137">o</span>&nbsp;<span class="op" id="5631139">&gt;=</span>&nbsp;<span class="ident" id="5631142">flushBuffer</span>&nbsp;<span class="op" id="5631154">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5631159">d</span><span class="op" id="5631160">.</span><span class="ident" id="5631161">flush</span><span class="op" id="5631166">(</span><span class="op" id="5631167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5631172">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5631181">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5631184">}</span><br>
<span class="lineno"></span><span class="op" id="5631186">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span><span class="keyword" id="5631189">func</span>&nbsp;<span class="op" id="5631194">(</span><span class="ident" id="5631195">d</span>&nbsp;<span class="op" id="5631197">*</span><span class="ident" id="5631198">decoder</span><span class="op" id="5631205">)</span>&nbsp;<span class="ident" id="5631207">flush</span><span class="op" id="5631212">(</span><span class="op" id="5631213">)</span>&nbsp;<span class="op" id="5631215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5631218">d</span><span class="op" id="5631219">.</span><span class="ident" id="5631220">toRead</span>&nbsp;<span class="op" id="5631227">=</span>&nbsp;<span class="ident" id="5631229">d</span><span class="op" id="5631230">.</span><span class="ident" id="5631231">output</span><span class="op" id="5631237">[</span><span class="op" id="5631238">:</span><span class="ident" id="5631239">d</span><span class="op" id="5631240">.</span><span class="ident" id="5631241">o</span><span class="op" id="5631242">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5631245">d</span><span class="op" id="5631246">.</span><span class="ident" id="5631247">o</span>&nbsp;<span class="op" id="5631249">=</span>&nbsp;<span class="num" id="5631251">0</span><br>
<span class="lineno"></span><span class="op" id="5631253">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="5631256">var</span>&nbsp;<span class="ident" id="5631260">errClosed</span>&nbsp;<span class="op" id="5631270">=</span>&nbsp;<span class="ident" id="5631272">errors</span><span class="op" id="5631278">.</span><span class="ident" id="5631279">New</span><span class="op" id="5631282">(</span><span class="string" id="5631283">&#34;compress/lzw:&nbsp;reader/writer&nbsp;is&nbsp;closed&#34;</span><span class="op" id="5631322">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5631325">func</span>&nbsp;<span class="op" id="5631330">(</span><span class="ident" id="5631331">d</span>&nbsp;<span class="op" id="5631333">*</span><span class="ident" id="5631334">decoder</span><span class="op" id="5631341">)</span>&nbsp;<span class="ident" id="5631343">Close</span><span class="op" id="5631348">(</span><span class="op" id="5631349">)</span>&nbsp;<span class="builtintype" id="5631351">error</span>&nbsp;<span class="op" id="5631357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5631360">d</span><span class="op" id="5631361">.</span><span class="ident" id="5631362">err</span>&nbsp;<span class="op" id="5631366">=</span>&nbsp;<span class="ident" id="5631368">errClosed</span>&nbsp;<span class="comment" id="5631378">//&nbsp;in&nbsp;case&nbsp;any&nbsp;Reads&nbsp;come&nbsp;along</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5631411">return</span>&nbsp;<span class="ident" id="5631418">nil</span><br>
<span class="lineno"></span><span class="op" id="5631422">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5631425">//&nbsp;NewReader&nbsp;creates&nbsp;a&nbsp;new&nbsp;io.ReadCloser.</span><br>
<span class="lineno"></span><span class="comment" id="5631467">//&nbsp;Reads&nbsp;from&nbsp;the&nbsp;returned&nbsp;io.ReadCloser&nbsp;read&nbsp;and&nbsp;decompress&nbsp;data&nbsp;from&nbsp;r.</span><br>
<span class="lineno">225</span><span class="comment" id="5631541">//&nbsp;If&nbsp;r&nbsp;does&nbsp;not&nbsp;also&nbsp;implement&nbsp;io.ByteReader,</span><br>
<span class="lineno"></span><span class="comment" id="5631588">//&nbsp;the&nbsp;decompressor&nbsp;may&nbsp;read&nbsp;more&nbsp;data&nbsp;than&nbsp;necessary&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="comment" id="5631650">//&nbsp;It&nbsp;is&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;call&nbsp;Close&nbsp;on&nbsp;the&nbsp;ReadCloser&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="5631724">//&nbsp;finished&nbsp;reading.</span><br>
<span class="lineno"></span><span class="comment" id="5631745">//&nbsp;The&nbsp;number&nbsp;of&nbsp;bits&nbsp;to&nbsp;use&nbsp;for&nbsp;literal&nbsp;codes,&nbsp;litWidth,&nbsp;must&nbsp;be&nbsp;in&nbsp;the</span><br>
<span class="lineno">230</span><span class="comment" id="5631818">//&nbsp;range&nbsp;[2,8]&nbsp;and&nbsp;is&nbsp;typically&nbsp;8.</span><br>
<span class="lineno"></span><span class="keyword" id="5631853">func</span>&nbsp;<span class="ident" id="5631858">NewReader</span><span class="op" id="5631867">(</span><span class="ident" id="5631868">r</span>&nbsp;<span class="ident" id="5631870">io</span><span class="op" id="5631872">.</span><span class="ident" id="5631873">Reader</span><span class="op" id="5631879">,</span>&nbsp;<span class="ident" id="5631881">order</span>&nbsp;<span class="ident" id="5631887">Order</span><span class="op" id="5631892">,</span>&nbsp;<span class="ident" id="5631894">litWidth</span>&nbsp;<span class="builtintype" id="5631903">int</span><span class="op" id="5631906">)</span>&nbsp;<span class="ident" id="5631908">io</span><span class="op" id="5631910">.</span><span class="ident" id="5631911">ReadCloser</span>&nbsp;<span class="op" id="5631922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5631925">d</span>&nbsp;<span class="op" id="5631927">:=</span>&nbsp;<span class="builtinfunc" id="5631930">new</span><span class="op" id="5631933">(</span><span class="ident" id="5631934">decoder</span><span class="op" id="5631941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5631944">switch</span>&nbsp;<span class="ident" id="5631951">order</span>&nbsp;<span class="op" id="5631957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5631960">case</span>&nbsp;<span class="ident" id="5631965">LSB</span><span class="op" id="5631968">:</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5631972">d</span><span class="op" id="5631973">.</span><span class="ident" id="5631974">read</span>&nbsp;<span class="op" id="5631979">=</span>&nbsp;<span class="op" id="5631981">(</span><span class="op" id="5631982">*</span><span class="ident" id="5631983">decoder</span><span class="op" id="5631990">)</span><span class="op" id="5631991">.</span><span class="ident" id="5631992">readLSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5632001">case</span>&nbsp;<span class="ident" id="5632006">MSB</span><span class="op" id="5632009">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5632013">d</span><span class="op" id="5632014">.</span><span class="ident" id="5632015">read</span>&nbsp;<span class="op" id="5632020">=</span>&nbsp;<span class="op" id="5632022">(</span><span class="op" id="5632023">*</span><span class="ident" id="5632024">decoder</span><span class="op" id="5632031">)</span><span class="op" id="5632032">.</span><span class="ident" id="5632033">readMSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5632042">default</span><span class="op" id="5632049">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5632053">d</span><span class="op" id="5632054">.</span><span class="ident" id="5632055">err</span>&nbsp;<span class="op" id="5632059">=</span>&nbsp;<span class="ident" id="5632061">errors</span><span class="op" id="5632067">.</span><span class="ident" id="5632068">New</span><span class="op" id="5632071">(</span><span class="string" id="5632072">&#34;lzw:&nbsp;unknown&nbsp;order&#34;</span><span class="op" id="5632092">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5632096">return</span>&nbsp;<span class="ident" id="5632103">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5632106">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5632109">if</span>&nbsp;<span class="ident" id="5632112">litWidth</span>&nbsp;<span class="op" id="5632121">&lt;</span>&nbsp;<span class="num" id="5632123">2</span>&nbsp;<span class="op" id="5632125">||</span>&nbsp;<span class="num" id="5632128">8</span>&nbsp;<span class="op" id="5632130">&lt;</span>&nbsp;<span class="ident" id="5632132">litWidth</span>&nbsp;<span class="op" id="5632141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5632145">d</span><span class="op" id="5632146">.</span><span class="ident" id="5632147">err</span>&nbsp;<span class="op" id="5632151">=</span>&nbsp;<span class="ident" id="5632153">fmt</span><span class="op" id="5632156">.</span><span class="ident" id="5632157">Errorf</span><span class="op" id="5632163">(</span><span class="string" id="5632164">&#34;lzw:&nbsp;litWidth&nbsp;%d&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="5632195">,</span>&nbsp;<span class="ident" id="5632197">litWidth</span><span class="op" id="5632205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5632209">return</span>&nbsp;<span class="ident" id="5632216">d</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5632219">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5632222">if</span>&nbsp;<span class="ident" id="5632225">br</span><span class="op" id="5632227">,</span>&nbsp;<span class="ident" id="5632229">ok</span>&nbsp;<span class="op" id="5632232">:=</span>&nbsp;<span class="ident" id="5632235">r</span><span class="op" id="5632236">.</span><span class="op" id="5632237">(</span><span class="ident" id="5632238">io</span><span class="op" id="5632240">.</span><span class="ident" id="5632241">ByteReader</span><span class="op" id="5632251">)</span><span class="op" id="5632252">;</span>&nbsp;<span class="ident" id="5632254">ok</span>&nbsp;<span class="op" id="5632257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5632261">d</span><span class="op" id="5632262">.</span><span class="ident" id="5632263">r</span>&nbsp;<span class="op" id="5632265">=</span>&nbsp;<span class="ident" id="5632267">br</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5632271">}</span>&nbsp;<span class="keyword" id="5632273">else</span>&nbsp;<span class="op" id="5632278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5632282">d</span><span class="op" id="5632283">.</span><span class="ident" id="5632284">r</span>&nbsp;<span class="op" id="5632286">=</span>&nbsp;<span class="ident" id="5632288">bufio</span><span class="op" id="5632293">.</span><span class="ident" id="5632294">NewReader</span><span class="op" id="5632303">(</span><span class="ident" id="5632304">r</span><span class="op" id="5632305">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5632308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5632311">d</span><span class="op" id="5632312">.</span><span class="ident" id="5632313">litWidth</span>&nbsp;<span class="op" id="5632322">=</span>&nbsp;<span class="ident" id="5632324">litWidth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5632334">d</span><span class="op" id="5632335">.</span><span class="ident" id="5632336">width</span>&nbsp;<span class="op" id="5632342">=</span>&nbsp;<span class="num" id="5632344">1</span>&nbsp;<span class="op" id="5632346">+</span>&nbsp;<span class="builtintype" id="5632348">uint</span><span class="op" id="5632352">(</span><span class="ident" id="5632353">litWidth</span><span class="op" id="5632361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5632364">d</span><span class="op" id="5632365">.</span><span class="ident" id="5632366">clear</span>&nbsp;<span class="op" id="5632372">=</span>&nbsp;<span class="builtintype" id="5632374">uint16</span><span class="op" id="5632380">(</span><span class="num" id="5632381">1</span><span class="op" id="5632382">)</span>&nbsp;<span class="op" id="5632384">&lt;&lt;</span>&nbsp;<span class="builtintype" id="5632387">uint</span><span class="op" id="5632391">(</span><span class="ident" id="5632392">litWidth</span><span class="op" id="5632400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5632403">d</span><span class="op" id="5632404">.</span><span class="ident" id="5632405">eof</span><span class="op" id="5632408">,</span>&nbsp;<span class="ident" id="5632410">d</span><span class="op" id="5632411">.</span><span class="ident" id="5632412">hi</span>&nbsp;<span class="op" id="5632415">=</span>&nbsp;<span class="ident" id="5632417">d</span><span class="op" id="5632418">.</span><span class="ident" id="5632419">clear</span><span class="op" id="5632424">+</span><span class="num" id="5632425">1</span><span class="op" id="5632426">,</span>&nbsp;<span class="ident" id="5632428">d</span><span class="op" id="5632429">.</span><span class="ident" id="5632430">clear</span><span class="op" id="5632435">+</span><span class="num" id="5632436">1</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5632439">d</span><span class="op" id="5632440">.</span><span class="ident" id="5632441">overflow</span>&nbsp;<span class="op" id="5632450">=</span>&nbsp;<span class="builtintype" id="5632452">uint16</span><span class="op" id="5632458">(</span><span class="num" id="5632459">1</span><span class="op" id="5632460">)</span>&nbsp;<span class="op" id="5632462">&lt;&lt;</span>&nbsp;<span class="ident" id="5632465">d</span><span class="op" id="5632466">.</span><span class="ident" id="5632467">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5632474">d</span><span class="op" id="5632475">.</span><span class="ident" id="5632476">last</span>&nbsp;<span class="op" id="5632481">=</span>&nbsp;<span class="ident" id="5632483">decoderInvalidCode</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5632504">return</span>&nbsp;<span class="ident" id="5632511">d</span><br>
<span class="lineno"></span><span class="op" id="5632513">}</span>
</div>
</body>
</html>
