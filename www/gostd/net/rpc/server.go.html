<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/rpc</h2>
<ul>
<li><a href="/gostd/net/rpc/client.go.html">client.go</a></li>
<li><a href="/gostd/net/rpc/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/rpc/debug.go.html">debug.go</a></li>
<li><a href="/gostd/net/rpc/server.go.html">server.go</a></li>
<li><a href="/gostd/net/rpc/server_test.go.html">server_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5771105">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5771160">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5771214">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5771265">/*<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspPackage&nbsp;rpc&nbsp;provides&nbsp;access&nbsp;to&nbsp;the&nbsp;exported&nbsp;methods&nbsp;of&nbsp;an&nbsp;object&nbsp;across&nbsp;a<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspnetwork&nbsp;or&nbsp;other&nbsp;I/O&nbsp;connection.&nbsp;&nbsp;A&nbsp;server&nbsp;registers&nbsp;an&nbsp;object,&nbsp;making&nbsp;it&nbsp;visible<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspas&nbsp;a&nbsp;service&nbsp;with&nbsp;the&nbsp;name&nbsp;of&nbsp;the&nbsp;type&nbsp;of&nbsp;the&nbsp;object.&nbsp;&nbsp;After&nbsp;registration,&nbsp;exported<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspmethods&nbsp;of&nbsp;the&nbsp;object&nbsp;will&nbsp;be&nbsp;accessible&nbsp;remotely.&nbsp;&nbsp;A&nbsp;server&nbsp;may&nbsp;register&nbsp;multiple<br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbspobjects&nbsp;(services)&nbsp;of&nbsp;different&nbsp;types&nbsp;but&nbsp;it&nbsp;is&nbsp;an&nbsp;error&nbsp;to&nbsp;register&nbsp;multiple<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspobjects&nbsp;of&nbsp;the&nbsp;same&nbsp;type.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspOnly&nbsp;methods&nbsp;that&nbsp;satisfy&nbsp;these&nbsp;criteria&nbsp;will&nbsp;be&nbsp;made&nbsp;available&nbsp;for&nbsp;remote&nbsp;access;<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspother&nbsp;methods&nbsp;will&nbsp;be&nbsp;ignored:<br>
<span class="lineno">15</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;method&nbsp;is&nbsp;exported.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;method&nbsp;has&nbsp;two&nbsp;arguments,&nbsp;both&nbsp;exported&nbsp;(or&nbsp;builtin)&nbsp;types.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;method&#39;s&nbsp;second&nbsp;argument&nbsp;is&nbsp;a&nbsp;pointer.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;method&nbsp;has&nbsp;return&nbsp;type&nbsp;error.<br>
<span class="lineno">20</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspIn&nbsp;effect,&nbsp;the&nbsp;method&nbsp;must&nbsp;look&nbsp;schematically&nbsp;like<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;(t&nbsp;*T)&nbsp;MethodName(argType&nbsp;T1,&nbsp;replyType&nbsp;*T2)&nbsp;error<br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbspwhere&nbsp;T,&nbsp;T1&nbsp;and&nbsp;T2&nbsp;can&nbsp;be&nbsp;marshaled&nbsp;by&nbsp;encoding/gob.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspThese&nbsp;requirements&nbsp;apply&nbsp;even&nbsp;if&nbsp;a&nbsp;different&nbsp;codec&nbsp;is&nbsp;used.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp(In&nbsp;the&nbsp;future,&nbsp;these&nbsp;requirements&nbsp;may&nbsp;soften&nbsp;for&nbsp;custom&nbsp;codecs.)<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;method&#39;s&nbsp;first&nbsp;argument&nbsp;represents&nbsp;the&nbsp;arguments&nbsp;provided&nbsp;by&nbsp;the&nbsp;caller;&nbsp;the<br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbspsecond&nbsp;argument&nbsp;represents&nbsp;the&nbsp;result&nbsp;parameters&nbsp;to&nbsp;be&nbsp;returned&nbsp;to&nbsp;the&nbsp;caller.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;method&#39;s&nbsp;return&nbsp;value,&nbsp;if&nbsp;non-nil,&nbsp;is&nbsp;passed&nbsp;back&nbsp;as&nbsp;a&nbsp;string&nbsp;that&nbsp;the&nbsp;client<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspsees&nbsp;as&nbsp;if&nbsp;created&nbsp;by&nbsp;errors.New.&nbsp;&nbsp;If&nbsp;an&nbsp;error&nbsp;is&nbsp;returned,&nbsp;the&nbsp;reply&nbsp;parameter<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspwill&nbsp;not&nbsp;be&nbsp;sent&nbsp;back&nbsp;to&nbsp;the&nbsp;client.<br>
<span class="lineno"></span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;server&nbsp;may&nbsp;handle&nbsp;requests&nbsp;on&nbsp;a&nbsp;single&nbsp;connection&nbsp;by&nbsp;calling&nbsp;ServeConn.&nbsp;&nbsp;More<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsptypically&nbsp;it&nbsp;will&nbsp;create&nbsp;a&nbsp;network&nbsp;listener&nbsp;and&nbsp;call&nbsp;Accept&nbsp;or,&nbsp;for&nbsp;an&nbsp;HTTP<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsplistener,&nbsp;HandleHTTP&nbsp;and&nbsp;http.Serve.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspA&nbsp;client&nbsp;wishing&nbsp;to&nbsp;use&nbsp;the&nbsp;service&nbsp;establishes&nbsp;a&nbsp;connection&nbsp;and&nbsp;then&nbsp;invokes<br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbspNewClient&nbsp;on&nbsp;the&nbsp;connection.&nbsp;&nbsp;The&nbsp;convenience&nbsp;function&nbsp;Dial&nbsp;(DialHTTP)&nbsp;performs<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspboth&nbsp;steps&nbsp;for&nbsp;a&nbsp;raw&nbsp;network&nbsp;connection&nbsp;(an&nbsp;HTTP&nbsp;connection).&nbsp;&nbsp;The&nbsp;resulting<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspClient&nbsp;object&nbsp;has&nbsp;two&nbsp;methods,&nbsp;Call&nbsp;and&nbsp;Go,&nbsp;that&nbsp;specify&nbsp;the&nbsp;service&nbsp;and&nbsp;method&nbsp;to<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspcall,&nbsp;a&nbsp;pointer&nbsp;containing&nbsp;the&nbsp;arguments,&nbsp;and&nbsp;a&nbsp;pointer&nbsp;to&nbsp;receive&nbsp;the&nbsp;result<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspparameters.<br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;Call&nbsp;method&nbsp;waits&nbsp;for&nbsp;the&nbsp;remote&nbsp;call&nbsp;to&nbsp;complete&nbsp;while&nbsp;the&nbsp;Go&nbsp;method<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsplaunches&nbsp;the&nbsp;call&nbsp;asynchronously&nbsp;and&nbsp;signals&nbsp;completion&nbsp;using&nbsp;the&nbsp;Call<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspstructure&#39;s&nbsp;Done&nbsp;channel.<br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbspUnless&nbsp;an&nbsp;explicit&nbsp;codec&nbsp;is&nbsp;set&nbsp;up,&nbsp;package&nbsp;encoding/gob&nbsp;is&nbsp;used&nbsp;to<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsptransport&nbsp;the&nbsp;data.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspHere&nbsp;is&nbsp;a&nbsp;simple&nbsp;example.&nbsp;&nbsp;A&nbsp;server&nbsp;wishes&nbsp;to&nbsp;export&nbsp;an&nbsp;object&nbsp;of&nbsp;type&nbsp;Arith:<br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsppackage&nbsp;server<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsptype&nbsp;Args&nbsp;struct&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspA,&nbsp;B&nbsp;int<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsptype&nbsp;Quotient&nbsp;struct&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspQuo,&nbsp;Rem&nbsp;int<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsptype&nbsp;Arith&nbsp;int<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;(t&nbsp;*Arith)&nbsp;Multiply(args&nbsp;*Args,&nbsp;reply&nbsp;*int)&nbsp;error&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp*reply&nbsp;=&nbsp;args.A&nbsp;*&nbsp;args.B<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspreturn&nbsp;nil<br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;(t&nbsp;*Arith)&nbsp;Divide(args&nbsp;*Args,&nbsp;quo&nbsp;*Quotient)&nbsp;error&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;args.B&nbsp;==&nbsp;0&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspreturn&nbsp;errors.New(&#34;divide&nbsp;by&nbsp;zero&#34;)<br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspquo.Quo&nbsp;=&nbsp;args.A&nbsp;/&nbsp;args.B<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspquo.Rem&nbsp;=&nbsp;args.A&nbsp;%&nbsp;args.B<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspreturn&nbsp;nil<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;server&nbsp;calls&nbsp;(for&nbsp;HTTP&nbsp;service):<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsparith&nbsp;:=&nbsp;new(Arith)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsprpc.Register(arith)<br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsprpc.HandleHTTP()<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspl,&nbsp;e&nbsp;:=&nbsp;net.Listen(&#34;tcp&#34;,&nbsp;&#34;:1234&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;e&nbsp;!=&nbsp;nil&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(&#34;listen&nbsp;error:&#34;,&nbsp;e)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspgo&nbsp;http.Serve(l,&nbsp;nil)<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspAt&nbsp;this&nbsp;point,&nbsp;clients&nbsp;can&nbsp;see&nbsp;a&nbsp;service&nbsp;&#34;Arith&#34;&nbsp;with&nbsp;methods&nbsp;&#34;Arith.Multiply&#34;&nbsp;and<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&#34;Arith.Divide&#34;.&nbsp;&nbsp;To&nbsp;invoke&nbsp;one,&nbsp;a&nbsp;client&nbsp;first&nbsp;dials&nbsp;the&nbsp;server:<br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspclient,&nbsp;err&nbsp;:=&nbsp;rpc.DialHTTP(&#34;tcp&#34;,&nbsp;serverAddress&nbsp;+&nbsp;&#34;:1234&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(&#34;dialing:&#34;,&nbsp;err)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbspThen&nbsp;it&nbsp;can&nbsp;make&nbsp;a&nbsp;remote&nbsp;call:<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;Synchronous&nbsp;call<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspargs&nbsp;:=&nbsp;&amp;server.Args{7,8}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspvar&nbsp;reply&nbsp;int<br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsperr&nbsp;=&nbsp;client.Call(&#34;Arith.Multiply&#34;,&nbsp;args,&nbsp;&amp;reply)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(&#34;arith&nbsp;error:&#34;,&nbsp;err)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspfmt.Printf(&#34;Arith:&nbsp;%d*%d=%d&#34;,&nbsp;args.A,&nbsp;args.B,&nbsp;reply)<br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspor<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;Asynchronous&nbsp;call<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspquotient&nbsp;:=&nbsp;new(Quotient)<br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspdivCall&nbsp;:=&nbsp;client.Go(&#34;Arith.Divide&#34;,&nbsp;args,&nbsp;quotient,&nbsp;nil)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspreplyCall&nbsp;:=&nbsp;&lt;-divCall.Done&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;will&nbsp;be&nbsp;equal&nbsp;to&nbsp;divCall<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;check&nbsp;errors,&nbsp;print,&nbsp;etc.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspA&nbsp;server&nbsp;implementation&nbsp;will&nbsp;often&nbsp;provide&nbsp;a&nbsp;simple,&nbsp;type-safe&nbsp;wrapper&nbsp;for&nbsp;the<br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbspclient.<br>
<span class="lineno"></span>*/</span><br>
<span class="lineno"></span><span class="keyword" id="5775094">package</span>&nbsp;<span class="ident" id="5775102">rpc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5775107">import</span>&nbsp;<span class="op" id="5775114">(</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5775117">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5775126">&#34;encoding/gob&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5775142">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5775152">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5775158">&#34;log&#34;</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5775165">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5775172">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5775184">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5775195">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5775206">&#34;sync&#34;</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5775214">&#34;unicode&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5775225">&#34;unicode/utf8&#34;</span><br>
<span class="lineno"></span><span class="op" id="5775240">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5775243">const</span>&nbsp;<span class="op" id="5775249">(</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5775252">//&nbsp;Defaults&nbsp;used&nbsp;by&nbsp;HandleHTTP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5775284">DefaultRPCPath</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5775301">=</span>&nbsp;<span class="string" id="5775303">&#34;/_goRPC_&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5775315">DefaultDebugPath</span>&nbsp;<span class="op" id="5775332">=</span>&nbsp;<span class="string" id="5775334">&#34;/debug/rpc&#34;</span><br>
<span class="lineno"></span><span class="op" id="5775347">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="comment" id="5775350">//&nbsp;Precompute&nbsp;the&nbsp;reflect&nbsp;type&nbsp;for&nbsp;error.&nbsp;&nbsp;Can&#39;t&nbsp;use&nbsp;error&nbsp;directly</span><br>
<span class="lineno"></span><span class="comment" id="5775418">//&nbsp;because&nbsp;Typeof&nbsp;takes&nbsp;an&nbsp;empty&nbsp;interface&nbsp;value.&nbsp;&nbsp;This&nbsp;is&nbsp;annoying.</span><br>
<span class="lineno"></span><span class="keyword" id="5775487">var</span>&nbsp;<span class="ident" id="5775491">typeOfError</span>&nbsp;<span class="op" id="5775503">=</span>&nbsp;<span class="ident" id="5775505">reflect</span><span class="op" id="5775512">.</span><span class="ident" id="5775513">TypeOf</span><span class="op" id="5775519">(</span><span class="op" id="5775520">(</span><span class="op" id="5775521">*</span><span class="builtintype" id="5775522">error</span><span class="op" id="5775527">)</span><span class="op" id="5775528">(</span><span class="ident" id="5775529">nil</span><span class="op" id="5775532">)</span><span class="op" id="5775533">)</span><span class="op" id="5775534">.</span><span class="ident" id="5775535">Elem</span><span class="op" id="5775539">(</span><span class="op" id="5775540">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5775543">type</span>&nbsp;<span class="ident" id="5775548">methodType</span>&nbsp;<span class="keyword" id="5775559">struct</span>&nbsp;<span class="op" id="5775566">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5775569">sync</span><span class="op" id="5775573">.</span><span class="ident" id="5775574">Mutex</span>&nbsp;<span class="comment" id="5775580">//&nbsp;protects&nbsp;counters</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5775602">method</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5775613">reflect</span><span class="op" id="5775620">.</span><span class="ident" id="5775621">Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5775629">ArgType</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5775640">reflect</span><span class="op" id="5775647">.</span><span class="ident" id="5775648">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5775654">ReplyType</span>&nbsp;&nbsp;<span class="ident" id="5775665">reflect</span><span class="op" id="5775672">.</span><span class="ident" id="5775673">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5775679">numCalls</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5775690">uint</span><br>
<span class="lineno">155</span><span class="op" id="5775695">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5775698">type</span>&nbsp;<span class="ident" id="5775703">service</span>&nbsp;<span class="keyword" id="5775711">struct</span>&nbsp;<span class="op" id="5775718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5775721">name</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5775728">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5775751">//&nbsp;name&nbsp;of&nbsp;service</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5775771">rcvr</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5775778">reflect</span><span class="op" id="5775785">.</span><span class="ident" id="5775786">Value</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5775801">//&nbsp;receiver&nbsp;of&nbsp;methods&nbsp;for&nbsp;the&nbsp;service</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5775841">typ</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5775848">reflect</span><span class="op" id="5775855">.</span><span class="ident" id="5775856">Type</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5775871">//&nbsp;type&nbsp;of&nbsp;the&nbsp;receiver</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5775896">method</span>&nbsp;<span class="keyword" id="5775903">map</span><span class="op" id="5775906">[</span><span class="builtintype" id="5775907">string</span><span class="op" id="5775913">]</span><span class="op" id="5775914">*</span><span class="ident" id="5775915">methodType</span>&nbsp;<span class="comment" id="5775926">//&nbsp;registered&nbsp;methods</span><br>
<span class="lineno"></span><span class="op" id="5775948">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5775951">//&nbsp;Request&nbsp;is&nbsp;a&nbsp;header&nbsp;written&nbsp;before&nbsp;every&nbsp;RPC&nbsp;call.&nbsp;&nbsp;It&nbsp;is&nbsp;used&nbsp;internally</span><br>
<span class="lineno">165</span><span class="comment" id="5776028">//&nbsp;but&nbsp;documented&nbsp;here&nbsp;as&nbsp;an&nbsp;aid&nbsp;to&nbsp;debugging,&nbsp;such&nbsp;as&nbsp;when&nbsp;analyzing</span><br>
<span class="lineno"></span><span class="comment" id="5776098">//&nbsp;network&nbsp;traffic.</span><br>
<span class="lineno"></span><span class="keyword" id="5776118">type</span>&nbsp;<span class="ident" id="5776123">Request</span>&nbsp;<span class="keyword" id="5776131">struct</span>&nbsp;<span class="op" id="5776138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5776141">ServiceMethod</span>&nbsp;<span class="builtintype" id="5776155">string</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5776164">//&nbsp;format:&nbsp;&#34;Service.Method&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5776193">Seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5776207">uint64</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5776216">//&nbsp;sequence&nbsp;number&nbsp;chosen&nbsp;by&nbsp;client</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5776253">next</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5776267">*</span><span class="ident" id="5776268">Request</span>&nbsp;<span class="comment" id="5776276">//&nbsp;for&nbsp;free&nbsp;list&nbsp;in&nbsp;Server</span><br>
<span class="lineno"></span><span class="op" id="5776303">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5776306">//&nbsp;Response&nbsp;is&nbsp;a&nbsp;header&nbsp;written&nbsp;before&nbsp;every&nbsp;RPC&nbsp;return.&nbsp;&nbsp;It&nbsp;is&nbsp;used&nbsp;internally</span><br>
<span class="lineno"></span><span class="comment" id="5776386">//&nbsp;but&nbsp;documented&nbsp;here&nbsp;as&nbsp;an&nbsp;aid&nbsp;to&nbsp;debugging,&nbsp;such&nbsp;as&nbsp;when&nbsp;analyzing</span><br>
<span class="lineno">175</span><span class="comment" id="5776456">//&nbsp;network&nbsp;traffic.</span><br>
<span class="lineno"></span><span class="keyword" id="5776476">type</span>&nbsp;<span class="ident" id="5776481">Response</span>&nbsp;<span class="keyword" id="5776490">struct</span>&nbsp;<span class="op" id="5776497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5776500">ServiceMethod</span>&nbsp;<span class="builtintype" id="5776514">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5776524">//&nbsp;echoes&nbsp;that&nbsp;of&nbsp;the&nbsp;Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5776555">Seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5776569">uint64</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5776579">//&nbsp;echoes&nbsp;that&nbsp;of&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5776610">Error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5776624">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5776634">//&nbsp;error,&nbsp;if&nbsp;any.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5776653">next</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5776667">*</span><span class="ident" id="5776668">Response</span>&nbsp;<span class="comment" id="5776677">//&nbsp;for&nbsp;free&nbsp;list&nbsp;in&nbsp;Server</span><br>
<span class="lineno"></span><span class="op" id="5776704">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5776707">//&nbsp;Server&nbsp;represents&nbsp;an&nbsp;RPC&nbsp;Server.</span><br>
<span class="lineno"></span><span class="keyword" id="5776743">type</span>&nbsp;<span class="ident" id="5776748">Server</span>&nbsp;<span class="keyword" id="5776755">struct</span>&nbsp;<span class="op" id="5776762">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5776765">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5776776">sync</span><span class="op" id="5776780">.</span><span class="ident" id="5776781">RWMutex</span>&nbsp;<span class="comment" id="5776789">//&nbsp;protects&nbsp;the&nbsp;serviceMap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5776817">serviceMap</span>&nbsp;<span class="keyword" id="5776828">map</span><span class="op" id="5776831">[</span><span class="builtintype" id="5776832">string</span><span class="op" id="5776838">]</span><span class="op" id="5776839">*</span><span class="ident" id="5776840">service</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5776849">reqLock</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5776860">sync</span><span class="op" id="5776864">.</span><span class="ident" id="5776865">Mutex</span>&nbsp;<span class="comment" id="5776871">//&nbsp;protects&nbsp;freeReq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5776892">freeReq</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5776903">*</span><span class="ident" id="5776904">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5776913">respLock</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5776924">sync</span><span class="op" id="5776928">.</span><span class="ident" id="5776929">Mutex</span>&nbsp;<span class="comment" id="5776935">//&nbsp;protects&nbsp;freeResp</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5776957">freeResp</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5776968">*</span><span class="ident" id="5776969">Response</span><br>
<span class="lineno"></span><span class="op" id="5776978">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5776981">//&nbsp;NewServer&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server.</span><br>
<span class="lineno"></span><span class="keyword" id="5777016">func</span>&nbsp;<span class="ident" id="5777021">NewServer</span><span class="op" id="5777030">(</span><span class="op" id="5777031">)</span>&nbsp;<span class="op" id="5777033">*</span><span class="ident" id="5777034">Server</span>&nbsp;<span class="op" id="5777041">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5777044">return</span>&nbsp;<span class="op" id="5777051">&amp;</span><span class="ident" id="5777052">Server</span><span class="op" id="5777058">{</span><span class="ident" id="5777059">serviceMap</span><span class="op" id="5777069">:</span>&nbsp;<span class="builtinfunc" id="5777071">make</span><span class="op" id="5777075">(</span><span class="keyword" id="5777076">map</span><span class="op" id="5777079">[</span><span class="builtintype" id="5777080">string</span><span class="op" id="5777086">]</span><span class="op" id="5777087">*</span><span class="ident" id="5777088">service</span><span class="op" id="5777095">)</span><span class="op" id="5777096">}</span><br>
<span class="lineno"></span><span class="op" id="5777098">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5777101">//&nbsp;DefaultServer&nbsp;is&nbsp;the&nbsp;default&nbsp;instance&nbsp;of&nbsp;*Server.</span><br>
<span class="lineno"></span><span class="keyword" id="5777154">var</span>&nbsp;<span class="ident" id="5777158">DefaultServer</span>&nbsp;<span class="op" id="5777172">=</span>&nbsp;<span class="ident" id="5777174">NewServer</span><span class="op" id="5777183">(</span><span class="op" id="5777184">)</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="comment" id="5777187">//&nbsp;Is&nbsp;this&nbsp;an&nbsp;exported&nbsp;-&nbsp;upper&nbsp;case&nbsp;-&nbsp;name?</span><br>
<span class="lineno"></span><span class="keyword" id="5777231">func</span>&nbsp;<span class="ident" id="5777236">isExported</span><span class="op" id="5777246">(</span><span class="ident" id="5777247">name</span>&nbsp;<span class="builtintype" id="5777252">string</span><span class="op" id="5777258">)</span>&nbsp;<span class="builtintype" id="5777260">bool</span>&nbsp;<span class="op" id="5777265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="5777268">rune</span><span class="op" id="5777272">,</span>&nbsp;<span class="ident" id="5777274">_</span>&nbsp;<span class="op" id="5777276">:=</span>&nbsp;<span class="ident" id="5777279">utf8</span><span class="op" id="5777283">.</span><span class="ident" id="5777284">DecodeRuneInString</span><span class="op" id="5777302">(</span><span class="ident" id="5777303">name</span><span class="op" id="5777307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5777310">return</span>&nbsp;<span class="ident" id="5777317">unicode</span><span class="op" id="5777324">.</span><span class="ident" id="5777325">IsUpper</span><span class="op" id="5777332">(</span><span class="builtintype" id="5777333">rune</span><span class="op" id="5777337">)</span><br>
<span class="lineno">205</span><span class="op" id="5777339">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5777342">//&nbsp;Is&nbsp;this&nbsp;type&nbsp;exported&nbsp;or&nbsp;a&nbsp;builtin?</span><br>
<span class="lineno"></span><span class="keyword" id="5777381">func</span>&nbsp;<span class="ident" id="5777386">isExportedOrBuiltinType</span><span class="op" id="5777409">(</span><span class="ident" id="5777410">t</span>&nbsp;<span class="ident" id="5777412">reflect</span><span class="op" id="5777419">.</span><span class="ident" id="5777420">Type</span><span class="op" id="5777424">)</span>&nbsp;<span class="builtintype" id="5777426">bool</span>&nbsp;<span class="op" id="5777431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5777434">for</span>&nbsp;<span class="ident" id="5777438">t</span><span class="op" id="5777439">.</span><span class="ident" id="5777440">Kind</span><span class="op" id="5777444">(</span><span class="op" id="5777445">)</span>&nbsp;<span class="op" id="5777447">==</span>&nbsp;<span class="ident" id="5777450">reflect</span><span class="op" id="5777457">.</span><span class="ident" id="5777458">Ptr</span>&nbsp;<span class="op" id="5777462">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5777466">t</span>&nbsp;<span class="op" id="5777468">=</span>&nbsp;<span class="ident" id="5777470">t</span><span class="op" id="5777471">.</span><span class="ident" id="5777472">Elem</span><span class="op" id="5777476">(</span><span class="op" id="5777477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5777480">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5777483">//&nbsp;PkgPath&nbsp;will&nbsp;be&nbsp;non-empty&nbsp;even&nbsp;for&nbsp;an&nbsp;exported&nbsp;type,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5777540">//&nbsp;so&nbsp;we&nbsp;need&nbsp;to&nbsp;check&nbsp;the&nbsp;type&nbsp;name&nbsp;as&nbsp;well.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5777587">return</span>&nbsp;<span class="ident" id="5777594">isExported</span><span class="op" id="5777604">(</span><span class="ident" id="5777605">t</span><span class="op" id="5777606">.</span><span class="ident" id="5777607">Name</span><span class="op" id="5777611">(</span><span class="op" id="5777612">)</span><span class="op" id="5777613">)</span>&nbsp;<span class="op" id="5777615">||</span>&nbsp;<span class="ident" id="5777618">t</span><span class="op" id="5777619">.</span><span class="ident" id="5777620">PkgPath</span><span class="op" id="5777627">(</span><span class="op" id="5777628">)</span>&nbsp;<span class="op" id="5777630">==</span>&nbsp;<span class="string" id="5777633">&#34;&#34;</span><br>
<span class="lineno">215</span><span class="op" id="5777636">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5777639">//&nbsp;Register&nbsp;publishes&nbsp;in&nbsp;the&nbsp;server&nbsp;the&nbsp;set&nbsp;of&nbsp;methods&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5777701">//&nbsp;receiver&nbsp;value&nbsp;that&nbsp;satisfy&nbsp;the&nbsp;following&nbsp;conditions:</span><br>
<span class="lineno"></span><span class="comment" id="5777758">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;exported&nbsp;method</span><br>
<span class="lineno">220</span><span class="comment" id="5777779">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;two&nbsp;arguments,&nbsp;both&nbsp;of&nbsp;exported&nbsp;type</span><br>
<span class="lineno"></span><span class="comment" id="5777821">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;second&nbsp;argument&nbsp;is&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span><span class="comment" id="5777859">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;one&nbsp;return&nbsp;value,&nbsp;of&nbsp;type&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="5777896">//&nbsp;It&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;receiver&nbsp;is&nbsp;not&nbsp;an&nbsp;exported&nbsp;type&nbsp;or&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="5777966">//&nbsp;no&nbsp;suitable&nbsp;methods.&nbsp;It&nbsp;also&nbsp;logs&nbsp;the&nbsp;error&nbsp;using&nbsp;package&nbsp;log.</span><br>
<span class="lineno">225</span><span class="comment" id="5778032">//&nbsp;The&nbsp;client&nbsp;accesses&nbsp;each&nbsp;method&nbsp;using&nbsp;a&nbsp;string&nbsp;of&nbsp;the&nbsp;form&nbsp;&#34;Type.Method&#34;,</span><br>
<span class="lineno"></span><span class="comment" id="5778109">//&nbsp;where&nbsp;Type&nbsp;is&nbsp;the&nbsp;receiver&#39;s&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="5778156">func</span>&nbsp;<span class="op" id="5778161">(</span><span class="ident" id="5778162">server</span>&nbsp;<span class="op" id="5778169">*</span><span class="ident" id="5778170">Server</span><span class="op" id="5778176">)</span>&nbsp;<span class="ident" id="5778178">Register</span><span class="op" id="5778186">(</span><span class="ident" id="5778187">rcvr</span>&nbsp;<span class="keyword" id="5778192">interface</span><span class="op" id="5778201">{</span><span class="op" id="5778202">}</span><span class="op" id="5778203">)</span>&nbsp;<span class="builtintype" id="5778205">error</span>&nbsp;<span class="op" id="5778211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5778214">return</span>&nbsp;<span class="ident" id="5778221">server</span><span class="op" id="5778227">.</span><span class="ident" id="5778228">register</span><span class="op" id="5778236">(</span><span class="ident" id="5778237">rcvr</span><span class="op" id="5778241">,</span>&nbsp;<span class="string" id="5778243">&#34;&#34;</span><span class="op" id="5778245">,</span>&nbsp;<span class="builtintype" id="5778247">false</span><span class="op" id="5778252">)</span><br>
<span class="lineno"></span><span class="op" id="5778254">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment" id="5778257">//&nbsp;RegisterName&nbsp;is&nbsp;like&nbsp;Register&nbsp;but&nbsp;uses&nbsp;the&nbsp;provided&nbsp;name&nbsp;for&nbsp;the&nbsp;type</span><br>
<span class="lineno"></span><span class="comment" id="5778330">//&nbsp;instead&nbsp;of&nbsp;the&nbsp;receiver&#39;s&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="5778374">func</span>&nbsp;<span class="op" id="5778379">(</span><span class="ident" id="5778380">server</span>&nbsp;<span class="op" id="5778387">*</span><span class="ident" id="5778388">Server</span><span class="op" id="5778394">)</span>&nbsp;<span class="ident" id="5778396">RegisterName</span><span class="op" id="5778408">(</span><span class="ident" id="5778409">name</span>&nbsp;<span class="builtintype" id="5778414">string</span><span class="op" id="5778420">,</span>&nbsp;<span class="ident" id="5778422">rcvr</span>&nbsp;<span class="keyword" id="5778427">interface</span><span class="op" id="5778436">{</span><span class="op" id="5778437">}</span><span class="op" id="5778438">)</span>&nbsp;<span class="builtintype" id="5778440">error</span>&nbsp;<span class="op" id="5778446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5778449">return</span>&nbsp;<span class="ident" id="5778456">server</span><span class="op" id="5778462">.</span><span class="ident" id="5778463">register</span><span class="op" id="5778471">(</span><span class="ident" id="5778472">rcvr</span><span class="op" id="5778476">,</span>&nbsp;<span class="ident" id="5778478">name</span><span class="op" id="5778482">,</span>&nbsp;<span class="builtintype" id="5778484">true</span><span class="op" id="5778488">)</span><br>
<span class="lineno">235</span><span class="op" id="5778490">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5778493">func</span>&nbsp;<span class="op" id="5778498">(</span><span class="ident" id="5778499">server</span>&nbsp;<span class="op" id="5778506">*</span><span class="ident" id="5778507">Server</span><span class="op" id="5778513">)</span>&nbsp;<span class="ident" id="5778515">register</span><span class="op" id="5778523">(</span><span class="ident" id="5778524">rcvr</span>&nbsp;<span class="keyword" id="5778529">interface</span><span class="op" id="5778538">{</span><span class="op" id="5778539">}</span><span class="op" id="5778540">,</span>&nbsp;<span class="ident" id="5778542">name</span>&nbsp;<span class="builtintype" id="5778547">string</span><span class="op" id="5778553">,</span>&nbsp;<span class="ident" id="5778555">useName</span>&nbsp;<span class="builtintype" id="5778563">bool</span><span class="op" id="5778567">)</span>&nbsp;<span class="builtintype" id="5778569">error</span>&nbsp;<span class="op" id="5778575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5778578">server</span><span class="op" id="5778584">.</span><span class="ident" id="5778585">mu</span><span class="op" id="5778587">.</span><span class="ident" id="5778588">Lock</span><span class="op" id="5778592">(</span><span class="op" id="5778593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5778596">defer</span>&nbsp;<span class="ident" id="5778602">server</span><span class="op" id="5778608">.</span><span class="ident" id="5778609">mu</span><span class="op" id="5778611">.</span><span class="ident" id="5778612">Unlock</span><span class="op" id="5778618">(</span><span class="op" id="5778619">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5778622">if</span>&nbsp;<span class="ident" id="5778625">server</span><span class="op" id="5778631">.</span><span class="ident" id="5778632">serviceMap</span>&nbsp;<span class="op" id="5778643">==</span>&nbsp;<span class="ident" id="5778646">nil</span>&nbsp;<span class="op" id="5778650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5778654">server</span><span class="op" id="5778660">.</span><span class="ident" id="5778661">serviceMap</span>&nbsp;<span class="op" id="5778672">=</span>&nbsp;<span class="builtinfunc" id="5778674">make</span><span class="op" id="5778678">(</span><span class="keyword" id="5778679">map</span><span class="op" id="5778682">[</span><span class="builtintype" id="5778683">string</span><span class="op" id="5778689">]</span><span class="op" id="5778690">*</span><span class="ident" id="5778691">service</span><span class="op" id="5778698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5778701">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5778704">s</span>&nbsp;<span class="op" id="5778706">:=</span>&nbsp;<span class="builtinfunc" id="5778709">new</span><span class="op" id="5778712">(</span><span class="ident" id="5778713">service</span><span class="op" id="5778720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5778723">s</span><span class="op" id="5778724">.</span><span class="ident" id="5778725">typ</span>&nbsp;<span class="op" id="5778729">=</span>&nbsp;<span class="ident" id="5778731">reflect</span><span class="op" id="5778738">.</span><span class="ident" id="5778739">TypeOf</span><span class="op" id="5778745">(</span><span class="ident" id="5778746">rcvr</span><span class="op" id="5778750">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5778753">s</span><span class="op" id="5778754">.</span><span class="ident" id="5778755">rcvr</span>&nbsp;<span class="op" id="5778760">=</span>&nbsp;<span class="ident" id="5778762">reflect</span><span class="op" id="5778769">.</span><span class="ident" id="5778770">ValueOf</span><span class="op" id="5778777">(</span><span class="ident" id="5778778">rcvr</span><span class="op" id="5778782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5778785">sname</span>&nbsp;<span class="op" id="5778791">:=</span>&nbsp;<span class="ident" id="5778794">reflect</span><span class="op" id="5778801">.</span><span class="ident" id="5778802">Indirect</span><span class="op" id="5778810">(</span><span class="ident" id="5778811">s</span><span class="op" id="5778812">.</span><span class="ident" id="5778813">rcvr</span><span class="op" id="5778817">)</span><span class="op" id="5778818">.</span><span class="ident" id="5778819">Type</span><span class="op" id="5778823">(</span><span class="op" id="5778824">)</span><span class="op" id="5778825">.</span><span class="ident" id="5778826">Name</span><span class="op" id="5778830">(</span><span class="op" id="5778831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5778834">if</span>&nbsp;<span class="ident" id="5778837">useName</span>&nbsp;<span class="op" id="5778845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5778849">sname</span>&nbsp;<span class="op" id="5778855">=</span>&nbsp;<span class="ident" id="5778857">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5778863">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5778866">if</span>&nbsp;<span class="ident" id="5778869">sname</span>&nbsp;<span class="op" id="5778875">==</span>&nbsp;<span class="string" id="5778878">&#34;&#34;</span>&nbsp;<span class="op" id="5778881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5778885">s</span>&nbsp;<span class="op" id="5778887">:=</span>&nbsp;<span class="string" id="5778890">&#34;rpc.Register:&nbsp;no&nbsp;service&nbsp;name&nbsp;for&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5778932">+</span>&nbsp;<span class="ident" id="5778934">s</span><span class="op" id="5778935">.</span><span class="ident" id="5778936">typ</span><span class="op" id="5778939">.</span><span class="ident" id="5778940">String</span><span class="op" id="5778946">(</span><span class="op" id="5778947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5778951">log</span><span class="op" id="5778954">.</span><span class="ident" id="5778955">Print</span><span class="op" id="5778960">(</span><span class="ident" id="5778961">s</span><span class="op" id="5778962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5778966">return</span>&nbsp;<span class="ident" id="5778973">errors</span><span class="op" id="5778979">.</span><span class="ident" id="5778980">New</span><span class="op" id="5778983">(</span><span class="ident" id="5778984">s</span><span class="op" id="5778985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5778988">}</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5778991">if</span>&nbsp;<span class="op" id="5778994">!</span><span class="ident" id="5778995">isExported</span><span class="op" id="5779005">(</span><span class="ident" id="5779006">sname</span><span class="op" id="5779011">)</span>&nbsp;<span class="op" id="5779013">&amp;&amp;</span>&nbsp;<span class="op" id="5779016">!</span><span class="ident" id="5779017">useName</span>&nbsp;<span class="op" id="5779025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5779029">s</span>&nbsp;<span class="op" id="5779031">:=</span>&nbsp;<span class="string" id="5779034">&#34;rpc.Register:&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5779056">+</span>&nbsp;<span class="ident" id="5779058">sname</span>&nbsp;<span class="op" id="5779064">+</span>&nbsp;<span class="string" id="5779066">&#34;&nbsp;is&nbsp;not&nbsp;exported&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5779087">log</span><span class="op" id="5779090">.</span><span class="ident" id="5779091">Print</span><span class="op" id="5779096">(</span><span class="ident" id="5779097">s</span><span class="op" id="5779098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5779102">return</span>&nbsp;<span class="ident" id="5779109">errors</span><span class="op" id="5779115">.</span><span class="ident" id="5779116">New</span><span class="op" id="5779119">(</span><span class="ident" id="5779120">s</span><span class="op" id="5779121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5779124">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5779127">if</span>&nbsp;<span class="ident" id="5779130">_</span><span class="op" id="5779131">,</span>&nbsp;<span class="ident" id="5779133">present</span>&nbsp;<span class="op" id="5779141">:=</span>&nbsp;<span class="ident" id="5779144">server</span><span class="op" id="5779150">.</span><span class="ident" id="5779151">serviceMap</span><span class="op" id="5779161">[</span><span class="ident" id="5779162">sname</span><span class="op" id="5779167">]</span><span class="op" id="5779168">;</span>&nbsp;<span class="ident" id="5779170">present</span>&nbsp;<span class="op" id="5779178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5779182">return</span>&nbsp;<span class="ident" id="5779189">errors</span><span class="op" id="5779195">.</span><span class="ident" id="5779196">New</span><span class="op" id="5779199">(</span><span class="string" id="5779200">&#34;rpc:&nbsp;service&nbsp;already&nbsp;defined:&nbsp;&#34;</span>&nbsp;<span class="op" id="5779233">+</span>&nbsp;<span class="ident" id="5779235">sname</span><span class="op" id="5779240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5779243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5779246">s</span><span class="op" id="5779247">.</span><span class="ident" id="5779248">name</span>&nbsp;<span class="op" id="5779253">=</span>&nbsp;<span class="ident" id="5779255">sname</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5779263">//&nbsp;Install&nbsp;the&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5779287">s</span><span class="op" id="5779288">.</span><span class="ident" id="5779289">method</span>&nbsp;<span class="op" id="5779296">=</span>&nbsp;<span class="ident" id="5779298">suitableMethods</span><span class="op" id="5779313">(</span><span class="ident" id="5779314">s</span><span class="op" id="5779315">.</span><span class="ident" id="5779316">typ</span><span class="op" id="5779319">,</span>&nbsp;<span class="builtintype" id="5779321">true</span><span class="op" id="5779325">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5779329">if</span>&nbsp;<span class="builtinfunc" id="5779332">len</span><span class="op" id="5779335">(</span><span class="ident" id="5779336">s</span><span class="op" id="5779337">.</span><span class="ident" id="5779338">method</span><span class="op" id="5779344">)</span>&nbsp;<span class="op" id="5779346">==</span>&nbsp;<span class="num" id="5779349">0</span>&nbsp;<span class="op" id="5779351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5779355">str</span>&nbsp;<span class="op" id="5779359">:=</span>&nbsp;<span class="string" id="5779362">&#34;&#34;</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5779368">//&nbsp;To&nbsp;help&nbsp;the&nbsp;user,&nbsp;see&nbsp;if&nbsp;a&nbsp;pointer&nbsp;receiver&nbsp;would&nbsp;work.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5779429">method</span>&nbsp;<span class="op" id="5779436">:=</span>&nbsp;<span class="ident" id="5779439">suitableMethods</span><span class="op" id="5779454">(</span><span class="ident" id="5779455">reflect</span><span class="op" id="5779462">.</span><span class="ident" id="5779463">PtrTo</span><span class="op" id="5779468">(</span><span class="ident" id="5779469">s</span><span class="op" id="5779470">.</span><span class="ident" id="5779471">typ</span><span class="op" id="5779474">)</span><span class="op" id="5779475">,</span>&nbsp;<span class="builtintype" id="5779477">false</span><span class="op" id="5779482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5779486">if</span>&nbsp;<span class="builtinfunc" id="5779489">len</span><span class="op" id="5779492">(</span><span class="ident" id="5779493">method</span><span class="op" id="5779499">)</span>&nbsp;<span class="op" id="5779501">!=</span>&nbsp;<span class="num" id="5779504">0</span>&nbsp;<span class="op" id="5779506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5779511">str</span>&nbsp;<span class="op" id="5779515">=</span>&nbsp;<span class="string" id="5779517">&#34;rpc.Register:&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5779539">+</span>&nbsp;<span class="ident" id="5779541">sname</span>&nbsp;<span class="op" id="5779547">+</span>&nbsp;<span class="string" id="5779549">&#34;&nbsp;has&nbsp;no&nbsp;exported&nbsp;methods&nbsp;of&nbsp;suitable&nbsp;type&nbsp;(hint:&nbsp;pass&nbsp;a&nbsp;pointer&nbsp;to&nbsp;value&nbsp;of&nbsp;that&nbsp;type)&#34;</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5779640">}</span>&nbsp;<span class="keyword" id="5779642">else</span>&nbsp;<span class="op" id="5779647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5779652">str</span>&nbsp;<span class="op" id="5779656">=</span>&nbsp;<span class="string" id="5779658">&#34;rpc.Register:&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5779680">+</span>&nbsp;<span class="ident" id="5779682">sname</span>&nbsp;<span class="op" id="5779688">+</span>&nbsp;<span class="string" id="5779690">&#34;&nbsp;has&nbsp;no&nbsp;exported&nbsp;methods&nbsp;of&nbsp;suitable&nbsp;type&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5779736">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5779740">log</span><span class="op" id="5779743">.</span><span class="ident" id="5779744">Print</span><span class="op" id="5779749">(</span><span class="ident" id="5779750">str</span><span class="op" id="5779753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5779757">return</span>&nbsp;<span class="ident" id="5779764">errors</span><span class="op" id="5779770">.</span><span class="ident" id="5779771">New</span><span class="op" id="5779774">(</span><span class="ident" id="5779775">str</span><span class="op" id="5779778">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5779781">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5779784">server</span><span class="op" id="5779790">.</span><span class="ident" id="5779791">serviceMap</span><span class="op" id="5779801">[</span><span class="ident" id="5779802">s</span><span class="op" id="5779803">.</span><span class="ident" id="5779804">name</span><span class="op" id="5779808">]</span>&nbsp;<span class="op" id="5779810">=</span>&nbsp;<span class="ident" id="5779812">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5779815">return</span>&nbsp;<span class="ident" id="5779822">nil</span><br>
<span class="lineno"></span><span class="op" id="5779826">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="comment" id="5779829">//&nbsp;suitableMethods&nbsp;returns&nbsp;suitable&nbsp;Rpc&nbsp;methods&nbsp;of&nbsp;typ,&nbsp;it&nbsp;will&nbsp;report</span><br>
<span class="lineno"></span><span class="comment" id="5779900">//&nbsp;error&nbsp;using&nbsp;log&nbsp;if&nbsp;reportErr&nbsp;is&nbsp;true.</span><br>
<span class="lineno"></span><span class="keyword" id="5779941">func</span>&nbsp;<span class="ident" id="5779946">suitableMethods</span><span class="op" id="5779961">(</span><span class="ident" id="5779962">typ</span>&nbsp;<span class="ident" id="5779966">reflect</span><span class="op" id="5779973">.</span><span class="ident" id="5779974">Type</span><span class="op" id="5779978">,</span>&nbsp;<span class="ident" id="5779980">reportErr</span>&nbsp;<span class="builtintype" id="5779990">bool</span><span class="op" id="5779994">)</span>&nbsp;<span class="keyword" id="5779996">map</span><span class="op" id="5779999">[</span><span class="builtintype" id="5780000">string</span><span class="op" id="5780006">]</span><span class="op" id="5780007">*</span><span class="ident" id="5780008">methodType</span>&nbsp;<span class="op" id="5780019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5780022">methods</span>&nbsp;<span class="op" id="5780030">:=</span>&nbsp;<span class="builtinfunc" id="5780033">make</span><span class="op" id="5780037">(</span><span class="keyword" id="5780038">map</span><span class="op" id="5780041">[</span><span class="builtintype" id="5780042">string</span><span class="op" id="5780048">]</span><span class="op" id="5780049">*</span><span class="ident" id="5780050">methodType</span><span class="op" id="5780060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5780063">for</span>&nbsp;<span class="ident" id="5780067">m</span>&nbsp;<span class="op" id="5780069">:=</span>&nbsp;<span class="num" id="5780072">0</span><span class="op" id="5780073">;</span>&nbsp;<span class="ident" id="5780075">m</span>&nbsp;<span class="op" id="5780077">&lt;</span>&nbsp;<span class="ident" id="5780079">typ</span><span class="op" id="5780082">.</span><span class="ident" id="5780083">NumMethod</span><span class="op" id="5780092">(</span><span class="op" id="5780093">)</span><span class="op" id="5780094">;</span>&nbsp;<span class="ident" id="5780096">m</span><span class="op" id="5780097">++</span>&nbsp;<span class="op" id="5780100">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5780104">method</span>&nbsp;<span class="op" id="5780111">:=</span>&nbsp;<span class="ident" id="5780114">typ</span><span class="op" id="5780117">.</span><span class="ident" id="5780118">Method</span><span class="op" id="5780124">(</span><span class="ident" id="5780125">m</span><span class="op" id="5780126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5780130">mtype</span>&nbsp;<span class="op" id="5780136">:=</span>&nbsp;<span class="ident" id="5780139">method</span><span class="op" id="5780145">.</span><span class="ident" id="5780146">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5780153">mname</span>&nbsp;<span class="op" id="5780159">:=</span>&nbsp;<span class="ident" id="5780162">method</span><span class="op" id="5780168">.</span><span class="ident" id="5780169">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5780176">//&nbsp;Method&nbsp;must&nbsp;be&nbsp;exported.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5780206">if</span>&nbsp;<span class="ident" id="5780209">method</span><span class="op" id="5780215">.</span><span class="ident" id="5780216">PkgPath</span>&nbsp;<span class="op" id="5780224">!=</span>&nbsp;<span class="string" id="5780227">&#34;&#34;</span>&nbsp;<span class="op" id="5780230">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5780235">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5780246">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5780250">//&nbsp;Method&nbsp;needs&nbsp;three&nbsp;ins:&nbsp;receiver,&nbsp;*args,&nbsp;*reply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5780304">if</span>&nbsp;<span class="ident" id="5780307">mtype</span><span class="op" id="5780312">.</span><span class="ident" id="5780313">NumIn</span><span class="op" id="5780318">(</span><span class="op" id="5780319">)</span>&nbsp;<span class="op" id="5780321">!=</span>&nbsp;<span class="num" id="5780324">3</span>&nbsp;<span class="op" id="5780326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5780331">if</span>&nbsp;<span class="ident" id="5780334">reportErr</span>&nbsp;<span class="op" id="5780344">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5780350">log</span><span class="op" id="5780353">.</span><span class="ident" id="5780354">Println</span><span class="op" id="5780361">(</span><span class="string" id="5780362">&#34;method&#34;</span><span class="op" id="5780370">,</span>&nbsp;<span class="ident" id="5780372">mname</span><span class="op" id="5780377">,</span>&nbsp;<span class="string" id="5780379">&#34;has&nbsp;wrong&nbsp;number&nbsp;of&nbsp;ins:&#34;</span><span class="op" id="5780405">,</span>&nbsp;<span class="ident" id="5780407">mtype</span><span class="op" id="5780412">.</span><span class="ident" id="5780413">NumIn</span><span class="op" id="5780418">(</span><span class="op" id="5780419">)</span><span class="op" id="5780420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5780425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5780430">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5780441">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5780445">//&nbsp;First&nbsp;arg&nbsp;need&nbsp;not&nbsp;be&nbsp;a&nbsp;pointer.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5780483">argType</span>&nbsp;<span class="op" id="5780491">:=</span>&nbsp;<span class="ident" id="5780494">mtype</span><span class="op" id="5780499">.</span><span class="ident" id="5780500">In</span><span class="op" id="5780502">(</span><span class="num" id="5780503">1</span><span class="op" id="5780504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5780508">if</span>&nbsp;<span class="op" id="5780511">!</span><span class="ident" id="5780512">isExportedOrBuiltinType</span><span class="op" id="5780535">(</span><span class="ident" id="5780536">argType</span><span class="op" id="5780543">)</span>&nbsp;<span class="op" id="5780545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5780550">if</span>&nbsp;<span class="ident" id="5780553">reportErr</span>&nbsp;<span class="op" id="5780563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5780569">log</span><span class="op" id="5780572">.</span><span class="ident" id="5780573">Println</span><span class="op" id="5780580">(</span><span class="ident" id="5780581">mname</span><span class="op" id="5780586">,</span>&nbsp;<span class="string" id="5780588">&#34;argument&nbsp;type&nbsp;not&nbsp;exported:&#34;</span><span class="op" id="5780617">,</span>&nbsp;<span class="ident" id="5780619">argType</span><span class="op" id="5780626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5780631">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5780636">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5780647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5780651">//&nbsp;Second&nbsp;arg&nbsp;must&nbsp;be&nbsp;a&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5780686">replyType</span>&nbsp;<span class="op" id="5780696">:=</span>&nbsp;<span class="ident" id="5780699">mtype</span><span class="op" id="5780704">.</span><span class="ident" id="5780705">In</span><span class="op" id="5780707">(</span><span class="num" id="5780708">2</span><span class="op" id="5780709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5780713">if</span>&nbsp;<span class="ident" id="5780716">replyType</span><span class="op" id="5780725">.</span><span class="ident" id="5780726">Kind</span><span class="op" id="5780730">(</span><span class="op" id="5780731">)</span>&nbsp;<span class="op" id="5780733">!=</span>&nbsp;<span class="ident" id="5780736">reflect</span><span class="op" id="5780743">.</span><span class="ident" id="5780744">Ptr</span>&nbsp;<span class="op" id="5780748">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5780753">if</span>&nbsp;<span class="ident" id="5780756">reportErr</span>&nbsp;<span class="op" id="5780766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5780772">log</span><span class="op" id="5780775">.</span><span class="ident" id="5780776">Println</span><span class="op" id="5780783">(</span><span class="string" id="5780784">&#34;method&#34;</span><span class="op" id="5780792">,</span>&nbsp;<span class="ident" id="5780794">mname</span><span class="op" id="5780799">,</span>&nbsp;<span class="string" id="5780801">&#34;reply&nbsp;type&nbsp;not&nbsp;a&nbsp;pointer:&#34;</span><span class="op" id="5780828">,</span>&nbsp;<span class="ident" id="5780830">replyType</span><span class="op" id="5780839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5780844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5780849">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5780860">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5780864">//&nbsp;Reply&nbsp;type&nbsp;must&nbsp;be&nbsp;exported.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5780898">if</span>&nbsp;<span class="op" id="5780901">!</span><span class="ident" id="5780902">isExportedOrBuiltinType</span><span class="op" id="5780925">(</span><span class="ident" id="5780926">replyType</span><span class="op" id="5780935">)</span>&nbsp;<span class="op" id="5780937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5780942">if</span>&nbsp;<span class="ident" id="5780945">reportErr</span>&nbsp;<span class="op" id="5780955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5780961">log</span><span class="op" id="5780964">.</span><span class="ident" id="5780965">Println</span><span class="op" id="5780972">(</span><span class="string" id="5780973">&#34;method&#34;</span><span class="op" id="5780981">,</span>&nbsp;<span class="ident" id="5780983">mname</span><span class="op" id="5780988">,</span>&nbsp;<span class="string" id="5780990">&#34;reply&nbsp;type&nbsp;not&nbsp;exported:&#34;</span><span class="op" id="5781016">,</span>&nbsp;<span class="ident" id="5781018">replyType</span><span class="op" id="5781027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5781032">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5781037">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5781048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5781052">//&nbsp;Method&nbsp;needs&nbsp;one&nbsp;out.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5781079">if</span>&nbsp;<span class="ident" id="5781082">mtype</span><span class="op" id="5781087">.</span><span class="ident" id="5781088">NumOut</span><span class="op" id="5781094">(</span><span class="op" id="5781095">)</span>&nbsp;<span class="op" id="5781097">!=</span>&nbsp;<span class="num" id="5781100">1</span>&nbsp;<span class="op" id="5781102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5781107">if</span>&nbsp;<span class="ident" id="5781110">reportErr</span>&nbsp;<span class="op" id="5781120">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5781126">log</span><span class="op" id="5781129">.</span><span class="ident" id="5781130">Println</span><span class="op" id="5781137">(</span><span class="string" id="5781138">&#34;method&#34;</span><span class="op" id="5781146">,</span>&nbsp;<span class="ident" id="5781148">mname</span><span class="op" id="5781153">,</span>&nbsp;<span class="string" id="5781155">&#34;has&nbsp;wrong&nbsp;number&nbsp;of&nbsp;outs:&#34;</span><span class="op" id="5781182">,</span>&nbsp;<span class="ident" id="5781184">mtype</span><span class="op" id="5781189">.</span><span class="ident" id="5781190">NumOut</span><span class="op" id="5781196">(</span><span class="op" id="5781197">)</span><span class="op" id="5781198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5781203">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5781208">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5781219">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5781223">//&nbsp;The&nbsp;return&nbsp;type&nbsp;of&nbsp;the&nbsp;method&nbsp;must&nbsp;be&nbsp;error.</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5781273">if</span>&nbsp;<span class="ident" id="5781276">returnType</span>&nbsp;<span class="op" id="5781287">:=</span>&nbsp;<span class="ident" id="5781290">mtype</span><span class="op" id="5781295">.</span><span class="ident" id="5781296">Out</span><span class="op" id="5781299">(</span><span class="num" id="5781300">0</span><span class="op" id="5781301">)</span><span class="op" id="5781302">;</span>&nbsp;<span class="ident" id="5781304">returnType</span>&nbsp;<span class="op" id="5781315">!=</span>&nbsp;<span class="ident" id="5781318">typeOfError</span>&nbsp;<span class="op" id="5781330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5781335">if</span>&nbsp;<span class="ident" id="5781338">reportErr</span>&nbsp;<span class="op" id="5781348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5781354">log</span><span class="op" id="5781357">.</span><span class="ident" id="5781358">Println</span><span class="op" id="5781365">(</span><span class="string" id="5781366">&#34;method&#34;</span><span class="op" id="5781374">,</span>&nbsp;<span class="ident" id="5781376">mname</span><span class="op" id="5781381">,</span>&nbsp;<span class="string" id="5781383">&#34;returns&#34;</span><span class="op" id="5781392">,</span>&nbsp;<span class="ident" id="5781394">returnType</span><span class="op" id="5781404">.</span><span class="ident" id="5781405">String</span><span class="op" id="5781411">(</span><span class="op" id="5781412">)</span><span class="op" id="5781413">,</span>&nbsp;<span class="string" id="5781415">&#34;not&nbsp;error&#34;</span><span class="op" id="5781426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5781431">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5781436">continue</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5781447">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5781451">methods</span><span class="op" id="5781458">[</span><span class="ident" id="5781459">mname</span><span class="op" id="5781464">]</span>&nbsp;<span class="op" id="5781466">=</span>&nbsp;<span class="op" id="5781468">&amp;</span><span class="ident" id="5781469">methodType</span><span class="op" id="5781479">{</span><span class="ident" id="5781480">method</span><span class="op" id="5781486">:</span>&nbsp;<span class="ident" id="5781488">method</span><span class="op" id="5781494">,</span>&nbsp;<span class="ident" id="5781496">ArgType</span><span class="op" id="5781503">:</span>&nbsp;<span class="ident" id="5781505">argType</span><span class="op" id="5781512">,</span>&nbsp;<span class="ident" id="5781514">ReplyType</span><span class="op" id="5781523">:</span>&nbsp;<span class="ident" id="5781525">replyType</span><span class="op" id="5781534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5781537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5781540">return</span>&nbsp;<span class="ident" id="5781547">methods</span><br>
<span class="lineno"></span><span class="op" id="5781555">}</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span><span class="comment" id="5781558">//&nbsp;A&nbsp;value&nbsp;sent&nbsp;as&nbsp;a&nbsp;placeholder&nbsp;for&nbsp;the&nbsp;server&#39;s&nbsp;response&nbsp;value&nbsp;when&nbsp;the&nbsp;server</span><br>
<span class="lineno"></span><span class="comment" id="5781639">//&nbsp;receives&nbsp;an&nbsp;invalid&nbsp;request.&nbsp;It&nbsp;is&nbsp;never&nbsp;decoded&nbsp;by&nbsp;the&nbsp;client&nbsp;since&nbsp;the&nbsp;Response</span><br>
<span class="lineno"></span><span class="comment" id="5781724">//&nbsp;contains&nbsp;an&nbsp;error&nbsp;when&nbsp;it&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="5781762">var</span>&nbsp;<span class="ident" id="5781766">invalidRequest</span>&nbsp;<span class="op" id="5781781">=</span>&nbsp;<span class="keyword" id="5781783">struct</span><span class="op" id="5781789">{</span><span class="op" id="5781790">}</span><span class="op" id="5781791">{</span><span class="op" id="5781792">}</span><br>
<span class="lineno">350</span><br>
<span class="lineno"></span><span class="keyword" id="5781795">func</span>&nbsp;<span class="op" id="5781800">(</span><span class="ident" id="5781801">server</span>&nbsp;<span class="op" id="5781808">*</span><span class="ident" id="5781809">Server</span><span class="op" id="5781815">)</span>&nbsp;<span class="ident" id="5781817">sendResponse</span><span class="op" id="5781829">(</span><span class="ident" id="5781830">sending</span>&nbsp;<span class="op" id="5781838">*</span><span class="ident" id="5781839">sync</span><span class="op" id="5781843">.</span><span class="ident" id="5781844">Mutex</span><span class="op" id="5781849">,</span>&nbsp;<span class="ident" id="5781851">req</span>&nbsp;<span class="op" id="5781855">*</span><span class="ident" id="5781856">Request</span><span class="op" id="5781863">,</span>&nbsp;<span class="ident" id="5781865">reply</span>&nbsp;<span class="keyword" id="5781871">interface</span><span class="op" id="5781880">{</span><span class="op" id="5781881">}</span><span class="op" id="5781882">,</span>&nbsp;<span class="ident" id="5781884">codec</span>&nbsp;<span class="ident" id="5781890">ServerCodec</span><span class="op" id="5781901">,</span>&nbsp;<span class="ident" id="5781903">errmsg</span>&nbsp;<span class="builtintype" id="5781910">string</span><span class="op" id="5781916">)</span>&nbsp;<span class="op" id="5781918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5781921">resp</span>&nbsp;<span class="op" id="5781926">:=</span>&nbsp;<span class="ident" id="5781929">server</span><span class="op" id="5781935">.</span><span class="ident" id="5781936">getResponse</span><span class="op" id="5781947">(</span><span class="op" id="5781948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5781951">//&nbsp;Encode&nbsp;the&nbsp;response&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5781982">resp</span><span class="op" id="5781986">.</span><span class="ident" id="5781987">ServiceMethod</span>&nbsp;<span class="op" id="5782001">=</span>&nbsp;<span class="ident" id="5782003">req</span><span class="op" id="5782006">.</span><span class="ident" id="5782007">ServiceMethod</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5782022">if</span>&nbsp;<span class="ident" id="5782025">errmsg</span>&nbsp;<span class="op" id="5782032">!=</span>&nbsp;<span class="string" id="5782035">&#34;&#34;</span>&nbsp;<span class="op" id="5782038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5782042">resp</span><span class="op" id="5782046">.</span><span class="ident" id="5782047">Error</span>&nbsp;<span class="op" id="5782053">=</span>&nbsp;<span class="ident" id="5782055">errmsg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5782064">reply</span>&nbsp;<span class="op" id="5782070">=</span>&nbsp;<span class="ident" id="5782072">invalidRequest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5782088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5782091">resp</span><span class="op" id="5782095">.</span><span class="ident" id="5782096">Seq</span>&nbsp;<span class="op" id="5782100">=</span>&nbsp;<span class="ident" id="5782102">req</span><span class="op" id="5782105">.</span><span class="ident" id="5782106">Seq</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5782111">sending</span><span class="op" id="5782118">.</span><span class="ident" id="5782119">Lock</span><span class="op" id="5782123">(</span><span class="op" id="5782124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5782127">err</span>&nbsp;<span class="op" id="5782131">:=</span>&nbsp;<span class="ident" id="5782134">codec</span><span class="op" id="5782139">.</span><span class="ident" id="5782140">WriteResponse</span><span class="op" id="5782153">(</span><span class="ident" id="5782154">resp</span><span class="op" id="5782158">,</span>&nbsp;<span class="ident" id="5782160">reply</span><span class="op" id="5782165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5782168">if</span>&nbsp;<span class="ident" id="5782171">debugLog</span>&nbsp;<span class="op" id="5782180">&amp;&amp;</span>&nbsp;<span class="ident" id="5782183">err</span>&nbsp;<span class="op" id="5782187">!=</span>&nbsp;<span class="ident" id="5782190">nil</span>&nbsp;<span class="op" id="5782194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5782198">log</span><span class="op" id="5782201">.</span><span class="ident" id="5782202">Println</span><span class="op" id="5782209">(</span><span class="string" id="5782210">&#34;rpc:&nbsp;writing&nbsp;response:&#34;</span><span class="op" id="5782234">,</span>&nbsp;<span class="ident" id="5782236">err</span><span class="op" id="5782239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5782242">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5782245">sending</span><span class="op" id="5782252">.</span><span class="ident" id="5782253">Unlock</span><span class="op" id="5782259">(</span><span class="op" id="5782260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5782263">server</span><span class="op" id="5782269">.</span><span class="ident" id="5782270">freeResponse</span><span class="op" id="5782282">(</span><span class="ident" id="5782283">resp</span><span class="op" id="5782287">)</span><br>
<span class="lineno"></span><span class="op" id="5782289">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5782292">func</span>&nbsp;<span class="op" id="5782297">(</span><span class="ident" id="5782298">m</span>&nbsp;<span class="op" id="5782300">*</span><span class="ident" id="5782301">methodType</span><span class="op" id="5782311">)</span>&nbsp;<span class="ident" id="5782313">NumCalls</span><span class="op" id="5782321">(</span><span class="op" id="5782322">)</span>&nbsp;<span class="op" id="5782324">(</span><span class="ident" id="5782325">n</span>&nbsp;<span class="builtintype" id="5782327">uint</span><span class="op" id="5782331">)</span>&nbsp;<span class="op" id="5782333">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5782336">m</span><span class="op" id="5782337">.</span><span class="ident" id="5782338">Lock</span><span class="op" id="5782342">(</span><span class="op" id="5782343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5782346">n</span>&nbsp;<span class="op" id="5782348">=</span>&nbsp;<span class="ident" id="5782350">m</span><span class="op" id="5782351">.</span><span class="ident" id="5782352">numCalls</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5782362">m</span><span class="op" id="5782363">.</span><span class="ident" id="5782364">Unlock</span><span class="op" id="5782370">(</span><span class="op" id="5782371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5782374">return</span>&nbsp;<span class="ident" id="5782381">n</span><br>
<span class="lineno"></span><span class="op" id="5782383">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span><span class="keyword" id="5782386">func</span>&nbsp;<span class="op" id="5782391">(</span><span class="ident" id="5782392">s</span>&nbsp;<span class="op" id="5782394">*</span><span class="ident" id="5782395">service</span><span class="op" id="5782402">)</span>&nbsp;<span class="ident" id="5782404">call</span><span class="op" id="5782408">(</span><span class="ident" id="5782409">server</span>&nbsp;<span class="op" id="5782416">*</span><span class="ident" id="5782417">Server</span><span class="op" id="5782423">,</span>&nbsp;<span class="ident" id="5782425">sending</span>&nbsp;<span class="op" id="5782433">*</span><span class="ident" id="5782434">sync</span><span class="op" id="5782438">.</span><span class="ident" id="5782439">Mutex</span><span class="op" id="5782444">,</span>&nbsp;<span class="ident" id="5782446">mtype</span>&nbsp;<span class="op" id="5782452">*</span><span class="ident" id="5782453">methodType</span><span class="op" id="5782463">,</span>&nbsp;<span class="ident" id="5782465">req</span>&nbsp;<span class="op" id="5782469">*</span><span class="ident" id="5782470">Request</span><span class="op" id="5782477">,</span>&nbsp;<span class="ident" id="5782479">argv</span><span class="op" id="5782483">,</span>&nbsp;<span class="ident" id="5782485">replyv</span>&nbsp;<span class="ident" id="5782492">reflect</span><span class="op" id="5782499">.</span><span class="ident" id="5782500">Value</span><span class="op" id="5782505">,</span>&nbsp;<span class="ident" id="5782507">codec</span>&nbsp;<span class="ident" id="5782513">ServerCodec</span><span class="op" id="5782524">)</span>&nbsp;<span class="op" id="5782526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5782529">mtype</span><span class="op" id="5782534">.</span><span class="ident" id="5782535">Lock</span><span class="op" id="5782539">(</span><span class="op" id="5782540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5782543">mtype</span><span class="op" id="5782548">.</span><span class="ident" id="5782549">numCalls</span><span class="op" id="5782557">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5782561">mtype</span><span class="op" id="5782566">.</span><span class="ident" id="5782567">Unlock</span><span class="op" id="5782573">(</span><span class="op" id="5782574">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5782577">function</span>&nbsp;<span class="op" id="5782586">:=</span>&nbsp;<span class="ident" id="5782589">mtype</span><span class="op" id="5782594">.</span><span class="ident" id="5782595">method</span><span class="op" id="5782601">.</span><span class="ident" id="5782602">Func</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5782608">//&nbsp;Invoke&nbsp;the&nbsp;method,&nbsp;providing&nbsp;a&nbsp;new&nbsp;value&nbsp;for&nbsp;the&nbsp;reply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5782668">returnValues</span>&nbsp;<span class="op" id="5782681">:=</span>&nbsp;<span class="ident" id="5782684">function</span><span class="op" id="5782692">.</span><span class="ident" id="5782693">Call</span><span class="op" id="5782697">(</span><span class="op" id="5782698">[</span><span class="op" id="5782699">]</span><span class="ident" id="5782700">reflect</span><span class="op" id="5782707">.</span><span class="ident" id="5782708">Value</span><span class="op" id="5782713">{</span><span class="ident" id="5782714">s</span><span class="op" id="5782715">.</span><span class="ident" id="5782716">rcvr</span><span class="op" id="5782720">,</span>&nbsp;<span class="ident" id="5782722">argv</span><span class="op" id="5782726">,</span>&nbsp;<span class="ident" id="5782728">replyv</span><span class="op" id="5782734">}</span><span class="op" id="5782735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5782738">//&nbsp;The&nbsp;return&nbsp;value&nbsp;for&nbsp;the&nbsp;method&nbsp;is&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5782787">errInter</span>&nbsp;<span class="op" id="5782796">:=</span>&nbsp;<span class="ident" id="5782799">returnValues</span><span class="op" id="5782811">[</span><span class="num" id="5782812">0</span><span class="op" id="5782813">]</span><span class="op" id="5782814">.</span><span class="ident" id="5782815">Interface</span><span class="op" id="5782824">(</span><span class="op" id="5782825">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5782828">errmsg</span>&nbsp;<span class="op" id="5782835">:=</span>&nbsp;<span class="string" id="5782838">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5782842">if</span>&nbsp;<span class="ident" id="5782845">errInter</span>&nbsp;<span class="op" id="5782854">!=</span>&nbsp;<span class="ident" id="5782857">nil</span>&nbsp;<span class="op" id="5782861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5782865">errmsg</span>&nbsp;<span class="op" id="5782872">=</span>&nbsp;<span class="ident" id="5782874">errInter</span><span class="op" id="5782882">.</span><span class="op" id="5782883">(</span><span class="builtintype" id="5782884">error</span><span class="op" id="5782889">)</span><span class="op" id="5782890">.</span><span class="ident" id="5782891">Error</span><span class="op" id="5782896">(</span><span class="op" id="5782897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5782900">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5782903">server</span><span class="op" id="5782909">.</span><span class="ident" id="5782910">sendResponse</span><span class="op" id="5782922">(</span><span class="ident" id="5782923">sending</span><span class="op" id="5782930">,</span>&nbsp;<span class="ident" id="5782932">req</span><span class="op" id="5782935">,</span>&nbsp;<span class="ident" id="5782937">replyv</span><span class="op" id="5782943">.</span><span class="ident" id="5782944">Interface</span><span class="op" id="5782953">(</span><span class="op" id="5782954">)</span><span class="op" id="5782955">,</span>&nbsp;<span class="ident" id="5782957">codec</span><span class="op" id="5782962">,</span>&nbsp;<span class="ident" id="5782964">errmsg</span><span class="op" id="5782970">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5782973">server</span><span class="op" id="5782979">.</span><span class="ident" id="5782980">freeRequest</span><span class="op" id="5782991">(</span><span class="ident" id="5782992">req</span><span class="op" id="5782995">)</span><br>
<span class="lineno"></span><span class="op" id="5782997">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5783000">type</span>&nbsp;<span class="ident" id="5783005">gobServerCodec</span>&nbsp;<span class="keyword" id="5783020">struct</span>&nbsp;<span class="op" id="5783027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5783030">rwc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5783037">io</span><span class="op" id="5783039">.</span><span class="ident" id="5783040">ReadWriteCloser</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5783057">dec</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5783064">*</span><span class="ident" id="5783065">gob</span><span class="op" id="5783068">.</span><span class="ident" id="5783069">Decoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5783078">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5783085">*</span><span class="ident" id="5783086">gob</span><span class="op" id="5783089">.</span><span class="ident" id="5783090">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5783099">encBuf</span>&nbsp;<span class="op" id="5783106">*</span><span class="ident" id="5783107">bufio</span><span class="op" id="5783112">.</span><span class="ident" id="5783113">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5783121">closed</span>&nbsp;<span class="builtintype" id="5783128">bool</span><br>
<span class="lineno"></span><span class="op" id="5783133">}</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span><span class="keyword" id="5783136">func</span>&nbsp;<span class="op" id="5783141">(</span><span class="ident" id="5783142">c</span>&nbsp;<span class="op" id="5783144">*</span><span class="ident" id="5783145">gobServerCodec</span><span class="op" id="5783159">)</span>&nbsp;<span class="ident" id="5783161">ReadRequestHeader</span><span class="op" id="5783178">(</span><span class="ident" id="5783179">r</span>&nbsp;<span class="op" id="5783181">*</span><span class="ident" id="5783182">Request</span><span class="op" id="5783189">)</span>&nbsp;<span class="builtintype" id="5783191">error</span>&nbsp;<span class="op" id="5783197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5783200">return</span>&nbsp;<span class="ident" id="5783207">c</span><span class="op" id="5783208">.</span><span class="ident" id="5783209">dec</span><span class="op" id="5783212">.</span><span class="ident" id="5783213">Decode</span><span class="op" id="5783219">(</span><span class="ident" id="5783220">r</span><span class="op" id="5783221">)</span><br>
<span class="lineno"></span><span class="op" id="5783223">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span><span class="keyword" id="5783226">func</span>&nbsp;<span class="op" id="5783231">(</span><span class="ident" id="5783232">c</span>&nbsp;<span class="op" id="5783234">*</span><span class="ident" id="5783235">gobServerCodec</span><span class="op" id="5783249">)</span>&nbsp;<span class="ident" id="5783251">ReadRequestBody</span><span class="op" id="5783266">(</span><span class="ident" id="5783267">body</span>&nbsp;<span class="keyword" id="5783272">interface</span><span class="op" id="5783281">{</span><span class="op" id="5783282">}</span><span class="op" id="5783283">)</span>&nbsp;<span class="builtintype" id="5783285">error</span>&nbsp;<span class="op" id="5783291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5783294">return</span>&nbsp;<span class="ident" id="5783301">c</span><span class="op" id="5783302">.</span><span class="ident" id="5783303">dec</span><span class="op" id="5783306">.</span><span class="ident" id="5783307">Decode</span><span class="op" id="5783313">(</span><span class="ident" id="5783314">body</span><span class="op" id="5783318">)</span><br>
<span class="lineno"></span><span class="op" id="5783320">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5783323">func</span>&nbsp;<span class="op" id="5783328">(</span><span class="ident" id="5783329">c</span>&nbsp;<span class="op" id="5783331">*</span><span class="ident" id="5783332">gobServerCodec</span><span class="op" id="5783346">)</span>&nbsp;<span class="ident" id="5783348">WriteResponse</span><span class="op" id="5783361">(</span><span class="ident" id="5783362">r</span>&nbsp;<span class="op" id="5783364">*</span><span class="ident" id="5783365">Response</span><span class="op" id="5783373">,</span>&nbsp;<span class="ident" id="5783375">body</span>&nbsp;<span class="keyword" id="5783380">interface</span><span class="op" id="5783389">{</span><span class="op" id="5783390">}</span><span class="op" id="5783391">)</span>&nbsp;<span class="op" id="5783393">(</span><span class="ident" id="5783394">err</span>&nbsp;<span class="builtintype" id="5783398">error</span><span class="op" id="5783403">)</span>&nbsp;<span class="op" id="5783405">{</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5783408">if</span>&nbsp;<span class="ident" id="5783411">err</span>&nbsp;<span class="op" id="5783415">=</span>&nbsp;<span class="ident" id="5783417">c</span><span class="op" id="5783418">.</span><span class="ident" id="5783419">enc</span><span class="op" id="5783422">.</span><span class="ident" id="5783423">Encode</span><span class="op" id="5783429">(</span><span class="ident" id="5783430">r</span><span class="op" id="5783431">)</span><span class="op" id="5783432">;</span>&nbsp;<span class="ident" id="5783434">err</span>&nbsp;<span class="op" id="5783438">!=</span>&nbsp;<span class="ident" id="5783441">nil</span>&nbsp;<span class="op" id="5783445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5783449">if</span>&nbsp;<span class="ident" id="5783452">c</span><span class="op" id="5783453">.</span><span class="ident" id="5783454">encBuf</span><span class="op" id="5783460">.</span><span class="ident" id="5783461">Flush</span><span class="op" id="5783466">(</span><span class="op" id="5783467">)</span>&nbsp;<span class="op" id="5783469">==</span>&nbsp;<span class="ident" id="5783472">nil</span>&nbsp;<span class="op" id="5783476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5783481">//&nbsp;Gob&nbsp;couldn&#39;t&nbsp;encode&nbsp;the&nbsp;header.&nbsp;Should&nbsp;not&nbsp;happen,&nbsp;so&nbsp;if&nbsp;it&nbsp;does,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5783553">//&nbsp;shut&nbsp;down&nbsp;the&nbsp;connection&nbsp;to&nbsp;signal&nbsp;that&nbsp;the&nbsp;connection&nbsp;is&nbsp;broken.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5783625">log</span><span class="op" id="5783628">.</span><span class="ident" id="5783629">Println</span><span class="op" id="5783636">(</span><span class="string" id="5783637">&#34;rpc:&nbsp;gob&nbsp;error&nbsp;encoding&nbsp;response:&#34;</span><span class="op" id="5783672">,</span>&nbsp;<span class="ident" id="5783674">err</span><span class="op" id="5783677">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5783682">c</span><span class="op" id="5783683">.</span><span class="ident" id="5783684">Close</span><span class="op" id="5783689">(</span><span class="op" id="5783690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5783694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5783698">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5783706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5783709">if</span>&nbsp;<span class="ident" id="5783712">err</span>&nbsp;<span class="op" id="5783716">=</span>&nbsp;<span class="ident" id="5783718">c</span><span class="op" id="5783719">.</span><span class="ident" id="5783720">enc</span><span class="op" id="5783723">.</span><span class="ident" id="5783724">Encode</span><span class="op" id="5783730">(</span><span class="ident" id="5783731">body</span><span class="op" id="5783735">)</span><span class="op" id="5783736">;</span>&nbsp;<span class="ident" id="5783738">err</span>&nbsp;<span class="op" id="5783742">!=</span>&nbsp;<span class="ident" id="5783745">nil</span>&nbsp;<span class="op" id="5783749">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5783753">if</span>&nbsp;<span class="ident" id="5783756">c</span><span class="op" id="5783757">.</span><span class="ident" id="5783758">encBuf</span><span class="op" id="5783764">.</span><span class="ident" id="5783765">Flush</span><span class="op" id="5783770">(</span><span class="op" id="5783771">)</span>&nbsp;<span class="op" id="5783773">==</span>&nbsp;<span class="ident" id="5783776">nil</span>&nbsp;<span class="op" id="5783780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5783785">//&nbsp;Was&nbsp;a&nbsp;gob&nbsp;problem&nbsp;encoding&nbsp;the&nbsp;body&nbsp;but&nbsp;the&nbsp;header&nbsp;has&nbsp;been&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5783860">//&nbsp;Shut&nbsp;down&nbsp;the&nbsp;connection&nbsp;to&nbsp;signal&nbsp;that&nbsp;the&nbsp;connection&nbsp;is&nbsp;broken.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5783932">log</span><span class="op" id="5783935">.</span><span class="ident" id="5783936">Println</span><span class="op" id="5783943">(</span><span class="string" id="5783944">&#34;rpc:&nbsp;gob&nbsp;error&nbsp;encoding&nbsp;body:&#34;</span><span class="op" id="5783975">,</span>&nbsp;<span class="ident" id="5783977">err</span><span class="op" id="5783980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5783985">c</span><span class="op" id="5783986">.</span><span class="ident" id="5783987">Close</span><span class="op" id="5783992">(</span><span class="op" id="5783993">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5783997">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5784001">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5784009">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5784012">return</span>&nbsp;<span class="ident" id="5784019">c</span><span class="op" id="5784020">.</span><span class="ident" id="5784021">encBuf</span><span class="op" id="5784027">.</span><span class="ident" id="5784028">Flush</span><span class="op" id="5784033">(</span><span class="op" id="5784034">)</span><br>
<span class="lineno"></span><span class="op" id="5784036">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="5784039">func</span>&nbsp;<span class="op" id="5784044">(</span><span class="ident" id="5784045">c</span>&nbsp;<span class="op" id="5784047">*</span><span class="ident" id="5784048">gobServerCodec</span><span class="op" id="5784062">)</span>&nbsp;<span class="ident" id="5784064">Close</span><span class="op" id="5784069">(</span><span class="op" id="5784070">)</span>&nbsp;<span class="builtintype" id="5784072">error</span>&nbsp;<span class="op" id="5784078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5784081">if</span>&nbsp;<span class="ident" id="5784084">c</span><span class="op" id="5784085">.</span><span class="ident" id="5784086">closed</span>&nbsp;<span class="op" id="5784093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5784097">//&nbsp;Only&nbsp;call&nbsp;c.rwc.Close&nbsp;once;&nbsp;otherwise&nbsp;the&nbsp;semantics&nbsp;are&nbsp;undefined.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5784169">return</span>&nbsp;<span class="ident" id="5784176">nil</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5784181">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5784184">c</span><span class="op" id="5784185">.</span><span class="ident" id="5784186">closed</span>&nbsp;<span class="op" id="5784193">=</span>&nbsp;<span class="builtintype" id="5784195">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5784201">return</span>&nbsp;<span class="ident" id="5784208">c</span><span class="op" id="5784209">.</span><span class="ident" id="5784210">rwc</span><span class="op" id="5784213">.</span><span class="ident" id="5784214">Close</span><span class="op" id="5784219">(</span><span class="op" id="5784220">)</span><br>
<span class="lineno"></span><span class="op" id="5784222">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span><span class="comment" id="5784225">//&nbsp;ServeConn&nbsp;runs&nbsp;the&nbsp;server&nbsp;on&nbsp;a&nbsp;single&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="5784278">//&nbsp;ServeConn&nbsp;blocks,&nbsp;serving&nbsp;the&nbsp;connection&nbsp;until&nbsp;the&nbsp;client&nbsp;hangs&nbsp;up.</span><br>
<span class="lineno"></span><span class="comment" id="5784349">//&nbsp;The&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;ServeConn&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="comment" id="5784410">//&nbsp;ServeConn&nbsp;uses&nbsp;the&nbsp;gob&nbsp;wire&nbsp;format&nbsp;(see&nbsp;package&nbsp;gob)&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5784473">//&nbsp;connection.&nbsp;&nbsp;To&nbsp;use&nbsp;an&nbsp;alternate&nbsp;codec,&nbsp;use&nbsp;ServeCodec.</span><br>
<span class="lineno">445</span><span class="keyword" id="5784532">func</span>&nbsp;<span class="op" id="5784537">(</span><span class="ident" id="5784538">server</span>&nbsp;<span class="op" id="5784545">*</span><span class="ident" id="5784546">Server</span><span class="op" id="5784552">)</span>&nbsp;<span class="ident" id="5784554">ServeConn</span><span class="op" id="5784563">(</span><span class="ident" id="5784564">conn</span>&nbsp;<span class="ident" id="5784569">io</span><span class="op" id="5784571">.</span><span class="ident" id="5784572">ReadWriteCloser</span><span class="op" id="5784587">)</span>&nbsp;<span class="op" id="5784589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5784592">buf</span>&nbsp;<span class="op" id="5784596">:=</span>&nbsp;<span class="ident" id="5784599">bufio</span><span class="op" id="5784604">.</span><span class="ident" id="5784605">NewWriter</span><span class="op" id="5784614">(</span><span class="ident" id="5784615">conn</span><span class="op" id="5784619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5784622">srv</span>&nbsp;<span class="op" id="5784626">:=</span>&nbsp;<span class="op" id="5784629">&amp;</span><span class="ident" id="5784630">gobServerCodec</span><span class="op" id="5784644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5784648">rwc</span><span class="op" id="5784651">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5784656">conn</span><span class="op" id="5784660">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5784664">dec</span><span class="op" id="5784667">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5784672">gob</span><span class="op" id="5784675">.</span><span class="ident" id="5784676">NewDecoder</span><span class="op" id="5784686">(</span><span class="ident" id="5784687">conn</span><span class="op" id="5784691">)</span><span class="op" id="5784692">,</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5784696">enc</span><span class="op" id="5784699">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5784704">gob</span><span class="op" id="5784707">.</span><span class="ident" id="5784708">NewEncoder</span><span class="op" id="5784718">(</span><span class="ident" id="5784719">buf</span><span class="op" id="5784722">)</span><span class="op" id="5784723">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5784727">encBuf</span><span class="op" id="5784733">:</span>&nbsp;<span class="ident" id="5784735">buf</span><span class="op" id="5784738">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5784741">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5784744">server</span><span class="op" id="5784750">.</span><span class="ident" id="5784751">ServeCodec</span><span class="op" id="5784761">(</span><span class="ident" id="5784762">srv</span><span class="op" id="5784765">)</span><br>
<span class="lineno"></span><span class="op" id="5784767">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span><span class="comment" id="5784770">//&nbsp;ServeCodec&nbsp;is&nbsp;like&nbsp;ServeConn&nbsp;but&nbsp;uses&nbsp;the&nbsp;specified&nbsp;codec&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5784834">//&nbsp;decode&nbsp;requests&nbsp;and&nbsp;encode&nbsp;responses.</span><br>
<span class="lineno"></span><span class="keyword" id="5784875">func</span>&nbsp;<span class="op" id="5784880">(</span><span class="ident" id="5784881">server</span>&nbsp;<span class="op" id="5784888">*</span><span class="ident" id="5784889">Server</span><span class="op" id="5784895">)</span>&nbsp;<span class="ident" id="5784897">ServeCodec</span><span class="op" id="5784907">(</span><span class="ident" id="5784908">codec</span>&nbsp;<span class="ident" id="5784914">ServerCodec</span><span class="op" id="5784925">)</span>&nbsp;<span class="op" id="5784927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5784930">sending</span>&nbsp;<span class="op" id="5784938">:=</span>&nbsp;<span class="builtinfunc" id="5784941">new</span><span class="op" id="5784944">(</span><span class="ident" id="5784945">sync</span><span class="op" id="5784949">.</span><span class="ident" id="5784950">Mutex</span><span class="op" id="5784955">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5784958">for</span>&nbsp;<span class="op" id="5784962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5784966">service</span><span class="op" id="5784973">,</span>&nbsp;<span class="ident" id="5784975">mtype</span><span class="op" id="5784980">,</span>&nbsp;<span class="ident" id="5784982">req</span><span class="op" id="5784985">,</span>&nbsp;<span class="ident" id="5784987">argv</span><span class="op" id="5784991">,</span>&nbsp;<span class="ident" id="5784993">replyv</span><span class="op" id="5784999">,</span>&nbsp;<span class="ident" id="5785001">keepReading</span><span class="op" id="5785012">,</span>&nbsp;<span class="ident" id="5785014">err</span>&nbsp;<span class="op" id="5785018">:=</span>&nbsp;<span class="ident" id="5785021">server</span><span class="op" id="5785027">.</span><span class="ident" id="5785028">readRequest</span><span class="op" id="5785039">(</span><span class="ident" id="5785040">codec</span><span class="op" id="5785045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5785049">if</span>&nbsp;<span class="ident" id="5785052">err</span>&nbsp;<span class="op" id="5785056">!=</span>&nbsp;<span class="ident" id="5785059">nil</span>&nbsp;<span class="op" id="5785063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5785068">if</span>&nbsp;<span class="ident" id="5785071">debugLog</span>&nbsp;<span class="op" id="5785080">&amp;&amp;</span>&nbsp;<span class="ident" id="5785083">err</span>&nbsp;<span class="op" id="5785087">!=</span>&nbsp;<span class="ident" id="5785090">io</span><span class="op" id="5785092">.</span><span class="ident" id="5785093">EOF</span>&nbsp;<span class="op" id="5785097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5785103">log</span><span class="op" id="5785106">.</span><span class="ident" id="5785107">Println</span><span class="op" id="5785114">(</span><span class="string" id="5785115">&#34;rpc:&#34;</span><span class="op" id="5785121">,</span>&nbsp;<span class="ident" id="5785123">err</span><span class="op" id="5785126">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5785131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5785136">if</span>&nbsp;<span class="op" id="5785139">!</span><span class="ident" id="5785140">keepReading</span>&nbsp;<span class="op" id="5785152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5785158">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5785167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5785172">//&nbsp;send&nbsp;a&nbsp;response&nbsp;if&nbsp;we&nbsp;actually&nbsp;managed&nbsp;to&nbsp;read&nbsp;a&nbsp;header.</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5785235">if</span>&nbsp;<span class="ident" id="5785238">req</span>&nbsp;<span class="op" id="5785242">!=</span>&nbsp;<span class="ident" id="5785245">nil</span>&nbsp;<span class="op" id="5785249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5785255">server</span><span class="op" id="5785261">.</span><span class="ident" id="5785262">sendResponse</span><span class="op" id="5785274">(</span><span class="ident" id="5785275">sending</span><span class="op" id="5785282">,</span>&nbsp;<span class="ident" id="5785284">req</span><span class="op" id="5785287">,</span>&nbsp;<span class="ident" id="5785289">invalidRequest</span><span class="op" id="5785303">,</span>&nbsp;<span class="ident" id="5785305">codec</span><span class="op" id="5785310">,</span>&nbsp;<span class="ident" id="5785312">err</span><span class="op" id="5785315">.</span><span class="ident" id="5785316">Error</span><span class="op" id="5785321">(</span><span class="op" id="5785322">)</span><span class="op" id="5785323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5785329">server</span><span class="op" id="5785335">.</span><span class="ident" id="5785336">freeRequest</span><span class="op" id="5785347">(</span><span class="ident" id="5785348">req</span><span class="op" id="5785351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5785356">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5785361">continue</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5785372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5785376">go</span>&nbsp;<span class="ident" id="5785379">service</span><span class="op" id="5785386">.</span><span class="ident" id="5785387">call</span><span class="op" id="5785391">(</span><span class="ident" id="5785392">server</span><span class="op" id="5785398">,</span>&nbsp;<span class="ident" id="5785400">sending</span><span class="op" id="5785407">,</span>&nbsp;<span class="ident" id="5785409">mtype</span><span class="op" id="5785414">,</span>&nbsp;<span class="ident" id="5785416">req</span><span class="op" id="5785419">,</span>&nbsp;<span class="ident" id="5785421">argv</span><span class="op" id="5785425">,</span>&nbsp;<span class="ident" id="5785427">replyv</span><span class="op" id="5785433">,</span>&nbsp;<span class="ident" id="5785435">codec</span><span class="op" id="5785440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5785443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5785446">codec</span><span class="op" id="5785451">.</span><span class="ident" id="5785452">Close</span><span class="op" id="5785457">(</span><span class="op" id="5785458">)</span><br>
<span class="lineno"></span><span class="op" id="5785460">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="5785463">//&nbsp;ServeRequest&nbsp;is&nbsp;like&nbsp;ServeCodec&nbsp;but&nbsp;synchronously&nbsp;serves&nbsp;a&nbsp;single&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="5785541">//&nbsp;It&nbsp;does&nbsp;not&nbsp;close&nbsp;the&nbsp;codec&nbsp;upon&nbsp;completion.</span><br>
<span class="lineno"></span><span class="keyword" id="5785589">func</span>&nbsp;<span class="op" id="5785594">(</span><span class="ident" id="5785595">server</span>&nbsp;<span class="op" id="5785602">*</span><span class="ident" id="5785603">Server</span><span class="op" id="5785609">)</span>&nbsp;<span class="ident" id="5785611">ServeRequest</span><span class="op" id="5785623">(</span><span class="ident" id="5785624">codec</span>&nbsp;<span class="ident" id="5785630">ServerCodec</span><span class="op" id="5785641">)</span>&nbsp;<span class="builtintype" id="5785643">error</span>&nbsp;<span class="op" id="5785649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5785652">sending</span>&nbsp;<span class="op" id="5785660">:=</span>&nbsp;<span class="builtinfunc" id="5785663">new</span><span class="op" id="5785666">(</span><span class="ident" id="5785667">sync</span><span class="op" id="5785671">.</span><span class="ident" id="5785672">Mutex</span><span class="op" id="5785677">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5785680">service</span><span class="op" id="5785687">,</span>&nbsp;<span class="ident" id="5785689">mtype</span><span class="op" id="5785694">,</span>&nbsp;<span class="ident" id="5785696">req</span><span class="op" id="5785699">,</span>&nbsp;<span class="ident" id="5785701">argv</span><span class="op" id="5785705">,</span>&nbsp;<span class="ident" id="5785707">replyv</span><span class="op" id="5785713">,</span>&nbsp;<span class="ident" id="5785715">keepReading</span><span class="op" id="5785726">,</span>&nbsp;<span class="ident" id="5785728">err</span>&nbsp;<span class="op" id="5785732">:=</span>&nbsp;<span class="ident" id="5785735">server</span><span class="op" id="5785741">.</span><span class="ident" id="5785742">readRequest</span><span class="op" id="5785753">(</span><span class="ident" id="5785754">codec</span><span class="op" id="5785759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5785762">if</span>&nbsp;<span class="ident" id="5785765">err</span>&nbsp;<span class="op" id="5785769">!=</span>&nbsp;<span class="ident" id="5785772">nil</span>&nbsp;<span class="op" id="5785776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5785780">if</span>&nbsp;<span class="op" id="5785783">!</span><span class="ident" id="5785784">keepReading</span>&nbsp;<span class="op" id="5785796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5785801">return</span>&nbsp;<span class="ident" id="5785808">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5785814">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5785818">//&nbsp;send&nbsp;a&nbsp;response&nbsp;if&nbsp;we&nbsp;actually&nbsp;managed&nbsp;to&nbsp;read&nbsp;a&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5785880">if</span>&nbsp;<span class="ident" id="5785883">req</span>&nbsp;<span class="op" id="5785887">!=</span>&nbsp;<span class="ident" id="5785890">nil</span>&nbsp;<span class="op" id="5785894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5785899">server</span><span class="op" id="5785905">.</span><span class="ident" id="5785906">sendResponse</span><span class="op" id="5785918">(</span><span class="ident" id="5785919">sending</span><span class="op" id="5785926">,</span>&nbsp;<span class="ident" id="5785928">req</span><span class="op" id="5785931">,</span>&nbsp;<span class="ident" id="5785933">invalidRequest</span><span class="op" id="5785947">,</span>&nbsp;<span class="ident" id="5785949">codec</span><span class="op" id="5785954">,</span>&nbsp;<span class="ident" id="5785956">err</span><span class="op" id="5785959">.</span><span class="ident" id="5785960">Error</span><span class="op" id="5785965">(</span><span class="op" id="5785966">)</span><span class="op" id="5785967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5785972">server</span><span class="op" id="5785978">.</span><span class="ident" id="5785979">freeRequest</span><span class="op" id="5785990">(</span><span class="ident" id="5785991">req</span><span class="op" id="5785994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5785998">}</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5786002">return</span>&nbsp;<span class="ident" id="5786009">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5786014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5786017">service</span><span class="op" id="5786024">.</span><span class="ident" id="5786025">call</span><span class="op" id="5786029">(</span><span class="ident" id="5786030">server</span><span class="op" id="5786036">,</span>&nbsp;<span class="ident" id="5786038">sending</span><span class="op" id="5786045">,</span>&nbsp;<span class="ident" id="5786047">mtype</span><span class="op" id="5786052">,</span>&nbsp;<span class="ident" id="5786054">req</span><span class="op" id="5786057">,</span>&nbsp;<span class="ident" id="5786059">argv</span><span class="op" id="5786063">,</span>&nbsp;<span class="ident" id="5786065">replyv</span><span class="op" id="5786071">,</span>&nbsp;<span class="ident" id="5786073">codec</span><span class="op" id="5786078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5786081">return</span>&nbsp;<span class="ident" id="5786088">nil</span><br>
<span class="lineno"></span><span class="op" id="5786092">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="keyword" id="5786095">func</span>&nbsp;<span class="op" id="5786100">(</span><span class="ident" id="5786101">server</span>&nbsp;<span class="op" id="5786108">*</span><span class="ident" id="5786109">Server</span><span class="op" id="5786115">)</span>&nbsp;<span class="ident" id="5786117">getRequest</span><span class="op" id="5786127">(</span><span class="op" id="5786128">)</span>&nbsp;<span class="op" id="5786130">*</span><span class="ident" id="5786131">Request</span>&nbsp;<span class="op" id="5786139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5786142">server</span><span class="op" id="5786148">.</span><span class="ident" id="5786149">reqLock</span><span class="op" id="5786156">.</span><span class="ident" id="5786157">Lock</span><span class="op" id="5786161">(</span><span class="op" id="5786162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5786165">req</span>&nbsp;<span class="op" id="5786169">:=</span>&nbsp;<span class="ident" id="5786172">server</span><span class="op" id="5786178">.</span><span class="ident" id="5786179">freeReq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5786188">if</span>&nbsp;<span class="ident" id="5786191">req</span>&nbsp;<span class="op" id="5786195">==</span>&nbsp;<span class="ident" id="5786198">nil</span>&nbsp;<span class="op" id="5786202">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5786206">req</span>&nbsp;<span class="op" id="5786210">=</span>&nbsp;<span class="builtinfunc" id="5786212">new</span><span class="op" id="5786215">(</span><span class="ident" id="5786216">Request</span><span class="op" id="5786223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5786226">}</span>&nbsp;<span class="keyword" id="5786228">else</span>&nbsp;<span class="op" id="5786233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5786237">server</span><span class="op" id="5786243">.</span><span class="ident" id="5786244">freeReq</span>&nbsp;<span class="op" id="5786252">=</span>&nbsp;<span class="ident" id="5786254">req</span><span class="op" id="5786257">.</span><span class="ident" id="5786258">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5786265">*</span><span class="ident" id="5786266">req</span>&nbsp;<span class="op" id="5786270">=</span>&nbsp;<span class="ident" id="5786272">Request</span><span class="op" id="5786279">{</span><span class="op" id="5786280">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5786283">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5786286">server</span><span class="op" id="5786292">.</span><span class="ident" id="5786293">reqLock</span><span class="op" id="5786300">.</span><span class="ident" id="5786301">Unlock</span><span class="op" id="5786307">(</span><span class="op" id="5786308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5786311">return</span>&nbsp;<span class="ident" id="5786318">req</span><br>
<span class="lineno"></span><span class="op" id="5786322">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5786325">func</span>&nbsp;<span class="op" id="5786330">(</span><span class="ident" id="5786331">server</span>&nbsp;<span class="op" id="5786338">*</span><span class="ident" id="5786339">Server</span><span class="op" id="5786345">)</span>&nbsp;<span class="ident" id="5786347">freeRequest</span><span class="op" id="5786358">(</span><span class="ident" id="5786359">req</span>&nbsp;<span class="op" id="5786363">*</span><span class="ident" id="5786364">Request</span><span class="op" id="5786371">)</span>&nbsp;<span class="op" id="5786373">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5786376">server</span><span class="op" id="5786382">.</span><span class="ident" id="5786383">reqLock</span><span class="op" id="5786390">.</span><span class="ident" id="5786391">Lock</span><span class="op" id="5786395">(</span><span class="op" id="5786396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5786399">req</span><span class="op" id="5786402">.</span><span class="ident" id="5786403">next</span>&nbsp;<span class="op" id="5786408">=</span>&nbsp;<span class="ident" id="5786410">server</span><span class="op" id="5786416">.</span><span class="ident" id="5786417">freeReq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5786426">server</span><span class="op" id="5786432">.</span><span class="ident" id="5786433">freeReq</span>&nbsp;<span class="op" id="5786441">=</span>&nbsp;<span class="ident" id="5786443">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5786448">server</span><span class="op" id="5786454">.</span><span class="ident" id="5786455">reqLock</span><span class="op" id="5786462">.</span><span class="ident" id="5786463">Unlock</span><span class="op" id="5786469">(</span><span class="op" id="5786470">)</span><br>
<span class="lineno"></span><span class="op" id="5786472">}</span><br>
<span class="lineno">520</span><br>
<span class="lineno"></span><span class="keyword" id="5786475">func</span>&nbsp;<span class="op" id="5786480">(</span><span class="ident" id="5786481">server</span>&nbsp;<span class="op" id="5786488">*</span><span class="ident" id="5786489">Server</span><span class="op" id="5786495">)</span>&nbsp;<span class="ident" id="5786497">getResponse</span><span class="op" id="5786508">(</span><span class="op" id="5786509">)</span>&nbsp;<span class="op" id="5786511">*</span><span class="ident" id="5786512">Response</span>&nbsp;<span class="op" id="5786521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5786524">server</span><span class="op" id="5786530">.</span><span class="ident" id="5786531">respLock</span><span class="op" id="5786539">.</span><span class="ident" id="5786540">Lock</span><span class="op" id="5786544">(</span><span class="op" id="5786545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5786548">resp</span>&nbsp;<span class="op" id="5786553">:=</span>&nbsp;<span class="ident" id="5786556">server</span><span class="op" id="5786562">.</span><span class="ident" id="5786563">freeResp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5786573">if</span>&nbsp;<span class="ident" id="5786576">resp</span>&nbsp;<span class="op" id="5786581">==</span>&nbsp;<span class="ident" id="5786584">nil</span>&nbsp;<span class="op" id="5786588">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5786592">resp</span>&nbsp;<span class="op" id="5786597">=</span>&nbsp;<span class="builtinfunc" id="5786599">new</span><span class="op" id="5786602">(</span><span class="ident" id="5786603">Response</span><span class="op" id="5786611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5786614">}</span>&nbsp;<span class="keyword" id="5786616">else</span>&nbsp;<span class="op" id="5786621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5786625">server</span><span class="op" id="5786631">.</span><span class="ident" id="5786632">freeResp</span>&nbsp;<span class="op" id="5786641">=</span>&nbsp;<span class="ident" id="5786643">resp</span><span class="op" id="5786647">.</span><span class="ident" id="5786648">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5786655">*</span><span class="ident" id="5786656">resp</span>&nbsp;<span class="op" id="5786661">=</span>&nbsp;<span class="ident" id="5786663">Response</span><span class="op" id="5786671">{</span><span class="op" id="5786672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5786675">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5786678">server</span><span class="op" id="5786684">.</span><span class="ident" id="5786685">respLock</span><span class="op" id="5786693">.</span><span class="ident" id="5786694">Unlock</span><span class="op" id="5786700">(</span><span class="op" id="5786701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5786704">return</span>&nbsp;<span class="ident" id="5786711">resp</span><br>
<span class="lineno"></span><span class="op" id="5786716">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5786719">func</span>&nbsp;<span class="op" id="5786724">(</span><span class="ident" id="5786725">server</span>&nbsp;<span class="op" id="5786732">*</span><span class="ident" id="5786733">Server</span><span class="op" id="5786739">)</span>&nbsp;<span class="ident" id="5786741">freeResponse</span><span class="op" id="5786753">(</span><span class="ident" id="5786754">resp</span>&nbsp;<span class="op" id="5786759">*</span><span class="ident" id="5786760">Response</span><span class="op" id="5786768">)</span>&nbsp;<span class="op" id="5786770">{</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5786773">server</span><span class="op" id="5786779">.</span><span class="ident" id="5786780">respLock</span><span class="op" id="5786788">.</span><span class="ident" id="5786789">Lock</span><span class="op" id="5786793">(</span><span class="op" id="5786794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5786797">resp</span><span class="op" id="5786801">.</span><span class="ident" id="5786802">next</span>&nbsp;<span class="op" id="5786807">=</span>&nbsp;<span class="ident" id="5786809">server</span><span class="op" id="5786815">.</span><span class="ident" id="5786816">freeResp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5786826">server</span><span class="op" id="5786832">.</span><span class="ident" id="5786833">freeResp</span>&nbsp;<span class="op" id="5786842">=</span>&nbsp;<span class="ident" id="5786844">resp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5786850">server</span><span class="op" id="5786856">.</span><span class="ident" id="5786857">respLock</span><span class="op" id="5786865">.</span><span class="ident" id="5786866">Unlock</span><span class="op" id="5786872">(</span><span class="op" id="5786873">)</span><br>
<span class="lineno"></span><span class="op" id="5786875">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span><span class="keyword" id="5786878">func</span>&nbsp;<span class="op" id="5786883">(</span><span class="ident" id="5786884">server</span>&nbsp;<span class="op" id="5786891">*</span><span class="ident" id="5786892">Server</span><span class="op" id="5786898">)</span>&nbsp;<span class="ident" id="5786900">readRequest</span><span class="op" id="5786911">(</span><span class="ident" id="5786912">codec</span>&nbsp;<span class="ident" id="5786918">ServerCodec</span><span class="op" id="5786929">)</span>&nbsp;<span class="op" id="5786931">(</span><span class="ident" id="5786932">service</span>&nbsp;<span class="op" id="5786940">*</span><span class="ident" id="5786941">service</span><span class="op" id="5786948">,</span>&nbsp;<span class="ident" id="5786950">mtype</span>&nbsp;<span class="op" id="5786956">*</span><span class="ident" id="5786957">methodType</span><span class="op" id="5786967">,</span>&nbsp;<span class="ident" id="5786969">req</span>&nbsp;<span class="op" id="5786973">*</span><span class="ident" id="5786974">Request</span><span class="op" id="5786981">,</span>&nbsp;<span class="ident" id="5786983">argv</span><span class="op" id="5786987">,</span>&nbsp;<span class="ident" id="5786989">replyv</span>&nbsp;<span class="ident" id="5786996">reflect</span><span class="op" id="5787003">.</span><span class="ident" id="5787004">Value</span><span class="op" id="5787009">,</span>&nbsp;<span class="ident" id="5787011">keepReading</span>&nbsp;<span class="builtintype" id="5787023">bool</span><span class="op" id="5787027">,</span>&nbsp;<span class="ident" id="5787029">err</span>&nbsp;<span class="builtintype" id="5787033">error</span><span class="op" id="5787038">)</span>&nbsp;<span class="op" id="5787040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5787043">service</span><span class="op" id="5787050">,</span>&nbsp;<span class="ident" id="5787052">mtype</span><span class="op" id="5787057">,</span>&nbsp;<span class="ident" id="5787059">req</span><span class="op" id="5787062">,</span>&nbsp;<span class="ident" id="5787064">keepReading</span><span class="op" id="5787075">,</span>&nbsp;<span class="ident" id="5787077">err</span>&nbsp;<span class="op" id="5787081">=</span>&nbsp;<span class="ident" id="5787083">server</span><span class="op" id="5787089">.</span><span class="ident" id="5787090">readRequestHeader</span><span class="op" id="5787107">(</span><span class="ident" id="5787108">codec</span><span class="op" id="5787113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5787116">if</span>&nbsp;<span class="ident" id="5787119">err</span>&nbsp;<span class="op" id="5787123">!=</span>&nbsp;<span class="ident" id="5787126">nil</span>&nbsp;<span class="op" id="5787130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5787134">if</span>&nbsp;<span class="op" id="5787137">!</span><span class="ident" id="5787138">keepReading</span>&nbsp;<span class="op" id="5787150">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5787155">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5787164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5787168">//&nbsp;discard&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5787186">codec</span><span class="op" id="5787191">.</span><span class="ident" id="5787192">ReadRequestBody</span><span class="op" id="5787207">(</span><span class="ident" id="5787208">nil</span><span class="op" id="5787211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5787215">return</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5787223">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5787227">//&nbsp;Decode&nbsp;the&nbsp;argument&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5787258">argIsValue</span>&nbsp;<span class="op" id="5787269">:=</span>&nbsp;<span class="builtintype" id="5787272">false</span>&nbsp;<span class="comment" id="5787278">//&nbsp;if&nbsp;true,&nbsp;need&nbsp;to&nbsp;indirect&nbsp;before&nbsp;calling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5787324">if</span>&nbsp;<span class="ident" id="5787327">mtype</span><span class="op" id="5787332">.</span><span class="ident" id="5787333">ArgType</span><span class="op" id="5787340">.</span><span class="ident" id="5787341">Kind</span><span class="op" id="5787345">(</span><span class="op" id="5787346">)</span>&nbsp;<span class="op" id="5787348">==</span>&nbsp;<span class="ident" id="5787351">reflect</span><span class="op" id="5787358">.</span><span class="ident" id="5787359">Ptr</span>&nbsp;<span class="op" id="5787363">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5787367">argv</span>&nbsp;<span class="op" id="5787372">=</span>&nbsp;<span class="ident" id="5787374">reflect</span><span class="op" id="5787381">.</span><span class="ident" id="5787382">New</span><span class="op" id="5787385">(</span><span class="ident" id="5787386">mtype</span><span class="op" id="5787391">.</span><span class="ident" id="5787392">ArgType</span><span class="op" id="5787399">.</span><span class="ident" id="5787400">Elem</span><span class="op" id="5787404">(</span><span class="op" id="5787405">)</span><span class="op" id="5787406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5787409">}</span>&nbsp;<span class="keyword" id="5787411">else</span>&nbsp;<span class="op" id="5787416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5787420">argv</span>&nbsp;<span class="op" id="5787425">=</span>&nbsp;<span class="ident" id="5787427">reflect</span><span class="op" id="5787434">.</span><span class="ident" id="5787435">New</span><span class="op" id="5787438">(</span><span class="ident" id="5787439">mtype</span><span class="op" id="5787444">.</span><span class="ident" id="5787445">ArgType</span><span class="op" id="5787452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5787456">argIsValue</span>&nbsp;<span class="op" id="5787467">=</span>&nbsp;<span class="builtintype" id="5787469">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5787475">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5787478">//&nbsp;argv&nbsp;guaranteed&nbsp;to&nbsp;be&nbsp;a&nbsp;pointer&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5787519">if</span>&nbsp;<span class="ident" id="5787522">err</span>&nbsp;<span class="op" id="5787526">=</span>&nbsp;<span class="ident" id="5787528">codec</span><span class="op" id="5787533">.</span><span class="ident" id="5787534">ReadRequestBody</span><span class="op" id="5787549">(</span><span class="ident" id="5787550">argv</span><span class="op" id="5787554">.</span><span class="ident" id="5787555">Interface</span><span class="op" id="5787564">(</span><span class="op" id="5787565">)</span><span class="op" id="5787566">)</span><span class="op" id="5787567">;</span>&nbsp;<span class="ident" id="5787569">err</span>&nbsp;<span class="op" id="5787573">!=</span>&nbsp;<span class="ident" id="5787576">nil</span>&nbsp;<span class="op" id="5787580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5787584">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5787592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5787595">if</span>&nbsp;<span class="ident" id="5787598">argIsValue</span>&nbsp;<span class="op" id="5787609">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5787613">argv</span>&nbsp;<span class="op" id="5787618">=</span>&nbsp;<span class="ident" id="5787620">argv</span><span class="op" id="5787624">.</span><span class="ident" id="5787625">Elem</span><span class="op" id="5787629">(</span><span class="op" id="5787630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5787633">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5787637">replyv</span>&nbsp;<span class="op" id="5787644">=</span>&nbsp;<span class="ident" id="5787646">reflect</span><span class="op" id="5787653">.</span><span class="ident" id="5787654">New</span><span class="op" id="5787657">(</span><span class="ident" id="5787658">mtype</span><span class="op" id="5787663">.</span><span class="ident" id="5787664">ReplyType</span><span class="op" id="5787673">.</span><span class="ident" id="5787674">Elem</span><span class="op" id="5787678">(</span><span class="op" id="5787679">)</span><span class="op" id="5787680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5787683">return</span><br>
<span class="lineno">570</span><span class="op" id="5787690">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5787693">func</span>&nbsp;<span class="op" id="5787698">(</span><span class="ident" id="5787699">server</span>&nbsp;<span class="op" id="5787706">*</span><span class="ident" id="5787707">Server</span><span class="op" id="5787713">)</span>&nbsp;<span class="ident" id="5787715">readRequestHeader</span><span class="op" id="5787732">(</span><span class="ident" id="5787733">codec</span>&nbsp;<span class="ident" id="5787739">ServerCodec</span><span class="op" id="5787750">)</span>&nbsp;<span class="op" id="5787752">(</span><span class="ident" id="5787753">service</span>&nbsp;<span class="op" id="5787761">*</span><span class="ident" id="5787762">service</span><span class="op" id="5787769">,</span>&nbsp;<span class="ident" id="5787771">mtype</span>&nbsp;<span class="op" id="5787777">*</span><span class="ident" id="5787778">methodType</span><span class="op" id="5787788">,</span>&nbsp;<span class="ident" id="5787790">req</span>&nbsp;<span class="op" id="5787794">*</span><span class="ident" id="5787795">Request</span><span class="op" id="5787802">,</span>&nbsp;<span class="ident" id="5787804">keepReading</span>&nbsp;<span class="builtintype" id="5787816">bool</span><span class="op" id="5787820">,</span>&nbsp;<span class="ident" id="5787822">err</span>&nbsp;<span class="builtintype" id="5787826">error</span><span class="op" id="5787831">)</span>&nbsp;<span class="op" id="5787833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5787836">//&nbsp;Grab&nbsp;the&nbsp;request&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5787865">req</span>&nbsp;<span class="op" id="5787869">=</span>&nbsp;<span class="ident" id="5787871">server</span><span class="op" id="5787877">.</span><span class="ident" id="5787878">getRequest</span><span class="op" id="5787888">(</span><span class="op" id="5787889">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5787892">err</span>&nbsp;<span class="op" id="5787896">=</span>&nbsp;<span class="ident" id="5787898">codec</span><span class="op" id="5787903">.</span><span class="ident" id="5787904">ReadRequestHeader</span><span class="op" id="5787921">(</span><span class="ident" id="5787922">req</span><span class="op" id="5787925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5787928">if</span>&nbsp;<span class="ident" id="5787931">err</span>&nbsp;<span class="op" id="5787935">!=</span>&nbsp;<span class="ident" id="5787938">nil</span>&nbsp;<span class="op" id="5787942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5787946">req</span>&nbsp;<span class="op" id="5787950">=</span>&nbsp;<span class="ident" id="5787952">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5787958">if</span>&nbsp;<span class="ident" id="5787961">err</span>&nbsp;<span class="op" id="5787965">==</span>&nbsp;<span class="ident" id="5787968">io</span><span class="op" id="5787970">.</span><span class="ident" id="5787971">EOF</span>&nbsp;<span class="op" id="5787975">||</span>&nbsp;<span class="ident" id="5787978">err</span>&nbsp;<span class="op" id="5787982">==</span>&nbsp;<span class="ident" id="5787985">io</span><span class="op" id="5787987">.</span><span class="ident" id="5787988">ErrUnexpectedEOF</span>&nbsp;<span class="op" id="5788005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5788010">return</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5788019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5788023">err</span>&nbsp;<span class="op" id="5788027">=</span>&nbsp;<span class="ident" id="5788029">errors</span><span class="op" id="5788035">.</span><span class="ident" id="5788036">New</span><span class="op" id="5788039">(</span><span class="string" id="5788040">&#34;rpc:&nbsp;server&nbsp;cannot&nbsp;decode&nbsp;request:&nbsp;&#34;</span>&nbsp;<span class="op" id="5788078">+</span>&nbsp;<span class="ident" id="5788080">err</span><span class="op" id="5788083">.</span><span class="ident" id="5788084">Error</span><span class="op" id="5788089">(</span><span class="op" id="5788090">)</span><span class="op" id="5788091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5788095">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5788103">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5788107">//&nbsp;We&nbsp;read&nbsp;the&nbsp;header&nbsp;successfully.&nbsp;&nbsp;If&nbsp;we&nbsp;see&nbsp;an&nbsp;error&nbsp;now,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5788169">//&nbsp;we&nbsp;can&nbsp;still&nbsp;recover&nbsp;and&nbsp;move&nbsp;on&nbsp;to&nbsp;the&nbsp;next&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5788227">keepReading</span>&nbsp;<span class="op" id="5788239">=</span>&nbsp;<span class="builtintype" id="5788241">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5788248">dot</span>&nbsp;<span class="op" id="5788252">:=</span>&nbsp;<span class="ident" id="5788255">strings</span><span class="op" id="5788262">.</span><span class="ident" id="5788263">LastIndex</span><span class="op" id="5788272">(</span><span class="ident" id="5788273">req</span><span class="op" id="5788276">.</span><span class="ident" id="5788277">ServiceMethod</span><span class="op" id="5788290">,</span>&nbsp;<span class="string" id="5788292">&#34;.&#34;</span><span class="op" id="5788295">)</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5788298">if</span>&nbsp;<span class="ident" id="5788301">dot</span>&nbsp;<span class="op" id="5788305">&lt;</span>&nbsp;<span class="num" id="5788307">0</span>&nbsp;<span class="op" id="5788309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5788313">err</span>&nbsp;<span class="op" id="5788317">=</span>&nbsp;<span class="ident" id="5788319">errors</span><span class="op" id="5788325">.</span><span class="ident" id="5788326">New</span><span class="op" id="5788329">(</span><span class="string" id="5788330">&#34;rpc:&nbsp;service/method&nbsp;request&nbsp;ill-formed:&nbsp;&#34;</span>&nbsp;<span class="op" id="5788373">+</span>&nbsp;<span class="ident" id="5788375">req</span><span class="op" id="5788378">.</span><span class="ident" id="5788379">ServiceMethod</span><span class="op" id="5788392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5788396">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5788404">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5788407">serviceName</span>&nbsp;<span class="op" id="5788419">:=</span>&nbsp;<span class="ident" id="5788422">req</span><span class="op" id="5788425">.</span><span class="ident" id="5788426">ServiceMethod</span><span class="op" id="5788439">[</span><span class="op" id="5788440">:</span><span class="ident" id="5788441">dot</span><span class="op" id="5788444">]</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5788447">methodName</span>&nbsp;<span class="op" id="5788458">:=</span>&nbsp;<span class="ident" id="5788461">req</span><span class="op" id="5788464">.</span><span class="ident" id="5788465">ServiceMethod</span><span class="op" id="5788478">[</span><span class="ident" id="5788479">dot</span><span class="op" id="5788482">+</span><span class="num" id="5788483">1</span><span class="op" id="5788484">:</span><span class="op" id="5788485">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5788489">//&nbsp;Look&nbsp;up&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5788514">server</span><span class="op" id="5788520">.</span><span class="ident" id="5788521">mu</span><span class="op" id="5788523">.</span><span class="ident" id="5788524">RLock</span><span class="op" id="5788529">(</span><span class="op" id="5788530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5788533">service</span>&nbsp;<span class="op" id="5788541">=</span>&nbsp;<span class="ident" id="5788543">server</span><span class="op" id="5788549">.</span><span class="ident" id="5788550">serviceMap</span><span class="op" id="5788560">[</span><span class="ident" id="5788561">serviceName</span><span class="op" id="5788572">]</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5788575">server</span><span class="op" id="5788581">.</span><span class="ident" id="5788582">mu</span><span class="op" id="5788584">.</span><span class="ident" id="5788585">RUnlock</span><span class="op" id="5788592">(</span><span class="op" id="5788593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5788596">if</span>&nbsp;<span class="ident" id="5788599">service</span>&nbsp;<span class="op" id="5788607">==</span>&nbsp;<span class="ident" id="5788610">nil</span>&nbsp;<span class="op" id="5788614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5788618">err</span>&nbsp;<span class="op" id="5788622">=</span>&nbsp;<span class="ident" id="5788624">errors</span><span class="op" id="5788630">.</span><span class="ident" id="5788631">New</span><span class="op" id="5788634">(</span><span class="string" id="5788635">&#34;rpc:&nbsp;can&#39;t&nbsp;find&nbsp;service&nbsp;&#34;</span>&nbsp;<span class="op" id="5788662">+</span>&nbsp;<span class="ident" id="5788664">req</span><span class="op" id="5788667">.</span><span class="ident" id="5788668">ServiceMethod</span><span class="op" id="5788681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5788685">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5788693">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5788696">mtype</span>&nbsp;<span class="op" id="5788702">=</span>&nbsp;<span class="ident" id="5788704">service</span><span class="op" id="5788711">.</span><span class="ident" id="5788712">method</span><span class="op" id="5788718">[</span><span class="ident" id="5788719">methodName</span><span class="op" id="5788729">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5788732">if</span>&nbsp;<span class="ident" id="5788735">mtype</span>&nbsp;<span class="op" id="5788741">==</span>&nbsp;<span class="ident" id="5788744">nil</span>&nbsp;<span class="op" id="5788748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5788752">err</span>&nbsp;<span class="op" id="5788756">=</span>&nbsp;<span class="ident" id="5788758">errors</span><span class="op" id="5788764">.</span><span class="ident" id="5788765">New</span><span class="op" id="5788768">(</span><span class="string" id="5788769">&#34;rpc:&nbsp;can&#39;t&nbsp;find&nbsp;method&nbsp;&#34;</span>&nbsp;<span class="op" id="5788795">+</span>&nbsp;<span class="ident" id="5788797">req</span><span class="op" id="5788800">.</span><span class="ident" id="5788801">ServiceMethod</span><span class="op" id="5788814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5788817">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5788820">return</span><br>
<span class="lineno">610</span><span class="op" id="5788827">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5788830">//&nbsp;Accept&nbsp;accepts&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;and&nbsp;serves&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="5788896">//&nbsp;for&nbsp;each&nbsp;incoming&nbsp;connection.&nbsp;&nbsp;Accept&nbsp;blocks;&nbsp;the&nbsp;caller&nbsp;typically</span><br>
<span class="lineno"></span><span class="comment" id="5788966">//&nbsp;invokes&nbsp;it&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno">615</span><span class="keyword" id="5788999">func</span>&nbsp;<span class="op" id="5789004">(</span><span class="ident" id="5789005">server</span>&nbsp;<span class="op" id="5789012">*</span><span class="ident" id="5789013">Server</span><span class="op" id="5789019">)</span>&nbsp;<span class="ident" id="5789021">Accept</span><span class="op" id="5789027">(</span><span class="ident" id="5789028">lis</span>&nbsp;<span class="ident" id="5789032">net</span><span class="op" id="5789035">.</span><span class="ident" id="5789036">Listener</span><span class="op" id="5789044">)</span>&nbsp;<span class="op" id="5789046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5789049">for</span>&nbsp;<span class="op" id="5789053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5789057">conn</span><span class="op" id="5789061">,</span>&nbsp;<span class="ident" id="5789063">err</span>&nbsp;<span class="op" id="5789067">:=</span>&nbsp;<span class="ident" id="5789070">lis</span><span class="op" id="5789073">.</span><span class="ident" id="5789074">Accept</span><span class="op" id="5789080">(</span><span class="op" id="5789081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5789085">if</span>&nbsp;<span class="ident" id="5789088">err</span>&nbsp;<span class="op" id="5789092">!=</span>&nbsp;<span class="ident" id="5789095">nil</span>&nbsp;<span class="op" id="5789099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5789104">log</span><span class="op" id="5789107">.</span><span class="ident" id="5789108">Fatal</span><span class="op" id="5789113">(</span><span class="string" id="5789114">&#34;rpc.Serve:&nbsp;accept:&#34;</span><span class="op" id="5789134">,</span>&nbsp;<span class="ident" id="5789136">err</span><span class="op" id="5789139">.</span><span class="ident" id="5789140">Error</span><span class="op" id="5789145">(</span><span class="op" id="5789146">)</span><span class="op" id="5789147">)</span>&nbsp;<span class="comment" id="5789149">//&nbsp;TODO(r):&nbsp;exit?</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5789169">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5789173">go</span>&nbsp;<span class="ident" id="5789176">server</span><span class="op" id="5789182">.</span><span class="ident" id="5789183">ServeConn</span><span class="op" id="5789192">(</span><span class="ident" id="5789193">conn</span><span class="op" id="5789197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5789200">}</span><br>
<span class="lineno"></span><span class="op" id="5789202">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">625</span><span class="comment" id="5789205">//&nbsp;Register&nbsp;publishes&nbsp;the&nbsp;receiver&#39;s&nbsp;methods&nbsp;in&nbsp;the&nbsp;DefaultServer.</span><br>
<span class="lineno"></span><span class="keyword" id="5789272">func</span>&nbsp;<span class="ident" id="5789277">Register</span><span class="op" id="5789285">(</span><span class="ident" id="5789286">rcvr</span>&nbsp;<span class="keyword" id="5789291">interface</span><span class="op" id="5789300">{</span><span class="op" id="5789301">}</span><span class="op" id="5789302">)</span>&nbsp;<span class="builtintype" id="5789304">error</span>&nbsp;<span class="op" id="5789310">{</span>&nbsp;<span class="keyword" id="5789312">return</span>&nbsp;<span class="ident" id="5789319">DefaultServer</span><span class="op" id="5789332">.</span><span class="ident" id="5789333">Register</span><span class="op" id="5789341">(</span><span class="ident" id="5789342">rcvr</span><span class="op" id="5789346">)</span>&nbsp;<span class="op" id="5789348">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5789351">//&nbsp;RegisterName&nbsp;is&nbsp;like&nbsp;Register&nbsp;but&nbsp;uses&nbsp;the&nbsp;provided&nbsp;name&nbsp;for&nbsp;the&nbsp;type</span><br>
<span class="lineno"></span><span class="comment" id="5789424">//&nbsp;instead&nbsp;of&nbsp;the&nbsp;receiver&#39;s&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno">630</span><span class="keyword" id="5789468">func</span>&nbsp;<span class="ident" id="5789473">RegisterName</span><span class="op" id="5789485">(</span><span class="ident" id="5789486">name</span>&nbsp;<span class="builtintype" id="5789491">string</span><span class="op" id="5789497">,</span>&nbsp;<span class="ident" id="5789499">rcvr</span>&nbsp;<span class="keyword" id="5789504">interface</span><span class="op" id="5789513">{</span><span class="op" id="5789514">}</span><span class="op" id="5789515">)</span>&nbsp;<span class="builtintype" id="5789517">error</span>&nbsp;<span class="op" id="5789523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5789526">return</span>&nbsp;<span class="ident" id="5789533">DefaultServer</span><span class="op" id="5789546">.</span><span class="ident" id="5789547">RegisterName</span><span class="op" id="5789559">(</span><span class="ident" id="5789560">name</span><span class="op" id="5789564">,</span>&nbsp;<span class="ident" id="5789566">rcvr</span><span class="op" id="5789570">)</span><br>
<span class="lineno"></span><span class="op" id="5789572">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5789575">//&nbsp;A&nbsp;ServerCodec&nbsp;implements&nbsp;reading&nbsp;of&nbsp;RPC&nbsp;requests&nbsp;and&nbsp;writing&nbsp;of</span><br>
<span class="lineno">635</span><span class="comment" id="5789642">//&nbsp;RPC&nbsp;responses&nbsp;for&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;RPC&nbsp;session.</span><br>
<span class="lineno"></span><span class="comment" id="5789698">//&nbsp;The&nbsp;server&nbsp;calls&nbsp;ReadRequestHeader&nbsp;and&nbsp;ReadRequestBody&nbsp;in&nbsp;pairs</span><br>
<span class="lineno"></span><span class="comment" id="5789765">//&nbsp;to&nbsp;read&nbsp;requests&nbsp;from&nbsp;the&nbsp;connection,&nbsp;and&nbsp;it&nbsp;calls&nbsp;WriteResponse&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5789836">//&nbsp;write&nbsp;a&nbsp;response&nbsp;back.&nbsp;&nbsp;The&nbsp;server&nbsp;calls&nbsp;Close&nbsp;when&nbsp;finished&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5789909">//&nbsp;connection.&nbsp;ReadRequestBody&nbsp;may&nbsp;be&nbsp;called&nbsp;with&nbsp;a&nbsp;nil</span><br>
<span class="lineno">640</span><span class="comment" id="5789965">//&nbsp;argument&nbsp;to&nbsp;force&nbsp;the&nbsp;body&nbsp;of&nbsp;the&nbsp;request&nbsp;to&nbsp;be&nbsp;read&nbsp;and&nbsp;discarded.</span><br>
<span class="lineno"></span><span class="keyword" id="5790036">type</span>&nbsp;<span class="ident" id="5790041">ServerCodec</span>&nbsp;<span class="keyword" id="5790053">interface</span>&nbsp;<span class="op" id="5790063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5790066">ReadRequestHeader</span><span class="op" id="5790083">(</span><span class="op" id="5790084">*</span><span class="ident" id="5790085">Request</span><span class="op" id="5790092">)</span>&nbsp;<span class="builtintype" id="5790094">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5790101">ReadRequestBody</span><span class="op" id="5790116">(</span><span class="keyword" id="5790117">interface</span><span class="op" id="5790126">{</span><span class="op" id="5790127">}</span><span class="op" id="5790128">)</span>&nbsp;<span class="builtintype" id="5790130">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5790137">//&nbsp;WriteResponse&nbsp;must&nbsp;be&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5790211">WriteResponse</span><span class="op" id="5790224">(</span><span class="op" id="5790225">*</span><span class="ident" id="5790226">Response</span><span class="op" id="5790234">,</span>&nbsp;<span class="keyword" id="5790236">interface</span><span class="op" id="5790245">{</span><span class="op" id="5790246">}</span><span class="op" id="5790247">)</span>&nbsp;<span class="builtintype" id="5790249">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5790257">Close</span><span class="op" id="5790262">(</span><span class="op" id="5790263">)</span>&nbsp;<span class="builtintype" id="5790265">error</span><br>
<span class="lineno"></span><span class="op" id="5790271">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span><span class="comment" id="5790274">//&nbsp;ServeConn&nbsp;runs&nbsp;the&nbsp;DefaultServer&nbsp;on&nbsp;a&nbsp;single&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="5790334">//&nbsp;ServeConn&nbsp;blocks,&nbsp;serving&nbsp;the&nbsp;connection&nbsp;until&nbsp;the&nbsp;client&nbsp;hangs&nbsp;up.</span><br>
<span class="lineno"></span><span class="comment" id="5790405">//&nbsp;The&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;ServeConn&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="comment" id="5790466">//&nbsp;ServeConn&nbsp;uses&nbsp;the&nbsp;gob&nbsp;wire&nbsp;format&nbsp;(see&nbsp;package&nbsp;gob)&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5790529">//&nbsp;connection.&nbsp;&nbsp;To&nbsp;use&nbsp;an&nbsp;alternate&nbsp;codec,&nbsp;use&nbsp;ServeCodec.</span><br>
<span class="lineno">655</span><span class="keyword" id="5790588">func</span>&nbsp;<span class="ident" id="5790593">ServeConn</span><span class="op" id="5790602">(</span><span class="ident" id="5790603">conn</span>&nbsp;<span class="ident" id="5790608">io</span><span class="op" id="5790610">.</span><span class="ident" id="5790611">ReadWriteCloser</span><span class="op" id="5790626">)</span>&nbsp;<span class="op" id="5790628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5790631">DefaultServer</span><span class="op" id="5790644">.</span><span class="ident" id="5790645">ServeConn</span><span class="op" id="5790654">(</span><span class="ident" id="5790655">conn</span><span class="op" id="5790659">)</span><br>
<span class="lineno"></span><span class="op" id="5790661">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5790664">//&nbsp;ServeCodec&nbsp;is&nbsp;like&nbsp;ServeConn&nbsp;but&nbsp;uses&nbsp;the&nbsp;specified&nbsp;codec&nbsp;to</span><br>
<span class="lineno">660</span><span class="comment" id="5790728">//&nbsp;decode&nbsp;requests&nbsp;and&nbsp;encode&nbsp;responses.</span><br>
<span class="lineno"></span><span class="keyword" id="5790769">func</span>&nbsp;<span class="ident" id="5790774">ServeCodec</span><span class="op" id="5790784">(</span><span class="ident" id="5790785">codec</span>&nbsp;<span class="ident" id="5790791">ServerCodec</span><span class="op" id="5790802">)</span>&nbsp;<span class="op" id="5790804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5790807">DefaultServer</span><span class="op" id="5790820">.</span><span class="ident" id="5790821">ServeCodec</span><span class="op" id="5790831">(</span><span class="ident" id="5790832">codec</span><span class="op" id="5790837">)</span><br>
<span class="lineno"></span><span class="op" id="5790839">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span><span class="comment" id="5790842">//&nbsp;ServeRequest&nbsp;is&nbsp;like&nbsp;ServeCodec&nbsp;but&nbsp;synchronously&nbsp;serves&nbsp;a&nbsp;single&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="5790920">//&nbsp;It&nbsp;does&nbsp;not&nbsp;close&nbsp;the&nbsp;codec&nbsp;upon&nbsp;completion.</span><br>
<span class="lineno"></span><span class="keyword" id="5790968">func</span>&nbsp;<span class="ident" id="5790973">ServeRequest</span><span class="op" id="5790985">(</span><span class="ident" id="5790986">codec</span>&nbsp;<span class="ident" id="5790992">ServerCodec</span><span class="op" id="5791003">)</span>&nbsp;<span class="builtintype" id="5791005">error</span>&nbsp;<span class="op" id="5791011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5791014">return</span>&nbsp;<span class="ident" id="5791021">DefaultServer</span><span class="op" id="5791034">.</span><span class="ident" id="5791035">ServeRequest</span><span class="op" id="5791047">(</span><span class="ident" id="5791048">codec</span><span class="op" id="5791053">)</span><br>
<span class="lineno"></span><span class="op" id="5791055">}</span><br>
<span class="lineno">670</span><br>
<span class="lineno"></span><span class="comment" id="5791058">//&nbsp;Accept&nbsp;accepts&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;and&nbsp;serves&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="5791124">//&nbsp;to&nbsp;DefaultServer&nbsp;for&nbsp;each&nbsp;incoming&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="5791174">//&nbsp;Accept&nbsp;blocks;&nbsp;the&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;it&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5791243">func</span>&nbsp;<span class="ident" id="5791248">Accept</span><span class="op" id="5791254">(</span><span class="ident" id="5791255">lis</span>&nbsp;<span class="ident" id="5791259">net</span><span class="op" id="5791262">.</span><span class="ident" id="5791263">Listener</span><span class="op" id="5791271">)</span>&nbsp;<span class="op" id="5791273">{</span>&nbsp;<span class="ident" id="5791275">DefaultServer</span><span class="op" id="5791288">.</span><span class="ident" id="5791289">Accept</span><span class="op" id="5791295">(</span><span class="ident" id="5791296">lis</span><span class="op" id="5791299">)</span>&nbsp;<span class="op" id="5791301">}</span><br>
<span class="lineno">675</span><br>
<span class="lineno"></span><span class="comment" id="5791304">//&nbsp;Can&nbsp;connect&nbsp;to&nbsp;RPC&nbsp;service&nbsp;using&nbsp;HTTP&nbsp;CONNECT&nbsp;to&nbsp;rpcPath.</span><br>
<span class="lineno"></span><span class="keyword" id="5791365">var</span>&nbsp;<span class="ident" id="5791369">connected</span>&nbsp;<span class="op" id="5791379">=</span>&nbsp;<span class="string" id="5791381">&#34;200&nbsp;Connected&nbsp;to&nbsp;Go&nbsp;RPC&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5791408">//&nbsp;ServeHTTP&nbsp;implements&nbsp;an&nbsp;http.Handler&nbsp;that&nbsp;answers&nbsp;RPC&nbsp;requests.</span><br>
<span class="lineno">680</span><span class="keyword" id="5791475">func</span>&nbsp;<span class="op" id="5791480">(</span><span class="ident" id="5791481">server</span>&nbsp;<span class="op" id="5791488">*</span><span class="ident" id="5791489">Server</span><span class="op" id="5791495">)</span>&nbsp;<span class="ident" id="5791497">ServeHTTP</span><span class="op" id="5791506">(</span><span class="ident" id="5791507">w</span>&nbsp;<span class="ident" id="5791509">http</span><span class="op" id="5791513">.</span><span class="ident" id="5791514">ResponseWriter</span><span class="op" id="5791528">,</span>&nbsp;<span class="ident" id="5791530">req</span>&nbsp;<span class="op" id="5791534">*</span><span class="ident" id="5791535">http</span><span class="op" id="5791539">.</span><span class="ident" id="5791540">Request</span><span class="op" id="5791547">)</span>&nbsp;<span class="op" id="5791549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5791552">if</span>&nbsp;<span class="ident" id="5791555">req</span><span class="op" id="5791558">.</span><span class="ident" id="5791559">Method</span>&nbsp;<span class="op" id="5791566">!=</span>&nbsp;<span class="string" id="5791569">&#34;CONNECT&#34;</span>&nbsp;<span class="op" id="5791579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5791583">w</span><span class="op" id="5791584">.</span><span class="ident" id="5791585">Header</span><span class="op" id="5791591">(</span><span class="op" id="5791592">)</span><span class="op" id="5791593">.</span><span class="ident" id="5791594">Set</span><span class="op" id="5791597">(</span><span class="string" id="5791598">&#34;Content-Type&#34;</span><span class="op" id="5791612">,</span>&nbsp;<span class="string" id="5791614">&#34;text/plain;&nbsp;charset=utf-8&#34;</span><span class="op" id="5791641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5791645">w</span><span class="op" id="5791646">.</span><span class="ident" id="5791647">WriteHeader</span><span class="op" id="5791658">(</span><span class="ident" id="5791659">http</span><span class="op" id="5791663">.</span><span class="ident" id="5791664">StatusMethodNotAllowed</span><span class="op" id="5791686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5791690">io</span><span class="op" id="5791692">.</span><span class="ident" id="5791693">WriteString</span><span class="op" id="5791704">(</span><span class="ident" id="5791705">w</span><span class="op" id="5791706">,</span>&nbsp;<span class="string" id="5791708">&#34;405&nbsp;must&nbsp;CONNECT\n&#34;</span><span class="op" id="5791728">)</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5791732">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5791740">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5791743">conn</span><span class="op" id="5791747">,</span>&nbsp;<span class="ident" id="5791749">_</span><span class="op" id="5791750">,</span>&nbsp;<span class="ident" id="5791752">err</span>&nbsp;<span class="op" id="5791756">:=</span>&nbsp;<span class="ident" id="5791759">w</span><span class="op" id="5791760">.</span><span class="op" id="5791761">(</span><span class="ident" id="5791762">http</span><span class="op" id="5791766">.</span><span class="ident" id="5791767">Hijacker</span><span class="op" id="5791775">)</span><span class="op" id="5791776">.</span><span class="ident" id="5791777">Hijack</span><span class="op" id="5791783">(</span><span class="op" id="5791784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5791787">if</span>&nbsp;<span class="ident" id="5791790">err</span>&nbsp;<span class="op" id="5791794">!=</span>&nbsp;<span class="ident" id="5791797">nil</span>&nbsp;<span class="op" id="5791801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5791805">log</span><span class="op" id="5791808">.</span><span class="ident" id="5791809">Print</span><span class="op" id="5791814">(</span><span class="string" id="5791815">&#34;rpc&nbsp;hijacking&nbsp;&#34;</span><span class="op" id="5791831">,</span>&nbsp;<span class="ident" id="5791833">req</span><span class="op" id="5791836">.</span><span class="ident" id="5791837">RemoteAddr</span><span class="op" id="5791847">,</span>&nbsp;<span class="string" id="5791849">&#34;:&nbsp;&#34;</span><span class="op" id="5791853">,</span>&nbsp;<span class="ident" id="5791855">err</span><span class="op" id="5791858">.</span><span class="ident" id="5791859">Error</span><span class="op" id="5791864">(</span><span class="op" id="5791865">)</span><span class="op" id="5791866">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5791870">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5791878">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5791881">io</span><span class="op" id="5791883">.</span><span class="ident" id="5791884">WriteString</span><span class="op" id="5791895">(</span><span class="ident" id="5791896">conn</span><span class="op" id="5791900">,</span>&nbsp;<span class="string" id="5791902">&#34;HTTP/1.0&nbsp;&#34;</span><span class="op" id="5791913">+</span><span class="ident" id="5791914">connected</span><span class="op" id="5791923">+</span><span class="string" id="5791924">&#34;\n\n&#34;</span><span class="op" id="5791930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5791933">server</span><span class="op" id="5791939">.</span><span class="ident" id="5791940">ServeConn</span><span class="op" id="5791949">(</span><span class="ident" id="5791950">conn</span><span class="op" id="5791954">)</span><br>
<span class="lineno"></span><span class="op" id="5791956">}</span><br>
<span class="lineno">695</span><br>
<span class="lineno"></span><span class="comment" id="5791959">//&nbsp;HandleHTTP&nbsp;registers&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;for&nbsp;RPC&nbsp;messages&nbsp;on&nbsp;rpcPath,</span><br>
<span class="lineno"></span><span class="comment" id="5792028">//&nbsp;and&nbsp;a&nbsp;debugging&nbsp;handler&nbsp;on&nbsp;debugPath.</span><br>
<span class="lineno"></span><span class="comment" id="5792069">//&nbsp;It&nbsp;is&nbsp;still&nbsp;necessary&nbsp;to&nbsp;invoke&nbsp;http.Serve(),&nbsp;typically&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5792147">func</span>&nbsp;<span class="op" id="5792152">(</span><span class="ident" id="5792153">server</span>&nbsp;<span class="op" id="5792160">*</span><span class="ident" id="5792161">Server</span><span class="op" id="5792167">)</span>&nbsp;<span class="ident" id="5792169">HandleHTTP</span><span class="op" id="5792179">(</span><span class="ident" id="5792180">rpcPath</span><span class="op" id="5792187">,</span>&nbsp;<span class="ident" id="5792189">debugPath</span>&nbsp;<span class="builtintype" id="5792199">string</span><span class="op" id="5792205">)</span>&nbsp;<span class="op" id="5792207">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5792210">http</span><span class="op" id="5792214">.</span><span class="ident" id="5792215">Handle</span><span class="op" id="5792221">(</span><span class="ident" id="5792222">rpcPath</span><span class="op" id="5792229">,</span>&nbsp;<span class="ident" id="5792231">server</span><span class="op" id="5792237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5792240">http</span><span class="op" id="5792244">.</span><span class="ident" id="5792245">Handle</span><span class="op" id="5792251">(</span><span class="ident" id="5792252">debugPath</span><span class="op" id="5792261">,</span>&nbsp;<span class="ident" id="5792263">debugHTTP</span><span class="op" id="5792272">{</span><span class="ident" id="5792273">server</span><span class="op" id="5792279">}</span><span class="op" id="5792280">)</span><br>
<span class="lineno"></span><span class="op" id="5792282">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5792285">//&nbsp;HandleHTTP&nbsp;registers&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;for&nbsp;RPC&nbsp;messages&nbsp;to&nbsp;DefaultServer</span><br>
<span class="lineno">705</span><span class="comment" id="5792359">//&nbsp;on&nbsp;DefaultRPCPath&nbsp;and&nbsp;a&nbsp;debugging&nbsp;handler&nbsp;on&nbsp;DefaultDebugPath.</span><br>
<span class="lineno"></span><span class="comment" id="5792425">//&nbsp;It&nbsp;is&nbsp;still&nbsp;necessary&nbsp;to&nbsp;invoke&nbsp;http.Serve(),&nbsp;typically&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5792503">func</span>&nbsp;<span class="ident" id="5792508">HandleHTTP</span><span class="op" id="5792518">(</span><span class="op" id="5792519">)</span>&nbsp;<span class="op" id="5792521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5792524">DefaultServer</span><span class="op" id="5792537">.</span><span class="ident" id="5792538">HandleHTTP</span><span class="op" id="5792548">(</span><span class="ident" id="5792549">DefaultRPCPath</span><span class="op" id="5792563">,</span>&nbsp;<span class="ident" id="5792565">DefaultDebugPath</span><span class="op" id="5792581">)</span><br>
<span class="lineno"></span><span class="op" id="5792583">}</span>
</div>
</body>
</html>
