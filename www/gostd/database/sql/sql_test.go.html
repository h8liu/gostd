<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>database/sql</h2>
<ul>
<li><a href="/gostd/database/sql/convert.go.html">convert.go</a></li>
<li><a href="/gostd/database/sql/convert_test.go.html">convert_test.go</a></li>
<li><a href="/gostd/database/sql/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/database/sql/fakedb_test.go.html">fakedb_test.go</a></li>
<li><a href="/gostd/database/sql/sql.go.html">sql.go</a></li>
<li><a href="/gostd/database/sql/sql_test.go.html" class="current">sql_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6887393">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6887448">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6887502">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6887553">package</span>&nbsp;<span class="ident" id="6887561">sql</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6887566">import</span>&nbsp;<span class="op" id="6887573">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6887576">&#34;database/sql/driver&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6887599">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6887609">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6887616">&#34;math/rand&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6887629">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6887640">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6887651">&#34;strings&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6887662">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6887670">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6887681">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6887688">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="6887691">func</span>&nbsp;<span class="ident" id="6887696">init</span><span class="op" id="6887700">(</span><span class="op" id="6887701">)</span>&nbsp;<span class="op" id="6887703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6887706">type</span>&nbsp;<span class="ident" id="6887711">dbConn</span>&nbsp;<span class="keyword" id="6887718">struct</span>&nbsp;<span class="op" id="6887725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887729">db</span>&nbsp;<span class="op" id="6887732">*</span><span class="ident" id="6887733">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887738">c</span>&nbsp;&nbsp;<span class="op" id="6887741">*</span><span class="ident" id="6887742">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6887754">}</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887757">freedFrom</span>&nbsp;<span class="op" id="6887767">:=</span>&nbsp;<span class="builtinfunc" id="6887770">make</span><span class="op" id="6887774">(</span><span class="keyword" id="6887775">map</span><span class="op" id="6887778">[</span><span class="ident" id="6887779">dbConn</span><span class="op" id="6887785">]</span><span class="builtintype" id="6887786">string</span><span class="op" id="6887792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887795">putConnHook</span>&nbsp;<span class="op" id="6887807">=</span>&nbsp;<span class="keyword" id="6887809">func</span><span class="op" id="6887813">(</span><span class="ident" id="6887814">db</span>&nbsp;<span class="op" id="6887817">*</span><span class="ident" id="6887818">DB</span><span class="op" id="6887820">,</span>&nbsp;<span class="ident" id="6887822">c</span>&nbsp;<span class="op" id="6887824">*</span><span class="ident" id="6887825">driverConn</span><span class="op" id="6887835">)</span>&nbsp;<span class="op" id="6887837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887841">idx</span>&nbsp;<span class="op" id="6887845">:=</span>&nbsp;<span class="op" id="6887848">-</span><span class="num" id="6887849">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6887853">for</span>&nbsp;<span class="ident" id="6887857">i</span><span class="op" id="6887858">,</span>&nbsp;<span class="ident" id="6887860">v</span>&nbsp;<span class="op" id="6887862">:=</span>&nbsp;<span class="keyword" id="6887865">range</span>&nbsp;<span class="ident" id="6887871">db</span><span class="op" id="6887873">.</span><span class="ident" id="6887874">freeConn</span>&nbsp;<span class="op" id="6887883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6887888">if</span>&nbsp;<span class="ident" id="6887891">v</span>&nbsp;<span class="op" id="6887893">==</span>&nbsp;<span class="ident" id="6887896">c</span>&nbsp;<span class="op" id="6887898">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887904">idx</span>&nbsp;<span class="op" id="6887908">=</span>&nbsp;<span class="ident" id="6887910">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6887916">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6887925">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6887929">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6887933">if</span>&nbsp;<span class="ident" id="6887936">idx</span>&nbsp;<span class="op" id="6887940">&gt;=</span>&nbsp;<span class="num" id="6887943">0</span>&nbsp;<span class="op" id="6887945">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6887950">//&nbsp;print&nbsp;before&nbsp;panic,&nbsp;as&nbsp;panic&nbsp;may&nbsp;get&nbsp;lost&nbsp;due&nbsp;to&nbsp;conflicting&nbsp;panic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6888023">//&nbsp;(all&nbsp;goroutines&nbsp;asleep)&nbsp;elsewhere,&nbsp;since&nbsp;we&nbsp;might&nbsp;not&nbsp;unlock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6888090">//&nbsp;the&nbsp;mutex&nbsp;in&nbsp;freeConn&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6888124">println</span><span class="op" id="6888131">(</span><span class="string" id="6888132">&#34;double&nbsp;free&nbsp;of&nbsp;conn.&nbsp;conflicts&nbsp;are:\nA)&nbsp;&#34;</span>&nbsp;<span class="op" id="6888175">+</span>&nbsp;<span class="ident" id="6888177">freedFrom</span><span class="op" id="6888186">[</span><span class="ident" id="6888187">dbConn</span><span class="op" id="6888193">{</span><span class="ident" id="6888194">db</span><span class="op" id="6888196">,</span>&nbsp;<span class="ident" id="6888198">c</span><span class="op" id="6888199">}</span><span class="op" id="6888200">]</span>&nbsp;<span class="op" id="6888202">+</span>&nbsp;<span class="string" id="6888204">&#34;\n\nand\nB)&nbsp;&#34;</span>&nbsp;<span class="op" id="6888219">+</span>&nbsp;<span class="ident" id="6888221">stack</span><span class="op" id="6888226">(</span><span class="op" id="6888227">)</span><span class="op" id="6888228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6888233">panic</span><span class="op" id="6888238">(</span><span class="string" id="6888239">&#34;double&nbsp;free&nbsp;of&nbsp;conn.&#34;</span><span class="op" id="6888261">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6888265">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6888269">freedFrom</span><span class="op" id="6888278">[</span><span class="ident" id="6888279">dbConn</span><span class="op" id="6888285">{</span><span class="ident" id="6888286">db</span><span class="op" id="6888288">,</span>&nbsp;<span class="ident" id="6888290">c</span><span class="op" id="6888291">}</span><span class="op" id="6888292">]</span>&nbsp;<span class="op" id="6888294">=</span>&nbsp;<span class="ident" id="6888296">stack</span><span class="op" id="6888301">(</span><span class="op" id="6888302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6888305">}</span><br>
<span class="lineno"></span><span class="op" id="6888307">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword" id="6888310">const</span>&nbsp;<span class="ident" id="6888316">fakeDBName</span>&nbsp;<span class="op" id="6888327">=</span>&nbsp;<span class="string" id="6888329">&#34;foo&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6888336">var</span>&nbsp;<span class="ident" id="6888340">chrisBirthday</span>&nbsp;<span class="op" id="6888354">=</span>&nbsp;<span class="ident" id="6888356">time</span><span class="op" id="6888360">.</span><span class="ident" id="6888361">Unix</span><span class="op" id="6888365">(</span><span class="num" id="6888366">123456789</span><span class="op" id="6888375">,</span>&nbsp;<span class="num" id="6888377">0</span><span class="op" id="6888378">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6888381">func</span>&nbsp;<span class="ident" id="6888386">newTestDB</span><span class="op" id="6888395">(</span><span class="ident" id="6888396">t</span>&nbsp;<span class="ident" id="6888398">testing</span><span class="op" id="6888405">.</span><span class="ident" id="6888406">TB</span><span class="op" id="6888408">,</span>&nbsp;<span class="ident" id="6888410">name</span>&nbsp;<span class="builtintype" id="6888415">string</span><span class="op" id="6888421">)</span>&nbsp;<span class="op" id="6888423">*</span><span class="ident" id="6888424">DB</span>&nbsp;<span class="op" id="6888427">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6888430">db</span><span class="op" id="6888432">,</span>&nbsp;<span class="ident" id="6888434">err</span>&nbsp;<span class="op" id="6888438">:=</span>&nbsp;<span class="ident" id="6888441">Open</span><span class="op" id="6888445">(</span><span class="string" id="6888446">&#34;test&#34;</span><span class="op" id="6888452">,</span>&nbsp;<span class="ident" id="6888454">fakeDBName</span><span class="op" id="6888464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6888467">if</span>&nbsp;<span class="ident" id="6888470">err</span>&nbsp;<span class="op" id="6888474">!=</span>&nbsp;<span class="ident" id="6888477">nil</span>&nbsp;<span class="op" id="6888481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6888485">t</span><span class="op" id="6888486">.</span><span class="ident" id="6888487">Fatalf</span><span class="op" id="6888493">(</span><span class="string" id="6888494">&#34;Open:&nbsp;%v&#34;</span><span class="op" id="6888504">,</span>&nbsp;<span class="ident" id="6888506">err</span><span class="op" id="6888509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6888512">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6888515">if</span>&nbsp;<span class="ident" id="6888518">_</span><span class="op" id="6888519">,</span>&nbsp;<span class="ident" id="6888521">err</span>&nbsp;<span class="op" id="6888525">:=</span>&nbsp;<span class="ident" id="6888528">db</span><span class="op" id="6888530">.</span><span class="ident" id="6888531">Exec</span><span class="op" id="6888535">(</span><span class="string" id="6888536">&#34;WIPE&#34;</span><span class="op" id="6888542">)</span><span class="op" id="6888543">;</span>&nbsp;<span class="ident" id="6888545">err</span>&nbsp;<span class="op" id="6888549">!=</span>&nbsp;<span class="ident" id="6888552">nil</span>&nbsp;<span class="op" id="6888556">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6888560">t</span><span class="op" id="6888561">.</span><span class="ident" id="6888562">Fatalf</span><span class="op" id="6888568">(</span><span class="string" id="6888569">&#34;exec&nbsp;wipe:&nbsp;%v&#34;</span><span class="op" id="6888584">,</span>&nbsp;<span class="ident" id="6888586">err</span><span class="op" id="6888589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6888592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6888595">if</span>&nbsp;<span class="ident" id="6888598">name</span>&nbsp;<span class="op" id="6888603">==</span>&nbsp;<span class="string" id="6888606">&#34;people&#34;</span>&nbsp;<span class="op" id="6888615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6888619">exec</span><span class="op" id="6888623">(</span><span class="ident" id="6888624">t</span><span class="op" id="6888625">,</span>&nbsp;<span class="ident" id="6888627">db</span><span class="op" id="6888629">,</span>&nbsp;<span class="string" id="6888631">&#34;CREATE|people|name=string,age=int32,photo=blob,dead=bool,bdate=datetime&#34;</span><span class="op" id="6888704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6888708">exec</span><span class="op" id="6888712">(</span><span class="ident" id="6888713">t</span><span class="op" id="6888714">,</span>&nbsp;<span class="ident" id="6888716">db</span><span class="op" id="6888718">,</span>&nbsp;<span class="string" id="6888720">&#34;INSERT|people|name=Alice,age=?,photo=APHOTO&#34;</span><span class="op" id="6888765">,</span>&nbsp;<span class="num" id="6888767">1</span><span class="op" id="6888768">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6888772">exec</span><span class="op" id="6888776">(</span><span class="ident" id="6888777">t</span><span class="op" id="6888778">,</span>&nbsp;<span class="ident" id="6888780">db</span><span class="op" id="6888782">,</span>&nbsp;<span class="string" id="6888784">&#34;INSERT|people|name=Bob,age=?,photo=BPHOTO&#34;</span><span class="op" id="6888827">,</span>&nbsp;<span class="num" id="6888829">2</span><span class="op" id="6888830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6888834">exec</span><span class="op" id="6888838">(</span><span class="ident" id="6888839">t</span><span class="op" id="6888840">,</span>&nbsp;<span class="ident" id="6888842">db</span><span class="op" id="6888844">,</span>&nbsp;<span class="string" id="6888846">&#34;INSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="6888899">,</span>&nbsp;<span class="num" id="6888901">3</span><span class="op" id="6888902">,</span>&nbsp;<span class="ident" id="6888904">chrisBirthday</span><span class="op" id="6888917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6888920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6888923">if</span>&nbsp;<span class="ident" id="6888926">name</span>&nbsp;<span class="op" id="6888931">==</span>&nbsp;<span class="string" id="6888934">&#34;magicquery&#34;</span>&nbsp;<span class="op" id="6888947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6888951">//&nbsp;Magic&nbsp;table&nbsp;name&nbsp;and&nbsp;column,&nbsp;known&nbsp;by&nbsp;fakedb_test.go.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6889010">exec</span><span class="op" id="6889014">(</span><span class="ident" id="6889015">t</span><span class="op" id="6889016">,</span>&nbsp;<span class="ident" id="6889018">db</span><span class="op" id="6889020">,</span>&nbsp;<span class="string" id="6889022">&#34;CREATE|magicquery|op=string,millis=int32&#34;</span><span class="op" id="6889064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6889068">exec</span><span class="op" id="6889072">(</span><span class="ident" id="6889073">t</span><span class="op" id="6889074">,</span>&nbsp;<span class="ident" id="6889076">db</span><span class="op" id="6889078">,</span>&nbsp;<span class="string" id="6889080">&#34;INSERT|magicquery|op=sleep,millis=10&#34;</span><span class="op" id="6889118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6889121">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6889124">return</span>&nbsp;<span class="ident" id="6889131">db</span><br>
<span class="lineno"></span><span class="op" id="6889134">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="6889137">func</span>&nbsp;<span class="ident" id="6889142">exec</span><span class="op" id="6889146">(</span><span class="ident" id="6889147">t</span>&nbsp;<span class="ident" id="6889149">testing</span><span class="op" id="6889156">.</span><span class="ident" id="6889157">TB</span><span class="op" id="6889159">,</span>&nbsp;<span class="ident" id="6889161">db</span>&nbsp;<span class="op" id="6889164">*</span><span class="ident" id="6889165">DB</span><span class="op" id="6889167">,</span>&nbsp;<span class="ident" id="6889169">query</span>&nbsp;<span class="builtintype" id="6889175">string</span><span class="op" id="6889181">,</span>&nbsp;<span class="ident" id="6889183">args</span>&nbsp;<span class="op" id="6889188">...</span><span class="keyword" id="6889191">interface</span><span class="op" id="6889200">{</span><span class="op" id="6889201">}</span><span class="op" id="6889202">)</span>&nbsp;<span class="op" id="6889204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6889207">_</span><span class="op" id="6889208">,</span>&nbsp;<span class="ident" id="6889210">err</span>&nbsp;<span class="op" id="6889214">:=</span>&nbsp;<span class="ident" id="6889217">db</span><span class="op" id="6889219">.</span><span class="ident" id="6889220">Exec</span><span class="op" id="6889224">(</span><span class="ident" id="6889225">query</span><span class="op" id="6889230">,</span>&nbsp;<span class="ident" id="6889232">args</span><span class="op" id="6889236">...</span><span class="op" id="6889239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6889242">if</span>&nbsp;<span class="ident" id="6889245">err</span>&nbsp;<span class="op" id="6889249">!=</span>&nbsp;<span class="ident" id="6889252">nil</span>&nbsp;<span class="op" id="6889256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6889260">t</span><span class="op" id="6889261">.</span><span class="ident" id="6889262">Fatalf</span><span class="op" id="6889268">(</span><span class="string" id="6889269">&#34;Exec&nbsp;of&nbsp;%q:&nbsp;%v&#34;</span><span class="op" id="6889285">,</span>&nbsp;<span class="ident" id="6889287">query</span><span class="op" id="6889292">,</span>&nbsp;<span class="ident" id="6889294">err</span><span class="op" id="6889297">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6889300">}</span><br>
<span class="lineno"></span><span class="op" id="6889302">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6889305">func</span>&nbsp;<span class="ident" id="6889310">closeDB</span><span class="op" id="6889317">(</span><span class="ident" id="6889318">t</span>&nbsp;<span class="ident" id="6889320">testing</span><span class="op" id="6889327">.</span><span class="ident" id="6889328">TB</span><span class="op" id="6889330">,</span>&nbsp;<span class="ident" id="6889332">db</span>&nbsp;<span class="op" id="6889335">*</span><span class="ident" id="6889336">DB</span><span class="op" id="6889338">)</span>&nbsp;<span class="op" id="6889340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6889343">if</span>&nbsp;<span class="ident" id="6889346">e</span>&nbsp;<span class="op" id="6889348">:=</span>&nbsp;<span class="builtinfunc" id="6889351">recover</span><span class="op" id="6889358">(</span><span class="op" id="6889359">)</span><span class="op" id="6889360">;</span>&nbsp;<span class="ident" id="6889362">e</span>&nbsp;<span class="op" id="6889364">!=</span>&nbsp;<span class="ident" id="6889367">nil</span>&nbsp;<span class="op" id="6889371">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6889375">fmt</span><span class="op" id="6889378">.</span><span class="ident" id="6889379">Printf</span><span class="op" id="6889385">(</span><span class="string" id="6889386">&#34;Panic:&nbsp;%v\n&#34;</span><span class="op" id="6889399">,</span>&nbsp;<span class="ident" id="6889401">e</span><span class="op" id="6889402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6889406">panic</span><span class="op" id="6889411">(</span><span class="ident" id="6889412">e</span><span class="op" id="6889413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6889416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6889419">defer</span>&nbsp;<span class="ident" id="6889425">setHookpostCloseConn</span><span class="op" id="6889445">(</span><span class="ident" id="6889446">nil</span><span class="op" id="6889449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6889452">setHookpostCloseConn</span><span class="op" id="6889472">(</span><span class="keyword" id="6889473">func</span><span class="op" id="6889477">(</span><span class="ident" id="6889478">_</span>&nbsp;<span class="op" id="6889480">*</span><span class="ident" id="6889481">fakeConn</span><span class="op" id="6889489">,</span>&nbsp;<span class="ident" id="6889491">err</span>&nbsp;<span class="builtintype" id="6889495">error</span><span class="op" id="6889500">)</span>&nbsp;<span class="op" id="6889502">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6889506">if</span>&nbsp;<span class="ident" id="6889509">err</span>&nbsp;<span class="op" id="6889513">!=</span>&nbsp;<span class="ident" id="6889516">nil</span>&nbsp;<span class="op" id="6889520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6889525">t</span><span class="op" id="6889526">.</span><span class="ident" id="6889527">Errorf</span><span class="op" id="6889533">(</span><span class="string" id="6889534">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="6889562">,</span>&nbsp;<span class="ident" id="6889564">err</span><span class="op" id="6889567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6889571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6889574">}</span><span class="op" id="6889575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6889578">for</span>&nbsp;<span class="ident" id="6889582">i</span><span class="op" id="6889583">,</span>&nbsp;<span class="ident" id="6889585">dc</span>&nbsp;<span class="op" id="6889588">:=</span>&nbsp;<span class="keyword" id="6889591">range</span>&nbsp;<span class="ident" id="6889597">db</span><span class="op" id="6889599">.</span><span class="ident" id="6889600">freeConn</span>&nbsp;<span class="op" id="6889609">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6889613">if</span>&nbsp;<span class="ident" id="6889616">n</span>&nbsp;<span class="op" id="6889618">:=</span>&nbsp;<span class="builtinfunc" id="6889621">len</span><span class="op" id="6889624">(</span><span class="ident" id="6889625">dc</span><span class="op" id="6889627">.</span><span class="ident" id="6889628">openStmt</span><span class="op" id="6889636">)</span><span class="op" id="6889637">;</span>&nbsp;<span class="ident" id="6889639">n</span>&nbsp;<span class="op" id="6889641">&gt;</span>&nbsp;<span class="num" id="6889643">0</span>&nbsp;<span class="op" id="6889645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6889650">//&nbsp;Just&nbsp;a&nbsp;sanity&nbsp;check.&nbsp;This&nbsp;is&nbsp;legal&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6889694">//&nbsp;general,&nbsp;but&nbsp;if&nbsp;we&nbsp;make&nbsp;the&nbsp;tests&nbsp;clean&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6889743">//&nbsp;their&nbsp;statements&nbsp;first,&nbsp;then&nbsp;we&nbsp;can&nbsp;safely</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6889792">//&nbsp;verify&nbsp;this&nbsp;is&nbsp;always&nbsp;zero&nbsp;here,&nbsp;and&nbsp;any</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6889839">//&nbsp;other&nbsp;value&nbsp;is&nbsp;a&nbsp;leak.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6889868">t</span><span class="op" id="6889869">.</span><span class="ident" id="6889870">Errorf</span><span class="op" id="6889876">(</span><span class="string" id="6889877">&#34;while&nbsp;closing&nbsp;db,&nbsp;freeConn&nbsp;%d/%d&nbsp;had&nbsp;%d&nbsp;open&nbsp;stmts;&nbsp;want&nbsp;0&#34;</span><span class="op" id="6889937">,</span>&nbsp;<span class="ident" id="6889939">i</span><span class="op" id="6889940">,</span>&nbsp;<span class="builtinfunc" id="6889942">len</span><span class="op" id="6889945">(</span><span class="ident" id="6889946">db</span><span class="op" id="6889948">.</span><span class="ident" id="6889949">freeConn</span><span class="op" id="6889957">)</span><span class="op" id="6889958">,</span>&nbsp;<span class="ident" id="6889960">n</span><span class="op" id="6889961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6889965">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6889968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6889971">err</span>&nbsp;<span class="op" id="6889975">:=</span>&nbsp;<span class="ident" id="6889978">db</span><span class="op" id="6889980">.</span><span class="ident" id="6889981">Close</span><span class="op" id="6889986">(</span><span class="op" id="6889987">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6889990">if</span>&nbsp;<span class="ident" id="6889993">err</span>&nbsp;<span class="op" id="6889997">!=</span>&nbsp;<span class="ident" id="6890000">nil</span>&nbsp;<span class="op" id="6890004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6890008">t</span><span class="op" id="6890009">.</span><span class="ident" id="6890010">Fatalf</span><span class="op" id="6890016">(</span><span class="string" id="6890017">&#34;error&nbsp;closing&nbsp;DB:&nbsp;%v&#34;</span><span class="op" id="6890039">,</span>&nbsp;<span class="ident" id="6890041">err</span><span class="op" id="6890044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6890047">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6890050">db</span><span class="op" id="6890052">.</span><span class="ident" id="6890053">mu</span><span class="op" id="6890055">.</span><span class="ident" id="6890056">Lock</span><span class="op" id="6890060">(</span><span class="op" id="6890061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6890064">count</span>&nbsp;<span class="op" id="6890070">:=</span>&nbsp;<span class="ident" id="6890073">db</span><span class="op" id="6890075">.</span><span class="ident" id="6890076">numOpen</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6890085">db</span><span class="op" id="6890087">.</span><span class="ident" id="6890088">mu</span><span class="op" id="6890090">.</span><span class="ident" id="6890091">Unlock</span><span class="op" id="6890097">(</span><span class="op" id="6890098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6890101">if</span>&nbsp;<span class="ident" id="6890104">count</span>&nbsp;<span class="op" id="6890110">!=</span>&nbsp;<span class="num" id="6890113">0</span>&nbsp;<span class="op" id="6890115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6890119">t</span><span class="op" id="6890120">.</span><span class="ident" id="6890121">Fatalf</span><span class="op" id="6890127">(</span><span class="string" id="6890128">&#34;%d&nbsp;connections&nbsp;still&nbsp;open&nbsp;after&nbsp;closing&nbsp;DB&#34;</span><span class="op" id="6890172">,</span>&nbsp;<span class="ident" id="6890174">db</span><span class="op" id="6890176">.</span><span class="ident" id="6890177">numOpen</span><span class="op" id="6890184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6890187">}</span><br>
<span class="lineno"></span><span class="op" id="6890189">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="comment" id="6890192">//&nbsp;numPrepares&nbsp;assumes&nbsp;that&nbsp;db&nbsp;has&nbsp;exactly&nbsp;1&nbsp;idle&nbsp;conn&nbsp;and&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="6890259">//&nbsp;its&nbsp;count&nbsp;of&nbsp;calls&nbsp;to&nbsp;Prepare</span><br>
<span class="lineno"></span><span class="keyword" id="6890292">func</span>&nbsp;<span class="ident" id="6890297">numPrepares</span><span class="op" id="6890308">(</span><span class="ident" id="6890309">t</span>&nbsp;<span class="op" id="6890311">*</span><span class="ident" id="6890312">testing</span><span class="op" id="6890319">.</span><span class="ident" id="6890320">T</span><span class="op" id="6890321">,</span>&nbsp;<span class="ident" id="6890323">db</span>&nbsp;<span class="op" id="6890326">*</span><span class="ident" id="6890327">DB</span><span class="op" id="6890329">)</span>&nbsp;<span class="builtintype" id="6890331">int</span>&nbsp;<span class="op" id="6890335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6890338">if</span>&nbsp;<span class="ident" id="6890341">n</span>&nbsp;<span class="op" id="6890343">:=</span>&nbsp;<span class="builtinfunc" id="6890346">len</span><span class="op" id="6890349">(</span><span class="ident" id="6890350">db</span><span class="op" id="6890352">.</span><span class="ident" id="6890353">freeConn</span><span class="op" id="6890361">)</span><span class="op" id="6890362">;</span>&nbsp;<span class="ident" id="6890364">n</span>&nbsp;<span class="op" id="6890366">!=</span>&nbsp;<span class="num" id="6890369">1</span>&nbsp;<span class="op" id="6890371">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6890375">t</span><span class="op" id="6890376">.</span><span class="ident" id="6890377">Fatalf</span><span class="op" id="6890383">(</span><span class="string" id="6890384">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="6890409">,</span>&nbsp;<span class="ident" id="6890411">n</span><span class="op" id="6890412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6890415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6890418">return</span>&nbsp;<span class="ident" id="6890425">db</span><span class="op" id="6890427">.</span><span class="ident" id="6890428">freeConn</span><span class="op" id="6890436">[</span><span class="num" id="6890437">0</span><span class="op" id="6890438">]</span><span class="op" id="6890439">.</span><span class="ident" id="6890440">ci</span><span class="op" id="6890442">.</span><span class="op" id="6890443">(</span><span class="op" id="6890444">*</span><span class="ident" id="6890445">fakeConn</span><span class="op" id="6890453">)</span><span class="op" id="6890454">.</span><span class="ident" id="6890455">numPrepare</span><br>
<span class="lineno"></span><span class="op" id="6890466">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="keyword" id="6890469">func</span>&nbsp;<span class="op" id="6890474">(</span><span class="ident" id="6890475">db</span>&nbsp;<span class="op" id="6890478">*</span><span class="ident" id="6890479">DB</span><span class="op" id="6890481">)</span>&nbsp;<span class="ident" id="6890483">numDeps</span><span class="op" id="6890490">(</span><span class="op" id="6890491">)</span>&nbsp;<span class="builtintype" id="6890493">int</span>&nbsp;<span class="op" id="6890497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6890500">db</span><span class="op" id="6890502">.</span><span class="ident" id="6890503">mu</span><span class="op" id="6890505">.</span><span class="ident" id="6890506">Lock</span><span class="op" id="6890510">(</span><span class="op" id="6890511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6890514">defer</span>&nbsp;<span class="ident" id="6890520">db</span><span class="op" id="6890522">.</span><span class="ident" id="6890523">mu</span><span class="op" id="6890525">.</span><span class="ident" id="6890526">Unlock</span><span class="op" id="6890532">(</span><span class="op" id="6890533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6890536">return</span>&nbsp;<span class="builtinfunc" id="6890543">len</span><span class="op" id="6890546">(</span><span class="ident" id="6890547">db</span><span class="op" id="6890549">.</span><span class="ident" id="6890550">dep</span><span class="op" id="6890553">)</span><br>
<span class="lineno"></span><span class="op" id="6890555">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="comment" id="6890558">//&nbsp;Dependencies&nbsp;are&nbsp;closed&nbsp;via&nbsp;a&nbsp;goroutine,&nbsp;so&nbsp;this&nbsp;polls&nbsp;waiting&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="6890628">//&nbsp;numDeps&nbsp;to&nbsp;fall&nbsp;to&nbsp;want,&nbsp;waiting&nbsp;up&nbsp;to&nbsp;d.</span><br>
<span class="lineno"></span><span class="keyword" id="6890673">func</span>&nbsp;<span class="op" id="6890678">(</span><span class="ident" id="6890679">db</span>&nbsp;<span class="op" id="6890682">*</span><span class="ident" id="6890683">DB</span><span class="op" id="6890685">)</span>&nbsp;<span class="ident" id="6890687">numDepsPollUntil</span><span class="op" id="6890703">(</span><span class="ident" id="6890704">want</span>&nbsp;<span class="builtintype" id="6890709">int</span><span class="op" id="6890712">,</span>&nbsp;<span class="ident" id="6890714">d</span>&nbsp;<span class="ident" id="6890716">time</span><span class="op" id="6890720">.</span><span class="ident" id="6890721">Duration</span><span class="op" id="6890729">)</span>&nbsp;<span class="builtintype" id="6890731">int</span>&nbsp;<span class="op" id="6890735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6890738">deadline</span>&nbsp;<span class="op" id="6890747">:=</span>&nbsp;<span class="ident" id="6890750">time</span><span class="op" id="6890754">.</span><span class="ident" id="6890755">Now</span><span class="op" id="6890758">(</span><span class="op" id="6890759">)</span><span class="op" id="6890760">.</span><span class="ident" id="6890761">Add</span><span class="op" id="6890764">(</span><span class="ident" id="6890765">d</span><span class="op" id="6890766">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6890769">for</span>&nbsp;<span class="op" id="6890773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6890777">n</span>&nbsp;<span class="op" id="6890779">:=</span>&nbsp;<span class="ident" id="6890782">db</span><span class="op" id="6890784">.</span><span class="ident" id="6890785">numDeps</span><span class="op" id="6890792">(</span><span class="op" id="6890793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6890797">if</span>&nbsp;<span class="ident" id="6890800">n</span>&nbsp;<span class="op" id="6890802">&lt;=</span>&nbsp;<span class="ident" id="6890805">want</span>&nbsp;<span class="op" id="6890810">||</span>&nbsp;<span class="ident" id="6890813">time</span><span class="op" id="6890817">.</span><span class="ident" id="6890818">Now</span><span class="op" id="6890821">(</span><span class="op" id="6890822">)</span><span class="op" id="6890823">.</span><span class="ident" id="6890824">After</span><span class="op" id="6890829">(</span><span class="ident" id="6890830">deadline</span><span class="op" id="6890838">)</span>&nbsp;<span class="op" id="6890840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6890845">return</span>&nbsp;<span class="ident" id="6890852">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6890856">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6890860">time</span><span class="op" id="6890864">.</span><span class="ident" id="6890865">Sleep</span><span class="op" id="6890870">(</span><span class="num" id="6890871">50</span>&nbsp;<span class="op" id="6890874">*</span>&nbsp;<span class="ident" id="6890876">time</span><span class="op" id="6890880">.</span><span class="ident" id="6890881">Millisecond</span><span class="op" id="6890892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6890895">}</span><br>
<span class="lineno"></span><span class="op" id="6890897">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6890900">func</span>&nbsp;<span class="op" id="6890905">(</span><span class="ident" id="6890906">db</span>&nbsp;<span class="op" id="6890909">*</span><span class="ident" id="6890910">DB</span><span class="op" id="6890912">)</span>&nbsp;<span class="ident" id="6890914">numFreeConns</span><span class="op" id="6890926">(</span><span class="op" id="6890927">)</span>&nbsp;<span class="builtintype" id="6890929">int</span>&nbsp;<span class="op" id="6890933">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6890936">db</span><span class="op" id="6890938">.</span><span class="ident" id="6890939">mu</span><span class="op" id="6890941">.</span><span class="ident" id="6890942">Lock</span><span class="op" id="6890946">(</span><span class="op" id="6890947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6890950">defer</span>&nbsp;<span class="ident" id="6890956">db</span><span class="op" id="6890958">.</span><span class="ident" id="6890959">mu</span><span class="op" id="6890961">.</span><span class="ident" id="6890962">Unlock</span><span class="op" id="6890968">(</span><span class="op" id="6890969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6890972">return</span>&nbsp;<span class="builtinfunc" id="6890979">len</span><span class="op" id="6890982">(</span><span class="ident" id="6890983">db</span><span class="op" id="6890985">.</span><span class="ident" id="6890986">freeConn</span><span class="op" id="6890994">)</span><br>
<span class="lineno"></span><span class="op" id="6890996">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="6890999">func</span>&nbsp;<span class="op" id="6891004">(</span><span class="ident" id="6891005">db</span>&nbsp;<span class="op" id="6891008">*</span><span class="ident" id="6891009">DB</span><span class="op" id="6891011">)</span>&nbsp;<span class="ident" id="6891013">dumpDeps</span><span class="op" id="6891021">(</span><span class="ident" id="6891022">t</span>&nbsp;<span class="op" id="6891024">*</span><span class="ident" id="6891025">testing</span><span class="op" id="6891032">.</span><span class="ident" id="6891033">T</span><span class="op" id="6891034">)</span>&nbsp;<span class="op" id="6891036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6891039">for</span>&nbsp;<span class="ident" id="6891043">fc</span>&nbsp;<span class="op" id="6891046">:=</span>&nbsp;<span class="keyword" id="6891049">range</span>&nbsp;<span class="ident" id="6891055">db</span><span class="op" id="6891057">.</span><span class="ident" id="6891058">dep</span>&nbsp;<span class="op" id="6891062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891066">db</span><span class="op" id="6891068">.</span><span class="ident" id="6891069">dumpDep</span><span class="op" id="6891076">(</span><span class="ident" id="6891077">t</span><span class="op" id="6891078">,</span>&nbsp;<span class="num" id="6891080">0</span><span class="op" id="6891081">,</span>&nbsp;<span class="ident" id="6891083">fc</span><span class="op" id="6891085">,</span>&nbsp;<span class="keyword" id="6891087">map</span><span class="op" id="6891090">[</span><span class="ident" id="6891091">finalCloser</span><span class="op" id="6891102">]</span><span class="builtintype" id="6891103">bool</span><span class="op" id="6891107">{</span><span class="op" id="6891108">}</span><span class="op" id="6891109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6891112">}</span><br>
<span class="lineno"></span><span class="op" id="6891114">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span><span class="keyword" id="6891117">func</span>&nbsp;<span class="op" id="6891122">(</span><span class="ident" id="6891123">db</span>&nbsp;<span class="op" id="6891126">*</span><span class="ident" id="6891127">DB</span><span class="op" id="6891129">)</span>&nbsp;<span class="ident" id="6891131">dumpDep</span><span class="op" id="6891138">(</span><span class="ident" id="6891139">t</span>&nbsp;<span class="op" id="6891141">*</span><span class="ident" id="6891142">testing</span><span class="op" id="6891149">.</span><span class="ident" id="6891150">T</span><span class="op" id="6891151">,</span>&nbsp;<span class="ident" id="6891153">depth</span>&nbsp;<span class="builtintype" id="6891159">int</span><span class="op" id="6891162">,</span>&nbsp;<span class="ident" id="6891164">dep</span>&nbsp;<span class="ident" id="6891168">finalCloser</span><span class="op" id="6891179">,</span>&nbsp;<span class="ident" id="6891181">seen</span>&nbsp;<span class="keyword" id="6891186">map</span><span class="op" id="6891189">[</span><span class="ident" id="6891190">finalCloser</span><span class="op" id="6891201">]</span><span class="builtintype" id="6891202">bool</span><span class="op" id="6891206">)</span>&nbsp;<span class="op" id="6891208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891211">seen</span><span class="op" id="6891215">[</span><span class="ident" id="6891216">dep</span><span class="op" id="6891219">]</span>&nbsp;<span class="op" id="6891221">=</span>&nbsp;<span class="builtintype" id="6891223">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891229">indent</span>&nbsp;<span class="op" id="6891236">:=</span>&nbsp;<span class="ident" id="6891239">strings</span><span class="op" id="6891246">.</span><span class="ident" id="6891247">Repeat</span><span class="op" id="6891253">(</span><span class="string" id="6891254">&#34;&nbsp;&nbsp;&#34;</span><span class="op" id="6891258">,</span>&nbsp;<span class="ident" id="6891260">depth</span><span class="op" id="6891265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891268">ds</span>&nbsp;<span class="op" id="6891271">:=</span>&nbsp;<span class="ident" id="6891274">db</span><span class="op" id="6891276">.</span><span class="ident" id="6891277">dep</span><span class="op" id="6891280">[</span><span class="ident" id="6891281">dep</span><span class="op" id="6891284">]</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6891287">for</span>&nbsp;<span class="ident" id="6891291">k</span>&nbsp;<span class="op" id="6891293">:=</span>&nbsp;<span class="keyword" id="6891296">range</span>&nbsp;<span class="ident" id="6891302">ds</span>&nbsp;<span class="op" id="6891305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891309">t</span><span class="op" id="6891310">.</span><span class="ident" id="6891311">Logf</span><span class="op" id="6891315">(</span><span class="string" id="6891316">&#34;%s%T&nbsp;(%p)&nbsp;waiting&nbsp;for&nbsp;-&gt;&nbsp;%T&nbsp;(%p)&#34;</span><span class="op" id="6891350">,</span>&nbsp;<span class="ident" id="6891352">indent</span><span class="op" id="6891358">,</span>&nbsp;<span class="ident" id="6891360">dep</span><span class="op" id="6891363">,</span>&nbsp;<span class="ident" id="6891365">dep</span><span class="op" id="6891368">,</span>&nbsp;<span class="ident" id="6891370">k</span><span class="op" id="6891371">,</span>&nbsp;<span class="ident" id="6891373">k</span><span class="op" id="6891374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6891378">if</span>&nbsp;<span class="ident" id="6891381">fc</span><span class="op" id="6891383">,</span>&nbsp;<span class="ident" id="6891385">ok</span>&nbsp;<span class="op" id="6891388">:=</span>&nbsp;<span class="ident" id="6891391">k</span><span class="op" id="6891392">.</span><span class="op" id="6891393">(</span><span class="ident" id="6891394">finalCloser</span><span class="op" id="6891405">)</span><span class="op" id="6891406">;</span>&nbsp;<span class="ident" id="6891408">ok</span>&nbsp;<span class="op" id="6891411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6891416">if</span>&nbsp;<span class="op" id="6891419">!</span><span class="ident" id="6891420">seen</span><span class="op" id="6891424">[</span><span class="ident" id="6891425">fc</span><span class="op" id="6891427">]</span>&nbsp;<span class="op" id="6891429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891435">db</span><span class="op" id="6891437">.</span><span class="ident" id="6891438">dumpDep</span><span class="op" id="6891445">(</span><span class="ident" id="6891446">t</span><span class="op" id="6891447">,</span>&nbsp;<span class="ident" id="6891449">depth</span><span class="op" id="6891454">+</span><span class="num" id="6891455">1</span><span class="op" id="6891456">,</span>&nbsp;<span class="ident" id="6891458">fc</span><span class="op" id="6891460">,</span>&nbsp;<span class="ident" id="6891462">seen</span><span class="op" id="6891466">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6891471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6891475">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6891478">}</span><br>
<span class="lineno"></span><span class="op" id="6891480">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="6891483">func</span>&nbsp;<span class="ident" id="6891488">TestQuery</span><span class="op" id="6891497">(</span><span class="ident" id="6891498">t</span>&nbsp;<span class="op" id="6891500">*</span><span class="ident" id="6891501">testing</span><span class="op" id="6891508">.</span><span class="ident" id="6891509">T</span><span class="op" id="6891510">)</span>&nbsp;<span class="op" id="6891512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891515">db</span>&nbsp;<span class="op" id="6891518">:=</span>&nbsp;<span class="ident" id="6891521">newTestDB</span><span class="op" id="6891530">(</span><span class="ident" id="6891531">t</span><span class="op" id="6891532">,</span>&nbsp;<span class="string" id="6891534">&#34;people&#34;</span><span class="op" id="6891542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6891545">defer</span>&nbsp;<span class="ident" id="6891551">closeDB</span><span class="op" id="6891558">(</span><span class="ident" id="6891559">t</span><span class="op" id="6891560">,</span>&nbsp;<span class="ident" id="6891562">db</span><span class="op" id="6891564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891567">prepares0</span>&nbsp;<span class="op" id="6891577">:=</span>&nbsp;<span class="ident" id="6891580">numPrepares</span><span class="op" id="6891591">(</span><span class="ident" id="6891592">t</span><span class="op" id="6891593">,</span>&nbsp;<span class="ident" id="6891595">db</span><span class="op" id="6891597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891600">rows</span><span class="op" id="6891604">,</span>&nbsp;<span class="ident" id="6891606">err</span>&nbsp;<span class="op" id="6891610">:=</span>&nbsp;<span class="ident" id="6891613">db</span><span class="op" id="6891615">.</span><span class="ident" id="6891616">Query</span><span class="op" id="6891621">(</span><span class="string" id="6891622">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="6891647">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6891650">if</span>&nbsp;<span class="ident" id="6891653">err</span>&nbsp;<span class="op" id="6891657">!=</span>&nbsp;<span class="ident" id="6891660">nil</span>&nbsp;<span class="op" id="6891664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891668">t</span><span class="op" id="6891669">.</span><span class="ident" id="6891670">Fatalf</span><span class="op" id="6891676">(</span><span class="string" id="6891677">&#34;Query:&nbsp;%v&#34;</span><span class="op" id="6891688">,</span>&nbsp;<span class="ident" id="6891690">err</span><span class="op" id="6891693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6891696">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6891699">type</span>&nbsp;<span class="ident" id="6891704">row</span>&nbsp;<span class="keyword" id="6891708">struct</span>&nbsp;<span class="op" id="6891715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891719">age</span>&nbsp;&nbsp;<span class="builtintype" id="6891724">int</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891730">name</span>&nbsp;<span class="builtintype" id="6891735">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6891743">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891746">got</span>&nbsp;<span class="op" id="6891750">:=</span>&nbsp;<span class="op" id="6891753">[</span><span class="op" id="6891754">]</span><span class="ident" id="6891755">row</span><span class="op" id="6891758">{</span><span class="op" id="6891759">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6891762">for</span>&nbsp;<span class="ident" id="6891766">rows</span><span class="op" id="6891770">.</span><span class="ident" id="6891771">Next</span><span class="op" id="6891775">(</span><span class="op" id="6891776">)</span>&nbsp;<span class="op" id="6891778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6891782">var</span>&nbsp;<span class="ident" id="6891786">r</span>&nbsp;<span class="ident" id="6891788">row</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891794">err</span>&nbsp;<span class="op" id="6891798">=</span>&nbsp;<span class="ident" id="6891800">rows</span><span class="op" id="6891804">.</span><span class="ident" id="6891805">Scan</span><span class="op" id="6891809">(</span><span class="op" id="6891810">&amp;</span><span class="ident" id="6891811">r</span><span class="op" id="6891812">.</span><span class="ident" id="6891813">age</span><span class="op" id="6891816">,</span>&nbsp;<span class="op" id="6891818">&amp;</span><span class="ident" id="6891819">r</span><span class="op" id="6891820">.</span><span class="ident" id="6891821">name</span><span class="op" id="6891825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6891829">if</span>&nbsp;<span class="ident" id="6891832">err</span>&nbsp;<span class="op" id="6891836">!=</span>&nbsp;<span class="ident" id="6891839">nil</span>&nbsp;<span class="op" id="6891843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891848">t</span><span class="op" id="6891849">.</span><span class="ident" id="6891850">Fatalf</span><span class="op" id="6891856">(</span><span class="string" id="6891857">&#34;Scan:&nbsp;%v&#34;</span><span class="op" id="6891867">,</span>&nbsp;<span class="ident" id="6891869">err</span><span class="op" id="6891872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6891876">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891880">got</span>&nbsp;<span class="op" id="6891884">=</span>&nbsp;<span class="builtinfunc" id="6891886">append</span><span class="op" id="6891892">(</span><span class="ident" id="6891893">got</span><span class="op" id="6891896">,</span>&nbsp;<span class="ident" id="6891898">r</span><span class="op" id="6891899">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6891902">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891905">err</span>&nbsp;<span class="op" id="6891909">=</span>&nbsp;<span class="ident" id="6891911">rows</span><span class="op" id="6891915">.</span><span class="ident" id="6891916">Err</span><span class="op" id="6891919">(</span><span class="op" id="6891920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6891923">if</span>&nbsp;<span class="ident" id="6891926">err</span>&nbsp;<span class="op" id="6891930">!=</span>&nbsp;<span class="ident" id="6891933">nil</span>&nbsp;<span class="op" id="6891937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891941">t</span><span class="op" id="6891942">.</span><span class="ident" id="6891943">Fatalf</span><span class="op" id="6891949">(</span><span class="string" id="6891950">&#34;Err:&nbsp;%v&#34;</span><span class="op" id="6891959">,</span>&nbsp;<span class="ident" id="6891961">err</span><span class="op" id="6891964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6891967">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891970">want</span>&nbsp;<span class="op" id="6891975">:=</span>&nbsp;<span class="op" id="6891978">[</span><span class="op" id="6891979">]</span><span class="ident" id="6891980">row</span><span class="op" id="6891983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6891987">{</span><span class="ident" id="6891988">age</span><span class="op" id="6891991">:</span>&nbsp;<span class="num" id="6891993">1</span><span class="op" id="6891994">,</span>&nbsp;<span class="ident" id="6891996">name</span><span class="op" id="6892000">:</span>&nbsp;<span class="string" id="6892002">&#34;Alice&#34;</span><span class="op" id="6892009">}</span><span class="op" id="6892010">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6892014">{</span><span class="ident" id="6892015">age</span><span class="op" id="6892018">:</span>&nbsp;<span class="num" id="6892020">2</span><span class="op" id="6892021">,</span>&nbsp;<span class="ident" id="6892023">name</span><span class="op" id="6892027">:</span>&nbsp;<span class="string" id="6892029">&#34;Bob&#34;</span><span class="op" id="6892034">}</span><span class="op" id="6892035">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6892039">{</span><span class="ident" id="6892040">age</span><span class="op" id="6892043">:</span>&nbsp;<span class="num" id="6892045">3</span><span class="op" id="6892046">,</span>&nbsp;<span class="ident" id="6892048">name</span><span class="op" id="6892052">:</span>&nbsp;<span class="string" id="6892054">&#34;Chris&#34;</span><span class="op" id="6892061">}</span><span class="op" id="6892062">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6892065">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6892068">if</span>&nbsp;<span class="op" id="6892071">!</span><span class="ident" id="6892072">reflect</span><span class="op" id="6892079">.</span><span class="ident" id="6892080">DeepEqual</span><span class="op" id="6892089">(</span><span class="ident" id="6892090">got</span><span class="op" id="6892093">,</span>&nbsp;<span class="ident" id="6892095">want</span><span class="op" id="6892099">)</span>&nbsp;<span class="op" id="6892101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892105">t</span><span class="op" id="6892106">.</span><span class="ident" id="6892107">Errorf</span><span class="op" id="6892113">(</span><span class="string" id="6892114">&#34;mismatch.\n&nbsp;got:&nbsp;%#v\nwant:&nbsp;%#v&#34;</span><span class="op" id="6892147">,</span>&nbsp;<span class="ident" id="6892149">got</span><span class="op" id="6892152">,</span>&nbsp;<span class="ident" id="6892154">want</span><span class="op" id="6892158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6892161">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6892165">//&nbsp;And&nbsp;verify&nbsp;that&nbsp;the&nbsp;final&nbsp;rows.Next()&nbsp;call,&nbsp;which&nbsp;hit&nbsp;EOF,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6892228">//&nbsp;also&nbsp;closed&nbsp;the&nbsp;rows&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6892265">if</span>&nbsp;<span class="ident" id="6892268">n</span>&nbsp;<span class="op" id="6892270">:=</span>&nbsp;<span class="ident" id="6892273">db</span><span class="op" id="6892275">.</span><span class="ident" id="6892276">numFreeConns</span><span class="op" id="6892288">(</span><span class="op" id="6892289">)</span><span class="op" id="6892290">;</span>&nbsp;<span class="ident" id="6892292">n</span>&nbsp;<span class="op" id="6892294">!=</span>&nbsp;<span class="num" id="6892297">1</span>&nbsp;<span class="op" id="6892299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892303">t</span><span class="op" id="6892304">.</span><span class="ident" id="6892305">Fatalf</span><span class="op" id="6892311">(</span><span class="string" id="6892312">&#34;free&nbsp;conns&nbsp;after&nbsp;query&nbsp;hitting&nbsp;EOF&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="6892361">,</span>&nbsp;<span class="ident" id="6892363">n</span><span class="op" id="6892364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6892367">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6892370">if</span>&nbsp;<span class="ident" id="6892373">prepares</span>&nbsp;<span class="op" id="6892382">:=</span>&nbsp;<span class="ident" id="6892385">numPrepares</span><span class="op" id="6892396">(</span><span class="ident" id="6892397">t</span><span class="op" id="6892398">,</span>&nbsp;<span class="ident" id="6892400">db</span><span class="op" id="6892402">)</span>&nbsp;<span class="op" id="6892404">-</span>&nbsp;<span class="ident" id="6892406">prepares0</span><span class="op" id="6892415">;</span>&nbsp;<span class="ident" id="6892417">prepares</span>&nbsp;<span class="op" id="6892426">!=</span>&nbsp;<span class="num" id="6892429">1</span>&nbsp;<span class="op" id="6892431">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892435">t</span><span class="op" id="6892436">.</span><span class="ident" id="6892437">Errorf</span><span class="op" id="6892443">(</span><span class="string" id="6892444">&#34;executed&nbsp;%d&nbsp;Prepare&nbsp;statements;&nbsp;want&nbsp;1&#34;</span><span class="op" id="6892484">,</span>&nbsp;<span class="ident" id="6892486">prepares</span><span class="op" id="6892494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6892497">}</span><br>
<span class="lineno"></span><span class="op" id="6892499">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6892502">func</span>&nbsp;<span class="ident" id="6892507">TestByteOwnership</span><span class="op" id="6892524">(</span><span class="ident" id="6892525">t</span>&nbsp;<span class="op" id="6892527">*</span><span class="ident" id="6892528">testing</span><span class="op" id="6892535">.</span><span class="ident" id="6892536">T</span><span class="op" id="6892537">)</span>&nbsp;<span class="op" id="6892539">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892542">db</span>&nbsp;<span class="op" id="6892545">:=</span>&nbsp;<span class="ident" id="6892548">newTestDB</span><span class="op" id="6892557">(</span><span class="ident" id="6892558">t</span><span class="op" id="6892559">,</span>&nbsp;<span class="string" id="6892561">&#34;people&#34;</span><span class="op" id="6892569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6892572">defer</span>&nbsp;<span class="ident" id="6892578">closeDB</span><span class="op" id="6892585">(</span><span class="ident" id="6892586">t</span><span class="op" id="6892587">,</span>&nbsp;<span class="ident" id="6892589">db</span><span class="op" id="6892591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892594">rows</span><span class="op" id="6892598">,</span>&nbsp;<span class="ident" id="6892600">err</span>&nbsp;<span class="op" id="6892604">:=</span>&nbsp;<span class="ident" id="6892607">db</span><span class="op" id="6892609">.</span><span class="ident" id="6892610">Query</span><span class="op" id="6892615">(</span><span class="string" id="6892616">&#34;SELECT|people|name,photo|&#34;</span><span class="op" id="6892643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6892646">if</span>&nbsp;<span class="ident" id="6892649">err</span>&nbsp;<span class="op" id="6892653">!=</span>&nbsp;<span class="ident" id="6892656">nil</span>&nbsp;<span class="op" id="6892660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892664">t</span><span class="op" id="6892665">.</span><span class="ident" id="6892666">Fatalf</span><span class="op" id="6892672">(</span><span class="string" id="6892673">&#34;Query:&nbsp;%v&#34;</span><span class="op" id="6892684">,</span>&nbsp;<span class="ident" id="6892686">err</span><span class="op" id="6892689">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6892692">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6892695">type</span>&nbsp;<span class="ident" id="6892700">row</span>&nbsp;<span class="keyword" id="6892704">struct</span>&nbsp;<span class="op" id="6892711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892715">name</span>&nbsp;&nbsp;<span class="op" id="6892721">[</span><span class="op" id="6892722">]</span><span class="builtintype" id="6892723">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892730">photo</span>&nbsp;<span class="ident" id="6892736">RawBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6892746">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892749">got</span>&nbsp;<span class="op" id="6892753">:=</span>&nbsp;<span class="op" id="6892756">[</span><span class="op" id="6892757">]</span><span class="ident" id="6892758">row</span><span class="op" id="6892761">{</span><span class="op" id="6892762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6892765">for</span>&nbsp;<span class="ident" id="6892769">rows</span><span class="op" id="6892773">.</span><span class="ident" id="6892774">Next</span><span class="op" id="6892778">(</span><span class="op" id="6892779">)</span>&nbsp;<span class="op" id="6892781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6892785">var</span>&nbsp;<span class="ident" id="6892789">r</span>&nbsp;<span class="ident" id="6892791">row</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892797">err</span>&nbsp;<span class="op" id="6892801">=</span>&nbsp;<span class="ident" id="6892803">rows</span><span class="op" id="6892807">.</span><span class="ident" id="6892808">Scan</span><span class="op" id="6892812">(</span><span class="op" id="6892813">&amp;</span><span class="ident" id="6892814">r</span><span class="op" id="6892815">.</span><span class="ident" id="6892816">name</span><span class="op" id="6892820">,</span>&nbsp;<span class="op" id="6892822">&amp;</span><span class="ident" id="6892823">r</span><span class="op" id="6892824">.</span><span class="ident" id="6892825">photo</span><span class="op" id="6892830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6892834">if</span>&nbsp;<span class="ident" id="6892837">err</span>&nbsp;<span class="op" id="6892841">!=</span>&nbsp;<span class="ident" id="6892844">nil</span>&nbsp;<span class="op" id="6892848">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892853">t</span><span class="op" id="6892854">.</span><span class="ident" id="6892855">Fatalf</span><span class="op" id="6892861">(</span><span class="string" id="6892862">&#34;Scan:&nbsp;%v&#34;</span><span class="op" id="6892872">,</span>&nbsp;<span class="ident" id="6892874">err</span><span class="op" id="6892877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6892881">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892885">got</span>&nbsp;<span class="op" id="6892889">=</span>&nbsp;<span class="builtinfunc" id="6892891">append</span><span class="op" id="6892897">(</span><span class="ident" id="6892898">got</span><span class="op" id="6892901">,</span>&nbsp;<span class="ident" id="6892903">r</span><span class="op" id="6892904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6892907">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892910">corruptMemory</span>&nbsp;<span class="op" id="6892924">:=</span>&nbsp;<span class="op" id="6892927">[</span><span class="op" id="6892928">]</span><span class="builtintype" id="6892929">byte</span><span class="op" id="6892933">(</span><span class="string" id="6892934">&#34;\xffPHOTO&#34;</span><span class="op" id="6892945">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892948">want</span>&nbsp;<span class="op" id="6892953">:=</span>&nbsp;<span class="op" id="6892956">[</span><span class="op" id="6892957">]</span><span class="ident" id="6892958">row</span><span class="op" id="6892961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6892965">{</span><span class="ident" id="6892966">name</span><span class="op" id="6892970">:</span>&nbsp;<span class="op" id="6892972">[</span><span class="op" id="6892973">]</span><span class="builtintype" id="6892974">byte</span><span class="op" id="6892978">(</span><span class="string" id="6892979">&#34;Alice&#34;</span><span class="op" id="6892986">)</span><span class="op" id="6892987">,</span>&nbsp;<span class="ident" id="6892989">photo</span><span class="op" id="6892994">:</span>&nbsp;<span class="ident" id="6892996">corruptMemory</span><span class="op" id="6893009">}</span><span class="op" id="6893010">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6893014">{</span><span class="ident" id="6893015">name</span><span class="op" id="6893019">:</span>&nbsp;<span class="op" id="6893021">[</span><span class="op" id="6893022">]</span><span class="builtintype" id="6893023">byte</span><span class="op" id="6893027">(</span><span class="string" id="6893028">&#34;Bob&#34;</span><span class="op" id="6893033">)</span><span class="op" id="6893034">,</span>&nbsp;<span class="ident" id="6893036">photo</span><span class="op" id="6893041">:</span>&nbsp;<span class="ident" id="6893043">corruptMemory</span><span class="op" id="6893056">}</span><span class="op" id="6893057">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6893061">{</span><span class="ident" id="6893062">name</span><span class="op" id="6893066">:</span>&nbsp;<span class="op" id="6893068">[</span><span class="op" id="6893069">]</span><span class="builtintype" id="6893070">byte</span><span class="op" id="6893074">(</span><span class="string" id="6893075">&#34;Chris&#34;</span><span class="op" id="6893082">)</span><span class="op" id="6893083">,</span>&nbsp;<span class="ident" id="6893085">photo</span><span class="op" id="6893090">:</span>&nbsp;<span class="ident" id="6893092">corruptMemory</span><span class="op" id="6893105">}</span><span class="op" id="6893106">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6893109">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6893112">if</span>&nbsp;<span class="op" id="6893115">!</span><span class="ident" id="6893116">reflect</span><span class="op" id="6893123">.</span><span class="ident" id="6893124">DeepEqual</span><span class="op" id="6893133">(</span><span class="ident" id="6893134">got</span><span class="op" id="6893137">,</span>&nbsp;<span class="ident" id="6893139">want</span><span class="op" id="6893143">)</span>&nbsp;<span class="op" id="6893145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893149">t</span><span class="op" id="6893150">.</span><span class="ident" id="6893151">Errorf</span><span class="op" id="6893157">(</span><span class="string" id="6893158">&#34;mismatch.\n&nbsp;got:&nbsp;%#v\nwant:&nbsp;%#v&#34;</span><span class="op" id="6893191">,</span>&nbsp;<span class="ident" id="6893193">got</span><span class="op" id="6893196">,</span>&nbsp;<span class="ident" id="6893198">want</span><span class="op" id="6893202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6893205">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6893209">var</span>&nbsp;<span class="ident" id="6893213">photo</span>&nbsp;<span class="ident" id="6893219">RawBytes</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893229">err</span>&nbsp;<span class="op" id="6893233">=</span>&nbsp;<span class="ident" id="6893235">db</span><span class="op" id="6893237">.</span><span class="ident" id="6893238">QueryRow</span><span class="op" id="6893246">(</span><span class="string" id="6893247">&#34;SELECT|people|photo|name=?&#34;</span><span class="op" id="6893275">,</span>&nbsp;<span class="string" id="6893277">&#34;Alice&#34;</span><span class="op" id="6893284">)</span><span class="op" id="6893285">.</span><span class="ident" id="6893286">Scan</span><span class="op" id="6893290">(</span><span class="op" id="6893291">&amp;</span><span class="ident" id="6893292">photo</span><span class="op" id="6893297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6893300">if</span>&nbsp;<span class="ident" id="6893303">err</span>&nbsp;<span class="op" id="6893307">==</span>&nbsp;<span class="ident" id="6893310">nil</span>&nbsp;<span class="op" id="6893314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893318">t</span><span class="op" id="6893319">.</span><span class="ident" id="6893320">Error</span><span class="op" id="6893325">(</span><span class="string" id="6893326">&#34;want&nbsp;error&nbsp;scanning&nbsp;into&nbsp;RawBytes&nbsp;from&nbsp;QueryRow&#34;</span><span class="op" id="6893375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6893378">}</span><br>
<span class="lineno"></span><span class="op" id="6893380">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span><span class="keyword" id="6893383">func</span>&nbsp;<span class="ident" id="6893388">TestRowsColumns</span><span class="op" id="6893403">(</span><span class="ident" id="6893404">t</span>&nbsp;<span class="op" id="6893406">*</span><span class="ident" id="6893407">testing</span><span class="op" id="6893414">.</span><span class="ident" id="6893415">T</span><span class="op" id="6893416">)</span>&nbsp;<span class="op" id="6893418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893421">db</span>&nbsp;<span class="op" id="6893424">:=</span>&nbsp;<span class="ident" id="6893427">newTestDB</span><span class="op" id="6893436">(</span><span class="ident" id="6893437">t</span><span class="op" id="6893438">,</span>&nbsp;<span class="string" id="6893440">&#34;people&#34;</span><span class="op" id="6893448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6893451">defer</span>&nbsp;<span class="ident" id="6893457">closeDB</span><span class="op" id="6893464">(</span><span class="ident" id="6893465">t</span><span class="op" id="6893466">,</span>&nbsp;<span class="ident" id="6893468">db</span><span class="op" id="6893470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893473">rows</span><span class="op" id="6893477">,</span>&nbsp;<span class="ident" id="6893479">err</span>&nbsp;<span class="op" id="6893483">:=</span>&nbsp;<span class="ident" id="6893486">db</span><span class="op" id="6893488">.</span><span class="ident" id="6893489">Query</span><span class="op" id="6893494">(</span><span class="string" id="6893495">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="6893520">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6893523">if</span>&nbsp;<span class="ident" id="6893526">err</span>&nbsp;<span class="op" id="6893530">!=</span>&nbsp;<span class="ident" id="6893533">nil</span>&nbsp;<span class="op" id="6893537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893541">t</span><span class="op" id="6893542">.</span><span class="ident" id="6893543">Fatalf</span><span class="op" id="6893549">(</span><span class="string" id="6893550">&#34;Query:&nbsp;%v&#34;</span><span class="op" id="6893561">,</span>&nbsp;<span class="ident" id="6893563">err</span><span class="op" id="6893566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6893569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893572">cols</span><span class="op" id="6893576">,</span>&nbsp;<span class="ident" id="6893578">err</span>&nbsp;<span class="op" id="6893582">:=</span>&nbsp;<span class="ident" id="6893585">rows</span><span class="op" id="6893589">.</span><span class="ident" id="6893590">Columns</span><span class="op" id="6893597">(</span><span class="op" id="6893598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6893601">if</span>&nbsp;<span class="ident" id="6893604">err</span>&nbsp;<span class="op" id="6893608">!=</span>&nbsp;<span class="ident" id="6893611">nil</span>&nbsp;<span class="op" id="6893615">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893619">t</span><span class="op" id="6893620">.</span><span class="ident" id="6893621">Fatalf</span><span class="op" id="6893627">(</span><span class="string" id="6893628">&#34;Columns:&nbsp;%v&#34;</span><span class="op" id="6893641">,</span>&nbsp;<span class="ident" id="6893643">err</span><span class="op" id="6893646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6893649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893652">want</span>&nbsp;<span class="op" id="6893657">:=</span>&nbsp;<span class="op" id="6893660">[</span><span class="op" id="6893661">]</span><span class="builtintype" id="6893662">string</span><span class="op" id="6893668">{</span><span class="string" id="6893669">&#34;age&#34;</span><span class="op" id="6893674">,</span>&nbsp;<span class="string" id="6893676">&#34;name&#34;</span><span class="op" id="6893682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6893685">if</span>&nbsp;<span class="op" id="6893688">!</span><span class="ident" id="6893689">reflect</span><span class="op" id="6893696">.</span><span class="ident" id="6893697">DeepEqual</span><span class="op" id="6893706">(</span><span class="ident" id="6893707">cols</span><span class="op" id="6893711">,</span>&nbsp;<span class="ident" id="6893713">want</span><span class="op" id="6893717">)</span>&nbsp;<span class="op" id="6893719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893723">t</span><span class="op" id="6893724">.</span><span class="ident" id="6893725">Errorf</span><span class="op" id="6893731">(</span><span class="string" id="6893732">&#34;got&nbsp;%#v;&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="6893751">,</span>&nbsp;<span class="ident" id="6893753">cols</span><span class="op" id="6893757">,</span>&nbsp;<span class="ident" id="6893759">want</span><span class="op" id="6893763">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6893766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6893769">if</span>&nbsp;<span class="ident" id="6893772">err</span>&nbsp;<span class="op" id="6893776">:=</span>&nbsp;<span class="ident" id="6893779">rows</span><span class="op" id="6893783">.</span><span class="ident" id="6893784">Close</span><span class="op" id="6893789">(</span><span class="op" id="6893790">)</span><span class="op" id="6893791">;</span>&nbsp;<span class="ident" id="6893793">err</span>&nbsp;<span class="op" id="6893797">!=</span>&nbsp;<span class="ident" id="6893800">nil</span>&nbsp;<span class="op" id="6893804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893808">t</span><span class="op" id="6893809">.</span><span class="ident" id="6893810">Errorf</span><span class="op" id="6893816">(</span><span class="string" id="6893817">&#34;error&nbsp;closing&nbsp;rows:&nbsp;%s&#34;</span><span class="op" id="6893841">,</span>&nbsp;<span class="ident" id="6893843">err</span><span class="op" id="6893846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6893849">}</span><br>
<span class="lineno"></span><span class="op" id="6893851">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="6893854">func</span>&nbsp;<span class="ident" id="6893859">TestQueryRow</span><span class="op" id="6893871">(</span><span class="ident" id="6893872">t</span>&nbsp;<span class="op" id="6893874">*</span><span class="ident" id="6893875">testing</span><span class="op" id="6893882">.</span><span class="ident" id="6893883">T</span><span class="op" id="6893884">)</span>&nbsp;<span class="op" id="6893886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893889">db</span>&nbsp;<span class="op" id="6893892">:=</span>&nbsp;<span class="ident" id="6893895">newTestDB</span><span class="op" id="6893904">(</span><span class="ident" id="6893905">t</span><span class="op" id="6893906">,</span>&nbsp;<span class="string" id="6893908">&#34;people&#34;</span><span class="op" id="6893916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6893919">defer</span>&nbsp;<span class="ident" id="6893925">closeDB</span><span class="op" id="6893932">(</span><span class="ident" id="6893933">t</span><span class="op" id="6893934">,</span>&nbsp;<span class="ident" id="6893936">db</span><span class="op" id="6893938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6893941">var</span>&nbsp;<span class="ident" id="6893945">name</span>&nbsp;<span class="builtintype" id="6893950">string</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6893958">var</span>&nbsp;<span class="ident" id="6893962">age</span>&nbsp;<span class="builtintype" id="6893966">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6893971">var</span>&nbsp;<span class="ident" id="6893975">birthday</span>&nbsp;<span class="ident" id="6893984">time</span><span class="op" id="6893988">.</span><span class="ident" id="6893989">Time</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893996">err</span>&nbsp;<span class="op" id="6894000">:=</span>&nbsp;<span class="ident" id="6894003">db</span><span class="op" id="6894005">.</span><span class="ident" id="6894006">QueryRow</span><span class="op" id="6894014">(</span><span class="string" id="6894015">&#34;SELECT|people|age,name|age=?&#34;</span><span class="op" id="6894045">,</span>&nbsp;<span class="num" id="6894047">3</span><span class="op" id="6894048">)</span><span class="op" id="6894049">.</span><span class="ident" id="6894050">Scan</span><span class="op" id="6894054">(</span><span class="op" id="6894055">&amp;</span><span class="ident" id="6894056">age</span><span class="op" id="6894059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6894062">if</span>&nbsp;<span class="ident" id="6894065">err</span>&nbsp;<span class="op" id="6894069">==</span>&nbsp;<span class="ident" id="6894072">nil</span>&nbsp;<span class="op" id="6894076">||</span>&nbsp;<span class="op" id="6894079">!</span><span class="ident" id="6894080">strings</span><span class="op" id="6894087">.</span><span class="ident" id="6894088">Contains</span><span class="op" id="6894096">(</span><span class="ident" id="6894097">err</span><span class="op" id="6894100">.</span><span class="ident" id="6894101">Error</span><span class="op" id="6894106">(</span><span class="op" id="6894107">)</span><span class="op" id="6894108">,</span>&nbsp;<span class="string" id="6894110">&#34;expected&nbsp;2&nbsp;destination&nbsp;arguments&#34;</span><span class="op" id="6894144">)</span>&nbsp;<span class="op" id="6894146">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6894150">t</span><span class="op" id="6894151">.</span><span class="ident" id="6894152">Errorf</span><span class="op" id="6894158">(</span><span class="string" id="6894159">&#34;expected&nbsp;error&nbsp;from&nbsp;wrong&nbsp;number&nbsp;of&nbsp;arguments;&nbsp;actually&nbsp;got:&nbsp;%v&#34;</span><span class="op" id="6894224">,</span>&nbsp;<span class="ident" id="6894226">err</span><span class="op" id="6894229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6894232">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6894236">err</span>&nbsp;<span class="op" id="6894240">=</span>&nbsp;<span class="ident" id="6894242">db</span><span class="op" id="6894244">.</span><span class="ident" id="6894245">QueryRow</span><span class="op" id="6894253">(</span><span class="string" id="6894254">&#34;SELECT|people|bdate|age=?&#34;</span><span class="op" id="6894281">,</span>&nbsp;<span class="num" id="6894283">3</span><span class="op" id="6894284">)</span><span class="op" id="6894285">.</span><span class="ident" id="6894286">Scan</span><span class="op" id="6894290">(</span><span class="op" id="6894291">&amp;</span><span class="ident" id="6894292">birthday</span><span class="op" id="6894300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6894303">if</span>&nbsp;<span class="ident" id="6894306">err</span>&nbsp;<span class="op" id="6894310">!=</span>&nbsp;<span class="ident" id="6894313">nil</span>&nbsp;<span class="op" id="6894317">||</span>&nbsp;<span class="op" id="6894320">!</span><span class="ident" id="6894321">birthday</span><span class="op" id="6894329">.</span><span class="ident" id="6894330">Equal</span><span class="op" id="6894335">(</span><span class="ident" id="6894336">chrisBirthday</span><span class="op" id="6894349">)</span>&nbsp;<span class="op" id="6894351">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6894355">t</span><span class="op" id="6894356">.</span><span class="ident" id="6894357">Errorf</span><span class="op" id="6894363">(</span><span class="string" id="6894364">&#34;chris&nbsp;birthday&nbsp;=&nbsp;%v,&nbsp;err&nbsp;=&nbsp;%v;&nbsp;want&nbsp;%v&#34;</span><span class="op" id="6894404">,</span>&nbsp;<span class="ident" id="6894406">birthday</span><span class="op" id="6894414">,</span>&nbsp;<span class="ident" id="6894416">err</span><span class="op" id="6894419">,</span>&nbsp;<span class="ident" id="6894421">chrisBirthday</span><span class="op" id="6894434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6894437">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6894441">err</span>&nbsp;<span class="op" id="6894445">=</span>&nbsp;<span class="ident" id="6894447">db</span><span class="op" id="6894449">.</span><span class="ident" id="6894450">QueryRow</span><span class="op" id="6894458">(</span><span class="string" id="6894459">&#34;SELECT|people|age,name|age=?&#34;</span><span class="op" id="6894489">,</span>&nbsp;<span class="num" id="6894491">2</span><span class="op" id="6894492">)</span><span class="op" id="6894493">.</span><span class="ident" id="6894494">Scan</span><span class="op" id="6894498">(</span><span class="op" id="6894499">&amp;</span><span class="ident" id="6894500">age</span><span class="op" id="6894503">,</span>&nbsp;<span class="op" id="6894505">&amp;</span><span class="ident" id="6894506">name</span><span class="op" id="6894510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6894513">if</span>&nbsp;<span class="ident" id="6894516">err</span>&nbsp;<span class="op" id="6894520">!=</span>&nbsp;<span class="ident" id="6894523">nil</span>&nbsp;<span class="op" id="6894527">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6894531">t</span><span class="op" id="6894532">.</span><span class="ident" id="6894533">Fatalf</span><span class="op" id="6894539">(</span><span class="string" id="6894540">&#34;age&nbsp;QueryRow+Scan:&nbsp;%v&#34;</span><span class="op" id="6894563">,</span>&nbsp;<span class="ident" id="6894565">err</span><span class="op" id="6894568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6894571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6894574">if</span>&nbsp;<span class="ident" id="6894577">name</span>&nbsp;<span class="op" id="6894582">!=</span>&nbsp;<span class="string" id="6894585">&#34;Bob&#34;</span>&nbsp;<span class="op" id="6894591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6894595">t</span><span class="op" id="6894596">.</span><span class="ident" id="6894597">Errorf</span><span class="op" id="6894603">(</span><span class="string" id="6894604">&#34;expected&nbsp;name&nbsp;Bob,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="6894631">,</span>&nbsp;<span class="ident" id="6894633">name</span><span class="op" id="6894637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6894640">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6894643">if</span>&nbsp;<span class="ident" id="6894646">age</span>&nbsp;<span class="op" id="6894650">!=</span>&nbsp;<span class="num" id="6894653">2</span>&nbsp;<span class="op" id="6894655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6894659">t</span><span class="op" id="6894660">.</span><span class="ident" id="6894661">Errorf</span><span class="op" id="6894667">(</span><span class="string" id="6894668">&#34;expected&nbsp;age&nbsp;2,&nbsp;got&nbsp;%d&#34;</span><span class="op" id="6894692">,</span>&nbsp;<span class="ident" id="6894694">age</span><span class="op" id="6894697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6894700">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6894704">err</span>&nbsp;<span class="op" id="6894708">=</span>&nbsp;<span class="ident" id="6894710">db</span><span class="op" id="6894712">.</span><span class="ident" id="6894713">QueryRow</span><span class="op" id="6894721">(</span><span class="string" id="6894722">&#34;SELECT|people|age,name|name=?&#34;</span><span class="op" id="6894753">,</span>&nbsp;<span class="string" id="6894755">&#34;Alice&#34;</span><span class="op" id="6894762">)</span><span class="op" id="6894763">.</span><span class="ident" id="6894764">Scan</span><span class="op" id="6894768">(</span><span class="op" id="6894769">&amp;</span><span class="ident" id="6894770">age</span><span class="op" id="6894773">,</span>&nbsp;<span class="op" id="6894775">&amp;</span><span class="ident" id="6894776">name</span><span class="op" id="6894780">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6894783">if</span>&nbsp;<span class="ident" id="6894786">err</span>&nbsp;<span class="op" id="6894790">!=</span>&nbsp;<span class="ident" id="6894793">nil</span>&nbsp;<span class="op" id="6894797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6894801">t</span><span class="op" id="6894802">.</span><span class="ident" id="6894803">Fatalf</span><span class="op" id="6894809">(</span><span class="string" id="6894810">&#34;name&nbsp;QueryRow+Scan:&nbsp;%v&#34;</span><span class="op" id="6894834">,</span>&nbsp;<span class="ident" id="6894836">err</span><span class="op" id="6894839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6894842">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6894845">if</span>&nbsp;<span class="ident" id="6894848">name</span>&nbsp;<span class="op" id="6894853">!=</span>&nbsp;<span class="string" id="6894856">&#34;Alice&#34;</span>&nbsp;<span class="op" id="6894864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6894868">t</span><span class="op" id="6894869">.</span><span class="ident" id="6894870">Errorf</span><span class="op" id="6894876">(</span><span class="string" id="6894877">&#34;expected&nbsp;name&nbsp;Alice,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="6894906">,</span>&nbsp;<span class="ident" id="6894908">name</span><span class="op" id="6894912">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6894915">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6894918">if</span>&nbsp;<span class="ident" id="6894921">age</span>&nbsp;<span class="op" id="6894925">!=</span>&nbsp;<span class="num" id="6894928">1</span>&nbsp;<span class="op" id="6894930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6894934">t</span><span class="op" id="6894935">.</span><span class="ident" id="6894936">Errorf</span><span class="op" id="6894942">(</span><span class="string" id="6894943">&#34;expected&nbsp;age&nbsp;1,&nbsp;got&nbsp;%d&#34;</span><span class="op" id="6894967">,</span>&nbsp;<span class="ident" id="6894969">age</span><span class="op" id="6894972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6894975">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6894979">var</span>&nbsp;<span class="ident" id="6894983">photo</span>&nbsp;<span class="op" id="6894989">[</span><span class="op" id="6894990">]</span><span class="builtintype" id="6894991">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6894997">err</span>&nbsp;<span class="op" id="6895001">=</span>&nbsp;<span class="ident" id="6895003">db</span><span class="op" id="6895005">.</span><span class="ident" id="6895006">QueryRow</span><span class="op" id="6895014">(</span><span class="string" id="6895015">&#34;SELECT|people|photo|name=?&#34;</span><span class="op" id="6895043">,</span>&nbsp;<span class="string" id="6895045">&#34;Alice&#34;</span><span class="op" id="6895052">)</span><span class="op" id="6895053">.</span><span class="ident" id="6895054">Scan</span><span class="op" id="6895058">(</span><span class="op" id="6895059">&amp;</span><span class="ident" id="6895060">photo</span><span class="op" id="6895065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6895068">if</span>&nbsp;<span class="ident" id="6895071">err</span>&nbsp;<span class="op" id="6895075">!=</span>&nbsp;<span class="ident" id="6895078">nil</span>&nbsp;<span class="op" id="6895082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6895086">t</span><span class="op" id="6895087">.</span><span class="ident" id="6895088">Fatalf</span><span class="op" id="6895094">(</span><span class="string" id="6895095">&#34;photo&nbsp;QueryRow+Scan:&nbsp;%v&#34;</span><span class="op" id="6895120">,</span>&nbsp;<span class="ident" id="6895122">err</span><span class="op" id="6895125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6895128">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6895131">want</span>&nbsp;<span class="op" id="6895136">:=</span>&nbsp;<span class="op" id="6895139">[</span><span class="op" id="6895140">]</span><span class="builtintype" id="6895141">byte</span><span class="op" id="6895145">(</span><span class="string" id="6895146">&#34;APHOTO&#34;</span><span class="op" id="6895154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6895157">if</span>&nbsp;<span class="op" id="6895160">!</span><span class="ident" id="6895161">reflect</span><span class="op" id="6895168">.</span><span class="ident" id="6895169">DeepEqual</span><span class="op" id="6895178">(</span><span class="ident" id="6895179">photo</span><span class="op" id="6895184">,</span>&nbsp;<span class="ident" id="6895186">want</span><span class="op" id="6895190">)</span>&nbsp;<span class="op" id="6895192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6895196">t</span><span class="op" id="6895197">.</span><span class="ident" id="6895198">Errorf</span><span class="op" id="6895204">(</span><span class="string" id="6895205">&#34;photo&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="6895226">,</span>&nbsp;<span class="ident" id="6895228">photo</span><span class="op" id="6895233">,</span>&nbsp;<span class="ident" id="6895235">want</span><span class="op" id="6895239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6895242">}</span><br>
<span class="lineno"></span><span class="op" id="6895244">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span><span class="keyword" id="6895247">func</span>&nbsp;<span class="ident" id="6895252">TestStatementErrorAfterClose</span><span class="op" id="6895280">(</span><span class="ident" id="6895281">t</span>&nbsp;<span class="op" id="6895283">*</span><span class="ident" id="6895284">testing</span><span class="op" id="6895291">.</span><span class="ident" id="6895292">T</span><span class="op" id="6895293">)</span>&nbsp;<span class="op" id="6895295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6895298">db</span>&nbsp;<span class="op" id="6895301">:=</span>&nbsp;<span class="ident" id="6895304">newTestDB</span><span class="op" id="6895313">(</span><span class="ident" id="6895314">t</span><span class="op" id="6895315">,</span>&nbsp;<span class="string" id="6895317">&#34;people&#34;</span><span class="op" id="6895325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6895328">defer</span>&nbsp;<span class="ident" id="6895334">closeDB</span><span class="op" id="6895341">(</span><span class="ident" id="6895342">t</span><span class="op" id="6895343">,</span>&nbsp;<span class="ident" id="6895345">db</span><span class="op" id="6895347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6895350">stmt</span><span class="op" id="6895354">,</span>&nbsp;<span class="ident" id="6895356">err</span>&nbsp;<span class="op" id="6895360">:=</span>&nbsp;<span class="ident" id="6895363">db</span><span class="op" id="6895365">.</span><span class="ident" id="6895366">Prepare</span><span class="op" id="6895373">(</span><span class="string" id="6895374">&#34;SELECT|people|age|name=?&#34;</span><span class="op" id="6895400">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6895403">if</span>&nbsp;<span class="ident" id="6895406">err</span>&nbsp;<span class="op" id="6895410">!=</span>&nbsp;<span class="ident" id="6895413">nil</span>&nbsp;<span class="op" id="6895417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6895421">t</span><span class="op" id="6895422">.</span><span class="ident" id="6895423">Fatalf</span><span class="op" id="6895429">(</span><span class="string" id="6895430">&#34;Prepare:&nbsp;%v&#34;</span><span class="op" id="6895443">,</span>&nbsp;<span class="ident" id="6895445">err</span><span class="op" id="6895448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6895451">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6895454">err</span>&nbsp;<span class="op" id="6895458">=</span>&nbsp;<span class="ident" id="6895460">stmt</span><span class="op" id="6895464">.</span><span class="ident" id="6895465">Close</span><span class="op" id="6895470">(</span><span class="op" id="6895471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6895474">if</span>&nbsp;<span class="ident" id="6895477">err</span>&nbsp;<span class="op" id="6895481">!=</span>&nbsp;<span class="ident" id="6895484">nil</span>&nbsp;<span class="op" id="6895488">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6895492">t</span><span class="op" id="6895493">.</span><span class="ident" id="6895494">Fatalf</span><span class="op" id="6895500">(</span><span class="string" id="6895501">&#34;Close:&nbsp;%v&#34;</span><span class="op" id="6895512">,</span>&nbsp;<span class="ident" id="6895514">err</span><span class="op" id="6895517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6895520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6895523">var</span>&nbsp;<span class="ident" id="6895527">name</span>&nbsp;<span class="builtintype" id="6895532">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6895540">err</span>&nbsp;<span class="op" id="6895544">=</span>&nbsp;<span class="ident" id="6895546">stmt</span><span class="op" id="6895550">.</span><span class="ident" id="6895551">QueryRow</span><span class="op" id="6895559">(</span><span class="string" id="6895560">&#34;foo&#34;</span><span class="op" id="6895565">)</span><span class="op" id="6895566">.</span><span class="ident" id="6895567">Scan</span><span class="op" id="6895571">(</span><span class="op" id="6895572">&amp;</span><span class="ident" id="6895573">name</span><span class="op" id="6895577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6895580">if</span>&nbsp;<span class="ident" id="6895583">err</span>&nbsp;<span class="op" id="6895587">==</span>&nbsp;<span class="ident" id="6895590">nil</span>&nbsp;<span class="op" id="6895594">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6895598">t</span><span class="op" id="6895599">.</span><span class="ident" id="6895600">Errorf</span><span class="op" id="6895606">(</span><span class="string" id="6895607">&#34;expected&nbsp;error&nbsp;from&nbsp;QueryRow.Scan&nbsp;after&nbsp;Stmt.Close&#34;</span><span class="op" id="6895659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6895662">}</span><br>
<span class="lineno"></span><span class="op" id="6895664">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6895667">func</span>&nbsp;<span class="ident" id="6895672">TestStatementQueryRow</span><span class="op" id="6895693">(</span><span class="ident" id="6895694">t</span>&nbsp;<span class="op" id="6895696">*</span><span class="ident" id="6895697">testing</span><span class="op" id="6895704">.</span><span class="ident" id="6895705">T</span><span class="op" id="6895706">)</span>&nbsp;<span class="op" id="6895708">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6895711">db</span>&nbsp;<span class="op" id="6895714">:=</span>&nbsp;<span class="ident" id="6895717">newTestDB</span><span class="op" id="6895726">(</span><span class="ident" id="6895727">t</span><span class="op" id="6895728">,</span>&nbsp;<span class="string" id="6895730">&#34;people&#34;</span><span class="op" id="6895738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6895741">defer</span>&nbsp;<span class="ident" id="6895747">closeDB</span><span class="op" id="6895754">(</span><span class="ident" id="6895755">t</span><span class="op" id="6895756">,</span>&nbsp;<span class="ident" id="6895758">db</span><span class="op" id="6895760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6895763">stmt</span><span class="op" id="6895767">,</span>&nbsp;<span class="ident" id="6895769">err</span>&nbsp;<span class="op" id="6895773">:=</span>&nbsp;<span class="ident" id="6895776">db</span><span class="op" id="6895778">.</span><span class="ident" id="6895779">Prepare</span><span class="op" id="6895786">(</span><span class="string" id="6895787">&#34;SELECT|people|age|name=?&#34;</span><span class="op" id="6895813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6895816">if</span>&nbsp;<span class="ident" id="6895819">err</span>&nbsp;<span class="op" id="6895823">!=</span>&nbsp;<span class="ident" id="6895826">nil</span>&nbsp;<span class="op" id="6895830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6895834">t</span><span class="op" id="6895835">.</span><span class="ident" id="6895836">Fatalf</span><span class="op" id="6895842">(</span><span class="string" id="6895843">&#34;Prepare:&nbsp;%v&#34;</span><span class="op" id="6895856">,</span>&nbsp;<span class="ident" id="6895858">err</span><span class="op" id="6895861">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6895864">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6895867">defer</span>&nbsp;<span class="ident" id="6895873">stmt</span><span class="op" id="6895877">.</span><span class="ident" id="6895878">Close</span><span class="op" id="6895883">(</span><span class="op" id="6895884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6895887">var</span>&nbsp;<span class="ident" id="6895891">age</span>&nbsp;<span class="builtintype" id="6895895">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6895900">for</span>&nbsp;<span class="ident" id="6895904">n</span><span class="op" id="6895905">,</span>&nbsp;<span class="ident" id="6895907">tt</span>&nbsp;<span class="op" id="6895910">:=</span>&nbsp;<span class="keyword" id="6895913">range</span>&nbsp;<span class="op" id="6895919">[</span><span class="op" id="6895920">]</span><span class="keyword" id="6895921">struct</span>&nbsp;<span class="op" id="6895928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6895932">name</span>&nbsp;<span class="builtintype" id="6895937">string</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6895946">want</span>&nbsp;<span class="builtintype" id="6895951">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6895956">}</span><span class="op" id="6895957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6895961">{</span><span class="string" id="6895962">&#34;Alice&#34;</span><span class="op" id="6895969">,</span>&nbsp;<span class="num" id="6895971">1</span><span class="op" id="6895972">}</span><span class="op" id="6895973">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6895977">{</span><span class="string" id="6895978">&#34;Bob&#34;</span><span class="op" id="6895983">,</span>&nbsp;<span class="num" id="6895985">2</span><span class="op" id="6895986">}</span><span class="op" id="6895987">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6895991">{</span><span class="string" id="6895992">&#34;Chris&#34;</span><span class="op" id="6895999">,</span>&nbsp;<span class="num" id="6896001">3</span><span class="op" id="6896002">}</span><span class="op" id="6896003">,</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6896006">}</span>&nbsp;<span class="op" id="6896008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6896012">if</span>&nbsp;<span class="ident" id="6896015">err</span>&nbsp;<span class="op" id="6896019">:=</span>&nbsp;<span class="ident" id="6896022">stmt</span><span class="op" id="6896026">.</span><span class="ident" id="6896027">QueryRow</span><span class="op" id="6896035">(</span><span class="ident" id="6896036">tt</span><span class="op" id="6896038">.</span><span class="ident" id="6896039">name</span><span class="op" id="6896043">)</span><span class="op" id="6896044">.</span><span class="ident" id="6896045">Scan</span><span class="op" id="6896049">(</span><span class="op" id="6896050">&amp;</span><span class="ident" id="6896051">age</span><span class="op" id="6896054">)</span><span class="op" id="6896055">;</span>&nbsp;<span class="ident" id="6896057">err</span>&nbsp;<span class="op" id="6896061">!=</span>&nbsp;<span class="ident" id="6896064">nil</span>&nbsp;<span class="op" id="6896068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6896073">t</span><span class="op" id="6896074">.</span><span class="ident" id="6896075">Errorf</span><span class="op" id="6896081">(</span><span class="string" id="6896082">&#34;%d:&nbsp;on&nbsp;%q,&nbsp;QueryRow/Scan:&nbsp;%v&#34;</span><span class="op" id="6896112">,</span>&nbsp;<span class="ident" id="6896114">n</span><span class="op" id="6896115">,</span>&nbsp;<span class="ident" id="6896117">tt</span><span class="op" id="6896119">.</span><span class="ident" id="6896120">name</span><span class="op" id="6896124">,</span>&nbsp;<span class="ident" id="6896126">err</span><span class="op" id="6896129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6896133">}</span>&nbsp;<span class="keyword" id="6896135">else</span>&nbsp;<span class="keyword" id="6896140">if</span>&nbsp;<span class="ident" id="6896143">age</span>&nbsp;<span class="op" id="6896147">!=</span>&nbsp;<span class="ident" id="6896150">tt</span><span class="op" id="6896152">.</span><span class="ident" id="6896153">want</span>&nbsp;<span class="op" id="6896158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6896163">t</span><span class="op" id="6896164">.</span><span class="ident" id="6896165">Errorf</span><span class="op" id="6896171">(</span><span class="string" id="6896172">&#34;%d:&nbsp;age=%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6896193">,</span>&nbsp;<span class="ident" id="6896195">n</span><span class="op" id="6896196">,</span>&nbsp;<span class="ident" id="6896198">age</span><span class="op" id="6896201">,</span>&nbsp;<span class="ident" id="6896203">tt</span><span class="op" id="6896205">.</span><span class="ident" id="6896206">want</span><span class="op" id="6896210">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6896214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6896217">}</span><br>
<span class="lineno"></span><span class="op" id="6896219">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6896222">//&nbsp;golang.org/issue/3734</span><br>
<span class="lineno">360</span><span class="keyword" id="6896247">func</span>&nbsp;<span class="ident" id="6896252">TestStatementQueryRowConcurrent</span><span class="op" id="6896283">(</span><span class="ident" id="6896284">t</span>&nbsp;<span class="op" id="6896286">*</span><span class="ident" id="6896287">testing</span><span class="op" id="6896294">.</span><span class="ident" id="6896295">T</span><span class="op" id="6896296">)</span>&nbsp;<span class="op" id="6896298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6896301">db</span>&nbsp;<span class="op" id="6896304">:=</span>&nbsp;<span class="ident" id="6896307">newTestDB</span><span class="op" id="6896316">(</span><span class="ident" id="6896317">t</span><span class="op" id="6896318">,</span>&nbsp;<span class="string" id="6896320">&#34;people&#34;</span><span class="op" id="6896328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6896331">defer</span>&nbsp;<span class="ident" id="6896337">closeDB</span><span class="op" id="6896344">(</span><span class="ident" id="6896345">t</span><span class="op" id="6896346">,</span>&nbsp;<span class="ident" id="6896348">db</span><span class="op" id="6896350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6896353">stmt</span><span class="op" id="6896357">,</span>&nbsp;<span class="ident" id="6896359">err</span>&nbsp;<span class="op" id="6896363">:=</span>&nbsp;<span class="ident" id="6896366">db</span><span class="op" id="6896368">.</span><span class="ident" id="6896369">Prepare</span><span class="op" id="6896376">(</span><span class="string" id="6896377">&#34;SELECT|people|age|name=?&#34;</span><span class="op" id="6896403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6896406">if</span>&nbsp;<span class="ident" id="6896409">err</span>&nbsp;<span class="op" id="6896413">!=</span>&nbsp;<span class="ident" id="6896416">nil</span>&nbsp;<span class="op" id="6896420">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6896424">t</span><span class="op" id="6896425">.</span><span class="ident" id="6896426">Fatalf</span><span class="op" id="6896432">(</span><span class="string" id="6896433">&#34;Prepare:&nbsp;%v&#34;</span><span class="op" id="6896446">,</span>&nbsp;<span class="ident" id="6896448">err</span><span class="op" id="6896451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6896454">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6896457">defer</span>&nbsp;<span class="ident" id="6896463">stmt</span><span class="op" id="6896467">.</span><span class="ident" id="6896468">Close</span><span class="op" id="6896473">(</span><span class="op" id="6896474">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6896478">const</span>&nbsp;<span class="ident" id="6896484">n</span>&nbsp;<span class="op" id="6896486">=</span>&nbsp;<span class="num" id="6896488">10</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6896492">ch</span>&nbsp;<span class="op" id="6896495">:=</span>&nbsp;<span class="builtinfunc" id="6896498">make</span><span class="op" id="6896502">(</span><span class="keyword" id="6896503">chan</span>&nbsp;<span class="builtintype" id="6896508">error</span><span class="op" id="6896513">,</span>&nbsp;<span class="ident" id="6896515">n</span><span class="op" id="6896516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6896519">for</span>&nbsp;<span class="ident" id="6896523">i</span>&nbsp;<span class="op" id="6896525">:=</span>&nbsp;<span class="num" id="6896528">0</span><span class="op" id="6896529">;</span>&nbsp;<span class="ident" id="6896531">i</span>&nbsp;<span class="op" id="6896533">&lt;</span>&nbsp;<span class="ident" id="6896535">n</span><span class="op" id="6896536">;</span>&nbsp;<span class="ident" id="6896538">i</span><span class="op" id="6896539">++</span>&nbsp;<span class="op" id="6896542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6896546">go</span>&nbsp;<span class="keyword" id="6896549">func</span><span class="op" id="6896553">(</span><span class="op" id="6896554">)</span>&nbsp;<span class="op" id="6896556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6896561">var</span>&nbsp;<span class="ident" id="6896565">age</span>&nbsp;<span class="builtintype" id="6896569">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6896576">err</span>&nbsp;<span class="op" id="6896580">:=</span>&nbsp;<span class="ident" id="6896583">stmt</span><span class="op" id="6896587">.</span><span class="ident" id="6896588">QueryRow</span><span class="op" id="6896596">(</span><span class="string" id="6896597">&#34;Alice&#34;</span><span class="op" id="6896604">)</span><span class="op" id="6896605">.</span><span class="ident" id="6896606">Scan</span><span class="op" id="6896610">(</span><span class="op" id="6896611">&amp;</span><span class="ident" id="6896612">age</span><span class="op" id="6896615">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6896620">if</span>&nbsp;<span class="ident" id="6896623">err</span>&nbsp;<span class="op" id="6896627">==</span>&nbsp;<span class="ident" id="6896630">nil</span>&nbsp;<span class="op" id="6896634">&amp;&amp;</span>&nbsp;<span class="ident" id="6896637">age</span>&nbsp;<span class="op" id="6896641">!=</span>&nbsp;<span class="num" id="6896644">1</span>&nbsp;<span class="op" id="6896646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6896652">err</span>&nbsp;<span class="op" id="6896656">=</span>&nbsp;<span class="ident" id="6896658">fmt</span><span class="op" id="6896661">.</span><span class="ident" id="6896662">Errorf</span><span class="op" id="6896668">(</span><span class="string" id="6896669">&#34;unexpected&nbsp;age&nbsp;%d&#34;</span><span class="op" id="6896688">,</span>&nbsp;<span class="ident" id="6896690">age</span><span class="op" id="6896693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6896698">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6896703">ch</span>&nbsp;<span class="op" id="6896706">&lt;-</span>&nbsp;<span class="ident" id="6896709">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6896715">}</span><span class="op" id="6896716">(</span><span class="op" id="6896717">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6896720">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6896723">for</span>&nbsp;<span class="ident" id="6896727">i</span>&nbsp;<span class="op" id="6896729">:=</span>&nbsp;<span class="num" id="6896732">0</span><span class="op" id="6896733">;</span>&nbsp;<span class="ident" id="6896735">i</span>&nbsp;<span class="op" id="6896737">&lt;</span>&nbsp;<span class="ident" id="6896739">n</span><span class="op" id="6896740">;</span>&nbsp;<span class="ident" id="6896742">i</span><span class="op" id="6896743">++</span>&nbsp;<span class="op" id="6896746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6896750">if</span>&nbsp;<span class="ident" id="6896753">err</span>&nbsp;<span class="op" id="6896757">:=</span>&nbsp;<span class="op" id="6896760">&lt;-</span><span class="ident" id="6896762">ch</span><span class="op" id="6896764">;</span>&nbsp;<span class="ident" id="6896766">err</span>&nbsp;<span class="op" id="6896770">!=</span>&nbsp;<span class="ident" id="6896773">nil</span>&nbsp;<span class="op" id="6896777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6896782">t</span><span class="op" id="6896783">.</span><span class="ident" id="6896784">Error</span><span class="op" id="6896789">(</span><span class="ident" id="6896790">err</span><span class="op" id="6896793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6896797">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6896800">}</span><br>
<span class="lineno"></span><span class="op" id="6896802">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6896805">//&nbsp;just&nbsp;a&nbsp;test&nbsp;of&nbsp;fakedb&nbsp;itself</span><br>
<span class="lineno"></span><span class="keyword" id="6896837">func</span>&nbsp;<span class="ident" id="6896842">TestBogusPreboundParameters</span><span class="op" id="6896869">(</span><span class="ident" id="6896870">t</span>&nbsp;<span class="op" id="6896872">*</span><span class="ident" id="6896873">testing</span><span class="op" id="6896880">.</span><span class="ident" id="6896881">T</span><span class="op" id="6896882">)</span>&nbsp;<span class="op" id="6896884">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6896887">db</span>&nbsp;<span class="op" id="6896890">:=</span>&nbsp;<span class="ident" id="6896893">newTestDB</span><span class="op" id="6896902">(</span><span class="ident" id="6896903">t</span><span class="op" id="6896904">,</span>&nbsp;<span class="string" id="6896906">&#34;foo&#34;</span><span class="op" id="6896911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6896914">defer</span>&nbsp;<span class="ident" id="6896920">closeDB</span><span class="op" id="6896927">(</span><span class="ident" id="6896928">t</span><span class="op" id="6896929">,</span>&nbsp;<span class="ident" id="6896931">db</span><span class="op" id="6896933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6896936">exec</span><span class="op" id="6896940">(</span><span class="ident" id="6896941">t</span><span class="op" id="6896942">,</span>&nbsp;<span class="ident" id="6896944">db</span><span class="op" id="6896946">,</span>&nbsp;<span class="string" id="6896948">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="6896991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6896994">_</span><span class="op" id="6896995">,</span>&nbsp;<span class="ident" id="6896997">err</span>&nbsp;<span class="op" id="6897001">:=</span>&nbsp;<span class="ident" id="6897004">db</span><span class="op" id="6897006">.</span><span class="ident" id="6897007">Prepare</span><span class="op" id="6897014">(</span><span class="string" id="6897015">&#34;INSERT|t1|name=?,age=bogusconversion&#34;</span><span class="op" id="6897053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6897056">if</span>&nbsp;<span class="ident" id="6897059">err</span>&nbsp;<span class="op" id="6897063">==</span>&nbsp;<span class="ident" id="6897066">nil</span>&nbsp;<span class="op" id="6897070">{</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6897074">t</span><span class="op" id="6897075">.</span><span class="ident" id="6897076">Fatalf</span><span class="op" id="6897082">(</span><span class="string" id="6897083">&#34;expected&nbsp;error&#34;</span><span class="op" id="6897099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6897102">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6897105">if</span>&nbsp;<span class="ident" id="6897108">err</span><span class="op" id="6897111">.</span><span class="ident" id="6897112">Error</span><span class="op" id="6897117">(</span><span class="op" id="6897118">)</span>&nbsp;<span class="op" id="6897120">!=</span>&nbsp;<span class="string" id="6897123">`fakedb:&nbsp;invalid&nbsp;conversion&nbsp;to&nbsp;int32&nbsp;from&nbsp;&#34;bogusconversion&#34;`</span>&nbsp;<span class="op" id="6897184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6897188">t</span><span class="op" id="6897189">.</span><span class="ident" id="6897190">Errorf</span><span class="op" id="6897196">(</span><span class="string" id="6897197">&#34;unexpected&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="6897219">,</span>&nbsp;<span class="ident" id="6897221">err</span><span class="op" id="6897224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6897227">}</span><br>
<span class="lineno">400</span><span class="op" id="6897229">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6897232">func</span>&nbsp;<span class="ident" id="6897237">TestExec</span><span class="op" id="6897245">(</span><span class="ident" id="6897246">t</span>&nbsp;<span class="op" id="6897248">*</span><span class="ident" id="6897249">testing</span><span class="op" id="6897256">.</span><span class="ident" id="6897257">T</span><span class="op" id="6897258">)</span>&nbsp;<span class="op" id="6897260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6897263">db</span>&nbsp;<span class="op" id="6897266">:=</span>&nbsp;<span class="ident" id="6897269">newTestDB</span><span class="op" id="6897278">(</span><span class="ident" id="6897279">t</span><span class="op" id="6897280">,</span>&nbsp;<span class="string" id="6897282">&#34;foo&#34;</span><span class="op" id="6897287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6897290">defer</span>&nbsp;<span class="ident" id="6897296">closeDB</span><span class="op" id="6897303">(</span><span class="ident" id="6897304">t</span><span class="op" id="6897305">,</span>&nbsp;<span class="ident" id="6897307">db</span><span class="op" id="6897309">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6897312">exec</span><span class="op" id="6897316">(</span><span class="ident" id="6897317">t</span><span class="op" id="6897318">,</span>&nbsp;<span class="ident" id="6897320">db</span><span class="op" id="6897322">,</span>&nbsp;<span class="string" id="6897324">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="6897367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6897370">stmt</span><span class="op" id="6897374">,</span>&nbsp;<span class="ident" id="6897376">err</span>&nbsp;<span class="op" id="6897380">:=</span>&nbsp;<span class="ident" id="6897383">db</span><span class="op" id="6897385">.</span><span class="ident" id="6897386">Prepare</span><span class="op" id="6897393">(</span><span class="string" id="6897394">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="6897418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6897421">if</span>&nbsp;<span class="ident" id="6897424">err</span>&nbsp;<span class="op" id="6897428">!=</span>&nbsp;<span class="ident" id="6897431">nil</span>&nbsp;<span class="op" id="6897435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6897439">t</span><span class="op" id="6897440">.</span><span class="ident" id="6897441">Errorf</span><span class="op" id="6897447">(</span><span class="string" id="6897448">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="6897468">,</span>&nbsp;<span class="ident" id="6897470">stmt</span><span class="op" id="6897474">,</span>&nbsp;<span class="ident" id="6897476">err</span><span class="op" id="6897479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6897482">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6897485">defer</span>&nbsp;<span class="ident" id="6897491">stmt</span><span class="op" id="6897495">.</span><span class="ident" id="6897496">Close</span><span class="op" id="6897501">(</span><span class="op" id="6897502">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6897506">type</span>&nbsp;<span class="ident" id="6897511">execTest</span>&nbsp;<span class="keyword" id="6897520">struct</span>&nbsp;<span class="op" id="6897527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6897531">args</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6897539">[</span><span class="op" id="6897540">]</span><span class="keyword" id="6897541">interface</span><span class="op" id="6897550">{</span><span class="op" id="6897551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6897555">wantErr</span>&nbsp;<span class="builtintype" id="6897563">string</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6897571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6897574">execTests</span>&nbsp;<span class="op" id="6897584">:=</span>&nbsp;<span class="op" id="6897587">[</span><span class="op" id="6897588">]</span><span class="ident" id="6897589">execTest</span><span class="op" id="6897597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6897601">//&nbsp;Okay:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6897612">{</span><span class="op" id="6897613">[</span><span class="op" id="6897614">]</span><span class="keyword" id="6897615">interface</span><span class="op" id="6897624">{</span><span class="op" id="6897625">}</span><span class="op" id="6897626">{</span><span class="string" id="6897627">&#34;Brad&#34;</span><span class="op" id="6897633">,</span>&nbsp;<span class="num" id="6897635">31</span><span class="op" id="6897637">}</span><span class="op" id="6897638">,</span>&nbsp;<span class="string" id="6897640">&#34;&#34;</span><span class="op" id="6897642">}</span><span class="op" id="6897643">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6897647">{</span><span class="op" id="6897648">[</span><span class="op" id="6897649">]</span><span class="keyword" id="6897650">interface</span><span class="op" id="6897659">{</span><span class="op" id="6897660">}</span><span class="op" id="6897661">{</span><span class="string" id="6897662">&#34;Brad&#34;</span><span class="op" id="6897668">,</span>&nbsp;<span class="ident" id="6897670">int64</span><span class="op" id="6897675">(</span><span class="num" id="6897676">31</span><span class="op" id="6897678">)</span><span class="op" id="6897679">}</span><span class="op" id="6897680">,</span>&nbsp;<span class="string" id="6897682">&#34;&#34;</span><span class="op" id="6897684">}</span><span class="op" id="6897685">,</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6897689">{</span><span class="op" id="6897690">[</span><span class="op" id="6897691">]</span><span class="keyword" id="6897692">interface</span><span class="op" id="6897701">{</span><span class="op" id="6897702">}</span><span class="op" id="6897703">{</span><span class="string" id="6897704">&#34;Bob&#34;</span><span class="op" id="6897709">,</span>&nbsp;<span class="string" id="6897711">&#34;32&#34;</span><span class="op" id="6897715">}</span><span class="op" id="6897716">,</span>&nbsp;<span class="string" id="6897718">&#34;&#34;</span><span class="op" id="6897720">}</span><span class="op" id="6897721">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6897725">{</span><span class="op" id="6897726">[</span><span class="op" id="6897727">]</span><span class="keyword" id="6897728">interface</span><span class="op" id="6897737">{</span><span class="op" id="6897738">}</span><span class="op" id="6897739">{</span><span class="num" id="6897740">7</span><span class="op" id="6897741">,</span>&nbsp;<span class="num" id="6897743">9</span><span class="op" id="6897744">}</span><span class="op" id="6897745">,</span>&nbsp;<span class="string" id="6897747">&#34;&#34;</span><span class="op" id="6897749">}</span><span class="op" id="6897750">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6897755">//&nbsp;Invalid&nbsp;conversions:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6897781">{</span><span class="op" id="6897782">[</span><span class="op" id="6897783">]</span><span class="keyword" id="6897784">interface</span><span class="op" id="6897793">{</span><span class="op" id="6897794">}</span><span class="op" id="6897795">{</span><span class="string" id="6897796">&#34;Brad&#34;</span><span class="op" id="6897802">,</span>&nbsp;<span class="ident" id="6897804">int64</span><span class="op" id="6897809">(</span><span class="num" id="6897810">0xFFFFFFFF</span><span class="op" id="6897820">)</span><span class="op" id="6897821">}</span><span class="op" id="6897822">,</span>&nbsp;<span class="string" id="6897824">&#34;sql:&nbsp;converting&nbsp;argument&nbsp;#1&#39;s&nbsp;type:&nbsp;sql/driver:&nbsp;value&nbsp;4294967295&nbsp;overflows&nbsp;int32&#34;</span><span class="op" id="6897906">}</span><span class="op" id="6897907">,</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6897911">{</span><span class="op" id="6897912">[</span><span class="op" id="6897913">]</span><span class="keyword" id="6897914">interface</span><span class="op" id="6897923">{</span><span class="op" id="6897924">}</span><span class="op" id="6897925">{</span><span class="string" id="6897926">&#34;Brad&#34;</span><span class="op" id="6897932">,</span>&nbsp;<span class="string" id="6897934">&#34;strconv&nbsp;fail&#34;</span><span class="op" id="6897948">}</span><span class="op" id="6897949">,</span>&nbsp;<span class="string" id="6897951">&#34;sql:&nbsp;converting&nbsp;argument&nbsp;#1&#39;s&nbsp;type:&nbsp;sql/driver:&nbsp;value&nbsp;\&#34;strconv&nbsp;fail\&#34;&nbsp;can&#39;t&nbsp;be&nbsp;converted&nbsp;to&nbsp;int32&#34;</span><span class="op" id="6898051">}</span><span class="op" id="6898052">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6898057">//&nbsp;Wrong&nbsp;number&nbsp;of&nbsp;args:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6898084">{</span><span class="op" id="6898085">[</span><span class="op" id="6898086">]</span><span class="keyword" id="6898087">interface</span><span class="op" id="6898096">{</span><span class="op" id="6898097">}</span><span class="op" id="6898098">{</span><span class="op" id="6898099">}</span><span class="op" id="6898100">,</span>&nbsp;<span class="string" id="6898102">&#34;sql:&nbsp;expected&nbsp;2&nbsp;arguments,&nbsp;got&nbsp;0&#34;</span><span class="op" id="6898136">}</span><span class="op" id="6898137">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6898141">{</span><span class="op" id="6898142">[</span><span class="op" id="6898143">]</span><span class="keyword" id="6898144">interface</span><span class="op" id="6898153">{</span><span class="op" id="6898154">}</span><span class="op" id="6898155">{</span><span class="num" id="6898156">1</span><span class="op" id="6898157">,</span>&nbsp;<span class="num" id="6898159">2</span><span class="op" id="6898160">,</span>&nbsp;<span class="num" id="6898162">3</span><span class="op" id="6898163">}</span><span class="op" id="6898164">,</span>&nbsp;<span class="string" id="6898166">&#34;sql:&nbsp;expected&nbsp;2&nbsp;arguments,&nbsp;got&nbsp;3&#34;</span><span class="op" id="6898200">}</span><span class="op" id="6898201">,</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6898204">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6898207">for</span>&nbsp;<span class="ident" id="6898211">n</span><span class="op" id="6898212">,</span>&nbsp;<span class="ident" id="6898214">et</span>&nbsp;<span class="op" id="6898217">:=</span>&nbsp;<span class="keyword" id="6898220">range</span>&nbsp;<span class="ident" id="6898226">execTests</span>&nbsp;<span class="op" id="6898236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6898240">_</span><span class="op" id="6898241">,</span>&nbsp;<span class="ident" id="6898243">err</span>&nbsp;<span class="op" id="6898247">:=</span>&nbsp;<span class="ident" id="6898250">stmt</span><span class="op" id="6898254">.</span><span class="ident" id="6898255">Exec</span><span class="op" id="6898259">(</span><span class="ident" id="6898260">et</span><span class="op" id="6898262">.</span><span class="ident" id="6898263">args</span><span class="op" id="6898267">...</span><span class="op" id="6898270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6898274">errStr</span>&nbsp;<span class="op" id="6898281">:=</span>&nbsp;<span class="string" id="6898284">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6898289">if</span>&nbsp;<span class="ident" id="6898292">err</span>&nbsp;<span class="op" id="6898296">!=</span>&nbsp;<span class="ident" id="6898299">nil</span>&nbsp;<span class="op" id="6898303">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6898308">errStr</span>&nbsp;<span class="op" id="6898315">=</span>&nbsp;<span class="ident" id="6898317">err</span><span class="op" id="6898320">.</span><span class="ident" id="6898321">Error</span><span class="op" id="6898326">(</span><span class="op" id="6898327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6898331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6898335">if</span>&nbsp;<span class="ident" id="6898338">errStr</span>&nbsp;<span class="op" id="6898345">!=</span>&nbsp;<span class="ident" id="6898348">et</span><span class="op" id="6898350">.</span><span class="ident" id="6898351">wantErr</span>&nbsp;<span class="op" id="6898359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6898364">t</span><span class="op" id="6898365">.</span><span class="ident" id="6898366">Errorf</span><span class="op" id="6898372">(</span><span class="string" id="6898373">&#34;stmt.Execute&nbsp;#%d:&nbsp;for&nbsp;%v,&nbsp;got&nbsp;error&nbsp;%q,&nbsp;want&nbsp;error&nbsp;%q&#34;</span><span class="op" id="6898428">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6898434">n</span><span class="op" id="6898435">,</span>&nbsp;<span class="ident" id="6898437">et</span><span class="op" id="6898439">.</span><span class="ident" id="6898440">args</span><span class="op" id="6898444">,</span>&nbsp;<span class="ident" id="6898446">errStr</span><span class="op" id="6898452">,</span>&nbsp;<span class="ident" id="6898454">et</span><span class="op" id="6898456">.</span><span class="ident" id="6898457">wantErr</span><span class="op" id="6898464">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6898468">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6898471">}</span><br>
<span class="lineno"></span><span class="op" id="6898473">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6898476">func</span>&nbsp;<span class="ident" id="6898481">TestTxPrepare</span><span class="op" id="6898494">(</span><span class="ident" id="6898495">t</span>&nbsp;<span class="op" id="6898497">*</span><span class="ident" id="6898498">testing</span><span class="op" id="6898505">.</span><span class="ident" id="6898506">T</span><span class="op" id="6898507">)</span>&nbsp;<span class="op" id="6898509">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6898512">db</span>&nbsp;<span class="op" id="6898515">:=</span>&nbsp;<span class="ident" id="6898518">newTestDB</span><span class="op" id="6898527">(</span><span class="ident" id="6898528">t</span><span class="op" id="6898529">,</span>&nbsp;<span class="string" id="6898531">&#34;&#34;</span><span class="op" id="6898533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6898536">defer</span>&nbsp;<span class="ident" id="6898542">closeDB</span><span class="op" id="6898549">(</span><span class="ident" id="6898550">t</span><span class="op" id="6898551">,</span>&nbsp;<span class="ident" id="6898553">db</span><span class="op" id="6898555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6898558">exec</span><span class="op" id="6898562">(</span><span class="ident" id="6898563">t</span><span class="op" id="6898564">,</span>&nbsp;<span class="ident" id="6898566">db</span><span class="op" id="6898568">,</span>&nbsp;<span class="string" id="6898570">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="6898613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6898616">tx</span><span class="op" id="6898618">,</span>&nbsp;<span class="ident" id="6898620">err</span>&nbsp;<span class="op" id="6898624">:=</span>&nbsp;<span class="ident" id="6898627">db</span><span class="op" id="6898629">.</span><span class="ident" id="6898630">Begin</span><span class="op" id="6898635">(</span><span class="op" id="6898636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6898639">if</span>&nbsp;<span class="ident" id="6898642">err</span>&nbsp;<span class="op" id="6898646">!=</span>&nbsp;<span class="ident" id="6898649">nil</span>&nbsp;<span class="op" id="6898653">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6898657">t</span><span class="op" id="6898658">.</span><span class="ident" id="6898659">Fatalf</span><span class="op" id="6898665">(</span><span class="string" id="6898666">&#34;Begin&nbsp;=&nbsp;%v&#34;</span><span class="op" id="6898678">,</span>&nbsp;<span class="ident" id="6898680">err</span><span class="op" id="6898683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6898686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6898689">stmt</span><span class="op" id="6898693">,</span>&nbsp;<span class="ident" id="6898695">err</span>&nbsp;<span class="op" id="6898699">:=</span>&nbsp;<span class="ident" id="6898702">tx</span><span class="op" id="6898704">.</span><span class="ident" id="6898705">Prepare</span><span class="op" id="6898712">(</span><span class="string" id="6898713">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="6898737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6898740">if</span>&nbsp;<span class="ident" id="6898743">err</span>&nbsp;<span class="op" id="6898747">!=</span>&nbsp;<span class="ident" id="6898750">nil</span>&nbsp;<span class="op" id="6898754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6898758">t</span><span class="op" id="6898759">.</span><span class="ident" id="6898760">Fatalf</span><span class="op" id="6898766">(</span><span class="string" id="6898767">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="6898787">,</span>&nbsp;<span class="ident" id="6898789">stmt</span><span class="op" id="6898793">,</span>&nbsp;<span class="ident" id="6898795">err</span><span class="op" id="6898798">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6898801">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6898804">defer</span>&nbsp;<span class="ident" id="6898810">stmt</span><span class="op" id="6898814">.</span><span class="ident" id="6898815">Close</span><span class="op" id="6898820">(</span><span class="op" id="6898821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6898824">_</span><span class="op" id="6898825">,</span>&nbsp;<span class="ident" id="6898827">err</span>&nbsp;<span class="op" id="6898831">=</span>&nbsp;<span class="ident" id="6898833">stmt</span><span class="op" id="6898837">.</span><span class="ident" id="6898838">Exec</span><span class="op" id="6898842">(</span><span class="string" id="6898843">&#34;Bobby&#34;</span><span class="op" id="6898850">,</span>&nbsp;<span class="num" id="6898852">7</span><span class="op" id="6898853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6898856">if</span>&nbsp;<span class="ident" id="6898859">err</span>&nbsp;<span class="op" id="6898863">!=</span>&nbsp;<span class="ident" id="6898866">nil</span>&nbsp;<span class="op" id="6898870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6898874">t</span><span class="op" id="6898875">.</span><span class="ident" id="6898876">Fatalf</span><span class="op" id="6898882">(</span><span class="string" id="6898883">&#34;Exec&nbsp;=&nbsp;%v&#34;</span><span class="op" id="6898894">,</span>&nbsp;<span class="ident" id="6898896">err</span><span class="op" id="6898899">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6898902">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6898905">err</span>&nbsp;<span class="op" id="6898909">=</span>&nbsp;<span class="ident" id="6898911">tx</span><span class="op" id="6898913">.</span><span class="ident" id="6898914">Commit</span><span class="op" id="6898920">(</span><span class="op" id="6898921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6898924">if</span>&nbsp;<span class="ident" id="6898927">err</span>&nbsp;<span class="op" id="6898931">!=</span>&nbsp;<span class="ident" id="6898934">nil</span>&nbsp;<span class="op" id="6898938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6898942">t</span><span class="op" id="6898943">.</span><span class="ident" id="6898944">Fatalf</span><span class="op" id="6898950">(</span><span class="string" id="6898951">&#34;Commit&nbsp;=&nbsp;%v&#34;</span><span class="op" id="6898964">,</span>&nbsp;<span class="ident" id="6898966">err</span><span class="op" id="6898969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6898972">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6898975">//&nbsp;Commit()&nbsp;should&nbsp;have&nbsp;closed&nbsp;the&nbsp;statement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6899021">if</span>&nbsp;<span class="op" id="6899024">!</span><span class="ident" id="6899025">stmt</span><span class="op" id="6899029">.</span><span class="ident" id="6899030">closed</span>&nbsp;<span class="op" id="6899037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6899041">t</span><span class="op" id="6899042">.</span><span class="ident" id="6899043">Fatal</span><span class="op" id="6899048">(</span><span class="string" id="6899049">&#34;Stmt&nbsp;not&nbsp;closed&nbsp;after&nbsp;Commit&#34;</span><span class="op" id="6899079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6899082">}</span><br>
<span class="lineno"></span><span class="op" id="6899084">}</span><br>
<span class="lineno">470</span><br>
<span class="lineno"></span><span class="keyword" id="6899087">func</span>&nbsp;<span class="ident" id="6899092">TestTxStmt</span><span class="op" id="6899102">(</span><span class="ident" id="6899103">t</span>&nbsp;<span class="op" id="6899105">*</span><span class="ident" id="6899106">testing</span><span class="op" id="6899113">.</span><span class="ident" id="6899114">T</span><span class="op" id="6899115">)</span>&nbsp;<span class="op" id="6899117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6899120">db</span>&nbsp;<span class="op" id="6899123">:=</span>&nbsp;<span class="ident" id="6899126">newTestDB</span><span class="op" id="6899135">(</span><span class="ident" id="6899136">t</span><span class="op" id="6899137">,</span>&nbsp;<span class="string" id="6899139">&#34;&#34;</span><span class="op" id="6899141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6899144">defer</span>&nbsp;<span class="ident" id="6899150">closeDB</span><span class="op" id="6899157">(</span><span class="ident" id="6899158">t</span><span class="op" id="6899159">,</span>&nbsp;<span class="ident" id="6899161">db</span><span class="op" id="6899163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6899166">exec</span><span class="op" id="6899170">(</span><span class="ident" id="6899171">t</span><span class="op" id="6899172">,</span>&nbsp;<span class="ident" id="6899174">db</span><span class="op" id="6899176">,</span>&nbsp;<span class="string" id="6899178">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="6899221">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6899224">stmt</span><span class="op" id="6899228">,</span>&nbsp;<span class="ident" id="6899230">err</span>&nbsp;<span class="op" id="6899234">:=</span>&nbsp;<span class="ident" id="6899237">db</span><span class="op" id="6899239">.</span><span class="ident" id="6899240">Prepare</span><span class="op" id="6899247">(</span><span class="string" id="6899248">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="6899272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6899275">if</span>&nbsp;<span class="ident" id="6899278">err</span>&nbsp;<span class="op" id="6899282">!=</span>&nbsp;<span class="ident" id="6899285">nil</span>&nbsp;<span class="op" id="6899289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6899293">t</span><span class="op" id="6899294">.</span><span class="ident" id="6899295">Fatalf</span><span class="op" id="6899301">(</span><span class="string" id="6899302">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="6899322">,</span>&nbsp;<span class="ident" id="6899324">stmt</span><span class="op" id="6899328">,</span>&nbsp;<span class="ident" id="6899330">err</span><span class="op" id="6899333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6899336">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6899339">defer</span>&nbsp;<span class="ident" id="6899345">stmt</span><span class="op" id="6899349">.</span><span class="ident" id="6899350">Close</span><span class="op" id="6899355">(</span><span class="op" id="6899356">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6899359">tx</span><span class="op" id="6899361">,</span>&nbsp;<span class="ident" id="6899363">err</span>&nbsp;<span class="op" id="6899367">:=</span>&nbsp;<span class="ident" id="6899370">db</span><span class="op" id="6899372">.</span><span class="ident" id="6899373">Begin</span><span class="op" id="6899378">(</span><span class="op" id="6899379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6899382">if</span>&nbsp;<span class="ident" id="6899385">err</span>&nbsp;<span class="op" id="6899389">!=</span>&nbsp;<span class="ident" id="6899392">nil</span>&nbsp;<span class="op" id="6899396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6899400">t</span><span class="op" id="6899401">.</span><span class="ident" id="6899402">Fatalf</span><span class="op" id="6899408">(</span><span class="string" id="6899409">&#34;Begin&nbsp;=&nbsp;%v&#34;</span><span class="op" id="6899421">,</span>&nbsp;<span class="ident" id="6899423">err</span><span class="op" id="6899426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6899429">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6899432">txs</span>&nbsp;<span class="op" id="6899436">:=</span>&nbsp;<span class="ident" id="6899439">tx</span><span class="op" id="6899441">.</span><span class="ident" id="6899442">Stmt</span><span class="op" id="6899446">(</span><span class="ident" id="6899447">stmt</span><span class="op" id="6899451">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6899454">defer</span>&nbsp;<span class="ident" id="6899460">txs</span><span class="op" id="6899463">.</span><span class="ident" id="6899464">Close</span><span class="op" id="6899469">(</span><span class="op" id="6899470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6899473">_</span><span class="op" id="6899474">,</span>&nbsp;<span class="ident" id="6899476">err</span>&nbsp;<span class="op" id="6899480">=</span>&nbsp;<span class="ident" id="6899482">txs</span><span class="op" id="6899485">.</span><span class="ident" id="6899486">Exec</span><span class="op" id="6899490">(</span><span class="string" id="6899491">&#34;Bobby&#34;</span><span class="op" id="6899498">,</span>&nbsp;<span class="num" id="6899500">7</span><span class="op" id="6899501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6899504">if</span>&nbsp;<span class="ident" id="6899507">err</span>&nbsp;<span class="op" id="6899511">!=</span>&nbsp;<span class="ident" id="6899514">nil</span>&nbsp;<span class="op" id="6899518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6899522">t</span><span class="op" id="6899523">.</span><span class="ident" id="6899524">Fatalf</span><span class="op" id="6899530">(</span><span class="string" id="6899531">&#34;Exec&nbsp;=&nbsp;%v&#34;</span><span class="op" id="6899542">,</span>&nbsp;<span class="ident" id="6899544">err</span><span class="op" id="6899547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6899550">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6899553">err</span>&nbsp;<span class="op" id="6899557">=</span>&nbsp;<span class="ident" id="6899559">tx</span><span class="op" id="6899561">.</span><span class="ident" id="6899562">Commit</span><span class="op" id="6899568">(</span><span class="op" id="6899569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6899572">if</span>&nbsp;<span class="ident" id="6899575">err</span>&nbsp;<span class="op" id="6899579">!=</span>&nbsp;<span class="ident" id="6899582">nil</span>&nbsp;<span class="op" id="6899586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6899590">t</span><span class="op" id="6899591">.</span><span class="ident" id="6899592">Fatalf</span><span class="op" id="6899598">(</span><span class="string" id="6899599">&#34;Commit&nbsp;=&nbsp;%v&#34;</span><span class="op" id="6899612">,</span>&nbsp;<span class="ident" id="6899614">err</span><span class="op" id="6899617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6899620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6899623">//&nbsp;Commit()&nbsp;should&nbsp;have&nbsp;closed&nbsp;the&nbsp;statement</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6899669">if</span>&nbsp;<span class="op" id="6899672">!</span><span class="ident" id="6899673">txs</span><span class="op" id="6899676">.</span><span class="ident" id="6899677">closed</span>&nbsp;<span class="op" id="6899684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6899688">t</span><span class="op" id="6899689">.</span><span class="ident" id="6899690">Fatal</span><span class="op" id="6899695">(</span><span class="string" id="6899696">&#34;Stmt&nbsp;not&nbsp;closed&nbsp;after&nbsp;Commit&#34;</span><span class="op" id="6899726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6899729">}</span><br>
<span class="lineno"></span><span class="op" id="6899731">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">500</span><span class="comment" id="6899734">//&nbsp;Issue:&nbsp;http://golang.org/issue/2784</span><br>
<span class="lineno"></span><span class="comment" id="6899773">//&nbsp;This&nbsp;test&nbsp;didn&#39;t&nbsp;fail&nbsp;before&nbsp;because&nbsp;we&nbsp;got&nbsp;lucky&nbsp;with&nbsp;the&nbsp;fakedb&nbsp;driver.</span><br>
<span class="lineno"></span><span class="comment" id="6899850">//&nbsp;It&nbsp;was&nbsp;failing,&nbsp;and&nbsp;now&nbsp;not,&nbsp;in&nbsp;github.com/bradfitz/go-sql-test</span><br>
<span class="lineno"></span><span class="keyword" id="6899917">func</span>&nbsp;<span class="ident" id="6899922">TestTxQuery</span><span class="op" id="6899933">(</span><span class="ident" id="6899934">t</span>&nbsp;<span class="op" id="6899936">*</span><span class="ident" id="6899937">testing</span><span class="op" id="6899944">.</span><span class="ident" id="6899945">T</span><span class="op" id="6899946">)</span>&nbsp;<span class="op" id="6899948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6899951">db</span>&nbsp;<span class="op" id="6899954">:=</span>&nbsp;<span class="ident" id="6899957">newTestDB</span><span class="op" id="6899966">(</span><span class="ident" id="6899967">t</span><span class="op" id="6899968">,</span>&nbsp;<span class="string" id="6899970">&#34;&#34;</span><span class="op" id="6899972">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6899975">defer</span>&nbsp;<span class="ident" id="6899981">closeDB</span><span class="op" id="6899988">(</span><span class="ident" id="6899989">t</span><span class="op" id="6899990">,</span>&nbsp;<span class="ident" id="6899992">db</span><span class="op" id="6899994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6899997">exec</span><span class="op" id="6900001">(</span><span class="ident" id="6900002">t</span><span class="op" id="6900003">,</span>&nbsp;<span class="ident" id="6900005">db</span><span class="op" id="6900007">,</span>&nbsp;<span class="string" id="6900009">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="6900052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6900055">exec</span><span class="op" id="6900059">(</span><span class="ident" id="6900060">t</span><span class="op" id="6900061">,</span>&nbsp;<span class="ident" id="6900063">db</span><span class="op" id="6900065">,</span>&nbsp;<span class="string" id="6900067">&#34;INSERT|t1|name=Alice&#34;</span><span class="op" id="6900089">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6900093">tx</span><span class="op" id="6900095">,</span>&nbsp;<span class="ident" id="6900097">err</span>&nbsp;<span class="op" id="6900101">:=</span>&nbsp;<span class="ident" id="6900104">db</span><span class="op" id="6900106">.</span><span class="ident" id="6900107">Begin</span><span class="op" id="6900112">(</span><span class="op" id="6900113">)</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6900116">if</span>&nbsp;<span class="ident" id="6900119">err</span>&nbsp;<span class="op" id="6900123">!=</span>&nbsp;<span class="ident" id="6900126">nil</span>&nbsp;<span class="op" id="6900130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6900134">t</span><span class="op" id="6900135">.</span><span class="ident" id="6900136">Fatal</span><span class="op" id="6900141">(</span><span class="ident" id="6900142">err</span><span class="op" id="6900145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6900148">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6900151">defer</span>&nbsp;<span class="ident" id="6900157">tx</span><span class="op" id="6900159">.</span><span class="ident" id="6900160">Rollback</span><span class="op" id="6900168">(</span><span class="op" id="6900169">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6900173">r</span><span class="op" id="6900174">,</span>&nbsp;<span class="ident" id="6900176">err</span>&nbsp;<span class="op" id="6900180">:=</span>&nbsp;<span class="ident" id="6900183">tx</span><span class="op" id="6900185">.</span><span class="ident" id="6900186">Query</span><span class="op" id="6900191">(</span><span class="string" id="6900192">&#34;SELECT|t1|name|&#34;</span><span class="op" id="6900209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6900212">if</span>&nbsp;<span class="ident" id="6900215">err</span>&nbsp;<span class="op" id="6900219">!=</span>&nbsp;<span class="ident" id="6900222">nil</span>&nbsp;<span class="op" id="6900226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6900230">t</span><span class="op" id="6900231">.</span><span class="ident" id="6900232">Fatal</span><span class="op" id="6900237">(</span><span class="ident" id="6900238">err</span><span class="op" id="6900241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6900244">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6900247">defer</span>&nbsp;<span class="ident" id="6900253">r</span><span class="op" id="6900254">.</span><span class="ident" id="6900255">Close</span><span class="op" id="6900260">(</span><span class="op" id="6900261">)</span><br>
<span class="lineno">520</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6900265">if</span>&nbsp;<span class="op" id="6900268">!</span><span class="ident" id="6900269">r</span><span class="op" id="6900270">.</span><span class="ident" id="6900271">Next</span><span class="op" id="6900275">(</span><span class="op" id="6900276">)</span>&nbsp;<span class="op" id="6900278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6900282">if</span>&nbsp;<span class="ident" id="6900285">r</span><span class="op" id="6900286">.</span><span class="ident" id="6900287">Err</span><span class="op" id="6900290">(</span><span class="op" id="6900291">)</span>&nbsp;<span class="op" id="6900293">!=</span>&nbsp;<span class="ident" id="6900296">nil</span>&nbsp;<span class="op" id="6900300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6900305">t</span><span class="op" id="6900306">.</span><span class="ident" id="6900307">Fatal</span><span class="op" id="6900312">(</span><span class="ident" id="6900313">r</span><span class="op" id="6900314">.</span><span class="ident" id="6900315">Err</span><span class="op" id="6900318">(</span><span class="op" id="6900319">)</span><span class="op" id="6900320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6900324">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6900328">t</span><span class="op" id="6900329">.</span><span class="ident" id="6900330">Fatal</span><span class="op" id="6900335">(</span><span class="string" id="6900336">&#34;expected&nbsp;one&nbsp;row&#34;</span><span class="op" id="6900354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6900357">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6900361">var</span>&nbsp;<span class="ident" id="6900365">x</span>&nbsp;<span class="builtintype" id="6900367">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6900375">err</span>&nbsp;<span class="op" id="6900379">=</span>&nbsp;<span class="ident" id="6900381">r</span><span class="op" id="6900382">.</span><span class="ident" id="6900383">Scan</span><span class="op" id="6900387">(</span><span class="op" id="6900388">&amp;</span><span class="ident" id="6900389">x</span><span class="op" id="6900390">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6900393">if</span>&nbsp;<span class="ident" id="6900396">err</span>&nbsp;<span class="op" id="6900400">!=</span>&nbsp;<span class="ident" id="6900403">nil</span>&nbsp;<span class="op" id="6900407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6900411">t</span><span class="op" id="6900412">.</span><span class="ident" id="6900413">Fatal</span><span class="op" id="6900418">(</span><span class="ident" id="6900419">err</span><span class="op" id="6900422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6900425">}</span><br>
<span class="lineno"></span><span class="op" id="6900427">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="6900430">func</span>&nbsp;<span class="ident" id="6900435">TestTxQueryInvalid</span><span class="op" id="6900453">(</span><span class="ident" id="6900454">t</span>&nbsp;<span class="op" id="6900456">*</span><span class="ident" id="6900457">testing</span><span class="op" id="6900464">.</span><span class="ident" id="6900465">T</span><span class="op" id="6900466">)</span>&nbsp;<span class="op" id="6900468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6900471">db</span>&nbsp;<span class="op" id="6900474">:=</span>&nbsp;<span class="ident" id="6900477">newTestDB</span><span class="op" id="6900486">(</span><span class="ident" id="6900487">t</span><span class="op" id="6900488">,</span>&nbsp;<span class="string" id="6900490">&#34;&#34;</span><span class="op" id="6900492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6900495">defer</span>&nbsp;<span class="ident" id="6900501">closeDB</span><span class="op" id="6900508">(</span><span class="ident" id="6900509">t</span><span class="op" id="6900510">,</span>&nbsp;<span class="ident" id="6900512">db</span><span class="op" id="6900514">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6900518">tx</span><span class="op" id="6900520">,</span>&nbsp;<span class="ident" id="6900522">err</span>&nbsp;<span class="op" id="6900526">:=</span>&nbsp;<span class="ident" id="6900529">db</span><span class="op" id="6900531">.</span><span class="ident" id="6900532">Begin</span><span class="op" id="6900537">(</span><span class="op" id="6900538">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6900541">if</span>&nbsp;<span class="ident" id="6900544">err</span>&nbsp;<span class="op" id="6900548">!=</span>&nbsp;<span class="ident" id="6900551">nil</span>&nbsp;<span class="op" id="6900555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6900559">t</span><span class="op" id="6900560">.</span><span class="ident" id="6900561">Fatal</span><span class="op" id="6900566">(</span><span class="ident" id="6900567">err</span><span class="op" id="6900570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6900573">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6900576">defer</span>&nbsp;<span class="ident" id="6900582">tx</span><span class="op" id="6900584">.</span><span class="ident" id="6900585">Rollback</span><span class="op" id="6900593">(</span><span class="op" id="6900594">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6900598">_</span><span class="op" id="6900599">,</span>&nbsp;<span class="ident" id="6900601">err</span>&nbsp;<span class="op" id="6900605">=</span>&nbsp;<span class="ident" id="6900607">tx</span><span class="op" id="6900609">.</span><span class="ident" id="6900610">Query</span><span class="op" id="6900615">(</span><span class="string" id="6900616">&#34;SELECT|t1|name|&#34;</span><span class="op" id="6900633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6900636">if</span>&nbsp;<span class="ident" id="6900639">err</span>&nbsp;<span class="op" id="6900643">==</span>&nbsp;<span class="ident" id="6900646">nil</span>&nbsp;<span class="op" id="6900650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6900654">t</span><span class="op" id="6900655">.</span><span class="ident" id="6900656">Fatal</span><span class="op" id="6900661">(</span><span class="string" id="6900662">&#34;Error&nbsp;expected&#34;</span><span class="op" id="6900678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6900681">}</span><br>
<span class="lineno"></span><span class="op" id="6900683">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="comment" id="6900686">//&nbsp;Tests&nbsp;fix&nbsp;for&nbsp;issue&nbsp;4433,&nbsp;that&nbsp;retries&nbsp;in&nbsp;Begin&nbsp;happen&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="6900749">//&nbsp;conn.Begin()&nbsp;returns&nbsp;ErrBadConn</span><br>
<span class="lineno"></span><span class="keyword" id="6900784">func</span>&nbsp;<span class="ident" id="6900789">TestTxErrBadConn</span><span class="op" id="6900805">(</span><span class="ident" id="6900806">t</span>&nbsp;<span class="op" id="6900808">*</span><span class="ident" id="6900809">testing</span><span class="op" id="6900816">.</span><span class="ident" id="6900817">T</span><span class="op" id="6900818">)</span>&nbsp;<span class="op" id="6900820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6900823">db</span><span class="op" id="6900825">,</span>&nbsp;<span class="ident" id="6900827">err</span>&nbsp;<span class="op" id="6900831">:=</span>&nbsp;<span class="ident" id="6900834">Open</span><span class="op" id="6900838">(</span><span class="string" id="6900839">&#34;test&#34;</span><span class="op" id="6900845">,</span>&nbsp;<span class="ident" id="6900847">fakeDBName</span><span class="op" id="6900857">+</span><span class="string" id="6900858">&#34;;badConn&#34;</span><span class="op" id="6900868">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6900871">if</span>&nbsp;<span class="ident" id="6900874">err</span>&nbsp;<span class="op" id="6900878">!=</span>&nbsp;<span class="ident" id="6900881">nil</span>&nbsp;<span class="op" id="6900885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6900889">t</span><span class="op" id="6900890">.</span><span class="ident" id="6900891">Fatalf</span><span class="op" id="6900897">(</span><span class="string" id="6900898">&#34;Open:&nbsp;%v&#34;</span><span class="op" id="6900908">,</span>&nbsp;<span class="ident" id="6900910">err</span><span class="op" id="6900913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6900916">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6900919">if</span>&nbsp;<span class="ident" id="6900922">_</span><span class="op" id="6900923">,</span>&nbsp;<span class="ident" id="6900925">err</span>&nbsp;<span class="op" id="6900929">:=</span>&nbsp;<span class="ident" id="6900932">db</span><span class="op" id="6900934">.</span><span class="ident" id="6900935">Exec</span><span class="op" id="6900939">(</span><span class="string" id="6900940">&#34;WIPE&#34;</span><span class="op" id="6900946">)</span><span class="op" id="6900947">;</span>&nbsp;<span class="ident" id="6900949">err</span>&nbsp;<span class="op" id="6900953">!=</span>&nbsp;<span class="ident" id="6900956">nil</span>&nbsp;<span class="op" id="6900960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6900964">t</span><span class="op" id="6900965">.</span><span class="ident" id="6900966">Fatalf</span><span class="op" id="6900972">(</span><span class="string" id="6900973">&#34;exec&nbsp;wipe:&nbsp;%v&#34;</span><span class="op" id="6900988">,</span>&nbsp;<span class="ident" id="6900990">err</span><span class="op" id="6900993">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6900996">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6900999">defer</span>&nbsp;<span class="ident" id="6901005">closeDB</span><span class="op" id="6901012">(</span><span class="ident" id="6901013">t</span><span class="op" id="6901014">,</span>&nbsp;<span class="ident" id="6901016">db</span><span class="op" id="6901018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6901021">exec</span><span class="op" id="6901025">(</span><span class="ident" id="6901026">t</span><span class="op" id="6901027">,</span>&nbsp;<span class="ident" id="6901029">db</span><span class="op" id="6901031">,</span>&nbsp;<span class="string" id="6901033">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="6901076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6901079">stmt</span><span class="op" id="6901083">,</span>&nbsp;<span class="ident" id="6901085">err</span>&nbsp;<span class="op" id="6901089">:=</span>&nbsp;<span class="ident" id="6901092">db</span><span class="op" id="6901094">.</span><span class="ident" id="6901095">Prepare</span><span class="op" id="6901102">(</span><span class="string" id="6901103">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="6901127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6901130">if</span>&nbsp;<span class="ident" id="6901133">err</span>&nbsp;<span class="op" id="6901137">!=</span>&nbsp;<span class="ident" id="6901140">nil</span>&nbsp;<span class="op" id="6901144">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6901148">t</span><span class="op" id="6901149">.</span><span class="ident" id="6901150">Fatalf</span><span class="op" id="6901156">(</span><span class="string" id="6901157">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="6901177">,</span>&nbsp;<span class="ident" id="6901179">stmt</span><span class="op" id="6901183">,</span>&nbsp;<span class="ident" id="6901185">err</span><span class="op" id="6901188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6901191">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6901194">defer</span>&nbsp;<span class="ident" id="6901200">stmt</span><span class="op" id="6901204">.</span><span class="ident" id="6901205">Close</span><span class="op" id="6901210">(</span><span class="op" id="6901211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6901214">tx</span><span class="op" id="6901216">,</span>&nbsp;<span class="ident" id="6901218">err</span>&nbsp;<span class="op" id="6901222">:=</span>&nbsp;<span class="ident" id="6901225">db</span><span class="op" id="6901227">.</span><span class="ident" id="6901228">Begin</span><span class="op" id="6901233">(</span><span class="op" id="6901234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6901237">if</span>&nbsp;<span class="ident" id="6901240">err</span>&nbsp;<span class="op" id="6901244">!=</span>&nbsp;<span class="ident" id="6901247">nil</span>&nbsp;<span class="op" id="6901251">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6901255">t</span><span class="op" id="6901256">.</span><span class="ident" id="6901257">Fatalf</span><span class="op" id="6901263">(</span><span class="string" id="6901264">&#34;Begin&nbsp;=&nbsp;%v&#34;</span><span class="op" id="6901276">,</span>&nbsp;<span class="ident" id="6901278">err</span><span class="op" id="6901281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6901284">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6901287">txs</span>&nbsp;<span class="op" id="6901291">:=</span>&nbsp;<span class="ident" id="6901294">tx</span><span class="op" id="6901296">.</span><span class="ident" id="6901297">Stmt</span><span class="op" id="6901301">(</span><span class="ident" id="6901302">stmt</span><span class="op" id="6901306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6901309">defer</span>&nbsp;<span class="ident" id="6901315">txs</span><span class="op" id="6901318">.</span><span class="ident" id="6901319">Close</span><span class="op" id="6901324">(</span><span class="op" id="6901325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6901328">_</span><span class="op" id="6901329">,</span>&nbsp;<span class="ident" id="6901331">err</span>&nbsp;<span class="op" id="6901335">=</span>&nbsp;<span class="ident" id="6901337">txs</span><span class="op" id="6901340">.</span><span class="ident" id="6901341">Exec</span><span class="op" id="6901345">(</span><span class="string" id="6901346">&#34;Bobby&#34;</span><span class="op" id="6901353">,</span>&nbsp;<span class="num" id="6901355">7</span><span class="op" id="6901356">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6901359">if</span>&nbsp;<span class="ident" id="6901362">err</span>&nbsp;<span class="op" id="6901366">!=</span>&nbsp;<span class="ident" id="6901369">nil</span>&nbsp;<span class="op" id="6901373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6901377">t</span><span class="op" id="6901378">.</span><span class="ident" id="6901379">Fatalf</span><span class="op" id="6901385">(</span><span class="string" id="6901386">&#34;Exec&nbsp;=&nbsp;%v&#34;</span><span class="op" id="6901397">,</span>&nbsp;<span class="ident" id="6901399">err</span><span class="op" id="6901402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6901405">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6901408">err</span>&nbsp;<span class="op" id="6901412">=</span>&nbsp;<span class="ident" id="6901414">tx</span><span class="op" id="6901416">.</span><span class="ident" id="6901417">Commit</span><span class="op" id="6901423">(</span><span class="op" id="6901424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6901427">if</span>&nbsp;<span class="ident" id="6901430">err</span>&nbsp;<span class="op" id="6901434">!=</span>&nbsp;<span class="ident" id="6901437">nil</span>&nbsp;<span class="op" id="6901441">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6901445">t</span><span class="op" id="6901446">.</span><span class="ident" id="6901447">Fatalf</span><span class="op" id="6901453">(</span><span class="string" id="6901454">&#34;Commit&nbsp;=&nbsp;%v&#34;</span><span class="op" id="6901467">,</span>&nbsp;<span class="ident" id="6901469">err</span><span class="op" id="6901472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6901475">}</span><br>
<span class="lineno"></span><span class="op" id="6901477">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6901480">//&nbsp;Tests&nbsp;fix&nbsp;for&nbsp;issue&nbsp;2542,&nbsp;that&nbsp;we&nbsp;release&nbsp;a&nbsp;lock&nbsp;when&nbsp;querying&nbsp;on</span><br>
<span class="lineno">585</span><span class="comment" id="6901549">//&nbsp;a&nbsp;closed&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="6901573">func</span>&nbsp;<span class="ident" id="6901578">TestIssue2542Deadlock</span><span class="op" id="6901599">(</span><span class="ident" id="6901600">t</span>&nbsp;<span class="op" id="6901602">*</span><span class="ident" id="6901603">testing</span><span class="op" id="6901610">.</span><span class="ident" id="6901611">T</span><span class="op" id="6901612">)</span>&nbsp;<span class="op" id="6901614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6901617">db</span>&nbsp;<span class="op" id="6901620">:=</span>&nbsp;<span class="ident" id="6901623">newTestDB</span><span class="op" id="6901632">(</span><span class="ident" id="6901633">t</span><span class="op" id="6901634">,</span>&nbsp;<span class="string" id="6901636">&#34;people&#34;</span><span class="op" id="6901644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6901647">closeDB</span><span class="op" id="6901654">(</span><span class="ident" id="6901655">t</span><span class="op" id="6901656">,</span>&nbsp;<span class="ident" id="6901658">db</span><span class="op" id="6901660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6901663">for</span>&nbsp;<span class="ident" id="6901667">i</span>&nbsp;<span class="op" id="6901669">:=</span>&nbsp;<span class="num" id="6901672">0</span><span class="op" id="6901673">;</span>&nbsp;<span class="ident" id="6901675">i</span>&nbsp;<span class="op" id="6901677">&lt;</span>&nbsp;<span class="num" id="6901679">2</span><span class="op" id="6901680">;</span>&nbsp;<span class="ident" id="6901682">i</span><span class="op" id="6901683">++</span>&nbsp;<span class="op" id="6901686">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6901690">_</span><span class="op" id="6901691">,</span>&nbsp;<span class="ident" id="6901693">err</span>&nbsp;<span class="op" id="6901697">:=</span>&nbsp;<span class="ident" id="6901700">db</span><span class="op" id="6901702">.</span><span class="ident" id="6901703">Query</span><span class="op" id="6901708">(</span><span class="string" id="6901709">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="6901734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6901738">if</span>&nbsp;<span class="ident" id="6901741">err</span>&nbsp;<span class="op" id="6901745">==</span>&nbsp;<span class="ident" id="6901748">nil</span>&nbsp;<span class="op" id="6901752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6901757">t</span><span class="op" id="6901758">.</span><span class="ident" id="6901759">Fatalf</span><span class="op" id="6901765">(</span><span class="string" id="6901766">&#34;expected&nbsp;error&#34;</span><span class="op" id="6901782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6901786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6901789">}</span><br>
<span class="lineno">595</span><span class="op" id="6901791">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6901794">//&nbsp;From&nbsp;golang.org/issue/3865</span><br>
<span class="lineno"></span><span class="keyword" id="6901824">func</span>&nbsp;<span class="ident" id="6901829">TestCloseStmtBeforeRows</span><span class="op" id="6901852">(</span><span class="ident" id="6901853">t</span>&nbsp;<span class="op" id="6901855">*</span><span class="ident" id="6901856">testing</span><span class="op" id="6901863">.</span><span class="ident" id="6901864">T</span><span class="op" id="6901865">)</span>&nbsp;<span class="op" id="6901867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6901870">db</span>&nbsp;<span class="op" id="6901873">:=</span>&nbsp;<span class="ident" id="6901876">newTestDB</span><span class="op" id="6901885">(</span><span class="ident" id="6901886">t</span><span class="op" id="6901887">,</span>&nbsp;<span class="string" id="6901889">&#34;people&#34;</span><span class="op" id="6901897">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6901900">defer</span>&nbsp;<span class="ident" id="6901906">closeDB</span><span class="op" id="6901913">(</span><span class="ident" id="6901914">t</span><span class="op" id="6901915">,</span>&nbsp;<span class="ident" id="6901917">db</span><span class="op" id="6901919">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6901923">s</span><span class="op" id="6901924">,</span>&nbsp;<span class="ident" id="6901926">err</span>&nbsp;<span class="op" id="6901930">:=</span>&nbsp;<span class="ident" id="6901933">db</span><span class="op" id="6901935">.</span><span class="ident" id="6901936">Prepare</span><span class="op" id="6901943">(</span><span class="string" id="6901944">&#34;SELECT|people|name|&#34;</span><span class="op" id="6901965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6901968">if</span>&nbsp;<span class="ident" id="6901971">err</span>&nbsp;<span class="op" id="6901975">!=</span>&nbsp;<span class="ident" id="6901978">nil</span>&nbsp;<span class="op" id="6901982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6901986">t</span><span class="op" id="6901987">.</span><span class="ident" id="6901988">Fatal</span><span class="op" id="6901993">(</span><span class="ident" id="6901994">err</span><span class="op" id="6901997">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6902000">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6902004">r</span><span class="op" id="6902005">,</span>&nbsp;<span class="ident" id="6902007">err</span>&nbsp;<span class="op" id="6902011">:=</span>&nbsp;<span class="ident" id="6902014">s</span><span class="op" id="6902015">.</span><span class="ident" id="6902016">Query</span><span class="op" id="6902021">(</span><span class="op" id="6902022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6902025">if</span>&nbsp;<span class="ident" id="6902028">err</span>&nbsp;<span class="op" id="6902032">!=</span>&nbsp;<span class="ident" id="6902035">nil</span>&nbsp;<span class="op" id="6902039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6902043">s</span><span class="op" id="6902044">.</span><span class="ident" id="6902045">Close</span><span class="op" id="6902050">(</span><span class="op" id="6902051">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6902055">t</span><span class="op" id="6902056">.</span><span class="ident" id="6902057">Fatal</span><span class="op" id="6902062">(</span><span class="ident" id="6902063">err</span><span class="op" id="6902066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6902069">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6902073">err</span>&nbsp;<span class="op" id="6902077">=</span>&nbsp;<span class="ident" id="6902079">s</span><span class="op" id="6902080">.</span><span class="ident" id="6902081">Close</span><span class="op" id="6902086">(</span><span class="op" id="6902087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6902090">if</span>&nbsp;<span class="ident" id="6902093">err</span>&nbsp;<span class="op" id="6902097">!=</span>&nbsp;<span class="ident" id="6902100">nil</span>&nbsp;<span class="op" id="6902104">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6902108">t</span><span class="op" id="6902109">.</span><span class="ident" id="6902110">Fatal</span><span class="op" id="6902115">(</span><span class="ident" id="6902116">err</span><span class="op" id="6902119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6902122">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6902126">r</span><span class="op" id="6902127">.</span><span class="ident" id="6902128">Close</span><span class="op" id="6902133">(</span><span class="op" id="6902134">)</span><br>
<span class="lineno"></span><span class="op" id="6902136">}</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="comment" id="6902139">//&nbsp;Tests&nbsp;fix&nbsp;for&nbsp;issue&nbsp;2788,&nbsp;that&nbsp;we&nbsp;bind&nbsp;nil&nbsp;to&nbsp;a&nbsp;[]byte&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6902204">//&nbsp;value&nbsp;in&nbsp;the&nbsp;column&nbsp;is&nbsp;sql&nbsp;null</span><br>
<span class="lineno"></span><span class="keyword" id="6902239">func</span>&nbsp;<span class="ident" id="6902244">TestNullByteSlice</span><span class="op" id="6902261">(</span><span class="ident" id="6902262">t</span>&nbsp;<span class="op" id="6902264">*</span><span class="ident" id="6902265">testing</span><span class="op" id="6902272">.</span><span class="ident" id="6902273">T</span><span class="op" id="6902274">)</span>&nbsp;<span class="op" id="6902276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6902279">db</span>&nbsp;<span class="op" id="6902282">:=</span>&nbsp;<span class="ident" id="6902285">newTestDB</span><span class="op" id="6902294">(</span><span class="ident" id="6902295">t</span><span class="op" id="6902296">,</span>&nbsp;<span class="string" id="6902298">&#34;&#34;</span><span class="op" id="6902300">)</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6902303">defer</span>&nbsp;<span class="ident" id="6902309">closeDB</span><span class="op" id="6902316">(</span><span class="ident" id="6902317">t</span><span class="op" id="6902318">,</span>&nbsp;<span class="ident" id="6902320">db</span><span class="op" id="6902322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6902325">exec</span><span class="op" id="6902329">(</span><span class="ident" id="6902330">t</span><span class="op" id="6902331">,</span>&nbsp;<span class="ident" id="6902333">db</span><span class="op" id="6902335">,</span>&nbsp;<span class="string" id="6902337">&#34;CREATE|t|id=int32,name=nullstring&#34;</span><span class="op" id="6902372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6902375">exec</span><span class="op" id="6902379">(</span><span class="ident" id="6902380">t</span><span class="op" id="6902381">,</span>&nbsp;<span class="ident" id="6902383">db</span><span class="op" id="6902385">,</span>&nbsp;<span class="string" id="6902387">&#34;INSERT|t|id=10,name=?&#34;</span><span class="op" id="6902410">,</span>&nbsp;<span class="ident" id="6902412">nil</span><span class="op" id="6902415">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6902419">var</span>&nbsp;<span class="ident" id="6902423">name</span>&nbsp;<span class="op" id="6902428">[</span><span class="op" id="6902429">]</span><span class="builtintype" id="6902430">byte</span><br>
<span class="lineno">630</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6902437">err</span>&nbsp;<span class="op" id="6902441">:=</span>&nbsp;<span class="ident" id="6902444">db</span><span class="op" id="6902446">.</span><span class="ident" id="6902447">QueryRow</span><span class="op" id="6902455">(</span><span class="string" id="6902456">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="6902476">,</span>&nbsp;<span class="num" id="6902478">10</span><span class="op" id="6902480">)</span><span class="op" id="6902481">.</span><span class="ident" id="6902482">Scan</span><span class="op" id="6902486">(</span><span class="op" id="6902487">&amp;</span><span class="ident" id="6902488">name</span><span class="op" id="6902492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6902495">if</span>&nbsp;<span class="ident" id="6902498">err</span>&nbsp;<span class="op" id="6902502">!=</span>&nbsp;<span class="ident" id="6902505">nil</span>&nbsp;<span class="op" id="6902509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6902513">t</span><span class="op" id="6902514">.</span><span class="ident" id="6902515">Fatal</span><span class="op" id="6902520">(</span><span class="ident" id="6902521">err</span><span class="op" id="6902524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6902527">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6902530">if</span>&nbsp;<span class="ident" id="6902533">name</span>&nbsp;<span class="op" id="6902538">!=</span>&nbsp;<span class="ident" id="6902541">nil</span>&nbsp;<span class="op" id="6902545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6902549">t</span><span class="op" id="6902550">.</span><span class="ident" id="6902551">Fatalf</span><span class="op" id="6902557">(</span><span class="string" id="6902558">&#34;name&nbsp;[]byte&nbsp;should&nbsp;be&nbsp;nil&nbsp;for&nbsp;null&nbsp;column&nbsp;value,&nbsp;got:&nbsp;%#v&#34;</span><span class="op" id="6902617">,</span>&nbsp;<span class="ident" id="6902619">name</span><span class="op" id="6902623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6902626">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6902630">exec</span><span class="op" id="6902634">(</span><span class="ident" id="6902635">t</span><span class="op" id="6902636">,</span>&nbsp;<span class="ident" id="6902638">db</span><span class="op" id="6902640">,</span>&nbsp;<span class="string" id="6902642">&#34;INSERT|t|id=11,name=?&#34;</span><span class="op" id="6902665">,</span>&nbsp;<span class="string" id="6902667">&#34;bob&#34;</span><span class="op" id="6902672">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6902675">err</span>&nbsp;<span class="op" id="6902679">=</span>&nbsp;<span class="ident" id="6902681">db</span><span class="op" id="6902683">.</span><span class="ident" id="6902684">QueryRow</span><span class="op" id="6902692">(</span><span class="string" id="6902693">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="6902713">,</span>&nbsp;<span class="num" id="6902715">11</span><span class="op" id="6902717">)</span><span class="op" id="6902718">.</span><span class="ident" id="6902719">Scan</span><span class="op" id="6902723">(</span><span class="op" id="6902724">&amp;</span><span class="ident" id="6902725">name</span><span class="op" id="6902729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6902732">if</span>&nbsp;<span class="ident" id="6902735">err</span>&nbsp;<span class="op" id="6902739">!=</span>&nbsp;<span class="ident" id="6902742">nil</span>&nbsp;<span class="op" id="6902746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6902750">t</span><span class="op" id="6902751">.</span><span class="ident" id="6902752">Fatal</span><span class="op" id="6902757">(</span><span class="ident" id="6902758">err</span><span class="op" id="6902761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6902764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6902767">if</span>&nbsp;<span class="builtintype" id="6902770">string</span><span class="op" id="6902776">(</span><span class="ident" id="6902777">name</span><span class="op" id="6902781">)</span>&nbsp;<span class="op" id="6902783">!=</span>&nbsp;<span class="string" id="6902786">&#34;bob&#34;</span>&nbsp;<span class="op" id="6902792">{</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6902796">t</span><span class="op" id="6902797">.</span><span class="ident" id="6902798">Fatalf</span><span class="op" id="6902804">(</span><span class="string" id="6902805">&#34;name&nbsp;[]byte&nbsp;should&nbsp;be&nbsp;bob,&nbsp;got:&nbsp;%q&#34;</span><span class="op" id="6902841">,</span>&nbsp;<span class="builtintype" id="6902843">string</span><span class="op" id="6902849">(</span><span class="ident" id="6902850">name</span><span class="op" id="6902854">)</span><span class="op" id="6902855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6902858">}</span><br>
<span class="lineno"></span><span class="op" id="6902860">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6902863">func</span>&nbsp;<span class="ident" id="6902868">TestPointerParamsAndScans</span><span class="op" id="6902893">(</span><span class="ident" id="6902894">t</span>&nbsp;<span class="op" id="6902896">*</span><span class="ident" id="6902897">testing</span><span class="op" id="6902904">.</span><span class="ident" id="6902905">T</span><span class="op" id="6902906">)</span>&nbsp;<span class="op" id="6902908">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6902911">db</span>&nbsp;<span class="op" id="6902914">:=</span>&nbsp;<span class="ident" id="6902917">newTestDB</span><span class="op" id="6902926">(</span><span class="ident" id="6902927">t</span><span class="op" id="6902928">,</span>&nbsp;<span class="string" id="6902930">&#34;&#34;</span><span class="op" id="6902932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6902935">defer</span>&nbsp;<span class="ident" id="6902941">closeDB</span><span class="op" id="6902948">(</span><span class="ident" id="6902949">t</span><span class="op" id="6902950">,</span>&nbsp;<span class="ident" id="6902952">db</span><span class="op" id="6902954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6902957">exec</span><span class="op" id="6902961">(</span><span class="ident" id="6902962">t</span><span class="op" id="6902963">,</span>&nbsp;<span class="ident" id="6902965">db</span><span class="op" id="6902967">,</span>&nbsp;<span class="string" id="6902969">&#34;CREATE|t|id=int32,name=nullstring&#34;</span><span class="op" id="6903004">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6903008">bob</span>&nbsp;<span class="op" id="6903012">:=</span>&nbsp;<span class="string" id="6903015">&#34;bob&#34;</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6903022">var</span>&nbsp;<span class="ident" id="6903026">name</span>&nbsp;<span class="op" id="6903031">*</span><span class="builtintype" id="6903032">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6903041">name</span>&nbsp;<span class="op" id="6903046">=</span>&nbsp;<span class="op" id="6903048">&amp;</span><span class="ident" id="6903049">bob</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6903054">exec</span><span class="op" id="6903058">(</span><span class="ident" id="6903059">t</span><span class="op" id="6903060">,</span>&nbsp;<span class="ident" id="6903062">db</span><span class="op" id="6903064">,</span>&nbsp;<span class="string" id="6903066">&#34;INSERT|t|id=10,name=?&#34;</span><span class="op" id="6903089">,</span>&nbsp;<span class="ident" id="6903091">name</span><span class="op" id="6903095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6903098">name</span>&nbsp;<span class="op" id="6903103">=</span>&nbsp;<span class="ident" id="6903105">nil</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6903110">exec</span><span class="op" id="6903114">(</span><span class="ident" id="6903115">t</span><span class="op" id="6903116">,</span>&nbsp;<span class="ident" id="6903118">db</span><span class="op" id="6903120">,</span>&nbsp;<span class="string" id="6903122">&#34;INSERT|t|id=20,name=?&#34;</span><span class="op" id="6903145">,</span>&nbsp;<span class="ident" id="6903147">name</span><span class="op" id="6903151">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6903155">err</span>&nbsp;<span class="op" id="6903159">:=</span>&nbsp;<span class="ident" id="6903162">db</span><span class="op" id="6903164">.</span><span class="ident" id="6903165">QueryRow</span><span class="op" id="6903173">(</span><span class="string" id="6903174">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="6903194">,</span>&nbsp;<span class="num" id="6903196">10</span><span class="op" id="6903198">)</span><span class="op" id="6903199">.</span><span class="ident" id="6903200">Scan</span><span class="op" id="6903204">(</span><span class="op" id="6903205">&amp;</span><span class="ident" id="6903206">name</span><span class="op" id="6903210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6903213">if</span>&nbsp;<span class="ident" id="6903216">err</span>&nbsp;<span class="op" id="6903220">!=</span>&nbsp;<span class="ident" id="6903223">nil</span>&nbsp;<span class="op" id="6903227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6903231">t</span><span class="op" id="6903232">.</span><span class="ident" id="6903233">Fatalf</span><span class="op" id="6903239">(</span><span class="string" id="6903240">&#34;querying&nbsp;id&nbsp;10:&nbsp;%v&#34;</span><span class="op" id="6903260">,</span>&nbsp;<span class="ident" id="6903262">err</span><span class="op" id="6903265">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6903268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6903271">if</span>&nbsp;<span class="ident" id="6903274">name</span>&nbsp;<span class="op" id="6903279">==</span>&nbsp;<span class="ident" id="6903282">nil</span>&nbsp;<span class="op" id="6903286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6903290">t</span><span class="op" id="6903291">.</span><span class="ident" id="6903292">Errorf</span><span class="op" id="6903298">(</span><span class="string" id="6903299">&#34;id&nbsp;10&#39;s&nbsp;name&nbsp;=&nbsp;nil;&nbsp;want&nbsp;bob&#34;</span><span class="op" id="6903329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6903332">}</span>&nbsp;<span class="keyword" id="6903334">else</span>&nbsp;<span class="keyword" id="6903339">if</span>&nbsp;<span class="op" id="6903342">*</span><span class="ident" id="6903343">name</span>&nbsp;<span class="op" id="6903348">!=</span>&nbsp;<span class="string" id="6903351">&#34;bob&#34;</span>&nbsp;<span class="op" id="6903357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6903361">t</span><span class="op" id="6903362">.</span><span class="ident" id="6903363">Errorf</span><span class="op" id="6903369">(</span><span class="string" id="6903370">&#34;id&nbsp;10&#39;s&nbsp;name&nbsp;=&nbsp;%q;&nbsp;want&nbsp;bob&#34;</span><span class="op" id="6903399">,</span>&nbsp;<span class="op" id="6903401">*</span><span class="ident" id="6903402">name</span><span class="op" id="6903406">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6903409">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6903413">err</span>&nbsp;<span class="op" id="6903417">=</span>&nbsp;<span class="ident" id="6903419">db</span><span class="op" id="6903421">.</span><span class="ident" id="6903422">QueryRow</span><span class="op" id="6903430">(</span><span class="string" id="6903431">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="6903451">,</span>&nbsp;<span class="num" id="6903453">20</span><span class="op" id="6903455">)</span><span class="op" id="6903456">.</span><span class="ident" id="6903457">Scan</span><span class="op" id="6903461">(</span><span class="op" id="6903462">&amp;</span><span class="ident" id="6903463">name</span><span class="op" id="6903467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6903470">if</span>&nbsp;<span class="ident" id="6903473">err</span>&nbsp;<span class="op" id="6903477">!=</span>&nbsp;<span class="ident" id="6903480">nil</span>&nbsp;<span class="op" id="6903484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6903488">t</span><span class="op" id="6903489">.</span><span class="ident" id="6903490">Fatalf</span><span class="op" id="6903496">(</span><span class="string" id="6903497">&#34;querying&nbsp;id&nbsp;20:&nbsp;%v&#34;</span><span class="op" id="6903517">,</span>&nbsp;<span class="ident" id="6903519">err</span><span class="op" id="6903522">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6903525">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6903528">if</span>&nbsp;<span class="ident" id="6903531">name</span>&nbsp;<span class="op" id="6903536">!=</span>&nbsp;<span class="ident" id="6903539">nil</span>&nbsp;<span class="op" id="6903543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6903547">t</span><span class="op" id="6903548">.</span><span class="ident" id="6903549">Errorf</span><span class="op" id="6903555">(</span><span class="string" id="6903556">&#34;id&nbsp;20&nbsp;=&nbsp;%q;&nbsp;want&nbsp;nil&#34;</span><span class="op" id="6903578">,</span>&nbsp;<span class="op" id="6903580">*</span><span class="ident" id="6903581">name</span><span class="op" id="6903585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6903588">}</span><br>
<span class="lineno"></span><span class="op" id="6903590">}</span><br>
<span class="lineno">680</span><br>
<span class="lineno"></span><span class="keyword" id="6903593">func</span>&nbsp;<span class="ident" id="6903598">TestQueryRowClosingStmt</span><span class="op" id="6903621">(</span><span class="ident" id="6903622">t</span>&nbsp;<span class="op" id="6903624">*</span><span class="ident" id="6903625">testing</span><span class="op" id="6903632">.</span><span class="ident" id="6903633">T</span><span class="op" id="6903634">)</span>&nbsp;<span class="op" id="6903636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6903639">db</span>&nbsp;<span class="op" id="6903642">:=</span>&nbsp;<span class="ident" id="6903645">newTestDB</span><span class="op" id="6903654">(</span><span class="ident" id="6903655">t</span><span class="op" id="6903656">,</span>&nbsp;<span class="string" id="6903658">&#34;people&#34;</span><span class="op" id="6903666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6903669">defer</span>&nbsp;<span class="ident" id="6903675">closeDB</span><span class="op" id="6903682">(</span><span class="ident" id="6903683">t</span><span class="op" id="6903684">,</span>&nbsp;<span class="ident" id="6903686">db</span><span class="op" id="6903688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6903691">var</span>&nbsp;<span class="ident" id="6903695">name</span>&nbsp;<span class="builtintype" id="6903700">string</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6903708">var</span>&nbsp;<span class="ident" id="6903712">age</span>&nbsp;<span class="builtintype" id="6903716">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6903721">err</span>&nbsp;<span class="op" id="6903725">:=</span>&nbsp;<span class="ident" id="6903728">db</span><span class="op" id="6903730">.</span><span class="ident" id="6903731">QueryRow</span><span class="op" id="6903739">(</span><span class="string" id="6903740">&#34;SELECT|people|age,name|age=?&#34;</span><span class="op" id="6903770">,</span>&nbsp;<span class="num" id="6903772">3</span><span class="op" id="6903773">)</span><span class="op" id="6903774">.</span><span class="ident" id="6903775">Scan</span><span class="op" id="6903779">(</span><span class="op" id="6903780">&amp;</span><span class="ident" id="6903781">age</span><span class="op" id="6903784">,</span>&nbsp;<span class="op" id="6903786">&amp;</span><span class="ident" id="6903787">name</span><span class="op" id="6903791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6903794">if</span>&nbsp;<span class="ident" id="6903797">err</span>&nbsp;<span class="op" id="6903801">!=</span>&nbsp;<span class="ident" id="6903804">nil</span>&nbsp;<span class="op" id="6903808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6903812">t</span><span class="op" id="6903813">.</span><span class="ident" id="6903814">Fatal</span><span class="op" id="6903819">(</span><span class="ident" id="6903820">err</span><span class="op" id="6903823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6903826">}</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6903829">if</span>&nbsp;<span class="builtinfunc" id="6903832">len</span><span class="op" id="6903835">(</span><span class="ident" id="6903836">db</span><span class="op" id="6903838">.</span><span class="ident" id="6903839">freeConn</span><span class="op" id="6903847">)</span>&nbsp;<span class="op" id="6903849">!=</span>&nbsp;<span class="num" id="6903852">1</span>&nbsp;<span class="op" id="6903854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6903858">t</span><span class="op" id="6903859">.</span><span class="ident" id="6903860">Fatalf</span><span class="op" id="6903866">(</span><span class="string" id="6903867">&#34;expected&nbsp;1&nbsp;free&nbsp;conn&#34;</span><span class="op" id="6903889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6903892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6903895">fakeConn</span>&nbsp;<span class="op" id="6903904">:=</span>&nbsp;<span class="ident" id="6903907">db</span><span class="op" id="6903909">.</span><span class="ident" id="6903910">freeConn</span><span class="op" id="6903918">[</span><span class="num" id="6903919">0</span><span class="op" id="6903920">]</span><span class="op" id="6903921">.</span><span class="ident" id="6903922">ci</span><span class="op" id="6903924">.</span><span class="op" id="6903925">(</span><span class="op" id="6903926">*</span><span class="ident" id="6903927">fakeConn</span><span class="op" id="6903935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6903938">if</span>&nbsp;<span class="ident" id="6903941">made</span><span class="op" id="6903945">,</span>&nbsp;<span class="ident" id="6903947">closed</span>&nbsp;<span class="op" id="6903954">:=</span>&nbsp;<span class="ident" id="6903957">fakeConn</span><span class="op" id="6903965">.</span><span class="ident" id="6903966">stmtsMade</span><span class="op" id="6903975">,</span>&nbsp;<span class="ident" id="6903977">fakeConn</span><span class="op" id="6903985">.</span><span class="ident" id="6903986">stmtsClosed</span><span class="op" id="6903997">;</span>&nbsp;<span class="ident" id="6903999">made</span>&nbsp;<span class="op" id="6904004">!=</span>&nbsp;<span class="ident" id="6904007">closed</span>&nbsp;<span class="op" id="6904014">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6904018">t</span><span class="op" id="6904019">.</span><span class="ident" id="6904020">Errorf</span><span class="op" id="6904026">(</span><span class="string" id="6904027">&#34;statement&nbsp;close&nbsp;mismatch:&nbsp;made&nbsp;%d,&nbsp;closed&nbsp;%d&#34;</span><span class="op" id="6904073">,</span>&nbsp;<span class="ident" id="6904075">made</span><span class="op" id="6904079">,</span>&nbsp;<span class="ident" id="6904081">closed</span><span class="op" id="6904087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6904090">}</span><br>
<span class="lineno"></span><span class="op" id="6904092">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6904095">//&nbsp;Test&nbsp;issue&nbsp;6651</span><br>
<span class="lineno">700</span><span class="keyword" id="6904114">func</span>&nbsp;<span class="ident" id="6904119">TestIssue6651</span><span class="op" id="6904132">(</span><span class="ident" id="6904133">t</span>&nbsp;<span class="op" id="6904135">*</span><span class="ident" id="6904136">testing</span><span class="op" id="6904143">.</span><span class="ident" id="6904144">T</span><span class="op" id="6904145">)</span>&nbsp;<span class="op" id="6904147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6904150">db</span>&nbsp;<span class="op" id="6904153">:=</span>&nbsp;<span class="ident" id="6904156">newTestDB</span><span class="op" id="6904165">(</span><span class="ident" id="6904166">t</span><span class="op" id="6904167">,</span>&nbsp;<span class="string" id="6904169">&#34;people&#34;</span><span class="op" id="6904177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6904180">defer</span>&nbsp;<span class="ident" id="6904186">closeDB</span><span class="op" id="6904193">(</span><span class="ident" id="6904194">t</span><span class="op" id="6904195">,</span>&nbsp;<span class="ident" id="6904197">db</span><span class="op" id="6904199">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6904203">var</span>&nbsp;<span class="ident" id="6904207">v</span>&nbsp;<span class="builtintype" id="6904209">string</span><br>
<span class="lineno">705</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6904218">want</span>&nbsp;<span class="op" id="6904223">:=</span>&nbsp;<span class="string" id="6904226">&#34;error&nbsp;in&nbsp;rows.Next&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6904248">rowsCursorNextHook</span>&nbsp;<span class="op" id="6904267">=</span>&nbsp;<span class="keyword" id="6904269">func</span><span class="op" id="6904273">(</span><span class="ident" id="6904274">dest</span>&nbsp;<span class="op" id="6904279">[</span><span class="op" id="6904280">]</span><span class="ident" id="6904281">driver</span><span class="op" id="6904287">.</span><span class="ident" id="6904288">Value</span><span class="op" id="6904293">)</span>&nbsp;<span class="builtintype" id="6904295">error</span>&nbsp;<span class="op" id="6904301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6904305">return</span>&nbsp;<span class="ident" id="6904312">fmt</span><span class="op" id="6904315">.</span><span class="ident" id="6904316">Errorf</span><span class="op" id="6904322">(</span><span class="ident" id="6904323">want</span><span class="op" id="6904327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6904330">}</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6904333">defer</span>&nbsp;<span class="keyword" id="6904339">func</span><span class="op" id="6904343">(</span><span class="op" id="6904344">)</span>&nbsp;<span class="op" id="6904346">{</span>&nbsp;<span class="ident" id="6904348">rowsCursorNextHook</span>&nbsp;<span class="op" id="6904367">=</span>&nbsp;<span class="ident" id="6904369">nil</span>&nbsp;<span class="op" id="6904373">}</span><span class="op" id="6904374">(</span><span class="op" id="6904375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6904378">err</span>&nbsp;<span class="op" id="6904382">:=</span>&nbsp;<span class="ident" id="6904385">db</span><span class="op" id="6904387">.</span><span class="ident" id="6904388">QueryRow</span><span class="op" id="6904396">(</span><span class="string" id="6904397">&#34;SELECT|people|name|&#34;</span><span class="op" id="6904418">)</span><span class="op" id="6904419">.</span><span class="ident" id="6904420">Scan</span><span class="op" id="6904424">(</span><span class="op" id="6904425">&amp;</span><span class="ident" id="6904426">v</span><span class="op" id="6904427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6904430">if</span>&nbsp;<span class="ident" id="6904433">err</span>&nbsp;<span class="op" id="6904437">==</span>&nbsp;<span class="ident" id="6904440">nil</span>&nbsp;<span class="op" id="6904444">||</span>&nbsp;<span class="ident" id="6904447">err</span><span class="op" id="6904450">.</span><span class="ident" id="6904451">Error</span><span class="op" id="6904456">(</span><span class="op" id="6904457">)</span>&nbsp;<span class="op" id="6904459">!=</span>&nbsp;<span class="ident" id="6904462">want</span>&nbsp;<span class="op" id="6904467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6904471">t</span><span class="op" id="6904472">.</span><span class="ident" id="6904473">Errorf</span><span class="op" id="6904479">(</span><span class="string" id="6904480">&#34;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="6904501">,</span>&nbsp;<span class="ident" id="6904503">err</span><span class="op" id="6904506">,</span>&nbsp;<span class="ident" id="6904508">want</span><span class="op" id="6904512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6904515">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6904518">rowsCursorNextHook</span>&nbsp;<span class="op" id="6904537">=</span>&nbsp;<span class="ident" id="6904539">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6904545">want</span>&nbsp;<span class="op" id="6904550">=</span>&nbsp;<span class="string" id="6904552">&#34;error&nbsp;in&nbsp;rows.Close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6904575">rowsCloseHook</span>&nbsp;<span class="op" id="6904589">=</span>&nbsp;<span class="keyword" id="6904591">func</span><span class="op" id="6904595">(</span><span class="ident" id="6904596">rows</span>&nbsp;<span class="op" id="6904601">*</span><span class="ident" id="6904602">Rows</span><span class="op" id="6904606">,</span>&nbsp;<span class="ident" id="6904608">err</span>&nbsp;<span class="op" id="6904612">*</span><span class="builtintype" id="6904613">error</span><span class="op" id="6904618">)</span>&nbsp;<span class="op" id="6904620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6904624">*</span><span class="ident" id="6904625">err</span>&nbsp;<span class="op" id="6904629">=</span>&nbsp;<span class="ident" id="6904631">fmt</span><span class="op" id="6904634">.</span><span class="ident" id="6904635">Errorf</span><span class="op" id="6904641">(</span><span class="ident" id="6904642">want</span><span class="op" id="6904646">)</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6904649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6904652">defer</span>&nbsp;<span class="keyword" id="6904658">func</span><span class="op" id="6904662">(</span><span class="op" id="6904663">)</span>&nbsp;<span class="op" id="6904665">{</span>&nbsp;<span class="ident" id="6904667">rowsCloseHook</span>&nbsp;<span class="op" id="6904681">=</span>&nbsp;<span class="ident" id="6904683">nil</span>&nbsp;<span class="op" id="6904687">}</span><span class="op" id="6904688">(</span><span class="op" id="6904689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6904692">err</span>&nbsp;<span class="op" id="6904696">=</span>&nbsp;<span class="ident" id="6904698">db</span><span class="op" id="6904700">.</span><span class="ident" id="6904701">QueryRow</span><span class="op" id="6904709">(</span><span class="string" id="6904710">&#34;SELECT|people|name|&#34;</span><span class="op" id="6904731">)</span><span class="op" id="6904732">.</span><span class="ident" id="6904733">Scan</span><span class="op" id="6904737">(</span><span class="op" id="6904738">&amp;</span><span class="ident" id="6904739">v</span><span class="op" id="6904740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6904743">if</span>&nbsp;<span class="ident" id="6904746">err</span>&nbsp;<span class="op" id="6904750">==</span>&nbsp;<span class="ident" id="6904753">nil</span>&nbsp;<span class="op" id="6904757">||</span>&nbsp;<span class="ident" id="6904760">err</span><span class="op" id="6904763">.</span><span class="ident" id="6904764">Error</span><span class="op" id="6904769">(</span><span class="op" id="6904770">)</span>&nbsp;<span class="op" id="6904772">!=</span>&nbsp;<span class="ident" id="6904775">want</span>&nbsp;<span class="op" id="6904780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6904784">t</span><span class="op" id="6904785">.</span><span class="ident" id="6904786">Errorf</span><span class="op" id="6904792">(</span><span class="string" id="6904793">&#34;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="6904814">,</span>&nbsp;<span class="ident" id="6904816">err</span><span class="op" id="6904819">,</span>&nbsp;<span class="ident" id="6904821">want</span><span class="op" id="6904825">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6904828">}</span><br>
<span class="lineno"></span><span class="op" id="6904830">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6904833">type</span>&nbsp;<span class="ident" id="6904838">nullTestRow</span>&nbsp;<span class="keyword" id="6904850">struct</span>&nbsp;<span class="op" id="6904857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6904860">nullParam</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6904873">interface</span><span class="op" id="6904882">{</span><span class="op" id="6904883">}</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6904886">notNullParam</span>&nbsp;<span class="keyword" id="6904899">interface</span><span class="op" id="6904908">{</span><span class="op" id="6904909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6904912">scanNullVal</span>&nbsp;&nbsp;<span class="keyword" id="6904925">interface</span><span class="op" id="6904934">{</span><span class="op" id="6904935">}</span><br>
<span class="lineno"></span><span class="op" id="6904937">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6904940">type</span>&nbsp;<span class="ident" id="6904945">nullTestSpec</span>&nbsp;<span class="keyword" id="6904958">struct</span>&nbsp;<span class="op" id="6904965">{</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6904968">nullType</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6904980">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6904988">notNullType</span>&nbsp;<span class="builtintype" id="6905000">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6905008">rows</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6905020">[</span><span class="num" id="6905021">6</span><span class="op" id="6905022">]</span><span class="ident" id="6905023">nullTestRow</span><br>
<span class="lineno"></span><span class="op" id="6905035">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">740</span><span class="keyword" id="6905038">func</span>&nbsp;<span class="ident" id="6905043">TestNullStringParam</span><span class="op" id="6905062">(</span><span class="ident" id="6905063">t</span>&nbsp;<span class="op" id="6905065">*</span><span class="ident" id="6905066">testing</span><span class="op" id="6905073">.</span><span class="ident" id="6905074">T</span><span class="op" id="6905075">)</span>&nbsp;<span class="op" id="6905077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6905080">spec</span>&nbsp;<span class="op" id="6905085">:=</span>&nbsp;<span class="ident" id="6905088">nullTestSpec</span><span class="op" id="6905100">{</span><span class="string" id="6905101">&#34;nullstring&#34;</span><span class="op" id="6905113">,</span>&nbsp;<span class="string" id="6905115">&#34;string&#34;</span><span class="op" id="6905123">,</span>&nbsp;<span class="op" id="6905125">[</span><span class="num" id="6905126">6</span><span class="op" id="6905127">]</span><span class="ident" id="6905128">nullTestRow</span><span class="op" id="6905139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6905143">{</span><span class="ident" id="6905144">NullString</span><span class="op" id="6905154">{</span><span class="string" id="6905155">&#34;aqua&#34;</span><span class="op" id="6905161">,</span>&nbsp;<span class="builtintype" id="6905163">true</span><span class="op" id="6905167">}</span><span class="op" id="6905168">,</span>&nbsp;<span class="string" id="6905170">&#34;&#34;</span><span class="op" id="6905172">,</span>&nbsp;<span class="ident" id="6905174">NullString</span><span class="op" id="6905184">{</span><span class="string" id="6905185">&#34;aqua&#34;</span><span class="op" id="6905191">,</span>&nbsp;<span class="builtintype" id="6905193">true</span><span class="op" id="6905197">}</span><span class="op" id="6905198">}</span><span class="op" id="6905199">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6905203">{</span><span class="ident" id="6905204">NullString</span><span class="op" id="6905214">{</span><span class="string" id="6905215">&#34;brown&#34;</span><span class="op" id="6905222">,</span>&nbsp;<span class="builtintype" id="6905224">false</span><span class="op" id="6905229">}</span><span class="op" id="6905230">,</span>&nbsp;<span class="string" id="6905232">&#34;&#34;</span><span class="op" id="6905234">,</span>&nbsp;<span class="ident" id="6905236">NullString</span><span class="op" id="6905246">{</span><span class="string" id="6905247">&#34;&#34;</span><span class="op" id="6905249">,</span>&nbsp;<span class="builtintype" id="6905251">false</span><span class="op" id="6905256">}</span><span class="op" id="6905257">}</span><span class="op" id="6905258">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6905262">{</span><span class="string" id="6905263">&#34;chartreuse&#34;</span><span class="op" id="6905275">,</span>&nbsp;<span class="string" id="6905277">&#34;&#34;</span><span class="op" id="6905279">,</span>&nbsp;<span class="ident" id="6905281">NullString</span><span class="op" id="6905291">{</span><span class="string" id="6905292">&#34;chartreuse&#34;</span><span class="op" id="6905304">,</span>&nbsp;<span class="builtintype" id="6905306">true</span><span class="op" id="6905310">}</span><span class="op" id="6905311">}</span><span class="op" id="6905312">,</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6905316">{</span><span class="ident" id="6905317">NullString</span><span class="op" id="6905327">{</span><span class="string" id="6905328">&#34;darkred&#34;</span><span class="op" id="6905337">,</span>&nbsp;<span class="builtintype" id="6905339">true</span><span class="op" id="6905343">}</span><span class="op" id="6905344">,</span>&nbsp;<span class="string" id="6905346">&#34;&#34;</span><span class="op" id="6905348">,</span>&nbsp;<span class="ident" id="6905350">NullString</span><span class="op" id="6905360">{</span><span class="string" id="6905361">&#34;darkred&#34;</span><span class="op" id="6905370">,</span>&nbsp;<span class="builtintype" id="6905372">true</span><span class="op" id="6905376">}</span><span class="op" id="6905377">}</span><span class="op" id="6905378">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6905382">{</span><span class="ident" id="6905383">NullString</span><span class="op" id="6905393">{</span><span class="string" id="6905394">&#34;eel&#34;</span><span class="op" id="6905399">,</span>&nbsp;<span class="builtintype" id="6905401">false</span><span class="op" id="6905406">}</span><span class="op" id="6905407">,</span>&nbsp;<span class="string" id="6905409">&#34;&#34;</span><span class="op" id="6905411">,</span>&nbsp;<span class="ident" id="6905413">NullString</span><span class="op" id="6905423">{</span><span class="string" id="6905424">&#34;&#34;</span><span class="op" id="6905426">,</span>&nbsp;<span class="builtintype" id="6905428">false</span><span class="op" id="6905433">}</span><span class="op" id="6905434">}</span><span class="op" id="6905435">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6905439">{</span><span class="string" id="6905440">&#34;foo&#34;</span><span class="op" id="6905445">,</span>&nbsp;<span class="ident" id="6905447">NullString</span><span class="op" id="6905457">{</span><span class="string" id="6905458">&#34;black&#34;</span><span class="op" id="6905465">,</span>&nbsp;<span class="builtintype" id="6905467">false</span><span class="op" id="6905472">}</span><span class="op" id="6905473">,</span>&nbsp;<span class="ident" id="6905475">nil</span><span class="op" id="6905478">}</span><span class="op" id="6905479">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6905482">}</span><span class="op" id="6905483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6905486">nullTestRun</span><span class="op" id="6905497">(</span><span class="ident" id="6905498">t</span><span class="op" id="6905499">,</span>&nbsp;<span class="ident" id="6905501">spec</span><span class="op" id="6905505">)</span><br>
<span class="lineno">750</span><span class="op" id="6905507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6905510">func</span>&nbsp;<span class="ident" id="6905515">TestNullInt64Param</span><span class="op" id="6905533">(</span><span class="ident" id="6905534">t</span>&nbsp;<span class="op" id="6905536">*</span><span class="ident" id="6905537">testing</span><span class="op" id="6905544">.</span><span class="ident" id="6905545">T</span><span class="op" id="6905546">)</span>&nbsp;<span class="op" id="6905548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6905551">spec</span>&nbsp;<span class="op" id="6905556">:=</span>&nbsp;<span class="ident" id="6905559">nullTestSpec</span><span class="op" id="6905571">{</span><span class="string" id="6905572">&#34;nullint64&#34;</span><span class="op" id="6905583">,</span>&nbsp;<span class="string" id="6905585">&#34;int64&#34;</span><span class="op" id="6905592">,</span>&nbsp;<span class="op" id="6905594">[</span><span class="num" id="6905595">6</span><span class="op" id="6905596">]</span><span class="ident" id="6905597">nullTestRow</span><span class="op" id="6905608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6905612">{</span><span class="ident" id="6905613">NullInt64</span><span class="op" id="6905622">{</span><span class="num" id="6905623">31</span><span class="op" id="6905625">,</span>&nbsp;<span class="builtintype" id="6905627">true</span><span class="op" id="6905631">}</span><span class="op" id="6905632">,</span>&nbsp;<span class="num" id="6905634">1</span><span class="op" id="6905635">,</span>&nbsp;<span class="ident" id="6905637">NullInt64</span><span class="op" id="6905646">{</span><span class="num" id="6905647">31</span><span class="op" id="6905649">,</span>&nbsp;<span class="builtintype" id="6905651">true</span><span class="op" id="6905655">}</span><span class="op" id="6905656">}</span><span class="op" id="6905657">,</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6905661">{</span><span class="ident" id="6905662">NullInt64</span><span class="op" id="6905671">{</span><span class="op" id="6905672">-</span><span class="num" id="6905673">22</span><span class="op" id="6905675">,</span>&nbsp;<span class="builtintype" id="6905677">false</span><span class="op" id="6905682">}</span><span class="op" id="6905683">,</span>&nbsp;<span class="num" id="6905685">1</span><span class="op" id="6905686">,</span>&nbsp;<span class="ident" id="6905688">NullInt64</span><span class="op" id="6905697">{</span><span class="num" id="6905698">0</span><span class="op" id="6905699">,</span>&nbsp;<span class="builtintype" id="6905701">false</span><span class="op" id="6905706">}</span><span class="op" id="6905707">}</span><span class="op" id="6905708">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6905712">{</span><span class="num" id="6905713">22</span><span class="op" id="6905715">,</span>&nbsp;<span class="num" id="6905717">1</span><span class="op" id="6905718">,</span>&nbsp;<span class="ident" id="6905720">NullInt64</span><span class="op" id="6905729">{</span><span class="num" id="6905730">22</span><span class="op" id="6905732">,</span>&nbsp;<span class="builtintype" id="6905734">true</span><span class="op" id="6905738">}</span><span class="op" id="6905739">}</span><span class="op" id="6905740">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6905744">{</span><span class="ident" id="6905745">NullInt64</span><span class="op" id="6905754">{</span><span class="num" id="6905755">33</span><span class="op" id="6905757">,</span>&nbsp;<span class="builtintype" id="6905759">true</span><span class="op" id="6905763">}</span><span class="op" id="6905764">,</span>&nbsp;<span class="num" id="6905766">1</span><span class="op" id="6905767">,</span>&nbsp;<span class="ident" id="6905769">NullInt64</span><span class="op" id="6905778">{</span><span class="num" id="6905779">33</span><span class="op" id="6905781">,</span>&nbsp;<span class="builtintype" id="6905783">true</span><span class="op" id="6905787">}</span><span class="op" id="6905788">}</span><span class="op" id="6905789">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6905793">{</span><span class="ident" id="6905794">NullInt64</span><span class="op" id="6905803">{</span><span class="num" id="6905804">222</span><span class="op" id="6905807">,</span>&nbsp;<span class="builtintype" id="6905809">false</span><span class="op" id="6905814">}</span><span class="op" id="6905815">,</span>&nbsp;<span class="num" id="6905817">1</span><span class="op" id="6905818">,</span>&nbsp;<span class="ident" id="6905820">NullInt64</span><span class="op" id="6905829">{</span><span class="num" id="6905830">0</span><span class="op" id="6905831">,</span>&nbsp;<span class="builtintype" id="6905833">false</span><span class="op" id="6905838">}</span><span class="op" id="6905839">}</span><span class="op" id="6905840">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6905844">{</span><span class="num" id="6905845">0</span><span class="op" id="6905846">,</span>&nbsp;<span class="ident" id="6905848">NullInt64</span><span class="op" id="6905857">{</span><span class="num" id="6905858">31</span><span class="op" id="6905860">,</span>&nbsp;<span class="builtintype" id="6905862">false</span><span class="op" id="6905867">}</span><span class="op" id="6905868">,</span>&nbsp;<span class="ident" id="6905870">nil</span><span class="op" id="6905873">}</span><span class="op" id="6905874">,</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6905877">}</span><span class="op" id="6905878">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6905881">nullTestRun</span><span class="op" id="6905892">(</span><span class="ident" id="6905893">t</span><span class="op" id="6905894">,</span>&nbsp;<span class="ident" id="6905896">spec</span><span class="op" id="6905900">)</span><br>
<span class="lineno"></span><span class="op" id="6905902">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6905905">func</span>&nbsp;<span class="ident" id="6905910">TestNullFloat64Param</span><span class="op" id="6905930">(</span><span class="ident" id="6905931">t</span>&nbsp;<span class="op" id="6905933">*</span><span class="ident" id="6905934">testing</span><span class="op" id="6905941">.</span><span class="ident" id="6905942">T</span><span class="op" id="6905943">)</span>&nbsp;<span class="op" id="6905945">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6905948">spec</span>&nbsp;<span class="op" id="6905953">:=</span>&nbsp;<span class="ident" id="6905956">nullTestSpec</span><span class="op" id="6905968">{</span><span class="string" id="6905969">&#34;nullfloat64&#34;</span><span class="op" id="6905982">,</span>&nbsp;<span class="string" id="6905984">&#34;float64&#34;</span><span class="op" id="6905993">,</span>&nbsp;<span class="op" id="6905995">[</span><span class="num" id="6905996">6</span><span class="op" id="6905997">]</span><span class="ident" id="6905998">nullTestRow</span><span class="op" id="6906009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6906013">{</span><span class="ident" id="6906014">NullFloat64</span><span class="op" id="6906025">{</span><span class="num" id="6906026">31.2</span><span class="op" id="6906030">,</span>&nbsp;<span class="builtintype" id="6906032">true</span><span class="op" id="6906036">}</span><span class="op" id="6906037">,</span>&nbsp;<span class="num" id="6906039">1</span><span class="op" id="6906040">,</span>&nbsp;<span class="ident" id="6906042">NullFloat64</span><span class="op" id="6906053">{</span><span class="num" id="6906054">31.2</span><span class="op" id="6906058">,</span>&nbsp;<span class="builtintype" id="6906060">true</span><span class="op" id="6906064">}</span><span class="op" id="6906065">}</span><span class="op" id="6906066">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6906070">{</span><span class="ident" id="6906071">NullFloat64</span><span class="op" id="6906082">{</span><span class="num" id="6906083">13.1</span><span class="op" id="6906087">,</span>&nbsp;<span class="builtintype" id="6906089">false</span><span class="op" id="6906094">}</span><span class="op" id="6906095">,</span>&nbsp;<span class="num" id="6906097">1</span><span class="op" id="6906098">,</span>&nbsp;<span class="ident" id="6906100">NullFloat64</span><span class="op" id="6906111">{</span><span class="num" id="6906112">0</span><span class="op" id="6906113">,</span>&nbsp;<span class="builtintype" id="6906115">false</span><span class="op" id="6906120">}</span><span class="op" id="6906121">}</span><span class="op" id="6906122">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6906126">{</span><span class="op" id="6906127">-</span><span class="num" id="6906128">22.9</span><span class="op" id="6906132">,</span>&nbsp;<span class="num" id="6906134">1</span><span class="op" id="6906135">,</span>&nbsp;<span class="ident" id="6906137">NullFloat64</span><span class="op" id="6906148">{</span><span class="op" id="6906149">-</span><span class="num" id="6906150">22.9</span><span class="op" id="6906154">,</span>&nbsp;<span class="builtintype" id="6906156">true</span><span class="op" id="6906160">}</span><span class="op" id="6906161">}</span><span class="op" id="6906162">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6906166">{</span><span class="ident" id="6906167">NullFloat64</span><span class="op" id="6906178">{</span><span class="num" id="6906179">33.81</span><span class="op" id="6906184">,</span>&nbsp;<span class="builtintype" id="6906186">true</span><span class="op" id="6906190">}</span><span class="op" id="6906191">,</span>&nbsp;<span class="num" id="6906193">1</span><span class="op" id="6906194">,</span>&nbsp;<span class="ident" id="6906196">NullFloat64</span><span class="op" id="6906207">{</span><span class="num" id="6906208">33.81</span><span class="op" id="6906213">,</span>&nbsp;<span class="builtintype" id="6906215">true</span><span class="op" id="6906219">}</span><span class="op" id="6906220">}</span><span class="op" id="6906221">,</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6906225">{</span><span class="ident" id="6906226">NullFloat64</span><span class="op" id="6906237">{</span><span class="num" id="6906238">222</span><span class="op" id="6906241">,</span>&nbsp;<span class="builtintype" id="6906243">false</span><span class="op" id="6906248">}</span><span class="op" id="6906249">,</span>&nbsp;<span class="num" id="6906251">1</span><span class="op" id="6906252">,</span>&nbsp;<span class="ident" id="6906254">NullFloat64</span><span class="op" id="6906265">{</span><span class="num" id="6906266">0</span><span class="op" id="6906267">,</span>&nbsp;<span class="builtintype" id="6906269">false</span><span class="op" id="6906274">}</span><span class="op" id="6906275">}</span><span class="op" id="6906276">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6906280">{</span><span class="num" id="6906281">10</span><span class="op" id="6906283">,</span>&nbsp;<span class="ident" id="6906285">NullFloat64</span><span class="op" id="6906296">{</span><span class="num" id="6906297">31.2</span><span class="op" id="6906301">,</span>&nbsp;<span class="builtintype" id="6906303">false</span><span class="op" id="6906308">}</span><span class="op" id="6906309">,</span>&nbsp;<span class="ident" id="6906311">nil</span><span class="op" id="6906314">}</span><span class="op" id="6906315">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6906318">}</span><span class="op" id="6906319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6906322">nullTestRun</span><span class="op" id="6906333">(</span><span class="ident" id="6906334">t</span><span class="op" id="6906335">,</span>&nbsp;<span class="ident" id="6906337">spec</span><span class="op" id="6906341">)</span><br>
<span class="lineno"></span><span class="op" id="6906343">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span><span class="keyword" id="6906346">func</span>&nbsp;<span class="ident" id="6906351">TestNullBoolParam</span><span class="op" id="6906368">(</span><span class="ident" id="6906369">t</span>&nbsp;<span class="op" id="6906371">*</span><span class="ident" id="6906372">testing</span><span class="op" id="6906379">.</span><span class="ident" id="6906380">T</span><span class="op" id="6906381">)</span>&nbsp;<span class="op" id="6906383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6906386">spec</span>&nbsp;<span class="op" id="6906391">:=</span>&nbsp;<span class="ident" id="6906394">nullTestSpec</span><span class="op" id="6906406">{</span><span class="string" id="6906407">&#34;nullbool&#34;</span><span class="op" id="6906417">,</span>&nbsp;<span class="string" id="6906419">&#34;bool&#34;</span><span class="op" id="6906425">,</span>&nbsp;<span class="op" id="6906427">[</span><span class="num" id="6906428">6</span><span class="op" id="6906429">]</span><span class="ident" id="6906430">nullTestRow</span><span class="op" id="6906441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6906445">{</span><span class="ident" id="6906446">NullBool</span><span class="op" id="6906454">{</span><span class="builtintype" id="6906455">false</span><span class="op" id="6906460">,</span>&nbsp;<span class="builtintype" id="6906462">true</span><span class="op" id="6906466">}</span><span class="op" id="6906467">,</span>&nbsp;<span class="builtintype" id="6906469">true</span><span class="op" id="6906473">,</span>&nbsp;<span class="ident" id="6906475">NullBool</span><span class="op" id="6906483">{</span><span class="builtintype" id="6906484">false</span><span class="op" id="6906489">,</span>&nbsp;<span class="builtintype" id="6906491">true</span><span class="op" id="6906495">}</span><span class="op" id="6906496">}</span><span class="op" id="6906497">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6906501">{</span><span class="ident" id="6906502">NullBool</span><span class="op" id="6906510">{</span><span class="builtintype" id="6906511">true</span><span class="op" id="6906515">,</span>&nbsp;<span class="builtintype" id="6906517">false</span><span class="op" id="6906522">}</span><span class="op" id="6906523">,</span>&nbsp;<span class="builtintype" id="6906525">false</span><span class="op" id="6906530">,</span>&nbsp;<span class="ident" id="6906532">NullBool</span><span class="op" id="6906540">{</span><span class="builtintype" id="6906541">false</span><span class="op" id="6906546">,</span>&nbsp;<span class="builtintype" id="6906548">false</span><span class="op" id="6906553">}</span><span class="op" id="6906554">}</span><span class="op" id="6906555">,</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6906559">{</span><span class="builtintype" id="6906560">true</span><span class="op" id="6906564">,</span>&nbsp;<span class="builtintype" id="6906566">true</span><span class="op" id="6906570">,</span>&nbsp;<span class="ident" id="6906572">NullBool</span><span class="op" id="6906580">{</span><span class="builtintype" id="6906581">true</span><span class="op" id="6906585">,</span>&nbsp;<span class="builtintype" id="6906587">true</span><span class="op" id="6906591">}</span><span class="op" id="6906592">}</span><span class="op" id="6906593">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6906597">{</span><span class="ident" id="6906598">NullBool</span><span class="op" id="6906606">{</span><span class="builtintype" id="6906607">true</span><span class="op" id="6906611">,</span>&nbsp;<span class="builtintype" id="6906613">true</span><span class="op" id="6906617">}</span><span class="op" id="6906618">,</span>&nbsp;<span class="builtintype" id="6906620">false</span><span class="op" id="6906625">,</span>&nbsp;<span class="ident" id="6906627">NullBool</span><span class="op" id="6906635">{</span><span class="builtintype" id="6906636">true</span><span class="op" id="6906640">,</span>&nbsp;<span class="builtintype" id="6906642">true</span><span class="op" id="6906646">}</span><span class="op" id="6906647">}</span><span class="op" id="6906648">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6906652">{</span><span class="ident" id="6906653">NullBool</span><span class="op" id="6906661">{</span><span class="builtintype" id="6906662">true</span><span class="op" id="6906666">,</span>&nbsp;<span class="builtintype" id="6906668">false</span><span class="op" id="6906673">}</span><span class="op" id="6906674">,</span>&nbsp;<span class="builtintype" id="6906676">true</span><span class="op" id="6906680">,</span>&nbsp;<span class="ident" id="6906682">NullBool</span><span class="op" id="6906690">{</span><span class="builtintype" id="6906691">false</span><span class="op" id="6906696">,</span>&nbsp;<span class="builtintype" id="6906698">false</span><span class="op" id="6906703">}</span><span class="op" id="6906704">}</span><span class="op" id="6906705">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6906709">{</span><span class="builtintype" id="6906710">true</span><span class="op" id="6906714">,</span>&nbsp;<span class="ident" id="6906716">NullBool</span><span class="op" id="6906724">{</span><span class="builtintype" id="6906725">true</span><span class="op" id="6906729">,</span>&nbsp;<span class="builtintype" id="6906731">false</span><span class="op" id="6906736">}</span><span class="op" id="6906737">,</span>&nbsp;<span class="ident" id="6906739">nil</span><span class="op" id="6906742">}</span><span class="op" id="6906743">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6906746">}</span><span class="op" id="6906747">}</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6906750">nullTestRun</span><span class="op" id="6906761">(</span><span class="ident" id="6906762">t</span><span class="op" id="6906763">,</span>&nbsp;<span class="ident" id="6906765">spec</span><span class="op" id="6906769">)</span><br>
<span class="lineno"></span><span class="op" id="6906771">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6906774">func</span>&nbsp;<span class="ident" id="6906779">nullTestRun</span><span class="op" id="6906790">(</span><span class="ident" id="6906791">t</span>&nbsp;<span class="op" id="6906793">*</span><span class="ident" id="6906794">testing</span><span class="op" id="6906801">.</span><span class="ident" id="6906802">T</span><span class="op" id="6906803">,</span>&nbsp;<span class="ident" id="6906805">spec</span>&nbsp;<span class="ident" id="6906810">nullTestSpec</span><span class="op" id="6906822">)</span>&nbsp;<span class="op" id="6906824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6906827">db</span>&nbsp;<span class="op" id="6906830">:=</span>&nbsp;<span class="ident" id="6906833">newTestDB</span><span class="op" id="6906842">(</span><span class="ident" id="6906843">t</span><span class="op" id="6906844">,</span>&nbsp;<span class="string" id="6906846">&#34;&#34;</span><span class="op" id="6906848">)</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6906851">defer</span>&nbsp;<span class="ident" id="6906857">closeDB</span><span class="op" id="6906864">(</span><span class="ident" id="6906865">t</span><span class="op" id="6906866">,</span>&nbsp;<span class="ident" id="6906868">db</span><span class="op" id="6906870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6906873">exec</span><span class="op" id="6906877">(</span><span class="ident" id="6906878">t</span><span class="op" id="6906879">,</span>&nbsp;<span class="ident" id="6906881">db</span><span class="op" id="6906883">,</span>&nbsp;<span class="ident" id="6906885">fmt</span><span class="op" id="6906888">.</span><span class="ident" id="6906889">Sprintf</span><span class="op" id="6906896">(</span><span class="string" id="6906897">&#34;CREATE|t|id=int32,name=string,nullf=%s,notnullf=%s&#34;</span><span class="op" id="6906949">,</span>&nbsp;<span class="ident" id="6906951">spec</span><span class="op" id="6906955">.</span><span class="ident" id="6906956">nullType</span><span class="op" id="6906964">,</span>&nbsp;<span class="ident" id="6906966">spec</span><span class="op" id="6906970">.</span><span class="ident" id="6906971">notNullType</span><span class="op" id="6906982">)</span><span class="op" id="6906983">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6906987">//&nbsp;Inserts&nbsp;with&nbsp;db.Exec:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6907013">exec</span><span class="op" id="6907017">(</span><span class="ident" id="6907018">t</span><span class="op" id="6907019">,</span>&nbsp;<span class="ident" id="6907021">db</span><span class="op" id="6907023">,</span>&nbsp;<span class="string" id="6907025">&#34;INSERT|t|id=?,name=?,nullf=?,notnullf=?&#34;</span><span class="op" id="6907066">,</span>&nbsp;<span class="num" id="6907068">1</span><span class="op" id="6907069">,</span>&nbsp;<span class="string" id="6907071">&#34;alice&#34;</span><span class="op" id="6907078">,</span>&nbsp;<span class="ident" id="6907080">spec</span><span class="op" id="6907084">.</span><span class="ident" id="6907085">rows</span><span class="op" id="6907089">[</span><span class="num" id="6907090">0</span><span class="op" id="6907091">]</span><span class="op" id="6907092">.</span><span class="ident" id="6907093">nullParam</span><span class="op" id="6907102">,</span>&nbsp;<span class="ident" id="6907104">spec</span><span class="op" id="6907108">.</span><span class="ident" id="6907109">rows</span><span class="op" id="6907113">[</span><span class="num" id="6907114">0</span><span class="op" id="6907115">]</span><span class="op" id="6907116">.</span><span class="ident" id="6907117">notNullParam</span><span class="op" id="6907129">)</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6907132">exec</span><span class="op" id="6907136">(</span><span class="ident" id="6907137">t</span><span class="op" id="6907138">,</span>&nbsp;<span class="ident" id="6907140">db</span><span class="op" id="6907142">,</span>&nbsp;<span class="string" id="6907144">&#34;INSERT|t|id=?,name=?,nullf=?,notnullf=?&#34;</span><span class="op" id="6907185">,</span>&nbsp;<span class="num" id="6907187">2</span><span class="op" id="6907188">,</span>&nbsp;<span class="string" id="6907190">&#34;bob&#34;</span><span class="op" id="6907195">,</span>&nbsp;<span class="ident" id="6907197">spec</span><span class="op" id="6907201">.</span><span class="ident" id="6907202">rows</span><span class="op" id="6907206">[</span><span class="num" id="6907207">1</span><span class="op" id="6907208">]</span><span class="op" id="6907209">.</span><span class="ident" id="6907210">nullParam</span><span class="op" id="6907219">,</span>&nbsp;<span class="ident" id="6907221">spec</span><span class="op" id="6907225">.</span><span class="ident" id="6907226">rows</span><span class="op" id="6907230">[</span><span class="num" id="6907231">1</span><span class="op" id="6907232">]</span><span class="op" id="6907233">.</span><span class="ident" id="6907234">notNullParam</span><span class="op" id="6907246">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6907250">//&nbsp;Inserts&nbsp;with&nbsp;a&nbsp;prepared&nbsp;statement:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6907289">stmt</span><span class="op" id="6907293">,</span>&nbsp;<span class="ident" id="6907295">err</span>&nbsp;<span class="op" id="6907299">:=</span>&nbsp;<span class="ident" id="6907302">db</span><span class="op" id="6907304">.</span><span class="ident" id="6907305">Prepare</span><span class="op" id="6907312">(</span><span class="string" id="6907313">&#34;INSERT|t|id=?,name=?,nullf=?,notnullf=?&#34;</span><span class="op" id="6907354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6907357">if</span>&nbsp;<span class="ident" id="6907360">err</span>&nbsp;<span class="op" id="6907364">!=</span>&nbsp;<span class="ident" id="6907367">nil</span>&nbsp;<span class="op" id="6907371">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6907375">t</span><span class="op" id="6907376">.</span><span class="ident" id="6907377">Fatalf</span><span class="op" id="6907383">(</span><span class="string" id="6907384">&#34;prepare:&nbsp;%v&#34;</span><span class="op" id="6907397">,</span>&nbsp;<span class="ident" id="6907399">err</span><span class="op" id="6907402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6907405">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6907408">defer</span>&nbsp;<span class="ident" id="6907414">stmt</span><span class="op" id="6907418">.</span><span class="ident" id="6907419">Close</span><span class="op" id="6907424">(</span><span class="op" id="6907425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6907428">if</span>&nbsp;<span class="ident" id="6907431">_</span><span class="op" id="6907432">,</span>&nbsp;<span class="ident" id="6907434">err</span>&nbsp;<span class="op" id="6907438">:=</span>&nbsp;<span class="ident" id="6907441">stmt</span><span class="op" id="6907445">.</span><span class="ident" id="6907446">Exec</span><span class="op" id="6907450">(</span><span class="num" id="6907451">3</span><span class="op" id="6907452">,</span>&nbsp;<span class="string" id="6907454">&#34;chris&#34;</span><span class="op" id="6907461">,</span>&nbsp;<span class="ident" id="6907463">spec</span><span class="op" id="6907467">.</span><span class="ident" id="6907468">rows</span><span class="op" id="6907472">[</span><span class="num" id="6907473">2</span><span class="op" id="6907474">]</span><span class="op" id="6907475">.</span><span class="ident" id="6907476">nullParam</span><span class="op" id="6907485">,</span>&nbsp;<span class="ident" id="6907487">spec</span><span class="op" id="6907491">.</span><span class="ident" id="6907492">rows</span><span class="op" id="6907496">[</span><span class="num" id="6907497">2</span><span class="op" id="6907498">]</span><span class="op" id="6907499">.</span><span class="ident" id="6907500">notNullParam</span><span class="op" id="6907512">)</span><span class="op" id="6907513">;</span>&nbsp;<span class="ident" id="6907515">err</span>&nbsp;<span class="op" id="6907519">!=</span>&nbsp;<span class="ident" id="6907522">nil</span>&nbsp;<span class="op" id="6907526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6907530">t</span><span class="op" id="6907531">.</span><span class="ident" id="6907532">Errorf</span><span class="op" id="6907538">(</span><span class="string" id="6907539">&#34;exec&nbsp;insert&nbsp;chris:&nbsp;%v&#34;</span><span class="op" id="6907562">,</span>&nbsp;<span class="ident" id="6907564">err</span><span class="op" id="6907567">)</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6907570">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6907573">if</span>&nbsp;<span class="ident" id="6907576">_</span><span class="op" id="6907577">,</span>&nbsp;<span class="ident" id="6907579">err</span>&nbsp;<span class="op" id="6907583">:=</span>&nbsp;<span class="ident" id="6907586">stmt</span><span class="op" id="6907590">.</span><span class="ident" id="6907591">Exec</span><span class="op" id="6907595">(</span><span class="num" id="6907596">4</span><span class="op" id="6907597">,</span>&nbsp;<span class="string" id="6907599">&#34;dave&#34;</span><span class="op" id="6907605">,</span>&nbsp;<span class="ident" id="6907607">spec</span><span class="op" id="6907611">.</span><span class="ident" id="6907612">rows</span><span class="op" id="6907616">[</span><span class="num" id="6907617">3</span><span class="op" id="6907618">]</span><span class="op" id="6907619">.</span><span class="ident" id="6907620">nullParam</span><span class="op" id="6907629">,</span>&nbsp;<span class="ident" id="6907631">spec</span><span class="op" id="6907635">.</span><span class="ident" id="6907636">rows</span><span class="op" id="6907640">[</span><span class="num" id="6907641">3</span><span class="op" id="6907642">]</span><span class="op" id="6907643">.</span><span class="ident" id="6907644">notNullParam</span><span class="op" id="6907656">)</span><span class="op" id="6907657">;</span>&nbsp;<span class="ident" id="6907659">err</span>&nbsp;<span class="op" id="6907663">!=</span>&nbsp;<span class="ident" id="6907666">nil</span>&nbsp;<span class="op" id="6907670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6907674">t</span><span class="op" id="6907675">.</span><span class="ident" id="6907676">Errorf</span><span class="op" id="6907682">(</span><span class="string" id="6907683">&#34;exec&nbsp;insert&nbsp;dave:&nbsp;%v&#34;</span><span class="op" id="6907705">,</span>&nbsp;<span class="ident" id="6907707">err</span><span class="op" id="6907710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6907713">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6907716">if</span>&nbsp;<span class="ident" id="6907719">_</span><span class="op" id="6907720">,</span>&nbsp;<span class="ident" id="6907722">err</span>&nbsp;<span class="op" id="6907726">:=</span>&nbsp;<span class="ident" id="6907729">stmt</span><span class="op" id="6907733">.</span><span class="ident" id="6907734">Exec</span><span class="op" id="6907738">(</span><span class="num" id="6907739">5</span><span class="op" id="6907740">,</span>&nbsp;<span class="string" id="6907742">&#34;eleanor&#34;</span><span class="op" id="6907751">,</span>&nbsp;<span class="ident" id="6907753">spec</span><span class="op" id="6907757">.</span><span class="ident" id="6907758">rows</span><span class="op" id="6907762">[</span><span class="num" id="6907763">4</span><span class="op" id="6907764">]</span><span class="op" id="6907765">.</span><span class="ident" id="6907766">nullParam</span><span class="op" id="6907775">,</span>&nbsp;<span class="ident" id="6907777">spec</span><span class="op" id="6907781">.</span><span class="ident" id="6907782">rows</span><span class="op" id="6907786">[</span><span class="num" id="6907787">4</span><span class="op" id="6907788">]</span><span class="op" id="6907789">.</span><span class="ident" id="6907790">notNullParam</span><span class="op" id="6907802">)</span><span class="op" id="6907803">;</span>&nbsp;<span class="ident" id="6907805">err</span>&nbsp;<span class="op" id="6907809">!=</span>&nbsp;<span class="ident" id="6907812">nil</span>&nbsp;<span class="op" id="6907816">{</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6907820">t</span><span class="op" id="6907821">.</span><span class="ident" id="6907822">Errorf</span><span class="op" id="6907828">(</span><span class="string" id="6907829">&#34;exec&nbsp;insert&nbsp;eleanor:&nbsp;%v&#34;</span><span class="op" id="6907854">,</span>&nbsp;<span class="ident" id="6907856">err</span><span class="op" id="6907859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6907862">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6907866">//&nbsp;Can&#39;t&nbsp;put&nbsp;null&nbsp;val&nbsp;into&nbsp;non-null&nbsp;col</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6907907">if</span>&nbsp;<span class="ident" id="6907910">_</span><span class="op" id="6907911">,</span>&nbsp;<span class="ident" id="6907913">err</span>&nbsp;<span class="op" id="6907917">:=</span>&nbsp;<span class="ident" id="6907920">stmt</span><span class="op" id="6907924">.</span><span class="ident" id="6907925">Exec</span><span class="op" id="6907929">(</span><span class="num" id="6907930">6</span><span class="op" id="6907931">,</span>&nbsp;<span class="string" id="6907933">&#34;bob&#34;</span><span class="op" id="6907938">,</span>&nbsp;<span class="ident" id="6907940">spec</span><span class="op" id="6907944">.</span><span class="ident" id="6907945">rows</span><span class="op" id="6907949">[</span><span class="num" id="6907950">5</span><span class="op" id="6907951">]</span><span class="op" id="6907952">.</span><span class="ident" id="6907953">nullParam</span><span class="op" id="6907962">,</span>&nbsp;<span class="ident" id="6907964">spec</span><span class="op" id="6907968">.</span><span class="ident" id="6907969">rows</span><span class="op" id="6907973">[</span><span class="num" id="6907974">5</span><span class="op" id="6907975">]</span><span class="op" id="6907976">.</span><span class="ident" id="6907977">notNullParam</span><span class="op" id="6907989">)</span><span class="op" id="6907990">;</span>&nbsp;<span class="ident" id="6907992">err</span>&nbsp;<span class="op" id="6907996">==</span>&nbsp;<span class="ident" id="6907999">nil</span>&nbsp;<span class="op" id="6908003">{</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6908007">t</span><span class="op" id="6908008">.</span><span class="ident" id="6908009">Errorf</span><span class="op" id="6908015">(</span><span class="string" id="6908016">&#34;expected&nbsp;error&nbsp;inserting&nbsp;nil&nbsp;val&nbsp;with&nbsp;prepared&nbsp;statement&nbsp;Exec&#34;</span><span class="op" id="6908079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6908082">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6908086">_</span><span class="op" id="6908087">,</span>&nbsp;<span class="ident" id="6908089">err</span>&nbsp;<span class="op" id="6908093">=</span>&nbsp;<span class="ident" id="6908095">db</span><span class="op" id="6908097">.</span><span class="ident" id="6908098">Exec</span><span class="op" id="6908102">(</span><span class="string" id="6908103">&#34;INSERT|t|id=?,name=?,nullf=?&#34;</span><span class="op" id="6908133">,</span>&nbsp;<span class="num" id="6908135">999</span><span class="op" id="6908138">,</span>&nbsp;<span class="ident" id="6908140">nil</span><span class="op" id="6908143">,</span>&nbsp;<span class="ident" id="6908145">nil</span><span class="op" id="6908148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6908151">if</span>&nbsp;<span class="ident" id="6908154">err</span>&nbsp;<span class="op" id="6908158">==</span>&nbsp;<span class="ident" id="6908161">nil</span>&nbsp;<span class="op" id="6908165">{</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6908169">//&nbsp;TODO:&nbsp;this&nbsp;test&nbsp;fails,&nbsp;but&nbsp;it&#39;s&nbsp;just&nbsp;because</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6908219">//&nbsp;fakeConn&nbsp;implements&nbsp;the&nbsp;optional&nbsp;Execer&nbsp;interface,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6908275">//&nbsp;so&nbsp;arguably&nbsp;this&nbsp;is&nbsp;the&nbsp;correct&nbsp;behavior.&nbsp;&nbsp;But</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6908327">//&nbsp;maybe&nbsp;I&nbsp;should&nbsp;flesh&nbsp;out&nbsp;the&nbsp;fakeConn.Exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6908375">//&nbsp;implementation&nbsp;so&nbsp;this&nbsp;properly&nbsp;fails.</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6908419">//&nbsp;t.Errorf(&#34;expected&nbsp;error&nbsp;inserting&nbsp;nil&nbsp;name&nbsp;with&nbsp;Exec&#34;)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6908479">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6908483">paramtype</span>&nbsp;<span class="op" id="6908493">:=</span>&nbsp;<span class="ident" id="6908496">reflect</span><span class="op" id="6908503">.</span><span class="ident" id="6908504">TypeOf</span><span class="op" id="6908510">(</span><span class="ident" id="6908511">spec</span><span class="op" id="6908515">.</span><span class="ident" id="6908516">rows</span><span class="op" id="6908520">[</span><span class="num" id="6908521">0</span><span class="op" id="6908522">]</span><span class="op" id="6908523">.</span><span class="ident" id="6908524">nullParam</span><span class="op" id="6908533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6908536">bindVal</span>&nbsp;<span class="op" id="6908544">:=</span>&nbsp;<span class="ident" id="6908547">reflect</span><span class="op" id="6908554">.</span><span class="ident" id="6908555">New</span><span class="op" id="6908558">(</span><span class="ident" id="6908559">paramtype</span><span class="op" id="6908568">)</span><span class="op" id="6908569">.</span><span class="ident" id="6908570">Interface</span><span class="op" id="6908579">(</span><span class="op" id="6908580">)</span><br>
<span class="lineno">830</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6908584">for</span>&nbsp;<span class="ident" id="6908588">i</span>&nbsp;<span class="op" id="6908590">:=</span>&nbsp;<span class="num" id="6908593">0</span><span class="op" id="6908594">;</span>&nbsp;<span class="ident" id="6908596">i</span>&nbsp;<span class="op" id="6908598">&lt;</span>&nbsp;<span class="num" id="6908600">5</span><span class="op" id="6908601">;</span>&nbsp;<span class="ident" id="6908603">i</span><span class="op" id="6908604">++</span>&nbsp;<span class="op" id="6908607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6908611">id</span>&nbsp;<span class="op" id="6908614">:=</span>&nbsp;<span class="ident" id="6908617">i</span>&nbsp;<span class="op" id="6908619">+</span>&nbsp;<span class="num" id="6908621">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6908625">if</span>&nbsp;<span class="ident" id="6908628">err</span>&nbsp;<span class="op" id="6908632">:=</span>&nbsp;<span class="ident" id="6908635">db</span><span class="op" id="6908637">.</span><span class="ident" id="6908638">QueryRow</span><span class="op" id="6908646">(</span><span class="string" id="6908647">&#34;SELECT|t|nullf|id=?&#34;</span><span class="op" id="6908668">,</span>&nbsp;<span class="ident" id="6908670">id</span><span class="op" id="6908672">)</span><span class="op" id="6908673">.</span><span class="ident" id="6908674">Scan</span><span class="op" id="6908678">(</span><span class="ident" id="6908679">bindVal</span><span class="op" id="6908686">)</span><span class="op" id="6908687">;</span>&nbsp;<span class="ident" id="6908689">err</span>&nbsp;<span class="op" id="6908693">!=</span>&nbsp;<span class="ident" id="6908696">nil</span>&nbsp;<span class="op" id="6908700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6908705">t</span><span class="op" id="6908706">.</span><span class="ident" id="6908707">Errorf</span><span class="op" id="6908713">(</span><span class="string" id="6908714">&#34;id=%d&nbsp;Scan:&nbsp;%v&#34;</span><span class="op" id="6908730">,</span>&nbsp;<span class="ident" id="6908732">id</span><span class="op" id="6908734">,</span>&nbsp;<span class="ident" id="6908736">err</span><span class="op" id="6908739">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6908743">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6908747">bindValDeref</span>&nbsp;<span class="op" id="6908760">:=</span>&nbsp;<span class="ident" id="6908763">reflect</span><span class="op" id="6908770">.</span><span class="ident" id="6908771">ValueOf</span><span class="op" id="6908778">(</span><span class="ident" id="6908779">bindVal</span><span class="op" id="6908786">)</span><span class="op" id="6908787">.</span><span class="ident" id="6908788">Elem</span><span class="op" id="6908792">(</span><span class="op" id="6908793">)</span><span class="op" id="6908794">.</span><span class="ident" id="6908795">Interface</span><span class="op" id="6908804">(</span><span class="op" id="6908805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6908809">if</span>&nbsp;<span class="op" id="6908812">!</span><span class="ident" id="6908813">reflect</span><span class="op" id="6908820">.</span><span class="ident" id="6908821">DeepEqual</span><span class="op" id="6908830">(</span><span class="ident" id="6908831">bindValDeref</span><span class="op" id="6908843">,</span>&nbsp;<span class="ident" id="6908845">spec</span><span class="op" id="6908849">.</span><span class="ident" id="6908850">rows</span><span class="op" id="6908854">[</span><span class="ident" id="6908855">i</span><span class="op" id="6908856">]</span><span class="op" id="6908857">.</span><span class="ident" id="6908858">scanNullVal</span><span class="op" id="6908869">)</span>&nbsp;<span class="op" id="6908871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6908876">t</span><span class="op" id="6908877">.</span><span class="ident" id="6908878">Errorf</span><span class="op" id="6908884">(</span><span class="string" id="6908885">&#34;id=%d&nbsp;got&nbsp;%#v,&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="6908910">,</span>&nbsp;<span class="ident" id="6908912">id</span><span class="op" id="6908914">,</span>&nbsp;<span class="ident" id="6908916">bindValDeref</span><span class="op" id="6908928">,</span>&nbsp;<span class="ident" id="6908930">spec</span><span class="op" id="6908934">.</span><span class="ident" id="6908935">rows</span><span class="op" id="6908939">[</span><span class="ident" id="6908940">i</span><span class="op" id="6908941">]</span><span class="op" id="6908942">.</span><span class="ident" id="6908943">scanNullVal</span><span class="op" id="6908954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6908958">}</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6908961">}</span><br>
<span class="lineno"></span><span class="op" id="6908963">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6908966">//&nbsp;golang.org/issue/4859</span><br>
<span class="lineno"></span><span class="keyword" id="6908991">func</span>&nbsp;<span class="ident" id="6908996">TestQueryRowNilScanDest</span><span class="op" id="6909019">(</span><span class="ident" id="6909020">t</span>&nbsp;<span class="op" id="6909022">*</span><span class="ident" id="6909023">testing</span><span class="op" id="6909030">.</span><span class="ident" id="6909031">T</span><span class="op" id="6909032">)</span>&nbsp;<span class="op" id="6909034">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6909037">db</span>&nbsp;<span class="op" id="6909040">:=</span>&nbsp;<span class="ident" id="6909043">newTestDB</span><span class="op" id="6909052">(</span><span class="ident" id="6909053">t</span><span class="op" id="6909054">,</span>&nbsp;<span class="string" id="6909056">&#34;people&#34;</span><span class="op" id="6909064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6909067">defer</span>&nbsp;<span class="ident" id="6909073">closeDB</span><span class="op" id="6909080">(</span><span class="ident" id="6909081">t</span><span class="op" id="6909082">,</span>&nbsp;<span class="ident" id="6909084">db</span><span class="op" id="6909086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6909089">var</span>&nbsp;<span class="ident" id="6909093">name</span>&nbsp;<span class="op" id="6909098">*</span><span class="builtintype" id="6909099">string</span>&nbsp;<span class="comment" id="6909106">//&nbsp;nil&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6909122">err</span>&nbsp;<span class="op" id="6909126">:=</span>&nbsp;<span class="ident" id="6909129">db</span><span class="op" id="6909131">.</span><span class="ident" id="6909132">QueryRow</span><span class="op" id="6909140">(</span><span class="string" id="6909141">&#34;SELECT|people|name|&#34;</span><span class="op" id="6909162">)</span><span class="op" id="6909163">.</span><span class="ident" id="6909164">Scan</span><span class="op" id="6909168">(</span><span class="ident" id="6909169">name</span><span class="op" id="6909173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6909176">want</span>&nbsp;<span class="op" id="6909181">:=</span>&nbsp;<span class="string" id="6909184">&#34;sql:&nbsp;Scan&nbsp;error&nbsp;on&nbsp;column&nbsp;index&nbsp;0:&nbsp;destination&nbsp;pointer&nbsp;is&nbsp;nil&#34;</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6909249">if</span>&nbsp;<span class="ident" id="6909252">err</span>&nbsp;<span class="op" id="6909256">==</span>&nbsp;<span class="ident" id="6909259">nil</span>&nbsp;<span class="op" id="6909263">||</span>&nbsp;<span class="ident" id="6909266">err</span><span class="op" id="6909269">.</span><span class="ident" id="6909270">Error</span><span class="op" id="6909275">(</span><span class="op" id="6909276">)</span>&nbsp;<span class="op" id="6909278">!=</span>&nbsp;<span class="ident" id="6909281">want</span>&nbsp;<span class="op" id="6909286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6909290">t</span><span class="op" id="6909291">.</span><span class="ident" id="6909292">Errorf</span><span class="op" id="6909298">(</span><span class="string" id="6909299">&#34;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="6909320">,</span>&nbsp;<span class="ident" id="6909322">err</span><span class="op" id="6909325">.</span><span class="ident" id="6909326">Error</span><span class="op" id="6909331">(</span><span class="op" id="6909332">)</span><span class="op" id="6909333">,</span>&nbsp;<span class="ident" id="6909335">want</span><span class="op" id="6909339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6909342">}</span><br>
<span class="lineno"></span><span class="op" id="6909344">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">855</span><span class="keyword" id="6909347">func</span>&nbsp;<span class="ident" id="6909352">TestIssue4902</span><span class="op" id="6909365">(</span><span class="ident" id="6909366">t</span>&nbsp;<span class="op" id="6909368">*</span><span class="ident" id="6909369">testing</span><span class="op" id="6909376">.</span><span class="ident" id="6909377">T</span><span class="op" id="6909378">)</span>&nbsp;<span class="op" id="6909380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6909383">db</span>&nbsp;<span class="op" id="6909386">:=</span>&nbsp;<span class="ident" id="6909389">newTestDB</span><span class="op" id="6909398">(</span><span class="ident" id="6909399">t</span><span class="op" id="6909400">,</span>&nbsp;<span class="string" id="6909402">&#34;people&#34;</span><span class="op" id="6909410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6909413">defer</span>&nbsp;<span class="ident" id="6909419">closeDB</span><span class="op" id="6909426">(</span><span class="ident" id="6909427">t</span><span class="op" id="6909428">,</span>&nbsp;<span class="ident" id="6909430">db</span><span class="op" id="6909432">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6909436">driver</span>&nbsp;<span class="op" id="6909443">:=</span>&nbsp;<span class="ident" id="6909446">db</span><span class="op" id="6909448">.</span><span class="ident" id="6909449">driver</span><span class="op" id="6909455">.</span><span class="op" id="6909456">(</span><span class="op" id="6909457">*</span><span class="ident" id="6909458">fakeDriver</span><span class="op" id="6909468">)</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6909471">opens0</span>&nbsp;<span class="op" id="6909478">:=</span>&nbsp;<span class="ident" id="6909481">driver</span><span class="op" id="6909487">.</span><span class="ident" id="6909488">openCount</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6909500">var</span>&nbsp;<span class="ident" id="6909504">stmt</span>&nbsp;<span class="op" id="6909509">*</span><span class="ident" id="6909510">Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6909516">var</span>&nbsp;<span class="ident" id="6909520">err</span>&nbsp;<span class="builtintype" id="6909524">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6909531">for</span>&nbsp;<span class="ident" id="6909535">i</span>&nbsp;<span class="op" id="6909537">:=</span>&nbsp;<span class="num" id="6909540">0</span><span class="op" id="6909541">;</span>&nbsp;<span class="ident" id="6909543">i</span>&nbsp;<span class="op" id="6909545">&lt;</span>&nbsp;<span class="num" id="6909547">10</span><span class="op" id="6909549">;</span>&nbsp;<span class="ident" id="6909551">i</span><span class="op" id="6909552">++</span>&nbsp;<span class="op" id="6909555">{</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6909559">stmt</span><span class="op" id="6909563">,</span>&nbsp;<span class="ident" id="6909565">err</span>&nbsp;<span class="op" id="6909569">=</span>&nbsp;<span class="ident" id="6909571">db</span><span class="op" id="6909573">.</span><span class="ident" id="6909574">Prepare</span><span class="op" id="6909581">(</span><span class="string" id="6909582">&#34;SELECT|people|name|&#34;</span><span class="op" id="6909603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6909607">if</span>&nbsp;<span class="ident" id="6909610">err</span>&nbsp;<span class="op" id="6909614">!=</span>&nbsp;<span class="ident" id="6909617">nil</span>&nbsp;<span class="op" id="6909621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6909626">t</span><span class="op" id="6909627">.</span><span class="ident" id="6909628">Fatal</span><span class="op" id="6909633">(</span><span class="ident" id="6909634">err</span><span class="op" id="6909637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6909641">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6909645">err</span>&nbsp;<span class="op" id="6909649">=</span>&nbsp;<span class="ident" id="6909651">stmt</span><span class="op" id="6909655">.</span><span class="ident" id="6909656">Close</span><span class="op" id="6909661">(</span><span class="op" id="6909662">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6909666">if</span>&nbsp;<span class="ident" id="6909669">err</span>&nbsp;<span class="op" id="6909673">!=</span>&nbsp;<span class="ident" id="6909676">nil</span>&nbsp;<span class="op" id="6909680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6909685">t</span><span class="op" id="6909686">.</span><span class="ident" id="6909687">Fatal</span><span class="op" id="6909692">(</span><span class="ident" id="6909693">err</span><span class="op" id="6909696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6909700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6909703">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6909707">opens</span>&nbsp;<span class="op" id="6909713">:=</span>&nbsp;<span class="ident" id="6909716">driver</span><span class="op" id="6909722">.</span><span class="ident" id="6909723">openCount</span>&nbsp;<span class="op" id="6909733">-</span>&nbsp;<span class="ident" id="6909735">opens0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6909743">if</span>&nbsp;<span class="ident" id="6909746">opens</span>&nbsp;<span class="op" id="6909752">&gt;</span>&nbsp;<span class="num" id="6909754">1</span>&nbsp;<span class="op" id="6909756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6909760">t</span><span class="op" id="6909761">.</span><span class="ident" id="6909762">Errorf</span><span class="op" id="6909768">(</span><span class="string" id="6909769">&#34;opens&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;1&#34;</span><span class="op" id="6909792">,</span>&nbsp;<span class="ident" id="6909794">opens</span><span class="op" id="6909799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6909803">t</span><span class="op" id="6909804">.</span><span class="ident" id="6909805">Logf</span><span class="op" id="6909809">(</span><span class="string" id="6909810">&#34;db&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="6909820">,</span>&nbsp;<span class="ident" id="6909822">db</span><span class="op" id="6909824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6909828">t</span><span class="op" id="6909829">.</span><span class="ident" id="6909830">Logf</span><span class="op" id="6909834">(</span><span class="string" id="6909835">&#34;driver&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="6909849">,</span>&nbsp;<span class="ident" id="6909851">driver</span><span class="op" id="6909857">)</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6909861">t</span><span class="op" id="6909862">.</span><span class="ident" id="6909863">Logf</span><span class="op" id="6909867">(</span><span class="string" id="6909868">&#34;stmt&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="6909880">,</span>&nbsp;<span class="ident" id="6909882">stmt</span><span class="op" id="6909886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6909889">}</span><br>
<span class="lineno"></span><span class="op" id="6909891">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6909894">//&nbsp;Issue&nbsp;3857</span><br>
<span class="lineno">885</span><span class="comment" id="6909908">//&nbsp;This&nbsp;used&nbsp;to&nbsp;deadlock.</span><br>
<span class="lineno"></span><span class="keyword" id="6909934">func</span>&nbsp;<span class="ident" id="6909939">TestSimultaneousQueries</span><span class="op" id="6909962">(</span><span class="ident" id="6909963">t</span>&nbsp;<span class="op" id="6909965">*</span><span class="ident" id="6909966">testing</span><span class="op" id="6909973">.</span><span class="ident" id="6909974">T</span><span class="op" id="6909975">)</span>&nbsp;<span class="op" id="6909977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6909980">db</span>&nbsp;<span class="op" id="6909983">:=</span>&nbsp;<span class="ident" id="6909986">newTestDB</span><span class="op" id="6909995">(</span><span class="ident" id="6909996">t</span><span class="op" id="6909997">,</span>&nbsp;<span class="string" id="6909999">&#34;people&#34;</span><span class="op" id="6910007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6910010">defer</span>&nbsp;<span class="ident" id="6910016">closeDB</span><span class="op" id="6910023">(</span><span class="ident" id="6910024">t</span><span class="op" id="6910025">,</span>&nbsp;<span class="ident" id="6910027">db</span><span class="op" id="6910029">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6910033">tx</span><span class="op" id="6910035">,</span>&nbsp;<span class="ident" id="6910037">err</span>&nbsp;<span class="op" id="6910041">:=</span>&nbsp;<span class="ident" id="6910044">db</span><span class="op" id="6910046">.</span><span class="ident" id="6910047">Begin</span><span class="op" id="6910052">(</span><span class="op" id="6910053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6910056">if</span>&nbsp;<span class="ident" id="6910059">err</span>&nbsp;<span class="op" id="6910063">!=</span>&nbsp;<span class="ident" id="6910066">nil</span>&nbsp;<span class="op" id="6910070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6910074">t</span><span class="op" id="6910075">.</span><span class="ident" id="6910076">Fatal</span><span class="op" id="6910081">(</span><span class="ident" id="6910082">err</span><span class="op" id="6910085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6910088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6910091">defer</span>&nbsp;<span class="ident" id="6910097">tx</span><span class="op" id="6910099">.</span><span class="ident" id="6910100">Rollback</span><span class="op" id="6910108">(</span><span class="op" id="6910109">)</span><br>
<span class="lineno">895</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6910113">r1</span><span class="op" id="6910115">,</span>&nbsp;<span class="ident" id="6910117">err</span>&nbsp;<span class="op" id="6910121">:=</span>&nbsp;<span class="ident" id="6910124">tx</span><span class="op" id="6910126">.</span><span class="ident" id="6910127">Query</span><span class="op" id="6910132">(</span><span class="string" id="6910133">&#34;SELECT|people|name|&#34;</span><span class="op" id="6910154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6910157">if</span>&nbsp;<span class="ident" id="6910160">err</span>&nbsp;<span class="op" id="6910164">!=</span>&nbsp;<span class="ident" id="6910167">nil</span>&nbsp;<span class="op" id="6910171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6910175">t</span><span class="op" id="6910176">.</span><span class="ident" id="6910177">Fatal</span><span class="op" id="6910182">(</span><span class="ident" id="6910183">err</span><span class="op" id="6910186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6910189">}</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6910192">defer</span>&nbsp;<span class="ident" id="6910198">r1</span><span class="op" id="6910200">.</span><span class="ident" id="6910201">Close</span><span class="op" id="6910206">(</span><span class="op" id="6910207">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6910211">r2</span><span class="op" id="6910213">,</span>&nbsp;<span class="ident" id="6910215">err</span>&nbsp;<span class="op" id="6910219">:=</span>&nbsp;<span class="ident" id="6910222">tx</span><span class="op" id="6910224">.</span><span class="ident" id="6910225">Query</span><span class="op" id="6910230">(</span><span class="string" id="6910231">&#34;SELECT|people|name|&#34;</span><span class="op" id="6910252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6910255">if</span>&nbsp;<span class="ident" id="6910258">err</span>&nbsp;<span class="op" id="6910262">!=</span>&nbsp;<span class="ident" id="6910265">nil</span>&nbsp;<span class="op" id="6910269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6910273">t</span><span class="op" id="6910274">.</span><span class="ident" id="6910275">Fatal</span><span class="op" id="6910280">(</span><span class="ident" id="6910281">err</span><span class="op" id="6910284">)</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6910287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6910290">defer</span>&nbsp;<span class="ident" id="6910296">r2</span><span class="op" id="6910298">.</span><span class="ident" id="6910299">Close</span><span class="op" id="6910304">(</span><span class="op" id="6910305">)</span><br>
<span class="lineno"></span><span class="op" id="6910307">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6910310">func</span>&nbsp;<span class="ident" id="6910315">TestMaxIdleConns</span><span class="op" id="6910331">(</span><span class="ident" id="6910332">t</span>&nbsp;<span class="op" id="6910334">*</span><span class="ident" id="6910335">testing</span><span class="op" id="6910342">.</span><span class="ident" id="6910343">T</span><span class="op" id="6910344">)</span>&nbsp;<span class="op" id="6910346">{</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6910349">db</span>&nbsp;<span class="op" id="6910352">:=</span>&nbsp;<span class="ident" id="6910355">newTestDB</span><span class="op" id="6910364">(</span><span class="ident" id="6910365">t</span><span class="op" id="6910366">,</span>&nbsp;<span class="string" id="6910368">&#34;people&#34;</span><span class="op" id="6910376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6910379">defer</span>&nbsp;<span class="ident" id="6910385">closeDB</span><span class="op" id="6910392">(</span><span class="ident" id="6910393">t</span><span class="op" id="6910394">,</span>&nbsp;<span class="ident" id="6910396">db</span><span class="op" id="6910398">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6910402">tx</span><span class="op" id="6910404">,</span>&nbsp;<span class="ident" id="6910406">err</span>&nbsp;<span class="op" id="6910410">:=</span>&nbsp;<span class="ident" id="6910413">db</span><span class="op" id="6910415">.</span><span class="ident" id="6910416">Begin</span><span class="op" id="6910421">(</span><span class="op" id="6910422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6910425">if</span>&nbsp;<span class="ident" id="6910428">err</span>&nbsp;<span class="op" id="6910432">!=</span>&nbsp;<span class="ident" id="6910435">nil</span>&nbsp;<span class="op" id="6910439">{</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6910443">t</span><span class="op" id="6910444">.</span><span class="ident" id="6910445">Fatal</span><span class="op" id="6910450">(</span><span class="ident" id="6910451">err</span><span class="op" id="6910454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6910457">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6910460">tx</span><span class="op" id="6910462">.</span><span class="ident" id="6910463">Commit</span><span class="op" id="6910469">(</span><span class="op" id="6910470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6910473">if</span>&nbsp;<span class="ident" id="6910476">got</span>&nbsp;<span class="op" id="6910480">:=</span>&nbsp;<span class="builtinfunc" id="6910483">len</span><span class="op" id="6910486">(</span><span class="ident" id="6910487">db</span><span class="op" id="6910489">.</span><span class="ident" id="6910490">freeConn</span><span class="op" id="6910498">)</span><span class="op" id="6910499">;</span>&nbsp;<span class="ident" id="6910501">got</span>&nbsp;<span class="op" id="6910505">!=</span>&nbsp;<span class="num" id="6910508">1</span>&nbsp;<span class="op" id="6910510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6910514">t</span><span class="op" id="6910515">.</span><span class="ident" id="6910516">Errorf</span><span class="op" id="6910522">(</span><span class="string" id="6910523">&#34;freeConns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="6910547">,</span>&nbsp;<span class="ident" id="6910549">got</span><span class="op" id="6910552">)</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6910555">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6910559">db</span><span class="op" id="6910561">.</span><span class="ident" id="6910562">SetMaxIdleConns</span><span class="op" id="6910577">(</span><span class="num" id="6910578">0</span><span class="op" id="6910579">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6910583">if</span>&nbsp;<span class="ident" id="6910586">got</span>&nbsp;<span class="op" id="6910590">:=</span>&nbsp;<span class="builtinfunc" id="6910593">len</span><span class="op" id="6910596">(</span><span class="ident" id="6910597">db</span><span class="op" id="6910599">.</span><span class="ident" id="6910600">freeConn</span><span class="op" id="6910608">)</span><span class="op" id="6910609">;</span>&nbsp;<span class="ident" id="6910611">got</span>&nbsp;<span class="op" id="6910615">!=</span>&nbsp;<span class="num" id="6910618">0</span>&nbsp;<span class="op" id="6910620">{</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6910624">t</span><span class="op" id="6910625">.</span><span class="ident" id="6910626">Errorf</span><span class="op" id="6910632">(</span><span class="string" id="6910633">&#34;freeConns&nbsp;after&nbsp;set&nbsp;to&nbsp;zero&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="6910675">,</span>&nbsp;<span class="ident" id="6910677">got</span><span class="op" id="6910680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6910683">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6910687">tx</span><span class="op" id="6910689">,</span>&nbsp;<span class="ident" id="6910691">err</span>&nbsp;<span class="op" id="6910695">=</span>&nbsp;<span class="ident" id="6910697">db</span><span class="op" id="6910699">.</span><span class="ident" id="6910700">Begin</span><span class="op" id="6910705">(</span><span class="op" id="6910706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6910709">if</span>&nbsp;<span class="ident" id="6910712">err</span>&nbsp;<span class="op" id="6910716">!=</span>&nbsp;<span class="ident" id="6910719">nil</span>&nbsp;<span class="op" id="6910723">{</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6910727">t</span><span class="op" id="6910728">.</span><span class="ident" id="6910729">Fatal</span><span class="op" id="6910734">(</span><span class="ident" id="6910735">err</span><span class="op" id="6910738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6910741">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6910744">tx</span><span class="op" id="6910746">.</span><span class="ident" id="6910747">Commit</span><span class="op" id="6910753">(</span><span class="op" id="6910754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6910757">if</span>&nbsp;<span class="ident" id="6910760">got</span>&nbsp;<span class="op" id="6910764">:=</span>&nbsp;<span class="builtinfunc" id="6910767">len</span><span class="op" id="6910770">(</span><span class="ident" id="6910771">db</span><span class="op" id="6910773">.</span><span class="ident" id="6910774">freeConn</span><span class="op" id="6910782">)</span><span class="op" id="6910783">;</span>&nbsp;<span class="ident" id="6910785">got</span>&nbsp;<span class="op" id="6910789">!=</span>&nbsp;<span class="num" id="6910792">0</span>&nbsp;<span class="op" id="6910794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6910798">t</span><span class="op" id="6910799">.</span><span class="ident" id="6910800">Errorf</span><span class="op" id="6910806">(</span><span class="string" id="6910807">&#34;freeConns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="6910831">,</span>&nbsp;<span class="ident" id="6910833">got</span><span class="op" id="6910836">)</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6910839">}</span><br>
<span class="lineno"></span><span class="op" id="6910841">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6910844">func</span>&nbsp;<span class="ident" id="6910849">TestMaxOpenConns</span><span class="op" id="6910865">(</span><span class="ident" id="6910866">t</span>&nbsp;<span class="op" id="6910868">*</span><span class="ident" id="6910869">testing</span><span class="op" id="6910876">.</span><span class="ident" id="6910877">T</span><span class="op" id="6910878">)</span>&nbsp;<span class="op" id="6910880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6910883">if</span>&nbsp;<span class="ident" id="6910886">testing</span><span class="op" id="6910893">.</span><span class="ident" id="6910894">Short</span><span class="op" id="6910899">(</span><span class="op" id="6910900">)</span>&nbsp;<span class="op" id="6910902">{</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6910906">t</span><span class="op" id="6910907">.</span><span class="ident" id="6910908">Skip</span><span class="op" id="6910912">(</span><span class="string" id="6910913">&#34;skipping&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="6910937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6910940">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6910943">defer</span>&nbsp;<span class="ident" id="6910949">setHookpostCloseConn</span><span class="op" id="6910969">(</span><span class="ident" id="6910970">nil</span><span class="op" id="6910973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6910976">setHookpostCloseConn</span><span class="op" id="6910996">(</span><span class="keyword" id="6910997">func</span><span class="op" id="6911001">(</span><span class="ident" id="6911002">_</span>&nbsp;<span class="op" id="6911004">*</span><span class="ident" id="6911005">fakeConn</span><span class="op" id="6911013">,</span>&nbsp;<span class="ident" id="6911015">err</span>&nbsp;<span class="builtintype" id="6911019">error</span><span class="op" id="6911024">)</span>&nbsp;<span class="op" id="6911026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6911030">if</span>&nbsp;<span class="ident" id="6911033">err</span>&nbsp;<span class="op" id="6911037">!=</span>&nbsp;<span class="ident" id="6911040">nil</span>&nbsp;<span class="op" id="6911044">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6911049">t</span><span class="op" id="6911050">.</span><span class="ident" id="6911051">Errorf</span><span class="op" id="6911057">(</span><span class="string" id="6911058">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="6911086">,</span>&nbsp;<span class="ident" id="6911088">err</span><span class="op" id="6911091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6911095">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6911098">}</span><span class="op" id="6911099">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6911103">db</span>&nbsp;<span class="op" id="6911106">:=</span>&nbsp;<span class="ident" id="6911109">newTestDB</span><span class="op" id="6911118">(</span><span class="ident" id="6911119">t</span><span class="op" id="6911120">,</span>&nbsp;<span class="string" id="6911122">&#34;magicquery&#34;</span><span class="op" id="6911134">)</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6911137">defer</span>&nbsp;<span class="ident" id="6911143">closeDB</span><span class="op" id="6911150">(</span><span class="ident" id="6911151">t</span><span class="op" id="6911152">,</span>&nbsp;<span class="ident" id="6911154">db</span><span class="op" id="6911156">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6911160">driver</span>&nbsp;<span class="op" id="6911167">:=</span>&nbsp;<span class="ident" id="6911170">db</span><span class="op" id="6911172">.</span><span class="ident" id="6911173">driver</span><span class="op" id="6911179">.</span><span class="op" id="6911180">(</span><span class="op" id="6911181">*</span><span class="ident" id="6911182">fakeDriver</span><span class="op" id="6911192">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6911196">//&nbsp;Force&nbsp;the&nbsp;number&nbsp;of&nbsp;open&nbsp;connections&nbsp;to&nbsp;0&nbsp;so&nbsp;we&nbsp;can&nbsp;get&nbsp;an&nbsp;accurate</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6911268">//&nbsp;count&nbsp;for&nbsp;the&nbsp;test</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6911291">db</span><span class="op" id="6911293">.</span><span class="ident" id="6911294">SetMaxIdleConns</span><span class="op" id="6911309">(</span><span class="num" id="6911310">0</span><span class="op" id="6911311">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6911315">if</span>&nbsp;<span class="ident" id="6911318">g</span><span class="op" id="6911319">,</span>&nbsp;<span class="ident" id="6911321">w</span>&nbsp;<span class="op" id="6911323">:=</span>&nbsp;<span class="ident" id="6911326">db</span><span class="op" id="6911328">.</span><span class="ident" id="6911329">numFreeConns</span><span class="op" id="6911341">(</span><span class="op" id="6911342">)</span><span class="op" id="6911343">,</span>&nbsp;<span class="num" id="6911345">0</span><span class="op" id="6911346">;</span>&nbsp;<span class="ident" id="6911348">g</span>&nbsp;<span class="op" id="6911350">!=</span>&nbsp;<span class="ident" id="6911353">w</span>&nbsp;<span class="op" id="6911355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6911359">t</span><span class="op" id="6911360">.</span><span class="ident" id="6911361">Errorf</span><span class="op" id="6911367">(</span><span class="string" id="6911368">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6911394">,</span>&nbsp;<span class="ident" id="6911396">g</span><span class="op" id="6911397">,</span>&nbsp;<span class="ident" id="6911399">w</span><span class="op" id="6911400">)</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6911403">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6911407">if</span>&nbsp;<span class="ident" id="6911410">n</span>&nbsp;<span class="op" id="6911412">:=</span>&nbsp;<span class="ident" id="6911415">db</span><span class="op" id="6911417">.</span><span class="ident" id="6911418">numDepsPollUntil</span><span class="op" id="6911434">(</span><span class="num" id="6911435">0</span><span class="op" id="6911436">,</span>&nbsp;<span class="ident" id="6911438">time</span><span class="op" id="6911442">.</span><span class="ident" id="6911443">Second</span><span class="op" id="6911449">)</span><span class="op" id="6911450">;</span>&nbsp;<span class="ident" id="6911452">n</span>&nbsp;<span class="op" id="6911454">&gt;</span>&nbsp;<span class="num" id="6911456">0</span>&nbsp;<span class="op" id="6911458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6911462">t</span><span class="op" id="6911463">.</span><span class="ident" id="6911464">Errorf</span><span class="op" id="6911470">(</span><span class="string" id="6911471">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="6911512">,</span>&nbsp;<span class="ident" id="6911514">n</span><span class="op" id="6911515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6911519">db</span><span class="op" id="6911521">.</span><span class="ident" id="6911522">dumpDeps</span><span class="op" id="6911530">(</span><span class="ident" id="6911531">t</span><span class="op" id="6911532">)</span><br>
<span class="lineno">965</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6911535">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6911539">driver</span><span class="op" id="6911545">.</span><span class="ident" id="6911546">mu</span><span class="op" id="6911548">.</span><span class="ident" id="6911549">Lock</span><span class="op" id="6911553">(</span><span class="op" id="6911554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6911557">opens0</span>&nbsp;<span class="op" id="6911564">:=</span>&nbsp;<span class="ident" id="6911567">driver</span><span class="op" id="6911573">.</span><span class="ident" id="6911574">openCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6911585">closes0</span>&nbsp;<span class="op" id="6911593">:=</span>&nbsp;<span class="ident" id="6911596">driver</span><span class="op" id="6911602">.</span><span class="ident" id="6911603">closeCount</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6911615">driver</span><span class="op" id="6911621">.</span><span class="ident" id="6911622">mu</span><span class="op" id="6911624">.</span><span class="ident" id="6911625">Unlock</span><span class="op" id="6911631">(</span><span class="op" id="6911632">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6911636">db</span><span class="op" id="6911638">.</span><span class="ident" id="6911639">SetMaxIdleConns</span><span class="op" id="6911654">(</span><span class="num" id="6911655">10</span><span class="op" id="6911657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6911660">db</span><span class="op" id="6911662">.</span><span class="ident" id="6911663">SetMaxOpenConns</span><span class="op" id="6911678">(</span><span class="num" id="6911679">10</span><span class="op" id="6911681">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6911685">stmt</span><span class="op" id="6911689">,</span>&nbsp;<span class="ident" id="6911691">err</span>&nbsp;<span class="op" id="6911695">:=</span>&nbsp;<span class="ident" id="6911698">db</span><span class="op" id="6911700">.</span><span class="ident" id="6911701">Prepare</span><span class="op" id="6911708">(</span><span class="string" id="6911709">&#34;SELECT|magicquery|op|op=?,millis=?&#34;</span><span class="op" id="6911745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6911748">if</span>&nbsp;<span class="ident" id="6911751">err</span>&nbsp;<span class="op" id="6911755">!=</span>&nbsp;<span class="ident" id="6911758">nil</span>&nbsp;<span class="op" id="6911762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6911766">t</span><span class="op" id="6911767">.</span><span class="ident" id="6911768">Fatal</span><span class="op" id="6911773">(</span><span class="ident" id="6911774">err</span><span class="op" id="6911777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6911780">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6911784">//&nbsp;Start&nbsp;50&nbsp;parallel&nbsp;slow&nbsp;queries.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6911820">const</span>&nbsp;<span class="op" id="6911826">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6911830">nquery</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6911842">=</span>&nbsp;<span class="num" id="6911844">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6911849">sleepMillis</span>&nbsp;<span class="op" id="6911861">=</span>&nbsp;<span class="num" id="6911863">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6911868">nbatch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6911880">=</span>&nbsp;<span class="num" id="6911882">2</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6911885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6911888">var</span>&nbsp;<span class="ident" id="6911892">wg</span>&nbsp;<span class="ident" id="6911895">sync</span><span class="op" id="6911899">.</span><span class="ident" id="6911900">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6911911">for</span>&nbsp;<span class="ident" id="6911915">batch</span>&nbsp;<span class="op" id="6911921">:=</span>&nbsp;<span class="num" id="6911924">0</span><span class="op" id="6911925">;</span>&nbsp;<span class="ident" id="6911927">batch</span>&nbsp;<span class="op" id="6911933">&lt;</span>&nbsp;<span class="ident" id="6911935">nbatch</span><span class="op" id="6911941">;</span>&nbsp;<span class="ident" id="6911943">batch</span><span class="op" id="6911948">++</span>&nbsp;<span class="op" id="6911951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6911955">for</span>&nbsp;<span class="ident" id="6911959">i</span>&nbsp;<span class="op" id="6911961">:=</span>&nbsp;<span class="num" id="6911964">0</span><span class="op" id="6911965">;</span>&nbsp;<span class="ident" id="6911967">i</span>&nbsp;<span class="op" id="6911969">&lt;</span>&nbsp;<span class="ident" id="6911971">nquery</span><span class="op" id="6911977">;</span>&nbsp;<span class="ident" id="6911979">i</span><span class="op" id="6911980">++</span>&nbsp;<span class="op" id="6911983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6911988">wg</span><span class="op" id="6911990">.</span><span class="ident" id="6911991">Add</span><span class="op" id="6911994">(</span><span class="num" id="6911995">1</span><span class="op" id="6911996">)</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6912001">go</span>&nbsp;<span class="keyword" id="6912004">func</span><span class="op" id="6912008">(</span><span class="op" id="6912009">)</span>&nbsp;<span class="op" id="6912011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6912017">defer</span>&nbsp;<span class="ident" id="6912023">wg</span><span class="op" id="6912025">.</span><span class="ident" id="6912026">Done</span><span class="op" id="6912030">(</span><span class="op" id="6912031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6912037">var</span>&nbsp;<span class="ident" id="6912041">op</span>&nbsp;<span class="builtintype" id="6912044">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6912055">if</span>&nbsp;<span class="ident" id="6912058">err</span>&nbsp;<span class="op" id="6912062">:=</span>&nbsp;<span class="ident" id="6912065">stmt</span><span class="op" id="6912069">.</span><span class="ident" id="6912070">QueryRow</span><span class="op" id="6912078">(</span><span class="string" id="6912079">&#34;sleep&#34;</span><span class="op" id="6912086">,</span>&nbsp;<span class="ident" id="6912088">sleepMillis</span><span class="op" id="6912099">)</span><span class="op" id="6912100">.</span><span class="ident" id="6912101">Scan</span><span class="op" id="6912105">(</span><span class="op" id="6912106">&amp;</span><span class="ident" id="6912107">op</span><span class="op" id="6912109">)</span><span class="op" id="6912110">;</span>&nbsp;<span class="ident" id="6912112">err</span>&nbsp;<span class="op" id="6912116">!=</span>&nbsp;<span class="ident" id="6912119">nil</span>&nbsp;<span class="op" id="6912123">&amp;&amp;</span>&nbsp;<span class="ident" id="6912126">err</span>&nbsp;<span class="op" id="6912130">!=</span>&nbsp;<span class="ident" id="6912133">ErrNoRows</span>&nbsp;<span class="op" id="6912143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6912150">t</span><span class="op" id="6912151">.</span><span class="ident" id="6912152">Error</span><span class="op" id="6912157">(</span><span class="ident" id="6912158">err</span><span class="op" id="6912161">)</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6912167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6912172">}</span><span class="op" id="6912173">(</span><span class="op" id="6912174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6912178">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6912182">//&nbsp;Sleep&nbsp;for&nbsp;twice&nbsp;the&nbsp;expected&nbsp;length&nbsp;of&nbsp;time&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6912239">//&nbsp;batch&nbsp;of&nbsp;50&nbsp;queries&nbsp;above&nbsp;to&nbsp;finish&nbsp;before&nbsp;starting</span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6912296">//&nbsp;the&nbsp;next&nbsp;round.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6912317">time</span><span class="op" id="6912321">.</span><span class="ident" id="6912322">Sleep</span><span class="op" id="6912327">(</span><span class="num" id="6912328">2</span>&nbsp;<span class="op" id="6912330">*</span>&nbsp;<span class="ident" id="6912332">sleepMillis</span>&nbsp;<span class="op" id="6912344">*</span>&nbsp;<span class="ident" id="6912346">time</span><span class="op" id="6912350">.</span><span class="ident" id="6912351">Millisecond</span><span class="op" id="6912362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6912365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6912368">wg</span><span class="op" id="6912370">.</span><span class="ident" id="6912371">Wait</span><span class="op" id="6912375">(</span><span class="op" id="6912376">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6912380">if</span>&nbsp;<span class="ident" id="6912383">g</span><span class="op" id="6912384">,</span>&nbsp;<span class="ident" id="6912386">w</span>&nbsp;<span class="op" id="6912388">:=</span>&nbsp;<span class="ident" id="6912391">db</span><span class="op" id="6912393">.</span><span class="ident" id="6912394">numFreeConns</span><span class="op" id="6912406">(</span><span class="op" id="6912407">)</span><span class="op" id="6912408">,</span>&nbsp;<span class="num" id="6912410">10</span><span class="op" id="6912412">;</span>&nbsp;<span class="ident" id="6912414">g</span>&nbsp;<span class="op" id="6912416">!=</span>&nbsp;<span class="ident" id="6912419">w</span>&nbsp;<span class="op" id="6912421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6912425">t</span><span class="op" id="6912426">.</span><span class="ident" id="6912427">Errorf</span><span class="op" id="6912433">(</span><span class="string" id="6912434">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6912460">,</span>&nbsp;<span class="ident" id="6912462">g</span><span class="op" id="6912463">,</span>&nbsp;<span class="ident" id="6912465">w</span><span class="op" id="6912466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6912469">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6912473">if</span>&nbsp;<span class="ident" id="6912476">n</span>&nbsp;<span class="op" id="6912478">:=</span>&nbsp;<span class="ident" id="6912481">db</span><span class="op" id="6912483">.</span><span class="ident" id="6912484">numDepsPollUntil</span><span class="op" id="6912500">(</span><span class="num" id="6912501">20</span><span class="op" id="6912503">,</span>&nbsp;<span class="ident" id="6912505">time</span><span class="op" id="6912509">.</span><span class="ident" id="6912510">Second</span><span class="op" id="6912516">)</span><span class="op" id="6912517">;</span>&nbsp;<span class="ident" id="6912519">n</span>&nbsp;<span class="op" id="6912521">&gt;</span>&nbsp;<span class="num" id="6912523">20</span>&nbsp;<span class="op" id="6912526">{</span><br>
<span class="lineno">1010</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6912530">t</span><span class="op" id="6912531">.</span><span class="ident" id="6912532">Errorf</span><span class="op" id="6912538">(</span><span class="string" id="6912539">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;20&#34;</span><span class="op" id="6912584">,</span>&nbsp;<span class="ident" id="6912586">n</span><span class="op" id="6912587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6912591">db</span><span class="op" id="6912593">.</span><span class="ident" id="6912594">dumpDeps</span><span class="op" id="6912602">(</span><span class="ident" id="6912603">t</span><span class="op" id="6912604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6912607">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6912611">driver</span><span class="op" id="6912617">.</span><span class="ident" id="6912618">mu</span><span class="op" id="6912620">.</span><span class="ident" id="6912621">Lock</span><span class="op" id="6912625">(</span><span class="op" id="6912626">)</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6912629">opens</span>&nbsp;<span class="op" id="6912635">:=</span>&nbsp;<span class="ident" id="6912638">driver</span><span class="op" id="6912644">.</span><span class="ident" id="6912645">openCount</span>&nbsp;<span class="op" id="6912655">-</span>&nbsp;<span class="ident" id="6912657">opens0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6912665">closes</span>&nbsp;<span class="op" id="6912672">:=</span>&nbsp;<span class="ident" id="6912675">driver</span><span class="op" id="6912681">.</span><span class="ident" id="6912682">closeCount</span>&nbsp;<span class="op" id="6912693">-</span>&nbsp;<span class="ident" id="6912695">closes0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6912704">driver</span><span class="op" id="6912710">.</span><span class="ident" id="6912711">mu</span><span class="op" id="6912713">.</span><span class="ident" id="6912714">Unlock</span><span class="op" id="6912720">(</span><span class="op" id="6912721">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6912725">if</span>&nbsp;<span class="ident" id="6912728">opens</span>&nbsp;<span class="op" id="6912734">&gt;</span>&nbsp;<span class="num" id="6912736">10</span>&nbsp;<span class="op" id="6912739">{</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6912743">t</span><span class="op" id="6912744">.</span><span class="ident" id="6912745">Logf</span><span class="op" id="6912749">(</span><span class="string" id="6912750">&#34;open&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="6912767">,</span>&nbsp;<span class="ident" id="6912769">opens</span><span class="op" id="6912774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6912778">t</span><span class="op" id="6912779">.</span><span class="ident" id="6912780">Logf</span><span class="op" id="6912784">(</span><span class="string" id="6912785">&#34;close&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="6912803">,</span>&nbsp;<span class="ident" id="6912805">closes</span><span class="op" id="6912811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6912815">t</span><span class="op" id="6912816">.</span><span class="ident" id="6912817">Errorf</span><span class="op" id="6912823">(</span><span class="string" id="6912824">&#34;db&nbsp;connections&nbsp;opened&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;10&#34;</span><span class="op" id="6912864">,</span>&nbsp;<span class="ident" id="6912866">opens</span><span class="op" id="6912871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6912875">db</span><span class="op" id="6912877">.</span><span class="ident" id="6912878">dumpDeps</span><span class="op" id="6912886">(</span><span class="ident" id="6912887">t</span><span class="op" id="6912888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6912891">}</span><br>
<span class="lineno">1025</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6912895">if</span>&nbsp;<span class="ident" id="6912898">err</span>&nbsp;<span class="op" id="6912902">:=</span>&nbsp;<span class="ident" id="6912905">stmt</span><span class="op" id="6912909">.</span><span class="ident" id="6912910">Close</span><span class="op" id="6912915">(</span><span class="op" id="6912916">)</span><span class="op" id="6912917">;</span>&nbsp;<span class="ident" id="6912919">err</span>&nbsp;<span class="op" id="6912923">!=</span>&nbsp;<span class="ident" id="6912926">nil</span>&nbsp;<span class="op" id="6912930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6912934">t</span><span class="op" id="6912935">.</span><span class="ident" id="6912936">Fatal</span><span class="op" id="6912941">(</span><span class="ident" id="6912942">err</span><span class="op" id="6912945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6912948">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1030</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6912952">if</span>&nbsp;<span class="ident" id="6912955">g</span><span class="op" id="6912956">,</span>&nbsp;<span class="ident" id="6912958">w</span>&nbsp;<span class="op" id="6912960">:=</span>&nbsp;<span class="ident" id="6912963">db</span><span class="op" id="6912965">.</span><span class="ident" id="6912966">numFreeConns</span><span class="op" id="6912978">(</span><span class="op" id="6912979">)</span><span class="op" id="6912980">,</span>&nbsp;<span class="num" id="6912982">10</span><span class="op" id="6912984">;</span>&nbsp;<span class="ident" id="6912986">g</span>&nbsp;<span class="op" id="6912988">!=</span>&nbsp;<span class="ident" id="6912991">w</span>&nbsp;<span class="op" id="6912993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6912997">t</span><span class="op" id="6912998">.</span><span class="ident" id="6912999">Errorf</span><span class="op" id="6913005">(</span><span class="string" id="6913006">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6913032">,</span>&nbsp;<span class="ident" id="6913034">g</span><span class="op" id="6913035">,</span>&nbsp;<span class="ident" id="6913037">w</span><span class="op" id="6913038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6913041">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6913045">if</span>&nbsp;<span class="ident" id="6913048">n</span>&nbsp;<span class="op" id="6913050">:=</span>&nbsp;<span class="ident" id="6913053">db</span><span class="op" id="6913055">.</span><span class="ident" id="6913056">numDepsPollUntil</span><span class="op" id="6913072">(</span><span class="num" id="6913073">10</span><span class="op" id="6913075">,</span>&nbsp;<span class="ident" id="6913077">time</span><span class="op" id="6913081">.</span><span class="ident" id="6913082">Second</span><span class="op" id="6913088">)</span><span class="op" id="6913089">;</span>&nbsp;<span class="ident" id="6913091">n</span>&nbsp;<span class="op" id="6913093">&gt;</span>&nbsp;<span class="num" id="6913095">10</span>&nbsp;<span class="op" id="6913098">{</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6913102">t</span><span class="op" id="6913103">.</span><span class="ident" id="6913104">Errorf</span><span class="op" id="6913110">(</span><span class="string" id="6913111">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;10&#34;</span><span class="op" id="6913156">,</span>&nbsp;<span class="ident" id="6913158">n</span><span class="op" id="6913159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6913163">db</span><span class="op" id="6913165">.</span><span class="ident" id="6913166">dumpDeps</span><span class="op" id="6913174">(</span><span class="ident" id="6913175">t</span><span class="op" id="6913176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6913179">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6913183">db</span><span class="op" id="6913185">.</span><span class="ident" id="6913186">SetMaxOpenConns</span><span class="op" id="6913201">(</span><span class="num" id="6913202">5</span><span class="op" id="6913203">)</span><br>
<span class="lineno">1040</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6913207">if</span>&nbsp;<span class="ident" id="6913210">g</span><span class="op" id="6913211">,</span>&nbsp;<span class="ident" id="6913213">w</span>&nbsp;<span class="op" id="6913215">:=</span>&nbsp;<span class="ident" id="6913218">db</span><span class="op" id="6913220">.</span><span class="ident" id="6913221">numFreeConns</span><span class="op" id="6913233">(</span><span class="op" id="6913234">)</span><span class="op" id="6913235">,</span>&nbsp;<span class="num" id="6913237">5</span><span class="op" id="6913238">;</span>&nbsp;<span class="ident" id="6913240">g</span>&nbsp;<span class="op" id="6913242">!=</span>&nbsp;<span class="ident" id="6913245">w</span>&nbsp;<span class="op" id="6913247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6913251">t</span><span class="op" id="6913252">.</span><span class="ident" id="6913253">Errorf</span><span class="op" id="6913259">(</span><span class="string" id="6913260">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6913286">,</span>&nbsp;<span class="ident" id="6913288">g</span><span class="op" id="6913289">,</span>&nbsp;<span class="ident" id="6913291">w</span><span class="op" id="6913292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6913295">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6913299">if</span>&nbsp;<span class="ident" id="6913302">n</span>&nbsp;<span class="op" id="6913304">:=</span>&nbsp;<span class="ident" id="6913307">db</span><span class="op" id="6913309">.</span><span class="ident" id="6913310">numDepsPollUntil</span><span class="op" id="6913326">(</span><span class="num" id="6913327">5</span><span class="op" id="6913328">,</span>&nbsp;<span class="ident" id="6913330">time</span><span class="op" id="6913334">.</span><span class="ident" id="6913335">Second</span><span class="op" id="6913341">)</span><span class="op" id="6913342">;</span>&nbsp;<span class="ident" id="6913344">n</span>&nbsp;<span class="op" id="6913346">&gt;</span>&nbsp;<span class="num" id="6913348">5</span>&nbsp;<span class="op" id="6913350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6913354">t</span><span class="op" id="6913355">.</span><span class="ident" id="6913356">Errorf</span><span class="op" id="6913362">(</span><span class="string" id="6913363">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="6913404">,</span>&nbsp;<span class="ident" id="6913406">n</span><span class="op" id="6913407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6913411">db</span><span class="op" id="6913413">.</span><span class="ident" id="6913414">dumpDeps</span><span class="op" id="6913422">(</span><span class="ident" id="6913423">t</span><span class="op" id="6913424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6913427">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1050</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6913431">db</span><span class="op" id="6913433">.</span><span class="ident" id="6913434">SetMaxOpenConns</span><span class="op" id="6913449">(</span><span class="num" id="6913450">0</span><span class="op" id="6913451">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6913455">if</span>&nbsp;<span class="ident" id="6913458">g</span><span class="op" id="6913459">,</span>&nbsp;<span class="ident" id="6913461">w</span>&nbsp;<span class="op" id="6913463">:=</span>&nbsp;<span class="ident" id="6913466">db</span><span class="op" id="6913468">.</span><span class="ident" id="6913469">numFreeConns</span><span class="op" id="6913481">(</span><span class="op" id="6913482">)</span><span class="op" id="6913483">,</span>&nbsp;<span class="num" id="6913485">5</span><span class="op" id="6913486">;</span>&nbsp;<span class="ident" id="6913488">g</span>&nbsp;<span class="op" id="6913490">!=</span>&nbsp;<span class="ident" id="6913493">w</span>&nbsp;<span class="op" id="6913495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6913499">t</span><span class="op" id="6913500">.</span><span class="ident" id="6913501">Errorf</span><span class="op" id="6913507">(</span><span class="string" id="6913508">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6913534">,</span>&nbsp;<span class="ident" id="6913536">g</span><span class="op" id="6913537">,</span>&nbsp;<span class="ident" id="6913539">w</span><span class="op" id="6913540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6913543">}</span><br>
<span class="lineno">1055</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6913547">if</span>&nbsp;<span class="ident" id="6913550">n</span>&nbsp;<span class="op" id="6913552">:=</span>&nbsp;<span class="ident" id="6913555">db</span><span class="op" id="6913557">.</span><span class="ident" id="6913558">numDepsPollUntil</span><span class="op" id="6913574">(</span><span class="num" id="6913575">5</span><span class="op" id="6913576">,</span>&nbsp;<span class="ident" id="6913578">time</span><span class="op" id="6913582">.</span><span class="ident" id="6913583">Second</span><span class="op" id="6913589">)</span><span class="op" id="6913590">;</span>&nbsp;<span class="ident" id="6913592">n</span>&nbsp;<span class="op" id="6913594">&gt;</span>&nbsp;<span class="num" id="6913596">5</span>&nbsp;<span class="op" id="6913598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6913602">t</span><span class="op" id="6913603">.</span><span class="ident" id="6913604">Errorf</span><span class="op" id="6913610">(</span><span class="string" id="6913611">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="6913652">,</span>&nbsp;<span class="ident" id="6913654">n</span><span class="op" id="6913655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6913659">db</span><span class="op" id="6913661">.</span><span class="ident" id="6913662">dumpDeps</span><span class="op" id="6913670">(</span><span class="ident" id="6913671">t</span><span class="op" id="6913672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6913675">}</span><br>
<span class="lineno">1060</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6913679">db</span><span class="op" id="6913681">.</span><span class="ident" id="6913682">SetMaxIdleConns</span><span class="op" id="6913697">(</span><span class="num" id="6913698">0</span><span class="op" id="6913699">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6913703">if</span>&nbsp;<span class="ident" id="6913706">g</span><span class="op" id="6913707">,</span>&nbsp;<span class="ident" id="6913709">w</span>&nbsp;<span class="op" id="6913711">:=</span>&nbsp;<span class="ident" id="6913714">db</span><span class="op" id="6913716">.</span><span class="ident" id="6913717">numFreeConns</span><span class="op" id="6913729">(</span><span class="op" id="6913730">)</span><span class="op" id="6913731">,</span>&nbsp;<span class="num" id="6913733">0</span><span class="op" id="6913734">;</span>&nbsp;<span class="ident" id="6913736">g</span>&nbsp;<span class="op" id="6913738">!=</span>&nbsp;<span class="ident" id="6913741">w</span>&nbsp;<span class="op" id="6913743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6913747">t</span><span class="op" id="6913748">.</span><span class="ident" id="6913749">Errorf</span><span class="op" id="6913755">(</span><span class="string" id="6913756">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6913782">,</span>&nbsp;<span class="ident" id="6913784">g</span><span class="op" id="6913785">,</span>&nbsp;<span class="ident" id="6913787">w</span><span class="op" id="6913788">)</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6913791">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6913795">if</span>&nbsp;<span class="ident" id="6913798">n</span>&nbsp;<span class="op" id="6913800">:=</span>&nbsp;<span class="ident" id="6913803">db</span><span class="op" id="6913805">.</span><span class="ident" id="6913806">numDepsPollUntil</span><span class="op" id="6913822">(</span><span class="num" id="6913823">0</span><span class="op" id="6913824">,</span>&nbsp;<span class="ident" id="6913826">time</span><span class="op" id="6913830">.</span><span class="ident" id="6913831">Second</span><span class="op" id="6913837">)</span><span class="op" id="6913838">;</span>&nbsp;<span class="ident" id="6913840">n</span>&nbsp;<span class="op" id="6913842">&gt;</span>&nbsp;<span class="num" id="6913844">0</span>&nbsp;<span class="op" id="6913846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6913850">t</span><span class="op" id="6913851">.</span><span class="ident" id="6913852">Errorf</span><span class="op" id="6913858">(</span><span class="string" id="6913859">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="6913900">,</span>&nbsp;<span class="ident" id="6913902">n</span><span class="op" id="6913903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6913907">db</span><span class="op" id="6913909">.</span><span class="ident" id="6913910">dumpDeps</span><span class="op" id="6913918">(</span><span class="ident" id="6913919">t</span><span class="op" id="6913920">)</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6913923">}</span><br>
<span class="lineno"></span><span class="op" id="6913925">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6913928">func</span>&nbsp;<span class="ident" id="6913933">TestSingleOpenConn</span><span class="op" id="6913951">(</span><span class="ident" id="6913952">t</span>&nbsp;<span class="op" id="6913954">*</span><span class="ident" id="6913955">testing</span><span class="op" id="6913962">.</span><span class="ident" id="6913963">T</span><span class="op" id="6913964">)</span>&nbsp;<span class="op" id="6913966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6913969">db</span>&nbsp;<span class="op" id="6913972">:=</span>&nbsp;<span class="ident" id="6913975">newTestDB</span><span class="op" id="6913984">(</span><span class="ident" id="6913985">t</span><span class="op" id="6913986">,</span>&nbsp;<span class="string" id="6913988">&#34;people&#34;</span><span class="op" id="6913996">)</span><br>
<span class="lineno">1075</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6913999">defer</span>&nbsp;<span class="ident" id="6914005">closeDB</span><span class="op" id="6914012">(</span><span class="ident" id="6914013">t</span><span class="op" id="6914014">,</span>&nbsp;<span class="ident" id="6914016">db</span><span class="op" id="6914018">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6914022">db</span><span class="op" id="6914024">.</span><span class="ident" id="6914025">SetMaxOpenConns</span><span class="op" id="6914040">(</span><span class="num" id="6914041">1</span><span class="op" id="6914042">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6914046">rows</span><span class="op" id="6914050">,</span>&nbsp;<span class="ident" id="6914052">err</span>&nbsp;<span class="op" id="6914056">:=</span>&nbsp;<span class="ident" id="6914059">db</span><span class="op" id="6914061">.</span><span class="ident" id="6914062">Query</span><span class="op" id="6914067">(</span><span class="string" id="6914068">&#34;SELECT|people|name|&#34;</span><span class="op" id="6914089">)</span><br>
<span class="lineno">1080</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6914092">if</span>&nbsp;<span class="ident" id="6914095">err</span>&nbsp;<span class="op" id="6914099">!=</span>&nbsp;<span class="ident" id="6914102">nil</span>&nbsp;<span class="op" id="6914106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6914110">t</span><span class="op" id="6914111">.</span><span class="ident" id="6914112">Fatal</span><span class="op" id="6914117">(</span><span class="ident" id="6914118">err</span><span class="op" id="6914121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6914124">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6914127">if</span>&nbsp;<span class="ident" id="6914130">err</span>&nbsp;<span class="op" id="6914134">=</span>&nbsp;<span class="ident" id="6914136">rows</span><span class="op" id="6914140">.</span><span class="ident" id="6914141">Close</span><span class="op" id="6914146">(</span><span class="op" id="6914147">)</span><span class="op" id="6914148">;</span>&nbsp;<span class="ident" id="6914150">err</span>&nbsp;<span class="op" id="6914154">!=</span>&nbsp;<span class="ident" id="6914157">nil</span>&nbsp;<span class="op" id="6914161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6914165">t</span><span class="op" id="6914166">.</span><span class="ident" id="6914167">Fatal</span><span class="op" id="6914172">(</span><span class="ident" id="6914173">err</span><span class="op" id="6914176">)</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6914179">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6914182">//&nbsp;shouldn&#39;t&nbsp;deadlock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6914205">rows</span><span class="op" id="6914209">,</span>&nbsp;<span class="ident" id="6914211">err</span>&nbsp;<span class="op" id="6914215">=</span>&nbsp;<span class="ident" id="6914217">db</span><span class="op" id="6914219">.</span><span class="ident" id="6914220">Query</span><span class="op" id="6914225">(</span><span class="string" id="6914226">&#34;SELECT|people|name|&#34;</span><span class="op" id="6914247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6914250">if</span>&nbsp;<span class="ident" id="6914253">err</span>&nbsp;<span class="op" id="6914257">!=</span>&nbsp;<span class="ident" id="6914260">nil</span>&nbsp;<span class="op" id="6914264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6914268">t</span><span class="op" id="6914269">.</span><span class="ident" id="6914270">Fatal</span><span class="op" id="6914275">(</span><span class="ident" id="6914276">err</span><span class="op" id="6914279">)</span><br>
<span class="lineno">1090</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6914282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6914285">if</span>&nbsp;<span class="ident" id="6914288">err</span>&nbsp;<span class="op" id="6914292">=</span>&nbsp;<span class="ident" id="6914294">rows</span><span class="op" id="6914298">.</span><span class="ident" id="6914299">Close</span><span class="op" id="6914304">(</span><span class="op" id="6914305">)</span><span class="op" id="6914306">;</span>&nbsp;<span class="ident" id="6914308">err</span>&nbsp;<span class="op" id="6914312">!=</span>&nbsp;<span class="ident" id="6914315">nil</span>&nbsp;<span class="op" id="6914319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6914323">t</span><span class="op" id="6914324">.</span><span class="ident" id="6914325">Fatal</span><span class="op" id="6914330">(</span><span class="ident" id="6914331">err</span><span class="op" id="6914334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6914337">}</span><br>
<span class="lineno"></span><span class="op" id="6914339">}</span><br>
<span class="lineno">1095</span><br>
<span class="lineno"></span><span class="comment" id="6914342">//&nbsp;golang.org/issue/5323</span><br>
<span class="lineno"></span><span class="keyword" id="6914367">func</span>&nbsp;<span class="ident" id="6914372">TestStmtCloseDeps</span><span class="op" id="6914389">(</span><span class="ident" id="6914390">t</span>&nbsp;<span class="op" id="6914392">*</span><span class="ident" id="6914393">testing</span><span class="op" id="6914400">.</span><span class="ident" id="6914401">T</span><span class="op" id="6914402">)</span>&nbsp;<span class="op" id="6914404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6914407">if</span>&nbsp;<span class="ident" id="6914410">testing</span><span class="op" id="6914417">.</span><span class="ident" id="6914418">Short</span><span class="op" id="6914423">(</span><span class="op" id="6914424">)</span>&nbsp;<span class="op" id="6914426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6914430">t</span><span class="op" id="6914431">.</span><span class="ident" id="6914432">Skip</span><span class="op" id="6914436">(</span><span class="string" id="6914437">&#34;skipping&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="6914461">)</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6914464">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6914467">defer</span>&nbsp;<span class="ident" id="6914473">setHookpostCloseConn</span><span class="op" id="6914493">(</span><span class="ident" id="6914494">nil</span><span class="op" id="6914497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6914500">setHookpostCloseConn</span><span class="op" id="6914520">(</span><span class="keyword" id="6914521">func</span><span class="op" id="6914525">(</span><span class="ident" id="6914526">_</span>&nbsp;<span class="op" id="6914528">*</span><span class="ident" id="6914529">fakeConn</span><span class="op" id="6914537">,</span>&nbsp;<span class="ident" id="6914539">err</span>&nbsp;<span class="builtintype" id="6914543">error</span><span class="op" id="6914548">)</span>&nbsp;<span class="op" id="6914550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6914554">if</span>&nbsp;<span class="ident" id="6914557">err</span>&nbsp;<span class="op" id="6914561">!=</span>&nbsp;<span class="ident" id="6914564">nil</span>&nbsp;<span class="op" id="6914568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6914573">t</span><span class="op" id="6914574">.</span><span class="ident" id="6914575">Errorf</span><span class="op" id="6914581">(</span><span class="string" id="6914582">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="6914610">,</span>&nbsp;<span class="ident" id="6914612">err</span><span class="op" id="6914615">)</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6914619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6914622">}</span><span class="op" id="6914623">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6914627">db</span>&nbsp;<span class="op" id="6914630">:=</span>&nbsp;<span class="ident" id="6914633">newTestDB</span><span class="op" id="6914642">(</span><span class="ident" id="6914643">t</span><span class="op" id="6914644">,</span>&nbsp;<span class="string" id="6914646">&#34;magicquery&#34;</span><span class="op" id="6914658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6914661">defer</span>&nbsp;<span class="ident" id="6914667">closeDB</span><span class="op" id="6914674">(</span><span class="ident" id="6914675">t</span><span class="op" id="6914676">,</span>&nbsp;<span class="ident" id="6914678">db</span><span class="op" id="6914680">)</span><br>
<span class="lineno">1110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6914684">driver</span>&nbsp;<span class="op" id="6914691">:=</span>&nbsp;<span class="ident" id="6914694">db</span><span class="op" id="6914696">.</span><span class="ident" id="6914697">driver</span><span class="op" id="6914703">.</span><span class="op" id="6914704">(</span><span class="op" id="6914705">*</span><span class="ident" id="6914706">fakeDriver</span><span class="op" id="6914716">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6914720">driver</span><span class="op" id="6914726">.</span><span class="ident" id="6914727">mu</span><span class="op" id="6914729">.</span><span class="ident" id="6914730">Lock</span><span class="op" id="6914734">(</span><span class="op" id="6914735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6914738">opens0</span>&nbsp;<span class="op" id="6914745">:=</span>&nbsp;<span class="ident" id="6914748">driver</span><span class="op" id="6914754">.</span><span class="ident" id="6914755">openCount</span><br>
<span class="lineno">1115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6914766">closes0</span>&nbsp;<span class="op" id="6914774">:=</span>&nbsp;<span class="ident" id="6914777">driver</span><span class="op" id="6914783">.</span><span class="ident" id="6914784">closeCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6914796">driver</span><span class="op" id="6914802">.</span><span class="ident" id="6914803">mu</span><span class="op" id="6914805">.</span><span class="ident" id="6914806">Unlock</span><span class="op" id="6914812">(</span><span class="op" id="6914813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6914816">openDelta0</span>&nbsp;<span class="op" id="6914827">:=</span>&nbsp;<span class="ident" id="6914830">opens0</span>&nbsp;<span class="op" id="6914837">-</span>&nbsp;<span class="ident" id="6914839">closes0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6914849">stmt</span><span class="op" id="6914853">,</span>&nbsp;<span class="ident" id="6914855">err</span>&nbsp;<span class="op" id="6914859">:=</span>&nbsp;<span class="ident" id="6914862">db</span><span class="op" id="6914864">.</span><span class="ident" id="6914865">Prepare</span><span class="op" id="6914872">(</span><span class="string" id="6914873">&#34;SELECT|magicquery|op|op=?,millis=?&#34;</span><span class="op" id="6914909">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6914912">if</span>&nbsp;<span class="ident" id="6914915">err</span>&nbsp;<span class="op" id="6914919">!=</span>&nbsp;<span class="ident" id="6914922">nil</span>&nbsp;<span class="op" id="6914926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6914930">t</span><span class="op" id="6914931">.</span><span class="ident" id="6914932">Fatal</span><span class="op" id="6914937">(</span><span class="ident" id="6914938">err</span><span class="op" id="6914941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6914944">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6914948">//&nbsp;Start&nbsp;50&nbsp;parallel&nbsp;slow&nbsp;queries.</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6914984">const</span>&nbsp;<span class="op" id="6914990">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6914994">nquery</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6915006">=</span>&nbsp;<span class="num" id="6915008">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6915013">sleepMillis</span>&nbsp;<span class="op" id="6915025">=</span>&nbsp;<span class="num" id="6915027">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6915032">nbatch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6915044">=</span>&nbsp;<span class="num" id="6915046">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6915049">)</span><br>
<span class="lineno">1130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6915052">var</span>&nbsp;<span class="ident" id="6915056">wg</span>&nbsp;<span class="ident" id="6915059">sync</span><span class="op" id="6915063">.</span><span class="ident" id="6915064">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6915075">for</span>&nbsp;<span class="ident" id="6915079">batch</span>&nbsp;<span class="op" id="6915085">:=</span>&nbsp;<span class="num" id="6915088">0</span><span class="op" id="6915089">;</span>&nbsp;<span class="ident" id="6915091">batch</span>&nbsp;<span class="op" id="6915097">&lt;</span>&nbsp;<span class="ident" id="6915099">nbatch</span><span class="op" id="6915105">;</span>&nbsp;<span class="ident" id="6915107">batch</span><span class="op" id="6915112">++</span>&nbsp;<span class="op" id="6915115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6915119">for</span>&nbsp;<span class="ident" id="6915123">i</span>&nbsp;<span class="op" id="6915125">:=</span>&nbsp;<span class="num" id="6915128">0</span><span class="op" id="6915129">;</span>&nbsp;<span class="ident" id="6915131">i</span>&nbsp;<span class="op" id="6915133">&lt;</span>&nbsp;<span class="ident" id="6915135">nquery</span><span class="op" id="6915141">;</span>&nbsp;<span class="ident" id="6915143">i</span><span class="op" id="6915144">++</span>&nbsp;<span class="op" id="6915147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6915152">wg</span><span class="op" id="6915154">.</span><span class="ident" id="6915155">Add</span><span class="op" id="6915158">(</span><span class="num" id="6915159">1</span><span class="op" id="6915160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6915165">go</span>&nbsp;<span class="keyword" id="6915168">func</span><span class="op" id="6915172">(</span><span class="op" id="6915173">)</span>&nbsp;<span class="op" id="6915175">{</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6915181">defer</span>&nbsp;<span class="ident" id="6915187">wg</span><span class="op" id="6915189">.</span><span class="ident" id="6915190">Done</span><span class="op" id="6915194">(</span><span class="op" id="6915195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6915201">var</span>&nbsp;<span class="ident" id="6915205">op</span>&nbsp;<span class="builtintype" id="6915208">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6915219">if</span>&nbsp;<span class="ident" id="6915222">err</span>&nbsp;<span class="op" id="6915226">:=</span>&nbsp;<span class="ident" id="6915229">stmt</span><span class="op" id="6915233">.</span><span class="ident" id="6915234">QueryRow</span><span class="op" id="6915242">(</span><span class="string" id="6915243">&#34;sleep&#34;</span><span class="op" id="6915250">,</span>&nbsp;<span class="ident" id="6915252">sleepMillis</span><span class="op" id="6915263">)</span><span class="op" id="6915264">.</span><span class="ident" id="6915265">Scan</span><span class="op" id="6915269">(</span><span class="op" id="6915270">&amp;</span><span class="ident" id="6915271">op</span><span class="op" id="6915273">)</span><span class="op" id="6915274">;</span>&nbsp;<span class="ident" id="6915276">err</span>&nbsp;<span class="op" id="6915280">!=</span>&nbsp;<span class="ident" id="6915283">nil</span>&nbsp;<span class="op" id="6915287">&amp;&amp;</span>&nbsp;<span class="ident" id="6915290">err</span>&nbsp;<span class="op" id="6915294">!=</span>&nbsp;<span class="ident" id="6915297">ErrNoRows</span>&nbsp;<span class="op" id="6915307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6915314">t</span><span class="op" id="6915315">.</span><span class="ident" id="6915316">Error</span><span class="op" id="6915321">(</span><span class="ident" id="6915322">err</span><span class="op" id="6915325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6915331">}</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6915336">}</span><span class="op" id="6915337">(</span><span class="op" id="6915338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6915342">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6915346">//&nbsp;Sleep&nbsp;for&nbsp;twice&nbsp;the&nbsp;expected&nbsp;length&nbsp;of&nbsp;time&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6915403">//&nbsp;batch&nbsp;of&nbsp;50&nbsp;queries&nbsp;above&nbsp;to&nbsp;finish&nbsp;before&nbsp;starting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6915460">//&nbsp;the&nbsp;next&nbsp;round.</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6915481">time</span><span class="op" id="6915485">.</span><span class="ident" id="6915486">Sleep</span><span class="op" id="6915491">(</span><span class="num" id="6915492">2</span>&nbsp;<span class="op" id="6915494">*</span>&nbsp;<span class="ident" id="6915496">sleepMillis</span>&nbsp;<span class="op" id="6915508">*</span>&nbsp;<span class="ident" id="6915510">time</span><span class="op" id="6915514">.</span><span class="ident" id="6915515">Millisecond</span><span class="op" id="6915526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6915529">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6915532">wg</span><span class="op" id="6915534">.</span><span class="ident" id="6915535">Wait</span><span class="op" id="6915539">(</span><span class="op" id="6915540">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6915544">if</span>&nbsp;<span class="ident" id="6915547">g</span><span class="op" id="6915548">,</span>&nbsp;<span class="ident" id="6915550">w</span>&nbsp;<span class="op" id="6915552">:=</span>&nbsp;<span class="ident" id="6915555">db</span><span class="op" id="6915557">.</span><span class="ident" id="6915558">numFreeConns</span><span class="op" id="6915570">(</span><span class="op" id="6915571">)</span><span class="op" id="6915572">,</span>&nbsp;<span class="num" id="6915574">2</span><span class="op" id="6915575">;</span>&nbsp;<span class="ident" id="6915577">g</span>&nbsp;<span class="op" id="6915579">!=</span>&nbsp;<span class="ident" id="6915582">w</span>&nbsp;<span class="op" id="6915584">{</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6915588">t</span><span class="op" id="6915589">.</span><span class="ident" id="6915590">Errorf</span><span class="op" id="6915596">(</span><span class="string" id="6915597">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6915623">,</span>&nbsp;<span class="ident" id="6915625">g</span><span class="op" id="6915626">,</span>&nbsp;<span class="ident" id="6915628">w</span><span class="op" id="6915629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6915632">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6915636">if</span>&nbsp;<span class="ident" id="6915639">n</span>&nbsp;<span class="op" id="6915641">:=</span>&nbsp;<span class="ident" id="6915644">db</span><span class="op" id="6915646">.</span><span class="ident" id="6915647">numDepsPollUntil</span><span class="op" id="6915663">(</span><span class="num" id="6915664">4</span><span class="op" id="6915665">,</span>&nbsp;<span class="ident" id="6915667">time</span><span class="op" id="6915671">.</span><span class="ident" id="6915672">Second</span><span class="op" id="6915678">)</span><span class="op" id="6915679">;</span>&nbsp;<span class="ident" id="6915681">n</span>&nbsp;<span class="op" id="6915683">&gt;</span>&nbsp;<span class="num" id="6915685">4</span>&nbsp;<span class="op" id="6915687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6915691">t</span><span class="op" id="6915692">.</span><span class="ident" id="6915693">Errorf</span><span class="op" id="6915699">(</span><span class="string" id="6915700">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;4&#34;</span><span class="op" id="6915744">,</span>&nbsp;<span class="ident" id="6915746">n</span><span class="op" id="6915747">)</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6915751">db</span><span class="op" id="6915753">.</span><span class="ident" id="6915754">dumpDeps</span><span class="op" id="6915762">(</span><span class="ident" id="6915763">t</span><span class="op" id="6915764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6915767">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6915771">driver</span><span class="op" id="6915777">.</span><span class="ident" id="6915778">mu</span><span class="op" id="6915780">.</span><span class="ident" id="6915781">Lock</span><span class="op" id="6915785">(</span><span class="op" id="6915786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6915789">opens</span>&nbsp;<span class="op" id="6915795">:=</span>&nbsp;<span class="ident" id="6915798">driver</span><span class="op" id="6915804">.</span><span class="ident" id="6915805">openCount</span>&nbsp;<span class="op" id="6915815">-</span>&nbsp;<span class="ident" id="6915817">opens0</span><br>
<span class="lineno">1160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6915825">closes</span>&nbsp;<span class="op" id="6915832">:=</span>&nbsp;<span class="ident" id="6915835">driver</span><span class="op" id="6915841">.</span><span class="ident" id="6915842">closeCount</span>&nbsp;<span class="op" id="6915853">-</span>&nbsp;<span class="ident" id="6915855">closes0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6915864">openDelta</span>&nbsp;<span class="op" id="6915874">:=</span>&nbsp;<span class="op" id="6915877">(</span><span class="ident" id="6915878">driver</span><span class="op" id="6915884">.</span><span class="ident" id="6915885">openCount</span>&nbsp;<span class="op" id="6915895">-</span>&nbsp;<span class="ident" id="6915897">driver</span><span class="op" id="6915903">.</span><span class="ident" id="6915904">closeCount</span><span class="op" id="6915914">)</span>&nbsp;<span class="op" id="6915916">-</span>&nbsp;<span class="ident" id="6915918">openDelta0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6915930">driver</span><span class="op" id="6915936">.</span><span class="ident" id="6915937">mu</span><span class="op" id="6915939">.</span><span class="ident" id="6915940">Unlock</span><span class="op" id="6915946">(</span><span class="op" id="6915947">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6915951">if</span>&nbsp;<span class="ident" id="6915954">openDelta</span>&nbsp;<span class="op" id="6915964">&gt;</span>&nbsp;<span class="num" id="6915966">2</span>&nbsp;<span class="op" id="6915968">{</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6915972">t</span><span class="op" id="6915973">.</span><span class="ident" id="6915974">Logf</span><span class="op" id="6915978">(</span><span class="string" id="6915979">&#34;open&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="6915996">,</span>&nbsp;<span class="ident" id="6915998">opens</span><span class="op" id="6916003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6916007">t</span><span class="op" id="6916008">.</span><span class="ident" id="6916009">Logf</span><span class="op" id="6916013">(</span><span class="string" id="6916014">&#34;close&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="6916032">,</span>&nbsp;<span class="ident" id="6916034">closes</span><span class="op" id="6916040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6916044">t</span><span class="op" id="6916045">.</span><span class="ident" id="6916046">Logf</span><span class="op" id="6916050">(</span><span class="string" id="6916051">&#34;open&nbsp;delta&nbsp;=&nbsp;%d&#34;</span><span class="op" id="6916068">,</span>&nbsp;<span class="ident" id="6916070">openDelta</span><span class="op" id="6916079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6916083">t</span><span class="op" id="6916084">.</span><span class="ident" id="6916085">Errorf</span><span class="op" id="6916091">(</span><span class="string" id="6916092">&#34;db&nbsp;connections&nbsp;opened&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;2&#34;</span><span class="op" id="6916131">,</span>&nbsp;<span class="ident" id="6916133">openDelta</span><span class="op" id="6916142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6916146">db</span><span class="op" id="6916148">.</span><span class="ident" id="6916149">dumpDeps</span><span class="op" id="6916157">(</span><span class="ident" id="6916158">t</span><span class="op" id="6916159">)</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6916162">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6916166">if</span>&nbsp;<span class="builtinfunc" id="6916169">len</span><span class="op" id="6916172">(</span><span class="ident" id="6916173">stmt</span><span class="op" id="6916177">.</span><span class="ident" id="6916178">css</span><span class="op" id="6916181">)</span>&nbsp;<span class="op" id="6916183">&gt;</span>&nbsp;<span class="ident" id="6916185">nquery</span>&nbsp;<span class="op" id="6916192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6916196">t</span><span class="op" id="6916197">.</span><span class="ident" id="6916198">Errorf</span><span class="op" id="6916204">(</span><span class="string" id="6916205">&#34;len(stmt.css)&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;%d&#34;</span><span class="op" id="6916237">,</span>&nbsp;<span class="builtinfunc" id="6916239">len</span><span class="op" id="6916242">(</span><span class="ident" id="6916243">stmt</span><span class="op" id="6916247">.</span><span class="ident" id="6916248">css</span><span class="op" id="6916251">)</span><span class="op" id="6916252">,</span>&nbsp;<span class="ident" id="6916254">nquery</span><span class="op" id="6916260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6916263">}</span><br>
<span class="lineno">1175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6916267">if</span>&nbsp;<span class="ident" id="6916270">err</span>&nbsp;<span class="op" id="6916274">:=</span>&nbsp;<span class="ident" id="6916277">stmt</span><span class="op" id="6916281">.</span><span class="ident" id="6916282">Close</span><span class="op" id="6916287">(</span><span class="op" id="6916288">)</span><span class="op" id="6916289">;</span>&nbsp;<span class="ident" id="6916291">err</span>&nbsp;<span class="op" id="6916295">!=</span>&nbsp;<span class="ident" id="6916298">nil</span>&nbsp;<span class="op" id="6916302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6916306">t</span><span class="op" id="6916307">.</span><span class="ident" id="6916308">Fatal</span><span class="op" id="6916313">(</span><span class="ident" id="6916314">err</span><span class="op" id="6916317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6916320">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6916324">if</span>&nbsp;<span class="ident" id="6916327">g</span><span class="op" id="6916328">,</span>&nbsp;<span class="ident" id="6916330">w</span>&nbsp;<span class="op" id="6916332">:=</span>&nbsp;<span class="ident" id="6916335">db</span><span class="op" id="6916337">.</span><span class="ident" id="6916338">numFreeConns</span><span class="op" id="6916350">(</span><span class="op" id="6916351">)</span><span class="op" id="6916352">,</span>&nbsp;<span class="num" id="6916354">2</span><span class="op" id="6916355">;</span>&nbsp;<span class="ident" id="6916357">g</span>&nbsp;<span class="op" id="6916359">!=</span>&nbsp;<span class="ident" id="6916362">w</span>&nbsp;<span class="op" id="6916364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6916368">t</span><span class="op" id="6916369">.</span><span class="ident" id="6916370">Errorf</span><span class="op" id="6916376">(</span><span class="string" id="6916377">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6916403">,</span>&nbsp;<span class="ident" id="6916405">g</span><span class="op" id="6916406">,</span>&nbsp;<span class="ident" id="6916408">w</span><span class="op" id="6916409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6916412">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6916416">if</span>&nbsp;<span class="ident" id="6916419">n</span>&nbsp;<span class="op" id="6916421">:=</span>&nbsp;<span class="ident" id="6916424">db</span><span class="op" id="6916426">.</span><span class="ident" id="6916427">numDepsPollUntil</span><span class="op" id="6916443">(</span><span class="num" id="6916444">2</span><span class="op" id="6916445">,</span>&nbsp;<span class="ident" id="6916447">time</span><span class="op" id="6916451">.</span><span class="ident" id="6916452">Second</span><span class="op" id="6916458">)</span><span class="op" id="6916459">;</span>&nbsp;<span class="ident" id="6916461">n</span>&nbsp;<span class="op" id="6916463">&gt;</span>&nbsp;<span class="num" id="6916465">2</span>&nbsp;<span class="op" id="6916467">{</span><br>
<span class="lineno">1185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6916471">t</span><span class="op" id="6916472">.</span><span class="ident" id="6916473">Errorf</span><span class="op" id="6916479">(</span><span class="string" id="6916480">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;2&#34;</span><span class="op" id="6916524">,</span>&nbsp;<span class="ident" id="6916526">n</span><span class="op" id="6916527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6916531">db</span><span class="op" id="6916533">.</span><span class="ident" id="6916534">dumpDeps</span><span class="op" id="6916542">(</span><span class="ident" id="6916543">t</span><span class="op" id="6916544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6916547">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6916551">db</span><span class="op" id="6916553">.</span><span class="ident" id="6916554">SetMaxIdleConns</span><span class="op" id="6916569">(</span><span class="num" id="6916570">0</span><span class="op" id="6916571">)</span><br>
<span class="lineno">1190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6916575">if</span>&nbsp;<span class="ident" id="6916578">g</span><span class="op" id="6916579">,</span>&nbsp;<span class="ident" id="6916581">w</span>&nbsp;<span class="op" id="6916583">:=</span>&nbsp;<span class="ident" id="6916586">db</span><span class="op" id="6916588">.</span><span class="ident" id="6916589">numFreeConns</span><span class="op" id="6916601">(</span><span class="op" id="6916602">)</span><span class="op" id="6916603">,</span>&nbsp;<span class="num" id="6916605">0</span><span class="op" id="6916606">;</span>&nbsp;<span class="ident" id="6916608">g</span>&nbsp;<span class="op" id="6916610">!=</span>&nbsp;<span class="ident" id="6916613">w</span>&nbsp;<span class="op" id="6916615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6916619">t</span><span class="op" id="6916620">.</span><span class="ident" id="6916621">Errorf</span><span class="op" id="6916627">(</span><span class="string" id="6916628">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6916654">,</span>&nbsp;<span class="ident" id="6916656">g</span><span class="op" id="6916657">,</span>&nbsp;<span class="ident" id="6916659">w</span><span class="op" id="6916660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6916663">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6916667">if</span>&nbsp;<span class="ident" id="6916670">n</span>&nbsp;<span class="op" id="6916672">:=</span>&nbsp;<span class="ident" id="6916675">db</span><span class="op" id="6916677">.</span><span class="ident" id="6916678">numDepsPollUntil</span><span class="op" id="6916694">(</span><span class="num" id="6916695">0</span><span class="op" id="6916696">,</span>&nbsp;<span class="ident" id="6916698">time</span><span class="op" id="6916702">.</span><span class="ident" id="6916703">Second</span><span class="op" id="6916709">)</span><span class="op" id="6916710">;</span>&nbsp;<span class="ident" id="6916712">n</span>&nbsp;<span class="op" id="6916714">&gt;</span>&nbsp;<span class="num" id="6916716">0</span>&nbsp;<span class="op" id="6916718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6916722">t</span><span class="op" id="6916723">.</span><span class="ident" id="6916724">Errorf</span><span class="op" id="6916730">(</span><span class="string" id="6916731">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="6916772">,</span>&nbsp;<span class="ident" id="6916774">n</span><span class="op" id="6916775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6916779">db</span><span class="op" id="6916781">.</span><span class="ident" id="6916782">dumpDeps</span><span class="op" id="6916790">(</span><span class="ident" id="6916791">t</span><span class="op" id="6916792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6916795">}</span><br>
<span class="lineno"></span><span class="op" id="6916797">}</span><br>
<span class="lineno">1200</span><br>
<span class="lineno"></span><span class="comment" id="6916800">//&nbsp;golang.org/issue/5046</span><br>
<span class="lineno"></span><span class="keyword" id="6916825">func</span>&nbsp;<span class="ident" id="6916830">TestCloseConnBeforeStmts</span><span class="op" id="6916854">(</span><span class="ident" id="6916855">t</span>&nbsp;<span class="op" id="6916857">*</span><span class="ident" id="6916858">testing</span><span class="op" id="6916865">.</span><span class="ident" id="6916866">T</span><span class="op" id="6916867">)</span>&nbsp;<span class="op" id="6916869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6916872">db</span>&nbsp;<span class="op" id="6916875">:=</span>&nbsp;<span class="ident" id="6916878">newTestDB</span><span class="op" id="6916887">(</span><span class="ident" id="6916888">t</span><span class="op" id="6916889">,</span>&nbsp;<span class="string" id="6916891">&#34;people&#34;</span><span class="op" id="6916899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6916902">defer</span>&nbsp;<span class="ident" id="6916908">closeDB</span><span class="op" id="6916915">(</span><span class="ident" id="6916916">t</span><span class="op" id="6916917">,</span>&nbsp;<span class="ident" id="6916919">db</span><span class="op" id="6916921">)</span><br>
<span class="lineno">1205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6916925">defer</span>&nbsp;<span class="ident" id="6916931">setHookpostCloseConn</span><span class="op" id="6916951">(</span><span class="ident" id="6916952">nil</span><span class="op" id="6916955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6916958">setHookpostCloseConn</span><span class="op" id="6916978">(</span><span class="keyword" id="6916979">func</span><span class="op" id="6916983">(</span><span class="ident" id="6916984">_</span>&nbsp;<span class="op" id="6916986">*</span><span class="ident" id="6916987">fakeConn</span><span class="op" id="6916995">,</span>&nbsp;<span class="ident" id="6916997">err</span>&nbsp;<span class="builtintype" id="6917001">error</span><span class="op" id="6917006">)</span>&nbsp;<span class="op" id="6917008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6917012">if</span>&nbsp;<span class="ident" id="6917015">err</span>&nbsp;<span class="op" id="6917019">!=</span>&nbsp;<span class="ident" id="6917022">nil</span>&nbsp;<span class="op" id="6917026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6917031">t</span><span class="op" id="6917032">.</span><span class="ident" id="6917033">Errorf</span><span class="op" id="6917039">(</span><span class="string" id="6917040">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v;&nbsp;from&nbsp;%s&#34;</span><span class="op" id="6917077">,</span>&nbsp;<span class="ident" id="6917079">err</span><span class="op" id="6917082">,</span>&nbsp;<span class="ident" id="6917084">stack</span><span class="op" id="6917089">(</span><span class="op" id="6917090">)</span><span class="op" id="6917091">)</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6917096">db</span><span class="op" id="6917098">.</span><span class="ident" id="6917099">dumpDeps</span><span class="op" id="6917107">(</span><span class="ident" id="6917108">t</span><span class="op" id="6917109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6917114">t</span><span class="op" id="6917115">.</span><span class="ident" id="6917116">Errorf</span><span class="op" id="6917122">(</span><span class="string" id="6917123">&#34;DB&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="6917133">,</span>&nbsp;<span class="ident" id="6917135">db</span><span class="op" id="6917137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6917141">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6917144">}</span><span class="op" id="6917145">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6917149">stmt</span><span class="op" id="6917153">,</span>&nbsp;<span class="ident" id="6917155">err</span>&nbsp;<span class="op" id="6917159">:=</span>&nbsp;<span class="ident" id="6917162">db</span><span class="op" id="6917164">.</span><span class="ident" id="6917165">Prepare</span><span class="op" id="6917172">(</span><span class="string" id="6917173">&#34;SELECT|people|name|&#34;</span><span class="op" id="6917194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6917197">if</span>&nbsp;<span class="ident" id="6917200">err</span>&nbsp;<span class="op" id="6917204">!=</span>&nbsp;<span class="ident" id="6917207">nil</span>&nbsp;<span class="op" id="6917211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6917215">t</span><span class="op" id="6917216">.</span><span class="ident" id="6917217">Fatal</span><span class="op" id="6917222">(</span><span class="ident" id="6917223">err</span><span class="op" id="6917226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6917229">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6917233">if</span>&nbsp;<span class="builtinfunc" id="6917236">len</span><span class="op" id="6917239">(</span><span class="ident" id="6917240">db</span><span class="op" id="6917242">.</span><span class="ident" id="6917243">freeConn</span><span class="op" id="6917251">)</span>&nbsp;<span class="op" id="6917253">!=</span>&nbsp;<span class="num" id="6917256">1</span>&nbsp;<span class="op" id="6917258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6917262">t</span><span class="op" id="6917263">.</span><span class="ident" id="6917264">Fatalf</span><span class="op" id="6917270">(</span><span class="string" id="6917271">&#34;expected&nbsp;1&nbsp;freeConn;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="6917300">,</span>&nbsp;<span class="builtinfunc" id="6917302">len</span><span class="op" id="6917305">(</span><span class="ident" id="6917306">db</span><span class="op" id="6917308">.</span><span class="ident" id="6917309">freeConn</span><span class="op" id="6917317">)</span><span class="op" id="6917318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6917321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6917324">dc</span>&nbsp;<span class="op" id="6917327">:=</span>&nbsp;<span class="ident" id="6917330">db</span><span class="op" id="6917332">.</span><span class="ident" id="6917333">freeConn</span><span class="op" id="6917341">[</span><span class="num" id="6917342">0</span><span class="op" id="6917343">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6917346">if</span>&nbsp;<span class="ident" id="6917349">dc</span><span class="op" id="6917351">.</span><span class="ident" id="6917352">closed</span>&nbsp;<span class="op" id="6917359">{</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6917363">t</span><span class="op" id="6917364">.</span><span class="ident" id="6917365">Errorf</span><span class="op" id="6917371">(</span><span class="string" id="6917372">&#34;conn&nbsp;shouldn&#39;t&nbsp;be&nbsp;closed&#34;</span><span class="op" id="6917398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6917401">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6917405">if</span>&nbsp;<span class="ident" id="6917408">n</span>&nbsp;<span class="op" id="6917410">:=</span>&nbsp;<span class="builtinfunc" id="6917413">len</span><span class="op" id="6917416">(</span><span class="ident" id="6917417">dc</span><span class="op" id="6917419">.</span><span class="ident" id="6917420">openStmt</span><span class="op" id="6917428">)</span><span class="op" id="6917429">;</span>&nbsp;<span class="ident" id="6917431">n</span>&nbsp;<span class="op" id="6917433">!=</span>&nbsp;<span class="num" id="6917436">1</span>&nbsp;<span class="op" id="6917438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6917442">t</span><span class="op" id="6917443">.</span><span class="ident" id="6917444">Errorf</span><span class="op" id="6917450">(</span><span class="string" id="6917451">&#34;driverConn&nbsp;num&nbsp;openStmt&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="6917489">,</span>&nbsp;<span class="ident" id="6917491">n</span><span class="op" id="6917492">)</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6917495">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6917498">err</span>&nbsp;<span class="op" id="6917502">=</span>&nbsp;<span class="ident" id="6917504">db</span><span class="op" id="6917506">.</span><span class="ident" id="6917507">Close</span><span class="op" id="6917512">(</span><span class="op" id="6917513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6917516">if</span>&nbsp;<span class="ident" id="6917519">err</span>&nbsp;<span class="op" id="6917523">!=</span>&nbsp;<span class="ident" id="6917526">nil</span>&nbsp;<span class="op" id="6917530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6917534">t</span><span class="op" id="6917535">.</span><span class="ident" id="6917536">Errorf</span><span class="op" id="6917542">(</span><span class="string" id="6917543">&#34;db&nbsp;Close&nbsp;=&nbsp;%v&#34;</span><span class="op" id="6917558">,</span>&nbsp;<span class="ident" id="6917560">err</span><span class="op" id="6917563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6917566">}</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6917569">if</span>&nbsp;<span class="op" id="6917572">!</span><span class="ident" id="6917573">dc</span><span class="op" id="6917575">.</span><span class="ident" id="6917576">closed</span>&nbsp;<span class="op" id="6917583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6917587">t</span><span class="op" id="6917588">.</span><span class="ident" id="6917589">Errorf</span><span class="op" id="6917595">(</span><span class="string" id="6917596">&#34;after&nbsp;db.Close,&nbsp;driverConn&nbsp;should&nbsp;be&nbsp;closed&#34;</span><span class="op" id="6917641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6917644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6917647">if</span>&nbsp;<span class="ident" id="6917650">n</span>&nbsp;<span class="op" id="6917652">:=</span>&nbsp;<span class="builtinfunc" id="6917655">len</span><span class="op" id="6917658">(</span><span class="ident" id="6917659">dc</span><span class="op" id="6917661">.</span><span class="ident" id="6917662">openStmt</span><span class="op" id="6917670">)</span><span class="op" id="6917671">;</span>&nbsp;<span class="ident" id="6917673">n</span>&nbsp;<span class="op" id="6917675">!=</span>&nbsp;<span class="num" id="6917678">0</span>&nbsp;<span class="op" id="6917680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6917684">t</span><span class="op" id="6917685">.</span><span class="ident" id="6917686">Errorf</span><span class="op" id="6917692">(</span><span class="string" id="6917693">&#34;driverConn&nbsp;num&nbsp;openStmt&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="6917731">,</span>&nbsp;<span class="ident" id="6917733">n</span><span class="op" id="6917734">)</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6917737">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6917741">err</span>&nbsp;<span class="op" id="6917745">=</span>&nbsp;<span class="ident" id="6917747">stmt</span><span class="op" id="6917751">.</span><span class="ident" id="6917752">Close</span><span class="op" id="6917757">(</span><span class="op" id="6917758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6917761">if</span>&nbsp;<span class="ident" id="6917764">err</span>&nbsp;<span class="op" id="6917768">!=</span>&nbsp;<span class="ident" id="6917771">nil</span>&nbsp;<span class="op" id="6917775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6917779">t</span><span class="op" id="6917780">.</span><span class="ident" id="6917781">Errorf</span><span class="op" id="6917787">(</span><span class="string" id="6917788">&#34;Stmt&nbsp;close&nbsp;=&nbsp;%v&#34;</span><span class="op" id="6917805">,</span>&nbsp;<span class="ident" id="6917807">err</span><span class="op" id="6917810">)</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6917813">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6917817">if</span>&nbsp;<span class="op" id="6917820">!</span><span class="ident" id="6917821">dc</span><span class="op" id="6917823">.</span><span class="ident" id="6917824">closed</span>&nbsp;<span class="op" id="6917831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6917835">t</span><span class="op" id="6917836">.</span><span class="ident" id="6917837">Errorf</span><span class="op" id="6917843">(</span><span class="string" id="6917844">&#34;conn&nbsp;should&nbsp;be&nbsp;closed&#34;</span><span class="op" id="6917867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6917870">}</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6917873">if</span>&nbsp;<span class="ident" id="6917876">dc</span><span class="op" id="6917878">.</span><span class="ident" id="6917879">ci</span>&nbsp;<span class="op" id="6917882">!=</span>&nbsp;<span class="ident" id="6917885">nil</span>&nbsp;<span class="op" id="6917889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6917893">t</span><span class="op" id="6917894">.</span><span class="ident" id="6917895">Errorf</span><span class="op" id="6917901">(</span><span class="string" id="6917902">&#34;after&nbsp;Stmt&nbsp;Close,&nbsp;driverConn&#39;s&nbsp;Conn&nbsp;interface&nbsp;should&nbsp;be&nbsp;nil&#34;</span><span class="op" id="6917963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6917966">}</span><br>
<span class="lineno"></span><span class="op" id="6917968">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1255</span><span class="comment" id="6917971">//&nbsp;golang.org/issue/5283:&nbsp;don&#39;t&nbsp;release&nbsp;the&nbsp;Rows&#39;&nbsp;connection&nbsp;in&nbsp;Close</span><br>
<span class="lineno"></span><span class="comment" id="6918041">//&nbsp;before&nbsp;calling&nbsp;Stmt.Close.</span><br>
<span class="lineno"></span><span class="keyword" id="6918071">func</span>&nbsp;<span class="ident" id="6918076">TestRowsCloseOrder</span><span class="op" id="6918094">(</span><span class="ident" id="6918095">t</span>&nbsp;<span class="op" id="6918097">*</span><span class="ident" id="6918098">testing</span><span class="op" id="6918105">.</span><span class="ident" id="6918106">T</span><span class="op" id="6918107">)</span>&nbsp;<span class="op" id="6918109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6918112">db</span>&nbsp;<span class="op" id="6918115">:=</span>&nbsp;<span class="ident" id="6918118">newTestDB</span><span class="op" id="6918127">(</span><span class="ident" id="6918128">t</span><span class="op" id="6918129">,</span>&nbsp;<span class="string" id="6918131">&#34;people&#34;</span><span class="op" id="6918139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6918142">defer</span>&nbsp;<span class="ident" id="6918148">closeDB</span><span class="op" id="6918155">(</span><span class="ident" id="6918156">t</span><span class="op" id="6918157">,</span>&nbsp;<span class="ident" id="6918159">db</span><span class="op" id="6918161">)</span><br>
<span class="lineno">1260</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6918165">db</span><span class="op" id="6918167">.</span><span class="ident" id="6918168">SetMaxIdleConns</span><span class="op" id="6918183">(</span><span class="num" id="6918184">0</span><span class="op" id="6918185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6918188">setStrictFakeConnClose</span><span class="op" id="6918210">(</span><span class="ident" id="6918211">t</span><span class="op" id="6918212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6918215">defer</span>&nbsp;<span class="ident" id="6918221">setStrictFakeConnClose</span><span class="op" id="6918243">(</span><span class="ident" id="6918244">nil</span><span class="op" id="6918247">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6918251">rows</span><span class="op" id="6918255">,</span>&nbsp;<span class="ident" id="6918257">err</span>&nbsp;<span class="op" id="6918261">:=</span>&nbsp;<span class="ident" id="6918264">db</span><span class="op" id="6918266">.</span><span class="ident" id="6918267">Query</span><span class="op" id="6918272">(</span><span class="string" id="6918273">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="6918298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6918301">if</span>&nbsp;<span class="ident" id="6918304">err</span>&nbsp;<span class="op" id="6918308">!=</span>&nbsp;<span class="ident" id="6918311">nil</span>&nbsp;<span class="op" id="6918315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6918319">t</span><span class="op" id="6918320">.</span><span class="ident" id="6918321">Fatal</span><span class="op" id="6918326">(</span><span class="ident" id="6918327">err</span><span class="op" id="6918330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6918333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6918336">err</span>&nbsp;<span class="op" id="6918340">=</span>&nbsp;<span class="ident" id="6918342">rows</span><span class="op" id="6918346">.</span><span class="ident" id="6918347">Close</span><span class="op" id="6918352">(</span><span class="op" id="6918353">)</span><br>
<span class="lineno">1270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6918356">if</span>&nbsp;<span class="ident" id="6918359">err</span>&nbsp;<span class="op" id="6918363">!=</span>&nbsp;<span class="ident" id="6918366">nil</span>&nbsp;<span class="op" id="6918370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6918374">t</span><span class="op" id="6918375">.</span><span class="ident" id="6918376">Fatal</span><span class="op" id="6918381">(</span><span class="ident" id="6918382">err</span><span class="op" id="6918385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6918388">}</span><br>
<span class="lineno"></span><span class="op" id="6918390">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1275</span><span class="keyword" id="6918393">func</span>&nbsp;<span class="ident" id="6918398">TestRowsImplicitClose</span><span class="op" id="6918419">(</span><span class="ident" id="6918420">t</span>&nbsp;<span class="op" id="6918422">*</span><span class="ident" id="6918423">testing</span><span class="op" id="6918430">.</span><span class="ident" id="6918431">T</span><span class="op" id="6918432">)</span>&nbsp;<span class="op" id="6918434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6918437">db</span>&nbsp;<span class="op" id="6918440">:=</span>&nbsp;<span class="ident" id="6918443">newTestDB</span><span class="op" id="6918452">(</span><span class="ident" id="6918453">t</span><span class="op" id="6918454">,</span>&nbsp;<span class="string" id="6918456">&#34;people&#34;</span><span class="op" id="6918464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6918467">defer</span>&nbsp;<span class="ident" id="6918473">closeDB</span><span class="op" id="6918480">(</span><span class="ident" id="6918481">t</span><span class="op" id="6918482">,</span>&nbsp;<span class="ident" id="6918484">db</span><span class="op" id="6918486">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6918490">rows</span><span class="op" id="6918494">,</span>&nbsp;<span class="ident" id="6918496">err</span>&nbsp;<span class="op" id="6918500">:=</span>&nbsp;<span class="ident" id="6918503">db</span><span class="op" id="6918505">.</span><span class="ident" id="6918506">Query</span><span class="op" id="6918511">(</span><span class="string" id="6918512">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="6918537">)</span><br>
<span class="lineno">1280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6918540">if</span>&nbsp;<span class="ident" id="6918543">err</span>&nbsp;<span class="op" id="6918547">!=</span>&nbsp;<span class="ident" id="6918550">nil</span>&nbsp;<span class="op" id="6918554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6918558">t</span><span class="op" id="6918559">.</span><span class="ident" id="6918560">Fatal</span><span class="op" id="6918565">(</span><span class="ident" id="6918566">err</span><span class="op" id="6918569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6918572">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6918576">want</span><span class="op" id="6918580">,</span>&nbsp;<span class="ident" id="6918582">fail</span>&nbsp;<span class="op" id="6918587">:=</span>&nbsp;<span class="num" id="6918590">2</span><span class="op" id="6918591">,</span>&nbsp;<span class="ident" id="6918593">errors</span><span class="op" id="6918599">.</span><span class="ident" id="6918600">New</span><span class="op" id="6918603">(</span><span class="string" id="6918604">&#34;fail&#34;</span><span class="op" id="6918610">)</span><br>
<span class="lineno">1285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6918613">r</span>&nbsp;<span class="op" id="6918615">:=</span>&nbsp;<span class="ident" id="6918618">rows</span><span class="op" id="6918622">.</span><span class="ident" id="6918623">rowsi</span><span class="op" id="6918628">.</span><span class="op" id="6918629">(</span><span class="op" id="6918630">*</span><span class="ident" id="6918631">rowsCursor</span><span class="op" id="6918641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6918644">r</span><span class="op" id="6918645">.</span><span class="ident" id="6918646">errPos</span><span class="op" id="6918652">,</span>&nbsp;<span class="ident" id="6918654">r</span><span class="op" id="6918655">.</span><span class="ident" id="6918656">err</span>&nbsp;<span class="op" id="6918660">=</span>&nbsp;<span class="ident" id="6918662">want</span><span class="op" id="6918666">,</span>&nbsp;<span class="ident" id="6918668">fail</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6918675">got</span>&nbsp;<span class="op" id="6918679">:=</span>&nbsp;<span class="num" id="6918682">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6918685">for</span>&nbsp;<span class="ident" id="6918689">rows</span><span class="op" id="6918693">.</span><span class="ident" id="6918694">Next</span><span class="op" id="6918698">(</span><span class="op" id="6918699">)</span>&nbsp;<span class="op" id="6918701">{</span><br>
<span class="lineno">1290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6918705">got</span><span class="op" id="6918708">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6918712">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6918715">if</span>&nbsp;<span class="ident" id="6918718">got</span>&nbsp;<span class="op" id="6918722">!=</span>&nbsp;<span class="ident" id="6918725">want</span>&nbsp;<span class="op" id="6918730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6918734">t</span><span class="op" id="6918735">.</span><span class="ident" id="6918736">Errorf</span><span class="op" id="6918742">(</span><span class="string" id="6918743">&#34;got&nbsp;%d&nbsp;rows,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6918765">,</span>&nbsp;<span class="ident" id="6918767">got</span><span class="op" id="6918770">,</span>&nbsp;<span class="ident" id="6918772">want</span><span class="op" id="6918776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6918779">}</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6918782">if</span>&nbsp;<span class="ident" id="6918785">err</span>&nbsp;<span class="op" id="6918789">:=</span>&nbsp;<span class="ident" id="6918792">rows</span><span class="op" id="6918796">.</span><span class="ident" id="6918797">Err</span><span class="op" id="6918800">(</span><span class="op" id="6918801">)</span><span class="op" id="6918802">;</span>&nbsp;<span class="ident" id="6918804">err</span>&nbsp;<span class="op" id="6918808">!=</span>&nbsp;<span class="ident" id="6918811">fail</span>&nbsp;<span class="op" id="6918816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6918820">t</span><span class="op" id="6918821">.</span><span class="ident" id="6918822">Errorf</span><span class="op" id="6918828">(</span><span class="string" id="6918829">&#34;got&nbsp;error&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="6918852">,</span>&nbsp;<span class="ident" id="6918854">err</span><span class="op" id="6918857">,</span>&nbsp;<span class="ident" id="6918859">fail</span><span class="op" id="6918863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6918866">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6918869">if</span>&nbsp;<span class="op" id="6918872">!</span><span class="ident" id="6918873">r</span><span class="op" id="6918874">.</span><span class="ident" id="6918875">closed</span>&nbsp;<span class="op" id="6918882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6918886">t</span><span class="op" id="6918887">.</span><span class="ident" id="6918888">Errorf</span><span class="op" id="6918894">(</span><span class="string" id="6918895">&#34;r.closed&nbsp;is&nbsp;false,&nbsp;want&nbsp;true&#34;</span><span class="op" id="6918925">)</span><br>
<span class="lineno">1300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6918928">}</span><br>
<span class="lineno"></span><span class="op" id="6918930">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6918933">func</span>&nbsp;<span class="ident" id="6918938">TestStmtCloseOrder</span><span class="op" id="6918956">(</span><span class="ident" id="6918957">t</span>&nbsp;<span class="op" id="6918959">*</span><span class="ident" id="6918960">testing</span><span class="op" id="6918967">.</span><span class="ident" id="6918968">T</span><span class="op" id="6918969">)</span>&nbsp;<span class="op" id="6918971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6918974">db</span>&nbsp;<span class="op" id="6918977">:=</span>&nbsp;<span class="ident" id="6918980">newTestDB</span><span class="op" id="6918989">(</span><span class="ident" id="6918990">t</span><span class="op" id="6918991">,</span>&nbsp;<span class="string" id="6918993">&#34;people&#34;</span><span class="op" id="6919001">)</span><br>
<span class="lineno">1305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6919004">defer</span>&nbsp;<span class="ident" id="6919010">closeDB</span><span class="op" id="6919017">(</span><span class="ident" id="6919018">t</span><span class="op" id="6919019">,</span>&nbsp;<span class="ident" id="6919021">db</span><span class="op" id="6919023">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6919027">db</span><span class="op" id="6919029">.</span><span class="ident" id="6919030">SetMaxIdleConns</span><span class="op" id="6919045">(</span><span class="num" id="6919046">0</span><span class="op" id="6919047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6919050">setStrictFakeConnClose</span><span class="op" id="6919072">(</span><span class="ident" id="6919073">t</span><span class="op" id="6919074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6919077">defer</span>&nbsp;<span class="ident" id="6919083">setStrictFakeConnClose</span><span class="op" id="6919105">(</span><span class="ident" id="6919106">nil</span><span class="op" id="6919109">)</span><br>
<span class="lineno">1310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6919113">_</span><span class="op" id="6919114">,</span>&nbsp;<span class="ident" id="6919116">err</span>&nbsp;<span class="op" id="6919120">:=</span>&nbsp;<span class="ident" id="6919123">db</span><span class="op" id="6919125">.</span><span class="ident" id="6919126">Query</span><span class="op" id="6919131">(</span><span class="string" id="6919132">&#34;SELECT|non_existent|name|&#34;</span><span class="op" id="6919159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6919162">if</span>&nbsp;<span class="ident" id="6919165">err</span>&nbsp;<span class="op" id="6919169">==</span>&nbsp;<span class="ident" id="6919172">nil</span>&nbsp;<span class="op" id="6919176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6919180">t</span><span class="op" id="6919181">.</span><span class="ident" id="6919182">Fatal</span><span class="op" id="6919187">(</span><span class="string" id="6919188">&#34;Quering&nbsp;non-existent&nbsp;table&nbsp;should&nbsp;fail&#34;</span><span class="op" id="6919228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6919231">}</span><br>
<span class="lineno">1315</span><span class="op" id="6919233">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6919236">//&nbsp;golang.org/issue/5781</span><br>
<span class="lineno"></span><span class="keyword" id="6919261">func</span>&nbsp;<span class="ident" id="6919266">TestErrBadConnReconnect</span><span class="op" id="6919289">(</span><span class="ident" id="6919290">t</span>&nbsp;<span class="op" id="6919292">*</span><span class="ident" id="6919293">testing</span><span class="op" id="6919300">.</span><span class="ident" id="6919301">T</span><span class="op" id="6919302">)</span>&nbsp;<span class="op" id="6919304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6919307">db</span>&nbsp;<span class="op" id="6919310">:=</span>&nbsp;<span class="ident" id="6919313">newTestDB</span><span class="op" id="6919322">(</span><span class="ident" id="6919323">t</span><span class="op" id="6919324">,</span>&nbsp;<span class="string" id="6919326">&#34;foo&#34;</span><span class="op" id="6919331">)</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6919334">defer</span>&nbsp;<span class="ident" id="6919340">closeDB</span><span class="op" id="6919347">(</span><span class="ident" id="6919348">t</span><span class="op" id="6919349">,</span>&nbsp;<span class="ident" id="6919351">db</span><span class="op" id="6919353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6919356">exec</span><span class="op" id="6919360">(</span><span class="ident" id="6919361">t</span><span class="op" id="6919362">,</span>&nbsp;<span class="ident" id="6919364">db</span><span class="op" id="6919366">,</span>&nbsp;<span class="string" id="6919368">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="6919411">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6919415">simulateBadConn</span>&nbsp;<span class="op" id="6919431">:=</span>&nbsp;<span class="keyword" id="6919434">func</span><span class="op" id="6919438">(</span><span class="ident" id="6919439">name</span>&nbsp;<span class="builtintype" id="6919444">string</span><span class="op" id="6919450">,</span>&nbsp;<span class="ident" id="6919452">hook</span>&nbsp;<span class="op" id="6919457">*</span><span class="keyword" id="6919458">func</span><span class="op" id="6919462">(</span><span class="op" id="6919463">)</span>&nbsp;<span class="builtintype" id="6919465">bool</span><span class="op" id="6919469">,</span>&nbsp;<span class="ident" id="6919471">op</span>&nbsp;<span class="keyword" id="6919474">func</span><span class="op" id="6919478">(</span><span class="op" id="6919479">)</span>&nbsp;<span class="builtintype" id="6919481">error</span><span class="op" id="6919486">)</span>&nbsp;<span class="op" id="6919488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6919492">broken</span><span class="op" id="6919498">,</span>&nbsp;<span class="ident" id="6919500">retried</span>&nbsp;<span class="op" id="6919508">:=</span>&nbsp;<span class="builtintype" id="6919511">false</span><span class="op" id="6919516">,</span>&nbsp;<span class="builtintype" id="6919518">false</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6919526">numOpen</span>&nbsp;<span class="op" id="6919534">:=</span>&nbsp;<span class="ident" id="6919537">db</span><span class="op" id="6919539">.</span><span class="ident" id="6919540">numOpen</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6919551">//&nbsp;simulate&nbsp;a&nbsp;broken&nbsp;connection&nbsp;on&nbsp;the&nbsp;first&nbsp;try</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6919602">*</span><span class="ident" id="6919603">hook</span>&nbsp;<span class="op" id="6919608">=</span>&nbsp;<span class="keyword" id="6919610">func</span><span class="op" id="6919614">(</span><span class="op" id="6919615">)</span>&nbsp;<span class="builtintype" id="6919617">bool</span>&nbsp;<span class="op" id="6919622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6919627">if</span>&nbsp;<span class="op" id="6919630">!</span><span class="ident" id="6919631">broken</span>&nbsp;<span class="op" id="6919638">{</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6919644">broken</span>&nbsp;<span class="op" id="6919651">=</span>&nbsp;<span class="builtintype" id="6919653">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6919662">return</span>&nbsp;<span class="builtintype" id="6919669">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6919677">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6919682">retried</span>&nbsp;<span class="op" id="6919690">=</span>&nbsp;<span class="builtintype" id="6919692">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6919700">return</span>&nbsp;<span class="builtintype" id="6919707">false</span><br>
<span class="lineno">1335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6919715">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6919720">if</span>&nbsp;<span class="ident" id="6919723">err</span>&nbsp;<span class="op" id="6919727">:=</span>&nbsp;<span class="ident" id="6919730">op</span><span class="op" id="6919732">(</span><span class="op" id="6919733">)</span><span class="op" id="6919734">;</span>&nbsp;<span class="ident" id="6919736">err</span>&nbsp;<span class="op" id="6919740">!=</span>&nbsp;<span class="ident" id="6919743">nil</span>&nbsp;<span class="op" id="6919747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6919752">t</span><span class="op" id="6919753">.</span><span class="ident" id="6919754">Errorf</span><span class="op" id="6919760">(</span><span class="ident" id="6919761">name</span><span class="op" id="6919765">+</span><span class="string" id="6919766">&#34;:&nbsp;%v&#34;</span><span class="op" id="6919772">,</span>&nbsp;<span class="ident" id="6919774">err</span><span class="op" id="6919777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6919782">return</span><br>
<span class="lineno">1340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6919791">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6919796">if</span>&nbsp;<span class="op" id="6919799">!</span><span class="ident" id="6919800">broken</span>&nbsp;<span class="op" id="6919807">||</span>&nbsp;<span class="op" id="6919810">!</span><span class="ident" id="6919811">retried</span>&nbsp;<span class="op" id="6919819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6919824">t</span><span class="op" id="6919825">.</span><span class="ident" id="6919826">Error</span><span class="op" id="6919831">(</span><span class="ident" id="6919832">name</span>&nbsp;<span class="op" id="6919837">+</span>&nbsp;<span class="string" id="6919839">&#34;:&nbsp;Failed&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connection&#34;</span><span class="op" id="6919879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6919883">}</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6919887">*</span><span class="ident" id="6919888">hook</span>&nbsp;<span class="op" id="6919893">=</span>&nbsp;<span class="ident" id="6919895">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6919902">if</span>&nbsp;<span class="ident" id="6919905">numOpen</span>&nbsp;<span class="op" id="6919913">!=</span>&nbsp;<span class="ident" id="6919916">db</span><span class="op" id="6919918">.</span><span class="ident" id="6919919">numOpen</span>&nbsp;<span class="op" id="6919927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6919932">t</span><span class="op" id="6919933">.</span><span class="ident" id="6919934">Errorf</span><span class="op" id="6919940">(</span><span class="ident" id="6919941">name</span><span class="op" id="6919945">+</span><span class="string" id="6919946">&#34;:&nbsp;leaked&nbsp;%d&nbsp;connection(s)!&#34;</span><span class="op" id="6919974">,</span>&nbsp;<span class="ident" id="6919976">db</span><span class="op" id="6919978">.</span><span class="ident" id="6919979">numOpen</span><span class="op" id="6919986">-</span><span class="ident" id="6919987">numOpen</span><span class="op" id="6919994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6919999">numOpen</span>&nbsp;<span class="op" id="6920007">=</span>&nbsp;<span class="ident" id="6920009">db</span><span class="op" id="6920011">.</span><span class="ident" id="6920012">numOpen</span><br>
<span class="lineno">1350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6920022">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6920025">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6920029">//&nbsp;db.Exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6920041">dbExec</span>&nbsp;<span class="op" id="6920048">:=</span>&nbsp;<span class="keyword" id="6920051">func</span><span class="op" id="6920055">(</span><span class="op" id="6920056">)</span>&nbsp;<span class="builtintype" id="6920058">error</span>&nbsp;<span class="op" id="6920064">{</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6920068">_</span><span class="op" id="6920069">,</span>&nbsp;<span class="ident" id="6920071">err</span>&nbsp;<span class="op" id="6920075">:=</span>&nbsp;<span class="ident" id="6920078">db</span><span class="op" id="6920080">.</span><span class="ident" id="6920081">Exec</span><span class="op" id="6920085">(</span><span class="string" id="6920086">&#34;INSERT|t1|name=?,age=?,dead=?&#34;</span><span class="op" id="6920117">,</span>&nbsp;<span class="string" id="6920119">&#34;Gordon&#34;</span><span class="op" id="6920127">,</span>&nbsp;<span class="num" id="6920129">3</span><span class="op" id="6920130">,</span>&nbsp;<span class="builtintype" id="6920132">true</span><span class="op" id="6920136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6920140">return</span>&nbsp;<span class="ident" id="6920147">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6920152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6920155">simulateBadConn</span><span class="op" id="6920170">(</span><span class="string" id="6920171">&#34;db.Exec&nbsp;prepare&#34;</span><span class="op" id="6920188">,</span>&nbsp;<span class="op" id="6920190">&amp;</span><span class="ident" id="6920191">hookPrepareBadConn</span><span class="op" id="6920209">,</span>&nbsp;<span class="ident" id="6920211">dbExec</span><span class="op" id="6920217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6920220">simulateBadConn</span><span class="op" id="6920235">(</span><span class="string" id="6920236">&#34;db.Exec&nbsp;exec&#34;</span><span class="op" id="6920250">,</span>&nbsp;<span class="op" id="6920252">&amp;</span><span class="ident" id="6920253">hookExecBadConn</span><span class="op" id="6920268">,</span>&nbsp;<span class="ident" id="6920270">dbExec</span><span class="op" id="6920276">)</span><br>
<span class="lineno">1360</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6920280">//&nbsp;db.Query</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6920293">dbQuery</span>&nbsp;<span class="op" id="6920301">:=</span>&nbsp;<span class="keyword" id="6920304">func</span><span class="op" id="6920308">(</span><span class="op" id="6920309">)</span>&nbsp;<span class="builtintype" id="6920311">error</span>&nbsp;<span class="op" id="6920317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6920321">rows</span><span class="op" id="6920325">,</span>&nbsp;<span class="ident" id="6920327">err</span>&nbsp;<span class="op" id="6920331">:=</span>&nbsp;<span class="ident" id="6920334">db</span><span class="op" id="6920336">.</span><span class="ident" id="6920337">Query</span><span class="op" id="6920342">(</span><span class="string" id="6920343">&#34;SELECT|t1|age,name|&#34;</span><span class="op" id="6920364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6920368">if</span>&nbsp;<span class="ident" id="6920371">err</span>&nbsp;<span class="op" id="6920375">==</span>&nbsp;<span class="ident" id="6920378">nil</span>&nbsp;<span class="op" id="6920382">{</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6920387">err</span>&nbsp;<span class="op" id="6920391">=</span>&nbsp;<span class="ident" id="6920393">rows</span><span class="op" id="6920397">.</span><span class="ident" id="6920398">Close</span><span class="op" id="6920403">(</span><span class="op" id="6920404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6920408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6920412">return</span>&nbsp;<span class="ident" id="6920419">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6920424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6920427">simulateBadConn</span><span class="op" id="6920442">(</span><span class="string" id="6920443">&#34;db.Query&nbsp;prepare&#34;</span><span class="op" id="6920461">,</span>&nbsp;<span class="op" id="6920463">&amp;</span><span class="ident" id="6920464">hookPrepareBadConn</span><span class="op" id="6920482">,</span>&nbsp;<span class="ident" id="6920484">dbQuery</span><span class="op" id="6920491">)</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6920494">simulateBadConn</span><span class="op" id="6920509">(</span><span class="string" id="6920510">&#34;db.Query&nbsp;query&#34;</span><span class="op" id="6920526">,</span>&nbsp;<span class="op" id="6920528">&amp;</span><span class="ident" id="6920529">hookQueryBadConn</span><span class="op" id="6920545">,</span>&nbsp;<span class="ident" id="6920547">dbQuery</span><span class="op" id="6920554">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6920558">//&nbsp;db.Prepare</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6920573">simulateBadConn</span><span class="op" id="6920588">(</span><span class="string" id="6920589">&#34;db.Prepare&#34;</span><span class="op" id="6920601">,</span>&nbsp;<span class="op" id="6920603">&amp;</span><span class="ident" id="6920604">hookPrepareBadConn</span><span class="op" id="6920622">,</span>&nbsp;<span class="keyword" id="6920624">func</span><span class="op" id="6920628">(</span><span class="op" id="6920629">)</span>&nbsp;<span class="builtintype" id="6920631">error</span>&nbsp;<span class="op" id="6920637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6920641">stmt</span><span class="op" id="6920645">,</span>&nbsp;<span class="ident" id="6920647">err</span>&nbsp;<span class="op" id="6920651">:=</span>&nbsp;<span class="ident" id="6920654">db</span><span class="op" id="6920656">.</span><span class="ident" id="6920657">Prepare</span><span class="op" id="6920664">(</span><span class="string" id="6920665">&#34;INSERT|t1|name=?,age=?,dead=?&#34;</span><span class="op" id="6920696">)</span><br>
<span class="lineno">1375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6920700">if</span>&nbsp;<span class="ident" id="6920703">err</span>&nbsp;<span class="op" id="6920707">!=</span>&nbsp;<span class="ident" id="6920710">nil</span>&nbsp;<span class="op" id="6920714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6920719">return</span>&nbsp;<span class="ident" id="6920726">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6920732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6920736">stmt</span><span class="op" id="6920740">.</span><span class="ident" id="6920741">Close</span><span class="op" id="6920746">(</span><span class="op" id="6920747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6920751">return</span>&nbsp;<span class="ident" id="6920758">nil</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6920763">}</span><span class="op" id="6920764">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6920768">//&nbsp;Provide&nbsp;a&nbsp;way&nbsp;to&nbsp;force&nbsp;a&nbsp;re-prepare&nbsp;of&nbsp;a&nbsp;statement&nbsp;on&nbsp;next&nbsp;execution</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6920841">forcePrepare</span>&nbsp;<span class="op" id="6920854">:=</span>&nbsp;<span class="keyword" id="6920857">func</span><span class="op" id="6920861">(</span><span class="ident" id="6920862">stmt</span>&nbsp;<span class="op" id="6920867">*</span><span class="ident" id="6920868">Stmt</span><span class="op" id="6920872">)</span>&nbsp;<span class="op" id="6920874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6920878">stmt</span><span class="op" id="6920882">.</span><span class="ident" id="6920883">css</span>&nbsp;<span class="op" id="6920887">=</span>&nbsp;<span class="ident" id="6920889">nil</span><br>
<span class="lineno">1385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6920894">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6920898">//&nbsp;stmt.Exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6920912">stmt1</span><span class="op" id="6920917">,</span>&nbsp;<span class="ident" id="6920919">err</span>&nbsp;<span class="op" id="6920923">:=</span>&nbsp;<span class="ident" id="6920926">db</span><span class="op" id="6920928">.</span><span class="ident" id="6920929">Prepare</span><span class="op" id="6920936">(</span><span class="string" id="6920937">&#34;INSERT|t1|name=?,age=?,dead=?&#34;</span><span class="op" id="6920968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6920971">if</span>&nbsp;<span class="ident" id="6920974">err</span>&nbsp;<span class="op" id="6920978">!=</span>&nbsp;<span class="ident" id="6920981">nil</span>&nbsp;<span class="op" id="6920985">{</span><br>
<span class="lineno">1390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6920989">t</span><span class="op" id="6920990">.</span><span class="ident" id="6920991">Fatalf</span><span class="op" id="6920997">(</span><span class="string" id="6920998">&#34;prepare:&nbsp;%v&#34;</span><span class="op" id="6921011">,</span>&nbsp;<span class="ident" id="6921013">err</span><span class="op" id="6921016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6921019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6921022">defer</span>&nbsp;<span class="ident" id="6921028">stmt1</span><span class="op" id="6921033">.</span><span class="ident" id="6921034">Close</span><span class="op" id="6921039">(</span><span class="op" id="6921040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6921043">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;must&nbsp;prepare&nbsp;the&nbsp;stmt&nbsp;first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6921088">forcePrepare</span><span class="op" id="6921100">(</span><span class="ident" id="6921101">stmt1</span><span class="op" id="6921106">)</span><br>
<span class="lineno">1395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6921110">stmtExec</span>&nbsp;<span class="op" id="6921119">:=</span>&nbsp;<span class="keyword" id="6921122">func</span><span class="op" id="6921126">(</span><span class="op" id="6921127">)</span>&nbsp;<span class="builtintype" id="6921129">error</span>&nbsp;<span class="op" id="6921135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6921139">_</span><span class="op" id="6921140">,</span>&nbsp;<span class="ident" id="6921142">err</span>&nbsp;<span class="op" id="6921146">:=</span>&nbsp;<span class="ident" id="6921149">stmt1</span><span class="op" id="6921154">.</span><span class="ident" id="6921155">Exec</span><span class="op" id="6921159">(</span><span class="string" id="6921160">&#34;Gopher&#34;</span><span class="op" id="6921168">,</span>&nbsp;<span class="num" id="6921170">3</span><span class="op" id="6921171">,</span>&nbsp;<span class="builtintype" id="6921173">false</span><span class="op" id="6921178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6921182">return</span>&nbsp;<span class="ident" id="6921189">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6921194">}</span><br>
<span class="lineno">1400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6921197">simulateBadConn</span><span class="op" id="6921212">(</span><span class="string" id="6921213">&#34;stmt.Exec&nbsp;prepare&#34;</span><span class="op" id="6921232">,</span>&nbsp;<span class="op" id="6921234">&amp;</span><span class="ident" id="6921235">hookPrepareBadConn</span><span class="op" id="6921253">,</span>&nbsp;<span class="ident" id="6921255">stmtExec</span><span class="op" id="6921263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6921266">simulateBadConn</span><span class="op" id="6921281">(</span><span class="string" id="6921282">&#34;stmt.Exec&nbsp;exec&#34;</span><span class="op" id="6921298">,</span>&nbsp;<span class="op" id="6921300">&amp;</span><span class="ident" id="6921301">hookExecBadConn</span><span class="op" id="6921316">,</span>&nbsp;<span class="ident" id="6921318">stmtExec</span><span class="op" id="6921326">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6921330">//&nbsp;stmt.Query</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6921345">stmt2</span><span class="op" id="6921350">,</span>&nbsp;<span class="ident" id="6921352">err</span>&nbsp;<span class="op" id="6921356">:=</span>&nbsp;<span class="ident" id="6921359">db</span><span class="op" id="6921361">.</span><span class="ident" id="6921362">Prepare</span><span class="op" id="6921369">(</span><span class="string" id="6921370">&#34;SELECT|t1|age,name|&#34;</span><span class="op" id="6921391">)</span><br>
<span class="lineno">1405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6921394">if</span>&nbsp;<span class="ident" id="6921397">err</span>&nbsp;<span class="op" id="6921401">!=</span>&nbsp;<span class="ident" id="6921404">nil</span>&nbsp;<span class="op" id="6921408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6921412">t</span><span class="op" id="6921413">.</span><span class="ident" id="6921414">Fatalf</span><span class="op" id="6921420">(</span><span class="string" id="6921421">&#34;prepare:&nbsp;%v&#34;</span><span class="op" id="6921434">,</span>&nbsp;<span class="ident" id="6921436">err</span><span class="op" id="6921439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6921442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6921445">defer</span>&nbsp;<span class="ident" id="6921451">stmt2</span><span class="op" id="6921456">.</span><span class="ident" id="6921457">Close</span><span class="op" id="6921462">(</span><span class="op" id="6921463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6921466">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;must&nbsp;prepare&nbsp;the&nbsp;stmt&nbsp;first</span><br>
<span class="lineno">1410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6921511">forcePrepare</span><span class="op" id="6921523">(</span><span class="ident" id="6921524">stmt2</span><span class="op" id="6921529">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6921533">stmtQuery</span>&nbsp;<span class="op" id="6921543">:=</span>&nbsp;<span class="keyword" id="6921546">func</span><span class="op" id="6921550">(</span><span class="op" id="6921551">)</span>&nbsp;<span class="builtintype" id="6921553">error</span>&nbsp;<span class="op" id="6921559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6921563">rows</span><span class="op" id="6921567">,</span>&nbsp;<span class="ident" id="6921569">err</span>&nbsp;<span class="op" id="6921573">:=</span>&nbsp;<span class="ident" id="6921576">stmt2</span><span class="op" id="6921581">.</span><span class="ident" id="6921582">Query</span><span class="op" id="6921587">(</span><span class="op" id="6921588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6921592">if</span>&nbsp;<span class="ident" id="6921595">err</span>&nbsp;<span class="op" id="6921599">==</span>&nbsp;<span class="ident" id="6921602">nil</span>&nbsp;<span class="op" id="6921606">{</span><br>
<span class="lineno">1415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6921611">err</span>&nbsp;<span class="op" id="6921615">=</span>&nbsp;<span class="ident" id="6921617">rows</span><span class="op" id="6921621">.</span><span class="ident" id="6921622">Close</span><span class="op" id="6921627">(</span><span class="op" id="6921628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6921632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6921636">return</span>&nbsp;<span class="ident" id="6921643">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6921648">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6921651">simulateBadConn</span><span class="op" id="6921666">(</span><span class="string" id="6921667">&#34;stmt.Query&nbsp;prepare&#34;</span><span class="op" id="6921687">,</span>&nbsp;<span class="op" id="6921689">&amp;</span><span class="ident" id="6921690">hookPrepareBadConn</span><span class="op" id="6921708">,</span>&nbsp;<span class="ident" id="6921710">stmtQuery</span><span class="op" id="6921719">)</span><br>
<span class="lineno">1420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6921722">simulateBadConn</span><span class="op" id="6921737">(</span><span class="string" id="6921738">&#34;stmt.Query&nbsp;exec&#34;</span><span class="op" id="6921755">,</span>&nbsp;<span class="op" id="6921757">&amp;</span><span class="ident" id="6921758">hookQueryBadConn</span><span class="op" id="6921774">,</span>&nbsp;<span class="ident" id="6921776">stmtQuery</span><span class="op" id="6921785">)</span><br>
<span class="lineno"></span><span class="op" id="6921787">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6921790">type</span>&nbsp;<span class="ident" id="6921795">concurrentTest</span>&nbsp;<span class="keyword" id="6921810">interface</span>&nbsp;<span class="op" id="6921820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6921823">init</span><span class="op" id="6921827">(</span><span class="ident" id="6921828">t</span>&nbsp;<span class="ident" id="6921830">testing</span><span class="op" id="6921837">.</span><span class="ident" id="6921838">TB</span><span class="op" id="6921840">,</span>&nbsp;<span class="ident" id="6921842">db</span>&nbsp;<span class="op" id="6921845">*</span><span class="ident" id="6921846">DB</span><span class="op" id="6921848">)</span><br>
<span class="lineno">1425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6921851">finish</span><span class="op" id="6921857">(</span><span class="ident" id="6921858">t</span>&nbsp;<span class="ident" id="6921860">testing</span><span class="op" id="6921867">.</span><span class="ident" id="6921868">TB</span><span class="op" id="6921870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6921873">test</span><span class="op" id="6921877">(</span><span class="ident" id="6921878">t</span>&nbsp;<span class="ident" id="6921880">testing</span><span class="op" id="6921887">.</span><span class="ident" id="6921888">TB</span><span class="op" id="6921890">)</span>&nbsp;<span class="builtintype" id="6921892">error</span><br>
<span class="lineno"></span><span class="op" id="6921898">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6921901">type</span>&nbsp;<span class="ident" id="6921906">concurrentDBQueryTest</span>&nbsp;<span class="keyword" id="6921928">struct</span>&nbsp;<span class="op" id="6921935">{</span><br>
<span class="lineno">1430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6921938">db</span>&nbsp;<span class="op" id="6921941">*</span><span class="ident" id="6921942">DB</span><br>
<span class="lineno"></span><span class="op" id="6921945">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6921948">func</span>&nbsp;<span class="op" id="6921953">(</span><span class="ident" id="6921954">c</span>&nbsp;<span class="op" id="6921956">*</span><span class="ident" id="6921957">concurrentDBQueryTest</span><span class="op" id="6921978">)</span>&nbsp;<span class="ident" id="6921980">init</span><span class="op" id="6921984">(</span><span class="ident" id="6921985">t</span>&nbsp;<span class="ident" id="6921987">testing</span><span class="op" id="6921994">.</span><span class="ident" id="6921995">TB</span><span class="op" id="6921997">,</span>&nbsp;<span class="ident" id="6921999">db</span>&nbsp;<span class="op" id="6922002">*</span><span class="ident" id="6922003">DB</span><span class="op" id="6922005">)</span>&nbsp;<span class="op" id="6922007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6922010">c</span><span class="op" id="6922011">.</span><span class="ident" id="6922012">db</span>&nbsp;<span class="op" id="6922015">=</span>&nbsp;<span class="ident" id="6922017">db</span><br>
<span class="lineno">1435</span><span class="op" id="6922020">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6922023">func</span>&nbsp;<span class="op" id="6922028">(</span><span class="ident" id="6922029">c</span>&nbsp;<span class="op" id="6922031">*</span><span class="ident" id="6922032">concurrentDBQueryTest</span><span class="op" id="6922053">)</span>&nbsp;<span class="ident" id="6922055">finish</span><span class="op" id="6922061">(</span><span class="ident" id="6922062">t</span>&nbsp;<span class="ident" id="6922064">testing</span><span class="op" id="6922071">.</span><span class="ident" id="6922072">TB</span><span class="op" id="6922074">)</span>&nbsp;<span class="op" id="6922076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6922079">c</span><span class="op" id="6922080">.</span><span class="ident" id="6922081">db</span>&nbsp;<span class="op" id="6922084">=</span>&nbsp;<span class="ident" id="6922086">nil</span><br>
<span class="lineno"></span><span class="op" id="6922090">}</span><br>
<span class="lineno">1440</span><br>
<span class="lineno"></span><span class="keyword" id="6922093">func</span>&nbsp;<span class="op" id="6922098">(</span><span class="ident" id="6922099">c</span>&nbsp;<span class="op" id="6922101">*</span><span class="ident" id="6922102">concurrentDBQueryTest</span><span class="op" id="6922123">)</span>&nbsp;<span class="ident" id="6922125">test</span><span class="op" id="6922129">(</span><span class="ident" id="6922130">t</span>&nbsp;<span class="ident" id="6922132">testing</span><span class="op" id="6922139">.</span><span class="ident" id="6922140">TB</span><span class="op" id="6922142">)</span>&nbsp;<span class="builtintype" id="6922144">error</span>&nbsp;<span class="op" id="6922150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6922153">rows</span><span class="op" id="6922157">,</span>&nbsp;<span class="ident" id="6922159">err</span>&nbsp;<span class="op" id="6922163">:=</span>&nbsp;<span class="ident" id="6922166">c</span><span class="op" id="6922167">.</span><span class="ident" id="6922168">db</span><span class="op" id="6922170">.</span><span class="ident" id="6922171">Query</span><span class="op" id="6922176">(</span><span class="string" id="6922177">&#34;SELECT|people|name|&#34;</span><span class="op" id="6922198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6922201">if</span>&nbsp;<span class="ident" id="6922204">err</span>&nbsp;<span class="op" id="6922208">!=</span>&nbsp;<span class="ident" id="6922211">nil</span>&nbsp;<span class="op" id="6922215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6922219">t</span><span class="op" id="6922220">.</span><span class="ident" id="6922221">Error</span><span class="op" id="6922226">(</span><span class="ident" id="6922227">err</span><span class="op" id="6922230">)</span><br>
<span class="lineno">1445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6922234">return</span>&nbsp;<span class="ident" id="6922241">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6922246">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6922249">var</span>&nbsp;<span class="ident" id="6922253">name</span>&nbsp;<span class="builtintype" id="6922258">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6922266">for</span>&nbsp;<span class="ident" id="6922270">rows</span><span class="op" id="6922274">.</span><span class="ident" id="6922275">Next</span><span class="op" id="6922279">(</span><span class="op" id="6922280">)</span>&nbsp;<span class="op" id="6922282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6922286">rows</span><span class="op" id="6922290">.</span><span class="ident" id="6922291">Scan</span><span class="op" id="6922295">(</span><span class="op" id="6922296">&amp;</span><span class="ident" id="6922297">name</span><span class="op" id="6922301">)</span><br>
<span class="lineno">1450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6922304">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6922307">rows</span><span class="op" id="6922311">.</span><span class="ident" id="6922312">Close</span><span class="op" id="6922317">(</span><span class="op" id="6922318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6922321">return</span>&nbsp;<span class="ident" id="6922328">nil</span><br>
<span class="lineno"></span><span class="op" id="6922332">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1455</span><span class="keyword" id="6922335">type</span>&nbsp;<span class="ident" id="6922340">concurrentDBExecTest</span>&nbsp;<span class="keyword" id="6922361">struct</span>&nbsp;<span class="op" id="6922368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6922371">db</span>&nbsp;<span class="op" id="6922374">*</span><span class="ident" id="6922375">DB</span><br>
<span class="lineno"></span><span class="op" id="6922378">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6922381">func</span>&nbsp;<span class="op" id="6922386">(</span><span class="ident" id="6922387">c</span>&nbsp;<span class="op" id="6922389">*</span><span class="ident" id="6922390">concurrentDBExecTest</span><span class="op" id="6922410">)</span>&nbsp;<span class="ident" id="6922412">init</span><span class="op" id="6922416">(</span><span class="ident" id="6922417">t</span>&nbsp;<span class="ident" id="6922419">testing</span><span class="op" id="6922426">.</span><span class="ident" id="6922427">TB</span><span class="op" id="6922429">,</span>&nbsp;<span class="ident" id="6922431">db</span>&nbsp;<span class="op" id="6922434">*</span><span class="ident" id="6922435">DB</span><span class="op" id="6922437">)</span>&nbsp;<span class="op" id="6922439">{</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6922442">c</span><span class="op" id="6922443">.</span><span class="ident" id="6922444">db</span>&nbsp;<span class="op" id="6922447">=</span>&nbsp;<span class="ident" id="6922449">db</span><br>
<span class="lineno"></span><span class="op" id="6922452">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6922455">func</span>&nbsp;<span class="op" id="6922460">(</span><span class="ident" id="6922461">c</span>&nbsp;<span class="op" id="6922463">*</span><span class="ident" id="6922464">concurrentDBExecTest</span><span class="op" id="6922484">)</span>&nbsp;<span class="ident" id="6922486">finish</span><span class="op" id="6922492">(</span><span class="ident" id="6922493">t</span>&nbsp;<span class="ident" id="6922495">testing</span><span class="op" id="6922502">.</span><span class="ident" id="6922503">TB</span><span class="op" id="6922505">)</span>&nbsp;<span class="op" id="6922507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6922510">c</span><span class="op" id="6922511">.</span><span class="ident" id="6922512">db</span>&nbsp;<span class="op" id="6922515">=</span>&nbsp;<span class="ident" id="6922517">nil</span><br>
<span class="lineno">1465</span><span class="op" id="6922521">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6922524">func</span>&nbsp;<span class="op" id="6922529">(</span><span class="ident" id="6922530">c</span>&nbsp;<span class="op" id="6922532">*</span><span class="ident" id="6922533">concurrentDBExecTest</span><span class="op" id="6922553">)</span>&nbsp;<span class="ident" id="6922555">test</span><span class="op" id="6922559">(</span><span class="ident" id="6922560">t</span>&nbsp;<span class="ident" id="6922562">testing</span><span class="op" id="6922569">.</span><span class="ident" id="6922570">TB</span><span class="op" id="6922572">)</span>&nbsp;<span class="builtintype" id="6922574">error</span>&nbsp;<span class="op" id="6922580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6922583">_</span><span class="op" id="6922584">,</span>&nbsp;<span class="ident" id="6922586">err</span>&nbsp;<span class="op" id="6922590">:=</span>&nbsp;<span class="ident" id="6922593">c</span><span class="op" id="6922594">.</span><span class="ident" id="6922595">db</span><span class="op" id="6922597">.</span><span class="ident" id="6922598">Exec</span><span class="op" id="6922602">(</span><span class="string" id="6922603">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="6922656">,</span>&nbsp;<span class="num" id="6922658">3</span><span class="op" id="6922659">,</span>&nbsp;<span class="ident" id="6922661">chrisBirthday</span><span class="op" id="6922674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6922677">if</span>&nbsp;<span class="ident" id="6922680">err</span>&nbsp;<span class="op" id="6922684">!=</span>&nbsp;<span class="ident" id="6922687">nil</span>&nbsp;<span class="op" id="6922691">{</span><br>
<span class="lineno">1470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6922695">t</span><span class="op" id="6922696">.</span><span class="ident" id="6922697">Error</span><span class="op" id="6922702">(</span><span class="ident" id="6922703">err</span><span class="op" id="6922706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6922710">return</span>&nbsp;<span class="ident" id="6922717">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6922722">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6922725">return</span>&nbsp;<span class="ident" id="6922732">nil</span><br>
<span class="lineno"></span><span class="op" id="6922736">}</span><br>
<span class="lineno">1475</span><br>
<span class="lineno"></span><span class="keyword" id="6922739">type</span>&nbsp;<span class="ident" id="6922744">concurrentStmtQueryTest</span>&nbsp;<span class="keyword" id="6922768">struct</span>&nbsp;<span class="op" id="6922775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6922778">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6922783">*</span><span class="ident" id="6922784">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6922788">stmt</span>&nbsp;<span class="op" id="6922793">*</span><span class="ident" id="6922794">Stmt</span><br>
<span class="lineno"></span><span class="op" id="6922799">}</span><br>
<span class="lineno">1480</span><br>
<span class="lineno"></span><span class="keyword" id="6922802">func</span>&nbsp;<span class="op" id="6922807">(</span><span class="ident" id="6922808">c</span>&nbsp;<span class="op" id="6922810">*</span><span class="ident" id="6922811">concurrentStmtQueryTest</span><span class="op" id="6922834">)</span>&nbsp;<span class="ident" id="6922836">init</span><span class="op" id="6922840">(</span><span class="ident" id="6922841">t</span>&nbsp;<span class="ident" id="6922843">testing</span><span class="op" id="6922850">.</span><span class="ident" id="6922851">TB</span><span class="op" id="6922853">,</span>&nbsp;<span class="ident" id="6922855">db</span>&nbsp;<span class="op" id="6922858">*</span><span class="ident" id="6922859">DB</span><span class="op" id="6922861">)</span>&nbsp;<span class="op" id="6922863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6922866">c</span><span class="op" id="6922867">.</span><span class="ident" id="6922868">db</span>&nbsp;<span class="op" id="6922871">=</span>&nbsp;<span class="ident" id="6922873">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6922877">var</span>&nbsp;<span class="ident" id="6922881">err</span>&nbsp;<span class="builtintype" id="6922885">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6922892">c</span><span class="op" id="6922893">.</span><span class="ident" id="6922894">stmt</span><span class="op" id="6922898">,</span>&nbsp;<span class="ident" id="6922900">err</span>&nbsp;<span class="op" id="6922904">=</span>&nbsp;<span class="ident" id="6922906">db</span><span class="op" id="6922908">.</span><span class="ident" id="6922909">Prepare</span><span class="op" id="6922916">(</span><span class="string" id="6922917">&#34;SELECT|people|name|&#34;</span><span class="op" id="6922938">)</span><br>
<span class="lineno">1485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6922941">if</span>&nbsp;<span class="ident" id="6922944">err</span>&nbsp;<span class="op" id="6922948">!=</span>&nbsp;<span class="ident" id="6922951">nil</span>&nbsp;<span class="op" id="6922955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6922959">t</span><span class="op" id="6922960">.</span><span class="ident" id="6922961">Fatal</span><span class="op" id="6922966">(</span><span class="ident" id="6922967">err</span><span class="op" id="6922970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6922973">}</span><br>
<span class="lineno"></span><span class="op" id="6922975">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1490</span><span class="keyword" id="6922978">func</span>&nbsp;<span class="op" id="6922983">(</span><span class="ident" id="6922984">c</span>&nbsp;<span class="op" id="6922986">*</span><span class="ident" id="6922987">concurrentStmtQueryTest</span><span class="op" id="6923010">)</span>&nbsp;<span class="ident" id="6923012">finish</span><span class="op" id="6923018">(</span><span class="ident" id="6923019">t</span>&nbsp;<span class="ident" id="6923021">testing</span><span class="op" id="6923028">.</span><span class="ident" id="6923029">TB</span><span class="op" id="6923031">)</span>&nbsp;<span class="op" id="6923033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6923036">if</span>&nbsp;<span class="ident" id="6923039">c</span><span class="op" id="6923040">.</span><span class="ident" id="6923041">stmt</span>&nbsp;<span class="op" id="6923046">!=</span>&nbsp;<span class="ident" id="6923049">nil</span>&nbsp;<span class="op" id="6923053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6923057">c</span><span class="op" id="6923058">.</span><span class="ident" id="6923059">stmt</span><span class="op" id="6923063">.</span><span class="ident" id="6923064">Close</span><span class="op" id="6923069">(</span><span class="op" id="6923070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6923074">c</span><span class="op" id="6923075">.</span><span class="ident" id="6923076">stmt</span>&nbsp;<span class="op" id="6923081">=</span>&nbsp;<span class="ident" id="6923083">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6923088">}</span><br>
<span class="lineno">1495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6923091">c</span><span class="op" id="6923092">.</span><span class="ident" id="6923093">db</span>&nbsp;<span class="op" id="6923096">=</span>&nbsp;<span class="ident" id="6923098">nil</span><br>
<span class="lineno"></span><span class="op" id="6923102">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6923105">func</span>&nbsp;<span class="op" id="6923110">(</span><span class="ident" id="6923111">c</span>&nbsp;<span class="op" id="6923113">*</span><span class="ident" id="6923114">concurrentStmtQueryTest</span><span class="op" id="6923137">)</span>&nbsp;<span class="ident" id="6923139">test</span><span class="op" id="6923143">(</span><span class="ident" id="6923144">t</span>&nbsp;<span class="ident" id="6923146">testing</span><span class="op" id="6923153">.</span><span class="ident" id="6923154">TB</span><span class="op" id="6923156">)</span>&nbsp;<span class="builtintype" id="6923158">error</span>&nbsp;<span class="op" id="6923164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6923167">rows</span><span class="op" id="6923171">,</span>&nbsp;<span class="ident" id="6923173">err</span>&nbsp;<span class="op" id="6923177">:=</span>&nbsp;<span class="ident" id="6923180">c</span><span class="op" id="6923181">.</span><span class="ident" id="6923182">stmt</span><span class="op" id="6923186">.</span><span class="ident" id="6923187">Query</span><span class="op" id="6923192">(</span><span class="op" id="6923193">)</span><br>
<span class="lineno">1500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6923196">if</span>&nbsp;<span class="ident" id="6923199">err</span>&nbsp;<span class="op" id="6923203">!=</span>&nbsp;<span class="ident" id="6923206">nil</span>&nbsp;<span class="op" id="6923210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6923214">t</span><span class="op" id="6923215">.</span><span class="ident" id="6923216">Errorf</span><span class="op" id="6923222">(</span><span class="string" id="6923223">&#34;error&nbsp;on&nbsp;query:&nbsp;&nbsp;%v&#34;</span><span class="op" id="6923244">,</span>&nbsp;<span class="ident" id="6923246">err</span><span class="op" id="6923249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6923253">return</span>&nbsp;<span class="ident" id="6923260">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6923265">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6923269">var</span>&nbsp;<span class="ident" id="6923273">name</span>&nbsp;<span class="builtintype" id="6923278">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6923286">for</span>&nbsp;<span class="ident" id="6923290">rows</span><span class="op" id="6923294">.</span><span class="ident" id="6923295">Next</span><span class="op" id="6923299">(</span><span class="op" id="6923300">)</span>&nbsp;<span class="op" id="6923302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6923306">rows</span><span class="op" id="6923310">.</span><span class="ident" id="6923311">Scan</span><span class="op" id="6923315">(</span><span class="op" id="6923316">&amp;</span><span class="ident" id="6923317">name</span><span class="op" id="6923321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6923324">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6923327">rows</span><span class="op" id="6923331">.</span><span class="ident" id="6923332">Close</span><span class="op" id="6923337">(</span><span class="op" id="6923338">)</span><br>
<span class="lineno">1510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6923341">return</span>&nbsp;<span class="ident" id="6923348">nil</span><br>
<span class="lineno"></span><span class="op" id="6923352">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6923355">type</span>&nbsp;<span class="ident" id="6923360">concurrentStmtExecTest</span>&nbsp;<span class="keyword" id="6923383">struct</span>&nbsp;<span class="op" id="6923390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6923393">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6923398">*</span><span class="ident" id="6923399">DB</span><br>
<span class="lineno">1515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6923403">stmt</span>&nbsp;<span class="op" id="6923408">*</span><span class="ident" id="6923409">Stmt</span><br>
<span class="lineno"></span><span class="op" id="6923414">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6923417">func</span>&nbsp;<span class="op" id="6923422">(</span><span class="ident" id="6923423">c</span>&nbsp;<span class="op" id="6923425">*</span><span class="ident" id="6923426">concurrentStmtExecTest</span><span class="op" id="6923448">)</span>&nbsp;<span class="ident" id="6923450">init</span><span class="op" id="6923454">(</span><span class="ident" id="6923455">t</span>&nbsp;<span class="ident" id="6923457">testing</span><span class="op" id="6923464">.</span><span class="ident" id="6923465">TB</span><span class="op" id="6923467">,</span>&nbsp;<span class="ident" id="6923469">db</span>&nbsp;<span class="op" id="6923472">*</span><span class="ident" id="6923473">DB</span><span class="op" id="6923475">)</span>&nbsp;<span class="op" id="6923477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6923480">c</span><span class="op" id="6923481">.</span><span class="ident" id="6923482">db</span>&nbsp;<span class="op" id="6923485">=</span>&nbsp;<span class="ident" id="6923487">db</span><br>
<span class="lineno">1520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6923491">var</span>&nbsp;<span class="ident" id="6923495">err</span>&nbsp;<span class="builtintype" id="6923499">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6923506">c</span><span class="op" id="6923507">.</span><span class="ident" id="6923508">stmt</span><span class="op" id="6923512">,</span>&nbsp;<span class="ident" id="6923514">err</span>&nbsp;<span class="op" id="6923518">=</span>&nbsp;<span class="ident" id="6923520">db</span><span class="op" id="6923522">.</span><span class="ident" id="6923523">Prepare</span><span class="op" id="6923530">(</span><span class="string" id="6923531">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="6923584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6923587">if</span>&nbsp;<span class="ident" id="6923590">err</span>&nbsp;<span class="op" id="6923594">!=</span>&nbsp;<span class="ident" id="6923597">nil</span>&nbsp;<span class="op" id="6923601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6923605">t</span><span class="op" id="6923606">.</span><span class="ident" id="6923607">Fatal</span><span class="op" id="6923612">(</span><span class="ident" id="6923613">err</span><span class="op" id="6923616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6923619">}</span><br>
<span class="lineno">1525</span><span class="op" id="6923621">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6923624">func</span>&nbsp;<span class="op" id="6923629">(</span><span class="ident" id="6923630">c</span>&nbsp;<span class="op" id="6923632">*</span><span class="ident" id="6923633">concurrentStmtExecTest</span><span class="op" id="6923655">)</span>&nbsp;<span class="ident" id="6923657">finish</span><span class="op" id="6923663">(</span><span class="ident" id="6923664">t</span>&nbsp;<span class="ident" id="6923666">testing</span><span class="op" id="6923673">.</span><span class="ident" id="6923674">TB</span><span class="op" id="6923676">)</span>&nbsp;<span class="op" id="6923678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6923681">if</span>&nbsp;<span class="ident" id="6923684">c</span><span class="op" id="6923685">.</span><span class="ident" id="6923686">stmt</span>&nbsp;<span class="op" id="6923691">!=</span>&nbsp;<span class="ident" id="6923694">nil</span>&nbsp;<span class="op" id="6923698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6923702">c</span><span class="op" id="6923703">.</span><span class="ident" id="6923704">stmt</span><span class="op" id="6923708">.</span><span class="ident" id="6923709">Close</span><span class="op" id="6923714">(</span><span class="op" id="6923715">)</span><br>
<span class="lineno">1530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6923719">c</span><span class="op" id="6923720">.</span><span class="ident" id="6923721">stmt</span>&nbsp;<span class="op" id="6923726">=</span>&nbsp;<span class="ident" id="6923728">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6923733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6923736">c</span><span class="op" id="6923737">.</span><span class="ident" id="6923738">db</span>&nbsp;<span class="op" id="6923741">=</span>&nbsp;<span class="ident" id="6923743">nil</span><br>
<span class="lineno"></span><span class="op" id="6923747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1535</span><span class="keyword" id="6923750">func</span>&nbsp;<span class="op" id="6923755">(</span><span class="ident" id="6923756">c</span>&nbsp;<span class="op" id="6923758">*</span><span class="ident" id="6923759">concurrentStmtExecTest</span><span class="op" id="6923781">)</span>&nbsp;<span class="ident" id="6923783">test</span><span class="op" id="6923787">(</span><span class="ident" id="6923788">t</span>&nbsp;<span class="ident" id="6923790">testing</span><span class="op" id="6923797">.</span><span class="ident" id="6923798">TB</span><span class="op" id="6923800">)</span>&nbsp;<span class="builtintype" id="6923802">error</span>&nbsp;<span class="op" id="6923808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6923811">_</span><span class="op" id="6923812">,</span>&nbsp;<span class="ident" id="6923814">err</span>&nbsp;<span class="op" id="6923818">:=</span>&nbsp;<span class="ident" id="6923821">c</span><span class="op" id="6923822">.</span><span class="ident" id="6923823">stmt</span><span class="op" id="6923827">.</span><span class="ident" id="6923828">Exec</span><span class="op" id="6923832">(</span><span class="num" id="6923833">3</span><span class="op" id="6923834">,</span>&nbsp;<span class="ident" id="6923836">chrisBirthday</span><span class="op" id="6923849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6923852">if</span>&nbsp;<span class="ident" id="6923855">err</span>&nbsp;<span class="op" id="6923859">!=</span>&nbsp;<span class="ident" id="6923862">nil</span>&nbsp;<span class="op" id="6923866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6923870">t</span><span class="op" id="6923871">.</span><span class="ident" id="6923872">Errorf</span><span class="op" id="6923878">(</span><span class="string" id="6923879">&#34;error&nbsp;on&nbsp;exec:&nbsp;&nbsp;%v&#34;</span><span class="op" id="6923899">,</span>&nbsp;<span class="ident" id="6923901">err</span><span class="op" id="6923904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6923908">return</span>&nbsp;<span class="ident" id="6923915">err</span><br>
<span class="lineno">1540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6923920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6923923">return</span>&nbsp;<span class="ident" id="6923930">nil</span><br>
<span class="lineno"></span><span class="op" id="6923934">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6923937">type</span>&nbsp;<span class="ident" id="6923942">concurrentTxQueryTest</span>&nbsp;<span class="keyword" id="6923964">struct</span>&nbsp;<span class="op" id="6923971">{</span><br>
<span class="lineno">1545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6923974">db</span>&nbsp;<span class="op" id="6923977">*</span><span class="ident" id="6923978">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6923982">tx</span>&nbsp;<span class="op" id="6923985">*</span><span class="ident" id="6923986">Tx</span><br>
<span class="lineno"></span><span class="op" id="6923989">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6923992">func</span>&nbsp;<span class="op" id="6923997">(</span><span class="ident" id="6923998">c</span>&nbsp;<span class="op" id="6924000">*</span><span class="ident" id="6924001">concurrentTxQueryTest</span><span class="op" id="6924022">)</span>&nbsp;<span class="ident" id="6924024">init</span><span class="op" id="6924028">(</span><span class="ident" id="6924029">t</span>&nbsp;<span class="ident" id="6924031">testing</span><span class="op" id="6924038">.</span><span class="ident" id="6924039">TB</span><span class="op" id="6924041">,</span>&nbsp;<span class="ident" id="6924043">db</span>&nbsp;<span class="op" id="6924046">*</span><span class="ident" id="6924047">DB</span><span class="op" id="6924049">)</span>&nbsp;<span class="op" id="6924051">{</span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6924054">c</span><span class="op" id="6924055">.</span><span class="ident" id="6924056">db</span>&nbsp;<span class="op" id="6924059">=</span>&nbsp;<span class="ident" id="6924061">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6924065">var</span>&nbsp;<span class="ident" id="6924069">err</span>&nbsp;<span class="builtintype" id="6924073">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6924080">c</span><span class="op" id="6924081">.</span><span class="ident" id="6924082">tx</span><span class="op" id="6924084">,</span>&nbsp;<span class="ident" id="6924086">err</span>&nbsp;<span class="op" id="6924090">=</span>&nbsp;<span class="ident" id="6924092">c</span><span class="op" id="6924093">.</span><span class="ident" id="6924094">db</span><span class="op" id="6924096">.</span><span class="ident" id="6924097">Begin</span><span class="op" id="6924102">(</span><span class="op" id="6924103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6924106">if</span>&nbsp;<span class="ident" id="6924109">err</span>&nbsp;<span class="op" id="6924113">!=</span>&nbsp;<span class="ident" id="6924116">nil</span>&nbsp;<span class="op" id="6924120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6924124">t</span><span class="op" id="6924125">.</span><span class="ident" id="6924126">Fatal</span><span class="op" id="6924131">(</span><span class="ident" id="6924132">err</span><span class="op" id="6924135">)</span><br>
<span class="lineno">1555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6924138">}</span><br>
<span class="lineno"></span><span class="op" id="6924140">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6924143">func</span>&nbsp;<span class="op" id="6924148">(</span><span class="ident" id="6924149">c</span>&nbsp;<span class="op" id="6924151">*</span><span class="ident" id="6924152">concurrentTxQueryTest</span><span class="op" id="6924173">)</span>&nbsp;<span class="ident" id="6924175">finish</span><span class="op" id="6924181">(</span><span class="ident" id="6924182">t</span>&nbsp;<span class="ident" id="6924184">testing</span><span class="op" id="6924191">.</span><span class="ident" id="6924192">TB</span><span class="op" id="6924194">)</span>&nbsp;<span class="op" id="6924196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6924199">if</span>&nbsp;<span class="ident" id="6924202">c</span><span class="op" id="6924203">.</span><span class="ident" id="6924204">tx</span>&nbsp;<span class="op" id="6924207">!=</span>&nbsp;<span class="ident" id="6924210">nil</span>&nbsp;<span class="op" id="6924214">{</span><br>
<span class="lineno">1560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6924218">c</span><span class="op" id="6924219">.</span><span class="ident" id="6924220">tx</span><span class="op" id="6924222">.</span><span class="ident" id="6924223">Rollback</span><span class="op" id="6924231">(</span><span class="op" id="6924232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6924236">c</span><span class="op" id="6924237">.</span><span class="ident" id="6924238">tx</span>&nbsp;<span class="op" id="6924241">=</span>&nbsp;<span class="ident" id="6924243">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6924248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6924251">c</span><span class="op" id="6924252">.</span><span class="ident" id="6924253">db</span>&nbsp;<span class="op" id="6924256">=</span>&nbsp;<span class="ident" id="6924258">nil</span><br>
<span class="lineno"></span><span class="op" id="6924262">}</span><br>
<span class="lineno">1565</span><br>
<span class="lineno"></span><span class="keyword" id="6924265">func</span>&nbsp;<span class="op" id="6924270">(</span><span class="ident" id="6924271">c</span>&nbsp;<span class="op" id="6924273">*</span><span class="ident" id="6924274">concurrentTxQueryTest</span><span class="op" id="6924295">)</span>&nbsp;<span class="ident" id="6924297">test</span><span class="op" id="6924301">(</span><span class="ident" id="6924302">t</span>&nbsp;<span class="ident" id="6924304">testing</span><span class="op" id="6924311">.</span><span class="ident" id="6924312">TB</span><span class="op" id="6924314">)</span>&nbsp;<span class="builtintype" id="6924316">error</span>&nbsp;<span class="op" id="6924322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6924325">rows</span><span class="op" id="6924329">,</span>&nbsp;<span class="ident" id="6924331">err</span>&nbsp;<span class="op" id="6924335">:=</span>&nbsp;<span class="ident" id="6924338">c</span><span class="op" id="6924339">.</span><span class="ident" id="6924340">db</span><span class="op" id="6924342">.</span><span class="ident" id="6924343">Query</span><span class="op" id="6924348">(</span><span class="string" id="6924349">&#34;SELECT|people|name|&#34;</span><span class="op" id="6924370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6924373">if</span>&nbsp;<span class="ident" id="6924376">err</span>&nbsp;<span class="op" id="6924380">!=</span>&nbsp;<span class="ident" id="6924383">nil</span>&nbsp;<span class="op" id="6924387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6924391">t</span><span class="op" id="6924392">.</span><span class="ident" id="6924393">Error</span><span class="op" id="6924398">(</span><span class="ident" id="6924399">err</span><span class="op" id="6924402">)</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6924406">return</span>&nbsp;<span class="ident" id="6924413">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6924418">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6924421">var</span>&nbsp;<span class="ident" id="6924425">name</span>&nbsp;<span class="builtintype" id="6924430">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6924438">for</span>&nbsp;<span class="ident" id="6924442">rows</span><span class="op" id="6924446">.</span><span class="ident" id="6924447">Next</span><span class="op" id="6924451">(</span><span class="op" id="6924452">)</span>&nbsp;<span class="op" id="6924454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6924458">rows</span><span class="op" id="6924462">.</span><span class="ident" id="6924463">Scan</span><span class="op" id="6924467">(</span><span class="op" id="6924468">&amp;</span><span class="ident" id="6924469">name</span><span class="op" id="6924473">)</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6924476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6924479">rows</span><span class="op" id="6924483">.</span><span class="ident" id="6924484">Close</span><span class="op" id="6924489">(</span><span class="op" id="6924490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6924493">return</span>&nbsp;<span class="ident" id="6924500">nil</span><br>
<span class="lineno"></span><span class="op" id="6924504">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1580</span><span class="keyword" id="6924507">type</span>&nbsp;<span class="ident" id="6924512">concurrentTxExecTest</span>&nbsp;<span class="keyword" id="6924533">struct</span>&nbsp;<span class="op" id="6924540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6924543">db</span>&nbsp;<span class="op" id="6924546">*</span><span class="ident" id="6924547">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6924551">tx</span>&nbsp;<span class="op" id="6924554">*</span><span class="ident" id="6924555">Tx</span><br>
<span class="lineno"></span><span class="op" id="6924558">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1585</span><span class="keyword" id="6924561">func</span>&nbsp;<span class="op" id="6924566">(</span><span class="ident" id="6924567">c</span>&nbsp;<span class="op" id="6924569">*</span><span class="ident" id="6924570">concurrentTxExecTest</span><span class="op" id="6924590">)</span>&nbsp;<span class="ident" id="6924592">init</span><span class="op" id="6924596">(</span><span class="ident" id="6924597">t</span>&nbsp;<span class="ident" id="6924599">testing</span><span class="op" id="6924606">.</span><span class="ident" id="6924607">TB</span><span class="op" id="6924609">,</span>&nbsp;<span class="ident" id="6924611">db</span>&nbsp;<span class="op" id="6924614">*</span><span class="ident" id="6924615">DB</span><span class="op" id="6924617">)</span>&nbsp;<span class="op" id="6924619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6924622">c</span><span class="op" id="6924623">.</span><span class="ident" id="6924624">db</span>&nbsp;<span class="op" id="6924627">=</span>&nbsp;<span class="ident" id="6924629">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6924633">var</span>&nbsp;<span class="ident" id="6924637">err</span>&nbsp;<span class="builtintype" id="6924641">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6924648">c</span><span class="op" id="6924649">.</span><span class="ident" id="6924650">tx</span><span class="op" id="6924652">,</span>&nbsp;<span class="ident" id="6924654">err</span>&nbsp;<span class="op" id="6924658">=</span>&nbsp;<span class="ident" id="6924660">c</span><span class="op" id="6924661">.</span><span class="ident" id="6924662">db</span><span class="op" id="6924664">.</span><span class="ident" id="6924665">Begin</span><span class="op" id="6924670">(</span><span class="op" id="6924671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6924674">if</span>&nbsp;<span class="ident" id="6924677">err</span>&nbsp;<span class="op" id="6924681">!=</span>&nbsp;<span class="ident" id="6924684">nil</span>&nbsp;<span class="op" id="6924688">{</span><br>
<span class="lineno">1590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6924692">t</span><span class="op" id="6924693">.</span><span class="ident" id="6924694">Fatal</span><span class="op" id="6924699">(</span><span class="ident" id="6924700">err</span><span class="op" id="6924703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6924706">}</span><br>
<span class="lineno"></span><span class="op" id="6924708">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6924711">func</span>&nbsp;<span class="op" id="6924716">(</span><span class="ident" id="6924717">c</span>&nbsp;<span class="op" id="6924719">*</span><span class="ident" id="6924720">concurrentTxExecTest</span><span class="op" id="6924740">)</span>&nbsp;<span class="ident" id="6924742">finish</span><span class="op" id="6924748">(</span><span class="ident" id="6924749">t</span>&nbsp;<span class="ident" id="6924751">testing</span><span class="op" id="6924758">.</span><span class="ident" id="6924759">TB</span><span class="op" id="6924761">)</span>&nbsp;<span class="op" id="6924763">{</span><br>
<span class="lineno">1595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6924766">if</span>&nbsp;<span class="ident" id="6924769">c</span><span class="op" id="6924770">.</span><span class="ident" id="6924771">tx</span>&nbsp;<span class="op" id="6924774">!=</span>&nbsp;<span class="ident" id="6924777">nil</span>&nbsp;<span class="op" id="6924781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6924785">c</span><span class="op" id="6924786">.</span><span class="ident" id="6924787">tx</span><span class="op" id="6924789">.</span><span class="ident" id="6924790">Rollback</span><span class="op" id="6924798">(</span><span class="op" id="6924799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6924803">c</span><span class="op" id="6924804">.</span><span class="ident" id="6924805">tx</span>&nbsp;<span class="op" id="6924808">=</span>&nbsp;<span class="ident" id="6924810">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6924815">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6924818">c</span><span class="op" id="6924819">.</span><span class="ident" id="6924820">db</span>&nbsp;<span class="op" id="6924823">=</span>&nbsp;<span class="ident" id="6924825">nil</span><br>
<span class="lineno">1600</span><span class="op" id="6924829">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6924832">func</span>&nbsp;<span class="op" id="6924837">(</span><span class="ident" id="6924838">c</span>&nbsp;<span class="op" id="6924840">*</span><span class="ident" id="6924841">concurrentTxExecTest</span><span class="op" id="6924861">)</span>&nbsp;<span class="ident" id="6924863">test</span><span class="op" id="6924867">(</span><span class="ident" id="6924868">t</span>&nbsp;<span class="ident" id="6924870">testing</span><span class="op" id="6924877">.</span><span class="ident" id="6924878">TB</span><span class="op" id="6924880">)</span>&nbsp;<span class="builtintype" id="6924882">error</span>&nbsp;<span class="op" id="6924888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6924891">_</span><span class="op" id="6924892">,</span>&nbsp;<span class="ident" id="6924894">err</span>&nbsp;<span class="op" id="6924898">:=</span>&nbsp;<span class="ident" id="6924901">c</span><span class="op" id="6924902">.</span><span class="ident" id="6924903">tx</span><span class="op" id="6924905">.</span><span class="ident" id="6924906">Exec</span><span class="op" id="6924910">(</span><span class="string" id="6924911">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="6924964">,</span>&nbsp;<span class="num" id="6924966">3</span><span class="op" id="6924967">,</span>&nbsp;<span class="ident" id="6924969">chrisBirthday</span><span class="op" id="6924982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6924985">if</span>&nbsp;<span class="ident" id="6924988">err</span>&nbsp;<span class="op" id="6924992">!=</span>&nbsp;<span class="ident" id="6924995">nil</span>&nbsp;<span class="op" id="6924999">{</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6925003">t</span><span class="op" id="6925004">.</span><span class="ident" id="6925005">Error</span><span class="op" id="6925010">(</span><span class="ident" id="6925011">err</span><span class="op" id="6925014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6925018">return</span>&nbsp;<span class="ident" id="6925025">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6925030">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6925033">return</span>&nbsp;<span class="ident" id="6925040">nil</span><br>
<span class="lineno"></span><span class="op" id="6925044">}</span><br>
<span class="lineno">1610</span><br>
<span class="lineno"></span><span class="keyword" id="6925047">type</span>&nbsp;<span class="ident" id="6925052">concurrentTxStmtQueryTest</span>&nbsp;<span class="keyword" id="6925078">struct</span>&nbsp;<span class="op" id="6925085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6925088">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6925093">*</span><span class="ident" id="6925094">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6925098">tx</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6925103">*</span><span class="ident" id="6925104">Tx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6925108">stmt</span>&nbsp;<span class="op" id="6925113">*</span><span class="ident" id="6925114">Stmt</span><br>
<span class="lineno">1615</span><span class="op" id="6925119">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6925122">func</span>&nbsp;<span class="op" id="6925127">(</span><span class="ident" id="6925128">c</span>&nbsp;<span class="op" id="6925130">*</span><span class="ident" id="6925131">concurrentTxStmtQueryTest</span><span class="op" id="6925156">)</span>&nbsp;<span class="ident" id="6925158">init</span><span class="op" id="6925162">(</span><span class="ident" id="6925163">t</span>&nbsp;<span class="ident" id="6925165">testing</span><span class="op" id="6925172">.</span><span class="ident" id="6925173">TB</span><span class="op" id="6925175">,</span>&nbsp;<span class="ident" id="6925177">db</span>&nbsp;<span class="op" id="6925180">*</span><span class="ident" id="6925181">DB</span><span class="op" id="6925183">)</span>&nbsp;<span class="op" id="6925185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6925188">c</span><span class="op" id="6925189">.</span><span class="ident" id="6925190">db</span>&nbsp;<span class="op" id="6925193">=</span>&nbsp;<span class="ident" id="6925195">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6925199">var</span>&nbsp;<span class="ident" id="6925203">err</span>&nbsp;<span class="builtintype" id="6925207">error</span><br>
<span class="lineno">1620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6925214">c</span><span class="op" id="6925215">.</span><span class="ident" id="6925216">tx</span><span class="op" id="6925218">,</span>&nbsp;<span class="ident" id="6925220">err</span>&nbsp;<span class="op" id="6925224">=</span>&nbsp;<span class="ident" id="6925226">c</span><span class="op" id="6925227">.</span><span class="ident" id="6925228">db</span><span class="op" id="6925230">.</span><span class="ident" id="6925231">Begin</span><span class="op" id="6925236">(</span><span class="op" id="6925237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6925240">if</span>&nbsp;<span class="ident" id="6925243">err</span>&nbsp;<span class="op" id="6925247">!=</span>&nbsp;<span class="ident" id="6925250">nil</span>&nbsp;<span class="op" id="6925254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6925258">t</span><span class="op" id="6925259">.</span><span class="ident" id="6925260">Fatal</span><span class="op" id="6925265">(</span><span class="ident" id="6925266">err</span><span class="op" id="6925269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6925272">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6925275">c</span><span class="op" id="6925276">.</span><span class="ident" id="6925277">stmt</span><span class="op" id="6925281">,</span>&nbsp;<span class="ident" id="6925283">err</span>&nbsp;<span class="op" id="6925287">=</span>&nbsp;<span class="ident" id="6925289">c</span><span class="op" id="6925290">.</span><span class="ident" id="6925291">tx</span><span class="op" id="6925293">.</span><span class="ident" id="6925294">Prepare</span><span class="op" id="6925301">(</span><span class="string" id="6925302">&#34;SELECT|people|name|&#34;</span><span class="op" id="6925323">)</span><br>
<span class="lineno">1625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6925326">if</span>&nbsp;<span class="ident" id="6925329">err</span>&nbsp;<span class="op" id="6925333">!=</span>&nbsp;<span class="ident" id="6925336">nil</span>&nbsp;<span class="op" id="6925340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6925344">t</span><span class="op" id="6925345">.</span><span class="ident" id="6925346">Fatal</span><span class="op" id="6925351">(</span><span class="ident" id="6925352">err</span><span class="op" id="6925355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6925358">}</span><br>
<span class="lineno"></span><span class="op" id="6925360">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1630</span><span class="keyword" id="6925363">func</span>&nbsp;<span class="op" id="6925368">(</span><span class="ident" id="6925369">c</span>&nbsp;<span class="op" id="6925371">*</span><span class="ident" id="6925372">concurrentTxStmtQueryTest</span><span class="op" id="6925397">)</span>&nbsp;<span class="ident" id="6925399">finish</span><span class="op" id="6925405">(</span><span class="ident" id="6925406">t</span>&nbsp;<span class="ident" id="6925408">testing</span><span class="op" id="6925415">.</span><span class="ident" id="6925416">TB</span><span class="op" id="6925418">)</span>&nbsp;<span class="op" id="6925420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6925423">if</span>&nbsp;<span class="ident" id="6925426">c</span><span class="op" id="6925427">.</span><span class="ident" id="6925428">stmt</span>&nbsp;<span class="op" id="6925433">!=</span>&nbsp;<span class="ident" id="6925436">nil</span>&nbsp;<span class="op" id="6925440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6925444">c</span><span class="op" id="6925445">.</span><span class="ident" id="6925446">stmt</span><span class="op" id="6925450">.</span><span class="ident" id="6925451">Close</span><span class="op" id="6925456">(</span><span class="op" id="6925457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6925461">c</span><span class="op" id="6925462">.</span><span class="ident" id="6925463">stmt</span>&nbsp;<span class="op" id="6925468">=</span>&nbsp;<span class="ident" id="6925470">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6925475">}</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6925478">if</span>&nbsp;<span class="ident" id="6925481">c</span><span class="op" id="6925482">.</span><span class="ident" id="6925483">tx</span>&nbsp;<span class="op" id="6925486">!=</span>&nbsp;<span class="ident" id="6925489">nil</span>&nbsp;<span class="op" id="6925493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6925497">c</span><span class="op" id="6925498">.</span><span class="ident" id="6925499">tx</span><span class="op" id="6925501">.</span><span class="ident" id="6925502">Rollback</span><span class="op" id="6925510">(</span><span class="op" id="6925511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6925515">c</span><span class="op" id="6925516">.</span><span class="ident" id="6925517">tx</span>&nbsp;<span class="op" id="6925520">=</span>&nbsp;<span class="ident" id="6925522">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6925527">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6925530">c</span><span class="op" id="6925531">.</span><span class="ident" id="6925532">db</span>&nbsp;<span class="op" id="6925535">=</span>&nbsp;<span class="ident" id="6925537">nil</span><br>
<span class="lineno">1640</span><span class="op" id="6925541">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6925544">func</span>&nbsp;<span class="op" id="6925549">(</span><span class="ident" id="6925550">c</span>&nbsp;<span class="op" id="6925552">*</span><span class="ident" id="6925553">concurrentTxStmtQueryTest</span><span class="op" id="6925578">)</span>&nbsp;<span class="ident" id="6925580">test</span><span class="op" id="6925584">(</span><span class="ident" id="6925585">t</span>&nbsp;<span class="ident" id="6925587">testing</span><span class="op" id="6925594">.</span><span class="ident" id="6925595">TB</span><span class="op" id="6925597">)</span>&nbsp;<span class="builtintype" id="6925599">error</span>&nbsp;<span class="op" id="6925605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6925608">rows</span><span class="op" id="6925612">,</span>&nbsp;<span class="ident" id="6925614">err</span>&nbsp;<span class="op" id="6925618">:=</span>&nbsp;<span class="ident" id="6925621">c</span><span class="op" id="6925622">.</span><span class="ident" id="6925623">stmt</span><span class="op" id="6925627">.</span><span class="ident" id="6925628">Query</span><span class="op" id="6925633">(</span><span class="op" id="6925634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6925637">if</span>&nbsp;<span class="ident" id="6925640">err</span>&nbsp;<span class="op" id="6925644">!=</span>&nbsp;<span class="ident" id="6925647">nil</span>&nbsp;<span class="op" id="6925651">{</span><br>
<span class="lineno">1645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6925655">t</span><span class="op" id="6925656">.</span><span class="ident" id="6925657">Errorf</span><span class="op" id="6925663">(</span><span class="string" id="6925664">&#34;error&nbsp;on&nbsp;query:&nbsp;&nbsp;%v&#34;</span><span class="op" id="6925685">,</span>&nbsp;<span class="ident" id="6925687">err</span><span class="op" id="6925690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6925694">return</span>&nbsp;<span class="ident" id="6925701">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6925706">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6925710">var</span>&nbsp;<span class="ident" id="6925714">name</span>&nbsp;<span class="builtintype" id="6925719">string</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6925727">for</span>&nbsp;<span class="ident" id="6925731">rows</span><span class="op" id="6925735">.</span><span class="ident" id="6925736">Next</span><span class="op" id="6925740">(</span><span class="op" id="6925741">)</span>&nbsp;<span class="op" id="6925743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6925747">rows</span><span class="op" id="6925751">.</span><span class="ident" id="6925752">Scan</span><span class="op" id="6925756">(</span><span class="op" id="6925757">&amp;</span><span class="ident" id="6925758">name</span><span class="op" id="6925762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6925765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6925768">rows</span><span class="op" id="6925772">.</span><span class="ident" id="6925773">Close</span><span class="op" id="6925778">(</span><span class="op" id="6925779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6925782">return</span>&nbsp;<span class="ident" id="6925789">nil</span><br>
<span class="lineno">1655</span><span class="op" id="6925793">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6925796">type</span>&nbsp;<span class="ident" id="6925801">concurrentTxStmtExecTest</span>&nbsp;<span class="keyword" id="6925826">struct</span>&nbsp;<span class="op" id="6925833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6925836">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6925841">*</span><span class="ident" id="6925842">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6925846">tx</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6925851">*</span><span class="ident" id="6925852">Tx</span><br>
<span class="lineno">1660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6925856">stmt</span>&nbsp;<span class="op" id="6925861">*</span><span class="ident" id="6925862">Stmt</span><br>
<span class="lineno"></span><span class="op" id="6925867">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6925870">func</span>&nbsp;<span class="op" id="6925875">(</span><span class="ident" id="6925876">c</span>&nbsp;<span class="op" id="6925878">*</span><span class="ident" id="6925879">concurrentTxStmtExecTest</span><span class="op" id="6925903">)</span>&nbsp;<span class="ident" id="6925905">init</span><span class="op" id="6925909">(</span><span class="ident" id="6925910">t</span>&nbsp;<span class="ident" id="6925912">testing</span><span class="op" id="6925919">.</span><span class="ident" id="6925920">TB</span><span class="op" id="6925922">,</span>&nbsp;<span class="ident" id="6925924">db</span>&nbsp;<span class="op" id="6925927">*</span><span class="ident" id="6925928">DB</span><span class="op" id="6925930">)</span>&nbsp;<span class="op" id="6925932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6925935">c</span><span class="op" id="6925936">.</span><span class="ident" id="6925937">db</span>&nbsp;<span class="op" id="6925940">=</span>&nbsp;<span class="ident" id="6925942">db</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6925946">var</span>&nbsp;<span class="ident" id="6925950">err</span>&nbsp;<span class="builtintype" id="6925954">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6925961">c</span><span class="op" id="6925962">.</span><span class="ident" id="6925963">tx</span><span class="op" id="6925965">,</span>&nbsp;<span class="ident" id="6925967">err</span>&nbsp;<span class="op" id="6925971">=</span>&nbsp;<span class="ident" id="6925973">c</span><span class="op" id="6925974">.</span><span class="ident" id="6925975">db</span><span class="op" id="6925977">.</span><span class="ident" id="6925978">Begin</span><span class="op" id="6925983">(</span><span class="op" id="6925984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6925987">if</span>&nbsp;<span class="ident" id="6925990">err</span>&nbsp;<span class="op" id="6925994">!=</span>&nbsp;<span class="ident" id="6925997">nil</span>&nbsp;<span class="op" id="6926001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6926005">t</span><span class="op" id="6926006">.</span><span class="ident" id="6926007">Fatal</span><span class="op" id="6926012">(</span><span class="ident" id="6926013">err</span><span class="op" id="6926016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6926019">}</span><br>
<span class="lineno">1670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6926022">c</span><span class="op" id="6926023">.</span><span class="ident" id="6926024">stmt</span><span class="op" id="6926028">,</span>&nbsp;<span class="ident" id="6926030">err</span>&nbsp;<span class="op" id="6926034">=</span>&nbsp;<span class="ident" id="6926036">c</span><span class="op" id="6926037">.</span><span class="ident" id="6926038">tx</span><span class="op" id="6926040">.</span><span class="ident" id="6926041">Prepare</span><span class="op" id="6926048">(</span><span class="string" id="6926049">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="6926102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6926105">if</span>&nbsp;<span class="ident" id="6926108">err</span>&nbsp;<span class="op" id="6926112">!=</span>&nbsp;<span class="ident" id="6926115">nil</span>&nbsp;<span class="op" id="6926119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6926123">t</span><span class="op" id="6926124">.</span><span class="ident" id="6926125">Fatal</span><span class="op" id="6926130">(</span><span class="ident" id="6926131">err</span><span class="op" id="6926134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6926137">}</span><br>
<span class="lineno"></span><span class="op" id="6926139">}</span><br>
<span class="lineno">1675</span><br>
<span class="lineno"></span><span class="keyword" id="6926142">func</span>&nbsp;<span class="op" id="6926147">(</span><span class="ident" id="6926148">c</span>&nbsp;<span class="op" id="6926150">*</span><span class="ident" id="6926151">concurrentTxStmtExecTest</span><span class="op" id="6926175">)</span>&nbsp;<span class="ident" id="6926177">finish</span><span class="op" id="6926183">(</span><span class="ident" id="6926184">t</span>&nbsp;<span class="ident" id="6926186">testing</span><span class="op" id="6926193">.</span><span class="ident" id="6926194">TB</span><span class="op" id="6926196">)</span>&nbsp;<span class="op" id="6926198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6926201">if</span>&nbsp;<span class="ident" id="6926204">c</span><span class="op" id="6926205">.</span><span class="ident" id="6926206">stmt</span>&nbsp;<span class="op" id="6926211">!=</span>&nbsp;<span class="ident" id="6926214">nil</span>&nbsp;<span class="op" id="6926218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6926222">c</span><span class="op" id="6926223">.</span><span class="ident" id="6926224">stmt</span><span class="op" id="6926228">.</span><span class="ident" id="6926229">Close</span><span class="op" id="6926234">(</span><span class="op" id="6926235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6926239">c</span><span class="op" id="6926240">.</span><span class="ident" id="6926241">stmt</span>&nbsp;<span class="op" id="6926246">=</span>&nbsp;<span class="ident" id="6926248">nil</span><br>
<span class="lineno">1680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6926253">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6926256">if</span>&nbsp;<span class="ident" id="6926259">c</span><span class="op" id="6926260">.</span><span class="ident" id="6926261">tx</span>&nbsp;<span class="op" id="6926264">!=</span>&nbsp;<span class="ident" id="6926267">nil</span>&nbsp;<span class="op" id="6926271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6926275">c</span><span class="op" id="6926276">.</span><span class="ident" id="6926277">tx</span><span class="op" id="6926279">.</span><span class="ident" id="6926280">Rollback</span><span class="op" id="6926288">(</span><span class="op" id="6926289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6926293">c</span><span class="op" id="6926294">.</span><span class="ident" id="6926295">tx</span>&nbsp;<span class="op" id="6926298">=</span>&nbsp;<span class="ident" id="6926300">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6926305">}</span><br>
<span class="lineno">1685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6926308">c</span><span class="op" id="6926309">.</span><span class="ident" id="6926310">db</span>&nbsp;<span class="op" id="6926313">=</span>&nbsp;<span class="ident" id="6926315">nil</span><br>
<span class="lineno"></span><span class="op" id="6926319">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6926322">func</span>&nbsp;<span class="op" id="6926327">(</span><span class="ident" id="6926328">c</span>&nbsp;<span class="op" id="6926330">*</span><span class="ident" id="6926331">concurrentTxStmtExecTest</span><span class="op" id="6926355">)</span>&nbsp;<span class="ident" id="6926357">test</span><span class="op" id="6926361">(</span><span class="ident" id="6926362">t</span>&nbsp;<span class="ident" id="6926364">testing</span><span class="op" id="6926371">.</span><span class="ident" id="6926372">TB</span><span class="op" id="6926374">)</span>&nbsp;<span class="builtintype" id="6926376">error</span>&nbsp;<span class="op" id="6926382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6926385">_</span><span class="op" id="6926386">,</span>&nbsp;<span class="ident" id="6926388">err</span>&nbsp;<span class="op" id="6926392">:=</span>&nbsp;<span class="ident" id="6926395">c</span><span class="op" id="6926396">.</span><span class="ident" id="6926397">stmt</span><span class="op" id="6926401">.</span><span class="ident" id="6926402">Exec</span><span class="op" id="6926406">(</span><span class="num" id="6926407">3</span><span class="op" id="6926408">,</span>&nbsp;<span class="ident" id="6926410">chrisBirthday</span><span class="op" id="6926423">)</span><br>
<span class="lineno">1690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6926426">if</span>&nbsp;<span class="ident" id="6926429">err</span>&nbsp;<span class="op" id="6926433">!=</span>&nbsp;<span class="ident" id="6926436">nil</span>&nbsp;<span class="op" id="6926440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6926444">t</span><span class="op" id="6926445">.</span><span class="ident" id="6926446">Errorf</span><span class="op" id="6926452">(</span><span class="string" id="6926453">&#34;error&nbsp;on&nbsp;exec:&nbsp;&nbsp;%v&#34;</span><span class="op" id="6926473">,</span>&nbsp;<span class="ident" id="6926475">err</span><span class="op" id="6926478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6926482">return</span>&nbsp;<span class="ident" id="6926489">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6926494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6926497">return</span>&nbsp;<span class="ident" id="6926504">nil</span><br>
<span class="lineno">1695</span><span class="op" id="6926508">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6926511">type</span>&nbsp;<span class="ident" id="6926516">concurrentRandomTest</span>&nbsp;<span class="keyword" id="6926537">struct</span>&nbsp;<span class="op" id="6926544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6926547">tests</span>&nbsp;<span class="op" id="6926553">[</span><span class="op" id="6926554">]</span><span class="ident" id="6926555">concurrentTest</span><br>
<span class="lineno"></span><span class="op" id="6926570">}</span><br>
<span class="lineno">1700</span><br>
<span class="lineno"></span><span class="keyword" id="6926573">func</span>&nbsp;<span class="op" id="6926578">(</span><span class="ident" id="6926579">c</span>&nbsp;<span class="op" id="6926581">*</span><span class="ident" id="6926582">concurrentRandomTest</span><span class="op" id="6926602">)</span>&nbsp;<span class="ident" id="6926604">init</span><span class="op" id="6926608">(</span><span class="ident" id="6926609">t</span>&nbsp;<span class="ident" id="6926611">testing</span><span class="op" id="6926618">.</span><span class="ident" id="6926619">TB</span><span class="op" id="6926621">,</span>&nbsp;<span class="ident" id="6926623">db</span>&nbsp;<span class="op" id="6926626">*</span><span class="ident" id="6926627">DB</span><span class="op" id="6926629">)</span>&nbsp;<span class="op" id="6926631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6926634">c</span><span class="op" id="6926635">.</span><span class="ident" id="6926636">tests</span>&nbsp;<span class="op" id="6926642">=</span>&nbsp;<span class="op" id="6926644">[</span><span class="op" id="6926645">]</span><span class="ident" id="6926646">concurrentTest</span><span class="op" id="6926660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6926664">new</span><span class="op" id="6926667">(</span><span class="ident" id="6926668">concurrentDBQueryTest</span><span class="op" id="6926689">)</span><span class="op" id="6926690">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6926694">new</span><span class="op" id="6926697">(</span><span class="ident" id="6926698">concurrentDBExecTest</span><span class="op" id="6926718">)</span><span class="op" id="6926719">,</span><br>
<span class="lineno">1705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6926723">new</span><span class="op" id="6926726">(</span><span class="ident" id="6926727">concurrentStmtQueryTest</span><span class="op" id="6926750">)</span><span class="op" id="6926751">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6926755">new</span><span class="op" id="6926758">(</span><span class="ident" id="6926759">concurrentStmtExecTest</span><span class="op" id="6926781">)</span><span class="op" id="6926782">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6926786">new</span><span class="op" id="6926789">(</span><span class="ident" id="6926790">concurrentTxQueryTest</span><span class="op" id="6926811">)</span><span class="op" id="6926812">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6926816">new</span><span class="op" id="6926819">(</span><span class="ident" id="6926820">concurrentTxExecTest</span><span class="op" id="6926840">)</span><span class="op" id="6926841">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6926845">new</span><span class="op" id="6926848">(</span><span class="ident" id="6926849">concurrentTxStmtQueryTest</span><span class="op" id="6926874">)</span><span class="op" id="6926875">,</span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6926879">new</span><span class="op" id="6926882">(</span><span class="ident" id="6926883">concurrentTxStmtExecTest</span><span class="op" id="6926907">)</span><span class="op" id="6926908">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6926911">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6926914">for</span>&nbsp;<span class="ident" id="6926918">_</span><span class="op" id="6926919">,</span>&nbsp;<span class="ident" id="6926921">ct</span>&nbsp;<span class="op" id="6926924">:=</span>&nbsp;<span class="keyword" id="6926927">range</span>&nbsp;<span class="ident" id="6926933">c</span><span class="op" id="6926934">.</span><span class="ident" id="6926935">tests</span>&nbsp;<span class="op" id="6926941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6926945">ct</span><span class="op" id="6926947">.</span><span class="ident" id="6926948">init</span><span class="op" id="6926952">(</span><span class="ident" id="6926953">t</span><span class="op" id="6926954">,</span>&nbsp;<span class="ident" id="6926956">db</span><span class="op" id="6926958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6926961">}</span><br>
<span class="lineno">1715</span><span class="op" id="6926963">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6926966">func</span>&nbsp;<span class="op" id="6926971">(</span><span class="ident" id="6926972">c</span>&nbsp;<span class="op" id="6926974">*</span><span class="ident" id="6926975">concurrentRandomTest</span><span class="op" id="6926995">)</span>&nbsp;<span class="ident" id="6926997">finish</span><span class="op" id="6927003">(</span><span class="ident" id="6927004">t</span>&nbsp;<span class="ident" id="6927006">testing</span><span class="op" id="6927013">.</span><span class="ident" id="6927014">TB</span><span class="op" id="6927016">)</span>&nbsp;<span class="op" id="6927018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6927021">for</span>&nbsp;<span class="ident" id="6927025">_</span><span class="op" id="6927026">,</span>&nbsp;<span class="ident" id="6927028">ct</span>&nbsp;<span class="op" id="6927031">:=</span>&nbsp;<span class="keyword" id="6927034">range</span>&nbsp;<span class="ident" id="6927040">c</span><span class="op" id="6927041">.</span><span class="ident" id="6927042">tests</span>&nbsp;<span class="op" id="6927048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6927052">ct</span><span class="op" id="6927054">.</span><span class="ident" id="6927055">finish</span><span class="op" id="6927061">(</span><span class="ident" id="6927062">t</span><span class="op" id="6927063">)</span><br>
<span class="lineno">1720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6927066">}</span><br>
<span class="lineno"></span><span class="op" id="6927068">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6927071">func</span>&nbsp;<span class="op" id="6927076">(</span><span class="ident" id="6927077">c</span>&nbsp;<span class="op" id="6927079">*</span><span class="ident" id="6927080">concurrentRandomTest</span><span class="op" id="6927100">)</span>&nbsp;<span class="ident" id="6927102">test</span><span class="op" id="6927106">(</span><span class="ident" id="6927107">t</span>&nbsp;<span class="ident" id="6927109">testing</span><span class="op" id="6927116">.</span><span class="ident" id="6927117">TB</span><span class="op" id="6927119">)</span>&nbsp;<span class="builtintype" id="6927121">error</span>&nbsp;<span class="op" id="6927127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6927130">ct</span>&nbsp;<span class="op" id="6927133">:=</span>&nbsp;<span class="ident" id="6927136">c</span><span class="op" id="6927137">.</span><span class="ident" id="6927138">tests</span><span class="op" id="6927143">[</span><span class="ident" id="6927144">rand</span><span class="op" id="6927148">.</span><span class="ident" id="6927149">Intn</span><span class="op" id="6927153">(</span><span class="builtinfunc" id="6927154">len</span><span class="op" id="6927157">(</span><span class="ident" id="6927158">c</span><span class="op" id="6927159">.</span><span class="ident" id="6927160">tests</span><span class="op" id="6927165">)</span><span class="op" id="6927166">)</span><span class="op" id="6927167">]</span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6927170">return</span>&nbsp;<span class="ident" id="6927177">ct</span><span class="op" id="6927179">.</span><span class="ident" id="6927180">test</span><span class="op" id="6927184">(</span><span class="ident" id="6927185">t</span><span class="op" id="6927186">)</span><br>
<span class="lineno"></span><span class="op" id="6927188">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6927191">func</span>&nbsp;<span class="ident" id="6927196">doConcurrentTest</span><span class="op" id="6927212">(</span><span class="ident" id="6927213">t</span>&nbsp;<span class="ident" id="6927215">testing</span><span class="op" id="6927222">.</span><span class="ident" id="6927223">TB</span><span class="op" id="6927225">,</span>&nbsp;<span class="ident" id="6927227">ct</span>&nbsp;<span class="ident" id="6927230">concurrentTest</span><span class="op" id="6927244">)</span>&nbsp;<span class="op" id="6927246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6927249">maxProcs</span><span class="op" id="6927257">,</span>&nbsp;<span class="ident" id="6927259">numReqs</span>&nbsp;<span class="op" id="6927267">:=</span>&nbsp;<span class="num" id="6927270">1</span><span class="op" id="6927271">,</span>&nbsp;<span class="num" id="6927273">500</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6927278">if</span>&nbsp;<span class="ident" id="6927281">testing</span><span class="op" id="6927288">.</span><span class="ident" id="6927289">Short</span><span class="op" id="6927294">(</span><span class="op" id="6927295">)</span>&nbsp;<span class="op" id="6927297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6927301">maxProcs</span><span class="op" id="6927309">,</span>&nbsp;<span class="ident" id="6927311">numReqs</span>&nbsp;<span class="op" id="6927319">=</span>&nbsp;<span class="num" id="6927321">4</span><span class="op" id="6927322">,</span>&nbsp;<span class="num" id="6927324">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6927328">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6927331">defer</span>&nbsp;<span class="ident" id="6927337">runtime</span><span class="op" id="6927344">.</span><span class="ident" id="6927345">GOMAXPROCS</span><span class="op" id="6927355">(</span><span class="ident" id="6927356">runtime</span><span class="op" id="6927363">.</span><span class="ident" id="6927364">GOMAXPROCS</span><span class="op" id="6927374">(</span><span class="ident" id="6927375">maxProcs</span><span class="op" id="6927383">)</span><span class="op" id="6927384">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6927388">db</span>&nbsp;<span class="op" id="6927391">:=</span>&nbsp;<span class="ident" id="6927394">newTestDB</span><span class="op" id="6927403">(</span><span class="ident" id="6927404">t</span><span class="op" id="6927405">,</span>&nbsp;<span class="string" id="6927407">&#34;people&#34;</span><span class="op" id="6927415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6927418">defer</span>&nbsp;<span class="ident" id="6927424">closeDB</span><span class="op" id="6927431">(</span><span class="ident" id="6927432">t</span><span class="op" id="6927433">,</span>&nbsp;<span class="ident" id="6927435">db</span><span class="op" id="6927437">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6927441">ct</span><span class="op" id="6927443">.</span><span class="ident" id="6927444">init</span><span class="op" id="6927448">(</span><span class="ident" id="6927449">t</span><span class="op" id="6927450">,</span>&nbsp;<span class="ident" id="6927452">db</span><span class="op" id="6927454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6927457">defer</span>&nbsp;<span class="ident" id="6927463">ct</span><span class="op" id="6927465">.</span><span class="ident" id="6927466">finish</span><span class="op" id="6927472">(</span><span class="ident" id="6927473">t</span><span class="op" id="6927474">)</span><br>
<span class="lineno">1740</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6927478">var</span>&nbsp;<span class="ident" id="6927482">wg</span>&nbsp;<span class="ident" id="6927485">sync</span><span class="op" id="6927489">.</span><span class="ident" id="6927490">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6927501">wg</span><span class="op" id="6927503">.</span><span class="ident" id="6927504">Add</span><span class="op" id="6927507">(</span><span class="ident" id="6927508">numReqs</span><span class="op" id="6927515">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6927519">reqs</span>&nbsp;<span class="op" id="6927524">:=</span>&nbsp;<span class="builtinfunc" id="6927527">make</span><span class="op" id="6927531">(</span><span class="keyword" id="6927532">chan</span>&nbsp;<span class="builtintype" id="6927537">bool</span><span class="op" id="6927541">)</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6927544">defer</span>&nbsp;<span class="builtinfunc" id="6927550">close</span><span class="op" id="6927555">(</span><span class="ident" id="6927556">reqs</span><span class="op" id="6927560">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6927564">for</span>&nbsp;<span class="ident" id="6927568">i</span>&nbsp;<span class="op" id="6927570">:=</span>&nbsp;<span class="num" id="6927573">0</span><span class="op" id="6927574">;</span>&nbsp;<span class="ident" id="6927576">i</span>&nbsp;<span class="op" id="6927578">&lt;</span>&nbsp;<span class="ident" id="6927580">maxProcs</span><span class="op" id="6927588">*</span><span class="num" id="6927589">2</span><span class="op" id="6927590">;</span>&nbsp;<span class="ident" id="6927592">i</span><span class="op" id="6927593">++</span>&nbsp;<span class="op" id="6927596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6927600">go</span>&nbsp;<span class="keyword" id="6927603">func</span><span class="op" id="6927607">(</span><span class="op" id="6927608">)</span>&nbsp;<span class="op" id="6927610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6927615">for</span>&nbsp;<span class="keyword" id="6927619">range</span>&nbsp;<span class="ident" id="6927625">reqs</span>&nbsp;<span class="op" id="6927630">{</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6927636">err</span>&nbsp;<span class="op" id="6927640">:=</span>&nbsp;<span class="ident" id="6927643">ct</span><span class="op" id="6927645">.</span><span class="ident" id="6927646">test</span><span class="op" id="6927650">(</span><span class="ident" id="6927651">t</span><span class="op" id="6927652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6927658">if</span>&nbsp;<span class="ident" id="6927661">err</span>&nbsp;<span class="op" id="6927665">!=</span>&nbsp;<span class="ident" id="6927668">nil</span>&nbsp;<span class="op" id="6927672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6927679">wg</span><span class="op" id="6927681">.</span><span class="ident" id="6927682">Done</span><span class="op" id="6927686">(</span><span class="op" id="6927687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6927694">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6927707">}</span><br>
<span class="lineno">1755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6927713">wg</span><span class="op" id="6927715">.</span><span class="ident" id="6927716">Done</span><span class="op" id="6927720">(</span><span class="op" id="6927721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6927726">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6927730">}</span><span class="op" id="6927731">(</span><span class="op" id="6927732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6927735">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1760</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6927739">for</span>&nbsp;<span class="ident" id="6927743">i</span>&nbsp;<span class="op" id="6927745">:=</span>&nbsp;<span class="num" id="6927748">0</span><span class="op" id="6927749">;</span>&nbsp;<span class="ident" id="6927751">i</span>&nbsp;<span class="op" id="6927753">&lt;</span>&nbsp;<span class="ident" id="6927755">numReqs</span><span class="op" id="6927762">;</span>&nbsp;<span class="ident" id="6927764">i</span><span class="op" id="6927765">++</span>&nbsp;<span class="op" id="6927768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6927772">reqs</span>&nbsp;<span class="op" id="6927777">&lt;-</span>&nbsp;<span class="builtintype" id="6927780">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6927786">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6927790">wg</span><span class="op" id="6927792">.</span><span class="ident" id="6927793">Wait</span><span class="op" id="6927797">(</span><span class="op" id="6927798">)</span><br>
<span class="lineno">1765</span><span class="op" id="6927800">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6927803">func</span>&nbsp;<span class="ident" id="6927808">manyConcurrentQueries</span><span class="op" id="6927829">(</span><span class="ident" id="6927830">t</span>&nbsp;<span class="ident" id="6927832">testing</span><span class="op" id="6927839">.</span><span class="ident" id="6927840">TB</span><span class="op" id="6927842">)</span>&nbsp;<span class="op" id="6927844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6927847">maxProcs</span><span class="op" id="6927855">,</span>&nbsp;<span class="ident" id="6927857">numReqs</span>&nbsp;<span class="op" id="6927865">:=</span>&nbsp;<span class="num" id="6927868">16</span><span class="op" id="6927870">,</span>&nbsp;<span class="num" id="6927872">500</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6927877">if</span>&nbsp;<span class="ident" id="6927880">testing</span><span class="op" id="6927887">.</span><span class="ident" id="6927888">Short</span><span class="op" id="6927893">(</span><span class="op" id="6927894">)</span>&nbsp;<span class="op" id="6927896">{</span><br>
<span class="lineno">1770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6927900">maxProcs</span><span class="op" id="6927908">,</span>&nbsp;<span class="ident" id="6927910">numReqs</span>&nbsp;<span class="op" id="6927918">=</span>&nbsp;<span class="num" id="6927920">4</span><span class="op" id="6927921">,</span>&nbsp;<span class="num" id="6927923">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6927927">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6927930">defer</span>&nbsp;<span class="ident" id="6927936">runtime</span><span class="op" id="6927943">.</span><span class="ident" id="6927944">GOMAXPROCS</span><span class="op" id="6927954">(</span><span class="ident" id="6927955">runtime</span><span class="op" id="6927962">.</span><span class="ident" id="6927963">GOMAXPROCS</span><span class="op" id="6927973">(</span><span class="ident" id="6927974">maxProcs</span><span class="op" id="6927982">)</span><span class="op" id="6927983">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6927987">db</span>&nbsp;<span class="op" id="6927990">:=</span>&nbsp;<span class="ident" id="6927993">newTestDB</span><span class="op" id="6928002">(</span><span class="ident" id="6928003">t</span><span class="op" id="6928004">,</span>&nbsp;<span class="string" id="6928006">&#34;people&#34;</span><span class="op" id="6928014">)</span><br>
<span class="lineno">1775</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6928017">defer</span>&nbsp;<span class="ident" id="6928023">closeDB</span><span class="op" id="6928030">(</span><span class="ident" id="6928031">t</span><span class="op" id="6928032">,</span>&nbsp;<span class="ident" id="6928034">db</span><span class="op" id="6928036">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6928040">stmt</span><span class="op" id="6928044">,</span>&nbsp;<span class="ident" id="6928046">err</span>&nbsp;<span class="op" id="6928050">:=</span>&nbsp;<span class="ident" id="6928053">db</span><span class="op" id="6928055">.</span><span class="ident" id="6928056">Prepare</span><span class="op" id="6928063">(</span><span class="string" id="6928064">&#34;SELECT|people|name|&#34;</span><span class="op" id="6928085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6928088">if</span>&nbsp;<span class="ident" id="6928091">err</span>&nbsp;<span class="op" id="6928095">!=</span>&nbsp;<span class="ident" id="6928098">nil</span>&nbsp;<span class="op" id="6928102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6928106">t</span><span class="op" id="6928107">.</span><span class="ident" id="6928108">Fatal</span><span class="op" id="6928113">(</span><span class="ident" id="6928114">err</span><span class="op" id="6928117">)</span><br>
<span class="lineno">1780</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6928120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6928123">defer</span>&nbsp;<span class="ident" id="6928129">stmt</span><span class="op" id="6928133">.</span><span class="ident" id="6928134">Close</span><span class="op" id="6928139">(</span><span class="op" id="6928140">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6928144">var</span>&nbsp;<span class="ident" id="6928148">wg</span>&nbsp;<span class="ident" id="6928151">sync</span><span class="op" id="6928155">.</span><span class="ident" id="6928156">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6928167">wg</span><span class="op" id="6928169">.</span><span class="ident" id="6928170">Add</span><span class="op" id="6928173">(</span><span class="ident" id="6928174">numReqs</span><span class="op" id="6928181">)</span><br>
<span class="lineno">1785</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6928185">reqs</span>&nbsp;<span class="op" id="6928190">:=</span>&nbsp;<span class="builtinfunc" id="6928193">make</span><span class="op" id="6928197">(</span><span class="keyword" id="6928198">chan</span>&nbsp;<span class="builtintype" id="6928203">bool</span><span class="op" id="6928207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6928210">defer</span>&nbsp;<span class="builtinfunc" id="6928216">close</span><span class="op" id="6928221">(</span><span class="ident" id="6928222">reqs</span><span class="op" id="6928226">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6928230">for</span>&nbsp;<span class="ident" id="6928234">i</span>&nbsp;<span class="op" id="6928236">:=</span>&nbsp;<span class="num" id="6928239">0</span><span class="op" id="6928240">;</span>&nbsp;<span class="ident" id="6928242">i</span>&nbsp;<span class="op" id="6928244">&lt;</span>&nbsp;<span class="ident" id="6928246">maxProcs</span><span class="op" id="6928254">*</span><span class="num" id="6928255">2</span><span class="op" id="6928256">;</span>&nbsp;<span class="ident" id="6928258">i</span><span class="op" id="6928259">++</span>&nbsp;<span class="op" id="6928262">{</span><br>
<span class="lineno">1790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6928266">go</span>&nbsp;<span class="keyword" id="6928269">func</span><span class="op" id="6928273">(</span><span class="op" id="6928274">)</span>&nbsp;<span class="op" id="6928276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6928281">for</span>&nbsp;<span class="keyword" id="6928285">range</span>&nbsp;<span class="ident" id="6928291">reqs</span>&nbsp;<span class="op" id="6928296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6928302">rows</span><span class="op" id="6928306">,</span>&nbsp;<span class="ident" id="6928308">err</span>&nbsp;<span class="op" id="6928312">:=</span>&nbsp;<span class="ident" id="6928315">stmt</span><span class="op" id="6928319">.</span><span class="ident" id="6928320">Query</span><span class="op" id="6928325">(</span><span class="op" id="6928326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6928332">if</span>&nbsp;<span class="ident" id="6928335">err</span>&nbsp;<span class="op" id="6928339">!=</span>&nbsp;<span class="ident" id="6928342">nil</span>&nbsp;<span class="op" id="6928346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6928353">t</span><span class="op" id="6928354">.</span><span class="ident" id="6928355">Errorf</span><span class="op" id="6928361">(</span><span class="string" id="6928362">&#34;error&nbsp;on&nbsp;query:&nbsp;&nbsp;%v&#34;</span><span class="op" id="6928383">,</span>&nbsp;<span class="ident" id="6928385">err</span><span class="op" id="6928388">)</span><br>
<span class="lineno">1795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6928395">wg</span><span class="op" id="6928397">.</span><span class="ident" id="6928398">Done</span><span class="op" id="6928402">(</span><span class="op" id="6928403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6928410">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6928423">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6928430">var</span>&nbsp;<span class="ident" id="6928434">name</span>&nbsp;<span class="builtintype" id="6928439">string</span><br>
<span class="lineno">1800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6928450">for</span>&nbsp;<span class="ident" id="6928454">rows</span><span class="op" id="6928458">.</span><span class="ident" id="6928459">Next</span><span class="op" id="6928463">(</span><span class="op" id="6928464">)</span>&nbsp;<span class="op" id="6928466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6928473">rows</span><span class="op" id="6928477">.</span><span class="ident" id="6928478">Scan</span><span class="op" id="6928482">(</span><span class="op" id="6928483">&amp;</span><span class="ident" id="6928484">name</span><span class="op" id="6928488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6928494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6928500">rows</span><span class="op" id="6928504">.</span><span class="ident" id="6928505">Close</span><span class="op" id="6928510">(</span><span class="op" id="6928511">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6928518">wg</span><span class="op" id="6928520">.</span><span class="ident" id="6928521">Done</span><span class="op" id="6928525">(</span><span class="op" id="6928526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6928531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6928535">}</span><span class="op" id="6928536">(</span><span class="op" id="6928537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6928540">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1810</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6928544">for</span>&nbsp;<span class="ident" id="6928548">i</span>&nbsp;<span class="op" id="6928550">:=</span>&nbsp;<span class="num" id="6928553">0</span><span class="op" id="6928554">;</span>&nbsp;<span class="ident" id="6928556">i</span>&nbsp;<span class="op" id="6928558">&lt;</span>&nbsp;<span class="ident" id="6928560">numReqs</span><span class="op" id="6928567">;</span>&nbsp;<span class="ident" id="6928569">i</span><span class="op" id="6928570">++</span>&nbsp;<span class="op" id="6928573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6928577">reqs</span>&nbsp;<span class="op" id="6928582">&lt;-</span>&nbsp;<span class="builtintype" id="6928585">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6928591">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6928595">wg</span><span class="op" id="6928597">.</span><span class="ident" id="6928598">Wait</span><span class="op" id="6928602">(</span><span class="op" id="6928603">)</span><br>
<span class="lineno">1815</span><span class="op" id="6928605">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6928608">func</span>&nbsp;<span class="ident" id="6928613">TestIssue6081</span><span class="op" id="6928626">(</span><span class="ident" id="6928627">t</span>&nbsp;<span class="op" id="6928629">*</span><span class="ident" id="6928630">testing</span><span class="op" id="6928637">.</span><span class="ident" id="6928638">T</span><span class="op" id="6928639">)</span>&nbsp;<span class="op" id="6928641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6928644">db</span>&nbsp;<span class="op" id="6928647">:=</span>&nbsp;<span class="ident" id="6928650">newTestDB</span><span class="op" id="6928659">(</span><span class="ident" id="6928660">t</span><span class="op" id="6928661">,</span>&nbsp;<span class="string" id="6928663">&#34;people&#34;</span><span class="op" id="6928671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6928674">defer</span>&nbsp;<span class="ident" id="6928680">closeDB</span><span class="op" id="6928687">(</span><span class="ident" id="6928688">t</span><span class="op" id="6928689">,</span>&nbsp;<span class="ident" id="6928691">db</span><span class="op" id="6928693">)</span><br>
<span class="lineno">1820</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6928697">drv</span>&nbsp;<span class="op" id="6928701">:=</span>&nbsp;<span class="ident" id="6928704">db</span><span class="op" id="6928706">.</span><span class="ident" id="6928707">driver</span><span class="op" id="6928713">.</span><span class="op" id="6928714">(</span><span class="op" id="6928715">*</span><span class="ident" id="6928716">fakeDriver</span><span class="op" id="6928726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6928729">drv</span><span class="op" id="6928732">.</span><span class="ident" id="6928733">mu</span><span class="op" id="6928735">.</span><span class="ident" id="6928736">Lock</span><span class="op" id="6928740">(</span><span class="op" id="6928741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6928744">opens0</span>&nbsp;<span class="op" id="6928751">:=</span>&nbsp;<span class="ident" id="6928754">drv</span><span class="op" id="6928757">.</span><span class="ident" id="6928758">openCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6928769">closes0</span>&nbsp;<span class="op" id="6928777">:=</span>&nbsp;<span class="ident" id="6928780">drv</span><span class="op" id="6928783">.</span><span class="ident" id="6928784">closeCount</span><br>
<span class="lineno">1825</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6928796">drv</span><span class="op" id="6928799">.</span><span class="ident" id="6928800">mu</span><span class="op" id="6928802">.</span><span class="ident" id="6928803">Unlock</span><span class="op" id="6928809">(</span><span class="op" id="6928810">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6928814">stmt</span><span class="op" id="6928818">,</span>&nbsp;<span class="ident" id="6928820">err</span>&nbsp;<span class="op" id="6928824">:=</span>&nbsp;<span class="ident" id="6928827">db</span><span class="op" id="6928829">.</span><span class="ident" id="6928830">Prepare</span><span class="op" id="6928837">(</span><span class="string" id="6928838">&#34;SELECT|people|name|&#34;</span><span class="op" id="6928859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6928862">if</span>&nbsp;<span class="ident" id="6928865">err</span>&nbsp;<span class="op" id="6928869">!=</span>&nbsp;<span class="ident" id="6928872">nil</span>&nbsp;<span class="op" id="6928876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6928880">t</span><span class="op" id="6928881">.</span><span class="ident" id="6928882">Fatal</span><span class="op" id="6928887">(</span><span class="ident" id="6928888">err</span><span class="op" id="6928891">)</span><br>
<span class="lineno">1830</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6928894">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6928897">rowsCloseHook</span>&nbsp;<span class="op" id="6928911">=</span>&nbsp;<span class="keyword" id="6928913">func</span><span class="op" id="6928917">(</span><span class="ident" id="6928918">rows</span>&nbsp;<span class="op" id="6928923">*</span><span class="ident" id="6928924">Rows</span><span class="op" id="6928928">,</span>&nbsp;<span class="ident" id="6928930">err</span>&nbsp;<span class="op" id="6928934">*</span><span class="builtintype" id="6928935">error</span><span class="op" id="6928940">)</span>&nbsp;<span class="op" id="6928942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6928946">*</span><span class="ident" id="6928947">err</span>&nbsp;<span class="op" id="6928951">=</span>&nbsp;<span class="ident" id="6928953">driver</span><span class="op" id="6928959">.</span><span class="ident" id="6928960">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6928972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6928975">defer</span>&nbsp;<span class="keyword" id="6928981">func</span><span class="op" id="6928985">(</span><span class="op" id="6928986">)</span>&nbsp;<span class="op" id="6928988">{</span>&nbsp;<span class="ident" id="6928990">rowsCloseHook</span>&nbsp;<span class="op" id="6929004">=</span>&nbsp;<span class="ident" id="6929006">nil</span>&nbsp;<span class="op" id="6929010">}</span><span class="op" id="6929011">(</span><span class="op" id="6929012">)</span><br>
<span class="lineno">1835</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6929015">for</span>&nbsp;<span class="ident" id="6929019">i</span>&nbsp;<span class="op" id="6929021">:=</span>&nbsp;<span class="num" id="6929024">0</span><span class="op" id="6929025">;</span>&nbsp;<span class="ident" id="6929027">i</span>&nbsp;<span class="op" id="6929029">&lt;</span>&nbsp;<span class="num" id="6929031">10</span><span class="op" id="6929033">;</span>&nbsp;<span class="ident" id="6929035">i</span><span class="op" id="6929036">++</span>&nbsp;<span class="op" id="6929039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6929043">rows</span><span class="op" id="6929047">,</span>&nbsp;<span class="ident" id="6929049">err</span>&nbsp;<span class="op" id="6929053">:=</span>&nbsp;<span class="ident" id="6929056">stmt</span><span class="op" id="6929060">.</span><span class="ident" id="6929061">Query</span><span class="op" id="6929066">(</span><span class="op" id="6929067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6929071">if</span>&nbsp;<span class="ident" id="6929074">err</span>&nbsp;<span class="op" id="6929078">!=</span>&nbsp;<span class="ident" id="6929081">nil</span>&nbsp;<span class="op" id="6929085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6929090">t</span><span class="op" id="6929091">.</span><span class="ident" id="6929092">Fatal</span><span class="op" id="6929097">(</span><span class="ident" id="6929098">err</span><span class="op" id="6929101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6929105">}</span><br>
<span class="lineno">1840</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6929109">rows</span><span class="op" id="6929113">.</span><span class="ident" id="6929114">Close</span><span class="op" id="6929119">(</span><span class="op" id="6929120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6929123">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6929126">if</span>&nbsp;<span class="ident" id="6929129">n</span>&nbsp;<span class="op" id="6929131">:=</span>&nbsp;<span class="builtinfunc" id="6929134">len</span><span class="op" id="6929137">(</span><span class="ident" id="6929138">stmt</span><span class="op" id="6929142">.</span><span class="ident" id="6929143">css</span><span class="op" id="6929146">)</span><span class="op" id="6929147">;</span>&nbsp;<span class="ident" id="6929149">n</span>&nbsp;<span class="op" id="6929151">&gt;</span>&nbsp;<span class="num" id="6929153">1</span>&nbsp;<span class="op" id="6929155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6929159">t</span><span class="op" id="6929160">.</span><span class="ident" id="6929161">Errorf</span><span class="op" id="6929167">(</span><span class="string" id="6929168">&#34;len(css&nbsp;slice)&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;1&#34;</span><span class="op" id="6929200">,</span>&nbsp;<span class="ident" id="6929202">n</span><span class="op" id="6929203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6929206">}</span><br>
<span class="lineno">1845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6929209">stmt</span><span class="op" id="6929213">.</span><span class="ident" id="6929214">Close</span><span class="op" id="6929219">(</span><span class="op" id="6929220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6929223">if</span>&nbsp;<span class="ident" id="6929226">n</span>&nbsp;<span class="op" id="6929228">:=</span>&nbsp;<span class="builtinfunc" id="6929231">len</span><span class="op" id="6929234">(</span><span class="ident" id="6929235">stmt</span><span class="op" id="6929239">.</span><span class="ident" id="6929240">css</span><span class="op" id="6929243">)</span><span class="op" id="6929244">;</span>&nbsp;<span class="ident" id="6929246">n</span>&nbsp;<span class="op" id="6929248">!=</span>&nbsp;<span class="num" id="6929251">0</span>&nbsp;<span class="op" id="6929253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6929257">t</span><span class="op" id="6929258">.</span><span class="ident" id="6929259">Errorf</span><span class="op" id="6929265">(</span><span class="string" id="6929266">&#34;len(css&nbsp;slice)&nbsp;after&nbsp;Close&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="6929307">,</span>&nbsp;<span class="ident" id="6929309">n</span><span class="op" id="6929310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6929313">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1850</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6929317">drv</span><span class="op" id="6929320">.</span><span class="ident" id="6929321">mu</span><span class="op" id="6929323">.</span><span class="ident" id="6929324">Lock</span><span class="op" id="6929328">(</span><span class="op" id="6929329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6929332">opens</span>&nbsp;<span class="op" id="6929338">:=</span>&nbsp;<span class="ident" id="6929341">drv</span><span class="op" id="6929344">.</span><span class="ident" id="6929345">openCount</span>&nbsp;<span class="op" id="6929355">-</span>&nbsp;<span class="ident" id="6929357">opens0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6929365">closes</span>&nbsp;<span class="op" id="6929372">:=</span>&nbsp;<span class="ident" id="6929375">drv</span><span class="op" id="6929378">.</span><span class="ident" id="6929379">closeCount</span>&nbsp;<span class="op" id="6929390">-</span>&nbsp;<span class="ident" id="6929392">closes0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6929401">drv</span><span class="op" id="6929404">.</span><span class="ident" id="6929405">mu</span><span class="op" id="6929407">.</span><span class="ident" id="6929408">Unlock</span><span class="op" id="6929414">(</span><span class="op" id="6929415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6929418">if</span>&nbsp;<span class="ident" id="6929421">opens</span>&nbsp;<span class="op" id="6929427">&lt;</span>&nbsp;<span class="num" id="6929429">9</span>&nbsp;<span class="op" id="6929431">{</span><br>
<span class="lineno">1855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6929435">t</span><span class="op" id="6929436">.</span><span class="ident" id="6929437">Errorf</span><span class="op" id="6929443">(</span><span class="string" id="6929444">&#34;opens&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&gt;=&nbsp;9&#34;</span><span class="op" id="6929467">,</span>&nbsp;<span class="ident" id="6929469">opens</span><span class="op" id="6929474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6929477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6929480">if</span>&nbsp;<span class="ident" id="6929483">closes</span>&nbsp;<span class="op" id="6929490">&lt;</span>&nbsp;<span class="num" id="6929492">9</span>&nbsp;<span class="op" id="6929494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6929498">t</span><span class="op" id="6929499">.</span><span class="ident" id="6929500">Errorf</span><span class="op" id="6929506">(</span><span class="string" id="6929507">&#34;closes&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&gt;=&nbsp;9&#34;</span><span class="op" id="6929531">,</span>&nbsp;<span class="ident" id="6929533">closes</span><span class="op" id="6929539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6929542">}</span><br>
<span class="lineno">1860</span><span class="op" id="6929544">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6929547">func</span>&nbsp;<span class="ident" id="6929552">TestConcurrency</span><span class="op" id="6929567">(</span><span class="ident" id="6929568">t</span>&nbsp;<span class="op" id="6929570">*</span><span class="ident" id="6929571">testing</span><span class="op" id="6929578">.</span><span class="ident" id="6929579">T</span><span class="op" id="6929580">)</span>&nbsp;<span class="op" id="6929582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6929585">doConcurrentTest</span><span class="op" id="6929601">(</span><span class="ident" id="6929602">t</span><span class="op" id="6929603">,</span>&nbsp;<span class="builtinfunc" id="6929605">new</span><span class="op" id="6929608">(</span><span class="ident" id="6929609">concurrentDBQueryTest</span><span class="op" id="6929630">)</span><span class="op" id="6929631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6929634">doConcurrentTest</span><span class="op" id="6929650">(</span><span class="ident" id="6929651">t</span><span class="op" id="6929652">,</span>&nbsp;<span class="builtinfunc" id="6929654">new</span><span class="op" id="6929657">(</span><span class="ident" id="6929658">concurrentDBExecTest</span><span class="op" id="6929678">)</span><span class="op" id="6929679">)</span><br>
<span class="lineno">1865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6929682">doConcurrentTest</span><span class="op" id="6929698">(</span><span class="ident" id="6929699">t</span><span class="op" id="6929700">,</span>&nbsp;<span class="builtinfunc" id="6929702">new</span><span class="op" id="6929705">(</span><span class="ident" id="6929706">concurrentStmtQueryTest</span><span class="op" id="6929729">)</span><span class="op" id="6929730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6929733">doConcurrentTest</span><span class="op" id="6929749">(</span><span class="ident" id="6929750">t</span><span class="op" id="6929751">,</span>&nbsp;<span class="builtinfunc" id="6929753">new</span><span class="op" id="6929756">(</span><span class="ident" id="6929757">concurrentStmtExecTest</span><span class="op" id="6929779">)</span><span class="op" id="6929780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6929783">doConcurrentTest</span><span class="op" id="6929799">(</span><span class="ident" id="6929800">t</span><span class="op" id="6929801">,</span>&nbsp;<span class="builtinfunc" id="6929803">new</span><span class="op" id="6929806">(</span><span class="ident" id="6929807">concurrentTxQueryTest</span><span class="op" id="6929828">)</span><span class="op" id="6929829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6929832">doConcurrentTest</span><span class="op" id="6929848">(</span><span class="ident" id="6929849">t</span><span class="op" id="6929850">,</span>&nbsp;<span class="builtinfunc" id="6929852">new</span><span class="op" id="6929855">(</span><span class="ident" id="6929856">concurrentTxExecTest</span><span class="op" id="6929876">)</span><span class="op" id="6929877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6929880">doConcurrentTest</span><span class="op" id="6929896">(</span><span class="ident" id="6929897">t</span><span class="op" id="6929898">,</span>&nbsp;<span class="builtinfunc" id="6929900">new</span><span class="op" id="6929903">(</span><span class="ident" id="6929904">concurrentTxStmtQueryTest</span><span class="op" id="6929929">)</span><span class="op" id="6929930">)</span><br>
<span class="lineno">1870</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6929933">doConcurrentTest</span><span class="op" id="6929949">(</span><span class="ident" id="6929950">t</span><span class="op" id="6929951">,</span>&nbsp;<span class="builtinfunc" id="6929953">new</span><span class="op" id="6929956">(</span><span class="ident" id="6929957">concurrentTxStmtExecTest</span><span class="op" id="6929981">)</span><span class="op" id="6929982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6929985">doConcurrentTest</span><span class="op" id="6930001">(</span><span class="ident" id="6930002">t</span><span class="op" id="6930003">,</span>&nbsp;<span class="builtinfunc" id="6930005">new</span><span class="op" id="6930008">(</span><span class="ident" id="6930009">concurrentRandomTest</span><span class="op" id="6930029">)</span><span class="op" id="6930030">)</span><br>
<span class="lineno"></span><span class="op" id="6930032">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6930035">func</span>&nbsp;<span class="ident" id="6930040">TestConnectionLeak</span><span class="op" id="6930058">(</span><span class="ident" id="6930059">t</span>&nbsp;<span class="op" id="6930061">*</span><span class="ident" id="6930062">testing</span><span class="op" id="6930069">.</span><span class="ident" id="6930070">T</span><span class="op" id="6930071">)</span>&nbsp;<span class="op" id="6930073">{</span><br>
<span class="lineno">1875</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6930076">db</span>&nbsp;<span class="op" id="6930079">:=</span>&nbsp;<span class="ident" id="6930082">newTestDB</span><span class="op" id="6930091">(</span><span class="ident" id="6930092">t</span><span class="op" id="6930093">,</span>&nbsp;<span class="string" id="6930095">&#34;people&#34;</span><span class="op" id="6930103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6930106">defer</span>&nbsp;<span class="ident" id="6930112">closeDB</span><span class="op" id="6930119">(</span><span class="ident" id="6930120">t</span><span class="op" id="6930121">,</span>&nbsp;<span class="ident" id="6930123">db</span><span class="op" id="6930125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6930128">//&nbsp;Start&nbsp;by&nbsp;opening&nbsp;defaultMaxIdleConns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6930169">rows</span>&nbsp;<span class="op" id="6930174">:=</span>&nbsp;<span class="builtinfunc" id="6930177">make</span><span class="op" id="6930181">(</span><span class="op" id="6930182">[</span><span class="op" id="6930183">]</span><span class="op" id="6930184">*</span><span class="ident" id="6930185">Rows</span><span class="op" id="6930189">,</span>&nbsp;<span class="ident" id="6930191">defaultMaxIdleConns</span><span class="op" id="6930210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6930213">//&nbsp;We&nbsp;need&nbsp;to&nbsp;SetMaxOpenConns&nbsp;&gt;&nbsp;MaxIdleConns,&nbsp;so&nbsp;the&nbsp;DB&nbsp;can&nbsp;open</span><br>
<span class="lineno">1880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6930279">//&nbsp;a&nbsp;new&nbsp;connection&nbsp;and&nbsp;we&nbsp;can&nbsp;fill&nbsp;the&nbsp;idle&nbsp;queue&nbsp;with&nbsp;the&nbsp;released</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6930349">//&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6930366">db</span><span class="op" id="6930368">.</span><span class="ident" id="6930369">SetMaxOpenConns</span><span class="op" id="6930384">(</span><span class="builtinfunc" id="6930385">len</span><span class="op" id="6930388">(</span><span class="ident" id="6930389">rows</span><span class="op" id="6930393">)</span>&nbsp;<span class="op" id="6930395">+</span>&nbsp;<span class="num" id="6930397">1</span><span class="op" id="6930398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6930401">for</span>&nbsp;<span class="ident" id="6930405">ii</span>&nbsp;<span class="op" id="6930408">:=</span>&nbsp;<span class="keyword" id="6930411">range</span>&nbsp;<span class="ident" id="6930417">rows</span>&nbsp;<span class="op" id="6930422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6930426">r</span><span class="op" id="6930427">,</span>&nbsp;<span class="ident" id="6930429">err</span>&nbsp;<span class="op" id="6930433">:=</span>&nbsp;<span class="ident" id="6930436">db</span><span class="op" id="6930438">.</span><span class="ident" id="6930439">Query</span><span class="op" id="6930444">(</span><span class="string" id="6930445">&#34;SELECT|people|name|&#34;</span><span class="op" id="6930466">)</span><br>
<span class="lineno">1885</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6930470">if</span>&nbsp;<span class="ident" id="6930473">err</span>&nbsp;<span class="op" id="6930477">!=</span>&nbsp;<span class="ident" id="6930480">nil</span>&nbsp;<span class="op" id="6930484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6930489">t</span><span class="op" id="6930490">.</span><span class="ident" id="6930491">Fatal</span><span class="op" id="6930496">(</span><span class="ident" id="6930497">err</span><span class="op" id="6930500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6930504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6930508">r</span><span class="op" id="6930509">.</span><span class="ident" id="6930510">Next</span><span class="op" id="6930514">(</span><span class="op" id="6930515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6930519">if</span>&nbsp;<span class="ident" id="6930522">err</span>&nbsp;<span class="op" id="6930526">:=</span>&nbsp;<span class="ident" id="6930529">r</span><span class="op" id="6930530">.</span><span class="ident" id="6930531">Err</span><span class="op" id="6930534">(</span><span class="op" id="6930535">)</span><span class="op" id="6930536">;</span>&nbsp;<span class="ident" id="6930538">err</span>&nbsp;<span class="op" id="6930542">!=</span>&nbsp;<span class="ident" id="6930545">nil</span>&nbsp;<span class="op" id="6930549">{</span><br>
<span class="lineno">1890</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6930554">t</span><span class="op" id="6930555">.</span><span class="ident" id="6930556">Fatal</span><span class="op" id="6930561">(</span><span class="ident" id="6930562">err</span><span class="op" id="6930565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6930569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6930573">rows</span><span class="op" id="6930577">[</span><span class="ident" id="6930578">ii</span><span class="op" id="6930580">]</span>&nbsp;<span class="op" id="6930582">=</span>&nbsp;<span class="ident" id="6930584">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6930587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6930590">//&nbsp;Now&nbsp;we&nbsp;have&nbsp;defaultMaxIdleConns&nbsp;busy&nbsp;connections.&nbsp;Open</span><br>
<span class="lineno">1895</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6930649">//&nbsp;a&nbsp;new&nbsp;one,&nbsp;but&nbsp;wait&nbsp;until&nbsp;the&nbsp;busy&nbsp;connections&nbsp;are&nbsp;released</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6930713">//&nbsp;before&nbsp;returning&nbsp;control&nbsp;to&nbsp;DB.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6930749">drv</span>&nbsp;<span class="op" id="6930753">:=</span>&nbsp;<span class="ident" id="6930756">db</span><span class="op" id="6930758">.</span><span class="ident" id="6930759">driver</span><span class="op" id="6930765">.</span><span class="op" id="6930766">(</span><span class="op" id="6930767">*</span><span class="ident" id="6930768">fakeDriver</span><span class="op" id="6930778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6930781">drv</span><span class="op" id="6930784">.</span><span class="ident" id="6930785">waitCh</span>&nbsp;<span class="op" id="6930792">=</span>&nbsp;<span class="builtinfunc" id="6930794">make</span><span class="op" id="6930798">(</span><span class="keyword" id="6930799">chan</span>&nbsp;<span class="keyword" id="6930804">struct</span><span class="op" id="6930810">{</span><span class="op" id="6930811">}</span><span class="op" id="6930812">,</span>&nbsp;<span class="num" id="6930814">1</span><span class="op" id="6930815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6930818">drv</span><span class="op" id="6930821">.</span><span class="ident" id="6930822">waitingCh</span>&nbsp;<span class="op" id="6930832">=</span>&nbsp;<span class="builtinfunc" id="6930834">make</span><span class="op" id="6930838">(</span><span class="keyword" id="6930839">chan</span>&nbsp;<span class="keyword" id="6930844">struct</span><span class="op" id="6930850">{</span><span class="op" id="6930851">}</span><span class="op" id="6930852">,</span>&nbsp;<span class="num" id="6930854">1</span><span class="op" id="6930855">)</span><br>
<span class="lineno">1900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6930858">var</span>&nbsp;<span class="ident" id="6930862">wg</span>&nbsp;<span class="ident" id="6930865">sync</span><span class="op" id="6930869">.</span><span class="ident" id="6930870">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6930881">wg</span><span class="op" id="6930883">.</span><span class="ident" id="6930884">Add</span><span class="op" id="6930887">(</span><span class="num" id="6930888">1</span><span class="op" id="6930889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6930892">go</span>&nbsp;<span class="keyword" id="6930895">func</span><span class="op" id="6930899">(</span><span class="op" id="6930900">)</span>&nbsp;<span class="op" id="6930902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6930906">r</span><span class="op" id="6930907">,</span>&nbsp;<span class="ident" id="6930909">err</span>&nbsp;<span class="op" id="6930913">:=</span>&nbsp;<span class="ident" id="6930916">db</span><span class="op" id="6930918">.</span><span class="ident" id="6930919">Query</span><span class="op" id="6930924">(</span><span class="string" id="6930925">&#34;SELECT|people|name|&#34;</span><span class="op" id="6930946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6930950">if</span>&nbsp;<span class="ident" id="6930953">err</span>&nbsp;<span class="op" id="6930957">!=</span>&nbsp;<span class="ident" id="6930960">nil</span>&nbsp;<span class="op" id="6930964">{</span><br>
<span class="lineno">1905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6930969">t</span><span class="op" id="6930970">.</span><span class="ident" id="6930971">Fatal</span><span class="op" id="6930976">(</span><span class="ident" id="6930977">err</span><span class="op" id="6930980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6930984">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6930988">r</span><span class="op" id="6930989">.</span><span class="ident" id="6930990">Close</span><span class="op" id="6930995">(</span><span class="op" id="6930996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6931000">wg</span><span class="op" id="6931002">.</span><span class="ident" id="6931003">Done</span><span class="op" id="6931007">(</span><span class="op" id="6931008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6931011">}</span><span class="op" id="6931012">(</span><span class="op" id="6931013">)</span><br>
<span class="lineno">1910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6931016">//&nbsp;Wait&nbsp;until&nbsp;the&nbsp;goroutine&nbsp;we&#39;ve&nbsp;just&nbsp;created&nbsp;has&nbsp;started&nbsp;waiting.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6931085">&lt;-</span><span class="ident" id="6931087">drv</span><span class="op" id="6931090">.</span><span class="ident" id="6931091">waitingCh</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6931102">//&nbsp;Now&nbsp;close&nbsp;the&nbsp;busy&nbsp;connections.&nbsp;This&nbsp;provides&nbsp;a&nbsp;connection&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6931169">//&nbsp;the&nbsp;blocked&nbsp;goroutine&nbsp;and&nbsp;then&nbsp;fills&nbsp;up&nbsp;the&nbsp;idle&nbsp;queue.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6931229">for</span>&nbsp;<span class="ident" id="6931233">_</span><span class="op" id="6931234">,</span>&nbsp;<span class="ident" id="6931236">v</span>&nbsp;<span class="op" id="6931238">:=</span>&nbsp;<span class="keyword" id="6931241">range</span>&nbsp;<span class="ident" id="6931247">rows</span>&nbsp;<span class="op" id="6931252">{</span><br>
<span class="lineno">1915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6931256">v</span><span class="op" id="6931257">.</span><span class="ident" id="6931258">Close</span><span class="op" id="6931263">(</span><span class="op" id="6931264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6931267">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6931270">//&nbsp;At&nbsp;this&nbsp;point&nbsp;we&nbsp;give&nbsp;the&nbsp;new&nbsp;connection&nbsp;to&nbsp;DB.&nbsp;This&nbsp;connection&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6931341">//&nbsp;now&nbsp;useless,&nbsp;since&nbsp;the&nbsp;idle&nbsp;queue&nbsp;is&nbsp;full&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;pending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6931412">//&nbsp;requests.&nbsp;DB&nbsp;should&nbsp;deal&nbsp;with&nbsp;this&nbsp;situation&nbsp;without&nbsp;leaking&nbsp;the</span><br>
<span class="lineno">1920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6931481">//&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6931497">drv</span><span class="op" id="6931500">.</span><span class="ident" id="6931501">waitCh</span>&nbsp;<span class="op" id="6931508">&lt;-</span>&nbsp;<span class="keyword" id="6931511">struct</span><span class="op" id="6931517">{</span><span class="op" id="6931518">}</span><span class="op" id="6931519">{</span><span class="op" id="6931520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6931523">wg</span><span class="op" id="6931525">.</span><span class="ident" id="6931526">Wait</span><span class="op" id="6931530">(</span><span class="op" id="6931531">)</span><br>
<span class="lineno"></span><span class="op" id="6931533">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1925</span><span class="keyword" id="6931536">func</span>&nbsp;<span class="ident" id="6931541">BenchmarkConcurrentDBExec</span><span class="op" id="6931566">(</span><span class="ident" id="6931567">b</span>&nbsp;<span class="op" id="6931569">*</span><span class="ident" id="6931570">testing</span><span class="op" id="6931577">.</span><span class="ident" id="6931578">B</span><span class="op" id="6931579">)</span>&nbsp;<span class="op" id="6931581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6931584">b</span><span class="op" id="6931585">.</span><span class="ident" id="6931586">ReportAllocs</span><span class="op" id="6931598">(</span><span class="op" id="6931599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6931602">ct</span>&nbsp;<span class="op" id="6931605">:=</span>&nbsp;<span class="builtinfunc" id="6931608">new</span><span class="op" id="6931611">(</span><span class="ident" id="6931612">concurrentDBExecTest</span><span class="op" id="6931632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6931635">for</span>&nbsp;<span class="ident" id="6931639">i</span>&nbsp;<span class="op" id="6931641">:=</span>&nbsp;<span class="num" id="6931644">0</span><span class="op" id="6931645">;</span>&nbsp;<span class="ident" id="6931647">i</span>&nbsp;<span class="op" id="6931649">&lt;</span>&nbsp;<span class="ident" id="6931651">b</span><span class="op" id="6931652">.</span><span class="ident" id="6931653">N</span><span class="op" id="6931654">;</span>&nbsp;<span class="ident" id="6931656">i</span><span class="op" id="6931657">++</span>&nbsp;<span class="op" id="6931660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6931664">doConcurrentTest</span><span class="op" id="6931680">(</span><span class="ident" id="6931681">b</span><span class="op" id="6931682">,</span>&nbsp;<span class="ident" id="6931684">ct</span><span class="op" id="6931686">)</span><br>
<span class="lineno">1930</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6931689">}</span><br>
<span class="lineno"></span><span class="op" id="6931691">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6931694">func</span>&nbsp;<span class="ident" id="6931699">BenchmarkConcurrentStmtQuery</span><span class="op" id="6931727">(</span><span class="ident" id="6931728">b</span>&nbsp;<span class="op" id="6931730">*</span><span class="ident" id="6931731">testing</span><span class="op" id="6931738">.</span><span class="ident" id="6931739">B</span><span class="op" id="6931740">)</span>&nbsp;<span class="op" id="6931742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6931745">b</span><span class="op" id="6931746">.</span><span class="ident" id="6931747">ReportAllocs</span><span class="op" id="6931759">(</span><span class="op" id="6931760">)</span><br>
<span class="lineno">1935</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6931763">ct</span>&nbsp;<span class="op" id="6931766">:=</span>&nbsp;<span class="builtinfunc" id="6931769">new</span><span class="op" id="6931772">(</span><span class="ident" id="6931773">concurrentStmtQueryTest</span><span class="op" id="6931796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6931799">for</span>&nbsp;<span class="ident" id="6931803">i</span>&nbsp;<span class="op" id="6931805">:=</span>&nbsp;<span class="num" id="6931808">0</span><span class="op" id="6931809">;</span>&nbsp;<span class="ident" id="6931811">i</span>&nbsp;<span class="op" id="6931813">&lt;</span>&nbsp;<span class="ident" id="6931815">b</span><span class="op" id="6931816">.</span><span class="ident" id="6931817">N</span><span class="op" id="6931818">;</span>&nbsp;<span class="ident" id="6931820">i</span><span class="op" id="6931821">++</span>&nbsp;<span class="op" id="6931824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6931828">doConcurrentTest</span><span class="op" id="6931844">(</span><span class="ident" id="6931845">b</span><span class="op" id="6931846">,</span>&nbsp;<span class="ident" id="6931848">ct</span><span class="op" id="6931850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6931853">}</span><br>
<span class="lineno"></span><span class="op" id="6931855">}</span><br>
<span class="lineno">1940</span><br>
<span class="lineno"></span><span class="keyword" id="6931858">func</span>&nbsp;<span class="ident" id="6931863">BenchmarkConcurrentStmtExec</span><span class="op" id="6931890">(</span><span class="ident" id="6931891">b</span>&nbsp;<span class="op" id="6931893">*</span><span class="ident" id="6931894">testing</span><span class="op" id="6931901">.</span><span class="ident" id="6931902">B</span><span class="op" id="6931903">)</span>&nbsp;<span class="op" id="6931905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6931908">b</span><span class="op" id="6931909">.</span><span class="ident" id="6931910">ReportAllocs</span><span class="op" id="6931922">(</span><span class="op" id="6931923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6931926">ct</span>&nbsp;<span class="op" id="6931929">:=</span>&nbsp;<span class="builtinfunc" id="6931932">new</span><span class="op" id="6931935">(</span><span class="ident" id="6931936">concurrentStmtExecTest</span><span class="op" id="6931958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6931961">for</span>&nbsp;<span class="ident" id="6931965">i</span>&nbsp;<span class="op" id="6931967">:=</span>&nbsp;<span class="num" id="6931970">0</span><span class="op" id="6931971">;</span>&nbsp;<span class="ident" id="6931973">i</span>&nbsp;<span class="op" id="6931975">&lt;</span>&nbsp;<span class="ident" id="6931977">b</span><span class="op" id="6931978">.</span><span class="ident" id="6931979">N</span><span class="op" id="6931980">;</span>&nbsp;<span class="ident" id="6931982">i</span><span class="op" id="6931983">++</span>&nbsp;<span class="op" id="6931986">{</span><br>
<span class="lineno">1945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6931990">doConcurrentTest</span><span class="op" id="6932006">(</span><span class="ident" id="6932007">b</span><span class="op" id="6932008">,</span>&nbsp;<span class="ident" id="6932010">ct</span><span class="op" id="6932012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6932015">}</span><br>
<span class="lineno"></span><span class="op" id="6932017">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6932020">func</span>&nbsp;<span class="ident" id="6932025">BenchmarkConcurrentTxQuery</span><span class="op" id="6932051">(</span><span class="ident" id="6932052">b</span>&nbsp;<span class="op" id="6932054">*</span><span class="ident" id="6932055">testing</span><span class="op" id="6932062">.</span><span class="ident" id="6932063">B</span><span class="op" id="6932064">)</span>&nbsp;<span class="op" id="6932066">{</span><br>
<span class="lineno">1950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6932069">b</span><span class="op" id="6932070">.</span><span class="ident" id="6932071">ReportAllocs</span><span class="op" id="6932083">(</span><span class="op" id="6932084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6932087">ct</span>&nbsp;<span class="op" id="6932090">:=</span>&nbsp;<span class="builtinfunc" id="6932093">new</span><span class="op" id="6932096">(</span><span class="ident" id="6932097">concurrentTxQueryTest</span><span class="op" id="6932118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6932121">for</span>&nbsp;<span class="ident" id="6932125">i</span>&nbsp;<span class="op" id="6932127">:=</span>&nbsp;<span class="num" id="6932130">0</span><span class="op" id="6932131">;</span>&nbsp;<span class="ident" id="6932133">i</span>&nbsp;<span class="op" id="6932135">&lt;</span>&nbsp;<span class="ident" id="6932137">b</span><span class="op" id="6932138">.</span><span class="ident" id="6932139">N</span><span class="op" id="6932140">;</span>&nbsp;<span class="ident" id="6932142">i</span><span class="op" id="6932143">++</span>&nbsp;<span class="op" id="6932146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6932150">doConcurrentTest</span><span class="op" id="6932166">(</span><span class="ident" id="6932167">b</span><span class="op" id="6932168">,</span>&nbsp;<span class="ident" id="6932170">ct</span><span class="op" id="6932172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6932175">}</span><br>
<span class="lineno">1955</span><span class="op" id="6932177">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6932180">func</span>&nbsp;<span class="ident" id="6932185">BenchmarkConcurrentTxExec</span><span class="op" id="6932210">(</span><span class="ident" id="6932211">b</span>&nbsp;<span class="op" id="6932213">*</span><span class="ident" id="6932214">testing</span><span class="op" id="6932221">.</span><span class="ident" id="6932222">B</span><span class="op" id="6932223">)</span>&nbsp;<span class="op" id="6932225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6932228">b</span><span class="op" id="6932229">.</span><span class="ident" id="6932230">ReportAllocs</span><span class="op" id="6932242">(</span><span class="op" id="6932243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6932246">ct</span>&nbsp;<span class="op" id="6932249">:=</span>&nbsp;<span class="builtinfunc" id="6932252">new</span><span class="op" id="6932255">(</span><span class="ident" id="6932256">concurrentTxExecTest</span><span class="op" id="6932276">)</span><br>
<span class="lineno">1960</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6932279">for</span>&nbsp;<span class="ident" id="6932283">i</span>&nbsp;<span class="op" id="6932285">:=</span>&nbsp;<span class="num" id="6932288">0</span><span class="op" id="6932289">;</span>&nbsp;<span class="ident" id="6932291">i</span>&nbsp;<span class="op" id="6932293">&lt;</span>&nbsp;<span class="ident" id="6932295">b</span><span class="op" id="6932296">.</span><span class="ident" id="6932297">N</span><span class="op" id="6932298">;</span>&nbsp;<span class="ident" id="6932300">i</span><span class="op" id="6932301">++</span>&nbsp;<span class="op" id="6932304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6932308">doConcurrentTest</span><span class="op" id="6932324">(</span><span class="ident" id="6932325">b</span><span class="op" id="6932326">,</span>&nbsp;<span class="ident" id="6932328">ct</span><span class="op" id="6932330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6932333">}</span><br>
<span class="lineno"></span><span class="op" id="6932335">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1965</span><span class="keyword" id="6932338">func</span>&nbsp;<span class="ident" id="6932343">BenchmarkConcurrentTxStmtQuery</span><span class="op" id="6932373">(</span><span class="ident" id="6932374">b</span>&nbsp;<span class="op" id="6932376">*</span><span class="ident" id="6932377">testing</span><span class="op" id="6932384">.</span><span class="ident" id="6932385">B</span><span class="op" id="6932386">)</span>&nbsp;<span class="op" id="6932388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6932391">b</span><span class="op" id="6932392">.</span><span class="ident" id="6932393">ReportAllocs</span><span class="op" id="6932405">(</span><span class="op" id="6932406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6932409">ct</span>&nbsp;<span class="op" id="6932412">:=</span>&nbsp;<span class="builtinfunc" id="6932415">new</span><span class="op" id="6932418">(</span><span class="ident" id="6932419">concurrentTxStmtQueryTest</span><span class="op" id="6932444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6932447">for</span>&nbsp;<span class="ident" id="6932451">i</span>&nbsp;<span class="op" id="6932453">:=</span>&nbsp;<span class="num" id="6932456">0</span><span class="op" id="6932457">;</span>&nbsp;<span class="ident" id="6932459">i</span>&nbsp;<span class="op" id="6932461">&lt;</span>&nbsp;<span class="ident" id="6932463">b</span><span class="op" id="6932464">.</span><span class="ident" id="6932465">N</span><span class="op" id="6932466">;</span>&nbsp;<span class="ident" id="6932468">i</span><span class="op" id="6932469">++</span>&nbsp;<span class="op" id="6932472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6932476">doConcurrentTest</span><span class="op" id="6932492">(</span><span class="ident" id="6932493">b</span><span class="op" id="6932494">,</span>&nbsp;<span class="ident" id="6932496">ct</span><span class="op" id="6932498">)</span><br>
<span class="lineno">1970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6932501">}</span><br>
<span class="lineno"></span><span class="op" id="6932503">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6932506">func</span>&nbsp;<span class="ident" id="6932511">BenchmarkConcurrentTxStmtExec</span><span class="op" id="6932540">(</span><span class="ident" id="6932541">b</span>&nbsp;<span class="op" id="6932543">*</span><span class="ident" id="6932544">testing</span><span class="op" id="6932551">.</span><span class="ident" id="6932552">B</span><span class="op" id="6932553">)</span>&nbsp;<span class="op" id="6932555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6932558">b</span><span class="op" id="6932559">.</span><span class="ident" id="6932560">ReportAllocs</span><span class="op" id="6932572">(</span><span class="op" id="6932573">)</span><br>
<span class="lineno">1975</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6932576">ct</span>&nbsp;<span class="op" id="6932579">:=</span>&nbsp;<span class="builtinfunc" id="6932582">new</span><span class="op" id="6932585">(</span><span class="ident" id="6932586">concurrentTxStmtExecTest</span><span class="op" id="6932610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6932613">for</span>&nbsp;<span class="ident" id="6932617">i</span>&nbsp;<span class="op" id="6932619">:=</span>&nbsp;<span class="num" id="6932622">0</span><span class="op" id="6932623">;</span>&nbsp;<span class="ident" id="6932625">i</span>&nbsp;<span class="op" id="6932627">&lt;</span>&nbsp;<span class="ident" id="6932629">b</span><span class="op" id="6932630">.</span><span class="ident" id="6932631">N</span><span class="op" id="6932632">;</span>&nbsp;<span class="ident" id="6932634">i</span><span class="op" id="6932635">++</span>&nbsp;<span class="op" id="6932638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6932642">doConcurrentTest</span><span class="op" id="6932658">(</span><span class="ident" id="6932659">b</span><span class="op" id="6932660">,</span>&nbsp;<span class="ident" id="6932662">ct</span><span class="op" id="6932664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6932667">}</span><br>
<span class="lineno"></span><span class="op" id="6932669">}</span><br>
<span class="lineno">1980</span><br>
<span class="lineno"></span><span class="keyword" id="6932672">func</span>&nbsp;<span class="ident" id="6932677">BenchmarkConcurrentRandom</span><span class="op" id="6932702">(</span><span class="ident" id="6932703">b</span>&nbsp;<span class="op" id="6932705">*</span><span class="ident" id="6932706">testing</span><span class="op" id="6932713">.</span><span class="ident" id="6932714">B</span><span class="op" id="6932715">)</span>&nbsp;<span class="op" id="6932717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6932720">b</span><span class="op" id="6932721">.</span><span class="ident" id="6932722">ReportAllocs</span><span class="op" id="6932734">(</span><span class="op" id="6932735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6932738">ct</span>&nbsp;<span class="op" id="6932741">:=</span>&nbsp;<span class="builtinfunc" id="6932744">new</span><span class="op" id="6932747">(</span><span class="ident" id="6932748">concurrentRandomTest</span><span class="op" id="6932768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6932771">for</span>&nbsp;<span class="ident" id="6932775">i</span>&nbsp;<span class="op" id="6932777">:=</span>&nbsp;<span class="num" id="6932780">0</span><span class="op" id="6932781">;</span>&nbsp;<span class="ident" id="6932783">i</span>&nbsp;<span class="op" id="6932785">&lt;</span>&nbsp;<span class="ident" id="6932787">b</span><span class="op" id="6932788">.</span><span class="ident" id="6932789">N</span><span class="op" id="6932790">;</span>&nbsp;<span class="ident" id="6932792">i</span><span class="op" id="6932793">++</span>&nbsp;<span class="op" id="6932796">{</span><br>
<span class="lineno">1985</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6932800">doConcurrentTest</span><span class="op" id="6932816">(</span><span class="ident" id="6932817">b</span><span class="op" id="6932818">,</span>&nbsp;<span class="ident" id="6932820">ct</span><span class="op" id="6932822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6932825">}</span><br>
<span class="lineno"></span><span class="op" id="6932827">}</span>
</div>
</body>
</html>
