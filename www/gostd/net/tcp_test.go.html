<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html" class="current">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6711404">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6711459">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6711513">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6711564">package</span>&nbsp;<span class="ident" id="6711572">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6711577">import</span>&nbsp;<span class="op" id="6711584">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6711587">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6711594">&#34;io&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6711600">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6711611">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6711622">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6711630">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6711641">&#34;time&#34;</span><br>
<span class="lineno">15</span><span class="op" id="6711648">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6711651">func</span>&nbsp;<span class="ident" id="6711656">BenchmarkTCP4OneShot</span><span class="op" id="6711676">(</span><span class="ident" id="6711677">b</span>&nbsp;<span class="op" id="6711679">*</span><span class="ident" id="6711680">testing</span><span class="op" id="6711687">.</span><span class="ident" id="6711688">B</span><span class="op" id="6711689">)</span>&nbsp;<span class="op" id="6711691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6711694">benchmarkTCP</span><span class="op" id="6711706">(</span><span class="ident" id="6711707">b</span><span class="op" id="6711708">,</span>&nbsp;<span class="builtintype" id="6711710">false</span><span class="op" id="6711715">,</span>&nbsp;<span class="builtintype" id="6711717">false</span><span class="op" id="6711722">,</span>&nbsp;<span class="string" id="6711724">&#34;127.0.0.1:0&#34;</span><span class="op" id="6711737">)</span><br>
<span class="lineno"></span><span class="op" id="6711739">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="6711742">func</span>&nbsp;<span class="ident" id="6711747">BenchmarkTCP4OneShotTimeout</span><span class="op" id="6711774">(</span><span class="ident" id="6711775">b</span>&nbsp;<span class="op" id="6711777">*</span><span class="ident" id="6711778">testing</span><span class="op" id="6711785">.</span><span class="ident" id="6711786">B</span><span class="op" id="6711787">)</span>&nbsp;<span class="op" id="6711789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6711792">benchmarkTCP</span><span class="op" id="6711804">(</span><span class="ident" id="6711805">b</span><span class="op" id="6711806">,</span>&nbsp;<span class="builtintype" id="6711808">false</span><span class="op" id="6711813">,</span>&nbsp;<span class="builtintype" id="6711815">true</span><span class="op" id="6711819">,</span>&nbsp;<span class="string" id="6711821">&#34;127.0.0.1:0&#34;</span><span class="op" id="6711834">)</span><br>
<span class="lineno"></span><span class="op" id="6711836">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="6711839">func</span>&nbsp;<span class="ident" id="6711844">BenchmarkTCP4Persistent</span><span class="op" id="6711867">(</span><span class="ident" id="6711868">b</span>&nbsp;<span class="op" id="6711870">*</span><span class="ident" id="6711871">testing</span><span class="op" id="6711878">.</span><span class="ident" id="6711879">B</span><span class="op" id="6711880">)</span>&nbsp;<span class="op" id="6711882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6711885">benchmarkTCP</span><span class="op" id="6711897">(</span><span class="ident" id="6711898">b</span><span class="op" id="6711899">,</span>&nbsp;<span class="builtintype" id="6711901">true</span><span class="op" id="6711905">,</span>&nbsp;<span class="builtintype" id="6711907">false</span><span class="op" id="6711912">,</span>&nbsp;<span class="string" id="6711914">&#34;127.0.0.1:0&#34;</span><span class="op" id="6711927">)</span><br>
<span class="lineno"></span><span class="op" id="6711929">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6711932">func</span>&nbsp;<span class="ident" id="6711937">BenchmarkTCP4PersistentTimeout</span><span class="op" id="6711967">(</span><span class="ident" id="6711968">b</span>&nbsp;<span class="op" id="6711970">*</span><span class="ident" id="6711971">testing</span><span class="op" id="6711978">.</span><span class="ident" id="6711979">B</span><span class="op" id="6711980">)</span>&nbsp;<span class="op" id="6711982">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6711985">benchmarkTCP</span><span class="op" id="6711997">(</span><span class="ident" id="6711998">b</span><span class="op" id="6711999">,</span>&nbsp;<span class="builtintype" id="6712001">true</span><span class="op" id="6712005">,</span>&nbsp;<span class="builtintype" id="6712007">true</span><span class="op" id="6712011">,</span>&nbsp;<span class="string" id="6712013">&#34;127.0.0.1:0&#34;</span><span class="op" id="6712026">)</span><br>
<span class="lineno"></span><span class="op" id="6712028">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6712031">func</span>&nbsp;<span class="ident" id="6712036">BenchmarkTCP6OneShot</span><span class="op" id="6712056">(</span><span class="ident" id="6712057">b</span>&nbsp;<span class="op" id="6712059">*</span><span class="ident" id="6712060">testing</span><span class="op" id="6712067">.</span><span class="ident" id="6712068">B</span><span class="op" id="6712069">)</span>&nbsp;<span class="op" id="6712071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6712074">if</span>&nbsp;<span class="op" id="6712077">!</span><span class="ident" id="6712078">supportsIPv6</span>&nbsp;<span class="op" id="6712091">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6712095">b</span><span class="op" id="6712096">.</span><span class="ident" id="6712097">Skip</span><span class="op" id="6712101">(</span><span class="string" id="6712102">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="6712125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6712128">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6712131">benchmarkTCP</span><span class="op" id="6712143">(</span><span class="ident" id="6712144">b</span><span class="op" id="6712145">,</span>&nbsp;<span class="builtintype" id="6712147">false</span><span class="op" id="6712152">,</span>&nbsp;<span class="builtintype" id="6712154">false</span><span class="op" id="6712159">,</span>&nbsp;<span class="string" id="6712161">&#34;[::1]:0&#34;</span><span class="op" id="6712170">)</span><br>
<span class="lineno"></span><span class="op" id="6712172">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="6712175">func</span>&nbsp;<span class="ident" id="6712180">BenchmarkTCP6OneShotTimeout</span><span class="op" id="6712207">(</span><span class="ident" id="6712208">b</span>&nbsp;<span class="op" id="6712210">*</span><span class="ident" id="6712211">testing</span><span class="op" id="6712218">.</span><span class="ident" id="6712219">B</span><span class="op" id="6712220">)</span>&nbsp;<span class="op" id="6712222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6712225">if</span>&nbsp;<span class="op" id="6712228">!</span><span class="ident" id="6712229">supportsIPv6</span>&nbsp;<span class="op" id="6712242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6712246">b</span><span class="op" id="6712247">.</span><span class="ident" id="6712248">Skip</span><span class="op" id="6712252">(</span><span class="string" id="6712253">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="6712276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6712279">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6712282">benchmarkTCP</span><span class="op" id="6712294">(</span><span class="ident" id="6712295">b</span><span class="op" id="6712296">,</span>&nbsp;<span class="builtintype" id="6712298">false</span><span class="op" id="6712303">,</span>&nbsp;<span class="builtintype" id="6712305">true</span><span class="op" id="6712309">,</span>&nbsp;<span class="string" id="6712311">&#34;[::1]:0&#34;</span><span class="op" id="6712320">)</span><br>
<span class="lineno">45</span><span class="op" id="6712322">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6712325">func</span>&nbsp;<span class="ident" id="6712330">BenchmarkTCP6Persistent</span><span class="op" id="6712353">(</span><span class="ident" id="6712354">b</span>&nbsp;<span class="op" id="6712356">*</span><span class="ident" id="6712357">testing</span><span class="op" id="6712364">.</span><span class="ident" id="6712365">B</span><span class="op" id="6712366">)</span>&nbsp;<span class="op" id="6712368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6712371">if</span>&nbsp;<span class="op" id="6712374">!</span><span class="ident" id="6712375">supportsIPv6</span>&nbsp;<span class="op" id="6712388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6712392">b</span><span class="op" id="6712393">.</span><span class="ident" id="6712394">Skip</span><span class="op" id="6712398">(</span><span class="string" id="6712399">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="6712422">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6712425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6712428">benchmarkTCP</span><span class="op" id="6712440">(</span><span class="ident" id="6712441">b</span><span class="op" id="6712442">,</span>&nbsp;<span class="builtintype" id="6712444">true</span><span class="op" id="6712448">,</span>&nbsp;<span class="builtintype" id="6712450">false</span><span class="op" id="6712455">,</span>&nbsp;<span class="string" id="6712457">&#34;[::1]:0&#34;</span><span class="op" id="6712466">)</span><br>
<span class="lineno"></span><span class="op" id="6712468">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6712471">func</span>&nbsp;<span class="ident" id="6712476">BenchmarkTCP6PersistentTimeout</span><span class="op" id="6712506">(</span><span class="ident" id="6712507">b</span>&nbsp;<span class="op" id="6712509">*</span><span class="ident" id="6712510">testing</span><span class="op" id="6712517">.</span><span class="ident" id="6712518">B</span><span class="op" id="6712519">)</span>&nbsp;<span class="op" id="6712521">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6712524">if</span>&nbsp;<span class="op" id="6712527">!</span><span class="ident" id="6712528">supportsIPv6</span>&nbsp;<span class="op" id="6712541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6712545">b</span><span class="op" id="6712546">.</span><span class="ident" id="6712547">Skip</span><span class="op" id="6712551">(</span><span class="string" id="6712552">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="6712575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6712578">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6712581">benchmarkTCP</span><span class="op" id="6712593">(</span><span class="ident" id="6712594">b</span><span class="op" id="6712595">,</span>&nbsp;<span class="builtintype" id="6712597">true</span><span class="op" id="6712601">,</span>&nbsp;<span class="builtintype" id="6712603">true</span><span class="op" id="6712607">,</span>&nbsp;<span class="string" id="6712609">&#34;[::1]:0&#34;</span><span class="op" id="6712618">)</span><br>
<span class="lineno"></span><span class="op" id="6712620">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="6712623">func</span>&nbsp;<span class="ident" id="6712628">benchmarkTCP</span><span class="op" id="6712640">(</span><span class="ident" id="6712641">b</span>&nbsp;<span class="op" id="6712643">*</span><span class="ident" id="6712644">testing</span><span class="op" id="6712651">.</span><span class="ident" id="6712652">B</span><span class="op" id="6712653">,</span>&nbsp;<span class="ident" id="6712655">persistent</span><span class="op" id="6712665">,</span>&nbsp;<span class="ident" id="6712667">timeout</span>&nbsp;<span class="builtintype" id="6712675">bool</span><span class="op" id="6712679">,</span>&nbsp;<span class="ident" id="6712681">laddr</span>&nbsp;<span class="builtintype" id="6712687">string</span><span class="op" id="6712693">)</span>&nbsp;<span class="op" id="6712695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6712698">const</span>&nbsp;<span class="ident" id="6712704">msgLen</span>&nbsp;<span class="op" id="6712711">=</span>&nbsp;<span class="num" id="6712713">512</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6712718">conns</span>&nbsp;<span class="op" id="6712724">:=</span>&nbsp;<span class="ident" id="6712727">b</span><span class="op" id="6712728">.</span><span class="ident" id="6712729">N</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6712732">numConcurrent</span>&nbsp;<span class="op" id="6712746">:=</span>&nbsp;<span class="ident" id="6712749">runtime</span><span class="op" id="6712756">.</span><span class="ident" id="6712757">GOMAXPROCS</span><span class="op" id="6712767">(</span><span class="op" id="6712768">-</span><span class="num" id="6712769">1</span><span class="op" id="6712770">)</span>&nbsp;<span class="op" id="6712772">*</span>&nbsp;<span class="num" id="6712774">2</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6712777">msgs</span>&nbsp;<span class="op" id="6712782">:=</span>&nbsp;<span class="num" id="6712785">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6712788">if</span>&nbsp;<span class="ident" id="6712791">persistent</span>&nbsp;<span class="op" id="6712802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6712806">conns</span>&nbsp;<span class="op" id="6712812">=</span>&nbsp;<span class="ident" id="6712814">numConcurrent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6712830">msgs</span>&nbsp;<span class="op" id="6712835">=</span>&nbsp;<span class="ident" id="6712837">b</span><span class="op" id="6712838">.</span><span class="ident" id="6712839">N</span>&nbsp;<span class="op" id="6712841">/</span>&nbsp;<span class="ident" id="6712843">conns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6712851">if</span>&nbsp;<span class="ident" id="6712854">msgs</span>&nbsp;<span class="op" id="6712859">==</span>&nbsp;<span class="num" id="6712862">0</span>&nbsp;<span class="op" id="6712864">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6712869">msgs</span>&nbsp;<span class="op" id="6712874">=</span>&nbsp;<span class="num" id="6712876">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6712880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6712884">if</span>&nbsp;<span class="ident" id="6712887">conns</span>&nbsp;<span class="op" id="6712893">&gt;</span>&nbsp;<span class="ident" id="6712895">b</span><span class="op" id="6712896">.</span><span class="ident" id="6712897">N</span>&nbsp;<span class="op" id="6712899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6712904">conns</span>&nbsp;<span class="op" id="6712910">=</span>&nbsp;<span class="ident" id="6712912">b</span><span class="op" id="6712913">.</span><span class="ident" id="6712914">N</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6712918">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6712921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6712924">sendMsg</span>&nbsp;<span class="op" id="6712932">:=</span>&nbsp;<span class="keyword" id="6712935">func</span><span class="op" id="6712939">(</span><span class="ident" id="6712940">c</span>&nbsp;<span class="ident" id="6712942">Conn</span><span class="op" id="6712946">,</span>&nbsp;<span class="ident" id="6712948">buf</span>&nbsp;<span class="op" id="6712952">[</span><span class="op" id="6712953">]</span><span class="builtintype" id="6712954">byte</span><span class="op" id="6712958">)</span>&nbsp;<span class="builtintype" id="6712960">bool</span>&nbsp;<span class="op" id="6712965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6712969">n</span><span class="op" id="6712970">,</span>&nbsp;<span class="ident" id="6712972">err</span>&nbsp;<span class="op" id="6712976">:=</span>&nbsp;<span class="ident" id="6712979">c</span><span class="op" id="6712980">.</span><span class="ident" id="6712981">Write</span><span class="op" id="6712986">(</span><span class="ident" id="6712987">buf</span><span class="op" id="6712990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6712994">if</span>&nbsp;<span class="ident" id="6712997">n</span>&nbsp;<span class="op" id="6712999">!=</span>&nbsp;<span class="builtinfunc" id="6713002">len</span><span class="op" id="6713005">(</span><span class="ident" id="6713006">buf</span><span class="op" id="6713009">)</span>&nbsp;<span class="op" id="6713011">||</span>&nbsp;<span class="ident" id="6713014">err</span>&nbsp;<span class="op" id="6713018">!=</span>&nbsp;<span class="ident" id="6713021">nil</span>&nbsp;<span class="op" id="6713025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6713030">b</span><span class="op" id="6713031">.</span><span class="ident" id="6713032">Logf</span><span class="op" id="6713036">(</span><span class="string" id="6713037">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6713055">,</span>&nbsp;<span class="ident" id="6713057">err</span><span class="op" id="6713060">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6713065">return</span>&nbsp;<span class="builtintype" id="6713072">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6713080">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6713084">return</span>&nbsp;<span class="builtintype" id="6713091">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6713097">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6713100">recvMsg</span>&nbsp;<span class="op" id="6713108">:=</span>&nbsp;<span class="keyword" id="6713111">func</span><span class="op" id="6713115">(</span><span class="ident" id="6713116">c</span>&nbsp;<span class="ident" id="6713118">Conn</span><span class="op" id="6713122">,</span>&nbsp;<span class="ident" id="6713124">buf</span>&nbsp;<span class="op" id="6713128">[</span><span class="op" id="6713129">]</span><span class="builtintype" id="6713130">byte</span><span class="op" id="6713134">)</span>&nbsp;<span class="builtintype" id="6713136">bool</span>&nbsp;<span class="op" id="6713141">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6713145">for</span>&nbsp;<span class="ident" id="6713149">read</span>&nbsp;<span class="op" id="6713154">:=</span>&nbsp;<span class="num" id="6713157">0</span><span class="op" id="6713158">;</span>&nbsp;<span class="ident" id="6713160">read</span>&nbsp;<span class="op" id="6713165">!=</span>&nbsp;<span class="builtinfunc" id="6713168">len</span><span class="op" id="6713171">(</span><span class="ident" id="6713172">buf</span><span class="op" id="6713175">)</span><span class="op" id="6713176">;</span>&nbsp;<span class="op" id="6713178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6713183">n</span><span class="op" id="6713184">,</span>&nbsp;<span class="ident" id="6713186">err</span>&nbsp;<span class="op" id="6713190">:=</span>&nbsp;<span class="ident" id="6713193">c</span><span class="op" id="6713194">.</span><span class="ident" id="6713195">Read</span><span class="op" id="6713199">(</span><span class="ident" id="6713200">buf</span><span class="op" id="6713203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6713208">read</span>&nbsp;<span class="op" id="6713213">+=</span>&nbsp;<span class="ident" id="6713216">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6713221">if</span>&nbsp;<span class="ident" id="6713224">err</span>&nbsp;<span class="op" id="6713228">!=</span>&nbsp;<span class="ident" id="6713231">nil</span>&nbsp;<span class="op" id="6713235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6713241">b</span><span class="op" id="6713242">.</span><span class="ident" id="6713243">Logf</span><span class="op" id="6713247">(</span><span class="string" id="6713248">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6713265">,</span>&nbsp;<span class="ident" id="6713267">err</span><span class="op" id="6713270">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6713276">return</span>&nbsp;<span class="builtintype" id="6713283">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6713292">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6713296">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6713300">return</span>&nbsp;<span class="builtintype" id="6713307">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6713313">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6713316">ln</span><span class="op" id="6713318">,</span>&nbsp;<span class="ident" id="6713320">err</span>&nbsp;<span class="op" id="6713324">:=</span>&nbsp;<span class="ident" id="6713327">Listen</span><span class="op" id="6713333">(</span><span class="string" id="6713334">&#34;tcp&#34;</span><span class="op" id="6713339">,</span>&nbsp;<span class="ident" id="6713341">laddr</span><span class="op" id="6713346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6713349">if</span>&nbsp;<span class="ident" id="6713352">err</span>&nbsp;<span class="op" id="6713356">!=</span>&nbsp;<span class="ident" id="6713359">nil</span>&nbsp;<span class="op" id="6713363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6713367">b</span><span class="op" id="6713368">.</span><span class="ident" id="6713369">Fatalf</span><span class="op" id="6713375">(</span><span class="string" id="6713376">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6713395">,</span>&nbsp;<span class="ident" id="6713397">err</span><span class="op" id="6713400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6713403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6713406">defer</span>&nbsp;<span class="ident" id="6713412">ln</span><span class="op" id="6713414">.</span><span class="ident" id="6713415">Close</span><span class="op" id="6713420">(</span><span class="op" id="6713421">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6713424">serverSem</span>&nbsp;<span class="op" id="6713434">:=</span>&nbsp;<span class="builtinfunc" id="6713437">make</span><span class="op" id="6713441">(</span><span class="keyword" id="6713442">chan</span>&nbsp;<span class="builtintype" id="6713447">bool</span><span class="op" id="6713451">,</span>&nbsp;<span class="ident" id="6713453">numConcurrent</span><span class="op" id="6713466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6713469">//&nbsp;Acceptor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6713483">go</span>&nbsp;<span class="keyword" id="6713486">func</span><span class="op" id="6713490">(</span><span class="op" id="6713491">)</span>&nbsp;<span class="op" id="6713493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6713497">for</span>&nbsp;<span class="op" id="6713501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6713506">c</span><span class="op" id="6713507">,</span>&nbsp;<span class="ident" id="6713509">err</span>&nbsp;<span class="op" id="6713513">:=</span>&nbsp;<span class="ident" id="6713516">ln</span><span class="op" id="6713518">.</span><span class="ident" id="6713519">Accept</span><span class="op" id="6713525">(</span><span class="op" id="6713526">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6713531">if</span>&nbsp;<span class="ident" id="6713534">err</span>&nbsp;<span class="op" id="6713538">!=</span>&nbsp;<span class="ident" id="6713541">nil</span>&nbsp;<span class="op" id="6713545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6713551">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6713560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6713565">serverSem</span>&nbsp;<span class="op" id="6713575">&lt;-</span>&nbsp;<span class="builtintype" id="6713578">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6713586">//&nbsp;Server&nbsp;connection.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6713611">go</span>&nbsp;<span class="keyword" id="6713614">func</span><span class="op" id="6713618">(</span><span class="ident" id="6713619">c</span>&nbsp;<span class="ident" id="6713621">Conn</span><span class="op" id="6713625">)</span>&nbsp;<span class="op" id="6713627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6713633">defer</span>&nbsp;<span class="keyword" id="6713639">func</span><span class="op" id="6713643">(</span><span class="op" id="6713644">)</span>&nbsp;<span class="op" id="6713646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6713653">c</span><span class="op" id="6713654">.</span><span class="ident" id="6713655">Close</span><span class="op" id="6713660">(</span><span class="op" id="6713661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6713668">&lt;-</span><span class="ident" id="6713670">serverSem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6713684">}</span><span class="op" id="6713685">(</span><span class="op" id="6713686">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6713692">if</span>&nbsp;<span class="ident" id="6713695">timeout</span>&nbsp;<span class="op" id="6713703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6713710">c</span><span class="op" id="6713711">.</span><span class="ident" id="6713712">SetDeadline</span><span class="op" id="6713723">(</span><span class="ident" id="6713724">time</span><span class="op" id="6713728">.</span><span class="ident" id="6713729">Now</span><span class="op" id="6713732">(</span><span class="op" id="6713733">)</span><span class="op" id="6713734">.</span><span class="ident" id="6713735">Add</span><span class="op" id="6713738">(</span><span class="ident" id="6713739">time</span><span class="op" id="6713743">.</span><span class="ident" id="6713744">Hour</span><span class="op" id="6713748">)</span><span class="op" id="6713749">)</span>&nbsp;<span class="comment" id="6713751">//&nbsp;Not&nbsp;intended&nbsp;to&nbsp;fire.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6713780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6713786">var</span>&nbsp;<span class="ident" id="6713790">buf</span>&nbsp;<span class="op" id="6713794">[</span><span class="ident" id="6713795">msgLen</span><span class="op" id="6713801">]</span><span class="builtintype" id="6713802">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6713811">for</span>&nbsp;<span class="ident" id="6713815">m</span>&nbsp;<span class="op" id="6713817">:=</span>&nbsp;<span class="num" id="6713820">0</span><span class="op" id="6713821">;</span>&nbsp;<span class="ident" id="6713823">m</span>&nbsp;<span class="op" id="6713825">&lt;</span>&nbsp;<span class="ident" id="6713827">msgs</span><span class="op" id="6713831">;</span>&nbsp;<span class="ident" id="6713833">m</span><span class="op" id="6713834">++</span>&nbsp;<span class="op" id="6713837">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6713844">if</span>&nbsp;<span class="op" id="6713847">!</span><span class="ident" id="6713848">recvMsg</span><span class="op" id="6713855">(</span><span class="ident" id="6713856">c</span><span class="op" id="6713857">,</span>&nbsp;<span class="ident" id="6713859">buf</span><span class="op" id="6713862">[</span><span class="op" id="6713863">:</span><span class="op" id="6713864">]</span><span class="op" id="6713865">)</span>&nbsp;<span class="op" id="6713867">||</span>&nbsp;<span class="op" id="6713870">!</span><span class="ident" id="6713871">sendMsg</span><span class="op" id="6713878">(</span><span class="ident" id="6713879">c</span><span class="op" id="6713880">,</span>&nbsp;<span class="ident" id="6713882">buf</span><span class="op" id="6713885">[</span><span class="op" id="6713886">:</span><span class="op" id="6713887">]</span><span class="op" id="6713888">)</span>&nbsp;<span class="op" id="6713890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6713898">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6713909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6713915">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6713920">}</span><span class="op" id="6713921">(</span><span class="ident" id="6713922">c</span><span class="op" id="6713923">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6713927">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6713930">}</span><span class="op" id="6713931">(</span><span class="op" id="6713932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6713935">clientSem</span>&nbsp;<span class="op" id="6713945">:=</span>&nbsp;<span class="builtinfunc" id="6713948">make</span><span class="op" id="6713952">(</span><span class="keyword" id="6713953">chan</span>&nbsp;<span class="builtintype" id="6713958">bool</span><span class="op" id="6713962">,</span>&nbsp;<span class="ident" id="6713964">numConcurrent</span><span class="op" id="6713977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6713980">for</span>&nbsp;<span class="ident" id="6713984">i</span>&nbsp;<span class="op" id="6713986">:=</span>&nbsp;<span class="num" id="6713989">0</span><span class="op" id="6713990">;</span>&nbsp;<span class="ident" id="6713992">i</span>&nbsp;<span class="op" id="6713994">&lt;</span>&nbsp;<span class="ident" id="6713996">conns</span><span class="op" id="6714001">;</span>&nbsp;<span class="ident" id="6714003">i</span><span class="op" id="6714004">++</span>&nbsp;<span class="op" id="6714007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6714011">clientSem</span>&nbsp;<span class="op" id="6714021">&lt;-</span>&nbsp;<span class="builtintype" id="6714024">true</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6714031">//&nbsp;Client&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6714055">go</span>&nbsp;<span class="keyword" id="6714058">func</span><span class="op" id="6714062">(</span><span class="op" id="6714063">)</span>&nbsp;<span class="op" id="6714065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6714070">defer</span>&nbsp;<span class="keyword" id="6714076">func</span><span class="op" id="6714080">(</span><span class="op" id="6714081">)</span>&nbsp;<span class="op" id="6714083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6714089">&lt;-</span><span class="ident" id="6714091">clientSem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6714104">}</span><span class="op" id="6714105">(</span><span class="op" id="6714106">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6714111">c</span><span class="op" id="6714112">,</span>&nbsp;<span class="ident" id="6714114">err</span>&nbsp;<span class="op" id="6714118">:=</span>&nbsp;<span class="ident" id="6714121">Dial</span><span class="op" id="6714125">(</span><span class="string" id="6714126">&#34;tcp&#34;</span><span class="op" id="6714131">,</span>&nbsp;<span class="ident" id="6714133">ln</span><span class="op" id="6714135">.</span><span class="ident" id="6714136">Addr</span><span class="op" id="6714140">(</span><span class="op" id="6714141">)</span><span class="op" id="6714142">.</span><span class="ident" id="6714143">String</span><span class="op" id="6714149">(</span><span class="op" id="6714150">)</span><span class="op" id="6714151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6714156">if</span>&nbsp;<span class="ident" id="6714159">err</span>&nbsp;<span class="op" id="6714163">!=</span>&nbsp;<span class="ident" id="6714166">nil</span>&nbsp;<span class="op" id="6714170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6714176">b</span><span class="op" id="6714177">.</span><span class="ident" id="6714178">Logf</span><span class="op" id="6714182">(</span><span class="string" id="6714183">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6714200">,</span>&nbsp;<span class="ident" id="6714202">err</span><span class="op" id="6714205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6714211">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6714221">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6714226">defer</span>&nbsp;<span class="ident" id="6714232">c</span><span class="op" id="6714233">.</span><span class="ident" id="6714234">Close</span><span class="op" id="6714239">(</span><span class="op" id="6714240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6714245">if</span>&nbsp;<span class="ident" id="6714248">timeout</span>&nbsp;<span class="op" id="6714256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6714262">c</span><span class="op" id="6714263">.</span><span class="ident" id="6714264">SetDeadline</span><span class="op" id="6714275">(</span><span class="ident" id="6714276">time</span><span class="op" id="6714280">.</span><span class="ident" id="6714281">Now</span><span class="op" id="6714284">(</span><span class="op" id="6714285">)</span><span class="op" id="6714286">.</span><span class="ident" id="6714287">Add</span><span class="op" id="6714290">(</span><span class="ident" id="6714291">time</span><span class="op" id="6714295">.</span><span class="ident" id="6714296">Hour</span><span class="op" id="6714300">)</span><span class="op" id="6714301">)</span>&nbsp;<span class="comment" id="6714303">//&nbsp;Not&nbsp;intended&nbsp;to&nbsp;fire.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6714331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6714336">var</span>&nbsp;<span class="ident" id="6714340">buf</span>&nbsp;<span class="op" id="6714344">[</span><span class="ident" id="6714345">msgLen</span><span class="op" id="6714351">]</span><span class="builtintype" id="6714352">byte</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6714360">for</span>&nbsp;<span class="ident" id="6714364">m</span>&nbsp;<span class="op" id="6714366">:=</span>&nbsp;<span class="num" id="6714369">0</span><span class="op" id="6714370">;</span>&nbsp;<span class="ident" id="6714372">m</span>&nbsp;<span class="op" id="6714374">&lt;</span>&nbsp;<span class="ident" id="6714376">msgs</span><span class="op" id="6714380">;</span>&nbsp;<span class="ident" id="6714382">m</span><span class="op" id="6714383">++</span>&nbsp;<span class="op" id="6714386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6714392">if</span>&nbsp;<span class="op" id="6714395">!</span><span class="ident" id="6714396">sendMsg</span><span class="op" id="6714403">(</span><span class="ident" id="6714404">c</span><span class="op" id="6714405">,</span>&nbsp;<span class="ident" id="6714407">buf</span><span class="op" id="6714410">[</span><span class="op" id="6714411">:</span><span class="op" id="6714412">]</span><span class="op" id="6714413">)</span>&nbsp;<span class="op" id="6714415">||</span>&nbsp;<span class="op" id="6714418">!</span><span class="ident" id="6714419">recvMsg</span><span class="op" id="6714426">(</span><span class="ident" id="6714427">c</span><span class="op" id="6714428">,</span>&nbsp;<span class="ident" id="6714430">buf</span><span class="op" id="6714433">[</span><span class="op" id="6714434">:</span><span class="op" id="6714435">]</span><span class="op" id="6714436">)</span>&nbsp;<span class="op" id="6714438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6714445">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6714455">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6714460">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6714464">}</span><span class="op" id="6714465">(</span><span class="op" id="6714466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6714469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6714472">for</span>&nbsp;<span class="ident" id="6714476">i</span>&nbsp;<span class="op" id="6714478">:=</span>&nbsp;<span class="num" id="6714481">0</span><span class="op" id="6714482">;</span>&nbsp;<span class="ident" id="6714484">i</span>&nbsp;<span class="op" id="6714486">&lt;</span>&nbsp;<span class="ident" id="6714488">numConcurrent</span><span class="op" id="6714501">;</span>&nbsp;<span class="ident" id="6714503">i</span><span class="op" id="6714504">++</span>&nbsp;<span class="op" id="6714507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6714511">clientSem</span>&nbsp;<span class="op" id="6714521">&lt;-</span>&nbsp;<span class="builtintype" id="6714524">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6714531">serverSem</span>&nbsp;<span class="op" id="6714541">&lt;-</span>&nbsp;<span class="builtintype" id="6714544">true</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6714550">}</span><br>
<span class="lineno"></span><span class="op" id="6714552">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6714555">func</span>&nbsp;<span class="ident" id="6714560">BenchmarkTCP4ConcurrentReadWrite</span><span class="op" id="6714592">(</span><span class="ident" id="6714593">b</span>&nbsp;<span class="op" id="6714595">*</span><span class="ident" id="6714596">testing</span><span class="op" id="6714603">.</span><span class="ident" id="6714604">B</span><span class="op" id="6714605">)</span>&nbsp;<span class="op" id="6714607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6714610">benchmarkTCPConcurrentReadWrite</span><span class="op" id="6714641">(</span><span class="ident" id="6714642">b</span><span class="op" id="6714643">,</span>&nbsp;<span class="string" id="6714645">&#34;127.0.0.1:0&#34;</span><span class="op" id="6714658">)</span><br>
<span class="lineno">160</span><span class="op" id="6714660">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6714663">func</span>&nbsp;<span class="ident" id="6714668">BenchmarkTCP6ConcurrentReadWrite</span><span class="op" id="6714700">(</span><span class="ident" id="6714701">b</span>&nbsp;<span class="op" id="6714703">*</span><span class="ident" id="6714704">testing</span><span class="op" id="6714711">.</span><span class="ident" id="6714712">B</span><span class="op" id="6714713">)</span>&nbsp;<span class="op" id="6714715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6714718">if</span>&nbsp;<span class="op" id="6714721">!</span><span class="ident" id="6714722">supportsIPv6</span>&nbsp;<span class="op" id="6714735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6714739">b</span><span class="op" id="6714740">.</span><span class="ident" id="6714741">Skip</span><span class="op" id="6714745">(</span><span class="string" id="6714746">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="6714769">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6714772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6714775">benchmarkTCPConcurrentReadWrite</span><span class="op" id="6714806">(</span><span class="ident" id="6714807">b</span><span class="op" id="6714808">,</span>&nbsp;<span class="string" id="6714810">&#34;[::1]:0&#34;</span><span class="op" id="6714819">)</span><br>
<span class="lineno"></span><span class="op" id="6714821">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6714824">func</span>&nbsp;<span class="ident" id="6714829">benchmarkTCPConcurrentReadWrite</span><span class="op" id="6714860">(</span><span class="ident" id="6714861">b</span>&nbsp;<span class="op" id="6714863">*</span><span class="ident" id="6714864">testing</span><span class="op" id="6714871">.</span><span class="ident" id="6714872">B</span><span class="op" id="6714873">,</span>&nbsp;<span class="ident" id="6714875">laddr</span>&nbsp;<span class="builtintype" id="6714881">string</span><span class="op" id="6714887">)</span>&nbsp;<span class="op" id="6714889">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6714892">//&nbsp;The&nbsp;benchmark&nbsp;creates&nbsp;GOMAXPROCS&nbsp;client/server&nbsp;pairs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6714950">//&nbsp;Each&nbsp;pair&nbsp;creates&nbsp;4&nbsp;goroutines:&nbsp;client&nbsp;reader/writer&nbsp;and&nbsp;server&nbsp;reader/writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6715033">//&nbsp;The&nbsp;benchmark&nbsp;stresses&nbsp;concurrent&nbsp;reading&nbsp;and&nbsp;writing&nbsp;to&nbsp;the&nbsp;same&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6715115">//&nbsp;Such&nbsp;pattern&nbsp;is&nbsp;used&nbsp;in&nbsp;net/http&nbsp;and&nbsp;net/rpc.</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6715166">b</span><span class="op" id="6715167">.</span><span class="ident" id="6715168">StopTimer</span><span class="op" id="6715177">(</span><span class="op" id="6715178">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6715182">P</span>&nbsp;<span class="op" id="6715184">:=</span>&nbsp;<span class="ident" id="6715187">runtime</span><span class="op" id="6715194">.</span><span class="ident" id="6715195">GOMAXPROCS</span><span class="op" id="6715205">(</span><span class="num" id="6715206">0</span><span class="op" id="6715207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6715210">N</span>&nbsp;<span class="op" id="6715212">:=</span>&nbsp;<span class="ident" id="6715215">b</span><span class="op" id="6715216">.</span><span class="ident" id="6715217">N</span>&nbsp;<span class="op" id="6715219">/</span>&nbsp;<span class="ident" id="6715221">P</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6715224">W</span>&nbsp;<span class="op" id="6715226">:=</span>&nbsp;<span class="num" id="6715229">1000</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6715236">//&nbsp;Setup&nbsp;P&nbsp;client/server&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6715275">clients</span>&nbsp;<span class="op" id="6715283">:=</span>&nbsp;<span class="builtinfunc" id="6715286">make</span><span class="op" id="6715290">(</span><span class="op" id="6715291">[</span><span class="op" id="6715292">]</span><span class="ident" id="6715293">Conn</span><span class="op" id="6715297">,</span>&nbsp;<span class="ident" id="6715299">P</span><span class="op" id="6715300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6715303">servers</span>&nbsp;<span class="op" id="6715311">:=</span>&nbsp;<span class="builtinfunc" id="6715314">make</span><span class="op" id="6715318">(</span><span class="op" id="6715319">[</span><span class="op" id="6715320">]</span><span class="ident" id="6715321">Conn</span><span class="op" id="6715325">,</span>&nbsp;<span class="ident" id="6715327">P</span><span class="op" id="6715328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6715331">ln</span><span class="op" id="6715333">,</span>&nbsp;<span class="ident" id="6715335">err</span>&nbsp;<span class="op" id="6715339">:=</span>&nbsp;<span class="ident" id="6715342">Listen</span><span class="op" id="6715348">(</span><span class="string" id="6715349">&#34;tcp&#34;</span><span class="op" id="6715354">,</span>&nbsp;<span class="ident" id="6715356">laddr</span><span class="op" id="6715361">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6715364">if</span>&nbsp;<span class="ident" id="6715367">err</span>&nbsp;<span class="op" id="6715371">!=</span>&nbsp;<span class="ident" id="6715374">nil</span>&nbsp;<span class="op" id="6715378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6715382">b</span><span class="op" id="6715383">.</span><span class="ident" id="6715384">Fatalf</span><span class="op" id="6715390">(</span><span class="string" id="6715391">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6715410">,</span>&nbsp;<span class="ident" id="6715412">err</span><span class="op" id="6715415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6715418">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6715421">defer</span>&nbsp;<span class="ident" id="6715427">ln</span><span class="op" id="6715429">.</span><span class="ident" id="6715430">Close</span><span class="op" id="6715435">(</span><span class="op" id="6715436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6715439">done</span>&nbsp;<span class="op" id="6715444">:=</span>&nbsp;<span class="builtinfunc" id="6715447">make</span><span class="op" id="6715451">(</span><span class="keyword" id="6715452">chan</span>&nbsp;<span class="builtintype" id="6715457">bool</span><span class="op" id="6715461">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6715464">go</span>&nbsp;<span class="keyword" id="6715467">func</span><span class="op" id="6715471">(</span><span class="op" id="6715472">)</span>&nbsp;<span class="op" id="6715474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6715478">for</span>&nbsp;<span class="ident" id="6715482">p</span>&nbsp;<span class="op" id="6715484">:=</span>&nbsp;<span class="num" id="6715487">0</span><span class="op" id="6715488">;</span>&nbsp;<span class="ident" id="6715490">p</span>&nbsp;<span class="op" id="6715492">&lt;</span>&nbsp;<span class="ident" id="6715494">P</span><span class="op" id="6715495">;</span>&nbsp;<span class="ident" id="6715497">p</span><span class="op" id="6715498">++</span>&nbsp;<span class="op" id="6715501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6715506">s</span><span class="op" id="6715507">,</span>&nbsp;<span class="ident" id="6715509">err</span>&nbsp;<span class="op" id="6715513">:=</span>&nbsp;<span class="ident" id="6715516">ln</span><span class="op" id="6715518">.</span><span class="ident" id="6715519">Accept</span><span class="op" id="6715525">(</span><span class="op" id="6715526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6715531">if</span>&nbsp;<span class="ident" id="6715534">err</span>&nbsp;<span class="op" id="6715538">!=</span>&nbsp;<span class="ident" id="6715541">nil</span>&nbsp;<span class="op" id="6715545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6715551">b</span><span class="op" id="6715552">.</span><span class="ident" id="6715553">Errorf</span><span class="op" id="6715559">(</span><span class="string" id="6715560">&#34;Accept&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6715579">,</span>&nbsp;<span class="ident" id="6715581">err</span><span class="op" id="6715584">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6715590">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6715600">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6715605">servers</span><span class="op" id="6715612">[</span><span class="ident" id="6715613">p</span><span class="op" id="6715614">]</span>&nbsp;<span class="op" id="6715616">=</span>&nbsp;<span class="ident" id="6715618">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6715622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6715626">done</span>&nbsp;<span class="op" id="6715631">&lt;-</span>&nbsp;<span class="builtintype" id="6715634">true</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6715640">}</span><span class="op" id="6715641">(</span><span class="op" id="6715642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6715645">for</span>&nbsp;<span class="ident" id="6715649">p</span>&nbsp;<span class="op" id="6715651">:=</span>&nbsp;<span class="num" id="6715654">0</span><span class="op" id="6715655">;</span>&nbsp;<span class="ident" id="6715657">p</span>&nbsp;<span class="op" id="6715659">&lt;</span>&nbsp;<span class="ident" id="6715661">P</span><span class="op" id="6715662">;</span>&nbsp;<span class="ident" id="6715664">p</span><span class="op" id="6715665">++</span>&nbsp;<span class="op" id="6715668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6715672">c</span><span class="op" id="6715673">,</span>&nbsp;<span class="ident" id="6715675">err</span>&nbsp;<span class="op" id="6715679">:=</span>&nbsp;<span class="ident" id="6715682">Dial</span><span class="op" id="6715686">(</span><span class="string" id="6715687">&#34;tcp&#34;</span><span class="op" id="6715692">,</span>&nbsp;<span class="ident" id="6715694">ln</span><span class="op" id="6715696">.</span><span class="ident" id="6715697">Addr</span><span class="op" id="6715701">(</span><span class="op" id="6715702">)</span><span class="op" id="6715703">.</span><span class="ident" id="6715704">String</span><span class="op" id="6715710">(</span><span class="op" id="6715711">)</span><span class="op" id="6715712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6715716">if</span>&nbsp;<span class="ident" id="6715719">err</span>&nbsp;<span class="op" id="6715723">!=</span>&nbsp;<span class="ident" id="6715726">nil</span>&nbsp;<span class="op" id="6715730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6715735">b</span><span class="op" id="6715736">.</span><span class="ident" id="6715737">Fatalf</span><span class="op" id="6715743">(</span><span class="string" id="6715744">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6715761">,</span>&nbsp;<span class="ident" id="6715763">err</span><span class="op" id="6715766">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6715770">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6715774">clients</span><span class="op" id="6715781">[</span><span class="ident" id="6715782">p</span><span class="op" id="6715783">]</span>&nbsp;<span class="op" id="6715785">=</span>&nbsp;<span class="ident" id="6715787">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6715790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6715793">&lt;-</span><span class="ident" id="6715795">done</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6715802">b</span><span class="op" id="6715803">.</span><span class="ident" id="6715804">StartTimer</span><span class="op" id="6715814">(</span><span class="op" id="6715815">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6715819">var</span>&nbsp;<span class="ident" id="6715823">wg</span>&nbsp;<span class="ident" id="6715826">sync</span><span class="op" id="6715830">.</span><span class="ident" id="6715831">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6715842">wg</span><span class="op" id="6715844">.</span><span class="ident" id="6715845">Add</span><span class="op" id="6715848">(</span><span class="num" id="6715849">4</span>&nbsp;<span class="op" id="6715851">*</span>&nbsp;<span class="ident" id="6715853">P</span><span class="op" id="6715854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6715857">for</span>&nbsp;<span class="ident" id="6715861">p</span>&nbsp;<span class="op" id="6715863">:=</span>&nbsp;<span class="num" id="6715866">0</span><span class="op" id="6715867">;</span>&nbsp;<span class="ident" id="6715869">p</span>&nbsp;<span class="op" id="6715871">&lt;</span>&nbsp;<span class="ident" id="6715873">P</span><span class="op" id="6715874">;</span>&nbsp;<span class="ident" id="6715876">p</span><span class="op" id="6715877">++</span>&nbsp;<span class="op" id="6715880">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6715884">//&nbsp;Client&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6715904">go</span>&nbsp;<span class="keyword" id="6715907">func</span><span class="op" id="6715911">(</span><span class="ident" id="6715912">c</span>&nbsp;<span class="ident" id="6715914">Conn</span><span class="op" id="6715918">)</span>&nbsp;<span class="op" id="6715920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6715925">defer</span>&nbsp;<span class="ident" id="6715931">wg</span><span class="op" id="6715933">.</span><span class="ident" id="6715934">Done</span><span class="op" id="6715938">(</span><span class="op" id="6715939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6715944">var</span>&nbsp;<span class="ident" id="6715948">buf</span>&nbsp;<span class="op" id="6715952">[</span><span class="num" id="6715953">1</span><span class="op" id="6715954">]</span><span class="builtintype" id="6715955">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6715963">for</span>&nbsp;<span class="ident" id="6715967">i</span>&nbsp;<span class="op" id="6715969">:=</span>&nbsp;<span class="num" id="6715972">0</span><span class="op" id="6715973">;</span>&nbsp;<span class="ident" id="6715975">i</span>&nbsp;<span class="op" id="6715977">&lt;</span>&nbsp;<span class="ident" id="6715979">N</span><span class="op" id="6715980">;</span>&nbsp;<span class="ident" id="6715982">i</span><span class="op" id="6715983">++</span>&nbsp;<span class="op" id="6715986">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6715992">v</span>&nbsp;<span class="op" id="6715994">:=</span>&nbsp;<span class="builtintype" id="6715997">byte</span><span class="op" id="6716001">(</span><span class="ident" id="6716002">i</span><span class="op" id="6716003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6716009">for</span>&nbsp;<span class="ident" id="6716013">w</span>&nbsp;<span class="op" id="6716015">:=</span>&nbsp;<span class="num" id="6716018">0</span><span class="op" id="6716019">;</span>&nbsp;<span class="ident" id="6716021">w</span>&nbsp;<span class="op" id="6716023">&lt;</span>&nbsp;<span class="ident" id="6716025">W</span><span class="op" id="6716026">;</span>&nbsp;<span class="ident" id="6716028">w</span><span class="op" id="6716029">++</span>&nbsp;<span class="op" id="6716032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6716039">v</span>&nbsp;<span class="op" id="6716041">*=</span>&nbsp;<span class="ident" id="6716044">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6716050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6716056">buf</span><span class="op" id="6716059">[</span><span class="num" id="6716060">0</span><span class="op" id="6716061">]</span>&nbsp;<span class="op" id="6716063">=</span>&nbsp;<span class="ident" id="6716065">v</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6716071">_</span><span class="op" id="6716072">,</span>&nbsp;<span class="ident" id="6716074">err</span>&nbsp;<span class="op" id="6716078">:=</span>&nbsp;<span class="ident" id="6716081">c</span><span class="op" id="6716082">.</span><span class="ident" id="6716083">Write</span><span class="op" id="6716088">(</span><span class="ident" id="6716089">buf</span><span class="op" id="6716092">[</span><span class="op" id="6716093">:</span><span class="op" id="6716094">]</span><span class="op" id="6716095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6716101">if</span>&nbsp;<span class="ident" id="6716104">err</span>&nbsp;<span class="op" id="6716108">!=</span>&nbsp;<span class="ident" id="6716111">nil</span>&nbsp;<span class="op" id="6716115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6716122">b</span><span class="op" id="6716123">.</span><span class="ident" id="6716124">Errorf</span><span class="op" id="6716130">(</span><span class="string" id="6716131">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6716149">,</span>&nbsp;<span class="ident" id="6716151">err</span><span class="op" id="6716154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6716161">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6716172">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6716177">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6716181">}</span><span class="op" id="6716182">(</span><span class="ident" id="6716183">clients</span><span class="op" id="6716190">[</span><span class="ident" id="6716191">p</span><span class="op" id="6716192">]</span><span class="op" id="6716193">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6716198">//&nbsp;Pipe&nbsp;between&nbsp;server&nbsp;reader&nbsp;and&nbsp;server&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6716249">pipe</span>&nbsp;<span class="op" id="6716254">:=</span>&nbsp;<span class="builtinfunc" id="6716257">make</span><span class="op" id="6716261">(</span><span class="keyword" id="6716262">chan</span>&nbsp;<span class="builtintype" id="6716267">byte</span><span class="op" id="6716271">,</span>&nbsp;<span class="num" id="6716273">128</span><span class="op" id="6716276">)</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6716281">//&nbsp;Server&nbsp;reader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6716301">go</span>&nbsp;<span class="keyword" id="6716304">func</span><span class="op" id="6716308">(</span><span class="ident" id="6716309">s</span>&nbsp;<span class="ident" id="6716311">Conn</span><span class="op" id="6716315">)</span>&nbsp;<span class="op" id="6716317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6716322">defer</span>&nbsp;<span class="ident" id="6716328">wg</span><span class="op" id="6716330">.</span><span class="ident" id="6716331">Done</span><span class="op" id="6716335">(</span><span class="op" id="6716336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6716341">var</span>&nbsp;<span class="ident" id="6716345">buf</span>&nbsp;<span class="op" id="6716349">[</span><span class="num" id="6716350">1</span><span class="op" id="6716351">]</span><span class="builtintype" id="6716352">byte</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6716360">for</span>&nbsp;<span class="ident" id="6716364">i</span>&nbsp;<span class="op" id="6716366">:=</span>&nbsp;<span class="num" id="6716369">0</span><span class="op" id="6716370">;</span>&nbsp;<span class="ident" id="6716372">i</span>&nbsp;<span class="op" id="6716374">&lt;</span>&nbsp;<span class="ident" id="6716376">N</span><span class="op" id="6716377">;</span>&nbsp;<span class="ident" id="6716379">i</span><span class="op" id="6716380">++</span>&nbsp;<span class="op" id="6716383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6716389">_</span><span class="op" id="6716390">,</span>&nbsp;<span class="ident" id="6716392">err</span>&nbsp;<span class="op" id="6716396">:=</span>&nbsp;<span class="ident" id="6716399">s</span><span class="op" id="6716400">.</span><span class="ident" id="6716401">Read</span><span class="op" id="6716405">(</span><span class="ident" id="6716406">buf</span><span class="op" id="6716409">[</span><span class="op" id="6716410">:</span><span class="op" id="6716411">]</span><span class="op" id="6716412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6716418">if</span>&nbsp;<span class="ident" id="6716421">err</span>&nbsp;<span class="op" id="6716425">!=</span>&nbsp;<span class="ident" id="6716428">nil</span>&nbsp;<span class="op" id="6716432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6716439">b</span><span class="op" id="6716440">.</span><span class="ident" id="6716441">Errorf</span><span class="op" id="6716447">(</span><span class="string" id="6716448">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6716465">,</span>&nbsp;<span class="ident" id="6716467">err</span><span class="op" id="6716470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6716477">return</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6716488">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6716494">pipe</span>&nbsp;<span class="op" id="6716499">&lt;-</span>&nbsp;<span class="ident" id="6716502">buf</span><span class="op" id="6716505">[</span><span class="num" id="6716506">0</span><span class="op" id="6716507">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6716512">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6716516">}</span><span class="op" id="6716517">(</span><span class="ident" id="6716518">servers</span><span class="op" id="6716525">[</span><span class="ident" id="6716526">p</span><span class="op" id="6716527">]</span><span class="op" id="6716528">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6716533">//&nbsp;Server&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6716553">go</span>&nbsp;<span class="keyword" id="6716556">func</span><span class="op" id="6716560">(</span><span class="ident" id="6716561">s</span>&nbsp;<span class="ident" id="6716563">Conn</span><span class="op" id="6716567">)</span>&nbsp;<span class="op" id="6716569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6716574">defer</span>&nbsp;<span class="ident" id="6716580">wg</span><span class="op" id="6716582">.</span><span class="ident" id="6716583">Done</span><span class="op" id="6716587">(</span><span class="op" id="6716588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6716593">var</span>&nbsp;<span class="ident" id="6716597">buf</span>&nbsp;<span class="op" id="6716601">[</span><span class="num" id="6716602">1</span><span class="op" id="6716603">]</span><span class="builtintype" id="6716604">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6716612">for</span>&nbsp;<span class="ident" id="6716616">i</span>&nbsp;<span class="op" id="6716618">:=</span>&nbsp;<span class="num" id="6716621">0</span><span class="op" id="6716622">;</span>&nbsp;<span class="ident" id="6716624">i</span>&nbsp;<span class="op" id="6716626">&lt;</span>&nbsp;<span class="ident" id="6716628">N</span><span class="op" id="6716629">;</span>&nbsp;<span class="ident" id="6716631">i</span><span class="op" id="6716632">++</span>&nbsp;<span class="op" id="6716635">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6716641">v</span>&nbsp;<span class="op" id="6716643">:=</span>&nbsp;<span class="op" id="6716646">&lt;-</span><span class="ident" id="6716648">pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6716657">for</span>&nbsp;<span class="ident" id="6716661">w</span>&nbsp;<span class="op" id="6716663">:=</span>&nbsp;<span class="num" id="6716666">0</span><span class="op" id="6716667">;</span>&nbsp;<span class="ident" id="6716669">w</span>&nbsp;<span class="op" id="6716671">&lt;</span>&nbsp;<span class="ident" id="6716673">W</span><span class="op" id="6716674">;</span>&nbsp;<span class="ident" id="6716676">w</span><span class="op" id="6716677">++</span>&nbsp;<span class="op" id="6716680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6716687">v</span>&nbsp;<span class="op" id="6716689">*=</span>&nbsp;<span class="ident" id="6716692">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6716698">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6716704">buf</span><span class="op" id="6716707">[</span><span class="num" id="6716708">0</span><span class="op" id="6716709">]</span>&nbsp;<span class="op" id="6716711">=</span>&nbsp;<span class="ident" id="6716713">v</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6716719">_</span><span class="op" id="6716720">,</span>&nbsp;<span class="ident" id="6716722">err</span>&nbsp;<span class="op" id="6716726">:=</span>&nbsp;<span class="ident" id="6716729">s</span><span class="op" id="6716730">.</span><span class="ident" id="6716731">Write</span><span class="op" id="6716736">(</span><span class="ident" id="6716737">buf</span><span class="op" id="6716740">[</span><span class="op" id="6716741">:</span><span class="op" id="6716742">]</span><span class="op" id="6716743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6716749">if</span>&nbsp;<span class="ident" id="6716752">err</span>&nbsp;<span class="op" id="6716756">!=</span>&nbsp;<span class="ident" id="6716759">nil</span>&nbsp;<span class="op" id="6716763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6716770">b</span><span class="op" id="6716771">.</span><span class="ident" id="6716772">Errorf</span><span class="op" id="6716778">(</span><span class="string" id="6716779">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6716797">,</span>&nbsp;<span class="ident" id="6716799">err</span><span class="op" id="6716802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6716809">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6716820">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6716825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6716830">s</span><span class="op" id="6716831">.</span><span class="ident" id="6716832">Close</span><span class="op" id="6716837">(</span><span class="op" id="6716838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6716842">}</span><span class="op" id="6716843">(</span><span class="ident" id="6716844">servers</span><span class="op" id="6716851">[</span><span class="ident" id="6716852">p</span><span class="op" id="6716853">]</span><span class="op" id="6716854">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6716859">//&nbsp;Client&nbsp;reader.</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6716879">go</span>&nbsp;<span class="keyword" id="6716882">func</span><span class="op" id="6716886">(</span><span class="ident" id="6716887">c</span>&nbsp;<span class="ident" id="6716889">Conn</span><span class="op" id="6716893">)</span>&nbsp;<span class="op" id="6716895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6716900">defer</span>&nbsp;<span class="ident" id="6716906">wg</span><span class="op" id="6716908">.</span><span class="ident" id="6716909">Done</span><span class="op" id="6716913">(</span><span class="op" id="6716914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6716919">var</span>&nbsp;<span class="ident" id="6716923">buf</span>&nbsp;<span class="op" id="6716927">[</span><span class="num" id="6716928">1</span><span class="op" id="6716929">]</span><span class="builtintype" id="6716930">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6716938">for</span>&nbsp;<span class="ident" id="6716942">i</span>&nbsp;<span class="op" id="6716944">:=</span>&nbsp;<span class="num" id="6716947">0</span><span class="op" id="6716948">;</span>&nbsp;<span class="ident" id="6716950">i</span>&nbsp;<span class="op" id="6716952">&lt;</span>&nbsp;<span class="ident" id="6716954">N</span><span class="op" id="6716955">;</span>&nbsp;<span class="ident" id="6716957">i</span><span class="op" id="6716958">++</span>&nbsp;<span class="op" id="6716961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6716967">_</span><span class="op" id="6716968">,</span>&nbsp;<span class="ident" id="6716970">err</span>&nbsp;<span class="op" id="6716974">:=</span>&nbsp;<span class="ident" id="6716977">c</span><span class="op" id="6716978">.</span><span class="ident" id="6716979">Read</span><span class="op" id="6716983">(</span><span class="ident" id="6716984">buf</span><span class="op" id="6716987">[</span><span class="op" id="6716988">:</span><span class="op" id="6716989">]</span><span class="op" id="6716990">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6716996">if</span>&nbsp;<span class="ident" id="6716999">err</span>&nbsp;<span class="op" id="6717003">!=</span>&nbsp;<span class="ident" id="6717006">nil</span>&nbsp;<span class="op" id="6717010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6717017">b</span><span class="op" id="6717018">.</span><span class="ident" id="6717019">Errorf</span><span class="op" id="6717025">(</span><span class="string" id="6717026">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6717043">,</span>&nbsp;<span class="ident" id="6717045">err</span><span class="op" id="6717048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6717055">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6717066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6717071">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6717076">c</span><span class="op" id="6717077">.</span><span class="ident" id="6717078">Close</span><span class="op" id="6717083">(</span><span class="op" id="6717084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6717088">}</span><span class="op" id="6717089">(</span><span class="ident" id="6717090">clients</span><span class="op" id="6717097">[</span><span class="ident" id="6717098">p</span><span class="op" id="6717099">]</span><span class="op" id="6717100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6717103">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6717106">wg</span><span class="op" id="6717108">.</span><span class="ident" id="6717109">Wait</span><span class="op" id="6717113">(</span><span class="op" id="6717114">)</span><br>
<span class="lineno"></span><span class="op" id="6717116">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="keyword" id="6717119">type</span>&nbsp;<span class="ident" id="6717124">resolveTCPAddrTest</span>&nbsp;<span class="keyword" id="6717143">struct</span>&nbsp;<span class="op" id="6717150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6717153">net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6717167">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6717175">litAddrOrName</span>&nbsp;<span class="builtintype" id="6717189">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6717197">addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6717211">*</span><span class="ident" id="6717212">TCPAddr</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6717221">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6717235">error</span><br>
<span class="lineno"></span><span class="op" id="6717241">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6717244">var</span>&nbsp;<span class="ident" id="6717248">resolveTCPAddrTests</span>&nbsp;<span class="op" id="6717268">=</span>&nbsp;<span class="op" id="6717270">[</span><span class="op" id="6717271">]</span><span class="ident" id="6717272">resolveTCPAddrTest</span><span class="op" id="6717290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6717293">{</span><span class="string" id="6717294">&#34;tcp&#34;</span><span class="op" id="6717299">,</span>&nbsp;<span class="string" id="6717301">&#34;127.0.0.1:0&#34;</span><span class="op" id="6717314">,</span>&nbsp;<span class="op" id="6717316">&amp;</span><span class="ident" id="6717317">TCPAddr</span><span class="op" id="6717324">{</span><span class="ident" id="6717325">IP</span><span class="op" id="6717327">:</span>&nbsp;<span class="ident" id="6717329">IPv4</span><span class="op" id="6717333">(</span><span class="num" id="6717334">127</span><span class="op" id="6717337">,</span>&nbsp;<span class="num" id="6717339">0</span><span class="op" id="6717340">,</span>&nbsp;<span class="num" id="6717342">0</span><span class="op" id="6717343">,</span>&nbsp;<span class="num" id="6717345">1</span><span class="op" id="6717346">)</span><span class="op" id="6717347">,</span>&nbsp;<span class="ident" id="6717349">Port</span><span class="op" id="6717353">:</span>&nbsp;<span class="num" id="6717355">0</span><span class="op" id="6717356">}</span><span class="op" id="6717357">,</span>&nbsp;<span class="ident" id="6717359">nil</span><span class="op" id="6717362">}</span><span class="op" id="6717363">,</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6717366">{</span><span class="string" id="6717367">&#34;tcp4&#34;</span><span class="op" id="6717373">,</span>&nbsp;<span class="string" id="6717375">&#34;127.0.0.1:65535&#34;</span><span class="op" id="6717392">,</span>&nbsp;<span class="op" id="6717394">&amp;</span><span class="ident" id="6717395">TCPAddr</span><span class="op" id="6717402">{</span><span class="ident" id="6717403">IP</span><span class="op" id="6717405">:</span>&nbsp;<span class="ident" id="6717407">IPv4</span><span class="op" id="6717411">(</span><span class="num" id="6717412">127</span><span class="op" id="6717415">,</span>&nbsp;<span class="num" id="6717417">0</span><span class="op" id="6717418">,</span>&nbsp;<span class="num" id="6717420">0</span><span class="op" id="6717421">,</span>&nbsp;<span class="num" id="6717423">1</span><span class="op" id="6717424">)</span><span class="op" id="6717425">,</span>&nbsp;<span class="ident" id="6717427">Port</span><span class="op" id="6717431">:</span>&nbsp;<span class="num" id="6717433">65535</span><span class="op" id="6717438">}</span><span class="op" id="6717439">,</span>&nbsp;<span class="ident" id="6717441">nil</span><span class="op" id="6717444">}</span><span class="op" id="6717445">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6717449">{</span><span class="string" id="6717450">&#34;tcp&#34;</span><span class="op" id="6717455">,</span>&nbsp;<span class="string" id="6717457">&#34;[::1]:1&#34;</span><span class="op" id="6717466">,</span>&nbsp;<span class="op" id="6717468">&amp;</span><span class="ident" id="6717469">TCPAddr</span><span class="op" id="6717476">{</span><span class="ident" id="6717477">IP</span><span class="op" id="6717479">:</span>&nbsp;<span class="ident" id="6717481">ParseIP</span><span class="op" id="6717488">(</span><span class="string" id="6717489">&#34;::1&#34;</span><span class="op" id="6717494">)</span><span class="op" id="6717495">,</span>&nbsp;<span class="ident" id="6717497">Port</span><span class="op" id="6717501">:</span>&nbsp;<span class="num" id="6717503">1</span><span class="op" id="6717504">}</span><span class="op" id="6717505">,</span>&nbsp;<span class="ident" id="6717507">nil</span><span class="op" id="6717510">}</span><span class="op" id="6717511">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6717514">{</span><span class="string" id="6717515">&#34;tcp6&#34;</span><span class="op" id="6717521">,</span>&nbsp;<span class="string" id="6717523">&#34;[::1]:65534&#34;</span><span class="op" id="6717536">,</span>&nbsp;<span class="op" id="6717538">&amp;</span><span class="ident" id="6717539">TCPAddr</span><span class="op" id="6717546">{</span><span class="ident" id="6717547">IP</span><span class="op" id="6717549">:</span>&nbsp;<span class="ident" id="6717551">ParseIP</span><span class="op" id="6717558">(</span><span class="string" id="6717559">&#34;::1&#34;</span><span class="op" id="6717564">)</span><span class="op" id="6717565">,</span>&nbsp;<span class="ident" id="6717567">Port</span><span class="op" id="6717571">:</span>&nbsp;<span class="num" id="6717573">65534</span><span class="op" id="6717578">}</span><span class="op" id="6717579">,</span>&nbsp;<span class="ident" id="6717581">nil</span><span class="op" id="6717584">}</span><span class="op" id="6717585">,</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6717589">{</span><span class="string" id="6717590">&#34;tcp&#34;</span><span class="op" id="6717595">,</span>&nbsp;<span class="string" id="6717597">&#34;[::1%en0]:1&#34;</span><span class="op" id="6717610">,</span>&nbsp;<span class="op" id="6717612">&amp;</span><span class="ident" id="6717613">TCPAddr</span><span class="op" id="6717620">{</span><span class="ident" id="6717621">IP</span><span class="op" id="6717623">:</span>&nbsp;<span class="ident" id="6717625">ParseIP</span><span class="op" id="6717632">(</span><span class="string" id="6717633">&#34;::1&#34;</span><span class="op" id="6717638">)</span><span class="op" id="6717639">,</span>&nbsp;<span class="ident" id="6717641">Port</span><span class="op" id="6717645">:</span>&nbsp;<span class="num" id="6717647">1</span><span class="op" id="6717648">,</span>&nbsp;<span class="ident" id="6717650">Zone</span><span class="op" id="6717654">:</span>&nbsp;<span class="string" id="6717656">&#34;en0&#34;</span><span class="op" id="6717661">}</span><span class="op" id="6717662">,</span>&nbsp;<span class="ident" id="6717664">nil</span><span class="op" id="6717667">}</span><span class="op" id="6717668">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6717671">{</span><span class="string" id="6717672">&#34;tcp6&#34;</span><span class="op" id="6717678">,</span>&nbsp;<span class="string" id="6717680">&#34;[::1%911]:2&#34;</span><span class="op" id="6717693">,</span>&nbsp;<span class="op" id="6717695">&amp;</span><span class="ident" id="6717696">TCPAddr</span><span class="op" id="6717703">{</span><span class="ident" id="6717704">IP</span><span class="op" id="6717706">:</span>&nbsp;<span class="ident" id="6717708">ParseIP</span><span class="op" id="6717715">(</span><span class="string" id="6717716">&#34;::1&#34;</span><span class="op" id="6717721">)</span><span class="op" id="6717722">,</span>&nbsp;<span class="ident" id="6717724">Port</span><span class="op" id="6717728">:</span>&nbsp;<span class="num" id="6717730">2</span><span class="op" id="6717731">,</span>&nbsp;<span class="ident" id="6717733">Zone</span><span class="op" id="6717737">:</span>&nbsp;<span class="string" id="6717739">&#34;911&#34;</span><span class="op" id="6717744">}</span><span class="op" id="6717745">,</span>&nbsp;<span class="ident" id="6717747">nil</span><span class="op" id="6717750">}</span><span class="op" id="6717751">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6717755">{</span><span class="string" id="6717756">&#34;&#34;</span><span class="op" id="6717758">,</span>&nbsp;<span class="string" id="6717760">&#34;127.0.0.1:0&#34;</span><span class="op" id="6717773">,</span>&nbsp;<span class="op" id="6717775">&amp;</span><span class="ident" id="6717776">TCPAddr</span><span class="op" id="6717783">{</span><span class="ident" id="6717784">IP</span><span class="op" id="6717786">:</span>&nbsp;<span class="ident" id="6717788">IPv4</span><span class="op" id="6717792">(</span><span class="num" id="6717793">127</span><span class="op" id="6717796">,</span>&nbsp;<span class="num" id="6717798">0</span><span class="op" id="6717799">,</span>&nbsp;<span class="num" id="6717801">0</span><span class="op" id="6717802">,</span>&nbsp;<span class="num" id="6717804">1</span><span class="op" id="6717805">)</span><span class="op" id="6717806">,</span>&nbsp;<span class="ident" id="6717808">Port</span><span class="op" id="6717812">:</span>&nbsp;<span class="num" id="6717814">0</span><span class="op" id="6717815">}</span><span class="op" id="6717816">,</span>&nbsp;<span class="ident" id="6717818">nil</span><span class="op" id="6717821">}</span><span class="op" id="6717822">,</span>&nbsp;<span class="comment" id="6717824">//&nbsp;Go&nbsp;1.0&nbsp;behavior</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6717844">{</span><span class="string" id="6717845">&#34;&#34;</span><span class="op" id="6717847">,</span>&nbsp;<span class="string" id="6717849">&#34;[::1]:0&#34;</span><span class="op" id="6717858">,</span>&nbsp;<span class="op" id="6717860">&amp;</span><span class="ident" id="6717861">TCPAddr</span><span class="op" id="6717868">{</span><span class="ident" id="6717869">IP</span><span class="op" id="6717871">:</span>&nbsp;<span class="ident" id="6717873">ParseIP</span><span class="op" id="6717880">(</span><span class="string" id="6717881">&#34;::1&#34;</span><span class="op" id="6717886">)</span><span class="op" id="6717887">,</span>&nbsp;<span class="ident" id="6717889">Port</span><span class="op" id="6717893">:</span>&nbsp;<span class="num" id="6717895">0</span><span class="op" id="6717896">}</span><span class="op" id="6717897">,</span>&nbsp;<span class="ident" id="6717899">nil</span><span class="op" id="6717902">}</span><span class="op" id="6717903">,</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6717913">//&nbsp;Go&nbsp;1.0&nbsp;behavior</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6717934">{</span><span class="string" id="6717935">&#34;tcp&#34;</span><span class="op" id="6717940">,</span>&nbsp;<span class="string" id="6717942">&#34;:12345&#34;</span><span class="op" id="6717950">,</span>&nbsp;<span class="op" id="6717952">&amp;</span><span class="ident" id="6717953">TCPAddr</span><span class="op" id="6717960">{</span><span class="ident" id="6717961">Port</span><span class="op" id="6717965">:</span>&nbsp;<span class="num" id="6717967">12345</span><span class="op" id="6717972">}</span><span class="op" id="6717973">,</span>&nbsp;<span class="ident" id="6717975">nil</span><span class="op" id="6717978">}</span><span class="op" id="6717979">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6717983">{</span><span class="string" id="6717984">&#34;http&#34;</span><span class="op" id="6717990">,</span>&nbsp;<span class="string" id="6717992">&#34;127.0.0.1:0&#34;</span><span class="op" id="6718005">,</span>&nbsp;<span class="ident" id="6718007">nil</span><span class="op" id="6718010">,</span>&nbsp;<span class="ident" id="6718012">UnknownNetworkError</span><span class="op" id="6718031">(</span><span class="string" id="6718032">&#34;http&#34;</span><span class="op" id="6718038">)</span><span class="op" id="6718039">}</span><span class="op" id="6718040">,</span><br>
<span class="lineno"></span><span class="op" id="6718042">}</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span><span class="keyword" id="6718045">func</span>&nbsp;<span class="ident" id="6718050">init</span><span class="op" id="6718054">(</span><span class="op" id="6718055">)</span>&nbsp;<span class="op" id="6718057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6718060">if</span>&nbsp;<span class="ident" id="6718063">ifi</span>&nbsp;<span class="op" id="6718067">:=</span>&nbsp;<span class="ident" id="6718070">loopbackInterface</span><span class="op" id="6718087">(</span><span class="op" id="6718088">)</span><span class="op" id="6718089">;</span>&nbsp;<span class="ident" id="6718091">ifi</span>&nbsp;<span class="op" id="6718095">!=</span>&nbsp;<span class="ident" id="6718098">nil</span>&nbsp;<span class="op" id="6718102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6718106">index</span>&nbsp;<span class="op" id="6718112">:=</span>&nbsp;<span class="ident" id="6718115">fmt</span><span class="op" id="6718118">.</span><span class="ident" id="6718119">Sprintf</span><span class="op" id="6718126">(</span><span class="string" id="6718127">&#34;%v&#34;</span><span class="op" id="6718131">,</span>&nbsp;<span class="ident" id="6718133">ifi</span><span class="op" id="6718136">.</span><span class="ident" id="6718137">Index</span><span class="op" id="6718142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6718146">resolveTCPAddrTests</span>&nbsp;<span class="op" id="6718166">=</span>&nbsp;<span class="builtinfunc" id="6718168">append</span><span class="op" id="6718174">(</span><span class="ident" id="6718175">resolveTCPAddrTests</span><span class="op" id="6718194">,</span>&nbsp;<span class="op" id="6718196">[</span><span class="op" id="6718197">]</span><span class="ident" id="6718198">resolveTCPAddrTest</span><span class="op" id="6718216">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6718221">{</span><span class="string" id="6718222">&#34;tcp6&#34;</span><span class="op" id="6718228">,</span>&nbsp;<span class="string" id="6718230">&#34;[fe80::1%&#34;</span>&nbsp;<span class="op" id="6718242">+</span>&nbsp;<span class="ident" id="6718244">ifi</span><span class="op" id="6718247">.</span><span class="ident" id="6718248">Name</span>&nbsp;<span class="op" id="6718253">+</span>&nbsp;<span class="string" id="6718255">&#34;]:3&#34;</span><span class="op" id="6718260">,</span>&nbsp;<span class="op" id="6718262">&amp;</span><span class="ident" id="6718263">TCPAddr</span><span class="op" id="6718270">{</span><span class="ident" id="6718271">IP</span><span class="op" id="6718273">:</span>&nbsp;<span class="ident" id="6718275">ParseIP</span><span class="op" id="6718282">(</span><span class="string" id="6718283">&#34;fe80::1&#34;</span><span class="op" id="6718292">)</span><span class="op" id="6718293">,</span>&nbsp;<span class="ident" id="6718295">Port</span><span class="op" id="6718299">:</span>&nbsp;<span class="num" id="6718301">3</span><span class="op" id="6718302">,</span>&nbsp;<span class="ident" id="6718304">Zone</span><span class="op" id="6718308">:</span>&nbsp;<span class="ident" id="6718310">zoneToString</span><span class="op" id="6718322">(</span><span class="ident" id="6718323">ifi</span><span class="op" id="6718326">.</span><span class="ident" id="6718327">Index</span><span class="op" id="6718332">)</span><span class="op" id="6718333">}</span><span class="op" id="6718334">,</span>&nbsp;<span class="ident" id="6718336">nil</span><span class="op" id="6718339">}</span><span class="op" id="6718340">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6718345">{</span><span class="string" id="6718346">&#34;tcp6&#34;</span><span class="op" id="6718352">,</span>&nbsp;<span class="string" id="6718354">&#34;[fe80::1%&#34;</span>&nbsp;<span class="op" id="6718366">+</span>&nbsp;<span class="ident" id="6718368">index</span>&nbsp;<span class="op" id="6718374">+</span>&nbsp;<span class="string" id="6718376">&#34;]:4&#34;</span><span class="op" id="6718381">,</span>&nbsp;<span class="op" id="6718383">&amp;</span><span class="ident" id="6718384">TCPAddr</span><span class="op" id="6718391">{</span><span class="ident" id="6718392">IP</span><span class="op" id="6718394">:</span>&nbsp;<span class="ident" id="6718396">ParseIP</span><span class="op" id="6718403">(</span><span class="string" id="6718404">&#34;fe80::1&#34;</span><span class="op" id="6718413">)</span><span class="op" id="6718414">,</span>&nbsp;<span class="ident" id="6718416">Port</span><span class="op" id="6718420">:</span>&nbsp;<span class="num" id="6718422">4</span><span class="op" id="6718423">,</span>&nbsp;<span class="ident" id="6718425">Zone</span><span class="op" id="6718429">:</span>&nbsp;<span class="ident" id="6718431">index</span><span class="op" id="6718436">}</span><span class="op" id="6718437">,</span>&nbsp;<span class="ident" id="6718439">nil</span><span class="op" id="6718442">}</span><span class="op" id="6718443">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6718447">}</span><span class="op" id="6718448">...</span><span class="op" id="6718451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6718454">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6718457">if</span>&nbsp;<span class="ident" id="6718460">ips</span><span class="op" id="6718463">,</span>&nbsp;<span class="ident" id="6718465">err</span>&nbsp;<span class="op" id="6718469">:=</span>&nbsp;<span class="ident" id="6718472">LookupIP</span><span class="op" id="6718480">(</span><span class="string" id="6718481">&#34;localhost&#34;</span><span class="op" id="6718492">)</span><span class="op" id="6718493">;</span>&nbsp;<span class="ident" id="6718495">err</span>&nbsp;<span class="op" id="6718499">==</span>&nbsp;<span class="ident" id="6718502">nil</span>&nbsp;<span class="op" id="6718506">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="6718509">len</span><span class="op" id="6718512">(</span><span class="ident" id="6718513">ips</span><span class="op" id="6718516">)</span>&nbsp;<span class="op" id="6718518">&gt;</span>&nbsp;<span class="num" id="6718520">1</span>&nbsp;<span class="op" id="6718522">&amp;&amp;</span>&nbsp;<span class="ident" id="6718525">supportsIPv4</span>&nbsp;<span class="op" id="6718538">&amp;&amp;</span>&nbsp;<span class="ident" id="6718541">supportsIPv6</span>&nbsp;<span class="op" id="6718554">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6718558">resolveTCPAddrTests</span>&nbsp;<span class="op" id="6718578">=</span>&nbsp;<span class="builtinfunc" id="6718580">append</span><span class="op" id="6718586">(</span><span class="ident" id="6718587">resolveTCPAddrTests</span><span class="op" id="6718606">,</span>&nbsp;<span class="op" id="6718608">[</span><span class="op" id="6718609">]</span><span class="ident" id="6718610">resolveTCPAddrTest</span><span class="op" id="6718628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6718633">{</span><span class="string" id="6718634">&#34;tcp&#34;</span><span class="op" id="6718639">,</span>&nbsp;<span class="string" id="6718641">&#34;localhost:5&#34;</span><span class="op" id="6718654">,</span>&nbsp;<span class="op" id="6718656">&amp;</span><span class="ident" id="6718657">TCPAddr</span><span class="op" id="6718664">{</span><span class="ident" id="6718665">IP</span><span class="op" id="6718667">:</span>&nbsp;<span class="ident" id="6718669">IPv4</span><span class="op" id="6718673">(</span><span class="num" id="6718674">127</span><span class="op" id="6718677">,</span>&nbsp;<span class="num" id="6718679">0</span><span class="op" id="6718680">,</span>&nbsp;<span class="num" id="6718682">0</span><span class="op" id="6718683">,</span>&nbsp;<span class="num" id="6718685">1</span><span class="op" id="6718686">)</span><span class="op" id="6718687">,</span>&nbsp;<span class="ident" id="6718689">Port</span><span class="op" id="6718693">:</span>&nbsp;<span class="num" id="6718695">5</span><span class="op" id="6718696">}</span><span class="op" id="6718697">,</span>&nbsp;<span class="ident" id="6718699">nil</span><span class="op" id="6718702">}</span><span class="op" id="6718703">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6718708">{</span><span class="string" id="6718709">&#34;tcp4&#34;</span><span class="op" id="6718715">,</span>&nbsp;<span class="string" id="6718717">&#34;localhost:6&#34;</span><span class="op" id="6718730">,</span>&nbsp;<span class="op" id="6718732">&amp;</span><span class="ident" id="6718733">TCPAddr</span><span class="op" id="6718740">{</span><span class="ident" id="6718741">IP</span><span class="op" id="6718743">:</span>&nbsp;<span class="ident" id="6718745">IPv4</span><span class="op" id="6718749">(</span><span class="num" id="6718750">127</span><span class="op" id="6718753">,</span>&nbsp;<span class="num" id="6718755">0</span><span class="op" id="6718756">,</span>&nbsp;<span class="num" id="6718758">0</span><span class="op" id="6718759">,</span>&nbsp;<span class="num" id="6718761">1</span><span class="op" id="6718762">)</span><span class="op" id="6718763">,</span>&nbsp;<span class="ident" id="6718765">Port</span><span class="op" id="6718769">:</span>&nbsp;<span class="num" id="6718771">6</span><span class="op" id="6718772">}</span><span class="op" id="6718773">,</span>&nbsp;<span class="ident" id="6718775">nil</span><span class="op" id="6718778">}</span><span class="op" id="6718779">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6718784">{</span><span class="string" id="6718785">&#34;tcp6&#34;</span><span class="op" id="6718791">,</span>&nbsp;<span class="string" id="6718793">&#34;localhost:7&#34;</span><span class="op" id="6718806">,</span>&nbsp;<span class="op" id="6718808">&amp;</span><span class="ident" id="6718809">TCPAddr</span><span class="op" id="6718816">{</span><span class="ident" id="6718817">IP</span><span class="op" id="6718819">:</span>&nbsp;<span class="ident" id="6718821">IPv6loopback</span><span class="op" id="6718833">,</span>&nbsp;<span class="ident" id="6718835">Port</span><span class="op" id="6718839">:</span>&nbsp;<span class="num" id="6718841">7</span><span class="op" id="6718842">}</span><span class="op" id="6718843">,</span>&nbsp;<span class="ident" id="6718845">nil</span><span class="op" id="6718848">}</span><span class="op" id="6718849">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6718853">}</span><span class="op" id="6718854">...</span><span class="op" id="6718857">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6718860">}</span><br>
<span class="lineno"></span><span class="op" id="6718862">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6718865">func</span>&nbsp;<span class="ident" id="6718870">TestResolveTCPAddr</span><span class="op" id="6718888">(</span><span class="ident" id="6718889">t</span>&nbsp;<span class="op" id="6718891">*</span><span class="ident" id="6718892">testing</span><span class="op" id="6718899">.</span><span class="ident" id="6718900">T</span><span class="op" id="6718901">)</span>&nbsp;<span class="op" id="6718903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6718906">for</span>&nbsp;<span class="ident" id="6718910">_</span><span class="op" id="6718911">,</span>&nbsp;<span class="ident" id="6718913">tt</span>&nbsp;<span class="op" id="6718916">:=</span>&nbsp;<span class="keyword" id="6718919">range</span>&nbsp;<span class="ident" id="6718925">resolveTCPAddrTests</span>&nbsp;<span class="op" id="6718945">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6718949">addr</span><span class="op" id="6718953">,</span>&nbsp;<span class="ident" id="6718955">err</span>&nbsp;<span class="op" id="6718959">:=</span>&nbsp;<span class="ident" id="6718962">ResolveTCPAddr</span><span class="op" id="6718976">(</span><span class="ident" id="6718977">tt</span><span class="op" id="6718979">.</span><span class="ident" id="6718980">net</span><span class="op" id="6718983">,</span>&nbsp;<span class="ident" id="6718985">tt</span><span class="op" id="6718987">.</span><span class="ident" id="6718988">litAddrOrName</span><span class="op" id="6719001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6719005">if</span>&nbsp;<span class="ident" id="6719008">err</span>&nbsp;<span class="op" id="6719012">!=</span>&nbsp;<span class="ident" id="6719015">tt</span><span class="op" id="6719017">.</span><span class="ident" id="6719018">err</span>&nbsp;<span class="op" id="6719022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6719027">t</span><span class="op" id="6719028">.</span><span class="ident" id="6719029">Fatalf</span><span class="op" id="6719035">(</span><span class="string" id="6719036">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6719071">,</span>&nbsp;<span class="ident" id="6719073">tt</span><span class="op" id="6719075">.</span><span class="ident" id="6719076">net</span><span class="op" id="6719079">,</span>&nbsp;<span class="ident" id="6719081">tt</span><span class="op" id="6719083">.</span><span class="ident" id="6719084">litAddrOrName</span><span class="op" id="6719097">,</span>&nbsp;<span class="ident" id="6719099">err</span><span class="op" id="6719102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6719106">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6719110">if</span>&nbsp;<span class="op" id="6719113">!</span><span class="ident" id="6719114">reflect</span><span class="op" id="6719121">.</span><span class="ident" id="6719122">DeepEqual</span><span class="op" id="6719131">(</span><span class="ident" id="6719132">addr</span><span class="op" id="6719136">,</span>&nbsp;<span class="ident" id="6719138">tt</span><span class="op" id="6719140">.</span><span class="ident" id="6719141">addr</span><span class="op" id="6719145">)</span>&nbsp;<span class="op" id="6719147">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6719152">t</span><span class="op" id="6719153">.</span><span class="ident" id="6719154">Fatalf</span><span class="op" id="6719160">(</span><span class="string" id="6719161">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;=&nbsp;%#v,&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="6719201">,</span>&nbsp;<span class="ident" id="6719203">tt</span><span class="op" id="6719205">.</span><span class="ident" id="6719206">net</span><span class="op" id="6719209">,</span>&nbsp;<span class="ident" id="6719211">tt</span><span class="op" id="6719213">.</span><span class="ident" id="6719214">litAddrOrName</span><span class="op" id="6719227">,</span>&nbsp;<span class="ident" id="6719229">addr</span><span class="op" id="6719233">,</span>&nbsp;<span class="ident" id="6719235">tt</span><span class="op" id="6719237">.</span><span class="ident" id="6719238">addr</span><span class="op" id="6719242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6719246">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6719250">if</span>&nbsp;<span class="ident" id="6719253">err</span>&nbsp;<span class="op" id="6719257">==</span>&nbsp;<span class="ident" id="6719260">nil</span>&nbsp;<span class="op" id="6719264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6719269">str</span>&nbsp;<span class="op" id="6719273">:=</span>&nbsp;<span class="ident" id="6719276">addr</span><span class="op" id="6719280">.</span><span class="ident" id="6719281">String</span><span class="op" id="6719287">(</span><span class="op" id="6719288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6719293">addr1</span><span class="op" id="6719298">,</span>&nbsp;<span class="ident" id="6719300">err</span>&nbsp;<span class="op" id="6719304">:=</span>&nbsp;<span class="ident" id="6719307">ResolveTCPAddr</span><span class="op" id="6719321">(</span><span class="ident" id="6719322">tt</span><span class="op" id="6719324">.</span><span class="ident" id="6719325">net</span><span class="op" id="6719328">,</span>&nbsp;<span class="ident" id="6719330">str</span><span class="op" id="6719333">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6719338">if</span>&nbsp;<span class="ident" id="6719341">err</span>&nbsp;<span class="op" id="6719345">!=</span>&nbsp;<span class="ident" id="6719348">nil</span>&nbsp;<span class="op" id="6719352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6719358">t</span><span class="op" id="6719359">.</span><span class="ident" id="6719360">Fatalf</span><span class="op" id="6719366">(</span><span class="string" id="6719367">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;[from&nbsp;%q]:&nbsp;%v&#34;</span><span class="op" id="6719405">,</span>&nbsp;<span class="ident" id="6719407">tt</span><span class="op" id="6719409">.</span><span class="ident" id="6719410">net</span><span class="op" id="6719413">,</span>&nbsp;<span class="ident" id="6719415">str</span><span class="op" id="6719418">,</span>&nbsp;<span class="ident" id="6719420">tt</span><span class="op" id="6719422">.</span><span class="ident" id="6719423">litAddrOrName</span><span class="op" id="6719436">,</span>&nbsp;<span class="ident" id="6719438">err</span><span class="op" id="6719441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6719446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6719451">if</span>&nbsp;<span class="op" id="6719454">!</span><span class="ident" id="6719455">reflect</span><span class="op" id="6719462">.</span><span class="ident" id="6719463">DeepEqual</span><span class="op" id="6719472">(</span><span class="ident" id="6719473">addr1</span><span class="op" id="6719478">,</span>&nbsp;<span class="ident" id="6719480">addr</span><span class="op" id="6719484">)</span>&nbsp;<span class="op" id="6719486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6719492">t</span><span class="op" id="6719493">.</span><span class="ident" id="6719494">Fatalf</span><span class="op" id="6719500">(</span><span class="string" id="6719501">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;[from&nbsp;%q]&nbsp;=&nbsp;%#v,&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="6719551">,</span>&nbsp;<span class="ident" id="6719553">tt</span><span class="op" id="6719555">.</span><span class="ident" id="6719556">net</span><span class="op" id="6719559">,</span>&nbsp;<span class="ident" id="6719561">str</span><span class="op" id="6719564">,</span>&nbsp;<span class="ident" id="6719566">tt</span><span class="op" id="6719568">.</span><span class="ident" id="6719569">litAddrOrName</span><span class="op" id="6719582">,</span>&nbsp;<span class="ident" id="6719584">addr1</span><span class="op" id="6719589">,</span>&nbsp;<span class="ident" id="6719591">addr</span><span class="op" id="6719595">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6719600">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6719604">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6719607">}</span><br>
<span class="lineno"></span><span class="op" id="6719609">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span><span class="keyword" id="6719612">var</span>&nbsp;<span class="ident" id="6719616">tcpListenerNameTests</span>&nbsp;<span class="op" id="6719637">=</span>&nbsp;<span class="op" id="6719639">[</span><span class="op" id="6719640">]</span><span class="keyword" id="6719641">struct</span>&nbsp;<span class="op" id="6719648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6719651">net</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6719657">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6719665">laddr</span>&nbsp;<span class="op" id="6719671">*</span><span class="ident" id="6719672">TCPAddr</span><br>
<span class="lineno"></span><span class="op" id="6719680">}</span><span class="op" id="6719681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6719684">{</span><span class="string" id="6719685">&#34;tcp4&#34;</span><span class="op" id="6719691">,</span>&nbsp;<span class="op" id="6719693">&amp;</span><span class="ident" id="6719694">TCPAddr</span><span class="op" id="6719701">{</span><span class="ident" id="6719702">IP</span><span class="op" id="6719704">:</span>&nbsp;<span class="ident" id="6719706">IPv4</span><span class="op" id="6719710">(</span><span class="num" id="6719711">127</span><span class="op" id="6719714">,</span>&nbsp;<span class="num" id="6719716">0</span><span class="op" id="6719717">,</span>&nbsp;<span class="num" id="6719719">0</span><span class="op" id="6719720">,</span>&nbsp;<span class="num" id="6719722">1</span><span class="op" id="6719723">)</span><span class="op" id="6719724">}</span><span class="op" id="6719725">}</span><span class="op" id="6719726">,</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6719729">{</span><span class="string" id="6719730">&#34;tcp4&#34;</span><span class="op" id="6719736">,</span>&nbsp;<span class="op" id="6719738">&amp;</span><span class="ident" id="6719739">TCPAddr</span><span class="op" id="6719746">{</span><span class="op" id="6719747">}</span><span class="op" id="6719748">}</span><span class="op" id="6719749">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6719752">{</span><span class="string" id="6719753">&#34;tcp4&#34;</span><span class="op" id="6719759">,</span>&nbsp;<span class="ident" id="6719761">nil</span><span class="op" id="6719764">}</span><span class="op" id="6719765">,</span><br>
<span class="lineno"></span><span class="op" id="6719767">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6719770">func</span>&nbsp;<span class="ident" id="6719775">TestTCPListenerName</span><span class="op" id="6719794">(</span><span class="ident" id="6719795">t</span>&nbsp;<span class="op" id="6719797">*</span><span class="ident" id="6719798">testing</span><span class="op" id="6719805">.</span><span class="ident" id="6719806">T</span><span class="op" id="6719807">)</span>&nbsp;<span class="op" id="6719809">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6719812">if</span>&nbsp;<span class="ident" id="6719815">testing</span><span class="op" id="6719822">.</span><span class="ident" id="6719823">Short</span><span class="op" id="6719828">(</span><span class="op" id="6719829">)</span>&nbsp;<span class="op" id="6719831">||</span>&nbsp;<span class="op" id="6719834">!</span><span class="op" id="6719835">*</span><span class="ident" id="6719836">testExternal</span>&nbsp;<span class="op" id="6719849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6719853">t</span><span class="op" id="6719854">.</span><span class="ident" id="6719855">Skip</span><span class="op" id="6719859">(</span><span class="string" id="6719860">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="6719901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6719904">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6719908">for</span>&nbsp;<span class="ident" id="6719912">_</span><span class="op" id="6719913">,</span>&nbsp;<span class="ident" id="6719915">tt</span>&nbsp;<span class="op" id="6719918">:=</span>&nbsp;<span class="keyword" id="6719921">range</span>&nbsp;<span class="ident" id="6719927">tcpListenerNameTests</span>&nbsp;<span class="op" id="6719948">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6719952">ln</span><span class="op" id="6719954">,</span>&nbsp;<span class="ident" id="6719956">err</span>&nbsp;<span class="op" id="6719960">:=</span>&nbsp;<span class="ident" id="6719963">ListenTCP</span><span class="op" id="6719972">(</span><span class="ident" id="6719973">tt</span><span class="op" id="6719975">.</span><span class="ident" id="6719976">net</span><span class="op" id="6719979">,</span>&nbsp;<span class="ident" id="6719981">tt</span><span class="op" id="6719983">.</span><span class="ident" id="6719984">laddr</span><span class="op" id="6719989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6719993">if</span>&nbsp;<span class="ident" id="6719996">err</span>&nbsp;<span class="op" id="6720000">!=</span>&nbsp;<span class="ident" id="6720003">nil</span>&nbsp;<span class="op" id="6720007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6720012">t</span><span class="op" id="6720013">.</span><span class="ident" id="6720014">Fatalf</span><span class="op" id="6720020">(</span><span class="string" id="6720021">&#34;ListenTCP&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6720043">,</span>&nbsp;<span class="ident" id="6720045">err</span><span class="op" id="6720048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6720052">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6720056">defer</span>&nbsp;<span class="ident" id="6720062">ln</span><span class="op" id="6720064">.</span><span class="ident" id="6720065">Close</span><span class="op" id="6720070">(</span><span class="op" id="6720071">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6720075">la</span>&nbsp;<span class="op" id="6720078">:=</span>&nbsp;<span class="ident" id="6720081">ln</span><span class="op" id="6720083">.</span><span class="ident" id="6720084">Addr</span><span class="op" id="6720088">(</span><span class="op" id="6720089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6720093">if</span>&nbsp;<span class="ident" id="6720096">a</span><span class="op" id="6720097">,</span>&nbsp;<span class="ident" id="6720099">ok</span>&nbsp;<span class="op" id="6720102">:=</span>&nbsp;<span class="ident" id="6720105">la</span><span class="op" id="6720107">.</span><span class="op" id="6720108">(</span><span class="op" id="6720109">*</span><span class="ident" id="6720110">TCPAddr</span><span class="op" id="6720117">)</span><span class="op" id="6720118">;</span>&nbsp;<span class="op" id="6720120">!</span><span class="ident" id="6720121">ok</span>&nbsp;<span class="op" id="6720124">||</span>&nbsp;<span class="ident" id="6720127">a</span><span class="op" id="6720128">.</span><span class="ident" id="6720129">Port</span>&nbsp;<span class="op" id="6720134">==</span>&nbsp;<span class="num" id="6720137">0</span>&nbsp;<span class="op" id="6720139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6720144">t</span><span class="op" id="6720145">.</span><span class="ident" id="6720146">Fatalf</span><span class="op" id="6720152">(</span><span class="string" id="6720153">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;non-zero&nbsp;port&nbsp;number&#34;</span><span class="op" id="6720214">,</span>&nbsp;<span class="ident" id="6720216">la</span><span class="op" id="6720218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6720222">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6720225">}</span><br>
<span class="lineno">375</span><span class="op" id="6720227">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6720230">func</span>&nbsp;<span class="ident" id="6720235">TestIPv6LinkLocalUnicastTCP</span><span class="op" id="6720262">(</span><span class="ident" id="6720263">t</span>&nbsp;<span class="op" id="6720265">*</span><span class="ident" id="6720266">testing</span><span class="op" id="6720273">.</span><span class="ident" id="6720274">T</span><span class="op" id="6720275">)</span>&nbsp;<span class="op" id="6720277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6720280">if</span>&nbsp;<span class="ident" id="6720283">testing</span><span class="op" id="6720290">.</span><span class="ident" id="6720291">Short</span><span class="op" id="6720296">(</span><span class="op" id="6720297">)</span>&nbsp;<span class="op" id="6720299">||</span>&nbsp;<span class="op" id="6720302">!</span><span class="op" id="6720303">*</span><span class="ident" id="6720304">testExternal</span>&nbsp;<span class="op" id="6720317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6720321">t</span><span class="op" id="6720322">.</span><span class="ident" id="6720323">Skip</span><span class="op" id="6720327">(</span><span class="string" id="6720328">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="6720369">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6720372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6720375">if</span>&nbsp;<span class="op" id="6720378">!</span><span class="ident" id="6720379">supportsIPv6</span>&nbsp;<span class="op" id="6720392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6720396">t</span><span class="op" id="6720397">.</span><span class="ident" id="6720398">Skip</span><span class="op" id="6720402">(</span><span class="string" id="6720403">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="6720426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6720429">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6720432">ifi</span>&nbsp;<span class="op" id="6720436">:=</span>&nbsp;<span class="ident" id="6720439">loopbackInterface</span><span class="op" id="6720456">(</span><span class="op" id="6720457">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6720460">if</span>&nbsp;<span class="ident" id="6720463">ifi</span>&nbsp;<span class="op" id="6720467">==</span>&nbsp;<span class="ident" id="6720470">nil</span>&nbsp;<span class="op" id="6720474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6720478">t</span><span class="op" id="6720479">.</span><span class="ident" id="6720480">Skip</span><span class="op" id="6720484">(</span><span class="string" id="6720485">&#34;loopback&nbsp;interface&nbsp;not&nbsp;found&#34;</span><span class="op" id="6720515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6720518">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6720521">laddr</span>&nbsp;<span class="op" id="6720527">:=</span>&nbsp;<span class="ident" id="6720530">ipv6LinkLocalUnicastAddr</span><span class="op" id="6720554">(</span><span class="ident" id="6720555">ifi</span><span class="op" id="6720558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6720561">if</span>&nbsp;<span class="ident" id="6720564">laddr</span>&nbsp;<span class="op" id="6720570">==</span>&nbsp;<span class="string" id="6720573">&#34;&#34;</span>&nbsp;<span class="op" id="6720576">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6720580">t</span><span class="op" id="6720581">.</span><span class="ident" id="6720582">Skip</span><span class="op" id="6720586">(</span><span class="string" id="6720587">&#34;ipv6&nbsp;unicast&nbsp;address&nbsp;on&nbsp;loopback&nbsp;not&nbsp;found&#34;</span><span class="op" id="6720631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6720634">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6720638">type</span>&nbsp;<span class="ident" id="6720643">test</span>&nbsp;<span class="keyword" id="6720648">struct</span>&nbsp;<span class="op" id="6720655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6720659">net</span><span class="op" id="6720662">,</span>&nbsp;<span class="ident" id="6720664">addr</span>&nbsp;&nbsp;<span class="builtintype" id="6720670">string</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6720679">nameLookup</span>&nbsp;<span class="builtintype" id="6720690">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6720696">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6720699">var</span>&nbsp;<span class="ident" id="6720703">tests</span>&nbsp;<span class="op" id="6720709">=</span>&nbsp;<span class="op" id="6720711">[</span><span class="op" id="6720712">]</span><span class="ident" id="6720713">test</span><span class="op" id="6720717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6720721">{</span><span class="string" id="6720722">&#34;tcp&#34;</span><span class="op" id="6720727">,</span>&nbsp;<span class="string" id="6720729">&#34;[&#34;</span>&nbsp;<span class="op" id="6720733">+</span>&nbsp;<span class="ident" id="6720735">laddr</span>&nbsp;<span class="op" id="6720741">+</span>&nbsp;<span class="string" id="6720743">&#34;%&#34;</span>&nbsp;<span class="op" id="6720747">+</span>&nbsp;<span class="ident" id="6720749">ifi</span><span class="op" id="6720752">.</span><span class="ident" id="6720753">Name</span>&nbsp;<span class="op" id="6720758">+</span>&nbsp;<span class="string" id="6720760">&#34;]:0&#34;</span><span class="op" id="6720765">,</span>&nbsp;<span class="builtintype" id="6720767">false</span><span class="op" id="6720772">}</span><span class="op" id="6720773">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6720777">{</span><span class="string" id="6720778">&#34;tcp6&#34;</span><span class="op" id="6720784">,</span>&nbsp;<span class="string" id="6720786">&#34;[&#34;</span>&nbsp;<span class="op" id="6720790">+</span>&nbsp;<span class="ident" id="6720792">laddr</span>&nbsp;<span class="op" id="6720798">+</span>&nbsp;<span class="string" id="6720800">&#34;%&#34;</span>&nbsp;<span class="op" id="6720804">+</span>&nbsp;<span class="ident" id="6720806">ifi</span><span class="op" id="6720809">.</span><span class="ident" id="6720810">Name</span>&nbsp;<span class="op" id="6720815">+</span>&nbsp;<span class="string" id="6720817">&#34;]:0&#34;</span><span class="op" id="6720822">,</span>&nbsp;<span class="builtintype" id="6720824">false</span><span class="op" id="6720829">}</span><span class="op" id="6720830">,</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6720833">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6720836">switch</span>&nbsp;<span class="ident" id="6720843">runtime</span><span class="op" id="6720850">.</span><span class="ident" id="6720851">GOOS</span>&nbsp;<span class="op" id="6720856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6720859">case</span>&nbsp;<span class="string" id="6720864">&#34;darwin&#34;</span><span class="op" id="6720872">,</span>&nbsp;<span class="string" id="6720874">&#34;freebsd&#34;</span><span class="op" id="6720883">,</span>&nbsp;<span class="string" id="6720885">&#34;openbsd&#34;</span><span class="op" id="6720894">,</span>&nbsp;<span class="string" id="6720896">&#34;netbsd&#34;</span><span class="op" id="6720904">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6720908">tests</span>&nbsp;<span class="op" id="6720914">=</span>&nbsp;<span class="builtinfunc" id="6720916">append</span><span class="op" id="6720922">(</span><span class="ident" id="6720923">tests</span><span class="op" id="6720928">,</span>&nbsp;<span class="op" id="6720930">[</span><span class="op" id="6720931">]</span><span class="ident" id="6720932">test</span><span class="op" id="6720936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6720941">{</span><span class="string" id="6720942">&#34;tcp&#34;</span><span class="op" id="6720947">,</span>&nbsp;<span class="string" id="6720949">&#34;[localhost%&#34;</span>&nbsp;<span class="op" id="6720963">+</span>&nbsp;<span class="ident" id="6720965">ifi</span><span class="op" id="6720968">.</span><span class="ident" id="6720969">Name</span>&nbsp;<span class="op" id="6720974">+</span>&nbsp;<span class="string" id="6720976">&#34;]:0&#34;</span><span class="op" id="6720981">,</span>&nbsp;<span class="builtintype" id="6720983">true</span><span class="op" id="6720987">}</span><span class="op" id="6720988">,</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6720993">{</span><span class="string" id="6720994">&#34;tcp6&#34;</span><span class="op" id="6721000">,</span>&nbsp;<span class="string" id="6721002">&#34;[localhost%&#34;</span>&nbsp;<span class="op" id="6721016">+</span>&nbsp;<span class="ident" id="6721018">ifi</span><span class="op" id="6721021">.</span><span class="ident" id="6721022">Name</span>&nbsp;<span class="op" id="6721027">+</span>&nbsp;<span class="string" id="6721029">&#34;]:0&#34;</span><span class="op" id="6721034">,</span>&nbsp;<span class="builtintype" id="6721036">true</span><span class="op" id="6721040">}</span><span class="op" id="6721041">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6721045">}</span><span class="op" id="6721046">...</span><span class="op" id="6721049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6721052">case</span>&nbsp;<span class="string" id="6721057">&#34;linux&#34;</span><span class="op" id="6721064">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6721068">tests</span>&nbsp;<span class="op" id="6721074">=</span>&nbsp;<span class="builtinfunc" id="6721076">append</span><span class="op" id="6721082">(</span><span class="ident" id="6721083">tests</span><span class="op" id="6721088">,</span>&nbsp;<span class="op" id="6721090">[</span><span class="op" id="6721091">]</span><span class="ident" id="6721092">test</span><span class="op" id="6721096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6721101">{</span><span class="string" id="6721102">&#34;tcp&#34;</span><span class="op" id="6721107">,</span>&nbsp;<span class="string" id="6721109">&#34;[ip6-localhost%&#34;</span>&nbsp;<span class="op" id="6721127">+</span>&nbsp;<span class="ident" id="6721129">ifi</span><span class="op" id="6721132">.</span><span class="ident" id="6721133">Name</span>&nbsp;<span class="op" id="6721138">+</span>&nbsp;<span class="string" id="6721140">&#34;]:0&#34;</span><span class="op" id="6721145">,</span>&nbsp;<span class="builtintype" id="6721147">true</span><span class="op" id="6721151">}</span><span class="op" id="6721152">,</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6721157">{</span><span class="string" id="6721158">&#34;tcp6&#34;</span><span class="op" id="6721164">,</span>&nbsp;<span class="string" id="6721166">&#34;[ip6-localhost%&#34;</span>&nbsp;<span class="op" id="6721184">+</span>&nbsp;<span class="ident" id="6721186">ifi</span><span class="op" id="6721189">.</span><span class="ident" id="6721190">Name</span>&nbsp;<span class="op" id="6721195">+</span>&nbsp;<span class="string" id="6721197">&#34;]:0&#34;</span><span class="op" id="6721202">,</span>&nbsp;<span class="builtintype" id="6721204">true</span><span class="op" id="6721208">}</span><span class="op" id="6721209">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6721213">}</span><span class="op" id="6721214">...</span><span class="op" id="6721217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6721220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6721223">for</span>&nbsp;<span class="ident" id="6721227">_</span><span class="op" id="6721228">,</span>&nbsp;<span class="ident" id="6721230">tt</span>&nbsp;<span class="op" id="6721233">:=</span>&nbsp;<span class="keyword" id="6721236">range</span>&nbsp;<span class="ident" id="6721242">tests</span>&nbsp;<span class="op" id="6721248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6721252">ln</span><span class="op" id="6721254">,</span>&nbsp;<span class="ident" id="6721256">err</span>&nbsp;<span class="op" id="6721260">:=</span>&nbsp;<span class="ident" id="6721263">Listen</span><span class="op" id="6721269">(</span><span class="ident" id="6721270">tt</span><span class="op" id="6721272">.</span><span class="ident" id="6721273">net</span><span class="op" id="6721276">,</span>&nbsp;<span class="ident" id="6721278">tt</span><span class="op" id="6721280">.</span><span class="ident" id="6721281">addr</span><span class="op" id="6721285">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6721289">if</span>&nbsp;<span class="ident" id="6721292">err</span>&nbsp;<span class="op" id="6721296">!=</span>&nbsp;<span class="ident" id="6721299">nil</span>&nbsp;<span class="op" id="6721303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6721308">//&nbsp;It&nbsp;might&nbsp;return&nbsp;&#34;LookupHost&nbsp;returned&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6721354">//&nbsp;suitable&nbsp;address&#34;&nbsp;error&nbsp;on&nbsp;some&nbsp;platforms.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6721403">t</span><span class="op" id="6721404">.</span><span class="ident" id="6721405">Logf</span><span class="op" id="6721409">(</span><span class="string" id="6721410">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6721429">,</span>&nbsp;<span class="ident" id="6721431">err</span><span class="op" id="6721434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6721439">continue</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6721450">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6721454">defer</span>&nbsp;<span class="ident" id="6721460">ln</span><span class="op" id="6721462">.</span><span class="ident" id="6721463">Close</span><span class="op" id="6721468">(</span><span class="op" id="6721469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6721473">if</span>&nbsp;<span class="ident" id="6721476">la</span><span class="op" id="6721478">,</span>&nbsp;<span class="ident" id="6721480">ok</span>&nbsp;<span class="op" id="6721483">:=</span>&nbsp;<span class="ident" id="6721486">ln</span><span class="op" id="6721488">.</span><span class="ident" id="6721489">Addr</span><span class="op" id="6721493">(</span><span class="op" id="6721494">)</span><span class="op" id="6721495">.</span><span class="op" id="6721496">(</span><span class="op" id="6721497">*</span><span class="ident" id="6721498">TCPAddr</span><span class="op" id="6721505">)</span><span class="op" id="6721506">;</span>&nbsp;<span class="op" id="6721508">!</span><span class="ident" id="6721509">ok</span>&nbsp;<span class="op" id="6721512">||</span>&nbsp;<span class="op" id="6721515">!</span><span class="ident" id="6721516">tt</span><span class="op" id="6721518">.</span><span class="ident" id="6721519">nameLookup</span>&nbsp;<span class="op" id="6721530">&amp;&amp;</span>&nbsp;<span class="ident" id="6721533">la</span><span class="op" id="6721535">.</span><span class="ident" id="6721536">Zone</span>&nbsp;<span class="op" id="6721541">==</span>&nbsp;<span class="string" id="6721544">&#34;&#34;</span>&nbsp;<span class="op" id="6721547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6721552">t</span><span class="op" id="6721553">.</span><span class="ident" id="6721554">Fatalf</span><span class="op" id="6721560">(</span><span class="string" id="6721561">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;zone&nbsp;identifier&#34;</span><span class="op" id="6721617">,</span>&nbsp;<span class="ident" id="6721619">la</span><span class="op" id="6721621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6721625">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6721630">done</span>&nbsp;<span class="op" id="6721635">:=</span>&nbsp;<span class="builtinfunc" id="6721638">make</span><span class="op" id="6721642">(</span><span class="keyword" id="6721643">chan</span>&nbsp;<span class="builtintype" id="6721648">int</span><span class="op" id="6721651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6721655">go</span>&nbsp;<span class="ident" id="6721658">transponder</span><span class="op" id="6721669">(</span><span class="ident" id="6721670">t</span><span class="op" id="6721671">,</span>&nbsp;<span class="ident" id="6721673">ln</span><span class="op" id="6721675">,</span>&nbsp;<span class="ident" id="6721677">done</span><span class="op" id="6721681">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6721686">c</span><span class="op" id="6721687">,</span>&nbsp;<span class="ident" id="6721689">err</span>&nbsp;<span class="op" id="6721693">:=</span>&nbsp;<span class="ident" id="6721696">Dial</span><span class="op" id="6721700">(</span><span class="ident" id="6721701">tt</span><span class="op" id="6721703">.</span><span class="ident" id="6721704">net</span><span class="op" id="6721707">,</span>&nbsp;<span class="ident" id="6721709">ln</span><span class="op" id="6721711">.</span><span class="ident" id="6721712">Addr</span><span class="op" id="6721716">(</span><span class="op" id="6721717">)</span><span class="op" id="6721718">.</span><span class="ident" id="6721719">String</span><span class="op" id="6721725">(</span><span class="op" id="6721726">)</span><span class="op" id="6721727">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6721731">if</span>&nbsp;<span class="ident" id="6721734">err</span>&nbsp;<span class="op" id="6721738">!=</span>&nbsp;<span class="ident" id="6721741">nil</span>&nbsp;<span class="op" id="6721745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6721750">t</span><span class="op" id="6721751">.</span><span class="ident" id="6721752">Fatalf</span><span class="op" id="6721758">(</span><span class="string" id="6721759">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6721776">,</span>&nbsp;<span class="ident" id="6721778">err</span><span class="op" id="6721781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6721785">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6721789">defer</span>&nbsp;<span class="ident" id="6721795">c</span><span class="op" id="6721796">.</span><span class="ident" id="6721797">Close</span><span class="op" id="6721802">(</span><span class="op" id="6721803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6721807">if</span>&nbsp;<span class="ident" id="6721810">la</span><span class="op" id="6721812">,</span>&nbsp;<span class="ident" id="6721814">ok</span>&nbsp;<span class="op" id="6721817">:=</span>&nbsp;<span class="ident" id="6721820">c</span><span class="op" id="6721821">.</span><span class="ident" id="6721822">LocalAddr</span><span class="op" id="6721831">(</span><span class="op" id="6721832">)</span><span class="op" id="6721833">.</span><span class="op" id="6721834">(</span><span class="op" id="6721835">*</span><span class="ident" id="6721836">TCPAddr</span><span class="op" id="6721843">)</span><span class="op" id="6721844">;</span>&nbsp;<span class="op" id="6721846">!</span><span class="ident" id="6721847">ok</span>&nbsp;<span class="op" id="6721850">||</span>&nbsp;<span class="op" id="6721853">!</span><span class="ident" id="6721854">tt</span><span class="op" id="6721856">.</span><span class="ident" id="6721857">nameLookup</span>&nbsp;<span class="op" id="6721868">&amp;&amp;</span>&nbsp;<span class="ident" id="6721871">la</span><span class="op" id="6721873">.</span><span class="ident" id="6721874">Zone</span>&nbsp;<span class="op" id="6721879">==</span>&nbsp;<span class="string" id="6721882">&#34;&#34;</span>&nbsp;<span class="op" id="6721885">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6721890">t</span><span class="op" id="6721891">.</span><span class="ident" id="6721892">Fatalf</span><span class="op" id="6721898">(</span><span class="string" id="6721899">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;zone&nbsp;identifier&#34;</span><span class="op" id="6721955">,</span>&nbsp;<span class="ident" id="6721957">la</span><span class="op" id="6721959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6721963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6721967">if</span>&nbsp;<span class="ident" id="6721970">ra</span><span class="op" id="6721972">,</span>&nbsp;<span class="ident" id="6721974">ok</span>&nbsp;<span class="op" id="6721977">:=</span>&nbsp;<span class="ident" id="6721980">c</span><span class="op" id="6721981">.</span><span class="ident" id="6721982">RemoteAddr</span><span class="op" id="6721992">(</span><span class="op" id="6721993">)</span><span class="op" id="6721994">.</span><span class="op" id="6721995">(</span><span class="op" id="6721996">*</span><span class="ident" id="6721997">TCPAddr</span><span class="op" id="6722004">)</span><span class="op" id="6722005">;</span>&nbsp;<span class="op" id="6722007">!</span><span class="ident" id="6722008">ok</span>&nbsp;<span class="op" id="6722011">||</span>&nbsp;<span class="op" id="6722014">!</span><span class="ident" id="6722015">tt</span><span class="op" id="6722017">.</span><span class="ident" id="6722018">nameLookup</span>&nbsp;<span class="op" id="6722029">&amp;&amp;</span>&nbsp;<span class="ident" id="6722032">ra</span><span class="op" id="6722034">.</span><span class="ident" id="6722035">Zone</span>&nbsp;<span class="op" id="6722040">==</span>&nbsp;<span class="string" id="6722043">&#34;&#34;</span>&nbsp;<span class="op" id="6722046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6722051">t</span><span class="op" id="6722052">.</span><span class="ident" id="6722053">Fatalf</span><span class="op" id="6722059">(</span><span class="string" id="6722060">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;zone&nbsp;identifier&#34;</span><span class="op" id="6722116">,</span>&nbsp;<span class="ident" id="6722118">ra</span><span class="op" id="6722120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6722124">}</span><br>
<span class="lineno">440</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6722129">if</span>&nbsp;<span class="ident" id="6722132">_</span><span class="op" id="6722133">,</span>&nbsp;<span class="ident" id="6722135">err</span>&nbsp;<span class="op" id="6722139">:=</span>&nbsp;<span class="ident" id="6722142">c</span><span class="op" id="6722143">.</span><span class="ident" id="6722144">Write</span><span class="op" id="6722149">(</span><span class="op" id="6722150">[</span><span class="op" id="6722151">]</span><span class="builtintype" id="6722152">byte</span><span class="op" id="6722156">(</span><span class="string" id="6722157">&#34;TCP&nbsp;OVER&nbsp;IPV6&nbsp;LINKLOCAL&nbsp;TEST&#34;</span><span class="op" id="6722187">)</span><span class="op" id="6722188">)</span><span class="op" id="6722189">;</span>&nbsp;<span class="ident" id="6722191">err</span>&nbsp;<span class="op" id="6722195">!=</span>&nbsp;<span class="ident" id="6722198">nil</span>&nbsp;<span class="op" id="6722202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6722207">t</span><span class="op" id="6722208">.</span><span class="ident" id="6722209">Fatalf</span><span class="op" id="6722215">(</span><span class="string" id="6722216">&#34;Conn.Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6722239">,</span>&nbsp;<span class="ident" id="6722241">err</span><span class="op" id="6722244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6722248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6722252">b</span>&nbsp;<span class="op" id="6722254">:=</span>&nbsp;<span class="builtinfunc" id="6722257">make</span><span class="op" id="6722261">(</span><span class="op" id="6722262">[</span><span class="op" id="6722263">]</span><span class="builtintype" id="6722264">byte</span><span class="op" id="6722268">,</span>&nbsp;<span class="num" id="6722270">32</span><span class="op" id="6722272">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6722276">if</span>&nbsp;<span class="ident" id="6722279">_</span><span class="op" id="6722280">,</span>&nbsp;<span class="ident" id="6722282">err</span>&nbsp;<span class="op" id="6722286">:=</span>&nbsp;<span class="ident" id="6722289">c</span><span class="op" id="6722290">.</span><span class="ident" id="6722291">Read</span><span class="op" id="6722295">(</span><span class="ident" id="6722296">b</span><span class="op" id="6722297">)</span><span class="op" id="6722298">;</span>&nbsp;<span class="ident" id="6722300">err</span>&nbsp;<span class="op" id="6722304">!=</span>&nbsp;<span class="ident" id="6722307">nil</span>&nbsp;<span class="op" id="6722311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6722316">t</span><span class="op" id="6722317">.</span><span class="ident" id="6722318">Fatalf</span><span class="op" id="6722324">(</span><span class="string" id="6722325">&#34;Conn.Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6722347">,</span>&nbsp;<span class="ident" id="6722349">err</span><span class="op" id="6722352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6722356">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6722361">&lt;-</span><span class="ident" id="6722363">done</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6722369">}</span><br>
<span class="lineno"></span><span class="op" id="6722371">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6722374">func</span>&nbsp;<span class="ident" id="6722379">TestTCPConcurrentAccept</span><span class="op" id="6722402">(</span><span class="ident" id="6722403">t</span>&nbsp;<span class="op" id="6722405">*</span><span class="ident" id="6722406">testing</span><span class="op" id="6722413">.</span><span class="ident" id="6722414">T</span><span class="op" id="6722415">)</span>&nbsp;<span class="op" id="6722417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6722420">defer</span>&nbsp;<span class="ident" id="6722426">runtime</span><span class="op" id="6722433">.</span><span class="ident" id="6722434">GOMAXPROCS</span><span class="op" id="6722444">(</span><span class="ident" id="6722445">runtime</span><span class="op" id="6722452">.</span><span class="ident" id="6722453">GOMAXPROCS</span><span class="op" id="6722463">(</span><span class="num" id="6722464">4</span><span class="op" id="6722465">)</span><span class="op" id="6722466">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6722469">ln</span><span class="op" id="6722471">,</span>&nbsp;<span class="ident" id="6722473">err</span>&nbsp;<span class="op" id="6722477">:=</span>&nbsp;<span class="ident" id="6722480">Listen</span><span class="op" id="6722486">(</span><span class="string" id="6722487">&#34;tcp&#34;</span><span class="op" id="6722492">,</span>&nbsp;<span class="string" id="6722494">&#34;127.0.0.1:0&#34;</span><span class="op" id="6722507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6722510">if</span>&nbsp;<span class="ident" id="6722513">err</span>&nbsp;<span class="op" id="6722517">!=</span>&nbsp;<span class="ident" id="6722520">nil</span>&nbsp;<span class="op" id="6722524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6722528">t</span><span class="op" id="6722529">.</span><span class="ident" id="6722530">Fatalf</span><span class="op" id="6722536">(</span><span class="string" id="6722537">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6722556">,</span>&nbsp;<span class="ident" id="6722558">err</span><span class="op" id="6722561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6722564">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6722567">const</span>&nbsp;<span class="ident" id="6722573">N</span>&nbsp;<span class="op" id="6722575">=</span>&nbsp;<span class="num" id="6722577">10</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6722581">var</span>&nbsp;<span class="ident" id="6722585">wg</span>&nbsp;<span class="ident" id="6722588">sync</span><span class="op" id="6722592">.</span><span class="ident" id="6722593">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6722604">wg</span><span class="op" id="6722606">.</span><span class="ident" id="6722607">Add</span><span class="op" id="6722610">(</span><span class="ident" id="6722611">N</span><span class="op" id="6722612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6722615">for</span>&nbsp;<span class="ident" id="6722619">i</span>&nbsp;<span class="op" id="6722621">:=</span>&nbsp;<span class="num" id="6722624">0</span><span class="op" id="6722625">;</span>&nbsp;<span class="ident" id="6722627">i</span>&nbsp;<span class="op" id="6722629">&lt;</span>&nbsp;<span class="ident" id="6722631">N</span><span class="op" id="6722632">;</span>&nbsp;<span class="ident" id="6722634">i</span><span class="op" id="6722635">++</span>&nbsp;<span class="op" id="6722638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6722642">go</span>&nbsp;<span class="keyword" id="6722645">func</span><span class="op" id="6722649">(</span><span class="op" id="6722650">)</span>&nbsp;<span class="op" id="6722652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6722657">for</span>&nbsp;<span class="op" id="6722661">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6722667">c</span><span class="op" id="6722668">,</span>&nbsp;<span class="ident" id="6722670">err</span>&nbsp;<span class="op" id="6722674">:=</span>&nbsp;<span class="ident" id="6722677">ln</span><span class="op" id="6722679">.</span><span class="ident" id="6722680">Accept</span><span class="op" id="6722686">(</span><span class="op" id="6722687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6722693">if</span>&nbsp;<span class="ident" id="6722696">err</span>&nbsp;<span class="op" id="6722700">!=</span>&nbsp;<span class="ident" id="6722703">nil</span>&nbsp;<span class="op" id="6722707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6722714">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6722724">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6722730">c</span><span class="op" id="6722731">.</span><span class="ident" id="6722732">Close</span><span class="op" id="6722737">(</span><span class="op" id="6722738">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6722743">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6722748">wg</span><span class="op" id="6722750">.</span><span class="ident" id="6722751">Done</span><span class="op" id="6722755">(</span><span class="op" id="6722756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6722760">}</span><span class="op" id="6722761">(</span><span class="op" id="6722762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6722765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6722768">attempts</span>&nbsp;<span class="op" id="6722777">:=</span>&nbsp;<span class="num" id="6722780">10</span>&nbsp;<span class="op" id="6722783">*</span>&nbsp;<span class="ident" id="6722785">N</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6722788">fails</span>&nbsp;<span class="op" id="6722794">:=</span>&nbsp;<span class="num" id="6722797">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6722800">d</span>&nbsp;<span class="op" id="6722802">:=</span>&nbsp;<span class="op" id="6722805">&amp;</span><span class="ident" id="6722806">Dialer</span><span class="op" id="6722812">{</span><span class="ident" id="6722813">Timeout</span><span class="op" id="6722820">:</span>&nbsp;<span class="num" id="6722822">200</span>&nbsp;<span class="op" id="6722826">*</span>&nbsp;<span class="ident" id="6722828">time</span><span class="op" id="6722832">.</span><span class="ident" id="6722833">Millisecond</span><span class="op" id="6722844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6722847">for</span>&nbsp;<span class="ident" id="6722851">i</span>&nbsp;<span class="op" id="6722853">:=</span>&nbsp;<span class="num" id="6722856">0</span><span class="op" id="6722857">;</span>&nbsp;<span class="ident" id="6722859">i</span>&nbsp;<span class="op" id="6722861">&lt;</span>&nbsp;<span class="ident" id="6722863">attempts</span><span class="op" id="6722871">;</span>&nbsp;<span class="ident" id="6722873">i</span><span class="op" id="6722874">++</span>&nbsp;<span class="op" id="6722877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6722881">c</span><span class="op" id="6722882">,</span>&nbsp;<span class="ident" id="6722884">err</span>&nbsp;<span class="op" id="6722888">:=</span>&nbsp;<span class="ident" id="6722891">d</span><span class="op" id="6722892">.</span><span class="ident" id="6722893">Dial</span><span class="op" id="6722897">(</span><span class="string" id="6722898">&#34;tcp&#34;</span><span class="op" id="6722903">,</span>&nbsp;<span class="ident" id="6722905">ln</span><span class="op" id="6722907">.</span><span class="ident" id="6722908">Addr</span><span class="op" id="6722912">(</span><span class="op" id="6722913">)</span><span class="op" id="6722914">.</span><span class="ident" id="6722915">String</span><span class="op" id="6722921">(</span><span class="op" id="6722922">)</span><span class="op" id="6722923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6722927">if</span>&nbsp;<span class="ident" id="6722930">err</span>&nbsp;<span class="op" id="6722934">!=</span>&nbsp;<span class="ident" id="6722937">nil</span>&nbsp;<span class="op" id="6722941">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6722946">fails</span><span class="op" id="6722951">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6722956">}</span>&nbsp;<span class="keyword" id="6722958">else</span>&nbsp;<span class="op" id="6722963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6722968">c</span><span class="op" id="6722969">.</span><span class="ident" id="6722970">Close</span><span class="op" id="6722975">(</span><span class="op" id="6722976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6722980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6722983">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6722986">ln</span><span class="op" id="6722988">.</span><span class="ident" id="6722989">Close</span><span class="op" id="6722994">(</span><span class="op" id="6722995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6722998">wg</span><span class="op" id="6723000">.</span><span class="ident" id="6723001">Wait</span><span class="op" id="6723005">(</span><span class="op" id="6723006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6723009">if</span>&nbsp;<span class="ident" id="6723012">fails</span>&nbsp;<span class="op" id="6723018">&gt;</span>&nbsp;<span class="ident" id="6723020">attempts</span><span class="op" id="6723028">/</span><span class="num" id="6723029">9</span>&nbsp;<span class="op" id="6723031">{</span>&nbsp;<span class="comment" id="6723033">//&nbsp;see&nbsp;issues&nbsp;7400&nbsp;and&nbsp;7541</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6723063">t</span><span class="op" id="6723064">.</span><span class="ident" id="6723065">Fatalf</span><span class="op" id="6723071">(</span><span class="string" id="6723072">&#34;too&nbsp;many&nbsp;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6723098">,</span>&nbsp;<span class="ident" id="6723100">fails</span><span class="op" id="6723105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6723108">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6723111">if</span>&nbsp;<span class="ident" id="6723114">fails</span>&nbsp;<span class="op" id="6723120">&gt;</span>&nbsp;<span class="num" id="6723122">0</span>&nbsp;<span class="op" id="6723124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6723128">t</span><span class="op" id="6723129">.</span><span class="ident" id="6723130">Logf</span><span class="op" id="6723134">(</span><span class="string" id="6723135">&#34;#&nbsp;of&nbsp;failed&nbsp;Dials:&nbsp;%v&#34;</span><span class="op" id="6723158">,</span>&nbsp;<span class="ident" id="6723160">fails</span><span class="op" id="6723165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6723168">}</span><br>
<span class="lineno"></span><span class="op" id="6723170">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="keyword" id="6723173">func</span>&nbsp;<span class="ident" id="6723178">TestTCPReadWriteMallocs</span><span class="op" id="6723201">(</span><span class="ident" id="6723202">t</span>&nbsp;<span class="op" id="6723204">*</span><span class="ident" id="6723205">testing</span><span class="op" id="6723212">.</span><span class="ident" id="6723213">T</span><span class="op" id="6723214">)</span>&nbsp;<span class="op" id="6723216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6723219">if</span>&nbsp;<span class="ident" id="6723222">testing</span><span class="op" id="6723229">.</span><span class="ident" id="6723230">Short</span><span class="op" id="6723235">(</span><span class="op" id="6723236">)</span>&nbsp;<span class="op" id="6723238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6723242">t</span><span class="op" id="6723243">.</span><span class="ident" id="6723244">Skip</span><span class="op" id="6723248">(</span><span class="string" id="6723249">&#34;skipping&nbsp;malloc&nbsp;count&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="6723286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6723289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6723292">ln</span><span class="op" id="6723294">,</span>&nbsp;<span class="ident" id="6723296">err</span>&nbsp;<span class="op" id="6723300">:=</span>&nbsp;<span class="ident" id="6723303">Listen</span><span class="op" id="6723309">(</span><span class="string" id="6723310">&#34;tcp&#34;</span><span class="op" id="6723315">,</span>&nbsp;<span class="string" id="6723317">&#34;127.0.0.1:0&#34;</span><span class="op" id="6723330">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6723333">if</span>&nbsp;<span class="ident" id="6723336">err</span>&nbsp;<span class="op" id="6723340">!=</span>&nbsp;<span class="ident" id="6723343">nil</span>&nbsp;<span class="op" id="6723347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6723351">t</span><span class="op" id="6723352">.</span><span class="ident" id="6723353">Fatalf</span><span class="op" id="6723359">(</span><span class="string" id="6723360">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6723379">,</span>&nbsp;<span class="ident" id="6723381">err</span><span class="op" id="6723384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6723387">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6723390">defer</span>&nbsp;<span class="ident" id="6723396">ln</span><span class="op" id="6723398">.</span><span class="ident" id="6723399">Close</span><span class="op" id="6723404">(</span><span class="op" id="6723405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6723408">var</span>&nbsp;<span class="ident" id="6723412">server</span>&nbsp;<span class="ident" id="6723419">Conn</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6723425">errc</span>&nbsp;<span class="op" id="6723430">:=</span>&nbsp;<span class="builtinfunc" id="6723433">make</span><span class="op" id="6723437">(</span><span class="keyword" id="6723438">chan</span>&nbsp;<span class="builtintype" id="6723443">error</span><span class="op" id="6723448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6723451">go</span>&nbsp;<span class="keyword" id="6723454">func</span><span class="op" id="6723458">(</span><span class="op" id="6723459">)</span>&nbsp;<span class="op" id="6723461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6723465">var</span>&nbsp;<span class="ident" id="6723469">err</span>&nbsp;<span class="builtintype" id="6723473">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6723481">server</span><span class="op" id="6723487">,</span>&nbsp;<span class="ident" id="6723489">err</span>&nbsp;<span class="op" id="6723493">=</span>&nbsp;<span class="ident" id="6723495">ln</span><span class="op" id="6723497">.</span><span class="ident" id="6723498">Accept</span><span class="op" id="6723504">(</span><span class="op" id="6723505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6723509">errc</span>&nbsp;<span class="op" id="6723514">&lt;-</span>&nbsp;<span class="ident" id="6723517">err</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6723522">}</span><span class="op" id="6723523">(</span><span class="op" id="6723524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6723527">client</span><span class="op" id="6723533">,</span>&nbsp;<span class="ident" id="6723535">err</span>&nbsp;<span class="op" id="6723539">:=</span>&nbsp;<span class="ident" id="6723542">Dial</span><span class="op" id="6723546">(</span><span class="string" id="6723547">&#34;tcp&#34;</span><span class="op" id="6723552">,</span>&nbsp;<span class="ident" id="6723554">ln</span><span class="op" id="6723556">.</span><span class="ident" id="6723557">Addr</span><span class="op" id="6723561">(</span><span class="op" id="6723562">)</span><span class="op" id="6723563">.</span><span class="ident" id="6723564">String</span><span class="op" id="6723570">(</span><span class="op" id="6723571">)</span><span class="op" id="6723572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6723575">if</span>&nbsp;<span class="ident" id="6723578">err</span>&nbsp;<span class="op" id="6723582">!=</span>&nbsp;<span class="ident" id="6723585">nil</span>&nbsp;<span class="op" id="6723589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6723593">t</span><span class="op" id="6723594">.</span><span class="ident" id="6723595">Fatalf</span><span class="op" id="6723601">(</span><span class="string" id="6723602">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6723619">,</span>&nbsp;<span class="ident" id="6723621">err</span><span class="op" id="6723624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6723627">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6723630">if</span>&nbsp;<span class="ident" id="6723633">err</span>&nbsp;<span class="op" id="6723637">:=</span>&nbsp;<span class="op" id="6723640">&lt;-</span><span class="ident" id="6723642">errc</span><span class="op" id="6723646">;</span>&nbsp;<span class="ident" id="6723648">err</span>&nbsp;<span class="op" id="6723652">!=</span>&nbsp;<span class="ident" id="6723655">nil</span>&nbsp;<span class="op" id="6723659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6723663">t</span><span class="op" id="6723664">.</span><span class="ident" id="6723665">Fatalf</span><span class="op" id="6723671">(</span><span class="string" id="6723672">&#34;Accept&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6723691">,</span>&nbsp;<span class="ident" id="6723693">err</span><span class="op" id="6723696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6723699">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6723702">defer</span>&nbsp;<span class="ident" id="6723708">server</span><span class="op" id="6723714">.</span><span class="ident" id="6723715">Close</span><span class="op" id="6723720">(</span><span class="op" id="6723721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6723724">var</span>&nbsp;<span class="ident" id="6723728">buf</span>&nbsp;<span class="op" id="6723732">[</span><span class="num" id="6723733">128</span><span class="op" id="6723736">]</span><span class="builtintype" id="6723737">byte</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6723743">mallocs</span>&nbsp;<span class="op" id="6723751">:=</span>&nbsp;<span class="ident" id="6723754">testing</span><span class="op" id="6723761">.</span><span class="ident" id="6723762">AllocsPerRun</span><span class="op" id="6723774">(</span><span class="num" id="6723775">1000</span><span class="op" id="6723779">,</span>&nbsp;<span class="keyword" id="6723781">func</span><span class="op" id="6723785">(</span><span class="op" id="6723786">)</span>&nbsp;<span class="op" id="6723788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6723792">_</span><span class="op" id="6723793">,</span>&nbsp;<span class="ident" id="6723795">err</span>&nbsp;<span class="op" id="6723799">:=</span>&nbsp;<span class="ident" id="6723802">server</span><span class="op" id="6723808">.</span><span class="ident" id="6723809">Write</span><span class="op" id="6723814">(</span><span class="ident" id="6723815">buf</span><span class="op" id="6723818">[</span><span class="op" id="6723819">:</span><span class="op" id="6723820">]</span><span class="op" id="6723821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6723825">if</span>&nbsp;<span class="ident" id="6723828">err</span>&nbsp;<span class="op" id="6723832">!=</span>&nbsp;<span class="ident" id="6723835">nil</span>&nbsp;<span class="op" id="6723839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6723844">t</span><span class="op" id="6723845">.</span><span class="ident" id="6723846">Fatalf</span><span class="op" id="6723852">(</span><span class="string" id="6723853">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6723871">,</span>&nbsp;<span class="ident" id="6723873">err</span><span class="op" id="6723876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6723880">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6723884">_</span><span class="op" id="6723885">,</span>&nbsp;<span class="ident" id="6723887">err</span>&nbsp;<span class="op" id="6723891">=</span>&nbsp;<span class="ident" id="6723893">io</span><span class="op" id="6723895">.</span><span class="ident" id="6723896">ReadFull</span><span class="op" id="6723904">(</span><span class="ident" id="6723905">client</span><span class="op" id="6723911">,</span>&nbsp;<span class="ident" id="6723913">buf</span><span class="op" id="6723916">[</span><span class="op" id="6723917">:</span><span class="op" id="6723918">]</span><span class="op" id="6723919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6723923">if</span>&nbsp;<span class="ident" id="6723926">err</span>&nbsp;<span class="op" id="6723930">!=</span>&nbsp;<span class="ident" id="6723933">nil</span>&nbsp;<span class="op" id="6723937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6723942">t</span><span class="op" id="6723943">.</span><span class="ident" id="6723944">Fatalf</span><span class="op" id="6723950">(</span><span class="string" id="6723951">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6723968">,</span>&nbsp;<span class="ident" id="6723970">err</span><span class="op" id="6723973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6723977">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6723980">}</span><span class="op" id="6723981">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6723984">if</span>&nbsp;<span class="ident" id="6723987">mallocs</span>&nbsp;<span class="op" id="6723995">&gt;</span>&nbsp;<span class="num" id="6723997">0</span>&nbsp;<span class="op" id="6723999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6724003">t</span><span class="op" id="6724004">.</span><span class="ident" id="6724005">Fatalf</span><span class="op" id="6724011">(</span><span class="string" id="6724012">&#34;Got&nbsp;%v&nbsp;allocs,&nbsp;want&nbsp;0&#34;</span><span class="op" id="6724035">,</span>&nbsp;<span class="ident" id="6724037">mallocs</span><span class="op" id="6724044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6724047">}</span><br>
<span class="lineno"></span><span class="op" id="6724049">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="6724052">func</span>&nbsp;<span class="ident" id="6724057">TestTCPStress</span><span class="op" id="6724070">(</span><span class="ident" id="6724071">t</span>&nbsp;<span class="op" id="6724073">*</span><span class="ident" id="6724074">testing</span><span class="op" id="6724081">.</span><span class="ident" id="6724082">T</span><span class="op" id="6724083">)</span>&nbsp;<span class="op" id="6724085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6724088">const</span>&nbsp;<span class="ident" id="6724094">conns</span>&nbsp;<span class="op" id="6724100">=</span>&nbsp;<span class="num" id="6724102">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6724105">const</span>&nbsp;<span class="ident" id="6724111">msgLen</span>&nbsp;<span class="op" id="6724118">=</span>&nbsp;<span class="num" id="6724120">512</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6724125">msgs</span>&nbsp;<span class="op" id="6724130">:=</span>&nbsp;<span class="builtintype" id="6724133">int</span><span class="op" id="6724136">(</span><span class="num" id="6724137">1e4</span><span class="op" id="6724140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6724143">if</span>&nbsp;<span class="ident" id="6724146">testing</span><span class="op" id="6724153">.</span><span class="ident" id="6724154">Short</span><span class="op" id="6724159">(</span><span class="op" id="6724160">)</span>&nbsp;<span class="op" id="6724162">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6724166">msgs</span>&nbsp;<span class="op" id="6724171">=</span>&nbsp;<span class="num" id="6724173">1e2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6724178">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6724182">sendMsg</span>&nbsp;<span class="op" id="6724190">:=</span>&nbsp;<span class="keyword" id="6724193">func</span><span class="op" id="6724197">(</span><span class="ident" id="6724198">c</span>&nbsp;<span class="ident" id="6724200">Conn</span><span class="op" id="6724204">,</span>&nbsp;<span class="ident" id="6724206">buf</span>&nbsp;<span class="op" id="6724210">[</span><span class="op" id="6724211">]</span><span class="builtintype" id="6724212">byte</span><span class="op" id="6724216">)</span>&nbsp;<span class="builtintype" id="6724218">bool</span>&nbsp;<span class="op" id="6724223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6724227">n</span><span class="op" id="6724228">,</span>&nbsp;<span class="ident" id="6724230">err</span>&nbsp;<span class="op" id="6724234">:=</span>&nbsp;<span class="ident" id="6724237">c</span><span class="op" id="6724238">.</span><span class="ident" id="6724239">Write</span><span class="op" id="6724244">(</span><span class="ident" id="6724245">buf</span><span class="op" id="6724248">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6724252">if</span>&nbsp;<span class="ident" id="6724255">n</span>&nbsp;<span class="op" id="6724257">!=</span>&nbsp;<span class="builtinfunc" id="6724260">len</span><span class="op" id="6724263">(</span><span class="ident" id="6724264">buf</span><span class="op" id="6724267">)</span>&nbsp;<span class="op" id="6724269">||</span>&nbsp;<span class="ident" id="6724272">err</span>&nbsp;<span class="op" id="6724276">!=</span>&nbsp;<span class="ident" id="6724279">nil</span>&nbsp;<span class="op" id="6724283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6724288">t</span><span class="op" id="6724289">.</span><span class="ident" id="6724290">Logf</span><span class="op" id="6724294">(</span><span class="string" id="6724295">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6724313">,</span>&nbsp;<span class="ident" id="6724315">err</span><span class="op" id="6724318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6724323">return</span>&nbsp;<span class="builtintype" id="6724330">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6724338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6724342">return</span>&nbsp;<span class="builtintype" id="6724349">true</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6724355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6724358">recvMsg</span>&nbsp;<span class="op" id="6724366">:=</span>&nbsp;<span class="keyword" id="6724369">func</span><span class="op" id="6724373">(</span><span class="ident" id="6724374">c</span>&nbsp;<span class="ident" id="6724376">Conn</span><span class="op" id="6724380">,</span>&nbsp;<span class="ident" id="6724382">buf</span>&nbsp;<span class="op" id="6724386">[</span><span class="op" id="6724387">]</span><span class="builtintype" id="6724388">byte</span><span class="op" id="6724392">)</span>&nbsp;<span class="builtintype" id="6724394">bool</span>&nbsp;<span class="op" id="6724399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6724403">for</span>&nbsp;<span class="ident" id="6724407">read</span>&nbsp;<span class="op" id="6724412">:=</span>&nbsp;<span class="num" id="6724415">0</span><span class="op" id="6724416">;</span>&nbsp;<span class="ident" id="6724418">read</span>&nbsp;<span class="op" id="6724423">!=</span>&nbsp;<span class="builtinfunc" id="6724426">len</span><span class="op" id="6724429">(</span><span class="ident" id="6724430">buf</span><span class="op" id="6724433">)</span><span class="op" id="6724434">;</span>&nbsp;<span class="op" id="6724436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6724441">n</span><span class="op" id="6724442">,</span>&nbsp;<span class="ident" id="6724444">err</span>&nbsp;<span class="op" id="6724448">:=</span>&nbsp;<span class="ident" id="6724451">c</span><span class="op" id="6724452">.</span><span class="ident" id="6724453">Read</span><span class="op" id="6724457">(</span><span class="ident" id="6724458">buf</span><span class="op" id="6724461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6724466">read</span>&nbsp;<span class="op" id="6724471">+=</span>&nbsp;<span class="ident" id="6724474">n</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6724479">if</span>&nbsp;<span class="ident" id="6724482">err</span>&nbsp;<span class="op" id="6724486">!=</span>&nbsp;<span class="ident" id="6724489">nil</span>&nbsp;<span class="op" id="6724493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6724499">t</span><span class="op" id="6724500">.</span><span class="ident" id="6724501">Logf</span><span class="op" id="6724505">(</span><span class="string" id="6724506">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6724523">,</span>&nbsp;<span class="ident" id="6724525">err</span><span class="op" id="6724528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6724534">return</span>&nbsp;<span class="builtintype" id="6724541">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6724550">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6724554">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6724558">return</span>&nbsp;<span class="builtintype" id="6724565">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6724571">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6724575">ln</span><span class="op" id="6724577">,</span>&nbsp;<span class="ident" id="6724579">err</span>&nbsp;<span class="op" id="6724583">:=</span>&nbsp;<span class="ident" id="6724586">Listen</span><span class="op" id="6724592">(</span><span class="string" id="6724593">&#34;tcp&#34;</span><span class="op" id="6724598">,</span>&nbsp;<span class="string" id="6724600">&#34;127.0.0.1:0&#34;</span><span class="op" id="6724613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6724616">if</span>&nbsp;<span class="ident" id="6724619">err</span>&nbsp;<span class="op" id="6724623">!=</span>&nbsp;<span class="ident" id="6724626">nil</span>&nbsp;<span class="op" id="6724630">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6724634">t</span><span class="op" id="6724635">.</span><span class="ident" id="6724636">Fatalf</span><span class="op" id="6724642">(</span><span class="string" id="6724643">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6724662">,</span>&nbsp;<span class="ident" id="6724664">err</span><span class="op" id="6724667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6724670">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6724673">defer</span>&nbsp;<span class="ident" id="6724679">ln</span><span class="op" id="6724681">.</span><span class="ident" id="6724682">Close</span><span class="op" id="6724687">(</span><span class="op" id="6724688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6724691">//&nbsp;Acceptor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6724705">go</span>&nbsp;<span class="keyword" id="6724708">func</span><span class="op" id="6724712">(</span><span class="op" id="6724713">)</span>&nbsp;<span class="op" id="6724715">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6724719">for</span>&nbsp;<span class="op" id="6724723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6724728">c</span><span class="op" id="6724729">,</span>&nbsp;<span class="ident" id="6724731">err</span>&nbsp;<span class="op" id="6724735">:=</span>&nbsp;<span class="ident" id="6724738">ln</span><span class="op" id="6724740">.</span><span class="ident" id="6724741">Accept</span><span class="op" id="6724747">(</span><span class="op" id="6724748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6724753">if</span>&nbsp;<span class="ident" id="6724756">err</span>&nbsp;<span class="op" id="6724760">!=</span>&nbsp;<span class="ident" id="6724763">nil</span>&nbsp;<span class="op" id="6724767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6724773">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6724782">}</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6724787">//&nbsp;Server&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6724812">go</span>&nbsp;<span class="keyword" id="6724815">func</span><span class="op" id="6724819">(</span><span class="ident" id="6724820">c</span>&nbsp;<span class="ident" id="6724822">Conn</span><span class="op" id="6724826">)</span>&nbsp;<span class="op" id="6724828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6724834">defer</span>&nbsp;<span class="ident" id="6724840">c</span><span class="op" id="6724841">.</span><span class="ident" id="6724842">Close</span><span class="op" id="6724847">(</span><span class="op" id="6724848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6724854">var</span>&nbsp;<span class="ident" id="6724858">buf</span>&nbsp;<span class="op" id="6724862">[</span><span class="ident" id="6724863">msgLen</span><span class="op" id="6724869">]</span><span class="builtintype" id="6724870">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6724879">for</span>&nbsp;<span class="ident" id="6724883">m</span>&nbsp;<span class="op" id="6724885">:=</span>&nbsp;<span class="num" id="6724888">0</span><span class="op" id="6724889">;</span>&nbsp;<span class="ident" id="6724891">m</span>&nbsp;<span class="op" id="6724893">&lt;</span>&nbsp;<span class="ident" id="6724895">msgs</span><span class="op" id="6724899">;</span>&nbsp;<span class="ident" id="6724901">m</span><span class="op" id="6724902">++</span>&nbsp;<span class="op" id="6724905">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6724912">if</span>&nbsp;<span class="op" id="6724915">!</span><span class="ident" id="6724916">recvMsg</span><span class="op" id="6724923">(</span><span class="ident" id="6724924">c</span><span class="op" id="6724925">,</span>&nbsp;<span class="ident" id="6724927">buf</span><span class="op" id="6724930">[</span><span class="op" id="6724931">:</span><span class="op" id="6724932">]</span><span class="op" id="6724933">)</span>&nbsp;<span class="op" id="6724935">||</span>&nbsp;<span class="op" id="6724938">!</span><span class="ident" id="6724939">sendMsg</span><span class="op" id="6724946">(</span><span class="ident" id="6724947">c</span><span class="op" id="6724948">,</span>&nbsp;<span class="ident" id="6724950">buf</span><span class="op" id="6724953">[</span><span class="op" id="6724954">:</span><span class="op" id="6724955">]</span><span class="op" id="6724956">)</span>&nbsp;<span class="op" id="6724958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6724966">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6724977">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6724983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6724988">}</span><span class="op" id="6724989">(</span><span class="ident" id="6724990">c</span><span class="op" id="6724991">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6724995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6724998">}</span><span class="op" id="6724999">(</span><span class="op" id="6725000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6725003">done</span>&nbsp;<span class="op" id="6725008">:=</span>&nbsp;<span class="builtinfunc" id="6725011">make</span><span class="op" id="6725015">(</span><span class="keyword" id="6725016">chan</span>&nbsp;<span class="builtintype" id="6725021">bool</span><span class="op" id="6725025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6725028">for</span>&nbsp;<span class="ident" id="6725032">i</span>&nbsp;<span class="op" id="6725034">:=</span>&nbsp;<span class="num" id="6725037">0</span><span class="op" id="6725038">;</span>&nbsp;<span class="ident" id="6725040">i</span>&nbsp;<span class="op" id="6725042">&lt;</span>&nbsp;<span class="ident" id="6725044">conns</span><span class="op" id="6725049">;</span>&nbsp;<span class="ident" id="6725051">i</span><span class="op" id="6725052">++</span>&nbsp;<span class="op" id="6725055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6725059">//&nbsp;Client&nbsp;connection.</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6725083">go</span>&nbsp;<span class="keyword" id="6725086">func</span><span class="op" id="6725090">(</span><span class="op" id="6725091">)</span>&nbsp;<span class="op" id="6725093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6725098">defer</span>&nbsp;<span class="keyword" id="6725104">func</span><span class="op" id="6725108">(</span><span class="op" id="6725109">)</span>&nbsp;<span class="op" id="6725111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6725117">done</span>&nbsp;<span class="op" id="6725122">&lt;-</span>&nbsp;<span class="builtintype" id="6725125">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6725133">}</span><span class="op" id="6725134">(</span><span class="op" id="6725135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6725140">c</span><span class="op" id="6725141">,</span>&nbsp;<span class="ident" id="6725143">err</span>&nbsp;<span class="op" id="6725147">:=</span>&nbsp;<span class="ident" id="6725150">Dial</span><span class="op" id="6725154">(</span><span class="string" id="6725155">&#34;tcp&#34;</span><span class="op" id="6725160">,</span>&nbsp;<span class="ident" id="6725162">ln</span><span class="op" id="6725164">.</span><span class="ident" id="6725165">Addr</span><span class="op" id="6725169">(</span><span class="op" id="6725170">)</span><span class="op" id="6725171">.</span><span class="ident" id="6725172">String</span><span class="op" id="6725178">(</span><span class="op" id="6725179">)</span><span class="op" id="6725180">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6725185">if</span>&nbsp;<span class="ident" id="6725188">err</span>&nbsp;<span class="op" id="6725192">!=</span>&nbsp;<span class="ident" id="6725195">nil</span>&nbsp;<span class="op" id="6725199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6725205">t</span><span class="op" id="6725206">.</span><span class="ident" id="6725207">Logf</span><span class="op" id="6725211">(</span><span class="string" id="6725212">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6725229">,</span>&nbsp;<span class="ident" id="6725231">err</span><span class="op" id="6725234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6725240">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6725250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6725255">defer</span>&nbsp;<span class="ident" id="6725261">c</span><span class="op" id="6725262">.</span><span class="ident" id="6725263">Close</span><span class="op" id="6725268">(</span><span class="op" id="6725269">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6725274">var</span>&nbsp;<span class="ident" id="6725278">buf</span>&nbsp;<span class="op" id="6725282">[</span><span class="ident" id="6725283">msgLen</span><span class="op" id="6725289">]</span><span class="builtintype" id="6725290">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6725298">for</span>&nbsp;<span class="ident" id="6725302">m</span>&nbsp;<span class="op" id="6725304">:=</span>&nbsp;<span class="num" id="6725307">0</span><span class="op" id="6725308">;</span>&nbsp;<span class="ident" id="6725310">m</span>&nbsp;<span class="op" id="6725312">&lt;</span>&nbsp;<span class="ident" id="6725314">msgs</span><span class="op" id="6725318">;</span>&nbsp;<span class="ident" id="6725320">m</span><span class="op" id="6725321">++</span>&nbsp;<span class="op" id="6725324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6725330">if</span>&nbsp;<span class="op" id="6725333">!</span><span class="ident" id="6725334">sendMsg</span><span class="op" id="6725341">(</span><span class="ident" id="6725342">c</span><span class="op" id="6725343">,</span>&nbsp;<span class="ident" id="6725345">buf</span><span class="op" id="6725348">[</span><span class="op" id="6725349">:</span><span class="op" id="6725350">]</span><span class="op" id="6725351">)</span>&nbsp;<span class="op" id="6725353">||</span>&nbsp;<span class="op" id="6725356">!</span><span class="ident" id="6725357">recvMsg</span><span class="op" id="6725364">(</span><span class="ident" id="6725365">c</span><span class="op" id="6725366">,</span>&nbsp;<span class="ident" id="6725368">buf</span><span class="op" id="6725371">[</span><span class="op" id="6725372">:</span><span class="op" id="6725373">]</span><span class="op" id="6725374">)</span>&nbsp;<span class="op" id="6725376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6725383">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6725393">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6725398">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6725402">}</span><span class="op" id="6725403">(</span><span class="op" id="6725404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6725407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6725410">for</span>&nbsp;<span class="ident" id="6725414">i</span>&nbsp;<span class="op" id="6725416">:=</span>&nbsp;<span class="num" id="6725419">0</span><span class="op" id="6725420">;</span>&nbsp;<span class="ident" id="6725422">i</span>&nbsp;<span class="op" id="6725424">&lt;</span>&nbsp;<span class="ident" id="6725426">conns</span><span class="op" id="6725431">;</span>&nbsp;<span class="ident" id="6725433">i</span><span class="op" id="6725434">++</span>&nbsp;<span class="op" id="6725437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6725441">&lt;-</span><span class="ident" id="6725443">done</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6725449">}</span><br>
<span class="lineno"></span><span class="op" id="6725451">}</span>
</div>
</body>
</html>
