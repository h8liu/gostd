<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>database/sql</h2>
<ul>
<li><a href="/gostd/database/sql/convert.go.html">convert.go</a></li>
<li><a href="/gostd/database/sql/convert_test.go.html">convert_test.go</a></li>
<li><a href="/gostd/database/sql/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/database/sql/fakedb_test.go.html">fakedb_test.go</a></li>
<li><a href="/gostd/database/sql/sql.go.html" class="current">sql.go</a></li>
<li><a href="/gostd/database/sql/sql_test.go.html">sql_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5694746">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5694801">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5694855">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5694906">//&nbsp;Package&nbsp;sql&nbsp;provides&nbsp;a&nbsp;generic&nbsp;interface&nbsp;around&nbsp;SQL&nbsp;(or&nbsp;SQL-like)</span><br>
<span class="lineno"></span><span class="comment" id="5694975">//&nbsp;databases.</span><br>
<span class="lineno"></span><span class="comment" id="5694989">//</span><br>
<span class="lineno"></span><span class="comment" id="5694992">//&nbsp;The&nbsp;sql&nbsp;package&nbsp;must&nbsp;be&nbsp;used&nbsp;in&nbsp;conjunction&nbsp;with&nbsp;a&nbsp;database&nbsp;driver.</span><br>
<span class="lineno"></span><span class="comment" id="5695063">//&nbsp;See&nbsp;http://golang.org/s/sqldrivers&nbsp;for&nbsp;a&nbsp;list&nbsp;of&nbsp;drivers.</span><br>
<span class="lineno">10</span><span class="comment" id="5695124">//</span><br>
<span class="lineno"></span><span class="comment" id="5695127">//&nbsp;For&nbsp;more&nbsp;usage&nbsp;examples,&nbsp;see&nbsp;the&nbsp;wiki&nbsp;page&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="5695176">//&nbsp;http://golang.org/s/sqlwiki.</span><br>
<span class="lineno"></span><span class="keyword" id="5695208">package</span>&nbsp;<span class="ident" id="5695216">sql</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="5695221">import</span>&nbsp;<span class="op" id="5695228">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5695231">&#34;database/sql/driver&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5695254">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5695264">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5695271">&#34;io&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5695277">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5695288">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5695296">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="5695303">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="5695306">var</span>&nbsp;<span class="ident" id="5695310">drivers</span>&nbsp;<span class="op" id="5695318">=</span>&nbsp;<span class="builtinfunc" id="5695320">make</span><span class="op" id="5695324">(</span><span class="keyword" id="5695325">map</span><span class="op" id="5695328">[</span><span class="builtintype" id="5695329">string</span><span class="op" id="5695335">]</span><span class="ident" id="5695336">driver</span><span class="op" id="5695342">.</span><span class="ident" id="5695343">Driver</span><span class="op" id="5695349">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5695352">//&nbsp;Register&nbsp;makes&nbsp;a&nbsp;database&nbsp;driver&nbsp;available&nbsp;by&nbsp;the&nbsp;provided&nbsp;name.</span><br>
<span class="lineno"></span><span class="comment" id="5695420">//&nbsp;If&nbsp;Register&nbsp;is&nbsp;called&nbsp;twice&nbsp;with&nbsp;the&nbsp;same&nbsp;name&nbsp;or&nbsp;if&nbsp;driver&nbsp;is&nbsp;nil,</span><br>
<span class="lineno"></span><span class="comment" id="5695491">//&nbsp;it&nbsp;panics.</span><br>
<span class="lineno">30</span><span class="keyword" id="5695505">func</span>&nbsp;<span class="ident" id="5695510">Register</span><span class="op" id="5695518">(</span><span class="ident" id="5695519">name</span>&nbsp;<span class="builtintype" id="5695524">string</span><span class="op" id="5695530">,</span>&nbsp;<span class="ident" id="5695532">driver</span>&nbsp;<span class="ident" id="5695539">driver</span><span class="op" id="5695545">.</span><span class="ident" id="5695546">Driver</span><span class="op" id="5695552">)</span>&nbsp;<span class="op" id="5695554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5695557">if</span>&nbsp;<span class="ident" id="5695560">driver</span>&nbsp;<span class="op" id="5695567">==</span>&nbsp;<span class="ident" id="5695570">nil</span>&nbsp;<span class="op" id="5695574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5695578">panic</span><span class="op" id="5695583">(</span><span class="string" id="5695584">&#34;sql:&nbsp;Register&nbsp;driver&nbsp;is&nbsp;nil&#34;</span><span class="op" id="5695613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5695616">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5695619">if</span>&nbsp;<span class="ident" id="5695622">_</span><span class="op" id="5695623">,</span>&nbsp;<span class="ident" id="5695625">dup</span>&nbsp;<span class="op" id="5695629">:=</span>&nbsp;<span class="ident" id="5695632">drivers</span><span class="op" id="5695639">[</span><span class="ident" id="5695640">name</span><span class="op" id="5695644">]</span><span class="op" id="5695645">;</span>&nbsp;<span class="ident" id="5695647">dup</span>&nbsp;<span class="op" id="5695651">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5695655">panic</span><span class="op" id="5695660">(</span><span class="string" id="5695661">&#34;sql:&nbsp;Register&nbsp;called&nbsp;twice&nbsp;for&nbsp;driver&nbsp;&#34;</span>&nbsp;<span class="op" id="5695702">+</span>&nbsp;<span class="ident" id="5695704">name</span><span class="op" id="5695708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5695711">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5695714">drivers</span><span class="op" id="5695721">[</span><span class="ident" id="5695722">name</span><span class="op" id="5695726">]</span>&nbsp;<span class="op" id="5695728">=</span>&nbsp;<span class="ident" id="5695730">driver</span><br>
<span class="lineno"></span><span class="op" id="5695737">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="5695740">func</span>&nbsp;<span class="ident" id="5695745">unregisterAllDrivers</span><span class="op" id="5695765">(</span><span class="op" id="5695766">)</span>&nbsp;<span class="op" id="5695768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5695771">//&nbsp;For&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5695786">drivers</span>&nbsp;<span class="op" id="5695794">=</span>&nbsp;<span class="builtinfunc" id="5695796">make</span><span class="op" id="5695800">(</span><span class="keyword" id="5695801">map</span><span class="op" id="5695804">[</span><span class="builtintype" id="5695805">string</span><span class="op" id="5695811">]</span><span class="ident" id="5695812">driver</span><span class="op" id="5695818">.</span><span class="ident" id="5695819">Driver</span><span class="op" id="5695825">)</span><br>
<span class="lineno"></span><span class="op" id="5695827">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="5695830">//&nbsp;Drivers&nbsp;returns&nbsp;a&nbsp;sorted&nbsp;list&nbsp;of&nbsp;the&nbsp;names&nbsp;of&nbsp;the&nbsp;registered&nbsp;drivers.</span><br>
<span class="lineno"></span><span class="keyword" id="5695903">func</span>&nbsp;<span class="ident" id="5695908">Drivers</span><span class="op" id="5695915">(</span><span class="op" id="5695916">)</span>&nbsp;<span class="op" id="5695918">[</span><span class="op" id="5695919">]</span><span class="builtintype" id="5695920">string</span>&nbsp;<span class="op" id="5695927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5695930">var</span>&nbsp;<span class="ident" id="5695934">list</span>&nbsp;<span class="op" id="5695939">[</span><span class="op" id="5695940">]</span><span class="builtintype" id="5695941">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5695949">for</span>&nbsp;<span class="ident" id="5695953">name</span>&nbsp;<span class="op" id="5695958">:=</span>&nbsp;<span class="keyword" id="5695961">range</span>&nbsp;<span class="ident" id="5695967">drivers</span>&nbsp;<span class="op" id="5695975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5695979">list</span>&nbsp;<span class="op" id="5695984">=</span>&nbsp;<span class="builtinfunc" id="5695986">append</span><span class="op" id="5695992">(</span><span class="ident" id="5695993">list</span><span class="op" id="5695997">,</span>&nbsp;<span class="ident" id="5695999">name</span><span class="op" id="5696003">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5696006">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5696009">sort</span><span class="op" id="5696013">.</span><span class="ident" id="5696014">Strings</span><span class="op" id="5696021">(</span><span class="ident" id="5696022">list</span><span class="op" id="5696026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5696029">return</span>&nbsp;<span class="ident" id="5696036">list</span><br>
<span class="lineno"></span><span class="op" id="5696041">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="5696044">//&nbsp;RawBytes&nbsp;is&nbsp;a&nbsp;byte&nbsp;slice&nbsp;that&nbsp;holds&nbsp;a&nbsp;reference&nbsp;to&nbsp;memory&nbsp;owned&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="5696114">//&nbsp;the&nbsp;database&nbsp;itself.&nbsp;After&nbsp;a&nbsp;Scan&nbsp;into&nbsp;a&nbsp;RawBytes,&nbsp;the&nbsp;slice&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="5696186">//&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;call&nbsp;to&nbsp;Next,&nbsp;Scan,&nbsp;or&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="5696240">type</span>&nbsp;<span class="ident" id="5696245">RawBytes</span>&nbsp;<span class="op" id="5696254">[</span><span class="op" id="5696255">]</span><span class="builtintype" id="5696256">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="5696262">//&nbsp;NullString&nbsp;represents&nbsp;a&nbsp;string&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="5696314">//&nbsp;NullString&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="5696364">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination:</span><br>
<span class="lineno"></span><span class="comment" id="5696405">//</span><br>
<span class="lineno"></span><span class="comment" id="5696408">//&nbsp;&nbsp;var&nbsp;s&nbsp;NullString</span><br>
<span class="lineno">65</span><span class="comment" id="5696429">//&nbsp;&nbsp;err&nbsp;:=&nbsp;db.QueryRow(&#34;SELECT&nbsp;name&nbsp;FROM&nbsp;foo&nbsp;WHERE&nbsp;id=?&#34;,&nbsp;id).Scan(&amp;s)</span><br>
<span class="lineno"></span><span class="comment" id="5696500">//&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="5696508">//&nbsp;&nbsp;if&nbsp;s.Valid&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="5696525">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;use&nbsp;s.String</span><br>
<span class="lineno"></span><span class="comment" id="5696548">//&nbsp;&nbsp;}&nbsp;else&nbsp;{</span><br>
<span class="lineno">70</span><span class="comment" id="5696561">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;NULL&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="5696582">//&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="5696588">//</span><br>
<span class="lineno"></span><span class="keyword" id="5696591">type</span>&nbsp;<span class="ident" id="5696596">NullString</span>&nbsp;<span class="keyword" id="5696607">struct</span>&nbsp;<span class="op" id="5696614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5696617">String</span>&nbsp;<span class="builtintype" id="5696624">string</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5696632">Valid</span>&nbsp;&nbsp;<span class="builtintype" id="5696639">bool</span>&nbsp;<span class="comment" id="5696644">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;String&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="5696683">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5696686">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5696728">func</span>&nbsp;<span class="op" id="5696733">(</span><span class="ident" id="5696734">ns</span>&nbsp;<span class="op" id="5696737">*</span><span class="ident" id="5696738">NullString</span><span class="op" id="5696748">)</span>&nbsp;<span class="ident" id="5696750">Scan</span><span class="op" id="5696754">(</span><span class="ident" id="5696755">value</span>&nbsp;<span class="keyword" id="5696761">interface</span><span class="op" id="5696770">{</span><span class="op" id="5696771">}</span><span class="op" id="5696772">)</span>&nbsp;<span class="builtintype" id="5696774">error</span>&nbsp;<span class="op" id="5696780">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5696783">if</span>&nbsp;<span class="ident" id="5696786">value</span>&nbsp;<span class="op" id="5696792">==</span>&nbsp;<span class="ident" id="5696795">nil</span>&nbsp;<span class="op" id="5696799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5696803">ns</span><span class="op" id="5696805">.</span><span class="ident" id="5696806">String</span><span class="op" id="5696812">,</span>&nbsp;<span class="ident" id="5696814">ns</span><span class="op" id="5696816">.</span><span class="ident" id="5696817">Valid</span>&nbsp;<span class="op" id="5696823">=</span>&nbsp;<span class="string" id="5696825">&#34;&#34;</span><span class="op" id="5696827">,</span>&nbsp;<span class="builtintype" id="5696829">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5696837">return</span>&nbsp;<span class="ident" id="5696844">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5696849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5696852">ns</span><span class="op" id="5696854">.</span><span class="ident" id="5696855">Valid</span>&nbsp;<span class="op" id="5696861">=</span>&nbsp;<span class="builtintype" id="5696863">true</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5696869">return</span>&nbsp;<span class="ident" id="5696876">convertAssign</span><span class="op" id="5696889">(</span><span class="op" id="5696890">&amp;</span><span class="ident" id="5696891">ns</span><span class="op" id="5696893">.</span><span class="ident" id="5696894">String</span><span class="op" id="5696900">,</span>&nbsp;<span class="ident" id="5696902">value</span><span class="op" id="5696907">)</span><br>
<span class="lineno"></span><span class="op" id="5696909">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5696912">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5696961">func</span>&nbsp;<span class="op" id="5696966">(</span><span class="ident" id="5696967">ns</span>&nbsp;<span class="ident" id="5696970">NullString</span><span class="op" id="5696980">)</span>&nbsp;<span class="ident" id="5696982">Value</span><span class="op" id="5696987">(</span><span class="op" id="5696988">)</span>&nbsp;<span class="op" id="5696990">(</span><span class="ident" id="5696991">driver</span><span class="op" id="5696997">.</span><span class="ident" id="5696998">Value</span><span class="op" id="5697003">,</span>&nbsp;<span class="builtintype" id="5697005">error</span><span class="op" id="5697010">)</span>&nbsp;<span class="op" id="5697012">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5697015">if</span>&nbsp;<span class="op" id="5697018">!</span><span class="ident" id="5697019">ns</span><span class="op" id="5697021">.</span><span class="ident" id="5697022">Valid</span>&nbsp;<span class="op" id="5697028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5697032">return</span>&nbsp;<span class="ident" id="5697039">nil</span><span class="op" id="5697042">,</span>&nbsp;<span class="ident" id="5697044">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5697049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5697052">return</span>&nbsp;<span class="ident" id="5697059">ns</span><span class="op" id="5697061">.</span><span class="ident" id="5697062">String</span><span class="op" id="5697068">,</span>&nbsp;<span class="ident" id="5697070">nil</span><br>
<span class="lineno"></span><span class="op" id="5697074">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="5697077">//&nbsp;NullInt64&nbsp;represents&nbsp;an&nbsp;int64&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="5697128">//&nbsp;NullInt64&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="5697177">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination,&nbsp;similar&nbsp;to&nbsp;NullString.</span><br>
<span class="lineno"></span><span class="keyword" id="5697241">type</span>&nbsp;<span class="ident" id="5697246">NullInt64</span>&nbsp;<span class="keyword" id="5697256">struct</span>&nbsp;<span class="op" id="5697263">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5697266">Int64</span>&nbsp;<span class="ident" id="5697272">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5697279">Valid</span>&nbsp;<span class="builtintype" id="5697285">bool</span>&nbsp;<span class="comment" id="5697290">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;Int64&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="5697328">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5697331">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno">105</span><span class="keyword" id="5697373">func</span>&nbsp;<span class="op" id="5697378">(</span><span class="ident" id="5697379">n</span>&nbsp;<span class="op" id="5697381">*</span><span class="ident" id="5697382">NullInt64</span><span class="op" id="5697391">)</span>&nbsp;<span class="ident" id="5697393">Scan</span><span class="op" id="5697397">(</span><span class="ident" id="5697398">value</span>&nbsp;<span class="keyword" id="5697404">interface</span><span class="op" id="5697413">{</span><span class="op" id="5697414">}</span><span class="op" id="5697415">)</span>&nbsp;<span class="builtintype" id="5697417">error</span>&nbsp;<span class="op" id="5697423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5697426">if</span>&nbsp;<span class="ident" id="5697429">value</span>&nbsp;<span class="op" id="5697435">==</span>&nbsp;<span class="ident" id="5697438">nil</span>&nbsp;<span class="op" id="5697442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5697446">n</span><span class="op" id="5697447">.</span><span class="ident" id="5697448">Int64</span><span class="op" id="5697453">,</span>&nbsp;<span class="ident" id="5697455">n</span><span class="op" id="5697456">.</span><span class="ident" id="5697457">Valid</span>&nbsp;<span class="op" id="5697463">=</span>&nbsp;<span class="num" id="5697465">0</span><span class="op" id="5697466">,</span>&nbsp;<span class="builtintype" id="5697468">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5697476">return</span>&nbsp;<span class="ident" id="5697483">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5697488">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5697491">n</span><span class="op" id="5697492">.</span><span class="ident" id="5697493">Valid</span>&nbsp;<span class="op" id="5697499">=</span>&nbsp;<span class="builtintype" id="5697501">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5697507">return</span>&nbsp;<span class="ident" id="5697514">convertAssign</span><span class="op" id="5697527">(</span><span class="op" id="5697528">&amp;</span><span class="ident" id="5697529">n</span><span class="op" id="5697530">.</span><span class="ident" id="5697531">Int64</span><span class="op" id="5697536">,</span>&nbsp;<span class="ident" id="5697538">value</span><span class="op" id="5697543">)</span><br>
<span class="lineno"></span><span class="op" id="5697545">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5697548">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno">115</span><span class="keyword" id="5697597">func</span>&nbsp;<span class="op" id="5697602">(</span><span class="ident" id="5697603">n</span>&nbsp;<span class="ident" id="5697605">NullInt64</span><span class="op" id="5697614">)</span>&nbsp;<span class="ident" id="5697616">Value</span><span class="op" id="5697621">(</span><span class="op" id="5697622">)</span>&nbsp;<span class="op" id="5697624">(</span><span class="ident" id="5697625">driver</span><span class="op" id="5697631">.</span><span class="ident" id="5697632">Value</span><span class="op" id="5697637">,</span>&nbsp;<span class="builtintype" id="5697639">error</span><span class="op" id="5697644">)</span>&nbsp;<span class="op" id="5697646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5697649">if</span>&nbsp;<span class="op" id="5697652">!</span><span class="ident" id="5697653">n</span><span class="op" id="5697654">.</span><span class="ident" id="5697655">Valid</span>&nbsp;<span class="op" id="5697661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5697665">return</span>&nbsp;<span class="ident" id="5697672">nil</span><span class="op" id="5697675">,</span>&nbsp;<span class="ident" id="5697677">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5697682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5697685">return</span>&nbsp;<span class="ident" id="5697692">n</span><span class="op" id="5697693">.</span><span class="ident" id="5697694">Int64</span><span class="op" id="5697699">,</span>&nbsp;<span class="ident" id="5697701">nil</span><br>
<span class="lineno">120</span><span class="op" id="5697705">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5697708">//&nbsp;NullFloat64&nbsp;represents&nbsp;a&nbsp;float64&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="5697762">//&nbsp;NullFloat64&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="5697813">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination,&nbsp;similar&nbsp;to&nbsp;NullString.</span><br>
<span class="lineno">125</span><span class="keyword" id="5697877">type</span>&nbsp;<span class="ident" id="5697882">NullFloat64</span>&nbsp;<span class="keyword" id="5697894">struct</span>&nbsp;<span class="op" id="5697901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5697904">Float64</span>&nbsp;<span class="builtintype" id="5697912">float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5697921">Valid</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5697929">bool</span>&nbsp;<span class="comment" id="5697934">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;Float64&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="5697974">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="comment" id="5697977">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5698019">func</span>&nbsp;<span class="op" id="5698024">(</span><span class="ident" id="5698025">n</span>&nbsp;<span class="op" id="5698027">*</span><span class="ident" id="5698028">NullFloat64</span><span class="op" id="5698039">)</span>&nbsp;<span class="ident" id="5698041">Scan</span><span class="op" id="5698045">(</span><span class="ident" id="5698046">value</span>&nbsp;<span class="keyword" id="5698052">interface</span><span class="op" id="5698061">{</span><span class="op" id="5698062">}</span><span class="op" id="5698063">)</span>&nbsp;<span class="builtintype" id="5698065">error</span>&nbsp;<span class="op" id="5698071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5698074">if</span>&nbsp;<span class="ident" id="5698077">value</span>&nbsp;<span class="op" id="5698083">==</span>&nbsp;<span class="ident" id="5698086">nil</span>&nbsp;<span class="op" id="5698090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5698094">n</span><span class="op" id="5698095">.</span><span class="ident" id="5698096">Float64</span><span class="op" id="5698103">,</span>&nbsp;<span class="ident" id="5698105">n</span><span class="op" id="5698106">.</span><span class="ident" id="5698107">Valid</span>&nbsp;<span class="op" id="5698113">=</span>&nbsp;<span class="num" id="5698115">0</span><span class="op" id="5698116">,</span>&nbsp;<span class="builtintype" id="5698118">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5698126">return</span>&nbsp;<span class="ident" id="5698133">nil</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5698138">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5698141">n</span><span class="op" id="5698142">.</span><span class="ident" id="5698143">Valid</span>&nbsp;<span class="op" id="5698149">=</span>&nbsp;<span class="builtintype" id="5698151">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5698157">return</span>&nbsp;<span class="ident" id="5698164">convertAssign</span><span class="op" id="5698177">(</span><span class="op" id="5698178">&amp;</span><span class="ident" id="5698179">n</span><span class="op" id="5698180">.</span><span class="ident" id="5698181">Float64</span><span class="op" id="5698188">,</span>&nbsp;<span class="ident" id="5698190">value</span><span class="op" id="5698195">)</span><br>
<span class="lineno"></span><span class="op" id="5698197">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="5698200">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5698249">func</span>&nbsp;<span class="op" id="5698254">(</span><span class="ident" id="5698255">n</span>&nbsp;<span class="ident" id="5698257">NullFloat64</span><span class="op" id="5698268">)</span>&nbsp;<span class="ident" id="5698270">Value</span><span class="op" id="5698275">(</span><span class="op" id="5698276">)</span>&nbsp;<span class="op" id="5698278">(</span><span class="ident" id="5698279">driver</span><span class="op" id="5698285">.</span><span class="ident" id="5698286">Value</span><span class="op" id="5698291">,</span>&nbsp;<span class="builtintype" id="5698293">error</span><span class="op" id="5698298">)</span>&nbsp;<span class="op" id="5698300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5698303">if</span>&nbsp;<span class="op" id="5698306">!</span><span class="ident" id="5698307">n</span><span class="op" id="5698308">.</span><span class="ident" id="5698309">Valid</span>&nbsp;<span class="op" id="5698315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5698319">return</span>&nbsp;<span class="ident" id="5698326">nil</span><span class="op" id="5698329">,</span>&nbsp;<span class="ident" id="5698331">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5698336">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5698339">return</span>&nbsp;<span class="ident" id="5698346">n</span><span class="op" id="5698347">.</span><span class="ident" id="5698348">Float64</span><span class="op" id="5698355">,</span>&nbsp;<span class="ident" id="5698357">nil</span><br>
<span class="lineno"></span><span class="op" id="5698361">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5698364">//&nbsp;NullBool&nbsp;represents&nbsp;a&nbsp;bool&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="5698412">//&nbsp;NullBool&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno">150</span><span class="comment" id="5698460">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination,&nbsp;similar&nbsp;to&nbsp;NullString.</span><br>
<span class="lineno"></span><span class="keyword" id="5698524">type</span>&nbsp;<span class="ident" id="5698529">NullBool</span>&nbsp;<span class="keyword" id="5698538">struct</span>&nbsp;<span class="op" id="5698545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5698548">Bool</span>&nbsp;&nbsp;<span class="builtintype" id="5698554">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5698560">Valid</span>&nbsp;<span class="builtintype" id="5698566">bool</span>&nbsp;<span class="comment" id="5698571">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;Bool&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="5698608">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="5698611">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5698653">func</span>&nbsp;<span class="op" id="5698658">(</span><span class="ident" id="5698659">n</span>&nbsp;<span class="op" id="5698661">*</span><span class="ident" id="5698662">NullBool</span><span class="op" id="5698670">)</span>&nbsp;<span class="ident" id="5698672">Scan</span><span class="op" id="5698676">(</span><span class="ident" id="5698677">value</span>&nbsp;<span class="keyword" id="5698683">interface</span><span class="op" id="5698692">{</span><span class="op" id="5698693">}</span><span class="op" id="5698694">)</span>&nbsp;<span class="builtintype" id="5698696">error</span>&nbsp;<span class="op" id="5698702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5698705">if</span>&nbsp;<span class="ident" id="5698708">value</span>&nbsp;<span class="op" id="5698714">==</span>&nbsp;<span class="ident" id="5698717">nil</span>&nbsp;<span class="op" id="5698721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5698725">n</span><span class="op" id="5698726">.</span><span class="ident" id="5698727">Bool</span><span class="op" id="5698731">,</span>&nbsp;<span class="ident" id="5698733">n</span><span class="op" id="5698734">.</span><span class="ident" id="5698735">Valid</span>&nbsp;<span class="op" id="5698741">=</span>&nbsp;<span class="builtintype" id="5698743">false</span><span class="op" id="5698748">,</span>&nbsp;<span class="builtintype" id="5698750">false</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5698758">return</span>&nbsp;<span class="ident" id="5698765">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5698770">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5698773">n</span><span class="op" id="5698774">.</span><span class="ident" id="5698775">Valid</span>&nbsp;<span class="op" id="5698781">=</span>&nbsp;<span class="builtintype" id="5698783">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5698789">return</span>&nbsp;<span class="ident" id="5698796">convertAssign</span><span class="op" id="5698809">(</span><span class="op" id="5698810">&amp;</span><span class="ident" id="5698811">n</span><span class="op" id="5698812">.</span><span class="ident" id="5698813">Bool</span><span class="op" id="5698817">,</span>&nbsp;<span class="ident" id="5698819">value</span><span class="op" id="5698824">)</span><br>
<span class="lineno"></span><span class="op" id="5698826">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="5698829">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5698878">func</span>&nbsp;<span class="op" id="5698883">(</span><span class="ident" id="5698884">n</span>&nbsp;<span class="ident" id="5698886">NullBool</span><span class="op" id="5698894">)</span>&nbsp;<span class="ident" id="5698896">Value</span><span class="op" id="5698901">(</span><span class="op" id="5698902">)</span>&nbsp;<span class="op" id="5698904">(</span><span class="ident" id="5698905">driver</span><span class="op" id="5698911">.</span><span class="ident" id="5698912">Value</span><span class="op" id="5698917">,</span>&nbsp;<span class="builtintype" id="5698919">error</span><span class="op" id="5698924">)</span>&nbsp;<span class="op" id="5698926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5698929">if</span>&nbsp;<span class="op" id="5698932">!</span><span class="ident" id="5698933">n</span><span class="op" id="5698934">.</span><span class="ident" id="5698935">Valid</span>&nbsp;<span class="op" id="5698941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5698945">return</span>&nbsp;<span class="ident" id="5698952">nil</span><span class="op" id="5698955">,</span>&nbsp;<span class="ident" id="5698957">nil</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5698962">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5698965">return</span>&nbsp;<span class="ident" id="5698972">n</span><span class="op" id="5698973">.</span><span class="ident" id="5698974">Bool</span><span class="op" id="5698978">,</span>&nbsp;<span class="ident" id="5698980">nil</span><br>
<span class="lineno"></span><span class="op" id="5698984">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5698987">//&nbsp;Scanner&nbsp;is&nbsp;an&nbsp;interface&nbsp;used&nbsp;by&nbsp;Scan.</span><br>
<span class="lineno">175</span><span class="keyword" id="5699028">type</span>&nbsp;<span class="ident" id="5699033">Scanner</span>&nbsp;<span class="keyword" id="5699041">interface</span>&nbsp;<span class="op" id="5699051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5699054">//&nbsp;Scan&nbsp;assigns&nbsp;a&nbsp;value&nbsp;from&nbsp;a&nbsp;database&nbsp;driver.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5699103">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5699107">//&nbsp;The&nbsp;src&nbsp;value&nbsp;will&nbsp;be&nbsp;of&nbsp;one&nbsp;of&nbsp;the&nbsp;following&nbsp;restricted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5699168">//&nbsp;set&nbsp;of&nbsp;types:</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5699186">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5699190">//&nbsp;&nbsp;&nbsp;&nbsp;int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5699203">//&nbsp;&nbsp;&nbsp;&nbsp;float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5699218">//&nbsp;&nbsp;&nbsp;&nbsp;bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5699230">//&nbsp;&nbsp;&nbsp;&nbsp;[]byte</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5699244">//&nbsp;&nbsp;&nbsp;&nbsp;string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5699258">//&nbsp;&nbsp;&nbsp;&nbsp;time.Time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5699275">//&nbsp;&nbsp;&nbsp;&nbsp;nil&nbsp;-&nbsp;for&nbsp;NULL&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5699304">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5699308">//&nbsp;An&nbsp;error&nbsp;should&nbsp;be&nbsp;returned&nbsp;if&nbsp;the&nbsp;value&nbsp;can&nbsp;not&nbsp;be&nbsp;stored</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5699371">//&nbsp;without&nbsp;loss&nbsp;of&nbsp;information.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5699404">Scan</span><span class="op" id="5699408">(</span><span class="ident" id="5699409">src</span>&nbsp;<span class="keyword" id="5699413">interface</span><span class="op" id="5699422">{</span><span class="op" id="5699423">}</span><span class="op" id="5699424">)</span>&nbsp;<span class="builtintype" id="5699426">error</span><br>
<span class="lineno"></span><span class="op" id="5699432">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5699435">//&nbsp;ErrNoRows&nbsp;is&nbsp;returned&nbsp;by&nbsp;Scan&nbsp;when&nbsp;QueryRow&nbsp;doesn&#39;t&nbsp;return&nbsp;a</span><br>
<span class="lineno">195</span><span class="comment" id="5699499">//&nbsp;row.&nbsp;In&nbsp;such&nbsp;a&nbsp;case,&nbsp;QueryRow&nbsp;returns&nbsp;a&nbsp;placeholder&nbsp;*Row&nbsp;value&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="5699570">//&nbsp;defers&nbsp;this&nbsp;error&nbsp;until&nbsp;a&nbsp;Scan.</span><br>
<span class="lineno"></span><span class="keyword" id="5699605">var</span>&nbsp;<span class="ident" id="5699609">ErrNoRows</span>&nbsp;<span class="op" id="5699619">=</span>&nbsp;<span class="ident" id="5699621">errors</span><span class="op" id="5699627">.</span><span class="ident" id="5699628">New</span><span class="op" id="5699631">(</span><span class="string" id="5699632">&#34;sql:&nbsp;no&nbsp;rows&nbsp;in&nbsp;result&nbsp;set&#34;</span><span class="op" id="5699660">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5699663">//&nbsp;DB&nbsp;is&nbsp;a&nbsp;database&nbsp;handle&nbsp;representing&nbsp;a&nbsp;pool&nbsp;of&nbsp;zero&nbsp;or&nbsp;more</span><br>
<span class="lineno">200</span><span class="comment" id="5699726">//&nbsp;underlying&nbsp;connections.&nbsp;It&#39;s&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple</span><br>
<span class="lineno"></span><span class="comment" id="5699794">//&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="comment" id="5699809">//</span><br>
<span class="lineno"></span><span class="comment" id="5699812">//&nbsp;The&nbsp;sql&nbsp;package&nbsp;creates&nbsp;and&nbsp;frees&nbsp;connections&nbsp;automatically;&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="5699879">//&nbsp;also&nbsp;maintains&nbsp;a&nbsp;free&nbsp;pool&nbsp;of&nbsp;idle&nbsp;connections.&nbsp;If&nbsp;the&nbsp;database&nbsp;has</span><br>
<span class="lineno">205</span><span class="comment" id="5699950">//&nbsp;a&nbsp;concept&nbsp;of&nbsp;per-connection&nbsp;state,&nbsp;such&nbsp;state&nbsp;can&nbsp;only&nbsp;be&nbsp;reliably</span><br>
<span class="lineno"></span><span class="comment" id="5700020">//&nbsp;observed&nbsp;within&nbsp;a&nbsp;transaction.&nbsp;Once&nbsp;DB.Begin&nbsp;is&nbsp;called,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5700083">//&nbsp;returned&nbsp;Tx&nbsp;is&nbsp;bound&nbsp;to&nbsp;a&nbsp;single&nbsp;connection.&nbsp;Once&nbsp;Commit&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="5700146">//&nbsp;Rollback&nbsp;is&nbsp;called&nbsp;on&nbsp;the&nbsp;transaction,&nbsp;that&nbsp;transaction&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="5700207">//&nbsp;connection&nbsp;is&nbsp;returned&nbsp;to&nbsp;DB&#39;s&nbsp;idle&nbsp;connection&nbsp;pool.&nbsp;The&nbsp;pool&nbsp;size</span><br>
<span class="lineno">210</span><span class="comment" id="5700277">//&nbsp;can&nbsp;be&nbsp;controlled&nbsp;with&nbsp;SetMaxIdleConns.</span><br>
<span class="lineno"></span><span class="keyword" id="5700320">type</span>&nbsp;<span class="ident" id="5700325">DB</span>&nbsp;<span class="keyword" id="5700328">struct</span>&nbsp;<span class="op" id="5700335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5700338">driver</span>&nbsp;<span class="ident" id="5700345">driver</span><span class="op" id="5700351">.</span><span class="ident" id="5700352">Driver</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5700360">dsn</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5700367">string</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5700376">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5700389">sync</span><span class="op" id="5700393">.</span><span class="ident" id="5700394">Mutex</span>&nbsp;<span class="comment" id="5700400">//&nbsp;protects&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5700430">freeConn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5700443">[</span><span class="op" id="5700444">]</span><span class="op" id="5700445">*</span><span class="ident" id="5700446">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5700458">connRequests</span>&nbsp;<span class="op" id="5700471">[</span><span class="op" id="5700472">]</span><span class="keyword" id="5700473">chan</span>&nbsp;<span class="ident" id="5700478">connRequest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5700491">numOpen</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5700504">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5700509">pendingOpens</span>&nbsp;<span class="builtintype" id="5700522">int</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5700527">//&nbsp;Used&nbsp;to&nbsp;signal&nbsp;the&nbsp;need&nbsp;for&nbsp;new&nbsp;connections</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5700575">//&nbsp;a&nbsp;goroutine&nbsp;running&nbsp;connectionOpener()&nbsp;reads&nbsp;on&nbsp;this&nbsp;chan&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5700641">//&nbsp;maybeOpenNewConnections&nbsp;sends&nbsp;on&nbsp;the&nbsp;chan&nbsp;(one&nbsp;send&nbsp;per&nbsp;needed&nbsp;connection)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5700720">//&nbsp;It&nbsp;is&nbsp;closed&nbsp;during&nbsp;db.Close().&nbsp;The&nbsp;close&nbsp;tells&nbsp;the&nbsp;connectionOpener</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5700793">//&nbsp;goroutine&nbsp;to&nbsp;exit.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5700816">openerCh</span>&nbsp;<span class="keyword" id="5700825">chan</span>&nbsp;<span class="keyword" id="5700830">struct</span><span class="op" id="5700836">{</span><span class="op" id="5700837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5700840">closed</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5700849">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5700855">dep</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5700864">map</span><span class="op" id="5700867">[</span><span class="ident" id="5700868">finalCloser</span><span class="op" id="5700879">]</span><span class="ident" id="5700880">depSet</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5700888">lastPut</span>&nbsp;&nbsp;<span class="keyword" id="5700897">map</span><span class="op" id="5700900">[</span><span class="op" id="5700901">*</span><span class="ident" id="5700902">driverConn</span><span class="op" id="5700912">]</span><span class="builtintype" id="5700913">string</span>&nbsp;<span class="comment" id="5700920">//&nbsp;stacktrace&nbsp;of&nbsp;last&nbsp;conn&#39;s&nbsp;put;&nbsp;debug&nbsp;only</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5700966">maxIdle</span>&nbsp;&nbsp;<span class="builtintype" id="5700975">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5700998">//&nbsp;zero&nbsp;means&nbsp;defaultMaxIdleConns;&nbsp;negative&nbsp;means&nbsp;0</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5701051">maxOpen</span>&nbsp;&nbsp;<span class="builtintype" id="5701060">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5701083">//&nbsp;&lt;=&nbsp;0&nbsp;means&nbsp;unlimited</span><br>
<span class="lineno"></span><span class="op" id="5701107">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5701110">//&nbsp;driverConn&nbsp;wraps&nbsp;a&nbsp;driver.Conn&nbsp;with&nbsp;a&nbsp;mutex,&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5701161">//&nbsp;be&nbsp;held&nbsp;during&nbsp;all&nbsp;calls&nbsp;into&nbsp;the&nbsp;Conn.&nbsp;(including&nbsp;any&nbsp;calls&nbsp;onto</span><br>
<span class="lineno">235</span><span class="comment" id="5701230">//&nbsp;interfaces&nbsp;returned&nbsp;via&nbsp;that&nbsp;Conn,&nbsp;such&nbsp;as&nbsp;calls&nbsp;on&nbsp;Tx,&nbsp;Stmt,</span><br>
<span class="lineno"></span><span class="comment" id="5701295">//&nbsp;Result,&nbsp;Rows)</span><br>
<span class="lineno"></span><span class="keyword" id="5701312">type</span>&nbsp;<span class="ident" id="5701317">driverConn</span>&nbsp;<span class="keyword" id="5701328">struct</span>&nbsp;<span class="op" id="5701335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5701338">db</span>&nbsp;<span class="op" id="5701341">*</span><span class="ident" id="5701342">DB</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5701347">sync</span><span class="op" id="5701351">.</span><span class="ident" id="5701352">Mutex</span>&nbsp;&nbsp;<span class="comment" id="5701359">//&nbsp;guards&nbsp;following</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5701380">ci</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5701392">driver</span><span class="op" id="5701398">.</span><span class="ident" id="5701399">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5701405">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5701417">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5701423">finalClosed</span>&nbsp;<span class="builtintype" id="5701435">bool</span>&nbsp;<span class="comment" id="5701440">//&nbsp;ci.Close&nbsp;has&nbsp;been&nbsp;called</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5701469">openStmt</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5701481">map</span><span class="op" id="5701484">[</span><span class="ident" id="5701485">driver</span><span class="op" id="5701491">.</span><span class="ident" id="5701492">Stmt</span><span class="op" id="5701496">]</span><span class="builtintype" id="5701497">bool</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5701504">//&nbsp;guarded&nbsp;by&nbsp;db.mu</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5701525">inUse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5701536">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5701542">onPut</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5701553">[</span><span class="op" id="5701554">]</span><span class="keyword" id="5701555">func</span><span class="op" id="5701559">(</span><span class="op" id="5701560">)</span>&nbsp;<span class="comment" id="5701562">//&nbsp;code&nbsp;(with&nbsp;db.mu&nbsp;held)&nbsp;run&nbsp;when&nbsp;conn&nbsp;is&nbsp;next&nbsp;returned</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5701620">dbmuClosed</span>&nbsp;<span class="builtintype" id="5701631">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5701640">//&nbsp;same&nbsp;as&nbsp;closed,&nbsp;but&nbsp;guarded&nbsp;by&nbsp;db.mu,&nbsp;for&nbsp;connIfFree</span><br>
<span class="lineno">250</span><span class="op" id="5701696">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5701699">func</span>&nbsp;<span class="op" id="5701704">(</span><span class="ident" id="5701705">dc</span>&nbsp;<span class="op" id="5701708">*</span><span class="ident" id="5701709">driverConn</span><span class="op" id="5701719">)</span>&nbsp;<span class="ident" id="5701721">releaseConn</span><span class="op" id="5701732">(</span><span class="ident" id="5701733">err</span>&nbsp;<span class="builtintype" id="5701737">error</span><span class="op" id="5701742">)</span>&nbsp;<span class="op" id="5701744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5701747">dc</span><span class="op" id="5701749">.</span><span class="ident" id="5701750">db</span><span class="op" id="5701752">.</span><span class="ident" id="5701753">putConn</span><span class="op" id="5701760">(</span><span class="ident" id="5701761">dc</span><span class="op" id="5701763">,</span>&nbsp;<span class="ident" id="5701765">err</span><span class="op" id="5701768">)</span><br>
<span class="lineno"></span><span class="op" id="5701770">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="5701773">func</span>&nbsp;<span class="op" id="5701778">(</span><span class="ident" id="5701779">dc</span>&nbsp;<span class="op" id="5701782">*</span><span class="ident" id="5701783">driverConn</span><span class="op" id="5701793">)</span>&nbsp;<span class="ident" id="5701795">removeOpenStmt</span><span class="op" id="5701809">(</span><span class="ident" id="5701810">si</span>&nbsp;<span class="ident" id="5701813">driver</span><span class="op" id="5701819">.</span><span class="ident" id="5701820">Stmt</span><span class="op" id="5701824">)</span>&nbsp;<span class="op" id="5701826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5701829">dc</span><span class="op" id="5701831">.</span><span class="ident" id="5701832">Lock</span><span class="op" id="5701836">(</span><span class="op" id="5701837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5701840">defer</span>&nbsp;<span class="ident" id="5701846">dc</span><span class="op" id="5701848">.</span><span class="ident" id="5701849">Unlock</span><span class="op" id="5701855">(</span><span class="op" id="5701856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5701859">delete</span><span class="op" id="5701865">(</span><span class="ident" id="5701866">dc</span><span class="op" id="5701868">.</span><span class="ident" id="5701869">openStmt</span><span class="op" id="5701877">,</span>&nbsp;<span class="ident" id="5701879">si</span><span class="op" id="5701881">)</span><br>
<span class="lineno">260</span><span class="op" id="5701883">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5701886">func</span>&nbsp;<span class="op" id="5701891">(</span><span class="ident" id="5701892">dc</span>&nbsp;<span class="op" id="5701895">*</span><span class="ident" id="5701896">driverConn</span><span class="op" id="5701906">)</span>&nbsp;<span class="ident" id="5701908">prepareLocked</span><span class="op" id="5701921">(</span><span class="ident" id="5701922">query</span>&nbsp;<span class="builtintype" id="5701928">string</span><span class="op" id="5701934">)</span>&nbsp;<span class="op" id="5701936">(</span><span class="ident" id="5701937">driver</span><span class="op" id="5701943">.</span><span class="ident" id="5701944">Stmt</span><span class="op" id="5701948">,</span>&nbsp;<span class="builtintype" id="5701950">error</span><span class="op" id="5701955">)</span>&nbsp;<span class="op" id="5701957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5701960">si</span><span class="op" id="5701962">,</span>&nbsp;<span class="ident" id="5701964">err</span>&nbsp;<span class="op" id="5701968">:=</span>&nbsp;<span class="ident" id="5701971">dc</span><span class="op" id="5701973">.</span><span class="ident" id="5701974">ci</span><span class="op" id="5701976">.</span><span class="ident" id="5701977">Prepare</span><span class="op" id="5701984">(</span><span class="ident" id="5701985">query</span><span class="op" id="5701990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5701993">if</span>&nbsp;<span class="ident" id="5701996">err</span>&nbsp;<span class="op" id="5702000">==</span>&nbsp;<span class="ident" id="5702003">nil</span>&nbsp;<span class="op" id="5702007">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5702011">//&nbsp;Track&nbsp;each&nbsp;driverConn&#39;s&nbsp;open&nbsp;statements,&nbsp;so&nbsp;we&nbsp;can&nbsp;close&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5702078">//&nbsp;before&nbsp;closing&nbsp;the&nbsp;conn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5702108">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5702113">//&nbsp;TODO(bradfitz):&nbsp;let&nbsp;drivers&nbsp;opt&nbsp;out&nbsp;of&nbsp;caring&nbsp;about</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5702170">//&nbsp;stmt&nbsp;closes&nbsp;if&nbsp;the&nbsp;conn&nbsp;is&nbsp;about&nbsp;to&nbsp;close&nbsp;anyway?&nbsp;For&nbsp;now</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5702233">//&nbsp;do&nbsp;the&nbsp;safe&nbsp;thing,&nbsp;in&nbsp;case&nbsp;stmts&nbsp;need&nbsp;to&nbsp;be&nbsp;closed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5702290">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5702295">//&nbsp;TODO(bradfitz):&nbsp;after&nbsp;Go&nbsp;1.2,&nbsp;closing&nbsp;driver.Stmts</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5702351">//&nbsp;should&nbsp;be&nbsp;moved&nbsp;to&nbsp;driverStmt,&nbsp;using&nbsp;unique</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5702400">//&nbsp;*driverStmts&nbsp;everywhere&nbsp;(including&nbsp;from</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5702445">//&nbsp;*Stmt.connStmt,&nbsp;instead&nbsp;of&nbsp;returning&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5702489">//&nbsp;driver.Stmt),&nbsp;using&nbsp;driverStmt&nbsp;as&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5702538">//&nbsp;everywhere,&nbsp;and&nbsp;making&nbsp;it&nbsp;a&nbsp;finalCloser.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5702584">if</span>&nbsp;<span class="ident" id="5702587">dc</span><span class="op" id="5702589">.</span><span class="ident" id="5702590">openStmt</span>&nbsp;<span class="op" id="5702599">==</span>&nbsp;<span class="ident" id="5702602">nil</span>&nbsp;<span class="op" id="5702606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5702611">dc</span><span class="op" id="5702613">.</span><span class="ident" id="5702614">openStmt</span>&nbsp;<span class="op" id="5702623">=</span>&nbsp;<span class="builtinfunc" id="5702625">make</span><span class="op" id="5702629">(</span><span class="keyword" id="5702630">map</span><span class="op" id="5702633">[</span><span class="ident" id="5702634">driver</span><span class="op" id="5702640">.</span><span class="ident" id="5702641">Stmt</span><span class="op" id="5702645">]</span><span class="builtintype" id="5702646">bool</span><span class="op" id="5702650">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5702654">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5702658">dc</span><span class="op" id="5702660">.</span><span class="ident" id="5702661">openStmt</span><span class="op" id="5702669">[</span><span class="ident" id="5702670">si</span><span class="op" id="5702672">]</span>&nbsp;<span class="op" id="5702674">=</span>&nbsp;<span class="builtintype" id="5702676">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5702682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5702685">return</span>&nbsp;<span class="ident" id="5702692">si</span><span class="op" id="5702694">,</span>&nbsp;<span class="ident" id="5702696">err</span><br>
<span class="lineno"></span><span class="op" id="5702700">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="comment" id="5702703">//&nbsp;the&nbsp;dc.db&#39;s&nbsp;Mutex&nbsp;is&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword" id="5702733">func</span>&nbsp;<span class="op" id="5702738">(</span><span class="ident" id="5702739">dc</span>&nbsp;<span class="op" id="5702742">*</span><span class="ident" id="5702743">driverConn</span><span class="op" id="5702753">)</span>&nbsp;<span class="ident" id="5702755">closeDBLocked</span><span class="op" id="5702768">(</span><span class="op" id="5702769">)</span>&nbsp;<span class="keyword" id="5702771">func</span><span class="op" id="5702775">(</span><span class="op" id="5702776">)</span>&nbsp;<span class="builtintype" id="5702778">error</span>&nbsp;<span class="op" id="5702784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5702787">dc</span><span class="op" id="5702789">.</span><span class="ident" id="5702790">Lock</span><span class="op" id="5702794">(</span><span class="op" id="5702795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5702798">defer</span>&nbsp;<span class="ident" id="5702804">dc</span><span class="op" id="5702806">.</span><span class="ident" id="5702807">Unlock</span><span class="op" id="5702813">(</span><span class="op" id="5702814">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5702817">if</span>&nbsp;<span class="ident" id="5702820">dc</span><span class="op" id="5702822">.</span><span class="ident" id="5702823">closed</span>&nbsp;<span class="op" id="5702830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5702834">return</span>&nbsp;<span class="keyword" id="5702841">func</span><span class="op" id="5702845">(</span><span class="op" id="5702846">)</span>&nbsp;<span class="builtintype" id="5702848">error</span>&nbsp;<span class="op" id="5702854">{</span>&nbsp;<span class="keyword" id="5702856">return</span>&nbsp;<span class="ident" id="5702863">errors</span><span class="op" id="5702869">.</span><span class="ident" id="5702870">New</span><span class="op" id="5702873">(</span><span class="string" id="5702874">&#34;sql:&nbsp;duplicate&nbsp;driverConn&nbsp;close&#34;</span><span class="op" id="5702907">)</span>&nbsp;<span class="op" id="5702909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5702912">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5702915">dc</span><span class="op" id="5702917">.</span><span class="ident" id="5702918">closed</span>&nbsp;<span class="op" id="5702925">=</span>&nbsp;<span class="builtintype" id="5702927">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5702933">return</span>&nbsp;<span class="ident" id="5702940">dc</span><span class="op" id="5702942">.</span><span class="ident" id="5702943">db</span><span class="op" id="5702945">.</span><span class="ident" id="5702946">removeDepLocked</span><span class="op" id="5702961">(</span><span class="ident" id="5702962">dc</span><span class="op" id="5702964">,</span>&nbsp;<span class="ident" id="5702966">dc</span><span class="op" id="5702968">)</span><br>
<span class="lineno">295</span><span class="op" id="5702970">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5702973">func</span>&nbsp;<span class="op" id="5702978">(</span><span class="ident" id="5702979">dc</span>&nbsp;<span class="op" id="5702982">*</span><span class="ident" id="5702983">driverConn</span><span class="op" id="5702993">)</span>&nbsp;<span class="ident" id="5702995">Close</span><span class="op" id="5703000">(</span><span class="op" id="5703001">)</span>&nbsp;<span class="builtintype" id="5703003">error</span>&nbsp;<span class="op" id="5703009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5703012">dc</span><span class="op" id="5703014">.</span><span class="ident" id="5703015">Lock</span><span class="op" id="5703019">(</span><span class="op" id="5703020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5703023">if</span>&nbsp;<span class="ident" id="5703026">dc</span><span class="op" id="5703028">.</span><span class="ident" id="5703029">closed</span>&nbsp;<span class="op" id="5703036">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5703040">dc</span><span class="op" id="5703042">.</span><span class="ident" id="5703043">Unlock</span><span class="op" id="5703049">(</span><span class="op" id="5703050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5703054">return</span>&nbsp;<span class="ident" id="5703061">errors</span><span class="op" id="5703067">.</span><span class="ident" id="5703068">New</span><span class="op" id="5703071">(</span><span class="string" id="5703072">&#34;sql:&nbsp;duplicate&nbsp;driverConn&nbsp;close&#34;</span><span class="op" id="5703105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5703108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5703111">dc</span><span class="op" id="5703113">.</span><span class="ident" id="5703114">closed</span>&nbsp;<span class="op" id="5703121">=</span>&nbsp;<span class="builtintype" id="5703123">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5703129">dc</span><span class="op" id="5703131">.</span><span class="ident" id="5703132">Unlock</span><span class="op" id="5703138">(</span><span class="op" id="5703139">)</span>&nbsp;<span class="comment" id="5703141">//&nbsp;not&nbsp;defer;&nbsp;removeDep&nbsp;finalClose&nbsp;calls&nbsp;may&nbsp;need&nbsp;to&nbsp;lock</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5703201">//&nbsp;And&nbsp;now&nbsp;updates&nbsp;that&nbsp;require&nbsp;holding&nbsp;dc.mu.Lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5703254">dc</span><span class="op" id="5703256">.</span><span class="ident" id="5703257">db</span><span class="op" id="5703259">.</span><span class="ident" id="5703260">mu</span><span class="op" id="5703262">.</span><span class="ident" id="5703263">Lock</span><span class="op" id="5703267">(</span><span class="op" id="5703268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5703271">dc</span><span class="op" id="5703273">.</span><span class="ident" id="5703274">dbmuClosed</span>&nbsp;<span class="op" id="5703285">=</span>&nbsp;<span class="builtintype" id="5703287">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5703293">fn</span>&nbsp;<span class="op" id="5703296">:=</span>&nbsp;<span class="ident" id="5703299">dc</span><span class="op" id="5703301">.</span><span class="ident" id="5703302">db</span><span class="op" id="5703304">.</span><span class="ident" id="5703305">removeDepLocked</span><span class="op" id="5703320">(</span><span class="ident" id="5703321">dc</span><span class="op" id="5703323">,</span>&nbsp;<span class="ident" id="5703325">dc</span><span class="op" id="5703327">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5703330">dc</span><span class="op" id="5703332">.</span><span class="ident" id="5703333">db</span><span class="op" id="5703335">.</span><span class="ident" id="5703336">mu</span><span class="op" id="5703338">.</span><span class="ident" id="5703339">Unlock</span><span class="op" id="5703345">(</span><span class="op" id="5703346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5703349">return</span>&nbsp;<span class="ident" id="5703356">fn</span><span class="op" id="5703358">(</span><span class="op" id="5703359">)</span><br>
<span class="lineno"></span><span class="op" id="5703361">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5703364">func</span>&nbsp;<span class="op" id="5703369">(</span><span class="ident" id="5703370">dc</span>&nbsp;<span class="op" id="5703373">*</span><span class="ident" id="5703374">driverConn</span><span class="op" id="5703384">)</span>&nbsp;<span class="ident" id="5703386">finalClose</span><span class="op" id="5703396">(</span><span class="op" id="5703397">)</span>&nbsp;<span class="builtintype" id="5703399">error</span>&nbsp;<span class="op" id="5703405">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5703408">dc</span><span class="op" id="5703410">.</span><span class="ident" id="5703411">Lock</span><span class="op" id="5703415">(</span><span class="op" id="5703416">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5703420">for</span>&nbsp;<span class="ident" id="5703424">si</span>&nbsp;<span class="op" id="5703427">:=</span>&nbsp;<span class="keyword" id="5703430">range</span>&nbsp;<span class="ident" id="5703436">dc</span><span class="op" id="5703438">.</span><span class="ident" id="5703439">openStmt</span>&nbsp;<span class="op" id="5703448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5703452">si</span><span class="op" id="5703454">.</span><span class="ident" id="5703455">Close</span><span class="op" id="5703460">(</span><span class="op" id="5703461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5703464">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5703467">dc</span><span class="op" id="5703469">.</span><span class="ident" id="5703470">openStmt</span>&nbsp;<span class="op" id="5703479">=</span>&nbsp;<span class="ident" id="5703481">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5703487">err</span>&nbsp;<span class="op" id="5703491">:=</span>&nbsp;<span class="ident" id="5703494">dc</span><span class="op" id="5703496">.</span><span class="ident" id="5703497">ci</span><span class="op" id="5703499">.</span><span class="ident" id="5703500">Close</span><span class="op" id="5703505">(</span><span class="op" id="5703506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5703509">dc</span><span class="op" id="5703511">.</span><span class="ident" id="5703512">ci</span>&nbsp;<span class="op" id="5703515">=</span>&nbsp;<span class="ident" id="5703517">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5703522">dc</span><span class="op" id="5703524">.</span><span class="ident" id="5703525">finalClosed</span>&nbsp;<span class="op" id="5703537">=</span>&nbsp;<span class="builtintype" id="5703539">true</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5703545">dc</span><span class="op" id="5703547">.</span><span class="ident" id="5703548">Unlock</span><span class="op" id="5703554">(</span><span class="op" id="5703555">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5703559">dc</span><span class="op" id="5703561">.</span><span class="ident" id="5703562">db</span><span class="op" id="5703564">.</span><span class="ident" id="5703565">mu</span><span class="op" id="5703567">.</span><span class="ident" id="5703568">Lock</span><span class="op" id="5703572">(</span><span class="op" id="5703573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5703576">dc</span><span class="op" id="5703578">.</span><span class="ident" id="5703579">db</span><span class="op" id="5703581">.</span><span class="ident" id="5703582">numOpen</span><span class="op" id="5703589">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5703593">dc</span><span class="op" id="5703595">.</span><span class="ident" id="5703596">db</span><span class="op" id="5703598">.</span><span class="ident" id="5703599">maybeOpenNewConnections</span><span class="op" id="5703622">(</span><span class="op" id="5703623">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5703626">dc</span><span class="op" id="5703628">.</span><span class="ident" id="5703629">db</span><span class="op" id="5703631">.</span><span class="ident" id="5703632">mu</span><span class="op" id="5703634">.</span><span class="ident" id="5703635">Unlock</span><span class="op" id="5703641">(</span><span class="op" id="5703642">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5703646">return</span>&nbsp;<span class="ident" id="5703653">err</span><br>
<span class="lineno"></span><span class="op" id="5703657">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span><span class="comment" id="5703660">//&nbsp;driverStmt&nbsp;associates&nbsp;a&nbsp;driver.Stmt&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5703708">//&nbsp;*driverConn&nbsp;from&nbsp;which&nbsp;it&nbsp;came,&nbsp;so&nbsp;the&nbsp;driverConn&#39;s&nbsp;lock&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5703775">//&nbsp;held&nbsp;during&nbsp;calls.</span><br>
<span class="lineno"></span><span class="keyword" id="5703797">type</span>&nbsp;<span class="ident" id="5703802">driverStmt</span>&nbsp;<span class="keyword" id="5703813">struct</span>&nbsp;<span class="op" id="5703820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5703823">sync</span><span class="op" id="5703827">.</span><span class="ident" id="5703828">Locker</span>&nbsp;<span class="comment" id="5703835">//&nbsp;the&nbsp;*driverConn</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5703855">si</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5703867">driver</span><span class="op" id="5703873">.</span><span class="ident" id="5703874">Stmt</span><br>
<span class="lineno"></span><span class="op" id="5703879">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5703882">func</span>&nbsp;<span class="op" id="5703887">(</span><span class="ident" id="5703888">ds</span>&nbsp;<span class="op" id="5703891">*</span><span class="ident" id="5703892">driverStmt</span><span class="op" id="5703902">)</span>&nbsp;<span class="ident" id="5703904">Close</span><span class="op" id="5703909">(</span><span class="op" id="5703910">)</span>&nbsp;<span class="builtintype" id="5703912">error</span>&nbsp;<span class="op" id="5703918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5703921">ds</span><span class="op" id="5703923">.</span><span class="ident" id="5703924">Lock</span><span class="op" id="5703928">(</span><span class="op" id="5703929">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5703932">defer</span>&nbsp;<span class="ident" id="5703938">ds</span><span class="op" id="5703940">.</span><span class="ident" id="5703941">Unlock</span><span class="op" id="5703947">(</span><span class="op" id="5703948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5703951">return</span>&nbsp;<span class="ident" id="5703958">ds</span><span class="op" id="5703960">.</span><span class="ident" id="5703961">si</span><span class="op" id="5703963">.</span><span class="ident" id="5703964">Close</span><span class="op" id="5703969">(</span><span class="op" id="5703970">)</span><br>
<span class="lineno"></span><span class="op" id="5703972">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5703975">//&nbsp;depSet&nbsp;is&nbsp;a&nbsp;finalCloser&#39;s&nbsp;outstanding&nbsp;dependencies</span><br>
<span class="lineno">350</span><span class="keyword" id="5704029">type</span>&nbsp;<span class="ident" id="5704034">depSet</span>&nbsp;<span class="keyword" id="5704041">map</span><span class="op" id="5704044">[</span><span class="keyword" id="5704045">interface</span><span class="op" id="5704054">{</span><span class="op" id="5704055">}</span><span class="op" id="5704056">]</span><span class="builtintype" id="5704057">bool</span>&nbsp;<span class="comment" id="5704062">//&nbsp;set&nbsp;of&nbsp;true&nbsp;bools</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5704084">//&nbsp;The&nbsp;finalCloser&nbsp;interface&nbsp;is&nbsp;used&nbsp;by&nbsp;(*DB).addDep&nbsp;and&nbsp;related</span><br>
<span class="lineno"></span><span class="comment" id="5704149">//&nbsp;dependency&nbsp;reference&nbsp;counting.</span><br>
<span class="lineno"></span><span class="keyword" id="5704183">type</span>&nbsp;<span class="ident" id="5704188">finalCloser</span>&nbsp;<span class="keyword" id="5704200">interface</span>&nbsp;<span class="op" id="5704210">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5704213">//&nbsp;finalClose&nbsp;is&nbsp;called&nbsp;when&nbsp;the&nbsp;reference&nbsp;count&nbsp;of&nbsp;an&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5704276">//&nbsp;goes&nbsp;to&nbsp;zero.&nbsp;(*DB).mu&nbsp;is&nbsp;not&nbsp;held&nbsp;while&nbsp;calling&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5704333">finalClose</span><span class="op" id="5704343">(</span><span class="op" id="5704344">)</span>&nbsp;<span class="builtintype" id="5704346">error</span><br>
<span class="lineno"></span><span class="op" id="5704352">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span><span class="comment" id="5704355">//&nbsp;addDep&nbsp;notes&nbsp;that&nbsp;x&nbsp;now&nbsp;depends&nbsp;on&nbsp;dep,&nbsp;and&nbsp;x&#39;s&nbsp;finalClose&nbsp;won&#39;t&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5704426">//&nbsp;called&nbsp;until&nbsp;all&nbsp;of&nbsp;x&#39;s&nbsp;dependencies&nbsp;are&nbsp;removed&nbsp;with&nbsp;removeDep.</span><br>
<span class="lineno"></span><span class="keyword" id="5704494">func</span>&nbsp;<span class="op" id="5704499">(</span><span class="ident" id="5704500">db</span>&nbsp;<span class="op" id="5704503">*</span><span class="ident" id="5704504">DB</span><span class="op" id="5704506">)</span>&nbsp;<span class="ident" id="5704508">addDep</span><span class="op" id="5704514">(</span><span class="ident" id="5704515">x</span>&nbsp;<span class="ident" id="5704517">finalCloser</span><span class="op" id="5704528">,</span>&nbsp;<span class="ident" id="5704530">dep</span>&nbsp;<span class="keyword" id="5704534">interface</span><span class="op" id="5704543">{</span><span class="op" id="5704544">}</span><span class="op" id="5704545">)</span>&nbsp;<span class="op" id="5704547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5704550">//println(fmt.Sprintf(&#34;addDep(%T&nbsp;%p,&nbsp;%T&nbsp;%p)&#34;,&nbsp;x,&nbsp;x,&nbsp;dep,&nbsp;dep))</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5704614">db</span><span class="op" id="5704616">.</span><span class="ident" id="5704617">mu</span><span class="op" id="5704619">.</span><span class="ident" id="5704620">Lock</span><span class="op" id="5704624">(</span><span class="op" id="5704625">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5704628">defer</span>&nbsp;<span class="ident" id="5704634">db</span><span class="op" id="5704636">.</span><span class="ident" id="5704637">mu</span><span class="op" id="5704639">.</span><span class="ident" id="5704640">Unlock</span><span class="op" id="5704646">(</span><span class="op" id="5704647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5704650">db</span><span class="op" id="5704652">.</span><span class="ident" id="5704653">addDepLocked</span><span class="op" id="5704665">(</span><span class="ident" id="5704666">x</span><span class="op" id="5704667">,</span>&nbsp;<span class="ident" id="5704669">dep</span><span class="op" id="5704672">)</span><br>
<span class="lineno"></span><span class="op" id="5704674">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5704677">func</span>&nbsp;<span class="op" id="5704682">(</span><span class="ident" id="5704683">db</span>&nbsp;<span class="op" id="5704686">*</span><span class="ident" id="5704687">DB</span><span class="op" id="5704689">)</span>&nbsp;<span class="ident" id="5704691">addDepLocked</span><span class="op" id="5704703">(</span><span class="ident" id="5704704">x</span>&nbsp;<span class="ident" id="5704706">finalCloser</span><span class="op" id="5704717">,</span>&nbsp;<span class="ident" id="5704719">dep</span>&nbsp;<span class="keyword" id="5704723">interface</span><span class="op" id="5704732">{</span><span class="op" id="5704733">}</span><span class="op" id="5704734">)</span>&nbsp;<span class="op" id="5704736">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5704739">if</span>&nbsp;<span class="ident" id="5704742">db</span><span class="op" id="5704744">.</span><span class="ident" id="5704745">dep</span>&nbsp;<span class="op" id="5704749">==</span>&nbsp;<span class="ident" id="5704752">nil</span>&nbsp;<span class="op" id="5704756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5704760">db</span><span class="op" id="5704762">.</span><span class="ident" id="5704763">dep</span>&nbsp;<span class="op" id="5704767">=</span>&nbsp;<span class="builtinfunc" id="5704769">make</span><span class="op" id="5704773">(</span><span class="keyword" id="5704774">map</span><span class="op" id="5704777">[</span><span class="ident" id="5704778">finalCloser</span><span class="op" id="5704789">]</span><span class="ident" id="5704790">depSet</span><span class="op" id="5704796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5704799">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5704802">xdep</span>&nbsp;<span class="op" id="5704807">:=</span>&nbsp;<span class="ident" id="5704810">db</span><span class="op" id="5704812">.</span><span class="ident" id="5704813">dep</span><span class="op" id="5704816">[</span><span class="ident" id="5704817">x</span><span class="op" id="5704818">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5704821">if</span>&nbsp;<span class="ident" id="5704824">xdep</span>&nbsp;<span class="op" id="5704829">==</span>&nbsp;<span class="ident" id="5704832">nil</span>&nbsp;<span class="op" id="5704836">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5704840">xdep</span>&nbsp;<span class="op" id="5704845">=</span>&nbsp;<span class="builtinfunc" id="5704847">make</span><span class="op" id="5704851">(</span><span class="ident" id="5704852">depSet</span><span class="op" id="5704858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5704862">db</span><span class="op" id="5704864">.</span><span class="ident" id="5704865">dep</span><span class="op" id="5704868">[</span><span class="ident" id="5704869">x</span><span class="op" id="5704870">]</span>&nbsp;<span class="op" id="5704872">=</span>&nbsp;<span class="ident" id="5704874">xdep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5704880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5704883">xdep</span><span class="op" id="5704887">[</span><span class="ident" id="5704888">dep</span><span class="op" id="5704891">]</span>&nbsp;<span class="op" id="5704893">=</span>&nbsp;<span class="builtintype" id="5704895">true</span><br>
<span class="lineno"></span><span class="op" id="5704900">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span><span class="comment" id="5704903">//&nbsp;removeDep&nbsp;notes&nbsp;that&nbsp;x&nbsp;no&nbsp;longer&nbsp;depends&nbsp;on&nbsp;dep.</span><br>
<span class="lineno"></span><span class="comment" id="5704955">//&nbsp;If&nbsp;x&nbsp;still&nbsp;has&nbsp;dependencies,&nbsp;nil&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="comment" id="5705004">//&nbsp;If&nbsp;x&nbsp;no&nbsp;longer&nbsp;has&nbsp;any&nbsp;dependencies,&nbsp;its&nbsp;finalClose&nbsp;method&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5705074">//&nbsp;called&nbsp;and&nbsp;its&nbsp;error&nbsp;value&nbsp;will&nbsp;be&nbsp;returned.</span><br>
<span class="lineno">385</span><span class="keyword" id="5705122">func</span>&nbsp;<span class="op" id="5705127">(</span><span class="ident" id="5705128">db</span>&nbsp;<span class="op" id="5705131">*</span><span class="ident" id="5705132">DB</span><span class="op" id="5705134">)</span>&nbsp;<span class="ident" id="5705136">removeDep</span><span class="op" id="5705145">(</span><span class="ident" id="5705146">x</span>&nbsp;<span class="ident" id="5705148">finalCloser</span><span class="op" id="5705159">,</span>&nbsp;<span class="ident" id="5705161">dep</span>&nbsp;<span class="keyword" id="5705165">interface</span><span class="op" id="5705174">{</span><span class="op" id="5705175">}</span><span class="op" id="5705176">)</span>&nbsp;<span class="builtintype" id="5705178">error</span>&nbsp;<span class="op" id="5705184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5705187">db</span><span class="op" id="5705189">.</span><span class="ident" id="5705190">mu</span><span class="op" id="5705192">.</span><span class="ident" id="5705193">Lock</span><span class="op" id="5705197">(</span><span class="op" id="5705198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5705201">fn</span>&nbsp;<span class="op" id="5705204">:=</span>&nbsp;<span class="ident" id="5705207">db</span><span class="op" id="5705209">.</span><span class="ident" id="5705210">removeDepLocked</span><span class="op" id="5705225">(</span><span class="ident" id="5705226">x</span><span class="op" id="5705227">,</span>&nbsp;<span class="ident" id="5705229">dep</span><span class="op" id="5705232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5705235">db</span><span class="op" id="5705237">.</span><span class="ident" id="5705238">mu</span><span class="op" id="5705240">.</span><span class="ident" id="5705241">Unlock</span><span class="op" id="5705247">(</span><span class="op" id="5705248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5705251">return</span>&nbsp;<span class="ident" id="5705258">fn</span><span class="op" id="5705260">(</span><span class="op" id="5705261">)</span><br>
<span class="lineno">390</span><span class="op" id="5705263">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5705266">func</span>&nbsp;<span class="op" id="5705271">(</span><span class="ident" id="5705272">db</span>&nbsp;<span class="op" id="5705275">*</span><span class="ident" id="5705276">DB</span><span class="op" id="5705278">)</span>&nbsp;<span class="ident" id="5705280">removeDepLocked</span><span class="op" id="5705295">(</span><span class="ident" id="5705296">x</span>&nbsp;<span class="ident" id="5705298">finalCloser</span><span class="op" id="5705309">,</span>&nbsp;<span class="ident" id="5705311">dep</span>&nbsp;<span class="keyword" id="5705315">interface</span><span class="op" id="5705324">{</span><span class="op" id="5705325">}</span><span class="op" id="5705326">)</span>&nbsp;<span class="keyword" id="5705328">func</span><span class="op" id="5705332">(</span><span class="op" id="5705333">)</span>&nbsp;<span class="builtintype" id="5705335">error</span>&nbsp;<span class="op" id="5705341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5705344">//println(fmt.Sprintf(&#34;removeDep(%T&nbsp;%p,&nbsp;%T&nbsp;%p)&#34;,&nbsp;x,&nbsp;x,&nbsp;dep,&nbsp;dep))</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5705412">xdep</span><span class="op" id="5705416">,</span>&nbsp;<span class="ident" id="5705418">ok</span>&nbsp;<span class="op" id="5705421">:=</span>&nbsp;<span class="ident" id="5705424">db</span><span class="op" id="5705426">.</span><span class="ident" id="5705427">dep</span><span class="op" id="5705430">[</span><span class="ident" id="5705431">x</span><span class="op" id="5705432">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5705435">if</span>&nbsp;<span class="op" id="5705438">!</span><span class="ident" id="5705439">ok</span>&nbsp;<span class="op" id="5705442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5705446">panic</span><span class="op" id="5705451">(</span><span class="ident" id="5705452">fmt</span><span class="op" id="5705455">.</span><span class="ident" id="5705456">Sprintf</span><span class="op" id="5705463">(</span><span class="string" id="5705464">&#34;unpaired&nbsp;removeDep:&nbsp;no&nbsp;deps&nbsp;for&nbsp;%T&#34;</span><span class="op" id="5705500">,</span>&nbsp;<span class="ident" id="5705502">x</span><span class="op" id="5705503">)</span><span class="op" id="5705504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5705507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5705511">l0</span>&nbsp;<span class="op" id="5705514">:=</span>&nbsp;<span class="builtinfunc" id="5705517">len</span><span class="op" id="5705520">(</span><span class="ident" id="5705521">xdep</span><span class="op" id="5705525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5705528">delete</span><span class="op" id="5705534">(</span><span class="ident" id="5705535">xdep</span><span class="op" id="5705539">,</span>&nbsp;<span class="ident" id="5705541">dep</span><span class="op" id="5705544">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5705548">switch</span>&nbsp;<span class="builtinfunc" id="5705555">len</span><span class="op" id="5705558">(</span><span class="ident" id="5705559">xdep</span><span class="op" id="5705563">)</span>&nbsp;<span class="op" id="5705565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5705568">case</span>&nbsp;<span class="ident" id="5705573">l0</span><span class="op" id="5705575">:</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5705579">//&nbsp;Nothing&nbsp;removed.&nbsp;Shouldn&#39;t&nbsp;happen.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5705619">panic</span><span class="op" id="5705624">(</span><span class="ident" id="5705625">fmt</span><span class="op" id="5705628">.</span><span class="ident" id="5705629">Sprintf</span><span class="op" id="5705636">(</span><span class="string" id="5705637">&#34;unpaired&nbsp;removeDep:&nbsp;no&nbsp;%T&nbsp;dep&nbsp;on&nbsp;%T&#34;</span><span class="op" id="5705674">,</span>&nbsp;<span class="ident" id="5705676">dep</span><span class="op" id="5705679">,</span>&nbsp;<span class="ident" id="5705681">x</span><span class="op" id="5705682">)</span><span class="op" id="5705683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5705686">case</span>&nbsp;<span class="num" id="5705691">0</span><span class="op" id="5705692">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5705696">//&nbsp;No&nbsp;more&nbsp;dependencies.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5705723">delete</span><span class="op" id="5705729">(</span><span class="ident" id="5705730">db</span><span class="op" id="5705732">.</span><span class="ident" id="5705733">dep</span><span class="op" id="5705736">,</span>&nbsp;<span class="ident" id="5705738">x</span><span class="op" id="5705739">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5705743">return</span>&nbsp;<span class="ident" id="5705750">x</span><span class="op" id="5705751">.</span><span class="ident" id="5705752">finalClose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5705764">default</span><span class="op" id="5705771">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5705775">//&nbsp;Dependencies&nbsp;remain.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5705801">return</span>&nbsp;<span class="keyword" id="5705808">func</span><span class="op" id="5705812">(</span><span class="op" id="5705813">)</span>&nbsp;<span class="builtintype" id="5705815">error</span>&nbsp;<span class="op" id="5705821">{</span>&nbsp;<span class="keyword" id="5705823">return</span>&nbsp;<span class="ident" id="5705830">nil</span>&nbsp;<span class="op" id="5705834">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5705837">}</span><br>
<span class="lineno">415</span><span class="op" id="5705839">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5705842">//&nbsp;This&nbsp;is&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;connectionOpener&nbsp;request&nbsp;chan&nbsp;(dn.openerCh).</span><br>
<span class="lineno"></span><span class="comment" id="5705914">//&nbsp;This&nbsp;value&nbsp;should&nbsp;be&nbsp;larger&nbsp;than&nbsp;the&nbsp;maximum&nbsp;typical&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="5705976">//&nbsp;used&nbsp;for&nbsp;db.maxOpen.&nbsp;If&nbsp;maxOpen&nbsp;is&nbsp;significantly&nbsp;larger&nbsp;than</span><br>
<span class="lineno">420</span><span class="comment" id="5706040">//&nbsp;connectionRequestQueueSize&nbsp;then&nbsp;it&nbsp;is&nbsp;possible&nbsp;for&nbsp;ALL&nbsp;calls&nbsp;into&nbsp;the&nbsp;*DB</span><br>
<span class="lineno"></span><span class="comment" id="5706117">//&nbsp;to&nbsp;block&nbsp;until&nbsp;the&nbsp;connectionOpener&nbsp;can&nbsp;satisfy&nbsp;the&nbsp;backlog&nbsp;of&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="5706193">var</span>&nbsp;<span class="ident" id="5706197">connectionRequestQueueSize</span>&nbsp;<span class="op" id="5706224">=</span>&nbsp;<span class="num" id="5706226">1000000</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5706235">//&nbsp;Open&nbsp;opens&nbsp;a&nbsp;database&nbsp;specified&nbsp;by&nbsp;its&nbsp;database&nbsp;driver&nbsp;name&nbsp;and&nbsp;a</span><br>
<span class="lineno">425</span><span class="comment" id="5706304">//&nbsp;driver-specific&nbsp;data&nbsp;source&nbsp;name,&nbsp;usually&nbsp;consisting&nbsp;of&nbsp;at&nbsp;least&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5706374">//&nbsp;database&nbsp;name&nbsp;and&nbsp;connection&nbsp;information.</span><br>
<span class="lineno"></span><span class="comment" id="5706419">//</span><br>
<span class="lineno"></span><span class="comment" id="5706422">//&nbsp;Most&nbsp;users&nbsp;will&nbsp;open&nbsp;a&nbsp;database&nbsp;via&nbsp;a&nbsp;driver-specific&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="5706490">//&nbsp;helper&nbsp;function&nbsp;that&nbsp;returns&nbsp;a&nbsp;*DB.&nbsp;No&nbsp;database&nbsp;drivers&nbsp;are&nbsp;included</span><br>
<span class="lineno">430</span><span class="comment" id="5706562">//&nbsp;in&nbsp;the&nbsp;Go&nbsp;standard&nbsp;library.&nbsp;See&nbsp;http://golang.org/s/sqldrivers&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="5706632">//&nbsp;a&nbsp;list&nbsp;of&nbsp;third-party&nbsp;drivers.</span><br>
<span class="lineno"></span><span class="comment" id="5706666">//</span><br>
<span class="lineno"></span><span class="comment" id="5706669">//&nbsp;Open&nbsp;may&nbsp;just&nbsp;validate&nbsp;its&nbsp;arguments&nbsp;without&nbsp;creating&nbsp;a&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="5706739">//&nbsp;to&nbsp;the&nbsp;database.&nbsp;To&nbsp;verify&nbsp;that&nbsp;the&nbsp;data&nbsp;source&nbsp;name&nbsp;is&nbsp;valid,&nbsp;call</span><br>
<span class="lineno">435</span><span class="comment" id="5706810">//&nbsp;Ping.</span><br>
<span class="lineno"></span><span class="comment" id="5706819">//</span><br>
<span class="lineno"></span><span class="comment" id="5706822">//&nbsp;The&nbsp;returned&nbsp;DB&nbsp;is&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="5706891">//&nbsp;and&nbsp;maintains&nbsp;its&nbsp;own&nbsp;pool&nbsp;of&nbsp;idle&nbsp;connections.&nbsp;Thus,&nbsp;the&nbsp;Open</span><br>
<span class="lineno"></span><span class="comment" id="5706957">//&nbsp;function&nbsp;should&nbsp;be&nbsp;called&nbsp;just&nbsp;once.&nbsp;It&nbsp;is&nbsp;rarely&nbsp;necessary&nbsp;to</span><br>
<span class="lineno">440</span><span class="comment" id="5707023">//&nbsp;close&nbsp;a&nbsp;DB.</span><br>
<span class="lineno"></span><span class="keyword" id="5707038">func</span>&nbsp;<span class="ident" id="5707043">Open</span><span class="op" id="5707047">(</span><span class="ident" id="5707048">driverName</span><span class="op" id="5707058">,</span>&nbsp;<span class="ident" id="5707060">dataSourceName</span>&nbsp;<span class="builtintype" id="5707075">string</span><span class="op" id="5707081">)</span>&nbsp;<span class="op" id="5707083">(</span><span class="op" id="5707084">*</span><span class="ident" id="5707085">DB</span><span class="op" id="5707087">,</span>&nbsp;<span class="builtintype" id="5707089">error</span><span class="op" id="5707094">)</span>&nbsp;<span class="op" id="5707096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5707099">driveri</span><span class="op" id="5707106">,</span>&nbsp;<span class="ident" id="5707108">ok</span>&nbsp;<span class="op" id="5707111">:=</span>&nbsp;<span class="ident" id="5707114">drivers</span><span class="op" id="5707121">[</span><span class="ident" id="5707122">driverName</span><span class="op" id="5707132">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5707135">if</span>&nbsp;<span class="op" id="5707138">!</span><span class="ident" id="5707139">ok</span>&nbsp;<span class="op" id="5707142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5707146">return</span>&nbsp;<span class="ident" id="5707153">nil</span><span class="op" id="5707156">,</span>&nbsp;<span class="ident" id="5707158">fmt</span><span class="op" id="5707161">.</span><span class="ident" id="5707162">Errorf</span><span class="op" id="5707168">(</span><span class="string" id="5707169">&#34;sql:&nbsp;unknown&nbsp;driver&nbsp;%q&nbsp;(forgotten&nbsp;import?)&#34;</span><span class="op" id="5707213">,</span>&nbsp;<span class="ident" id="5707215">driverName</span><span class="op" id="5707225">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5707228">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5707231">db</span>&nbsp;<span class="op" id="5707234">:=</span>&nbsp;<span class="op" id="5707237">&amp;</span><span class="ident" id="5707238">DB</span><span class="op" id="5707240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5707244">driver</span><span class="op" id="5707250">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5707254">driveri</span><span class="op" id="5707261">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5707265">dsn</span><span class="op" id="5707268">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5707275">dataSourceName</span><span class="op" id="5707289">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5707293">openerCh</span><span class="op" id="5707301">:</span>&nbsp;<span class="builtinfunc" id="5707303">make</span><span class="op" id="5707307">(</span><span class="keyword" id="5707308">chan</span>&nbsp;<span class="keyword" id="5707313">struct</span><span class="op" id="5707319">{</span><span class="op" id="5707320">}</span><span class="op" id="5707321">,</span>&nbsp;<span class="ident" id="5707323">connectionRequestQueueSize</span><span class="op" id="5707349">)</span><span class="op" id="5707350">,</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5707354">lastPut</span><span class="op" id="5707361">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="5707364">make</span><span class="op" id="5707368">(</span><span class="keyword" id="5707369">map</span><span class="op" id="5707372">[</span><span class="op" id="5707373">*</span><span class="ident" id="5707374">driverConn</span><span class="op" id="5707384">]</span><span class="builtintype" id="5707385">string</span><span class="op" id="5707391">)</span><span class="op" id="5707392">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5707395">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5707398">go</span>&nbsp;<span class="ident" id="5707401">db</span><span class="op" id="5707403">.</span><span class="ident" id="5707404">connectionOpener</span><span class="op" id="5707420">(</span><span class="op" id="5707421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5707424">return</span>&nbsp;<span class="ident" id="5707431">db</span><span class="op" id="5707433">,</span>&nbsp;<span class="ident" id="5707435">nil</span><br>
<span class="lineno"></span><span class="op" id="5707439">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span><span class="comment" id="5707442">//&nbsp;Ping&nbsp;verifies&nbsp;a&nbsp;connection&nbsp;to&nbsp;the&nbsp;database&nbsp;is&nbsp;still&nbsp;alive,</span><br>
<span class="lineno"></span><span class="comment" id="5707504">//&nbsp;establishing&nbsp;a&nbsp;connection&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="5707547">func</span>&nbsp;<span class="op" id="5707552">(</span><span class="ident" id="5707553">db</span>&nbsp;<span class="op" id="5707556">*</span><span class="ident" id="5707557">DB</span><span class="op" id="5707559">)</span>&nbsp;<span class="ident" id="5707561">Ping</span><span class="op" id="5707565">(</span><span class="op" id="5707566">)</span>&nbsp;<span class="builtintype" id="5707568">error</span>&nbsp;<span class="op" id="5707574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5707577">//&nbsp;TODO(bradfitz):&nbsp;give&nbsp;drivers&nbsp;an&nbsp;optional&nbsp;hook&nbsp;to&nbsp;implement</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5707640">//&nbsp;this&nbsp;in&nbsp;a&nbsp;more&nbsp;efficient&nbsp;or&nbsp;more&nbsp;reliable&nbsp;way,&nbsp;if&nbsp;they</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5707699">//&nbsp;have&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5707713">dc</span><span class="op" id="5707715">,</span>&nbsp;<span class="ident" id="5707717">err</span>&nbsp;<span class="op" id="5707721">:=</span>&nbsp;<span class="ident" id="5707724">db</span><span class="op" id="5707726">.</span><span class="ident" id="5707727">conn</span><span class="op" id="5707731">(</span><span class="op" id="5707732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5707735">if</span>&nbsp;<span class="ident" id="5707738">err</span>&nbsp;<span class="op" id="5707742">!=</span>&nbsp;<span class="ident" id="5707745">nil</span>&nbsp;<span class="op" id="5707749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5707753">return</span>&nbsp;<span class="ident" id="5707760">err</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5707765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5707768">db</span><span class="op" id="5707770">.</span><span class="ident" id="5707771">putConn</span><span class="op" id="5707778">(</span><span class="ident" id="5707779">dc</span><span class="op" id="5707781">,</span>&nbsp;<span class="ident" id="5707783">nil</span><span class="op" id="5707786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5707789">return</span>&nbsp;<span class="ident" id="5707796">nil</span><br>
<span class="lineno"></span><span class="op" id="5707800">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">470</span><span class="comment" id="5707803">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;database,&nbsp;releasing&nbsp;any&nbsp;open&nbsp;resources.</span><br>
<span class="lineno"></span><span class="comment" id="5707863">//</span><br>
<span class="lineno"></span><span class="comment" id="5707866">//&nbsp;It&nbsp;is&nbsp;rare&nbsp;to&nbsp;Close&nbsp;a&nbsp;DB,&nbsp;as&nbsp;the&nbsp;DB&nbsp;handle&nbsp;is&nbsp;meant&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5707927">//&nbsp;long-lived&nbsp;and&nbsp;shared&nbsp;between&nbsp;many&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="5707977">func</span>&nbsp;<span class="op" id="5707982">(</span><span class="ident" id="5707983">db</span>&nbsp;<span class="op" id="5707986">*</span><span class="ident" id="5707987">DB</span><span class="op" id="5707989">)</span>&nbsp;<span class="ident" id="5707991">Close</span><span class="op" id="5707996">(</span><span class="op" id="5707997">)</span>&nbsp;<span class="builtintype" id="5707999">error</span>&nbsp;<span class="op" id="5708005">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5708008">db</span><span class="op" id="5708010">.</span><span class="ident" id="5708011">mu</span><span class="op" id="5708013">.</span><span class="ident" id="5708014">Lock</span><span class="op" id="5708018">(</span><span class="op" id="5708019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5708022">if</span>&nbsp;<span class="ident" id="5708025">db</span><span class="op" id="5708027">.</span><span class="ident" id="5708028">closed</span>&nbsp;<span class="op" id="5708035">{</span>&nbsp;<span class="comment" id="5708037">//&nbsp;Make&nbsp;DB.Close&nbsp;idempotent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5708067">db</span><span class="op" id="5708069">.</span><span class="ident" id="5708070">mu</span><span class="op" id="5708072">.</span><span class="ident" id="5708073">Unlock</span><span class="op" id="5708079">(</span><span class="op" id="5708080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5708084">return</span>&nbsp;<span class="ident" id="5708091">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5708096">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5708099">close</span><span class="op" id="5708104">(</span><span class="ident" id="5708105">db</span><span class="op" id="5708107">.</span><span class="ident" id="5708108">openerCh</span><span class="op" id="5708116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5708119">var</span>&nbsp;<span class="ident" id="5708123">err</span>&nbsp;<span class="builtintype" id="5708127">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5708134">fns</span>&nbsp;<span class="op" id="5708138">:=</span>&nbsp;<span class="builtinfunc" id="5708141">make</span><span class="op" id="5708145">(</span><span class="op" id="5708146">[</span><span class="op" id="5708147">]</span><span class="keyword" id="5708148">func</span><span class="op" id="5708152">(</span><span class="op" id="5708153">)</span>&nbsp;<span class="builtintype" id="5708155">error</span><span class="op" id="5708160">,</span>&nbsp;<span class="num" id="5708162">0</span><span class="op" id="5708163">,</span>&nbsp;<span class="builtinfunc" id="5708165">len</span><span class="op" id="5708168">(</span><span class="ident" id="5708169">db</span><span class="op" id="5708171">.</span><span class="ident" id="5708172">freeConn</span><span class="op" id="5708180">)</span><span class="op" id="5708181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5708184">for</span>&nbsp;<span class="ident" id="5708188">_</span><span class="op" id="5708189">,</span>&nbsp;<span class="ident" id="5708191">dc</span>&nbsp;<span class="op" id="5708194">:=</span>&nbsp;<span class="keyword" id="5708197">range</span>&nbsp;<span class="ident" id="5708203">db</span><span class="op" id="5708205">.</span><span class="ident" id="5708206">freeConn</span>&nbsp;<span class="op" id="5708215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5708219">fns</span>&nbsp;<span class="op" id="5708223">=</span>&nbsp;<span class="builtinfunc" id="5708225">append</span><span class="op" id="5708231">(</span><span class="ident" id="5708232">fns</span><span class="op" id="5708235">,</span>&nbsp;<span class="ident" id="5708237">dc</span><span class="op" id="5708239">.</span><span class="ident" id="5708240">closeDBLocked</span><span class="op" id="5708253">(</span><span class="op" id="5708254">)</span><span class="op" id="5708255">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5708258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5708261">db</span><span class="op" id="5708263">.</span><span class="ident" id="5708264">freeConn</span>&nbsp;<span class="op" id="5708273">=</span>&nbsp;<span class="ident" id="5708275">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5708280">db</span><span class="op" id="5708282">.</span><span class="ident" id="5708283">closed</span>&nbsp;<span class="op" id="5708290">=</span>&nbsp;<span class="builtintype" id="5708292">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5708298">for</span>&nbsp;<span class="ident" id="5708302">_</span><span class="op" id="5708303">,</span>&nbsp;<span class="ident" id="5708305">req</span>&nbsp;<span class="op" id="5708309">:=</span>&nbsp;<span class="keyword" id="5708312">range</span>&nbsp;<span class="ident" id="5708318">db</span><span class="op" id="5708320">.</span><span class="ident" id="5708321">connRequests</span>&nbsp;<span class="op" id="5708334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5708338">close</span><span class="op" id="5708343">(</span><span class="ident" id="5708344">req</span><span class="op" id="5708347">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5708350">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5708353">db</span><span class="op" id="5708355">.</span><span class="ident" id="5708356">mu</span><span class="op" id="5708358">.</span><span class="ident" id="5708359">Unlock</span><span class="op" id="5708365">(</span><span class="op" id="5708366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5708369">for</span>&nbsp;<span class="ident" id="5708373">_</span><span class="op" id="5708374">,</span>&nbsp;<span class="ident" id="5708376">fn</span>&nbsp;<span class="op" id="5708379">:=</span>&nbsp;<span class="keyword" id="5708382">range</span>&nbsp;<span class="ident" id="5708388">fns</span>&nbsp;<span class="op" id="5708392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5708396">err1</span>&nbsp;<span class="op" id="5708401">:=</span>&nbsp;<span class="ident" id="5708404">fn</span><span class="op" id="5708406">(</span><span class="op" id="5708407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5708411">if</span>&nbsp;<span class="ident" id="5708414">err1</span>&nbsp;<span class="op" id="5708419">!=</span>&nbsp;<span class="ident" id="5708422">nil</span>&nbsp;<span class="op" id="5708426">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5708431">err</span>&nbsp;<span class="op" id="5708435">=</span>&nbsp;<span class="ident" id="5708437">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5708444">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5708447">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5708450">return</span>&nbsp;<span class="ident" id="5708457">err</span><br>
<span class="lineno"></span><span class="op" id="5708461">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="keyword" id="5708464">const</span>&nbsp;<span class="ident" id="5708470">defaultMaxIdleConns</span>&nbsp;<span class="op" id="5708490">=</span>&nbsp;<span class="num" id="5708492">2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5708495">func</span>&nbsp;<span class="op" id="5708500">(</span><span class="ident" id="5708501">db</span>&nbsp;<span class="op" id="5708504">*</span><span class="ident" id="5708505">DB</span><span class="op" id="5708507">)</span>&nbsp;<span class="ident" id="5708509">maxIdleConnsLocked</span><span class="op" id="5708527">(</span><span class="op" id="5708528">)</span>&nbsp;<span class="builtintype" id="5708530">int</span>&nbsp;<span class="op" id="5708534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5708537">n</span>&nbsp;<span class="op" id="5708539">:=</span>&nbsp;<span class="ident" id="5708542">db</span><span class="op" id="5708544">.</span><span class="ident" id="5708545">maxIdle</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5708554">switch</span>&nbsp;<span class="op" id="5708561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5708564">case</span>&nbsp;<span class="ident" id="5708569">n</span>&nbsp;<span class="op" id="5708571">==</span>&nbsp;<span class="num" id="5708574">0</span><span class="op" id="5708575">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5708579">//&nbsp;TODO(bradfitz):&nbsp;ask&nbsp;driver,&nbsp;if&nbsp;supported,&nbsp;for&nbsp;its&nbsp;default&nbsp;preference</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5708653">return</span>&nbsp;<span class="ident" id="5708660">defaultMaxIdleConns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5708681">case</span>&nbsp;<span class="ident" id="5708686">n</span>&nbsp;<span class="op" id="5708688">&lt;</span>&nbsp;<span class="num" id="5708690">0</span><span class="op" id="5708691">:</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5708695">return</span>&nbsp;<span class="num" id="5708702">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5708705">default</span><span class="op" id="5708712">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5708716">return</span>&nbsp;<span class="ident" id="5708723">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5708726">}</span><br>
<span class="lineno"></span><span class="op" id="5708728">}</span><br>
<span class="lineno">515</span><br>
<span class="lineno"></span><span class="comment" id="5708731">//&nbsp;SetMaxIdleConns&nbsp;sets&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;connections&nbsp;in&nbsp;the&nbsp;idle</span><br>
<span class="lineno"></span><span class="comment" id="5708801">//&nbsp;connection&nbsp;pool.</span><br>
<span class="lineno"></span><span class="comment" id="5708821">//</span><br>
<span class="lineno"></span><span class="comment" id="5708824">//&nbsp;If&nbsp;MaxOpenConns&nbsp;is&nbsp;greater&nbsp;than&nbsp;0&nbsp;but&nbsp;less&nbsp;than&nbsp;the&nbsp;new&nbsp;MaxIdleConns</span><br>
<span class="lineno">520</span><span class="comment" id="5708896">//&nbsp;then&nbsp;the&nbsp;new&nbsp;MaxIdleConns&nbsp;will&nbsp;be&nbsp;reduced&nbsp;to&nbsp;match&nbsp;the&nbsp;MaxOpenConns&nbsp;limit</span><br>
<span class="lineno"></span><span class="comment" id="5708973">//</span><br>
<span class="lineno"></span><span class="comment" id="5708976">//&nbsp;If&nbsp;n&nbsp;&lt;=&nbsp;0,&nbsp;no&nbsp;idle&nbsp;connections&nbsp;are&nbsp;retained.</span><br>
<span class="lineno"></span><span class="keyword" id="5709024">func</span>&nbsp;<span class="op" id="5709029">(</span><span class="ident" id="5709030">db</span>&nbsp;<span class="op" id="5709033">*</span><span class="ident" id="5709034">DB</span><span class="op" id="5709036">)</span>&nbsp;<span class="ident" id="5709038">SetMaxIdleConns</span><span class="op" id="5709053">(</span><span class="ident" id="5709054">n</span>&nbsp;<span class="builtintype" id="5709056">int</span><span class="op" id="5709059">)</span>&nbsp;<span class="op" id="5709061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5709064">db</span><span class="op" id="5709066">.</span><span class="ident" id="5709067">mu</span><span class="op" id="5709069">.</span><span class="ident" id="5709070">Lock</span><span class="op" id="5709074">(</span><span class="op" id="5709075">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5709078">if</span>&nbsp;<span class="ident" id="5709081">n</span>&nbsp;<span class="op" id="5709083">&gt;</span>&nbsp;<span class="num" id="5709085">0</span>&nbsp;<span class="op" id="5709087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5709091">db</span><span class="op" id="5709093">.</span><span class="ident" id="5709094">maxIdle</span>&nbsp;<span class="op" id="5709102">=</span>&nbsp;<span class="ident" id="5709104">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5709107">}</span>&nbsp;<span class="keyword" id="5709109">else</span>&nbsp;<span class="op" id="5709114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5709118">//&nbsp;No&nbsp;idle&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5709144">db</span><span class="op" id="5709146">.</span><span class="ident" id="5709147">maxIdle</span>&nbsp;<span class="op" id="5709155">=</span>&nbsp;<span class="op" id="5709157">-</span><span class="num" id="5709158">1</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5709161">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5709164">//&nbsp;Make&nbsp;sure&nbsp;maxIdle&nbsp;doesn&#39;t&nbsp;exceed&nbsp;maxOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5709209">if</span>&nbsp;<span class="ident" id="5709212">db</span><span class="op" id="5709214">.</span><span class="ident" id="5709215">maxOpen</span>&nbsp;<span class="op" id="5709223">&gt;</span>&nbsp;<span class="num" id="5709225">0</span>&nbsp;<span class="op" id="5709227">&amp;&amp;</span>&nbsp;<span class="ident" id="5709230">db</span><span class="op" id="5709232">.</span><span class="ident" id="5709233">maxIdleConnsLocked</span><span class="op" id="5709251">(</span><span class="op" id="5709252">)</span>&nbsp;<span class="op" id="5709254">&gt;</span>&nbsp;<span class="ident" id="5709256">db</span><span class="op" id="5709258">.</span><span class="ident" id="5709259">maxOpen</span>&nbsp;<span class="op" id="5709267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5709271">db</span><span class="op" id="5709273">.</span><span class="ident" id="5709274">maxIdle</span>&nbsp;<span class="op" id="5709282">=</span>&nbsp;<span class="ident" id="5709284">db</span><span class="op" id="5709286">.</span><span class="ident" id="5709287">maxOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5709296">}</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5709299">var</span>&nbsp;<span class="ident" id="5709303">closing</span>&nbsp;<span class="op" id="5709311">[</span><span class="op" id="5709312">]</span><span class="op" id="5709313">*</span><span class="ident" id="5709314">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5709326">idleCount</span>&nbsp;<span class="op" id="5709336">:=</span>&nbsp;<span class="builtinfunc" id="5709339">len</span><span class="op" id="5709342">(</span><span class="ident" id="5709343">db</span><span class="op" id="5709345">.</span><span class="ident" id="5709346">freeConn</span><span class="op" id="5709354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5709357">maxIdle</span>&nbsp;<span class="op" id="5709365">:=</span>&nbsp;<span class="ident" id="5709368">db</span><span class="op" id="5709370">.</span><span class="ident" id="5709371">maxIdleConnsLocked</span><span class="op" id="5709389">(</span><span class="op" id="5709390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5709393">if</span>&nbsp;<span class="ident" id="5709396">idleCount</span>&nbsp;<span class="op" id="5709406">&gt;</span>&nbsp;<span class="ident" id="5709408">maxIdle</span>&nbsp;<span class="op" id="5709416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5709420">closing</span>&nbsp;<span class="op" id="5709428">=</span>&nbsp;<span class="ident" id="5709430">db</span><span class="op" id="5709432">.</span><span class="ident" id="5709433">freeConn</span><span class="op" id="5709441">[</span><span class="ident" id="5709442">maxIdle</span><span class="op" id="5709449">:</span><span class="op" id="5709450">]</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5709454">db</span><span class="op" id="5709456">.</span><span class="ident" id="5709457">freeConn</span>&nbsp;<span class="op" id="5709466">=</span>&nbsp;<span class="ident" id="5709468">db</span><span class="op" id="5709470">.</span><span class="ident" id="5709471">freeConn</span><span class="op" id="5709479">[</span><span class="op" id="5709480">:</span><span class="ident" id="5709481">maxIdle</span><span class="op" id="5709488">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5709491">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5709494">db</span><span class="op" id="5709496">.</span><span class="ident" id="5709497">mu</span><span class="op" id="5709499">.</span><span class="ident" id="5709500">Unlock</span><span class="op" id="5709506">(</span><span class="op" id="5709507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5709510">for</span>&nbsp;<span class="ident" id="5709514">_</span><span class="op" id="5709515">,</span>&nbsp;<span class="ident" id="5709517">c</span>&nbsp;<span class="op" id="5709519">:=</span>&nbsp;<span class="keyword" id="5709522">range</span>&nbsp;<span class="ident" id="5709528">closing</span>&nbsp;<span class="op" id="5709536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5709540">c</span><span class="op" id="5709541">.</span><span class="ident" id="5709542">Close</span><span class="op" id="5709547">(</span><span class="op" id="5709548">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5709551">}</span><br>
<span class="lineno"></span><span class="op" id="5709553">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5709556">//&nbsp;SetMaxOpenConns&nbsp;sets&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;open&nbsp;connections&nbsp;to&nbsp;the&nbsp;database.</span><br>
<span class="lineno"></span><span class="comment" id="5709636">//</span><br>
<span class="lineno">550</span><span class="comment" id="5709639">//&nbsp;If&nbsp;MaxIdleConns&nbsp;is&nbsp;greater&nbsp;than&nbsp;0&nbsp;and&nbsp;the&nbsp;new&nbsp;MaxOpenConns&nbsp;is&nbsp;less&nbsp;than</span><br>
<span class="lineno"></span><span class="comment" id="5709714">//&nbsp;MaxIdleConns,&nbsp;then&nbsp;MaxIdleConns&nbsp;will&nbsp;be&nbsp;reduced&nbsp;to&nbsp;match&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="5709782">//&nbsp;MaxOpenConns&nbsp;limit</span><br>
<span class="lineno"></span><span class="comment" id="5709804">//</span><br>
<span class="lineno"></span><span class="comment" id="5709807">//&nbsp;If&nbsp;n&nbsp;&lt;=&nbsp;0,&nbsp;then&nbsp;there&nbsp;is&nbsp;no&nbsp;limit&nbsp;on&nbsp;the&nbsp;number&nbsp;of&nbsp;open&nbsp;connections.</span><br>
<span class="lineno">555</span><span class="comment" id="5709879">//&nbsp;The&nbsp;default&nbsp;is&nbsp;0&nbsp;(unlimited).</span><br>
<span class="lineno"></span><span class="keyword" id="5709912">func</span>&nbsp;<span class="op" id="5709917">(</span><span class="ident" id="5709918">db</span>&nbsp;<span class="op" id="5709921">*</span><span class="ident" id="5709922">DB</span><span class="op" id="5709924">)</span>&nbsp;<span class="ident" id="5709926">SetMaxOpenConns</span><span class="op" id="5709941">(</span><span class="ident" id="5709942">n</span>&nbsp;<span class="builtintype" id="5709944">int</span><span class="op" id="5709947">)</span>&nbsp;<span class="op" id="5709949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5709952">db</span><span class="op" id="5709954">.</span><span class="ident" id="5709955">mu</span><span class="op" id="5709957">.</span><span class="ident" id="5709958">Lock</span><span class="op" id="5709962">(</span><span class="op" id="5709963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5709966">db</span><span class="op" id="5709968">.</span><span class="ident" id="5709969">maxOpen</span>&nbsp;<span class="op" id="5709977">=</span>&nbsp;<span class="ident" id="5709979">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5709982">if</span>&nbsp;<span class="ident" id="5709985">n</span>&nbsp;<span class="op" id="5709987">&lt;</span>&nbsp;<span class="num" id="5709989">0</span>&nbsp;<span class="op" id="5709991">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5709995">db</span><span class="op" id="5709997">.</span><span class="ident" id="5709998">maxOpen</span>&nbsp;<span class="op" id="5710006">=</span>&nbsp;<span class="num" id="5710008">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5710011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5710014">syncMaxIdle</span>&nbsp;<span class="op" id="5710026">:=</span>&nbsp;<span class="ident" id="5710029">db</span><span class="op" id="5710031">.</span><span class="ident" id="5710032">maxOpen</span>&nbsp;<span class="op" id="5710040">&gt;</span>&nbsp;<span class="num" id="5710042">0</span>&nbsp;<span class="op" id="5710044">&amp;&amp;</span>&nbsp;<span class="ident" id="5710047">db</span><span class="op" id="5710049">.</span><span class="ident" id="5710050">maxIdleConnsLocked</span><span class="op" id="5710068">(</span><span class="op" id="5710069">)</span>&nbsp;<span class="op" id="5710071">&gt;</span>&nbsp;<span class="ident" id="5710073">db</span><span class="op" id="5710075">.</span><span class="ident" id="5710076">maxOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5710085">db</span><span class="op" id="5710087">.</span><span class="ident" id="5710088">mu</span><span class="op" id="5710090">.</span><span class="ident" id="5710091">Unlock</span><span class="op" id="5710097">(</span><span class="op" id="5710098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5710101">if</span>&nbsp;<span class="ident" id="5710104">syncMaxIdle</span>&nbsp;<span class="op" id="5710116">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5710120">db</span><span class="op" id="5710122">.</span><span class="ident" id="5710123">SetMaxIdleConns</span><span class="op" id="5710138">(</span><span class="ident" id="5710139">n</span><span class="op" id="5710140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5710143">}</span><br>
<span class="lineno"></span><span class="op" id="5710145">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5710148">//&nbsp;Assumes&nbsp;db.mu&nbsp;is&nbsp;locked.</span><br>
<span class="lineno">570</span><span class="comment" id="5710176">//&nbsp;If&nbsp;there&nbsp;are&nbsp;connRequests&nbsp;and&nbsp;the&nbsp;connection&nbsp;limit&nbsp;hasn&#39;t&nbsp;been&nbsp;reached,</span><br>
<span class="lineno"></span><span class="comment" id="5710251">//&nbsp;then&nbsp;tell&nbsp;the&nbsp;connectionOpener&nbsp;to&nbsp;open&nbsp;new&nbsp;connections.</span><br>
<span class="lineno"></span><span class="keyword" id="5710310">func</span>&nbsp;<span class="op" id="5710315">(</span><span class="ident" id="5710316">db</span>&nbsp;<span class="op" id="5710319">*</span><span class="ident" id="5710320">DB</span><span class="op" id="5710322">)</span>&nbsp;<span class="ident" id="5710324">maybeOpenNewConnections</span><span class="op" id="5710347">(</span><span class="op" id="5710348">)</span>&nbsp;<span class="op" id="5710350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5710353">numRequests</span>&nbsp;<span class="op" id="5710365">:=</span>&nbsp;<span class="builtinfunc" id="5710368">len</span><span class="op" id="5710371">(</span><span class="ident" id="5710372">db</span><span class="op" id="5710374">.</span><span class="ident" id="5710375">connRequests</span><span class="op" id="5710387">)</span>&nbsp;<span class="op" id="5710389">-</span>&nbsp;<span class="ident" id="5710391">db</span><span class="op" id="5710393">.</span><span class="ident" id="5710394">pendingOpens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5710408">if</span>&nbsp;<span class="ident" id="5710411">db</span><span class="op" id="5710413">.</span><span class="ident" id="5710414">maxOpen</span>&nbsp;<span class="op" id="5710422">&gt;</span>&nbsp;<span class="num" id="5710424">0</span>&nbsp;<span class="op" id="5710426">{</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5710430">numCanOpen</span>&nbsp;<span class="op" id="5710441">:=</span>&nbsp;<span class="ident" id="5710444">db</span><span class="op" id="5710446">.</span><span class="ident" id="5710447">maxOpen</span>&nbsp;<span class="op" id="5710455">-</span>&nbsp;<span class="op" id="5710457">(</span><span class="ident" id="5710458">db</span><span class="op" id="5710460">.</span><span class="ident" id="5710461">numOpen</span>&nbsp;<span class="op" id="5710469">+</span>&nbsp;<span class="ident" id="5710471">db</span><span class="op" id="5710473">.</span><span class="ident" id="5710474">pendingOpens</span><span class="op" id="5710486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5710490">if</span>&nbsp;<span class="ident" id="5710493">numRequests</span>&nbsp;<span class="op" id="5710505">&gt;</span>&nbsp;<span class="ident" id="5710507">numCanOpen</span>&nbsp;<span class="op" id="5710518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5710523">numRequests</span>&nbsp;<span class="op" id="5710535">=</span>&nbsp;<span class="ident" id="5710537">numCanOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5710550">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5710553">}</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5710556">for</span>&nbsp;<span class="ident" id="5710560">numRequests</span>&nbsp;<span class="op" id="5710572">&gt;</span>&nbsp;<span class="num" id="5710574">0</span>&nbsp;<span class="op" id="5710576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5710580">db</span><span class="op" id="5710582">.</span><span class="ident" id="5710583">pendingOpens</span><span class="op" id="5710595">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5710600">numRequests</span><span class="op" id="5710611">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5710616">db</span><span class="op" id="5710618">.</span><span class="ident" id="5710619">openerCh</span>&nbsp;<span class="op" id="5710628">&lt;-</span>&nbsp;<span class="keyword" id="5710631">struct</span><span class="op" id="5710637">{</span><span class="op" id="5710638">}</span><span class="op" id="5710639">{</span><span class="op" id="5710640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5710643">}</span><br>
<span class="lineno">585</span><span class="op" id="5710645">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5710648">//&nbsp;Runs&nbsp;in&nbsp;a&nbsp;separate&nbsp;goroutine,&nbsp;opens&nbsp;new&nbsp;connections&nbsp;when&nbsp;requested.</span><br>
<span class="lineno"></span><span class="keyword" id="5710719">func</span>&nbsp;<span class="op" id="5710724">(</span><span class="ident" id="5710725">db</span>&nbsp;<span class="op" id="5710728">*</span><span class="ident" id="5710729">DB</span><span class="op" id="5710731">)</span>&nbsp;<span class="ident" id="5710733">connectionOpener</span><span class="op" id="5710749">(</span><span class="op" id="5710750">)</span>&nbsp;<span class="op" id="5710752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5710755">for</span>&nbsp;<span class="keyword" id="5710759">range</span>&nbsp;<span class="ident" id="5710765">db</span><span class="op" id="5710767">.</span><span class="ident" id="5710768">openerCh</span>&nbsp;<span class="op" id="5710777">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5710781">db</span><span class="op" id="5710783">.</span><span class="ident" id="5710784">openNewConnection</span><span class="op" id="5710801">(</span><span class="op" id="5710802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5710805">}</span><br>
<span class="lineno"></span><span class="op" id="5710807">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5710810">//&nbsp;Open&nbsp;one&nbsp;new&nbsp;connection</span><br>
<span class="lineno">595</span><span class="keyword" id="5710837">func</span>&nbsp;<span class="op" id="5710842">(</span><span class="ident" id="5710843">db</span>&nbsp;<span class="op" id="5710846">*</span><span class="ident" id="5710847">DB</span><span class="op" id="5710849">)</span>&nbsp;<span class="ident" id="5710851">openNewConnection</span><span class="op" id="5710868">(</span><span class="op" id="5710869">)</span>&nbsp;<span class="op" id="5710871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5710874">ci</span><span class="op" id="5710876">,</span>&nbsp;<span class="ident" id="5710878">err</span>&nbsp;<span class="op" id="5710882">:=</span>&nbsp;<span class="ident" id="5710885">db</span><span class="op" id="5710887">.</span><span class="ident" id="5710888">driver</span><span class="op" id="5710894">.</span><span class="ident" id="5710895">Open</span><span class="op" id="5710899">(</span><span class="ident" id="5710900">db</span><span class="op" id="5710902">.</span><span class="ident" id="5710903">dsn</span><span class="op" id="5710906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5710909">db</span><span class="op" id="5710911">.</span><span class="ident" id="5710912">mu</span><span class="op" id="5710914">.</span><span class="ident" id="5710915">Lock</span><span class="op" id="5710919">(</span><span class="op" id="5710920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5710923">defer</span>&nbsp;<span class="ident" id="5710929">db</span><span class="op" id="5710931">.</span><span class="ident" id="5710932">mu</span><span class="op" id="5710934">.</span><span class="ident" id="5710935">Unlock</span><span class="op" id="5710941">(</span><span class="op" id="5710942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5710945">if</span>&nbsp;<span class="ident" id="5710948">db</span><span class="op" id="5710950">.</span><span class="ident" id="5710951">closed</span>&nbsp;<span class="op" id="5710958">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5710962">if</span>&nbsp;<span class="ident" id="5710965">err</span>&nbsp;<span class="op" id="5710969">==</span>&nbsp;<span class="ident" id="5710972">nil</span>&nbsp;<span class="op" id="5710976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5710981">ci</span><span class="op" id="5710983">.</span><span class="ident" id="5710984">Close</span><span class="op" id="5710989">(</span><span class="op" id="5710990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5710994">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5710998">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5711006">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5711009">db</span><span class="op" id="5711011">.</span><span class="ident" id="5711012">pendingOpens</span><span class="op" id="5711024">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5711028">if</span>&nbsp;<span class="ident" id="5711031">err</span>&nbsp;<span class="op" id="5711035">!=</span>&nbsp;<span class="ident" id="5711038">nil</span>&nbsp;<span class="op" id="5711042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5711046">db</span><span class="op" id="5711048">.</span><span class="ident" id="5711049">putConnDBLocked</span><span class="op" id="5711064">(</span><span class="ident" id="5711065">nil</span><span class="op" id="5711068">,</span>&nbsp;<span class="ident" id="5711070">err</span><span class="op" id="5711073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5711077">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5711085">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5711088">dc</span>&nbsp;<span class="op" id="5711091">:=</span>&nbsp;<span class="op" id="5711094">&amp;</span><span class="ident" id="5711095">driverConn</span><span class="op" id="5711105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5711109">db</span><span class="op" id="5711111">:</span>&nbsp;<span class="ident" id="5711113">db</span><span class="op" id="5711115">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5711119">ci</span><span class="op" id="5711121">:</span>&nbsp;<span class="ident" id="5711123">ci</span><span class="op" id="5711125">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5711128">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5711131">if</span>&nbsp;<span class="ident" id="5711134">db</span><span class="op" id="5711136">.</span><span class="ident" id="5711137">putConnDBLocked</span><span class="op" id="5711152">(</span><span class="ident" id="5711153">dc</span><span class="op" id="5711155">,</span>&nbsp;<span class="ident" id="5711157">err</span><span class="op" id="5711160">)</span>&nbsp;<span class="op" id="5711162">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5711166">db</span><span class="op" id="5711168">.</span><span class="ident" id="5711169">addDepLocked</span><span class="op" id="5711181">(</span><span class="ident" id="5711182">dc</span><span class="op" id="5711184">,</span>&nbsp;<span class="ident" id="5711186">dc</span><span class="op" id="5711188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5711192">db</span><span class="op" id="5711194">.</span><span class="ident" id="5711195">numOpen</span><span class="op" id="5711202">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5711206">}</span>&nbsp;<span class="keyword" id="5711208">else</span>&nbsp;<span class="op" id="5711213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5711217">ci</span><span class="op" id="5711219">.</span><span class="ident" id="5711220">Close</span><span class="op" id="5711225">(</span><span class="op" id="5711226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5711229">}</span><br>
<span class="lineno">620</span><span class="op" id="5711231">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5711234">//&nbsp;connRequest&nbsp;represents&nbsp;one&nbsp;request&nbsp;for&nbsp;a&nbsp;new&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="5711293">//&nbsp;When&nbsp;there&nbsp;are&nbsp;no&nbsp;idle&nbsp;connections&nbsp;available,&nbsp;DB.conn&nbsp;will&nbsp;create</span><br>
<span class="lineno"></span><span class="comment" id="5711362">//&nbsp;a&nbsp;new&nbsp;connRequest&nbsp;and&nbsp;put&nbsp;it&nbsp;on&nbsp;the&nbsp;db.connRequests&nbsp;list.</span><br>
<span class="lineno">625</span><span class="keyword" id="5711423">type</span>&nbsp;<span class="ident" id="5711428">connRequest</span>&nbsp;<span class="keyword" id="5711440">struct</span>&nbsp;<span class="op" id="5711447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5711450">conn</span>&nbsp;<span class="op" id="5711455">*</span><span class="ident" id="5711456">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5711468">err</span>&nbsp;&nbsp;<span class="builtintype" id="5711473">error</span><br>
<span class="lineno"></span><span class="op" id="5711479">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span><span class="keyword" id="5711482">var</span>&nbsp;<span class="ident" id="5711486">errDBClosed</span>&nbsp;<span class="op" id="5711498">=</span>&nbsp;<span class="ident" id="5711500">errors</span><span class="op" id="5711506">.</span><span class="ident" id="5711507">New</span><span class="op" id="5711510">(</span><span class="string" id="5711511">&#34;sql:&nbsp;database&nbsp;is&nbsp;closed&#34;</span><span class="op" id="5711536">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5711539">//&nbsp;conn&nbsp;returns&nbsp;a&nbsp;newly-opened&nbsp;or&nbsp;cached&nbsp;*driverConn</span><br>
<span class="lineno"></span><span class="keyword" id="5711592">func</span>&nbsp;<span class="op" id="5711597">(</span><span class="ident" id="5711598">db</span>&nbsp;<span class="op" id="5711601">*</span><span class="ident" id="5711602">DB</span><span class="op" id="5711604">)</span>&nbsp;<span class="ident" id="5711606">conn</span><span class="op" id="5711610">(</span><span class="op" id="5711611">)</span>&nbsp;<span class="op" id="5711613">(</span><span class="op" id="5711614">*</span><span class="ident" id="5711615">driverConn</span><span class="op" id="5711625">,</span>&nbsp;<span class="builtintype" id="5711627">error</span><span class="op" id="5711632">)</span>&nbsp;<span class="op" id="5711634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5711637">db</span><span class="op" id="5711639">.</span><span class="ident" id="5711640">mu</span><span class="op" id="5711642">.</span><span class="ident" id="5711643">Lock</span><span class="op" id="5711647">(</span><span class="op" id="5711648">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5711651">if</span>&nbsp;<span class="ident" id="5711654">db</span><span class="op" id="5711656">.</span><span class="ident" id="5711657">closed</span>&nbsp;<span class="op" id="5711664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5711668">db</span><span class="op" id="5711670">.</span><span class="ident" id="5711671">mu</span><span class="op" id="5711673">.</span><span class="ident" id="5711674">Unlock</span><span class="op" id="5711680">(</span><span class="op" id="5711681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5711685">return</span>&nbsp;<span class="ident" id="5711692">nil</span><span class="op" id="5711695">,</span>&nbsp;<span class="ident" id="5711697">errDBClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5711710">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5711714">//&nbsp;If&nbsp;db.maxOpen&nbsp;&gt;&nbsp;0&nbsp;and&nbsp;the&nbsp;number&nbsp;of&nbsp;open&nbsp;connections&nbsp;is&nbsp;over&nbsp;the&nbsp;limit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5711789">//&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;free&nbsp;connection,&nbsp;make&nbsp;a&nbsp;request&nbsp;and&nbsp;wait.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5711852">if</span>&nbsp;<span class="ident" id="5711855">db</span><span class="op" id="5711857">.</span><span class="ident" id="5711858">maxOpen</span>&nbsp;<span class="op" id="5711866">&gt;</span>&nbsp;<span class="num" id="5711868">0</span>&nbsp;<span class="op" id="5711870">&amp;&amp;</span>&nbsp;<span class="ident" id="5711873">db</span><span class="op" id="5711875">.</span><span class="ident" id="5711876">numOpen</span>&nbsp;<span class="op" id="5711884">&gt;=</span>&nbsp;<span class="ident" id="5711887">db</span><span class="op" id="5711889">.</span><span class="ident" id="5711890">maxOpen</span>&nbsp;<span class="op" id="5711898">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5711901">len</span><span class="op" id="5711904">(</span><span class="ident" id="5711905">db</span><span class="op" id="5711907">.</span><span class="ident" id="5711908">freeConn</span><span class="op" id="5711916">)</span>&nbsp;<span class="op" id="5711918">==</span>&nbsp;<span class="num" id="5711921">0</span>&nbsp;<span class="op" id="5711923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5711927">//&nbsp;Make&nbsp;the&nbsp;connRequest&nbsp;channel.&nbsp;It&#39;s&nbsp;buffered&nbsp;so&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5711988">//&nbsp;connectionOpener&nbsp;doesn&#39;t&nbsp;block&nbsp;while&nbsp;waiting&nbsp;for&nbsp;the&nbsp;req&nbsp;to&nbsp;be&nbsp;read.</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5712062">req</span>&nbsp;<span class="op" id="5712066">:=</span>&nbsp;<span class="builtinfunc" id="5712069">make</span><span class="op" id="5712073">(</span><span class="keyword" id="5712074">chan</span>&nbsp;<span class="ident" id="5712079">connRequest</span><span class="op" id="5712090">,</span>&nbsp;<span class="num" id="5712092">1</span><span class="op" id="5712093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5712097">db</span><span class="op" id="5712099">.</span><span class="ident" id="5712100">connRequests</span>&nbsp;<span class="op" id="5712113">=</span>&nbsp;<span class="builtinfunc" id="5712115">append</span><span class="op" id="5712121">(</span><span class="ident" id="5712122">db</span><span class="op" id="5712124">.</span><span class="ident" id="5712125">connRequests</span><span class="op" id="5712137">,</span>&nbsp;<span class="ident" id="5712139">req</span><span class="op" id="5712142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5712146">db</span><span class="op" id="5712148">.</span><span class="ident" id="5712149">maybeOpenNewConnections</span><span class="op" id="5712172">(</span><span class="op" id="5712173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5712177">db</span><span class="op" id="5712179">.</span><span class="ident" id="5712180">mu</span><span class="op" id="5712182">.</span><span class="ident" id="5712183">Unlock</span><span class="op" id="5712189">(</span><span class="op" id="5712190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5712194">ret</span>&nbsp;<span class="op" id="5712198">:=</span>&nbsp;<span class="op" id="5712201">&lt;-</span><span class="ident" id="5712203">req</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5712209">return</span>&nbsp;<span class="ident" id="5712216">ret</span><span class="op" id="5712219">.</span><span class="ident" id="5712220">conn</span><span class="op" id="5712224">,</span>&nbsp;<span class="ident" id="5712226">ret</span><span class="op" id="5712229">.</span><span class="ident" id="5712230">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5712235">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5712239">if</span>&nbsp;<span class="ident" id="5712242">c</span>&nbsp;<span class="op" id="5712244">:=</span>&nbsp;<span class="builtinfunc" id="5712247">len</span><span class="op" id="5712250">(</span><span class="ident" id="5712251">db</span><span class="op" id="5712253">.</span><span class="ident" id="5712254">freeConn</span><span class="op" id="5712262">)</span><span class="op" id="5712263">;</span>&nbsp;<span class="ident" id="5712265">c</span>&nbsp;<span class="op" id="5712267">&gt;</span>&nbsp;<span class="num" id="5712269">0</span>&nbsp;<span class="op" id="5712271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5712275">conn</span>&nbsp;<span class="op" id="5712280">:=</span>&nbsp;<span class="ident" id="5712283">db</span><span class="op" id="5712285">.</span><span class="ident" id="5712286">freeConn</span><span class="op" id="5712294">[</span><span class="num" id="5712295">0</span><span class="op" id="5712296">]</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5712300">copy</span><span class="op" id="5712304">(</span><span class="ident" id="5712305">db</span><span class="op" id="5712307">.</span><span class="ident" id="5712308">freeConn</span><span class="op" id="5712316">,</span>&nbsp;<span class="ident" id="5712318">db</span><span class="op" id="5712320">.</span><span class="ident" id="5712321">freeConn</span><span class="op" id="5712329">[</span><span class="num" id="5712330">1</span><span class="op" id="5712331">:</span><span class="op" id="5712332">]</span><span class="op" id="5712333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5712337">db</span><span class="op" id="5712339">.</span><span class="ident" id="5712340">freeConn</span>&nbsp;<span class="op" id="5712349">=</span>&nbsp;<span class="ident" id="5712351">db</span><span class="op" id="5712353">.</span><span class="ident" id="5712354">freeConn</span><span class="op" id="5712362">[</span><span class="op" id="5712363">:</span><span class="ident" id="5712364">c</span><span class="op" id="5712365">-</span><span class="num" id="5712366">1</span><span class="op" id="5712367">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5712371">conn</span><span class="op" id="5712375">.</span><span class="ident" id="5712376">inUse</span>&nbsp;<span class="op" id="5712382">=</span>&nbsp;<span class="builtintype" id="5712384">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5712391">db</span><span class="op" id="5712393">.</span><span class="ident" id="5712394">mu</span><span class="op" id="5712396">.</span><span class="ident" id="5712397">Unlock</span><span class="op" id="5712403">(</span><span class="op" id="5712404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5712408">return</span>&nbsp;<span class="ident" id="5712415">conn</span><span class="op" id="5712419">,</span>&nbsp;<span class="ident" id="5712421">nil</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5712426">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5712430">db</span><span class="op" id="5712432">.</span><span class="ident" id="5712433">numOpen</span><span class="op" id="5712440">++</span>&nbsp;<span class="comment" id="5712443">//&nbsp;optimistically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5712462">db</span><span class="op" id="5712464">.</span><span class="ident" id="5712465">mu</span><span class="op" id="5712467">.</span><span class="ident" id="5712468">Unlock</span><span class="op" id="5712474">(</span><span class="op" id="5712475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5712478">ci</span><span class="op" id="5712480">,</span>&nbsp;<span class="ident" id="5712482">err</span>&nbsp;<span class="op" id="5712486">:=</span>&nbsp;<span class="ident" id="5712489">db</span><span class="op" id="5712491">.</span><span class="ident" id="5712492">driver</span><span class="op" id="5712498">.</span><span class="ident" id="5712499">Open</span><span class="op" id="5712503">(</span><span class="ident" id="5712504">db</span><span class="op" id="5712506">.</span><span class="ident" id="5712507">dsn</span><span class="op" id="5712510">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5712513">if</span>&nbsp;<span class="ident" id="5712516">err</span>&nbsp;<span class="op" id="5712520">!=</span>&nbsp;<span class="ident" id="5712523">nil</span>&nbsp;<span class="op" id="5712527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5712531">db</span><span class="op" id="5712533">.</span><span class="ident" id="5712534">mu</span><span class="op" id="5712536">.</span><span class="ident" id="5712537">Lock</span><span class="op" id="5712541">(</span><span class="op" id="5712542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5712546">db</span><span class="op" id="5712548">.</span><span class="ident" id="5712549">numOpen</span><span class="op" id="5712556">--</span>&nbsp;<span class="comment" id="5712559">//&nbsp;correct&nbsp;for&nbsp;earlier&nbsp;optimism</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5712593">db</span><span class="op" id="5712595">.</span><span class="ident" id="5712596">mu</span><span class="op" id="5712598">.</span><span class="ident" id="5712599">Unlock</span><span class="op" id="5712605">(</span><span class="op" id="5712606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5712610">return</span>&nbsp;<span class="ident" id="5712617">nil</span><span class="op" id="5712620">,</span>&nbsp;<span class="ident" id="5712622">err</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5712627">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5712630">db</span><span class="op" id="5712632">.</span><span class="ident" id="5712633">mu</span><span class="op" id="5712635">.</span><span class="ident" id="5712636">Lock</span><span class="op" id="5712640">(</span><span class="op" id="5712641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5712644">dc</span>&nbsp;<span class="op" id="5712647">:=</span>&nbsp;<span class="op" id="5712650">&amp;</span><span class="ident" id="5712651">driverConn</span><span class="op" id="5712661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5712665">db</span><span class="op" id="5712667">:</span>&nbsp;<span class="ident" id="5712669">db</span><span class="op" id="5712671">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5712675">ci</span><span class="op" id="5712677">:</span>&nbsp;<span class="ident" id="5712679">ci</span><span class="op" id="5712681">,</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5712684">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5712687">db</span><span class="op" id="5712689">.</span><span class="ident" id="5712690">addDepLocked</span><span class="op" id="5712702">(</span><span class="ident" id="5712703">dc</span><span class="op" id="5712705">,</span>&nbsp;<span class="ident" id="5712707">dc</span><span class="op" id="5712709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5712712">dc</span><span class="op" id="5712714">.</span><span class="ident" id="5712715">inUse</span>&nbsp;<span class="op" id="5712721">=</span>&nbsp;<span class="builtintype" id="5712723">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5712729">db</span><span class="op" id="5712731">.</span><span class="ident" id="5712732">mu</span><span class="op" id="5712734">.</span><span class="ident" id="5712735">Unlock</span><span class="op" id="5712741">(</span><span class="op" id="5712742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5712745">return</span>&nbsp;<span class="ident" id="5712752">dc</span><span class="op" id="5712754">,</span>&nbsp;<span class="ident" id="5712756">nil</span><br>
<span class="lineno">680</span><span class="op" id="5712760">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5712763">var</span>&nbsp;<span class="op" id="5712767">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5712770">errConnClosed</span>&nbsp;<span class="op" id="5712784">=</span>&nbsp;<span class="ident" id="5712786">errors</span><span class="op" id="5712792">.</span><span class="ident" id="5712793">New</span><span class="op" id="5712796">(</span><span class="string" id="5712797">&#34;database/sql:&nbsp;internal&nbsp;sentinel&nbsp;error:&nbsp;conn&nbsp;is&nbsp;closed&#34;</span><span class="op" id="5712852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5712855">errConnBusy</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5712869">=</span>&nbsp;<span class="ident" id="5712871">errors</span><span class="op" id="5712877">.</span><span class="ident" id="5712878">New</span><span class="op" id="5712881">(</span><span class="string" id="5712882">&#34;database/sql:&nbsp;internal&nbsp;sentinel&nbsp;error:&nbsp;conn&nbsp;is&nbsp;busy&#34;</span><span class="op" id="5712935">)</span><br>
<span class="lineno">685</span><span class="op" id="5712937">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5712940">//&nbsp;connIfFree&nbsp;returns&nbsp;(wanted,&nbsp;nil)&nbsp;if&nbsp;wanted&nbsp;is&nbsp;still&nbsp;a&nbsp;valid&nbsp;conn&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5713012">//&nbsp;isn&#39;t&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span><span class="comment" id="5713029">//</span><br>
<span class="lineno">690</span><span class="comment" id="5713032">//&nbsp;The&nbsp;error&nbsp;is&nbsp;errConnClosed&nbsp;if&nbsp;the&nbsp;connection&nbsp;if&nbsp;the&nbsp;requested&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="5713108">//&nbsp;is&nbsp;invalid&nbsp;because&nbsp;it&#39;s&nbsp;been&nbsp;closed.</span><br>
<span class="lineno"></span><span class="comment" id="5713148">//</span><br>
<span class="lineno"></span><span class="comment" id="5713151">//&nbsp;The&nbsp;error&nbsp;is&nbsp;errConnBusy&nbsp;if&nbsp;the&nbsp;connection&nbsp;is&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="5713208">func</span>&nbsp;<span class="op" id="5713213">(</span><span class="ident" id="5713214">db</span>&nbsp;<span class="op" id="5713217">*</span><span class="ident" id="5713218">DB</span><span class="op" id="5713220">)</span>&nbsp;<span class="ident" id="5713222">connIfFree</span><span class="op" id="5713232">(</span><span class="ident" id="5713233">wanted</span>&nbsp;<span class="op" id="5713240">*</span><span class="ident" id="5713241">driverConn</span><span class="op" id="5713251">)</span>&nbsp;<span class="op" id="5713253">(</span><span class="op" id="5713254">*</span><span class="ident" id="5713255">driverConn</span><span class="op" id="5713265">,</span>&nbsp;<span class="builtintype" id="5713267">error</span><span class="op" id="5713272">)</span>&nbsp;<span class="op" id="5713274">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5713277">db</span><span class="op" id="5713279">.</span><span class="ident" id="5713280">mu</span><span class="op" id="5713282">.</span><span class="ident" id="5713283">Lock</span><span class="op" id="5713287">(</span><span class="op" id="5713288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5713291">defer</span>&nbsp;<span class="ident" id="5713297">db</span><span class="op" id="5713299">.</span><span class="ident" id="5713300">mu</span><span class="op" id="5713302">.</span><span class="ident" id="5713303">Unlock</span><span class="op" id="5713309">(</span><span class="op" id="5713310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5713313">if</span>&nbsp;<span class="ident" id="5713316">wanted</span><span class="op" id="5713322">.</span><span class="ident" id="5713323">dbmuClosed</span>&nbsp;<span class="op" id="5713334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5713338">return</span>&nbsp;<span class="ident" id="5713345">nil</span><span class="op" id="5713348">,</span>&nbsp;<span class="ident" id="5713350">errConnClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5713365">}</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5713368">if</span>&nbsp;<span class="ident" id="5713371">wanted</span><span class="op" id="5713377">.</span><span class="ident" id="5713378">inUse</span>&nbsp;<span class="op" id="5713384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5713388">return</span>&nbsp;<span class="ident" id="5713395">nil</span><span class="op" id="5713398">,</span>&nbsp;<span class="ident" id="5713400">errConnBusy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5713413">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5713416">idx</span>&nbsp;<span class="op" id="5713420">:=</span>&nbsp;<span class="op" id="5713423">-</span><span class="num" id="5713424">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5713427">for</span>&nbsp;<span class="ident" id="5713431">ii</span><span class="op" id="5713433">,</span>&nbsp;<span class="ident" id="5713435">v</span>&nbsp;<span class="op" id="5713437">:=</span>&nbsp;<span class="keyword" id="5713440">range</span>&nbsp;<span class="ident" id="5713446">db</span><span class="op" id="5713448">.</span><span class="ident" id="5713449">freeConn</span>&nbsp;<span class="op" id="5713458">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5713462">if</span>&nbsp;<span class="ident" id="5713465">v</span>&nbsp;<span class="op" id="5713467">==</span>&nbsp;<span class="ident" id="5713470">wanted</span>&nbsp;<span class="op" id="5713477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5713482">idx</span>&nbsp;<span class="op" id="5713486">=</span>&nbsp;<span class="ident" id="5713488">ii</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5713494">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5713502">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5713505">}</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5713508">if</span>&nbsp;<span class="ident" id="5713511">idx</span>&nbsp;<span class="op" id="5713515">&gt;=</span>&nbsp;<span class="num" id="5713518">0</span>&nbsp;<span class="op" id="5713520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5713524">db</span><span class="op" id="5713526">.</span><span class="ident" id="5713527">freeConn</span>&nbsp;<span class="op" id="5713536">=</span>&nbsp;<span class="builtinfunc" id="5713538">append</span><span class="op" id="5713544">(</span><span class="ident" id="5713545">db</span><span class="op" id="5713547">.</span><span class="ident" id="5713548">freeConn</span><span class="op" id="5713556">[</span><span class="op" id="5713557">:</span><span class="ident" id="5713558">idx</span><span class="op" id="5713561">]</span><span class="op" id="5713562">,</span>&nbsp;<span class="ident" id="5713564">db</span><span class="op" id="5713566">.</span><span class="ident" id="5713567">freeConn</span><span class="op" id="5713575">[</span><span class="ident" id="5713576">idx</span><span class="op" id="5713579">+</span><span class="num" id="5713580">1</span><span class="op" id="5713581">:</span><span class="op" id="5713582">]</span><span class="op" id="5713583">...</span><span class="op" id="5713586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5713590">wanted</span><span class="op" id="5713596">.</span><span class="ident" id="5713597">inUse</span>&nbsp;<span class="op" id="5713603">=</span>&nbsp;<span class="builtintype" id="5713605">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5713612">return</span>&nbsp;<span class="ident" id="5713619">wanted</span><span class="op" id="5713625">,</span>&nbsp;<span class="ident" id="5713627">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5713632">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5713635">//&nbsp;TODO(bradfitz):&nbsp;shouldn&#39;t&nbsp;get&nbsp;here.&nbsp;After&nbsp;Go&nbsp;1.1,&nbsp;change&nbsp;this&nbsp;to:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5713705">//&nbsp;panic(&#34;connIfFree&nbsp;call&nbsp;requested&nbsp;a&nbsp;non-closed,&nbsp;non-busy,&nbsp;non-free&nbsp;conn&#34;)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5713782">//&nbsp;Which&nbsp;passes&nbsp;all&nbsp;the&nbsp;tests,&nbsp;but&nbsp;I&#39;m&nbsp;too&nbsp;paranoid&nbsp;to&nbsp;include&nbsp;this</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5713851">//&nbsp;late&nbsp;in&nbsp;Go&nbsp;1.1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5713871">//&nbsp;Instead,&nbsp;treat&nbsp;it&nbsp;like&nbsp;a&nbsp;busy&nbsp;connection:</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5713917">return</span>&nbsp;<span class="ident" id="5713924">nil</span><span class="op" id="5713927">,</span>&nbsp;<span class="ident" id="5713929">errConnBusy</span><br>
<span class="lineno"></span><span class="op" id="5713941">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5713944">//&nbsp;putConnHook&nbsp;is&nbsp;a&nbsp;hook&nbsp;for&nbsp;testing.</span><br>
<span class="lineno"></span><span class="keyword" id="5713982">var</span>&nbsp;<span class="ident" id="5713986">putConnHook</span>&nbsp;<span class="keyword" id="5713998">func</span><span class="op" id="5714002">(</span><span class="op" id="5714003">*</span><span class="ident" id="5714004">DB</span><span class="op" id="5714006">,</span>&nbsp;<span class="op" id="5714008">*</span><span class="ident" id="5714009">driverConn</span><span class="op" id="5714019">)</span><br>
<span class="lineno">725</span><br>
<span class="lineno"></span><span class="comment" id="5714022">//&nbsp;noteUnusedDriverStatement&nbsp;notes&nbsp;that&nbsp;si&nbsp;is&nbsp;no&nbsp;longer&nbsp;used&nbsp;and&nbsp;should</span><br>
<span class="lineno"></span><span class="comment" id="5714094">//&nbsp;be&nbsp;closed&nbsp;whenever&nbsp;possible&nbsp;(when&nbsp;c&nbsp;is&nbsp;next&nbsp;not&nbsp;in&nbsp;use),&nbsp;unless&nbsp;c&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="5714166">//&nbsp;already&nbsp;closed.</span><br>
<span class="lineno"></span><span class="keyword" id="5714185">func</span>&nbsp;<span class="op" id="5714190">(</span><span class="ident" id="5714191">db</span>&nbsp;<span class="op" id="5714194">*</span><span class="ident" id="5714195">DB</span><span class="op" id="5714197">)</span>&nbsp;<span class="ident" id="5714199">noteUnusedDriverStatement</span><span class="op" id="5714224">(</span><span class="ident" id="5714225">c</span>&nbsp;<span class="op" id="5714227">*</span><span class="ident" id="5714228">driverConn</span><span class="op" id="5714238">,</span>&nbsp;<span class="ident" id="5714240">si</span>&nbsp;<span class="ident" id="5714243">driver</span><span class="op" id="5714249">.</span><span class="ident" id="5714250">Stmt</span><span class="op" id="5714254">)</span>&nbsp;<span class="op" id="5714256">{</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5714259">db</span><span class="op" id="5714261">.</span><span class="ident" id="5714262">mu</span><span class="op" id="5714264">.</span><span class="ident" id="5714265">Lock</span><span class="op" id="5714269">(</span><span class="op" id="5714270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5714273">defer</span>&nbsp;<span class="ident" id="5714279">db</span><span class="op" id="5714281">.</span><span class="ident" id="5714282">mu</span><span class="op" id="5714284">.</span><span class="ident" id="5714285">Unlock</span><span class="op" id="5714291">(</span><span class="op" id="5714292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5714295">if</span>&nbsp;<span class="ident" id="5714298">c</span><span class="op" id="5714299">.</span><span class="ident" id="5714300">inUse</span>&nbsp;<span class="op" id="5714306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5714310">c</span><span class="op" id="5714311">.</span><span class="ident" id="5714312">onPut</span>&nbsp;<span class="op" id="5714318">=</span>&nbsp;<span class="builtinfunc" id="5714320">append</span><span class="op" id="5714326">(</span><span class="ident" id="5714327">c</span><span class="op" id="5714328">.</span><span class="ident" id="5714329">onPut</span><span class="op" id="5714334">,</span>&nbsp;<span class="keyword" id="5714336">func</span><span class="op" id="5714340">(</span><span class="op" id="5714341">)</span>&nbsp;<span class="op" id="5714343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5714348">si</span><span class="op" id="5714350">.</span><span class="ident" id="5714351">Close</span><span class="op" id="5714356">(</span><span class="op" id="5714357">)</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5714361">}</span><span class="op" id="5714362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5714365">}</span>&nbsp;<span class="keyword" id="5714367">else</span>&nbsp;<span class="op" id="5714372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5714376">c</span><span class="op" id="5714377">.</span><span class="ident" id="5714378">Lock</span><span class="op" id="5714382">(</span><span class="op" id="5714383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5714387">defer</span>&nbsp;<span class="ident" id="5714393">c</span><span class="op" id="5714394">.</span><span class="ident" id="5714395">Unlock</span><span class="op" id="5714401">(</span><span class="op" id="5714402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5714406">if</span>&nbsp;<span class="op" id="5714409">!</span><span class="ident" id="5714410">c</span><span class="op" id="5714411">.</span><span class="ident" id="5714412">finalClosed</span>&nbsp;<span class="op" id="5714424">{</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5714429">si</span><span class="op" id="5714431">.</span><span class="ident" id="5714432">Close</span><span class="op" id="5714437">(</span><span class="op" id="5714438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5714442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5714445">}</span><br>
<span class="lineno"></span><span class="op" id="5714447">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">745</span><span class="comment" id="5714450">//&nbsp;debugGetPut&nbsp;determines&nbsp;whether&nbsp;getConn&nbsp;&amp;&nbsp;putConn&nbsp;calls&#39;&nbsp;stack&nbsp;traces</span><br>
<span class="lineno"></span><span class="comment" id="5714522">//&nbsp;are&nbsp;returned&nbsp;for&nbsp;more&nbsp;verbose&nbsp;crashes.</span><br>
<span class="lineno"></span><span class="keyword" id="5714564">const</span>&nbsp;<span class="ident" id="5714570">debugGetPut</span>&nbsp;<span class="op" id="5714582">=</span>&nbsp;<span class="builtintype" id="5714584">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5714591">//&nbsp;putConn&nbsp;adds&nbsp;a&nbsp;connection&nbsp;to&nbsp;the&nbsp;db&#39;s&nbsp;free&nbsp;pool.</span><br>
<span class="lineno">750</span><span class="comment" id="5714643">//&nbsp;err&nbsp;is&nbsp;optionally&nbsp;the&nbsp;last&nbsp;error&nbsp;that&nbsp;occurred&nbsp;on&nbsp;this&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="5714713">func</span>&nbsp;<span class="op" id="5714718">(</span><span class="ident" id="5714719">db</span>&nbsp;<span class="op" id="5714722">*</span><span class="ident" id="5714723">DB</span><span class="op" id="5714725">)</span>&nbsp;<span class="ident" id="5714727">putConn</span><span class="op" id="5714734">(</span><span class="ident" id="5714735">dc</span>&nbsp;<span class="op" id="5714738">*</span><span class="ident" id="5714739">driverConn</span><span class="op" id="5714749">,</span>&nbsp;<span class="ident" id="5714751">err</span>&nbsp;<span class="builtintype" id="5714755">error</span><span class="op" id="5714760">)</span>&nbsp;<span class="op" id="5714762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5714765">db</span><span class="op" id="5714767">.</span><span class="ident" id="5714768">mu</span><span class="op" id="5714770">.</span><span class="ident" id="5714771">Lock</span><span class="op" id="5714775">(</span><span class="op" id="5714776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5714779">if</span>&nbsp;<span class="op" id="5714782">!</span><span class="ident" id="5714783">dc</span><span class="op" id="5714785">.</span><span class="ident" id="5714786">inUse</span>&nbsp;<span class="op" id="5714792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5714796">if</span>&nbsp;<span class="ident" id="5714799">debugGetPut</span>&nbsp;<span class="op" id="5714811">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5714816">fmt</span><span class="op" id="5714819">.</span><span class="ident" id="5714820">Printf</span><span class="op" id="5714826">(</span><span class="string" id="5714827">&#34;putConn(%v)&nbsp;DUPLICATE&nbsp;was:&nbsp;%s\n\nPREVIOUS&nbsp;was:&nbsp;%s&#34;</span><span class="op" id="5714878">,</span>&nbsp;<span class="ident" id="5714880">dc</span><span class="op" id="5714882">,</span>&nbsp;<span class="ident" id="5714884">stack</span><span class="op" id="5714889">(</span><span class="op" id="5714890">)</span><span class="op" id="5714891">,</span>&nbsp;<span class="ident" id="5714893">db</span><span class="op" id="5714895">.</span><span class="ident" id="5714896">lastPut</span><span class="op" id="5714903">[</span><span class="ident" id="5714904">dc</span><span class="op" id="5714906">]</span><span class="op" id="5714907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5714911">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5714915">panic</span><span class="op" id="5714920">(</span><span class="string" id="5714921">&#34;sql:&nbsp;connection&nbsp;returned&nbsp;that&nbsp;was&nbsp;never&nbsp;out&#34;</span><span class="op" id="5714966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5714969">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5714972">if</span>&nbsp;<span class="ident" id="5714975">debugGetPut</span>&nbsp;<span class="op" id="5714987">{</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5714991">db</span><span class="op" id="5714993">.</span><span class="ident" id="5714994">lastPut</span><span class="op" id="5715001">[</span><span class="ident" id="5715002">dc</span><span class="op" id="5715004">]</span>&nbsp;<span class="op" id="5715006">=</span>&nbsp;<span class="ident" id="5715008">stack</span><span class="op" id="5715013">(</span><span class="op" id="5715014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5715017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5715020">dc</span><span class="op" id="5715022">.</span><span class="ident" id="5715023">inUse</span>&nbsp;<span class="op" id="5715029">=</span>&nbsp;<span class="builtintype" id="5715031">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5715039">for</span>&nbsp;<span class="ident" id="5715043">_</span><span class="op" id="5715044">,</span>&nbsp;<span class="ident" id="5715046">fn</span>&nbsp;<span class="op" id="5715049">:=</span>&nbsp;<span class="keyword" id="5715052">range</span>&nbsp;<span class="ident" id="5715058">dc</span><span class="op" id="5715060">.</span><span class="ident" id="5715061">onPut</span>&nbsp;<span class="op" id="5715067">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5715071">fn</span><span class="op" id="5715073">(</span><span class="op" id="5715074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5715077">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5715080">dc</span><span class="op" id="5715082">.</span><span class="ident" id="5715083">onPut</span>&nbsp;<span class="op" id="5715089">=</span>&nbsp;<span class="ident" id="5715091">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5715097">if</span>&nbsp;<span class="ident" id="5715100">err</span>&nbsp;<span class="op" id="5715104">==</span>&nbsp;<span class="ident" id="5715107">driver</span><span class="op" id="5715113">.</span><span class="ident" id="5715114">ErrBadConn</span>&nbsp;<span class="op" id="5715125">{</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5715129">//&nbsp;Don&#39;t&nbsp;reuse&nbsp;bad&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5715163">//&nbsp;Since&nbsp;the&nbsp;conn&nbsp;is&nbsp;considered&nbsp;bad&nbsp;and&nbsp;is&nbsp;being&nbsp;discarded,&nbsp;treat&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5715234">//&nbsp;as&nbsp;closed.&nbsp;Don&#39;t&nbsp;decrement&nbsp;the&nbsp;open&nbsp;count&nbsp;here,&nbsp;finalClose&nbsp;will</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5715303">//&nbsp;take&nbsp;care&nbsp;of&nbsp;that.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5715327">db</span><span class="op" id="5715329">.</span><span class="ident" id="5715330">maybeOpenNewConnections</span><span class="op" id="5715353">(</span><span class="op" id="5715354">)</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5715358">db</span><span class="op" id="5715360">.</span><span class="ident" id="5715361">mu</span><span class="op" id="5715363">.</span><span class="ident" id="5715364">Unlock</span><span class="op" id="5715370">(</span><span class="op" id="5715371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5715375">dc</span><span class="op" id="5715377">.</span><span class="ident" id="5715378">Close</span><span class="op" id="5715383">(</span><span class="op" id="5715384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5715388">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5715396">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5715399">if</span>&nbsp;<span class="ident" id="5715402">putConnHook</span>&nbsp;<span class="op" id="5715414">!=</span>&nbsp;<span class="ident" id="5715417">nil</span>&nbsp;<span class="op" id="5715421">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5715425">putConnHook</span><span class="op" id="5715436">(</span><span class="ident" id="5715437">db</span><span class="op" id="5715439">,</span>&nbsp;<span class="ident" id="5715441">dc</span><span class="op" id="5715443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5715446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5715449">added</span>&nbsp;<span class="op" id="5715455">:=</span>&nbsp;<span class="ident" id="5715458">db</span><span class="op" id="5715460">.</span><span class="ident" id="5715461">putConnDBLocked</span><span class="op" id="5715476">(</span><span class="ident" id="5715477">dc</span><span class="op" id="5715479">,</span>&nbsp;<span class="ident" id="5715481">nil</span><span class="op" id="5715484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5715487">db</span><span class="op" id="5715489">.</span><span class="ident" id="5715490">mu</span><span class="op" id="5715492">.</span><span class="ident" id="5715493">Unlock</span><span class="op" id="5715499">(</span><span class="op" id="5715500">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5715504">if</span>&nbsp;<span class="op" id="5715507">!</span><span class="ident" id="5715508">added</span>&nbsp;<span class="op" id="5715514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5715518">dc</span><span class="op" id="5715520">.</span><span class="ident" id="5715521">Close</span><span class="op" id="5715526">(</span><span class="op" id="5715527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5715530">}</span><br>
<span class="lineno"></span><span class="op" id="5715532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">790</span><span class="comment" id="5715535">//&nbsp;Satisfy&nbsp;a&nbsp;connRequest&nbsp;or&nbsp;put&nbsp;the&nbsp;driverConn&nbsp;in&nbsp;the&nbsp;idle&nbsp;pool&nbsp;and&nbsp;return&nbsp;true</span><br>
<span class="lineno"></span><span class="comment" id="5715615">//&nbsp;or&nbsp;return&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="5715635">//&nbsp;putConnDBLocked&nbsp;will&nbsp;satisfy&nbsp;a&nbsp;connRequest&nbsp;if&nbsp;there&nbsp;is&nbsp;one,&nbsp;or&nbsp;it&nbsp;will</span><br>
<span class="lineno"></span><span class="comment" id="5715709">//&nbsp;return&nbsp;the&nbsp;*driverConn&nbsp;to&nbsp;the&nbsp;freeConn&nbsp;list&nbsp;if&nbsp;err&nbsp;==&nbsp;nil&nbsp;and&nbsp;the&nbsp;idle</span><br>
<span class="lineno"></span><span class="comment" id="5715783">//&nbsp;connection&nbsp;limit&nbsp;will&nbsp;not&nbsp;be&nbsp;exceeded.</span><br>
<span class="lineno">795</span><span class="comment" id="5715825">//&nbsp;If&nbsp;err&nbsp;!=&nbsp;nil,&nbsp;the&nbsp;value&nbsp;of&nbsp;dc&nbsp;is&nbsp;ignored.</span><br>
<span class="lineno"></span><span class="comment" id="5715871">//&nbsp;If&nbsp;err&nbsp;==&nbsp;nil,&nbsp;then&nbsp;dc&nbsp;must&nbsp;not&nbsp;equal&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="5715917">//&nbsp;If&nbsp;a&nbsp;connRequest&nbsp;was&nbsp;fulfilled&nbsp;or&nbsp;the&nbsp;*driverConn&nbsp;was&nbsp;placed&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5715988">//&nbsp;freeConn&nbsp;list,&nbsp;then&nbsp;true&nbsp;is&nbsp;returned,&nbsp;otherwise&nbsp;false&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="5716058">func</span>&nbsp;<span class="op" id="5716063">(</span><span class="ident" id="5716064">db</span>&nbsp;<span class="op" id="5716067">*</span><span class="ident" id="5716068">DB</span><span class="op" id="5716070">)</span>&nbsp;<span class="ident" id="5716072">putConnDBLocked</span><span class="op" id="5716087">(</span><span class="ident" id="5716088">dc</span>&nbsp;<span class="op" id="5716091">*</span><span class="ident" id="5716092">driverConn</span><span class="op" id="5716102">,</span>&nbsp;<span class="ident" id="5716104">err</span>&nbsp;<span class="builtintype" id="5716108">error</span><span class="op" id="5716113">)</span>&nbsp;<span class="builtintype" id="5716115">bool</span>&nbsp;<span class="op" id="5716120">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5716123">if</span>&nbsp;<span class="ident" id="5716126">c</span>&nbsp;<span class="op" id="5716128">:=</span>&nbsp;<span class="builtinfunc" id="5716131">len</span><span class="op" id="5716134">(</span><span class="ident" id="5716135">db</span><span class="op" id="5716137">.</span><span class="ident" id="5716138">connRequests</span><span class="op" id="5716150">)</span><span class="op" id="5716151">;</span>&nbsp;<span class="ident" id="5716153">c</span>&nbsp;<span class="op" id="5716155">&gt;</span>&nbsp;<span class="num" id="5716157">0</span>&nbsp;<span class="op" id="5716159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5716163">req</span>&nbsp;<span class="op" id="5716167">:=</span>&nbsp;<span class="ident" id="5716170">db</span><span class="op" id="5716172">.</span><span class="ident" id="5716173">connRequests</span><span class="op" id="5716185">[</span><span class="num" id="5716186">0</span><span class="op" id="5716187">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5716191">//&nbsp;This&nbsp;copy&nbsp;is&nbsp;O(n)&nbsp;but&nbsp;in&nbsp;practice&nbsp;faster&nbsp;than&nbsp;a&nbsp;linked&nbsp;list.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5716257">//&nbsp;TODO:&nbsp;consider&nbsp;compacting&nbsp;it&nbsp;down&nbsp;less&nbsp;often&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5716311">//&nbsp;moving&nbsp;the&nbsp;base&nbsp;instead?</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5716341">copy</span><span class="op" id="5716345">(</span><span class="ident" id="5716346">db</span><span class="op" id="5716348">.</span><span class="ident" id="5716349">connRequests</span><span class="op" id="5716361">,</span>&nbsp;<span class="ident" id="5716363">db</span><span class="op" id="5716365">.</span><span class="ident" id="5716366">connRequests</span><span class="op" id="5716378">[</span><span class="num" id="5716379">1</span><span class="op" id="5716380">:</span><span class="op" id="5716381">]</span><span class="op" id="5716382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5716386">db</span><span class="op" id="5716388">.</span><span class="ident" id="5716389">connRequests</span>&nbsp;<span class="op" id="5716402">=</span>&nbsp;<span class="ident" id="5716404">db</span><span class="op" id="5716406">.</span><span class="ident" id="5716407">connRequests</span><span class="op" id="5716419">[</span><span class="op" id="5716420">:</span><span class="ident" id="5716421">c</span><span class="op" id="5716422">-</span><span class="num" id="5716423">1</span><span class="op" id="5716424">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5716428">if</span>&nbsp;<span class="ident" id="5716431">err</span>&nbsp;<span class="op" id="5716435">==</span>&nbsp;<span class="ident" id="5716438">nil</span>&nbsp;<span class="op" id="5716442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5716447">dc</span><span class="op" id="5716449">.</span><span class="ident" id="5716450">inUse</span>&nbsp;<span class="op" id="5716456">=</span>&nbsp;<span class="builtintype" id="5716458">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5716465">}</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5716469">req</span>&nbsp;<span class="op" id="5716473">&lt;-</span>&nbsp;<span class="ident" id="5716476">connRequest</span><span class="op" id="5716487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5716492">conn</span><span class="op" id="5716496">:</span>&nbsp;<span class="ident" id="5716498">dc</span><span class="op" id="5716500">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5716505">err</span><span class="op" id="5716508">:</span>&nbsp;&nbsp;<span class="ident" id="5716511">err</span><span class="op" id="5716514">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5716518">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5716522">return</span>&nbsp;<span class="builtintype" id="5716529">true</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5716535">}</span>&nbsp;<span class="keyword" id="5716537">else</span>&nbsp;<span class="keyword" id="5716542">if</span>&nbsp;<span class="ident" id="5716545">err</span>&nbsp;<span class="op" id="5716549">==</span>&nbsp;<span class="ident" id="5716552">nil</span>&nbsp;<span class="op" id="5716556">&amp;&amp;</span>&nbsp;<span class="op" id="5716559">!</span><span class="ident" id="5716560">db</span><span class="op" id="5716562">.</span><span class="ident" id="5716563">closed</span>&nbsp;<span class="op" id="5716570">&amp;&amp;</span>&nbsp;<span class="ident" id="5716573">db</span><span class="op" id="5716575">.</span><span class="ident" id="5716576">maxIdleConnsLocked</span><span class="op" id="5716594">(</span><span class="op" id="5716595">)</span>&nbsp;<span class="op" id="5716597">&gt;</span>&nbsp;<span class="builtinfunc" id="5716599">len</span><span class="op" id="5716602">(</span><span class="ident" id="5716603">db</span><span class="op" id="5716605">.</span><span class="ident" id="5716606">freeConn</span><span class="op" id="5716614">)</span>&nbsp;<span class="op" id="5716616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5716620">db</span><span class="op" id="5716622">.</span><span class="ident" id="5716623">freeConn</span>&nbsp;<span class="op" id="5716632">=</span>&nbsp;<span class="builtinfunc" id="5716634">append</span><span class="op" id="5716640">(</span><span class="ident" id="5716641">db</span><span class="op" id="5716643">.</span><span class="ident" id="5716644">freeConn</span><span class="op" id="5716652">,</span>&nbsp;<span class="ident" id="5716654">dc</span><span class="op" id="5716656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5716660">return</span>&nbsp;<span class="builtintype" id="5716667">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5716673">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5716676">return</span>&nbsp;<span class="builtintype" id="5716683">false</span><br>
<span class="lineno">820</span><span class="op" id="5716689">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5716692">//&nbsp;maxBadConnRetries&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;maximum&nbsp;retries&nbsp;if&nbsp;the&nbsp;driver&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="5716768">//&nbsp;driver.ErrBadConn&nbsp;to&nbsp;signal&nbsp;a&nbsp;broken&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="5716820">const</span>&nbsp;<span class="ident" id="5716826">maxBadConnRetries</span>&nbsp;<span class="op" id="5716844">=</span>&nbsp;<span class="num" id="5716846">10</span><br>
<span class="lineno">825</span><br>
<span class="lineno"></span><span class="comment" id="5716850">//&nbsp;Prepare&nbsp;creates&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;for&nbsp;later&nbsp;queries&nbsp;or&nbsp;executions.</span><br>
<span class="lineno"></span><span class="comment" id="5716923">//&nbsp;Multiple&nbsp;queries&nbsp;or&nbsp;executions&nbsp;may&nbsp;be&nbsp;run&nbsp;concurrently&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5716990">//&nbsp;returned&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5717013">func</span>&nbsp;<span class="op" id="5717018">(</span><span class="ident" id="5717019">db</span>&nbsp;<span class="op" id="5717022">*</span><span class="ident" id="5717023">DB</span><span class="op" id="5717025">)</span>&nbsp;<span class="ident" id="5717027">Prepare</span><span class="op" id="5717034">(</span><span class="ident" id="5717035">query</span>&nbsp;<span class="builtintype" id="5717041">string</span><span class="op" id="5717047">)</span>&nbsp;<span class="op" id="5717049">(</span><span class="op" id="5717050">*</span><span class="ident" id="5717051">Stmt</span><span class="op" id="5717055">,</span>&nbsp;<span class="builtintype" id="5717057">error</span><span class="op" id="5717062">)</span>&nbsp;<span class="op" id="5717064">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5717067">var</span>&nbsp;<span class="ident" id="5717071">stmt</span>&nbsp;<span class="op" id="5717076">*</span><span class="ident" id="5717077">Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5717083">var</span>&nbsp;<span class="ident" id="5717087">err</span>&nbsp;<span class="builtintype" id="5717091">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5717098">for</span>&nbsp;<span class="ident" id="5717102">i</span>&nbsp;<span class="op" id="5717104">:=</span>&nbsp;<span class="num" id="5717107">0</span><span class="op" id="5717108">;</span>&nbsp;<span class="ident" id="5717110">i</span>&nbsp;<span class="op" id="5717112">&lt;</span>&nbsp;<span class="ident" id="5717114">maxBadConnRetries</span><span class="op" id="5717131">;</span>&nbsp;<span class="ident" id="5717133">i</span><span class="op" id="5717134">++</span>&nbsp;<span class="op" id="5717137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5717141">stmt</span><span class="op" id="5717145">,</span>&nbsp;<span class="ident" id="5717147">err</span>&nbsp;<span class="op" id="5717151">=</span>&nbsp;<span class="ident" id="5717153">db</span><span class="op" id="5717155">.</span><span class="ident" id="5717156">prepare</span><span class="op" id="5717163">(</span><span class="ident" id="5717164">query</span><span class="op" id="5717169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5717173">if</span>&nbsp;<span class="ident" id="5717176">err</span>&nbsp;<span class="op" id="5717180">!=</span>&nbsp;<span class="ident" id="5717183">driver</span><span class="op" id="5717189">.</span><span class="ident" id="5717190">ErrBadConn</span>&nbsp;<span class="op" id="5717201">{</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5717206">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5717214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5717217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5717220">return</span>&nbsp;<span class="ident" id="5717227">stmt</span><span class="op" id="5717231">,</span>&nbsp;<span class="ident" id="5717233">err</span><br>
<span class="lineno"></span><span class="op" id="5717237">}</span><br>
<span class="lineno">840</span><br>
<span class="lineno"></span><span class="keyword" id="5717240">func</span>&nbsp;<span class="op" id="5717245">(</span><span class="ident" id="5717246">db</span>&nbsp;<span class="op" id="5717249">*</span><span class="ident" id="5717250">DB</span><span class="op" id="5717252">)</span>&nbsp;<span class="ident" id="5717254">prepare</span><span class="op" id="5717261">(</span><span class="ident" id="5717262">query</span>&nbsp;<span class="builtintype" id="5717268">string</span><span class="op" id="5717274">)</span>&nbsp;<span class="op" id="5717276">(</span><span class="op" id="5717277">*</span><span class="ident" id="5717278">Stmt</span><span class="op" id="5717282">,</span>&nbsp;<span class="builtintype" id="5717284">error</span><span class="op" id="5717289">)</span>&nbsp;<span class="op" id="5717291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5717294">//&nbsp;TODO:&nbsp;check&nbsp;if&nbsp;db.driver&nbsp;supports&nbsp;an&nbsp;optional</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5717344">//&nbsp;driver.Preparer&nbsp;interface&nbsp;and&nbsp;call&nbsp;that&nbsp;instead,&nbsp;if&nbsp;so,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5717404">//&nbsp;otherwise&nbsp;we&nbsp;make&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;that&#39;s&nbsp;bound</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5717460">//&nbsp;to&nbsp;a&nbsp;connection,&nbsp;and&nbsp;to&nbsp;execute&nbsp;this&nbsp;prepared&nbsp;statement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5717520">//&nbsp;we&nbsp;either&nbsp;need&nbsp;to&nbsp;use&nbsp;this&nbsp;connection&nbsp;(if&nbsp;it&#39;s&nbsp;free),&nbsp;else</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5717583">//&nbsp;get&nbsp;a&nbsp;new&nbsp;connection&nbsp;+&nbsp;re-prepare&nbsp;+&nbsp;execute&nbsp;on&nbsp;that&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5717644">dc</span><span class="op" id="5717646">,</span>&nbsp;<span class="ident" id="5717648">err</span>&nbsp;<span class="op" id="5717652">:=</span>&nbsp;<span class="ident" id="5717655">db</span><span class="op" id="5717657">.</span><span class="ident" id="5717658">conn</span><span class="op" id="5717662">(</span><span class="op" id="5717663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5717666">if</span>&nbsp;<span class="ident" id="5717669">err</span>&nbsp;<span class="op" id="5717673">!=</span>&nbsp;<span class="ident" id="5717676">nil</span>&nbsp;<span class="op" id="5717680">{</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5717684">return</span>&nbsp;<span class="ident" id="5717691">nil</span><span class="op" id="5717694">,</span>&nbsp;<span class="ident" id="5717696">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5717701">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5717704">dc</span><span class="op" id="5717706">.</span><span class="ident" id="5717707">Lock</span><span class="op" id="5717711">(</span><span class="op" id="5717712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5717715">si</span><span class="op" id="5717717">,</span>&nbsp;<span class="ident" id="5717719">err</span>&nbsp;<span class="op" id="5717723">:=</span>&nbsp;<span class="ident" id="5717726">dc</span><span class="op" id="5717728">.</span><span class="ident" id="5717729">prepareLocked</span><span class="op" id="5717742">(</span><span class="ident" id="5717743">query</span><span class="op" id="5717748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5717751">dc</span><span class="op" id="5717753">.</span><span class="ident" id="5717754">Unlock</span><span class="op" id="5717760">(</span><span class="op" id="5717761">)</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5717764">if</span>&nbsp;<span class="ident" id="5717767">err</span>&nbsp;<span class="op" id="5717771">!=</span>&nbsp;<span class="ident" id="5717774">nil</span>&nbsp;<span class="op" id="5717778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5717782">db</span><span class="op" id="5717784">.</span><span class="ident" id="5717785">putConn</span><span class="op" id="5717792">(</span><span class="ident" id="5717793">dc</span><span class="op" id="5717795">,</span>&nbsp;<span class="ident" id="5717797">err</span><span class="op" id="5717800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5717804">return</span>&nbsp;<span class="ident" id="5717811">nil</span><span class="op" id="5717814">,</span>&nbsp;<span class="ident" id="5717816">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5717821">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5717824">stmt</span>&nbsp;<span class="op" id="5717829">:=</span>&nbsp;<span class="op" id="5717832">&amp;</span><span class="ident" id="5717833">Stmt</span><span class="op" id="5717837">{</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5717841">db</span><span class="op" id="5717843">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5717848">db</span><span class="op" id="5717850">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5717854">query</span><span class="op" id="5717859">:</span>&nbsp;<span class="ident" id="5717861">query</span><span class="op" id="5717866">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5717870">css</span><span class="op" id="5717873">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5717877">[</span><span class="op" id="5717878">]</span><span class="ident" id="5717879">connStmt</span><span class="op" id="5717887">{</span><span class="op" id="5717888">{</span><span class="ident" id="5717889">dc</span><span class="op" id="5717891">,</span>&nbsp;<span class="ident" id="5717893">si</span><span class="op" id="5717895">}</span><span class="op" id="5717896">}</span><span class="op" id="5717897">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5717900">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5717903">db</span><span class="op" id="5717905">.</span><span class="ident" id="5717906">addDep</span><span class="op" id="5717912">(</span><span class="ident" id="5717913">stmt</span><span class="op" id="5717917">,</span>&nbsp;<span class="ident" id="5717919">stmt</span><span class="op" id="5717923">)</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5717926">db</span><span class="op" id="5717928">.</span><span class="ident" id="5717929">putConn</span><span class="op" id="5717936">(</span><span class="ident" id="5717937">dc</span><span class="op" id="5717939">,</span>&nbsp;<span class="ident" id="5717941">nil</span><span class="op" id="5717944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5717947">return</span>&nbsp;<span class="ident" id="5717954">stmt</span><span class="op" id="5717958">,</span>&nbsp;<span class="ident" id="5717960">nil</span><br>
<span class="lineno"></span><span class="op" id="5717964">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5717967">//&nbsp;Exec&nbsp;executes&nbsp;a&nbsp;query&nbsp;without&nbsp;returning&nbsp;any&nbsp;rows.</span><br>
<span class="lineno">870</span><span class="comment" id="5718020">//&nbsp;The&nbsp;args&nbsp;are&nbsp;for&nbsp;any&nbsp;placeholder&nbsp;parameters&nbsp;in&nbsp;the&nbsp;query.</span><br>
<span class="lineno"></span><span class="keyword" id="5718081">func</span>&nbsp;<span class="op" id="5718086">(</span><span class="ident" id="5718087">db</span>&nbsp;<span class="op" id="5718090">*</span><span class="ident" id="5718091">DB</span><span class="op" id="5718093">)</span>&nbsp;<span class="ident" id="5718095">Exec</span><span class="op" id="5718099">(</span><span class="ident" id="5718100">query</span>&nbsp;<span class="builtintype" id="5718106">string</span><span class="op" id="5718112">,</span>&nbsp;<span class="ident" id="5718114">args</span>&nbsp;<span class="op" id="5718119">...</span><span class="keyword" id="5718122">interface</span><span class="op" id="5718131">{</span><span class="op" id="5718132">}</span><span class="op" id="5718133">)</span>&nbsp;<span class="op" id="5718135">(</span><span class="ident" id="5718136">Result</span><span class="op" id="5718142">,</span>&nbsp;<span class="builtintype" id="5718144">error</span><span class="op" id="5718149">)</span>&nbsp;<span class="op" id="5718151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5718154">var</span>&nbsp;<span class="ident" id="5718158">res</span>&nbsp;<span class="ident" id="5718162">Result</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5718170">var</span>&nbsp;<span class="ident" id="5718174">err</span>&nbsp;<span class="builtintype" id="5718178">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5718185">for</span>&nbsp;<span class="ident" id="5718189">i</span>&nbsp;<span class="op" id="5718191">:=</span>&nbsp;<span class="num" id="5718194">0</span><span class="op" id="5718195">;</span>&nbsp;<span class="ident" id="5718197">i</span>&nbsp;<span class="op" id="5718199">&lt;</span>&nbsp;<span class="ident" id="5718201">maxBadConnRetries</span><span class="op" id="5718218">;</span>&nbsp;<span class="ident" id="5718220">i</span><span class="op" id="5718221">++</span>&nbsp;<span class="op" id="5718224">{</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5718228">res</span><span class="op" id="5718231">,</span>&nbsp;<span class="ident" id="5718233">err</span>&nbsp;<span class="op" id="5718237">=</span>&nbsp;<span class="ident" id="5718239">db</span><span class="op" id="5718241">.</span><span class="ident" id="5718242">exec</span><span class="op" id="5718246">(</span><span class="ident" id="5718247">query</span><span class="op" id="5718252">,</span>&nbsp;<span class="ident" id="5718254">args</span><span class="op" id="5718258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5718262">if</span>&nbsp;<span class="ident" id="5718265">err</span>&nbsp;<span class="op" id="5718269">!=</span>&nbsp;<span class="ident" id="5718272">driver</span><span class="op" id="5718278">.</span><span class="ident" id="5718279">ErrBadConn</span>&nbsp;<span class="op" id="5718290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5718295">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5718303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5718306">}</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5718309">return</span>&nbsp;<span class="ident" id="5718316">res</span><span class="op" id="5718319">,</span>&nbsp;<span class="ident" id="5718321">err</span><br>
<span class="lineno"></span><span class="op" id="5718325">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5718328">func</span>&nbsp;<span class="op" id="5718333">(</span><span class="ident" id="5718334">db</span>&nbsp;<span class="op" id="5718337">*</span><span class="ident" id="5718338">DB</span><span class="op" id="5718340">)</span>&nbsp;<span class="ident" id="5718342">exec</span><span class="op" id="5718346">(</span><span class="ident" id="5718347">query</span>&nbsp;<span class="builtintype" id="5718353">string</span><span class="op" id="5718359">,</span>&nbsp;<span class="ident" id="5718361">args</span>&nbsp;<span class="op" id="5718366">[</span><span class="op" id="5718367">]</span><span class="keyword" id="5718368">interface</span><span class="op" id="5718377">{</span><span class="op" id="5718378">}</span><span class="op" id="5718379">)</span>&nbsp;<span class="op" id="5718381">(</span><span class="ident" id="5718382">res</span>&nbsp;<span class="ident" id="5718386">Result</span><span class="op" id="5718392">,</span>&nbsp;<span class="ident" id="5718394">err</span>&nbsp;<span class="builtintype" id="5718398">error</span><span class="op" id="5718403">)</span>&nbsp;<span class="op" id="5718405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5718408">dc</span><span class="op" id="5718410">,</span>&nbsp;<span class="ident" id="5718412">err</span>&nbsp;<span class="op" id="5718416">:=</span>&nbsp;<span class="ident" id="5718419">db</span><span class="op" id="5718421">.</span><span class="ident" id="5718422">conn</span><span class="op" id="5718426">(</span><span class="op" id="5718427">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5718430">if</span>&nbsp;<span class="ident" id="5718433">err</span>&nbsp;<span class="op" id="5718437">!=</span>&nbsp;<span class="ident" id="5718440">nil</span>&nbsp;<span class="op" id="5718444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5718448">return</span>&nbsp;<span class="ident" id="5718455">nil</span><span class="op" id="5718458">,</span>&nbsp;<span class="ident" id="5718460">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5718465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5718468">defer</span>&nbsp;<span class="keyword" id="5718474">func</span><span class="op" id="5718478">(</span><span class="op" id="5718479">)</span>&nbsp;<span class="op" id="5718481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5718485">db</span><span class="op" id="5718487">.</span><span class="ident" id="5718488">putConn</span><span class="op" id="5718495">(</span><span class="ident" id="5718496">dc</span><span class="op" id="5718498">,</span>&nbsp;<span class="ident" id="5718500">err</span><span class="op" id="5718503">)</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5718506">}</span><span class="op" id="5718507">(</span><span class="op" id="5718508">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5718512">if</span>&nbsp;<span class="ident" id="5718515">execer</span><span class="op" id="5718521">,</span>&nbsp;<span class="ident" id="5718523">ok</span>&nbsp;<span class="op" id="5718526">:=</span>&nbsp;<span class="ident" id="5718529">dc</span><span class="op" id="5718531">.</span><span class="ident" id="5718532">ci</span><span class="op" id="5718534">.</span><span class="op" id="5718535">(</span><span class="ident" id="5718536">driver</span><span class="op" id="5718542">.</span><span class="ident" id="5718543">Execer</span><span class="op" id="5718549">)</span><span class="op" id="5718550">;</span>&nbsp;<span class="ident" id="5718552">ok</span>&nbsp;<span class="op" id="5718555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5718559">dargs</span><span class="op" id="5718564">,</span>&nbsp;<span class="ident" id="5718566">err</span>&nbsp;<span class="op" id="5718570">:=</span>&nbsp;<span class="ident" id="5718573">driverArgs</span><span class="op" id="5718583">(</span><span class="ident" id="5718584">nil</span><span class="op" id="5718587">,</span>&nbsp;<span class="ident" id="5718589">args</span><span class="op" id="5718593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5718597">if</span>&nbsp;<span class="ident" id="5718600">err</span>&nbsp;<span class="op" id="5718604">!=</span>&nbsp;<span class="ident" id="5718607">nil</span>&nbsp;<span class="op" id="5718611">{</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5718616">return</span>&nbsp;<span class="ident" id="5718623">nil</span><span class="op" id="5718626">,</span>&nbsp;<span class="ident" id="5718628">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5718634">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5718638">dc</span><span class="op" id="5718640">.</span><span class="ident" id="5718641">Lock</span><span class="op" id="5718645">(</span><span class="op" id="5718646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5718650">resi</span><span class="op" id="5718654">,</span>&nbsp;<span class="ident" id="5718656">err</span>&nbsp;<span class="op" id="5718660">:=</span>&nbsp;<span class="ident" id="5718663">execer</span><span class="op" id="5718669">.</span><span class="ident" id="5718670">Exec</span><span class="op" id="5718674">(</span><span class="ident" id="5718675">query</span><span class="op" id="5718680">,</span>&nbsp;<span class="ident" id="5718682">dargs</span><span class="op" id="5718687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5718691">dc</span><span class="op" id="5718693">.</span><span class="ident" id="5718694">Unlock</span><span class="op" id="5718700">(</span><span class="op" id="5718701">)</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5718705">if</span>&nbsp;<span class="ident" id="5718708">err</span>&nbsp;<span class="op" id="5718712">!=</span>&nbsp;<span class="ident" id="5718715">driver</span><span class="op" id="5718721">.</span><span class="ident" id="5718722">ErrSkip</span>&nbsp;<span class="op" id="5718730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5718735">if</span>&nbsp;<span class="ident" id="5718738">err</span>&nbsp;<span class="op" id="5718742">!=</span>&nbsp;<span class="ident" id="5718745">nil</span>&nbsp;<span class="op" id="5718749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5718755">return</span>&nbsp;<span class="ident" id="5718762">nil</span><span class="op" id="5718765">,</span>&nbsp;<span class="ident" id="5718767">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5718774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5718779">return</span>&nbsp;<span class="ident" id="5718786">driverResult</span><span class="op" id="5718798">{</span><span class="ident" id="5718799">dc</span><span class="op" id="5718801">,</span>&nbsp;<span class="ident" id="5718803">resi</span><span class="op" id="5718807">}</span><span class="op" id="5718808">,</span>&nbsp;<span class="ident" id="5718810">nil</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5718816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5718819">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5718823">dc</span><span class="op" id="5718825">.</span><span class="ident" id="5718826">Lock</span><span class="op" id="5718830">(</span><span class="op" id="5718831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5718834">si</span><span class="op" id="5718836">,</span>&nbsp;<span class="ident" id="5718838">err</span>&nbsp;<span class="op" id="5718842">:=</span>&nbsp;<span class="ident" id="5718845">dc</span><span class="op" id="5718847">.</span><span class="ident" id="5718848">ci</span><span class="op" id="5718850">.</span><span class="ident" id="5718851">Prepare</span><span class="op" id="5718858">(</span><span class="ident" id="5718859">query</span><span class="op" id="5718864">)</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5718867">dc</span><span class="op" id="5718869">.</span><span class="ident" id="5718870">Unlock</span><span class="op" id="5718876">(</span><span class="op" id="5718877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5718880">if</span>&nbsp;<span class="ident" id="5718883">err</span>&nbsp;<span class="op" id="5718887">!=</span>&nbsp;<span class="ident" id="5718890">nil</span>&nbsp;<span class="op" id="5718894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5718898">return</span>&nbsp;<span class="ident" id="5718905">nil</span><span class="op" id="5718908">,</span>&nbsp;<span class="ident" id="5718910">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5718915">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5718918">defer</span>&nbsp;<span class="ident" id="5718924">withLock</span><span class="op" id="5718932">(</span><span class="ident" id="5718933">dc</span><span class="op" id="5718935">,</span>&nbsp;<span class="keyword" id="5718937">func</span><span class="op" id="5718941">(</span><span class="op" id="5718942">)</span>&nbsp;<span class="op" id="5718944">{</span>&nbsp;<span class="ident" id="5718946">si</span><span class="op" id="5718948">.</span><span class="ident" id="5718949">Close</span><span class="op" id="5718954">(</span><span class="op" id="5718955">)</span>&nbsp;<span class="op" id="5718957">}</span><span class="op" id="5718958">)</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5718961">return</span>&nbsp;<span class="ident" id="5718968">resultFromStatement</span><span class="op" id="5718987">(</span><span class="ident" id="5718988">driverStmt</span><span class="op" id="5718998">{</span><span class="ident" id="5718999">dc</span><span class="op" id="5719001">,</span>&nbsp;<span class="ident" id="5719003">si</span><span class="op" id="5719005">}</span><span class="op" id="5719006">,</span>&nbsp;<span class="ident" id="5719008">args</span><span class="op" id="5719012">...</span><span class="op" id="5719015">)</span><br>
<span class="lineno"></span><span class="op" id="5719017">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5719020">//&nbsp;Query&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;returns&nbsp;rows,&nbsp;typically&nbsp;a&nbsp;SELECT.</span><br>
<span class="lineno"></span><span class="comment" id="5719085">//&nbsp;The&nbsp;args&nbsp;are&nbsp;for&nbsp;any&nbsp;placeholder&nbsp;parameters&nbsp;in&nbsp;the&nbsp;query.</span><br>
<span class="lineno">920</span><span class="keyword" id="5719146">func</span>&nbsp;<span class="op" id="5719151">(</span><span class="ident" id="5719152">db</span>&nbsp;<span class="op" id="5719155">*</span><span class="ident" id="5719156">DB</span><span class="op" id="5719158">)</span>&nbsp;<span class="ident" id="5719160">Query</span><span class="op" id="5719165">(</span><span class="ident" id="5719166">query</span>&nbsp;<span class="builtintype" id="5719172">string</span><span class="op" id="5719178">,</span>&nbsp;<span class="ident" id="5719180">args</span>&nbsp;<span class="op" id="5719185">...</span><span class="keyword" id="5719188">interface</span><span class="op" id="5719197">{</span><span class="op" id="5719198">}</span><span class="op" id="5719199">)</span>&nbsp;<span class="op" id="5719201">(</span><span class="op" id="5719202">*</span><span class="ident" id="5719203">Rows</span><span class="op" id="5719207">,</span>&nbsp;<span class="builtintype" id="5719209">error</span><span class="op" id="5719214">)</span>&nbsp;<span class="op" id="5719216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5719219">var</span>&nbsp;<span class="ident" id="5719223">rows</span>&nbsp;<span class="op" id="5719228">*</span><span class="ident" id="5719229">Rows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5719235">var</span>&nbsp;<span class="ident" id="5719239">err</span>&nbsp;<span class="builtintype" id="5719243">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5719250">for</span>&nbsp;<span class="ident" id="5719254">i</span>&nbsp;<span class="op" id="5719256">:=</span>&nbsp;<span class="num" id="5719259">0</span><span class="op" id="5719260">;</span>&nbsp;<span class="ident" id="5719262">i</span>&nbsp;<span class="op" id="5719264">&lt;</span>&nbsp;<span class="ident" id="5719266">maxBadConnRetries</span><span class="op" id="5719283">;</span>&nbsp;<span class="ident" id="5719285">i</span><span class="op" id="5719286">++</span>&nbsp;<span class="op" id="5719289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5719293">rows</span><span class="op" id="5719297">,</span>&nbsp;<span class="ident" id="5719299">err</span>&nbsp;<span class="op" id="5719303">=</span>&nbsp;<span class="ident" id="5719305">db</span><span class="op" id="5719307">.</span><span class="ident" id="5719308">query</span><span class="op" id="5719313">(</span><span class="ident" id="5719314">query</span><span class="op" id="5719319">,</span>&nbsp;<span class="ident" id="5719321">args</span><span class="op" id="5719325">)</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5719329">if</span>&nbsp;<span class="ident" id="5719332">err</span>&nbsp;<span class="op" id="5719336">!=</span>&nbsp;<span class="ident" id="5719339">driver</span><span class="op" id="5719345">.</span><span class="ident" id="5719346">ErrBadConn</span>&nbsp;<span class="op" id="5719357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5719362">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5719370">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5719373">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5719376">return</span>&nbsp;<span class="ident" id="5719383">rows</span><span class="op" id="5719387">,</span>&nbsp;<span class="ident" id="5719389">err</span><br>
<span class="lineno">930</span><span class="op" id="5719393">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5719396">func</span>&nbsp;<span class="op" id="5719401">(</span><span class="ident" id="5719402">db</span>&nbsp;<span class="op" id="5719405">*</span><span class="ident" id="5719406">DB</span><span class="op" id="5719408">)</span>&nbsp;<span class="ident" id="5719410">query</span><span class="op" id="5719415">(</span><span class="ident" id="5719416">query</span>&nbsp;<span class="builtintype" id="5719422">string</span><span class="op" id="5719428">,</span>&nbsp;<span class="ident" id="5719430">args</span>&nbsp;<span class="op" id="5719435">[</span><span class="op" id="5719436">]</span><span class="keyword" id="5719437">interface</span><span class="op" id="5719446">{</span><span class="op" id="5719447">}</span><span class="op" id="5719448">)</span>&nbsp;<span class="op" id="5719450">(</span><span class="op" id="5719451">*</span><span class="ident" id="5719452">Rows</span><span class="op" id="5719456">,</span>&nbsp;<span class="builtintype" id="5719458">error</span><span class="op" id="5719463">)</span>&nbsp;<span class="op" id="5719465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5719468">ci</span><span class="op" id="5719470">,</span>&nbsp;<span class="ident" id="5719472">err</span>&nbsp;<span class="op" id="5719476">:=</span>&nbsp;<span class="ident" id="5719479">db</span><span class="op" id="5719481">.</span><span class="ident" id="5719482">conn</span><span class="op" id="5719486">(</span><span class="op" id="5719487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5719490">if</span>&nbsp;<span class="ident" id="5719493">err</span>&nbsp;<span class="op" id="5719497">!=</span>&nbsp;<span class="ident" id="5719500">nil</span>&nbsp;<span class="op" id="5719504">{</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5719508">return</span>&nbsp;<span class="ident" id="5719515">nil</span><span class="op" id="5719518">,</span>&nbsp;<span class="ident" id="5719520">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5719525">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5719529">return</span>&nbsp;<span class="ident" id="5719536">db</span><span class="op" id="5719538">.</span><span class="ident" id="5719539">queryConn</span><span class="op" id="5719548">(</span><span class="ident" id="5719549">ci</span><span class="op" id="5719551">,</span>&nbsp;<span class="ident" id="5719553">ci</span><span class="op" id="5719555">.</span><span class="ident" id="5719556">releaseConn</span><span class="op" id="5719567">,</span>&nbsp;<span class="ident" id="5719569">query</span><span class="op" id="5719574">,</span>&nbsp;<span class="ident" id="5719576">args</span><span class="op" id="5719580">)</span><br>
<span class="lineno"></span><span class="op" id="5719582">}</span><br>
<span class="lineno">940</span><br>
<span class="lineno"></span><span class="comment" id="5719585">//&nbsp;queryConn&nbsp;executes&nbsp;a&nbsp;query&nbsp;on&nbsp;the&nbsp;given&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="5719640">//&nbsp;The&nbsp;connection&nbsp;gets&nbsp;released&nbsp;by&nbsp;the&nbsp;releaseConn&nbsp;function.</span><br>
<span class="lineno"></span><span class="keyword" id="5719701">func</span>&nbsp;<span class="op" id="5719706">(</span><span class="ident" id="5719707">db</span>&nbsp;<span class="op" id="5719710">*</span><span class="ident" id="5719711">DB</span><span class="op" id="5719713">)</span>&nbsp;<span class="ident" id="5719715">queryConn</span><span class="op" id="5719724">(</span><span class="ident" id="5719725">dc</span>&nbsp;<span class="op" id="5719728">*</span><span class="ident" id="5719729">driverConn</span><span class="op" id="5719739">,</span>&nbsp;<span class="ident" id="5719741">releaseConn</span>&nbsp;<span class="keyword" id="5719753">func</span><span class="op" id="5719757">(</span><span class="builtintype" id="5719758">error</span><span class="op" id="5719763">)</span><span class="op" id="5719764">,</span>&nbsp;<span class="ident" id="5719766">query</span>&nbsp;<span class="builtintype" id="5719772">string</span><span class="op" id="5719778">,</span>&nbsp;<span class="ident" id="5719780">args</span>&nbsp;<span class="op" id="5719785">[</span><span class="op" id="5719786">]</span><span class="keyword" id="5719787">interface</span><span class="op" id="5719796">{</span><span class="op" id="5719797">}</span><span class="op" id="5719798">)</span>&nbsp;<span class="op" id="5719800">(</span><span class="op" id="5719801">*</span><span class="ident" id="5719802">Rows</span><span class="op" id="5719806">,</span>&nbsp;<span class="builtintype" id="5719808">error</span><span class="op" id="5719813">)</span>&nbsp;<span class="op" id="5719815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5719818">if</span>&nbsp;<span class="ident" id="5719821">queryer</span><span class="op" id="5719828">,</span>&nbsp;<span class="ident" id="5719830">ok</span>&nbsp;<span class="op" id="5719833">:=</span>&nbsp;<span class="ident" id="5719836">dc</span><span class="op" id="5719838">.</span><span class="ident" id="5719839">ci</span><span class="op" id="5719841">.</span><span class="op" id="5719842">(</span><span class="ident" id="5719843">driver</span><span class="op" id="5719849">.</span><span class="ident" id="5719850">Queryer</span><span class="op" id="5719857">)</span><span class="op" id="5719858">;</span>&nbsp;<span class="ident" id="5719860">ok</span>&nbsp;<span class="op" id="5719863">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5719867">dargs</span><span class="op" id="5719872">,</span>&nbsp;<span class="ident" id="5719874">err</span>&nbsp;<span class="op" id="5719878">:=</span>&nbsp;<span class="ident" id="5719881">driverArgs</span><span class="op" id="5719891">(</span><span class="ident" id="5719892">nil</span><span class="op" id="5719895">,</span>&nbsp;<span class="ident" id="5719897">args</span><span class="op" id="5719901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5719905">if</span>&nbsp;<span class="ident" id="5719908">err</span>&nbsp;<span class="op" id="5719912">!=</span>&nbsp;<span class="ident" id="5719915">nil</span>&nbsp;<span class="op" id="5719919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5719924">releaseConn</span><span class="op" id="5719935">(</span><span class="ident" id="5719936">err</span><span class="op" id="5719939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5719944">return</span>&nbsp;<span class="ident" id="5719951">nil</span><span class="op" id="5719954">,</span>&nbsp;<span class="ident" id="5719956">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5719962">}</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5719966">dc</span><span class="op" id="5719968">.</span><span class="ident" id="5719969">Lock</span><span class="op" id="5719973">(</span><span class="op" id="5719974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5719978">rowsi</span><span class="op" id="5719983">,</span>&nbsp;<span class="ident" id="5719985">err</span>&nbsp;<span class="op" id="5719989">:=</span>&nbsp;<span class="ident" id="5719992">queryer</span><span class="op" id="5719999">.</span><span class="ident" id="5720000">Query</span><span class="op" id="5720005">(</span><span class="ident" id="5720006">query</span><span class="op" id="5720011">,</span>&nbsp;<span class="ident" id="5720013">dargs</span><span class="op" id="5720018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5720022">dc</span><span class="op" id="5720024">.</span><span class="ident" id="5720025">Unlock</span><span class="op" id="5720031">(</span><span class="op" id="5720032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5720036">if</span>&nbsp;<span class="ident" id="5720039">err</span>&nbsp;<span class="op" id="5720043">!=</span>&nbsp;<span class="ident" id="5720046">driver</span><span class="op" id="5720052">.</span><span class="ident" id="5720053">ErrSkip</span>&nbsp;<span class="op" id="5720061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5720066">if</span>&nbsp;<span class="ident" id="5720069">err</span>&nbsp;<span class="op" id="5720073">!=</span>&nbsp;<span class="ident" id="5720076">nil</span>&nbsp;<span class="op" id="5720080">{</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5720086">releaseConn</span><span class="op" id="5720097">(</span><span class="ident" id="5720098">err</span><span class="op" id="5720101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5720107">return</span>&nbsp;<span class="ident" id="5720114">nil</span><span class="op" id="5720117">,</span>&nbsp;<span class="ident" id="5720119">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5720126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5720131">//&nbsp;Note:&nbsp;ownership&nbsp;of&nbsp;dc&nbsp;passes&nbsp;to&nbsp;the&nbsp;*Rows,&nbsp;to&nbsp;be&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5720192">//&nbsp;with&nbsp;releaseConn.</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5720216">rows</span>&nbsp;<span class="op" id="5720221">:=</span>&nbsp;<span class="op" id="5720224">&amp;</span><span class="ident" id="5720225">Rows</span><span class="op" id="5720229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5720235">dc</span><span class="op" id="5720237">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5720248">dc</span><span class="op" id="5720250">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5720256">releaseConn</span><span class="op" id="5720267">:</span>&nbsp;<span class="ident" id="5720269">releaseConn</span><span class="op" id="5720280">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5720286">rowsi</span><span class="op" id="5720291">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5720299">rowsi</span><span class="op" id="5720304">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5720309">}</span><br>
<span class="lineno">965</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5720314">return</span>&nbsp;<span class="ident" id="5720321">rows</span><span class="op" id="5720325">,</span>&nbsp;<span class="ident" id="5720327">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5720333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5720336">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5720340">dc</span><span class="op" id="5720342">.</span><span class="ident" id="5720343">Lock</span><span class="op" id="5720347">(</span><span class="op" id="5720348">)</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5720351">si</span><span class="op" id="5720353">,</span>&nbsp;<span class="ident" id="5720355">err</span>&nbsp;<span class="op" id="5720359">:=</span>&nbsp;<span class="ident" id="5720362">dc</span><span class="op" id="5720364">.</span><span class="ident" id="5720365">ci</span><span class="op" id="5720367">.</span><span class="ident" id="5720368">Prepare</span><span class="op" id="5720375">(</span><span class="ident" id="5720376">query</span><span class="op" id="5720381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5720384">dc</span><span class="op" id="5720386">.</span><span class="ident" id="5720387">Unlock</span><span class="op" id="5720393">(</span><span class="op" id="5720394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5720397">if</span>&nbsp;<span class="ident" id="5720400">err</span>&nbsp;<span class="op" id="5720404">!=</span>&nbsp;<span class="ident" id="5720407">nil</span>&nbsp;<span class="op" id="5720411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5720415">releaseConn</span><span class="op" id="5720426">(</span><span class="ident" id="5720427">err</span><span class="op" id="5720430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5720434">return</span>&nbsp;<span class="ident" id="5720441">nil</span><span class="op" id="5720444">,</span>&nbsp;<span class="ident" id="5720446">err</span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5720451">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5720455">ds</span>&nbsp;<span class="op" id="5720458">:=</span>&nbsp;<span class="ident" id="5720461">driverStmt</span><span class="op" id="5720471">{</span><span class="ident" id="5720472">dc</span><span class="op" id="5720474">,</span>&nbsp;<span class="ident" id="5720476">si</span><span class="op" id="5720478">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5720481">rowsi</span><span class="op" id="5720486">,</span>&nbsp;<span class="ident" id="5720488">err</span>&nbsp;<span class="op" id="5720492">:=</span>&nbsp;<span class="ident" id="5720495">rowsiFromStatement</span><span class="op" id="5720513">(</span><span class="ident" id="5720514">ds</span><span class="op" id="5720516">,</span>&nbsp;<span class="ident" id="5720518">args</span><span class="op" id="5720522">...</span><span class="op" id="5720525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5720528">if</span>&nbsp;<span class="ident" id="5720531">err</span>&nbsp;<span class="op" id="5720535">!=</span>&nbsp;<span class="ident" id="5720538">nil</span>&nbsp;<span class="op" id="5720542">{</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5720546">dc</span><span class="op" id="5720548">.</span><span class="ident" id="5720549">Lock</span><span class="op" id="5720553">(</span><span class="op" id="5720554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5720558">si</span><span class="op" id="5720560">.</span><span class="ident" id="5720561">Close</span><span class="op" id="5720566">(</span><span class="op" id="5720567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5720571">dc</span><span class="op" id="5720573">.</span><span class="ident" id="5720574">Unlock</span><span class="op" id="5720580">(</span><span class="op" id="5720581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5720585">releaseConn</span><span class="op" id="5720596">(</span><span class="ident" id="5720597">err</span><span class="op" id="5720600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5720604">return</span>&nbsp;<span class="ident" id="5720611">nil</span><span class="op" id="5720614">,</span>&nbsp;<span class="ident" id="5720616">err</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5720621">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5720625">//&nbsp;Note:&nbsp;ownership&nbsp;of&nbsp;ci&nbsp;passes&nbsp;to&nbsp;the&nbsp;*Rows,&nbsp;to&nbsp;be&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5720684">//&nbsp;with&nbsp;releaseConn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5720706">rows</span>&nbsp;<span class="op" id="5720711">:=</span>&nbsp;<span class="op" id="5720714">&amp;</span><span class="ident" id="5720715">Rows</span><span class="op" id="5720719">{</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5720723">dc</span><span class="op" id="5720725">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5720736">dc</span><span class="op" id="5720738">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5720742">releaseConn</span><span class="op" id="5720753">:</span>&nbsp;<span class="ident" id="5720755">releaseConn</span><span class="op" id="5720766">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5720770">rowsi</span><span class="op" id="5720775">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5720783">rowsi</span><span class="op" id="5720788">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5720792">closeStmt</span><span class="op" id="5720801">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5720805">si</span><span class="op" id="5720807">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5720810">}</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5720813">return</span>&nbsp;<span class="ident" id="5720820">rows</span><span class="op" id="5720824">,</span>&nbsp;<span class="ident" id="5720826">nil</span><br>
<span class="lineno"></span><span class="op" id="5720830">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5720833">//&nbsp;QueryRow&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;is&nbsp;expected&nbsp;to&nbsp;return&nbsp;at&nbsp;most&nbsp;one&nbsp;row.</span><br>
<span class="lineno"></span><span class="comment" id="5720906">//&nbsp;QueryRow&nbsp;always&nbsp;return&nbsp;a&nbsp;non-nil&nbsp;value.&nbsp;Errors&nbsp;are&nbsp;deferred&nbsp;until</span><br>
<span class="lineno">1000</span><span class="comment" id="5720975">//&nbsp;Row&#39;s&nbsp;Scan&nbsp;method&nbsp;is&nbsp;called.</span><br>
<span class="lineno"></span><span class="keyword" id="5721007">func</span>&nbsp;<span class="op" id="5721012">(</span><span class="ident" id="5721013">db</span>&nbsp;<span class="op" id="5721016">*</span><span class="ident" id="5721017">DB</span><span class="op" id="5721019">)</span>&nbsp;<span class="ident" id="5721021">QueryRow</span><span class="op" id="5721029">(</span><span class="ident" id="5721030">query</span>&nbsp;<span class="builtintype" id="5721036">string</span><span class="op" id="5721042">,</span>&nbsp;<span class="ident" id="5721044">args</span>&nbsp;<span class="op" id="5721049">...</span><span class="keyword" id="5721052">interface</span><span class="op" id="5721061">{</span><span class="op" id="5721062">}</span><span class="op" id="5721063">)</span>&nbsp;<span class="op" id="5721065">*</span><span class="ident" id="5721066">Row</span>&nbsp;<span class="op" id="5721070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5721073">rows</span><span class="op" id="5721077">,</span>&nbsp;<span class="ident" id="5721079">err</span>&nbsp;<span class="op" id="5721083">:=</span>&nbsp;<span class="ident" id="5721086">db</span><span class="op" id="5721088">.</span><span class="ident" id="5721089">Query</span><span class="op" id="5721094">(</span><span class="ident" id="5721095">query</span><span class="op" id="5721100">,</span>&nbsp;<span class="ident" id="5721102">args</span><span class="op" id="5721106">...</span><span class="op" id="5721109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5721112">return</span>&nbsp;<span class="op" id="5721119">&amp;</span><span class="ident" id="5721120">Row</span><span class="op" id="5721123">{</span><span class="ident" id="5721124">rows</span><span class="op" id="5721128">:</span>&nbsp;<span class="ident" id="5721130">rows</span><span class="op" id="5721134">,</span>&nbsp;<span class="ident" id="5721136">err</span><span class="op" id="5721139">:</span>&nbsp;<span class="ident" id="5721141">err</span><span class="op" id="5721144">}</span><br>
<span class="lineno"></span><span class="op" id="5721146">}</span><br>
<span class="lineno">1005</span><br>
<span class="lineno"></span><span class="comment" id="5721149">//&nbsp;Begin&nbsp;starts&nbsp;a&nbsp;transaction.&nbsp;The&nbsp;isolation&nbsp;level&nbsp;is&nbsp;dependent&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="5721216">//&nbsp;the&nbsp;driver.</span><br>
<span class="lineno"></span><span class="keyword" id="5721231">func</span>&nbsp;<span class="op" id="5721236">(</span><span class="ident" id="5721237">db</span>&nbsp;<span class="op" id="5721240">*</span><span class="ident" id="5721241">DB</span><span class="op" id="5721243">)</span>&nbsp;<span class="ident" id="5721245">Begin</span><span class="op" id="5721250">(</span><span class="op" id="5721251">)</span>&nbsp;<span class="op" id="5721253">(</span><span class="op" id="5721254">*</span><span class="ident" id="5721255">Tx</span><span class="op" id="5721257">,</span>&nbsp;<span class="builtintype" id="5721259">error</span><span class="op" id="5721264">)</span>&nbsp;<span class="op" id="5721266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5721269">var</span>&nbsp;<span class="ident" id="5721273">tx</span>&nbsp;<span class="op" id="5721276">*</span><span class="ident" id="5721277">Tx</span><br>
<span class="lineno">1010</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5721281">var</span>&nbsp;<span class="ident" id="5721285">err</span>&nbsp;<span class="builtintype" id="5721289">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5721296">for</span>&nbsp;<span class="ident" id="5721300">i</span>&nbsp;<span class="op" id="5721302">:=</span>&nbsp;<span class="num" id="5721305">0</span><span class="op" id="5721306">;</span>&nbsp;<span class="ident" id="5721308">i</span>&nbsp;<span class="op" id="5721310">&lt;</span>&nbsp;<span class="ident" id="5721312">maxBadConnRetries</span><span class="op" id="5721329">;</span>&nbsp;<span class="ident" id="5721331">i</span><span class="op" id="5721332">++</span>&nbsp;<span class="op" id="5721335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5721339">tx</span><span class="op" id="5721341">,</span>&nbsp;<span class="ident" id="5721343">err</span>&nbsp;<span class="op" id="5721347">=</span>&nbsp;<span class="ident" id="5721349">db</span><span class="op" id="5721351">.</span><span class="ident" id="5721352">begin</span><span class="op" id="5721357">(</span><span class="op" id="5721358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5721362">if</span>&nbsp;<span class="ident" id="5721365">err</span>&nbsp;<span class="op" id="5721369">!=</span>&nbsp;<span class="ident" id="5721372">driver</span><span class="op" id="5721378">.</span><span class="ident" id="5721379">ErrBadConn</span>&nbsp;<span class="op" id="5721390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5721395">break</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5721403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5721406">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5721409">return</span>&nbsp;<span class="ident" id="5721416">tx</span><span class="op" id="5721418">,</span>&nbsp;<span class="ident" id="5721420">err</span><br>
<span class="lineno"></span><span class="op" id="5721424">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1020</span><span class="keyword" id="5721427">func</span>&nbsp;<span class="op" id="5721432">(</span><span class="ident" id="5721433">db</span>&nbsp;<span class="op" id="5721436">*</span><span class="ident" id="5721437">DB</span><span class="op" id="5721439">)</span>&nbsp;<span class="ident" id="5721441">begin</span><span class="op" id="5721446">(</span><span class="op" id="5721447">)</span>&nbsp;<span class="op" id="5721449">(</span><span class="ident" id="5721450">tx</span>&nbsp;<span class="op" id="5721453">*</span><span class="ident" id="5721454">Tx</span><span class="op" id="5721456">,</span>&nbsp;<span class="ident" id="5721458">err</span>&nbsp;<span class="builtintype" id="5721462">error</span><span class="op" id="5721467">)</span>&nbsp;<span class="op" id="5721469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5721472">dc</span><span class="op" id="5721474">,</span>&nbsp;<span class="ident" id="5721476">err</span>&nbsp;<span class="op" id="5721480">:=</span>&nbsp;<span class="ident" id="5721483">db</span><span class="op" id="5721485">.</span><span class="ident" id="5721486">conn</span><span class="op" id="5721490">(</span><span class="op" id="5721491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5721494">if</span>&nbsp;<span class="ident" id="5721497">err</span>&nbsp;<span class="op" id="5721501">!=</span>&nbsp;<span class="ident" id="5721504">nil</span>&nbsp;<span class="op" id="5721508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5721512">return</span>&nbsp;<span class="ident" id="5721519">nil</span><span class="op" id="5721522">,</span>&nbsp;<span class="ident" id="5721524">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5721529">}</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5721532">dc</span><span class="op" id="5721534">.</span><span class="ident" id="5721535">Lock</span><span class="op" id="5721539">(</span><span class="op" id="5721540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5721543">txi</span><span class="op" id="5721546">,</span>&nbsp;<span class="ident" id="5721548">err</span>&nbsp;<span class="op" id="5721552">:=</span>&nbsp;<span class="ident" id="5721555">dc</span><span class="op" id="5721557">.</span><span class="ident" id="5721558">ci</span><span class="op" id="5721560">.</span><span class="ident" id="5721561">Begin</span><span class="op" id="5721566">(</span><span class="op" id="5721567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5721570">dc</span><span class="op" id="5721572">.</span><span class="ident" id="5721573">Unlock</span><span class="op" id="5721579">(</span><span class="op" id="5721580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5721583">if</span>&nbsp;<span class="ident" id="5721586">err</span>&nbsp;<span class="op" id="5721590">!=</span>&nbsp;<span class="ident" id="5721593">nil</span>&nbsp;<span class="op" id="5721597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5721601">db</span><span class="op" id="5721603">.</span><span class="ident" id="5721604">putConn</span><span class="op" id="5721611">(</span><span class="ident" id="5721612">dc</span><span class="op" id="5721614">,</span>&nbsp;<span class="ident" id="5721616">err</span><span class="op" id="5721619">)</span><br>
<span class="lineno">1030</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5721623">return</span>&nbsp;<span class="ident" id="5721630">nil</span><span class="op" id="5721633">,</span>&nbsp;<span class="ident" id="5721635">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5721640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5721643">return</span>&nbsp;<span class="op" id="5721650">&amp;</span><span class="ident" id="5721651">Tx</span><span class="op" id="5721653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5721657">db</span><span class="op" id="5721659">:</span>&nbsp;&nbsp;<span class="ident" id="5721662">db</span><span class="op" id="5721664">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5721668">dc</span><span class="op" id="5721670">:</span>&nbsp;&nbsp;<span class="ident" id="5721673">dc</span><span class="op" id="5721675">,</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5721679">txi</span><span class="op" id="5721682">:</span>&nbsp;<span class="ident" id="5721684">txi</span><span class="op" id="5721687">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5721690">}</span><span class="op" id="5721691">,</span>&nbsp;<span class="ident" id="5721693">nil</span><br>
<span class="lineno"></span><span class="op" id="5721697">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5721700">//&nbsp;Driver&nbsp;returns&nbsp;the&nbsp;database&#39;s&nbsp;underlying&nbsp;driver.</span><br>
<span class="lineno">1040</span><span class="keyword" id="5721752">func</span>&nbsp;<span class="op" id="5721757">(</span><span class="ident" id="5721758">db</span>&nbsp;<span class="op" id="5721761">*</span><span class="ident" id="5721762">DB</span><span class="op" id="5721764">)</span>&nbsp;<span class="ident" id="5721766">Driver</span><span class="op" id="5721772">(</span><span class="op" id="5721773">)</span>&nbsp;<span class="ident" id="5721775">driver</span><span class="op" id="5721781">.</span><span class="ident" id="5721782">Driver</span>&nbsp;<span class="op" id="5721789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5721792">return</span>&nbsp;<span class="ident" id="5721799">db</span><span class="op" id="5721801">.</span><span class="ident" id="5721802">driver</span><br>
<span class="lineno"></span><span class="op" id="5721809">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5721812">//&nbsp;Tx&nbsp;is&nbsp;an&nbsp;in-progress&nbsp;database&nbsp;transaction.</span><br>
<span class="lineno">1045</span><span class="comment" id="5721858">//</span><br>
<span class="lineno"></span><span class="comment" id="5721861">//&nbsp;A&nbsp;transaction&nbsp;must&nbsp;end&nbsp;with&nbsp;a&nbsp;call&nbsp;to&nbsp;Commit&nbsp;or&nbsp;Rollback.</span><br>
<span class="lineno"></span><span class="comment" id="5721922">//</span><br>
<span class="lineno"></span><span class="comment" id="5721925">//&nbsp;After&nbsp;a&nbsp;call&nbsp;to&nbsp;Commit&nbsp;or&nbsp;Rollback,&nbsp;all&nbsp;operations&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5721986">//&nbsp;transaction&nbsp;fail&nbsp;with&nbsp;ErrTxDone.</span><br>
<span class="lineno">1050</span><span class="keyword" id="5722022">type</span>&nbsp;<span class="ident" id="5722027">Tx</span>&nbsp;<span class="keyword" id="5722030">struct</span>&nbsp;<span class="op" id="5722037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5722040">db</span>&nbsp;<span class="op" id="5722043">*</span><span class="ident" id="5722044">DB</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5722049">//&nbsp;dc&nbsp;is&nbsp;owned&nbsp;exclusively&nbsp;until&nbsp;Commit&nbsp;or&nbsp;Rollback,&nbsp;at&nbsp;which&nbsp;point</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5722118">//&nbsp;it&#39;s&nbsp;returned&nbsp;with&nbsp;putConn.</span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5722150">dc</span>&nbsp;&nbsp;<span class="op" id="5722154">*</span><span class="ident" id="5722155">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5722167">txi</span>&nbsp;<span class="ident" id="5722171">driver</span><span class="op" id="5722177">.</span><span class="ident" id="5722178">Tx</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5722183">//&nbsp;done&nbsp;transitions&nbsp;from&nbsp;false&nbsp;to&nbsp;true&nbsp;exactly&nbsp;once,&nbsp;on&nbsp;Commit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5722247">//&nbsp;or&nbsp;Rollback.&nbsp;once&nbsp;done,&nbsp;all&nbsp;operations&nbsp;fail&nbsp;with</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5722300">//&nbsp;ErrTxDone.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5722315">done</span>&nbsp;<span class="builtintype" id="5722320">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5722327">//&nbsp;All&nbsp;Stmts&nbsp;prepared&nbsp;for&nbsp;this&nbsp;transaction.&nbsp;&nbsp;These&nbsp;will&nbsp;be&nbsp;closed&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5722404">//&nbsp;transaction&nbsp;has&nbsp;been&nbsp;committed&nbsp;or&nbsp;rolled&nbsp;back.</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5722455">stmts</span>&nbsp;<span class="keyword" id="5722461">struct</span>&nbsp;<span class="op" id="5722468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5722472">sync</span><span class="op" id="5722476">.</span><span class="ident" id="5722477">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5722485">v</span>&nbsp;<span class="op" id="5722487">[</span><span class="op" id="5722488">]</span><span class="op" id="5722489">*</span><span class="ident" id="5722490">Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5722496">}</span><br>
<span class="lineno"></span><span class="op" id="5722498">}</span><br>
<span class="lineno">1070</span><br>
<span class="lineno"></span><span class="keyword" id="5722501">var</span>&nbsp;<span class="ident" id="5722505">ErrTxDone</span>&nbsp;<span class="op" id="5722515">=</span>&nbsp;<span class="ident" id="5722517">errors</span><span class="op" id="5722523">.</span><span class="ident" id="5722524">New</span><span class="op" id="5722527">(</span><span class="string" id="5722528">&#34;sql:&nbsp;Transaction&nbsp;has&nbsp;already&nbsp;been&nbsp;committed&nbsp;or&nbsp;rolled&nbsp;back&#34;</span><span class="op" id="5722588">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5722591">func</span>&nbsp;<span class="op" id="5722596">(</span><span class="ident" id="5722597">tx</span>&nbsp;<span class="op" id="5722600">*</span><span class="ident" id="5722601">Tx</span><span class="op" id="5722603">)</span>&nbsp;<span class="builtinfunc" id="5722605">close</span><span class="op" id="5722610">(</span><span class="op" id="5722611">)</span>&nbsp;<span class="op" id="5722613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5722616">if</span>&nbsp;<span class="ident" id="5722619">tx</span><span class="op" id="5722621">.</span><span class="ident" id="5722622">done</span>&nbsp;<span class="op" id="5722627">{</span><br>
<span class="lineno">1075</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5722631">panic</span><span class="op" id="5722636">(</span><span class="string" id="5722637">&#34;double&nbsp;close&#34;</span><span class="op" id="5722651">)</span>&nbsp;<span class="comment" id="5722653">//&nbsp;internal&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5722672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5722675">tx</span><span class="op" id="5722677">.</span><span class="ident" id="5722678">done</span>&nbsp;<span class="op" id="5722683">=</span>&nbsp;<span class="builtintype" id="5722685">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5722691">tx</span><span class="op" id="5722693">.</span><span class="ident" id="5722694">db</span><span class="op" id="5722696">.</span><span class="ident" id="5722697">putConn</span><span class="op" id="5722704">(</span><span class="ident" id="5722705">tx</span><span class="op" id="5722707">.</span><span class="ident" id="5722708">dc</span><span class="op" id="5722710">,</span>&nbsp;<span class="ident" id="5722712">nil</span><span class="op" id="5722715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5722718">tx</span><span class="op" id="5722720">.</span><span class="ident" id="5722721">dc</span>&nbsp;<span class="op" id="5722724">=</span>&nbsp;<span class="ident" id="5722726">nil</span><br>
<span class="lineno">1080</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5722731">tx</span><span class="op" id="5722733">.</span><span class="ident" id="5722734">txi</span>&nbsp;<span class="op" id="5722738">=</span>&nbsp;<span class="ident" id="5722740">nil</span><br>
<span class="lineno"></span><span class="op" id="5722744">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5722747">func</span>&nbsp;<span class="op" id="5722752">(</span><span class="ident" id="5722753">tx</span>&nbsp;<span class="op" id="5722756">*</span><span class="ident" id="5722757">Tx</span><span class="op" id="5722759">)</span>&nbsp;<span class="ident" id="5722761">grabConn</span><span class="op" id="5722769">(</span><span class="op" id="5722770">)</span>&nbsp;<span class="op" id="5722772">(</span><span class="op" id="5722773">*</span><span class="ident" id="5722774">driverConn</span><span class="op" id="5722784">,</span>&nbsp;<span class="builtintype" id="5722786">error</span><span class="op" id="5722791">)</span>&nbsp;<span class="op" id="5722793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5722796">if</span>&nbsp;<span class="ident" id="5722799">tx</span><span class="op" id="5722801">.</span><span class="ident" id="5722802">done</span>&nbsp;<span class="op" id="5722807">{</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5722811">return</span>&nbsp;<span class="ident" id="5722818">nil</span><span class="op" id="5722821">,</span>&nbsp;<span class="ident" id="5722823">ErrTxDone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5722834">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5722837">return</span>&nbsp;<span class="ident" id="5722844">tx</span><span class="op" id="5722846">.</span><span class="ident" id="5722847">dc</span><span class="op" id="5722849">,</span>&nbsp;<span class="ident" id="5722851">nil</span><br>
<span class="lineno"></span><span class="op" id="5722855">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1090</span><span class="comment" id="5722858">//&nbsp;Closes&nbsp;all&nbsp;Stmts&nbsp;prepared&nbsp;for&nbsp;this&nbsp;transaction.</span><br>
<span class="lineno"></span><span class="keyword" id="5722909">func</span>&nbsp;<span class="op" id="5722914">(</span><span class="ident" id="5722915">tx</span>&nbsp;<span class="op" id="5722918">*</span><span class="ident" id="5722919">Tx</span><span class="op" id="5722921">)</span>&nbsp;<span class="ident" id="5722923">closePrepared</span><span class="op" id="5722936">(</span><span class="op" id="5722937">)</span>&nbsp;<span class="op" id="5722939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5722942">tx</span><span class="op" id="5722944">.</span><span class="ident" id="5722945">stmts</span><span class="op" id="5722950">.</span><span class="ident" id="5722951">Lock</span><span class="op" id="5722955">(</span><span class="op" id="5722956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5722959">for</span>&nbsp;<span class="ident" id="5722963">_</span><span class="op" id="5722964">,</span>&nbsp;<span class="ident" id="5722966">stmt</span>&nbsp;<span class="op" id="5722971">:=</span>&nbsp;<span class="keyword" id="5722974">range</span>&nbsp;<span class="ident" id="5722980">tx</span><span class="op" id="5722982">.</span><span class="ident" id="5722983">stmts</span><span class="op" id="5722988">.</span><span class="ident" id="5722989">v</span>&nbsp;<span class="op" id="5722991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5722995">stmt</span><span class="op" id="5722999">.</span><span class="ident" id="5723000">Close</span><span class="op" id="5723005">(</span><span class="op" id="5723006">)</span><br>
<span class="lineno">1095</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5723009">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5723012">tx</span><span class="op" id="5723014">.</span><span class="ident" id="5723015">stmts</span><span class="op" id="5723020">.</span><span class="ident" id="5723021">Unlock</span><span class="op" id="5723027">(</span><span class="op" id="5723028">)</span><br>
<span class="lineno"></span><span class="op" id="5723030">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5723033">//&nbsp;Commit&nbsp;commits&nbsp;the&nbsp;transaction.</span><br>
<span class="lineno">1100</span><span class="keyword" id="5723068">func</span>&nbsp;<span class="op" id="5723073">(</span><span class="ident" id="5723074">tx</span>&nbsp;<span class="op" id="5723077">*</span><span class="ident" id="5723078">Tx</span><span class="op" id="5723080">)</span>&nbsp;<span class="ident" id="5723082">Commit</span><span class="op" id="5723088">(</span><span class="op" id="5723089">)</span>&nbsp;<span class="builtintype" id="5723091">error</span>&nbsp;<span class="op" id="5723097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5723100">if</span>&nbsp;<span class="ident" id="5723103">tx</span><span class="op" id="5723105">.</span><span class="ident" id="5723106">done</span>&nbsp;<span class="op" id="5723111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5723115">return</span>&nbsp;<span class="ident" id="5723122">ErrTxDone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5723133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5723136">defer</span>&nbsp;<span class="ident" id="5723142">tx</span><span class="op" id="5723144">.</span><span class="builtinfunc" id="5723145">close</span><span class="op" id="5723150">(</span><span class="op" id="5723151">)</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5723154">tx</span><span class="op" id="5723156">.</span><span class="ident" id="5723157">dc</span><span class="op" id="5723159">.</span><span class="ident" id="5723160">Lock</span><span class="op" id="5723164">(</span><span class="op" id="5723165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5723168">err</span>&nbsp;<span class="op" id="5723172">:=</span>&nbsp;<span class="ident" id="5723175">tx</span><span class="op" id="5723177">.</span><span class="ident" id="5723178">txi</span><span class="op" id="5723181">.</span><span class="ident" id="5723182">Commit</span><span class="op" id="5723188">(</span><span class="op" id="5723189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5723192">tx</span><span class="op" id="5723194">.</span><span class="ident" id="5723195">dc</span><span class="op" id="5723197">.</span><span class="ident" id="5723198">Unlock</span><span class="op" id="5723204">(</span><span class="op" id="5723205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5723208">if</span>&nbsp;<span class="ident" id="5723211">err</span>&nbsp;<span class="op" id="5723215">!=</span>&nbsp;<span class="ident" id="5723218">driver</span><span class="op" id="5723224">.</span><span class="ident" id="5723225">ErrBadConn</span>&nbsp;<span class="op" id="5723236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5723240">tx</span><span class="op" id="5723242">.</span><span class="ident" id="5723243">closePrepared</span><span class="op" id="5723256">(</span><span class="op" id="5723257">)</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5723260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5723263">return</span>&nbsp;<span class="ident" id="5723270">err</span><br>
<span class="lineno"></span><span class="op" id="5723274">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5723277">//&nbsp;Rollback&nbsp;aborts&nbsp;the&nbsp;transaction.</span><br>
<span class="lineno">1115</span><span class="keyword" id="5723313">func</span>&nbsp;<span class="op" id="5723318">(</span><span class="ident" id="5723319">tx</span>&nbsp;<span class="op" id="5723322">*</span><span class="ident" id="5723323">Tx</span><span class="op" id="5723325">)</span>&nbsp;<span class="ident" id="5723327">Rollback</span><span class="op" id="5723335">(</span><span class="op" id="5723336">)</span>&nbsp;<span class="builtintype" id="5723338">error</span>&nbsp;<span class="op" id="5723344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5723347">if</span>&nbsp;<span class="ident" id="5723350">tx</span><span class="op" id="5723352">.</span><span class="ident" id="5723353">done</span>&nbsp;<span class="op" id="5723358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5723362">return</span>&nbsp;<span class="ident" id="5723369">ErrTxDone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5723380">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5723383">defer</span>&nbsp;<span class="ident" id="5723389">tx</span><span class="op" id="5723391">.</span><span class="builtinfunc" id="5723392">close</span><span class="op" id="5723397">(</span><span class="op" id="5723398">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5723401">tx</span><span class="op" id="5723403">.</span><span class="ident" id="5723404">dc</span><span class="op" id="5723406">.</span><span class="ident" id="5723407">Lock</span><span class="op" id="5723411">(</span><span class="op" id="5723412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5723415">err</span>&nbsp;<span class="op" id="5723419">:=</span>&nbsp;<span class="ident" id="5723422">tx</span><span class="op" id="5723424">.</span><span class="ident" id="5723425">txi</span><span class="op" id="5723428">.</span><span class="ident" id="5723429">Rollback</span><span class="op" id="5723437">(</span><span class="op" id="5723438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5723441">tx</span><span class="op" id="5723443">.</span><span class="ident" id="5723444">dc</span><span class="op" id="5723446">.</span><span class="ident" id="5723447">Unlock</span><span class="op" id="5723453">(</span><span class="op" id="5723454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5723457">if</span>&nbsp;<span class="ident" id="5723460">err</span>&nbsp;<span class="op" id="5723464">!=</span>&nbsp;<span class="ident" id="5723467">driver</span><span class="op" id="5723473">.</span><span class="ident" id="5723474">ErrBadConn</span>&nbsp;<span class="op" id="5723485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5723489">tx</span><span class="op" id="5723491">.</span><span class="ident" id="5723492">closePrepared</span><span class="op" id="5723505">(</span><span class="op" id="5723506">)</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5723509">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5723512">return</span>&nbsp;<span class="ident" id="5723519">err</span><br>
<span class="lineno"></span><span class="op" id="5723523">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5723526">//&nbsp;Prepare&nbsp;creates&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;for&nbsp;use&nbsp;within&nbsp;a&nbsp;transaction.</span><br>
<span class="lineno">1130</span><span class="comment" id="5723596">//</span><br>
<span class="lineno"></span><span class="comment" id="5723599">//&nbsp;The&nbsp;returned&nbsp;statement&nbsp;operates&nbsp;within&nbsp;the&nbsp;transaction&nbsp;and&nbsp;can&nbsp;no&nbsp;longer</span><br>
<span class="lineno"></span><span class="comment" id="5723675">//&nbsp;be&nbsp;used&nbsp;once&nbsp;the&nbsp;transaction&nbsp;has&nbsp;been&nbsp;committed&nbsp;or&nbsp;rolled&nbsp;back.</span><br>
<span class="lineno"></span><span class="comment" id="5723742">//</span><br>
<span class="lineno"></span><span class="comment" id="5723745">//&nbsp;To&nbsp;use&nbsp;an&nbsp;existing&nbsp;prepared&nbsp;statement&nbsp;on&nbsp;this&nbsp;transaction,&nbsp;see&nbsp;Tx.Stmt.</span><br>
<span class="lineno">1135</span><span class="keyword" id="5723820">func</span>&nbsp;<span class="op" id="5723825">(</span><span class="ident" id="5723826">tx</span>&nbsp;<span class="op" id="5723829">*</span><span class="ident" id="5723830">Tx</span><span class="op" id="5723832">)</span>&nbsp;<span class="ident" id="5723834">Prepare</span><span class="op" id="5723841">(</span><span class="ident" id="5723842">query</span>&nbsp;<span class="builtintype" id="5723848">string</span><span class="op" id="5723854">)</span>&nbsp;<span class="op" id="5723856">(</span><span class="op" id="5723857">*</span><span class="ident" id="5723858">Stmt</span><span class="op" id="5723862">,</span>&nbsp;<span class="builtintype" id="5723864">error</span><span class="op" id="5723869">)</span>&nbsp;<span class="op" id="5723871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5723874">//&nbsp;TODO(bradfitz):&nbsp;We&nbsp;could&nbsp;be&nbsp;more&nbsp;efficient&nbsp;here&nbsp;and&nbsp;either</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5723937">//&nbsp;provide&nbsp;a&nbsp;method&nbsp;to&nbsp;take&nbsp;an&nbsp;existing&nbsp;Stmt&nbsp;(created&nbsp;on</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5723995">//&nbsp;perhaps&nbsp;a&nbsp;different&nbsp;Conn),&nbsp;and&nbsp;re-create&nbsp;it&nbsp;on&nbsp;this&nbsp;Conn&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5724059">//&nbsp;necessary.&nbsp;Or,&nbsp;better:&nbsp;keep&nbsp;a&nbsp;map&nbsp;in&nbsp;DB&nbsp;of&nbsp;query&nbsp;string&nbsp;to</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5724122">//&nbsp;Stmts,&nbsp;and&nbsp;have&nbsp;Stmt.Execute&nbsp;do&nbsp;the&nbsp;right&nbsp;thing&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5724178">//&nbsp;re-prepare&nbsp;if&nbsp;the&nbsp;Conn&nbsp;in&nbsp;use&nbsp;doesn&#39;t&nbsp;have&nbsp;that&nbsp;prepared</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5724239">//&nbsp;statement.&nbsp;&nbsp;But&nbsp;we&#39;ll&nbsp;want&nbsp;to&nbsp;avoid&nbsp;caching&nbsp;the&nbsp;statement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5724301">//&nbsp;in&nbsp;the&nbsp;case&nbsp;where&nbsp;we&nbsp;only&nbsp;call&nbsp;conn.Prepare&nbsp;implicitly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5724360">//&nbsp;(such&nbsp;as&nbsp;in&nbsp;db.Exec&nbsp;or&nbsp;tx.Exec),&nbsp;but&nbsp;the&nbsp;caller&nbsp;package</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5724420">//&nbsp;can&#39;t&nbsp;be&nbsp;holding&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;returned&nbsp;statement.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5724480">//&nbsp;Perhaps&nbsp;just&nbsp;looking&nbsp;at&nbsp;the&nbsp;reference&nbsp;count&nbsp;(by&nbsp;noting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5724539">//&nbsp;Stmt.Close)&nbsp;would&nbsp;be&nbsp;enough.&nbsp;We&nbsp;might&nbsp;also&nbsp;want&nbsp;a&nbsp;finalizer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5724603">//&nbsp;on&nbsp;Stmt&nbsp;to&nbsp;drop&nbsp;the&nbsp;reference&nbsp;count.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5724644">dc</span><span class="op" id="5724646">,</span>&nbsp;<span class="ident" id="5724648">err</span>&nbsp;<span class="op" id="5724652">:=</span>&nbsp;<span class="ident" id="5724655">tx</span><span class="op" id="5724657">.</span><span class="ident" id="5724658">grabConn</span><span class="op" id="5724666">(</span><span class="op" id="5724667">)</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5724670">if</span>&nbsp;<span class="ident" id="5724673">err</span>&nbsp;<span class="op" id="5724677">!=</span>&nbsp;<span class="ident" id="5724680">nil</span>&nbsp;<span class="op" id="5724684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5724688">return</span>&nbsp;<span class="ident" id="5724695">nil</span><span class="op" id="5724698">,</span>&nbsp;<span class="ident" id="5724700">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5724705">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5724709">dc</span><span class="op" id="5724711">.</span><span class="ident" id="5724712">Lock</span><span class="op" id="5724716">(</span><span class="op" id="5724717">)</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5724720">si</span><span class="op" id="5724722">,</span>&nbsp;<span class="ident" id="5724724">err</span>&nbsp;<span class="op" id="5724728">:=</span>&nbsp;<span class="ident" id="5724731">dc</span><span class="op" id="5724733">.</span><span class="ident" id="5724734">ci</span><span class="op" id="5724736">.</span><span class="ident" id="5724737">Prepare</span><span class="op" id="5724744">(</span><span class="ident" id="5724745">query</span><span class="op" id="5724750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5724753">dc</span><span class="op" id="5724755">.</span><span class="ident" id="5724756">Unlock</span><span class="op" id="5724762">(</span><span class="op" id="5724763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5724766">if</span>&nbsp;<span class="ident" id="5724769">err</span>&nbsp;<span class="op" id="5724773">!=</span>&nbsp;<span class="ident" id="5724776">nil</span>&nbsp;<span class="op" id="5724780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5724784">return</span>&nbsp;<span class="ident" id="5724791">nil</span><span class="op" id="5724794">,</span>&nbsp;<span class="ident" id="5724796">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5724801">}</span><br>
<span class="lineno">1160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5724805">stmt</span>&nbsp;<span class="op" id="5724810">:=</span>&nbsp;<span class="op" id="5724813">&amp;</span><span class="ident" id="5724814">Stmt</span><span class="op" id="5724818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5724822">db</span><span class="op" id="5724824">:</span>&nbsp;<span class="ident" id="5724826">tx</span><span class="op" id="5724828">.</span><span class="ident" id="5724829">db</span><span class="op" id="5724831">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5724835">tx</span><span class="op" id="5724837">:</span>&nbsp;<span class="ident" id="5724839">tx</span><span class="op" id="5724841">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5724845">txsi</span><span class="op" id="5724849">:</span>&nbsp;<span class="op" id="5724851">&amp;</span><span class="ident" id="5724852">driverStmt</span><span class="op" id="5724862">{</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5724867">Locker</span><span class="op" id="5724873">:</span>&nbsp;<span class="ident" id="5724875">dc</span><span class="op" id="5724877">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5724882">si</span><span class="op" id="5724884">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5724890">si</span><span class="op" id="5724892">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5724896">}</span><span class="op" id="5724897">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5724901">query</span><span class="op" id="5724906">:</span>&nbsp;<span class="ident" id="5724908">query</span><span class="op" id="5724913">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5724916">}</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5724919">tx</span><span class="op" id="5724921">.</span><span class="ident" id="5724922">stmts</span><span class="op" id="5724927">.</span><span class="ident" id="5724928">Lock</span><span class="op" id="5724932">(</span><span class="op" id="5724933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5724936">tx</span><span class="op" id="5724938">.</span><span class="ident" id="5724939">stmts</span><span class="op" id="5724944">.</span><span class="ident" id="5724945">v</span>&nbsp;<span class="op" id="5724947">=</span>&nbsp;<span class="builtinfunc" id="5724949">append</span><span class="op" id="5724955">(</span><span class="ident" id="5724956">tx</span><span class="op" id="5724958">.</span><span class="ident" id="5724959">stmts</span><span class="op" id="5724964">.</span><span class="ident" id="5724965">v</span><span class="op" id="5724966">,</span>&nbsp;<span class="ident" id="5724968">stmt</span><span class="op" id="5724972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5724975">tx</span><span class="op" id="5724977">.</span><span class="ident" id="5724978">stmts</span><span class="op" id="5724983">.</span><span class="ident" id="5724984">Unlock</span><span class="op" id="5724990">(</span><span class="op" id="5724991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5724994">return</span>&nbsp;<span class="ident" id="5725001">stmt</span><span class="op" id="5725005">,</span>&nbsp;<span class="ident" id="5725007">nil</span><br>
<span class="lineno"></span><span class="op" id="5725011">}</span><br>
<span class="lineno">1175</span><br>
<span class="lineno"></span><span class="comment" id="5725014">//&nbsp;Stmt&nbsp;returns&nbsp;a&nbsp;transaction-specific&nbsp;prepared&nbsp;statement&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="5725077">//&nbsp;an&nbsp;existing&nbsp;statement.</span><br>
<span class="lineno"></span><span class="comment" id="5725103">//</span><br>
<span class="lineno"></span><span class="comment" id="5725106">//&nbsp;Example:</span><br>
<span class="lineno">1180</span><span class="comment" id="5725118">//&nbsp;&nbsp;updateMoney,&nbsp;err&nbsp;:=&nbsp;db.Prepare(&#34;UPDATE&nbsp;balance&nbsp;SET&nbsp;money=money+?&nbsp;WHERE&nbsp;id=?&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="5725200">//&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="5725208">//&nbsp;&nbsp;tx,&nbsp;err&nbsp;:=&nbsp;db.Begin()</span><br>
<span class="lineno"></span><span class="comment" id="5725234">//&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="5725242">//&nbsp;&nbsp;res,&nbsp;err&nbsp;:=&nbsp;tx.Stmt(updateMoney).Exec(123.45,&nbsp;98293203)</span><br>
<span class="lineno">1185</span><span class="keyword" id="5725302">func</span>&nbsp;<span class="op" id="5725307">(</span><span class="ident" id="5725308">tx</span>&nbsp;<span class="op" id="5725311">*</span><span class="ident" id="5725312">Tx</span><span class="op" id="5725314">)</span>&nbsp;<span class="ident" id="5725316">Stmt</span><span class="op" id="5725320">(</span><span class="ident" id="5725321">stmt</span>&nbsp;<span class="op" id="5725326">*</span><span class="ident" id="5725327">Stmt</span><span class="op" id="5725331">)</span>&nbsp;<span class="op" id="5725333">*</span><span class="ident" id="5725334">Stmt</span>&nbsp;<span class="op" id="5725339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5725342">//&nbsp;TODO(bradfitz):&nbsp;optimize&nbsp;this.&nbsp;Currently&nbsp;this&nbsp;re-prepares</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5725404">//&nbsp;each&nbsp;time.&nbsp;&nbsp;This&nbsp;is&nbsp;fine&nbsp;for&nbsp;now&nbsp;to&nbsp;illustrate&nbsp;the&nbsp;API&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5725467">//&nbsp;we&nbsp;should&nbsp;really&nbsp;cache&nbsp;already-prepared&nbsp;statements</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5725522">//&nbsp;per-Conn.&nbsp;See&nbsp;also&nbsp;the&nbsp;big&nbsp;comment&nbsp;in&nbsp;Tx.Prepare.</span><br>
<span class="lineno">1190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5725577">if</span>&nbsp;<span class="ident" id="5725580">tx</span><span class="op" id="5725582">.</span><span class="ident" id="5725583">db</span>&nbsp;<span class="op" id="5725586">!=</span>&nbsp;<span class="ident" id="5725589">stmt</span><span class="op" id="5725593">.</span><span class="ident" id="5725594">db</span>&nbsp;<span class="op" id="5725597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5725601">return</span>&nbsp;<span class="op" id="5725608">&amp;</span><span class="ident" id="5725609">Stmt</span><span class="op" id="5725613">{</span><span class="ident" id="5725614">stickyErr</span><span class="op" id="5725623">:</span>&nbsp;<span class="ident" id="5725625">errors</span><span class="op" id="5725631">.</span><span class="ident" id="5725632">New</span><span class="op" id="5725635">(</span><span class="string" id="5725636">&#34;sql:&nbsp;Tx.Stmt:&nbsp;statement&nbsp;from&nbsp;different&nbsp;database&nbsp;used&#34;</span><span class="op" id="5725690">)</span><span class="op" id="5725691">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5725694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5725697">dc</span><span class="op" id="5725699">,</span>&nbsp;<span class="ident" id="5725701">err</span>&nbsp;<span class="op" id="5725705">:=</span>&nbsp;<span class="ident" id="5725708">tx</span><span class="op" id="5725710">.</span><span class="ident" id="5725711">grabConn</span><span class="op" id="5725719">(</span><span class="op" id="5725720">)</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5725723">if</span>&nbsp;<span class="ident" id="5725726">err</span>&nbsp;<span class="op" id="5725730">!=</span>&nbsp;<span class="ident" id="5725733">nil</span>&nbsp;<span class="op" id="5725737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5725741">return</span>&nbsp;<span class="op" id="5725748">&amp;</span><span class="ident" id="5725749">Stmt</span><span class="op" id="5725753">{</span><span class="ident" id="5725754">stickyErr</span><span class="op" id="5725763">:</span>&nbsp;<span class="ident" id="5725765">err</span><span class="op" id="5725768">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5725771">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5725774">dc</span><span class="op" id="5725776">.</span><span class="ident" id="5725777">Lock</span><span class="op" id="5725781">(</span><span class="op" id="5725782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5725785">si</span><span class="op" id="5725787">,</span>&nbsp;<span class="ident" id="5725789">err</span>&nbsp;<span class="op" id="5725793">:=</span>&nbsp;<span class="ident" id="5725796">dc</span><span class="op" id="5725798">.</span><span class="ident" id="5725799">ci</span><span class="op" id="5725801">.</span><span class="ident" id="5725802">Prepare</span><span class="op" id="5725809">(</span><span class="ident" id="5725810">stmt</span><span class="op" id="5725814">.</span><span class="ident" id="5725815">query</span><span class="op" id="5725820">)</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5725823">dc</span><span class="op" id="5725825">.</span><span class="ident" id="5725826">Unlock</span><span class="op" id="5725832">(</span><span class="op" id="5725833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5725836">txs</span>&nbsp;<span class="op" id="5725840">:=</span>&nbsp;<span class="op" id="5725843">&amp;</span><span class="ident" id="5725844">Stmt</span><span class="op" id="5725848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5725852">db</span><span class="op" id="5725854">:</span>&nbsp;<span class="ident" id="5725856">tx</span><span class="op" id="5725858">.</span><span class="ident" id="5725859">db</span><span class="op" id="5725861">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5725865">tx</span><span class="op" id="5725867">:</span>&nbsp;<span class="ident" id="5725869">tx</span><span class="op" id="5725871">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5725875">txsi</span><span class="op" id="5725879">:</span>&nbsp;<span class="op" id="5725881">&amp;</span><span class="ident" id="5725882">driverStmt</span><span class="op" id="5725892">{</span><br>
<span class="lineno">1205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5725897">Locker</span><span class="op" id="5725903">:</span>&nbsp;<span class="ident" id="5725905">dc</span><span class="op" id="5725907">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5725912">si</span><span class="op" id="5725914">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5725920">si</span><span class="op" id="5725922">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5725926">}</span><span class="op" id="5725927">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5725931">query</span><span class="op" id="5725936">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5725942">stmt</span><span class="op" id="5725946">.</span><span class="ident" id="5725947">query</span><span class="op" id="5725952">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5725956">stickyErr</span><span class="op" id="5725965">:</span>&nbsp;<span class="ident" id="5725967">err</span><span class="op" id="5725970">,</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5725973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5725976">tx</span><span class="op" id="5725978">.</span><span class="ident" id="5725979">stmts</span><span class="op" id="5725984">.</span><span class="ident" id="5725985">Lock</span><span class="op" id="5725989">(</span><span class="op" id="5725990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5725993">tx</span><span class="op" id="5725995">.</span><span class="ident" id="5725996">stmts</span><span class="op" id="5726001">.</span><span class="ident" id="5726002">v</span>&nbsp;<span class="op" id="5726004">=</span>&nbsp;<span class="builtinfunc" id="5726006">append</span><span class="op" id="5726012">(</span><span class="ident" id="5726013">tx</span><span class="op" id="5726015">.</span><span class="ident" id="5726016">stmts</span><span class="op" id="5726021">.</span><span class="ident" id="5726022">v</span><span class="op" id="5726023">,</span>&nbsp;<span class="ident" id="5726025">txs</span><span class="op" id="5726028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5726031">tx</span><span class="op" id="5726033">.</span><span class="ident" id="5726034">stmts</span><span class="op" id="5726039">.</span><span class="ident" id="5726040">Unlock</span><span class="op" id="5726046">(</span><span class="op" id="5726047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5726050">return</span>&nbsp;<span class="ident" id="5726057">txs</span><br>
<span class="lineno">1215</span><span class="op" id="5726061">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5726064">//&nbsp;Exec&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;doesn&#39;t&nbsp;return&nbsp;rows.</span><br>
<span class="lineno"></span><span class="comment" id="5726115">//&nbsp;For&nbsp;example:&nbsp;an&nbsp;INSERT&nbsp;and&nbsp;UPDATE.</span><br>
<span class="lineno"></span><span class="keyword" id="5726153">func</span>&nbsp;<span class="op" id="5726158">(</span><span class="ident" id="5726159">tx</span>&nbsp;<span class="op" id="5726162">*</span><span class="ident" id="5726163">Tx</span><span class="op" id="5726165">)</span>&nbsp;<span class="ident" id="5726167">Exec</span><span class="op" id="5726171">(</span><span class="ident" id="5726172">query</span>&nbsp;<span class="builtintype" id="5726178">string</span><span class="op" id="5726184">,</span>&nbsp;<span class="ident" id="5726186">args</span>&nbsp;<span class="op" id="5726191">...</span><span class="keyword" id="5726194">interface</span><span class="op" id="5726203">{</span><span class="op" id="5726204">}</span><span class="op" id="5726205">)</span>&nbsp;<span class="op" id="5726207">(</span><span class="ident" id="5726208">Result</span><span class="op" id="5726214">,</span>&nbsp;<span class="builtintype" id="5726216">error</span><span class="op" id="5726221">)</span>&nbsp;<span class="op" id="5726223">{</span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5726226">dc</span><span class="op" id="5726228">,</span>&nbsp;<span class="ident" id="5726230">err</span>&nbsp;<span class="op" id="5726234">:=</span>&nbsp;<span class="ident" id="5726237">tx</span><span class="op" id="5726239">.</span><span class="ident" id="5726240">grabConn</span><span class="op" id="5726248">(</span><span class="op" id="5726249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5726252">if</span>&nbsp;<span class="ident" id="5726255">err</span>&nbsp;<span class="op" id="5726259">!=</span>&nbsp;<span class="ident" id="5726262">nil</span>&nbsp;<span class="op" id="5726266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5726270">return</span>&nbsp;<span class="ident" id="5726277">nil</span><span class="op" id="5726280">,</span>&nbsp;<span class="ident" id="5726282">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5726287">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5726291">if</span>&nbsp;<span class="ident" id="5726294">execer</span><span class="op" id="5726300">,</span>&nbsp;<span class="ident" id="5726302">ok</span>&nbsp;<span class="op" id="5726305">:=</span>&nbsp;<span class="ident" id="5726308">dc</span><span class="op" id="5726310">.</span><span class="ident" id="5726311">ci</span><span class="op" id="5726313">.</span><span class="op" id="5726314">(</span><span class="ident" id="5726315">driver</span><span class="op" id="5726321">.</span><span class="ident" id="5726322">Execer</span><span class="op" id="5726328">)</span><span class="op" id="5726329">;</span>&nbsp;<span class="ident" id="5726331">ok</span>&nbsp;<span class="op" id="5726334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5726338">dargs</span><span class="op" id="5726343">,</span>&nbsp;<span class="ident" id="5726345">err</span>&nbsp;<span class="op" id="5726349">:=</span>&nbsp;<span class="ident" id="5726352">driverArgs</span><span class="op" id="5726362">(</span><span class="ident" id="5726363">nil</span><span class="op" id="5726366">,</span>&nbsp;<span class="ident" id="5726368">args</span><span class="op" id="5726372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5726376">if</span>&nbsp;<span class="ident" id="5726379">err</span>&nbsp;<span class="op" id="5726383">!=</span>&nbsp;<span class="ident" id="5726386">nil</span>&nbsp;<span class="op" id="5726390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5726395">return</span>&nbsp;<span class="ident" id="5726402">nil</span><span class="op" id="5726405">,</span>&nbsp;<span class="ident" id="5726407">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5726413">}</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5726417">dc</span><span class="op" id="5726419">.</span><span class="ident" id="5726420">Lock</span><span class="op" id="5726424">(</span><span class="op" id="5726425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5726429">resi</span><span class="op" id="5726433">,</span>&nbsp;<span class="ident" id="5726435">err</span>&nbsp;<span class="op" id="5726439">:=</span>&nbsp;<span class="ident" id="5726442">execer</span><span class="op" id="5726448">.</span><span class="ident" id="5726449">Exec</span><span class="op" id="5726453">(</span><span class="ident" id="5726454">query</span><span class="op" id="5726459">,</span>&nbsp;<span class="ident" id="5726461">dargs</span><span class="op" id="5726466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5726470">dc</span><span class="op" id="5726472">.</span><span class="ident" id="5726473">Unlock</span><span class="op" id="5726479">(</span><span class="op" id="5726480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5726484">if</span>&nbsp;<span class="ident" id="5726487">err</span>&nbsp;<span class="op" id="5726491">==</span>&nbsp;<span class="ident" id="5726494">nil</span>&nbsp;<span class="op" id="5726498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5726503">return</span>&nbsp;<span class="ident" id="5726510">driverResult</span><span class="op" id="5726522">{</span><span class="ident" id="5726523">dc</span><span class="op" id="5726525">,</span>&nbsp;<span class="ident" id="5726527">resi</span><span class="op" id="5726531">}</span><span class="op" id="5726532">,</span>&nbsp;<span class="ident" id="5726534">nil</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5726540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5726544">if</span>&nbsp;<span class="ident" id="5726547">err</span>&nbsp;<span class="op" id="5726551">!=</span>&nbsp;<span class="ident" id="5726554">driver</span><span class="op" id="5726560">.</span><span class="ident" id="5726561">ErrSkip</span>&nbsp;<span class="op" id="5726569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5726574">return</span>&nbsp;<span class="ident" id="5726581">nil</span><span class="op" id="5726584">,</span>&nbsp;<span class="ident" id="5726586">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5726592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5726595">}</span><br>
<span class="lineno">1240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5726599">dc</span><span class="op" id="5726601">.</span><span class="ident" id="5726602">Lock</span><span class="op" id="5726606">(</span><span class="op" id="5726607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5726610">si</span><span class="op" id="5726612">,</span>&nbsp;<span class="ident" id="5726614">err</span>&nbsp;<span class="op" id="5726618">:=</span>&nbsp;<span class="ident" id="5726621">dc</span><span class="op" id="5726623">.</span><span class="ident" id="5726624">ci</span><span class="op" id="5726626">.</span><span class="ident" id="5726627">Prepare</span><span class="op" id="5726634">(</span><span class="ident" id="5726635">query</span><span class="op" id="5726640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5726643">dc</span><span class="op" id="5726645">.</span><span class="ident" id="5726646">Unlock</span><span class="op" id="5726652">(</span><span class="op" id="5726653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5726656">if</span>&nbsp;<span class="ident" id="5726659">err</span>&nbsp;<span class="op" id="5726663">!=</span>&nbsp;<span class="ident" id="5726666">nil</span>&nbsp;<span class="op" id="5726670">{</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5726674">return</span>&nbsp;<span class="ident" id="5726681">nil</span><span class="op" id="5726684">,</span>&nbsp;<span class="ident" id="5726686">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5726691">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5726694">defer</span>&nbsp;<span class="ident" id="5726700">withLock</span><span class="op" id="5726708">(</span><span class="ident" id="5726709">dc</span><span class="op" id="5726711">,</span>&nbsp;<span class="keyword" id="5726713">func</span><span class="op" id="5726717">(</span><span class="op" id="5726718">)</span>&nbsp;<span class="op" id="5726720">{</span>&nbsp;<span class="ident" id="5726722">si</span><span class="op" id="5726724">.</span><span class="ident" id="5726725">Close</span><span class="op" id="5726730">(</span><span class="op" id="5726731">)</span>&nbsp;<span class="op" id="5726733">}</span><span class="op" id="5726734">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5726738">return</span>&nbsp;<span class="ident" id="5726745">resultFromStatement</span><span class="op" id="5726764">(</span><span class="ident" id="5726765">driverStmt</span><span class="op" id="5726775">{</span><span class="ident" id="5726776">dc</span><span class="op" id="5726778">,</span>&nbsp;<span class="ident" id="5726780">si</span><span class="op" id="5726782">}</span><span class="op" id="5726783">,</span>&nbsp;<span class="ident" id="5726785">args</span><span class="op" id="5726789">...</span><span class="op" id="5726792">)</span><br>
<span class="lineno">1250</span><span class="op" id="5726794">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5726797">//&nbsp;Query&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;returns&nbsp;rows,&nbsp;typically&nbsp;a&nbsp;SELECT.</span><br>
<span class="lineno"></span><span class="keyword" id="5726862">func</span>&nbsp;<span class="op" id="5726867">(</span><span class="ident" id="5726868">tx</span>&nbsp;<span class="op" id="5726871">*</span><span class="ident" id="5726872">Tx</span><span class="op" id="5726874">)</span>&nbsp;<span class="ident" id="5726876">Query</span><span class="op" id="5726881">(</span><span class="ident" id="5726882">query</span>&nbsp;<span class="builtintype" id="5726888">string</span><span class="op" id="5726894">,</span>&nbsp;<span class="ident" id="5726896">args</span>&nbsp;<span class="op" id="5726901">...</span><span class="keyword" id="5726904">interface</span><span class="op" id="5726913">{</span><span class="op" id="5726914">}</span><span class="op" id="5726915">)</span>&nbsp;<span class="op" id="5726917">(</span><span class="op" id="5726918">*</span><span class="ident" id="5726919">Rows</span><span class="op" id="5726923">,</span>&nbsp;<span class="builtintype" id="5726925">error</span><span class="op" id="5726930">)</span>&nbsp;<span class="op" id="5726932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5726935">dc</span><span class="op" id="5726937">,</span>&nbsp;<span class="ident" id="5726939">err</span>&nbsp;<span class="op" id="5726943">:=</span>&nbsp;<span class="ident" id="5726946">tx</span><span class="op" id="5726948">.</span><span class="ident" id="5726949">grabConn</span><span class="op" id="5726957">(</span><span class="op" id="5726958">)</span><br>
<span class="lineno">1255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5726961">if</span>&nbsp;<span class="ident" id="5726964">err</span>&nbsp;<span class="op" id="5726968">!=</span>&nbsp;<span class="ident" id="5726971">nil</span>&nbsp;<span class="op" id="5726975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5726979">return</span>&nbsp;<span class="ident" id="5726986">nil</span><span class="op" id="5726989">,</span>&nbsp;<span class="ident" id="5726991">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5726996">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5726999">releaseConn</span>&nbsp;<span class="op" id="5727011">:=</span>&nbsp;<span class="keyword" id="5727014">func</span><span class="op" id="5727018">(</span><span class="builtintype" id="5727019">error</span><span class="op" id="5727024">)</span>&nbsp;<span class="op" id="5727026">{</span><span class="op" id="5727027">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5727030">return</span>&nbsp;<span class="ident" id="5727037">tx</span><span class="op" id="5727039">.</span><span class="ident" id="5727040">db</span><span class="op" id="5727042">.</span><span class="ident" id="5727043">queryConn</span><span class="op" id="5727052">(</span><span class="ident" id="5727053">dc</span><span class="op" id="5727055">,</span>&nbsp;<span class="ident" id="5727057">releaseConn</span><span class="op" id="5727068">,</span>&nbsp;<span class="ident" id="5727070">query</span><span class="op" id="5727075">,</span>&nbsp;<span class="ident" id="5727077">args</span><span class="op" id="5727081">)</span><br>
<span class="lineno">1260</span><span class="op" id="5727083">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5727086">//&nbsp;QueryRow&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;is&nbsp;expected&nbsp;to&nbsp;return&nbsp;at&nbsp;most&nbsp;one&nbsp;row.</span><br>
<span class="lineno"></span><span class="comment" id="5727159">//&nbsp;QueryRow&nbsp;always&nbsp;return&nbsp;a&nbsp;non-nil&nbsp;value.&nbsp;Errors&nbsp;are&nbsp;deferred&nbsp;until</span><br>
<span class="lineno"></span><span class="comment" id="5727228">//&nbsp;Row&#39;s&nbsp;Scan&nbsp;method&nbsp;is&nbsp;called.</span><br>
<span class="lineno">1265</span><span class="keyword" id="5727260">func</span>&nbsp;<span class="op" id="5727265">(</span><span class="ident" id="5727266">tx</span>&nbsp;<span class="op" id="5727269">*</span><span class="ident" id="5727270">Tx</span><span class="op" id="5727272">)</span>&nbsp;<span class="ident" id="5727274">QueryRow</span><span class="op" id="5727282">(</span><span class="ident" id="5727283">query</span>&nbsp;<span class="builtintype" id="5727289">string</span><span class="op" id="5727295">,</span>&nbsp;<span class="ident" id="5727297">args</span>&nbsp;<span class="op" id="5727302">...</span><span class="keyword" id="5727305">interface</span><span class="op" id="5727314">{</span><span class="op" id="5727315">}</span><span class="op" id="5727316">)</span>&nbsp;<span class="op" id="5727318">*</span><span class="ident" id="5727319">Row</span>&nbsp;<span class="op" id="5727323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5727326">rows</span><span class="op" id="5727330">,</span>&nbsp;<span class="ident" id="5727332">err</span>&nbsp;<span class="op" id="5727336">:=</span>&nbsp;<span class="ident" id="5727339">tx</span><span class="op" id="5727341">.</span><span class="ident" id="5727342">Query</span><span class="op" id="5727347">(</span><span class="ident" id="5727348">query</span><span class="op" id="5727353">,</span>&nbsp;<span class="ident" id="5727355">args</span><span class="op" id="5727359">...</span><span class="op" id="5727362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5727365">return</span>&nbsp;<span class="op" id="5727372">&amp;</span><span class="ident" id="5727373">Row</span><span class="op" id="5727376">{</span><span class="ident" id="5727377">rows</span><span class="op" id="5727381">:</span>&nbsp;<span class="ident" id="5727383">rows</span><span class="op" id="5727387">,</span>&nbsp;<span class="ident" id="5727389">err</span><span class="op" id="5727392">:</span>&nbsp;<span class="ident" id="5727394">err</span><span class="op" id="5727397">}</span><br>
<span class="lineno"></span><span class="op" id="5727399">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1270</span><span class="comment" id="5727402">//&nbsp;connStmt&nbsp;is&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;on&nbsp;a&nbsp;particular&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="5727466">type</span>&nbsp;<span class="ident" id="5727471">connStmt</span>&nbsp;<span class="keyword" id="5727480">struct</span>&nbsp;<span class="op" id="5727487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5727490">dc</span>&nbsp;<span class="op" id="5727493">*</span><span class="ident" id="5727494">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5727506">si</span>&nbsp;<span class="ident" id="5727509">driver</span><span class="op" id="5727515">.</span><span class="ident" id="5727516">Stmt</span><br>
<span class="lineno"></span><span class="op" id="5727521">}</span><br>
<span class="lineno">1275</span><br>
<span class="lineno"></span><span class="comment" id="5727524">//&nbsp;Stmt&nbsp;is&nbsp;a&nbsp;prepared&nbsp;statement.&nbsp;Stmt&nbsp;is&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="5727613">type</span>&nbsp;<span class="ident" id="5727618">Stmt</span>&nbsp;<span class="keyword" id="5727623">struct</span>&nbsp;<span class="op" id="5727630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5727633">//&nbsp;Immutable:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5727648">db</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5727658">*</span><span class="ident" id="5727659">DB</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5727665">//&nbsp;where&nbsp;we&nbsp;came&nbsp;from</span><br>
<span class="lineno">1280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5727688">query</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5727698">string</span>&nbsp;<span class="comment" id="5727705">//&nbsp;that&nbsp;created&nbsp;the&nbsp;Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5727731">stickyErr</span>&nbsp;<span class="builtintype" id="5727741">error</span>&nbsp;&nbsp;<span class="comment" id="5727748">//&nbsp;if&nbsp;non-nil,&nbsp;this&nbsp;error&nbsp;is&nbsp;returned&nbsp;for&nbsp;all&nbsp;operations</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5727807">closemu</span>&nbsp;<span class="ident" id="5727815">sync</span><span class="op" id="5727819">.</span><span class="ident" id="5727820">RWMutex</span>&nbsp;<span class="comment" id="5727828">//&nbsp;held&nbsp;exclusively&nbsp;during&nbsp;close,&nbsp;for&nbsp;read&nbsp;otherwise.</span><br>
<span class="lineno"></span><br>
<span class="lineno">1285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5727884">//&nbsp;If&nbsp;in&nbsp;a&nbsp;transaction,&nbsp;else&nbsp;both&nbsp;nil:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5727924">tx</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5727929">*</span><span class="ident" id="5727930">Tx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5727934">txsi</span>&nbsp;<span class="op" id="5727939">*</span><span class="ident" id="5727940">driverStmt</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5727953">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5727960">sync</span><span class="op" id="5727964">.</span><span class="ident" id="5727965">Mutex</span>&nbsp;<span class="comment" id="5727971">//&nbsp;protects&nbsp;the&nbsp;rest&nbsp;of&nbsp;the&nbsp;fields</span><br>
<span class="lineno">1290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5728007">closed</span>&nbsp;<span class="builtintype" id="5728014">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5728021">//&nbsp;css&nbsp;is&nbsp;a&nbsp;list&nbsp;of&nbsp;underlying&nbsp;driver&nbsp;statement&nbsp;interfaces</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5728081">//&nbsp;that&nbsp;are&nbsp;valid&nbsp;on&nbsp;particular&nbsp;connections.&nbsp;&nbsp;This&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5728141">//&nbsp;used&nbsp;if&nbsp;tx&nbsp;==&nbsp;nil&nbsp;and&nbsp;one&nbsp;is&nbsp;found&nbsp;that&nbsp;has&nbsp;idle</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5728194">//&nbsp;connections.&nbsp;&nbsp;If&nbsp;tx&nbsp;!=&nbsp;nil,&nbsp;txsi&nbsp;is&nbsp;always&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5728247">css</span>&nbsp;<span class="op" id="5728251">[</span><span class="op" id="5728252">]</span><span class="ident" id="5728253">connStmt</span><br>
<span class="lineno"></span><span class="op" id="5728262">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5728265">//&nbsp;Exec&nbsp;executes&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;with&nbsp;the&nbsp;given&nbsp;arguments&nbsp;and</span><br>
<span class="lineno">1300</span><span class="comment" id="5728332">//&nbsp;returns&nbsp;a&nbsp;Result&nbsp;summarizing&nbsp;the&nbsp;effect&nbsp;of&nbsp;the&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5728393">func</span>&nbsp;<span class="op" id="5728398">(</span><span class="ident" id="5728399">s</span>&nbsp;<span class="op" id="5728401">*</span><span class="ident" id="5728402">Stmt</span><span class="op" id="5728406">)</span>&nbsp;<span class="ident" id="5728408">Exec</span><span class="op" id="5728412">(</span><span class="ident" id="5728413">args</span>&nbsp;<span class="op" id="5728418">...</span><span class="keyword" id="5728421">interface</span><span class="op" id="5728430">{</span><span class="op" id="5728431">}</span><span class="op" id="5728432">)</span>&nbsp;<span class="op" id="5728434">(</span><span class="ident" id="5728435">Result</span><span class="op" id="5728441">,</span>&nbsp;<span class="builtintype" id="5728443">error</span><span class="op" id="5728448">)</span>&nbsp;<span class="op" id="5728450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5728453">s</span><span class="op" id="5728454">.</span><span class="ident" id="5728455">closemu</span><span class="op" id="5728462">.</span><span class="ident" id="5728463">RLock</span><span class="op" id="5728468">(</span><span class="op" id="5728469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5728472">defer</span>&nbsp;<span class="ident" id="5728478">s</span><span class="op" id="5728479">.</span><span class="ident" id="5728480">closemu</span><span class="op" id="5728487">.</span><span class="ident" id="5728488">RUnlock</span><span class="op" id="5728495">(</span><span class="op" id="5728496">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5728500">var</span>&nbsp;<span class="ident" id="5728504">res</span>&nbsp;<span class="ident" id="5728508">Result</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5728516">for</span>&nbsp;<span class="ident" id="5728520">i</span>&nbsp;<span class="op" id="5728522">:=</span>&nbsp;<span class="num" id="5728525">0</span><span class="op" id="5728526">;</span>&nbsp;<span class="ident" id="5728528">i</span>&nbsp;<span class="op" id="5728530">&lt;</span>&nbsp;<span class="ident" id="5728532">maxBadConnRetries</span><span class="op" id="5728549">;</span>&nbsp;<span class="ident" id="5728551">i</span><span class="op" id="5728552">++</span>&nbsp;<span class="op" id="5728555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5728559">dc</span><span class="op" id="5728561">,</span>&nbsp;<span class="ident" id="5728563">releaseConn</span><span class="op" id="5728574">,</span>&nbsp;<span class="ident" id="5728576">si</span><span class="op" id="5728578">,</span>&nbsp;<span class="ident" id="5728580">err</span>&nbsp;<span class="op" id="5728584">:=</span>&nbsp;<span class="ident" id="5728587">s</span><span class="op" id="5728588">.</span><span class="ident" id="5728589">connStmt</span><span class="op" id="5728597">(</span><span class="op" id="5728598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5728602">if</span>&nbsp;<span class="ident" id="5728605">err</span>&nbsp;<span class="op" id="5728609">!=</span>&nbsp;<span class="ident" id="5728612">nil</span>&nbsp;<span class="op" id="5728616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5728621">if</span>&nbsp;<span class="ident" id="5728624">err</span>&nbsp;<span class="op" id="5728628">==</span>&nbsp;<span class="ident" id="5728631">driver</span><span class="op" id="5728637">.</span><span class="ident" id="5728638">ErrBadConn</span>&nbsp;<span class="op" id="5728649">{</span><br>
<span class="lineno">1310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5728655">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5728667">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5728672">return</span>&nbsp;<span class="ident" id="5728679">nil</span><span class="op" id="5728682">,</span>&nbsp;<span class="ident" id="5728684">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5728690">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5728695">res</span><span class="op" id="5728698">,</span>&nbsp;<span class="ident" id="5728700">err</span>&nbsp;<span class="op" id="5728704">=</span>&nbsp;<span class="ident" id="5728706">resultFromStatement</span><span class="op" id="5728725">(</span><span class="ident" id="5728726">driverStmt</span><span class="op" id="5728736">{</span><span class="ident" id="5728737">dc</span><span class="op" id="5728739">,</span>&nbsp;<span class="ident" id="5728741">si</span><span class="op" id="5728743">}</span><span class="op" id="5728744">,</span>&nbsp;<span class="ident" id="5728746">args</span><span class="op" id="5728750">...</span><span class="op" id="5728753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5728757">releaseConn</span><span class="op" id="5728768">(</span><span class="ident" id="5728769">err</span><span class="op" id="5728772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5728776">if</span>&nbsp;<span class="ident" id="5728779">err</span>&nbsp;<span class="op" id="5728783">!=</span>&nbsp;<span class="ident" id="5728786">driver</span><span class="op" id="5728792">.</span><span class="ident" id="5728793">ErrBadConn</span>&nbsp;<span class="op" id="5728804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5728809">return</span>&nbsp;<span class="ident" id="5728816">res</span><span class="op" id="5728819">,</span>&nbsp;<span class="ident" id="5728821">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5728827">}</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5728830">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5728833">return</span>&nbsp;<span class="ident" id="5728840">nil</span><span class="op" id="5728843">,</span>&nbsp;<span class="ident" id="5728845">driver</span><span class="op" id="5728851">.</span><span class="ident" id="5728852">ErrBadConn</span><br>
<span class="lineno"></span><span class="op" id="5728863">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5728866">func</span>&nbsp;<span class="ident" id="5728871">resultFromStatement</span><span class="op" id="5728890">(</span><span class="ident" id="5728891">ds</span>&nbsp;<span class="ident" id="5728894">driverStmt</span><span class="op" id="5728904">,</span>&nbsp;<span class="ident" id="5728906">args</span>&nbsp;<span class="op" id="5728911">...</span><span class="keyword" id="5728914">interface</span><span class="op" id="5728923">{</span><span class="op" id="5728924">}</span><span class="op" id="5728925">)</span>&nbsp;<span class="op" id="5728927">(</span><span class="ident" id="5728928">Result</span><span class="op" id="5728934">,</span>&nbsp;<span class="builtintype" id="5728936">error</span><span class="op" id="5728941">)</span>&nbsp;<span class="op" id="5728943">{</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5728946">ds</span><span class="op" id="5728948">.</span><span class="ident" id="5728949">Lock</span><span class="op" id="5728953">(</span><span class="op" id="5728954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5728957">want</span>&nbsp;<span class="op" id="5728962">:=</span>&nbsp;<span class="ident" id="5728965">ds</span><span class="op" id="5728967">.</span><span class="ident" id="5728968">si</span><span class="op" id="5728970">.</span><span class="ident" id="5728971">NumInput</span><span class="op" id="5728979">(</span><span class="op" id="5728980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5728983">ds</span><span class="op" id="5728985">.</span><span class="ident" id="5728986">Unlock</span><span class="op" id="5728992">(</span><span class="op" id="5728993">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5728997">//&nbsp;-1&nbsp;means&nbsp;the&nbsp;driver&nbsp;doesn&#39;t&nbsp;know&nbsp;how&nbsp;to&nbsp;count&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5729061">//&nbsp;placeholders,&nbsp;so&nbsp;we&nbsp;won&#39;t&nbsp;sanity&nbsp;check&nbsp;input&nbsp;here&nbsp;and&nbsp;instead&nbsp;let&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5729135">//&nbsp;driver&nbsp;deal&nbsp;with&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5729164">if</span>&nbsp;<span class="ident" id="5729167">want</span>&nbsp;<span class="op" id="5729172">!=</span>&nbsp;<span class="op" id="5729175">-</span><span class="num" id="5729176">1</span>&nbsp;<span class="op" id="5729178">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5729181">len</span><span class="op" id="5729184">(</span><span class="ident" id="5729185">args</span><span class="op" id="5729189">)</span>&nbsp;<span class="op" id="5729191">!=</span>&nbsp;<span class="ident" id="5729194">want</span>&nbsp;<span class="op" id="5729199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5729203">return</span>&nbsp;<span class="ident" id="5729210">nil</span><span class="op" id="5729213">,</span>&nbsp;<span class="ident" id="5729215">fmt</span><span class="op" id="5729218">.</span><span class="ident" id="5729219">Errorf</span><span class="op" id="5729225">(</span><span class="string" id="5729226">&#34;sql:&nbsp;expected&nbsp;%d&nbsp;arguments,&nbsp;got&nbsp;%d&#34;</span><span class="op" id="5729262">,</span>&nbsp;<span class="ident" id="5729264">want</span><span class="op" id="5729268">,</span>&nbsp;<span class="builtinfunc" id="5729270">len</span><span class="op" id="5729273">(</span><span class="ident" id="5729274">args</span><span class="op" id="5729278">)</span><span class="op" id="5729279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5729282">}</span><br>
<span class="lineno">1335</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5729286">dargs</span><span class="op" id="5729291">,</span>&nbsp;<span class="ident" id="5729293">err</span>&nbsp;<span class="op" id="5729297">:=</span>&nbsp;<span class="ident" id="5729300">driverArgs</span><span class="op" id="5729310">(</span><span class="op" id="5729311">&amp;</span><span class="ident" id="5729312">ds</span><span class="op" id="5729314">,</span>&nbsp;<span class="ident" id="5729316">args</span><span class="op" id="5729320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5729323">if</span>&nbsp;<span class="ident" id="5729326">err</span>&nbsp;<span class="op" id="5729330">!=</span>&nbsp;<span class="ident" id="5729333">nil</span>&nbsp;<span class="op" id="5729337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5729341">return</span>&nbsp;<span class="ident" id="5729348">nil</span><span class="op" id="5729351">,</span>&nbsp;<span class="ident" id="5729353">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5729358">}</span><br>
<span class="lineno">1340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5729362">ds</span><span class="op" id="5729364">.</span><span class="ident" id="5729365">Lock</span><span class="op" id="5729369">(</span><span class="op" id="5729370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5729373">resi</span><span class="op" id="5729377">,</span>&nbsp;<span class="ident" id="5729379">err</span>&nbsp;<span class="op" id="5729383">:=</span>&nbsp;<span class="ident" id="5729386">ds</span><span class="op" id="5729388">.</span><span class="ident" id="5729389">si</span><span class="op" id="5729391">.</span><span class="ident" id="5729392">Exec</span><span class="op" id="5729396">(</span><span class="ident" id="5729397">dargs</span><span class="op" id="5729402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5729405">ds</span><span class="op" id="5729407">.</span><span class="ident" id="5729408">Unlock</span><span class="op" id="5729414">(</span><span class="op" id="5729415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5729418">if</span>&nbsp;<span class="ident" id="5729421">err</span>&nbsp;<span class="op" id="5729425">!=</span>&nbsp;<span class="ident" id="5729428">nil</span>&nbsp;<span class="op" id="5729432">{</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5729436">return</span>&nbsp;<span class="ident" id="5729443">nil</span><span class="op" id="5729446">,</span>&nbsp;<span class="ident" id="5729448">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5729453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5729456">return</span>&nbsp;<span class="ident" id="5729463">driverResult</span><span class="op" id="5729475">{</span><span class="ident" id="5729476">ds</span><span class="op" id="5729478">.</span><span class="ident" id="5729479">Locker</span><span class="op" id="5729485">,</span>&nbsp;<span class="ident" id="5729487">resi</span><span class="op" id="5729491">}</span><span class="op" id="5729492">,</span>&nbsp;<span class="ident" id="5729494">nil</span><br>
<span class="lineno"></span><span class="op" id="5729498">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1350</span><span class="comment" id="5729501">//&nbsp;connStmt&nbsp;returns&nbsp;a&nbsp;free&nbsp;driver&nbsp;connection&nbsp;on&nbsp;which&nbsp;to&nbsp;execute&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5729570">//&nbsp;statement,&nbsp;a&nbsp;function&nbsp;to&nbsp;call&nbsp;to&nbsp;release&nbsp;the&nbsp;connection,&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5729636">//&nbsp;statement&nbsp;bound&nbsp;to&nbsp;that&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="5729675">func</span>&nbsp;<span class="op" id="5729680">(</span><span class="ident" id="5729681">s</span>&nbsp;<span class="op" id="5729683">*</span><span class="ident" id="5729684">Stmt</span><span class="op" id="5729688">)</span>&nbsp;<span class="ident" id="5729690">connStmt</span><span class="op" id="5729698">(</span><span class="op" id="5729699">)</span>&nbsp;<span class="op" id="5729701">(</span><span class="ident" id="5729702">ci</span>&nbsp;<span class="op" id="5729705">*</span><span class="ident" id="5729706">driverConn</span><span class="op" id="5729716">,</span>&nbsp;<span class="ident" id="5729718">releaseConn</span>&nbsp;<span class="keyword" id="5729730">func</span><span class="op" id="5729734">(</span><span class="builtintype" id="5729735">error</span><span class="op" id="5729740">)</span><span class="op" id="5729741">,</span>&nbsp;<span class="ident" id="5729743">si</span>&nbsp;<span class="ident" id="5729746">driver</span><span class="op" id="5729752">.</span><span class="ident" id="5729753">Stmt</span><span class="op" id="5729757">,</span>&nbsp;<span class="ident" id="5729759">err</span>&nbsp;<span class="builtintype" id="5729763">error</span><span class="op" id="5729768">)</span>&nbsp;<span class="op" id="5729770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5729773">if</span>&nbsp;<span class="ident" id="5729776">err</span>&nbsp;<span class="op" id="5729780">=</span>&nbsp;<span class="ident" id="5729782">s</span><span class="op" id="5729783">.</span><span class="ident" id="5729784">stickyErr</span><span class="op" id="5729793">;</span>&nbsp;<span class="ident" id="5729795">err</span>&nbsp;<span class="op" id="5729799">!=</span>&nbsp;<span class="ident" id="5729802">nil</span>&nbsp;<span class="op" id="5729806">{</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5729810">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5729818">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5729821">s</span><span class="op" id="5729822">.</span><span class="ident" id="5729823">mu</span><span class="op" id="5729825">.</span><span class="ident" id="5729826">Lock</span><span class="op" id="5729830">(</span><span class="op" id="5729831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5729834">if</span>&nbsp;<span class="ident" id="5729837">s</span><span class="op" id="5729838">.</span><span class="ident" id="5729839">closed</span>&nbsp;<span class="op" id="5729846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5729850">s</span><span class="op" id="5729851">.</span><span class="ident" id="5729852">mu</span><span class="op" id="5729854">.</span><span class="ident" id="5729855">Unlock</span><span class="op" id="5729861">(</span><span class="op" id="5729862">)</span><br>
<span class="lineno">1360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5729866">err</span>&nbsp;<span class="op" id="5729870">=</span>&nbsp;<span class="ident" id="5729872">errors</span><span class="op" id="5729878">.</span><span class="ident" id="5729879">New</span><span class="op" id="5729882">(</span><span class="string" id="5729883">&#34;sql:&nbsp;statement&nbsp;is&nbsp;closed&#34;</span><span class="op" id="5729909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5729913">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5729921">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5729925">//&nbsp;In&nbsp;a&nbsp;transaction,&nbsp;we&nbsp;always&nbsp;use&nbsp;the&nbsp;connection&nbsp;that&nbsp;the</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5729985">//&nbsp;transaction&nbsp;was&nbsp;created&nbsp;on.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5730017">if</span>&nbsp;<span class="ident" id="5730020">s</span><span class="op" id="5730021">.</span><span class="ident" id="5730022">tx</span>&nbsp;<span class="op" id="5730025">!=</span>&nbsp;<span class="ident" id="5730028">nil</span>&nbsp;<span class="op" id="5730032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5730036">s</span><span class="op" id="5730037">.</span><span class="ident" id="5730038">mu</span><span class="op" id="5730040">.</span><span class="ident" id="5730041">Unlock</span><span class="op" id="5730047">(</span><span class="op" id="5730048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5730052">ci</span><span class="op" id="5730054">,</span>&nbsp;<span class="ident" id="5730056">err</span>&nbsp;<span class="op" id="5730060">=</span>&nbsp;<span class="ident" id="5730062">s</span><span class="op" id="5730063">.</span><span class="ident" id="5730064">tx</span><span class="op" id="5730066">.</span><span class="ident" id="5730067">grabConn</span><span class="op" id="5730075">(</span><span class="op" id="5730076">)</span>&nbsp;<span class="comment" id="5730078">//&nbsp;blocks,&nbsp;waiting&nbsp;for&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5730119">if</span>&nbsp;<span class="ident" id="5730122">err</span>&nbsp;<span class="op" id="5730126">!=</span>&nbsp;<span class="ident" id="5730129">nil</span>&nbsp;<span class="op" id="5730133">{</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5730138">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5730147">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5730151">releaseConn</span>&nbsp;<span class="op" id="5730163">=</span>&nbsp;<span class="keyword" id="5730165">func</span><span class="op" id="5730169">(</span><span class="builtintype" id="5730170">error</span><span class="op" id="5730175">)</span>&nbsp;<span class="op" id="5730177">{</span><span class="op" id="5730178">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5730182">return</span>&nbsp;<span class="ident" id="5730189">ci</span><span class="op" id="5730191">,</span>&nbsp;<span class="ident" id="5730193">releaseConn</span><span class="op" id="5730204">,</span>&nbsp;<span class="ident" id="5730206">s</span><span class="op" id="5730207">.</span><span class="ident" id="5730208">txsi</span><span class="op" id="5730212">.</span><span class="ident" id="5730213">si</span><span class="op" id="5730215">,</span>&nbsp;<span class="ident" id="5730217">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5730222">}</span><br>
<span class="lineno">1375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5730226">for</span>&nbsp;<span class="ident" id="5730230">i</span>&nbsp;<span class="op" id="5730232">:=</span>&nbsp;<span class="num" id="5730235">0</span><span class="op" id="5730236">;</span>&nbsp;<span class="ident" id="5730238">i</span>&nbsp;<span class="op" id="5730240">&lt;</span>&nbsp;<span class="builtinfunc" id="5730242">len</span><span class="op" id="5730245">(</span><span class="ident" id="5730246">s</span><span class="op" id="5730247">.</span><span class="ident" id="5730248">css</span><span class="op" id="5730251">)</span><span class="op" id="5730252">;</span>&nbsp;<span class="ident" id="5730254">i</span><span class="op" id="5730255">++</span>&nbsp;<span class="op" id="5730258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5730262">v</span>&nbsp;<span class="op" id="5730264">:=</span>&nbsp;<span class="ident" id="5730267">s</span><span class="op" id="5730268">.</span><span class="ident" id="5730269">css</span><span class="op" id="5730272">[</span><span class="ident" id="5730273">i</span><span class="op" id="5730274">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5730278">_</span><span class="op" id="5730279">,</span>&nbsp;<span class="ident" id="5730281">err</span>&nbsp;<span class="op" id="5730285">:=</span>&nbsp;<span class="ident" id="5730288">s</span><span class="op" id="5730289">.</span><span class="ident" id="5730290">db</span><span class="op" id="5730292">.</span><span class="ident" id="5730293">connIfFree</span><span class="op" id="5730303">(</span><span class="ident" id="5730304">v</span><span class="op" id="5730305">.</span><span class="ident" id="5730306">dc</span><span class="op" id="5730308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5730312">if</span>&nbsp;<span class="ident" id="5730315">err</span>&nbsp;<span class="op" id="5730319">==</span>&nbsp;<span class="ident" id="5730322">nil</span>&nbsp;<span class="op" id="5730326">{</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5730331">s</span><span class="op" id="5730332">.</span><span class="ident" id="5730333">mu</span><span class="op" id="5730335">.</span><span class="ident" id="5730336">Unlock</span><span class="op" id="5730342">(</span><span class="op" id="5730343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5730348">return</span>&nbsp;<span class="ident" id="5730355">v</span><span class="op" id="5730356">.</span><span class="ident" id="5730357">dc</span><span class="op" id="5730359">,</span>&nbsp;<span class="ident" id="5730361">v</span><span class="op" id="5730362">.</span><span class="ident" id="5730363">dc</span><span class="op" id="5730365">.</span><span class="ident" id="5730366">releaseConn</span><span class="op" id="5730377">,</span>&nbsp;<span class="ident" id="5730379">v</span><span class="op" id="5730380">.</span><span class="ident" id="5730381">si</span><span class="op" id="5730383">,</span>&nbsp;<span class="ident" id="5730385">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5730391">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5730395">if</span>&nbsp;<span class="ident" id="5730398">err</span>&nbsp;<span class="op" id="5730402">==</span>&nbsp;<span class="ident" id="5730405">errConnClosed</span>&nbsp;<span class="op" id="5730419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5730424">//&nbsp;Lazily&nbsp;remove&nbsp;dead&nbsp;conn&nbsp;from&nbsp;our&nbsp;freelist.</span><br>
<span class="lineno">1385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5730473">s</span><span class="op" id="5730474">.</span><span class="ident" id="5730475">css</span><span class="op" id="5730478">[</span><span class="ident" id="5730479">i</span><span class="op" id="5730480">]</span>&nbsp;<span class="op" id="5730482">=</span>&nbsp;<span class="ident" id="5730484">s</span><span class="op" id="5730485">.</span><span class="ident" id="5730486">css</span><span class="op" id="5730489">[</span><span class="builtinfunc" id="5730490">len</span><span class="op" id="5730493">(</span><span class="ident" id="5730494">s</span><span class="op" id="5730495">.</span><span class="ident" id="5730496">css</span><span class="op" id="5730499">)</span><span class="op" id="5730500">-</span><span class="num" id="5730501">1</span><span class="op" id="5730502">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5730507">s</span><span class="op" id="5730508">.</span><span class="ident" id="5730509">css</span>&nbsp;<span class="op" id="5730513">=</span>&nbsp;<span class="ident" id="5730515">s</span><span class="op" id="5730516">.</span><span class="ident" id="5730517">css</span><span class="op" id="5730520">[</span><span class="op" id="5730521">:</span><span class="builtinfunc" id="5730522">len</span><span class="op" id="5730525">(</span><span class="ident" id="5730526">s</span><span class="op" id="5730527">.</span><span class="ident" id="5730528">css</span><span class="op" id="5730531">)</span><span class="op" id="5730532">-</span><span class="num" id="5730533">1</span><span class="op" id="5730534">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5730539">i</span><span class="op" id="5730540">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5730545">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5730549">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5730552">s</span><span class="op" id="5730553">.</span><span class="ident" id="5730554">mu</span><span class="op" id="5730556">.</span><span class="ident" id="5730557">Unlock</span><span class="op" id="5730563">(</span><span class="op" id="5730564">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5730568">//&nbsp;If&nbsp;all&nbsp;connections&nbsp;are&nbsp;busy,&nbsp;either&nbsp;wait&nbsp;for&nbsp;one&nbsp;to&nbsp;become&nbsp;available&nbsp;(if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5730645">//&nbsp;we&#39;ve&nbsp;already&nbsp;hit&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;open&nbsp;connections)&nbsp;or&nbsp;create&nbsp;a</span><br>
<span class="lineno">1395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5730719">//&nbsp;new&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5730732">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5730736">//&nbsp;TODO(bradfitz):&nbsp;or&nbsp;always&nbsp;wait&nbsp;for&nbsp;one?&nbsp;make&nbsp;configurable&nbsp;later?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5730805">dc</span><span class="op" id="5730807">,</span>&nbsp;<span class="ident" id="5730809">err</span>&nbsp;<span class="op" id="5730813">:=</span>&nbsp;<span class="ident" id="5730816">s</span><span class="op" id="5730817">.</span><span class="ident" id="5730818">db</span><span class="op" id="5730820">.</span><span class="ident" id="5730821">conn</span><span class="op" id="5730825">(</span><span class="op" id="5730826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5730829">if</span>&nbsp;<span class="ident" id="5730832">err</span>&nbsp;<span class="op" id="5730836">!=</span>&nbsp;<span class="ident" id="5730839">nil</span>&nbsp;<span class="op" id="5730843">{</span><br>
<span class="lineno">1400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5730847">return</span>&nbsp;<span class="ident" id="5730854">nil</span><span class="op" id="5730857">,</span>&nbsp;<span class="ident" id="5730859">nil</span><span class="op" id="5730862">,</span>&nbsp;<span class="ident" id="5730864">nil</span><span class="op" id="5730867">,</span>&nbsp;<span class="ident" id="5730869">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5730874">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5730878">//&nbsp;Do&nbsp;another&nbsp;pass&nbsp;over&nbsp;the&nbsp;list&nbsp;to&nbsp;see&nbsp;whether&nbsp;this&nbsp;statement&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5730946">//&nbsp;already&nbsp;been&nbsp;prepared&nbsp;on&nbsp;the&nbsp;connection&nbsp;assigned&nbsp;to&nbsp;us.</span><br>
<span class="lineno">1405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5731006">s</span><span class="op" id="5731007">.</span><span class="ident" id="5731008">mu</span><span class="op" id="5731010">.</span><span class="ident" id="5731011">Lock</span><span class="op" id="5731015">(</span><span class="op" id="5731016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5731019">for</span>&nbsp;<span class="ident" id="5731023">_</span><span class="op" id="5731024">,</span>&nbsp;<span class="ident" id="5731026">v</span>&nbsp;<span class="op" id="5731028">:=</span>&nbsp;<span class="keyword" id="5731031">range</span>&nbsp;<span class="ident" id="5731037">s</span><span class="op" id="5731038">.</span><span class="ident" id="5731039">css</span>&nbsp;<span class="op" id="5731043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5731047">if</span>&nbsp;<span class="ident" id="5731050">v</span><span class="op" id="5731051">.</span><span class="ident" id="5731052">dc</span>&nbsp;<span class="op" id="5731055">==</span>&nbsp;<span class="ident" id="5731058">dc</span>&nbsp;<span class="op" id="5731061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5731066">s</span><span class="op" id="5731067">.</span><span class="ident" id="5731068">mu</span><span class="op" id="5731070">.</span><span class="ident" id="5731071">Unlock</span><span class="op" id="5731077">(</span><span class="op" id="5731078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5731083">return</span>&nbsp;<span class="ident" id="5731090">dc</span><span class="op" id="5731092">,</span>&nbsp;<span class="ident" id="5731094">dc</span><span class="op" id="5731096">.</span><span class="ident" id="5731097">releaseConn</span><span class="op" id="5731108">,</span>&nbsp;<span class="ident" id="5731110">v</span><span class="op" id="5731111">.</span><span class="ident" id="5731112">si</span><span class="op" id="5731114">,</span>&nbsp;<span class="ident" id="5731116">nil</span><br>
<span class="lineno">1410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5731122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5731125">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5731128">s</span><span class="op" id="5731129">.</span><span class="ident" id="5731130">mu</span><span class="op" id="5731132">.</span><span class="ident" id="5731133">Unlock</span><span class="op" id="5731139">(</span><span class="op" id="5731140">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5731144">//&nbsp;No&nbsp;luck;&nbsp;we&nbsp;need&nbsp;to&nbsp;prepare&nbsp;the&nbsp;statement&nbsp;on&nbsp;this&nbsp;connection</span><br>
<span class="lineno">1415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5731209">dc</span><span class="op" id="5731211">.</span><span class="ident" id="5731212">Lock</span><span class="op" id="5731216">(</span><span class="op" id="5731217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5731220">si</span><span class="op" id="5731222">,</span>&nbsp;<span class="ident" id="5731224">err</span>&nbsp;<span class="op" id="5731228">=</span>&nbsp;<span class="ident" id="5731230">dc</span><span class="op" id="5731232">.</span><span class="ident" id="5731233">prepareLocked</span><span class="op" id="5731246">(</span><span class="ident" id="5731247">s</span><span class="op" id="5731248">.</span><span class="ident" id="5731249">query</span><span class="op" id="5731254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5731257">dc</span><span class="op" id="5731259">.</span><span class="ident" id="5731260">Unlock</span><span class="op" id="5731266">(</span><span class="op" id="5731267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5731270">if</span>&nbsp;<span class="ident" id="5731273">err</span>&nbsp;<span class="op" id="5731277">!=</span>&nbsp;<span class="ident" id="5731280">nil</span>&nbsp;<span class="op" id="5731284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5731288">s</span><span class="op" id="5731289">.</span><span class="ident" id="5731290">db</span><span class="op" id="5731292">.</span><span class="ident" id="5731293">putConn</span><span class="op" id="5731300">(</span><span class="ident" id="5731301">dc</span><span class="op" id="5731303">,</span>&nbsp;<span class="ident" id="5731305">err</span><span class="op" id="5731308">)</span><br>
<span class="lineno">1420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5731312">return</span>&nbsp;<span class="ident" id="5731319">nil</span><span class="op" id="5731322">,</span>&nbsp;<span class="ident" id="5731324">nil</span><span class="op" id="5731327">,</span>&nbsp;<span class="ident" id="5731329">nil</span><span class="op" id="5731332">,</span>&nbsp;<span class="ident" id="5731334">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5731339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5731342">s</span><span class="op" id="5731343">.</span><span class="ident" id="5731344">mu</span><span class="op" id="5731346">.</span><span class="ident" id="5731347">Lock</span><span class="op" id="5731351">(</span><span class="op" id="5731352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5731355">cs</span>&nbsp;<span class="op" id="5731358">:=</span>&nbsp;<span class="ident" id="5731361">connStmt</span><span class="op" id="5731369">{</span><span class="ident" id="5731370">dc</span><span class="op" id="5731372">,</span>&nbsp;<span class="ident" id="5731374">si</span><span class="op" id="5731376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5731379">s</span><span class="op" id="5731380">.</span><span class="ident" id="5731381">css</span>&nbsp;<span class="op" id="5731385">=</span>&nbsp;<span class="builtinfunc" id="5731387">append</span><span class="op" id="5731393">(</span><span class="ident" id="5731394">s</span><span class="op" id="5731395">.</span><span class="ident" id="5731396">css</span><span class="op" id="5731399">,</span>&nbsp;<span class="ident" id="5731401">cs</span><span class="op" id="5731403">)</span><br>
<span class="lineno">1425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5731406">s</span><span class="op" id="5731407">.</span><span class="ident" id="5731408">mu</span><span class="op" id="5731410">.</span><span class="ident" id="5731411">Unlock</span><span class="op" id="5731417">(</span><span class="op" id="5731418">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5731422">return</span>&nbsp;<span class="ident" id="5731429">dc</span><span class="op" id="5731431">,</span>&nbsp;<span class="ident" id="5731433">dc</span><span class="op" id="5731435">.</span><span class="ident" id="5731436">releaseConn</span><span class="op" id="5731447">,</span>&nbsp;<span class="ident" id="5731449">si</span><span class="op" id="5731451">,</span>&nbsp;<span class="ident" id="5731453">nil</span><br>
<span class="lineno"></span><span class="op" id="5731457">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1430</span><span class="comment" id="5731460">//&nbsp;Query&nbsp;executes&nbsp;a&nbsp;prepared&nbsp;query&nbsp;statement&nbsp;with&nbsp;the&nbsp;given&nbsp;arguments</span><br>
<span class="lineno"></span><span class="comment" id="5731530">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;query&nbsp;results&nbsp;as&nbsp;a&nbsp;*Rows.</span><br>
<span class="lineno"></span><span class="keyword" id="5731575">func</span>&nbsp;<span class="op" id="5731580">(</span><span class="ident" id="5731581">s</span>&nbsp;<span class="op" id="5731583">*</span><span class="ident" id="5731584">Stmt</span><span class="op" id="5731588">)</span>&nbsp;<span class="ident" id="5731590">Query</span><span class="op" id="5731595">(</span><span class="ident" id="5731596">args</span>&nbsp;<span class="op" id="5731601">...</span><span class="keyword" id="5731604">interface</span><span class="op" id="5731613">{</span><span class="op" id="5731614">}</span><span class="op" id="5731615">)</span>&nbsp;<span class="op" id="5731617">(</span><span class="op" id="5731618">*</span><span class="ident" id="5731619">Rows</span><span class="op" id="5731623">,</span>&nbsp;<span class="builtintype" id="5731625">error</span><span class="op" id="5731630">)</span>&nbsp;<span class="op" id="5731632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5731635">s</span><span class="op" id="5731636">.</span><span class="ident" id="5731637">closemu</span><span class="op" id="5731644">.</span><span class="ident" id="5731645">RLock</span><span class="op" id="5731650">(</span><span class="op" id="5731651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5731654">defer</span>&nbsp;<span class="ident" id="5731660">s</span><span class="op" id="5731661">.</span><span class="ident" id="5731662">closemu</span><span class="op" id="5731669">.</span><span class="ident" id="5731670">RUnlock</span><span class="op" id="5731677">(</span><span class="op" id="5731678">)</span><br>
<span class="lineno">1435</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5731682">var</span>&nbsp;<span class="ident" id="5731686">rowsi</span>&nbsp;<span class="ident" id="5731692">driver</span><span class="op" id="5731698">.</span><span class="ident" id="5731699">Rows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5731705">for</span>&nbsp;<span class="ident" id="5731709">i</span>&nbsp;<span class="op" id="5731711">:=</span>&nbsp;<span class="num" id="5731714">0</span><span class="op" id="5731715">;</span>&nbsp;<span class="ident" id="5731717">i</span>&nbsp;<span class="op" id="5731719">&lt;</span>&nbsp;<span class="ident" id="5731721">maxBadConnRetries</span><span class="op" id="5731738">;</span>&nbsp;<span class="ident" id="5731740">i</span><span class="op" id="5731741">++</span>&nbsp;<span class="op" id="5731744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5731748">dc</span><span class="op" id="5731750">,</span>&nbsp;<span class="ident" id="5731752">releaseConn</span><span class="op" id="5731763">,</span>&nbsp;<span class="ident" id="5731765">si</span><span class="op" id="5731767">,</span>&nbsp;<span class="ident" id="5731769">err</span>&nbsp;<span class="op" id="5731773">:=</span>&nbsp;<span class="ident" id="5731776">s</span><span class="op" id="5731777">.</span><span class="ident" id="5731778">connStmt</span><span class="op" id="5731786">(</span><span class="op" id="5731787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5731791">if</span>&nbsp;<span class="ident" id="5731794">err</span>&nbsp;<span class="op" id="5731798">!=</span>&nbsp;<span class="ident" id="5731801">nil</span>&nbsp;<span class="op" id="5731805">{</span><br>
<span class="lineno">1440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5731810">if</span>&nbsp;<span class="ident" id="5731813">err</span>&nbsp;<span class="op" id="5731817">==</span>&nbsp;<span class="ident" id="5731820">driver</span><span class="op" id="5731826">.</span><span class="ident" id="5731827">ErrBadConn</span>&nbsp;<span class="op" id="5731838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5731844">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5731856">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5731861">return</span>&nbsp;<span class="ident" id="5731868">nil</span><span class="op" id="5731871">,</span>&nbsp;<span class="ident" id="5731873">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5731879">}</span><br>
<span class="lineno">1445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5731884">rowsi</span><span class="op" id="5731889">,</span>&nbsp;<span class="ident" id="5731891">err</span>&nbsp;<span class="op" id="5731895">=</span>&nbsp;<span class="ident" id="5731897">rowsiFromStatement</span><span class="op" id="5731915">(</span><span class="ident" id="5731916">driverStmt</span><span class="op" id="5731926">{</span><span class="ident" id="5731927">dc</span><span class="op" id="5731929">,</span>&nbsp;<span class="ident" id="5731931">si</span><span class="op" id="5731933">}</span><span class="op" id="5731934">,</span>&nbsp;<span class="ident" id="5731936">args</span><span class="op" id="5731940">...</span><span class="op" id="5731943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5731947">if</span>&nbsp;<span class="ident" id="5731950">err</span>&nbsp;<span class="op" id="5731954">==</span>&nbsp;<span class="ident" id="5731957">nil</span>&nbsp;<span class="op" id="5731961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5731966">//&nbsp;Note:&nbsp;ownership&nbsp;of&nbsp;ci&nbsp;passes&nbsp;to&nbsp;the&nbsp;*Rows,&nbsp;to&nbsp;be&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5732027">//&nbsp;with&nbsp;releaseConn.</span><br>
<span class="lineno">1450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5732051">rows</span>&nbsp;<span class="op" id="5732056">:=</span>&nbsp;<span class="op" id="5732059">&amp;</span><span class="ident" id="5732060">Rows</span><span class="op" id="5732064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5732070">dc</span><span class="op" id="5732072">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5732077">dc</span><span class="op" id="5732079">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5732085">rowsi</span><span class="op" id="5732090">:</span>&nbsp;<span class="ident" id="5732092">rowsi</span><span class="op" id="5732097">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5732103">//&nbsp;releaseConn&nbsp;set&nbsp;below</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5732131">}</span><br>
<span class="lineno">1455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5732136">s</span><span class="op" id="5732137">.</span><span class="ident" id="5732138">db</span><span class="op" id="5732140">.</span><span class="ident" id="5732141">addDep</span><span class="op" id="5732147">(</span><span class="ident" id="5732148">s</span><span class="op" id="5732149">,</span>&nbsp;<span class="ident" id="5732151">rows</span><span class="op" id="5732155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5732160">rows</span><span class="op" id="5732164">.</span><span class="ident" id="5732165">releaseConn</span>&nbsp;<span class="op" id="5732177">=</span>&nbsp;<span class="keyword" id="5732179">func</span><span class="op" id="5732183">(</span><span class="ident" id="5732184">err</span>&nbsp;<span class="builtintype" id="5732188">error</span><span class="op" id="5732193">)</span>&nbsp;<span class="op" id="5732195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5732201">releaseConn</span><span class="op" id="5732212">(</span><span class="ident" id="5732213">err</span><span class="op" id="5732216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5732222">s</span><span class="op" id="5732223">.</span><span class="ident" id="5732224">db</span><span class="op" id="5732226">.</span><span class="ident" id="5732227">removeDep</span><span class="op" id="5732236">(</span><span class="ident" id="5732237">s</span><span class="op" id="5732238">,</span>&nbsp;<span class="ident" id="5732240">rows</span><span class="op" id="5732244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5732249">}</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5732254">return</span>&nbsp;<span class="ident" id="5732261">rows</span><span class="op" id="5732265">,</span>&nbsp;<span class="ident" id="5732267">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5732273">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5732278">releaseConn</span><span class="op" id="5732289">(</span><span class="ident" id="5732290">err</span><span class="op" id="5732293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5732297">if</span>&nbsp;<span class="ident" id="5732300">err</span>&nbsp;<span class="op" id="5732304">!=</span>&nbsp;<span class="ident" id="5732307">driver</span><span class="op" id="5732313">.</span><span class="ident" id="5732314">ErrBadConn</span>&nbsp;<span class="op" id="5732325">{</span><br>
<span class="lineno">1465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5732330">return</span>&nbsp;<span class="ident" id="5732337">nil</span><span class="op" id="5732340">,</span>&nbsp;<span class="ident" id="5732342">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5732348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5732351">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5732354">return</span>&nbsp;<span class="ident" id="5732361">nil</span><span class="op" id="5732364">,</span>&nbsp;<span class="ident" id="5732366">driver</span><span class="op" id="5732372">.</span><span class="ident" id="5732373">ErrBadConn</span><br>
<span class="lineno"></span><span class="op" id="5732384">}</span><br>
<span class="lineno">1470</span><br>
<span class="lineno"></span><span class="keyword" id="5732387">func</span>&nbsp;<span class="ident" id="5732392">rowsiFromStatement</span><span class="op" id="5732410">(</span><span class="ident" id="5732411">ds</span>&nbsp;<span class="ident" id="5732414">driverStmt</span><span class="op" id="5732424">,</span>&nbsp;<span class="ident" id="5732426">args</span>&nbsp;<span class="op" id="5732431">...</span><span class="keyword" id="5732434">interface</span><span class="op" id="5732443">{</span><span class="op" id="5732444">}</span><span class="op" id="5732445">)</span>&nbsp;<span class="op" id="5732447">(</span><span class="ident" id="5732448">driver</span><span class="op" id="5732454">.</span><span class="ident" id="5732455">Rows</span><span class="op" id="5732459">,</span>&nbsp;<span class="builtintype" id="5732461">error</span><span class="op" id="5732466">)</span>&nbsp;<span class="op" id="5732468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5732471">ds</span><span class="op" id="5732473">.</span><span class="ident" id="5732474">Lock</span><span class="op" id="5732478">(</span><span class="op" id="5732479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5732482">want</span>&nbsp;<span class="op" id="5732487">:=</span>&nbsp;<span class="ident" id="5732490">ds</span><span class="op" id="5732492">.</span><span class="ident" id="5732493">si</span><span class="op" id="5732495">.</span><span class="ident" id="5732496">NumInput</span><span class="op" id="5732504">(</span><span class="op" id="5732505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5732508">ds</span><span class="op" id="5732510">.</span><span class="ident" id="5732511">Unlock</span><span class="op" id="5732517">(</span><span class="op" id="5732518">)</span><br>
<span class="lineno">1475</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5732522">//&nbsp;-1&nbsp;means&nbsp;the&nbsp;driver&nbsp;doesn&#39;t&nbsp;know&nbsp;how&nbsp;to&nbsp;count&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5732586">//&nbsp;placeholders,&nbsp;so&nbsp;we&nbsp;won&#39;t&nbsp;sanity&nbsp;check&nbsp;input&nbsp;here&nbsp;and&nbsp;instead&nbsp;let&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5732660">//&nbsp;driver&nbsp;deal&nbsp;with&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5732689">if</span>&nbsp;<span class="ident" id="5732692">want</span>&nbsp;<span class="op" id="5732697">!=</span>&nbsp;<span class="op" id="5732700">-</span><span class="num" id="5732701">1</span>&nbsp;<span class="op" id="5732703">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5732706">len</span><span class="op" id="5732709">(</span><span class="ident" id="5732710">args</span><span class="op" id="5732714">)</span>&nbsp;<span class="op" id="5732716">!=</span>&nbsp;<span class="ident" id="5732719">want</span>&nbsp;<span class="op" id="5732724">{</span><br>
<span class="lineno">1480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5732728">return</span>&nbsp;<span class="ident" id="5732735">nil</span><span class="op" id="5732738">,</span>&nbsp;<span class="ident" id="5732740">fmt</span><span class="op" id="5732743">.</span><span class="ident" id="5732744">Errorf</span><span class="op" id="5732750">(</span><span class="string" id="5732751">&#34;sql:&nbsp;statement&nbsp;expects&nbsp;%d&nbsp;inputs;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="5732793">,</span>&nbsp;<span class="ident" id="5732795">want</span><span class="op" id="5732799">,</span>&nbsp;<span class="builtinfunc" id="5732801">len</span><span class="op" id="5732804">(</span><span class="ident" id="5732805">args</span><span class="op" id="5732809">)</span><span class="op" id="5732810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5732813">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5732817">dargs</span><span class="op" id="5732822">,</span>&nbsp;<span class="ident" id="5732824">err</span>&nbsp;<span class="op" id="5732828">:=</span>&nbsp;<span class="ident" id="5732831">driverArgs</span><span class="op" id="5732841">(</span><span class="op" id="5732842">&amp;</span><span class="ident" id="5732843">ds</span><span class="op" id="5732845">,</span>&nbsp;<span class="ident" id="5732847">args</span><span class="op" id="5732851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5732854">if</span>&nbsp;<span class="ident" id="5732857">err</span>&nbsp;<span class="op" id="5732861">!=</span>&nbsp;<span class="ident" id="5732864">nil</span>&nbsp;<span class="op" id="5732868">{</span><br>
<span class="lineno">1485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5732872">return</span>&nbsp;<span class="ident" id="5732879">nil</span><span class="op" id="5732882">,</span>&nbsp;<span class="ident" id="5732884">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5732889">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5732893">ds</span><span class="op" id="5732895">.</span><span class="ident" id="5732896">Lock</span><span class="op" id="5732900">(</span><span class="op" id="5732901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5732904">rowsi</span><span class="op" id="5732909">,</span>&nbsp;<span class="ident" id="5732911">err</span>&nbsp;<span class="op" id="5732915">:=</span>&nbsp;<span class="ident" id="5732918">ds</span><span class="op" id="5732920">.</span><span class="ident" id="5732921">si</span><span class="op" id="5732923">.</span><span class="ident" id="5732924">Query</span><span class="op" id="5732929">(</span><span class="ident" id="5732930">dargs</span><span class="op" id="5732935">)</span><br>
<span class="lineno">1490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5732938">ds</span><span class="op" id="5732940">.</span><span class="ident" id="5732941">Unlock</span><span class="op" id="5732947">(</span><span class="op" id="5732948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5732951">if</span>&nbsp;<span class="ident" id="5732954">err</span>&nbsp;<span class="op" id="5732958">!=</span>&nbsp;<span class="ident" id="5732961">nil</span>&nbsp;<span class="op" id="5732965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5732969">return</span>&nbsp;<span class="ident" id="5732976">nil</span><span class="op" id="5732979">,</span>&nbsp;<span class="ident" id="5732981">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5732986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5732989">return</span>&nbsp;<span class="ident" id="5732996">rowsi</span><span class="op" id="5733001">,</span>&nbsp;<span class="ident" id="5733003">nil</span><br>
<span class="lineno">1495</span><span class="op" id="5733007">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5733010">//&nbsp;QueryRow&nbsp;executes&nbsp;a&nbsp;prepared&nbsp;query&nbsp;statement&nbsp;with&nbsp;the&nbsp;given&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="comment" id="5733084">//&nbsp;If&nbsp;an&nbsp;error&nbsp;occurs&nbsp;during&nbsp;the&nbsp;execution&nbsp;of&nbsp;the&nbsp;statement,&nbsp;that&nbsp;error&nbsp;will</span><br>
<span class="lineno"></span><span class="comment" id="5733161">//&nbsp;be&nbsp;returned&nbsp;by&nbsp;a&nbsp;call&nbsp;to&nbsp;Scan&nbsp;on&nbsp;the&nbsp;returned&nbsp;*Row,&nbsp;which&nbsp;is&nbsp;always&nbsp;non-nil.</span><br>
<span class="lineno">1500</span><span class="comment" id="5733241">//&nbsp;If&nbsp;the&nbsp;query&nbsp;selects&nbsp;no&nbsp;rows,&nbsp;the&nbsp;*Row&#39;s&nbsp;Scan&nbsp;will&nbsp;return&nbsp;ErrNoRows.</span><br>
<span class="lineno"></span><span class="comment" id="5733313">//&nbsp;Otherwise,&nbsp;the&nbsp;*Row&#39;s&nbsp;Scan&nbsp;scans&nbsp;the&nbsp;first&nbsp;selected&nbsp;row&nbsp;and&nbsp;discards</span><br>
<span class="lineno"></span><span class="comment" id="5733385">//&nbsp;the&nbsp;rest.</span><br>
<span class="lineno"></span><span class="comment" id="5733398">//</span><br>
<span class="lineno"></span><span class="comment" id="5733401">//&nbsp;Example&nbsp;usage:</span><br>
<span class="lineno">1505</span><span class="comment" id="5733419">//</span><br>
<span class="lineno"></span><span class="comment" id="5733422">//&nbsp;&nbsp;var&nbsp;name&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="5733442">//&nbsp;&nbsp;err&nbsp;:=&nbsp;nameByUseridStmt.QueryRow(id).Scan(&amp;name)</span><br>
<span class="lineno"></span><span class="keyword" id="5733495">func</span>&nbsp;<span class="op" id="5733500">(</span><span class="ident" id="5733501">s</span>&nbsp;<span class="op" id="5733503">*</span><span class="ident" id="5733504">Stmt</span><span class="op" id="5733508">)</span>&nbsp;<span class="ident" id="5733510">QueryRow</span><span class="op" id="5733518">(</span><span class="ident" id="5733519">args</span>&nbsp;<span class="op" id="5733524">...</span><span class="keyword" id="5733527">interface</span><span class="op" id="5733536">{</span><span class="op" id="5733537">}</span><span class="op" id="5733538">)</span>&nbsp;<span class="op" id="5733540">*</span><span class="ident" id="5733541">Row</span>&nbsp;<span class="op" id="5733545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5733548">rows</span><span class="op" id="5733552">,</span>&nbsp;<span class="ident" id="5733554">err</span>&nbsp;<span class="op" id="5733558">:=</span>&nbsp;<span class="ident" id="5733561">s</span><span class="op" id="5733562">.</span><span class="ident" id="5733563">Query</span><span class="op" id="5733568">(</span><span class="ident" id="5733569">args</span><span class="op" id="5733573">...</span><span class="op" id="5733576">)</span><br>
<span class="lineno">1510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5733579">if</span>&nbsp;<span class="ident" id="5733582">err</span>&nbsp;<span class="op" id="5733586">!=</span>&nbsp;<span class="ident" id="5733589">nil</span>&nbsp;<span class="op" id="5733593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5733597">return</span>&nbsp;<span class="op" id="5733604">&amp;</span><span class="ident" id="5733605">Row</span><span class="op" id="5733608">{</span><span class="ident" id="5733609">err</span><span class="op" id="5733612">:</span>&nbsp;<span class="ident" id="5733614">err</span><span class="op" id="5733617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5733620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5733623">return</span>&nbsp;<span class="op" id="5733630">&amp;</span><span class="ident" id="5733631">Row</span><span class="op" id="5733634">{</span><span class="ident" id="5733635">rows</span><span class="op" id="5733639">:</span>&nbsp;<span class="ident" id="5733641">rows</span><span class="op" id="5733645">}</span><br>
<span class="lineno"></span><span class="op" id="5733647">}</span><br>
<span class="lineno">1515</span><br>
<span class="lineno"></span><span class="comment" id="5733650">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5733681">func</span>&nbsp;<span class="op" id="5733686">(</span><span class="ident" id="5733687">s</span>&nbsp;<span class="op" id="5733689">*</span><span class="ident" id="5733690">Stmt</span><span class="op" id="5733694">)</span>&nbsp;<span class="ident" id="5733696">Close</span><span class="op" id="5733701">(</span><span class="op" id="5733702">)</span>&nbsp;<span class="builtintype" id="5733704">error</span>&nbsp;<span class="op" id="5733710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5733713">s</span><span class="op" id="5733714">.</span><span class="ident" id="5733715">closemu</span><span class="op" id="5733722">.</span><span class="ident" id="5733723">Lock</span><span class="op" id="5733727">(</span><span class="op" id="5733728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5733731">defer</span>&nbsp;<span class="ident" id="5733737">s</span><span class="op" id="5733738">.</span><span class="ident" id="5733739">closemu</span><span class="op" id="5733746">.</span><span class="ident" id="5733747">Unlock</span><span class="op" id="5733753">(</span><span class="op" id="5733754">)</span><br>
<span class="lineno">1520</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5733758">if</span>&nbsp;<span class="ident" id="5733761">s</span><span class="op" id="5733762">.</span><span class="ident" id="5733763">stickyErr</span>&nbsp;<span class="op" id="5733773">!=</span>&nbsp;<span class="ident" id="5733776">nil</span>&nbsp;<span class="op" id="5733780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5733784">return</span>&nbsp;<span class="ident" id="5733791">s</span><span class="op" id="5733792">.</span><span class="ident" id="5733793">stickyErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5733804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5733807">s</span><span class="op" id="5733808">.</span><span class="ident" id="5733809">mu</span><span class="op" id="5733811">.</span><span class="ident" id="5733812">Lock</span><span class="op" id="5733816">(</span><span class="op" id="5733817">)</span><br>
<span class="lineno">1525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5733820">if</span>&nbsp;<span class="ident" id="5733823">s</span><span class="op" id="5733824">.</span><span class="ident" id="5733825">closed</span>&nbsp;<span class="op" id="5733832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5733836">s</span><span class="op" id="5733837">.</span><span class="ident" id="5733838">mu</span><span class="op" id="5733840">.</span><span class="ident" id="5733841">Unlock</span><span class="op" id="5733847">(</span><span class="op" id="5733848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5733852">return</span>&nbsp;<span class="ident" id="5733859">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5733864">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5733867">s</span><span class="op" id="5733868">.</span><span class="ident" id="5733869">closed</span>&nbsp;<span class="op" id="5733876">=</span>&nbsp;<span class="builtintype" id="5733878">true</span><br>
<span class="lineno">1530</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5733885">if</span>&nbsp;<span class="ident" id="5733888">s</span><span class="op" id="5733889">.</span><span class="ident" id="5733890">tx</span>&nbsp;<span class="op" id="5733893">!=</span>&nbsp;<span class="ident" id="5733896">nil</span>&nbsp;<span class="op" id="5733900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5733904">s</span><span class="op" id="5733905">.</span><span class="ident" id="5733906">txsi</span><span class="op" id="5733910">.</span><span class="ident" id="5733911">Close</span><span class="op" id="5733916">(</span><span class="op" id="5733917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5733921">s</span><span class="op" id="5733922">.</span><span class="ident" id="5733923">mu</span><span class="op" id="5733925">.</span><span class="ident" id="5733926">Unlock</span><span class="op" id="5733932">(</span><span class="op" id="5733933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5733937">return</span>&nbsp;<span class="ident" id="5733944">nil</span><br>
<span class="lineno">1535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5733949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5733952">s</span><span class="op" id="5733953">.</span><span class="ident" id="5733954">mu</span><span class="op" id="5733956">.</span><span class="ident" id="5733957">Unlock</span><span class="op" id="5733963">(</span><span class="op" id="5733964">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5733968">return</span>&nbsp;<span class="ident" id="5733975">s</span><span class="op" id="5733976">.</span><span class="ident" id="5733977">db</span><span class="op" id="5733979">.</span><span class="ident" id="5733980">removeDep</span><span class="op" id="5733989">(</span><span class="ident" id="5733990">s</span><span class="op" id="5733991">,</span>&nbsp;<span class="ident" id="5733993">s</span><span class="op" id="5733994">)</span><br>
<span class="lineno"></span><span class="op" id="5733996">}</span><br>
<span class="lineno">1540</span><br>
<span class="lineno"></span><span class="keyword" id="5733999">func</span>&nbsp;<span class="op" id="5734004">(</span><span class="ident" id="5734005">s</span>&nbsp;<span class="op" id="5734007">*</span><span class="ident" id="5734008">Stmt</span><span class="op" id="5734012">)</span>&nbsp;<span class="ident" id="5734014">finalClose</span><span class="op" id="5734024">(</span><span class="op" id="5734025">)</span>&nbsp;<span class="builtintype" id="5734027">error</span>&nbsp;<span class="op" id="5734033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5734036">s</span><span class="op" id="5734037">.</span><span class="ident" id="5734038">mu</span><span class="op" id="5734040">.</span><span class="ident" id="5734041">Lock</span><span class="op" id="5734045">(</span><span class="op" id="5734046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5734049">defer</span>&nbsp;<span class="ident" id="5734055">s</span><span class="op" id="5734056">.</span><span class="ident" id="5734057">mu</span><span class="op" id="5734059">.</span><span class="ident" id="5734060">Unlock</span><span class="op" id="5734066">(</span><span class="op" id="5734067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5734070">if</span>&nbsp;<span class="ident" id="5734073">s</span><span class="op" id="5734074">.</span><span class="ident" id="5734075">css</span>&nbsp;<span class="op" id="5734079">!=</span>&nbsp;<span class="ident" id="5734082">nil</span>&nbsp;<span class="op" id="5734086">{</span><br>
<span class="lineno">1545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5734090">for</span>&nbsp;<span class="ident" id="5734094">_</span><span class="op" id="5734095">,</span>&nbsp;<span class="ident" id="5734097">v</span>&nbsp;<span class="op" id="5734099">:=</span>&nbsp;<span class="keyword" id="5734102">range</span>&nbsp;<span class="ident" id="5734108">s</span><span class="op" id="5734109">.</span><span class="ident" id="5734110">css</span>&nbsp;<span class="op" id="5734114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5734119">s</span><span class="op" id="5734120">.</span><span class="ident" id="5734121">db</span><span class="op" id="5734123">.</span><span class="ident" id="5734124">noteUnusedDriverStatement</span><span class="op" id="5734149">(</span><span class="ident" id="5734150">v</span><span class="op" id="5734151">.</span><span class="ident" id="5734152">dc</span><span class="op" id="5734154">,</span>&nbsp;<span class="ident" id="5734156">v</span><span class="op" id="5734157">.</span><span class="ident" id="5734158">si</span><span class="op" id="5734160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5734165">v</span><span class="op" id="5734166">.</span><span class="ident" id="5734167">dc</span><span class="op" id="5734169">.</span><span class="ident" id="5734170">removeOpenStmt</span><span class="op" id="5734184">(</span><span class="ident" id="5734185">v</span><span class="op" id="5734186">.</span><span class="ident" id="5734187">si</span><span class="op" id="5734189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5734193">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5734197">s</span><span class="op" id="5734198">.</span><span class="ident" id="5734199">css</span>&nbsp;<span class="op" id="5734203">=</span>&nbsp;<span class="ident" id="5734205">nil</span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5734210">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5734213">return</span>&nbsp;<span class="ident" id="5734220">nil</span><br>
<span class="lineno"></span><span class="op" id="5734224">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5734227">//&nbsp;Rows&nbsp;is&nbsp;the&nbsp;result&nbsp;of&nbsp;a&nbsp;query.&nbsp;Its&nbsp;cursor&nbsp;starts&nbsp;before&nbsp;the&nbsp;first&nbsp;row</span><br>
<span class="lineno">1555</span><span class="comment" id="5734300">//&nbsp;of&nbsp;the&nbsp;result&nbsp;set.&nbsp;Use&nbsp;Next&nbsp;to&nbsp;advance&nbsp;through&nbsp;the&nbsp;rows:</span><br>
<span class="lineno"></span><span class="comment" id="5734360">//</span><br>
<span class="lineno"></span><span class="comment" id="5734363">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rows,&nbsp;err&nbsp;:=&nbsp;db.Query(&#34;SELECT&nbsp;...&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="5734406">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="5734417">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defer&nbsp;rows.Close()</span><br>
<span class="lineno">1560</span><span class="comment" id="5734443">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;rows.Next()&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="5734468">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;id&nbsp;int</span><br>
<span class="lineno"></span><span class="comment" id="5734490">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;name&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="5734517">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;rows.Scan(&amp;id,&nbsp;&amp;name)</span><br>
<span class="lineno"></span><span class="comment" id="5734556">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br>
<span class="lineno">1565</span><span class="comment" id="5734571">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="5734580">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;rows.Err()&nbsp;//&nbsp;get&nbsp;any&nbsp;error&nbsp;encountered&nbsp;during&nbsp;iteration</span><br>
<span class="lineno"></span><span class="comment" id="5734650">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="keyword" id="5734661">type</span>&nbsp;<span class="ident" id="5734666">Rows</span>&nbsp;<span class="keyword" id="5734671">struct</span>&nbsp;<span class="op" id="5734678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5734681">dc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5734693">*</span><span class="ident" id="5734694">driverConn</span>&nbsp;<span class="comment" id="5734705">//&nbsp;owned;&nbsp;must&nbsp;call&nbsp;releaseConn&nbsp;when&nbsp;closed&nbsp;to&nbsp;release</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5734761">releaseConn</span>&nbsp;<span class="keyword" id="5734773">func</span><span class="op" id="5734777">(</span><span class="builtintype" id="5734778">error</span><span class="op" id="5734783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5734786">rowsi</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5734798">driver</span><span class="op" id="5734804">.</span><span class="ident" id="5734805">Rows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5734812">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5734822">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5734828">lastcols</span>&nbsp;&nbsp;<span class="op" id="5734838">[</span><span class="op" id="5734839">]</span><span class="ident" id="5734840">driver</span><span class="op" id="5734846">.</span><span class="ident" id="5734847">Value</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5734854">lasterr</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5734864">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5734876">//&nbsp;non-nil&nbsp;only&nbsp;if&nbsp;closed&nbsp;is&nbsp;true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5734911">closeStmt</span>&nbsp;<span class="ident" id="5734921">driver</span><span class="op" id="5734927">.</span><span class="ident" id="5734928">Stmt</span>&nbsp;<span class="comment" id="5734933">//&nbsp;if&nbsp;non-nil,&nbsp;statement&nbsp;to&nbsp;Close&nbsp;on&nbsp;close</span><br>
<span class="lineno"></span><span class="op" id="5734976">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5734979">//&nbsp;Next&nbsp;prepares&nbsp;the&nbsp;next&nbsp;result&nbsp;row&nbsp;for&nbsp;reading&nbsp;with&nbsp;the&nbsp;Scan&nbsp;method.&nbsp;&nbsp;It</span><br>
<span class="lineno">1580</span><span class="comment" id="5735054">//&nbsp;returns&nbsp;true&nbsp;on&nbsp;success,&nbsp;or&nbsp;false&nbsp;if&nbsp;there&nbsp;is&nbsp;no&nbsp;next&nbsp;result&nbsp;row&nbsp;or&nbsp;an&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="5735134">//&nbsp;happened&nbsp;while&nbsp;preparing&nbsp;it.&nbsp;&nbsp;Err&nbsp;should&nbsp;be&nbsp;consulted&nbsp;to&nbsp;distinguish&nbsp;between</span><br>
<span class="lineno"></span><span class="comment" id="5735214">//&nbsp;the&nbsp;two&nbsp;cases.</span><br>
<span class="lineno"></span><span class="comment" id="5735232">//</span><br>
<span class="lineno"></span><span class="comment" id="5735235">//&nbsp;Every&nbsp;call&nbsp;to&nbsp;Scan,&nbsp;even&nbsp;the&nbsp;first&nbsp;one,&nbsp;must&nbsp;be&nbsp;preceded&nbsp;by&nbsp;a&nbsp;call&nbsp;to&nbsp;Next.</span><br>
<span class="lineno">1585</span><span class="keyword" id="5735314">func</span>&nbsp;<span class="op" id="5735319">(</span><span class="ident" id="5735320">rs</span>&nbsp;<span class="op" id="5735323">*</span><span class="ident" id="5735324">Rows</span><span class="op" id="5735328">)</span>&nbsp;<span class="ident" id="5735330">Next</span><span class="op" id="5735334">(</span><span class="op" id="5735335">)</span>&nbsp;<span class="builtintype" id="5735337">bool</span>&nbsp;<span class="op" id="5735342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5735345">if</span>&nbsp;<span class="ident" id="5735348">rs</span><span class="op" id="5735350">.</span><span class="ident" id="5735351">closed</span>&nbsp;<span class="op" id="5735358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5735362">return</span>&nbsp;<span class="builtintype" id="5735369">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5735376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5735379">if</span>&nbsp;<span class="ident" id="5735382">rs</span><span class="op" id="5735384">.</span><span class="ident" id="5735385">lastcols</span>&nbsp;<span class="op" id="5735394">==</span>&nbsp;<span class="ident" id="5735397">nil</span>&nbsp;<span class="op" id="5735401">{</span><br>
<span class="lineno">1590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5735405">rs</span><span class="op" id="5735407">.</span><span class="ident" id="5735408">lastcols</span>&nbsp;<span class="op" id="5735417">=</span>&nbsp;<span class="builtinfunc" id="5735419">make</span><span class="op" id="5735423">(</span><span class="op" id="5735424">[</span><span class="op" id="5735425">]</span><span class="ident" id="5735426">driver</span><span class="op" id="5735432">.</span><span class="ident" id="5735433">Value</span><span class="op" id="5735438">,</span>&nbsp;<span class="builtinfunc" id="5735440">len</span><span class="op" id="5735443">(</span><span class="ident" id="5735444">rs</span><span class="op" id="5735446">.</span><span class="ident" id="5735447">rowsi</span><span class="op" id="5735452">.</span><span class="ident" id="5735453">Columns</span><span class="op" id="5735460">(</span><span class="op" id="5735461">)</span><span class="op" id="5735462">)</span><span class="op" id="5735463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5735466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5735469">rs</span><span class="op" id="5735471">.</span><span class="ident" id="5735472">lasterr</span>&nbsp;<span class="op" id="5735480">=</span>&nbsp;<span class="ident" id="5735482">rs</span><span class="op" id="5735484">.</span><span class="ident" id="5735485">rowsi</span><span class="op" id="5735490">.</span><span class="ident" id="5735491">Next</span><span class="op" id="5735495">(</span><span class="ident" id="5735496">rs</span><span class="op" id="5735498">.</span><span class="ident" id="5735499">lastcols</span><span class="op" id="5735507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5735510">if</span>&nbsp;<span class="ident" id="5735513">rs</span><span class="op" id="5735515">.</span><span class="ident" id="5735516">lasterr</span>&nbsp;<span class="op" id="5735524">!=</span>&nbsp;<span class="ident" id="5735527">nil</span>&nbsp;<span class="op" id="5735531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5735535">rs</span><span class="op" id="5735537">.</span><span class="ident" id="5735538">Close</span><span class="op" id="5735543">(</span><span class="op" id="5735544">)</span><br>
<span class="lineno">1595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5735548">return</span>&nbsp;<span class="builtintype" id="5735555">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5735562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5735565">return</span>&nbsp;<span class="builtintype" id="5735572">true</span><br>
<span class="lineno"></span><span class="op" id="5735577">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1600</span><span class="comment" id="5735580">//&nbsp;Err&nbsp;returns&nbsp;the&nbsp;error,&nbsp;if&nbsp;any,&nbsp;that&nbsp;was&nbsp;encountered&nbsp;during&nbsp;iteration.</span><br>
<span class="lineno"></span><span class="comment" id="5735653">//&nbsp;Err&nbsp;may&nbsp;be&nbsp;called&nbsp;after&nbsp;an&nbsp;explicit&nbsp;or&nbsp;implicit&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="5735711">func</span>&nbsp;<span class="op" id="5735716">(</span><span class="ident" id="5735717">rs</span>&nbsp;<span class="op" id="5735720">*</span><span class="ident" id="5735721">Rows</span><span class="op" id="5735725">)</span>&nbsp;<span class="ident" id="5735727">Err</span><span class="op" id="5735730">(</span><span class="op" id="5735731">)</span>&nbsp;<span class="builtintype" id="5735733">error</span>&nbsp;<span class="op" id="5735739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5735742">if</span>&nbsp;<span class="ident" id="5735745">rs</span><span class="op" id="5735747">.</span><span class="ident" id="5735748">lasterr</span>&nbsp;<span class="op" id="5735756">==</span>&nbsp;<span class="ident" id="5735759">io</span><span class="op" id="5735761">.</span><span class="ident" id="5735762">EOF</span>&nbsp;<span class="op" id="5735766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5735770">return</span>&nbsp;<span class="ident" id="5735777">nil</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5735782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5735785">return</span>&nbsp;<span class="ident" id="5735792">rs</span><span class="op" id="5735794">.</span><span class="ident" id="5735795">lasterr</span><br>
<span class="lineno"></span><span class="op" id="5735803">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5735806">//&nbsp;Columns&nbsp;returns&nbsp;the&nbsp;column&nbsp;names.</span><br>
<span class="lineno">1610</span><span class="comment" id="5735843">//&nbsp;Columns&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;rows&nbsp;are&nbsp;closed,&nbsp;or&nbsp;if&nbsp;the&nbsp;rows</span><br>
<span class="lineno"></span><span class="comment" id="5735910">//&nbsp;are&nbsp;from&nbsp;QueryRow&nbsp;and&nbsp;there&nbsp;was&nbsp;a&nbsp;deferred&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="5735963">func</span>&nbsp;<span class="op" id="5735968">(</span><span class="ident" id="5735969">rs</span>&nbsp;<span class="op" id="5735972">*</span><span class="ident" id="5735973">Rows</span><span class="op" id="5735977">)</span>&nbsp;<span class="ident" id="5735979">Columns</span><span class="op" id="5735986">(</span><span class="op" id="5735987">)</span>&nbsp;<span class="op" id="5735989">(</span><span class="op" id="5735990">[</span><span class="op" id="5735991">]</span><span class="builtintype" id="5735992">string</span><span class="op" id="5735998">,</span>&nbsp;<span class="builtintype" id="5736000">error</span><span class="op" id="5736005">)</span>&nbsp;<span class="op" id="5736007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5736010">if</span>&nbsp;<span class="ident" id="5736013">rs</span><span class="op" id="5736015">.</span><span class="ident" id="5736016">closed</span>&nbsp;<span class="op" id="5736023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5736027">return</span>&nbsp;<span class="ident" id="5736034">nil</span><span class="op" id="5736037">,</span>&nbsp;<span class="ident" id="5736039">errors</span><span class="op" id="5736045">.</span><span class="ident" id="5736046">New</span><span class="op" id="5736049">(</span><span class="string" id="5736050">&#34;sql:&nbsp;Rows&nbsp;are&nbsp;closed&#34;</span><span class="op" id="5736072">)</span><br>
<span class="lineno">1615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5736075">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5736078">if</span>&nbsp;<span class="ident" id="5736081">rs</span><span class="op" id="5736083">.</span><span class="ident" id="5736084">rowsi</span>&nbsp;<span class="op" id="5736090">==</span>&nbsp;<span class="ident" id="5736093">nil</span>&nbsp;<span class="op" id="5736097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5736101">return</span>&nbsp;<span class="ident" id="5736108">nil</span><span class="op" id="5736111">,</span>&nbsp;<span class="ident" id="5736113">errors</span><span class="op" id="5736119">.</span><span class="ident" id="5736120">New</span><span class="op" id="5736123">(</span><span class="string" id="5736124">&#34;sql:&nbsp;no&nbsp;Rows&nbsp;available&#34;</span><span class="op" id="5736148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5736151">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5736154">return</span>&nbsp;<span class="ident" id="5736161">rs</span><span class="op" id="5736163">.</span><span class="ident" id="5736164">rowsi</span><span class="op" id="5736169">.</span><span class="ident" id="5736170">Columns</span><span class="op" id="5736177">(</span><span class="op" id="5736178">)</span><span class="op" id="5736179">,</span>&nbsp;<span class="ident" id="5736181">nil</span><br>
<span class="lineno">1620</span><span class="op" id="5736185">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5736188">//&nbsp;Scan&nbsp;copies&nbsp;the&nbsp;columns&nbsp;in&nbsp;the&nbsp;current&nbsp;row&nbsp;into&nbsp;the&nbsp;values&nbsp;pointed</span><br>
<span class="lineno"></span><span class="comment" id="5736258">//&nbsp;at&nbsp;by&nbsp;dest.</span><br>
<span class="lineno"></span><span class="comment" id="5736273">//</span><br>
<span class="lineno">1625</span><span class="comment" id="5736276">//&nbsp;If&nbsp;an&nbsp;argument&nbsp;has&nbsp;type&nbsp;*[]byte,&nbsp;Scan&nbsp;saves&nbsp;in&nbsp;that&nbsp;argument&nbsp;a&nbsp;copy</span><br>
<span class="lineno"></span><span class="comment" id="5736347">//&nbsp;of&nbsp;the&nbsp;corresponding&nbsp;data.&nbsp;The&nbsp;copy&nbsp;is&nbsp;owned&nbsp;by&nbsp;the&nbsp;caller&nbsp;and&nbsp;can</span><br>
<span class="lineno"></span><span class="comment" id="5736417">//&nbsp;be&nbsp;modified&nbsp;and&nbsp;held&nbsp;indefinitely.&nbsp;The&nbsp;copy&nbsp;can&nbsp;be&nbsp;avoided&nbsp;by&nbsp;using</span><br>
<span class="lineno"></span><span class="comment" id="5736488">//&nbsp;an&nbsp;argument&nbsp;of&nbsp;type&nbsp;*RawBytes&nbsp;instead;&nbsp;see&nbsp;the&nbsp;documentation&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="5736556">//&nbsp;RawBytes&nbsp;for&nbsp;restrictions&nbsp;on&nbsp;its&nbsp;use.</span><br>
<span class="lineno">1630</span><span class="comment" id="5736597">//</span><br>
<span class="lineno"></span><span class="comment" id="5736600">//&nbsp;If&nbsp;an&nbsp;argument&nbsp;has&nbsp;type&nbsp;*interface{},&nbsp;Scan&nbsp;copies&nbsp;the&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="5736663">//&nbsp;provided&nbsp;by&nbsp;the&nbsp;underlying&nbsp;driver&nbsp;without&nbsp;conversion.&nbsp;If&nbsp;the&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="5736733">//&nbsp;is&nbsp;of&nbsp;type&nbsp;[]byte,&nbsp;a&nbsp;copy&nbsp;is&nbsp;made&nbsp;and&nbsp;the&nbsp;caller&nbsp;owns&nbsp;the&nbsp;result.</span><br>
<span class="lineno"></span><span class="keyword" id="5736802">func</span>&nbsp;<span class="op" id="5736807">(</span><span class="ident" id="5736808">rs</span>&nbsp;<span class="op" id="5736811">*</span><span class="ident" id="5736812">Rows</span><span class="op" id="5736816">)</span>&nbsp;<span class="ident" id="5736818">Scan</span><span class="op" id="5736822">(</span><span class="ident" id="5736823">dest</span>&nbsp;<span class="op" id="5736828">...</span><span class="keyword" id="5736831">interface</span><span class="op" id="5736840">{</span><span class="op" id="5736841">}</span><span class="op" id="5736842">)</span>&nbsp;<span class="builtintype" id="5736844">error</span>&nbsp;<span class="op" id="5736850">{</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5736853">if</span>&nbsp;<span class="ident" id="5736856">rs</span><span class="op" id="5736858">.</span><span class="ident" id="5736859">closed</span>&nbsp;<span class="op" id="5736866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5736870">return</span>&nbsp;<span class="ident" id="5736877">errors</span><span class="op" id="5736883">.</span><span class="ident" id="5736884">New</span><span class="op" id="5736887">(</span><span class="string" id="5736888">&#34;sql:&nbsp;Rows&nbsp;are&nbsp;closed&#34;</span><span class="op" id="5736910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5736913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5736916">if</span>&nbsp;<span class="ident" id="5736919">rs</span><span class="op" id="5736921">.</span><span class="ident" id="5736922">lastcols</span>&nbsp;<span class="op" id="5736931">==</span>&nbsp;<span class="ident" id="5736934">nil</span>&nbsp;<span class="op" id="5736938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5736942">return</span>&nbsp;<span class="ident" id="5736949">errors</span><span class="op" id="5736955">.</span><span class="ident" id="5736956">New</span><span class="op" id="5736959">(</span><span class="string" id="5736960">&#34;sql:&nbsp;Scan&nbsp;called&nbsp;without&nbsp;calling&nbsp;Next&#34;</span><span class="op" id="5736999">)</span><br>
<span class="lineno">1640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5737002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5737005">if</span>&nbsp;<span class="builtinfunc" id="5737008">len</span><span class="op" id="5737011">(</span><span class="ident" id="5737012">dest</span><span class="op" id="5737016">)</span>&nbsp;<span class="op" id="5737018">!=</span>&nbsp;<span class="builtinfunc" id="5737021">len</span><span class="op" id="5737024">(</span><span class="ident" id="5737025">rs</span><span class="op" id="5737027">.</span><span class="ident" id="5737028">lastcols</span><span class="op" id="5737036">)</span>&nbsp;<span class="op" id="5737038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5737042">return</span>&nbsp;<span class="ident" id="5737049">fmt</span><span class="op" id="5737052">.</span><span class="ident" id="5737053">Errorf</span><span class="op" id="5737059">(</span><span class="string" id="5737060">&#34;sql:&nbsp;expected&nbsp;%d&nbsp;destination&nbsp;arguments&nbsp;in&nbsp;Scan,&nbsp;not&nbsp;%d&#34;</span><span class="op" id="5737116">,</span>&nbsp;<span class="builtinfunc" id="5737118">len</span><span class="op" id="5737121">(</span><span class="ident" id="5737122">rs</span><span class="op" id="5737124">.</span><span class="ident" id="5737125">lastcols</span><span class="op" id="5737133">)</span><span class="op" id="5737134">,</span>&nbsp;<span class="builtinfunc" id="5737136">len</span><span class="op" id="5737139">(</span><span class="ident" id="5737140">dest</span><span class="op" id="5737144">)</span><span class="op" id="5737145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5737148">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5737151">for</span>&nbsp;<span class="ident" id="5737155">i</span><span class="op" id="5737156">,</span>&nbsp;<span class="ident" id="5737158">sv</span>&nbsp;<span class="op" id="5737161">:=</span>&nbsp;<span class="keyword" id="5737164">range</span>&nbsp;<span class="ident" id="5737170">rs</span><span class="op" id="5737172">.</span><span class="ident" id="5737173">lastcols</span>&nbsp;<span class="op" id="5737182">{</span><br>
<span class="lineno">1645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5737186">err</span>&nbsp;<span class="op" id="5737190">:=</span>&nbsp;<span class="ident" id="5737193">convertAssign</span><span class="op" id="5737206">(</span><span class="ident" id="5737207">dest</span><span class="op" id="5737211">[</span><span class="ident" id="5737212">i</span><span class="op" id="5737213">]</span><span class="op" id="5737214">,</span>&nbsp;<span class="ident" id="5737216">sv</span><span class="op" id="5737218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5737222">if</span>&nbsp;<span class="ident" id="5737225">err</span>&nbsp;<span class="op" id="5737229">!=</span>&nbsp;<span class="ident" id="5737232">nil</span>&nbsp;<span class="op" id="5737236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5737241">return</span>&nbsp;<span class="ident" id="5737248">fmt</span><span class="op" id="5737251">.</span><span class="ident" id="5737252">Errorf</span><span class="op" id="5737258">(</span><span class="string" id="5737259">&#34;sql:&nbsp;Scan&nbsp;error&nbsp;on&nbsp;column&nbsp;index&nbsp;%d:&nbsp;%v&#34;</span><span class="op" id="5737299">,</span>&nbsp;<span class="ident" id="5737301">i</span><span class="op" id="5737302">,</span>&nbsp;<span class="ident" id="5737304">err</span><span class="op" id="5737307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5737311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5737314">}</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5737317">return</span>&nbsp;<span class="ident" id="5737324">nil</span><br>
<span class="lineno"></span><span class="op" id="5737328">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5737331">var</span>&nbsp;<span class="ident" id="5737335">rowsCloseHook</span>&nbsp;<span class="keyword" id="5737349">func</span><span class="op" id="5737353">(</span><span class="op" id="5737354">*</span><span class="ident" id="5737355">Rows</span><span class="op" id="5737359">,</span>&nbsp;<span class="op" id="5737361">*</span><span class="builtintype" id="5737362">error</span><span class="op" id="5737367">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1655</span><span class="comment" id="5737370">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;Rows,&nbsp;preventing&nbsp;further&nbsp;enumeration.&nbsp;If&nbsp;Next&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="5737444">//&nbsp;false,&nbsp;the&nbsp;Rows&nbsp;are&nbsp;closed&nbsp;automatically&nbsp;and&nbsp;it&nbsp;will&nbsp;suffice&nbsp;to&nbsp;check&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5737521">//&nbsp;result&nbsp;of&nbsp;Err.&nbsp;Close&nbsp;is&nbsp;idempotent&nbsp;and&nbsp;does&nbsp;not&nbsp;affect&nbsp;the&nbsp;result&nbsp;of&nbsp;Err.</span><br>
<span class="lineno"></span><span class="keyword" id="5737598">func</span>&nbsp;<span class="op" id="5737603">(</span><span class="ident" id="5737604">rs</span>&nbsp;<span class="op" id="5737607">*</span><span class="ident" id="5737608">Rows</span><span class="op" id="5737612">)</span>&nbsp;<span class="ident" id="5737614">Close</span><span class="op" id="5737619">(</span><span class="op" id="5737620">)</span>&nbsp;<span class="builtintype" id="5737622">error</span>&nbsp;<span class="op" id="5737628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5737631">if</span>&nbsp;<span class="ident" id="5737634">rs</span><span class="op" id="5737636">.</span><span class="ident" id="5737637">closed</span>&nbsp;<span class="op" id="5737644">{</span><br>
<span class="lineno">1660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5737648">return</span>&nbsp;<span class="ident" id="5737655">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5737660">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5737663">rs</span><span class="op" id="5737665">.</span><span class="ident" id="5737666">closed</span>&nbsp;<span class="op" id="5737673">=</span>&nbsp;<span class="builtintype" id="5737675">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5737681">err</span>&nbsp;<span class="op" id="5737685">:=</span>&nbsp;<span class="ident" id="5737688">rs</span><span class="op" id="5737690">.</span><span class="ident" id="5737691">rowsi</span><span class="op" id="5737696">.</span><span class="ident" id="5737697">Close</span><span class="op" id="5737702">(</span><span class="op" id="5737703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5737706">if</span>&nbsp;<span class="ident" id="5737709">fn</span>&nbsp;<span class="op" id="5737712">:=</span>&nbsp;<span class="ident" id="5737715">rowsCloseHook</span><span class="op" id="5737728">;</span>&nbsp;<span class="ident" id="5737730">fn</span>&nbsp;<span class="op" id="5737733">!=</span>&nbsp;<span class="ident" id="5737736">nil</span>&nbsp;<span class="op" id="5737740">{</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5737744">fn</span><span class="op" id="5737746">(</span><span class="ident" id="5737747">rs</span><span class="op" id="5737749">,</span>&nbsp;<span class="op" id="5737751">&amp;</span><span class="ident" id="5737752">err</span><span class="op" id="5737755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5737758">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5737761">if</span>&nbsp;<span class="ident" id="5737764">rs</span><span class="op" id="5737766">.</span><span class="ident" id="5737767">closeStmt</span>&nbsp;<span class="op" id="5737777">!=</span>&nbsp;<span class="ident" id="5737780">nil</span>&nbsp;<span class="op" id="5737784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5737788">rs</span><span class="op" id="5737790">.</span><span class="ident" id="5737791">closeStmt</span><span class="op" id="5737800">.</span><span class="ident" id="5737801">Close</span><span class="op" id="5737806">(</span><span class="op" id="5737807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5737810">}</span><br>
<span class="lineno">1670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5737813">rs</span><span class="op" id="5737815">.</span><span class="ident" id="5737816">releaseConn</span><span class="op" id="5737827">(</span><span class="ident" id="5737828">err</span><span class="op" id="5737831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5737834">return</span>&nbsp;<span class="ident" id="5737841">err</span><br>
<span class="lineno"></span><span class="op" id="5737845">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5737848">//&nbsp;Row&nbsp;is&nbsp;the&nbsp;result&nbsp;of&nbsp;calling&nbsp;QueryRow&nbsp;to&nbsp;select&nbsp;a&nbsp;single&nbsp;row.</span><br>
<span class="lineno">1675</span><span class="keyword" id="5737913">type</span>&nbsp;<span class="ident" id="5737918">Row</span>&nbsp;<span class="keyword" id="5737922">struct</span>&nbsp;<span class="op" id="5737929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5737932">//&nbsp;One&nbsp;of&nbsp;these&nbsp;two&nbsp;will&nbsp;be&nbsp;non-nil:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5737970">err</span>&nbsp;&nbsp;<span class="builtintype" id="5737975">error</span>&nbsp;<span class="comment" id="5737981">//&nbsp;deferred&nbsp;error&nbsp;for&nbsp;easy&nbsp;chaining</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5738018">rows</span>&nbsp;<span class="op" id="5738023">*</span><span class="ident" id="5738024">Rows</span><br>
<span class="lineno"></span><span class="op" id="5738029">}</span><br>
<span class="lineno">1680</span><br>
<span class="lineno"></span><span class="comment" id="5738032">//&nbsp;Scan&nbsp;copies&nbsp;the&nbsp;columns&nbsp;from&nbsp;the&nbsp;matched&nbsp;row&nbsp;into&nbsp;the&nbsp;values</span><br>
<span class="lineno"></span><span class="comment" id="5738096">//&nbsp;pointed&nbsp;at&nbsp;by&nbsp;dest.&nbsp;&nbsp;If&nbsp;more&nbsp;than&nbsp;one&nbsp;row&nbsp;matches&nbsp;the&nbsp;query,</span><br>
<span class="lineno"></span><span class="comment" id="5738160">//&nbsp;Scan&nbsp;uses&nbsp;the&nbsp;first&nbsp;row&nbsp;and&nbsp;discards&nbsp;the&nbsp;rest.&nbsp;&nbsp;If&nbsp;no&nbsp;row&nbsp;matches</span><br>
<span class="lineno"></span><span class="comment" id="5738229">//&nbsp;the&nbsp;query,&nbsp;Scan&nbsp;returns&nbsp;ErrNoRows.</span><br>
<span class="lineno">1685</span><span class="keyword" id="5738267">func</span>&nbsp;<span class="op" id="5738272">(</span><span class="ident" id="5738273">r</span>&nbsp;<span class="op" id="5738275">*</span><span class="ident" id="5738276">Row</span><span class="op" id="5738279">)</span>&nbsp;<span class="ident" id="5738281">Scan</span><span class="op" id="5738285">(</span><span class="ident" id="5738286">dest</span>&nbsp;<span class="op" id="5738291">...</span><span class="keyword" id="5738294">interface</span><span class="op" id="5738303">{</span><span class="op" id="5738304">}</span><span class="op" id="5738305">)</span>&nbsp;<span class="builtintype" id="5738307">error</span>&nbsp;<span class="op" id="5738313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5738316">if</span>&nbsp;<span class="ident" id="5738319">r</span><span class="op" id="5738320">.</span><span class="ident" id="5738321">err</span>&nbsp;<span class="op" id="5738325">!=</span>&nbsp;<span class="ident" id="5738328">nil</span>&nbsp;<span class="op" id="5738332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5738336">return</span>&nbsp;<span class="ident" id="5738343">r</span><span class="op" id="5738344">.</span><span class="ident" id="5738345">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5738350">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5738354">//&nbsp;TODO(bradfitz):&nbsp;for&nbsp;now&nbsp;we&nbsp;need&nbsp;to&nbsp;defensively&nbsp;clone&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5738415">//&nbsp;[]byte&nbsp;that&nbsp;the&nbsp;driver&nbsp;returned&nbsp;(not&nbsp;permitting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5738467">//&nbsp;*RawBytes&nbsp;in&nbsp;Rows.Scan),&nbsp;since&nbsp;we&#39;re&nbsp;about&nbsp;to&nbsp;close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5738523">//&nbsp;the&nbsp;Rows&nbsp;in&nbsp;our&nbsp;defer,&nbsp;when&nbsp;we&nbsp;return&nbsp;from&nbsp;this&nbsp;function.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5738585">//&nbsp;the&nbsp;contract&nbsp;with&nbsp;the&nbsp;driver.Next(...)&nbsp;interface&nbsp;is&nbsp;that&nbsp;it</span><br>
<span class="lineno">1695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5738649">//&nbsp;can&nbsp;return&nbsp;slices&nbsp;into&nbsp;read-only&nbsp;temporary&nbsp;memory&nbsp;that&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5738710">//&nbsp;only&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;Scan/Close.&nbsp;&nbsp;But&nbsp;the&nbsp;TODO&nbsp;is&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5738774">//&nbsp;for&nbsp;a&nbsp;lot&nbsp;of&nbsp;drivers,&nbsp;this&nbsp;copy&nbsp;will&nbsp;be&nbsp;unnecessary.&nbsp;&nbsp;We</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5738835">//&nbsp;should&nbsp;provide&nbsp;an&nbsp;optional&nbsp;interface&nbsp;for&nbsp;drivers&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5738891">//&nbsp;implement&nbsp;to&nbsp;say,&nbsp;&#34;don&#39;t&nbsp;worry,&nbsp;the&nbsp;[]bytes&nbsp;that&nbsp;I&nbsp;return</span><br>
<span class="lineno">1700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5738953">//&nbsp;from&nbsp;Next&nbsp;will&nbsp;not&nbsp;be&nbsp;modified&nbsp;again.&#34;&nbsp;(for&nbsp;instance,&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5739014">//&nbsp;they&nbsp;were&nbsp;obtained&nbsp;from&nbsp;the&nbsp;network&nbsp;anyway)&nbsp;But&nbsp;for&nbsp;now&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5739077">//&nbsp;don&#39;t&nbsp;care.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5739093">defer</span>&nbsp;<span class="ident" id="5739099">r</span><span class="op" id="5739100">.</span><span class="ident" id="5739101">rows</span><span class="op" id="5739105">.</span><span class="ident" id="5739106">Close</span><span class="op" id="5739111">(</span><span class="op" id="5739112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5739115">for</span>&nbsp;<span class="ident" id="5739119">_</span><span class="op" id="5739120">,</span>&nbsp;<span class="ident" id="5739122">dp</span>&nbsp;<span class="op" id="5739125">:=</span>&nbsp;<span class="keyword" id="5739128">range</span>&nbsp;<span class="ident" id="5739134">dest</span>&nbsp;<span class="op" id="5739139">{</span><br>
<span class="lineno">1705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5739143">if</span>&nbsp;<span class="ident" id="5739146">_</span><span class="op" id="5739147">,</span>&nbsp;<span class="ident" id="5739149">ok</span>&nbsp;<span class="op" id="5739152">:=</span>&nbsp;<span class="ident" id="5739155">dp</span><span class="op" id="5739157">.</span><span class="op" id="5739158">(</span><span class="op" id="5739159">*</span><span class="ident" id="5739160">RawBytes</span><span class="op" id="5739168">)</span><span class="op" id="5739169">;</span>&nbsp;<span class="ident" id="5739171">ok</span>&nbsp;<span class="op" id="5739174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5739179">return</span>&nbsp;<span class="ident" id="5739186">errors</span><span class="op" id="5739192">.</span><span class="ident" id="5739193">New</span><span class="op" id="5739196">(</span><span class="string" id="5739197">&#34;sql:&nbsp;RawBytes&nbsp;isn&#39;t&nbsp;allowed&nbsp;on&nbsp;Row.Scan&#34;</span><span class="op" id="5739238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5739242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5739245">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5739249">if</span>&nbsp;<span class="op" id="5739252">!</span><span class="ident" id="5739253">r</span><span class="op" id="5739254">.</span><span class="ident" id="5739255">rows</span><span class="op" id="5739259">.</span><span class="ident" id="5739260">Next</span><span class="op" id="5739264">(</span><span class="op" id="5739265">)</span>&nbsp;<span class="op" id="5739267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5739271">if</span>&nbsp;<span class="ident" id="5739274">err</span>&nbsp;<span class="op" id="5739278">:=</span>&nbsp;<span class="ident" id="5739281">r</span><span class="op" id="5739282">.</span><span class="ident" id="5739283">rows</span><span class="op" id="5739287">.</span><span class="ident" id="5739288">Err</span><span class="op" id="5739291">(</span><span class="op" id="5739292">)</span><span class="op" id="5739293">;</span>&nbsp;<span class="ident" id="5739295">err</span>&nbsp;<span class="op" id="5739299">!=</span>&nbsp;<span class="ident" id="5739302">nil</span>&nbsp;<span class="op" id="5739306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5739311">return</span>&nbsp;<span class="ident" id="5739318">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5739324">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5739328">return</span>&nbsp;<span class="ident" id="5739335">ErrNoRows</span><br>
<span class="lineno">1715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5739346">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5739349">err</span>&nbsp;<span class="op" id="5739353">:=</span>&nbsp;<span class="ident" id="5739356">r</span><span class="op" id="5739357">.</span><span class="ident" id="5739358">rows</span><span class="op" id="5739362">.</span><span class="ident" id="5739363">Scan</span><span class="op" id="5739367">(</span><span class="ident" id="5739368">dest</span><span class="op" id="5739372">...</span><span class="op" id="5739375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5739378">if</span>&nbsp;<span class="ident" id="5739381">err</span>&nbsp;<span class="op" id="5739385">!=</span>&nbsp;<span class="ident" id="5739388">nil</span>&nbsp;<span class="op" id="5739392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5739396">return</span>&nbsp;<span class="ident" id="5739403">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5739408">}</span><br>
<span class="lineno">1720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5739411">//&nbsp;Make&nbsp;sure&nbsp;the&nbsp;query&nbsp;can&nbsp;be&nbsp;processed&nbsp;to&nbsp;completion&nbsp;with&nbsp;no&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5739482">if</span>&nbsp;<span class="ident" id="5739485">err</span>&nbsp;<span class="op" id="5739489">:=</span>&nbsp;<span class="ident" id="5739492">r</span><span class="op" id="5739493">.</span><span class="ident" id="5739494">rows</span><span class="op" id="5739498">.</span><span class="ident" id="5739499">Close</span><span class="op" id="5739504">(</span><span class="op" id="5739505">)</span><span class="op" id="5739506">;</span>&nbsp;<span class="ident" id="5739508">err</span>&nbsp;<span class="op" id="5739512">!=</span>&nbsp;<span class="ident" id="5739515">nil</span>&nbsp;<span class="op" id="5739519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5739523">return</span>&nbsp;<span class="ident" id="5739530">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5739535">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5739539">return</span>&nbsp;<span class="ident" id="5739546">nil</span><br>
<span class="lineno"></span><span class="op" id="5739550">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5739553">//&nbsp;A&nbsp;Result&nbsp;summarizes&nbsp;an&nbsp;executed&nbsp;SQL&nbsp;command.</span><br>
<span class="lineno"></span><span class="keyword" id="5739601">type</span>&nbsp;<span class="ident" id="5739606">Result</span>&nbsp;<span class="keyword" id="5739613">interface</span>&nbsp;<span class="op" id="5739623">{</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5739626">//&nbsp;LastInsertId&nbsp;returns&nbsp;the&nbsp;integer&nbsp;generated&nbsp;by&nbsp;the&nbsp;database</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5739689">//&nbsp;in&nbsp;response&nbsp;to&nbsp;a&nbsp;command.&nbsp;Typically&nbsp;this&nbsp;will&nbsp;be&nbsp;from&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5739750">//&nbsp;&#34;auto&nbsp;increment&#34;&nbsp;column&nbsp;when&nbsp;inserting&nbsp;a&nbsp;new&nbsp;row.&nbsp;Not&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5739812">//&nbsp;databases&nbsp;support&nbsp;this&nbsp;feature,&nbsp;and&nbsp;the&nbsp;syntax&nbsp;of&nbsp;such</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5739871">//&nbsp;statements&nbsp;varies.</span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5739894">LastInsertId</span><span class="op" id="5739906">(</span><span class="op" id="5739907">)</span>&nbsp;<span class="op" id="5739909">(</span><span class="ident" id="5739910">int64</span><span class="op" id="5739915">,</span>&nbsp;<span class="builtintype" id="5739917">error</span><span class="op" id="5739922">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5739926">//&nbsp;RowsAffected&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;rows&nbsp;affected&nbsp;by&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5739985">//&nbsp;update,&nbsp;insert,&nbsp;or&nbsp;delete.&nbsp;Not&nbsp;every&nbsp;database&nbsp;or&nbsp;database</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5740047">//&nbsp;driver&nbsp;may&nbsp;support&nbsp;this.</span><br>
<span class="lineno">1740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5740076">RowsAffected</span><span class="op" id="5740088">(</span><span class="op" id="5740089">)</span>&nbsp;<span class="op" id="5740091">(</span><span class="ident" id="5740092">int64</span><span class="op" id="5740097">,</span>&nbsp;<span class="builtintype" id="5740099">error</span><span class="op" id="5740104">)</span><br>
<span class="lineno"></span><span class="op" id="5740106">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5740109">type</span>&nbsp;<span class="ident" id="5740114">driverResult</span>&nbsp;<span class="keyword" id="5740127">struct</span>&nbsp;<span class="op" id="5740134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5740137">sync</span><span class="op" id="5740141">.</span><span class="ident" id="5740142">Locker</span>&nbsp;<span class="comment" id="5740149">//&nbsp;the&nbsp;*driverConn</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5740169">resi</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5740181">driver</span><span class="op" id="5740187">.</span><span class="ident" id="5740188">Result</span><br>
<span class="lineno"></span><span class="op" id="5740195">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5740198">func</span>&nbsp;<span class="op" id="5740203">(</span><span class="ident" id="5740204">dr</span>&nbsp;<span class="ident" id="5740207">driverResult</span><span class="op" id="5740219">)</span>&nbsp;<span class="ident" id="5740221">LastInsertId</span><span class="op" id="5740233">(</span><span class="op" id="5740234">)</span>&nbsp;<span class="op" id="5740236">(</span><span class="ident" id="5740237">int64</span><span class="op" id="5740242">,</span>&nbsp;<span class="builtintype" id="5740244">error</span><span class="op" id="5740249">)</span>&nbsp;<span class="op" id="5740251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5740254">dr</span><span class="op" id="5740256">.</span><span class="ident" id="5740257">Lock</span><span class="op" id="5740261">(</span><span class="op" id="5740262">)</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5740265">defer</span>&nbsp;<span class="ident" id="5740271">dr</span><span class="op" id="5740273">.</span><span class="ident" id="5740274">Unlock</span><span class="op" id="5740280">(</span><span class="op" id="5740281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5740284">return</span>&nbsp;<span class="ident" id="5740291">dr</span><span class="op" id="5740293">.</span><span class="ident" id="5740294">resi</span><span class="op" id="5740298">.</span><span class="ident" id="5740299">LastInsertId</span><span class="op" id="5740311">(</span><span class="op" id="5740312">)</span><br>
<span class="lineno"></span><span class="op" id="5740314">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5740317">func</span>&nbsp;<span class="op" id="5740322">(</span><span class="ident" id="5740323">dr</span>&nbsp;<span class="ident" id="5740326">driverResult</span><span class="op" id="5740338">)</span>&nbsp;<span class="ident" id="5740340">RowsAffected</span><span class="op" id="5740352">(</span><span class="op" id="5740353">)</span>&nbsp;<span class="op" id="5740355">(</span><span class="ident" id="5740356">int64</span><span class="op" id="5740361">,</span>&nbsp;<span class="builtintype" id="5740363">error</span><span class="op" id="5740368">)</span>&nbsp;<span class="op" id="5740370">{</span><br>
<span class="lineno">1755</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5740373">dr</span><span class="op" id="5740375">.</span><span class="ident" id="5740376">Lock</span><span class="op" id="5740380">(</span><span class="op" id="5740381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5740384">defer</span>&nbsp;<span class="ident" id="5740390">dr</span><span class="op" id="5740392">.</span><span class="ident" id="5740393">Unlock</span><span class="op" id="5740399">(</span><span class="op" id="5740400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5740403">return</span>&nbsp;<span class="ident" id="5740410">dr</span><span class="op" id="5740412">.</span><span class="ident" id="5740413">resi</span><span class="op" id="5740417">.</span><span class="ident" id="5740418">RowsAffected</span><span class="op" id="5740430">(</span><span class="op" id="5740431">)</span><br>
<span class="lineno"></span><span class="op" id="5740433">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1760</span><span class="keyword" id="5740436">func</span>&nbsp;<span class="ident" id="5740441">stack</span><span class="op" id="5740446">(</span><span class="op" id="5740447">)</span>&nbsp;<span class="builtintype" id="5740449">string</span>&nbsp;<span class="op" id="5740456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5740459">var</span>&nbsp;<span class="ident" id="5740463">buf</span>&nbsp;<span class="op" id="5740467">[</span><span class="num" id="5740468">2</span>&nbsp;<span class="op" id="5740470">&lt;&lt;</span>&nbsp;<span class="num" id="5740473">10</span><span class="op" id="5740475">]</span><span class="builtintype" id="5740476">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5740482">return</span>&nbsp;<span class="builtintype" id="5740489">string</span><span class="op" id="5740495">(</span><span class="ident" id="5740496">buf</span><span class="op" id="5740499">[</span><span class="op" id="5740500">:</span><span class="ident" id="5740501">runtime</span><span class="op" id="5740508">.</span><span class="ident" id="5740509">Stack</span><span class="op" id="5740514">(</span><span class="ident" id="5740515">buf</span><span class="op" id="5740518">[</span><span class="op" id="5740519">:</span><span class="op" id="5740520">]</span><span class="op" id="5740521">,</span>&nbsp;<span class="builtintype" id="5740523">false</span><span class="op" id="5740528">)</span><span class="op" id="5740529">]</span><span class="op" id="5740530">)</span><br>
<span class="lineno"></span><span class="op" id="5740532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1765</span><span class="comment" id="5740535">//&nbsp;withLock&nbsp;runs&nbsp;while&nbsp;holding&nbsp;lk.</span><br>
<span class="lineno"></span><span class="keyword" id="5740570">func</span>&nbsp;<span class="ident" id="5740575">withLock</span><span class="op" id="5740583">(</span><span class="ident" id="5740584">lk</span>&nbsp;<span class="ident" id="5740587">sync</span><span class="op" id="5740591">.</span><span class="ident" id="5740592">Locker</span><span class="op" id="5740598">,</span>&nbsp;<span class="ident" id="5740600">fn</span>&nbsp;<span class="keyword" id="5740603">func</span><span class="op" id="5740607">(</span><span class="op" id="5740608">)</span><span class="op" id="5740609">)</span>&nbsp;<span class="op" id="5740611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5740614">lk</span><span class="op" id="5740616">.</span><span class="ident" id="5740617">Lock</span><span class="op" id="5740621">(</span><span class="op" id="5740622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5740625">fn</span><span class="op" id="5740627">(</span><span class="op" id="5740628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5740631">lk</span><span class="op" id="5740633">.</span><span class="ident" id="5740634">Unlock</span><span class="op" id="5740640">(</span><span class="op" id="5740641">)</span><br>
<span class="lineno">1770</span><span class="op" id="5740643">}</span>
</div>
</body>
</html>
