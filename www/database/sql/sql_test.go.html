<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="7253037">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7253092">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7253146">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7253197">package</span>&nbsp;<span class="ident" id="7253205">sql</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7253210">import</span>&nbsp;<span class="op" id="7253217">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7253220">&#34;database/sql/driver&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7253243">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7253253">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7253260">&#34;math/rand&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7253273">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7253284">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7253295">&#34;strings&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7253306">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7253314">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7253325">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7253332">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="7253335">func</span>&nbsp;<span class="ident" id="7253340">init</span><span class="op" id="7253344">(</span><span class="op" id="7253345">)</span>&nbsp;<span class="op" id="7253347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7253350">type</span>&nbsp;<span class="ident" id="7253355">dbConn</span>&nbsp;<span class="keyword" id="7253362">struct</span>&nbsp;<span class="op" id="7253369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7253373">db</span>&nbsp;<span class="op" id="7253376">*</span><span class="ident" id="7253377">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7253382">c</span>&nbsp;&nbsp;<span class="op" id="7253385">*</span><span class="ident" id="7253386">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7253398">}</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7253401">freedFrom</span>&nbsp;<span class="op" id="7253411">:=</span>&nbsp;<span class="builtinfunc" id="7253414">make</span><span class="op" id="7253418">(</span><span class="keyword" id="7253419">map</span><span class="op" id="7253422">[</span><span class="ident" id="7253423">dbConn</span><span class="op" id="7253429">]</span><span class="builtintype" id="7253430">string</span><span class="op" id="7253436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7253439">putConnHook</span>&nbsp;<span class="op" id="7253451">=</span>&nbsp;<span class="keyword" id="7253453">func</span><span class="op" id="7253457">(</span><span class="ident" id="7253458">db</span>&nbsp;<span class="op" id="7253461">*</span><span class="ident" id="7253462">DB</span><span class="op" id="7253464">,</span>&nbsp;<span class="ident" id="7253466">c</span>&nbsp;<span class="op" id="7253468">*</span><span class="ident" id="7253469">driverConn</span><span class="op" id="7253479">)</span>&nbsp;<span class="op" id="7253481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7253485">idx</span>&nbsp;<span class="op" id="7253489">:=</span>&nbsp;<span class="op" id="7253492">-</span><span class="num" id="7253493">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7253497">for</span>&nbsp;<span class="ident" id="7253501">i</span><span class="op" id="7253502">,</span>&nbsp;<span class="ident" id="7253504">v</span>&nbsp;<span class="op" id="7253506">:=</span>&nbsp;<span class="keyword" id="7253509">range</span>&nbsp;<span class="ident" id="7253515">db</span><span class="op" id="7253517">.</span><span class="ident" id="7253518">freeConn</span>&nbsp;<span class="op" id="7253527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7253532">if</span>&nbsp;<span class="ident" id="7253535">v</span>&nbsp;<span class="op" id="7253537">==</span>&nbsp;<span class="ident" id="7253540">c</span>&nbsp;<span class="op" id="7253542">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7253548">idx</span>&nbsp;<span class="op" id="7253552">=</span>&nbsp;<span class="ident" id="7253554">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7253560">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7253569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7253573">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7253577">if</span>&nbsp;<span class="ident" id="7253580">idx</span>&nbsp;<span class="op" id="7253584">&gt;=</span>&nbsp;<span class="num" id="7253587">0</span>&nbsp;<span class="op" id="7253589">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7253594">//&nbsp;print&nbsp;before&nbsp;panic,&nbsp;as&nbsp;panic&nbsp;may&nbsp;get&nbsp;lost&nbsp;due&nbsp;to&nbsp;conflicting&nbsp;panic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7253667">//&nbsp;(all&nbsp;goroutines&nbsp;asleep)&nbsp;elsewhere,&nbsp;since&nbsp;we&nbsp;might&nbsp;not&nbsp;unlock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7253734">//&nbsp;the&nbsp;mutex&nbsp;in&nbsp;freeConn&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7253768">println</span><span class="op" id="7253775">(</span><span class="string" id="7253776">&#34;double&nbsp;free&nbsp;of&nbsp;conn.&nbsp;conflicts&nbsp;are:\nA)&nbsp;&#34;</span>&nbsp;<span class="op" id="7253819">+</span>&nbsp;<span class="ident" id="7253821">freedFrom</span><span class="op" id="7253830">[</span><span class="ident" id="7253831">dbConn</span><span class="op" id="7253837">{</span><span class="ident" id="7253838">db</span><span class="op" id="7253840">,</span>&nbsp;<span class="ident" id="7253842">c</span><span class="op" id="7253843">}</span><span class="op" id="7253844">]</span>&nbsp;<span class="op" id="7253846">+</span>&nbsp;<span class="string" id="7253848">&#34;\n\nand\nB)&nbsp;&#34;</span>&nbsp;<span class="op" id="7253863">+</span>&nbsp;<span class="ident" id="7253865">stack</span><span class="op" id="7253870">(</span><span class="op" id="7253871">)</span><span class="op" id="7253872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7253877">panic</span><span class="op" id="7253882">(</span><span class="string" id="7253883">&#34;double&nbsp;free&nbsp;of&nbsp;conn.&#34;</span><span class="op" id="7253905">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7253909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7253913">freedFrom</span><span class="op" id="7253922">[</span><span class="ident" id="7253923">dbConn</span><span class="op" id="7253929">{</span><span class="ident" id="7253930">db</span><span class="op" id="7253932">,</span>&nbsp;<span class="ident" id="7253934">c</span><span class="op" id="7253935">}</span><span class="op" id="7253936">]</span>&nbsp;<span class="op" id="7253938">=</span>&nbsp;<span class="ident" id="7253940">stack</span><span class="op" id="7253945">(</span><span class="op" id="7253946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7253949">}</span><br>
<span class="lineno"></span><span class="op" id="7253951">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword" id="7253954">const</span>&nbsp;<span class="ident" id="7253960">fakeDBName</span>&nbsp;<span class="op" id="7253971">=</span>&nbsp;<span class="string" id="7253973">&#34;foo&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7253980">var</span>&nbsp;<span class="ident" id="7253984">chrisBirthday</span>&nbsp;<span class="op" id="7253998">=</span>&nbsp;<span class="ident" id="7254000">time</span><span class="op" id="7254004">.</span><span class="ident" id="7254005">Unix</span><span class="op" id="7254009">(</span><span class="num" id="7254010">123456789</span><span class="op" id="7254019">,</span>&nbsp;<span class="num" id="7254021">0</span><span class="op" id="7254022">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7254025">func</span>&nbsp;<span class="ident" id="7254030">newTestDB</span><span class="op" id="7254039">(</span><span class="ident" id="7254040">t</span>&nbsp;<span class="ident" id="7254042">testing</span><span class="op" id="7254049">.</span><span class="ident" id="7254050">TB</span><span class="op" id="7254052">,</span>&nbsp;<span class="ident" id="7254054">name</span>&nbsp;<span class="builtintype" id="7254059">string</span><span class="op" id="7254065">)</span>&nbsp;<span class="op" id="7254067">*</span><span class="ident" id="7254068">DB</span>&nbsp;<span class="op" id="7254071">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7254074">db</span><span class="op" id="7254076">,</span>&nbsp;<span class="ident" id="7254078">err</span>&nbsp;<span class="op" id="7254082">:=</span>&nbsp;<span class="ident" id="7254085">Open</span><span class="op" id="7254089">(</span><span class="string" id="7254090">&#34;test&#34;</span><span class="op" id="7254096">,</span>&nbsp;<span class="ident" id="7254098">fakeDBName</span><span class="op" id="7254108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7254111">if</span>&nbsp;<span class="ident" id="7254114">err</span>&nbsp;<span class="op" id="7254118">!=</span>&nbsp;<span class="ident" id="7254121">nil</span>&nbsp;<span class="op" id="7254125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7254129">t</span><span class="op" id="7254130">.</span><span class="ident" id="7254131">Fatalf</span><span class="op" id="7254137">(</span><span class="string" id="7254138">&#34;Open:&nbsp;%v&#34;</span><span class="op" id="7254148">,</span>&nbsp;<span class="ident" id="7254150">err</span><span class="op" id="7254153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7254156">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7254159">if</span>&nbsp;<span class="ident" id="7254162">_</span><span class="op" id="7254163">,</span>&nbsp;<span class="ident" id="7254165">err</span>&nbsp;<span class="op" id="7254169">:=</span>&nbsp;<span class="ident" id="7254172">db</span><span class="op" id="7254174">.</span><span class="ident" id="7254175">Exec</span><span class="op" id="7254179">(</span><span class="string" id="7254180">&#34;WIPE&#34;</span><span class="op" id="7254186">)</span><span class="op" id="7254187">;</span>&nbsp;<span class="ident" id="7254189">err</span>&nbsp;<span class="op" id="7254193">!=</span>&nbsp;<span class="ident" id="7254196">nil</span>&nbsp;<span class="op" id="7254200">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7254204">t</span><span class="op" id="7254205">.</span><span class="ident" id="7254206">Fatalf</span><span class="op" id="7254212">(</span><span class="string" id="7254213">&#34;exec&nbsp;wipe:&nbsp;%v&#34;</span><span class="op" id="7254228">,</span>&nbsp;<span class="ident" id="7254230">err</span><span class="op" id="7254233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7254236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7254239">if</span>&nbsp;<span class="ident" id="7254242">name</span>&nbsp;<span class="op" id="7254247">==</span>&nbsp;<span class="string" id="7254250">&#34;people&#34;</span>&nbsp;<span class="op" id="7254259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7254263">exec</span><span class="op" id="7254267">(</span><span class="ident" id="7254268">t</span><span class="op" id="7254269">,</span>&nbsp;<span class="ident" id="7254271">db</span><span class="op" id="7254273">,</span>&nbsp;<span class="string" id="7254275">&#34;CREATE|people|name=string,age=int32,photo=blob,dead=bool,bdate=datetime&#34;</span><span class="op" id="7254348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7254352">exec</span><span class="op" id="7254356">(</span><span class="ident" id="7254357">t</span><span class="op" id="7254358">,</span>&nbsp;<span class="ident" id="7254360">db</span><span class="op" id="7254362">,</span>&nbsp;<span class="string" id="7254364">&#34;INSERT|people|name=Alice,age=?,photo=APHOTO&#34;</span><span class="op" id="7254409">,</span>&nbsp;<span class="num" id="7254411">1</span><span class="op" id="7254412">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7254416">exec</span><span class="op" id="7254420">(</span><span class="ident" id="7254421">t</span><span class="op" id="7254422">,</span>&nbsp;<span class="ident" id="7254424">db</span><span class="op" id="7254426">,</span>&nbsp;<span class="string" id="7254428">&#34;INSERT|people|name=Bob,age=?,photo=BPHOTO&#34;</span><span class="op" id="7254471">,</span>&nbsp;<span class="num" id="7254473">2</span><span class="op" id="7254474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7254478">exec</span><span class="op" id="7254482">(</span><span class="ident" id="7254483">t</span><span class="op" id="7254484">,</span>&nbsp;<span class="ident" id="7254486">db</span><span class="op" id="7254488">,</span>&nbsp;<span class="string" id="7254490">&#34;INSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="7254543">,</span>&nbsp;<span class="num" id="7254545">3</span><span class="op" id="7254546">,</span>&nbsp;<span class="ident" id="7254548">chrisBirthday</span><span class="op" id="7254561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7254564">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7254567">if</span>&nbsp;<span class="ident" id="7254570">name</span>&nbsp;<span class="op" id="7254575">==</span>&nbsp;<span class="string" id="7254578">&#34;magicquery&#34;</span>&nbsp;<span class="op" id="7254591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7254595">//&nbsp;Magic&nbsp;table&nbsp;name&nbsp;and&nbsp;column,&nbsp;known&nbsp;by&nbsp;fakedb_test.go.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7254654">exec</span><span class="op" id="7254658">(</span><span class="ident" id="7254659">t</span><span class="op" id="7254660">,</span>&nbsp;<span class="ident" id="7254662">db</span><span class="op" id="7254664">,</span>&nbsp;<span class="string" id="7254666">&#34;CREATE|magicquery|op=string,millis=int32&#34;</span><span class="op" id="7254708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7254712">exec</span><span class="op" id="7254716">(</span><span class="ident" id="7254717">t</span><span class="op" id="7254718">,</span>&nbsp;<span class="ident" id="7254720">db</span><span class="op" id="7254722">,</span>&nbsp;<span class="string" id="7254724">&#34;INSERT|magicquery|op=sleep,millis=10&#34;</span><span class="op" id="7254762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7254765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7254768">return</span>&nbsp;<span class="ident" id="7254775">db</span><br>
<span class="lineno"></span><span class="op" id="7254778">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="7254781">func</span>&nbsp;<span class="ident" id="7254786">exec</span><span class="op" id="7254790">(</span><span class="ident" id="7254791">t</span>&nbsp;<span class="ident" id="7254793">testing</span><span class="op" id="7254800">.</span><span class="ident" id="7254801">TB</span><span class="op" id="7254803">,</span>&nbsp;<span class="ident" id="7254805">db</span>&nbsp;<span class="op" id="7254808">*</span><span class="ident" id="7254809">DB</span><span class="op" id="7254811">,</span>&nbsp;<span class="ident" id="7254813">query</span>&nbsp;<span class="builtintype" id="7254819">string</span><span class="op" id="7254825">,</span>&nbsp;<span class="ident" id="7254827">args</span>&nbsp;<span class="op" id="7254832">...</span><span class="keyword" id="7254835">interface</span><span class="op" id="7254844">{</span><span class="op" id="7254845">}</span><span class="op" id="7254846">)</span>&nbsp;<span class="op" id="7254848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7254851">_</span><span class="op" id="7254852">,</span>&nbsp;<span class="ident" id="7254854">err</span>&nbsp;<span class="op" id="7254858">:=</span>&nbsp;<span class="ident" id="7254861">db</span><span class="op" id="7254863">.</span><span class="ident" id="7254864">Exec</span><span class="op" id="7254868">(</span><span class="ident" id="7254869">query</span><span class="op" id="7254874">,</span>&nbsp;<span class="ident" id="7254876">args</span><span class="op" id="7254880">...</span><span class="op" id="7254883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7254886">if</span>&nbsp;<span class="ident" id="7254889">err</span>&nbsp;<span class="op" id="7254893">!=</span>&nbsp;<span class="ident" id="7254896">nil</span>&nbsp;<span class="op" id="7254900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7254904">t</span><span class="op" id="7254905">.</span><span class="ident" id="7254906">Fatalf</span><span class="op" id="7254912">(</span><span class="string" id="7254913">&#34;Exec&nbsp;of&nbsp;%q:&nbsp;%v&#34;</span><span class="op" id="7254929">,</span>&nbsp;<span class="ident" id="7254931">query</span><span class="op" id="7254936">,</span>&nbsp;<span class="ident" id="7254938">err</span><span class="op" id="7254941">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7254944">}</span><br>
<span class="lineno"></span><span class="op" id="7254946">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7254949">func</span>&nbsp;<span class="ident" id="7254954">closeDB</span><span class="op" id="7254961">(</span><span class="ident" id="7254962">t</span>&nbsp;<span class="ident" id="7254964">testing</span><span class="op" id="7254971">.</span><span class="ident" id="7254972">TB</span><span class="op" id="7254974">,</span>&nbsp;<span class="ident" id="7254976">db</span>&nbsp;<span class="op" id="7254979">*</span><span class="ident" id="7254980">DB</span><span class="op" id="7254982">)</span>&nbsp;<span class="op" id="7254984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7254987">if</span>&nbsp;<span class="ident" id="7254990">e</span>&nbsp;<span class="op" id="7254992">:=</span>&nbsp;<span class="builtinfunc" id="7254995">recover</span><span class="op" id="7255002">(</span><span class="op" id="7255003">)</span><span class="op" id="7255004">;</span>&nbsp;<span class="ident" id="7255006">e</span>&nbsp;<span class="op" id="7255008">!=</span>&nbsp;<span class="ident" id="7255011">nil</span>&nbsp;<span class="op" id="7255015">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7255019">fmt</span><span class="op" id="7255022">.</span><span class="ident" id="7255023">Printf</span><span class="op" id="7255029">(</span><span class="string" id="7255030">&#34;Panic:&nbsp;%v\n&#34;</span><span class="op" id="7255043">,</span>&nbsp;<span class="ident" id="7255045">e</span><span class="op" id="7255046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7255050">panic</span><span class="op" id="7255055">(</span><span class="ident" id="7255056">e</span><span class="op" id="7255057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7255060">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7255063">defer</span>&nbsp;<span class="ident" id="7255069">setHookpostCloseConn</span><span class="op" id="7255089">(</span><span class="ident" id="7255090">nil</span><span class="op" id="7255093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7255096">setHookpostCloseConn</span><span class="op" id="7255116">(</span><span class="keyword" id="7255117">func</span><span class="op" id="7255121">(</span><span class="ident" id="7255122">_</span>&nbsp;<span class="op" id="7255124">*</span><span class="ident" id="7255125">fakeConn</span><span class="op" id="7255133">,</span>&nbsp;<span class="ident" id="7255135">err</span>&nbsp;<span class="builtintype" id="7255139">error</span><span class="op" id="7255144">)</span>&nbsp;<span class="op" id="7255146">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7255150">if</span>&nbsp;<span class="ident" id="7255153">err</span>&nbsp;<span class="op" id="7255157">!=</span>&nbsp;<span class="ident" id="7255160">nil</span>&nbsp;<span class="op" id="7255164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7255169">t</span><span class="op" id="7255170">.</span><span class="ident" id="7255171">Errorf</span><span class="op" id="7255177">(</span><span class="string" id="7255178">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="7255206">,</span>&nbsp;<span class="ident" id="7255208">err</span><span class="op" id="7255211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7255215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7255218">}</span><span class="op" id="7255219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7255222">for</span>&nbsp;<span class="ident" id="7255226">i</span><span class="op" id="7255227">,</span>&nbsp;<span class="ident" id="7255229">dc</span>&nbsp;<span class="op" id="7255232">:=</span>&nbsp;<span class="keyword" id="7255235">range</span>&nbsp;<span class="ident" id="7255241">db</span><span class="op" id="7255243">.</span><span class="ident" id="7255244">freeConn</span>&nbsp;<span class="op" id="7255253">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7255257">if</span>&nbsp;<span class="ident" id="7255260">n</span>&nbsp;<span class="op" id="7255262">:=</span>&nbsp;<span class="builtinfunc" id="7255265">len</span><span class="op" id="7255268">(</span><span class="ident" id="7255269">dc</span><span class="op" id="7255271">.</span><span class="ident" id="7255272">openStmt</span><span class="op" id="7255280">)</span><span class="op" id="7255281">;</span>&nbsp;<span class="ident" id="7255283">n</span>&nbsp;<span class="op" id="7255285">&gt;</span>&nbsp;<span class="num" id="7255287">0</span>&nbsp;<span class="op" id="7255289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7255294">//&nbsp;Just&nbsp;a&nbsp;sanity&nbsp;check.&nbsp;This&nbsp;is&nbsp;legal&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7255338">//&nbsp;general,&nbsp;but&nbsp;if&nbsp;we&nbsp;make&nbsp;the&nbsp;tests&nbsp;clean&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7255387">//&nbsp;their&nbsp;statements&nbsp;first,&nbsp;then&nbsp;we&nbsp;can&nbsp;safely</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7255436">//&nbsp;verify&nbsp;this&nbsp;is&nbsp;always&nbsp;zero&nbsp;here,&nbsp;and&nbsp;any</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7255483">//&nbsp;other&nbsp;value&nbsp;is&nbsp;a&nbsp;leak.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7255512">t</span><span class="op" id="7255513">.</span><span class="ident" id="7255514">Errorf</span><span class="op" id="7255520">(</span><span class="string" id="7255521">&#34;while&nbsp;closing&nbsp;db,&nbsp;freeConn&nbsp;%d/%d&nbsp;had&nbsp;%d&nbsp;open&nbsp;stmts;&nbsp;want&nbsp;0&#34;</span><span class="op" id="7255581">,</span>&nbsp;<span class="ident" id="7255583">i</span><span class="op" id="7255584">,</span>&nbsp;<span class="builtinfunc" id="7255586">len</span><span class="op" id="7255589">(</span><span class="ident" id="7255590">db</span><span class="op" id="7255592">.</span><span class="ident" id="7255593">freeConn</span><span class="op" id="7255601">)</span><span class="op" id="7255602">,</span>&nbsp;<span class="ident" id="7255604">n</span><span class="op" id="7255605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7255609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7255612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7255615">err</span>&nbsp;<span class="op" id="7255619">:=</span>&nbsp;<span class="ident" id="7255622">db</span><span class="op" id="7255624">.</span><span class="ident" id="7255625">Close</span><span class="op" id="7255630">(</span><span class="op" id="7255631">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7255634">if</span>&nbsp;<span class="ident" id="7255637">err</span>&nbsp;<span class="op" id="7255641">!=</span>&nbsp;<span class="ident" id="7255644">nil</span>&nbsp;<span class="op" id="7255648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7255652">t</span><span class="op" id="7255653">.</span><span class="ident" id="7255654">Fatalf</span><span class="op" id="7255660">(</span><span class="string" id="7255661">&#34;error&nbsp;closing&nbsp;DB:&nbsp;%v&#34;</span><span class="op" id="7255683">,</span>&nbsp;<span class="ident" id="7255685">err</span><span class="op" id="7255688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7255691">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7255694">db</span><span class="op" id="7255696">.</span><span class="ident" id="7255697">mu</span><span class="op" id="7255699">.</span><span class="ident" id="7255700">Lock</span><span class="op" id="7255704">(</span><span class="op" id="7255705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7255708">count</span>&nbsp;<span class="op" id="7255714">:=</span>&nbsp;<span class="ident" id="7255717">db</span><span class="op" id="7255719">.</span><span class="ident" id="7255720">numOpen</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7255729">db</span><span class="op" id="7255731">.</span><span class="ident" id="7255732">mu</span><span class="op" id="7255734">.</span><span class="ident" id="7255735">Unlock</span><span class="op" id="7255741">(</span><span class="op" id="7255742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7255745">if</span>&nbsp;<span class="ident" id="7255748">count</span>&nbsp;<span class="op" id="7255754">!=</span>&nbsp;<span class="num" id="7255757">0</span>&nbsp;<span class="op" id="7255759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7255763">t</span><span class="op" id="7255764">.</span><span class="ident" id="7255765">Fatalf</span><span class="op" id="7255771">(</span><span class="string" id="7255772">&#34;%d&nbsp;connections&nbsp;still&nbsp;open&nbsp;after&nbsp;closing&nbsp;DB&#34;</span><span class="op" id="7255816">,</span>&nbsp;<span class="ident" id="7255818">db</span><span class="op" id="7255820">.</span><span class="ident" id="7255821">numOpen</span><span class="op" id="7255828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7255831">}</span><br>
<span class="lineno"></span><span class="op" id="7255833">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="comment" id="7255836">//&nbsp;numPrepares&nbsp;assumes&nbsp;that&nbsp;db&nbsp;has&nbsp;exactly&nbsp;1&nbsp;idle&nbsp;conn&nbsp;and&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="7255903">//&nbsp;its&nbsp;count&nbsp;of&nbsp;calls&nbsp;to&nbsp;Prepare</span><br>
<span class="lineno"></span><span class="keyword" id="7255936">func</span>&nbsp;<span class="ident" id="7255941">numPrepares</span><span class="op" id="7255952">(</span><span class="ident" id="7255953">t</span>&nbsp;<span class="op" id="7255955">*</span><span class="ident" id="7255956">testing</span><span class="op" id="7255963">.</span><span class="ident" id="7255964">T</span><span class="op" id="7255965">,</span>&nbsp;<span class="ident" id="7255967">db</span>&nbsp;<span class="op" id="7255970">*</span><span class="ident" id="7255971">DB</span><span class="op" id="7255973">)</span>&nbsp;<span class="builtintype" id="7255975">int</span>&nbsp;<span class="op" id="7255979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7255982">if</span>&nbsp;<span class="ident" id="7255985">n</span>&nbsp;<span class="op" id="7255987">:=</span>&nbsp;<span class="builtinfunc" id="7255990">len</span><span class="op" id="7255993">(</span><span class="ident" id="7255994">db</span><span class="op" id="7255996">.</span><span class="ident" id="7255997">freeConn</span><span class="op" id="7256005">)</span><span class="op" id="7256006">;</span>&nbsp;<span class="ident" id="7256008">n</span>&nbsp;<span class="op" id="7256010">!=</span>&nbsp;<span class="num" id="7256013">1</span>&nbsp;<span class="op" id="7256015">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7256019">t</span><span class="op" id="7256020">.</span><span class="ident" id="7256021">Fatalf</span><span class="op" id="7256027">(</span><span class="string" id="7256028">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="7256053">,</span>&nbsp;<span class="ident" id="7256055">n</span><span class="op" id="7256056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7256059">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7256062">return</span>&nbsp;<span class="ident" id="7256069">db</span><span class="op" id="7256071">.</span><span class="ident" id="7256072">freeConn</span><span class="op" id="7256080">[</span><span class="num" id="7256081">0</span><span class="op" id="7256082">]</span><span class="op" id="7256083">.</span><span class="ident" id="7256084">ci</span><span class="op" id="7256086">.</span><span class="op" id="7256087">(</span><span class="op" id="7256088">*</span><span class="ident" id="7256089">fakeConn</span><span class="op" id="7256097">)</span><span class="op" id="7256098">.</span><span class="ident" id="7256099">numPrepare</span><br>
<span class="lineno"></span><span class="op" id="7256110">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="keyword" id="7256113">func</span>&nbsp;<span class="op" id="7256118">(</span><span class="ident" id="7256119">db</span>&nbsp;<span class="op" id="7256122">*</span><span class="ident" id="7256123">DB</span><span class="op" id="7256125">)</span>&nbsp;<span class="ident" id="7256127">numDeps</span><span class="op" id="7256134">(</span><span class="op" id="7256135">)</span>&nbsp;<span class="builtintype" id="7256137">int</span>&nbsp;<span class="op" id="7256141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7256144">db</span><span class="op" id="7256146">.</span><span class="ident" id="7256147">mu</span><span class="op" id="7256149">.</span><span class="ident" id="7256150">Lock</span><span class="op" id="7256154">(</span><span class="op" id="7256155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7256158">defer</span>&nbsp;<span class="ident" id="7256164">db</span><span class="op" id="7256166">.</span><span class="ident" id="7256167">mu</span><span class="op" id="7256169">.</span><span class="ident" id="7256170">Unlock</span><span class="op" id="7256176">(</span><span class="op" id="7256177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7256180">return</span>&nbsp;<span class="builtinfunc" id="7256187">len</span><span class="op" id="7256190">(</span><span class="ident" id="7256191">db</span><span class="op" id="7256193">.</span><span class="ident" id="7256194">dep</span><span class="op" id="7256197">)</span><br>
<span class="lineno"></span><span class="op" id="7256199">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="comment" id="7256202">//&nbsp;Dependencies&nbsp;are&nbsp;closed&nbsp;via&nbsp;a&nbsp;goroutine,&nbsp;so&nbsp;this&nbsp;polls&nbsp;waiting&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="7256272">//&nbsp;numDeps&nbsp;to&nbsp;fall&nbsp;to&nbsp;want,&nbsp;waiting&nbsp;up&nbsp;to&nbsp;d.</span><br>
<span class="lineno"></span><span class="keyword" id="7256317">func</span>&nbsp;<span class="op" id="7256322">(</span><span class="ident" id="7256323">db</span>&nbsp;<span class="op" id="7256326">*</span><span class="ident" id="7256327">DB</span><span class="op" id="7256329">)</span>&nbsp;<span class="ident" id="7256331">numDepsPollUntil</span><span class="op" id="7256347">(</span><span class="ident" id="7256348">want</span>&nbsp;<span class="builtintype" id="7256353">int</span><span class="op" id="7256356">,</span>&nbsp;<span class="ident" id="7256358">d</span>&nbsp;<span class="ident" id="7256360">time</span><span class="op" id="7256364">.</span><span class="ident" id="7256365">Duration</span><span class="op" id="7256373">)</span>&nbsp;<span class="builtintype" id="7256375">int</span>&nbsp;<span class="op" id="7256379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7256382">deadline</span>&nbsp;<span class="op" id="7256391">:=</span>&nbsp;<span class="ident" id="7256394">time</span><span class="op" id="7256398">.</span><span class="ident" id="7256399">Now</span><span class="op" id="7256402">(</span><span class="op" id="7256403">)</span><span class="op" id="7256404">.</span><span class="ident" id="7256405">Add</span><span class="op" id="7256408">(</span><span class="ident" id="7256409">d</span><span class="op" id="7256410">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7256413">for</span>&nbsp;<span class="op" id="7256417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7256421">n</span>&nbsp;<span class="op" id="7256423">:=</span>&nbsp;<span class="ident" id="7256426">db</span><span class="op" id="7256428">.</span><span class="ident" id="7256429">numDeps</span><span class="op" id="7256436">(</span><span class="op" id="7256437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7256441">if</span>&nbsp;<span class="ident" id="7256444">n</span>&nbsp;<span class="op" id="7256446">&lt;=</span>&nbsp;<span class="ident" id="7256449">want</span>&nbsp;<span class="op" id="7256454">||</span>&nbsp;<span class="ident" id="7256457">time</span><span class="op" id="7256461">.</span><span class="ident" id="7256462">Now</span><span class="op" id="7256465">(</span><span class="op" id="7256466">)</span><span class="op" id="7256467">.</span><span class="ident" id="7256468">After</span><span class="op" id="7256473">(</span><span class="ident" id="7256474">deadline</span><span class="op" id="7256482">)</span>&nbsp;<span class="op" id="7256484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7256489">return</span>&nbsp;<span class="ident" id="7256496">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7256500">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7256504">time</span><span class="op" id="7256508">.</span><span class="ident" id="7256509">Sleep</span><span class="op" id="7256514">(</span><span class="num" id="7256515">50</span>&nbsp;<span class="op" id="7256518">*</span>&nbsp;<span class="ident" id="7256520">time</span><span class="op" id="7256524">.</span><span class="ident" id="7256525">Millisecond</span><span class="op" id="7256536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7256539">}</span><br>
<span class="lineno"></span><span class="op" id="7256541">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7256544">func</span>&nbsp;<span class="op" id="7256549">(</span><span class="ident" id="7256550">db</span>&nbsp;<span class="op" id="7256553">*</span><span class="ident" id="7256554">DB</span><span class="op" id="7256556">)</span>&nbsp;<span class="ident" id="7256558">numFreeConns</span><span class="op" id="7256570">(</span><span class="op" id="7256571">)</span>&nbsp;<span class="builtintype" id="7256573">int</span>&nbsp;<span class="op" id="7256577">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7256580">db</span><span class="op" id="7256582">.</span><span class="ident" id="7256583">mu</span><span class="op" id="7256585">.</span><span class="ident" id="7256586">Lock</span><span class="op" id="7256590">(</span><span class="op" id="7256591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7256594">defer</span>&nbsp;<span class="ident" id="7256600">db</span><span class="op" id="7256602">.</span><span class="ident" id="7256603">mu</span><span class="op" id="7256605">.</span><span class="ident" id="7256606">Unlock</span><span class="op" id="7256612">(</span><span class="op" id="7256613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7256616">return</span>&nbsp;<span class="builtinfunc" id="7256623">len</span><span class="op" id="7256626">(</span><span class="ident" id="7256627">db</span><span class="op" id="7256629">.</span><span class="ident" id="7256630">freeConn</span><span class="op" id="7256638">)</span><br>
<span class="lineno"></span><span class="op" id="7256640">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="7256643">func</span>&nbsp;<span class="op" id="7256648">(</span><span class="ident" id="7256649">db</span>&nbsp;<span class="op" id="7256652">*</span><span class="ident" id="7256653">DB</span><span class="op" id="7256655">)</span>&nbsp;<span class="ident" id="7256657">dumpDeps</span><span class="op" id="7256665">(</span><span class="ident" id="7256666">t</span>&nbsp;<span class="op" id="7256668">*</span><span class="ident" id="7256669">testing</span><span class="op" id="7256676">.</span><span class="ident" id="7256677">T</span><span class="op" id="7256678">)</span>&nbsp;<span class="op" id="7256680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7256683">for</span>&nbsp;<span class="ident" id="7256687">fc</span>&nbsp;<span class="op" id="7256690">:=</span>&nbsp;<span class="keyword" id="7256693">range</span>&nbsp;<span class="ident" id="7256699">db</span><span class="op" id="7256701">.</span><span class="ident" id="7256702">dep</span>&nbsp;<span class="op" id="7256706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7256710">db</span><span class="op" id="7256712">.</span><span class="ident" id="7256713">dumpDep</span><span class="op" id="7256720">(</span><span class="ident" id="7256721">t</span><span class="op" id="7256722">,</span>&nbsp;<span class="num" id="7256724">0</span><span class="op" id="7256725">,</span>&nbsp;<span class="ident" id="7256727">fc</span><span class="op" id="7256729">,</span>&nbsp;<span class="keyword" id="7256731">map</span><span class="op" id="7256734">[</span><span class="ident" id="7256735">finalCloser</span><span class="op" id="7256746">]</span><span class="builtintype" id="7256747">bool</span><span class="op" id="7256751">{</span><span class="op" id="7256752">}</span><span class="op" id="7256753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7256756">}</span><br>
<span class="lineno"></span><span class="op" id="7256758">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span><span class="keyword" id="7256761">func</span>&nbsp;<span class="op" id="7256766">(</span><span class="ident" id="7256767">db</span>&nbsp;<span class="op" id="7256770">*</span><span class="ident" id="7256771">DB</span><span class="op" id="7256773">)</span>&nbsp;<span class="ident" id="7256775">dumpDep</span><span class="op" id="7256782">(</span><span class="ident" id="7256783">t</span>&nbsp;<span class="op" id="7256785">*</span><span class="ident" id="7256786">testing</span><span class="op" id="7256793">.</span><span class="ident" id="7256794">T</span><span class="op" id="7256795">,</span>&nbsp;<span class="ident" id="7256797">depth</span>&nbsp;<span class="builtintype" id="7256803">int</span><span class="op" id="7256806">,</span>&nbsp;<span class="ident" id="7256808">dep</span>&nbsp;<span class="ident" id="7256812">finalCloser</span><span class="op" id="7256823">,</span>&nbsp;<span class="ident" id="7256825">seen</span>&nbsp;<span class="keyword" id="7256830">map</span><span class="op" id="7256833">[</span><span class="ident" id="7256834">finalCloser</span><span class="op" id="7256845">]</span><span class="builtintype" id="7256846">bool</span><span class="op" id="7256850">)</span>&nbsp;<span class="op" id="7256852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7256855">seen</span><span class="op" id="7256859">[</span><span class="ident" id="7256860">dep</span><span class="op" id="7256863">]</span>&nbsp;<span class="op" id="7256865">=</span>&nbsp;<span class="ident" id="7256867">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7256873">indent</span>&nbsp;<span class="op" id="7256880">:=</span>&nbsp;<span class="ident" id="7256883">strings</span><span class="op" id="7256890">.</span><span class="ident" id="7256891">Repeat</span><span class="op" id="7256897">(</span><span class="string" id="7256898">&#34;&nbsp;&nbsp;&#34;</span><span class="op" id="7256902">,</span>&nbsp;<span class="ident" id="7256904">depth</span><span class="op" id="7256909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7256912">ds</span>&nbsp;<span class="op" id="7256915">:=</span>&nbsp;<span class="ident" id="7256918">db</span><span class="op" id="7256920">.</span><span class="ident" id="7256921">dep</span><span class="op" id="7256924">[</span><span class="ident" id="7256925">dep</span><span class="op" id="7256928">]</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7256931">for</span>&nbsp;<span class="ident" id="7256935">k</span>&nbsp;<span class="op" id="7256937">:=</span>&nbsp;<span class="keyword" id="7256940">range</span>&nbsp;<span class="ident" id="7256946">ds</span>&nbsp;<span class="op" id="7256949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7256953">t</span><span class="op" id="7256954">.</span><span class="ident" id="7256955">Logf</span><span class="op" id="7256959">(</span><span class="string" id="7256960">&#34;%s%T&nbsp;(%p)&nbsp;waiting&nbsp;for&nbsp;-&gt;&nbsp;%T&nbsp;(%p)&#34;</span><span class="op" id="7256994">,</span>&nbsp;<span class="ident" id="7256996">indent</span><span class="op" id="7257002">,</span>&nbsp;<span class="ident" id="7257004">dep</span><span class="op" id="7257007">,</span>&nbsp;<span class="ident" id="7257009">dep</span><span class="op" id="7257012">,</span>&nbsp;<span class="ident" id="7257014">k</span><span class="op" id="7257015">,</span>&nbsp;<span class="ident" id="7257017">k</span><span class="op" id="7257018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7257022">if</span>&nbsp;<span class="ident" id="7257025">fc</span><span class="op" id="7257027">,</span>&nbsp;<span class="ident" id="7257029">ok</span>&nbsp;<span class="op" id="7257032">:=</span>&nbsp;<span class="ident" id="7257035">k</span><span class="op" id="7257036">.</span><span class="op" id="7257037">(</span><span class="ident" id="7257038">finalCloser</span><span class="op" id="7257049">)</span><span class="op" id="7257050">;</span>&nbsp;<span class="ident" id="7257052">ok</span>&nbsp;<span class="op" id="7257055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7257060">if</span>&nbsp;<span class="op" id="7257063">!</span><span class="ident" id="7257064">seen</span><span class="op" id="7257068">[</span><span class="ident" id="7257069">fc</span><span class="op" id="7257071">]</span>&nbsp;<span class="op" id="7257073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7257079">db</span><span class="op" id="7257081">.</span><span class="ident" id="7257082">dumpDep</span><span class="op" id="7257089">(</span><span class="ident" id="7257090">t</span><span class="op" id="7257091">,</span>&nbsp;<span class="ident" id="7257093">depth</span><span class="op" id="7257098">+</span><span class="num" id="7257099">1</span><span class="op" id="7257100">,</span>&nbsp;<span class="ident" id="7257102">fc</span><span class="op" id="7257104">,</span>&nbsp;<span class="ident" id="7257106">seen</span><span class="op" id="7257110">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7257115">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7257119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7257122">}</span><br>
<span class="lineno"></span><span class="op" id="7257124">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="7257127">func</span>&nbsp;<span class="ident" id="7257132">TestQuery</span><span class="op" id="7257141">(</span><span class="ident" id="7257142">t</span>&nbsp;<span class="op" id="7257144">*</span><span class="ident" id="7257145">testing</span><span class="op" id="7257152">.</span><span class="ident" id="7257153">T</span><span class="op" id="7257154">)</span>&nbsp;<span class="op" id="7257156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7257159">db</span>&nbsp;<span class="op" id="7257162">:=</span>&nbsp;<span class="ident" id="7257165">newTestDB</span><span class="op" id="7257174">(</span><span class="ident" id="7257175">t</span><span class="op" id="7257176">,</span>&nbsp;<span class="string" id="7257178">&#34;people&#34;</span><span class="op" id="7257186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7257189">defer</span>&nbsp;<span class="ident" id="7257195">closeDB</span><span class="op" id="7257202">(</span><span class="ident" id="7257203">t</span><span class="op" id="7257204">,</span>&nbsp;<span class="ident" id="7257206">db</span><span class="op" id="7257208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7257211">prepares0</span>&nbsp;<span class="op" id="7257221">:=</span>&nbsp;<span class="ident" id="7257224">numPrepares</span><span class="op" id="7257235">(</span><span class="ident" id="7257236">t</span><span class="op" id="7257237">,</span>&nbsp;<span class="ident" id="7257239">db</span><span class="op" id="7257241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7257244">rows</span><span class="op" id="7257248">,</span>&nbsp;<span class="ident" id="7257250">err</span>&nbsp;<span class="op" id="7257254">:=</span>&nbsp;<span class="ident" id="7257257">db</span><span class="op" id="7257259">.</span><span class="ident" id="7257260">Query</span><span class="op" id="7257265">(</span><span class="string" id="7257266">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="7257291">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7257294">if</span>&nbsp;<span class="ident" id="7257297">err</span>&nbsp;<span class="op" id="7257301">!=</span>&nbsp;<span class="ident" id="7257304">nil</span>&nbsp;<span class="op" id="7257308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7257312">t</span><span class="op" id="7257313">.</span><span class="ident" id="7257314">Fatalf</span><span class="op" id="7257320">(</span><span class="string" id="7257321">&#34;Query:&nbsp;%v&#34;</span><span class="op" id="7257332">,</span>&nbsp;<span class="ident" id="7257334">err</span><span class="op" id="7257337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7257340">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7257343">type</span>&nbsp;<span class="ident" id="7257348">row</span>&nbsp;<span class="keyword" id="7257352">struct</span>&nbsp;<span class="op" id="7257359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7257363">age</span>&nbsp;&nbsp;<span class="builtintype" id="7257368">int</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7257374">name</span>&nbsp;<span class="builtintype" id="7257379">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7257387">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7257390">got</span>&nbsp;<span class="op" id="7257394">:=</span>&nbsp;<span class="op" id="7257397">[</span><span class="op" id="7257398">]</span><span class="ident" id="7257399">row</span><span class="op" id="7257402">{</span><span class="op" id="7257403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7257406">for</span>&nbsp;<span class="ident" id="7257410">rows</span><span class="op" id="7257414">.</span><span class="ident" id="7257415">Next</span><span class="op" id="7257419">(</span><span class="op" id="7257420">)</span>&nbsp;<span class="op" id="7257422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7257426">var</span>&nbsp;<span class="ident" id="7257430">r</span>&nbsp;<span class="ident" id="7257432">row</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7257438">err</span>&nbsp;<span class="op" id="7257442">=</span>&nbsp;<span class="ident" id="7257444">rows</span><span class="op" id="7257448">.</span><span class="ident" id="7257449">Scan</span><span class="op" id="7257453">(</span><span class="op" id="7257454">&amp;</span><span class="ident" id="7257455">r</span><span class="op" id="7257456">.</span><span class="ident" id="7257457">age</span><span class="op" id="7257460">,</span>&nbsp;<span class="op" id="7257462">&amp;</span><span class="ident" id="7257463">r</span><span class="op" id="7257464">.</span><span class="ident" id="7257465">name</span><span class="op" id="7257469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7257473">if</span>&nbsp;<span class="ident" id="7257476">err</span>&nbsp;<span class="op" id="7257480">!=</span>&nbsp;<span class="ident" id="7257483">nil</span>&nbsp;<span class="op" id="7257487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7257492">t</span><span class="op" id="7257493">.</span><span class="ident" id="7257494">Fatalf</span><span class="op" id="7257500">(</span><span class="string" id="7257501">&#34;Scan:&nbsp;%v&#34;</span><span class="op" id="7257511">,</span>&nbsp;<span class="ident" id="7257513">err</span><span class="op" id="7257516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7257520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7257524">got</span>&nbsp;<span class="op" id="7257528">=</span>&nbsp;<span class="builtinfunc" id="7257530">append</span><span class="op" id="7257536">(</span><span class="ident" id="7257537">got</span><span class="op" id="7257540">,</span>&nbsp;<span class="ident" id="7257542">r</span><span class="op" id="7257543">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7257546">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7257549">err</span>&nbsp;<span class="op" id="7257553">=</span>&nbsp;<span class="ident" id="7257555">rows</span><span class="op" id="7257559">.</span><span class="ident" id="7257560">Err</span><span class="op" id="7257563">(</span><span class="op" id="7257564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7257567">if</span>&nbsp;<span class="ident" id="7257570">err</span>&nbsp;<span class="op" id="7257574">!=</span>&nbsp;<span class="ident" id="7257577">nil</span>&nbsp;<span class="op" id="7257581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7257585">t</span><span class="op" id="7257586">.</span><span class="ident" id="7257587">Fatalf</span><span class="op" id="7257593">(</span><span class="string" id="7257594">&#34;Err:&nbsp;%v&#34;</span><span class="op" id="7257603">,</span>&nbsp;<span class="ident" id="7257605">err</span><span class="op" id="7257608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7257611">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7257614">want</span>&nbsp;<span class="op" id="7257619">:=</span>&nbsp;<span class="op" id="7257622">[</span><span class="op" id="7257623">]</span><span class="ident" id="7257624">row</span><span class="op" id="7257627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7257631">{</span><span class="ident" id="7257632">age</span><span class="op" id="7257635">:</span>&nbsp;<span class="num" id="7257637">1</span><span class="op" id="7257638">,</span>&nbsp;<span class="ident" id="7257640">name</span><span class="op" id="7257644">:</span>&nbsp;<span class="string" id="7257646">&#34;Alice&#34;</span><span class="op" id="7257653">}</span><span class="op" id="7257654">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7257658">{</span><span class="ident" id="7257659">age</span><span class="op" id="7257662">:</span>&nbsp;<span class="num" id="7257664">2</span><span class="op" id="7257665">,</span>&nbsp;<span class="ident" id="7257667">name</span><span class="op" id="7257671">:</span>&nbsp;<span class="string" id="7257673">&#34;Bob&#34;</span><span class="op" id="7257678">}</span><span class="op" id="7257679">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7257683">{</span><span class="ident" id="7257684">age</span><span class="op" id="7257687">:</span>&nbsp;<span class="num" id="7257689">3</span><span class="op" id="7257690">,</span>&nbsp;<span class="ident" id="7257692">name</span><span class="op" id="7257696">:</span>&nbsp;<span class="string" id="7257698">&#34;Chris&#34;</span><span class="op" id="7257705">}</span><span class="op" id="7257706">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7257709">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7257712">if</span>&nbsp;<span class="op" id="7257715">!</span><span class="ident" id="7257716">reflect</span><span class="op" id="7257723">.</span><span class="ident" id="7257724">DeepEqual</span><span class="op" id="7257733">(</span><span class="ident" id="7257734">got</span><span class="op" id="7257737">,</span>&nbsp;<span class="ident" id="7257739">want</span><span class="op" id="7257743">)</span>&nbsp;<span class="op" id="7257745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7257749">t</span><span class="op" id="7257750">.</span><span class="ident" id="7257751">Errorf</span><span class="op" id="7257757">(</span><span class="string" id="7257758">&#34;mismatch.\n&nbsp;got:&nbsp;%#v\nwant:&nbsp;%#v&#34;</span><span class="op" id="7257791">,</span>&nbsp;<span class="ident" id="7257793">got</span><span class="op" id="7257796">,</span>&nbsp;<span class="ident" id="7257798">want</span><span class="op" id="7257802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7257805">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7257809">//&nbsp;And&nbsp;verify&nbsp;that&nbsp;the&nbsp;final&nbsp;rows.Next()&nbsp;call,&nbsp;which&nbsp;hit&nbsp;EOF,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7257872">//&nbsp;also&nbsp;closed&nbsp;the&nbsp;rows&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7257909">if</span>&nbsp;<span class="ident" id="7257912">n</span>&nbsp;<span class="op" id="7257914">:=</span>&nbsp;<span class="ident" id="7257917">db</span><span class="op" id="7257919">.</span><span class="ident" id="7257920">numFreeConns</span><span class="op" id="7257932">(</span><span class="op" id="7257933">)</span><span class="op" id="7257934">;</span>&nbsp;<span class="ident" id="7257936">n</span>&nbsp;<span class="op" id="7257938">!=</span>&nbsp;<span class="num" id="7257941">1</span>&nbsp;<span class="op" id="7257943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7257947">t</span><span class="op" id="7257948">.</span><span class="ident" id="7257949">Fatalf</span><span class="op" id="7257955">(</span><span class="string" id="7257956">&#34;free&nbsp;conns&nbsp;after&nbsp;query&nbsp;hitting&nbsp;EOF&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="7258005">,</span>&nbsp;<span class="ident" id="7258007">n</span><span class="op" id="7258008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7258011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7258014">if</span>&nbsp;<span class="ident" id="7258017">prepares</span>&nbsp;<span class="op" id="7258026">:=</span>&nbsp;<span class="ident" id="7258029">numPrepares</span><span class="op" id="7258040">(</span><span class="ident" id="7258041">t</span><span class="op" id="7258042">,</span>&nbsp;<span class="ident" id="7258044">db</span><span class="op" id="7258046">)</span>&nbsp;<span class="op" id="7258048">-</span>&nbsp;<span class="ident" id="7258050">prepares0</span><span class="op" id="7258059">;</span>&nbsp;<span class="ident" id="7258061">prepares</span>&nbsp;<span class="op" id="7258070">!=</span>&nbsp;<span class="num" id="7258073">1</span>&nbsp;<span class="op" id="7258075">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7258079">t</span><span class="op" id="7258080">.</span><span class="ident" id="7258081">Errorf</span><span class="op" id="7258087">(</span><span class="string" id="7258088">&#34;executed&nbsp;%d&nbsp;Prepare&nbsp;statements;&nbsp;want&nbsp;1&#34;</span><span class="op" id="7258128">,</span>&nbsp;<span class="ident" id="7258130">prepares</span><span class="op" id="7258138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7258141">}</span><br>
<span class="lineno"></span><span class="op" id="7258143">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7258146">func</span>&nbsp;<span class="ident" id="7258151">TestByteOwnership</span><span class="op" id="7258168">(</span><span class="ident" id="7258169">t</span>&nbsp;<span class="op" id="7258171">*</span><span class="ident" id="7258172">testing</span><span class="op" id="7258179">.</span><span class="ident" id="7258180">T</span><span class="op" id="7258181">)</span>&nbsp;<span class="op" id="7258183">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7258186">db</span>&nbsp;<span class="op" id="7258189">:=</span>&nbsp;<span class="ident" id="7258192">newTestDB</span><span class="op" id="7258201">(</span><span class="ident" id="7258202">t</span><span class="op" id="7258203">,</span>&nbsp;<span class="string" id="7258205">&#34;people&#34;</span><span class="op" id="7258213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7258216">defer</span>&nbsp;<span class="ident" id="7258222">closeDB</span><span class="op" id="7258229">(</span><span class="ident" id="7258230">t</span><span class="op" id="7258231">,</span>&nbsp;<span class="ident" id="7258233">db</span><span class="op" id="7258235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7258238">rows</span><span class="op" id="7258242">,</span>&nbsp;<span class="ident" id="7258244">err</span>&nbsp;<span class="op" id="7258248">:=</span>&nbsp;<span class="ident" id="7258251">db</span><span class="op" id="7258253">.</span><span class="ident" id="7258254">Query</span><span class="op" id="7258259">(</span><span class="string" id="7258260">&#34;SELECT|people|name,photo|&#34;</span><span class="op" id="7258287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7258290">if</span>&nbsp;<span class="ident" id="7258293">err</span>&nbsp;<span class="op" id="7258297">!=</span>&nbsp;<span class="ident" id="7258300">nil</span>&nbsp;<span class="op" id="7258304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7258308">t</span><span class="op" id="7258309">.</span><span class="ident" id="7258310">Fatalf</span><span class="op" id="7258316">(</span><span class="string" id="7258317">&#34;Query:&nbsp;%v&#34;</span><span class="op" id="7258328">,</span>&nbsp;<span class="ident" id="7258330">err</span><span class="op" id="7258333">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7258336">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7258339">type</span>&nbsp;<span class="ident" id="7258344">row</span>&nbsp;<span class="keyword" id="7258348">struct</span>&nbsp;<span class="op" id="7258355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7258359">name</span>&nbsp;&nbsp;<span class="op" id="7258365">[</span><span class="op" id="7258366">]</span><span class="builtintype" id="7258367">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7258374">photo</span>&nbsp;<span class="ident" id="7258380">RawBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7258390">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7258393">got</span>&nbsp;<span class="op" id="7258397">:=</span>&nbsp;<span class="op" id="7258400">[</span><span class="op" id="7258401">]</span><span class="ident" id="7258402">row</span><span class="op" id="7258405">{</span><span class="op" id="7258406">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7258409">for</span>&nbsp;<span class="ident" id="7258413">rows</span><span class="op" id="7258417">.</span><span class="ident" id="7258418">Next</span><span class="op" id="7258422">(</span><span class="op" id="7258423">)</span>&nbsp;<span class="op" id="7258425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7258429">var</span>&nbsp;<span class="ident" id="7258433">r</span>&nbsp;<span class="ident" id="7258435">row</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7258441">err</span>&nbsp;<span class="op" id="7258445">=</span>&nbsp;<span class="ident" id="7258447">rows</span><span class="op" id="7258451">.</span><span class="ident" id="7258452">Scan</span><span class="op" id="7258456">(</span><span class="op" id="7258457">&amp;</span><span class="ident" id="7258458">r</span><span class="op" id="7258459">.</span><span class="ident" id="7258460">name</span><span class="op" id="7258464">,</span>&nbsp;<span class="op" id="7258466">&amp;</span><span class="ident" id="7258467">r</span><span class="op" id="7258468">.</span><span class="ident" id="7258469">photo</span><span class="op" id="7258474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7258478">if</span>&nbsp;<span class="ident" id="7258481">err</span>&nbsp;<span class="op" id="7258485">!=</span>&nbsp;<span class="ident" id="7258488">nil</span>&nbsp;<span class="op" id="7258492">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7258497">t</span><span class="op" id="7258498">.</span><span class="ident" id="7258499">Fatalf</span><span class="op" id="7258505">(</span><span class="string" id="7258506">&#34;Scan:&nbsp;%v&#34;</span><span class="op" id="7258516">,</span>&nbsp;<span class="ident" id="7258518">err</span><span class="op" id="7258521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7258525">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7258529">got</span>&nbsp;<span class="op" id="7258533">=</span>&nbsp;<span class="builtinfunc" id="7258535">append</span><span class="op" id="7258541">(</span><span class="ident" id="7258542">got</span><span class="op" id="7258545">,</span>&nbsp;<span class="ident" id="7258547">r</span><span class="op" id="7258548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7258551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7258554">corruptMemory</span>&nbsp;<span class="op" id="7258568">:=</span>&nbsp;<span class="op" id="7258571">[</span><span class="op" id="7258572">]</span><span class="builtintype" id="7258573">byte</span><span class="op" id="7258577">(</span><span class="string" id="7258578">&#34;\xffPHOTO&#34;</span><span class="op" id="7258589">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7258592">want</span>&nbsp;<span class="op" id="7258597">:=</span>&nbsp;<span class="op" id="7258600">[</span><span class="op" id="7258601">]</span><span class="ident" id="7258602">row</span><span class="op" id="7258605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7258609">{</span><span class="ident" id="7258610">name</span><span class="op" id="7258614">:</span>&nbsp;<span class="op" id="7258616">[</span><span class="op" id="7258617">]</span><span class="builtintype" id="7258618">byte</span><span class="op" id="7258622">(</span><span class="string" id="7258623">&#34;Alice&#34;</span><span class="op" id="7258630">)</span><span class="op" id="7258631">,</span>&nbsp;<span class="ident" id="7258633">photo</span><span class="op" id="7258638">:</span>&nbsp;<span class="ident" id="7258640">corruptMemory</span><span class="op" id="7258653">}</span><span class="op" id="7258654">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7258658">{</span><span class="ident" id="7258659">name</span><span class="op" id="7258663">:</span>&nbsp;<span class="op" id="7258665">[</span><span class="op" id="7258666">]</span><span class="builtintype" id="7258667">byte</span><span class="op" id="7258671">(</span><span class="string" id="7258672">&#34;Bob&#34;</span><span class="op" id="7258677">)</span><span class="op" id="7258678">,</span>&nbsp;<span class="ident" id="7258680">photo</span><span class="op" id="7258685">:</span>&nbsp;<span class="ident" id="7258687">corruptMemory</span><span class="op" id="7258700">}</span><span class="op" id="7258701">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7258705">{</span><span class="ident" id="7258706">name</span><span class="op" id="7258710">:</span>&nbsp;<span class="op" id="7258712">[</span><span class="op" id="7258713">]</span><span class="builtintype" id="7258714">byte</span><span class="op" id="7258718">(</span><span class="string" id="7258719">&#34;Chris&#34;</span><span class="op" id="7258726">)</span><span class="op" id="7258727">,</span>&nbsp;<span class="ident" id="7258729">photo</span><span class="op" id="7258734">:</span>&nbsp;<span class="ident" id="7258736">corruptMemory</span><span class="op" id="7258749">}</span><span class="op" id="7258750">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7258753">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7258756">if</span>&nbsp;<span class="op" id="7258759">!</span><span class="ident" id="7258760">reflect</span><span class="op" id="7258767">.</span><span class="ident" id="7258768">DeepEqual</span><span class="op" id="7258777">(</span><span class="ident" id="7258778">got</span><span class="op" id="7258781">,</span>&nbsp;<span class="ident" id="7258783">want</span><span class="op" id="7258787">)</span>&nbsp;<span class="op" id="7258789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7258793">t</span><span class="op" id="7258794">.</span><span class="ident" id="7258795">Errorf</span><span class="op" id="7258801">(</span><span class="string" id="7258802">&#34;mismatch.\n&nbsp;got:&nbsp;%#v\nwant:&nbsp;%#v&#34;</span><span class="op" id="7258835">,</span>&nbsp;<span class="ident" id="7258837">got</span><span class="op" id="7258840">,</span>&nbsp;<span class="ident" id="7258842">want</span><span class="op" id="7258846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7258849">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7258853">var</span>&nbsp;<span class="ident" id="7258857">photo</span>&nbsp;<span class="ident" id="7258863">RawBytes</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7258873">err</span>&nbsp;<span class="op" id="7258877">=</span>&nbsp;<span class="ident" id="7258879">db</span><span class="op" id="7258881">.</span><span class="ident" id="7258882">QueryRow</span><span class="op" id="7258890">(</span><span class="string" id="7258891">&#34;SELECT|people|photo|name=?&#34;</span><span class="op" id="7258919">,</span>&nbsp;<span class="string" id="7258921">&#34;Alice&#34;</span><span class="op" id="7258928">)</span><span class="op" id="7258929">.</span><span class="ident" id="7258930">Scan</span><span class="op" id="7258934">(</span><span class="op" id="7258935">&amp;</span><span class="ident" id="7258936">photo</span><span class="op" id="7258941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7258944">if</span>&nbsp;<span class="ident" id="7258947">err</span>&nbsp;<span class="op" id="7258951">==</span>&nbsp;<span class="ident" id="7258954">nil</span>&nbsp;<span class="op" id="7258958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7258962">t</span><span class="op" id="7258963">.</span><span class="ident" id="7258964">Error</span><span class="op" id="7258969">(</span><span class="string" id="7258970">&#34;want&nbsp;error&nbsp;scanning&nbsp;into&nbsp;RawBytes&nbsp;from&nbsp;QueryRow&#34;</span><span class="op" id="7259019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7259022">}</span><br>
<span class="lineno"></span><span class="op" id="7259024">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span><span class="keyword" id="7259027">func</span>&nbsp;<span class="ident" id="7259032">TestRowsColumns</span><span class="op" id="7259047">(</span><span class="ident" id="7259048">t</span>&nbsp;<span class="op" id="7259050">*</span><span class="ident" id="7259051">testing</span><span class="op" id="7259058">.</span><span class="ident" id="7259059">T</span><span class="op" id="7259060">)</span>&nbsp;<span class="op" id="7259062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7259065">db</span>&nbsp;<span class="op" id="7259068">:=</span>&nbsp;<span class="ident" id="7259071">newTestDB</span><span class="op" id="7259080">(</span><span class="ident" id="7259081">t</span><span class="op" id="7259082">,</span>&nbsp;<span class="string" id="7259084">&#34;people&#34;</span><span class="op" id="7259092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7259095">defer</span>&nbsp;<span class="ident" id="7259101">closeDB</span><span class="op" id="7259108">(</span><span class="ident" id="7259109">t</span><span class="op" id="7259110">,</span>&nbsp;<span class="ident" id="7259112">db</span><span class="op" id="7259114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7259117">rows</span><span class="op" id="7259121">,</span>&nbsp;<span class="ident" id="7259123">err</span>&nbsp;<span class="op" id="7259127">:=</span>&nbsp;<span class="ident" id="7259130">db</span><span class="op" id="7259132">.</span><span class="ident" id="7259133">Query</span><span class="op" id="7259138">(</span><span class="string" id="7259139">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="7259164">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7259167">if</span>&nbsp;<span class="ident" id="7259170">err</span>&nbsp;<span class="op" id="7259174">!=</span>&nbsp;<span class="ident" id="7259177">nil</span>&nbsp;<span class="op" id="7259181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7259185">t</span><span class="op" id="7259186">.</span><span class="ident" id="7259187">Fatalf</span><span class="op" id="7259193">(</span><span class="string" id="7259194">&#34;Query:&nbsp;%v&#34;</span><span class="op" id="7259205">,</span>&nbsp;<span class="ident" id="7259207">err</span><span class="op" id="7259210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7259213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7259216">cols</span><span class="op" id="7259220">,</span>&nbsp;<span class="ident" id="7259222">err</span>&nbsp;<span class="op" id="7259226">:=</span>&nbsp;<span class="ident" id="7259229">rows</span><span class="op" id="7259233">.</span><span class="ident" id="7259234">Columns</span><span class="op" id="7259241">(</span><span class="op" id="7259242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7259245">if</span>&nbsp;<span class="ident" id="7259248">err</span>&nbsp;<span class="op" id="7259252">!=</span>&nbsp;<span class="ident" id="7259255">nil</span>&nbsp;<span class="op" id="7259259">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7259263">t</span><span class="op" id="7259264">.</span><span class="ident" id="7259265">Fatalf</span><span class="op" id="7259271">(</span><span class="string" id="7259272">&#34;Columns:&nbsp;%v&#34;</span><span class="op" id="7259285">,</span>&nbsp;<span class="ident" id="7259287">err</span><span class="op" id="7259290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7259293">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7259296">want</span>&nbsp;<span class="op" id="7259301">:=</span>&nbsp;<span class="op" id="7259304">[</span><span class="op" id="7259305">]</span><span class="builtintype" id="7259306">string</span><span class="op" id="7259312">{</span><span class="string" id="7259313">&#34;age&#34;</span><span class="op" id="7259318">,</span>&nbsp;<span class="string" id="7259320">&#34;name&#34;</span><span class="op" id="7259326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7259329">if</span>&nbsp;<span class="op" id="7259332">!</span><span class="ident" id="7259333">reflect</span><span class="op" id="7259340">.</span><span class="ident" id="7259341">DeepEqual</span><span class="op" id="7259350">(</span><span class="ident" id="7259351">cols</span><span class="op" id="7259355">,</span>&nbsp;<span class="ident" id="7259357">want</span><span class="op" id="7259361">)</span>&nbsp;<span class="op" id="7259363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7259367">t</span><span class="op" id="7259368">.</span><span class="ident" id="7259369">Errorf</span><span class="op" id="7259375">(</span><span class="string" id="7259376">&#34;got&nbsp;%#v;&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="7259395">,</span>&nbsp;<span class="ident" id="7259397">cols</span><span class="op" id="7259401">,</span>&nbsp;<span class="ident" id="7259403">want</span><span class="op" id="7259407">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7259410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7259413">if</span>&nbsp;<span class="ident" id="7259416">err</span>&nbsp;<span class="op" id="7259420">:=</span>&nbsp;<span class="ident" id="7259423">rows</span><span class="op" id="7259427">.</span><span class="ident" id="7259428">Close</span><span class="op" id="7259433">(</span><span class="op" id="7259434">)</span><span class="op" id="7259435">;</span>&nbsp;<span class="ident" id="7259437">err</span>&nbsp;<span class="op" id="7259441">!=</span>&nbsp;<span class="ident" id="7259444">nil</span>&nbsp;<span class="op" id="7259448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7259452">t</span><span class="op" id="7259453">.</span><span class="ident" id="7259454">Errorf</span><span class="op" id="7259460">(</span><span class="string" id="7259461">&#34;error&nbsp;closing&nbsp;rows:&nbsp;%s&#34;</span><span class="op" id="7259485">,</span>&nbsp;<span class="ident" id="7259487">err</span><span class="op" id="7259490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7259493">}</span><br>
<span class="lineno"></span><span class="op" id="7259495">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="7259498">func</span>&nbsp;<span class="ident" id="7259503">TestQueryRow</span><span class="op" id="7259515">(</span><span class="ident" id="7259516">t</span>&nbsp;<span class="op" id="7259518">*</span><span class="ident" id="7259519">testing</span><span class="op" id="7259526">.</span><span class="ident" id="7259527">T</span><span class="op" id="7259528">)</span>&nbsp;<span class="op" id="7259530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7259533">db</span>&nbsp;<span class="op" id="7259536">:=</span>&nbsp;<span class="ident" id="7259539">newTestDB</span><span class="op" id="7259548">(</span><span class="ident" id="7259549">t</span><span class="op" id="7259550">,</span>&nbsp;<span class="string" id="7259552">&#34;people&#34;</span><span class="op" id="7259560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7259563">defer</span>&nbsp;<span class="ident" id="7259569">closeDB</span><span class="op" id="7259576">(</span><span class="ident" id="7259577">t</span><span class="op" id="7259578">,</span>&nbsp;<span class="ident" id="7259580">db</span><span class="op" id="7259582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7259585">var</span>&nbsp;<span class="ident" id="7259589">name</span>&nbsp;<span class="builtintype" id="7259594">string</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7259602">var</span>&nbsp;<span class="ident" id="7259606">age</span>&nbsp;<span class="builtintype" id="7259610">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7259615">var</span>&nbsp;<span class="ident" id="7259619">birthday</span>&nbsp;<span class="ident" id="7259628">time</span><span class="op" id="7259632">.</span><span class="ident" id="7259633">Time</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7259640">err</span>&nbsp;<span class="op" id="7259644">:=</span>&nbsp;<span class="ident" id="7259647">db</span><span class="op" id="7259649">.</span><span class="ident" id="7259650">QueryRow</span><span class="op" id="7259658">(</span><span class="string" id="7259659">&#34;SELECT|people|age,name|age=?&#34;</span><span class="op" id="7259689">,</span>&nbsp;<span class="num" id="7259691">3</span><span class="op" id="7259692">)</span><span class="op" id="7259693">.</span><span class="ident" id="7259694">Scan</span><span class="op" id="7259698">(</span><span class="op" id="7259699">&amp;</span><span class="ident" id="7259700">age</span><span class="op" id="7259703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7259706">if</span>&nbsp;<span class="ident" id="7259709">err</span>&nbsp;<span class="op" id="7259713">==</span>&nbsp;<span class="ident" id="7259716">nil</span>&nbsp;<span class="op" id="7259720">||</span>&nbsp;<span class="op" id="7259723">!</span><span class="ident" id="7259724">strings</span><span class="op" id="7259731">.</span><span class="ident" id="7259732">Contains</span><span class="op" id="7259740">(</span><span class="ident" id="7259741">err</span><span class="op" id="7259744">.</span><span class="ident" id="7259745">Error</span><span class="op" id="7259750">(</span><span class="op" id="7259751">)</span><span class="op" id="7259752">,</span>&nbsp;<span class="string" id="7259754">&#34;expected&nbsp;2&nbsp;destination&nbsp;arguments&#34;</span><span class="op" id="7259788">)</span>&nbsp;<span class="op" id="7259790">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7259794">t</span><span class="op" id="7259795">.</span><span class="ident" id="7259796">Errorf</span><span class="op" id="7259802">(</span><span class="string" id="7259803">&#34;expected&nbsp;error&nbsp;from&nbsp;wrong&nbsp;number&nbsp;of&nbsp;arguments;&nbsp;actually&nbsp;got:&nbsp;%v&#34;</span><span class="op" id="7259868">,</span>&nbsp;<span class="ident" id="7259870">err</span><span class="op" id="7259873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7259876">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7259880">err</span>&nbsp;<span class="op" id="7259884">=</span>&nbsp;<span class="ident" id="7259886">db</span><span class="op" id="7259888">.</span><span class="ident" id="7259889">QueryRow</span><span class="op" id="7259897">(</span><span class="string" id="7259898">&#34;SELECT|people|bdate|age=?&#34;</span><span class="op" id="7259925">,</span>&nbsp;<span class="num" id="7259927">3</span><span class="op" id="7259928">)</span><span class="op" id="7259929">.</span><span class="ident" id="7259930">Scan</span><span class="op" id="7259934">(</span><span class="op" id="7259935">&amp;</span><span class="ident" id="7259936">birthday</span><span class="op" id="7259944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7259947">if</span>&nbsp;<span class="ident" id="7259950">err</span>&nbsp;<span class="op" id="7259954">!=</span>&nbsp;<span class="ident" id="7259957">nil</span>&nbsp;<span class="op" id="7259961">||</span>&nbsp;<span class="op" id="7259964">!</span><span class="ident" id="7259965">birthday</span><span class="op" id="7259973">.</span><span class="ident" id="7259974">Equal</span><span class="op" id="7259979">(</span><span class="ident" id="7259980">chrisBirthday</span><span class="op" id="7259993">)</span>&nbsp;<span class="op" id="7259995">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7259999">t</span><span class="op" id="7260000">.</span><span class="ident" id="7260001">Errorf</span><span class="op" id="7260007">(</span><span class="string" id="7260008">&#34;chris&nbsp;birthday&nbsp;=&nbsp;%v,&nbsp;err&nbsp;=&nbsp;%v;&nbsp;want&nbsp;%v&#34;</span><span class="op" id="7260048">,</span>&nbsp;<span class="ident" id="7260050">birthday</span><span class="op" id="7260058">,</span>&nbsp;<span class="ident" id="7260060">err</span><span class="op" id="7260063">,</span>&nbsp;<span class="ident" id="7260065">chrisBirthday</span><span class="op" id="7260078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7260081">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7260085">err</span>&nbsp;<span class="op" id="7260089">=</span>&nbsp;<span class="ident" id="7260091">db</span><span class="op" id="7260093">.</span><span class="ident" id="7260094">QueryRow</span><span class="op" id="7260102">(</span><span class="string" id="7260103">&#34;SELECT|people|age,name|age=?&#34;</span><span class="op" id="7260133">,</span>&nbsp;<span class="num" id="7260135">2</span><span class="op" id="7260136">)</span><span class="op" id="7260137">.</span><span class="ident" id="7260138">Scan</span><span class="op" id="7260142">(</span><span class="op" id="7260143">&amp;</span><span class="ident" id="7260144">age</span><span class="op" id="7260147">,</span>&nbsp;<span class="op" id="7260149">&amp;</span><span class="ident" id="7260150">name</span><span class="op" id="7260154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7260157">if</span>&nbsp;<span class="ident" id="7260160">err</span>&nbsp;<span class="op" id="7260164">!=</span>&nbsp;<span class="ident" id="7260167">nil</span>&nbsp;<span class="op" id="7260171">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7260175">t</span><span class="op" id="7260176">.</span><span class="ident" id="7260177">Fatalf</span><span class="op" id="7260183">(</span><span class="string" id="7260184">&#34;age&nbsp;QueryRow+Scan:&nbsp;%v&#34;</span><span class="op" id="7260207">,</span>&nbsp;<span class="ident" id="7260209">err</span><span class="op" id="7260212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7260215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7260218">if</span>&nbsp;<span class="ident" id="7260221">name</span>&nbsp;<span class="op" id="7260226">!=</span>&nbsp;<span class="string" id="7260229">&#34;Bob&#34;</span>&nbsp;<span class="op" id="7260235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7260239">t</span><span class="op" id="7260240">.</span><span class="ident" id="7260241">Errorf</span><span class="op" id="7260247">(</span><span class="string" id="7260248">&#34;expected&nbsp;name&nbsp;Bob,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="7260275">,</span>&nbsp;<span class="ident" id="7260277">name</span><span class="op" id="7260281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7260284">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7260287">if</span>&nbsp;<span class="ident" id="7260290">age</span>&nbsp;<span class="op" id="7260294">!=</span>&nbsp;<span class="num" id="7260297">2</span>&nbsp;<span class="op" id="7260299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7260303">t</span><span class="op" id="7260304">.</span><span class="ident" id="7260305">Errorf</span><span class="op" id="7260311">(</span><span class="string" id="7260312">&#34;expected&nbsp;age&nbsp;2,&nbsp;got&nbsp;%d&#34;</span><span class="op" id="7260336">,</span>&nbsp;<span class="ident" id="7260338">age</span><span class="op" id="7260341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7260344">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7260348">err</span>&nbsp;<span class="op" id="7260352">=</span>&nbsp;<span class="ident" id="7260354">db</span><span class="op" id="7260356">.</span><span class="ident" id="7260357">QueryRow</span><span class="op" id="7260365">(</span><span class="string" id="7260366">&#34;SELECT|people|age,name|name=?&#34;</span><span class="op" id="7260397">,</span>&nbsp;<span class="string" id="7260399">&#34;Alice&#34;</span><span class="op" id="7260406">)</span><span class="op" id="7260407">.</span><span class="ident" id="7260408">Scan</span><span class="op" id="7260412">(</span><span class="op" id="7260413">&amp;</span><span class="ident" id="7260414">age</span><span class="op" id="7260417">,</span>&nbsp;<span class="op" id="7260419">&amp;</span><span class="ident" id="7260420">name</span><span class="op" id="7260424">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7260427">if</span>&nbsp;<span class="ident" id="7260430">err</span>&nbsp;<span class="op" id="7260434">!=</span>&nbsp;<span class="ident" id="7260437">nil</span>&nbsp;<span class="op" id="7260441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7260445">t</span><span class="op" id="7260446">.</span><span class="ident" id="7260447">Fatalf</span><span class="op" id="7260453">(</span><span class="string" id="7260454">&#34;name&nbsp;QueryRow+Scan:&nbsp;%v&#34;</span><span class="op" id="7260478">,</span>&nbsp;<span class="ident" id="7260480">err</span><span class="op" id="7260483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7260486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7260489">if</span>&nbsp;<span class="ident" id="7260492">name</span>&nbsp;<span class="op" id="7260497">!=</span>&nbsp;<span class="string" id="7260500">&#34;Alice&#34;</span>&nbsp;<span class="op" id="7260508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7260512">t</span><span class="op" id="7260513">.</span><span class="ident" id="7260514">Errorf</span><span class="op" id="7260520">(</span><span class="string" id="7260521">&#34;expected&nbsp;name&nbsp;Alice,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="7260550">,</span>&nbsp;<span class="ident" id="7260552">name</span><span class="op" id="7260556">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7260559">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7260562">if</span>&nbsp;<span class="ident" id="7260565">age</span>&nbsp;<span class="op" id="7260569">!=</span>&nbsp;<span class="num" id="7260572">1</span>&nbsp;<span class="op" id="7260574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7260578">t</span><span class="op" id="7260579">.</span><span class="ident" id="7260580">Errorf</span><span class="op" id="7260586">(</span><span class="string" id="7260587">&#34;expected&nbsp;age&nbsp;1,&nbsp;got&nbsp;%d&#34;</span><span class="op" id="7260611">,</span>&nbsp;<span class="ident" id="7260613">age</span><span class="op" id="7260616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7260619">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7260623">var</span>&nbsp;<span class="ident" id="7260627">photo</span>&nbsp;<span class="op" id="7260633">[</span><span class="op" id="7260634">]</span><span class="builtintype" id="7260635">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7260641">err</span>&nbsp;<span class="op" id="7260645">=</span>&nbsp;<span class="ident" id="7260647">db</span><span class="op" id="7260649">.</span><span class="ident" id="7260650">QueryRow</span><span class="op" id="7260658">(</span><span class="string" id="7260659">&#34;SELECT|people|photo|name=?&#34;</span><span class="op" id="7260687">,</span>&nbsp;<span class="string" id="7260689">&#34;Alice&#34;</span><span class="op" id="7260696">)</span><span class="op" id="7260697">.</span><span class="ident" id="7260698">Scan</span><span class="op" id="7260702">(</span><span class="op" id="7260703">&amp;</span><span class="ident" id="7260704">photo</span><span class="op" id="7260709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7260712">if</span>&nbsp;<span class="ident" id="7260715">err</span>&nbsp;<span class="op" id="7260719">!=</span>&nbsp;<span class="ident" id="7260722">nil</span>&nbsp;<span class="op" id="7260726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7260730">t</span><span class="op" id="7260731">.</span><span class="ident" id="7260732">Fatalf</span><span class="op" id="7260738">(</span><span class="string" id="7260739">&#34;photo&nbsp;QueryRow+Scan:&nbsp;%v&#34;</span><span class="op" id="7260764">,</span>&nbsp;<span class="ident" id="7260766">err</span><span class="op" id="7260769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7260772">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7260775">want</span>&nbsp;<span class="op" id="7260780">:=</span>&nbsp;<span class="op" id="7260783">[</span><span class="op" id="7260784">]</span><span class="builtintype" id="7260785">byte</span><span class="op" id="7260789">(</span><span class="string" id="7260790">&#34;APHOTO&#34;</span><span class="op" id="7260798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7260801">if</span>&nbsp;<span class="op" id="7260804">!</span><span class="ident" id="7260805">reflect</span><span class="op" id="7260812">.</span><span class="ident" id="7260813">DeepEqual</span><span class="op" id="7260822">(</span><span class="ident" id="7260823">photo</span><span class="op" id="7260828">,</span>&nbsp;<span class="ident" id="7260830">want</span><span class="op" id="7260834">)</span>&nbsp;<span class="op" id="7260836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7260840">t</span><span class="op" id="7260841">.</span><span class="ident" id="7260842">Errorf</span><span class="op" id="7260848">(</span><span class="string" id="7260849">&#34;photo&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7260870">,</span>&nbsp;<span class="ident" id="7260872">photo</span><span class="op" id="7260877">,</span>&nbsp;<span class="ident" id="7260879">want</span><span class="op" id="7260883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7260886">}</span><br>
<span class="lineno"></span><span class="op" id="7260888">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span><span class="keyword" id="7260891">func</span>&nbsp;<span class="ident" id="7260896">TestStatementErrorAfterClose</span><span class="op" id="7260924">(</span><span class="ident" id="7260925">t</span>&nbsp;<span class="op" id="7260927">*</span><span class="ident" id="7260928">testing</span><span class="op" id="7260935">.</span><span class="ident" id="7260936">T</span><span class="op" id="7260937">)</span>&nbsp;<span class="op" id="7260939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7260942">db</span>&nbsp;<span class="op" id="7260945">:=</span>&nbsp;<span class="ident" id="7260948">newTestDB</span><span class="op" id="7260957">(</span><span class="ident" id="7260958">t</span><span class="op" id="7260959">,</span>&nbsp;<span class="string" id="7260961">&#34;people&#34;</span><span class="op" id="7260969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7260972">defer</span>&nbsp;<span class="ident" id="7260978">closeDB</span><span class="op" id="7260985">(</span><span class="ident" id="7260986">t</span><span class="op" id="7260987">,</span>&nbsp;<span class="ident" id="7260989">db</span><span class="op" id="7260991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7260994">stmt</span><span class="op" id="7260998">,</span>&nbsp;<span class="ident" id="7261000">err</span>&nbsp;<span class="op" id="7261004">:=</span>&nbsp;<span class="ident" id="7261007">db</span><span class="op" id="7261009">.</span><span class="ident" id="7261010">Prepare</span><span class="op" id="7261017">(</span><span class="string" id="7261018">&#34;SELECT|people|age|name=?&#34;</span><span class="op" id="7261044">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7261047">if</span>&nbsp;<span class="ident" id="7261050">err</span>&nbsp;<span class="op" id="7261054">!=</span>&nbsp;<span class="ident" id="7261057">nil</span>&nbsp;<span class="op" id="7261061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7261065">t</span><span class="op" id="7261066">.</span><span class="ident" id="7261067">Fatalf</span><span class="op" id="7261073">(</span><span class="string" id="7261074">&#34;Prepare:&nbsp;%v&#34;</span><span class="op" id="7261087">,</span>&nbsp;<span class="ident" id="7261089">err</span><span class="op" id="7261092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7261095">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7261098">err</span>&nbsp;<span class="op" id="7261102">=</span>&nbsp;<span class="ident" id="7261104">stmt</span><span class="op" id="7261108">.</span><span class="ident" id="7261109">Close</span><span class="op" id="7261114">(</span><span class="op" id="7261115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7261118">if</span>&nbsp;<span class="ident" id="7261121">err</span>&nbsp;<span class="op" id="7261125">!=</span>&nbsp;<span class="ident" id="7261128">nil</span>&nbsp;<span class="op" id="7261132">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7261136">t</span><span class="op" id="7261137">.</span><span class="ident" id="7261138">Fatalf</span><span class="op" id="7261144">(</span><span class="string" id="7261145">&#34;Close:&nbsp;%v&#34;</span><span class="op" id="7261156">,</span>&nbsp;<span class="ident" id="7261158">err</span><span class="op" id="7261161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7261164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7261167">var</span>&nbsp;<span class="ident" id="7261171">name</span>&nbsp;<span class="builtintype" id="7261176">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7261184">err</span>&nbsp;<span class="op" id="7261188">=</span>&nbsp;<span class="ident" id="7261190">stmt</span><span class="op" id="7261194">.</span><span class="ident" id="7261195">QueryRow</span><span class="op" id="7261203">(</span><span class="string" id="7261204">&#34;foo&#34;</span><span class="op" id="7261209">)</span><span class="op" id="7261210">.</span><span class="ident" id="7261211">Scan</span><span class="op" id="7261215">(</span><span class="op" id="7261216">&amp;</span><span class="ident" id="7261217">name</span><span class="op" id="7261221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7261224">if</span>&nbsp;<span class="ident" id="7261227">err</span>&nbsp;<span class="op" id="7261231">==</span>&nbsp;<span class="ident" id="7261234">nil</span>&nbsp;<span class="op" id="7261238">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7261242">t</span><span class="op" id="7261243">.</span><span class="ident" id="7261244">Errorf</span><span class="op" id="7261250">(</span><span class="string" id="7261251">&#34;expected&nbsp;error&nbsp;from&nbsp;QueryRow.Scan&nbsp;after&nbsp;Stmt.Close&#34;</span><span class="op" id="7261303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7261306">}</span><br>
<span class="lineno"></span><span class="op" id="7261308">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7261311">func</span>&nbsp;<span class="ident" id="7261316">TestStatementQueryRow</span><span class="op" id="7261337">(</span><span class="ident" id="7261338">t</span>&nbsp;<span class="op" id="7261340">*</span><span class="ident" id="7261341">testing</span><span class="op" id="7261348">.</span><span class="ident" id="7261349">T</span><span class="op" id="7261350">)</span>&nbsp;<span class="op" id="7261352">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7261355">db</span>&nbsp;<span class="op" id="7261358">:=</span>&nbsp;<span class="ident" id="7261361">newTestDB</span><span class="op" id="7261370">(</span><span class="ident" id="7261371">t</span><span class="op" id="7261372">,</span>&nbsp;<span class="string" id="7261374">&#34;people&#34;</span><span class="op" id="7261382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7261385">defer</span>&nbsp;<span class="ident" id="7261391">closeDB</span><span class="op" id="7261398">(</span><span class="ident" id="7261399">t</span><span class="op" id="7261400">,</span>&nbsp;<span class="ident" id="7261402">db</span><span class="op" id="7261404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7261407">stmt</span><span class="op" id="7261411">,</span>&nbsp;<span class="ident" id="7261413">err</span>&nbsp;<span class="op" id="7261417">:=</span>&nbsp;<span class="ident" id="7261420">db</span><span class="op" id="7261422">.</span><span class="ident" id="7261423">Prepare</span><span class="op" id="7261430">(</span><span class="string" id="7261431">&#34;SELECT|people|age|name=?&#34;</span><span class="op" id="7261457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7261460">if</span>&nbsp;<span class="ident" id="7261463">err</span>&nbsp;<span class="op" id="7261467">!=</span>&nbsp;<span class="ident" id="7261470">nil</span>&nbsp;<span class="op" id="7261474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7261478">t</span><span class="op" id="7261479">.</span><span class="ident" id="7261480">Fatalf</span><span class="op" id="7261486">(</span><span class="string" id="7261487">&#34;Prepare:&nbsp;%v&#34;</span><span class="op" id="7261500">,</span>&nbsp;<span class="ident" id="7261502">err</span><span class="op" id="7261505">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7261508">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7261511">defer</span>&nbsp;<span class="ident" id="7261517">stmt</span><span class="op" id="7261521">.</span><span class="ident" id="7261522">Close</span><span class="op" id="7261527">(</span><span class="op" id="7261528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7261531">var</span>&nbsp;<span class="ident" id="7261535">age</span>&nbsp;<span class="builtintype" id="7261539">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7261544">for</span>&nbsp;<span class="ident" id="7261548">n</span><span class="op" id="7261549">,</span>&nbsp;<span class="ident" id="7261551">tt</span>&nbsp;<span class="op" id="7261554">:=</span>&nbsp;<span class="keyword" id="7261557">range</span>&nbsp;<span class="op" id="7261563">[</span><span class="op" id="7261564">]</span><span class="keyword" id="7261565">struct</span>&nbsp;<span class="op" id="7261572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7261576">name</span>&nbsp;<span class="builtintype" id="7261581">string</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7261590">want</span>&nbsp;<span class="builtintype" id="7261595">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7261600">}</span><span class="op" id="7261601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7261605">{</span><span class="string" id="7261606">&#34;Alice&#34;</span><span class="op" id="7261613">,</span>&nbsp;<span class="num" id="7261615">1</span><span class="op" id="7261616">}</span><span class="op" id="7261617">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7261621">{</span><span class="string" id="7261622">&#34;Bob&#34;</span><span class="op" id="7261627">,</span>&nbsp;<span class="num" id="7261629">2</span><span class="op" id="7261630">}</span><span class="op" id="7261631">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7261635">{</span><span class="string" id="7261636">&#34;Chris&#34;</span><span class="op" id="7261643">,</span>&nbsp;<span class="num" id="7261645">3</span><span class="op" id="7261646">}</span><span class="op" id="7261647">,</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7261650">}</span>&nbsp;<span class="op" id="7261652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7261656">if</span>&nbsp;<span class="ident" id="7261659">err</span>&nbsp;<span class="op" id="7261663">:=</span>&nbsp;<span class="ident" id="7261666">stmt</span><span class="op" id="7261670">.</span><span class="ident" id="7261671">QueryRow</span><span class="op" id="7261679">(</span><span class="ident" id="7261680">tt</span><span class="op" id="7261682">.</span><span class="ident" id="7261683">name</span><span class="op" id="7261687">)</span><span class="op" id="7261688">.</span><span class="ident" id="7261689">Scan</span><span class="op" id="7261693">(</span><span class="op" id="7261694">&amp;</span><span class="ident" id="7261695">age</span><span class="op" id="7261698">)</span><span class="op" id="7261699">;</span>&nbsp;<span class="ident" id="7261701">err</span>&nbsp;<span class="op" id="7261705">!=</span>&nbsp;<span class="ident" id="7261708">nil</span>&nbsp;<span class="op" id="7261712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7261717">t</span><span class="op" id="7261718">.</span><span class="ident" id="7261719">Errorf</span><span class="op" id="7261725">(</span><span class="string" id="7261726">&#34;%d:&nbsp;on&nbsp;%q,&nbsp;QueryRow/Scan:&nbsp;%v&#34;</span><span class="op" id="7261756">,</span>&nbsp;<span class="ident" id="7261758">n</span><span class="op" id="7261759">,</span>&nbsp;<span class="ident" id="7261761">tt</span><span class="op" id="7261763">.</span><span class="ident" id="7261764">name</span><span class="op" id="7261768">,</span>&nbsp;<span class="ident" id="7261770">err</span><span class="op" id="7261773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7261777">}</span>&nbsp;<span class="keyword" id="7261779">else</span>&nbsp;<span class="keyword" id="7261784">if</span>&nbsp;<span class="ident" id="7261787">age</span>&nbsp;<span class="op" id="7261791">!=</span>&nbsp;<span class="ident" id="7261794">tt</span><span class="op" id="7261796">.</span><span class="ident" id="7261797">want</span>&nbsp;<span class="op" id="7261802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7261807">t</span><span class="op" id="7261808">.</span><span class="ident" id="7261809">Errorf</span><span class="op" id="7261815">(</span><span class="string" id="7261816">&#34;%d:&nbsp;age=%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7261837">,</span>&nbsp;<span class="ident" id="7261839">n</span><span class="op" id="7261840">,</span>&nbsp;<span class="ident" id="7261842">age</span><span class="op" id="7261845">,</span>&nbsp;<span class="ident" id="7261847">tt</span><span class="op" id="7261849">.</span><span class="ident" id="7261850">want</span><span class="op" id="7261854">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7261858">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7261861">}</span><br>
<span class="lineno"></span><span class="op" id="7261863">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7261866">//&nbsp;golang.org/issue/3734</span><br>
<span class="lineno">360</span><span class="keyword" id="7261891">func</span>&nbsp;<span class="ident" id="7261896">TestStatementQueryRowConcurrent</span><span class="op" id="7261927">(</span><span class="ident" id="7261928">t</span>&nbsp;<span class="op" id="7261930">*</span><span class="ident" id="7261931">testing</span><span class="op" id="7261938">.</span><span class="ident" id="7261939">T</span><span class="op" id="7261940">)</span>&nbsp;<span class="op" id="7261942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7261945">db</span>&nbsp;<span class="op" id="7261948">:=</span>&nbsp;<span class="ident" id="7261951">newTestDB</span><span class="op" id="7261960">(</span><span class="ident" id="7261961">t</span><span class="op" id="7261962">,</span>&nbsp;<span class="string" id="7261964">&#34;people&#34;</span><span class="op" id="7261972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7261975">defer</span>&nbsp;<span class="ident" id="7261981">closeDB</span><span class="op" id="7261988">(</span><span class="ident" id="7261989">t</span><span class="op" id="7261990">,</span>&nbsp;<span class="ident" id="7261992">db</span><span class="op" id="7261994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7261997">stmt</span><span class="op" id="7262001">,</span>&nbsp;<span class="ident" id="7262003">err</span>&nbsp;<span class="op" id="7262007">:=</span>&nbsp;<span class="ident" id="7262010">db</span><span class="op" id="7262012">.</span><span class="ident" id="7262013">Prepare</span><span class="op" id="7262020">(</span><span class="string" id="7262021">&#34;SELECT|people|age|name=?&#34;</span><span class="op" id="7262047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7262050">if</span>&nbsp;<span class="ident" id="7262053">err</span>&nbsp;<span class="op" id="7262057">!=</span>&nbsp;<span class="ident" id="7262060">nil</span>&nbsp;<span class="op" id="7262064">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7262068">t</span><span class="op" id="7262069">.</span><span class="ident" id="7262070">Fatalf</span><span class="op" id="7262076">(</span><span class="string" id="7262077">&#34;Prepare:&nbsp;%v&#34;</span><span class="op" id="7262090">,</span>&nbsp;<span class="ident" id="7262092">err</span><span class="op" id="7262095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7262098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7262101">defer</span>&nbsp;<span class="ident" id="7262107">stmt</span><span class="op" id="7262111">.</span><span class="ident" id="7262112">Close</span><span class="op" id="7262117">(</span><span class="op" id="7262118">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7262122">const</span>&nbsp;<span class="ident" id="7262128">n</span>&nbsp;<span class="op" id="7262130">=</span>&nbsp;<span class="num" id="7262132">10</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7262136">ch</span>&nbsp;<span class="op" id="7262139">:=</span>&nbsp;<span class="builtinfunc" id="7262142">make</span><span class="op" id="7262146">(</span><span class="keyword" id="7262147">chan</span>&nbsp;<span class="builtintype" id="7262152">error</span><span class="op" id="7262157">,</span>&nbsp;<span class="ident" id="7262159">n</span><span class="op" id="7262160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7262163">for</span>&nbsp;<span class="ident" id="7262167">i</span>&nbsp;<span class="op" id="7262169">:=</span>&nbsp;<span class="num" id="7262172">0</span><span class="op" id="7262173">;</span>&nbsp;<span class="ident" id="7262175">i</span>&nbsp;<span class="op" id="7262177">&lt;</span>&nbsp;<span class="ident" id="7262179">n</span><span class="op" id="7262180">;</span>&nbsp;<span class="ident" id="7262182">i</span><span class="op" id="7262183">++</span>&nbsp;<span class="op" id="7262186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7262190">go</span>&nbsp;<span class="keyword" id="7262193">func</span><span class="op" id="7262197">(</span><span class="op" id="7262198">)</span>&nbsp;<span class="op" id="7262200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7262205">var</span>&nbsp;<span class="ident" id="7262209">age</span>&nbsp;<span class="builtintype" id="7262213">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7262220">err</span>&nbsp;<span class="op" id="7262224">:=</span>&nbsp;<span class="ident" id="7262227">stmt</span><span class="op" id="7262231">.</span><span class="ident" id="7262232">QueryRow</span><span class="op" id="7262240">(</span><span class="string" id="7262241">&#34;Alice&#34;</span><span class="op" id="7262248">)</span><span class="op" id="7262249">.</span><span class="ident" id="7262250">Scan</span><span class="op" id="7262254">(</span><span class="op" id="7262255">&amp;</span><span class="ident" id="7262256">age</span><span class="op" id="7262259">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7262264">if</span>&nbsp;<span class="ident" id="7262267">err</span>&nbsp;<span class="op" id="7262271">==</span>&nbsp;<span class="ident" id="7262274">nil</span>&nbsp;<span class="op" id="7262278">&amp;&amp;</span>&nbsp;<span class="ident" id="7262281">age</span>&nbsp;<span class="op" id="7262285">!=</span>&nbsp;<span class="num" id="7262288">1</span>&nbsp;<span class="op" id="7262290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7262296">err</span>&nbsp;<span class="op" id="7262300">=</span>&nbsp;<span class="ident" id="7262302">fmt</span><span class="op" id="7262305">.</span><span class="ident" id="7262306">Errorf</span><span class="op" id="7262312">(</span><span class="string" id="7262313">&#34;unexpected&nbsp;age&nbsp;%d&#34;</span><span class="op" id="7262332">,</span>&nbsp;<span class="ident" id="7262334">age</span><span class="op" id="7262337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7262342">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7262347">ch</span>&nbsp;<span class="op" id="7262350">&lt;-</span>&nbsp;<span class="ident" id="7262353">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7262359">}</span><span class="op" id="7262360">(</span><span class="op" id="7262361">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7262364">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7262367">for</span>&nbsp;<span class="ident" id="7262371">i</span>&nbsp;<span class="op" id="7262373">:=</span>&nbsp;<span class="num" id="7262376">0</span><span class="op" id="7262377">;</span>&nbsp;<span class="ident" id="7262379">i</span>&nbsp;<span class="op" id="7262381">&lt;</span>&nbsp;<span class="ident" id="7262383">n</span><span class="op" id="7262384">;</span>&nbsp;<span class="ident" id="7262386">i</span><span class="op" id="7262387">++</span>&nbsp;<span class="op" id="7262390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7262394">if</span>&nbsp;<span class="ident" id="7262397">err</span>&nbsp;<span class="op" id="7262401">:=</span>&nbsp;<span class="op" id="7262404">&lt;-</span><span class="ident" id="7262406">ch</span><span class="op" id="7262408">;</span>&nbsp;<span class="ident" id="7262410">err</span>&nbsp;<span class="op" id="7262414">!=</span>&nbsp;<span class="ident" id="7262417">nil</span>&nbsp;<span class="op" id="7262421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7262426">t</span><span class="op" id="7262427">.</span><span class="ident" id="7262428">Error</span><span class="op" id="7262433">(</span><span class="ident" id="7262434">err</span><span class="op" id="7262437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7262441">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7262444">}</span><br>
<span class="lineno"></span><span class="op" id="7262446">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7262449">//&nbsp;just&nbsp;a&nbsp;test&nbsp;of&nbsp;fakedb&nbsp;itself</span><br>
<span class="lineno"></span><span class="keyword" id="7262481">func</span>&nbsp;<span class="ident" id="7262486">TestBogusPreboundParameters</span><span class="op" id="7262513">(</span><span class="ident" id="7262514">t</span>&nbsp;<span class="op" id="7262516">*</span><span class="ident" id="7262517">testing</span><span class="op" id="7262524">.</span><span class="ident" id="7262525">T</span><span class="op" id="7262526">)</span>&nbsp;<span class="op" id="7262528">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7262531">db</span>&nbsp;<span class="op" id="7262534">:=</span>&nbsp;<span class="ident" id="7262537">newTestDB</span><span class="op" id="7262546">(</span><span class="ident" id="7262547">t</span><span class="op" id="7262548">,</span>&nbsp;<span class="string" id="7262550">&#34;foo&#34;</span><span class="op" id="7262555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7262558">defer</span>&nbsp;<span class="ident" id="7262564">closeDB</span><span class="op" id="7262571">(</span><span class="ident" id="7262572">t</span><span class="op" id="7262573">,</span>&nbsp;<span class="ident" id="7262575">db</span><span class="op" id="7262577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7262580">exec</span><span class="op" id="7262584">(</span><span class="ident" id="7262585">t</span><span class="op" id="7262586">,</span>&nbsp;<span class="ident" id="7262588">db</span><span class="op" id="7262590">,</span>&nbsp;<span class="string" id="7262592">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7262635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7262638">_</span><span class="op" id="7262639">,</span>&nbsp;<span class="ident" id="7262641">err</span>&nbsp;<span class="op" id="7262645">:=</span>&nbsp;<span class="ident" id="7262648">db</span><span class="op" id="7262650">.</span><span class="ident" id="7262651">Prepare</span><span class="op" id="7262658">(</span><span class="string" id="7262659">&#34;INSERT|t1|name=?,age=bogusconversion&#34;</span><span class="op" id="7262697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7262700">if</span>&nbsp;<span class="ident" id="7262703">err</span>&nbsp;<span class="op" id="7262707">==</span>&nbsp;<span class="ident" id="7262710">nil</span>&nbsp;<span class="op" id="7262714">{</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7262718">t</span><span class="op" id="7262719">.</span><span class="ident" id="7262720">Fatalf</span><span class="op" id="7262726">(</span><span class="string" id="7262727">&#34;expected&nbsp;error&#34;</span><span class="op" id="7262743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7262746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7262749">if</span>&nbsp;<span class="ident" id="7262752">err</span><span class="op" id="7262755">.</span><span class="ident" id="7262756">Error</span><span class="op" id="7262761">(</span><span class="op" id="7262762">)</span>&nbsp;<span class="op" id="7262764">!=</span>&nbsp;<span class="string" id="7262767">`fakedb:&nbsp;invalid&nbsp;conversion&nbsp;to&nbsp;int32&nbsp;from&nbsp;&#34;bogusconversion&#34;`</span>&nbsp;<span class="op" id="7262828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7262832">t</span><span class="op" id="7262833">.</span><span class="ident" id="7262834">Errorf</span><span class="op" id="7262840">(</span><span class="string" id="7262841">&#34;unexpected&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="7262863">,</span>&nbsp;<span class="ident" id="7262865">err</span><span class="op" id="7262868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7262871">}</span><br>
<span class="lineno">400</span><span class="op" id="7262873">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7262876">func</span>&nbsp;<span class="ident" id="7262881">TestExec</span><span class="op" id="7262889">(</span><span class="ident" id="7262890">t</span>&nbsp;<span class="op" id="7262892">*</span><span class="ident" id="7262893">testing</span><span class="op" id="7262900">.</span><span class="ident" id="7262901">T</span><span class="op" id="7262902">)</span>&nbsp;<span class="op" id="7262904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7262907">db</span>&nbsp;<span class="op" id="7262910">:=</span>&nbsp;<span class="ident" id="7262913">newTestDB</span><span class="op" id="7262922">(</span><span class="ident" id="7262923">t</span><span class="op" id="7262924">,</span>&nbsp;<span class="string" id="7262926">&#34;foo&#34;</span><span class="op" id="7262931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7262934">defer</span>&nbsp;<span class="ident" id="7262940">closeDB</span><span class="op" id="7262947">(</span><span class="ident" id="7262948">t</span><span class="op" id="7262949">,</span>&nbsp;<span class="ident" id="7262951">db</span><span class="op" id="7262953">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7262956">exec</span><span class="op" id="7262960">(</span><span class="ident" id="7262961">t</span><span class="op" id="7262962">,</span>&nbsp;<span class="ident" id="7262964">db</span><span class="op" id="7262966">,</span>&nbsp;<span class="string" id="7262968">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7263011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7263014">stmt</span><span class="op" id="7263018">,</span>&nbsp;<span class="ident" id="7263020">err</span>&nbsp;<span class="op" id="7263024">:=</span>&nbsp;<span class="ident" id="7263027">db</span><span class="op" id="7263029">.</span><span class="ident" id="7263030">Prepare</span><span class="op" id="7263037">(</span><span class="string" id="7263038">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="7263062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7263065">if</span>&nbsp;<span class="ident" id="7263068">err</span>&nbsp;<span class="op" id="7263072">!=</span>&nbsp;<span class="ident" id="7263075">nil</span>&nbsp;<span class="op" id="7263079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7263083">t</span><span class="op" id="7263084">.</span><span class="ident" id="7263085">Errorf</span><span class="op" id="7263091">(</span><span class="string" id="7263092">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="7263112">,</span>&nbsp;<span class="ident" id="7263114">stmt</span><span class="op" id="7263118">,</span>&nbsp;<span class="ident" id="7263120">err</span><span class="op" id="7263123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7263126">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7263129">defer</span>&nbsp;<span class="ident" id="7263135">stmt</span><span class="op" id="7263139">.</span><span class="ident" id="7263140">Close</span><span class="op" id="7263145">(</span><span class="op" id="7263146">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7263150">type</span>&nbsp;<span class="ident" id="7263155">execTest</span>&nbsp;<span class="keyword" id="7263164">struct</span>&nbsp;<span class="op" id="7263171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7263175">args</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7263183">[</span><span class="op" id="7263184">]</span><span class="keyword" id="7263185">interface</span><span class="op" id="7263194">{</span><span class="op" id="7263195">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7263199">wantErr</span>&nbsp;<span class="builtintype" id="7263207">string</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7263215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7263218">execTests</span>&nbsp;<span class="op" id="7263228">:=</span>&nbsp;<span class="op" id="7263231">[</span><span class="op" id="7263232">]</span><span class="ident" id="7263233">execTest</span><span class="op" id="7263241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7263245">//&nbsp;Okay:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7263256">{</span><span class="op" id="7263257">[</span><span class="op" id="7263258">]</span><span class="keyword" id="7263259">interface</span><span class="op" id="7263268">{</span><span class="op" id="7263269">}</span><span class="op" id="7263270">{</span><span class="string" id="7263271">&#34;Brad&#34;</span><span class="op" id="7263277">,</span>&nbsp;<span class="num" id="7263279">31</span><span class="op" id="7263281">}</span><span class="op" id="7263282">,</span>&nbsp;<span class="string" id="7263284">&#34;&#34;</span><span class="op" id="7263286">}</span><span class="op" id="7263287">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7263291">{</span><span class="op" id="7263292">[</span><span class="op" id="7263293">]</span><span class="keyword" id="7263294">interface</span><span class="op" id="7263303">{</span><span class="op" id="7263304">}</span><span class="op" id="7263305">{</span><span class="string" id="7263306">&#34;Brad&#34;</span><span class="op" id="7263312">,</span>&nbsp;<span class="ident" id="7263314">int64</span><span class="op" id="7263319">(</span><span class="num" id="7263320">31</span><span class="op" id="7263322">)</span><span class="op" id="7263323">}</span><span class="op" id="7263324">,</span>&nbsp;<span class="string" id="7263326">&#34;&#34;</span><span class="op" id="7263328">}</span><span class="op" id="7263329">,</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7263333">{</span><span class="op" id="7263334">[</span><span class="op" id="7263335">]</span><span class="keyword" id="7263336">interface</span><span class="op" id="7263345">{</span><span class="op" id="7263346">}</span><span class="op" id="7263347">{</span><span class="string" id="7263348">&#34;Bob&#34;</span><span class="op" id="7263353">,</span>&nbsp;<span class="string" id="7263355">&#34;32&#34;</span><span class="op" id="7263359">}</span><span class="op" id="7263360">,</span>&nbsp;<span class="string" id="7263362">&#34;&#34;</span><span class="op" id="7263364">}</span><span class="op" id="7263365">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7263369">{</span><span class="op" id="7263370">[</span><span class="op" id="7263371">]</span><span class="keyword" id="7263372">interface</span><span class="op" id="7263381">{</span><span class="op" id="7263382">}</span><span class="op" id="7263383">{</span><span class="num" id="7263384">7</span><span class="op" id="7263385">,</span>&nbsp;<span class="num" id="7263387">9</span><span class="op" id="7263388">}</span><span class="op" id="7263389">,</span>&nbsp;<span class="string" id="7263391">&#34;&#34;</span><span class="op" id="7263393">}</span><span class="op" id="7263394">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7263399">//&nbsp;Invalid&nbsp;conversions:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7263425">{</span><span class="op" id="7263426">[</span><span class="op" id="7263427">]</span><span class="keyword" id="7263428">interface</span><span class="op" id="7263437">{</span><span class="op" id="7263438">}</span><span class="op" id="7263439">{</span><span class="string" id="7263440">&#34;Brad&#34;</span><span class="op" id="7263446">,</span>&nbsp;<span class="ident" id="7263448">int64</span><span class="op" id="7263453">(</span><span class="num" id="7263454">0xFFFFFFFF</span><span class="op" id="7263464">)</span><span class="op" id="7263465">}</span><span class="op" id="7263466">,</span>&nbsp;<span class="string" id="7263468">&#34;sql:&nbsp;converting&nbsp;argument&nbsp;#1&#39;s&nbsp;type:&nbsp;sql/driver:&nbsp;value&nbsp;4294967295&nbsp;overflows&nbsp;int32&#34;</span><span class="op" id="7263550">}</span><span class="op" id="7263551">,</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7263555">{</span><span class="op" id="7263556">[</span><span class="op" id="7263557">]</span><span class="keyword" id="7263558">interface</span><span class="op" id="7263567">{</span><span class="op" id="7263568">}</span><span class="op" id="7263569">{</span><span class="string" id="7263570">&#34;Brad&#34;</span><span class="op" id="7263576">,</span>&nbsp;<span class="string" id="7263578">&#34;strconv&nbsp;fail&#34;</span><span class="op" id="7263592">}</span><span class="op" id="7263593">,</span>&nbsp;<span class="string" id="7263595">&#34;sql:&nbsp;converting&nbsp;argument&nbsp;#1&#39;s&nbsp;type:&nbsp;sql/driver:&nbsp;value&nbsp;\&#34;strconv&nbsp;fail\&#34;&nbsp;can&#39;t&nbsp;be&nbsp;converted&nbsp;to&nbsp;int32&#34;</span><span class="op" id="7263695">}</span><span class="op" id="7263696">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7263701">//&nbsp;Wrong&nbsp;number&nbsp;of&nbsp;args:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7263728">{</span><span class="op" id="7263729">[</span><span class="op" id="7263730">]</span><span class="keyword" id="7263731">interface</span><span class="op" id="7263740">{</span><span class="op" id="7263741">}</span><span class="op" id="7263742">{</span><span class="op" id="7263743">}</span><span class="op" id="7263744">,</span>&nbsp;<span class="string" id="7263746">&#34;sql:&nbsp;expected&nbsp;2&nbsp;arguments,&nbsp;got&nbsp;0&#34;</span><span class="op" id="7263780">}</span><span class="op" id="7263781">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7263785">{</span><span class="op" id="7263786">[</span><span class="op" id="7263787">]</span><span class="keyword" id="7263788">interface</span><span class="op" id="7263797">{</span><span class="op" id="7263798">}</span><span class="op" id="7263799">{</span><span class="num" id="7263800">1</span><span class="op" id="7263801">,</span>&nbsp;<span class="num" id="7263803">2</span><span class="op" id="7263804">,</span>&nbsp;<span class="num" id="7263806">3</span><span class="op" id="7263807">}</span><span class="op" id="7263808">,</span>&nbsp;<span class="string" id="7263810">&#34;sql:&nbsp;expected&nbsp;2&nbsp;arguments,&nbsp;got&nbsp;3&#34;</span><span class="op" id="7263844">}</span><span class="op" id="7263845">,</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7263848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7263851">for</span>&nbsp;<span class="ident" id="7263855">n</span><span class="op" id="7263856">,</span>&nbsp;<span class="ident" id="7263858">et</span>&nbsp;<span class="op" id="7263861">:=</span>&nbsp;<span class="keyword" id="7263864">range</span>&nbsp;<span class="ident" id="7263870">execTests</span>&nbsp;<span class="op" id="7263880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7263884">_</span><span class="op" id="7263885">,</span>&nbsp;<span class="ident" id="7263887">err</span>&nbsp;<span class="op" id="7263891">:=</span>&nbsp;<span class="ident" id="7263894">stmt</span><span class="op" id="7263898">.</span><span class="ident" id="7263899">Exec</span><span class="op" id="7263903">(</span><span class="ident" id="7263904">et</span><span class="op" id="7263906">.</span><span class="ident" id="7263907">args</span><span class="op" id="7263911">...</span><span class="op" id="7263914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7263918">errStr</span>&nbsp;<span class="op" id="7263925">:=</span>&nbsp;<span class="string" id="7263928">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7263933">if</span>&nbsp;<span class="ident" id="7263936">err</span>&nbsp;<span class="op" id="7263940">!=</span>&nbsp;<span class="ident" id="7263943">nil</span>&nbsp;<span class="op" id="7263947">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7263952">errStr</span>&nbsp;<span class="op" id="7263959">=</span>&nbsp;<span class="ident" id="7263961">err</span><span class="op" id="7263964">.</span><span class="ident" id="7263965">Error</span><span class="op" id="7263970">(</span><span class="op" id="7263971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7263975">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7263979">if</span>&nbsp;<span class="ident" id="7263982">errStr</span>&nbsp;<span class="op" id="7263989">!=</span>&nbsp;<span class="ident" id="7263992">et</span><span class="op" id="7263994">.</span><span class="ident" id="7263995">wantErr</span>&nbsp;<span class="op" id="7264003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7264008">t</span><span class="op" id="7264009">.</span><span class="ident" id="7264010">Errorf</span><span class="op" id="7264016">(</span><span class="string" id="7264017">&#34;stmt.Execute&nbsp;#%d:&nbsp;for&nbsp;%v,&nbsp;got&nbsp;error&nbsp;%q,&nbsp;want&nbsp;error&nbsp;%q&#34;</span><span class="op" id="7264072">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7264078">n</span><span class="op" id="7264079">,</span>&nbsp;<span class="ident" id="7264081">et</span><span class="op" id="7264083">.</span><span class="ident" id="7264084">args</span><span class="op" id="7264088">,</span>&nbsp;<span class="ident" id="7264090">errStr</span><span class="op" id="7264096">,</span>&nbsp;<span class="ident" id="7264098">et</span><span class="op" id="7264100">.</span><span class="ident" id="7264101">wantErr</span><span class="op" id="7264108">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7264112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7264115">}</span><br>
<span class="lineno"></span><span class="op" id="7264117">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7264120">func</span>&nbsp;<span class="ident" id="7264125">TestTxPrepare</span><span class="op" id="7264138">(</span><span class="ident" id="7264139">t</span>&nbsp;<span class="op" id="7264141">*</span><span class="ident" id="7264142">testing</span><span class="op" id="7264149">.</span><span class="ident" id="7264150">T</span><span class="op" id="7264151">)</span>&nbsp;<span class="op" id="7264153">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7264156">db</span>&nbsp;<span class="op" id="7264159">:=</span>&nbsp;<span class="ident" id="7264162">newTestDB</span><span class="op" id="7264171">(</span><span class="ident" id="7264172">t</span><span class="op" id="7264173">,</span>&nbsp;<span class="string" id="7264175">&#34;&#34;</span><span class="op" id="7264177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7264180">defer</span>&nbsp;<span class="ident" id="7264186">closeDB</span><span class="op" id="7264193">(</span><span class="ident" id="7264194">t</span><span class="op" id="7264195">,</span>&nbsp;<span class="ident" id="7264197">db</span><span class="op" id="7264199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7264202">exec</span><span class="op" id="7264206">(</span><span class="ident" id="7264207">t</span><span class="op" id="7264208">,</span>&nbsp;<span class="ident" id="7264210">db</span><span class="op" id="7264212">,</span>&nbsp;<span class="string" id="7264214">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7264257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7264260">tx</span><span class="op" id="7264262">,</span>&nbsp;<span class="ident" id="7264264">err</span>&nbsp;<span class="op" id="7264268">:=</span>&nbsp;<span class="ident" id="7264271">db</span><span class="op" id="7264273">.</span><span class="ident" id="7264274">Begin</span><span class="op" id="7264279">(</span><span class="op" id="7264280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7264283">if</span>&nbsp;<span class="ident" id="7264286">err</span>&nbsp;<span class="op" id="7264290">!=</span>&nbsp;<span class="ident" id="7264293">nil</span>&nbsp;<span class="op" id="7264297">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7264301">t</span><span class="op" id="7264302">.</span><span class="ident" id="7264303">Fatalf</span><span class="op" id="7264309">(</span><span class="string" id="7264310">&#34;Begin&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7264322">,</span>&nbsp;<span class="ident" id="7264324">err</span><span class="op" id="7264327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7264330">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7264333">stmt</span><span class="op" id="7264337">,</span>&nbsp;<span class="ident" id="7264339">err</span>&nbsp;<span class="op" id="7264343">:=</span>&nbsp;<span class="ident" id="7264346">tx</span><span class="op" id="7264348">.</span><span class="ident" id="7264349">Prepare</span><span class="op" id="7264356">(</span><span class="string" id="7264357">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="7264381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7264384">if</span>&nbsp;<span class="ident" id="7264387">err</span>&nbsp;<span class="op" id="7264391">!=</span>&nbsp;<span class="ident" id="7264394">nil</span>&nbsp;<span class="op" id="7264398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7264402">t</span><span class="op" id="7264403">.</span><span class="ident" id="7264404">Fatalf</span><span class="op" id="7264410">(</span><span class="string" id="7264411">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="7264431">,</span>&nbsp;<span class="ident" id="7264433">stmt</span><span class="op" id="7264437">,</span>&nbsp;<span class="ident" id="7264439">err</span><span class="op" id="7264442">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7264445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7264448">defer</span>&nbsp;<span class="ident" id="7264454">stmt</span><span class="op" id="7264458">.</span><span class="ident" id="7264459">Close</span><span class="op" id="7264464">(</span><span class="op" id="7264465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7264468">_</span><span class="op" id="7264469">,</span>&nbsp;<span class="ident" id="7264471">err</span>&nbsp;<span class="op" id="7264475">=</span>&nbsp;<span class="ident" id="7264477">stmt</span><span class="op" id="7264481">.</span><span class="ident" id="7264482">Exec</span><span class="op" id="7264486">(</span><span class="string" id="7264487">&#34;Bobby&#34;</span><span class="op" id="7264494">,</span>&nbsp;<span class="num" id="7264496">7</span><span class="op" id="7264497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7264500">if</span>&nbsp;<span class="ident" id="7264503">err</span>&nbsp;<span class="op" id="7264507">!=</span>&nbsp;<span class="ident" id="7264510">nil</span>&nbsp;<span class="op" id="7264514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7264518">t</span><span class="op" id="7264519">.</span><span class="ident" id="7264520">Fatalf</span><span class="op" id="7264526">(</span><span class="string" id="7264527">&#34;Exec&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7264538">,</span>&nbsp;<span class="ident" id="7264540">err</span><span class="op" id="7264543">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7264546">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7264549">err</span>&nbsp;<span class="op" id="7264553">=</span>&nbsp;<span class="ident" id="7264555">tx</span><span class="op" id="7264557">.</span><span class="ident" id="7264558">Commit</span><span class="op" id="7264564">(</span><span class="op" id="7264565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7264568">if</span>&nbsp;<span class="ident" id="7264571">err</span>&nbsp;<span class="op" id="7264575">!=</span>&nbsp;<span class="ident" id="7264578">nil</span>&nbsp;<span class="op" id="7264582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7264586">t</span><span class="op" id="7264587">.</span><span class="ident" id="7264588">Fatalf</span><span class="op" id="7264594">(</span><span class="string" id="7264595">&#34;Commit&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7264608">,</span>&nbsp;<span class="ident" id="7264610">err</span><span class="op" id="7264613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7264616">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7264619">//&nbsp;Commit()&nbsp;should&nbsp;have&nbsp;closed&nbsp;the&nbsp;statement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7264665">if</span>&nbsp;<span class="op" id="7264668">!</span><span class="ident" id="7264669">stmt</span><span class="op" id="7264673">.</span><span class="ident" id="7264674">closed</span>&nbsp;<span class="op" id="7264681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7264685">t</span><span class="op" id="7264686">.</span><span class="ident" id="7264687">Fatal</span><span class="op" id="7264692">(</span><span class="string" id="7264693">&#34;Stmt&nbsp;not&nbsp;closed&nbsp;after&nbsp;Commit&#34;</span><span class="op" id="7264723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7264726">}</span><br>
<span class="lineno"></span><span class="op" id="7264728">}</span><br>
<span class="lineno">470</span><br>
<span class="lineno"></span><span class="keyword" id="7264731">func</span>&nbsp;<span class="ident" id="7264736">TestTxStmt</span><span class="op" id="7264746">(</span><span class="ident" id="7264747">t</span>&nbsp;<span class="op" id="7264749">*</span><span class="ident" id="7264750">testing</span><span class="op" id="7264757">.</span><span class="ident" id="7264758">T</span><span class="op" id="7264759">)</span>&nbsp;<span class="op" id="7264761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7264764">db</span>&nbsp;<span class="op" id="7264767">:=</span>&nbsp;<span class="ident" id="7264770">newTestDB</span><span class="op" id="7264779">(</span><span class="ident" id="7264780">t</span><span class="op" id="7264781">,</span>&nbsp;<span class="string" id="7264783">&#34;&#34;</span><span class="op" id="7264785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7264788">defer</span>&nbsp;<span class="ident" id="7264794">closeDB</span><span class="op" id="7264801">(</span><span class="ident" id="7264802">t</span><span class="op" id="7264803">,</span>&nbsp;<span class="ident" id="7264805">db</span><span class="op" id="7264807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7264810">exec</span><span class="op" id="7264814">(</span><span class="ident" id="7264815">t</span><span class="op" id="7264816">,</span>&nbsp;<span class="ident" id="7264818">db</span><span class="op" id="7264820">,</span>&nbsp;<span class="string" id="7264822">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7264865">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7264868">stmt</span><span class="op" id="7264872">,</span>&nbsp;<span class="ident" id="7264874">err</span>&nbsp;<span class="op" id="7264878">:=</span>&nbsp;<span class="ident" id="7264881">db</span><span class="op" id="7264883">.</span><span class="ident" id="7264884">Prepare</span><span class="op" id="7264891">(</span><span class="string" id="7264892">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="7264916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7264919">if</span>&nbsp;<span class="ident" id="7264922">err</span>&nbsp;<span class="op" id="7264926">!=</span>&nbsp;<span class="ident" id="7264929">nil</span>&nbsp;<span class="op" id="7264933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7264937">t</span><span class="op" id="7264938">.</span><span class="ident" id="7264939">Fatalf</span><span class="op" id="7264945">(</span><span class="string" id="7264946">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="7264966">,</span>&nbsp;<span class="ident" id="7264968">stmt</span><span class="op" id="7264972">,</span>&nbsp;<span class="ident" id="7264974">err</span><span class="op" id="7264977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7264980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7264983">defer</span>&nbsp;<span class="ident" id="7264989">stmt</span><span class="op" id="7264993">.</span><span class="ident" id="7264994">Close</span><span class="op" id="7264999">(</span><span class="op" id="7265000">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7265003">tx</span><span class="op" id="7265005">,</span>&nbsp;<span class="ident" id="7265007">err</span>&nbsp;<span class="op" id="7265011">:=</span>&nbsp;<span class="ident" id="7265014">db</span><span class="op" id="7265016">.</span><span class="ident" id="7265017">Begin</span><span class="op" id="7265022">(</span><span class="op" id="7265023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7265026">if</span>&nbsp;<span class="ident" id="7265029">err</span>&nbsp;<span class="op" id="7265033">!=</span>&nbsp;<span class="ident" id="7265036">nil</span>&nbsp;<span class="op" id="7265040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7265044">t</span><span class="op" id="7265045">.</span><span class="ident" id="7265046">Fatalf</span><span class="op" id="7265052">(</span><span class="string" id="7265053">&#34;Begin&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7265065">,</span>&nbsp;<span class="ident" id="7265067">err</span><span class="op" id="7265070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7265073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7265076">txs</span>&nbsp;<span class="op" id="7265080">:=</span>&nbsp;<span class="ident" id="7265083">tx</span><span class="op" id="7265085">.</span><span class="ident" id="7265086">Stmt</span><span class="op" id="7265090">(</span><span class="ident" id="7265091">stmt</span><span class="op" id="7265095">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7265098">defer</span>&nbsp;<span class="ident" id="7265104">txs</span><span class="op" id="7265107">.</span><span class="ident" id="7265108">Close</span><span class="op" id="7265113">(</span><span class="op" id="7265114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7265117">_</span><span class="op" id="7265118">,</span>&nbsp;<span class="ident" id="7265120">err</span>&nbsp;<span class="op" id="7265124">=</span>&nbsp;<span class="ident" id="7265126">txs</span><span class="op" id="7265129">.</span><span class="ident" id="7265130">Exec</span><span class="op" id="7265134">(</span><span class="string" id="7265135">&#34;Bobby&#34;</span><span class="op" id="7265142">,</span>&nbsp;<span class="num" id="7265144">7</span><span class="op" id="7265145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7265148">if</span>&nbsp;<span class="ident" id="7265151">err</span>&nbsp;<span class="op" id="7265155">!=</span>&nbsp;<span class="ident" id="7265158">nil</span>&nbsp;<span class="op" id="7265162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7265166">t</span><span class="op" id="7265167">.</span><span class="ident" id="7265168">Fatalf</span><span class="op" id="7265174">(</span><span class="string" id="7265175">&#34;Exec&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7265186">,</span>&nbsp;<span class="ident" id="7265188">err</span><span class="op" id="7265191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7265194">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7265197">err</span>&nbsp;<span class="op" id="7265201">=</span>&nbsp;<span class="ident" id="7265203">tx</span><span class="op" id="7265205">.</span><span class="ident" id="7265206">Commit</span><span class="op" id="7265212">(</span><span class="op" id="7265213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7265216">if</span>&nbsp;<span class="ident" id="7265219">err</span>&nbsp;<span class="op" id="7265223">!=</span>&nbsp;<span class="ident" id="7265226">nil</span>&nbsp;<span class="op" id="7265230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7265234">t</span><span class="op" id="7265235">.</span><span class="ident" id="7265236">Fatalf</span><span class="op" id="7265242">(</span><span class="string" id="7265243">&#34;Commit&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7265256">,</span>&nbsp;<span class="ident" id="7265258">err</span><span class="op" id="7265261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7265264">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7265267">//&nbsp;Commit()&nbsp;should&nbsp;have&nbsp;closed&nbsp;the&nbsp;statement</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7265313">if</span>&nbsp;<span class="op" id="7265316">!</span><span class="ident" id="7265317">txs</span><span class="op" id="7265320">.</span><span class="ident" id="7265321">closed</span>&nbsp;<span class="op" id="7265328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7265332">t</span><span class="op" id="7265333">.</span><span class="ident" id="7265334">Fatal</span><span class="op" id="7265339">(</span><span class="string" id="7265340">&#34;Stmt&nbsp;not&nbsp;closed&nbsp;after&nbsp;Commit&#34;</span><span class="op" id="7265370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7265373">}</span><br>
<span class="lineno"></span><span class="op" id="7265375">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">500</span><span class="comment" id="7265378">//&nbsp;Issue:&nbsp;http://golang.org/issue/2784</span><br>
<span class="lineno"></span><span class="comment" id="7265417">//&nbsp;This&nbsp;test&nbsp;didn&#39;t&nbsp;fail&nbsp;before&nbsp;because&nbsp;we&nbsp;got&nbsp;lucky&nbsp;with&nbsp;the&nbsp;fakedb&nbsp;driver.</span><br>
<span class="lineno"></span><span class="comment" id="7265494">//&nbsp;It&nbsp;was&nbsp;failing,&nbsp;and&nbsp;now&nbsp;not,&nbsp;in&nbsp;github.com/bradfitz/go-sql-test</span><br>
<span class="lineno"></span><span class="keyword" id="7265561">func</span>&nbsp;<span class="ident" id="7265566">TestTxQuery</span><span class="op" id="7265577">(</span><span class="ident" id="7265578">t</span>&nbsp;<span class="op" id="7265580">*</span><span class="ident" id="7265581">testing</span><span class="op" id="7265588">.</span><span class="ident" id="7265589">T</span><span class="op" id="7265590">)</span>&nbsp;<span class="op" id="7265592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7265595">db</span>&nbsp;<span class="op" id="7265598">:=</span>&nbsp;<span class="ident" id="7265601">newTestDB</span><span class="op" id="7265610">(</span><span class="ident" id="7265611">t</span><span class="op" id="7265612">,</span>&nbsp;<span class="string" id="7265614">&#34;&#34;</span><span class="op" id="7265616">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7265619">defer</span>&nbsp;<span class="ident" id="7265625">closeDB</span><span class="op" id="7265632">(</span><span class="ident" id="7265633">t</span><span class="op" id="7265634">,</span>&nbsp;<span class="ident" id="7265636">db</span><span class="op" id="7265638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7265641">exec</span><span class="op" id="7265645">(</span><span class="ident" id="7265646">t</span><span class="op" id="7265647">,</span>&nbsp;<span class="ident" id="7265649">db</span><span class="op" id="7265651">,</span>&nbsp;<span class="string" id="7265653">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7265696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7265699">exec</span><span class="op" id="7265703">(</span><span class="ident" id="7265704">t</span><span class="op" id="7265705">,</span>&nbsp;<span class="ident" id="7265707">db</span><span class="op" id="7265709">,</span>&nbsp;<span class="string" id="7265711">&#34;INSERT|t1|name=Alice&#34;</span><span class="op" id="7265733">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7265737">tx</span><span class="op" id="7265739">,</span>&nbsp;<span class="ident" id="7265741">err</span>&nbsp;<span class="op" id="7265745">:=</span>&nbsp;<span class="ident" id="7265748">db</span><span class="op" id="7265750">.</span><span class="ident" id="7265751">Begin</span><span class="op" id="7265756">(</span><span class="op" id="7265757">)</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7265760">if</span>&nbsp;<span class="ident" id="7265763">err</span>&nbsp;<span class="op" id="7265767">!=</span>&nbsp;<span class="ident" id="7265770">nil</span>&nbsp;<span class="op" id="7265774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7265778">t</span><span class="op" id="7265779">.</span><span class="ident" id="7265780">Fatal</span><span class="op" id="7265785">(</span><span class="ident" id="7265786">err</span><span class="op" id="7265789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7265792">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7265795">defer</span>&nbsp;<span class="ident" id="7265801">tx</span><span class="op" id="7265803">.</span><span class="ident" id="7265804">Rollback</span><span class="op" id="7265812">(</span><span class="op" id="7265813">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7265817">r</span><span class="op" id="7265818">,</span>&nbsp;<span class="ident" id="7265820">err</span>&nbsp;<span class="op" id="7265824">:=</span>&nbsp;<span class="ident" id="7265827">tx</span><span class="op" id="7265829">.</span><span class="ident" id="7265830">Query</span><span class="op" id="7265835">(</span><span class="string" id="7265836">&#34;SELECT|t1|name|&#34;</span><span class="op" id="7265853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7265856">if</span>&nbsp;<span class="ident" id="7265859">err</span>&nbsp;<span class="op" id="7265863">!=</span>&nbsp;<span class="ident" id="7265866">nil</span>&nbsp;<span class="op" id="7265870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7265874">t</span><span class="op" id="7265875">.</span><span class="ident" id="7265876">Fatal</span><span class="op" id="7265881">(</span><span class="ident" id="7265882">err</span><span class="op" id="7265885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7265888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7265891">defer</span>&nbsp;<span class="ident" id="7265897">r</span><span class="op" id="7265898">.</span><span class="ident" id="7265899">Close</span><span class="op" id="7265904">(</span><span class="op" id="7265905">)</span><br>
<span class="lineno">520</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7265909">if</span>&nbsp;<span class="op" id="7265912">!</span><span class="ident" id="7265913">r</span><span class="op" id="7265914">.</span><span class="ident" id="7265915">Next</span><span class="op" id="7265919">(</span><span class="op" id="7265920">)</span>&nbsp;<span class="op" id="7265922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7265926">if</span>&nbsp;<span class="ident" id="7265929">r</span><span class="op" id="7265930">.</span><span class="ident" id="7265931">Err</span><span class="op" id="7265934">(</span><span class="op" id="7265935">)</span>&nbsp;<span class="op" id="7265937">!=</span>&nbsp;<span class="ident" id="7265940">nil</span>&nbsp;<span class="op" id="7265944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7265949">t</span><span class="op" id="7265950">.</span><span class="ident" id="7265951">Fatal</span><span class="op" id="7265956">(</span><span class="ident" id="7265957">r</span><span class="op" id="7265958">.</span><span class="ident" id="7265959">Err</span><span class="op" id="7265962">(</span><span class="op" id="7265963">)</span><span class="op" id="7265964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7265968">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7265972">t</span><span class="op" id="7265973">.</span><span class="ident" id="7265974">Fatal</span><span class="op" id="7265979">(</span><span class="string" id="7265980">&#34;expected&nbsp;one&nbsp;row&#34;</span><span class="op" id="7265998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7266001">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7266005">var</span>&nbsp;<span class="ident" id="7266009">x</span>&nbsp;<span class="builtintype" id="7266011">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7266019">err</span>&nbsp;<span class="op" id="7266023">=</span>&nbsp;<span class="ident" id="7266025">r</span><span class="op" id="7266026">.</span><span class="ident" id="7266027">Scan</span><span class="op" id="7266031">(</span><span class="op" id="7266032">&amp;</span><span class="ident" id="7266033">x</span><span class="op" id="7266034">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7266037">if</span>&nbsp;<span class="ident" id="7266040">err</span>&nbsp;<span class="op" id="7266044">!=</span>&nbsp;<span class="ident" id="7266047">nil</span>&nbsp;<span class="op" id="7266051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7266055">t</span><span class="op" id="7266056">.</span><span class="ident" id="7266057">Fatal</span><span class="op" id="7266062">(</span><span class="ident" id="7266063">err</span><span class="op" id="7266066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7266069">}</span><br>
<span class="lineno"></span><span class="op" id="7266071">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="7266074">func</span>&nbsp;<span class="ident" id="7266079">TestTxQueryInvalid</span><span class="op" id="7266097">(</span><span class="ident" id="7266098">t</span>&nbsp;<span class="op" id="7266100">*</span><span class="ident" id="7266101">testing</span><span class="op" id="7266108">.</span><span class="ident" id="7266109">T</span><span class="op" id="7266110">)</span>&nbsp;<span class="op" id="7266112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7266115">db</span>&nbsp;<span class="op" id="7266118">:=</span>&nbsp;<span class="ident" id="7266121">newTestDB</span><span class="op" id="7266130">(</span><span class="ident" id="7266131">t</span><span class="op" id="7266132">,</span>&nbsp;<span class="string" id="7266134">&#34;&#34;</span><span class="op" id="7266136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7266139">defer</span>&nbsp;<span class="ident" id="7266145">closeDB</span><span class="op" id="7266152">(</span><span class="ident" id="7266153">t</span><span class="op" id="7266154">,</span>&nbsp;<span class="ident" id="7266156">db</span><span class="op" id="7266158">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7266162">tx</span><span class="op" id="7266164">,</span>&nbsp;<span class="ident" id="7266166">err</span>&nbsp;<span class="op" id="7266170">:=</span>&nbsp;<span class="ident" id="7266173">db</span><span class="op" id="7266175">.</span><span class="ident" id="7266176">Begin</span><span class="op" id="7266181">(</span><span class="op" id="7266182">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7266185">if</span>&nbsp;<span class="ident" id="7266188">err</span>&nbsp;<span class="op" id="7266192">!=</span>&nbsp;<span class="ident" id="7266195">nil</span>&nbsp;<span class="op" id="7266199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7266203">t</span><span class="op" id="7266204">.</span><span class="ident" id="7266205">Fatal</span><span class="op" id="7266210">(</span><span class="ident" id="7266211">err</span><span class="op" id="7266214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7266217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7266220">defer</span>&nbsp;<span class="ident" id="7266226">tx</span><span class="op" id="7266228">.</span><span class="ident" id="7266229">Rollback</span><span class="op" id="7266237">(</span><span class="op" id="7266238">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7266242">_</span><span class="op" id="7266243">,</span>&nbsp;<span class="ident" id="7266245">err</span>&nbsp;<span class="op" id="7266249">=</span>&nbsp;<span class="ident" id="7266251">tx</span><span class="op" id="7266253">.</span><span class="ident" id="7266254">Query</span><span class="op" id="7266259">(</span><span class="string" id="7266260">&#34;SELECT|t1|name|&#34;</span><span class="op" id="7266277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7266280">if</span>&nbsp;<span class="ident" id="7266283">err</span>&nbsp;<span class="op" id="7266287">==</span>&nbsp;<span class="ident" id="7266290">nil</span>&nbsp;<span class="op" id="7266294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7266298">t</span><span class="op" id="7266299">.</span><span class="ident" id="7266300">Fatal</span><span class="op" id="7266305">(</span><span class="string" id="7266306">&#34;Error&nbsp;expected&#34;</span><span class="op" id="7266322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7266325">}</span><br>
<span class="lineno"></span><span class="op" id="7266327">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="comment" id="7266330">//&nbsp;Tests&nbsp;fix&nbsp;for&nbsp;issue&nbsp;4433,&nbsp;that&nbsp;retries&nbsp;in&nbsp;Begin&nbsp;happen&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="7266393">//&nbsp;conn.Begin()&nbsp;returns&nbsp;ErrBadConn</span><br>
<span class="lineno"></span><span class="keyword" id="7266428">func</span>&nbsp;<span class="ident" id="7266433">TestTxErrBadConn</span><span class="op" id="7266449">(</span><span class="ident" id="7266450">t</span>&nbsp;<span class="op" id="7266452">*</span><span class="ident" id="7266453">testing</span><span class="op" id="7266460">.</span><span class="ident" id="7266461">T</span><span class="op" id="7266462">)</span>&nbsp;<span class="op" id="7266464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7266467">db</span><span class="op" id="7266469">,</span>&nbsp;<span class="ident" id="7266471">err</span>&nbsp;<span class="op" id="7266475">:=</span>&nbsp;<span class="ident" id="7266478">Open</span><span class="op" id="7266482">(</span><span class="string" id="7266483">&#34;test&#34;</span><span class="op" id="7266489">,</span>&nbsp;<span class="ident" id="7266491">fakeDBName</span><span class="op" id="7266501">+</span><span class="string" id="7266502">&#34;;badConn&#34;</span><span class="op" id="7266512">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7266515">if</span>&nbsp;<span class="ident" id="7266518">err</span>&nbsp;<span class="op" id="7266522">!=</span>&nbsp;<span class="ident" id="7266525">nil</span>&nbsp;<span class="op" id="7266529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7266533">t</span><span class="op" id="7266534">.</span><span class="ident" id="7266535">Fatalf</span><span class="op" id="7266541">(</span><span class="string" id="7266542">&#34;Open:&nbsp;%v&#34;</span><span class="op" id="7266552">,</span>&nbsp;<span class="ident" id="7266554">err</span><span class="op" id="7266557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7266560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7266563">if</span>&nbsp;<span class="ident" id="7266566">_</span><span class="op" id="7266567">,</span>&nbsp;<span class="ident" id="7266569">err</span>&nbsp;<span class="op" id="7266573">:=</span>&nbsp;<span class="ident" id="7266576">db</span><span class="op" id="7266578">.</span><span class="ident" id="7266579">Exec</span><span class="op" id="7266583">(</span><span class="string" id="7266584">&#34;WIPE&#34;</span><span class="op" id="7266590">)</span><span class="op" id="7266591">;</span>&nbsp;<span class="ident" id="7266593">err</span>&nbsp;<span class="op" id="7266597">!=</span>&nbsp;<span class="ident" id="7266600">nil</span>&nbsp;<span class="op" id="7266604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7266608">t</span><span class="op" id="7266609">.</span><span class="ident" id="7266610">Fatalf</span><span class="op" id="7266616">(</span><span class="string" id="7266617">&#34;exec&nbsp;wipe:&nbsp;%v&#34;</span><span class="op" id="7266632">,</span>&nbsp;<span class="ident" id="7266634">err</span><span class="op" id="7266637">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7266640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7266643">defer</span>&nbsp;<span class="ident" id="7266649">closeDB</span><span class="op" id="7266656">(</span><span class="ident" id="7266657">t</span><span class="op" id="7266658">,</span>&nbsp;<span class="ident" id="7266660">db</span><span class="op" id="7266662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7266665">exec</span><span class="op" id="7266669">(</span><span class="ident" id="7266670">t</span><span class="op" id="7266671">,</span>&nbsp;<span class="ident" id="7266673">db</span><span class="op" id="7266675">,</span>&nbsp;<span class="string" id="7266677">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7266720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7266723">stmt</span><span class="op" id="7266727">,</span>&nbsp;<span class="ident" id="7266729">err</span>&nbsp;<span class="op" id="7266733">:=</span>&nbsp;<span class="ident" id="7266736">db</span><span class="op" id="7266738">.</span><span class="ident" id="7266739">Prepare</span><span class="op" id="7266746">(</span><span class="string" id="7266747">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="7266771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7266774">if</span>&nbsp;<span class="ident" id="7266777">err</span>&nbsp;<span class="op" id="7266781">!=</span>&nbsp;<span class="ident" id="7266784">nil</span>&nbsp;<span class="op" id="7266788">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7266792">t</span><span class="op" id="7266793">.</span><span class="ident" id="7266794">Fatalf</span><span class="op" id="7266800">(</span><span class="string" id="7266801">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="7266821">,</span>&nbsp;<span class="ident" id="7266823">stmt</span><span class="op" id="7266827">,</span>&nbsp;<span class="ident" id="7266829">err</span><span class="op" id="7266832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7266835">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7266838">defer</span>&nbsp;<span class="ident" id="7266844">stmt</span><span class="op" id="7266848">.</span><span class="ident" id="7266849">Close</span><span class="op" id="7266854">(</span><span class="op" id="7266855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7266858">tx</span><span class="op" id="7266860">,</span>&nbsp;<span class="ident" id="7266862">err</span>&nbsp;<span class="op" id="7266866">:=</span>&nbsp;<span class="ident" id="7266869">db</span><span class="op" id="7266871">.</span><span class="ident" id="7266872">Begin</span><span class="op" id="7266877">(</span><span class="op" id="7266878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7266881">if</span>&nbsp;<span class="ident" id="7266884">err</span>&nbsp;<span class="op" id="7266888">!=</span>&nbsp;<span class="ident" id="7266891">nil</span>&nbsp;<span class="op" id="7266895">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7266899">t</span><span class="op" id="7266900">.</span><span class="ident" id="7266901">Fatalf</span><span class="op" id="7266907">(</span><span class="string" id="7266908">&#34;Begin&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7266920">,</span>&nbsp;<span class="ident" id="7266922">err</span><span class="op" id="7266925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7266928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7266931">txs</span>&nbsp;<span class="op" id="7266935">:=</span>&nbsp;<span class="ident" id="7266938">tx</span><span class="op" id="7266940">.</span><span class="ident" id="7266941">Stmt</span><span class="op" id="7266945">(</span><span class="ident" id="7266946">stmt</span><span class="op" id="7266950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7266953">defer</span>&nbsp;<span class="ident" id="7266959">txs</span><span class="op" id="7266962">.</span><span class="ident" id="7266963">Close</span><span class="op" id="7266968">(</span><span class="op" id="7266969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7266972">_</span><span class="op" id="7266973">,</span>&nbsp;<span class="ident" id="7266975">err</span>&nbsp;<span class="op" id="7266979">=</span>&nbsp;<span class="ident" id="7266981">txs</span><span class="op" id="7266984">.</span><span class="ident" id="7266985">Exec</span><span class="op" id="7266989">(</span><span class="string" id="7266990">&#34;Bobby&#34;</span><span class="op" id="7266997">,</span>&nbsp;<span class="num" id="7266999">7</span><span class="op" id="7267000">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7267003">if</span>&nbsp;<span class="ident" id="7267006">err</span>&nbsp;<span class="op" id="7267010">!=</span>&nbsp;<span class="ident" id="7267013">nil</span>&nbsp;<span class="op" id="7267017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7267021">t</span><span class="op" id="7267022">.</span><span class="ident" id="7267023">Fatalf</span><span class="op" id="7267029">(</span><span class="string" id="7267030">&#34;Exec&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7267041">,</span>&nbsp;<span class="ident" id="7267043">err</span><span class="op" id="7267046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7267049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7267052">err</span>&nbsp;<span class="op" id="7267056">=</span>&nbsp;<span class="ident" id="7267058">tx</span><span class="op" id="7267060">.</span><span class="ident" id="7267061">Commit</span><span class="op" id="7267067">(</span><span class="op" id="7267068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7267071">if</span>&nbsp;<span class="ident" id="7267074">err</span>&nbsp;<span class="op" id="7267078">!=</span>&nbsp;<span class="ident" id="7267081">nil</span>&nbsp;<span class="op" id="7267085">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7267089">t</span><span class="op" id="7267090">.</span><span class="ident" id="7267091">Fatalf</span><span class="op" id="7267097">(</span><span class="string" id="7267098">&#34;Commit&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7267111">,</span>&nbsp;<span class="ident" id="7267113">err</span><span class="op" id="7267116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7267119">}</span><br>
<span class="lineno"></span><span class="op" id="7267121">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7267124">//&nbsp;Tests&nbsp;fix&nbsp;for&nbsp;issue&nbsp;2542,&nbsp;that&nbsp;we&nbsp;release&nbsp;a&nbsp;lock&nbsp;when&nbsp;querying&nbsp;on</span><br>
<span class="lineno">585</span><span class="comment" id="7267193">//&nbsp;a&nbsp;closed&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="7267217">func</span>&nbsp;<span class="ident" id="7267222">TestIssue2542Deadlock</span><span class="op" id="7267243">(</span><span class="ident" id="7267244">t</span>&nbsp;<span class="op" id="7267246">*</span><span class="ident" id="7267247">testing</span><span class="op" id="7267254">.</span><span class="ident" id="7267255">T</span><span class="op" id="7267256">)</span>&nbsp;<span class="op" id="7267258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7267261">db</span>&nbsp;<span class="op" id="7267264">:=</span>&nbsp;<span class="ident" id="7267267">newTestDB</span><span class="op" id="7267276">(</span><span class="ident" id="7267277">t</span><span class="op" id="7267278">,</span>&nbsp;<span class="string" id="7267280">&#34;people&#34;</span><span class="op" id="7267288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7267291">closeDB</span><span class="op" id="7267298">(</span><span class="ident" id="7267299">t</span><span class="op" id="7267300">,</span>&nbsp;<span class="ident" id="7267302">db</span><span class="op" id="7267304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7267307">for</span>&nbsp;<span class="ident" id="7267311">i</span>&nbsp;<span class="op" id="7267313">:=</span>&nbsp;<span class="num" id="7267316">0</span><span class="op" id="7267317">;</span>&nbsp;<span class="ident" id="7267319">i</span>&nbsp;<span class="op" id="7267321">&lt;</span>&nbsp;<span class="num" id="7267323">2</span><span class="op" id="7267324">;</span>&nbsp;<span class="ident" id="7267326">i</span><span class="op" id="7267327">++</span>&nbsp;<span class="op" id="7267330">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7267334">_</span><span class="op" id="7267335">,</span>&nbsp;<span class="ident" id="7267337">err</span>&nbsp;<span class="op" id="7267341">:=</span>&nbsp;<span class="ident" id="7267344">db</span><span class="op" id="7267346">.</span><span class="ident" id="7267347">Query</span><span class="op" id="7267352">(</span><span class="string" id="7267353">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="7267378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7267382">if</span>&nbsp;<span class="ident" id="7267385">err</span>&nbsp;<span class="op" id="7267389">==</span>&nbsp;<span class="ident" id="7267392">nil</span>&nbsp;<span class="op" id="7267396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7267401">t</span><span class="op" id="7267402">.</span><span class="ident" id="7267403">Fatalf</span><span class="op" id="7267409">(</span><span class="string" id="7267410">&#34;expected&nbsp;error&#34;</span><span class="op" id="7267426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7267430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7267433">}</span><br>
<span class="lineno">595</span><span class="op" id="7267435">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7267438">//&nbsp;From&nbsp;golang.org/issue/3865</span><br>
<span class="lineno"></span><span class="keyword" id="7267468">func</span>&nbsp;<span class="ident" id="7267473">TestCloseStmtBeforeRows</span><span class="op" id="7267496">(</span><span class="ident" id="7267497">t</span>&nbsp;<span class="op" id="7267499">*</span><span class="ident" id="7267500">testing</span><span class="op" id="7267507">.</span><span class="ident" id="7267508">T</span><span class="op" id="7267509">)</span>&nbsp;<span class="op" id="7267511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7267514">db</span>&nbsp;<span class="op" id="7267517">:=</span>&nbsp;<span class="ident" id="7267520">newTestDB</span><span class="op" id="7267529">(</span><span class="ident" id="7267530">t</span><span class="op" id="7267531">,</span>&nbsp;<span class="string" id="7267533">&#34;people&#34;</span><span class="op" id="7267541">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7267544">defer</span>&nbsp;<span class="ident" id="7267550">closeDB</span><span class="op" id="7267557">(</span><span class="ident" id="7267558">t</span><span class="op" id="7267559">,</span>&nbsp;<span class="ident" id="7267561">db</span><span class="op" id="7267563">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7267567">s</span><span class="op" id="7267568">,</span>&nbsp;<span class="ident" id="7267570">err</span>&nbsp;<span class="op" id="7267574">:=</span>&nbsp;<span class="ident" id="7267577">db</span><span class="op" id="7267579">.</span><span class="ident" id="7267580">Prepare</span><span class="op" id="7267587">(</span><span class="string" id="7267588">&#34;SELECT|people|name|&#34;</span><span class="op" id="7267609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7267612">if</span>&nbsp;<span class="ident" id="7267615">err</span>&nbsp;<span class="op" id="7267619">!=</span>&nbsp;<span class="ident" id="7267622">nil</span>&nbsp;<span class="op" id="7267626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7267630">t</span><span class="op" id="7267631">.</span><span class="ident" id="7267632">Fatal</span><span class="op" id="7267637">(</span><span class="ident" id="7267638">err</span><span class="op" id="7267641">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7267644">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7267648">r</span><span class="op" id="7267649">,</span>&nbsp;<span class="ident" id="7267651">err</span>&nbsp;<span class="op" id="7267655">:=</span>&nbsp;<span class="ident" id="7267658">s</span><span class="op" id="7267659">.</span><span class="ident" id="7267660">Query</span><span class="op" id="7267665">(</span><span class="op" id="7267666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7267669">if</span>&nbsp;<span class="ident" id="7267672">err</span>&nbsp;<span class="op" id="7267676">!=</span>&nbsp;<span class="ident" id="7267679">nil</span>&nbsp;<span class="op" id="7267683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7267687">s</span><span class="op" id="7267688">.</span><span class="ident" id="7267689">Close</span><span class="op" id="7267694">(</span><span class="op" id="7267695">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7267699">t</span><span class="op" id="7267700">.</span><span class="ident" id="7267701">Fatal</span><span class="op" id="7267706">(</span><span class="ident" id="7267707">err</span><span class="op" id="7267710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7267713">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7267717">err</span>&nbsp;<span class="op" id="7267721">=</span>&nbsp;<span class="ident" id="7267723">s</span><span class="op" id="7267724">.</span><span class="ident" id="7267725">Close</span><span class="op" id="7267730">(</span><span class="op" id="7267731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7267734">if</span>&nbsp;<span class="ident" id="7267737">err</span>&nbsp;<span class="op" id="7267741">!=</span>&nbsp;<span class="ident" id="7267744">nil</span>&nbsp;<span class="op" id="7267748">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7267752">t</span><span class="op" id="7267753">.</span><span class="ident" id="7267754">Fatal</span><span class="op" id="7267759">(</span><span class="ident" id="7267760">err</span><span class="op" id="7267763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7267766">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7267770">r</span><span class="op" id="7267771">.</span><span class="ident" id="7267772">Close</span><span class="op" id="7267777">(</span><span class="op" id="7267778">)</span><br>
<span class="lineno"></span><span class="op" id="7267780">}</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="comment" id="7267783">//&nbsp;Tests&nbsp;fix&nbsp;for&nbsp;issue&nbsp;2788,&nbsp;that&nbsp;we&nbsp;bind&nbsp;nil&nbsp;to&nbsp;a&nbsp;[]byte&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="7267848">//&nbsp;value&nbsp;in&nbsp;the&nbsp;column&nbsp;is&nbsp;sql&nbsp;null</span><br>
<span class="lineno"></span><span class="keyword" id="7267883">func</span>&nbsp;<span class="ident" id="7267888">TestNullByteSlice</span><span class="op" id="7267905">(</span><span class="ident" id="7267906">t</span>&nbsp;<span class="op" id="7267908">*</span><span class="ident" id="7267909">testing</span><span class="op" id="7267916">.</span><span class="ident" id="7267917">T</span><span class="op" id="7267918">)</span>&nbsp;<span class="op" id="7267920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7267923">db</span>&nbsp;<span class="op" id="7267926">:=</span>&nbsp;<span class="ident" id="7267929">newTestDB</span><span class="op" id="7267938">(</span><span class="ident" id="7267939">t</span><span class="op" id="7267940">,</span>&nbsp;<span class="string" id="7267942">&#34;&#34;</span><span class="op" id="7267944">)</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7267947">defer</span>&nbsp;<span class="ident" id="7267953">closeDB</span><span class="op" id="7267960">(</span><span class="ident" id="7267961">t</span><span class="op" id="7267962">,</span>&nbsp;<span class="ident" id="7267964">db</span><span class="op" id="7267966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7267969">exec</span><span class="op" id="7267973">(</span><span class="ident" id="7267974">t</span><span class="op" id="7267975">,</span>&nbsp;<span class="ident" id="7267977">db</span><span class="op" id="7267979">,</span>&nbsp;<span class="string" id="7267981">&#34;CREATE|t|id=int32,name=nullstring&#34;</span><span class="op" id="7268016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7268019">exec</span><span class="op" id="7268023">(</span><span class="ident" id="7268024">t</span><span class="op" id="7268025">,</span>&nbsp;<span class="ident" id="7268027">db</span><span class="op" id="7268029">,</span>&nbsp;<span class="string" id="7268031">&#34;INSERT|t|id=10,name=?&#34;</span><span class="op" id="7268054">,</span>&nbsp;<span class="ident" id="7268056">nil</span><span class="op" id="7268059">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7268063">var</span>&nbsp;<span class="ident" id="7268067">name</span>&nbsp;<span class="op" id="7268072">[</span><span class="op" id="7268073">]</span><span class="builtintype" id="7268074">byte</span><br>
<span class="lineno">630</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7268081">err</span>&nbsp;<span class="op" id="7268085">:=</span>&nbsp;<span class="ident" id="7268088">db</span><span class="op" id="7268090">.</span><span class="ident" id="7268091">QueryRow</span><span class="op" id="7268099">(</span><span class="string" id="7268100">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="7268120">,</span>&nbsp;<span class="num" id="7268122">10</span><span class="op" id="7268124">)</span><span class="op" id="7268125">.</span><span class="ident" id="7268126">Scan</span><span class="op" id="7268130">(</span><span class="op" id="7268131">&amp;</span><span class="ident" id="7268132">name</span><span class="op" id="7268136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7268139">if</span>&nbsp;<span class="ident" id="7268142">err</span>&nbsp;<span class="op" id="7268146">!=</span>&nbsp;<span class="ident" id="7268149">nil</span>&nbsp;<span class="op" id="7268153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7268157">t</span><span class="op" id="7268158">.</span><span class="ident" id="7268159">Fatal</span><span class="op" id="7268164">(</span><span class="ident" id="7268165">err</span><span class="op" id="7268168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7268171">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7268174">if</span>&nbsp;<span class="ident" id="7268177">name</span>&nbsp;<span class="op" id="7268182">!=</span>&nbsp;<span class="ident" id="7268185">nil</span>&nbsp;<span class="op" id="7268189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7268193">t</span><span class="op" id="7268194">.</span><span class="ident" id="7268195">Fatalf</span><span class="op" id="7268201">(</span><span class="string" id="7268202">&#34;name&nbsp;[]byte&nbsp;should&nbsp;be&nbsp;nil&nbsp;for&nbsp;null&nbsp;column&nbsp;value,&nbsp;got:&nbsp;%#v&#34;</span><span class="op" id="7268261">,</span>&nbsp;<span class="ident" id="7268263">name</span><span class="op" id="7268267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7268270">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7268274">exec</span><span class="op" id="7268278">(</span><span class="ident" id="7268279">t</span><span class="op" id="7268280">,</span>&nbsp;<span class="ident" id="7268282">db</span><span class="op" id="7268284">,</span>&nbsp;<span class="string" id="7268286">&#34;INSERT|t|id=11,name=?&#34;</span><span class="op" id="7268309">,</span>&nbsp;<span class="string" id="7268311">&#34;bob&#34;</span><span class="op" id="7268316">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7268319">err</span>&nbsp;<span class="op" id="7268323">=</span>&nbsp;<span class="ident" id="7268325">db</span><span class="op" id="7268327">.</span><span class="ident" id="7268328">QueryRow</span><span class="op" id="7268336">(</span><span class="string" id="7268337">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="7268357">,</span>&nbsp;<span class="num" id="7268359">11</span><span class="op" id="7268361">)</span><span class="op" id="7268362">.</span><span class="ident" id="7268363">Scan</span><span class="op" id="7268367">(</span><span class="op" id="7268368">&amp;</span><span class="ident" id="7268369">name</span><span class="op" id="7268373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7268376">if</span>&nbsp;<span class="ident" id="7268379">err</span>&nbsp;<span class="op" id="7268383">!=</span>&nbsp;<span class="ident" id="7268386">nil</span>&nbsp;<span class="op" id="7268390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7268394">t</span><span class="op" id="7268395">.</span><span class="ident" id="7268396">Fatal</span><span class="op" id="7268401">(</span><span class="ident" id="7268402">err</span><span class="op" id="7268405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7268408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7268411">if</span>&nbsp;<span class="builtintype" id="7268414">string</span><span class="op" id="7268420">(</span><span class="ident" id="7268421">name</span><span class="op" id="7268425">)</span>&nbsp;<span class="op" id="7268427">!=</span>&nbsp;<span class="string" id="7268430">&#34;bob&#34;</span>&nbsp;<span class="op" id="7268436">{</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7268440">t</span><span class="op" id="7268441">.</span><span class="ident" id="7268442">Fatalf</span><span class="op" id="7268448">(</span><span class="string" id="7268449">&#34;name&nbsp;[]byte&nbsp;should&nbsp;be&nbsp;bob,&nbsp;got:&nbsp;%q&#34;</span><span class="op" id="7268485">,</span>&nbsp;<span class="builtintype" id="7268487">string</span><span class="op" id="7268493">(</span><span class="ident" id="7268494">name</span><span class="op" id="7268498">)</span><span class="op" id="7268499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7268502">}</span><br>
<span class="lineno"></span><span class="op" id="7268504">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7268507">func</span>&nbsp;<span class="ident" id="7268512">TestPointerParamsAndScans</span><span class="op" id="7268537">(</span><span class="ident" id="7268538">t</span>&nbsp;<span class="op" id="7268540">*</span><span class="ident" id="7268541">testing</span><span class="op" id="7268548">.</span><span class="ident" id="7268549">T</span><span class="op" id="7268550">)</span>&nbsp;<span class="op" id="7268552">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7268555">db</span>&nbsp;<span class="op" id="7268558">:=</span>&nbsp;<span class="ident" id="7268561">newTestDB</span><span class="op" id="7268570">(</span><span class="ident" id="7268571">t</span><span class="op" id="7268572">,</span>&nbsp;<span class="string" id="7268574">&#34;&#34;</span><span class="op" id="7268576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7268579">defer</span>&nbsp;<span class="ident" id="7268585">closeDB</span><span class="op" id="7268592">(</span><span class="ident" id="7268593">t</span><span class="op" id="7268594">,</span>&nbsp;<span class="ident" id="7268596">db</span><span class="op" id="7268598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7268601">exec</span><span class="op" id="7268605">(</span><span class="ident" id="7268606">t</span><span class="op" id="7268607">,</span>&nbsp;<span class="ident" id="7268609">db</span><span class="op" id="7268611">,</span>&nbsp;<span class="string" id="7268613">&#34;CREATE|t|id=int32,name=nullstring&#34;</span><span class="op" id="7268648">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7268652">bob</span>&nbsp;<span class="op" id="7268656">:=</span>&nbsp;<span class="string" id="7268659">&#34;bob&#34;</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7268666">var</span>&nbsp;<span class="ident" id="7268670">name</span>&nbsp;<span class="op" id="7268675">*</span><span class="builtintype" id="7268676">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7268685">name</span>&nbsp;<span class="op" id="7268690">=</span>&nbsp;<span class="op" id="7268692">&amp;</span><span class="ident" id="7268693">bob</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7268698">exec</span><span class="op" id="7268702">(</span><span class="ident" id="7268703">t</span><span class="op" id="7268704">,</span>&nbsp;<span class="ident" id="7268706">db</span><span class="op" id="7268708">,</span>&nbsp;<span class="string" id="7268710">&#34;INSERT|t|id=10,name=?&#34;</span><span class="op" id="7268733">,</span>&nbsp;<span class="ident" id="7268735">name</span><span class="op" id="7268739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7268742">name</span>&nbsp;<span class="op" id="7268747">=</span>&nbsp;<span class="ident" id="7268749">nil</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7268754">exec</span><span class="op" id="7268758">(</span><span class="ident" id="7268759">t</span><span class="op" id="7268760">,</span>&nbsp;<span class="ident" id="7268762">db</span><span class="op" id="7268764">,</span>&nbsp;<span class="string" id="7268766">&#34;INSERT|t|id=20,name=?&#34;</span><span class="op" id="7268789">,</span>&nbsp;<span class="ident" id="7268791">name</span><span class="op" id="7268795">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7268799">err</span>&nbsp;<span class="op" id="7268803">:=</span>&nbsp;<span class="ident" id="7268806">db</span><span class="op" id="7268808">.</span><span class="ident" id="7268809">QueryRow</span><span class="op" id="7268817">(</span><span class="string" id="7268818">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="7268838">,</span>&nbsp;<span class="num" id="7268840">10</span><span class="op" id="7268842">)</span><span class="op" id="7268843">.</span><span class="ident" id="7268844">Scan</span><span class="op" id="7268848">(</span><span class="op" id="7268849">&amp;</span><span class="ident" id="7268850">name</span><span class="op" id="7268854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7268857">if</span>&nbsp;<span class="ident" id="7268860">err</span>&nbsp;<span class="op" id="7268864">!=</span>&nbsp;<span class="ident" id="7268867">nil</span>&nbsp;<span class="op" id="7268871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7268875">t</span><span class="op" id="7268876">.</span><span class="ident" id="7268877">Fatalf</span><span class="op" id="7268883">(</span><span class="string" id="7268884">&#34;querying&nbsp;id&nbsp;10:&nbsp;%v&#34;</span><span class="op" id="7268904">,</span>&nbsp;<span class="ident" id="7268906">err</span><span class="op" id="7268909">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7268912">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7268915">if</span>&nbsp;<span class="ident" id="7268918">name</span>&nbsp;<span class="op" id="7268923">==</span>&nbsp;<span class="ident" id="7268926">nil</span>&nbsp;<span class="op" id="7268930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7268934">t</span><span class="op" id="7268935">.</span><span class="ident" id="7268936">Errorf</span><span class="op" id="7268942">(</span><span class="string" id="7268943">&#34;id&nbsp;10&#39;s&nbsp;name&nbsp;=&nbsp;nil;&nbsp;want&nbsp;bob&#34;</span><span class="op" id="7268973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7268976">}</span>&nbsp;<span class="keyword" id="7268978">else</span>&nbsp;<span class="keyword" id="7268983">if</span>&nbsp;<span class="op" id="7268986">*</span><span class="ident" id="7268987">name</span>&nbsp;<span class="op" id="7268992">!=</span>&nbsp;<span class="string" id="7268995">&#34;bob&#34;</span>&nbsp;<span class="op" id="7269001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7269005">t</span><span class="op" id="7269006">.</span><span class="ident" id="7269007">Errorf</span><span class="op" id="7269013">(</span><span class="string" id="7269014">&#34;id&nbsp;10&#39;s&nbsp;name&nbsp;=&nbsp;%q;&nbsp;want&nbsp;bob&#34;</span><span class="op" id="7269043">,</span>&nbsp;<span class="op" id="7269045">*</span><span class="ident" id="7269046">name</span><span class="op" id="7269050">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7269053">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7269057">err</span>&nbsp;<span class="op" id="7269061">=</span>&nbsp;<span class="ident" id="7269063">db</span><span class="op" id="7269065">.</span><span class="ident" id="7269066">QueryRow</span><span class="op" id="7269074">(</span><span class="string" id="7269075">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="7269095">,</span>&nbsp;<span class="num" id="7269097">20</span><span class="op" id="7269099">)</span><span class="op" id="7269100">.</span><span class="ident" id="7269101">Scan</span><span class="op" id="7269105">(</span><span class="op" id="7269106">&amp;</span><span class="ident" id="7269107">name</span><span class="op" id="7269111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7269114">if</span>&nbsp;<span class="ident" id="7269117">err</span>&nbsp;<span class="op" id="7269121">!=</span>&nbsp;<span class="ident" id="7269124">nil</span>&nbsp;<span class="op" id="7269128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7269132">t</span><span class="op" id="7269133">.</span><span class="ident" id="7269134">Fatalf</span><span class="op" id="7269140">(</span><span class="string" id="7269141">&#34;querying&nbsp;id&nbsp;20:&nbsp;%v&#34;</span><span class="op" id="7269161">,</span>&nbsp;<span class="ident" id="7269163">err</span><span class="op" id="7269166">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7269169">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7269172">if</span>&nbsp;<span class="ident" id="7269175">name</span>&nbsp;<span class="op" id="7269180">!=</span>&nbsp;<span class="ident" id="7269183">nil</span>&nbsp;<span class="op" id="7269187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7269191">t</span><span class="op" id="7269192">.</span><span class="ident" id="7269193">Errorf</span><span class="op" id="7269199">(</span><span class="string" id="7269200">&#34;id&nbsp;20&nbsp;=&nbsp;%q;&nbsp;want&nbsp;nil&#34;</span><span class="op" id="7269222">,</span>&nbsp;<span class="op" id="7269224">*</span><span class="ident" id="7269225">name</span><span class="op" id="7269229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7269232">}</span><br>
<span class="lineno"></span><span class="op" id="7269234">}</span><br>
<span class="lineno">680</span><br>
<span class="lineno"></span><span class="keyword" id="7269237">func</span>&nbsp;<span class="ident" id="7269242">TestQueryRowClosingStmt</span><span class="op" id="7269265">(</span><span class="ident" id="7269266">t</span>&nbsp;<span class="op" id="7269268">*</span><span class="ident" id="7269269">testing</span><span class="op" id="7269276">.</span><span class="ident" id="7269277">T</span><span class="op" id="7269278">)</span>&nbsp;<span class="op" id="7269280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7269283">db</span>&nbsp;<span class="op" id="7269286">:=</span>&nbsp;<span class="ident" id="7269289">newTestDB</span><span class="op" id="7269298">(</span><span class="ident" id="7269299">t</span><span class="op" id="7269300">,</span>&nbsp;<span class="string" id="7269302">&#34;people&#34;</span><span class="op" id="7269310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7269313">defer</span>&nbsp;<span class="ident" id="7269319">closeDB</span><span class="op" id="7269326">(</span><span class="ident" id="7269327">t</span><span class="op" id="7269328">,</span>&nbsp;<span class="ident" id="7269330">db</span><span class="op" id="7269332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7269335">var</span>&nbsp;<span class="ident" id="7269339">name</span>&nbsp;<span class="builtintype" id="7269344">string</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7269352">var</span>&nbsp;<span class="ident" id="7269356">age</span>&nbsp;<span class="builtintype" id="7269360">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7269365">err</span>&nbsp;<span class="op" id="7269369">:=</span>&nbsp;<span class="ident" id="7269372">db</span><span class="op" id="7269374">.</span><span class="ident" id="7269375">QueryRow</span><span class="op" id="7269383">(</span><span class="string" id="7269384">&#34;SELECT|people|age,name|age=?&#34;</span><span class="op" id="7269414">,</span>&nbsp;<span class="num" id="7269416">3</span><span class="op" id="7269417">)</span><span class="op" id="7269418">.</span><span class="ident" id="7269419">Scan</span><span class="op" id="7269423">(</span><span class="op" id="7269424">&amp;</span><span class="ident" id="7269425">age</span><span class="op" id="7269428">,</span>&nbsp;<span class="op" id="7269430">&amp;</span><span class="ident" id="7269431">name</span><span class="op" id="7269435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7269438">if</span>&nbsp;<span class="ident" id="7269441">err</span>&nbsp;<span class="op" id="7269445">!=</span>&nbsp;<span class="ident" id="7269448">nil</span>&nbsp;<span class="op" id="7269452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7269456">t</span><span class="op" id="7269457">.</span><span class="ident" id="7269458">Fatal</span><span class="op" id="7269463">(</span><span class="ident" id="7269464">err</span><span class="op" id="7269467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7269470">}</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7269473">if</span>&nbsp;<span class="builtinfunc" id="7269476">len</span><span class="op" id="7269479">(</span><span class="ident" id="7269480">db</span><span class="op" id="7269482">.</span><span class="ident" id="7269483">freeConn</span><span class="op" id="7269491">)</span>&nbsp;<span class="op" id="7269493">!=</span>&nbsp;<span class="num" id="7269496">1</span>&nbsp;<span class="op" id="7269498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7269502">t</span><span class="op" id="7269503">.</span><span class="ident" id="7269504">Fatalf</span><span class="op" id="7269510">(</span><span class="string" id="7269511">&#34;expected&nbsp;1&nbsp;free&nbsp;conn&#34;</span><span class="op" id="7269533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7269536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7269539">fakeConn</span>&nbsp;<span class="op" id="7269548">:=</span>&nbsp;<span class="ident" id="7269551">db</span><span class="op" id="7269553">.</span><span class="ident" id="7269554">freeConn</span><span class="op" id="7269562">[</span><span class="num" id="7269563">0</span><span class="op" id="7269564">]</span><span class="op" id="7269565">.</span><span class="ident" id="7269566">ci</span><span class="op" id="7269568">.</span><span class="op" id="7269569">(</span><span class="op" id="7269570">*</span><span class="ident" id="7269571">fakeConn</span><span class="op" id="7269579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7269582">if</span>&nbsp;<span class="ident" id="7269585">made</span><span class="op" id="7269589">,</span>&nbsp;<span class="ident" id="7269591">closed</span>&nbsp;<span class="op" id="7269598">:=</span>&nbsp;<span class="ident" id="7269601">fakeConn</span><span class="op" id="7269609">.</span><span class="ident" id="7269610">stmtsMade</span><span class="op" id="7269619">,</span>&nbsp;<span class="ident" id="7269621">fakeConn</span><span class="op" id="7269629">.</span><span class="ident" id="7269630">stmtsClosed</span><span class="op" id="7269641">;</span>&nbsp;<span class="ident" id="7269643">made</span>&nbsp;<span class="op" id="7269648">!=</span>&nbsp;<span class="ident" id="7269651">closed</span>&nbsp;<span class="op" id="7269658">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7269662">t</span><span class="op" id="7269663">.</span><span class="ident" id="7269664">Errorf</span><span class="op" id="7269670">(</span><span class="string" id="7269671">&#34;statement&nbsp;close&nbsp;mismatch:&nbsp;made&nbsp;%d,&nbsp;closed&nbsp;%d&#34;</span><span class="op" id="7269717">,</span>&nbsp;<span class="ident" id="7269719">made</span><span class="op" id="7269723">,</span>&nbsp;<span class="ident" id="7269725">closed</span><span class="op" id="7269731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7269734">}</span><br>
<span class="lineno"></span><span class="op" id="7269736">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7269739">//&nbsp;Test&nbsp;issue&nbsp;6651</span><br>
<span class="lineno">700</span><span class="keyword" id="7269758">func</span>&nbsp;<span class="ident" id="7269763">TestIssue6651</span><span class="op" id="7269776">(</span><span class="ident" id="7269777">t</span>&nbsp;<span class="op" id="7269779">*</span><span class="ident" id="7269780">testing</span><span class="op" id="7269787">.</span><span class="ident" id="7269788">T</span><span class="op" id="7269789">)</span>&nbsp;<span class="op" id="7269791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7269794">db</span>&nbsp;<span class="op" id="7269797">:=</span>&nbsp;<span class="ident" id="7269800">newTestDB</span><span class="op" id="7269809">(</span><span class="ident" id="7269810">t</span><span class="op" id="7269811">,</span>&nbsp;<span class="string" id="7269813">&#34;people&#34;</span><span class="op" id="7269821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7269824">defer</span>&nbsp;<span class="ident" id="7269830">closeDB</span><span class="op" id="7269837">(</span><span class="ident" id="7269838">t</span><span class="op" id="7269839">,</span>&nbsp;<span class="ident" id="7269841">db</span><span class="op" id="7269843">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7269847">var</span>&nbsp;<span class="ident" id="7269851">v</span>&nbsp;<span class="builtintype" id="7269853">string</span><br>
<span class="lineno">705</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7269862">want</span>&nbsp;<span class="op" id="7269867">:=</span>&nbsp;<span class="string" id="7269870">&#34;error&nbsp;in&nbsp;rows.Next&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7269892">rowsCursorNextHook</span>&nbsp;<span class="op" id="7269911">=</span>&nbsp;<span class="keyword" id="7269913">func</span><span class="op" id="7269917">(</span><span class="ident" id="7269918">dest</span>&nbsp;<span class="op" id="7269923">[</span><span class="op" id="7269924">]</span><span class="ident" id="7269925">driver</span><span class="op" id="7269931">.</span><span class="ident" id="7269932">Value</span><span class="op" id="7269937">)</span>&nbsp;<span class="builtintype" id="7269939">error</span>&nbsp;<span class="op" id="7269945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7269949">return</span>&nbsp;<span class="ident" id="7269956">fmt</span><span class="op" id="7269959">.</span><span class="ident" id="7269960">Errorf</span><span class="op" id="7269966">(</span><span class="ident" id="7269967">want</span><span class="op" id="7269971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7269974">}</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7269977">defer</span>&nbsp;<span class="keyword" id="7269983">func</span><span class="op" id="7269987">(</span><span class="op" id="7269988">)</span>&nbsp;<span class="op" id="7269990">{</span>&nbsp;<span class="ident" id="7269992">rowsCursorNextHook</span>&nbsp;<span class="op" id="7270011">=</span>&nbsp;<span class="ident" id="7270013">nil</span>&nbsp;<span class="op" id="7270017">}</span><span class="op" id="7270018">(</span><span class="op" id="7270019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7270022">err</span>&nbsp;<span class="op" id="7270026">:=</span>&nbsp;<span class="ident" id="7270029">db</span><span class="op" id="7270031">.</span><span class="ident" id="7270032">QueryRow</span><span class="op" id="7270040">(</span><span class="string" id="7270041">&#34;SELECT|people|name|&#34;</span><span class="op" id="7270062">)</span><span class="op" id="7270063">.</span><span class="ident" id="7270064">Scan</span><span class="op" id="7270068">(</span><span class="op" id="7270069">&amp;</span><span class="ident" id="7270070">v</span><span class="op" id="7270071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7270074">if</span>&nbsp;<span class="ident" id="7270077">err</span>&nbsp;<span class="op" id="7270081">==</span>&nbsp;<span class="ident" id="7270084">nil</span>&nbsp;<span class="op" id="7270088">||</span>&nbsp;<span class="ident" id="7270091">err</span><span class="op" id="7270094">.</span><span class="ident" id="7270095">Error</span><span class="op" id="7270100">(</span><span class="op" id="7270101">)</span>&nbsp;<span class="op" id="7270103">!=</span>&nbsp;<span class="ident" id="7270106">want</span>&nbsp;<span class="op" id="7270111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7270115">t</span><span class="op" id="7270116">.</span><span class="ident" id="7270117">Errorf</span><span class="op" id="7270123">(</span><span class="string" id="7270124">&#34;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7270145">,</span>&nbsp;<span class="ident" id="7270147">err</span><span class="op" id="7270150">,</span>&nbsp;<span class="ident" id="7270152">want</span><span class="op" id="7270156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7270159">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7270162">rowsCursorNextHook</span>&nbsp;<span class="op" id="7270181">=</span>&nbsp;<span class="ident" id="7270183">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7270189">want</span>&nbsp;<span class="op" id="7270194">=</span>&nbsp;<span class="string" id="7270196">&#34;error&nbsp;in&nbsp;rows.Close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7270219">rowsCloseHook</span>&nbsp;<span class="op" id="7270233">=</span>&nbsp;<span class="keyword" id="7270235">func</span><span class="op" id="7270239">(</span><span class="ident" id="7270240">rows</span>&nbsp;<span class="op" id="7270245">*</span><span class="ident" id="7270246">Rows</span><span class="op" id="7270250">,</span>&nbsp;<span class="ident" id="7270252">err</span>&nbsp;<span class="op" id="7270256">*</span><span class="builtintype" id="7270257">error</span><span class="op" id="7270262">)</span>&nbsp;<span class="op" id="7270264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7270268">*</span><span class="ident" id="7270269">err</span>&nbsp;<span class="op" id="7270273">=</span>&nbsp;<span class="ident" id="7270275">fmt</span><span class="op" id="7270278">.</span><span class="ident" id="7270279">Errorf</span><span class="op" id="7270285">(</span><span class="ident" id="7270286">want</span><span class="op" id="7270290">)</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7270293">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7270296">defer</span>&nbsp;<span class="keyword" id="7270302">func</span><span class="op" id="7270306">(</span><span class="op" id="7270307">)</span>&nbsp;<span class="op" id="7270309">{</span>&nbsp;<span class="ident" id="7270311">rowsCloseHook</span>&nbsp;<span class="op" id="7270325">=</span>&nbsp;<span class="ident" id="7270327">nil</span>&nbsp;<span class="op" id="7270331">}</span><span class="op" id="7270332">(</span><span class="op" id="7270333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7270336">err</span>&nbsp;<span class="op" id="7270340">=</span>&nbsp;<span class="ident" id="7270342">db</span><span class="op" id="7270344">.</span><span class="ident" id="7270345">QueryRow</span><span class="op" id="7270353">(</span><span class="string" id="7270354">&#34;SELECT|people|name|&#34;</span><span class="op" id="7270375">)</span><span class="op" id="7270376">.</span><span class="ident" id="7270377">Scan</span><span class="op" id="7270381">(</span><span class="op" id="7270382">&amp;</span><span class="ident" id="7270383">v</span><span class="op" id="7270384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7270387">if</span>&nbsp;<span class="ident" id="7270390">err</span>&nbsp;<span class="op" id="7270394">==</span>&nbsp;<span class="ident" id="7270397">nil</span>&nbsp;<span class="op" id="7270401">||</span>&nbsp;<span class="ident" id="7270404">err</span><span class="op" id="7270407">.</span><span class="ident" id="7270408">Error</span><span class="op" id="7270413">(</span><span class="op" id="7270414">)</span>&nbsp;<span class="op" id="7270416">!=</span>&nbsp;<span class="ident" id="7270419">want</span>&nbsp;<span class="op" id="7270424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7270428">t</span><span class="op" id="7270429">.</span><span class="ident" id="7270430">Errorf</span><span class="op" id="7270436">(</span><span class="string" id="7270437">&#34;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7270458">,</span>&nbsp;<span class="ident" id="7270460">err</span><span class="op" id="7270463">,</span>&nbsp;<span class="ident" id="7270465">want</span><span class="op" id="7270469">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7270472">}</span><br>
<span class="lineno"></span><span class="op" id="7270474">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7270477">type</span>&nbsp;<span class="ident" id="7270482">nullTestRow</span>&nbsp;<span class="keyword" id="7270494">struct</span>&nbsp;<span class="op" id="7270501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7270504">nullParam</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7270517">interface</span><span class="op" id="7270526">{</span><span class="op" id="7270527">}</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7270530">notNullParam</span>&nbsp;<span class="keyword" id="7270543">interface</span><span class="op" id="7270552">{</span><span class="op" id="7270553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7270556">scanNullVal</span>&nbsp;&nbsp;<span class="keyword" id="7270569">interface</span><span class="op" id="7270578">{</span><span class="op" id="7270579">}</span><br>
<span class="lineno"></span><span class="op" id="7270581">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7270584">type</span>&nbsp;<span class="ident" id="7270589">nullTestSpec</span>&nbsp;<span class="keyword" id="7270602">struct</span>&nbsp;<span class="op" id="7270609">{</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7270612">nullType</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7270624">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7270632">notNullType</span>&nbsp;<span class="builtintype" id="7270644">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7270652">rows</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7270664">[</span><span class="num" id="7270665">6</span><span class="op" id="7270666">]</span><span class="ident" id="7270667">nullTestRow</span><br>
<span class="lineno"></span><span class="op" id="7270679">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">740</span><span class="keyword" id="7270682">func</span>&nbsp;<span class="ident" id="7270687">TestNullStringParam</span><span class="op" id="7270706">(</span><span class="ident" id="7270707">t</span>&nbsp;<span class="op" id="7270709">*</span><span class="ident" id="7270710">testing</span><span class="op" id="7270717">.</span><span class="ident" id="7270718">T</span><span class="op" id="7270719">)</span>&nbsp;<span class="op" id="7270721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7270724">spec</span>&nbsp;<span class="op" id="7270729">:=</span>&nbsp;<span class="ident" id="7270732">nullTestSpec</span><span class="op" id="7270744">{</span><span class="string" id="7270745">&#34;nullstring&#34;</span><span class="op" id="7270757">,</span>&nbsp;<span class="string" id="7270759">&#34;string&#34;</span><span class="op" id="7270767">,</span>&nbsp;<span class="op" id="7270769">[</span><span class="num" id="7270770">6</span><span class="op" id="7270771">]</span><span class="ident" id="7270772">nullTestRow</span><span class="op" id="7270783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7270787">{</span><span class="ident" id="7270788">NullString</span><span class="op" id="7270798">{</span><span class="string" id="7270799">&#34;aqua&#34;</span><span class="op" id="7270805">,</span>&nbsp;<span class="ident" id="7270807">true</span><span class="op" id="7270811">}</span><span class="op" id="7270812">,</span>&nbsp;<span class="string" id="7270814">&#34;&#34;</span><span class="op" id="7270816">,</span>&nbsp;<span class="ident" id="7270818">NullString</span><span class="op" id="7270828">{</span><span class="string" id="7270829">&#34;aqua&#34;</span><span class="op" id="7270835">,</span>&nbsp;<span class="ident" id="7270837">true</span><span class="op" id="7270841">}</span><span class="op" id="7270842">}</span><span class="op" id="7270843">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7270847">{</span><span class="ident" id="7270848">NullString</span><span class="op" id="7270858">{</span><span class="string" id="7270859">&#34;brown&#34;</span><span class="op" id="7270866">,</span>&nbsp;<span class="ident" id="7270868">false</span><span class="op" id="7270873">}</span><span class="op" id="7270874">,</span>&nbsp;<span class="string" id="7270876">&#34;&#34;</span><span class="op" id="7270878">,</span>&nbsp;<span class="ident" id="7270880">NullString</span><span class="op" id="7270890">{</span><span class="string" id="7270891">&#34;&#34;</span><span class="op" id="7270893">,</span>&nbsp;<span class="ident" id="7270895">false</span><span class="op" id="7270900">}</span><span class="op" id="7270901">}</span><span class="op" id="7270902">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7270906">{</span><span class="string" id="7270907">&#34;chartreuse&#34;</span><span class="op" id="7270919">,</span>&nbsp;<span class="string" id="7270921">&#34;&#34;</span><span class="op" id="7270923">,</span>&nbsp;<span class="ident" id="7270925">NullString</span><span class="op" id="7270935">{</span><span class="string" id="7270936">&#34;chartreuse&#34;</span><span class="op" id="7270948">,</span>&nbsp;<span class="ident" id="7270950">true</span><span class="op" id="7270954">}</span><span class="op" id="7270955">}</span><span class="op" id="7270956">,</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7270960">{</span><span class="ident" id="7270961">NullString</span><span class="op" id="7270971">{</span><span class="string" id="7270972">&#34;darkred&#34;</span><span class="op" id="7270981">,</span>&nbsp;<span class="ident" id="7270983">true</span><span class="op" id="7270987">}</span><span class="op" id="7270988">,</span>&nbsp;<span class="string" id="7270990">&#34;&#34;</span><span class="op" id="7270992">,</span>&nbsp;<span class="ident" id="7270994">NullString</span><span class="op" id="7271004">{</span><span class="string" id="7271005">&#34;darkred&#34;</span><span class="op" id="7271014">,</span>&nbsp;<span class="ident" id="7271016">true</span><span class="op" id="7271020">}</span><span class="op" id="7271021">}</span><span class="op" id="7271022">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7271026">{</span><span class="ident" id="7271027">NullString</span><span class="op" id="7271037">{</span><span class="string" id="7271038">&#34;eel&#34;</span><span class="op" id="7271043">,</span>&nbsp;<span class="ident" id="7271045">false</span><span class="op" id="7271050">}</span><span class="op" id="7271051">,</span>&nbsp;<span class="string" id="7271053">&#34;&#34;</span><span class="op" id="7271055">,</span>&nbsp;<span class="ident" id="7271057">NullString</span><span class="op" id="7271067">{</span><span class="string" id="7271068">&#34;&#34;</span><span class="op" id="7271070">,</span>&nbsp;<span class="ident" id="7271072">false</span><span class="op" id="7271077">}</span><span class="op" id="7271078">}</span><span class="op" id="7271079">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7271083">{</span><span class="string" id="7271084">&#34;foo&#34;</span><span class="op" id="7271089">,</span>&nbsp;<span class="ident" id="7271091">NullString</span><span class="op" id="7271101">{</span><span class="string" id="7271102">&#34;black&#34;</span><span class="op" id="7271109">,</span>&nbsp;<span class="ident" id="7271111">false</span><span class="op" id="7271116">}</span><span class="op" id="7271117">,</span>&nbsp;<span class="ident" id="7271119">nil</span><span class="op" id="7271122">}</span><span class="op" id="7271123">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7271126">}</span><span class="op" id="7271127">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7271130">nullTestRun</span><span class="op" id="7271141">(</span><span class="ident" id="7271142">t</span><span class="op" id="7271143">,</span>&nbsp;<span class="ident" id="7271145">spec</span><span class="op" id="7271149">)</span><br>
<span class="lineno">750</span><span class="op" id="7271151">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7271154">func</span>&nbsp;<span class="ident" id="7271159">TestNullInt64Param</span><span class="op" id="7271177">(</span><span class="ident" id="7271178">t</span>&nbsp;<span class="op" id="7271180">*</span><span class="ident" id="7271181">testing</span><span class="op" id="7271188">.</span><span class="ident" id="7271189">T</span><span class="op" id="7271190">)</span>&nbsp;<span class="op" id="7271192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7271195">spec</span>&nbsp;<span class="op" id="7271200">:=</span>&nbsp;<span class="ident" id="7271203">nullTestSpec</span><span class="op" id="7271215">{</span><span class="string" id="7271216">&#34;nullint64&#34;</span><span class="op" id="7271227">,</span>&nbsp;<span class="string" id="7271229">&#34;int64&#34;</span><span class="op" id="7271236">,</span>&nbsp;<span class="op" id="7271238">[</span><span class="num" id="7271239">6</span><span class="op" id="7271240">]</span><span class="ident" id="7271241">nullTestRow</span><span class="op" id="7271252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7271256">{</span><span class="ident" id="7271257">NullInt64</span><span class="op" id="7271266">{</span><span class="num" id="7271267">31</span><span class="op" id="7271269">,</span>&nbsp;<span class="ident" id="7271271">true</span><span class="op" id="7271275">}</span><span class="op" id="7271276">,</span>&nbsp;<span class="num" id="7271278">1</span><span class="op" id="7271279">,</span>&nbsp;<span class="ident" id="7271281">NullInt64</span><span class="op" id="7271290">{</span><span class="num" id="7271291">31</span><span class="op" id="7271293">,</span>&nbsp;<span class="ident" id="7271295">true</span><span class="op" id="7271299">}</span><span class="op" id="7271300">}</span><span class="op" id="7271301">,</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7271305">{</span><span class="ident" id="7271306">NullInt64</span><span class="op" id="7271315">{</span><span class="op" id="7271316">-</span><span class="num" id="7271317">22</span><span class="op" id="7271319">,</span>&nbsp;<span class="ident" id="7271321">false</span><span class="op" id="7271326">}</span><span class="op" id="7271327">,</span>&nbsp;<span class="num" id="7271329">1</span><span class="op" id="7271330">,</span>&nbsp;<span class="ident" id="7271332">NullInt64</span><span class="op" id="7271341">{</span><span class="num" id="7271342">0</span><span class="op" id="7271343">,</span>&nbsp;<span class="ident" id="7271345">false</span><span class="op" id="7271350">}</span><span class="op" id="7271351">}</span><span class="op" id="7271352">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7271356">{</span><span class="num" id="7271357">22</span><span class="op" id="7271359">,</span>&nbsp;<span class="num" id="7271361">1</span><span class="op" id="7271362">,</span>&nbsp;<span class="ident" id="7271364">NullInt64</span><span class="op" id="7271373">{</span><span class="num" id="7271374">22</span><span class="op" id="7271376">,</span>&nbsp;<span class="ident" id="7271378">true</span><span class="op" id="7271382">}</span><span class="op" id="7271383">}</span><span class="op" id="7271384">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7271388">{</span><span class="ident" id="7271389">NullInt64</span><span class="op" id="7271398">{</span><span class="num" id="7271399">33</span><span class="op" id="7271401">,</span>&nbsp;<span class="ident" id="7271403">true</span><span class="op" id="7271407">}</span><span class="op" id="7271408">,</span>&nbsp;<span class="num" id="7271410">1</span><span class="op" id="7271411">,</span>&nbsp;<span class="ident" id="7271413">NullInt64</span><span class="op" id="7271422">{</span><span class="num" id="7271423">33</span><span class="op" id="7271425">,</span>&nbsp;<span class="ident" id="7271427">true</span><span class="op" id="7271431">}</span><span class="op" id="7271432">}</span><span class="op" id="7271433">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7271437">{</span><span class="ident" id="7271438">NullInt64</span><span class="op" id="7271447">{</span><span class="num" id="7271448">222</span><span class="op" id="7271451">,</span>&nbsp;<span class="ident" id="7271453">false</span><span class="op" id="7271458">}</span><span class="op" id="7271459">,</span>&nbsp;<span class="num" id="7271461">1</span><span class="op" id="7271462">,</span>&nbsp;<span class="ident" id="7271464">NullInt64</span><span class="op" id="7271473">{</span><span class="num" id="7271474">0</span><span class="op" id="7271475">,</span>&nbsp;<span class="ident" id="7271477">false</span><span class="op" id="7271482">}</span><span class="op" id="7271483">}</span><span class="op" id="7271484">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7271488">{</span><span class="num" id="7271489">0</span><span class="op" id="7271490">,</span>&nbsp;<span class="ident" id="7271492">NullInt64</span><span class="op" id="7271501">{</span><span class="num" id="7271502">31</span><span class="op" id="7271504">,</span>&nbsp;<span class="ident" id="7271506">false</span><span class="op" id="7271511">}</span><span class="op" id="7271512">,</span>&nbsp;<span class="ident" id="7271514">nil</span><span class="op" id="7271517">}</span><span class="op" id="7271518">,</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7271521">}</span><span class="op" id="7271522">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7271525">nullTestRun</span><span class="op" id="7271536">(</span><span class="ident" id="7271537">t</span><span class="op" id="7271538">,</span>&nbsp;<span class="ident" id="7271540">spec</span><span class="op" id="7271544">)</span><br>
<span class="lineno"></span><span class="op" id="7271546">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7271549">func</span>&nbsp;<span class="ident" id="7271554">TestNullFloat64Param</span><span class="op" id="7271574">(</span><span class="ident" id="7271575">t</span>&nbsp;<span class="op" id="7271577">*</span><span class="ident" id="7271578">testing</span><span class="op" id="7271585">.</span><span class="ident" id="7271586">T</span><span class="op" id="7271587">)</span>&nbsp;<span class="op" id="7271589">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7271592">spec</span>&nbsp;<span class="op" id="7271597">:=</span>&nbsp;<span class="ident" id="7271600">nullTestSpec</span><span class="op" id="7271612">{</span><span class="string" id="7271613">&#34;nullfloat64&#34;</span><span class="op" id="7271626">,</span>&nbsp;<span class="string" id="7271628">&#34;float64&#34;</span><span class="op" id="7271637">,</span>&nbsp;<span class="op" id="7271639">[</span><span class="num" id="7271640">6</span><span class="op" id="7271641">]</span><span class="ident" id="7271642">nullTestRow</span><span class="op" id="7271653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7271657">{</span><span class="ident" id="7271658">NullFloat64</span><span class="op" id="7271669">{</span><span class="num" id="7271670">31.2</span><span class="op" id="7271674">,</span>&nbsp;<span class="ident" id="7271676">true</span><span class="op" id="7271680">}</span><span class="op" id="7271681">,</span>&nbsp;<span class="num" id="7271683">1</span><span class="op" id="7271684">,</span>&nbsp;<span class="ident" id="7271686">NullFloat64</span><span class="op" id="7271697">{</span><span class="num" id="7271698">31.2</span><span class="op" id="7271702">,</span>&nbsp;<span class="ident" id="7271704">true</span><span class="op" id="7271708">}</span><span class="op" id="7271709">}</span><span class="op" id="7271710">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7271714">{</span><span class="ident" id="7271715">NullFloat64</span><span class="op" id="7271726">{</span><span class="num" id="7271727">13.1</span><span class="op" id="7271731">,</span>&nbsp;<span class="ident" id="7271733">false</span><span class="op" id="7271738">}</span><span class="op" id="7271739">,</span>&nbsp;<span class="num" id="7271741">1</span><span class="op" id="7271742">,</span>&nbsp;<span class="ident" id="7271744">NullFloat64</span><span class="op" id="7271755">{</span><span class="num" id="7271756">0</span><span class="op" id="7271757">,</span>&nbsp;<span class="ident" id="7271759">false</span><span class="op" id="7271764">}</span><span class="op" id="7271765">}</span><span class="op" id="7271766">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7271770">{</span><span class="op" id="7271771">-</span><span class="num" id="7271772">22.9</span><span class="op" id="7271776">,</span>&nbsp;<span class="num" id="7271778">1</span><span class="op" id="7271779">,</span>&nbsp;<span class="ident" id="7271781">NullFloat64</span><span class="op" id="7271792">{</span><span class="op" id="7271793">-</span><span class="num" id="7271794">22.9</span><span class="op" id="7271798">,</span>&nbsp;<span class="ident" id="7271800">true</span><span class="op" id="7271804">}</span><span class="op" id="7271805">}</span><span class="op" id="7271806">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7271810">{</span><span class="ident" id="7271811">NullFloat64</span><span class="op" id="7271822">{</span><span class="num" id="7271823">33.81</span><span class="op" id="7271828">,</span>&nbsp;<span class="ident" id="7271830">true</span><span class="op" id="7271834">}</span><span class="op" id="7271835">,</span>&nbsp;<span class="num" id="7271837">1</span><span class="op" id="7271838">,</span>&nbsp;<span class="ident" id="7271840">NullFloat64</span><span class="op" id="7271851">{</span><span class="num" id="7271852">33.81</span><span class="op" id="7271857">,</span>&nbsp;<span class="ident" id="7271859">true</span><span class="op" id="7271863">}</span><span class="op" id="7271864">}</span><span class="op" id="7271865">,</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7271869">{</span><span class="ident" id="7271870">NullFloat64</span><span class="op" id="7271881">{</span><span class="num" id="7271882">222</span><span class="op" id="7271885">,</span>&nbsp;<span class="ident" id="7271887">false</span><span class="op" id="7271892">}</span><span class="op" id="7271893">,</span>&nbsp;<span class="num" id="7271895">1</span><span class="op" id="7271896">,</span>&nbsp;<span class="ident" id="7271898">NullFloat64</span><span class="op" id="7271909">{</span><span class="num" id="7271910">0</span><span class="op" id="7271911">,</span>&nbsp;<span class="ident" id="7271913">false</span><span class="op" id="7271918">}</span><span class="op" id="7271919">}</span><span class="op" id="7271920">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7271924">{</span><span class="num" id="7271925">10</span><span class="op" id="7271927">,</span>&nbsp;<span class="ident" id="7271929">NullFloat64</span><span class="op" id="7271940">{</span><span class="num" id="7271941">31.2</span><span class="op" id="7271945">,</span>&nbsp;<span class="ident" id="7271947">false</span><span class="op" id="7271952">}</span><span class="op" id="7271953">,</span>&nbsp;<span class="ident" id="7271955">nil</span><span class="op" id="7271958">}</span><span class="op" id="7271959">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7271962">}</span><span class="op" id="7271963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7271966">nullTestRun</span><span class="op" id="7271977">(</span><span class="ident" id="7271978">t</span><span class="op" id="7271979">,</span>&nbsp;<span class="ident" id="7271981">spec</span><span class="op" id="7271985">)</span><br>
<span class="lineno"></span><span class="op" id="7271987">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span><span class="keyword" id="7271990">func</span>&nbsp;<span class="ident" id="7271995">TestNullBoolParam</span><span class="op" id="7272012">(</span><span class="ident" id="7272013">t</span>&nbsp;<span class="op" id="7272015">*</span><span class="ident" id="7272016">testing</span><span class="op" id="7272023">.</span><span class="ident" id="7272024">T</span><span class="op" id="7272025">)</span>&nbsp;<span class="op" id="7272027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7272030">spec</span>&nbsp;<span class="op" id="7272035">:=</span>&nbsp;<span class="ident" id="7272038">nullTestSpec</span><span class="op" id="7272050">{</span><span class="string" id="7272051">&#34;nullbool&#34;</span><span class="op" id="7272061">,</span>&nbsp;<span class="string" id="7272063">&#34;bool&#34;</span><span class="op" id="7272069">,</span>&nbsp;<span class="op" id="7272071">[</span><span class="num" id="7272072">6</span><span class="op" id="7272073">]</span><span class="ident" id="7272074">nullTestRow</span><span class="op" id="7272085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7272089">{</span><span class="ident" id="7272090">NullBool</span><span class="op" id="7272098">{</span><span class="ident" id="7272099">false</span><span class="op" id="7272104">,</span>&nbsp;<span class="ident" id="7272106">true</span><span class="op" id="7272110">}</span><span class="op" id="7272111">,</span>&nbsp;<span class="ident" id="7272113">true</span><span class="op" id="7272117">,</span>&nbsp;<span class="ident" id="7272119">NullBool</span><span class="op" id="7272127">{</span><span class="ident" id="7272128">false</span><span class="op" id="7272133">,</span>&nbsp;<span class="ident" id="7272135">true</span><span class="op" id="7272139">}</span><span class="op" id="7272140">}</span><span class="op" id="7272141">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7272145">{</span><span class="ident" id="7272146">NullBool</span><span class="op" id="7272154">{</span><span class="ident" id="7272155">true</span><span class="op" id="7272159">,</span>&nbsp;<span class="ident" id="7272161">false</span><span class="op" id="7272166">}</span><span class="op" id="7272167">,</span>&nbsp;<span class="ident" id="7272169">false</span><span class="op" id="7272174">,</span>&nbsp;<span class="ident" id="7272176">NullBool</span><span class="op" id="7272184">{</span><span class="ident" id="7272185">false</span><span class="op" id="7272190">,</span>&nbsp;<span class="ident" id="7272192">false</span><span class="op" id="7272197">}</span><span class="op" id="7272198">}</span><span class="op" id="7272199">,</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7272203">{</span><span class="ident" id="7272204">true</span><span class="op" id="7272208">,</span>&nbsp;<span class="ident" id="7272210">true</span><span class="op" id="7272214">,</span>&nbsp;<span class="ident" id="7272216">NullBool</span><span class="op" id="7272224">{</span><span class="ident" id="7272225">true</span><span class="op" id="7272229">,</span>&nbsp;<span class="ident" id="7272231">true</span><span class="op" id="7272235">}</span><span class="op" id="7272236">}</span><span class="op" id="7272237">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7272241">{</span><span class="ident" id="7272242">NullBool</span><span class="op" id="7272250">{</span><span class="ident" id="7272251">true</span><span class="op" id="7272255">,</span>&nbsp;<span class="ident" id="7272257">true</span><span class="op" id="7272261">}</span><span class="op" id="7272262">,</span>&nbsp;<span class="ident" id="7272264">false</span><span class="op" id="7272269">,</span>&nbsp;<span class="ident" id="7272271">NullBool</span><span class="op" id="7272279">{</span><span class="ident" id="7272280">true</span><span class="op" id="7272284">,</span>&nbsp;<span class="ident" id="7272286">true</span><span class="op" id="7272290">}</span><span class="op" id="7272291">}</span><span class="op" id="7272292">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7272296">{</span><span class="ident" id="7272297">NullBool</span><span class="op" id="7272305">{</span><span class="ident" id="7272306">true</span><span class="op" id="7272310">,</span>&nbsp;<span class="ident" id="7272312">false</span><span class="op" id="7272317">}</span><span class="op" id="7272318">,</span>&nbsp;<span class="ident" id="7272320">true</span><span class="op" id="7272324">,</span>&nbsp;<span class="ident" id="7272326">NullBool</span><span class="op" id="7272334">{</span><span class="ident" id="7272335">false</span><span class="op" id="7272340">,</span>&nbsp;<span class="ident" id="7272342">false</span><span class="op" id="7272347">}</span><span class="op" id="7272348">}</span><span class="op" id="7272349">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7272353">{</span><span class="ident" id="7272354">true</span><span class="op" id="7272358">,</span>&nbsp;<span class="ident" id="7272360">NullBool</span><span class="op" id="7272368">{</span><span class="ident" id="7272369">true</span><span class="op" id="7272373">,</span>&nbsp;<span class="ident" id="7272375">false</span><span class="op" id="7272380">}</span><span class="op" id="7272381">,</span>&nbsp;<span class="ident" id="7272383">nil</span><span class="op" id="7272386">}</span><span class="op" id="7272387">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7272390">}</span><span class="op" id="7272391">}</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7272394">nullTestRun</span><span class="op" id="7272405">(</span><span class="ident" id="7272406">t</span><span class="op" id="7272407">,</span>&nbsp;<span class="ident" id="7272409">spec</span><span class="op" id="7272413">)</span><br>
<span class="lineno"></span><span class="op" id="7272415">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7272418">func</span>&nbsp;<span class="ident" id="7272423">nullTestRun</span><span class="op" id="7272434">(</span><span class="ident" id="7272435">t</span>&nbsp;<span class="op" id="7272437">*</span><span class="ident" id="7272438">testing</span><span class="op" id="7272445">.</span><span class="ident" id="7272446">T</span><span class="op" id="7272447">,</span>&nbsp;<span class="ident" id="7272449">spec</span>&nbsp;<span class="ident" id="7272454">nullTestSpec</span><span class="op" id="7272466">)</span>&nbsp;<span class="op" id="7272468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7272471">db</span>&nbsp;<span class="op" id="7272474">:=</span>&nbsp;<span class="ident" id="7272477">newTestDB</span><span class="op" id="7272486">(</span><span class="ident" id="7272487">t</span><span class="op" id="7272488">,</span>&nbsp;<span class="string" id="7272490">&#34;&#34;</span><span class="op" id="7272492">)</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7272495">defer</span>&nbsp;<span class="ident" id="7272501">closeDB</span><span class="op" id="7272508">(</span><span class="ident" id="7272509">t</span><span class="op" id="7272510">,</span>&nbsp;<span class="ident" id="7272512">db</span><span class="op" id="7272514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7272517">exec</span><span class="op" id="7272521">(</span><span class="ident" id="7272522">t</span><span class="op" id="7272523">,</span>&nbsp;<span class="ident" id="7272525">db</span><span class="op" id="7272527">,</span>&nbsp;<span class="ident" id="7272529">fmt</span><span class="op" id="7272532">.</span><span class="ident" id="7272533">Sprintf</span><span class="op" id="7272540">(</span><span class="string" id="7272541">&#34;CREATE|t|id=int32,name=string,nullf=%s,notnullf=%s&#34;</span><span class="op" id="7272593">,</span>&nbsp;<span class="ident" id="7272595">spec</span><span class="op" id="7272599">.</span><span class="ident" id="7272600">nullType</span><span class="op" id="7272608">,</span>&nbsp;<span class="ident" id="7272610">spec</span><span class="op" id="7272614">.</span><span class="ident" id="7272615">notNullType</span><span class="op" id="7272626">)</span><span class="op" id="7272627">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7272631">//&nbsp;Inserts&nbsp;with&nbsp;db.Exec:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7272657">exec</span><span class="op" id="7272661">(</span><span class="ident" id="7272662">t</span><span class="op" id="7272663">,</span>&nbsp;<span class="ident" id="7272665">db</span><span class="op" id="7272667">,</span>&nbsp;<span class="string" id="7272669">&#34;INSERT|t|id=?,name=?,nullf=?,notnullf=?&#34;</span><span class="op" id="7272710">,</span>&nbsp;<span class="num" id="7272712">1</span><span class="op" id="7272713">,</span>&nbsp;<span class="string" id="7272715">&#34;alice&#34;</span><span class="op" id="7272722">,</span>&nbsp;<span class="ident" id="7272724">spec</span><span class="op" id="7272728">.</span><span class="ident" id="7272729">rows</span><span class="op" id="7272733">[</span><span class="num" id="7272734">0</span><span class="op" id="7272735">]</span><span class="op" id="7272736">.</span><span class="ident" id="7272737">nullParam</span><span class="op" id="7272746">,</span>&nbsp;<span class="ident" id="7272748">spec</span><span class="op" id="7272752">.</span><span class="ident" id="7272753">rows</span><span class="op" id="7272757">[</span><span class="num" id="7272758">0</span><span class="op" id="7272759">]</span><span class="op" id="7272760">.</span><span class="ident" id="7272761">notNullParam</span><span class="op" id="7272773">)</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7272776">exec</span><span class="op" id="7272780">(</span><span class="ident" id="7272781">t</span><span class="op" id="7272782">,</span>&nbsp;<span class="ident" id="7272784">db</span><span class="op" id="7272786">,</span>&nbsp;<span class="string" id="7272788">&#34;INSERT|t|id=?,name=?,nullf=?,notnullf=?&#34;</span><span class="op" id="7272829">,</span>&nbsp;<span class="num" id="7272831">2</span><span class="op" id="7272832">,</span>&nbsp;<span class="string" id="7272834">&#34;bob&#34;</span><span class="op" id="7272839">,</span>&nbsp;<span class="ident" id="7272841">spec</span><span class="op" id="7272845">.</span><span class="ident" id="7272846">rows</span><span class="op" id="7272850">[</span><span class="num" id="7272851">1</span><span class="op" id="7272852">]</span><span class="op" id="7272853">.</span><span class="ident" id="7272854">nullParam</span><span class="op" id="7272863">,</span>&nbsp;<span class="ident" id="7272865">spec</span><span class="op" id="7272869">.</span><span class="ident" id="7272870">rows</span><span class="op" id="7272874">[</span><span class="num" id="7272875">1</span><span class="op" id="7272876">]</span><span class="op" id="7272877">.</span><span class="ident" id="7272878">notNullParam</span><span class="op" id="7272890">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7272894">//&nbsp;Inserts&nbsp;with&nbsp;a&nbsp;prepared&nbsp;statement:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7272933">stmt</span><span class="op" id="7272937">,</span>&nbsp;<span class="ident" id="7272939">err</span>&nbsp;<span class="op" id="7272943">:=</span>&nbsp;<span class="ident" id="7272946">db</span><span class="op" id="7272948">.</span><span class="ident" id="7272949">Prepare</span><span class="op" id="7272956">(</span><span class="string" id="7272957">&#34;INSERT|t|id=?,name=?,nullf=?,notnullf=?&#34;</span><span class="op" id="7272998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7273001">if</span>&nbsp;<span class="ident" id="7273004">err</span>&nbsp;<span class="op" id="7273008">!=</span>&nbsp;<span class="ident" id="7273011">nil</span>&nbsp;<span class="op" id="7273015">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7273019">t</span><span class="op" id="7273020">.</span><span class="ident" id="7273021">Fatalf</span><span class="op" id="7273027">(</span><span class="string" id="7273028">&#34;prepare:&nbsp;%v&#34;</span><span class="op" id="7273041">,</span>&nbsp;<span class="ident" id="7273043">err</span><span class="op" id="7273046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7273049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7273052">defer</span>&nbsp;<span class="ident" id="7273058">stmt</span><span class="op" id="7273062">.</span><span class="ident" id="7273063">Close</span><span class="op" id="7273068">(</span><span class="op" id="7273069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7273072">if</span>&nbsp;<span class="ident" id="7273075">_</span><span class="op" id="7273076">,</span>&nbsp;<span class="ident" id="7273078">err</span>&nbsp;<span class="op" id="7273082">:=</span>&nbsp;<span class="ident" id="7273085">stmt</span><span class="op" id="7273089">.</span><span class="ident" id="7273090">Exec</span><span class="op" id="7273094">(</span><span class="num" id="7273095">3</span><span class="op" id="7273096">,</span>&nbsp;<span class="string" id="7273098">&#34;chris&#34;</span><span class="op" id="7273105">,</span>&nbsp;<span class="ident" id="7273107">spec</span><span class="op" id="7273111">.</span><span class="ident" id="7273112">rows</span><span class="op" id="7273116">[</span><span class="num" id="7273117">2</span><span class="op" id="7273118">]</span><span class="op" id="7273119">.</span><span class="ident" id="7273120">nullParam</span><span class="op" id="7273129">,</span>&nbsp;<span class="ident" id="7273131">spec</span><span class="op" id="7273135">.</span><span class="ident" id="7273136">rows</span><span class="op" id="7273140">[</span><span class="num" id="7273141">2</span><span class="op" id="7273142">]</span><span class="op" id="7273143">.</span><span class="ident" id="7273144">notNullParam</span><span class="op" id="7273156">)</span><span class="op" id="7273157">;</span>&nbsp;<span class="ident" id="7273159">err</span>&nbsp;<span class="op" id="7273163">!=</span>&nbsp;<span class="ident" id="7273166">nil</span>&nbsp;<span class="op" id="7273170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7273174">t</span><span class="op" id="7273175">.</span><span class="ident" id="7273176">Errorf</span><span class="op" id="7273182">(</span><span class="string" id="7273183">&#34;exec&nbsp;insert&nbsp;chris:&nbsp;%v&#34;</span><span class="op" id="7273206">,</span>&nbsp;<span class="ident" id="7273208">err</span><span class="op" id="7273211">)</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7273214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7273217">if</span>&nbsp;<span class="ident" id="7273220">_</span><span class="op" id="7273221">,</span>&nbsp;<span class="ident" id="7273223">err</span>&nbsp;<span class="op" id="7273227">:=</span>&nbsp;<span class="ident" id="7273230">stmt</span><span class="op" id="7273234">.</span><span class="ident" id="7273235">Exec</span><span class="op" id="7273239">(</span><span class="num" id="7273240">4</span><span class="op" id="7273241">,</span>&nbsp;<span class="string" id="7273243">&#34;dave&#34;</span><span class="op" id="7273249">,</span>&nbsp;<span class="ident" id="7273251">spec</span><span class="op" id="7273255">.</span><span class="ident" id="7273256">rows</span><span class="op" id="7273260">[</span><span class="num" id="7273261">3</span><span class="op" id="7273262">]</span><span class="op" id="7273263">.</span><span class="ident" id="7273264">nullParam</span><span class="op" id="7273273">,</span>&nbsp;<span class="ident" id="7273275">spec</span><span class="op" id="7273279">.</span><span class="ident" id="7273280">rows</span><span class="op" id="7273284">[</span><span class="num" id="7273285">3</span><span class="op" id="7273286">]</span><span class="op" id="7273287">.</span><span class="ident" id="7273288">notNullParam</span><span class="op" id="7273300">)</span><span class="op" id="7273301">;</span>&nbsp;<span class="ident" id="7273303">err</span>&nbsp;<span class="op" id="7273307">!=</span>&nbsp;<span class="ident" id="7273310">nil</span>&nbsp;<span class="op" id="7273314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7273318">t</span><span class="op" id="7273319">.</span><span class="ident" id="7273320">Errorf</span><span class="op" id="7273326">(</span><span class="string" id="7273327">&#34;exec&nbsp;insert&nbsp;dave:&nbsp;%v&#34;</span><span class="op" id="7273349">,</span>&nbsp;<span class="ident" id="7273351">err</span><span class="op" id="7273354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7273357">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7273360">if</span>&nbsp;<span class="ident" id="7273363">_</span><span class="op" id="7273364">,</span>&nbsp;<span class="ident" id="7273366">err</span>&nbsp;<span class="op" id="7273370">:=</span>&nbsp;<span class="ident" id="7273373">stmt</span><span class="op" id="7273377">.</span><span class="ident" id="7273378">Exec</span><span class="op" id="7273382">(</span><span class="num" id="7273383">5</span><span class="op" id="7273384">,</span>&nbsp;<span class="string" id="7273386">&#34;eleanor&#34;</span><span class="op" id="7273395">,</span>&nbsp;<span class="ident" id="7273397">spec</span><span class="op" id="7273401">.</span><span class="ident" id="7273402">rows</span><span class="op" id="7273406">[</span><span class="num" id="7273407">4</span><span class="op" id="7273408">]</span><span class="op" id="7273409">.</span><span class="ident" id="7273410">nullParam</span><span class="op" id="7273419">,</span>&nbsp;<span class="ident" id="7273421">spec</span><span class="op" id="7273425">.</span><span class="ident" id="7273426">rows</span><span class="op" id="7273430">[</span><span class="num" id="7273431">4</span><span class="op" id="7273432">]</span><span class="op" id="7273433">.</span><span class="ident" id="7273434">notNullParam</span><span class="op" id="7273446">)</span><span class="op" id="7273447">;</span>&nbsp;<span class="ident" id="7273449">err</span>&nbsp;<span class="op" id="7273453">!=</span>&nbsp;<span class="ident" id="7273456">nil</span>&nbsp;<span class="op" id="7273460">{</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7273464">t</span><span class="op" id="7273465">.</span><span class="ident" id="7273466">Errorf</span><span class="op" id="7273472">(</span><span class="string" id="7273473">&#34;exec&nbsp;insert&nbsp;eleanor:&nbsp;%v&#34;</span><span class="op" id="7273498">,</span>&nbsp;<span class="ident" id="7273500">err</span><span class="op" id="7273503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7273506">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7273510">//&nbsp;Can&#39;t&nbsp;put&nbsp;null&nbsp;val&nbsp;into&nbsp;non-null&nbsp;col</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7273551">if</span>&nbsp;<span class="ident" id="7273554">_</span><span class="op" id="7273555">,</span>&nbsp;<span class="ident" id="7273557">err</span>&nbsp;<span class="op" id="7273561">:=</span>&nbsp;<span class="ident" id="7273564">stmt</span><span class="op" id="7273568">.</span><span class="ident" id="7273569">Exec</span><span class="op" id="7273573">(</span><span class="num" id="7273574">6</span><span class="op" id="7273575">,</span>&nbsp;<span class="string" id="7273577">&#34;bob&#34;</span><span class="op" id="7273582">,</span>&nbsp;<span class="ident" id="7273584">spec</span><span class="op" id="7273588">.</span><span class="ident" id="7273589">rows</span><span class="op" id="7273593">[</span><span class="num" id="7273594">5</span><span class="op" id="7273595">]</span><span class="op" id="7273596">.</span><span class="ident" id="7273597">nullParam</span><span class="op" id="7273606">,</span>&nbsp;<span class="ident" id="7273608">spec</span><span class="op" id="7273612">.</span><span class="ident" id="7273613">rows</span><span class="op" id="7273617">[</span><span class="num" id="7273618">5</span><span class="op" id="7273619">]</span><span class="op" id="7273620">.</span><span class="ident" id="7273621">notNullParam</span><span class="op" id="7273633">)</span><span class="op" id="7273634">;</span>&nbsp;<span class="ident" id="7273636">err</span>&nbsp;<span class="op" id="7273640">==</span>&nbsp;<span class="ident" id="7273643">nil</span>&nbsp;<span class="op" id="7273647">{</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7273651">t</span><span class="op" id="7273652">.</span><span class="ident" id="7273653">Errorf</span><span class="op" id="7273659">(</span><span class="string" id="7273660">&#34;expected&nbsp;error&nbsp;inserting&nbsp;nil&nbsp;val&nbsp;with&nbsp;prepared&nbsp;statement&nbsp;Exec&#34;</span><span class="op" id="7273723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7273726">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7273730">_</span><span class="op" id="7273731">,</span>&nbsp;<span class="ident" id="7273733">err</span>&nbsp;<span class="op" id="7273737">=</span>&nbsp;<span class="ident" id="7273739">db</span><span class="op" id="7273741">.</span><span class="ident" id="7273742">Exec</span><span class="op" id="7273746">(</span><span class="string" id="7273747">&#34;INSERT|t|id=?,name=?,nullf=?&#34;</span><span class="op" id="7273777">,</span>&nbsp;<span class="num" id="7273779">999</span><span class="op" id="7273782">,</span>&nbsp;<span class="ident" id="7273784">nil</span><span class="op" id="7273787">,</span>&nbsp;<span class="ident" id="7273789">nil</span><span class="op" id="7273792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7273795">if</span>&nbsp;<span class="ident" id="7273798">err</span>&nbsp;<span class="op" id="7273802">==</span>&nbsp;<span class="ident" id="7273805">nil</span>&nbsp;<span class="op" id="7273809">{</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7273813">//&nbsp;TODO:&nbsp;this&nbsp;test&nbsp;fails,&nbsp;but&nbsp;it&#39;s&nbsp;just&nbsp;because</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7273863">//&nbsp;fakeConn&nbsp;implements&nbsp;the&nbsp;optional&nbsp;Execer&nbsp;interface,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7273919">//&nbsp;so&nbsp;arguably&nbsp;this&nbsp;is&nbsp;the&nbsp;correct&nbsp;behavior.&nbsp;&nbsp;But</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7273971">//&nbsp;maybe&nbsp;I&nbsp;should&nbsp;flesh&nbsp;out&nbsp;the&nbsp;fakeConn.Exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7274019">//&nbsp;implementation&nbsp;so&nbsp;this&nbsp;properly&nbsp;fails.</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7274063">//&nbsp;t.Errorf(&#34;expected&nbsp;error&nbsp;inserting&nbsp;nil&nbsp;name&nbsp;with&nbsp;Exec&#34;)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7274123">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7274127">paramtype</span>&nbsp;<span class="op" id="7274137">:=</span>&nbsp;<span class="ident" id="7274140">reflect</span><span class="op" id="7274147">.</span><span class="ident" id="7274148">TypeOf</span><span class="op" id="7274154">(</span><span class="ident" id="7274155">spec</span><span class="op" id="7274159">.</span><span class="ident" id="7274160">rows</span><span class="op" id="7274164">[</span><span class="num" id="7274165">0</span><span class="op" id="7274166">]</span><span class="op" id="7274167">.</span><span class="ident" id="7274168">nullParam</span><span class="op" id="7274177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7274180">bindVal</span>&nbsp;<span class="op" id="7274188">:=</span>&nbsp;<span class="ident" id="7274191">reflect</span><span class="op" id="7274198">.</span><span class="ident" id="7274199">New</span><span class="op" id="7274202">(</span><span class="ident" id="7274203">paramtype</span><span class="op" id="7274212">)</span><span class="op" id="7274213">.</span><span class="ident" id="7274214">Interface</span><span class="op" id="7274223">(</span><span class="op" id="7274224">)</span><br>
<span class="lineno">830</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7274228">for</span>&nbsp;<span class="ident" id="7274232">i</span>&nbsp;<span class="op" id="7274234">:=</span>&nbsp;<span class="num" id="7274237">0</span><span class="op" id="7274238">;</span>&nbsp;<span class="ident" id="7274240">i</span>&nbsp;<span class="op" id="7274242">&lt;</span>&nbsp;<span class="num" id="7274244">5</span><span class="op" id="7274245">;</span>&nbsp;<span class="ident" id="7274247">i</span><span class="op" id="7274248">++</span>&nbsp;<span class="op" id="7274251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7274255">id</span>&nbsp;<span class="op" id="7274258">:=</span>&nbsp;<span class="ident" id="7274261">i</span>&nbsp;<span class="op" id="7274263">+</span>&nbsp;<span class="num" id="7274265">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7274269">if</span>&nbsp;<span class="ident" id="7274272">err</span>&nbsp;<span class="op" id="7274276">:=</span>&nbsp;<span class="ident" id="7274279">db</span><span class="op" id="7274281">.</span><span class="ident" id="7274282">QueryRow</span><span class="op" id="7274290">(</span><span class="string" id="7274291">&#34;SELECT|t|nullf|id=?&#34;</span><span class="op" id="7274312">,</span>&nbsp;<span class="ident" id="7274314">id</span><span class="op" id="7274316">)</span><span class="op" id="7274317">.</span><span class="ident" id="7274318">Scan</span><span class="op" id="7274322">(</span><span class="ident" id="7274323">bindVal</span><span class="op" id="7274330">)</span><span class="op" id="7274331">;</span>&nbsp;<span class="ident" id="7274333">err</span>&nbsp;<span class="op" id="7274337">!=</span>&nbsp;<span class="ident" id="7274340">nil</span>&nbsp;<span class="op" id="7274344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7274349">t</span><span class="op" id="7274350">.</span><span class="ident" id="7274351">Errorf</span><span class="op" id="7274357">(</span><span class="string" id="7274358">&#34;id=%d&nbsp;Scan:&nbsp;%v&#34;</span><span class="op" id="7274374">,</span>&nbsp;<span class="ident" id="7274376">id</span><span class="op" id="7274378">,</span>&nbsp;<span class="ident" id="7274380">err</span><span class="op" id="7274383">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7274387">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7274391">bindValDeref</span>&nbsp;<span class="op" id="7274404">:=</span>&nbsp;<span class="ident" id="7274407">reflect</span><span class="op" id="7274414">.</span><span class="ident" id="7274415">ValueOf</span><span class="op" id="7274422">(</span><span class="ident" id="7274423">bindVal</span><span class="op" id="7274430">)</span><span class="op" id="7274431">.</span><span class="ident" id="7274432">Elem</span><span class="op" id="7274436">(</span><span class="op" id="7274437">)</span><span class="op" id="7274438">.</span><span class="ident" id="7274439">Interface</span><span class="op" id="7274448">(</span><span class="op" id="7274449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7274453">if</span>&nbsp;<span class="op" id="7274456">!</span><span class="ident" id="7274457">reflect</span><span class="op" id="7274464">.</span><span class="ident" id="7274465">DeepEqual</span><span class="op" id="7274474">(</span><span class="ident" id="7274475">bindValDeref</span><span class="op" id="7274487">,</span>&nbsp;<span class="ident" id="7274489">spec</span><span class="op" id="7274493">.</span><span class="ident" id="7274494">rows</span><span class="op" id="7274498">[</span><span class="ident" id="7274499">i</span><span class="op" id="7274500">]</span><span class="op" id="7274501">.</span><span class="ident" id="7274502">scanNullVal</span><span class="op" id="7274513">)</span>&nbsp;<span class="op" id="7274515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7274520">t</span><span class="op" id="7274521">.</span><span class="ident" id="7274522">Errorf</span><span class="op" id="7274528">(</span><span class="string" id="7274529">&#34;id=%d&nbsp;got&nbsp;%#v,&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="7274554">,</span>&nbsp;<span class="ident" id="7274556">id</span><span class="op" id="7274558">,</span>&nbsp;<span class="ident" id="7274560">bindValDeref</span><span class="op" id="7274572">,</span>&nbsp;<span class="ident" id="7274574">spec</span><span class="op" id="7274578">.</span><span class="ident" id="7274579">rows</span><span class="op" id="7274583">[</span><span class="ident" id="7274584">i</span><span class="op" id="7274585">]</span><span class="op" id="7274586">.</span><span class="ident" id="7274587">scanNullVal</span><span class="op" id="7274598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7274602">}</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7274605">}</span><br>
<span class="lineno"></span><span class="op" id="7274607">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7274610">//&nbsp;golang.org/issue/4859</span><br>
<span class="lineno"></span><span class="keyword" id="7274635">func</span>&nbsp;<span class="ident" id="7274640">TestQueryRowNilScanDest</span><span class="op" id="7274663">(</span><span class="ident" id="7274664">t</span>&nbsp;<span class="op" id="7274666">*</span><span class="ident" id="7274667">testing</span><span class="op" id="7274674">.</span><span class="ident" id="7274675">T</span><span class="op" id="7274676">)</span>&nbsp;<span class="op" id="7274678">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7274681">db</span>&nbsp;<span class="op" id="7274684">:=</span>&nbsp;<span class="ident" id="7274687">newTestDB</span><span class="op" id="7274696">(</span><span class="ident" id="7274697">t</span><span class="op" id="7274698">,</span>&nbsp;<span class="string" id="7274700">&#34;people&#34;</span><span class="op" id="7274708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7274711">defer</span>&nbsp;<span class="ident" id="7274717">closeDB</span><span class="op" id="7274724">(</span><span class="ident" id="7274725">t</span><span class="op" id="7274726">,</span>&nbsp;<span class="ident" id="7274728">db</span><span class="op" id="7274730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7274733">var</span>&nbsp;<span class="ident" id="7274737">name</span>&nbsp;<span class="op" id="7274742">*</span><span class="builtintype" id="7274743">string</span>&nbsp;<span class="comment" id="7274750">//&nbsp;nil&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7274766">err</span>&nbsp;<span class="op" id="7274770">:=</span>&nbsp;<span class="ident" id="7274773">db</span><span class="op" id="7274775">.</span><span class="ident" id="7274776">QueryRow</span><span class="op" id="7274784">(</span><span class="string" id="7274785">&#34;SELECT|people|name|&#34;</span><span class="op" id="7274806">)</span><span class="op" id="7274807">.</span><span class="ident" id="7274808">Scan</span><span class="op" id="7274812">(</span><span class="ident" id="7274813">name</span><span class="op" id="7274817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7274820">want</span>&nbsp;<span class="op" id="7274825">:=</span>&nbsp;<span class="string" id="7274828">&#34;sql:&nbsp;Scan&nbsp;error&nbsp;on&nbsp;column&nbsp;index&nbsp;0:&nbsp;destination&nbsp;pointer&nbsp;is&nbsp;nil&#34;</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7274893">if</span>&nbsp;<span class="ident" id="7274896">err</span>&nbsp;<span class="op" id="7274900">==</span>&nbsp;<span class="ident" id="7274903">nil</span>&nbsp;<span class="op" id="7274907">||</span>&nbsp;<span class="ident" id="7274910">err</span><span class="op" id="7274913">.</span><span class="ident" id="7274914">Error</span><span class="op" id="7274919">(</span><span class="op" id="7274920">)</span>&nbsp;<span class="op" id="7274922">!=</span>&nbsp;<span class="ident" id="7274925">want</span>&nbsp;<span class="op" id="7274930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7274934">t</span><span class="op" id="7274935">.</span><span class="ident" id="7274936">Errorf</span><span class="op" id="7274942">(</span><span class="string" id="7274943">&#34;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7274964">,</span>&nbsp;<span class="ident" id="7274966">err</span><span class="op" id="7274969">.</span><span class="ident" id="7274970">Error</span><span class="op" id="7274975">(</span><span class="op" id="7274976">)</span><span class="op" id="7274977">,</span>&nbsp;<span class="ident" id="7274979">want</span><span class="op" id="7274983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7274986">}</span><br>
<span class="lineno"></span><span class="op" id="7274988">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">855</span><span class="keyword" id="7274991">func</span>&nbsp;<span class="ident" id="7274996">TestIssue4902</span><span class="op" id="7275009">(</span><span class="ident" id="7275010">t</span>&nbsp;<span class="op" id="7275012">*</span><span class="ident" id="7275013">testing</span><span class="op" id="7275020">.</span><span class="ident" id="7275021">T</span><span class="op" id="7275022">)</span>&nbsp;<span class="op" id="7275024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7275027">db</span>&nbsp;<span class="op" id="7275030">:=</span>&nbsp;<span class="ident" id="7275033">newTestDB</span><span class="op" id="7275042">(</span><span class="ident" id="7275043">t</span><span class="op" id="7275044">,</span>&nbsp;<span class="string" id="7275046">&#34;people&#34;</span><span class="op" id="7275054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7275057">defer</span>&nbsp;<span class="ident" id="7275063">closeDB</span><span class="op" id="7275070">(</span><span class="ident" id="7275071">t</span><span class="op" id="7275072">,</span>&nbsp;<span class="ident" id="7275074">db</span><span class="op" id="7275076">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7275080">driver</span>&nbsp;<span class="op" id="7275087">:=</span>&nbsp;<span class="ident" id="7275090">db</span><span class="op" id="7275092">.</span><span class="ident" id="7275093">driver</span><span class="op" id="7275099">.</span><span class="op" id="7275100">(</span><span class="op" id="7275101">*</span><span class="ident" id="7275102">fakeDriver</span><span class="op" id="7275112">)</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7275115">opens0</span>&nbsp;<span class="op" id="7275122">:=</span>&nbsp;<span class="ident" id="7275125">driver</span><span class="op" id="7275131">.</span><span class="ident" id="7275132">openCount</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7275144">var</span>&nbsp;<span class="ident" id="7275148">stmt</span>&nbsp;<span class="op" id="7275153">*</span><span class="ident" id="7275154">Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7275160">var</span>&nbsp;<span class="ident" id="7275164">err</span>&nbsp;<span class="builtintype" id="7275168">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7275175">for</span>&nbsp;<span class="ident" id="7275179">i</span>&nbsp;<span class="op" id="7275181">:=</span>&nbsp;<span class="num" id="7275184">0</span><span class="op" id="7275185">;</span>&nbsp;<span class="ident" id="7275187">i</span>&nbsp;<span class="op" id="7275189">&lt;</span>&nbsp;<span class="num" id="7275191">10</span><span class="op" id="7275193">;</span>&nbsp;<span class="ident" id="7275195">i</span><span class="op" id="7275196">++</span>&nbsp;<span class="op" id="7275199">{</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7275203">stmt</span><span class="op" id="7275207">,</span>&nbsp;<span class="ident" id="7275209">err</span>&nbsp;<span class="op" id="7275213">=</span>&nbsp;<span class="ident" id="7275215">db</span><span class="op" id="7275217">.</span><span class="ident" id="7275218">Prepare</span><span class="op" id="7275225">(</span><span class="string" id="7275226">&#34;SELECT|people|name|&#34;</span><span class="op" id="7275247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7275251">if</span>&nbsp;<span class="ident" id="7275254">err</span>&nbsp;<span class="op" id="7275258">!=</span>&nbsp;<span class="ident" id="7275261">nil</span>&nbsp;<span class="op" id="7275265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7275270">t</span><span class="op" id="7275271">.</span><span class="ident" id="7275272">Fatal</span><span class="op" id="7275277">(</span><span class="ident" id="7275278">err</span><span class="op" id="7275281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7275285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7275289">err</span>&nbsp;<span class="op" id="7275293">=</span>&nbsp;<span class="ident" id="7275295">stmt</span><span class="op" id="7275299">.</span><span class="ident" id="7275300">Close</span><span class="op" id="7275305">(</span><span class="op" id="7275306">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7275310">if</span>&nbsp;<span class="ident" id="7275313">err</span>&nbsp;<span class="op" id="7275317">!=</span>&nbsp;<span class="ident" id="7275320">nil</span>&nbsp;<span class="op" id="7275324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7275329">t</span><span class="op" id="7275330">.</span><span class="ident" id="7275331">Fatal</span><span class="op" id="7275336">(</span><span class="ident" id="7275337">err</span><span class="op" id="7275340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7275344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7275347">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7275351">opens</span>&nbsp;<span class="op" id="7275357">:=</span>&nbsp;<span class="ident" id="7275360">driver</span><span class="op" id="7275366">.</span><span class="ident" id="7275367">openCount</span>&nbsp;<span class="op" id="7275377">-</span>&nbsp;<span class="ident" id="7275379">opens0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7275387">if</span>&nbsp;<span class="ident" id="7275390">opens</span>&nbsp;<span class="op" id="7275396">&gt;</span>&nbsp;<span class="num" id="7275398">1</span>&nbsp;<span class="op" id="7275400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7275404">t</span><span class="op" id="7275405">.</span><span class="ident" id="7275406">Errorf</span><span class="op" id="7275412">(</span><span class="string" id="7275413">&#34;opens&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;1&#34;</span><span class="op" id="7275436">,</span>&nbsp;<span class="ident" id="7275438">opens</span><span class="op" id="7275443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7275447">t</span><span class="op" id="7275448">.</span><span class="ident" id="7275449">Logf</span><span class="op" id="7275453">(</span><span class="string" id="7275454">&#34;db&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="7275464">,</span>&nbsp;<span class="ident" id="7275466">db</span><span class="op" id="7275468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7275472">t</span><span class="op" id="7275473">.</span><span class="ident" id="7275474">Logf</span><span class="op" id="7275478">(</span><span class="string" id="7275479">&#34;driver&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="7275493">,</span>&nbsp;<span class="ident" id="7275495">driver</span><span class="op" id="7275501">)</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7275505">t</span><span class="op" id="7275506">.</span><span class="ident" id="7275507">Logf</span><span class="op" id="7275511">(</span><span class="string" id="7275512">&#34;stmt&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="7275524">,</span>&nbsp;<span class="ident" id="7275526">stmt</span><span class="op" id="7275530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7275533">}</span><br>
<span class="lineno"></span><span class="op" id="7275535">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7275538">//&nbsp;Issue&nbsp;3857</span><br>
<span class="lineno">885</span><span class="comment" id="7275552">//&nbsp;This&nbsp;used&nbsp;to&nbsp;deadlock.</span><br>
<span class="lineno"></span><span class="keyword" id="7275578">func</span>&nbsp;<span class="ident" id="7275583">TestSimultaneousQueries</span><span class="op" id="7275606">(</span><span class="ident" id="7275607">t</span>&nbsp;<span class="op" id="7275609">*</span><span class="ident" id="7275610">testing</span><span class="op" id="7275617">.</span><span class="ident" id="7275618">T</span><span class="op" id="7275619">)</span>&nbsp;<span class="op" id="7275621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7275624">db</span>&nbsp;<span class="op" id="7275627">:=</span>&nbsp;<span class="ident" id="7275630">newTestDB</span><span class="op" id="7275639">(</span><span class="ident" id="7275640">t</span><span class="op" id="7275641">,</span>&nbsp;<span class="string" id="7275643">&#34;people&#34;</span><span class="op" id="7275651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7275654">defer</span>&nbsp;<span class="ident" id="7275660">closeDB</span><span class="op" id="7275667">(</span><span class="ident" id="7275668">t</span><span class="op" id="7275669">,</span>&nbsp;<span class="ident" id="7275671">db</span><span class="op" id="7275673">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7275677">tx</span><span class="op" id="7275679">,</span>&nbsp;<span class="ident" id="7275681">err</span>&nbsp;<span class="op" id="7275685">:=</span>&nbsp;<span class="ident" id="7275688">db</span><span class="op" id="7275690">.</span><span class="ident" id="7275691">Begin</span><span class="op" id="7275696">(</span><span class="op" id="7275697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7275700">if</span>&nbsp;<span class="ident" id="7275703">err</span>&nbsp;<span class="op" id="7275707">!=</span>&nbsp;<span class="ident" id="7275710">nil</span>&nbsp;<span class="op" id="7275714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7275718">t</span><span class="op" id="7275719">.</span><span class="ident" id="7275720">Fatal</span><span class="op" id="7275725">(</span><span class="ident" id="7275726">err</span><span class="op" id="7275729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7275732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7275735">defer</span>&nbsp;<span class="ident" id="7275741">tx</span><span class="op" id="7275743">.</span><span class="ident" id="7275744">Rollback</span><span class="op" id="7275752">(</span><span class="op" id="7275753">)</span><br>
<span class="lineno">895</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7275757">r1</span><span class="op" id="7275759">,</span>&nbsp;<span class="ident" id="7275761">err</span>&nbsp;<span class="op" id="7275765">:=</span>&nbsp;<span class="ident" id="7275768">tx</span><span class="op" id="7275770">.</span><span class="ident" id="7275771">Query</span><span class="op" id="7275776">(</span><span class="string" id="7275777">&#34;SELECT|people|name|&#34;</span><span class="op" id="7275798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7275801">if</span>&nbsp;<span class="ident" id="7275804">err</span>&nbsp;<span class="op" id="7275808">!=</span>&nbsp;<span class="ident" id="7275811">nil</span>&nbsp;<span class="op" id="7275815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7275819">t</span><span class="op" id="7275820">.</span><span class="ident" id="7275821">Fatal</span><span class="op" id="7275826">(</span><span class="ident" id="7275827">err</span><span class="op" id="7275830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7275833">}</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7275836">defer</span>&nbsp;<span class="ident" id="7275842">r1</span><span class="op" id="7275844">.</span><span class="ident" id="7275845">Close</span><span class="op" id="7275850">(</span><span class="op" id="7275851">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7275855">r2</span><span class="op" id="7275857">,</span>&nbsp;<span class="ident" id="7275859">err</span>&nbsp;<span class="op" id="7275863">:=</span>&nbsp;<span class="ident" id="7275866">tx</span><span class="op" id="7275868">.</span><span class="ident" id="7275869">Query</span><span class="op" id="7275874">(</span><span class="string" id="7275875">&#34;SELECT|people|name|&#34;</span><span class="op" id="7275896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7275899">if</span>&nbsp;<span class="ident" id="7275902">err</span>&nbsp;<span class="op" id="7275906">!=</span>&nbsp;<span class="ident" id="7275909">nil</span>&nbsp;<span class="op" id="7275913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7275917">t</span><span class="op" id="7275918">.</span><span class="ident" id="7275919">Fatal</span><span class="op" id="7275924">(</span><span class="ident" id="7275925">err</span><span class="op" id="7275928">)</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7275931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7275934">defer</span>&nbsp;<span class="ident" id="7275940">r2</span><span class="op" id="7275942">.</span><span class="ident" id="7275943">Close</span><span class="op" id="7275948">(</span><span class="op" id="7275949">)</span><br>
<span class="lineno"></span><span class="op" id="7275951">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7275954">func</span>&nbsp;<span class="ident" id="7275959">TestMaxIdleConns</span><span class="op" id="7275975">(</span><span class="ident" id="7275976">t</span>&nbsp;<span class="op" id="7275978">*</span><span class="ident" id="7275979">testing</span><span class="op" id="7275986">.</span><span class="ident" id="7275987">T</span><span class="op" id="7275988">)</span>&nbsp;<span class="op" id="7275990">{</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7275993">db</span>&nbsp;<span class="op" id="7275996">:=</span>&nbsp;<span class="ident" id="7275999">newTestDB</span><span class="op" id="7276008">(</span><span class="ident" id="7276009">t</span><span class="op" id="7276010">,</span>&nbsp;<span class="string" id="7276012">&#34;people&#34;</span><span class="op" id="7276020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7276023">defer</span>&nbsp;<span class="ident" id="7276029">closeDB</span><span class="op" id="7276036">(</span><span class="ident" id="7276037">t</span><span class="op" id="7276038">,</span>&nbsp;<span class="ident" id="7276040">db</span><span class="op" id="7276042">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7276046">tx</span><span class="op" id="7276048">,</span>&nbsp;<span class="ident" id="7276050">err</span>&nbsp;<span class="op" id="7276054">:=</span>&nbsp;<span class="ident" id="7276057">db</span><span class="op" id="7276059">.</span><span class="ident" id="7276060">Begin</span><span class="op" id="7276065">(</span><span class="op" id="7276066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7276069">if</span>&nbsp;<span class="ident" id="7276072">err</span>&nbsp;<span class="op" id="7276076">!=</span>&nbsp;<span class="ident" id="7276079">nil</span>&nbsp;<span class="op" id="7276083">{</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7276087">t</span><span class="op" id="7276088">.</span><span class="ident" id="7276089">Fatal</span><span class="op" id="7276094">(</span><span class="ident" id="7276095">err</span><span class="op" id="7276098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7276101">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7276104">tx</span><span class="op" id="7276106">.</span><span class="ident" id="7276107">Commit</span><span class="op" id="7276113">(</span><span class="op" id="7276114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7276117">if</span>&nbsp;<span class="ident" id="7276120">got</span>&nbsp;<span class="op" id="7276124">:=</span>&nbsp;<span class="builtinfunc" id="7276127">len</span><span class="op" id="7276130">(</span><span class="ident" id="7276131">db</span><span class="op" id="7276133">.</span><span class="ident" id="7276134">freeConn</span><span class="op" id="7276142">)</span><span class="op" id="7276143">;</span>&nbsp;<span class="ident" id="7276145">got</span>&nbsp;<span class="op" id="7276149">!=</span>&nbsp;<span class="num" id="7276152">1</span>&nbsp;<span class="op" id="7276154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7276158">t</span><span class="op" id="7276159">.</span><span class="ident" id="7276160">Errorf</span><span class="op" id="7276166">(</span><span class="string" id="7276167">&#34;freeConns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="7276191">,</span>&nbsp;<span class="ident" id="7276193">got</span><span class="op" id="7276196">)</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7276199">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7276203">db</span><span class="op" id="7276205">.</span><span class="ident" id="7276206">SetMaxIdleConns</span><span class="op" id="7276221">(</span><span class="num" id="7276222">0</span><span class="op" id="7276223">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7276227">if</span>&nbsp;<span class="ident" id="7276230">got</span>&nbsp;<span class="op" id="7276234">:=</span>&nbsp;<span class="builtinfunc" id="7276237">len</span><span class="op" id="7276240">(</span><span class="ident" id="7276241">db</span><span class="op" id="7276243">.</span><span class="ident" id="7276244">freeConn</span><span class="op" id="7276252">)</span><span class="op" id="7276253">;</span>&nbsp;<span class="ident" id="7276255">got</span>&nbsp;<span class="op" id="7276259">!=</span>&nbsp;<span class="num" id="7276262">0</span>&nbsp;<span class="op" id="7276264">{</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7276268">t</span><span class="op" id="7276269">.</span><span class="ident" id="7276270">Errorf</span><span class="op" id="7276276">(</span><span class="string" id="7276277">&#34;freeConns&nbsp;after&nbsp;set&nbsp;to&nbsp;zero&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="7276319">,</span>&nbsp;<span class="ident" id="7276321">got</span><span class="op" id="7276324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7276327">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7276331">tx</span><span class="op" id="7276333">,</span>&nbsp;<span class="ident" id="7276335">err</span>&nbsp;<span class="op" id="7276339">=</span>&nbsp;<span class="ident" id="7276341">db</span><span class="op" id="7276343">.</span><span class="ident" id="7276344">Begin</span><span class="op" id="7276349">(</span><span class="op" id="7276350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7276353">if</span>&nbsp;<span class="ident" id="7276356">err</span>&nbsp;<span class="op" id="7276360">!=</span>&nbsp;<span class="ident" id="7276363">nil</span>&nbsp;<span class="op" id="7276367">{</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7276371">t</span><span class="op" id="7276372">.</span><span class="ident" id="7276373">Fatal</span><span class="op" id="7276378">(</span><span class="ident" id="7276379">err</span><span class="op" id="7276382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7276385">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7276388">tx</span><span class="op" id="7276390">.</span><span class="ident" id="7276391">Commit</span><span class="op" id="7276397">(</span><span class="op" id="7276398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7276401">if</span>&nbsp;<span class="ident" id="7276404">got</span>&nbsp;<span class="op" id="7276408">:=</span>&nbsp;<span class="builtinfunc" id="7276411">len</span><span class="op" id="7276414">(</span><span class="ident" id="7276415">db</span><span class="op" id="7276417">.</span><span class="ident" id="7276418">freeConn</span><span class="op" id="7276426">)</span><span class="op" id="7276427">;</span>&nbsp;<span class="ident" id="7276429">got</span>&nbsp;<span class="op" id="7276433">!=</span>&nbsp;<span class="num" id="7276436">0</span>&nbsp;<span class="op" id="7276438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7276442">t</span><span class="op" id="7276443">.</span><span class="ident" id="7276444">Errorf</span><span class="op" id="7276450">(</span><span class="string" id="7276451">&#34;freeConns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="7276475">,</span>&nbsp;<span class="ident" id="7276477">got</span><span class="op" id="7276480">)</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7276483">}</span><br>
<span class="lineno"></span><span class="op" id="7276485">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7276488">func</span>&nbsp;<span class="ident" id="7276493">TestMaxOpenConns</span><span class="op" id="7276509">(</span><span class="ident" id="7276510">t</span>&nbsp;<span class="op" id="7276512">*</span><span class="ident" id="7276513">testing</span><span class="op" id="7276520">.</span><span class="ident" id="7276521">T</span><span class="op" id="7276522">)</span>&nbsp;<span class="op" id="7276524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7276527">if</span>&nbsp;<span class="ident" id="7276530">testing</span><span class="op" id="7276537">.</span><span class="ident" id="7276538">Short</span><span class="op" id="7276543">(</span><span class="op" id="7276544">)</span>&nbsp;<span class="op" id="7276546">{</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7276550">t</span><span class="op" id="7276551">.</span><span class="ident" id="7276552">Skip</span><span class="op" id="7276556">(</span><span class="string" id="7276557">&#34;skipping&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="7276581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7276584">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7276587">defer</span>&nbsp;<span class="ident" id="7276593">setHookpostCloseConn</span><span class="op" id="7276613">(</span><span class="ident" id="7276614">nil</span><span class="op" id="7276617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7276620">setHookpostCloseConn</span><span class="op" id="7276640">(</span><span class="keyword" id="7276641">func</span><span class="op" id="7276645">(</span><span class="ident" id="7276646">_</span>&nbsp;<span class="op" id="7276648">*</span><span class="ident" id="7276649">fakeConn</span><span class="op" id="7276657">,</span>&nbsp;<span class="ident" id="7276659">err</span>&nbsp;<span class="builtintype" id="7276663">error</span><span class="op" id="7276668">)</span>&nbsp;<span class="op" id="7276670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7276674">if</span>&nbsp;<span class="ident" id="7276677">err</span>&nbsp;<span class="op" id="7276681">!=</span>&nbsp;<span class="ident" id="7276684">nil</span>&nbsp;<span class="op" id="7276688">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7276693">t</span><span class="op" id="7276694">.</span><span class="ident" id="7276695">Errorf</span><span class="op" id="7276701">(</span><span class="string" id="7276702">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="7276730">,</span>&nbsp;<span class="ident" id="7276732">err</span><span class="op" id="7276735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7276739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7276742">}</span><span class="op" id="7276743">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7276747">db</span>&nbsp;<span class="op" id="7276750">:=</span>&nbsp;<span class="ident" id="7276753">newTestDB</span><span class="op" id="7276762">(</span><span class="ident" id="7276763">t</span><span class="op" id="7276764">,</span>&nbsp;<span class="string" id="7276766">&#34;magicquery&#34;</span><span class="op" id="7276778">)</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7276781">defer</span>&nbsp;<span class="ident" id="7276787">closeDB</span><span class="op" id="7276794">(</span><span class="ident" id="7276795">t</span><span class="op" id="7276796">,</span>&nbsp;<span class="ident" id="7276798">db</span><span class="op" id="7276800">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7276804">driver</span>&nbsp;<span class="op" id="7276811">:=</span>&nbsp;<span class="ident" id="7276814">db</span><span class="op" id="7276816">.</span><span class="ident" id="7276817">driver</span><span class="op" id="7276823">.</span><span class="op" id="7276824">(</span><span class="op" id="7276825">*</span><span class="ident" id="7276826">fakeDriver</span><span class="op" id="7276836">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7276840">//&nbsp;Force&nbsp;the&nbsp;number&nbsp;of&nbsp;open&nbsp;connections&nbsp;to&nbsp;0&nbsp;so&nbsp;we&nbsp;can&nbsp;get&nbsp;an&nbsp;accurate</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7276912">//&nbsp;count&nbsp;for&nbsp;the&nbsp;test</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7276935">db</span><span class="op" id="7276937">.</span><span class="ident" id="7276938">SetMaxIdleConns</span><span class="op" id="7276953">(</span><span class="num" id="7276954">0</span><span class="op" id="7276955">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7276959">if</span>&nbsp;<span class="ident" id="7276962">g</span><span class="op" id="7276963">,</span>&nbsp;<span class="ident" id="7276965">w</span>&nbsp;<span class="op" id="7276967">:=</span>&nbsp;<span class="ident" id="7276970">db</span><span class="op" id="7276972">.</span><span class="ident" id="7276973">numFreeConns</span><span class="op" id="7276985">(</span><span class="op" id="7276986">)</span><span class="op" id="7276987">,</span>&nbsp;<span class="num" id="7276989">0</span><span class="op" id="7276990">;</span>&nbsp;<span class="ident" id="7276992">g</span>&nbsp;<span class="op" id="7276994">!=</span>&nbsp;<span class="ident" id="7276997">w</span>&nbsp;<span class="op" id="7276999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7277003">t</span><span class="op" id="7277004">.</span><span class="ident" id="7277005">Errorf</span><span class="op" id="7277011">(</span><span class="string" id="7277012">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7277038">,</span>&nbsp;<span class="ident" id="7277040">g</span><span class="op" id="7277041">,</span>&nbsp;<span class="ident" id="7277043">w</span><span class="op" id="7277044">)</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7277047">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7277051">if</span>&nbsp;<span class="ident" id="7277054">n</span>&nbsp;<span class="op" id="7277056">:=</span>&nbsp;<span class="ident" id="7277059">db</span><span class="op" id="7277061">.</span><span class="ident" id="7277062">numDepsPollUntil</span><span class="op" id="7277078">(</span><span class="num" id="7277079">0</span><span class="op" id="7277080">,</span>&nbsp;<span class="ident" id="7277082">time</span><span class="op" id="7277086">.</span><span class="ident" id="7277087">Second</span><span class="op" id="7277093">)</span><span class="op" id="7277094">;</span>&nbsp;<span class="ident" id="7277096">n</span>&nbsp;<span class="op" id="7277098">&gt;</span>&nbsp;<span class="num" id="7277100">0</span>&nbsp;<span class="op" id="7277102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7277106">t</span><span class="op" id="7277107">.</span><span class="ident" id="7277108">Errorf</span><span class="op" id="7277114">(</span><span class="string" id="7277115">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="7277156">,</span>&nbsp;<span class="ident" id="7277158">n</span><span class="op" id="7277159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7277163">db</span><span class="op" id="7277165">.</span><span class="ident" id="7277166">dumpDeps</span><span class="op" id="7277174">(</span><span class="ident" id="7277175">t</span><span class="op" id="7277176">)</span><br>
<span class="lineno">965</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7277179">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7277183">driver</span><span class="op" id="7277189">.</span><span class="ident" id="7277190">mu</span><span class="op" id="7277192">.</span><span class="ident" id="7277193">Lock</span><span class="op" id="7277197">(</span><span class="op" id="7277198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7277201">opens0</span>&nbsp;<span class="op" id="7277208">:=</span>&nbsp;<span class="ident" id="7277211">driver</span><span class="op" id="7277217">.</span><span class="ident" id="7277218">openCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7277229">closes0</span>&nbsp;<span class="op" id="7277237">:=</span>&nbsp;<span class="ident" id="7277240">driver</span><span class="op" id="7277246">.</span><span class="ident" id="7277247">closeCount</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7277259">driver</span><span class="op" id="7277265">.</span><span class="ident" id="7277266">mu</span><span class="op" id="7277268">.</span><span class="ident" id="7277269">Unlock</span><span class="op" id="7277275">(</span><span class="op" id="7277276">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7277280">db</span><span class="op" id="7277282">.</span><span class="ident" id="7277283">SetMaxIdleConns</span><span class="op" id="7277298">(</span><span class="num" id="7277299">10</span><span class="op" id="7277301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7277304">db</span><span class="op" id="7277306">.</span><span class="ident" id="7277307">SetMaxOpenConns</span><span class="op" id="7277322">(</span><span class="num" id="7277323">10</span><span class="op" id="7277325">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7277329">stmt</span><span class="op" id="7277333">,</span>&nbsp;<span class="ident" id="7277335">err</span>&nbsp;<span class="op" id="7277339">:=</span>&nbsp;<span class="ident" id="7277342">db</span><span class="op" id="7277344">.</span><span class="ident" id="7277345">Prepare</span><span class="op" id="7277352">(</span><span class="string" id="7277353">&#34;SELECT|magicquery|op|op=?,millis=?&#34;</span><span class="op" id="7277389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7277392">if</span>&nbsp;<span class="ident" id="7277395">err</span>&nbsp;<span class="op" id="7277399">!=</span>&nbsp;<span class="ident" id="7277402">nil</span>&nbsp;<span class="op" id="7277406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7277410">t</span><span class="op" id="7277411">.</span><span class="ident" id="7277412">Fatal</span><span class="op" id="7277417">(</span><span class="ident" id="7277418">err</span><span class="op" id="7277421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7277424">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7277428">//&nbsp;Start&nbsp;50&nbsp;parallel&nbsp;slow&nbsp;queries.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7277464">const</span>&nbsp;<span class="op" id="7277470">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7277474">nquery</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7277486">=</span>&nbsp;<span class="num" id="7277488">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7277493">sleepMillis</span>&nbsp;<span class="op" id="7277505">=</span>&nbsp;<span class="num" id="7277507">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7277512">nbatch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7277524">=</span>&nbsp;<span class="num" id="7277526">2</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7277529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7277532">var</span>&nbsp;<span class="ident" id="7277536">wg</span>&nbsp;<span class="ident" id="7277539">sync</span><span class="op" id="7277543">.</span><span class="ident" id="7277544">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7277555">for</span>&nbsp;<span class="ident" id="7277559">batch</span>&nbsp;<span class="op" id="7277565">:=</span>&nbsp;<span class="num" id="7277568">0</span><span class="op" id="7277569">;</span>&nbsp;<span class="ident" id="7277571">batch</span>&nbsp;<span class="op" id="7277577">&lt;</span>&nbsp;<span class="ident" id="7277579">nbatch</span><span class="op" id="7277585">;</span>&nbsp;<span class="ident" id="7277587">batch</span><span class="op" id="7277592">++</span>&nbsp;<span class="op" id="7277595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7277599">for</span>&nbsp;<span class="ident" id="7277603">i</span>&nbsp;<span class="op" id="7277605">:=</span>&nbsp;<span class="num" id="7277608">0</span><span class="op" id="7277609">;</span>&nbsp;<span class="ident" id="7277611">i</span>&nbsp;<span class="op" id="7277613">&lt;</span>&nbsp;<span class="ident" id="7277615">nquery</span><span class="op" id="7277621">;</span>&nbsp;<span class="ident" id="7277623">i</span><span class="op" id="7277624">++</span>&nbsp;<span class="op" id="7277627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7277632">wg</span><span class="op" id="7277634">.</span><span class="ident" id="7277635">Add</span><span class="op" id="7277638">(</span><span class="num" id="7277639">1</span><span class="op" id="7277640">)</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7277645">go</span>&nbsp;<span class="keyword" id="7277648">func</span><span class="op" id="7277652">(</span><span class="op" id="7277653">)</span>&nbsp;<span class="op" id="7277655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7277661">defer</span>&nbsp;<span class="ident" id="7277667">wg</span><span class="op" id="7277669">.</span><span class="ident" id="7277670">Done</span><span class="op" id="7277674">(</span><span class="op" id="7277675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7277681">var</span>&nbsp;<span class="ident" id="7277685">op</span>&nbsp;<span class="builtintype" id="7277688">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7277699">if</span>&nbsp;<span class="ident" id="7277702">err</span>&nbsp;<span class="op" id="7277706">:=</span>&nbsp;<span class="ident" id="7277709">stmt</span><span class="op" id="7277713">.</span><span class="ident" id="7277714">QueryRow</span><span class="op" id="7277722">(</span><span class="string" id="7277723">&#34;sleep&#34;</span><span class="op" id="7277730">,</span>&nbsp;<span class="ident" id="7277732">sleepMillis</span><span class="op" id="7277743">)</span><span class="op" id="7277744">.</span><span class="ident" id="7277745">Scan</span><span class="op" id="7277749">(</span><span class="op" id="7277750">&amp;</span><span class="ident" id="7277751">op</span><span class="op" id="7277753">)</span><span class="op" id="7277754">;</span>&nbsp;<span class="ident" id="7277756">err</span>&nbsp;<span class="op" id="7277760">!=</span>&nbsp;<span class="ident" id="7277763">nil</span>&nbsp;<span class="op" id="7277767">&amp;&amp;</span>&nbsp;<span class="ident" id="7277770">err</span>&nbsp;<span class="op" id="7277774">!=</span>&nbsp;<span class="ident" id="7277777">ErrNoRows</span>&nbsp;<span class="op" id="7277787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7277794">t</span><span class="op" id="7277795">.</span><span class="ident" id="7277796">Error</span><span class="op" id="7277801">(</span><span class="ident" id="7277802">err</span><span class="op" id="7277805">)</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7277811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7277816">}</span><span class="op" id="7277817">(</span><span class="op" id="7277818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7277822">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7277826">//&nbsp;Sleep&nbsp;for&nbsp;twice&nbsp;the&nbsp;expected&nbsp;length&nbsp;of&nbsp;time&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7277883">//&nbsp;batch&nbsp;of&nbsp;50&nbsp;queries&nbsp;above&nbsp;to&nbsp;finish&nbsp;before&nbsp;starting</span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7277940">//&nbsp;the&nbsp;next&nbsp;round.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7277961">time</span><span class="op" id="7277965">.</span><span class="ident" id="7277966">Sleep</span><span class="op" id="7277971">(</span><span class="num" id="7277972">2</span>&nbsp;<span class="op" id="7277974">*</span>&nbsp;<span class="ident" id="7277976">sleepMillis</span>&nbsp;<span class="op" id="7277988">*</span>&nbsp;<span class="ident" id="7277990">time</span><span class="op" id="7277994">.</span><span class="ident" id="7277995">Millisecond</span><span class="op" id="7278006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7278009">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7278012">wg</span><span class="op" id="7278014">.</span><span class="ident" id="7278015">Wait</span><span class="op" id="7278019">(</span><span class="op" id="7278020">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7278024">if</span>&nbsp;<span class="ident" id="7278027">g</span><span class="op" id="7278028">,</span>&nbsp;<span class="ident" id="7278030">w</span>&nbsp;<span class="op" id="7278032">:=</span>&nbsp;<span class="ident" id="7278035">db</span><span class="op" id="7278037">.</span><span class="ident" id="7278038">numFreeConns</span><span class="op" id="7278050">(</span><span class="op" id="7278051">)</span><span class="op" id="7278052">,</span>&nbsp;<span class="num" id="7278054">10</span><span class="op" id="7278056">;</span>&nbsp;<span class="ident" id="7278058">g</span>&nbsp;<span class="op" id="7278060">!=</span>&nbsp;<span class="ident" id="7278063">w</span>&nbsp;<span class="op" id="7278065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7278069">t</span><span class="op" id="7278070">.</span><span class="ident" id="7278071">Errorf</span><span class="op" id="7278077">(</span><span class="string" id="7278078">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7278104">,</span>&nbsp;<span class="ident" id="7278106">g</span><span class="op" id="7278107">,</span>&nbsp;<span class="ident" id="7278109">w</span><span class="op" id="7278110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7278113">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7278117">if</span>&nbsp;<span class="ident" id="7278120">n</span>&nbsp;<span class="op" id="7278122">:=</span>&nbsp;<span class="ident" id="7278125">db</span><span class="op" id="7278127">.</span><span class="ident" id="7278128">numDepsPollUntil</span><span class="op" id="7278144">(</span><span class="num" id="7278145">20</span><span class="op" id="7278147">,</span>&nbsp;<span class="ident" id="7278149">time</span><span class="op" id="7278153">.</span><span class="ident" id="7278154">Second</span><span class="op" id="7278160">)</span><span class="op" id="7278161">;</span>&nbsp;<span class="ident" id="7278163">n</span>&nbsp;<span class="op" id="7278165">&gt;</span>&nbsp;<span class="num" id="7278167">20</span>&nbsp;<span class="op" id="7278170">{</span><br>
<span class="lineno">1010</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7278174">t</span><span class="op" id="7278175">.</span><span class="ident" id="7278176">Errorf</span><span class="op" id="7278182">(</span><span class="string" id="7278183">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;20&#34;</span><span class="op" id="7278228">,</span>&nbsp;<span class="ident" id="7278230">n</span><span class="op" id="7278231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7278235">db</span><span class="op" id="7278237">.</span><span class="ident" id="7278238">dumpDeps</span><span class="op" id="7278246">(</span><span class="ident" id="7278247">t</span><span class="op" id="7278248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7278251">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7278255">driver</span><span class="op" id="7278261">.</span><span class="ident" id="7278262">mu</span><span class="op" id="7278264">.</span><span class="ident" id="7278265">Lock</span><span class="op" id="7278269">(</span><span class="op" id="7278270">)</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7278273">opens</span>&nbsp;<span class="op" id="7278279">:=</span>&nbsp;<span class="ident" id="7278282">driver</span><span class="op" id="7278288">.</span><span class="ident" id="7278289">openCount</span>&nbsp;<span class="op" id="7278299">-</span>&nbsp;<span class="ident" id="7278301">opens0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7278309">closes</span>&nbsp;<span class="op" id="7278316">:=</span>&nbsp;<span class="ident" id="7278319">driver</span><span class="op" id="7278325">.</span><span class="ident" id="7278326">closeCount</span>&nbsp;<span class="op" id="7278337">-</span>&nbsp;<span class="ident" id="7278339">closes0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7278348">driver</span><span class="op" id="7278354">.</span><span class="ident" id="7278355">mu</span><span class="op" id="7278357">.</span><span class="ident" id="7278358">Unlock</span><span class="op" id="7278364">(</span><span class="op" id="7278365">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7278369">if</span>&nbsp;<span class="ident" id="7278372">opens</span>&nbsp;<span class="op" id="7278378">&gt;</span>&nbsp;<span class="num" id="7278380">10</span>&nbsp;<span class="op" id="7278383">{</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7278387">t</span><span class="op" id="7278388">.</span><span class="ident" id="7278389">Logf</span><span class="op" id="7278393">(</span><span class="string" id="7278394">&#34;open&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7278411">,</span>&nbsp;<span class="ident" id="7278413">opens</span><span class="op" id="7278418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7278422">t</span><span class="op" id="7278423">.</span><span class="ident" id="7278424">Logf</span><span class="op" id="7278428">(</span><span class="string" id="7278429">&#34;close&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7278447">,</span>&nbsp;<span class="ident" id="7278449">closes</span><span class="op" id="7278455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7278459">t</span><span class="op" id="7278460">.</span><span class="ident" id="7278461">Errorf</span><span class="op" id="7278467">(</span><span class="string" id="7278468">&#34;db&nbsp;connections&nbsp;opened&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;10&#34;</span><span class="op" id="7278508">,</span>&nbsp;<span class="ident" id="7278510">opens</span><span class="op" id="7278515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7278519">db</span><span class="op" id="7278521">.</span><span class="ident" id="7278522">dumpDeps</span><span class="op" id="7278530">(</span><span class="ident" id="7278531">t</span><span class="op" id="7278532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7278535">}</span><br>
<span class="lineno">1025</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7278539">if</span>&nbsp;<span class="ident" id="7278542">err</span>&nbsp;<span class="op" id="7278546">:=</span>&nbsp;<span class="ident" id="7278549">stmt</span><span class="op" id="7278553">.</span><span class="ident" id="7278554">Close</span><span class="op" id="7278559">(</span><span class="op" id="7278560">)</span><span class="op" id="7278561">;</span>&nbsp;<span class="ident" id="7278563">err</span>&nbsp;<span class="op" id="7278567">!=</span>&nbsp;<span class="ident" id="7278570">nil</span>&nbsp;<span class="op" id="7278574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7278578">t</span><span class="op" id="7278579">.</span><span class="ident" id="7278580">Fatal</span><span class="op" id="7278585">(</span><span class="ident" id="7278586">err</span><span class="op" id="7278589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7278592">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1030</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7278596">if</span>&nbsp;<span class="ident" id="7278599">g</span><span class="op" id="7278600">,</span>&nbsp;<span class="ident" id="7278602">w</span>&nbsp;<span class="op" id="7278604">:=</span>&nbsp;<span class="ident" id="7278607">db</span><span class="op" id="7278609">.</span><span class="ident" id="7278610">numFreeConns</span><span class="op" id="7278622">(</span><span class="op" id="7278623">)</span><span class="op" id="7278624">,</span>&nbsp;<span class="num" id="7278626">10</span><span class="op" id="7278628">;</span>&nbsp;<span class="ident" id="7278630">g</span>&nbsp;<span class="op" id="7278632">!=</span>&nbsp;<span class="ident" id="7278635">w</span>&nbsp;<span class="op" id="7278637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7278641">t</span><span class="op" id="7278642">.</span><span class="ident" id="7278643">Errorf</span><span class="op" id="7278649">(</span><span class="string" id="7278650">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7278676">,</span>&nbsp;<span class="ident" id="7278678">g</span><span class="op" id="7278679">,</span>&nbsp;<span class="ident" id="7278681">w</span><span class="op" id="7278682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7278685">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7278689">if</span>&nbsp;<span class="ident" id="7278692">n</span>&nbsp;<span class="op" id="7278694">:=</span>&nbsp;<span class="ident" id="7278697">db</span><span class="op" id="7278699">.</span><span class="ident" id="7278700">numDepsPollUntil</span><span class="op" id="7278716">(</span><span class="num" id="7278717">10</span><span class="op" id="7278719">,</span>&nbsp;<span class="ident" id="7278721">time</span><span class="op" id="7278725">.</span><span class="ident" id="7278726">Second</span><span class="op" id="7278732">)</span><span class="op" id="7278733">;</span>&nbsp;<span class="ident" id="7278735">n</span>&nbsp;<span class="op" id="7278737">&gt;</span>&nbsp;<span class="num" id="7278739">10</span>&nbsp;<span class="op" id="7278742">{</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7278746">t</span><span class="op" id="7278747">.</span><span class="ident" id="7278748">Errorf</span><span class="op" id="7278754">(</span><span class="string" id="7278755">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;10&#34;</span><span class="op" id="7278800">,</span>&nbsp;<span class="ident" id="7278802">n</span><span class="op" id="7278803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7278807">db</span><span class="op" id="7278809">.</span><span class="ident" id="7278810">dumpDeps</span><span class="op" id="7278818">(</span><span class="ident" id="7278819">t</span><span class="op" id="7278820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7278823">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7278827">db</span><span class="op" id="7278829">.</span><span class="ident" id="7278830">SetMaxOpenConns</span><span class="op" id="7278845">(</span><span class="num" id="7278846">5</span><span class="op" id="7278847">)</span><br>
<span class="lineno">1040</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7278851">if</span>&nbsp;<span class="ident" id="7278854">g</span><span class="op" id="7278855">,</span>&nbsp;<span class="ident" id="7278857">w</span>&nbsp;<span class="op" id="7278859">:=</span>&nbsp;<span class="ident" id="7278862">db</span><span class="op" id="7278864">.</span><span class="ident" id="7278865">numFreeConns</span><span class="op" id="7278877">(</span><span class="op" id="7278878">)</span><span class="op" id="7278879">,</span>&nbsp;<span class="num" id="7278881">5</span><span class="op" id="7278882">;</span>&nbsp;<span class="ident" id="7278884">g</span>&nbsp;<span class="op" id="7278886">!=</span>&nbsp;<span class="ident" id="7278889">w</span>&nbsp;<span class="op" id="7278891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7278895">t</span><span class="op" id="7278896">.</span><span class="ident" id="7278897">Errorf</span><span class="op" id="7278903">(</span><span class="string" id="7278904">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7278930">,</span>&nbsp;<span class="ident" id="7278932">g</span><span class="op" id="7278933">,</span>&nbsp;<span class="ident" id="7278935">w</span><span class="op" id="7278936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7278939">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7278943">if</span>&nbsp;<span class="ident" id="7278946">n</span>&nbsp;<span class="op" id="7278948">:=</span>&nbsp;<span class="ident" id="7278951">db</span><span class="op" id="7278953">.</span><span class="ident" id="7278954">numDepsPollUntil</span><span class="op" id="7278970">(</span><span class="num" id="7278971">5</span><span class="op" id="7278972">,</span>&nbsp;<span class="ident" id="7278974">time</span><span class="op" id="7278978">.</span><span class="ident" id="7278979">Second</span><span class="op" id="7278985">)</span><span class="op" id="7278986">;</span>&nbsp;<span class="ident" id="7278988">n</span>&nbsp;<span class="op" id="7278990">&gt;</span>&nbsp;<span class="num" id="7278992">5</span>&nbsp;<span class="op" id="7278994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7278998">t</span><span class="op" id="7278999">.</span><span class="ident" id="7279000">Errorf</span><span class="op" id="7279006">(</span><span class="string" id="7279007">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="7279048">,</span>&nbsp;<span class="ident" id="7279050">n</span><span class="op" id="7279051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7279055">db</span><span class="op" id="7279057">.</span><span class="ident" id="7279058">dumpDeps</span><span class="op" id="7279066">(</span><span class="ident" id="7279067">t</span><span class="op" id="7279068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7279071">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1050</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7279075">db</span><span class="op" id="7279077">.</span><span class="ident" id="7279078">SetMaxOpenConns</span><span class="op" id="7279093">(</span><span class="num" id="7279094">0</span><span class="op" id="7279095">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7279099">if</span>&nbsp;<span class="ident" id="7279102">g</span><span class="op" id="7279103">,</span>&nbsp;<span class="ident" id="7279105">w</span>&nbsp;<span class="op" id="7279107">:=</span>&nbsp;<span class="ident" id="7279110">db</span><span class="op" id="7279112">.</span><span class="ident" id="7279113">numFreeConns</span><span class="op" id="7279125">(</span><span class="op" id="7279126">)</span><span class="op" id="7279127">,</span>&nbsp;<span class="num" id="7279129">5</span><span class="op" id="7279130">;</span>&nbsp;<span class="ident" id="7279132">g</span>&nbsp;<span class="op" id="7279134">!=</span>&nbsp;<span class="ident" id="7279137">w</span>&nbsp;<span class="op" id="7279139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7279143">t</span><span class="op" id="7279144">.</span><span class="ident" id="7279145">Errorf</span><span class="op" id="7279151">(</span><span class="string" id="7279152">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7279178">,</span>&nbsp;<span class="ident" id="7279180">g</span><span class="op" id="7279181">,</span>&nbsp;<span class="ident" id="7279183">w</span><span class="op" id="7279184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7279187">}</span><br>
<span class="lineno">1055</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7279191">if</span>&nbsp;<span class="ident" id="7279194">n</span>&nbsp;<span class="op" id="7279196">:=</span>&nbsp;<span class="ident" id="7279199">db</span><span class="op" id="7279201">.</span><span class="ident" id="7279202">numDepsPollUntil</span><span class="op" id="7279218">(</span><span class="num" id="7279219">5</span><span class="op" id="7279220">,</span>&nbsp;<span class="ident" id="7279222">time</span><span class="op" id="7279226">.</span><span class="ident" id="7279227">Second</span><span class="op" id="7279233">)</span><span class="op" id="7279234">;</span>&nbsp;<span class="ident" id="7279236">n</span>&nbsp;<span class="op" id="7279238">&gt;</span>&nbsp;<span class="num" id="7279240">5</span>&nbsp;<span class="op" id="7279242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7279246">t</span><span class="op" id="7279247">.</span><span class="ident" id="7279248">Errorf</span><span class="op" id="7279254">(</span><span class="string" id="7279255">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="7279296">,</span>&nbsp;<span class="ident" id="7279298">n</span><span class="op" id="7279299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7279303">db</span><span class="op" id="7279305">.</span><span class="ident" id="7279306">dumpDeps</span><span class="op" id="7279314">(</span><span class="ident" id="7279315">t</span><span class="op" id="7279316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7279319">}</span><br>
<span class="lineno">1060</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7279323">db</span><span class="op" id="7279325">.</span><span class="ident" id="7279326">SetMaxIdleConns</span><span class="op" id="7279341">(</span><span class="num" id="7279342">0</span><span class="op" id="7279343">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7279347">if</span>&nbsp;<span class="ident" id="7279350">g</span><span class="op" id="7279351">,</span>&nbsp;<span class="ident" id="7279353">w</span>&nbsp;<span class="op" id="7279355">:=</span>&nbsp;<span class="ident" id="7279358">db</span><span class="op" id="7279360">.</span><span class="ident" id="7279361">numFreeConns</span><span class="op" id="7279373">(</span><span class="op" id="7279374">)</span><span class="op" id="7279375">,</span>&nbsp;<span class="num" id="7279377">0</span><span class="op" id="7279378">;</span>&nbsp;<span class="ident" id="7279380">g</span>&nbsp;<span class="op" id="7279382">!=</span>&nbsp;<span class="ident" id="7279385">w</span>&nbsp;<span class="op" id="7279387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7279391">t</span><span class="op" id="7279392">.</span><span class="ident" id="7279393">Errorf</span><span class="op" id="7279399">(</span><span class="string" id="7279400">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7279426">,</span>&nbsp;<span class="ident" id="7279428">g</span><span class="op" id="7279429">,</span>&nbsp;<span class="ident" id="7279431">w</span><span class="op" id="7279432">)</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7279435">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7279439">if</span>&nbsp;<span class="ident" id="7279442">n</span>&nbsp;<span class="op" id="7279444">:=</span>&nbsp;<span class="ident" id="7279447">db</span><span class="op" id="7279449">.</span><span class="ident" id="7279450">numDepsPollUntil</span><span class="op" id="7279466">(</span><span class="num" id="7279467">0</span><span class="op" id="7279468">,</span>&nbsp;<span class="ident" id="7279470">time</span><span class="op" id="7279474">.</span><span class="ident" id="7279475">Second</span><span class="op" id="7279481">)</span><span class="op" id="7279482">;</span>&nbsp;<span class="ident" id="7279484">n</span>&nbsp;<span class="op" id="7279486">&gt;</span>&nbsp;<span class="num" id="7279488">0</span>&nbsp;<span class="op" id="7279490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7279494">t</span><span class="op" id="7279495">.</span><span class="ident" id="7279496">Errorf</span><span class="op" id="7279502">(</span><span class="string" id="7279503">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="7279544">,</span>&nbsp;<span class="ident" id="7279546">n</span><span class="op" id="7279547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7279551">db</span><span class="op" id="7279553">.</span><span class="ident" id="7279554">dumpDeps</span><span class="op" id="7279562">(</span><span class="ident" id="7279563">t</span><span class="op" id="7279564">)</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7279567">}</span><br>
<span class="lineno"></span><span class="op" id="7279569">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7279572">func</span>&nbsp;<span class="ident" id="7279577">TestSingleOpenConn</span><span class="op" id="7279595">(</span><span class="ident" id="7279596">t</span>&nbsp;<span class="op" id="7279598">*</span><span class="ident" id="7279599">testing</span><span class="op" id="7279606">.</span><span class="ident" id="7279607">T</span><span class="op" id="7279608">)</span>&nbsp;<span class="op" id="7279610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7279613">db</span>&nbsp;<span class="op" id="7279616">:=</span>&nbsp;<span class="ident" id="7279619">newTestDB</span><span class="op" id="7279628">(</span><span class="ident" id="7279629">t</span><span class="op" id="7279630">,</span>&nbsp;<span class="string" id="7279632">&#34;people&#34;</span><span class="op" id="7279640">)</span><br>
<span class="lineno">1075</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7279643">defer</span>&nbsp;<span class="ident" id="7279649">closeDB</span><span class="op" id="7279656">(</span><span class="ident" id="7279657">t</span><span class="op" id="7279658">,</span>&nbsp;<span class="ident" id="7279660">db</span><span class="op" id="7279662">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7279666">db</span><span class="op" id="7279668">.</span><span class="ident" id="7279669">SetMaxOpenConns</span><span class="op" id="7279684">(</span><span class="num" id="7279685">1</span><span class="op" id="7279686">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7279690">rows</span><span class="op" id="7279694">,</span>&nbsp;<span class="ident" id="7279696">err</span>&nbsp;<span class="op" id="7279700">:=</span>&nbsp;<span class="ident" id="7279703">db</span><span class="op" id="7279705">.</span><span class="ident" id="7279706">Query</span><span class="op" id="7279711">(</span><span class="string" id="7279712">&#34;SELECT|people|name|&#34;</span><span class="op" id="7279733">)</span><br>
<span class="lineno">1080</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7279736">if</span>&nbsp;<span class="ident" id="7279739">err</span>&nbsp;<span class="op" id="7279743">!=</span>&nbsp;<span class="ident" id="7279746">nil</span>&nbsp;<span class="op" id="7279750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7279754">t</span><span class="op" id="7279755">.</span><span class="ident" id="7279756">Fatal</span><span class="op" id="7279761">(</span><span class="ident" id="7279762">err</span><span class="op" id="7279765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7279768">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7279771">if</span>&nbsp;<span class="ident" id="7279774">err</span>&nbsp;<span class="op" id="7279778">=</span>&nbsp;<span class="ident" id="7279780">rows</span><span class="op" id="7279784">.</span><span class="ident" id="7279785">Close</span><span class="op" id="7279790">(</span><span class="op" id="7279791">)</span><span class="op" id="7279792">;</span>&nbsp;<span class="ident" id="7279794">err</span>&nbsp;<span class="op" id="7279798">!=</span>&nbsp;<span class="ident" id="7279801">nil</span>&nbsp;<span class="op" id="7279805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7279809">t</span><span class="op" id="7279810">.</span><span class="ident" id="7279811">Fatal</span><span class="op" id="7279816">(</span><span class="ident" id="7279817">err</span><span class="op" id="7279820">)</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7279823">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7279826">//&nbsp;shouldn&#39;t&nbsp;deadlock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7279849">rows</span><span class="op" id="7279853">,</span>&nbsp;<span class="ident" id="7279855">err</span>&nbsp;<span class="op" id="7279859">=</span>&nbsp;<span class="ident" id="7279861">db</span><span class="op" id="7279863">.</span><span class="ident" id="7279864">Query</span><span class="op" id="7279869">(</span><span class="string" id="7279870">&#34;SELECT|people|name|&#34;</span><span class="op" id="7279891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7279894">if</span>&nbsp;<span class="ident" id="7279897">err</span>&nbsp;<span class="op" id="7279901">!=</span>&nbsp;<span class="ident" id="7279904">nil</span>&nbsp;<span class="op" id="7279908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7279912">t</span><span class="op" id="7279913">.</span><span class="ident" id="7279914">Fatal</span><span class="op" id="7279919">(</span><span class="ident" id="7279920">err</span><span class="op" id="7279923">)</span><br>
<span class="lineno">1090</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7279926">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7279929">if</span>&nbsp;<span class="ident" id="7279932">err</span>&nbsp;<span class="op" id="7279936">=</span>&nbsp;<span class="ident" id="7279938">rows</span><span class="op" id="7279942">.</span><span class="ident" id="7279943">Close</span><span class="op" id="7279948">(</span><span class="op" id="7279949">)</span><span class="op" id="7279950">;</span>&nbsp;<span class="ident" id="7279952">err</span>&nbsp;<span class="op" id="7279956">!=</span>&nbsp;<span class="ident" id="7279959">nil</span>&nbsp;<span class="op" id="7279963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7279967">t</span><span class="op" id="7279968">.</span><span class="ident" id="7279969">Fatal</span><span class="op" id="7279974">(</span><span class="ident" id="7279975">err</span><span class="op" id="7279978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7279981">}</span><br>
<span class="lineno"></span><span class="op" id="7279983">}</span><br>
<span class="lineno">1095</span><br>
<span class="lineno"></span><span class="comment" id="7279986">//&nbsp;golang.org/issue/5323</span><br>
<span class="lineno"></span><span class="keyword" id="7280011">func</span>&nbsp;<span class="ident" id="7280016">TestStmtCloseDeps</span><span class="op" id="7280033">(</span><span class="ident" id="7280034">t</span>&nbsp;<span class="op" id="7280036">*</span><span class="ident" id="7280037">testing</span><span class="op" id="7280044">.</span><span class="ident" id="7280045">T</span><span class="op" id="7280046">)</span>&nbsp;<span class="op" id="7280048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7280051">if</span>&nbsp;<span class="ident" id="7280054">testing</span><span class="op" id="7280061">.</span><span class="ident" id="7280062">Short</span><span class="op" id="7280067">(</span><span class="op" id="7280068">)</span>&nbsp;<span class="op" id="7280070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7280074">t</span><span class="op" id="7280075">.</span><span class="ident" id="7280076">Skip</span><span class="op" id="7280080">(</span><span class="string" id="7280081">&#34;skipping&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="7280105">)</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7280108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7280111">defer</span>&nbsp;<span class="ident" id="7280117">setHookpostCloseConn</span><span class="op" id="7280137">(</span><span class="ident" id="7280138">nil</span><span class="op" id="7280141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7280144">setHookpostCloseConn</span><span class="op" id="7280164">(</span><span class="keyword" id="7280165">func</span><span class="op" id="7280169">(</span><span class="ident" id="7280170">_</span>&nbsp;<span class="op" id="7280172">*</span><span class="ident" id="7280173">fakeConn</span><span class="op" id="7280181">,</span>&nbsp;<span class="ident" id="7280183">err</span>&nbsp;<span class="builtintype" id="7280187">error</span><span class="op" id="7280192">)</span>&nbsp;<span class="op" id="7280194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7280198">if</span>&nbsp;<span class="ident" id="7280201">err</span>&nbsp;<span class="op" id="7280205">!=</span>&nbsp;<span class="ident" id="7280208">nil</span>&nbsp;<span class="op" id="7280212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7280217">t</span><span class="op" id="7280218">.</span><span class="ident" id="7280219">Errorf</span><span class="op" id="7280225">(</span><span class="string" id="7280226">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="7280254">,</span>&nbsp;<span class="ident" id="7280256">err</span><span class="op" id="7280259">)</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7280263">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7280266">}</span><span class="op" id="7280267">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7280271">db</span>&nbsp;<span class="op" id="7280274">:=</span>&nbsp;<span class="ident" id="7280277">newTestDB</span><span class="op" id="7280286">(</span><span class="ident" id="7280287">t</span><span class="op" id="7280288">,</span>&nbsp;<span class="string" id="7280290">&#34;magicquery&#34;</span><span class="op" id="7280302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7280305">defer</span>&nbsp;<span class="ident" id="7280311">closeDB</span><span class="op" id="7280318">(</span><span class="ident" id="7280319">t</span><span class="op" id="7280320">,</span>&nbsp;<span class="ident" id="7280322">db</span><span class="op" id="7280324">)</span><br>
<span class="lineno">1110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7280328">driver</span>&nbsp;<span class="op" id="7280335">:=</span>&nbsp;<span class="ident" id="7280338">db</span><span class="op" id="7280340">.</span><span class="ident" id="7280341">driver</span><span class="op" id="7280347">.</span><span class="op" id="7280348">(</span><span class="op" id="7280349">*</span><span class="ident" id="7280350">fakeDriver</span><span class="op" id="7280360">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7280364">driver</span><span class="op" id="7280370">.</span><span class="ident" id="7280371">mu</span><span class="op" id="7280373">.</span><span class="ident" id="7280374">Lock</span><span class="op" id="7280378">(</span><span class="op" id="7280379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7280382">opens0</span>&nbsp;<span class="op" id="7280389">:=</span>&nbsp;<span class="ident" id="7280392">driver</span><span class="op" id="7280398">.</span><span class="ident" id="7280399">openCount</span><br>
<span class="lineno">1115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7280410">closes0</span>&nbsp;<span class="op" id="7280418">:=</span>&nbsp;<span class="ident" id="7280421">driver</span><span class="op" id="7280427">.</span><span class="ident" id="7280428">closeCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7280440">driver</span><span class="op" id="7280446">.</span><span class="ident" id="7280447">mu</span><span class="op" id="7280449">.</span><span class="ident" id="7280450">Unlock</span><span class="op" id="7280456">(</span><span class="op" id="7280457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7280460">openDelta0</span>&nbsp;<span class="op" id="7280471">:=</span>&nbsp;<span class="ident" id="7280474">opens0</span>&nbsp;<span class="op" id="7280481">-</span>&nbsp;<span class="ident" id="7280483">closes0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7280493">stmt</span><span class="op" id="7280497">,</span>&nbsp;<span class="ident" id="7280499">err</span>&nbsp;<span class="op" id="7280503">:=</span>&nbsp;<span class="ident" id="7280506">db</span><span class="op" id="7280508">.</span><span class="ident" id="7280509">Prepare</span><span class="op" id="7280516">(</span><span class="string" id="7280517">&#34;SELECT|magicquery|op|op=?,millis=?&#34;</span><span class="op" id="7280553">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7280556">if</span>&nbsp;<span class="ident" id="7280559">err</span>&nbsp;<span class="op" id="7280563">!=</span>&nbsp;<span class="ident" id="7280566">nil</span>&nbsp;<span class="op" id="7280570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7280574">t</span><span class="op" id="7280575">.</span><span class="ident" id="7280576">Fatal</span><span class="op" id="7280581">(</span><span class="ident" id="7280582">err</span><span class="op" id="7280585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7280588">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7280592">//&nbsp;Start&nbsp;50&nbsp;parallel&nbsp;slow&nbsp;queries.</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7280628">const</span>&nbsp;<span class="op" id="7280634">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7280638">nquery</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7280650">=</span>&nbsp;<span class="num" id="7280652">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7280657">sleepMillis</span>&nbsp;<span class="op" id="7280669">=</span>&nbsp;<span class="num" id="7280671">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7280676">nbatch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7280688">=</span>&nbsp;<span class="num" id="7280690">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7280693">)</span><br>
<span class="lineno">1130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7280696">var</span>&nbsp;<span class="ident" id="7280700">wg</span>&nbsp;<span class="ident" id="7280703">sync</span><span class="op" id="7280707">.</span><span class="ident" id="7280708">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7280719">for</span>&nbsp;<span class="ident" id="7280723">batch</span>&nbsp;<span class="op" id="7280729">:=</span>&nbsp;<span class="num" id="7280732">0</span><span class="op" id="7280733">;</span>&nbsp;<span class="ident" id="7280735">batch</span>&nbsp;<span class="op" id="7280741">&lt;</span>&nbsp;<span class="ident" id="7280743">nbatch</span><span class="op" id="7280749">;</span>&nbsp;<span class="ident" id="7280751">batch</span><span class="op" id="7280756">++</span>&nbsp;<span class="op" id="7280759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7280763">for</span>&nbsp;<span class="ident" id="7280767">i</span>&nbsp;<span class="op" id="7280769">:=</span>&nbsp;<span class="num" id="7280772">0</span><span class="op" id="7280773">;</span>&nbsp;<span class="ident" id="7280775">i</span>&nbsp;<span class="op" id="7280777">&lt;</span>&nbsp;<span class="ident" id="7280779">nquery</span><span class="op" id="7280785">;</span>&nbsp;<span class="ident" id="7280787">i</span><span class="op" id="7280788">++</span>&nbsp;<span class="op" id="7280791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7280796">wg</span><span class="op" id="7280798">.</span><span class="ident" id="7280799">Add</span><span class="op" id="7280802">(</span><span class="num" id="7280803">1</span><span class="op" id="7280804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7280809">go</span>&nbsp;<span class="keyword" id="7280812">func</span><span class="op" id="7280816">(</span><span class="op" id="7280817">)</span>&nbsp;<span class="op" id="7280819">{</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7280825">defer</span>&nbsp;<span class="ident" id="7280831">wg</span><span class="op" id="7280833">.</span><span class="ident" id="7280834">Done</span><span class="op" id="7280838">(</span><span class="op" id="7280839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7280845">var</span>&nbsp;<span class="ident" id="7280849">op</span>&nbsp;<span class="builtintype" id="7280852">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7280863">if</span>&nbsp;<span class="ident" id="7280866">err</span>&nbsp;<span class="op" id="7280870">:=</span>&nbsp;<span class="ident" id="7280873">stmt</span><span class="op" id="7280877">.</span><span class="ident" id="7280878">QueryRow</span><span class="op" id="7280886">(</span><span class="string" id="7280887">&#34;sleep&#34;</span><span class="op" id="7280894">,</span>&nbsp;<span class="ident" id="7280896">sleepMillis</span><span class="op" id="7280907">)</span><span class="op" id="7280908">.</span><span class="ident" id="7280909">Scan</span><span class="op" id="7280913">(</span><span class="op" id="7280914">&amp;</span><span class="ident" id="7280915">op</span><span class="op" id="7280917">)</span><span class="op" id="7280918">;</span>&nbsp;<span class="ident" id="7280920">err</span>&nbsp;<span class="op" id="7280924">!=</span>&nbsp;<span class="ident" id="7280927">nil</span>&nbsp;<span class="op" id="7280931">&amp;&amp;</span>&nbsp;<span class="ident" id="7280934">err</span>&nbsp;<span class="op" id="7280938">!=</span>&nbsp;<span class="ident" id="7280941">ErrNoRows</span>&nbsp;<span class="op" id="7280951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7280958">t</span><span class="op" id="7280959">.</span><span class="ident" id="7280960">Error</span><span class="op" id="7280965">(</span><span class="ident" id="7280966">err</span><span class="op" id="7280969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7280975">}</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7280980">}</span><span class="op" id="7280981">(</span><span class="op" id="7280982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7280986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7280990">//&nbsp;Sleep&nbsp;for&nbsp;twice&nbsp;the&nbsp;expected&nbsp;length&nbsp;of&nbsp;time&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7281047">//&nbsp;batch&nbsp;of&nbsp;50&nbsp;queries&nbsp;above&nbsp;to&nbsp;finish&nbsp;before&nbsp;starting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7281104">//&nbsp;the&nbsp;next&nbsp;round.</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7281125">time</span><span class="op" id="7281129">.</span><span class="ident" id="7281130">Sleep</span><span class="op" id="7281135">(</span><span class="num" id="7281136">2</span>&nbsp;<span class="op" id="7281138">*</span>&nbsp;<span class="ident" id="7281140">sleepMillis</span>&nbsp;<span class="op" id="7281152">*</span>&nbsp;<span class="ident" id="7281154">time</span><span class="op" id="7281158">.</span><span class="ident" id="7281159">Millisecond</span><span class="op" id="7281170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7281173">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7281176">wg</span><span class="op" id="7281178">.</span><span class="ident" id="7281179">Wait</span><span class="op" id="7281183">(</span><span class="op" id="7281184">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7281188">if</span>&nbsp;<span class="ident" id="7281191">g</span><span class="op" id="7281192">,</span>&nbsp;<span class="ident" id="7281194">w</span>&nbsp;<span class="op" id="7281196">:=</span>&nbsp;<span class="ident" id="7281199">db</span><span class="op" id="7281201">.</span><span class="ident" id="7281202">numFreeConns</span><span class="op" id="7281214">(</span><span class="op" id="7281215">)</span><span class="op" id="7281216">,</span>&nbsp;<span class="num" id="7281218">2</span><span class="op" id="7281219">;</span>&nbsp;<span class="ident" id="7281221">g</span>&nbsp;<span class="op" id="7281223">!=</span>&nbsp;<span class="ident" id="7281226">w</span>&nbsp;<span class="op" id="7281228">{</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7281232">t</span><span class="op" id="7281233">.</span><span class="ident" id="7281234">Errorf</span><span class="op" id="7281240">(</span><span class="string" id="7281241">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7281267">,</span>&nbsp;<span class="ident" id="7281269">g</span><span class="op" id="7281270">,</span>&nbsp;<span class="ident" id="7281272">w</span><span class="op" id="7281273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7281276">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7281280">if</span>&nbsp;<span class="ident" id="7281283">n</span>&nbsp;<span class="op" id="7281285">:=</span>&nbsp;<span class="ident" id="7281288">db</span><span class="op" id="7281290">.</span><span class="ident" id="7281291">numDepsPollUntil</span><span class="op" id="7281307">(</span><span class="num" id="7281308">4</span><span class="op" id="7281309">,</span>&nbsp;<span class="ident" id="7281311">time</span><span class="op" id="7281315">.</span><span class="ident" id="7281316">Second</span><span class="op" id="7281322">)</span><span class="op" id="7281323">;</span>&nbsp;<span class="ident" id="7281325">n</span>&nbsp;<span class="op" id="7281327">&gt;</span>&nbsp;<span class="num" id="7281329">4</span>&nbsp;<span class="op" id="7281331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7281335">t</span><span class="op" id="7281336">.</span><span class="ident" id="7281337">Errorf</span><span class="op" id="7281343">(</span><span class="string" id="7281344">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;4&#34;</span><span class="op" id="7281388">,</span>&nbsp;<span class="ident" id="7281390">n</span><span class="op" id="7281391">)</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7281395">db</span><span class="op" id="7281397">.</span><span class="ident" id="7281398">dumpDeps</span><span class="op" id="7281406">(</span><span class="ident" id="7281407">t</span><span class="op" id="7281408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7281411">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7281415">driver</span><span class="op" id="7281421">.</span><span class="ident" id="7281422">mu</span><span class="op" id="7281424">.</span><span class="ident" id="7281425">Lock</span><span class="op" id="7281429">(</span><span class="op" id="7281430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7281433">opens</span>&nbsp;<span class="op" id="7281439">:=</span>&nbsp;<span class="ident" id="7281442">driver</span><span class="op" id="7281448">.</span><span class="ident" id="7281449">openCount</span>&nbsp;<span class="op" id="7281459">-</span>&nbsp;<span class="ident" id="7281461">opens0</span><br>
<span class="lineno">1160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7281469">closes</span>&nbsp;<span class="op" id="7281476">:=</span>&nbsp;<span class="ident" id="7281479">driver</span><span class="op" id="7281485">.</span><span class="ident" id="7281486">closeCount</span>&nbsp;<span class="op" id="7281497">-</span>&nbsp;<span class="ident" id="7281499">closes0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7281508">openDelta</span>&nbsp;<span class="op" id="7281518">:=</span>&nbsp;<span class="op" id="7281521">(</span><span class="ident" id="7281522">driver</span><span class="op" id="7281528">.</span><span class="ident" id="7281529">openCount</span>&nbsp;<span class="op" id="7281539">-</span>&nbsp;<span class="ident" id="7281541">driver</span><span class="op" id="7281547">.</span><span class="ident" id="7281548">closeCount</span><span class="op" id="7281558">)</span>&nbsp;<span class="op" id="7281560">-</span>&nbsp;<span class="ident" id="7281562">openDelta0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7281574">driver</span><span class="op" id="7281580">.</span><span class="ident" id="7281581">mu</span><span class="op" id="7281583">.</span><span class="ident" id="7281584">Unlock</span><span class="op" id="7281590">(</span><span class="op" id="7281591">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7281595">if</span>&nbsp;<span class="ident" id="7281598">openDelta</span>&nbsp;<span class="op" id="7281608">&gt;</span>&nbsp;<span class="num" id="7281610">2</span>&nbsp;<span class="op" id="7281612">{</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7281616">t</span><span class="op" id="7281617">.</span><span class="ident" id="7281618">Logf</span><span class="op" id="7281622">(</span><span class="string" id="7281623">&#34;open&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7281640">,</span>&nbsp;<span class="ident" id="7281642">opens</span><span class="op" id="7281647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7281651">t</span><span class="op" id="7281652">.</span><span class="ident" id="7281653">Logf</span><span class="op" id="7281657">(</span><span class="string" id="7281658">&#34;close&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7281676">,</span>&nbsp;<span class="ident" id="7281678">closes</span><span class="op" id="7281684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7281688">t</span><span class="op" id="7281689">.</span><span class="ident" id="7281690">Logf</span><span class="op" id="7281694">(</span><span class="string" id="7281695">&#34;open&nbsp;delta&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7281712">,</span>&nbsp;<span class="ident" id="7281714">openDelta</span><span class="op" id="7281723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7281727">t</span><span class="op" id="7281728">.</span><span class="ident" id="7281729">Errorf</span><span class="op" id="7281735">(</span><span class="string" id="7281736">&#34;db&nbsp;connections&nbsp;opened&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;2&#34;</span><span class="op" id="7281775">,</span>&nbsp;<span class="ident" id="7281777">openDelta</span><span class="op" id="7281786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7281790">db</span><span class="op" id="7281792">.</span><span class="ident" id="7281793">dumpDeps</span><span class="op" id="7281801">(</span><span class="ident" id="7281802">t</span><span class="op" id="7281803">)</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7281806">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7281810">if</span>&nbsp;<span class="builtinfunc" id="7281813">len</span><span class="op" id="7281816">(</span><span class="ident" id="7281817">stmt</span><span class="op" id="7281821">.</span><span class="ident" id="7281822">css</span><span class="op" id="7281825">)</span>&nbsp;<span class="op" id="7281827">&gt;</span>&nbsp;<span class="ident" id="7281829">nquery</span>&nbsp;<span class="op" id="7281836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7281840">t</span><span class="op" id="7281841">.</span><span class="ident" id="7281842">Errorf</span><span class="op" id="7281848">(</span><span class="string" id="7281849">&#34;len(stmt.css)&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;%d&#34;</span><span class="op" id="7281881">,</span>&nbsp;<span class="builtinfunc" id="7281883">len</span><span class="op" id="7281886">(</span><span class="ident" id="7281887">stmt</span><span class="op" id="7281891">.</span><span class="ident" id="7281892">css</span><span class="op" id="7281895">)</span><span class="op" id="7281896">,</span>&nbsp;<span class="ident" id="7281898">nquery</span><span class="op" id="7281904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7281907">}</span><br>
<span class="lineno">1175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7281911">if</span>&nbsp;<span class="ident" id="7281914">err</span>&nbsp;<span class="op" id="7281918">:=</span>&nbsp;<span class="ident" id="7281921">stmt</span><span class="op" id="7281925">.</span><span class="ident" id="7281926">Close</span><span class="op" id="7281931">(</span><span class="op" id="7281932">)</span><span class="op" id="7281933">;</span>&nbsp;<span class="ident" id="7281935">err</span>&nbsp;<span class="op" id="7281939">!=</span>&nbsp;<span class="ident" id="7281942">nil</span>&nbsp;<span class="op" id="7281946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7281950">t</span><span class="op" id="7281951">.</span><span class="ident" id="7281952">Fatal</span><span class="op" id="7281957">(</span><span class="ident" id="7281958">err</span><span class="op" id="7281961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7281964">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7281968">if</span>&nbsp;<span class="ident" id="7281971">g</span><span class="op" id="7281972">,</span>&nbsp;<span class="ident" id="7281974">w</span>&nbsp;<span class="op" id="7281976">:=</span>&nbsp;<span class="ident" id="7281979">db</span><span class="op" id="7281981">.</span><span class="ident" id="7281982">numFreeConns</span><span class="op" id="7281994">(</span><span class="op" id="7281995">)</span><span class="op" id="7281996">,</span>&nbsp;<span class="num" id="7281998">2</span><span class="op" id="7281999">;</span>&nbsp;<span class="ident" id="7282001">g</span>&nbsp;<span class="op" id="7282003">!=</span>&nbsp;<span class="ident" id="7282006">w</span>&nbsp;<span class="op" id="7282008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7282012">t</span><span class="op" id="7282013">.</span><span class="ident" id="7282014">Errorf</span><span class="op" id="7282020">(</span><span class="string" id="7282021">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7282047">,</span>&nbsp;<span class="ident" id="7282049">g</span><span class="op" id="7282050">,</span>&nbsp;<span class="ident" id="7282052">w</span><span class="op" id="7282053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7282056">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7282060">if</span>&nbsp;<span class="ident" id="7282063">n</span>&nbsp;<span class="op" id="7282065">:=</span>&nbsp;<span class="ident" id="7282068">db</span><span class="op" id="7282070">.</span><span class="ident" id="7282071">numDepsPollUntil</span><span class="op" id="7282087">(</span><span class="num" id="7282088">2</span><span class="op" id="7282089">,</span>&nbsp;<span class="ident" id="7282091">time</span><span class="op" id="7282095">.</span><span class="ident" id="7282096">Second</span><span class="op" id="7282102">)</span><span class="op" id="7282103">;</span>&nbsp;<span class="ident" id="7282105">n</span>&nbsp;<span class="op" id="7282107">&gt;</span>&nbsp;<span class="num" id="7282109">2</span>&nbsp;<span class="op" id="7282111">{</span><br>
<span class="lineno">1185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7282115">t</span><span class="op" id="7282116">.</span><span class="ident" id="7282117">Errorf</span><span class="op" id="7282123">(</span><span class="string" id="7282124">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;2&#34;</span><span class="op" id="7282168">,</span>&nbsp;<span class="ident" id="7282170">n</span><span class="op" id="7282171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7282175">db</span><span class="op" id="7282177">.</span><span class="ident" id="7282178">dumpDeps</span><span class="op" id="7282186">(</span><span class="ident" id="7282187">t</span><span class="op" id="7282188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7282191">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7282195">db</span><span class="op" id="7282197">.</span><span class="ident" id="7282198">SetMaxIdleConns</span><span class="op" id="7282213">(</span><span class="num" id="7282214">0</span><span class="op" id="7282215">)</span><br>
<span class="lineno">1190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7282219">if</span>&nbsp;<span class="ident" id="7282222">g</span><span class="op" id="7282223">,</span>&nbsp;<span class="ident" id="7282225">w</span>&nbsp;<span class="op" id="7282227">:=</span>&nbsp;<span class="ident" id="7282230">db</span><span class="op" id="7282232">.</span><span class="ident" id="7282233">numFreeConns</span><span class="op" id="7282245">(</span><span class="op" id="7282246">)</span><span class="op" id="7282247">,</span>&nbsp;<span class="num" id="7282249">0</span><span class="op" id="7282250">;</span>&nbsp;<span class="ident" id="7282252">g</span>&nbsp;<span class="op" id="7282254">!=</span>&nbsp;<span class="ident" id="7282257">w</span>&nbsp;<span class="op" id="7282259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7282263">t</span><span class="op" id="7282264">.</span><span class="ident" id="7282265">Errorf</span><span class="op" id="7282271">(</span><span class="string" id="7282272">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7282298">,</span>&nbsp;<span class="ident" id="7282300">g</span><span class="op" id="7282301">,</span>&nbsp;<span class="ident" id="7282303">w</span><span class="op" id="7282304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7282307">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7282311">if</span>&nbsp;<span class="ident" id="7282314">n</span>&nbsp;<span class="op" id="7282316">:=</span>&nbsp;<span class="ident" id="7282319">db</span><span class="op" id="7282321">.</span><span class="ident" id="7282322">numDepsPollUntil</span><span class="op" id="7282338">(</span><span class="num" id="7282339">0</span><span class="op" id="7282340">,</span>&nbsp;<span class="ident" id="7282342">time</span><span class="op" id="7282346">.</span><span class="ident" id="7282347">Second</span><span class="op" id="7282353">)</span><span class="op" id="7282354">;</span>&nbsp;<span class="ident" id="7282356">n</span>&nbsp;<span class="op" id="7282358">&gt;</span>&nbsp;<span class="num" id="7282360">0</span>&nbsp;<span class="op" id="7282362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7282366">t</span><span class="op" id="7282367">.</span><span class="ident" id="7282368">Errorf</span><span class="op" id="7282374">(</span><span class="string" id="7282375">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="7282416">,</span>&nbsp;<span class="ident" id="7282418">n</span><span class="op" id="7282419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7282423">db</span><span class="op" id="7282425">.</span><span class="ident" id="7282426">dumpDeps</span><span class="op" id="7282434">(</span><span class="ident" id="7282435">t</span><span class="op" id="7282436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7282439">}</span><br>
<span class="lineno"></span><span class="op" id="7282441">}</span><br>
<span class="lineno">1200</span><br>
<span class="lineno"></span><span class="comment" id="7282444">//&nbsp;golang.org/issue/5046</span><br>
<span class="lineno"></span><span class="keyword" id="7282469">func</span>&nbsp;<span class="ident" id="7282474">TestCloseConnBeforeStmts</span><span class="op" id="7282498">(</span><span class="ident" id="7282499">t</span>&nbsp;<span class="op" id="7282501">*</span><span class="ident" id="7282502">testing</span><span class="op" id="7282509">.</span><span class="ident" id="7282510">T</span><span class="op" id="7282511">)</span>&nbsp;<span class="op" id="7282513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7282516">db</span>&nbsp;<span class="op" id="7282519">:=</span>&nbsp;<span class="ident" id="7282522">newTestDB</span><span class="op" id="7282531">(</span><span class="ident" id="7282532">t</span><span class="op" id="7282533">,</span>&nbsp;<span class="string" id="7282535">&#34;people&#34;</span><span class="op" id="7282543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7282546">defer</span>&nbsp;<span class="ident" id="7282552">closeDB</span><span class="op" id="7282559">(</span><span class="ident" id="7282560">t</span><span class="op" id="7282561">,</span>&nbsp;<span class="ident" id="7282563">db</span><span class="op" id="7282565">)</span><br>
<span class="lineno">1205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7282569">defer</span>&nbsp;<span class="ident" id="7282575">setHookpostCloseConn</span><span class="op" id="7282595">(</span><span class="ident" id="7282596">nil</span><span class="op" id="7282599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7282602">setHookpostCloseConn</span><span class="op" id="7282622">(</span><span class="keyword" id="7282623">func</span><span class="op" id="7282627">(</span><span class="ident" id="7282628">_</span>&nbsp;<span class="op" id="7282630">*</span><span class="ident" id="7282631">fakeConn</span><span class="op" id="7282639">,</span>&nbsp;<span class="ident" id="7282641">err</span>&nbsp;<span class="builtintype" id="7282645">error</span><span class="op" id="7282650">)</span>&nbsp;<span class="op" id="7282652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7282656">if</span>&nbsp;<span class="ident" id="7282659">err</span>&nbsp;<span class="op" id="7282663">!=</span>&nbsp;<span class="ident" id="7282666">nil</span>&nbsp;<span class="op" id="7282670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7282675">t</span><span class="op" id="7282676">.</span><span class="ident" id="7282677">Errorf</span><span class="op" id="7282683">(</span><span class="string" id="7282684">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v;&nbsp;from&nbsp;%s&#34;</span><span class="op" id="7282721">,</span>&nbsp;<span class="ident" id="7282723">err</span><span class="op" id="7282726">,</span>&nbsp;<span class="ident" id="7282728">stack</span><span class="op" id="7282733">(</span><span class="op" id="7282734">)</span><span class="op" id="7282735">)</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7282740">db</span><span class="op" id="7282742">.</span><span class="ident" id="7282743">dumpDeps</span><span class="op" id="7282751">(</span><span class="ident" id="7282752">t</span><span class="op" id="7282753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7282758">t</span><span class="op" id="7282759">.</span><span class="ident" id="7282760">Errorf</span><span class="op" id="7282766">(</span><span class="string" id="7282767">&#34;DB&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="7282777">,</span>&nbsp;<span class="ident" id="7282779">db</span><span class="op" id="7282781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7282785">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7282788">}</span><span class="op" id="7282789">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7282793">stmt</span><span class="op" id="7282797">,</span>&nbsp;<span class="ident" id="7282799">err</span>&nbsp;<span class="op" id="7282803">:=</span>&nbsp;<span class="ident" id="7282806">db</span><span class="op" id="7282808">.</span><span class="ident" id="7282809">Prepare</span><span class="op" id="7282816">(</span><span class="string" id="7282817">&#34;SELECT|people|name|&#34;</span><span class="op" id="7282838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7282841">if</span>&nbsp;<span class="ident" id="7282844">err</span>&nbsp;<span class="op" id="7282848">!=</span>&nbsp;<span class="ident" id="7282851">nil</span>&nbsp;<span class="op" id="7282855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7282859">t</span><span class="op" id="7282860">.</span><span class="ident" id="7282861">Fatal</span><span class="op" id="7282866">(</span><span class="ident" id="7282867">err</span><span class="op" id="7282870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7282873">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7282877">if</span>&nbsp;<span class="builtinfunc" id="7282880">len</span><span class="op" id="7282883">(</span><span class="ident" id="7282884">db</span><span class="op" id="7282886">.</span><span class="ident" id="7282887">freeConn</span><span class="op" id="7282895">)</span>&nbsp;<span class="op" id="7282897">!=</span>&nbsp;<span class="num" id="7282900">1</span>&nbsp;<span class="op" id="7282902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7282906">t</span><span class="op" id="7282907">.</span><span class="ident" id="7282908">Fatalf</span><span class="op" id="7282914">(</span><span class="string" id="7282915">&#34;expected&nbsp;1&nbsp;freeConn;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="7282944">,</span>&nbsp;<span class="builtinfunc" id="7282946">len</span><span class="op" id="7282949">(</span><span class="ident" id="7282950">db</span><span class="op" id="7282952">.</span><span class="ident" id="7282953">freeConn</span><span class="op" id="7282961">)</span><span class="op" id="7282962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7282965">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7282968">dc</span>&nbsp;<span class="op" id="7282971">:=</span>&nbsp;<span class="ident" id="7282974">db</span><span class="op" id="7282976">.</span><span class="ident" id="7282977">freeConn</span><span class="op" id="7282985">[</span><span class="num" id="7282986">0</span><span class="op" id="7282987">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7282990">if</span>&nbsp;<span class="ident" id="7282993">dc</span><span class="op" id="7282995">.</span><span class="ident" id="7282996">closed</span>&nbsp;<span class="op" id="7283003">{</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7283007">t</span><span class="op" id="7283008">.</span><span class="ident" id="7283009">Errorf</span><span class="op" id="7283015">(</span><span class="string" id="7283016">&#34;conn&nbsp;shouldn&#39;t&nbsp;be&nbsp;closed&#34;</span><span class="op" id="7283042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7283045">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7283049">if</span>&nbsp;<span class="ident" id="7283052">n</span>&nbsp;<span class="op" id="7283054">:=</span>&nbsp;<span class="builtinfunc" id="7283057">len</span><span class="op" id="7283060">(</span><span class="ident" id="7283061">dc</span><span class="op" id="7283063">.</span><span class="ident" id="7283064">openStmt</span><span class="op" id="7283072">)</span><span class="op" id="7283073">;</span>&nbsp;<span class="ident" id="7283075">n</span>&nbsp;<span class="op" id="7283077">!=</span>&nbsp;<span class="num" id="7283080">1</span>&nbsp;<span class="op" id="7283082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7283086">t</span><span class="op" id="7283087">.</span><span class="ident" id="7283088">Errorf</span><span class="op" id="7283094">(</span><span class="string" id="7283095">&#34;driverConn&nbsp;num&nbsp;openStmt&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="7283133">,</span>&nbsp;<span class="ident" id="7283135">n</span><span class="op" id="7283136">)</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7283139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7283142">err</span>&nbsp;<span class="op" id="7283146">=</span>&nbsp;<span class="ident" id="7283148">db</span><span class="op" id="7283150">.</span><span class="ident" id="7283151">Close</span><span class="op" id="7283156">(</span><span class="op" id="7283157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7283160">if</span>&nbsp;<span class="ident" id="7283163">err</span>&nbsp;<span class="op" id="7283167">!=</span>&nbsp;<span class="ident" id="7283170">nil</span>&nbsp;<span class="op" id="7283174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7283178">t</span><span class="op" id="7283179">.</span><span class="ident" id="7283180">Errorf</span><span class="op" id="7283186">(</span><span class="string" id="7283187">&#34;db&nbsp;Close&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7283202">,</span>&nbsp;<span class="ident" id="7283204">err</span><span class="op" id="7283207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7283210">}</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7283213">if</span>&nbsp;<span class="op" id="7283216">!</span><span class="ident" id="7283217">dc</span><span class="op" id="7283219">.</span><span class="ident" id="7283220">closed</span>&nbsp;<span class="op" id="7283227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7283231">t</span><span class="op" id="7283232">.</span><span class="ident" id="7283233">Errorf</span><span class="op" id="7283239">(</span><span class="string" id="7283240">&#34;after&nbsp;db.Close,&nbsp;driverConn&nbsp;should&nbsp;be&nbsp;closed&#34;</span><span class="op" id="7283285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7283288">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7283291">if</span>&nbsp;<span class="ident" id="7283294">n</span>&nbsp;<span class="op" id="7283296">:=</span>&nbsp;<span class="builtinfunc" id="7283299">len</span><span class="op" id="7283302">(</span><span class="ident" id="7283303">dc</span><span class="op" id="7283305">.</span><span class="ident" id="7283306">openStmt</span><span class="op" id="7283314">)</span><span class="op" id="7283315">;</span>&nbsp;<span class="ident" id="7283317">n</span>&nbsp;<span class="op" id="7283319">!=</span>&nbsp;<span class="num" id="7283322">0</span>&nbsp;<span class="op" id="7283324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7283328">t</span><span class="op" id="7283329">.</span><span class="ident" id="7283330">Errorf</span><span class="op" id="7283336">(</span><span class="string" id="7283337">&#34;driverConn&nbsp;num&nbsp;openStmt&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="7283375">,</span>&nbsp;<span class="ident" id="7283377">n</span><span class="op" id="7283378">)</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7283381">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7283385">err</span>&nbsp;<span class="op" id="7283389">=</span>&nbsp;<span class="ident" id="7283391">stmt</span><span class="op" id="7283395">.</span><span class="ident" id="7283396">Close</span><span class="op" id="7283401">(</span><span class="op" id="7283402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7283405">if</span>&nbsp;<span class="ident" id="7283408">err</span>&nbsp;<span class="op" id="7283412">!=</span>&nbsp;<span class="ident" id="7283415">nil</span>&nbsp;<span class="op" id="7283419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7283423">t</span><span class="op" id="7283424">.</span><span class="ident" id="7283425">Errorf</span><span class="op" id="7283431">(</span><span class="string" id="7283432">&#34;Stmt&nbsp;close&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7283449">,</span>&nbsp;<span class="ident" id="7283451">err</span><span class="op" id="7283454">)</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7283457">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7283461">if</span>&nbsp;<span class="op" id="7283464">!</span><span class="ident" id="7283465">dc</span><span class="op" id="7283467">.</span><span class="ident" id="7283468">closed</span>&nbsp;<span class="op" id="7283475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7283479">t</span><span class="op" id="7283480">.</span><span class="ident" id="7283481">Errorf</span><span class="op" id="7283487">(</span><span class="string" id="7283488">&#34;conn&nbsp;should&nbsp;be&nbsp;closed&#34;</span><span class="op" id="7283511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7283514">}</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7283517">if</span>&nbsp;<span class="ident" id="7283520">dc</span><span class="op" id="7283522">.</span><span class="ident" id="7283523">ci</span>&nbsp;<span class="op" id="7283526">!=</span>&nbsp;<span class="ident" id="7283529">nil</span>&nbsp;<span class="op" id="7283533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7283537">t</span><span class="op" id="7283538">.</span><span class="ident" id="7283539">Errorf</span><span class="op" id="7283545">(</span><span class="string" id="7283546">&#34;after&nbsp;Stmt&nbsp;Close,&nbsp;driverConn&#39;s&nbsp;Conn&nbsp;interface&nbsp;should&nbsp;be&nbsp;nil&#34;</span><span class="op" id="7283607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7283610">}</span><br>
<span class="lineno"></span><span class="op" id="7283612">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1255</span><span class="comment" id="7283615">//&nbsp;golang.org/issue/5283:&nbsp;don&#39;t&nbsp;release&nbsp;the&nbsp;Rows&#39;&nbsp;connection&nbsp;in&nbsp;Close</span><br>
<span class="lineno"></span><span class="comment" id="7283685">//&nbsp;before&nbsp;calling&nbsp;Stmt.Close.</span><br>
<span class="lineno"></span><span class="keyword" id="7283715">func</span>&nbsp;<span class="ident" id="7283720">TestRowsCloseOrder</span><span class="op" id="7283738">(</span><span class="ident" id="7283739">t</span>&nbsp;<span class="op" id="7283741">*</span><span class="ident" id="7283742">testing</span><span class="op" id="7283749">.</span><span class="ident" id="7283750">T</span><span class="op" id="7283751">)</span>&nbsp;<span class="op" id="7283753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7283756">db</span>&nbsp;<span class="op" id="7283759">:=</span>&nbsp;<span class="ident" id="7283762">newTestDB</span><span class="op" id="7283771">(</span><span class="ident" id="7283772">t</span><span class="op" id="7283773">,</span>&nbsp;<span class="string" id="7283775">&#34;people&#34;</span><span class="op" id="7283783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7283786">defer</span>&nbsp;<span class="ident" id="7283792">closeDB</span><span class="op" id="7283799">(</span><span class="ident" id="7283800">t</span><span class="op" id="7283801">,</span>&nbsp;<span class="ident" id="7283803">db</span><span class="op" id="7283805">)</span><br>
<span class="lineno">1260</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7283809">db</span><span class="op" id="7283811">.</span><span class="ident" id="7283812">SetMaxIdleConns</span><span class="op" id="7283827">(</span><span class="num" id="7283828">0</span><span class="op" id="7283829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7283832">setStrictFakeConnClose</span><span class="op" id="7283854">(</span><span class="ident" id="7283855">t</span><span class="op" id="7283856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7283859">defer</span>&nbsp;<span class="ident" id="7283865">setStrictFakeConnClose</span><span class="op" id="7283887">(</span><span class="ident" id="7283888">nil</span><span class="op" id="7283891">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7283895">rows</span><span class="op" id="7283899">,</span>&nbsp;<span class="ident" id="7283901">err</span>&nbsp;<span class="op" id="7283905">:=</span>&nbsp;<span class="ident" id="7283908">db</span><span class="op" id="7283910">.</span><span class="ident" id="7283911">Query</span><span class="op" id="7283916">(</span><span class="string" id="7283917">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="7283942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7283945">if</span>&nbsp;<span class="ident" id="7283948">err</span>&nbsp;<span class="op" id="7283952">!=</span>&nbsp;<span class="ident" id="7283955">nil</span>&nbsp;<span class="op" id="7283959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7283963">t</span><span class="op" id="7283964">.</span><span class="ident" id="7283965">Fatal</span><span class="op" id="7283970">(</span><span class="ident" id="7283971">err</span><span class="op" id="7283974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7283977">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7283980">err</span>&nbsp;<span class="op" id="7283984">=</span>&nbsp;<span class="ident" id="7283986">rows</span><span class="op" id="7283990">.</span><span class="ident" id="7283991">Close</span><span class="op" id="7283996">(</span><span class="op" id="7283997">)</span><br>
<span class="lineno">1270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7284000">if</span>&nbsp;<span class="ident" id="7284003">err</span>&nbsp;<span class="op" id="7284007">!=</span>&nbsp;<span class="ident" id="7284010">nil</span>&nbsp;<span class="op" id="7284014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7284018">t</span><span class="op" id="7284019">.</span><span class="ident" id="7284020">Fatal</span><span class="op" id="7284025">(</span><span class="ident" id="7284026">err</span><span class="op" id="7284029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7284032">}</span><br>
<span class="lineno"></span><span class="op" id="7284034">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1275</span><span class="keyword" id="7284037">func</span>&nbsp;<span class="ident" id="7284042">TestRowsImplicitClose</span><span class="op" id="7284063">(</span><span class="ident" id="7284064">t</span>&nbsp;<span class="op" id="7284066">*</span><span class="ident" id="7284067">testing</span><span class="op" id="7284074">.</span><span class="ident" id="7284075">T</span><span class="op" id="7284076">)</span>&nbsp;<span class="op" id="7284078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7284081">db</span>&nbsp;<span class="op" id="7284084">:=</span>&nbsp;<span class="ident" id="7284087">newTestDB</span><span class="op" id="7284096">(</span><span class="ident" id="7284097">t</span><span class="op" id="7284098">,</span>&nbsp;<span class="string" id="7284100">&#34;people&#34;</span><span class="op" id="7284108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7284111">defer</span>&nbsp;<span class="ident" id="7284117">closeDB</span><span class="op" id="7284124">(</span><span class="ident" id="7284125">t</span><span class="op" id="7284126">,</span>&nbsp;<span class="ident" id="7284128">db</span><span class="op" id="7284130">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7284134">rows</span><span class="op" id="7284138">,</span>&nbsp;<span class="ident" id="7284140">err</span>&nbsp;<span class="op" id="7284144">:=</span>&nbsp;<span class="ident" id="7284147">db</span><span class="op" id="7284149">.</span><span class="ident" id="7284150">Query</span><span class="op" id="7284155">(</span><span class="string" id="7284156">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="7284181">)</span><br>
<span class="lineno">1280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7284184">if</span>&nbsp;<span class="ident" id="7284187">err</span>&nbsp;<span class="op" id="7284191">!=</span>&nbsp;<span class="ident" id="7284194">nil</span>&nbsp;<span class="op" id="7284198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7284202">t</span><span class="op" id="7284203">.</span><span class="ident" id="7284204">Fatal</span><span class="op" id="7284209">(</span><span class="ident" id="7284210">err</span><span class="op" id="7284213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7284216">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7284220">want</span><span class="op" id="7284224">,</span>&nbsp;<span class="ident" id="7284226">fail</span>&nbsp;<span class="op" id="7284231">:=</span>&nbsp;<span class="num" id="7284234">2</span><span class="op" id="7284235">,</span>&nbsp;<span class="ident" id="7284237">errors</span><span class="op" id="7284243">.</span><span class="ident" id="7284244">New</span><span class="op" id="7284247">(</span><span class="string" id="7284248">&#34;fail&#34;</span><span class="op" id="7284254">)</span><br>
<span class="lineno">1285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7284257">r</span>&nbsp;<span class="op" id="7284259">:=</span>&nbsp;<span class="ident" id="7284262">rows</span><span class="op" id="7284266">.</span><span class="ident" id="7284267">rowsi</span><span class="op" id="7284272">.</span><span class="op" id="7284273">(</span><span class="op" id="7284274">*</span><span class="ident" id="7284275">rowsCursor</span><span class="op" id="7284285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7284288">r</span><span class="op" id="7284289">.</span><span class="ident" id="7284290">errPos</span><span class="op" id="7284296">,</span>&nbsp;<span class="ident" id="7284298">r</span><span class="op" id="7284299">.</span><span class="ident" id="7284300">err</span>&nbsp;<span class="op" id="7284304">=</span>&nbsp;<span class="ident" id="7284306">want</span><span class="op" id="7284310">,</span>&nbsp;<span class="ident" id="7284312">fail</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7284319">got</span>&nbsp;<span class="op" id="7284323">:=</span>&nbsp;<span class="num" id="7284326">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7284329">for</span>&nbsp;<span class="ident" id="7284333">rows</span><span class="op" id="7284337">.</span><span class="ident" id="7284338">Next</span><span class="op" id="7284342">(</span><span class="op" id="7284343">)</span>&nbsp;<span class="op" id="7284345">{</span><br>
<span class="lineno">1290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7284349">got</span><span class="op" id="7284352">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7284356">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7284359">if</span>&nbsp;<span class="ident" id="7284362">got</span>&nbsp;<span class="op" id="7284366">!=</span>&nbsp;<span class="ident" id="7284369">want</span>&nbsp;<span class="op" id="7284374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7284378">t</span><span class="op" id="7284379">.</span><span class="ident" id="7284380">Errorf</span><span class="op" id="7284386">(</span><span class="string" id="7284387">&#34;got&nbsp;%d&nbsp;rows,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7284409">,</span>&nbsp;<span class="ident" id="7284411">got</span><span class="op" id="7284414">,</span>&nbsp;<span class="ident" id="7284416">want</span><span class="op" id="7284420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7284423">}</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7284426">if</span>&nbsp;<span class="ident" id="7284429">err</span>&nbsp;<span class="op" id="7284433">:=</span>&nbsp;<span class="ident" id="7284436">rows</span><span class="op" id="7284440">.</span><span class="ident" id="7284441">Err</span><span class="op" id="7284444">(</span><span class="op" id="7284445">)</span><span class="op" id="7284446">;</span>&nbsp;<span class="ident" id="7284448">err</span>&nbsp;<span class="op" id="7284452">!=</span>&nbsp;<span class="ident" id="7284455">fail</span>&nbsp;<span class="op" id="7284460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7284464">t</span><span class="op" id="7284465">.</span><span class="ident" id="7284466">Errorf</span><span class="op" id="7284472">(</span><span class="string" id="7284473">&#34;got&nbsp;error&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="7284496">,</span>&nbsp;<span class="ident" id="7284498">err</span><span class="op" id="7284501">,</span>&nbsp;<span class="ident" id="7284503">fail</span><span class="op" id="7284507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7284510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7284513">if</span>&nbsp;<span class="op" id="7284516">!</span><span class="ident" id="7284517">r</span><span class="op" id="7284518">.</span><span class="ident" id="7284519">closed</span>&nbsp;<span class="op" id="7284526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7284530">t</span><span class="op" id="7284531">.</span><span class="ident" id="7284532">Errorf</span><span class="op" id="7284538">(</span><span class="string" id="7284539">&#34;r.closed&nbsp;is&nbsp;false,&nbsp;want&nbsp;true&#34;</span><span class="op" id="7284569">)</span><br>
<span class="lineno">1300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7284572">}</span><br>
<span class="lineno"></span><span class="op" id="7284574">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7284577">func</span>&nbsp;<span class="ident" id="7284582">TestStmtCloseOrder</span><span class="op" id="7284600">(</span><span class="ident" id="7284601">t</span>&nbsp;<span class="op" id="7284603">*</span><span class="ident" id="7284604">testing</span><span class="op" id="7284611">.</span><span class="ident" id="7284612">T</span><span class="op" id="7284613">)</span>&nbsp;<span class="op" id="7284615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7284618">db</span>&nbsp;<span class="op" id="7284621">:=</span>&nbsp;<span class="ident" id="7284624">newTestDB</span><span class="op" id="7284633">(</span><span class="ident" id="7284634">t</span><span class="op" id="7284635">,</span>&nbsp;<span class="string" id="7284637">&#34;people&#34;</span><span class="op" id="7284645">)</span><br>
<span class="lineno">1305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7284648">defer</span>&nbsp;<span class="ident" id="7284654">closeDB</span><span class="op" id="7284661">(</span><span class="ident" id="7284662">t</span><span class="op" id="7284663">,</span>&nbsp;<span class="ident" id="7284665">db</span><span class="op" id="7284667">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7284671">db</span><span class="op" id="7284673">.</span><span class="ident" id="7284674">SetMaxIdleConns</span><span class="op" id="7284689">(</span><span class="num" id="7284690">0</span><span class="op" id="7284691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7284694">setStrictFakeConnClose</span><span class="op" id="7284716">(</span><span class="ident" id="7284717">t</span><span class="op" id="7284718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7284721">defer</span>&nbsp;<span class="ident" id="7284727">setStrictFakeConnClose</span><span class="op" id="7284749">(</span><span class="ident" id="7284750">nil</span><span class="op" id="7284753">)</span><br>
<span class="lineno">1310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7284757">_</span><span class="op" id="7284758">,</span>&nbsp;<span class="ident" id="7284760">err</span>&nbsp;<span class="op" id="7284764">:=</span>&nbsp;<span class="ident" id="7284767">db</span><span class="op" id="7284769">.</span><span class="ident" id="7284770">Query</span><span class="op" id="7284775">(</span><span class="string" id="7284776">&#34;SELECT|non_existent|name|&#34;</span><span class="op" id="7284803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7284806">if</span>&nbsp;<span class="ident" id="7284809">err</span>&nbsp;<span class="op" id="7284813">==</span>&nbsp;<span class="ident" id="7284816">nil</span>&nbsp;<span class="op" id="7284820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7284824">t</span><span class="op" id="7284825">.</span><span class="ident" id="7284826">Fatal</span><span class="op" id="7284831">(</span><span class="string" id="7284832">&#34;Quering&nbsp;non-existent&nbsp;table&nbsp;should&nbsp;fail&#34;</span><span class="op" id="7284872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7284875">}</span><br>
<span class="lineno">1315</span><span class="op" id="7284877">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7284880">//&nbsp;golang.org/issue/5781</span><br>
<span class="lineno"></span><span class="keyword" id="7284905">func</span>&nbsp;<span class="ident" id="7284910">TestErrBadConnReconnect</span><span class="op" id="7284933">(</span><span class="ident" id="7284934">t</span>&nbsp;<span class="op" id="7284936">*</span><span class="ident" id="7284937">testing</span><span class="op" id="7284944">.</span><span class="ident" id="7284945">T</span><span class="op" id="7284946">)</span>&nbsp;<span class="op" id="7284948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7284951">db</span>&nbsp;<span class="op" id="7284954">:=</span>&nbsp;<span class="ident" id="7284957">newTestDB</span><span class="op" id="7284966">(</span><span class="ident" id="7284967">t</span><span class="op" id="7284968">,</span>&nbsp;<span class="string" id="7284970">&#34;foo&#34;</span><span class="op" id="7284975">)</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7284978">defer</span>&nbsp;<span class="ident" id="7284984">closeDB</span><span class="op" id="7284991">(</span><span class="ident" id="7284992">t</span><span class="op" id="7284993">,</span>&nbsp;<span class="ident" id="7284995">db</span><span class="op" id="7284997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7285000">exec</span><span class="op" id="7285004">(</span><span class="ident" id="7285005">t</span><span class="op" id="7285006">,</span>&nbsp;<span class="ident" id="7285008">db</span><span class="op" id="7285010">,</span>&nbsp;<span class="string" id="7285012">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7285055">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7285059">simulateBadConn</span>&nbsp;<span class="op" id="7285075">:=</span>&nbsp;<span class="keyword" id="7285078">func</span><span class="op" id="7285082">(</span><span class="ident" id="7285083">name</span>&nbsp;<span class="builtintype" id="7285088">string</span><span class="op" id="7285094">,</span>&nbsp;<span class="ident" id="7285096">hook</span>&nbsp;<span class="op" id="7285101">*</span><span class="keyword" id="7285102">func</span><span class="op" id="7285106">(</span><span class="op" id="7285107">)</span>&nbsp;<span class="builtintype" id="7285109">bool</span><span class="op" id="7285113">,</span>&nbsp;<span class="ident" id="7285115">op</span>&nbsp;<span class="keyword" id="7285118">func</span><span class="op" id="7285122">(</span><span class="op" id="7285123">)</span>&nbsp;<span class="builtintype" id="7285125">error</span><span class="op" id="7285130">)</span>&nbsp;<span class="op" id="7285132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7285136">broken</span><span class="op" id="7285142">,</span>&nbsp;<span class="ident" id="7285144">retried</span>&nbsp;<span class="op" id="7285152">:=</span>&nbsp;<span class="ident" id="7285155">false</span><span class="op" id="7285160">,</span>&nbsp;<span class="ident" id="7285162">false</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7285170">numOpen</span>&nbsp;<span class="op" id="7285178">:=</span>&nbsp;<span class="ident" id="7285181">db</span><span class="op" id="7285183">.</span><span class="ident" id="7285184">numOpen</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7285195">//&nbsp;simulate&nbsp;a&nbsp;broken&nbsp;connection&nbsp;on&nbsp;the&nbsp;first&nbsp;try</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7285246">*</span><span class="ident" id="7285247">hook</span>&nbsp;<span class="op" id="7285252">=</span>&nbsp;<span class="keyword" id="7285254">func</span><span class="op" id="7285258">(</span><span class="op" id="7285259">)</span>&nbsp;<span class="builtintype" id="7285261">bool</span>&nbsp;<span class="op" id="7285266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7285271">if</span>&nbsp;<span class="op" id="7285274">!</span><span class="ident" id="7285275">broken</span>&nbsp;<span class="op" id="7285282">{</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7285288">broken</span>&nbsp;<span class="op" id="7285295">=</span>&nbsp;<span class="ident" id="7285297">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7285306">return</span>&nbsp;<span class="ident" id="7285313">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7285321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7285326">retried</span>&nbsp;<span class="op" id="7285334">=</span>&nbsp;<span class="ident" id="7285336">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7285344">return</span>&nbsp;<span class="ident" id="7285351">false</span><br>
<span class="lineno">1335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7285359">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7285364">if</span>&nbsp;<span class="ident" id="7285367">err</span>&nbsp;<span class="op" id="7285371">:=</span>&nbsp;<span class="ident" id="7285374">op</span><span class="op" id="7285376">(</span><span class="op" id="7285377">)</span><span class="op" id="7285378">;</span>&nbsp;<span class="ident" id="7285380">err</span>&nbsp;<span class="op" id="7285384">!=</span>&nbsp;<span class="ident" id="7285387">nil</span>&nbsp;<span class="op" id="7285391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7285396">t</span><span class="op" id="7285397">.</span><span class="ident" id="7285398">Errorf</span><span class="op" id="7285404">(</span><span class="ident" id="7285405">name</span><span class="op" id="7285409">+</span><span class="string" id="7285410">&#34;:&nbsp;%v&#34;</span><span class="op" id="7285416">,</span>&nbsp;<span class="ident" id="7285418">err</span><span class="op" id="7285421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7285426">return</span><br>
<span class="lineno">1340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7285435">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7285440">if</span>&nbsp;<span class="op" id="7285443">!</span><span class="ident" id="7285444">broken</span>&nbsp;<span class="op" id="7285451">||</span>&nbsp;<span class="op" id="7285454">!</span><span class="ident" id="7285455">retried</span>&nbsp;<span class="op" id="7285463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7285468">t</span><span class="op" id="7285469">.</span><span class="ident" id="7285470">Error</span><span class="op" id="7285475">(</span><span class="ident" id="7285476">name</span>&nbsp;<span class="op" id="7285481">+</span>&nbsp;<span class="string" id="7285483">&#34;:&nbsp;Failed&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connection&#34;</span><span class="op" id="7285523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7285527">}</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7285531">*</span><span class="ident" id="7285532">hook</span>&nbsp;<span class="op" id="7285537">=</span>&nbsp;<span class="ident" id="7285539">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7285546">if</span>&nbsp;<span class="ident" id="7285549">numOpen</span>&nbsp;<span class="op" id="7285557">!=</span>&nbsp;<span class="ident" id="7285560">db</span><span class="op" id="7285562">.</span><span class="ident" id="7285563">numOpen</span>&nbsp;<span class="op" id="7285571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7285576">t</span><span class="op" id="7285577">.</span><span class="ident" id="7285578">Errorf</span><span class="op" id="7285584">(</span><span class="ident" id="7285585">name</span><span class="op" id="7285589">+</span><span class="string" id="7285590">&#34;:&nbsp;leaked&nbsp;%d&nbsp;connection(s)!&#34;</span><span class="op" id="7285618">,</span>&nbsp;<span class="ident" id="7285620">db</span><span class="op" id="7285622">.</span><span class="ident" id="7285623">numOpen</span><span class="op" id="7285630">-</span><span class="ident" id="7285631">numOpen</span><span class="op" id="7285638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7285643">numOpen</span>&nbsp;<span class="op" id="7285651">=</span>&nbsp;<span class="ident" id="7285653">db</span><span class="op" id="7285655">.</span><span class="ident" id="7285656">numOpen</span><br>
<span class="lineno">1350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7285666">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7285669">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7285673">//&nbsp;db.Exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7285685">dbExec</span>&nbsp;<span class="op" id="7285692">:=</span>&nbsp;<span class="keyword" id="7285695">func</span><span class="op" id="7285699">(</span><span class="op" id="7285700">)</span>&nbsp;<span class="builtintype" id="7285702">error</span>&nbsp;<span class="op" id="7285708">{</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7285712">_</span><span class="op" id="7285713">,</span>&nbsp;<span class="ident" id="7285715">err</span>&nbsp;<span class="op" id="7285719">:=</span>&nbsp;<span class="ident" id="7285722">db</span><span class="op" id="7285724">.</span><span class="ident" id="7285725">Exec</span><span class="op" id="7285729">(</span><span class="string" id="7285730">&#34;INSERT|t1|name=?,age=?,dead=?&#34;</span><span class="op" id="7285761">,</span>&nbsp;<span class="string" id="7285763">&#34;Gordon&#34;</span><span class="op" id="7285771">,</span>&nbsp;<span class="num" id="7285773">3</span><span class="op" id="7285774">,</span>&nbsp;<span class="ident" id="7285776">true</span><span class="op" id="7285780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7285784">return</span>&nbsp;<span class="ident" id="7285791">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7285796">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7285799">simulateBadConn</span><span class="op" id="7285814">(</span><span class="string" id="7285815">&#34;db.Exec&nbsp;prepare&#34;</span><span class="op" id="7285832">,</span>&nbsp;<span class="op" id="7285834">&amp;</span><span class="ident" id="7285835">hookPrepareBadConn</span><span class="op" id="7285853">,</span>&nbsp;<span class="ident" id="7285855">dbExec</span><span class="op" id="7285861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7285864">simulateBadConn</span><span class="op" id="7285879">(</span><span class="string" id="7285880">&#34;db.Exec&nbsp;exec&#34;</span><span class="op" id="7285894">,</span>&nbsp;<span class="op" id="7285896">&amp;</span><span class="ident" id="7285897">hookExecBadConn</span><span class="op" id="7285912">,</span>&nbsp;<span class="ident" id="7285914">dbExec</span><span class="op" id="7285920">)</span><br>
<span class="lineno">1360</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7285924">//&nbsp;db.Query</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7285937">dbQuery</span>&nbsp;<span class="op" id="7285945">:=</span>&nbsp;<span class="keyword" id="7285948">func</span><span class="op" id="7285952">(</span><span class="op" id="7285953">)</span>&nbsp;<span class="builtintype" id="7285955">error</span>&nbsp;<span class="op" id="7285961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7285965">rows</span><span class="op" id="7285969">,</span>&nbsp;<span class="ident" id="7285971">err</span>&nbsp;<span class="op" id="7285975">:=</span>&nbsp;<span class="ident" id="7285978">db</span><span class="op" id="7285980">.</span><span class="ident" id="7285981">Query</span><span class="op" id="7285986">(</span><span class="string" id="7285987">&#34;SELECT|t1|age,name|&#34;</span><span class="op" id="7286008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7286012">if</span>&nbsp;<span class="ident" id="7286015">err</span>&nbsp;<span class="op" id="7286019">==</span>&nbsp;<span class="ident" id="7286022">nil</span>&nbsp;<span class="op" id="7286026">{</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7286031">err</span>&nbsp;<span class="op" id="7286035">=</span>&nbsp;<span class="ident" id="7286037">rows</span><span class="op" id="7286041">.</span><span class="ident" id="7286042">Close</span><span class="op" id="7286047">(</span><span class="op" id="7286048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7286052">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7286056">return</span>&nbsp;<span class="ident" id="7286063">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7286068">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7286071">simulateBadConn</span><span class="op" id="7286086">(</span><span class="string" id="7286087">&#34;db.Query&nbsp;prepare&#34;</span><span class="op" id="7286105">,</span>&nbsp;<span class="op" id="7286107">&amp;</span><span class="ident" id="7286108">hookPrepareBadConn</span><span class="op" id="7286126">,</span>&nbsp;<span class="ident" id="7286128">dbQuery</span><span class="op" id="7286135">)</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7286138">simulateBadConn</span><span class="op" id="7286153">(</span><span class="string" id="7286154">&#34;db.Query&nbsp;query&#34;</span><span class="op" id="7286170">,</span>&nbsp;<span class="op" id="7286172">&amp;</span><span class="ident" id="7286173">hookQueryBadConn</span><span class="op" id="7286189">,</span>&nbsp;<span class="ident" id="7286191">dbQuery</span><span class="op" id="7286198">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7286202">//&nbsp;db.Prepare</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7286217">simulateBadConn</span><span class="op" id="7286232">(</span><span class="string" id="7286233">&#34;db.Prepare&#34;</span><span class="op" id="7286245">,</span>&nbsp;<span class="op" id="7286247">&amp;</span><span class="ident" id="7286248">hookPrepareBadConn</span><span class="op" id="7286266">,</span>&nbsp;<span class="keyword" id="7286268">func</span><span class="op" id="7286272">(</span><span class="op" id="7286273">)</span>&nbsp;<span class="builtintype" id="7286275">error</span>&nbsp;<span class="op" id="7286281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7286285">stmt</span><span class="op" id="7286289">,</span>&nbsp;<span class="ident" id="7286291">err</span>&nbsp;<span class="op" id="7286295">:=</span>&nbsp;<span class="ident" id="7286298">db</span><span class="op" id="7286300">.</span><span class="ident" id="7286301">Prepare</span><span class="op" id="7286308">(</span><span class="string" id="7286309">&#34;INSERT|t1|name=?,age=?,dead=?&#34;</span><span class="op" id="7286340">)</span><br>
<span class="lineno">1375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7286344">if</span>&nbsp;<span class="ident" id="7286347">err</span>&nbsp;<span class="op" id="7286351">!=</span>&nbsp;<span class="ident" id="7286354">nil</span>&nbsp;<span class="op" id="7286358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7286363">return</span>&nbsp;<span class="ident" id="7286370">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7286376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7286380">stmt</span><span class="op" id="7286384">.</span><span class="ident" id="7286385">Close</span><span class="op" id="7286390">(</span><span class="op" id="7286391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7286395">return</span>&nbsp;<span class="ident" id="7286402">nil</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7286407">}</span><span class="op" id="7286408">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7286412">//&nbsp;Provide&nbsp;a&nbsp;way&nbsp;to&nbsp;force&nbsp;a&nbsp;re-prepare&nbsp;of&nbsp;a&nbsp;statement&nbsp;on&nbsp;next&nbsp;execution</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7286485">forcePrepare</span>&nbsp;<span class="op" id="7286498">:=</span>&nbsp;<span class="keyword" id="7286501">func</span><span class="op" id="7286505">(</span><span class="ident" id="7286506">stmt</span>&nbsp;<span class="op" id="7286511">*</span><span class="ident" id="7286512">Stmt</span><span class="op" id="7286516">)</span>&nbsp;<span class="op" id="7286518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7286522">stmt</span><span class="op" id="7286526">.</span><span class="ident" id="7286527">css</span>&nbsp;<span class="op" id="7286531">=</span>&nbsp;<span class="ident" id="7286533">nil</span><br>
<span class="lineno">1385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7286538">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7286542">//&nbsp;stmt.Exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7286556">stmt1</span><span class="op" id="7286561">,</span>&nbsp;<span class="ident" id="7286563">err</span>&nbsp;<span class="op" id="7286567">:=</span>&nbsp;<span class="ident" id="7286570">db</span><span class="op" id="7286572">.</span><span class="ident" id="7286573">Prepare</span><span class="op" id="7286580">(</span><span class="string" id="7286581">&#34;INSERT|t1|name=?,age=?,dead=?&#34;</span><span class="op" id="7286612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7286615">if</span>&nbsp;<span class="ident" id="7286618">err</span>&nbsp;<span class="op" id="7286622">!=</span>&nbsp;<span class="ident" id="7286625">nil</span>&nbsp;<span class="op" id="7286629">{</span><br>
<span class="lineno">1390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7286633">t</span><span class="op" id="7286634">.</span><span class="ident" id="7286635">Fatalf</span><span class="op" id="7286641">(</span><span class="string" id="7286642">&#34;prepare:&nbsp;%v&#34;</span><span class="op" id="7286655">,</span>&nbsp;<span class="ident" id="7286657">err</span><span class="op" id="7286660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7286663">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7286666">defer</span>&nbsp;<span class="ident" id="7286672">stmt1</span><span class="op" id="7286677">.</span><span class="ident" id="7286678">Close</span><span class="op" id="7286683">(</span><span class="op" id="7286684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7286687">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;must&nbsp;prepare&nbsp;the&nbsp;stmt&nbsp;first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7286732">forcePrepare</span><span class="op" id="7286744">(</span><span class="ident" id="7286745">stmt1</span><span class="op" id="7286750">)</span><br>
<span class="lineno">1395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7286754">stmtExec</span>&nbsp;<span class="op" id="7286763">:=</span>&nbsp;<span class="keyword" id="7286766">func</span><span class="op" id="7286770">(</span><span class="op" id="7286771">)</span>&nbsp;<span class="builtintype" id="7286773">error</span>&nbsp;<span class="op" id="7286779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7286783">_</span><span class="op" id="7286784">,</span>&nbsp;<span class="ident" id="7286786">err</span>&nbsp;<span class="op" id="7286790">:=</span>&nbsp;<span class="ident" id="7286793">stmt1</span><span class="op" id="7286798">.</span><span class="ident" id="7286799">Exec</span><span class="op" id="7286803">(</span><span class="string" id="7286804">&#34;Gopher&#34;</span><span class="op" id="7286812">,</span>&nbsp;<span class="num" id="7286814">3</span><span class="op" id="7286815">,</span>&nbsp;<span class="ident" id="7286817">false</span><span class="op" id="7286822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7286826">return</span>&nbsp;<span class="ident" id="7286833">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7286838">}</span><br>
<span class="lineno">1400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7286841">simulateBadConn</span><span class="op" id="7286856">(</span><span class="string" id="7286857">&#34;stmt.Exec&nbsp;prepare&#34;</span><span class="op" id="7286876">,</span>&nbsp;<span class="op" id="7286878">&amp;</span><span class="ident" id="7286879">hookPrepareBadConn</span><span class="op" id="7286897">,</span>&nbsp;<span class="ident" id="7286899">stmtExec</span><span class="op" id="7286907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7286910">simulateBadConn</span><span class="op" id="7286925">(</span><span class="string" id="7286926">&#34;stmt.Exec&nbsp;exec&#34;</span><span class="op" id="7286942">,</span>&nbsp;<span class="op" id="7286944">&amp;</span><span class="ident" id="7286945">hookExecBadConn</span><span class="op" id="7286960">,</span>&nbsp;<span class="ident" id="7286962">stmtExec</span><span class="op" id="7286970">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7286974">//&nbsp;stmt.Query</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7286989">stmt2</span><span class="op" id="7286994">,</span>&nbsp;<span class="ident" id="7286996">err</span>&nbsp;<span class="op" id="7287000">:=</span>&nbsp;<span class="ident" id="7287003">db</span><span class="op" id="7287005">.</span><span class="ident" id="7287006">Prepare</span><span class="op" id="7287013">(</span><span class="string" id="7287014">&#34;SELECT|t1|age,name|&#34;</span><span class="op" id="7287035">)</span><br>
<span class="lineno">1405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7287038">if</span>&nbsp;<span class="ident" id="7287041">err</span>&nbsp;<span class="op" id="7287045">!=</span>&nbsp;<span class="ident" id="7287048">nil</span>&nbsp;<span class="op" id="7287052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7287056">t</span><span class="op" id="7287057">.</span><span class="ident" id="7287058">Fatalf</span><span class="op" id="7287064">(</span><span class="string" id="7287065">&#34;prepare:&nbsp;%v&#34;</span><span class="op" id="7287078">,</span>&nbsp;<span class="ident" id="7287080">err</span><span class="op" id="7287083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7287086">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7287089">defer</span>&nbsp;<span class="ident" id="7287095">stmt2</span><span class="op" id="7287100">.</span><span class="ident" id="7287101">Close</span><span class="op" id="7287106">(</span><span class="op" id="7287107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7287110">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;must&nbsp;prepare&nbsp;the&nbsp;stmt&nbsp;first</span><br>
<span class="lineno">1410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7287155">forcePrepare</span><span class="op" id="7287167">(</span><span class="ident" id="7287168">stmt2</span><span class="op" id="7287173">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7287177">stmtQuery</span>&nbsp;<span class="op" id="7287187">:=</span>&nbsp;<span class="keyword" id="7287190">func</span><span class="op" id="7287194">(</span><span class="op" id="7287195">)</span>&nbsp;<span class="builtintype" id="7287197">error</span>&nbsp;<span class="op" id="7287203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7287207">rows</span><span class="op" id="7287211">,</span>&nbsp;<span class="ident" id="7287213">err</span>&nbsp;<span class="op" id="7287217">:=</span>&nbsp;<span class="ident" id="7287220">stmt2</span><span class="op" id="7287225">.</span><span class="ident" id="7287226">Query</span><span class="op" id="7287231">(</span><span class="op" id="7287232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7287236">if</span>&nbsp;<span class="ident" id="7287239">err</span>&nbsp;<span class="op" id="7287243">==</span>&nbsp;<span class="ident" id="7287246">nil</span>&nbsp;<span class="op" id="7287250">{</span><br>
<span class="lineno">1415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7287255">err</span>&nbsp;<span class="op" id="7287259">=</span>&nbsp;<span class="ident" id="7287261">rows</span><span class="op" id="7287265">.</span><span class="ident" id="7287266">Close</span><span class="op" id="7287271">(</span><span class="op" id="7287272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7287276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7287280">return</span>&nbsp;<span class="ident" id="7287287">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7287292">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7287295">simulateBadConn</span><span class="op" id="7287310">(</span><span class="string" id="7287311">&#34;stmt.Query&nbsp;prepare&#34;</span><span class="op" id="7287331">,</span>&nbsp;<span class="op" id="7287333">&amp;</span><span class="ident" id="7287334">hookPrepareBadConn</span><span class="op" id="7287352">,</span>&nbsp;<span class="ident" id="7287354">stmtQuery</span><span class="op" id="7287363">)</span><br>
<span class="lineno">1420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7287366">simulateBadConn</span><span class="op" id="7287381">(</span><span class="string" id="7287382">&#34;stmt.Query&nbsp;exec&#34;</span><span class="op" id="7287399">,</span>&nbsp;<span class="op" id="7287401">&amp;</span><span class="ident" id="7287402">hookQueryBadConn</span><span class="op" id="7287418">,</span>&nbsp;<span class="ident" id="7287420">stmtQuery</span><span class="op" id="7287429">)</span><br>
<span class="lineno"></span><span class="op" id="7287431">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7287434">type</span>&nbsp;<span class="ident" id="7287439">concurrentTest</span>&nbsp;<span class="keyword" id="7287454">interface</span>&nbsp;<span class="op" id="7287464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7287467">init</span><span class="op" id="7287471">(</span><span class="ident" id="7287472">t</span>&nbsp;<span class="ident" id="7287474">testing</span><span class="op" id="7287481">.</span><span class="ident" id="7287482">TB</span><span class="op" id="7287484">,</span>&nbsp;<span class="ident" id="7287486">db</span>&nbsp;<span class="op" id="7287489">*</span><span class="ident" id="7287490">DB</span><span class="op" id="7287492">)</span><br>
<span class="lineno">1425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7287495">finish</span><span class="op" id="7287501">(</span><span class="ident" id="7287502">t</span>&nbsp;<span class="ident" id="7287504">testing</span><span class="op" id="7287511">.</span><span class="ident" id="7287512">TB</span><span class="op" id="7287514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7287517">test</span><span class="op" id="7287521">(</span><span class="ident" id="7287522">t</span>&nbsp;<span class="ident" id="7287524">testing</span><span class="op" id="7287531">.</span><span class="ident" id="7287532">TB</span><span class="op" id="7287534">)</span>&nbsp;<span class="builtintype" id="7287536">error</span><br>
<span class="lineno"></span><span class="op" id="7287542">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7287545">type</span>&nbsp;<span class="ident" id="7287550">concurrentDBQueryTest</span>&nbsp;<span class="keyword" id="7287572">struct</span>&nbsp;<span class="op" id="7287579">{</span><br>
<span class="lineno">1430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7287582">db</span>&nbsp;<span class="op" id="7287585">*</span><span class="ident" id="7287586">DB</span><br>
<span class="lineno"></span><span class="op" id="7287589">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7287592">func</span>&nbsp;<span class="op" id="7287597">(</span><span class="ident" id="7287598">c</span>&nbsp;<span class="op" id="7287600">*</span><span class="ident" id="7287601">concurrentDBQueryTest</span><span class="op" id="7287622">)</span>&nbsp;<span class="ident" id="7287624">init</span><span class="op" id="7287628">(</span><span class="ident" id="7287629">t</span>&nbsp;<span class="ident" id="7287631">testing</span><span class="op" id="7287638">.</span><span class="ident" id="7287639">TB</span><span class="op" id="7287641">,</span>&nbsp;<span class="ident" id="7287643">db</span>&nbsp;<span class="op" id="7287646">*</span><span class="ident" id="7287647">DB</span><span class="op" id="7287649">)</span>&nbsp;<span class="op" id="7287651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7287654">c</span><span class="op" id="7287655">.</span><span class="ident" id="7287656">db</span>&nbsp;<span class="op" id="7287659">=</span>&nbsp;<span class="ident" id="7287661">db</span><br>
<span class="lineno">1435</span><span class="op" id="7287664">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7287667">func</span>&nbsp;<span class="op" id="7287672">(</span><span class="ident" id="7287673">c</span>&nbsp;<span class="op" id="7287675">*</span><span class="ident" id="7287676">concurrentDBQueryTest</span><span class="op" id="7287697">)</span>&nbsp;<span class="ident" id="7287699">finish</span><span class="op" id="7287705">(</span><span class="ident" id="7287706">t</span>&nbsp;<span class="ident" id="7287708">testing</span><span class="op" id="7287715">.</span><span class="ident" id="7287716">TB</span><span class="op" id="7287718">)</span>&nbsp;<span class="op" id="7287720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7287723">c</span><span class="op" id="7287724">.</span><span class="ident" id="7287725">db</span>&nbsp;<span class="op" id="7287728">=</span>&nbsp;<span class="ident" id="7287730">nil</span><br>
<span class="lineno"></span><span class="op" id="7287734">}</span><br>
<span class="lineno">1440</span><br>
<span class="lineno"></span><span class="keyword" id="7287737">func</span>&nbsp;<span class="op" id="7287742">(</span><span class="ident" id="7287743">c</span>&nbsp;<span class="op" id="7287745">*</span><span class="ident" id="7287746">concurrentDBQueryTest</span><span class="op" id="7287767">)</span>&nbsp;<span class="ident" id="7287769">test</span><span class="op" id="7287773">(</span><span class="ident" id="7287774">t</span>&nbsp;<span class="ident" id="7287776">testing</span><span class="op" id="7287783">.</span><span class="ident" id="7287784">TB</span><span class="op" id="7287786">)</span>&nbsp;<span class="builtintype" id="7287788">error</span>&nbsp;<span class="op" id="7287794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7287797">rows</span><span class="op" id="7287801">,</span>&nbsp;<span class="ident" id="7287803">err</span>&nbsp;<span class="op" id="7287807">:=</span>&nbsp;<span class="ident" id="7287810">c</span><span class="op" id="7287811">.</span><span class="ident" id="7287812">db</span><span class="op" id="7287814">.</span><span class="ident" id="7287815">Query</span><span class="op" id="7287820">(</span><span class="string" id="7287821">&#34;SELECT|people|name|&#34;</span><span class="op" id="7287842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7287845">if</span>&nbsp;<span class="ident" id="7287848">err</span>&nbsp;<span class="op" id="7287852">!=</span>&nbsp;<span class="ident" id="7287855">nil</span>&nbsp;<span class="op" id="7287859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7287863">t</span><span class="op" id="7287864">.</span><span class="ident" id="7287865">Error</span><span class="op" id="7287870">(</span><span class="ident" id="7287871">err</span><span class="op" id="7287874">)</span><br>
<span class="lineno">1445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7287878">return</span>&nbsp;<span class="ident" id="7287885">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7287890">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7287893">var</span>&nbsp;<span class="ident" id="7287897">name</span>&nbsp;<span class="builtintype" id="7287902">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7287910">for</span>&nbsp;<span class="ident" id="7287914">rows</span><span class="op" id="7287918">.</span><span class="ident" id="7287919">Next</span><span class="op" id="7287923">(</span><span class="op" id="7287924">)</span>&nbsp;<span class="op" id="7287926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7287930">rows</span><span class="op" id="7287934">.</span><span class="ident" id="7287935">Scan</span><span class="op" id="7287939">(</span><span class="op" id="7287940">&amp;</span><span class="ident" id="7287941">name</span><span class="op" id="7287945">)</span><br>
<span class="lineno">1450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7287948">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7287951">rows</span><span class="op" id="7287955">.</span><span class="ident" id="7287956">Close</span><span class="op" id="7287961">(</span><span class="op" id="7287962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7287965">return</span>&nbsp;<span class="ident" id="7287972">nil</span><br>
<span class="lineno"></span><span class="op" id="7287976">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1455</span><span class="keyword" id="7287979">type</span>&nbsp;<span class="ident" id="7287984">concurrentDBExecTest</span>&nbsp;<span class="keyword" id="7288005">struct</span>&nbsp;<span class="op" id="7288012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7288015">db</span>&nbsp;<span class="op" id="7288018">*</span><span class="ident" id="7288019">DB</span><br>
<span class="lineno"></span><span class="op" id="7288022">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7288025">func</span>&nbsp;<span class="op" id="7288030">(</span><span class="ident" id="7288031">c</span>&nbsp;<span class="op" id="7288033">*</span><span class="ident" id="7288034">concurrentDBExecTest</span><span class="op" id="7288054">)</span>&nbsp;<span class="ident" id="7288056">init</span><span class="op" id="7288060">(</span><span class="ident" id="7288061">t</span>&nbsp;<span class="ident" id="7288063">testing</span><span class="op" id="7288070">.</span><span class="ident" id="7288071">TB</span><span class="op" id="7288073">,</span>&nbsp;<span class="ident" id="7288075">db</span>&nbsp;<span class="op" id="7288078">*</span><span class="ident" id="7288079">DB</span><span class="op" id="7288081">)</span>&nbsp;<span class="op" id="7288083">{</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7288086">c</span><span class="op" id="7288087">.</span><span class="ident" id="7288088">db</span>&nbsp;<span class="op" id="7288091">=</span>&nbsp;<span class="ident" id="7288093">db</span><br>
<span class="lineno"></span><span class="op" id="7288096">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7288099">func</span>&nbsp;<span class="op" id="7288104">(</span><span class="ident" id="7288105">c</span>&nbsp;<span class="op" id="7288107">*</span><span class="ident" id="7288108">concurrentDBExecTest</span><span class="op" id="7288128">)</span>&nbsp;<span class="ident" id="7288130">finish</span><span class="op" id="7288136">(</span><span class="ident" id="7288137">t</span>&nbsp;<span class="ident" id="7288139">testing</span><span class="op" id="7288146">.</span><span class="ident" id="7288147">TB</span><span class="op" id="7288149">)</span>&nbsp;<span class="op" id="7288151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7288154">c</span><span class="op" id="7288155">.</span><span class="ident" id="7288156">db</span>&nbsp;<span class="op" id="7288159">=</span>&nbsp;<span class="ident" id="7288161">nil</span><br>
<span class="lineno">1465</span><span class="op" id="7288165">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7288168">func</span>&nbsp;<span class="op" id="7288173">(</span><span class="ident" id="7288174">c</span>&nbsp;<span class="op" id="7288176">*</span><span class="ident" id="7288177">concurrentDBExecTest</span><span class="op" id="7288197">)</span>&nbsp;<span class="ident" id="7288199">test</span><span class="op" id="7288203">(</span><span class="ident" id="7288204">t</span>&nbsp;<span class="ident" id="7288206">testing</span><span class="op" id="7288213">.</span><span class="ident" id="7288214">TB</span><span class="op" id="7288216">)</span>&nbsp;<span class="builtintype" id="7288218">error</span>&nbsp;<span class="op" id="7288224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7288227">_</span><span class="op" id="7288228">,</span>&nbsp;<span class="ident" id="7288230">err</span>&nbsp;<span class="op" id="7288234">:=</span>&nbsp;<span class="ident" id="7288237">c</span><span class="op" id="7288238">.</span><span class="ident" id="7288239">db</span><span class="op" id="7288241">.</span><span class="ident" id="7288242">Exec</span><span class="op" id="7288246">(</span><span class="string" id="7288247">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="7288300">,</span>&nbsp;<span class="num" id="7288302">3</span><span class="op" id="7288303">,</span>&nbsp;<span class="ident" id="7288305">chrisBirthday</span><span class="op" id="7288318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7288321">if</span>&nbsp;<span class="ident" id="7288324">err</span>&nbsp;<span class="op" id="7288328">!=</span>&nbsp;<span class="ident" id="7288331">nil</span>&nbsp;<span class="op" id="7288335">{</span><br>
<span class="lineno">1470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7288339">t</span><span class="op" id="7288340">.</span><span class="ident" id="7288341">Error</span><span class="op" id="7288346">(</span><span class="ident" id="7288347">err</span><span class="op" id="7288350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7288354">return</span>&nbsp;<span class="ident" id="7288361">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7288366">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7288369">return</span>&nbsp;<span class="ident" id="7288376">nil</span><br>
<span class="lineno"></span><span class="op" id="7288380">}</span><br>
<span class="lineno">1475</span><br>
<span class="lineno"></span><span class="keyword" id="7288383">type</span>&nbsp;<span class="ident" id="7288388">concurrentStmtQueryTest</span>&nbsp;<span class="keyword" id="7288412">struct</span>&nbsp;<span class="op" id="7288419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7288422">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7288427">*</span><span class="ident" id="7288428">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7288432">stmt</span>&nbsp;<span class="op" id="7288437">*</span><span class="ident" id="7288438">Stmt</span><br>
<span class="lineno"></span><span class="op" id="7288443">}</span><br>
<span class="lineno">1480</span><br>
<span class="lineno"></span><span class="keyword" id="7288446">func</span>&nbsp;<span class="op" id="7288451">(</span><span class="ident" id="7288452">c</span>&nbsp;<span class="op" id="7288454">*</span><span class="ident" id="7288455">concurrentStmtQueryTest</span><span class="op" id="7288478">)</span>&nbsp;<span class="ident" id="7288480">init</span><span class="op" id="7288484">(</span><span class="ident" id="7288485">t</span>&nbsp;<span class="ident" id="7288487">testing</span><span class="op" id="7288494">.</span><span class="ident" id="7288495">TB</span><span class="op" id="7288497">,</span>&nbsp;<span class="ident" id="7288499">db</span>&nbsp;<span class="op" id="7288502">*</span><span class="ident" id="7288503">DB</span><span class="op" id="7288505">)</span>&nbsp;<span class="op" id="7288507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7288510">c</span><span class="op" id="7288511">.</span><span class="ident" id="7288512">db</span>&nbsp;<span class="op" id="7288515">=</span>&nbsp;<span class="ident" id="7288517">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7288521">var</span>&nbsp;<span class="ident" id="7288525">err</span>&nbsp;<span class="builtintype" id="7288529">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7288536">c</span><span class="op" id="7288537">.</span><span class="ident" id="7288538">stmt</span><span class="op" id="7288542">,</span>&nbsp;<span class="ident" id="7288544">err</span>&nbsp;<span class="op" id="7288548">=</span>&nbsp;<span class="ident" id="7288550">db</span><span class="op" id="7288552">.</span><span class="ident" id="7288553">Prepare</span><span class="op" id="7288560">(</span><span class="string" id="7288561">&#34;SELECT|people|name|&#34;</span><span class="op" id="7288582">)</span><br>
<span class="lineno">1485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7288585">if</span>&nbsp;<span class="ident" id="7288588">err</span>&nbsp;<span class="op" id="7288592">!=</span>&nbsp;<span class="ident" id="7288595">nil</span>&nbsp;<span class="op" id="7288599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7288603">t</span><span class="op" id="7288604">.</span><span class="ident" id="7288605">Fatal</span><span class="op" id="7288610">(</span><span class="ident" id="7288611">err</span><span class="op" id="7288614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7288617">}</span><br>
<span class="lineno"></span><span class="op" id="7288619">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1490</span><span class="keyword" id="7288622">func</span>&nbsp;<span class="op" id="7288627">(</span><span class="ident" id="7288628">c</span>&nbsp;<span class="op" id="7288630">*</span><span class="ident" id="7288631">concurrentStmtQueryTest</span><span class="op" id="7288654">)</span>&nbsp;<span class="ident" id="7288656">finish</span><span class="op" id="7288662">(</span><span class="ident" id="7288663">t</span>&nbsp;<span class="ident" id="7288665">testing</span><span class="op" id="7288672">.</span><span class="ident" id="7288673">TB</span><span class="op" id="7288675">)</span>&nbsp;<span class="op" id="7288677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7288680">if</span>&nbsp;<span class="ident" id="7288683">c</span><span class="op" id="7288684">.</span><span class="ident" id="7288685">stmt</span>&nbsp;<span class="op" id="7288690">!=</span>&nbsp;<span class="ident" id="7288693">nil</span>&nbsp;<span class="op" id="7288697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7288701">c</span><span class="op" id="7288702">.</span><span class="ident" id="7288703">stmt</span><span class="op" id="7288707">.</span><span class="ident" id="7288708">Close</span><span class="op" id="7288713">(</span><span class="op" id="7288714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7288718">c</span><span class="op" id="7288719">.</span><span class="ident" id="7288720">stmt</span>&nbsp;<span class="op" id="7288725">=</span>&nbsp;<span class="ident" id="7288727">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7288732">}</span><br>
<span class="lineno">1495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7288735">c</span><span class="op" id="7288736">.</span><span class="ident" id="7288737">db</span>&nbsp;<span class="op" id="7288740">=</span>&nbsp;<span class="ident" id="7288742">nil</span><br>
<span class="lineno"></span><span class="op" id="7288746">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7288749">func</span>&nbsp;<span class="op" id="7288754">(</span><span class="ident" id="7288755">c</span>&nbsp;<span class="op" id="7288757">*</span><span class="ident" id="7288758">concurrentStmtQueryTest</span><span class="op" id="7288781">)</span>&nbsp;<span class="ident" id="7288783">test</span><span class="op" id="7288787">(</span><span class="ident" id="7288788">t</span>&nbsp;<span class="ident" id="7288790">testing</span><span class="op" id="7288797">.</span><span class="ident" id="7288798">TB</span><span class="op" id="7288800">)</span>&nbsp;<span class="builtintype" id="7288802">error</span>&nbsp;<span class="op" id="7288808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7288811">rows</span><span class="op" id="7288815">,</span>&nbsp;<span class="ident" id="7288817">err</span>&nbsp;<span class="op" id="7288821">:=</span>&nbsp;<span class="ident" id="7288824">c</span><span class="op" id="7288825">.</span><span class="ident" id="7288826">stmt</span><span class="op" id="7288830">.</span><span class="ident" id="7288831">Query</span><span class="op" id="7288836">(</span><span class="op" id="7288837">)</span><br>
<span class="lineno">1500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7288840">if</span>&nbsp;<span class="ident" id="7288843">err</span>&nbsp;<span class="op" id="7288847">!=</span>&nbsp;<span class="ident" id="7288850">nil</span>&nbsp;<span class="op" id="7288854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7288858">t</span><span class="op" id="7288859">.</span><span class="ident" id="7288860">Errorf</span><span class="op" id="7288866">(</span><span class="string" id="7288867">&#34;error&nbsp;on&nbsp;query:&nbsp;&nbsp;%v&#34;</span><span class="op" id="7288888">,</span>&nbsp;<span class="ident" id="7288890">err</span><span class="op" id="7288893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7288897">return</span>&nbsp;<span class="ident" id="7288904">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7288909">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7288913">var</span>&nbsp;<span class="ident" id="7288917">name</span>&nbsp;<span class="builtintype" id="7288922">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7288930">for</span>&nbsp;<span class="ident" id="7288934">rows</span><span class="op" id="7288938">.</span><span class="ident" id="7288939">Next</span><span class="op" id="7288943">(</span><span class="op" id="7288944">)</span>&nbsp;<span class="op" id="7288946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7288950">rows</span><span class="op" id="7288954">.</span><span class="ident" id="7288955">Scan</span><span class="op" id="7288959">(</span><span class="op" id="7288960">&amp;</span><span class="ident" id="7288961">name</span><span class="op" id="7288965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7288968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7288971">rows</span><span class="op" id="7288975">.</span><span class="ident" id="7288976">Close</span><span class="op" id="7288981">(</span><span class="op" id="7288982">)</span><br>
<span class="lineno">1510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7288985">return</span>&nbsp;<span class="ident" id="7288992">nil</span><br>
<span class="lineno"></span><span class="op" id="7288996">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7288999">type</span>&nbsp;<span class="ident" id="7289004">concurrentStmtExecTest</span>&nbsp;<span class="keyword" id="7289027">struct</span>&nbsp;<span class="op" id="7289034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7289037">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7289042">*</span><span class="ident" id="7289043">DB</span><br>
<span class="lineno">1515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7289047">stmt</span>&nbsp;<span class="op" id="7289052">*</span><span class="ident" id="7289053">Stmt</span><br>
<span class="lineno"></span><span class="op" id="7289058">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7289061">func</span>&nbsp;<span class="op" id="7289066">(</span><span class="ident" id="7289067">c</span>&nbsp;<span class="op" id="7289069">*</span><span class="ident" id="7289070">concurrentStmtExecTest</span><span class="op" id="7289092">)</span>&nbsp;<span class="ident" id="7289094">init</span><span class="op" id="7289098">(</span><span class="ident" id="7289099">t</span>&nbsp;<span class="ident" id="7289101">testing</span><span class="op" id="7289108">.</span><span class="ident" id="7289109">TB</span><span class="op" id="7289111">,</span>&nbsp;<span class="ident" id="7289113">db</span>&nbsp;<span class="op" id="7289116">*</span><span class="ident" id="7289117">DB</span><span class="op" id="7289119">)</span>&nbsp;<span class="op" id="7289121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7289124">c</span><span class="op" id="7289125">.</span><span class="ident" id="7289126">db</span>&nbsp;<span class="op" id="7289129">=</span>&nbsp;<span class="ident" id="7289131">db</span><br>
<span class="lineno">1520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7289135">var</span>&nbsp;<span class="ident" id="7289139">err</span>&nbsp;<span class="builtintype" id="7289143">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7289150">c</span><span class="op" id="7289151">.</span><span class="ident" id="7289152">stmt</span><span class="op" id="7289156">,</span>&nbsp;<span class="ident" id="7289158">err</span>&nbsp;<span class="op" id="7289162">=</span>&nbsp;<span class="ident" id="7289164">db</span><span class="op" id="7289166">.</span><span class="ident" id="7289167">Prepare</span><span class="op" id="7289174">(</span><span class="string" id="7289175">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="7289228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7289231">if</span>&nbsp;<span class="ident" id="7289234">err</span>&nbsp;<span class="op" id="7289238">!=</span>&nbsp;<span class="ident" id="7289241">nil</span>&nbsp;<span class="op" id="7289245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7289249">t</span><span class="op" id="7289250">.</span><span class="ident" id="7289251">Fatal</span><span class="op" id="7289256">(</span><span class="ident" id="7289257">err</span><span class="op" id="7289260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7289263">}</span><br>
<span class="lineno">1525</span><span class="op" id="7289265">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7289268">func</span>&nbsp;<span class="op" id="7289273">(</span><span class="ident" id="7289274">c</span>&nbsp;<span class="op" id="7289276">*</span><span class="ident" id="7289277">concurrentStmtExecTest</span><span class="op" id="7289299">)</span>&nbsp;<span class="ident" id="7289301">finish</span><span class="op" id="7289307">(</span><span class="ident" id="7289308">t</span>&nbsp;<span class="ident" id="7289310">testing</span><span class="op" id="7289317">.</span><span class="ident" id="7289318">TB</span><span class="op" id="7289320">)</span>&nbsp;<span class="op" id="7289322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7289325">if</span>&nbsp;<span class="ident" id="7289328">c</span><span class="op" id="7289329">.</span><span class="ident" id="7289330">stmt</span>&nbsp;<span class="op" id="7289335">!=</span>&nbsp;<span class="ident" id="7289338">nil</span>&nbsp;<span class="op" id="7289342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7289346">c</span><span class="op" id="7289347">.</span><span class="ident" id="7289348">stmt</span><span class="op" id="7289352">.</span><span class="ident" id="7289353">Close</span><span class="op" id="7289358">(</span><span class="op" id="7289359">)</span><br>
<span class="lineno">1530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7289363">c</span><span class="op" id="7289364">.</span><span class="ident" id="7289365">stmt</span>&nbsp;<span class="op" id="7289370">=</span>&nbsp;<span class="ident" id="7289372">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7289377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7289380">c</span><span class="op" id="7289381">.</span><span class="ident" id="7289382">db</span>&nbsp;<span class="op" id="7289385">=</span>&nbsp;<span class="ident" id="7289387">nil</span><br>
<span class="lineno"></span><span class="op" id="7289391">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1535</span><span class="keyword" id="7289394">func</span>&nbsp;<span class="op" id="7289399">(</span><span class="ident" id="7289400">c</span>&nbsp;<span class="op" id="7289402">*</span><span class="ident" id="7289403">concurrentStmtExecTest</span><span class="op" id="7289425">)</span>&nbsp;<span class="ident" id="7289427">test</span><span class="op" id="7289431">(</span><span class="ident" id="7289432">t</span>&nbsp;<span class="ident" id="7289434">testing</span><span class="op" id="7289441">.</span><span class="ident" id="7289442">TB</span><span class="op" id="7289444">)</span>&nbsp;<span class="builtintype" id="7289446">error</span>&nbsp;<span class="op" id="7289452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7289455">_</span><span class="op" id="7289456">,</span>&nbsp;<span class="ident" id="7289458">err</span>&nbsp;<span class="op" id="7289462">:=</span>&nbsp;<span class="ident" id="7289465">c</span><span class="op" id="7289466">.</span><span class="ident" id="7289467">stmt</span><span class="op" id="7289471">.</span><span class="ident" id="7289472">Exec</span><span class="op" id="7289476">(</span><span class="num" id="7289477">3</span><span class="op" id="7289478">,</span>&nbsp;<span class="ident" id="7289480">chrisBirthday</span><span class="op" id="7289493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7289496">if</span>&nbsp;<span class="ident" id="7289499">err</span>&nbsp;<span class="op" id="7289503">!=</span>&nbsp;<span class="ident" id="7289506">nil</span>&nbsp;<span class="op" id="7289510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7289514">t</span><span class="op" id="7289515">.</span><span class="ident" id="7289516">Errorf</span><span class="op" id="7289522">(</span><span class="string" id="7289523">&#34;error&nbsp;on&nbsp;exec:&nbsp;&nbsp;%v&#34;</span><span class="op" id="7289543">,</span>&nbsp;<span class="ident" id="7289545">err</span><span class="op" id="7289548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7289552">return</span>&nbsp;<span class="ident" id="7289559">err</span><br>
<span class="lineno">1540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7289564">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7289567">return</span>&nbsp;<span class="ident" id="7289574">nil</span><br>
<span class="lineno"></span><span class="op" id="7289578">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7289581">type</span>&nbsp;<span class="ident" id="7289586">concurrentTxQueryTest</span>&nbsp;<span class="keyword" id="7289608">struct</span>&nbsp;<span class="op" id="7289615">{</span><br>
<span class="lineno">1545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7289618">db</span>&nbsp;<span class="op" id="7289621">*</span><span class="ident" id="7289622">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7289626">tx</span>&nbsp;<span class="op" id="7289629">*</span><span class="ident" id="7289630">Tx</span><br>
<span class="lineno"></span><span class="op" id="7289633">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7289636">func</span>&nbsp;<span class="op" id="7289641">(</span><span class="ident" id="7289642">c</span>&nbsp;<span class="op" id="7289644">*</span><span class="ident" id="7289645">concurrentTxQueryTest</span><span class="op" id="7289666">)</span>&nbsp;<span class="ident" id="7289668">init</span><span class="op" id="7289672">(</span><span class="ident" id="7289673">t</span>&nbsp;<span class="ident" id="7289675">testing</span><span class="op" id="7289682">.</span><span class="ident" id="7289683">TB</span><span class="op" id="7289685">,</span>&nbsp;<span class="ident" id="7289687">db</span>&nbsp;<span class="op" id="7289690">*</span><span class="ident" id="7289691">DB</span><span class="op" id="7289693">)</span>&nbsp;<span class="op" id="7289695">{</span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7289698">c</span><span class="op" id="7289699">.</span><span class="ident" id="7289700">db</span>&nbsp;<span class="op" id="7289703">=</span>&nbsp;<span class="ident" id="7289705">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7289709">var</span>&nbsp;<span class="ident" id="7289713">err</span>&nbsp;<span class="builtintype" id="7289717">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7289724">c</span><span class="op" id="7289725">.</span><span class="ident" id="7289726">tx</span><span class="op" id="7289728">,</span>&nbsp;<span class="ident" id="7289730">err</span>&nbsp;<span class="op" id="7289734">=</span>&nbsp;<span class="ident" id="7289736">c</span><span class="op" id="7289737">.</span><span class="ident" id="7289738">db</span><span class="op" id="7289740">.</span><span class="ident" id="7289741">Begin</span><span class="op" id="7289746">(</span><span class="op" id="7289747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7289750">if</span>&nbsp;<span class="ident" id="7289753">err</span>&nbsp;<span class="op" id="7289757">!=</span>&nbsp;<span class="ident" id="7289760">nil</span>&nbsp;<span class="op" id="7289764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7289768">t</span><span class="op" id="7289769">.</span><span class="ident" id="7289770">Fatal</span><span class="op" id="7289775">(</span><span class="ident" id="7289776">err</span><span class="op" id="7289779">)</span><br>
<span class="lineno">1555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7289782">}</span><br>
<span class="lineno"></span><span class="op" id="7289784">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7289787">func</span>&nbsp;<span class="op" id="7289792">(</span><span class="ident" id="7289793">c</span>&nbsp;<span class="op" id="7289795">*</span><span class="ident" id="7289796">concurrentTxQueryTest</span><span class="op" id="7289817">)</span>&nbsp;<span class="ident" id="7289819">finish</span><span class="op" id="7289825">(</span><span class="ident" id="7289826">t</span>&nbsp;<span class="ident" id="7289828">testing</span><span class="op" id="7289835">.</span><span class="ident" id="7289836">TB</span><span class="op" id="7289838">)</span>&nbsp;<span class="op" id="7289840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7289843">if</span>&nbsp;<span class="ident" id="7289846">c</span><span class="op" id="7289847">.</span><span class="ident" id="7289848">tx</span>&nbsp;<span class="op" id="7289851">!=</span>&nbsp;<span class="ident" id="7289854">nil</span>&nbsp;<span class="op" id="7289858">{</span><br>
<span class="lineno">1560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7289862">c</span><span class="op" id="7289863">.</span><span class="ident" id="7289864">tx</span><span class="op" id="7289866">.</span><span class="ident" id="7289867">Rollback</span><span class="op" id="7289875">(</span><span class="op" id="7289876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7289880">c</span><span class="op" id="7289881">.</span><span class="ident" id="7289882">tx</span>&nbsp;<span class="op" id="7289885">=</span>&nbsp;<span class="ident" id="7289887">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7289892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7289895">c</span><span class="op" id="7289896">.</span><span class="ident" id="7289897">db</span>&nbsp;<span class="op" id="7289900">=</span>&nbsp;<span class="ident" id="7289902">nil</span><br>
<span class="lineno"></span><span class="op" id="7289906">}</span><br>
<span class="lineno">1565</span><br>
<span class="lineno"></span><span class="keyword" id="7289909">func</span>&nbsp;<span class="op" id="7289914">(</span><span class="ident" id="7289915">c</span>&nbsp;<span class="op" id="7289917">*</span><span class="ident" id="7289918">concurrentTxQueryTest</span><span class="op" id="7289939">)</span>&nbsp;<span class="ident" id="7289941">test</span><span class="op" id="7289945">(</span><span class="ident" id="7289946">t</span>&nbsp;<span class="ident" id="7289948">testing</span><span class="op" id="7289955">.</span><span class="ident" id="7289956">TB</span><span class="op" id="7289958">)</span>&nbsp;<span class="builtintype" id="7289960">error</span>&nbsp;<span class="op" id="7289966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7289969">rows</span><span class="op" id="7289973">,</span>&nbsp;<span class="ident" id="7289975">err</span>&nbsp;<span class="op" id="7289979">:=</span>&nbsp;<span class="ident" id="7289982">c</span><span class="op" id="7289983">.</span><span class="ident" id="7289984">db</span><span class="op" id="7289986">.</span><span class="ident" id="7289987">Query</span><span class="op" id="7289992">(</span><span class="string" id="7289993">&#34;SELECT|people|name|&#34;</span><span class="op" id="7290014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7290017">if</span>&nbsp;<span class="ident" id="7290020">err</span>&nbsp;<span class="op" id="7290024">!=</span>&nbsp;<span class="ident" id="7290027">nil</span>&nbsp;<span class="op" id="7290031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7290035">t</span><span class="op" id="7290036">.</span><span class="ident" id="7290037">Error</span><span class="op" id="7290042">(</span><span class="ident" id="7290043">err</span><span class="op" id="7290046">)</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7290050">return</span>&nbsp;<span class="ident" id="7290057">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7290062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7290065">var</span>&nbsp;<span class="ident" id="7290069">name</span>&nbsp;<span class="builtintype" id="7290074">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7290082">for</span>&nbsp;<span class="ident" id="7290086">rows</span><span class="op" id="7290090">.</span><span class="ident" id="7290091">Next</span><span class="op" id="7290095">(</span><span class="op" id="7290096">)</span>&nbsp;<span class="op" id="7290098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7290102">rows</span><span class="op" id="7290106">.</span><span class="ident" id="7290107">Scan</span><span class="op" id="7290111">(</span><span class="op" id="7290112">&amp;</span><span class="ident" id="7290113">name</span><span class="op" id="7290117">)</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7290120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7290123">rows</span><span class="op" id="7290127">.</span><span class="ident" id="7290128">Close</span><span class="op" id="7290133">(</span><span class="op" id="7290134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7290137">return</span>&nbsp;<span class="ident" id="7290144">nil</span><br>
<span class="lineno"></span><span class="op" id="7290148">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1580</span><span class="keyword" id="7290151">type</span>&nbsp;<span class="ident" id="7290156">concurrentTxExecTest</span>&nbsp;<span class="keyword" id="7290177">struct</span>&nbsp;<span class="op" id="7290184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7290187">db</span>&nbsp;<span class="op" id="7290190">*</span><span class="ident" id="7290191">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7290195">tx</span>&nbsp;<span class="op" id="7290198">*</span><span class="ident" id="7290199">Tx</span><br>
<span class="lineno"></span><span class="op" id="7290202">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1585</span><span class="keyword" id="7290205">func</span>&nbsp;<span class="op" id="7290210">(</span><span class="ident" id="7290211">c</span>&nbsp;<span class="op" id="7290213">*</span><span class="ident" id="7290214">concurrentTxExecTest</span><span class="op" id="7290234">)</span>&nbsp;<span class="ident" id="7290236">init</span><span class="op" id="7290240">(</span><span class="ident" id="7290241">t</span>&nbsp;<span class="ident" id="7290243">testing</span><span class="op" id="7290250">.</span><span class="ident" id="7290251">TB</span><span class="op" id="7290253">,</span>&nbsp;<span class="ident" id="7290255">db</span>&nbsp;<span class="op" id="7290258">*</span><span class="ident" id="7290259">DB</span><span class="op" id="7290261">)</span>&nbsp;<span class="op" id="7290263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7290266">c</span><span class="op" id="7290267">.</span><span class="ident" id="7290268">db</span>&nbsp;<span class="op" id="7290271">=</span>&nbsp;<span class="ident" id="7290273">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7290277">var</span>&nbsp;<span class="ident" id="7290281">err</span>&nbsp;<span class="builtintype" id="7290285">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7290292">c</span><span class="op" id="7290293">.</span><span class="ident" id="7290294">tx</span><span class="op" id="7290296">,</span>&nbsp;<span class="ident" id="7290298">err</span>&nbsp;<span class="op" id="7290302">=</span>&nbsp;<span class="ident" id="7290304">c</span><span class="op" id="7290305">.</span><span class="ident" id="7290306">db</span><span class="op" id="7290308">.</span><span class="ident" id="7290309">Begin</span><span class="op" id="7290314">(</span><span class="op" id="7290315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7290318">if</span>&nbsp;<span class="ident" id="7290321">err</span>&nbsp;<span class="op" id="7290325">!=</span>&nbsp;<span class="ident" id="7290328">nil</span>&nbsp;<span class="op" id="7290332">{</span><br>
<span class="lineno">1590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7290336">t</span><span class="op" id="7290337">.</span><span class="ident" id="7290338">Fatal</span><span class="op" id="7290343">(</span><span class="ident" id="7290344">err</span><span class="op" id="7290347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7290350">}</span><br>
<span class="lineno"></span><span class="op" id="7290352">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7290355">func</span>&nbsp;<span class="op" id="7290360">(</span><span class="ident" id="7290361">c</span>&nbsp;<span class="op" id="7290363">*</span><span class="ident" id="7290364">concurrentTxExecTest</span><span class="op" id="7290384">)</span>&nbsp;<span class="ident" id="7290386">finish</span><span class="op" id="7290392">(</span><span class="ident" id="7290393">t</span>&nbsp;<span class="ident" id="7290395">testing</span><span class="op" id="7290402">.</span><span class="ident" id="7290403">TB</span><span class="op" id="7290405">)</span>&nbsp;<span class="op" id="7290407">{</span><br>
<span class="lineno">1595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7290410">if</span>&nbsp;<span class="ident" id="7290413">c</span><span class="op" id="7290414">.</span><span class="ident" id="7290415">tx</span>&nbsp;<span class="op" id="7290418">!=</span>&nbsp;<span class="ident" id="7290421">nil</span>&nbsp;<span class="op" id="7290425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7290429">c</span><span class="op" id="7290430">.</span><span class="ident" id="7290431">tx</span><span class="op" id="7290433">.</span><span class="ident" id="7290434">Rollback</span><span class="op" id="7290442">(</span><span class="op" id="7290443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7290447">c</span><span class="op" id="7290448">.</span><span class="ident" id="7290449">tx</span>&nbsp;<span class="op" id="7290452">=</span>&nbsp;<span class="ident" id="7290454">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7290459">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7290462">c</span><span class="op" id="7290463">.</span><span class="ident" id="7290464">db</span>&nbsp;<span class="op" id="7290467">=</span>&nbsp;<span class="ident" id="7290469">nil</span><br>
<span class="lineno">1600</span><span class="op" id="7290473">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7290476">func</span>&nbsp;<span class="op" id="7290481">(</span><span class="ident" id="7290482">c</span>&nbsp;<span class="op" id="7290484">*</span><span class="ident" id="7290485">concurrentTxExecTest</span><span class="op" id="7290505">)</span>&nbsp;<span class="ident" id="7290507">test</span><span class="op" id="7290511">(</span><span class="ident" id="7290512">t</span>&nbsp;<span class="ident" id="7290514">testing</span><span class="op" id="7290521">.</span><span class="ident" id="7290522">TB</span><span class="op" id="7290524">)</span>&nbsp;<span class="builtintype" id="7290526">error</span>&nbsp;<span class="op" id="7290532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7290535">_</span><span class="op" id="7290536">,</span>&nbsp;<span class="ident" id="7290538">err</span>&nbsp;<span class="op" id="7290542">:=</span>&nbsp;<span class="ident" id="7290545">c</span><span class="op" id="7290546">.</span><span class="ident" id="7290547">tx</span><span class="op" id="7290549">.</span><span class="ident" id="7290550">Exec</span><span class="op" id="7290554">(</span><span class="string" id="7290555">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="7290608">,</span>&nbsp;<span class="num" id="7290610">3</span><span class="op" id="7290611">,</span>&nbsp;<span class="ident" id="7290613">chrisBirthday</span><span class="op" id="7290626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7290629">if</span>&nbsp;<span class="ident" id="7290632">err</span>&nbsp;<span class="op" id="7290636">!=</span>&nbsp;<span class="ident" id="7290639">nil</span>&nbsp;<span class="op" id="7290643">{</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7290647">t</span><span class="op" id="7290648">.</span><span class="ident" id="7290649">Error</span><span class="op" id="7290654">(</span><span class="ident" id="7290655">err</span><span class="op" id="7290658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7290662">return</span>&nbsp;<span class="ident" id="7290669">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7290674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7290677">return</span>&nbsp;<span class="ident" id="7290684">nil</span><br>
<span class="lineno"></span><span class="op" id="7290688">}</span><br>
<span class="lineno">1610</span><br>
<span class="lineno"></span><span class="keyword" id="7290691">type</span>&nbsp;<span class="ident" id="7290696">concurrentTxStmtQueryTest</span>&nbsp;<span class="keyword" id="7290722">struct</span>&nbsp;<span class="op" id="7290729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7290732">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7290737">*</span><span class="ident" id="7290738">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7290742">tx</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7290747">*</span><span class="ident" id="7290748">Tx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7290752">stmt</span>&nbsp;<span class="op" id="7290757">*</span><span class="ident" id="7290758">Stmt</span><br>
<span class="lineno">1615</span><span class="op" id="7290763">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7290766">func</span>&nbsp;<span class="op" id="7290771">(</span><span class="ident" id="7290772">c</span>&nbsp;<span class="op" id="7290774">*</span><span class="ident" id="7290775">concurrentTxStmtQueryTest</span><span class="op" id="7290800">)</span>&nbsp;<span class="ident" id="7290802">init</span><span class="op" id="7290806">(</span><span class="ident" id="7290807">t</span>&nbsp;<span class="ident" id="7290809">testing</span><span class="op" id="7290816">.</span><span class="ident" id="7290817">TB</span><span class="op" id="7290819">,</span>&nbsp;<span class="ident" id="7290821">db</span>&nbsp;<span class="op" id="7290824">*</span><span class="ident" id="7290825">DB</span><span class="op" id="7290827">)</span>&nbsp;<span class="op" id="7290829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7290832">c</span><span class="op" id="7290833">.</span><span class="ident" id="7290834">db</span>&nbsp;<span class="op" id="7290837">=</span>&nbsp;<span class="ident" id="7290839">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7290843">var</span>&nbsp;<span class="ident" id="7290847">err</span>&nbsp;<span class="builtintype" id="7290851">error</span><br>
<span class="lineno">1620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7290858">c</span><span class="op" id="7290859">.</span><span class="ident" id="7290860">tx</span><span class="op" id="7290862">,</span>&nbsp;<span class="ident" id="7290864">err</span>&nbsp;<span class="op" id="7290868">=</span>&nbsp;<span class="ident" id="7290870">c</span><span class="op" id="7290871">.</span><span class="ident" id="7290872">db</span><span class="op" id="7290874">.</span><span class="ident" id="7290875">Begin</span><span class="op" id="7290880">(</span><span class="op" id="7290881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7290884">if</span>&nbsp;<span class="ident" id="7290887">err</span>&nbsp;<span class="op" id="7290891">!=</span>&nbsp;<span class="ident" id="7290894">nil</span>&nbsp;<span class="op" id="7290898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7290902">t</span><span class="op" id="7290903">.</span><span class="ident" id="7290904">Fatal</span><span class="op" id="7290909">(</span><span class="ident" id="7290910">err</span><span class="op" id="7290913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7290916">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7290919">c</span><span class="op" id="7290920">.</span><span class="ident" id="7290921">stmt</span><span class="op" id="7290925">,</span>&nbsp;<span class="ident" id="7290927">err</span>&nbsp;<span class="op" id="7290931">=</span>&nbsp;<span class="ident" id="7290933">c</span><span class="op" id="7290934">.</span><span class="ident" id="7290935">tx</span><span class="op" id="7290937">.</span><span class="ident" id="7290938">Prepare</span><span class="op" id="7290945">(</span><span class="string" id="7290946">&#34;SELECT|people|name|&#34;</span><span class="op" id="7290967">)</span><br>
<span class="lineno">1625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7290970">if</span>&nbsp;<span class="ident" id="7290973">err</span>&nbsp;<span class="op" id="7290977">!=</span>&nbsp;<span class="ident" id="7290980">nil</span>&nbsp;<span class="op" id="7290984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7290988">t</span><span class="op" id="7290989">.</span><span class="ident" id="7290990">Fatal</span><span class="op" id="7290995">(</span><span class="ident" id="7290996">err</span><span class="op" id="7290999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7291002">}</span><br>
<span class="lineno"></span><span class="op" id="7291004">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1630</span><span class="keyword" id="7291007">func</span>&nbsp;<span class="op" id="7291012">(</span><span class="ident" id="7291013">c</span>&nbsp;<span class="op" id="7291015">*</span><span class="ident" id="7291016">concurrentTxStmtQueryTest</span><span class="op" id="7291041">)</span>&nbsp;<span class="ident" id="7291043">finish</span><span class="op" id="7291049">(</span><span class="ident" id="7291050">t</span>&nbsp;<span class="ident" id="7291052">testing</span><span class="op" id="7291059">.</span><span class="ident" id="7291060">TB</span><span class="op" id="7291062">)</span>&nbsp;<span class="op" id="7291064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7291067">if</span>&nbsp;<span class="ident" id="7291070">c</span><span class="op" id="7291071">.</span><span class="ident" id="7291072">stmt</span>&nbsp;<span class="op" id="7291077">!=</span>&nbsp;<span class="ident" id="7291080">nil</span>&nbsp;<span class="op" id="7291084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7291088">c</span><span class="op" id="7291089">.</span><span class="ident" id="7291090">stmt</span><span class="op" id="7291094">.</span><span class="ident" id="7291095">Close</span><span class="op" id="7291100">(</span><span class="op" id="7291101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7291105">c</span><span class="op" id="7291106">.</span><span class="ident" id="7291107">stmt</span>&nbsp;<span class="op" id="7291112">=</span>&nbsp;<span class="ident" id="7291114">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7291119">}</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7291122">if</span>&nbsp;<span class="ident" id="7291125">c</span><span class="op" id="7291126">.</span><span class="ident" id="7291127">tx</span>&nbsp;<span class="op" id="7291130">!=</span>&nbsp;<span class="ident" id="7291133">nil</span>&nbsp;<span class="op" id="7291137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7291141">c</span><span class="op" id="7291142">.</span><span class="ident" id="7291143">tx</span><span class="op" id="7291145">.</span><span class="ident" id="7291146">Rollback</span><span class="op" id="7291154">(</span><span class="op" id="7291155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7291159">c</span><span class="op" id="7291160">.</span><span class="ident" id="7291161">tx</span>&nbsp;<span class="op" id="7291164">=</span>&nbsp;<span class="ident" id="7291166">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7291171">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7291174">c</span><span class="op" id="7291175">.</span><span class="ident" id="7291176">db</span>&nbsp;<span class="op" id="7291179">=</span>&nbsp;<span class="ident" id="7291181">nil</span><br>
<span class="lineno">1640</span><span class="op" id="7291185">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7291188">func</span>&nbsp;<span class="op" id="7291193">(</span><span class="ident" id="7291194">c</span>&nbsp;<span class="op" id="7291196">*</span><span class="ident" id="7291197">concurrentTxStmtQueryTest</span><span class="op" id="7291222">)</span>&nbsp;<span class="ident" id="7291224">test</span><span class="op" id="7291228">(</span><span class="ident" id="7291229">t</span>&nbsp;<span class="ident" id="7291231">testing</span><span class="op" id="7291238">.</span><span class="ident" id="7291239">TB</span><span class="op" id="7291241">)</span>&nbsp;<span class="builtintype" id="7291243">error</span>&nbsp;<span class="op" id="7291249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7291252">rows</span><span class="op" id="7291256">,</span>&nbsp;<span class="ident" id="7291258">err</span>&nbsp;<span class="op" id="7291262">:=</span>&nbsp;<span class="ident" id="7291265">c</span><span class="op" id="7291266">.</span><span class="ident" id="7291267">stmt</span><span class="op" id="7291271">.</span><span class="ident" id="7291272">Query</span><span class="op" id="7291277">(</span><span class="op" id="7291278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7291281">if</span>&nbsp;<span class="ident" id="7291284">err</span>&nbsp;<span class="op" id="7291288">!=</span>&nbsp;<span class="ident" id="7291291">nil</span>&nbsp;<span class="op" id="7291295">{</span><br>
<span class="lineno">1645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7291299">t</span><span class="op" id="7291300">.</span><span class="ident" id="7291301">Errorf</span><span class="op" id="7291307">(</span><span class="string" id="7291308">&#34;error&nbsp;on&nbsp;query:&nbsp;&nbsp;%v&#34;</span><span class="op" id="7291329">,</span>&nbsp;<span class="ident" id="7291331">err</span><span class="op" id="7291334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7291338">return</span>&nbsp;<span class="ident" id="7291345">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7291350">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7291354">var</span>&nbsp;<span class="ident" id="7291358">name</span>&nbsp;<span class="builtintype" id="7291363">string</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7291371">for</span>&nbsp;<span class="ident" id="7291375">rows</span><span class="op" id="7291379">.</span><span class="ident" id="7291380">Next</span><span class="op" id="7291384">(</span><span class="op" id="7291385">)</span>&nbsp;<span class="op" id="7291387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7291391">rows</span><span class="op" id="7291395">.</span><span class="ident" id="7291396">Scan</span><span class="op" id="7291400">(</span><span class="op" id="7291401">&amp;</span><span class="ident" id="7291402">name</span><span class="op" id="7291406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7291409">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7291412">rows</span><span class="op" id="7291416">.</span><span class="ident" id="7291417">Close</span><span class="op" id="7291422">(</span><span class="op" id="7291423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7291426">return</span>&nbsp;<span class="ident" id="7291433">nil</span><br>
<span class="lineno">1655</span><span class="op" id="7291437">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7291440">type</span>&nbsp;<span class="ident" id="7291445">concurrentTxStmtExecTest</span>&nbsp;<span class="keyword" id="7291470">struct</span>&nbsp;<span class="op" id="7291477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7291480">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7291485">*</span><span class="ident" id="7291486">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7291490">tx</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7291495">*</span><span class="ident" id="7291496">Tx</span><br>
<span class="lineno">1660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7291500">stmt</span>&nbsp;<span class="op" id="7291505">*</span><span class="ident" id="7291506">Stmt</span><br>
<span class="lineno"></span><span class="op" id="7291511">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7291514">func</span>&nbsp;<span class="op" id="7291519">(</span><span class="ident" id="7291520">c</span>&nbsp;<span class="op" id="7291522">*</span><span class="ident" id="7291523">concurrentTxStmtExecTest</span><span class="op" id="7291547">)</span>&nbsp;<span class="ident" id="7291549">init</span><span class="op" id="7291553">(</span><span class="ident" id="7291554">t</span>&nbsp;<span class="ident" id="7291556">testing</span><span class="op" id="7291563">.</span><span class="ident" id="7291564">TB</span><span class="op" id="7291566">,</span>&nbsp;<span class="ident" id="7291568">db</span>&nbsp;<span class="op" id="7291571">*</span><span class="ident" id="7291572">DB</span><span class="op" id="7291574">)</span>&nbsp;<span class="op" id="7291576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7291579">c</span><span class="op" id="7291580">.</span><span class="ident" id="7291581">db</span>&nbsp;<span class="op" id="7291584">=</span>&nbsp;<span class="ident" id="7291586">db</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7291590">var</span>&nbsp;<span class="ident" id="7291594">err</span>&nbsp;<span class="builtintype" id="7291598">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7291605">c</span><span class="op" id="7291606">.</span><span class="ident" id="7291607">tx</span><span class="op" id="7291609">,</span>&nbsp;<span class="ident" id="7291611">err</span>&nbsp;<span class="op" id="7291615">=</span>&nbsp;<span class="ident" id="7291617">c</span><span class="op" id="7291618">.</span><span class="ident" id="7291619">db</span><span class="op" id="7291621">.</span><span class="ident" id="7291622">Begin</span><span class="op" id="7291627">(</span><span class="op" id="7291628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7291631">if</span>&nbsp;<span class="ident" id="7291634">err</span>&nbsp;<span class="op" id="7291638">!=</span>&nbsp;<span class="ident" id="7291641">nil</span>&nbsp;<span class="op" id="7291645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7291649">t</span><span class="op" id="7291650">.</span><span class="ident" id="7291651">Fatal</span><span class="op" id="7291656">(</span><span class="ident" id="7291657">err</span><span class="op" id="7291660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7291663">}</span><br>
<span class="lineno">1670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7291666">c</span><span class="op" id="7291667">.</span><span class="ident" id="7291668">stmt</span><span class="op" id="7291672">,</span>&nbsp;<span class="ident" id="7291674">err</span>&nbsp;<span class="op" id="7291678">=</span>&nbsp;<span class="ident" id="7291680">c</span><span class="op" id="7291681">.</span><span class="ident" id="7291682">tx</span><span class="op" id="7291684">.</span><span class="ident" id="7291685">Prepare</span><span class="op" id="7291692">(</span><span class="string" id="7291693">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="7291746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7291749">if</span>&nbsp;<span class="ident" id="7291752">err</span>&nbsp;<span class="op" id="7291756">!=</span>&nbsp;<span class="ident" id="7291759">nil</span>&nbsp;<span class="op" id="7291763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7291767">t</span><span class="op" id="7291768">.</span><span class="ident" id="7291769">Fatal</span><span class="op" id="7291774">(</span><span class="ident" id="7291775">err</span><span class="op" id="7291778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7291781">}</span><br>
<span class="lineno"></span><span class="op" id="7291783">}</span><br>
<span class="lineno">1675</span><br>
<span class="lineno"></span><span class="keyword" id="7291786">func</span>&nbsp;<span class="op" id="7291791">(</span><span class="ident" id="7291792">c</span>&nbsp;<span class="op" id="7291794">*</span><span class="ident" id="7291795">concurrentTxStmtExecTest</span><span class="op" id="7291819">)</span>&nbsp;<span class="ident" id="7291821">finish</span><span class="op" id="7291827">(</span><span class="ident" id="7291828">t</span>&nbsp;<span class="ident" id="7291830">testing</span><span class="op" id="7291837">.</span><span class="ident" id="7291838">TB</span><span class="op" id="7291840">)</span>&nbsp;<span class="op" id="7291842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7291845">if</span>&nbsp;<span class="ident" id="7291848">c</span><span class="op" id="7291849">.</span><span class="ident" id="7291850">stmt</span>&nbsp;<span class="op" id="7291855">!=</span>&nbsp;<span class="ident" id="7291858">nil</span>&nbsp;<span class="op" id="7291862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7291866">c</span><span class="op" id="7291867">.</span><span class="ident" id="7291868">stmt</span><span class="op" id="7291872">.</span><span class="ident" id="7291873">Close</span><span class="op" id="7291878">(</span><span class="op" id="7291879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7291883">c</span><span class="op" id="7291884">.</span><span class="ident" id="7291885">stmt</span>&nbsp;<span class="op" id="7291890">=</span>&nbsp;<span class="ident" id="7291892">nil</span><br>
<span class="lineno">1680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7291897">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7291900">if</span>&nbsp;<span class="ident" id="7291903">c</span><span class="op" id="7291904">.</span><span class="ident" id="7291905">tx</span>&nbsp;<span class="op" id="7291908">!=</span>&nbsp;<span class="ident" id="7291911">nil</span>&nbsp;<span class="op" id="7291915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7291919">c</span><span class="op" id="7291920">.</span><span class="ident" id="7291921">tx</span><span class="op" id="7291923">.</span><span class="ident" id="7291924">Rollback</span><span class="op" id="7291932">(</span><span class="op" id="7291933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7291937">c</span><span class="op" id="7291938">.</span><span class="ident" id="7291939">tx</span>&nbsp;<span class="op" id="7291942">=</span>&nbsp;<span class="ident" id="7291944">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7291949">}</span><br>
<span class="lineno">1685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7291952">c</span><span class="op" id="7291953">.</span><span class="ident" id="7291954">db</span>&nbsp;<span class="op" id="7291957">=</span>&nbsp;<span class="ident" id="7291959">nil</span><br>
<span class="lineno"></span><span class="op" id="7291963">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7291966">func</span>&nbsp;<span class="op" id="7291971">(</span><span class="ident" id="7291972">c</span>&nbsp;<span class="op" id="7291974">*</span><span class="ident" id="7291975">concurrentTxStmtExecTest</span><span class="op" id="7291999">)</span>&nbsp;<span class="ident" id="7292001">test</span><span class="op" id="7292005">(</span><span class="ident" id="7292006">t</span>&nbsp;<span class="ident" id="7292008">testing</span><span class="op" id="7292015">.</span><span class="ident" id="7292016">TB</span><span class="op" id="7292018">)</span>&nbsp;<span class="builtintype" id="7292020">error</span>&nbsp;<span class="op" id="7292026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7292029">_</span><span class="op" id="7292030">,</span>&nbsp;<span class="ident" id="7292032">err</span>&nbsp;<span class="op" id="7292036">:=</span>&nbsp;<span class="ident" id="7292039">c</span><span class="op" id="7292040">.</span><span class="ident" id="7292041">stmt</span><span class="op" id="7292045">.</span><span class="ident" id="7292046">Exec</span><span class="op" id="7292050">(</span><span class="num" id="7292051">3</span><span class="op" id="7292052">,</span>&nbsp;<span class="ident" id="7292054">chrisBirthday</span><span class="op" id="7292067">)</span><br>
<span class="lineno">1690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7292070">if</span>&nbsp;<span class="ident" id="7292073">err</span>&nbsp;<span class="op" id="7292077">!=</span>&nbsp;<span class="ident" id="7292080">nil</span>&nbsp;<span class="op" id="7292084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7292088">t</span><span class="op" id="7292089">.</span><span class="ident" id="7292090">Errorf</span><span class="op" id="7292096">(</span><span class="string" id="7292097">&#34;error&nbsp;on&nbsp;exec:&nbsp;&nbsp;%v&#34;</span><span class="op" id="7292117">,</span>&nbsp;<span class="ident" id="7292119">err</span><span class="op" id="7292122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7292126">return</span>&nbsp;<span class="ident" id="7292133">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7292138">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7292141">return</span>&nbsp;<span class="ident" id="7292148">nil</span><br>
<span class="lineno">1695</span><span class="op" id="7292152">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7292155">type</span>&nbsp;<span class="ident" id="7292160">concurrentRandomTest</span>&nbsp;<span class="keyword" id="7292181">struct</span>&nbsp;<span class="op" id="7292188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7292191">tests</span>&nbsp;<span class="op" id="7292197">[</span><span class="op" id="7292198">]</span><span class="ident" id="7292199">concurrentTest</span><br>
<span class="lineno"></span><span class="op" id="7292214">}</span><br>
<span class="lineno">1700</span><br>
<span class="lineno"></span><span class="keyword" id="7292217">func</span>&nbsp;<span class="op" id="7292222">(</span><span class="ident" id="7292223">c</span>&nbsp;<span class="op" id="7292225">*</span><span class="ident" id="7292226">concurrentRandomTest</span><span class="op" id="7292246">)</span>&nbsp;<span class="ident" id="7292248">init</span><span class="op" id="7292252">(</span><span class="ident" id="7292253">t</span>&nbsp;<span class="ident" id="7292255">testing</span><span class="op" id="7292262">.</span><span class="ident" id="7292263">TB</span><span class="op" id="7292265">,</span>&nbsp;<span class="ident" id="7292267">db</span>&nbsp;<span class="op" id="7292270">*</span><span class="ident" id="7292271">DB</span><span class="op" id="7292273">)</span>&nbsp;<span class="op" id="7292275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7292278">c</span><span class="op" id="7292279">.</span><span class="ident" id="7292280">tests</span>&nbsp;<span class="op" id="7292286">=</span>&nbsp;<span class="op" id="7292288">[</span><span class="op" id="7292289">]</span><span class="ident" id="7292290">concurrentTest</span><span class="op" id="7292304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7292308">new</span><span class="op" id="7292311">(</span><span class="ident" id="7292312">concurrentDBQueryTest</span><span class="op" id="7292333">)</span><span class="op" id="7292334">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7292338">new</span><span class="op" id="7292341">(</span><span class="ident" id="7292342">concurrentDBExecTest</span><span class="op" id="7292362">)</span><span class="op" id="7292363">,</span><br>
<span class="lineno">1705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7292367">new</span><span class="op" id="7292370">(</span><span class="ident" id="7292371">concurrentStmtQueryTest</span><span class="op" id="7292394">)</span><span class="op" id="7292395">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7292399">new</span><span class="op" id="7292402">(</span><span class="ident" id="7292403">concurrentStmtExecTest</span><span class="op" id="7292425">)</span><span class="op" id="7292426">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7292430">new</span><span class="op" id="7292433">(</span><span class="ident" id="7292434">concurrentTxQueryTest</span><span class="op" id="7292455">)</span><span class="op" id="7292456">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7292460">new</span><span class="op" id="7292463">(</span><span class="ident" id="7292464">concurrentTxExecTest</span><span class="op" id="7292484">)</span><span class="op" id="7292485">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7292489">new</span><span class="op" id="7292492">(</span><span class="ident" id="7292493">concurrentTxStmtQueryTest</span><span class="op" id="7292518">)</span><span class="op" id="7292519">,</span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7292523">new</span><span class="op" id="7292526">(</span><span class="ident" id="7292527">concurrentTxStmtExecTest</span><span class="op" id="7292551">)</span><span class="op" id="7292552">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7292555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7292558">for</span>&nbsp;<span class="ident" id="7292562">_</span><span class="op" id="7292563">,</span>&nbsp;<span class="ident" id="7292565">ct</span>&nbsp;<span class="op" id="7292568">:=</span>&nbsp;<span class="keyword" id="7292571">range</span>&nbsp;<span class="ident" id="7292577">c</span><span class="op" id="7292578">.</span><span class="ident" id="7292579">tests</span>&nbsp;<span class="op" id="7292585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7292589">ct</span><span class="op" id="7292591">.</span><span class="ident" id="7292592">init</span><span class="op" id="7292596">(</span><span class="ident" id="7292597">t</span><span class="op" id="7292598">,</span>&nbsp;<span class="ident" id="7292600">db</span><span class="op" id="7292602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7292605">}</span><br>
<span class="lineno">1715</span><span class="op" id="7292607">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7292610">func</span>&nbsp;<span class="op" id="7292615">(</span><span class="ident" id="7292616">c</span>&nbsp;<span class="op" id="7292618">*</span><span class="ident" id="7292619">concurrentRandomTest</span><span class="op" id="7292639">)</span>&nbsp;<span class="ident" id="7292641">finish</span><span class="op" id="7292647">(</span><span class="ident" id="7292648">t</span>&nbsp;<span class="ident" id="7292650">testing</span><span class="op" id="7292657">.</span><span class="ident" id="7292658">TB</span><span class="op" id="7292660">)</span>&nbsp;<span class="op" id="7292662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7292665">for</span>&nbsp;<span class="ident" id="7292669">_</span><span class="op" id="7292670">,</span>&nbsp;<span class="ident" id="7292672">ct</span>&nbsp;<span class="op" id="7292675">:=</span>&nbsp;<span class="keyword" id="7292678">range</span>&nbsp;<span class="ident" id="7292684">c</span><span class="op" id="7292685">.</span><span class="ident" id="7292686">tests</span>&nbsp;<span class="op" id="7292692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7292696">ct</span><span class="op" id="7292698">.</span><span class="ident" id="7292699">finish</span><span class="op" id="7292705">(</span><span class="ident" id="7292706">t</span><span class="op" id="7292707">)</span><br>
<span class="lineno">1720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7292710">}</span><br>
<span class="lineno"></span><span class="op" id="7292712">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7292715">func</span>&nbsp;<span class="op" id="7292720">(</span><span class="ident" id="7292721">c</span>&nbsp;<span class="op" id="7292723">*</span><span class="ident" id="7292724">concurrentRandomTest</span><span class="op" id="7292744">)</span>&nbsp;<span class="ident" id="7292746">test</span><span class="op" id="7292750">(</span><span class="ident" id="7292751">t</span>&nbsp;<span class="ident" id="7292753">testing</span><span class="op" id="7292760">.</span><span class="ident" id="7292761">TB</span><span class="op" id="7292763">)</span>&nbsp;<span class="builtintype" id="7292765">error</span>&nbsp;<span class="op" id="7292771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7292774">ct</span>&nbsp;<span class="op" id="7292777">:=</span>&nbsp;<span class="ident" id="7292780">c</span><span class="op" id="7292781">.</span><span class="ident" id="7292782">tests</span><span class="op" id="7292787">[</span><span class="ident" id="7292788">rand</span><span class="op" id="7292792">.</span><span class="ident" id="7292793">Intn</span><span class="op" id="7292797">(</span><span class="builtinfunc" id="7292798">len</span><span class="op" id="7292801">(</span><span class="ident" id="7292802">c</span><span class="op" id="7292803">.</span><span class="ident" id="7292804">tests</span><span class="op" id="7292809">)</span><span class="op" id="7292810">)</span><span class="op" id="7292811">]</span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7292814">return</span>&nbsp;<span class="ident" id="7292821">ct</span><span class="op" id="7292823">.</span><span class="ident" id="7292824">test</span><span class="op" id="7292828">(</span><span class="ident" id="7292829">t</span><span class="op" id="7292830">)</span><br>
<span class="lineno"></span><span class="op" id="7292832">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7292835">func</span>&nbsp;<span class="ident" id="7292840">doConcurrentTest</span><span class="op" id="7292856">(</span><span class="ident" id="7292857">t</span>&nbsp;<span class="ident" id="7292859">testing</span><span class="op" id="7292866">.</span><span class="ident" id="7292867">TB</span><span class="op" id="7292869">,</span>&nbsp;<span class="ident" id="7292871">ct</span>&nbsp;<span class="ident" id="7292874">concurrentTest</span><span class="op" id="7292888">)</span>&nbsp;<span class="op" id="7292890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7292893">maxProcs</span><span class="op" id="7292901">,</span>&nbsp;<span class="ident" id="7292903">numReqs</span>&nbsp;<span class="op" id="7292911">:=</span>&nbsp;<span class="num" id="7292914">1</span><span class="op" id="7292915">,</span>&nbsp;<span class="num" id="7292917">500</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7292922">if</span>&nbsp;<span class="ident" id="7292925">testing</span><span class="op" id="7292932">.</span><span class="ident" id="7292933">Short</span><span class="op" id="7292938">(</span><span class="op" id="7292939">)</span>&nbsp;<span class="op" id="7292941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7292945">maxProcs</span><span class="op" id="7292953">,</span>&nbsp;<span class="ident" id="7292955">numReqs</span>&nbsp;<span class="op" id="7292963">=</span>&nbsp;<span class="num" id="7292965">4</span><span class="op" id="7292966">,</span>&nbsp;<span class="num" id="7292968">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7292972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7292975">defer</span>&nbsp;<span class="ident" id="7292981">runtime</span><span class="op" id="7292988">.</span><span class="ident" id="7292989">GOMAXPROCS</span><span class="op" id="7292999">(</span><span class="ident" id="7293000">runtime</span><span class="op" id="7293007">.</span><span class="ident" id="7293008">GOMAXPROCS</span><span class="op" id="7293018">(</span><span class="ident" id="7293019">maxProcs</span><span class="op" id="7293027">)</span><span class="op" id="7293028">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7293032">db</span>&nbsp;<span class="op" id="7293035">:=</span>&nbsp;<span class="ident" id="7293038">newTestDB</span><span class="op" id="7293047">(</span><span class="ident" id="7293048">t</span><span class="op" id="7293049">,</span>&nbsp;<span class="string" id="7293051">&#34;people&#34;</span><span class="op" id="7293059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7293062">defer</span>&nbsp;<span class="ident" id="7293068">closeDB</span><span class="op" id="7293075">(</span><span class="ident" id="7293076">t</span><span class="op" id="7293077">,</span>&nbsp;<span class="ident" id="7293079">db</span><span class="op" id="7293081">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7293085">ct</span><span class="op" id="7293087">.</span><span class="ident" id="7293088">init</span><span class="op" id="7293092">(</span><span class="ident" id="7293093">t</span><span class="op" id="7293094">,</span>&nbsp;<span class="ident" id="7293096">db</span><span class="op" id="7293098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7293101">defer</span>&nbsp;<span class="ident" id="7293107">ct</span><span class="op" id="7293109">.</span><span class="ident" id="7293110">finish</span><span class="op" id="7293116">(</span><span class="ident" id="7293117">t</span><span class="op" id="7293118">)</span><br>
<span class="lineno">1740</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7293122">var</span>&nbsp;<span class="ident" id="7293126">wg</span>&nbsp;<span class="ident" id="7293129">sync</span><span class="op" id="7293133">.</span><span class="ident" id="7293134">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7293145">wg</span><span class="op" id="7293147">.</span><span class="ident" id="7293148">Add</span><span class="op" id="7293151">(</span><span class="ident" id="7293152">numReqs</span><span class="op" id="7293159">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7293163">reqs</span>&nbsp;<span class="op" id="7293168">:=</span>&nbsp;<span class="builtinfunc" id="7293171">make</span><span class="op" id="7293175">(</span><span class="keyword" id="7293176">chan</span>&nbsp;<span class="builtintype" id="7293181">bool</span><span class="op" id="7293185">)</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7293188">defer</span>&nbsp;<span class="builtinfunc" id="7293194">close</span><span class="op" id="7293199">(</span><span class="ident" id="7293200">reqs</span><span class="op" id="7293204">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7293208">for</span>&nbsp;<span class="ident" id="7293212">i</span>&nbsp;<span class="op" id="7293214">:=</span>&nbsp;<span class="num" id="7293217">0</span><span class="op" id="7293218">;</span>&nbsp;<span class="ident" id="7293220">i</span>&nbsp;<span class="op" id="7293222">&lt;</span>&nbsp;<span class="ident" id="7293224">maxProcs</span><span class="op" id="7293232">*</span><span class="num" id="7293233">2</span><span class="op" id="7293234">;</span>&nbsp;<span class="ident" id="7293236">i</span><span class="op" id="7293237">++</span>&nbsp;<span class="op" id="7293240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7293244">go</span>&nbsp;<span class="keyword" id="7293247">func</span><span class="op" id="7293251">(</span><span class="op" id="7293252">)</span>&nbsp;<span class="op" id="7293254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7293259">for</span>&nbsp;<span class="keyword" id="7293263">range</span>&nbsp;<span class="ident" id="7293269">reqs</span>&nbsp;<span class="op" id="7293274">{</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7293280">err</span>&nbsp;<span class="op" id="7293284">:=</span>&nbsp;<span class="ident" id="7293287">ct</span><span class="op" id="7293289">.</span><span class="ident" id="7293290">test</span><span class="op" id="7293294">(</span><span class="ident" id="7293295">t</span><span class="op" id="7293296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7293302">if</span>&nbsp;<span class="ident" id="7293305">err</span>&nbsp;<span class="op" id="7293309">!=</span>&nbsp;<span class="ident" id="7293312">nil</span>&nbsp;<span class="op" id="7293316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7293323">wg</span><span class="op" id="7293325">.</span><span class="ident" id="7293326">Done</span><span class="op" id="7293330">(</span><span class="op" id="7293331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7293338">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7293351">}</span><br>
<span class="lineno">1755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7293357">wg</span><span class="op" id="7293359">.</span><span class="ident" id="7293360">Done</span><span class="op" id="7293364">(</span><span class="op" id="7293365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7293370">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7293374">}</span><span class="op" id="7293375">(</span><span class="op" id="7293376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7293379">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1760</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7293383">for</span>&nbsp;<span class="ident" id="7293387">i</span>&nbsp;<span class="op" id="7293389">:=</span>&nbsp;<span class="num" id="7293392">0</span><span class="op" id="7293393">;</span>&nbsp;<span class="ident" id="7293395">i</span>&nbsp;<span class="op" id="7293397">&lt;</span>&nbsp;<span class="ident" id="7293399">numReqs</span><span class="op" id="7293406">;</span>&nbsp;<span class="ident" id="7293408">i</span><span class="op" id="7293409">++</span>&nbsp;<span class="op" id="7293412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7293416">reqs</span>&nbsp;<span class="op" id="7293421">&lt;-</span>&nbsp;<span class="ident" id="7293424">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7293430">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7293434">wg</span><span class="op" id="7293436">.</span><span class="ident" id="7293437">Wait</span><span class="op" id="7293441">(</span><span class="op" id="7293442">)</span><br>
<span class="lineno">1765</span><span class="op" id="7293444">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7293447">func</span>&nbsp;<span class="ident" id="7293452">manyConcurrentQueries</span><span class="op" id="7293473">(</span><span class="ident" id="7293474">t</span>&nbsp;<span class="ident" id="7293476">testing</span><span class="op" id="7293483">.</span><span class="ident" id="7293484">TB</span><span class="op" id="7293486">)</span>&nbsp;<span class="op" id="7293488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7293491">maxProcs</span><span class="op" id="7293499">,</span>&nbsp;<span class="ident" id="7293501">numReqs</span>&nbsp;<span class="op" id="7293509">:=</span>&nbsp;<span class="num" id="7293512">16</span><span class="op" id="7293514">,</span>&nbsp;<span class="num" id="7293516">500</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7293521">if</span>&nbsp;<span class="ident" id="7293524">testing</span><span class="op" id="7293531">.</span><span class="ident" id="7293532">Short</span><span class="op" id="7293537">(</span><span class="op" id="7293538">)</span>&nbsp;<span class="op" id="7293540">{</span><br>
<span class="lineno">1770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7293544">maxProcs</span><span class="op" id="7293552">,</span>&nbsp;<span class="ident" id="7293554">numReqs</span>&nbsp;<span class="op" id="7293562">=</span>&nbsp;<span class="num" id="7293564">4</span><span class="op" id="7293565">,</span>&nbsp;<span class="num" id="7293567">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7293571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7293574">defer</span>&nbsp;<span class="ident" id="7293580">runtime</span><span class="op" id="7293587">.</span><span class="ident" id="7293588">GOMAXPROCS</span><span class="op" id="7293598">(</span><span class="ident" id="7293599">runtime</span><span class="op" id="7293606">.</span><span class="ident" id="7293607">GOMAXPROCS</span><span class="op" id="7293617">(</span><span class="ident" id="7293618">maxProcs</span><span class="op" id="7293626">)</span><span class="op" id="7293627">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7293631">db</span>&nbsp;<span class="op" id="7293634">:=</span>&nbsp;<span class="ident" id="7293637">newTestDB</span><span class="op" id="7293646">(</span><span class="ident" id="7293647">t</span><span class="op" id="7293648">,</span>&nbsp;<span class="string" id="7293650">&#34;people&#34;</span><span class="op" id="7293658">)</span><br>
<span class="lineno">1775</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7293661">defer</span>&nbsp;<span class="ident" id="7293667">closeDB</span><span class="op" id="7293674">(</span><span class="ident" id="7293675">t</span><span class="op" id="7293676">,</span>&nbsp;<span class="ident" id="7293678">db</span><span class="op" id="7293680">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7293684">stmt</span><span class="op" id="7293688">,</span>&nbsp;<span class="ident" id="7293690">err</span>&nbsp;<span class="op" id="7293694">:=</span>&nbsp;<span class="ident" id="7293697">db</span><span class="op" id="7293699">.</span><span class="ident" id="7293700">Prepare</span><span class="op" id="7293707">(</span><span class="string" id="7293708">&#34;SELECT|people|name|&#34;</span><span class="op" id="7293729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7293732">if</span>&nbsp;<span class="ident" id="7293735">err</span>&nbsp;<span class="op" id="7293739">!=</span>&nbsp;<span class="ident" id="7293742">nil</span>&nbsp;<span class="op" id="7293746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7293750">t</span><span class="op" id="7293751">.</span><span class="ident" id="7293752">Fatal</span><span class="op" id="7293757">(</span><span class="ident" id="7293758">err</span><span class="op" id="7293761">)</span><br>
<span class="lineno">1780</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7293764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7293767">defer</span>&nbsp;<span class="ident" id="7293773">stmt</span><span class="op" id="7293777">.</span><span class="ident" id="7293778">Close</span><span class="op" id="7293783">(</span><span class="op" id="7293784">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7293788">var</span>&nbsp;<span class="ident" id="7293792">wg</span>&nbsp;<span class="ident" id="7293795">sync</span><span class="op" id="7293799">.</span><span class="ident" id="7293800">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7293811">wg</span><span class="op" id="7293813">.</span><span class="ident" id="7293814">Add</span><span class="op" id="7293817">(</span><span class="ident" id="7293818">numReqs</span><span class="op" id="7293825">)</span><br>
<span class="lineno">1785</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7293829">reqs</span>&nbsp;<span class="op" id="7293834">:=</span>&nbsp;<span class="builtinfunc" id="7293837">make</span><span class="op" id="7293841">(</span><span class="keyword" id="7293842">chan</span>&nbsp;<span class="builtintype" id="7293847">bool</span><span class="op" id="7293851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7293854">defer</span>&nbsp;<span class="builtinfunc" id="7293860">close</span><span class="op" id="7293865">(</span><span class="ident" id="7293866">reqs</span><span class="op" id="7293870">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7293874">for</span>&nbsp;<span class="ident" id="7293878">i</span>&nbsp;<span class="op" id="7293880">:=</span>&nbsp;<span class="num" id="7293883">0</span><span class="op" id="7293884">;</span>&nbsp;<span class="ident" id="7293886">i</span>&nbsp;<span class="op" id="7293888">&lt;</span>&nbsp;<span class="ident" id="7293890">maxProcs</span><span class="op" id="7293898">*</span><span class="num" id="7293899">2</span><span class="op" id="7293900">;</span>&nbsp;<span class="ident" id="7293902">i</span><span class="op" id="7293903">++</span>&nbsp;<span class="op" id="7293906">{</span><br>
<span class="lineno">1790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7293910">go</span>&nbsp;<span class="keyword" id="7293913">func</span><span class="op" id="7293917">(</span><span class="op" id="7293918">)</span>&nbsp;<span class="op" id="7293920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7293925">for</span>&nbsp;<span class="keyword" id="7293929">range</span>&nbsp;<span class="ident" id="7293935">reqs</span>&nbsp;<span class="op" id="7293940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7293946">rows</span><span class="op" id="7293950">,</span>&nbsp;<span class="ident" id="7293952">err</span>&nbsp;<span class="op" id="7293956">:=</span>&nbsp;<span class="ident" id="7293959">stmt</span><span class="op" id="7293963">.</span><span class="ident" id="7293964">Query</span><span class="op" id="7293969">(</span><span class="op" id="7293970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7293976">if</span>&nbsp;<span class="ident" id="7293979">err</span>&nbsp;<span class="op" id="7293983">!=</span>&nbsp;<span class="ident" id="7293986">nil</span>&nbsp;<span class="op" id="7293990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7293997">t</span><span class="op" id="7293998">.</span><span class="ident" id="7293999">Errorf</span><span class="op" id="7294005">(</span><span class="string" id="7294006">&#34;error&nbsp;on&nbsp;query:&nbsp;&nbsp;%v&#34;</span><span class="op" id="7294027">,</span>&nbsp;<span class="ident" id="7294029">err</span><span class="op" id="7294032">)</span><br>
<span class="lineno">1795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7294039">wg</span><span class="op" id="7294041">.</span><span class="ident" id="7294042">Done</span><span class="op" id="7294046">(</span><span class="op" id="7294047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7294054">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7294067">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7294074">var</span>&nbsp;<span class="ident" id="7294078">name</span>&nbsp;<span class="builtintype" id="7294083">string</span><br>
<span class="lineno">1800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7294094">for</span>&nbsp;<span class="ident" id="7294098">rows</span><span class="op" id="7294102">.</span><span class="ident" id="7294103">Next</span><span class="op" id="7294107">(</span><span class="op" id="7294108">)</span>&nbsp;<span class="op" id="7294110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7294117">rows</span><span class="op" id="7294121">.</span><span class="ident" id="7294122">Scan</span><span class="op" id="7294126">(</span><span class="op" id="7294127">&amp;</span><span class="ident" id="7294128">name</span><span class="op" id="7294132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7294138">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7294144">rows</span><span class="op" id="7294148">.</span><span class="ident" id="7294149">Close</span><span class="op" id="7294154">(</span><span class="op" id="7294155">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7294162">wg</span><span class="op" id="7294164">.</span><span class="ident" id="7294165">Done</span><span class="op" id="7294169">(</span><span class="op" id="7294170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7294175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7294179">}</span><span class="op" id="7294180">(</span><span class="op" id="7294181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7294184">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1810</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7294188">for</span>&nbsp;<span class="ident" id="7294192">i</span>&nbsp;<span class="op" id="7294194">:=</span>&nbsp;<span class="num" id="7294197">0</span><span class="op" id="7294198">;</span>&nbsp;<span class="ident" id="7294200">i</span>&nbsp;<span class="op" id="7294202">&lt;</span>&nbsp;<span class="ident" id="7294204">numReqs</span><span class="op" id="7294211">;</span>&nbsp;<span class="ident" id="7294213">i</span><span class="op" id="7294214">++</span>&nbsp;<span class="op" id="7294217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7294221">reqs</span>&nbsp;<span class="op" id="7294226">&lt;-</span>&nbsp;<span class="ident" id="7294229">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7294235">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7294239">wg</span><span class="op" id="7294241">.</span><span class="ident" id="7294242">Wait</span><span class="op" id="7294246">(</span><span class="op" id="7294247">)</span><br>
<span class="lineno">1815</span><span class="op" id="7294249">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7294252">func</span>&nbsp;<span class="ident" id="7294257">TestIssue6081</span><span class="op" id="7294270">(</span><span class="ident" id="7294271">t</span>&nbsp;<span class="op" id="7294273">*</span><span class="ident" id="7294274">testing</span><span class="op" id="7294281">.</span><span class="ident" id="7294282">T</span><span class="op" id="7294283">)</span>&nbsp;<span class="op" id="7294285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7294288">db</span>&nbsp;<span class="op" id="7294291">:=</span>&nbsp;<span class="ident" id="7294294">newTestDB</span><span class="op" id="7294303">(</span><span class="ident" id="7294304">t</span><span class="op" id="7294305">,</span>&nbsp;<span class="string" id="7294307">&#34;people&#34;</span><span class="op" id="7294315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7294318">defer</span>&nbsp;<span class="ident" id="7294324">closeDB</span><span class="op" id="7294331">(</span><span class="ident" id="7294332">t</span><span class="op" id="7294333">,</span>&nbsp;<span class="ident" id="7294335">db</span><span class="op" id="7294337">)</span><br>
<span class="lineno">1820</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7294341">drv</span>&nbsp;<span class="op" id="7294345">:=</span>&nbsp;<span class="ident" id="7294348">db</span><span class="op" id="7294350">.</span><span class="ident" id="7294351">driver</span><span class="op" id="7294357">.</span><span class="op" id="7294358">(</span><span class="op" id="7294359">*</span><span class="ident" id="7294360">fakeDriver</span><span class="op" id="7294370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7294373">drv</span><span class="op" id="7294376">.</span><span class="ident" id="7294377">mu</span><span class="op" id="7294379">.</span><span class="ident" id="7294380">Lock</span><span class="op" id="7294384">(</span><span class="op" id="7294385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7294388">opens0</span>&nbsp;<span class="op" id="7294395">:=</span>&nbsp;<span class="ident" id="7294398">drv</span><span class="op" id="7294401">.</span><span class="ident" id="7294402">openCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7294413">closes0</span>&nbsp;<span class="op" id="7294421">:=</span>&nbsp;<span class="ident" id="7294424">drv</span><span class="op" id="7294427">.</span><span class="ident" id="7294428">closeCount</span><br>
<span class="lineno">1825</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7294440">drv</span><span class="op" id="7294443">.</span><span class="ident" id="7294444">mu</span><span class="op" id="7294446">.</span><span class="ident" id="7294447">Unlock</span><span class="op" id="7294453">(</span><span class="op" id="7294454">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7294458">stmt</span><span class="op" id="7294462">,</span>&nbsp;<span class="ident" id="7294464">err</span>&nbsp;<span class="op" id="7294468">:=</span>&nbsp;<span class="ident" id="7294471">db</span><span class="op" id="7294473">.</span><span class="ident" id="7294474">Prepare</span><span class="op" id="7294481">(</span><span class="string" id="7294482">&#34;SELECT|people|name|&#34;</span><span class="op" id="7294503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7294506">if</span>&nbsp;<span class="ident" id="7294509">err</span>&nbsp;<span class="op" id="7294513">!=</span>&nbsp;<span class="ident" id="7294516">nil</span>&nbsp;<span class="op" id="7294520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7294524">t</span><span class="op" id="7294525">.</span><span class="ident" id="7294526">Fatal</span><span class="op" id="7294531">(</span><span class="ident" id="7294532">err</span><span class="op" id="7294535">)</span><br>
<span class="lineno">1830</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7294538">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7294541">rowsCloseHook</span>&nbsp;<span class="op" id="7294555">=</span>&nbsp;<span class="keyword" id="7294557">func</span><span class="op" id="7294561">(</span><span class="ident" id="7294562">rows</span>&nbsp;<span class="op" id="7294567">*</span><span class="ident" id="7294568">Rows</span><span class="op" id="7294572">,</span>&nbsp;<span class="ident" id="7294574">err</span>&nbsp;<span class="op" id="7294578">*</span><span class="builtintype" id="7294579">error</span><span class="op" id="7294584">)</span>&nbsp;<span class="op" id="7294586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7294590">*</span><span class="ident" id="7294591">err</span>&nbsp;<span class="op" id="7294595">=</span>&nbsp;<span class="ident" id="7294597">driver</span><span class="op" id="7294603">.</span><span class="ident" id="7294604">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7294616">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7294619">defer</span>&nbsp;<span class="keyword" id="7294625">func</span><span class="op" id="7294629">(</span><span class="op" id="7294630">)</span>&nbsp;<span class="op" id="7294632">{</span>&nbsp;<span class="ident" id="7294634">rowsCloseHook</span>&nbsp;<span class="op" id="7294648">=</span>&nbsp;<span class="ident" id="7294650">nil</span>&nbsp;<span class="op" id="7294654">}</span><span class="op" id="7294655">(</span><span class="op" id="7294656">)</span><br>
<span class="lineno">1835</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7294659">for</span>&nbsp;<span class="ident" id="7294663">i</span>&nbsp;<span class="op" id="7294665">:=</span>&nbsp;<span class="num" id="7294668">0</span><span class="op" id="7294669">;</span>&nbsp;<span class="ident" id="7294671">i</span>&nbsp;<span class="op" id="7294673">&lt;</span>&nbsp;<span class="num" id="7294675">10</span><span class="op" id="7294677">;</span>&nbsp;<span class="ident" id="7294679">i</span><span class="op" id="7294680">++</span>&nbsp;<span class="op" id="7294683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7294687">rows</span><span class="op" id="7294691">,</span>&nbsp;<span class="ident" id="7294693">err</span>&nbsp;<span class="op" id="7294697">:=</span>&nbsp;<span class="ident" id="7294700">stmt</span><span class="op" id="7294704">.</span><span class="ident" id="7294705">Query</span><span class="op" id="7294710">(</span><span class="op" id="7294711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7294715">if</span>&nbsp;<span class="ident" id="7294718">err</span>&nbsp;<span class="op" id="7294722">!=</span>&nbsp;<span class="ident" id="7294725">nil</span>&nbsp;<span class="op" id="7294729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7294734">t</span><span class="op" id="7294735">.</span><span class="ident" id="7294736">Fatal</span><span class="op" id="7294741">(</span><span class="ident" id="7294742">err</span><span class="op" id="7294745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7294749">}</span><br>
<span class="lineno">1840</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7294753">rows</span><span class="op" id="7294757">.</span><span class="ident" id="7294758">Close</span><span class="op" id="7294763">(</span><span class="op" id="7294764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7294767">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7294770">if</span>&nbsp;<span class="ident" id="7294773">n</span>&nbsp;<span class="op" id="7294775">:=</span>&nbsp;<span class="builtinfunc" id="7294778">len</span><span class="op" id="7294781">(</span><span class="ident" id="7294782">stmt</span><span class="op" id="7294786">.</span><span class="ident" id="7294787">css</span><span class="op" id="7294790">)</span><span class="op" id="7294791">;</span>&nbsp;<span class="ident" id="7294793">n</span>&nbsp;<span class="op" id="7294795">&gt;</span>&nbsp;<span class="num" id="7294797">1</span>&nbsp;<span class="op" id="7294799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7294803">t</span><span class="op" id="7294804">.</span><span class="ident" id="7294805">Errorf</span><span class="op" id="7294811">(</span><span class="string" id="7294812">&#34;len(css&nbsp;slice)&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;1&#34;</span><span class="op" id="7294844">,</span>&nbsp;<span class="ident" id="7294846">n</span><span class="op" id="7294847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7294850">}</span><br>
<span class="lineno">1845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7294853">stmt</span><span class="op" id="7294857">.</span><span class="ident" id="7294858">Close</span><span class="op" id="7294863">(</span><span class="op" id="7294864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7294867">if</span>&nbsp;<span class="ident" id="7294870">n</span>&nbsp;<span class="op" id="7294872">:=</span>&nbsp;<span class="builtinfunc" id="7294875">len</span><span class="op" id="7294878">(</span><span class="ident" id="7294879">stmt</span><span class="op" id="7294883">.</span><span class="ident" id="7294884">css</span><span class="op" id="7294887">)</span><span class="op" id="7294888">;</span>&nbsp;<span class="ident" id="7294890">n</span>&nbsp;<span class="op" id="7294892">!=</span>&nbsp;<span class="num" id="7294895">0</span>&nbsp;<span class="op" id="7294897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7294901">t</span><span class="op" id="7294902">.</span><span class="ident" id="7294903">Errorf</span><span class="op" id="7294909">(</span><span class="string" id="7294910">&#34;len(css&nbsp;slice)&nbsp;after&nbsp;Close&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="7294951">,</span>&nbsp;<span class="ident" id="7294953">n</span><span class="op" id="7294954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7294957">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1850</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7294961">drv</span><span class="op" id="7294964">.</span><span class="ident" id="7294965">mu</span><span class="op" id="7294967">.</span><span class="ident" id="7294968">Lock</span><span class="op" id="7294972">(</span><span class="op" id="7294973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7294976">opens</span>&nbsp;<span class="op" id="7294982">:=</span>&nbsp;<span class="ident" id="7294985">drv</span><span class="op" id="7294988">.</span><span class="ident" id="7294989">openCount</span>&nbsp;<span class="op" id="7294999">-</span>&nbsp;<span class="ident" id="7295001">opens0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7295009">closes</span>&nbsp;<span class="op" id="7295016">:=</span>&nbsp;<span class="ident" id="7295019">drv</span><span class="op" id="7295022">.</span><span class="ident" id="7295023">closeCount</span>&nbsp;<span class="op" id="7295034">-</span>&nbsp;<span class="ident" id="7295036">closes0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7295045">drv</span><span class="op" id="7295048">.</span><span class="ident" id="7295049">mu</span><span class="op" id="7295051">.</span><span class="ident" id="7295052">Unlock</span><span class="op" id="7295058">(</span><span class="op" id="7295059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7295062">if</span>&nbsp;<span class="ident" id="7295065">opens</span>&nbsp;<span class="op" id="7295071">&lt;</span>&nbsp;<span class="num" id="7295073">9</span>&nbsp;<span class="op" id="7295075">{</span><br>
<span class="lineno">1855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7295079">t</span><span class="op" id="7295080">.</span><span class="ident" id="7295081">Errorf</span><span class="op" id="7295087">(</span><span class="string" id="7295088">&#34;opens&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&gt;=&nbsp;9&#34;</span><span class="op" id="7295111">,</span>&nbsp;<span class="ident" id="7295113">opens</span><span class="op" id="7295118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7295121">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7295124">if</span>&nbsp;<span class="ident" id="7295127">closes</span>&nbsp;<span class="op" id="7295134">&lt;</span>&nbsp;<span class="num" id="7295136">9</span>&nbsp;<span class="op" id="7295138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7295142">t</span><span class="op" id="7295143">.</span><span class="ident" id="7295144">Errorf</span><span class="op" id="7295150">(</span><span class="string" id="7295151">&#34;closes&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&gt;=&nbsp;9&#34;</span><span class="op" id="7295175">,</span>&nbsp;<span class="ident" id="7295177">closes</span><span class="op" id="7295183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7295186">}</span><br>
<span class="lineno">1860</span><span class="op" id="7295188">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7295191">func</span>&nbsp;<span class="ident" id="7295196">TestConcurrency</span><span class="op" id="7295211">(</span><span class="ident" id="7295212">t</span>&nbsp;<span class="op" id="7295214">*</span><span class="ident" id="7295215">testing</span><span class="op" id="7295222">.</span><span class="ident" id="7295223">T</span><span class="op" id="7295224">)</span>&nbsp;<span class="op" id="7295226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7295229">doConcurrentTest</span><span class="op" id="7295245">(</span><span class="ident" id="7295246">t</span><span class="op" id="7295247">,</span>&nbsp;<span class="builtinfunc" id="7295249">new</span><span class="op" id="7295252">(</span><span class="ident" id="7295253">concurrentDBQueryTest</span><span class="op" id="7295274">)</span><span class="op" id="7295275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7295278">doConcurrentTest</span><span class="op" id="7295294">(</span><span class="ident" id="7295295">t</span><span class="op" id="7295296">,</span>&nbsp;<span class="builtinfunc" id="7295298">new</span><span class="op" id="7295301">(</span><span class="ident" id="7295302">concurrentDBExecTest</span><span class="op" id="7295322">)</span><span class="op" id="7295323">)</span><br>
<span class="lineno">1865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7295326">doConcurrentTest</span><span class="op" id="7295342">(</span><span class="ident" id="7295343">t</span><span class="op" id="7295344">,</span>&nbsp;<span class="builtinfunc" id="7295346">new</span><span class="op" id="7295349">(</span><span class="ident" id="7295350">concurrentStmtQueryTest</span><span class="op" id="7295373">)</span><span class="op" id="7295374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7295377">doConcurrentTest</span><span class="op" id="7295393">(</span><span class="ident" id="7295394">t</span><span class="op" id="7295395">,</span>&nbsp;<span class="builtinfunc" id="7295397">new</span><span class="op" id="7295400">(</span><span class="ident" id="7295401">concurrentStmtExecTest</span><span class="op" id="7295423">)</span><span class="op" id="7295424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7295427">doConcurrentTest</span><span class="op" id="7295443">(</span><span class="ident" id="7295444">t</span><span class="op" id="7295445">,</span>&nbsp;<span class="builtinfunc" id="7295447">new</span><span class="op" id="7295450">(</span><span class="ident" id="7295451">concurrentTxQueryTest</span><span class="op" id="7295472">)</span><span class="op" id="7295473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7295476">doConcurrentTest</span><span class="op" id="7295492">(</span><span class="ident" id="7295493">t</span><span class="op" id="7295494">,</span>&nbsp;<span class="builtinfunc" id="7295496">new</span><span class="op" id="7295499">(</span><span class="ident" id="7295500">concurrentTxExecTest</span><span class="op" id="7295520">)</span><span class="op" id="7295521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7295524">doConcurrentTest</span><span class="op" id="7295540">(</span><span class="ident" id="7295541">t</span><span class="op" id="7295542">,</span>&nbsp;<span class="builtinfunc" id="7295544">new</span><span class="op" id="7295547">(</span><span class="ident" id="7295548">concurrentTxStmtQueryTest</span><span class="op" id="7295573">)</span><span class="op" id="7295574">)</span><br>
<span class="lineno">1870</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7295577">doConcurrentTest</span><span class="op" id="7295593">(</span><span class="ident" id="7295594">t</span><span class="op" id="7295595">,</span>&nbsp;<span class="builtinfunc" id="7295597">new</span><span class="op" id="7295600">(</span><span class="ident" id="7295601">concurrentTxStmtExecTest</span><span class="op" id="7295625">)</span><span class="op" id="7295626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7295629">doConcurrentTest</span><span class="op" id="7295645">(</span><span class="ident" id="7295646">t</span><span class="op" id="7295647">,</span>&nbsp;<span class="builtinfunc" id="7295649">new</span><span class="op" id="7295652">(</span><span class="ident" id="7295653">concurrentRandomTest</span><span class="op" id="7295673">)</span><span class="op" id="7295674">)</span><br>
<span class="lineno"></span><span class="op" id="7295676">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7295679">func</span>&nbsp;<span class="ident" id="7295684">TestConnectionLeak</span><span class="op" id="7295702">(</span><span class="ident" id="7295703">t</span>&nbsp;<span class="op" id="7295705">*</span><span class="ident" id="7295706">testing</span><span class="op" id="7295713">.</span><span class="ident" id="7295714">T</span><span class="op" id="7295715">)</span>&nbsp;<span class="op" id="7295717">{</span><br>
<span class="lineno">1875</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7295720">db</span>&nbsp;<span class="op" id="7295723">:=</span>&nbsp;<span class="ident" id="7295726">newTestDB</span><span class="op" id="7295735">(</span><span class="ident" id="7295736">t</span><span class="op" id="7295737">,</span>&nbsp;<span class="string" id="7295739">&#34;people&#34;</span><span class="op" id="7295747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7295750">defer</span>&nbsp;<span class="ident" id="7295756">closeDB</span><span class="op" id="7295763">(</span><span class="ident" id="7295764">t</span><span class="op" id="7295765">,</span>&nbsp;<span class="ident" id="7295767">db</span><span class="op" id="7295769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7295772">//&nbsp;Start&nbsp;by&nbsp;opening&nbsp;defaultMaxIdleConns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7295813">rows</span>&nbsp;<span class="op" id="7295818">:=</span>&nbsp;<span class="builtinfunc" id="7295821">make</span><span class="op" id="7295825">(</span><span class="op" id="7295826">[</span><span class="op" id="7295827">]</span><span class="op" id="7295828">*</span><span class="ident" id="7295829">Rows</span><span class="op" id="7295833">,</span>&nbsp;<span class="ident" id="7295835">defaultMaxIdleConns</span><span class="op" id="7295854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7295857">//&nbsp;We&nbsp;need&nbsp;to&nbsp;SetMaxOpenConns&nbsp;&gt;&nbsp;MaxIdleConns,&nbsp;so&nbsp;the&nbsp;DB&nbsp;can&nbsp;open</span><br>
<span class="lineno">1880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7295923">//&nbsp;a&nbsp;new&nbsp;connection&nbsp;and&nbsp;we&nbsp;can&nbsp;fill&nbsp;the&nbsp;idle&nbsp;queue&nbsp;with&nbsp;the&nbsp;released</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7295993">//&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7296010">db</span><span class="op" id="7296012">.</span><span class="ident" id="7296013">SetMaxOpenConns</span><span class="op" id="7296028">(</span><span class="builtinfunc" id="7296029">len</span><span class="op" id="7296032">(</span><span class="ident" id="7296033">rows</span><span class="op" id="7296037">)</span>&nbsp;<span class="op" id="7296039">+</span>&nbsp;<span class="num" id="7296041">1</span><span class="op" id="7296042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7296045">for</span>&nbsp;<span class="ident" id="7296049">ii</span>&nbsp;<span class="op" id="7296052">:=</span>&nbsp;<span class="keyword" id="7296055">range</span>&nbsp;<span class="ident" id="7296061">rows</span>&nbsp;<span class="op" id="7296066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7296070">r</span><span class="op" id="7296071">,</span>&nbsp;<span class="ident" id="7296073">err</span>&nbsp;<span class="op" id="7296077">:=</span>&nbsp;<span class="ident" id="7296080">db</span><span class="op" id="7296082">.</span><span class="ident" id="7296083">Query</span><span class="op" id="7296088">(</span><span class="string" id="7296089">&#34;SELECT|people|name|&#34;</span><span class="op" id="7296110">)</span><br>
<span class="lineno">1885</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7296114">if</span>&nbsp;<span class="ident" id="7296117">err</span>&nbsp;<span class="op" id="7296121">!=</span>&nbsp;<span class="ident" id="7296124">nil</span>&nbsp;<span class="op" id="7296128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7296133">t</span><span class="op" id="7296134">.</span><span class="ident" id="7296135">Fatal</span><span class="op" id="7296140">(</span><span class="ident" id="7296141">err</span><span class="op" id="7296144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7296148">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7296152">r</span><span class="op" id="7296153">.</span><span class="ident" id="7296154">Next</span><span class="op" id="7296158">(</span><span class="op" id="7296159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7296163">if</span>&nbsp;<span class="ident" id="7296166">err</span>&nbsp;<span class="op" id="7296170">:=</span>&nbsp;<span class="ident" id="7296173">r</span><span class="op" id="7296174">.</span><span class="ident" id="7296175">Err</span><span class="op" id="7296178">(</span><span class="op" id="7296179">)</span><span class="op" id="7296180">;</span>&nbsp;<span class="ident" id="7296182">err</span>&nbsp;<span class="op" id="7296186">!=</span>&nbsp;<span class="ident" id="7296189">nil</span>&nbsp;<span class="op" id="7296193">{</span><br>
<span class="lineno">1890</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7296198">t</span><span class="op" id="7296199">.</span><span class="ident" id="7296200">Fatal</span><span class="op" id="7296205">(</span><span class="ident" id="7296206">err</span><span class="op" id="7296209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7296213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7296217">rows</span><span class="op" id="7296221">[</span><span class="ident" id="7296222">ii</span><span class="op" id="7296224">]</span>&nbsp;<span class="op" id="7296226">=</span>&nbsp;<span class="ident" id="7296228">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7296231">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7296234">//&nbsp;Now&nbsp;we&nbsp;have&nbsp;defaultMaxIdleConns&nbsp;busy&nbsp;connections.&nbsp;Open</span><br>
<span class="lineno">1895</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7296293">//&nbsp;a&nbsp;new&nbsp;one,&nbsp;but&nbsp;wait&nbsp;until&nbsp;the&nbsp;busy&nbsp;connections&nbsp;are&nbsp;released</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7296357">//&nbsp;before&nbsp;returning&nbsp;control&nbsp;to&nbsp;DB.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7296393">drv</span>&nbsp;<span class="op" id="7296397">:=</span>&nbsp;<span class="ident" id="7296400">db</span><span class="op" id="7296402">.</span><span class="ident" id="7296403">driver</span><span class="op" id="7296409">.</span><span class="op" id="7296410">(</span><span class="op" id="7296411">*</span><span class="ident" id="7296412">fakeDriver</span><span class="op" id="7296422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7296425">drv</span><span class="op" id="7296428">.</span><span class="ident" id="7296429">waitCh</span>&nbsp;<span class="op" id="7296436">=</span>&nbsp;<span class="builtinfunc" id="7296438">make</span><span class="op" id="7296442">(</span><span class="keyword" id="7296443">chan</span>&nbsp;<span class="keyword" id="7296448">struct</span><span class="op" id="7296454">{</span><span class="op" id="7296455">}</span><span class="op" id="7296456">,</span>&nbsp;<span class="num" id="7296458">1</span><span class="op" id="7296459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7296462">drv</span><span class="op" id="7296465">.</span><span class="ident" id="7296466">waitingCh</span>&nbsp;<span class="op" id="7296476">=</span>&nbsp;<span class="builtinfunc" id="7296478">make</span><span class="op" id="7296482">(</span><span class="keyword" id="7296483">chan</span>&nbsp;<span class="keyword" id="7296488">struct</span><span class="op" id="7296494">{</span><span class="op" id="7296495">}</span><span class="op" id="7296496">,</span>&nbsp;<span class="num" id="7296498">1</span><span class="op" id="7296499">)</span><br>
<span class="lineno">1900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7296502">var</span>&nbsp;<span class="ident" id="7296506">wg</span>&nbsp;<span class="ident" id="7296509">sync</span><span class="op" id="7296513">.</span><span class="ident" id="7296514">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7296525">wg</span><span class="op" id="7296527">.</span><span class="ident" id="7296528">Add</span><span class="op" id="7296531">(</span><span class="num" id="7296532">1</span><span class="op" id="7296533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7296536">go</span>&nbsp;<span class="keyword" id="7296539">func</span><span class="op" id="7296543">(</span><span class="op" id="7296544">)</span>&nbsp;<span class="op" id="7296546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7296550">r</span><span class="op" id="7296551">,</span>&nbsp;<span class="ident" id="7296553">err</span>&nbsp;<span class="op" id="7296557">:=</span>&nbsp;<span class="ident" id="7296560">db</span><span class="op" id="7296562">.</span><span class="ident" id="7296563">Query</span><span class="op" id="7296568">(</span><span class="string" id="7296569">&#34;SELECT|people|name|&#34;</span><span class="op" id="7296590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7296594">if</span>&nbsp;<span class="ident" id="7296597">err</span>&nbsp;<span class="op" id="7296601">!=</span>&nbsp;<span class="ident" id="7296604">nil</span>&nbsp;<span class="op" id="7296608">{</span><br>
<span class="lineno">1905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7296613">t</span><span class="op" id="7296614">.</span><span class="ident" id="7296615">Fatal</span><span class="op" id="7296620">(</span><span class="ident" id="7296621">err</span><span class="op" id="7296624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7296628">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7296632">r</span><span class="op" id="7296633">.</span><span class="ident" id="7296634">Close</span><span class="op" id="7296639">(</span><span class="op" id="7296640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7296644">wg</span><span class="op" id="7296646">.</span><span class="ident" id="7296647">Done</span><span class="op" id="7296651">(</span><span class="op" id="7296652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7296655">}</span><span class="op" id="7296656">(</span><span class="op" id="7296657">)</span><br>
<span class="lineno">1910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7296660">//&nbsp;Wait&nbsp;until&nbsp;the&nbsp;goroutine&nbsp;we&#39;ve&nbsp;just&nbsp;created&nbsp;has&nbsp;started&nbsp;waiting.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7296729">&lt;-</span><span class="ident" id="7296731">drv</span><span class="op" id="7296734">.</span><span class="ident" id="7296735">waitingCh</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7296746">//&nbsp;Now&nbsp;close&nbsp;the&nbsp;busy&nbsp;connections.&nbsp;This&nbsp;provides&nbsp;a&nbsp;connection&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7296813">//&nbsp;the&nbsp;blocked&nbsp;goroutine&nbsp;and&nbsp;then&nbsp;fills&nbsp;up&nbsp;the&nbsp;idle&nbsp;queue.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7296873">for</span>&nbsp;<span class="ident" id="7296877">_</span><span class="op" id="7296878">,</span>&nbsp;<span class="ident" id="7296880">v</span>&nbsp;<span class="op" id="7296882">:=</span>&nbsp;<span class="keyword" id="7296885">range</span>&nbsp;<span class="ident" id="7296891">rows</span>&nbsp;<span class="op" id="7296896">{</span><br>
<span class="lineno">1915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7296900">v</span><span class="op" id="7296901">.</span><span class="ident" id="7296902">Close</span><span class="op" id="7296907">(</span><span class="op" id="7296908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7296911">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7296914">//&nbsp;At&nbsp;this&nbsp;point&nbsp;we&nbsp;give&nbsp;the&nbsp;new&nbsp;connection&nbsp;to&nbsp;DB.&nbsp;This&nbsp;connection&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7296985">//&nbsp;now&nbsp;useless,&nbsp;since&nbsp;the&nbsp;idle&nbsp;queue&nbsp;is&nbsp;full&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;pending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7297056">//&nbsp;requests.&nbsp;DB&nbsp;should&nbsp;deal&nbsp;with&nbsp;this&nbsp;situation&nbsp;without&nbsp;leaking&nbsp;the</span><br>
<span class="lineno">1920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7297125">//&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7297141">drv</span><span class="op" id="7297144">.</span><span class="ident" id="7297145">waitCh</span>&nbsp;<span class="op" id="7297152">&lt;-</span>&nbsp;<span class="keyword" id="7297155">struct</span><span class="op" id="7297161">{</span><span class="op" id="7297162">}</span><span class="op" id="7297163">{</span><span class="op" id="7297164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7297167">wg</span><span class="op" id="7297169">.</span><span class="ident" id="7297170">Wait</span><span class="op" id="7297174">(</span><span class="op" id="7297175">)</span><br>
<span class="lineno"></span><span class="op" id="7297177">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1925</span><span class="keyword" id="7297180">func</span>&nbsp;<span class="ident" id="7297185">BenchmarkConcurrentDBExec</span><span class="op" id="7297210">(</span><span class="ident" id="7297211">b</span>&nbsp;<span class="op" id="7297213">*</span><span class="ident" id="7297214">testing</span><span class="op" id="7297221">.</span><span class="ident" id="7297222">B</span><span class="op" id="7297223">)</span>&nbsp;<span class="op" id="7297225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7297228">b</span><span class="op" id="7297229">.</span><span class="ident" id="7297230">ReportAllocs</span><span class="op" id="7297242">(</span><span class="op" id="7297243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7297246">ct</span>&nbsp;<span class="op" id="7297249">:=</span>&nbsp;<span class="builtinfunc" id="7297252">new</span><span class="op" id="7297255">(</span><span class="ident" id="7297256">concurrentDBExecTest</span><span class="op" id="7297276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7297279">for</span>&nbsp;<span class="ident" id="7297283">i</span>&nbsp;<span class="op" id="7297285">:=</span>&nbsp;<span class="num" id="7297288">0</span><span class="op" id="7297289">;</span>&nbsp;<span class="ident" id="7297291">i</span>&nbsp;<span class="op" id="7297293">&lt;</span>&nbsp;<span class="ident" id="7297295">b</span><span class="op" id="7297296">.</span><span class="ident" id="7297297">N</span><span class="op" id="7297298">;</span>&nbsp;<span class="ident" id="7297300">i</span><span class="op" id="7297301">++</span>&nbsp;<span class="op" id="7297304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7297308">doConcurrentTest</span><span class="op" id="7297324">(</span><span class="ident" id="7297325">b</span><span class="op" id="7297326">,</span>&nbsp;<span class="ident" id="7297328">ct</span><span class="op" id="7297330">)</span><br>
<span class="lineno">1930</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7297333">}</span><br>
<span class="lineno"></span><span class="op" id="7297335">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7297338">func</span>&nbsp;<span class="ident" id="7297343">BenchmarkConcurrentStmtQuery</span><span class="op" id="7297371">(</span><span class="ident" id="7297372">b</span>&nbsp;<span class="op" id="7297374">*</span><span class="ident" id="7297375">testing</span><span class="op" id="7297382">.</span><span class="ident" id="7297383">B</span><span class="op" id="7297384">)</span>&nbsp;<span class="op" id="7297386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7297389">b</span><span class="op" id="7297390">.</span><span class="ident" id="7297391">ReportAllocs</span><span class="op" id="7297403">(</span><span class="op" id="7297404">)</span><br>
<span class="lineno">1935</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7297407">ct</span>&nbsp;<span class="op" id="7297410">:=</span>&nbsp;<span class="builtinfunc" id="7297413">new</span><span class="op" id="7297416">(</span><span class="ident" id="7297417">concurrentStmtQueryTest</span><span class="op" id="7297440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7297443">for</span>&nbsp;<span class="ident" id="7297447">i</span>&nbsp;<span class="op" id="7297449">:=</span>&nbsp;<span class="num" id="7297452">0</span><span class="op" id="7297453">;</span>&nbsp;<span class="ident" id="7297455">i</span>&nbsp;<span class="op" id="7297457">&lt;</span>&nbsp;<span class="ident" id="7297459">b</span><span class="op" id="7297460">.</span><span class="ident" id="7297461">N</span><span class="op" id="7297462">;</span>&nbsp;<span class="ident" id="7297464">i</span><span class="op" id="7297465">++</span>&nbsp;<span class="op" id="7297468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7297472">doConcurrentTest</span><span class="op" id="7297488">(</span><span class="ident" id="7297489">b</span><span class="op" id="7297490">,</span>&nbsp;<span class="ident" id="7297492">ct</span><span class="op" id="7297494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7297497">}</span><br>
<span class="lineno"></span><span class="op" id="7297499">}</span><br>
<span class="lineno">1940</span><br>
<span class="lineno"></span><span class="keyword" id="7297502">func</span>&nbsp;<span class="ident" id="7297507">BenchmarkConcurrentStmtExec</span><span class="op" id="7297534">(</span><span class="ident" id="7297535">b</span>&nbsp;<span class="op" id="7297537">*</span><span class="ident" id="7297538">testing</span><span class="op" id="7297545">.</span><span class="ident" id="7297546">B</span><span class="op" id="7297547">)</span>&nbsp;<span class="op" id="7297549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7297552">b</span><span class="op" id="7297553">.</span><span class="ident" id="7297554">ReportAllocs</span><span class="op" id="7297566">(</span><span class="op" id="7297567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7297570">ct</span>&nbsp;<span class="op" id="7297573">:=</span>&nbsp;<span class="builtinfunc" id="7297576">new</span><span class="op" id="7297579">(</span><span class="ident" id="7297580">concurrentStmtExecTest</span><span class="op" id="7297602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7297605">for</span>&nbsp;<span class="ident" id="7297609">i</span>&nbsp;<span class="op" id="7297611">:=</span>&nbsp;<span class="num" id="7297614">0</span><span class="op" id="7297615">;</span>&nbsp;<span class="ident" id="7297617">i</span>&nbsp;<span class="op" id="7297619">&lt;</span>&nbsp;<span class="ident" id="7297621">b</span><span class="op" id="7297622">.</span><span class="ident" id="7297623">N</span><span class="op" id="7297624">;</span>&nbsp;<span class="ident" id="7297626">i</span><span class="op" id="7297627">++</span>&nbsp;<span class="op" id="7297630">{</span><br>
<span class="lineno">1945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7297634">doConcurrentTest</span><span class="op" id="7297650">(</span><span class="ident" id="7297651">b</span><span class="op" id="7297652">,</span>&nbsp;<span class="ident" id="7297654">ct</span><span class="op" id="7297656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7297659">}</span><br>
<span class="lineno"></span><span class="op" id="7297661">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7297664">func</span>&nbsp;<span class="ident" id="7297669">BenchmarkConcurrentTxQuery</span><span class="op" id="7297695">(</span><span class="ident" id="7297696">b</span>&nbsp;<span class="op" id="7297698">*</span><span class="ident" id="7297699">testing</span><span class="op" id="7297706">.</span><span class="ident" id="7297707">B</span><span class="op" id="7297708">)</span>&nbsp;<span class="op" id="7297710">{</span><br>
<span class="lineno">1950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7297713">b</span><span class="op" id="7297714">.</span><span class="ident" id="7297715">ReportAllocs</span><span class="op" id="7297727">(</span><span class="op" id="7297728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7297731">ct</span>&nbsp;<span class="op" id="7297734">:=</span>&nbsp;<span class="builtinfunc" id="7297737">new</span><span class="op" id="7297740">(</span><span class="ident" id="7297741">concurrentTxQueryTest</span><span class="op" id="7297762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7297765">for</span>&nbsp;<span class="ident" id="7297769">i</span>&nbsp;<span class="op" id="7297771">:=</span>&nbsp;<span class="num" id="7297774">0</span><span class="op" id="7297775">;</span>&nbsp;<span class="ident" id="7297777">i</span>&nbsp;<span class="op" id="7297779">&lt;</span>&nbsp;<span class="ident" id="7297781">b</span><span class="op" id="7297782">.</span><span class="ident" id="7297783">N</span><span class="op" id="7297784">;</span>&nbsp;<span class="ident" id="7297786">i</span><span class="op" id="7297787">++</span>&nbsp;<span class="op" id="7297790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7297794">doConcurrentTest</span><span class="op" id="7297810">(</span><span class="ident" id="7297811">b</span><span class="op" id="7297812">,</span>&nbsp;<span class="ident" id="7297814">ct</span><span class="op" id="7297816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7297819">}</span><br>
<span class="lineno">1955</span><span class="op" id="7297821">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7297824">func</span>&nbsp;<span class="ident" id="7297829">BenchmarkConcurrentTxExec</span><span class="op" id="7297854">(</span><span class="ident" id="7297855">b</span>&nbsp;<span class="op" id="7297857">*</span><span class="ident" id="7297858">testing</span><span class="op" id="7297865">.</span><span class="ident" id="7297866">B</span><span class="op" id="7297867">)</span>&nbsp;<span class="op" id="7297869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7297872">b</span><span class="op" id="7297873">.</span><span class="ident" id="7297874">ReportAllocs</span><span class="op" id="7297886">(</span><span class="op" id="7297887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7297890">ct</span>&nbsp;<span class="op" id="7297893">:=</span>&nbsp;<span class="builtinfunc" id="7297896">new</span><span class="op" id="7297899">(</span><span class="ident" id="7297900">concurrentTxExecTest</span><span class="op" id="7297920">)</span><br>
<span class="lineno">1960</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7297923">for</span>&nbsp;<span class="ident" id="7297927">i</span>&nbsp;<span class="op" id="7297929">:=</span>&nbsp;<span class="num" id="7297932">0</span><span class="op" id="7297933">;</span>&nbsp;<span class="ident" id="7297935">i</span>&nbsp;<span class="op" id="7297937">&lt;</span>&nbsp;<span class="ident" id="7297939">b</span><span class="op" id="7297940">.</span><span class="ident" id="7297941">N</span><span class="op" id="7297942">;</span>&nbsp;<span class="ident" id="7297944">i</span><span class="op" id="7297945">++</span>&nbsp;<span class="op" id="7297948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7297952">doConcurrentTest</span><span class="op" id="7297968">(</span><span class="ident" id="7297969">b</span><span class="op" id="7297970">,</span>&nbsp;<span class="ident" id="7297972">ct</span><span class="op" id="7297974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7297977">}</span><br>
<span class="lineno"></span><span class="op" id="7297979">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1965</span><span class="keyword" id="7297982">func</span>&nbsp;<span class="ident" id="7297987">BenchmarkConcurrentTxStmtQuery</span><span class="op" id="7298017">(</span><span class="ident" id="7298018">b</span>&nbsp;<span class="op" id="7298020">*</span><span class="ident" id="7298021">testing</span><span class="op" id="7298028">.</span><span class="ident" id="7298029">B</span><span class="op" id="7298030">)</span>&nbsp;<span class="op" id="7298032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7298035">b</span><span class="op" id="7298036">.</span><span class="ident" id="7298037">ReportAllocs</span><span class="op" id="7298049">(</span><span class="op" id="7298050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7298053">ct</span>&nbsp;<span class="op" id="7298056">:=</span>&nbsp;<span class="builtinfunc" id="7298059">new</span><span class="op" id="7298062">(</span><span class="ident" id="7298063">concurrentTxStmtQueryTest</span><span class="op" id="7298088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7298091">for</span>&nbsp;<span class="ident" id="7298095">i</span>&nbsp;<span class="op" id="7298097">:=</span>&nbsp;<span class="num" id="7298100">0</span><span class="op" id="7298101">;</span>&nbsp;<span class="ident" id="7298103">i</span>&nbsp;<span class="op" id="7298105">&lt;</span>&nbsp;<span class="ident" id="7298107">b</span><span class="op" id="7298108">.</span><span class="ident" id="7298109">N</span><span class="op" id="7298110">;</span>&nbsp;<span class="ident" id="7298112">i</span><span class="op" id="7298113">++</span>&nbsp;<span class="op" id="7298116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7298120">doConcurrentTest</span><span class="op" id="7298136">(</span><span class="ident" id="7298137">b</span><span class="op" id="7298138">,</span>&nbsp;<span class="ident" id="7298140">ct</span><span class="op" id="7298142">)</span><br>
<span class="lineno">1970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7298145">}</span><br>
<span class="lineno"></span><span class="op" id="7298147">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7298150">func</span>&nbsp;<span class="ident" id="7298155">BenchmarkConcurrentTxStmtExec</span><span class="op" id="7298184">(</span><span class="ident" id="7298185">b</span>&nbsp;<span class="op" id="7298187">*</span><span class="ident" id="7298188">testing</span><span class="op" id="7298195">.</span><span class="ident" id="7298196">B</span><span class="op" id="7298197">)</span>&nbsp;<span class="op" id="7298199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7298202">b</span><span class="op" id="7298203">.</span><span class="ident" id="7298204">ReportAllocs</span><span class="op" id="7298216">(</span><span class="op" id="7298217">)</span><br>
<span class="lineno">1975</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7298220">ct</span>&nbsp;<span class="op" id="7298223">:=</span>&nbsp;<span class="builtinfunc" id="7298226">new</span><span class="op" id="7298229">(</span><span class="ident" id="7298230">concurrentTxStmtExecTest</span><span class="op" id="7298254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7298257">for</span>&nbsp;<span class="ident" id="7298261">i</span>&nbsp;<span class="op" id="7298263">:=</span>&nbsp;<span class="num" id="7298266">0</span><span class="op" id="7298267">;</span>&nbsp;<span class="ident" id="7298269">i</span>&nbsp;<span class="op" id="7298271">&lt;</span>&nbsp;<span class="ident" id="7298273">b</span><span class="op" id="7298274">.</span><span class="ident" id="7298275">N</span><span class="op" id="7298276">;</span>&nbsp;<span class="ident" id="7298278">i</span><span class="op" id="7298279">++</span>&nbsp;<span class="op" id="7298282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7298286">doConcurrentTest</span><span class="op" id="7298302">(</span><span class="ident" id="7298303">b</span><span class="op" id="7298304">,</span>&nbsp;<span class="ident" id="7298306">ct</span><span class="op" id="7298308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7298311">}</span><br>
<span class="lineno"></span><span class="op" id="7298313">}</span><br>
<span class="lineno">1980</span><br>
<span class="lineno"></span><span class="keyword" id="7298316">func</span>&nbsp;<span class="ident" id="7298321">BenchmarkConcurrentRandom</span><span class="op" id="7298346">(</span><span class="ident" id="7298347">b</span>&nbsp;<span class="op" id="7298349">*</span><span class="ident" id="7298350">testing</span><span class="op" id="7298357">.</span><span class="ident" id="7298358">B</span><span class="op" id="7298359">)</span>&nbsp;<span class="op" id="7298361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7298364">b</span><span class="op" id="7298365">.</span><span class="ident" id="7298366">ReportAllocs</span><span class="op" id="7298378">(</span><span class="op" id="7298379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7298382">ct</span>&nbsp;<span class="op" id="7298385">:=</span>&nbsp;<span class="builtinfunc" id="7298388">new</span><span class="op" id="7298391">(</span><span class="ident" id="7298392">concurrentRandomTest</span><span class="op" id="7298412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7298415">for</span>&nbsp;<span class="ident" id="7298419">i</span>&nbsp;<span class="op" id="7298421">:=</span>&nbsp;<span class="num" id="7298424">0</span><span class="op" id="7298425">;</span>&nbsp;<span class="ident" id="7298427">i</span>&nbsp;<span class="op" id="7298429">&lt;</span>&nbsp;<span class="ident" id="7298431">b</span><span class="op" id="7298432">.</span><span class="ident" id="7298433">N</span><span class="op" id="7298434">;</span>&nbsp;<span class="ident" id="7298436">i</span><span class="op" id="7298437">++</span>&nbsp;<span class="op" id="7298440">{</span><br>
<span class="lineno">1985</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7298444">doConcurrentTest</span><span class="op" id="7298460">(</span><span class="ident" id="7298461">b</span><span class="op" id="7298462">,</span>&nbsp;<span class="ident" id="7298464">ct</span><span class="op" id="7298466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7298469">}</span><br>
<span class="lineno"></span><span class="op" id="7298471">}</span>
</div>
</body>
</html>
