<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1609160">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1609215">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1609269">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1609320">//&nbsp;Malloc&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="1609341">//&nbsp;Patterned&nbsp;after&nbsp;tcmalloc&#39;s&nbsp;algorithms;&nbsp;shorter&nbsp;code.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1609398">package</span>&nbsp;<span class="ident" id="1609406">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="1609415">import</span>&nbsp;<span class="op" id="1609422">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1609425">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1609434">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1609437">//&nbsp;NOTE(rsc):&nbsp;Everything&nbsp;here&nbsp;could&nbsp;use&nbsp;cas&nbsp;if&nbsp;contention&nbsp;became&nbsp;an&nbsp;issue.</span><br>
<span class="lineno">15</span><span class="keyword" id="1609512">var</span>&nbsp;<span class="ident" id="1609516">proflock</span>&nbsp;<span class="ident" id="1609525">mutex</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1609532">//&nbsp;All&nbsp;memory&nbsp;allocations&nbsp;are&nbsp;local&nbsp;and&nbsp;do&nbsp;not&nbsp;escape&nbsp;outside&nbsp;of&nbsp;the&nbsp;profiler.</span><br>
<span class="lineno"></span><span class="comment" id="1609611">//&nbsp;The&nbsp;profiler&nbsp;is&nbsp;forbidden&nbsp;from&nbsp;referring&nbsp;to&nbsp;garbage-collected&nbsp;memory.</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="1609685">const</span>&nbsp;<span class="op" id="1609691">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1609694">//&nbsp;profile&nbsp;types</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609712">memProfile</span>&nbsp;<span class="ident" id="1609723">bucketType</span>&nbsp;<span class="op" id="1609734">=</span>&nbsp;<span class="num" id="1609736">1</span>&nbsp;<span class="op" id="1609738">+</span>&nbsp;<span class="ident" id="1609740">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609746">blockProfile</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1609761">//&nbsp;size&nbsp;of&nbsp;bucket&nbsp;hash&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609791">buckHashSize</span>&nbsp;<span class="op" id="1609804">=</span>&nbsp;<span class="num" id="1609806">179999</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1609815">//&nbsp;max&nbsp;depth&nbsp;of&nbsp;stack&nbsp;to&nbsp;record&nbsp;in&nbsp;bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609858">maxStack</span>&nbsp;<span class="op" id="1609867">=</span>&nbsp;<span class="num" id="1609869">32</span><br>
<span class="lineno">30</span><span class="op" id="1609872">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1609875">type</span>&nbsp;<span class="ident" id="1609880">bucketType</span>&nbsp;<span class="builtintype" id="1609891">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1609896">//&nbsp;A&nbsp;bucket&nbsp;holds&nbsp;per-call-stack&nbsp;profiling&nbsp;information.</span><br>
<span class="lineno">35</span><span class="comment" id="1609952">//&nbsp;The&nbsp;representation&nbsp;is&nbsp;a&nbsp;bit&nbsp;sleazy,&nbsp;inherited&nbsp;from&nbsp;C.</span><br>
<span class="lineno"></span><span class="comment" id="1610009">//&nbsp;This&nbsp;struct&nbsp;defines&nbsp;the&nbsp;bucket&nbsp;header.&nbsp;It&nbsp;is&nbsp;followed&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1610069">//&nbsp;memory&nbsp;by&nbsp;the&nbsp;stack&nbsp;words&nbsp;and&nbsp;then&nbsp;the&nbsp;actual&nbsp;record</span><br>
<span class="lineno"></span><span class="comment" id="1610125">//&nbsp;data,&nbsp;either&nbsp;a&nbsp;memRecord&nbsp;or&nbsp;a&nbsp;blockRecord.</span><br>
<span class="lineno"></span><span class="comment" id="1610171">//</span><br>
<span class="lineno">40</span><span class="comment" id="1610174">//&nbsp;Per-call-stack&nbsp;profiling&nbsp;information.</span><br>
<span class="lineno"></span><span class="comment" id="1610215">//&nbsp;Lookup&nbsp;by&nbsp;hashing&nbsp;call&nbsp;stack&nbsp;into&nbsp;a&nbsp;linked-list&nbsp;hash&nbsp;table.</span><br>
<span class="lineno"></span><span class="keyword" id="1610278">type</span>&nbsp;<span class="ident" id="1610283">bucket</span>&nbsp;<span class="keyword" id="1610290">struct</span>&nbsp;<span class="op" id="1610297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1610300">next</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1610308">*</span><span class="ident" id="1610309">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1610317">allnext</span>&nbsp;<span class="op" id="1610325">*</span><span class="ident" id="1610326">bucket</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1610334">typ</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610342">bucketType</span>&nbsp;<span class="comment" id="1610353">//&nbsp;memBucket&nbsp;or&nbsp;blockBucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1610382">hash</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1610390">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1610399">size</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1610407">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1610416">nstk</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1610424">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1610432">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="comment" id="1610435">//&nbsp;A&nbsp;memRecord&nbsp;is&nbsp;the&nbsp;bucket&nbsp;data&nbsp;for&nbsp;a&nbsp;bucket&nbsp;of&nbsp;type&nbsp;memProfile,</span><br>
<span class="lineno"></span><span class="comment" id="1610502">//&nbsp;part&nbsp;of&nbsp;the&nbsp;memory&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="1610533">type</span>&nbsp;<span class="ident" id="1610538">memRecord</span>&nbsp;<span class="keyword" id="1610548">struct</span>&nbsp;<span class="op" id="1610555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1610558">//&nbsp;The&nbsp;following&nbsp;complex&nbsp;3-stage&nbsp;scheme&nbsp;of&nbsp;stats&nbsp;accumulation</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1610621">//&nbsp;is&nbsp;required&nbsp;to&nbsp;obtain&nbsp;a&nbsp;consistent&nbsp;picture&nbsp;of&nbsp;mallocs&nbsp;and&nbsp;frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1610689">//&nbsp;for&nbsp;some&nbsp;point&nbsp;in&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1610717">//&nbsp;The&nbsp;problem&nbsp;is&nbsp;that&nbsp;mallocs&nbsp;come&nbsp;in&nbsp;real&nbsp;time,&nbsp;while&nbsp;frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1610780">//&nbsp;come&nbsp;only&nbsp;after&nbsp;a&nbsp;GC&nbsp;during&nbsp;concurrent&nbsp;sweeping.&nbsp;So&nbsp;if&nbsp;we&nbsp;would</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1610848">//&nbsp;naively&nbsp;count&nbsp;them,&nbsp;we&nbsp;would&nbsp;get&nbsp;a&nbsp;skew&nbsp;toward&nbsp;mallocs.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1610908">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1610912">//&nbsp;Mallocs&nbsp;are&nbsp;accounted&nbsp;in&nbsp;recent&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1610955">//&nbsp;Explicit&nbsp;frees&nbsp;are&nbsp;accounted&nbsp;in&nbsp;recent&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1611005">//&nbsp;GC&nbsp;frees&nbsp;are&nbsp;accounted&nbsp;in&nbsp;prev&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1611047">//&nbsp;After&nbsp;GC&nbsp;prev&nbsp;stats&nbsp;are&nbsp;added&nbsp;to&nbsp;final&nbsp;stats&nbsp;and</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1611100">//&nbsp;recent&nbsp;stats&nbsp;are&nbsp;moved&nbsp;into&nbsp;prev&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611144">allocs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1611156">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611165">frees</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1611177">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611186">alloc_bytes</span>&nbsp;<span class="builtintype" id="1611198">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611207">free_bytes</span>&nbsp;&nbsp;<span class="builtintype" id="1611219">uintptr</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1611229">//&nbsp;changes&nbsp;between&nbsp;next-to-last&nbsp;GC&nbsp;and&nbsp;last&nbsp;GC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611277">prev_allocs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1611294">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611303">prev_frees</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1611320">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611329">prev_alloc_bytes</span>&nbsp;<span class="builtintype" id="1611346">uintptr</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611355">prev_free_bytes</span>&nbsp;&nbsp;<span class="builtintype" id="1611372">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1611382">//&nbsp;changes&nbsp;since&nbsp;last&nbsp;GC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611408">recent_allocs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1611427">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611436">recent_frees</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1611455">uintptr</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611464">recent_alloc_bytes</span>&nbsp;<span class="builtintype" id="1611483">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611492">recent_free_bytes</span>&nbsp;&nbsp;<span class="builtintype" id="1611511">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1611519">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1611522">//&nbsp;A&nbsp;blockRecord&nbsp;is&nbsp;the&nbsp;bucket&nbsp;data&nbsp;for&nbsp;a&nbsp;bucket&nbsp;of&nbsp;type&nbsp;blockProfile,</span><br>
<span class="lineno">85</span><span class="comment" id="1611593">//&nbsp;part&nbsp;of&nbsp;the&nbsp;blocking&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="1611626">type</span>&nbsp;<span class="ident" id="1611631">blockRecord</span>&nbsp;<span class="keyword" id="1611643">struct</span>&nbsp;<span class="op" id="1611650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611653">count</span>&nbsp;&nbsp;<span class="ident" id="1611660">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611667">cycles</span>&nbsp;<span class="ident" id="1611674">int64</span><br>
<span class="lineno"></span><span class="op" id="1611680">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="1611683">var</span>&nbsp;<span class="op" id="1611687">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611690">mbuckets</span>&nbsp;&nbsp;<span class="op" id="1611700">*</span><span class="ident" id="1611701">bucket</span>&nbsp;<span class="comment" id="1611708">//&nbsp;memory&nbsp;profile&nbsp;buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611735">bbuckets</span>&nbsp;&nbsp;<span class="op" id="1611745">*</span><span class="ident" id="1611746">bucket</span>&nbsp;<span class="comment" id="1611753">//&nbsp;blocking&nbsp;profile&nbsp;buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611782">buckhash</span>&nbsp;&nbsp;<span class="op" id="1611792">*</span><span class="op" id="1611793">[</span><span class="num" id="1611794">179999</span><span class="op" id="1611800">]</span><span class="op" id="1611801">*</span><span class="ident" id="1611802">bucket</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611810">bucketmem</span>&nbsp;<span class="builtintype" id="1611820">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1611828">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1611831">//&nbsp;newBucket&nbsp;allocates&nbsp;a&nbsp;bucket&nbsp;with&nbsp;the&nbsp;given&nbsp;type&nbsp;and&nbsp;number&nbsp;of&nbsp;stack&nbsp;entries.</span><br>
<span class="lineno"></span><span class="keyword" id="1611912">func</span>&nbsp;<span class="ident" id="1611917">newBucket</span><span class="op" id="1611926">(</span><span class="ident" id="1611927">typ</span>&nbsp;<span class="ident" id="1611931">bucketType</span><span class="op" id="1611941">,</span>&nbsp;<span class="ident" id="1611943">nstk</span>&nbsp;<span class="builtintype" id="1611948">int</span><span class="op" id="1611951">)</span>&nbsp;<span class="op" id="1611953">*</span><span class="ident" id="1611954">bucket</span>&nbsp;<span class="op" id="1611961">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611964">size</span>&nbsp;<span class="op" id="1611969">:=</span>&nbsp;<span class="ident" id="1611972">unsafe</span><span class="op" id="1611978">.</span><span class="ident" id="1611979">Sizeof</span><span class="op" id="1611985">(</span><span class="ident" id="1611986">bucket</span><span class="op" id="1611992">{</span><span class="op" id="1611993">}</span><span class="op" id="1611994">)</span>&nbsp;<span class="op" id="1611996">+</span>&nbsp;<span class="builtintype" id="1611998">uintptr</span><span class="op" id="1612005">(</span><span class="ident" id="1612006">nstk</span><span class="op" id="1612010">)</span><span class="op" id="1612011">*</span><span class="ident" id="1612012">unsafe</span><span class="op" id="1612018">.</span><span class="ident" id="1612019">Sizeof</span><span class="op" id="1612025">(</span><span class="builtintype" id="1612026">uintptr</span><span class="op" id="1612033">(</span><span class="num" id="1612034">0</span><span class="op" id="1612035">)</span><span class="op" id="1612036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1612039">switch</span>&nbsp;<span class="ident" id="1612046">typ</span>&nbsp;<span class="op" id="1612050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1612053">default</span><span class="op" id="1612060">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612064">gothrow</span><span class="op" id="1612071">(</span><span class="string" id="1612072">&#34;invalid&nbsp;profile&nbsp;bucket&nbsp;type&#34;</span><span class="op" id="1612101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1612104">case</span>&nbsp;<span class="ident" id="1612109">memProfile</span><span class="op" id="1612119">:</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612123">size</span>&nbsp;<span class="op" id="1612128">+=</span>&nbsp;<span class="ident" id="1612131">unsafe</span><span class="op" id="1612137">.</span><span class="ident" id="1612138">Sizeof</span><span class="op" id="1612144">(</span><span class="ident" id="1612145">memRecord</span><span class="op" id="1612154">{</span><span class="op" id="1612155">}</span><span class="op" id="1612156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1612159">case</span>&nbsp;<span class="ident" id="1612164">blockProfile</span><span class="op" id="1612176">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612180">size</span>&nbsp;<span class="op" id="1612185">+=</span>&nbsp;<span class="ident" id="1612188">unsafe</span><span class="op" id="1612194">.</span><span class="ident" id="1612195">Sizeof</span><span class="op" id="1612201">(</span><span class="ident" id="1612202">blockRecord</span><span class="op" id="1612213">{</span><span class="op" id="1612214">}</span><span class="op" id="1612215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1612218">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612222">b</span>&nbsp;<span class="op" id="1612224">:=</span>&nbsp;<span class="op" id="1612227">(</span><span class="op" id="1612228">*</span><span class="ident" id="1612229">bucket</span><span class="op" id="1612235">)</span><span class="op" id="1612236">(</span><span class="ident" id="1612237">persistentalloc</span><span class="op" id="1612252">(</span><span class="ident" id="1612253">size</span><span class="op" id="1612257">,</span>&nbsp;<span class="num" id="1612259">0</span><span class="op" id="1612260">,</span>&nbsp;<span class="op" id="1612262">&amp;</span><span class="ident" id="1612263">memstats</span><span class="op" id="1612271">.</span><span class="ident" id="1612272">buckhash_sys</span><span class="op" id="1612284">)</span><span class="op" id="1612285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612288">bucketmem</span>&nbsp;<span class="op" id="1612298">+=</span>&nbsp;<span class="ident" id="1612301">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612307">b</span><span class="op" id="1612308">.</span><span class="ident" id="1612309">typ</span>&nbsp;<span class="op" id="1612313">=</span>&nbsp;<span class="ident" id="1612315">typ</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612320">b</span><span class="op" id="1612321">.</span><span class="ident" id="1612322">nstk</span>&nbsp;<span class="op" id="1612327">=</span>&nbsp;<span class="builtintype" id="1612329">uintptr</span><span class="op" id="1612336">(</span><span class="ident" id="1612337">nstk</span><span class="op" id="1612341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1612344">return</span>&nbsp;<span class="ident" id="1612351">b</span><br>
<span class="lineno">115</span><span class="op" id="1612353">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1612356">//&nbsp;stk&nbsp;returns&nbsp;the&nbsp;slice&nbsp;in&nbsp;b&nbsp;holding&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword" id="1612405">func</span>&nbsp;<span class="op" id="1612410">(</span><span class="ident" id="1612411">b</span>&nbsp;<span class="op" id="1612413">*</span><span class="ident" id="1612414">bucket</span><span class="op" id="1612420">)</span>&nbsp;<span class="ident" id="1612422">stk</span><span class="op" id="1612425">(</span><span class="op" id="1612426">)</span>&nbsp;<span class="op" id="1612428">[</span><span class="op" id="1612429">]</span><span class="builtintype" id="1612430">uintptr</span>&nbsp;<span class="op" id="1612438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612441">stk</span>&nbsp;<span class="op" id="1612445">:=</span>&nbsp;<span class="op" id="1612448">(</span><span class="op" id="1612449">*</span><span class="op" id="1612450">[</span><span class="ident" id="1612451">maxStack</span><span class="op" id="1612459">]</span><span class="builtintype" id="1612460">uintptr</span><span class="op" id="1612467">)</span><span class="op" id="1612468">(</span><span class="ident" id="1612469">add</span><span class="op" id="1612472">(</span><span class="ident" id="1612473">unsafe</span><span class="op" id="1612479">.</span><span class="ident" id="1612480">Pointer</span><span class="op" id="1612487">(</span><span class="ident" id="1612488">b</span><span class="op" id="1612489">)</span><span class="op" id="1612490">,</span>&nbsp;<span class="ident" id="1612492">unsafe</span><span class="op" id="1612498">.</span><span class="ident" id="1612499">Sizeof</span><span class="op" id="1612505">(</span><span class="op" id="1612506">*</span><span class="ident" id="1612507">b</span><span class="op" id="1612508">)</span><span class="op" id="1612509">)</span><span class="op" id="1612510">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1612513">return</span>&nbsp;<span class="ident" id="1612520">stk</span><span class="op" id="1612523">[</span><span class="op" id="1612524">:</span><span class="ident" id="1612525">b</span><span class="op" id="1612526">.</span><span class="ident" id="1612527">nstk</span><span class="op" id="1612531">:</span><span class="ident" id="1612532">b</span><span class="op" id="1612533">.</span><span class="ident" id="1612534">nstk</span><span class="op" id="1612538">]</span><br>
<span class="lineno"></span><span class="op" id="1612540">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1612543">//&nbsp;mp&nbsp;returns&nbsp;the&nbsp;memRecord&nbsp;associated&nbsp;with&nbsp;the&nbsp;memProfile&nbsp;bucket&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="1612612">func</span>&nbsp;<span class="op" id="1612617">(</span><span class="ident" id="1612618">b</span>&nbsp;<span class="op" id="1612620">*</span><span class="ident" id="1612621">bucket</span><span class="op" id="1612627">)</span>&nbsp;<span class="ident" id="1612629">mp</span><span class="op" id="1612631">(</span><span class="op" id="1612632">)</span>&nbsp;<span class="op" id="1612634">*</span><span class="ident" id="1612635">memRecord</span>&nbsp;<span class="op" id="1612645">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1612648">if</span>&nbsp;<span class="ident" id="1612651">b</span><span class="op" id="1612652">.</span><span class="ident" id="1612653">typ</span>&nbsp;<span class="op" id="1612657">!=</span>&nbsp;<span class="ident" id="1612660">memProfile</span>&nbsp;<span class="op" id="1612671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612675">gothrow</span><span class="op" id="1612682">(</span><span class="string" id="1612683">&#34;bad&nbsp;use&nbsp;of&nbsp;bucket.mp&#34;</span><span class="op" id="1612705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1612708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612711">data</span>&nbsp;<span class="op" id="1612716">:=</span>&nbsp;<span class="ident" id="1612719">add</span><span class="op" id="1612722">(</span><span class="ident" id="1612723">unsafe</span><span class="op" id="1612729">.</span><span class="ident" id="1612730">Pointer</span><span class="op" id="1612737">(</span><span class="ident" id="1612738">b</span><span class="op" id="1612739">)</span><span class="op" id="1612740">,</span>&nbsp;<span class="ident" id="1612742">unsafe</span><span class="op" id="1612748">.</span><span class="ident" id="1612749">Sizeof</span><span class="op" id="1612755">(</span><span class="op" id="1612756">*</span><span class="ident" id="1612757">b</span><span class="op" id="1612758">)</span><span class="op" id="1612759">+</span><span class="ident" id="1612760">b</span><span class="op" id="1612761">.</span><span class="ident" id="1612762">nstk</span><span class="op" id="1612766">*</span><span class="ident" id="1612767">unsafe</span><span class="op" id="1612773">.</span><span class="ident" id="1612774">Sizeof</span><span class="op" id="1612780">(</span><span class="builtintype" id="1612781">uintptr</span><span class="op" id="1612788">(</span><span class="num" id="1612789">0</span><span class="op" id="1612790">)</span><span class="op" id="1612791">)</span><span class="op" id="1612792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1612795">return</span>&nbsp;<span class="op" id="1612802">(</span><span class="op" id="1612803">*</span><span class="ident" id="1612804">memRecord</span><span class="op" id="1612813">)</span><span class="op" id="1612814">(</span><span class="ident" id="1612815">data</span><span class="op" id="1612819">)</span><br>
<span class="lineno">130</span><span class="op" id="1612821">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1612824">//&nbsp;bp&nbsp;returns&nbsp;the&nbsp;blockRecord&nbsp;associated&nbsp;with&nbsp;the&nbsp;blockProfile&nbsp;bucket&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="1612897">func</span>&nbsp;<span class="op" id="1612902">(</span><span class="ident" id="1612903">b</span>&nbsp;<span class="op" id="1612905">*</span><span class="ident" id="1612906">bucket</span><span class="op" id="1612912">)</span>&nbsp;<span class="ident" id="1612914">bp</span><span class="op" id="1612916">(</span><span class="op" id="1612917">)</span>&nbsp;<span class="op" id="1612919">*</span><span class="ident" id="1612920">blockRecord</span>&nbsp;<span class="op" id="1612932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1612935">if</span>&nbsp;<span class="ident" id="1612938">b</span><span class="op" id="1612939">.</span><span class="ident" id="1612940">typ</span>&nbsp;<span class="op" id="1612944">!=</span>&nbsp;<span class="ident" id="1612947">blockProfile</span>&nbsp;<span class="op" id="1612960">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612964">gothrow</span><span class="op" id="1612971">(</span><span class="string" id="1612972">&#34;bad&nbsp;use&nbsp;of&nbsp;bucket.bp&#34;</span><span class="op" id="1612994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1612997">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613000">data</span>&nbsp;<span class="op" id="1613005">:=</span>&nbsp;<span class="ident" id="1613008">add</span><span class="op" id="1613011">(</span><span class="ident" id="1613012">unsafe</span><span class="op" id="1613018">.</span><span class="ident" id="1613019">Pointer</span><span class="op" id="1613026">(</span><span class="ident" id="1613027">b</span><span class="op" id="1613028">)</span><span class="op" id="1613029">,</span>&nbsp;<span class="ident" id="1613031">unsafe</span><span class="op" id="1613037">.</span><span class="ident" id="1613038">Sizeof</span><span class="op" id="1613044">(</span><span class="op" id="1613045">*</span><span class="ident" id="1613046">b</span><span class="op" id="1613047">)</span><span class="op" id="1613048">+</span><span class="ident" id="1613049">b</span><span class="op" id="1613050">.</span><span class="ident" id="1613051">nstk</span><span class="op" id="1613055">*</span><span class="ident" id="1613056">unsafe</span><span class="op" id="1613062">.</span><span class="ident" id="1613063">Sizeof</span><span class="op" id="1613069">(</span><span class="builtintype" id="1613070">uintptr</span><span class="op" id="1613077">(</span><span class="num" id="1613078">0</span><span class="op" id="1613079">)</span><span class="op" id="1613080">)</span><span class="op" id="1613081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1613084">return</span>&nbsp;<span class="op" id="1613091">(</span><span class="op" id="1613092">*</span><span class="ident" id="1613093">blockRecord</span><span class="op" id="1613104">)</span><span class="op" id="1613105">(</span><span class="ident" id="1613106">data</span><span class="op" id="1613110">)</span><br>
<span class="lineno"></span><span class="op" id="1613112">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="comment" id="1613115">//&nbsp;Return&nbsp;the&nbsp;bucket&nbsp;for&nbsp;stk[0:nstk],&nbsp;allocating&nbsp;new&nbsp;bucket&nbsp;if&nbsp;needed.</span><br>
<span class="lineno"></span><span class="keyword" id="1613186">func</span>&nbsp;<span class="ident" id="1613191">stkbucket</span><span class="op" id="1613200">(</span><span class="ident" id="1613201">typ</span>&nbsp;<span class="ident" id="1613205">bucketType</span><span class="op" id="1613215">,</span>&nbsp;<span class="ident" id="1613217">size</span>&nbsp;<span class="builtintype" id="1613222">uintptr</span><span class="op" id="1613229">,</span>&nbsp;<span class="ident" id="1613231">stk</span>&nbsp;<span class="op" id="1613235">[</span><span class="op" id="1613236">]</span><span class="builtintype" id="1613237">uintptr</span><span class="op" id="1613244">,</span>&nbsp;<span class="ident" id="1613246">alloc</span>&nbsp;<span class="builtintype" id="1613252">bool</span><span class="op" id="1613256">)</span>&nbsp;<span class="op" id="1613258">*</span><span class="ident" id="1613259">bucket</span>&nbsp;<span class="op" id="1613266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1613269">if</span>&nbsp;<span class="ident" id="1613272">buckhash</span>&nbsp;<span class="op" id="1613281">==</span>&nbsp;<span class="ident" id="1613284">nil</span>&nbsp;<span class="op" id="1613288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613292">buckhash</span>&nbsp;<span class="op" id="1613301">=</span>&nbsp;<span class="op" id="1613303">(</span><span class="op" id="1613304">*</span><span class="op" id="1613305">[</span><span class="ident" id="1613306">buckHashSize</span><span class="op" id="1613318">]</span><span class="op" id="1613319">*</span><span class="ident" id="1613320">bucket</span><span class="op" id="1613326">)</span><span class="op" id="1613327">(</span><span class="ident" id="1613328">sysAlloc</span><span class="op" id="1613336">(</span><span class="ident" id="1613337">unsafe</span><span class="op" id="1613343">.</span><span class="ident" id="1613344">Sizeof</span><span class="op" id="1613350">(</span><span class="op" id="1613351">*</span><span class="ident" id="1613352">buckhash</span><span class="op" id="1613360">)</span><span class="op" id="1613361">,</span>&nbsp;<span class="op" id="1613363">&amp;</span><span class="ident" id="1613364">memstats</span><span class="op" id="1613372">.</span><span class="ident" id="1613373">buckhash_sys</span><span class="op" id="1613385">)</span><span class="op" id="1613386">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1613390">if</span>&nbsp;<span class="ident" id="1613393">buckhash</span>&nbsp;<span class="op" id="1613402">==</span>&nbsp;<span class="ident" id="1613405">nil</span>&nbsp;<span class="op" id="1613409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613414">gothrow</span><span class="op" id="1613421">(</span><span class="string" id="1613422">&#34;runtime:&nbsp;cannot&nbsp;allocate&nbsp;memory&#34;</span><span class="op" id="1613455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1613459">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1613462">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1613466">//&nbsp;Hash&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1613482">var</span>&nbsp;<span class="ident" id="1613486">h</span>&nbsp;<span class="builtintype" id="1613488">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1613497">for</span>&nbsp;<span class="ident" id="1613501">_</span><span class="op" id="1613502">,</span>&nbsp;<span class="ident" id="1613504">pc</span>&nbsp;<span class="op" id="1613507">:=</span>&nbsp;<span class="keyword" id="1613510">range</span>&nbsp;<span class="ident" id="1613516">stk</span>&nbsp;<span class="op" id="1613520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613524">h</span>&nbsp;<span class="op" id="1613526">+=</span>&nbsp;<span class="ident" id="1613529">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613534">h</span>&nbsp;<span class="op" id="1613536">+=</span>&nbsp;<span class="ident" id="1613539">h</span>&nbsp;<span class="op" id="1613541">&lt;&lt;</span>&nbsp;<span class="num" id="1613544">10</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613549">h</span>&nbsp;<span class="op" id="1613551">^=</span>&nbsp;<span class="ident" id="1613554">h</span>&nbsp;<span class="op" id="1613556">&gt;&gt;</span>&nbsp;<span class="num" id="1613559">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1613562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1613565">//&nbsp;hash&nbsp;in&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613582">h</span>&nbsp;<span class="op" id="1613584">+=</span>&nbsp;<span class="ident" id="1613587">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613593">h</span>&nbsp;<span class="op" id="1613595">+=</span>&nbsp;<span class="ident" id="1613598">h</span>&nbsp;<span class="op" id="1613600">&lt;&lt;</span>&nbsp;<span class="num" id="1613603">10</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613607">h</span>&nbsp;<span class="op" id="1613609">^=</span>&nbsp;<span class="ident" id="1613612">h</span>&nbsp;<span class="op" id="1613614">&gt;&gt;</span>&nbsp;<span class="num" id="1613617">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1613620">//&nbsp;finalize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613633">h</span>&nbsp;<span class="op" id="1613635">+=</span>&nbsp;<span class="ident" id="1613638">h</span>&nbsp;<span class="op" id="1613640">&lt;&lt;</span>&nbsp;<span class="num" id="1613643">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613646">h</span>&nbsp;<span class="op" id="1613648">^=</span>&nbsp;<span class="ident" id="1613651">h</span>&nbsp;<span class="op" id="1613653">&gt;&gt;</span>&nbsp;<span class="num" id="1613656">11</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613661">i</span>&nbsp;<span class="op" id="1613663">:=</span>&nbsp;<span class="builtintype" id="1613666">int</span><span class="op" id="1613669">(</span><span class="ident" id="1613670">h</span>&nbsp;<span class="op" id="1613672">%</span>&nbsp;<span class="ident" id="1613674">buckHashSize</span><span class="op" id="1613686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1613689">for</span>&nbsp;<span class="ident" id="1613693">b</span>&nbsp;<span class="op" id="1613695">:=</span>&nbsp;<span class="ident" id="1613698">buckhash</span><span class="op" id="1613706">[</span><span class="ident" id="1613707">i</span><span class="op" id="1613708">]</span><span class="op" id="1613709">;</span>&nbsp;<span class="ident" id="1613711">b</span>&nbsp;<span class="op" id="1613713">!=</span>&nbsp;<span class="ident" id="1613716">nil</span><span class="op" id="1613719">;</span>&nbsp;<span class="ident" id="1613721">b</span>&nbsp;<span class="op" id="1613723">=</span>&nbsp;<span class="ident" id="1613725">b</span><span class="op" id="1613726">.</span><span class="ident" id="1613727">next</span>&nbsp;<span class="op" id="1613732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1613736">if</span>&nbsp;<span class="ident" id="1613739">b</span><span class="op" id="1613740">.</span><span class="ident" id="1613741">typ</span>&nbsp;<span class="op" id="1613745">==</span>&nbsp;<span class="ident" id="1613748">typ</span>&nbsp;<span class="op" id="1613752">&amp;&amp;</span>&nbsp;<span class="ident" id="1613755">b</span><span class="op" id="1613756">.</span><span class="ident" id="1613757">hash</span>&nbsp;<span class="op" id="1613762">==</span>&nbsp;<span class="ident" id="1613765">h</span>&nbsp;<span class="op" id="1613767">&amp;&amp;</span>&nbsp;<span class="ident" id="1613770">b</span><span class="op" id="1613771">.</span><span class="ident" id="1613772">size</span>&nbsp;<span class="op" id="1613777">==</span>&nbsp;<span class="ident" id="1613780">size</span>&nbsp;<span class="op" id="1613785">&amp;&amp;</span>&nbsp;<span class="ident" id="1613788">eqslice</span><span class="op" id="1613795">(</span><span class="ident" id="1613796">b</span><span class="op" id="1613797">.</span><span class="ident" id="1613798">stk</span><span class="op" id="1613801">(</span><span class="op" id="1613802">)</span><span class="op" id="1613803">,</span>&nbsp;<span class="ident" id="1613805">stk</span><span class="op" id="1613808">)</span>&nbsp;<span class="op" id="1613810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1613815">return</span>&nbsp;<span class="ident" id="1613822">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1613826">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1613829">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1613833">if</span>&nbsp;<span class="op" id="1613836">!</span><span class="ident" id="1613837">alloc</span>&nbsp;<span class="op" id="1613843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1613847">return</span>&nbsp;<span class="ident" id="1613854">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1613859">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1613863">//&nbsp;Create&nbsp;new&nbsp;bucket.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613886">b</span>&nbsp;<span class="op" id="1613888">:=</span>&nbsp;<span class="ident" id="1613891">newBucket</span><span class="op" id="1613900">(</span><span class="ident" id="1613901">typ</span><span class="op" id="1613904">,</span>&nbsp;<span class="builtinfunc" id="1613906">len</span><span class="op" id="1613909">(</span><span class="ident" id="1613910">stk</span><span class="op" id="1613913">)</span><span class="op" id="1613914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1613917">copy</span><span class="op" id="1613921">(</span><span class="ident" id="1613922">b</span><span class="op" id="1613923">.</span><span class="ident" id="1613924">stk</span><span class="op" id="1613927">(</span><span class="op" id="1613928">)</span><span class="op" id="1613929">,</span>&nbsp;<span class="ident" id="1613931">stk</span><span class="op" id="1613934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613937">b</span><span class="op" id="1613938">.</span><span class="ident" id="1613939">hash</span>&nbsp;<span class="op" id="1613944">=</span>&nbsp;<span class="ident" id="1613946">h</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613949">b</span><span class="op" id="1613950">.</span><span class="ident" id="1613951">size</span>&nbsp;<span class="op" id="1613956">=</span>&nbsp;<span class="ident" id="1613958">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613964">b</span><span class="op" id="1613965">.</span><span class="ident" id="1613966">next</span>&nbsp;<span class="op" id="1613971">=</span>&nbsp;<span class="ident" id="1613973">buckhash</span><span class="op" id="1613981">[</span><span class="ident" id="1613982">i</span><span class="op" id="1613983">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613986">buckhash</span><span class="op" id="1613994">[</span><span class="ident" id="1613995">i</span><span class="op" id="1613996">]</span>&nbsp;<span class="op" id="1613998">=</span>&nbsp;<span class="ident" id="1614000">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614003">if</span>&nbsp;<span class="ident" id="1614006">typ</span>&nbsp;<span class="op" id="1614010">==</span>&nbsp;<span class="ident" id="1614013">memProfile</span>&nbsp;<span class="op" id="1614024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614028">b</span><span class="op" id="1614029">.</span><span class="ident" id="1614030">allnext</span>&nbsp;<span class="op" id="1614038">=</span>&nbsp;<span class="ident" id="1614040">mbuckets</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614051">mbuckets</span>&nbsp;<span class="op" id="1614060">=</span>&nbsp;<span class="ident" id="1614062">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1614065">}</span>&nbsp;<span class="keyword" id="1614067">else</span>&nbsp;<span class="op" id="1614072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614076">b</span><span class="op" id="1614077">.</span><span class="ident" id="1614078">allnext</span>&nbsp;<span class="op" id="1614086">=</span>&nbsp;<span class="ident" id="1614088">bbuckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614099">bbuckets</span>&nbsp;<span class="op" id="1614108">=</span>&nbsp;<span class="ident" id="1614110">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1614113">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614116">return</span>&nbsp;<span class="ident" id="1614123">b</span><br>
<span class="lineno"></span><span class="op" id="1614125">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1614128">func</span>&nbsp;<span class="ident" id="1614133">sysAlloc</span><span class="op" id="1614141">(</span><span class="ident" id="1614142">n</span>&nbsp;<span class="builtintype" id="1614144">uintptr</span><span class="op" id="1614151">,</span>&nbsp;<span class="ident" id="1614153">stat</span>&nbsp;<span class="op" id="1614158">*</span><span class="ident" id="1614159">uint64</span><span class="op" id="1614165">)</span>&nbsp;<span class="ident" id="1614167">unsafe</span><span class="op" id="1614173">.</span><span class="ident" id="1614174">Pointer</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span><span class="keyword" id="1614183">func</span>&nbsp;<span class="ident" id="1614188">eqslice</span><span class="op" id="1614195">(</span><span class="ident" id="1614196">x</span><span class="op" id="1614197">,</span>&nbsp;<span class="ident" id="1614199">y</span>&nbsp;<span class="op" id="1614201">[</span><span class="op" id="1614202">]</span><span class="builtintype" id="1614203">uintptr</span><span class="op" id="1614210">)</span>&nbsp;<span class="builtintype" id="1614212">bool</span>&nbsp;<span class="op" id="1614217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614220">if</span>&nbsp;<span class="builtinfunc" id="1614223">len</span><span class="op" id="1614226">(</span><span class="ident" id="1614227">x</span><span class="op" id="1614228">)</span>&nbsp;<span class="op" id="1614230">!=</span>&nbsp;<span class="builtinfunc" id="1614233">len</span><span class="op" id="1614236">(</span><span class="ident" id="1614237">y</span><span class="op" id="1614238">)</span>&nbsp;<span class="op" id="1614240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614244">return</span>&nbsp;<span class="builtintype" id="1614251">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1614258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614261">for</span>&nbsp;<span class="ident" id="1614265">i</span><span class="op" id="1614266">,</span>&nbsp;<span class="ident" id="1614268">xi</span>&nbsp;<span class="op" id="1614271">:=</span>&nbsp;<span class="keyword" id="1614274">range</span>&nbsp;<span class="ident" id="1614280">x</span>&nbsp;<span class="op" id="1614282">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614286">if</span>&nbsp;<span class="ident" id="1614289">xi</span>&nbsp;<span class="op" id="1614292">!=</span>&nbsp;<span class="ident" id="1614295">y</span><span class="op" id="1614296">[</span><span class="ident" id="1614297">i</span><span class="op" id="1614298">]</span>&nbsp;<span class="op" id="1614300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614305">return</span>&nbsp;<span class="builtintype" id="1614312">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1614320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1614323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614326">return</span>&nbsp;<span class="builtintype" id="1614333">true</span><br>
<span class="lineno">205</span><span class="op" id="1614338">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1614341">func</span>&nbsp;<span class="ident" id="1614346">mprof_GC</span><span class="op" id="1614354">(</span><span class="op" id="1614355">)</span>&nbsp;<span class="op" id="1614357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614360">for</span>&nbsp;<span class="ident" id="1614364">b</span>&nbsp;<span class="op" id="1614366">:=</span>&nbsp;<span class="ident" id="1614369">mbuckets</span><span class="op" id="1614377">;</span>&nbsp;<span class="ident" id="1614379">b</span>&nbsp;<span class="op" id="1614381">!=</span>&nbsp;<span class="ident" id="1614384">nil</span><span class="op" id="1614387">;</span>&nbsp;<span class="ident" id="1614389">b</span>&nbsp;<span class="op" id="1614391">=</span>&nbsp;<span class="ident" id="1614393">b</span><span class="op" id="1614394">.</span><span class="ident" id="1614395">allnext</span>&nbsp;<span class="op" id="1614403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614407">mp</span>&nbsp;<span class="op" id="1614410">:=</span>&nbsp;<span class="ident" id="1614413">b</span><span class="op" id="1614414">.</span><span class="ident" id="1614415">mp</span><span class="op" id="1614417">(</span><span class="op" id="1614418">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614422">mp</span><span class="op" id="1614424">.</span><span class="ident" id="1614425">allocs</span>&nbsp;<span class="op" id="1614432">+=</span>&nbsp;<span class="ident" id="1614435">mp</span><span class="op" id="1614437">.</span><span class="ident" id="1614438">prev_allocs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614452">mp</span><span class="op" id="1614454">.</span><span class="ident" id="1614455">frees</span>&nbsp;<span class="op" id="1614461">+=</span>&nbsp;<span class="ident" id="1614464">mp</span><span class="op" id="1614466">.</span><span class="ident" id="1614467">prev_frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614480">mp</span><span class="op" id="1614482">.</span><span class="ident" id="1614483">alloc_bytes</span>&nbsp;<span class="op" id="1614495">+=</span>&nbsp;<span class="ident" id="1614498">mp</span><span class="op" id="1614500">.</span><span class="ident" id="1614501">prev_alloc_bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614520">mp</span><span class="op" id="1614522">.</span><span class="ident" id="1614523">free_bytes</span>&nbsp;<span class="op" id="1614534">+=</span>&nbsp;<span class="ident" id="1614537">mp</span><span class="op" id="1614539">.</span><span class="ident" id="1614540">prev_free_bytes</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614559">mp</span><span class="op" id="1614561">.</span><span class="ident" id="1614562">prev_allocs</span>&nbsp;<span class="op" id="1614574">=</span>&nbsp;<span class="ident" id="1614576">mp</span><span class="op" id="1614578">.</span><span class="ident" id="1614579">recent_allocs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614595">mp</span><span class="op" id="1614597">.</span><span class="ident" id="1614598">prev_frees</span>&nbsp;<span class="op" id="1614609">=</span>&nbsp;<span class="ident" id="1614611">mp</span><span class="op" id="1614613">.</span><span class="ident" id="1614614">recent_frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614629">mp</span><span class="op" id="1614631">.</span><span class="ident" id="1614632">prev_alloc_bytes</span>&nbsp;<span class="op" id="1614649">=</span>&nbsp;<span class="ident" id="1614651">mp</span><span class="op" id="1614653">.</span><span class="ident" id="1614654">recent_alloc_bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614675">mp</span><span class="op" id="1614677">.</span><span class="ident" id="1614678">prev_free_bytes</span>&nbsp;<span class="op" id="1614694">=</span>&nbsp;<span class="ident" id="1614696">mp</span><span class="op" id="1614698">.</span><span class="ident" id="1614699">recent_free_bytes</span><br>
<span class="lineno"></span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614720">mp</span><span class="op" id="1614722">.</span><span class="ident" id="1614723">recent_allocs</span>&nbsp;<span class="op" id="1614737">=</span>&nbsp;<span class="num" id="1614739">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614743">mp</span><span class="op" id="1614745">.</span><span class="ident" id="1614746">recent_frees</span>&nbsp;<span class="op" id="1614759">=</span>&nbsp;<span class="num" id="1614761">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614765">mp</span><span class="op" id="1614767">.</span><span class="ident" id="1614768">recent_alloc_bytes</span>&nbsp;<span class="op" id="1614787">=</span>&nbsp;<span class="num" id="1614789">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614793">mp</span><span class="op" id="1614795">.</span><span class="ident" id="1614796">recent_free_bytes</span>&nbsp;<span class="op" id="1614814">=</span>&nbsp;<span class="num" id="1614816">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1614819">}</span><br>
<span class="lineno">225</span><span class="op" id="1614821">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1614824">//&nbsp;Record&nbsp;that&nbsp;a&nbsp;gc&nbsp;just&nbsp;happened:&nbsp;all&nbsp;the&nbsp;&#39;recent&#39;&nbsp;statistics&nbsp;are&nbsp;now&nbsp;real.</span><br>
<span class="lineno"></span><span class="keyword" id="1614901">func</span>&nbsp;<span class="ident" id="1614906">mProf_GC</span><span class="op" id="1614914">(</span><span class="op" id="1614915">)</span>&nbsp;<span class="op" id="1614917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614920">lock</span><span class="op" id="1614924">(</span><span class="op" id="1614925">&amp;</span><span class="ident" id="1614926">proflock</span><span class="op" id="1614934">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614937">mprof_GC</span><span class="op" id="1614945">(</span><span class="op" id="1614946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614949">unlock</span><span class="op" id="1614955">(</span><span class="op" id="1614956">&amp;</span><span class="ident" id="1614957">proflock</span><span class="op" id="1614965">)</span><br>
<span class="lineno"></span><span class="op" id="1614967">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1614970">//&nbsp;Called&nbsp;by&nbsp;malloc&nbsp;to&nbsp;record&nbsp;a&nbsp;profiled&nbsp;block.</span><br>
<span class="lineno">235</span><span class="keyword" id="1615018">func</span>&nbsp;<span class="ident" id="1615023">mProf_Malloc</span><span class="op" id="1615035">(</span><span class="ident" id="1615036">p</span>&nbsp;<span class="ident" id="1615038">unsafe</span><span class="op" id="1615044">.</span><span class="ident" id="1615045">Pointer</span><span class="op" id="1615052">,</span>&nbsp;<span class="ident" id="1615054">size</span>&nbsp;<span class="builtintype" id="1615059">uintptr</span><span class="op" id="1615066">)</span>&nbsp;<span class="op" id="1615068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1615071">var</span>&nbsp;<span class="ident" id="1615075">stk</span>&nbsp;<span class="op" id="1615079">[</span><span class="ident" id="1615080">maxStack</span><span class="op" id="1615088">]</span><span class="builtintype" id="1615089">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615098">nstk</span>&nbsp;<span class="op" id="1615103">:=</span>&nbsp;<span class="ident" id="1615106">callers</span><span class="op" id="1615113">(</span><span class="num" id="1615114">4</span><span class="op" id="1615115">,</span>&nbsp;<span class="op" id="1615117">&amp;</span><span class="ident" id="1615118">stk</span><span class="op" id="1615121">[</span><span class="num" id="1615122">0</span><span class="op" id="1615123">]</span><span class="op" id="1615124">,</span>&nbsp;<span class="builtinfunc" id="1615126">len</span><span class="op" id="1615129">(</span><span class="ident" id="1615130">stk</span><span class="op" id="1615133">)</span><span class="op" id="1615134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615137">lock</span><span class="op" id="1615141">(</span><span class="op" id="1615142">&amp;</span><span class="ident" id="1615143">proflock</span><span class="op" id="1615151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615154">b</span>&nbsp;<span class="op" id="1615156">:=</span>&nbsp;<span class="ident" id="1615159">stkbucket</span><span class="op" id="1615168">(</span><span class="ident" id="1615169">memProfile</span><span class="op" id="1615179">,</span>&nbsp;<span class="ident" id="1615181">size</span><span class="op" id="1615185">,</span>&nbsp;<span class="ident" id="1615187">stk</span><span class="op" id="1615190">[</span><span class="op" id="1615191">:</span><span class="ident" id="1615192">nstk</span><span class="op" id="1615196">]</span><span class="op" id="1615197">,</span>&nbsp;<span class="builtintype" id="1615199">true</span><span class="op" id="1615203">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615206">mp</span>&nbsp;<span class="op" id="1615209">:=</span>&nbsp;<span class="ident" id="1615212">b</span><span class="op" id="1615213">.</span><span class="ident" id="1615214">mp</span><span class="op" id="1615216">(</span><span class="op" id="1615217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615220">mp</span><span class="op" id="1615222">.</span><span class="ident" id="1615223">recent_allocs</span><span class="op" id="1615236">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615240">mp</span><span class="op" id="1615242">.</span><span class="ident" id="1615243">recent_alloc_bytes</span>&nbsp;<span class="op" id="1615262">+=</span>&nbsp;<span class="ident" id="1615265">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615271">unlock</span><span class="op" id="1615277">(</span><span class="op" id="1615278">&amp;</span><span class="ident" id="1615279">proflock</span><span class="op" id="1615287">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1615291">//&nbsp;Setprofilebucket&nbsp;locks&nbsp;a&nbsp;bunch&nbsp;of&nbsp;other&nbsp;mutexes,&nbsp;so&nbsp;we&nbsp;call&nbsp;it&nbsp;outside&nbsp;of&nbsp;proflock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1615379">//&nbsp;This&nbsp;reduces&nbsp;potential&nbsp;contention&nbsp;and&nbsp;chances&nbsp;of&nbsp;deadlocks.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1615443">//&nbsp;Since&nbsp;the&nbsp;object&nbsp;must&nbsp;be&nbsp;alive&nbsp;during&nbsp;call&nbsp;to&nbsp;mProf_Malloc,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1615507">//&nbsp;it&#39;s&nbsp;fine&nbsp;to&nbsp;do&nbsp;this&nbsp;non-atomically.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615548">setprofilebucket</span><span class="op" id="1615564">(</span><span class="ident" id="1615565">p</span><span class="op" id="1615566">,</span>&nbsp;<span class="ident" id="1615568">b</span><span class="op" id="1615569">)</span><br>
<span class="lineno">250</span><span class="op" id="1615571">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1615574">func</span>&nbsp;<span class="ident" id="1615579">setprofilebucket_m</span><span class="op" id="1615597">(</span><span class="op" id="1615598">)</span>&nbsp;<span class="comment" id="1615600">//&nbsp;mheap.c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1615612">func</span>&nbsp;<span class="ident" id="1615617">setprofilebucket</span><span class="op" id="1615633">(</span><span class="ident" id="1615634">p</span>&nbsp;<span class="ident" id="1615636">unsafe</span><span class="op" id="1615642">.</span><span class="ident" id="1615643">Pointer</span><span class="op" id="1615650">,</span>&nbsp;<span class="ident" id="1615652">b</span>&nbsp;<span class="op" id="1615654">*</span><span class="ident" id="1615655">bucket</span><span class="op" id="1615661">)</span>&nbsp;<span class="op" id="1615663">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615666">g</span>&nbsp;<span class="op" id="1615668">:=</span>&nbsp;<span class="ident" id="1615671">getg</span><span class="op" id="1615675">(</span><span class="op" id="1615676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615679">g</span><span class="op" id="1615680">.</span><span class="ident" id="1615681">m</span><span class="op" id="1615682">.</span><span class="ident" id="1615683">ptrarg</span><span class="op" id="1615689">[</span><span class="num" id="1615690">0</span><span class="op" id="1615691">]</span>&nbsp;<span class="op" id="1615693">=</span>&nbsp;<span class="ident" id="1615695">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615698">g</span><span class="op" id="1615699">.</span><span class="ident" id="1615700">m</span><span class="op" id="1615701">.</span><span class="ident" id="1615702">ptrarg</span><span class="op" id="1615708">[</span><span class="num" id="1615709">1</span><span class="op" id="1615710">]</span>&nbsp;<span class="op" id="1615712">=</span>&nbsp;<span class="ident" id="1615714">unsafe</span><span class="op" id="1615720">.</span><span class="ident" id="1615721">Pointer</span><span class="op" id="1615728">(</span><span class="ident" id="1615729">b</span><span class="op" id="1615730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615733">onM</span><span class="op" id="1615736">(</span><span class="ident" id="1615737">setprofilebucket_m</span><span class="op" id="1615755">)</span><br>
<span class="lineno"></span><span class="op" id="1615757">}</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="1615760">//&nbsp;Called&nbsp;when&nbsp;freeing&nbsp;a&nbsp;profiled&nbsp;block.</span><br>
<span class="lineno"></span><span class="keyword" id="1615801">func</span>&nbsp;<span class="ident" id="1615806">mProf_Free</span><span class="op" id="1615816">(</span><span class="ident" id="1615817">b</span>&nbsp;<span class="op" id="1615819">*</span><span class="ident" id="1615820">bucket</span><span class="op" id="1615826">,</span>&nbsp;<span class="ident" id="1615828">size</span>&nbsp;<span class="builtintype" id="1615833">uintptr</span><span class="op" id="1615840">,</span>&nbsp;<span class="ident" id="1615842">freed</span>&nbsp;<span class="builtintype" id="1615848">bool</span><span class="op" id="1615852">)</span>&nbsp;<span class="op" id="1615854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615857">lock</span><span class="op" id="1615861">(</span><span class="op" id="1615862">&amp;</span><span class="ident" id="1615863">proflock</span><span class="op" id="1615871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615874">mp</span>&nbsp;<span class="op" id="1615877">:=</span>&nbsp;<span class="ident" id="1615880">b</span><span class="op" id="1615881">.</span><span class="ident" id="1615882">mp</span><span class="op" id="1615884">(</span><span class="op" id="1615885">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1615888">if</span>&nbsp;<span class="ident" id="1615891">freed</span>&nbsp;<span class="op" id="1615897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615901">mp</span><span class="op" id="1615903">.</span><span class="ident" id="1615904">recent_frees</span><span class="op" id="1615916">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615921">mp</span><span class="op" id="1615923">.</span><span class="ident" id="1615924">recent_free_bytes</span>&nbsp;<span class="op" id="1615942">+=</span>&nbsp;<span class="ident" id="1615945">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1615951">}</span>&nbsp;<span class="keyword" id="1615953">else</span>&nbsp;<span class="op" id="1615958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615962">mp</span><span class="op" id="1615964">.</span><span class="ident" id="1615965">prev_frees</span><span class="op" id="1615975">++</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615980">mp</span><span class="op" id="1615982">.</span><span class="ident" id="1615983">prev_free_bytes</span>&nbsp;<span class="op" id="1615999">+=</span>&nbsp;<span class="ident" id="1616002">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1616008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616011">unlock</span><span class="op" id="1616017">(</span><span class="op" id="1616018">&amp;</span><span class="ident" id="1616019">proflock</span><span class="op" id="1616027">)</span><br>
<span class="lineno"></span><span class="op" id="1616029">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span><span class="keyword" id="1616032">var</span>&nbsp;<span class="ident" id="1616036">blockprofilerate</span>&nbsp;<span class="ident" id="1616053">uint64</span>&nbsp;<span class="comment" id="1616060">//&nbsp;in&nbsp;CPU&nbsp;ticks</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1616077">//&nbsp;SetBlockProfileRate&nbsp;controls&nbsp;the&nbsp;fraction&nbsp;of&nbsp;goroutine&nbsp;blocking&nbsp;events</span><br>
<span class="lineno"></span><span class="comment" id="1616151">//&nbsp;that&nbsp;are&nbsp;reported&nbsp;in&nbsp;the&nbsp;blocking&nbsp;profile.&nbsp;&nbsp;The&nbsp;profiler&nbsp;aims&nbsp;to&nbsp;sample</span><br>
<span class="lineno"></span><span class="comment" id="1616226">//&nbsp;an&nbsp;average&nbsp;of&nbsp;one&nbsp;blocking&nbsp;event&nbsp;per&nbsp;rate&nbsp;nanoseconds&nbsp;spent&nbsp;blocked.</span><br>
<span class="lineno">280</span><span class="comment" id="1616298">//</span><br>
<span class="lineno"></span><span class="comment" id="1616301">//&nbsp;To&nbsp;include&nbsp;every&nbsp;blocking&nbsp;event&nbsp;in&nbsp;the&nbsp;profile,&nbsp;pass&nbsp;rate&nbsp;=&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="1616367">//&nbsp;To&nbsp;turn&nbsp;off&nbsp;profiling&nbsp;entirely,&nbsp;pass&nbsp;rate&nbsp;&lt;=&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="1616418">func</span>&nbsp;<span class="ident" id="1616423">SetBlockProfileRate</span><span class="op" id="1616442">(</span><span class="ident" id="1616443">rate</span>&nbsp;<span class="builtintype" id="1616448">int</span><span class="op" id="1616451">)</span>&nbsp;<span class="op" id="1616453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1616456">var</span>&nbsp;<span class="ident" id="1616460">r</span>&nbsp;<span class="ident" id="1616462">int64</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1616469">if</span>&nbsp;<span class="ident" id="1616472">rate</span>&nbsp;<span class="op" id="1616477">&lt;=</span>&nbsp;<span class="num" id="1616480">0</span>&nbsp;<span class="op" id="1616482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616486">r</span>&nbsp;<span class="op" id="1616488">=</span>&nbsp;<span class="num" id="1616490">0</span>&nbsp;<span class="comment" id="1616492">//&nbsp;disable&nbsp;profiling</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1616514">}</span>&nbsp;<span class="keyword" id="1616516">else</span>&nbsp;<span class="keyword" id="1616521">if</span>&nbsp;<span class="ident" id="1616524">rate</span>&nbsp;<span class="op" id="1616529">==</span>&nbsp;<span class="num" id="1616532">1</span>&nbsp;<span class="op" id="1616534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616538">r</span>&nbsp;<span class="op" id="1616540">=</span>&nbsp;<span class="num" id="1616542">1</span>&nbsp;<span class="comment" id="1616544">//&nbsp;profile&nbsp;everything</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1616567">}</span>&nbsp;<span class="keyword" id="1616569">else</span>&nbsp;<span class="op" id="1616574">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1616578">//&nbsp;convert&nbsp;ns&nbsp;to&nbsp;cycles,&nbsp;use&nbsp;float64&nbsp;to&nbsp;prevent&nbsp;overflow&nbsp;during&nbsp;multiplication</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616659">r</span>&nbsp;<span class="op" id="1616661">=</span>&nbsp;<span class="ident" id="1616663">int64</span><span class="op" id="1616668">(</span><span class="builtintype" id="1616669">float64</span><span class="op" id="1616676">(</span><span class="ident" id="1616677">rate</span><span class="op" id="1616681">)</span>&nbsp;<span class="op" id="1616683">*</span>&nbsp;<span class="builtintype" id="1616685">float64</span><span class="op" id="1616692">(</span><span class="ident" id="1616693">tickspersecond</span><span class="op" id="1616707">(</span><span class="op" id="1616708">)</span><span class="op" id="1616709">)</span>&nbsp;<span class="op" id="1616711">/</span>&nbsp;<span class="op" id="1616713">(</span><span class="num" id="1616714">1000</span>&nbsp;<span class="op" id="1616719">*</span>&nbsp;<span class="num" id="1616721">1000</span>&nbsp;<span class="op" id="1616726">*</span>&nbsp;<span class="num" id="1616728">1000</span><span class="op" id="1616732">)</span><span class="op" id="1616733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1616737">if</span>&nbsp;<span class="ident" id="1616740">r</span>&nbsp;<span class="op" id="1616742">==</span>&nbsp;<span class="num" id="1616745">0</span>&nbsp;<span class="op" id="1616747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616752">r</span>&nbsp;<span class="op" id="1616754">=</span>&nbsp;<span class="num" id="1616756">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1616760">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1616763">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616767">atomicstore64</span><span class="op" id="1616780">(</span><span class="op" id="1616781">&amp;</span><span class="ident" id="1616782">blockprofilerate</span><span class="op" id="1616798">,</span>&nbsp;<span class="ident" id="1616800">uint64</span><span class="op" id="1616806">(</span><span class="ident" id="1616807">r</span><span class="op" id="1616808">)</span><span class="op" id="1616809">)</span><br>
<span class="lineno"></span><span class="op" id="1616811">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span><span class="keyword" id="1616814">func</span>&nbsp;<span class="ident" id="1616819">blockevent</span><span class="op" id="1616829">(</span><span class="ident" id="1616830">cycles</span>&nbsp;<span class="ident" id="1616837">int64</span><span class="op" id="1616842">,</span>&nbsp;<span class="ident" id="1616844">skip</span>&nbsp;<span class="builtintype" id="1616849">int</span><span class="op" id="1616852">)</span>&nbsp;<span class="op" id="1616854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1616857">if</span>&nbsp;<span class="ident" id="1616860">cycles</span>&nbsp;<span class="op" id="1616867">&lt;=</span>&nbsp;<span class="num" id="1616870">0</span>&nbsp;<span class="op" id="1616872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616876">cycles</span>&nbsp;<span class="op" id="1616883">=</span>&nbsp;<span class="num" id="1616885">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1616888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616891">rate</span>&nbsp;<span class="op" id="1616896">:=</span>&nbsp;<span class="ident" id="1616899">int64</span><span class="op" id="1616904">(</span><span class="ident" id="1616905">atomicload64</span><span class="op" id="1616917">(</span><span class="op" id="1616918">&amp;</span><span class="ident" id="1616919">blockprofilerate</span><span class="op" id="1616935">)</span><span class="op" id="1616936">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1616939">if</span>&nbsp;<span class="ident" id="1616942">rate</span>&nbsp;<span class="op" id="1616947">&lt;=</span>&nbsp;<span class="num" id="1616950">0</span>&nbsp;<span class="op" id="1616952">||</span>&nbsp;<span class="op" id="1616955">(</span><span class="ident" id="1616956">rate</span>&nbsp;<span class="op" id="1616961">&gt;</span>&nbsp;<span class="ident" id="1616963">cycles</span>&nbsp;<span class="op" id="1616970">&amp;&amp;</span>&nbsp;<span class="ident" id="1616973">int64</span><span class="op" id="1616978">(</span><span class="ident" id="1616979">fastrand1</span><span class="op" id="1616988">(</span><span class="op" id="1616989">)</span><span class="op" id="1616990">)</span><span class="op" id="1616991">%</span><span class="ident" id="1616992">rate</span>&nbsp;<span class="op" id="1616997">&gt;</span>&nbsp;<span class="ident" id="1616999">cycles</span><span class="op" id="1617005">)</span>&nbsp;<span class="op" id="1617007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1617011">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1617019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617022">gp</span>&nbsp;<span class="op" id="1617025">:=</span>&nbsp;<span class="ident" id="1617028">getg</span><span class="op" id="1617032">(</span><span class="op" id="1617033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1617036">var</span>&nbsp;<span class="ident" id="1617040">nstk</span>&nbsp;<span class="builtintype" id="1617045">int</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1617050">var</span>&nbsp;<span class="ident" id="1617054">stk</span>&nbsp;<span class="op" id="1617058">[</span><span class="ident" id="1617059">maxStack</span><span class="op" id="1617067">]</span><span class="builtintype" id="1617068">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1617077">if</span>&nbsp;<span class="ident" id="1617080">gp</span><span class="op" id="1617082">.</span><span class="ident" id="1617083">m</span><span class="op" id="1617084">.</span><span class="ident" id="1617085">curg</span>&nbsp;<span class="op" id="1617090">==</span>&nbsp;<span class="ident" id="1617093">nil</span>&nbsp;<span class="op" id="1617097">||</span>&nbsp;<span class="ident" id="1617100">gp</span><span class="op" id="1617102">.</span><span class="ident" id="1617103">m</span><span class="op" id="1617104">.</span><span class="ident" id="1617105">curg</span>&nbsp;<span class="op" id="1617110">==</span>&nbsp;<span class="ident" id="1617113">gp</span>&nbsp;<span class="op" id="1617116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617120">nstk</span>&nbsp;<span class="op" id="1617125">=</span>&nbsp;<span class="ident" id="1617127">callers</span><span class="op" id="1617134">(</span><span class="ident" id="1617135">skip</span><span class="op" id="1617139">,</span>&nbsp;<span class="op" id="1617141">&amp;</span><span class="ident" id="1617142">stk</span><span class="op" id="1617145">[</span><span class="num" id="1617146">0</span><span class="op" id="1617147">]</span><span class="op" id="1617148">,</span>&nbsp;<span class="builtinfunc" id="1617150">len</span><span class="op" id="1617153">(</span><span class="ident" id="1617154">stk</span><span class="op" id="1617157">)</span><span class="op" id="1617158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1617161">}</span>&nbsp;<span class="keyword" id="1617163">else</span>&nbsp;<span class="op" id="1617168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617172">nstk</span>&nbsp;<span class="op" id="1617177">=</span>&nbsp;<span class="ident" id="1617179">gcallers</span><span class="op" id="1617187">(</span><span class="ident" id="1617188">gp</span><span class="op" id="1617190">.</span><span class="ident" id="1617191">m</span><span class="op" id="1617192">.</span><span class="ident" id="1617193">curg</span><span class="op" id="1617197">,</span>&nbsp;<span class="ident" id="1617199">skip</span><span class="op" id="1617203">,</span>&nbsp;<span class="op" id="1617205">&amp;</span><span class="ident" id="1617206">stk</span><span class="op" id="1617209">[</span><span class="num" id="1617210">0</span><span class="op" id="1617211">]</span><span class="op" id="1617212">,</span>&nbsp;<span class="builtinfunc" id="1617214">len</span><span class="op" id="1617217">(</span><span class="ident" id="1617218">stk</span><span class="op" id="1617221">)</span><span class="op" id="1617222">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1617225">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617228">lock</span><span class="op" id="1617232">(</span><span class="op" id="1617233">&amp;</span><span class="ident" id="1617234">proflock</span><span class="op" id="1617242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617245">b</span>&nbsp;<span class="op" id="1617247">:=</span>&nbsp;<span class="ident" id="1617250">stkbucket</span><span class="op" id="1617259">(</span><span class="ident" id="1617260">blockProfile</span><span class="op" id="1617272">,</span>&nbsp;<span class="num" id="1617274">0</span><span class="op" id="1617275">,</span>&nbsp;<span class="ident" id="1617277">stk</span><span class="op" id="1617280">[</span><span class="op" id="1617281">:</span><span class="ident" id="1617282">nstk</span><span class="op" id="1617286">]</span><span class="op" id="1617287">,</span>&nbsp;<span class="builtintype" id="1617289">true</span><span class="op" id="1617293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617296">b</span><span class="op" id="1617297">.</span><span class="ident" id="1617298">bp</span><span class="op" id="1617300">(</span><span class="op" id="1617301">)</span><span class="op" id="1617302">.</span><span class="ident" id="1617303">count</span><span class="op" id="1617308">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617312">b</span><span class="op" id="1617313">.</span><span class="ident" id="1617314">bp</span><span class="op" id="1617316">(</span><span class="op" id="1617317">)</span><span class="op" id="1617318">.</span><span class="ident" id="1617319">cycles</span>&nbsp;<span class="op" id="1617326">+=</span>&nbsp;<span class="ident" id="1617329">cycles</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617337">unlock</span><span class="op" id="1617343">(</span><span class="op" id="1617344">&amp;</span><span class="ident" id="1617345">proflock</span><span class="op" id="1617353">)</span><br>
<span class="lineno"></span><span class="op" id="1617355">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1617358">//&nbsp;Go&nbsp;interface&nbsp;to&nbsp;profile&nbsp;data.</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span><span class="comment" id="1617392">//&nbsp;A&nbsp;StackRecord&nbsp;describes&nbsp;a&nbsp;single&nbsp;execution&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword" id="1617445">type</span>&nbsp;<span class="ident" id="1617450">StackRecord</span>&nbsp;<span class="keyword" id="1617462">struct</span>&nbsp;<span class="op" id="1617469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617472">Stack0</span>&nbsp;<span class="op" id="1617479">[</span><span class="num" id="1617480">32</span><span class="op" id="1617482">]</span><span class="builtintype" id="1617483">uintptr</span>&nbsp;<span class="comment" id="1617491">//&nbsp;stack&nbsp;trace&nbsp;for&nbsp;this&nbsp;record;&nbsp;ends&nbsp;at&nbsp;first&nbsp;0&nbsp;entry</span><br>
<span class="lineno"></span><span class="op" id="1617545">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span><span class="comment" id="1617548">//&nbsp;Stack&nbsp;returns&nbsp;the&nbsp;stack&nbsp;trace&nbsp;associated&nbsp;with&nbsp;the&nbsp;record,</span><br>
<span class="lineno"></span><span class="comment" id="1617609">//&nbsp;a&nbsp;prefix&nbsp;of&nbsp;r.Stack0.</span><br>
<span class="lineno"></span><span class="keyword" id="1617634">func</span>&nbsp;<span class="op" id="1617639">(</span><span class="ident" id="1617640">r</span>&nbsp;<span class="op" id="1617642">*</span><span class="ident" id="1617643">StackRecord</span><span class="op" id="1617654">)</span>&nbsp;<span class="ident" id="1617656">Stack</span><span class="op" id="1617661">(</span><span class="op" id="1617662">)</span>&nbsp;<span class="op" id="1617664">[</span><span class="op" id="1617665">]</span><span class="builtintype" id="1617666">uintptr</span>&nbsp;<span class="op" id="1617674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1617677">for</span>&nbsp;<span class="ident" id="1617681">i</span><span class="op" id="1617682">,</span>&nbsp;<span class="ident" id="1617684">v</span>&nbsp;<span class="op" id="1617686">:=</span>&nbsp;<span class="keyword" id="1617689">range</span>&nbsp;<span class="ident" id="1617695">r</span><span class="op" id="1617696">.</span><span class="ident" id="1617697">Stack0</span>&nbsp;<span class="op" id="1617704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1617708">if</span>&nbsp;<span class="ident" id="1617711">v</span>&nbsp;<span class="op" id="1617713">==</span>&nbsp;<span class="num" id="1617716">0</span>&nbsp;<span class="op" id="1617718">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1617723">return</span>&nbsp;<span class="ident" id="1617730">r</span><span class="op" id="1617731">.</span><span class="ident" id="1617732">Stack0</span><span class="op" id="1617738">[</span><span class="num" id="1617739">0</span><span class="op" id="1617740">:</span><span class="ident" id="1617741">i</span><span class="op" id="1617742">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1617746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1617749">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1617752">return</span>&nbsp;<span class="ident" id="1617759">r</span><span class="op" id="1617760">.</span><span class="ident" id="1617761">Stack0</span><span class="op" id="1617767">[</span><span class="num" id="1617768">0</span><span class="op" id="1617769">:</span><span class="op" id="1617770">]</span><br>
<span class="lineno"></span><span class="op" id="1617772">}</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span><span class="comment" id="1617775">//&nbsp;MemProfileRate&nbsp;controls&nbsp;the&nbsp;fraction&nbsp;of&nbsp;memory&nbsp;allocations</span><br>
<span class="lineno"></span><span class="comment" id="1617837">//&nbsp;that&nbsp;are&nbsp;recorded&nbsp;and&nbsp;reported&nbsp;in&nbsp;the&nbsp;memory&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1617894">//&nbsp;The&nbsp;profiler&nbsp;aims&nbsp;to&nbsp;sample&nbsp;an&nbsp;average&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="1617939">//&nbsp;one&nbsp;allocation&nbsp;per&nbsp;MemProfileRate&nbsp;bytes&nbsp;allocated.</span><br>
<span class="lineno">345</span><span class="comment" id="1617993">//</span><br>
<span class="lineno"></span><span class="comment" id="1617996">//&nbsp;To&nbsp;include&nbsp;every&nbsp;allocated&nbsp;block&nbsp;in&nbsp;the&nbsp;profile,&nbsp;set&nbsp;MemProfileRate&nbsp;to&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="1618073">//&nbsp;To&nbsp;turn&nbsp;off&nbsp;profiling&nbsp;entirely,&nbsp;set&nbsp;MemProfileRate&nbsp;to&nbsp;0.</span><br>
<span class="lineno"></span><span class="comment" id="1618133">//</span><br>
<span class="lineno"></span><span class="comment" id="1618136">//&nbsp;The&nbsp;tools&nbsp;that&nbsp;process&nbsp;the&nbsp;memory&nbsp;profiles&nbsp;assume&nbsp;that&nbsp;the</span><br>
<span class="lineno">350</span><span class="comment" id="1618198">//&nbsp;profile&nbsp;rate&nbsp;is&nbsp;constant&nbsp;across&nbsp;the&nbsp;lifetime&nbsp;of&nbsp;the&nbsp;program</span><br>
<span class="lineno"></span><span class="comment" id="1618261">//&nbsp;and&nbsp;equal&nbsp;to&nbsp;the&nbsp;current&nbsp;value.&nbsp;&nbsp;Programs&nbsp;that&nbsp;change&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1618322">//&nbsp;memory&nbsp;profiling&nbsp;rate&nbsp;should&nbsp;do&nbsp;so&nbsp;just&nbsp;once,&nbsp;as&nbsp;early&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="1618383">//&nbsp;possible&nbsp;in&nbsp;the&nbsp;execution&nbsp;of&nbsp;the&nbsp;program&nbsp;(for&nbsp;example,</span><br>
<span class="lineno"></span><span class="comment" id="1618441">//&nbsp;at&nbsp;the&nbsp;beginning&nbsp;of&nbsp;main).</span><br>
<span class="lineno">355</span><span class="keyword" id="1618471">var</span>&nbsp;<span class="ident" id="1618475">MemProfileRate</span>&nbsp;<span class="builtintype" id="1618490">int</span>&nbsp;<span class="op" id="1618494">=</span>&nbsp;<span class="num" id="1618496">512</span>&nbsp;<span class="op" id="1618500">*</span>&nbsp;<span class="num" id="1618502">1024</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1618508">//&nbsp;A&nbsp;MemProfileRecord&nbsp;describes&nbsp;the&nbsp;live&nbsp;objects&nbsp;allocated</span><br>
<span class="lineno"></span><span class="comment" id="1618567">//&nbsp;by&nbsp;a&nbsp;particular&nbsp;call&nbsp;sequence&nbsp;(stack&nbsp;trace).</span><br>
<span class="lineno"></span><span class="keyword" id="1618615">type</span>&nbsp;<span class="ident" id="1618620">MemProfileRecord</span>&nbsp;<span class="keyword" id="1618637">struct</span>&nbsp;<span class="op" id="1618644">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618647">AllocBytes</span><span class="op" id="1618657">,</span>&nbsp;<span class="ident" id="1618659">FreeBytes</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1618673">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1618685">//&nbsp;number&nbsp;of&nbsp;bytes&nbsp;allocated,&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618722">AllocObjects</span><span class="op" id="1618734">,</span>&nbsp;<span class="ident" id="1618736">FreeObjects</span>&nbsp;<span class="ident" id="1618748">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1618760">//&nbsp;number&nbsp;of&nbsp;objects&nbsp;allocated,&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618799">Stack0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1618825">[</span><span class="num" id="1618826">32</span><span class="op" id="1618828">]</span><span class="builtintype" id="1618829">uintptr</span>&nbsp;<span class="comment" id="1618837">//&nbsp;stack&nbsp;trace&nbsp;for&nbsp;this&nbsp;record;&nbsp;ends&nbsp;at&nbsp;first&nbsp;0&nbsp;entry</span><br>
<span class="lineno"></span><span class="op" id="1618891">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="comment" id="1618894">//&nbsp;InUseBytes&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;in&nbsp;use&nbsp;(AllocBytes&nbsp;-&nbsp;FreeBytes).</span><br>
<span class="lineno"></span><span class="keyword" id="1618969">func</span>&nbsp;<span class="op" id="1618974">(</span><span class="ident" id="1618975">r</span>&nbsp;<span class="op" id="1618977">*</span><span class="ident" id="1618978">MemProfileRecord</span><span class="op" id="1618994">)</span>&nbsp;<span class="ident" id="1618996">InUseBytes</span><span class="op" id="1619006">(</span><span class="op" id="1619007">)</span>&nbsp;<span class="ident" id="1619009">int64</span>&nbsp;<span class="op" id="1619015">{</span>&nbsp;<span class="keyword" id="1619017">return</span>&nbsp;<span class="ident" id="1619024">r</span><span class="op" id="1619025">.</span><span class="ident" id="1619026">AllocBytes</span>&nbsp;<span class="op" id="1619037">-</span>&nbsp;<span class="ident" id="1619039">r</span><span class="op" id="1619040">.</span><span class="ident" id="1619041">FreeBytes</span>&nbsp;<span class="op" id="1619051">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1619054">//&nbsp;InUseObjects&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;objects&nbsp;in&nbsp;use&nbsp;(AllocObjects&nbsp;-&nbsp;FreeObjects).</span><br>
<span class="lineno"></span><span class="keyword" id="1619137">func</span>&nbsp;<span class="op" id="1619142">(</span><span class="ident" id="1619143">r</span>&nbsp;<span class="op" id="1619145">*</span><span class="ident" id="1619146">MemProfileRecord</span><span class="op" id="1619162">)</span>&nbsp;<span class="ident" id="1619164">InUseObjects</span><span class="op" id="1619176">(</span><span class="op" id="1619177">)</span>&nbsp;<span class="ident" id="1619179">int64</span>&nbsp;<span class="op" id="1619185">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1619188">return</span>&nbsp;<span class="ident" id="1619195">r</span><span class="op" id="1619196">.</span><span class="ident" id="1619197">AllocObjects</span>&nbsp;<span class="op" id="1619210">-</span>&nbsp;<span class="ident" id="1619212">r</span><span class="op" id="1619213">.</span><span class="ident" id="1619214">FreeObjects</span><br>
<span class="lineno"></span><span class="op" id="1619226">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1619229">//&nbsp;Stack&nbsp;returns&nbsp;the&nbsp;stack&nbsp;trace&nbsp;associated&nbsp;with&nbsp;the&nbsp;record,</span><br>
<span class="lineno"></span><span class="comment" id="1619290">//&nbsp;a&nbsp;prefix&nbsp;of&nbsp;r.Stack0.</span><br>
<span class="lineno">375</span><span class="keyword" id="1619315">func</span>&nbsp;<span class="op" id="1619320">(</span><span class="ident" id="1619321">r</span>&nbsp;<span class="op" id="1619323">*</span><span class="ident" id="1619324">MemProfileRecord</span><span class="op" id="1619340">)</span>&nbsp;<span class="ident" id="1619342">Stack</span><span class="op" id="1619347">(</span><span class="op" id="1619348">)</span>&nbsp;<span class="op" id="1619350">[</span><span class="op" id="1619351">]</span><span class="builtintype" id="1619352">uintptr</span>&nbsp;<span class="op" id="1619360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1619363">for</span>&nbsp;<span class="ident" id="1619367">i</span><span class="op" id="1619368">,</span>&nbsp;<span class="ident" id="1619370">v</span>&nbsp;<span class="op" id="1619372">:=</span>&nbsp;<span class="keyword" id="1619375">range</span>&nbsp;<span class="ident" id="1619381">r</span><span class="op" id="1619382">.</span><span class="ident" id="1619383">Stack0</span>&nbsp;<span class="op" id="1619390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1619394">if</span>&nbsp;<span class="ident" id="1619397">v</span>&nbsp;<span class="op" id="1619399">==</span>&nbsp;<span class="num" id="1619402">0</span>&nbsp;<span class="op" id="1619404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1619409">return</span>&nbsp;<span class="ident" id="1619416">r</span><span class="op" id="1619417">.</span><span class="ident" id="1619418">Stack0</span><span class="op" id="1619424">[</span><span class="num" id="1619425">0</span><span class="op" id="1619426">:</span><span class="ident" id="1619427">i</span><span class="op" id="1619428">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1619432">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1619435">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1619438">return</span>&nbsp;<span class="ident" id="1619445">r</span><span class="op" id="1619446">.</span><span class="ident" id="1619447">Stack0</span><span class="op" id="1619453">[</span><span class="num" id="1619454">0</span><span class="op" id="1619455">:</span><span class="op" id="1619456">]</span><br>
<span class="lineno"></span><span class="op" id="1619458">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1619461">//&nbsp;MemProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;current&nbsp;memory&nbsp;profile.</span><br>
<span class="lineno">385</span><span class="comment" id="1619539">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;MemProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno"></span><span class="comment" id="1619616">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;MemProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1619685">//</span><br>
<span class="lineno"></span><span class="comment" id="1619688">//&nbsp;If&nbsp;inuseZero&nbsp;is&nbsp;true,&nbsp;the&nbsp;profile&nbsp;includes&nbsp;allocation&nbsp;records</span><br>
<span class="lineno"></span><span class="comment" id="1619753">//&nbsp;where&nbsp;r.AllocBytes&nbsp;&gt;&nbsp;0&nbsp;but&nbsp;r.AllocBytes&nbsp;==&nbsp;r.FreeBytes.</span><br>
<span class="lineno">390</span><span class="comment" id="1619812">//&nbsp;These&nbsp;are&nbsp;sites&nbsp;where&nbsp;memory&nbsp;was&nbsp;allocated,&nbsp;but&nbsp;it&nbsp;has&nbsp;all</span><br>
<span class="lineno"></span><span class="comment" id="1619874">//&nbsp;been&nbsp;released&nbsp;back&nbsp;to&nbsp;the&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="1619912">//</span><br>
<span class="lineno"></span><span class="comment" id="1619915">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1619971">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.memprofile&nbsp;flag&nbsp;instead</span><br>
<span class="lineno">395</span><span class="comment" id="1620026">//&nbsp;of&nbsp;calling&nbsp;MemProfile&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1620061">func</span>&nbsp;<span class="ident" id="1620066">MemProfile</span><span class="op" id="1620076">(</span><span class="ident" id="1620077">p</span>&nbsp;<span class="op" id="1620079">[</span><span class="op" id="1620080">]</span><span class="ident" id="1620081">MemProfileRecord</span><span class="op" id="1620097">,</span>&nbsp;<span class="ident" id="1620099">inuseZero</span>&nbsp;<span class="builtintype" id="1620109">bool</span><span class="op" id="1620113">)</span>&nbsp;<span class="op" id="1620115">(</span><span class="ident" id="1620116">n</span>&nbsp;<span class="builtintype" id="1620118">int</span><span class="op" id="1620121">,</span>&nbsp;<span class="ident" id="1620123">ok</span>&nbsp;<span class="builtintype" id="1620126">bool</span><span class="op" id="1620130">)</span>&nbsp;<span class="op" id="1620132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620135">lock</span><span class="op" id="1620139">(</span><span class="op" id="1620140">&amp;</span><span class="ident" id="1620141">proflock</span><span class="op" id="1620149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620152">clear</span>&nbsp;<span class="op" id="1620158">:=</span>&nbsp;<span class="builtintype" id="1620161">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620167">for</span>&nbsp;<span class="ident" id="1620171">b</span>&nbsp;<span class="op" id="1620173">:=</span>&nbsp;<span class="ident" id="1620176">mbuckets</span><span class="op" id="1620184">;</span>&nbsp;<span class="ident" id="1620186">b</span>&nbsp;<span class="op" id="1620188">!=</span>&nbsp;<span class="ident" id="1620191">nil</span><span class="op" id="1620194">;</span>&nbsp;<span class="ident" id="1620196">b</span>&nbsp;<span class="op" id="1620198">=</span>&nbsp;<span class="ident" id="1620200">b</span><span class="op" id="1620201">.</span><span class="ident" id="1620202">allnext</span>&nbsp;<span class="op" id="1620210">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620214">mp</span>&nbsp;<span class="op" id="1620217">:=</span>&nbsp;<span class="ident" id="1620220">b</span><span class="op" id="1620221">.</span><span class="ident" id="1620222">mp</span><span class="op" id="1620224">(</span><span class="op" id="1620225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620229">if</span>&nbsp;<span class="ident" id="1620232">inuseZero</span>&nbsp;<span class="op" id="1620242">||</span>&nbsp;<span class="ident" id="1620245">mp</span><span class="op" id="1620247">.</span><span class="ident" id="1620248">alloc_bytes</span>&nbsp;<span class="op" id="1620260">!=</span>&nbsp;<span class="ident" id="1620263">mp</span><span class="op" id="1620265">.</span><span class="ident" id="1620266">free_bytes</span>&nbsp;<span class="op" id="1620277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620282">n</span><span class="op" id="1620283">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620288">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620292">if</span>&nbsp;<span class="ident" id="1620295">mp</span><span class="op" id="1620297">.</span><span class="ident" id="1620298">allocs</span>&nbsp;<span class="op" id="1620305">!=</span>&nbsp;<span class="num" id="1620308">0</span>&nbsp;<span class="op" id="1620310">||</span>&nbsp;<span class="ident" id="1620313">mp</span><span class="op" id="1620315">.</span><span class="ident" id="1620316">frees</span>&nbsp;<span class="op" id="1620322">!=</span>&nbsp;<span class="num" id="1620325">0</span>&nbsp;<span class="op" id="1620327">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620332">clear</span>&nbsp;<span class="op" id="1620338">=</span>&nbsp;<span class="builtintype" id="1620340">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620351">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620354">if</span>&nbsp;<span class="ident" id="1620357">clear</span>&nbsp;<span class="op" id="1620363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1620367">//&nbsp;Absolutely&nbsp;no&nbsp;data,&nbsp;suggesting&nbsp;that&nbsp;a&nbsp;garbage&nbsp;collection</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1620429">//&nbsp;has&nbsp;not&nbsp;yet&nbsp;happened.&nbsp;In&nbsp;order&nbsp;to&nbsp;allow&nbsp;profiling&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1620489">//&nbsp;garbage&nbsp;collection&nbsp;is&nbsp;disabled&nbsp;from&nbsp;the&nbsp;beginning&nbsp;of&nbsp;execution,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1620558">//&nbsp;accumulate&nbsp;stats&nbsp;as&nbsp;if&nbsp;a&nbsp;GC&nbsp;just&nbsp;happened,&nbsp;and&nbsp;recount&nbsp;buckets.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620627">mprof_GC</span><span class="op" id="1620635">(</span><span class="op" id="1620636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620640">mprof_GC</span><span class="op" id="1620648">(</span><span class="op" id="1620649">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620653">n</span>&nbsp;<span class="op" id="1620655">=</span>&nbsp;<span class="num" id="1620657">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620661">for</span>&nbsp;<span class="ident" id="1620665">b</span>&nbsp;<span class="op" id="1620667">:=</span>&nbsp;<span class="ident" id="1620670">mbuckets</span><span class="op" id="1620678">;</span>&nbsp;<span class="ident" id="1620680">b</span>&nbsp;<span class="op" id="1620682">!=</span>&nbsp;<span class="ident" id="1620685">nil</span><span class="op" id="1620688">;</span>&nbsp;<span class="ident" id="1620690">b</span>&nbsp;<span class="op" id="1620692">=</span>&nbsp;<span class="ident" id="1620694">b</span><span class="op" id="1620695">.</span><span class="ident" id="1620696">allnext</span>&nbsp;<span class="op" id="1620704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620709">mp</span>&nbsp;<span class="op" id="1620712">:=</span>&nbsp;<span class="ident" id="1620715">b</span><span class="op" id="1620716">.</span><span class="ident" id="1620717">mp</span><span class="op" id="1620719">(</span><span class="op" id="1620720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620725">if</span>&nbsp;<span class="ident" id="1620728">inuseZero</span>&nbsp;<span class="op" id="1620738">||</span>&nbsp;<span class="ident" id="1620741">mp</span><span class="op" id="1620743">.</span><span class="ident" id="1620744">alloc_bytes</span>&nbsp;<span class="op" id="1620756">!=</span>&nbsp;<span class="ident" id="1620759">mp</span><span class="op" id="1620761">.</span><span class="ident" id="1620762">free_bytes</span>&nbsp;<span class="op" id="1620773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620779">n</span><span class="op" id="1620780">++</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620793">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620796">if</span>&nbsp;<span class="ident" id="1620799">n</span>&nbsp;<span class="op" id="1620801">&lt;=</span>&nbsp;<span class="builtinfunc" id="1620804">len</span><span class="op" id="1620807">(</span><span class="ident" id="1620808">p</span><span class="op" id="1620809">)</span>&nbsp;<span class="op" id="1620811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620815">ok</span>&nbsp;<span class="op" id="1620818">=</span>&nbsp;<span class="builtintype" id="1620820">true</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620827">idx</span>&nbsp;<span class="op" id="1620831">:=</span>&nbsp;<span class="num" id="1620834">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620838">for</span>&nbsp;<span class="ident" id="1620842">b</span>&nbsp;<span class="op" id="1620844">:=</span>&nbsp;<span class="ident" id="1620847">mbuckets</span><span class="op" id="1620855">;</span>&nbsp;<span class="ident" id="1620857">b</span>&nbsp;<span class="op" id="1620859">!=</span>&nbsp;<span class="ident" id="1620862">nil</span><span class="op" id="1620865">;</span>&nbsp;<span class="ident" id="1620867">b</span>&nbsp;<span class="op" id="1620869">=</span>&nbsp;<span class="ident" id="1620871">b</span><span class="op" id="1620872">.</span><span class="ident" id="1620873">allnext</span>&nbsp;<span class="op" id="1620881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620886">mp</span>&nbsp;<span class="op" id="1620889">:=</span>&nbsp;<span class="ident" id="1620892">b</span><span class="op" id="1620893">.</span><span class="ident" id="1620894">mp</span><span class="op" id="1620896">(</span><span class="op" id="1620897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620902">if</span>&nbsp;<span class="ident" id="1620905">inuseZero</span>&nbsp;<span class="op" id="1620915">||</span>&nbsp;<span class="ident" id="1620918">mp</span><span class="op" id="1620920">.</span><span class="ident" id="1620921">alloc_bytes</span>&nbsp;<span class="op" id="1620933">!=</span>&nbsp;<span class="ident" id="1620936">mp</span><span class="op" id="1620938">.</span><span class="ident" id="1620939">free_bytes</span>&nbsp;<span class="op" id="1620950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620956">record</span><span class="op" id="1620962">(</span><span class="op" id="1620963">&amp;</span><span class="ident" id="1620964">p</span><span class="op" id="1620965">[</span><span class="ident" id="1620966">idx</span><span class="op" id="1620969">]</span><span class="op" id="1620970">,</span>&nbsp;<span class="ident" id="1620972">b</span><span class="op" id="1620973">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620979">idx</span><span class="op" id="1620982">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620998">unlock</span><span class="op" id="1621004">(</span><span class="op" id="1621005">&amp;</span><span class="ident" id="1621006">proflock</span><span class="op" id="1621014">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1621017">return</span><br>
<span class="lineno"></span><span class="op" id="1621024">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1621027">//&nbsp;Write&nbsp;b&#39;s&nbsp;data&nbsp;to&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="1621051">func</span>&nbsp;<span class="ident" id="1621056">record</span><span class="op" id="1621062">(</span><span class="ident" id="1621063">r</span>&nbsp;<span class="op" id="1621065">*</span><span class="ident" id="1621066">MemProfileRecord</span><span class="op" id="1621082">,</span>&nbsp;<span class="ident" id="1621084">b</span>&nbsp;<span class="op" id="1621086">*</span><span class="ident" id="1621087">bucket</span><span class="op" id="1621093">)</span>&nbsp;<span class="op" id="1621095">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621098">mp</span>&nbsp;<span class="op" id="1621101">:=</span>&nbsp;<span class="ident" id="1621104">b</span><span class="op" id="1621105">.</span><span class="ident" id="1621106">mp</span><span class="op" id="1621108">(</span><span class="op" id="1621109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621112">r</span><span class="op" id="1621113">.</span><span class="ident" id="1621114">AllocBytes</span>&nbsp;<span class="op" id="1621125">=</span>&nbsp;<span class="ident" id="1621127">int64</span><span class="op" id="1621132">(</span><span class="ident" id="1621133">mp</span><span class="op" id="1621135">.</span><span class="ident" id="1621136">alloc_bytes</span><span class="op" id="1621147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621150">r</span><span class="op" id="1621151">.</span><span class="ident" id="1621152">FreeBytes</span>&nbsp;<span class="op" id="1621162">=</span>&nbsp;<span class="ident" id="1621164">int64</span><span class="op" id="1621169">(</span><span class="ident" id="1621170">mp</span><span class="op" id="1621172">.</span><span class="ident" id="1621173">free_bytes</span><span class="op" id="1621183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621186">r</span><span class="op" id="1621187">.</span><span class="ident" id="1621188">AllocObjects</span>&nbsp;<span class="op" id="1621201">=</span>&nbsp;<span class="ident" id="1621203">int64</span><span class="op" id="1621208">(</span><span class="ident" id="1621209">mp</span><span class="op" id="1621211">.</span><span class="ident" id="1621212">allocs</span><span class="op" id="1621218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621221">r</span><span class="op" id="1621222">.</span><span class="ident" id="1621223">FreeObjects</span>&nbsp;<span class="op" id="1621235">=</span>&nbsp;<span class="ident" id="1621237">int64</span><span class="op" id="1621242">(</span><span class="ident" id="1621243">mp</span><span class="op" id="1621245">.</span><span class="ident" id="1621246">frees</span><span class="op" id="1621251">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1621254">copy</span><span class="op" id="1621258">(</span><span class="ident" id="1621259">r</span><span class="op" id="1621260">.</span><span class="ident" id="1621261">Stack0</span><span class="op" id="1621267">[</span><span class="op" id="1621268">:</span><span class="op" id="1621269">]</span><span class="op" id="1621270">,</span>&nbsp;<span class="ident" id="1621272">b</span><span class="op" id="1621273">.</span><span class="ident" id="1621274">stk</span><span class="op" id="1621277">(</span><span class="op" id="1621278">)</span><span class="op" id="1621279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1621282">for</span>&nbsp;<span class="ident" id="1621286">i</span>&nbsp;<span class="op" id="1621288">:=</span>&nbsp;<span class="builtintype" id="1621291">int</span><span class="op" id="1621294">(</span><span class="ident" id="1621295">b</span><span class="op" id="1621296">.</span><span class="ident" id="1621297">nstk</span><span class="op" id="1621301">)</span><span class="op" id="1621302">;</span>&nbsp;<span class="ident" id="1621304">i</span>&nbsp;<span class="op" id="1621306">&lt;</span>&nbsp;<span class="builtinfunc" id="1621308">len</span><span class="op" id="1621311">(</span><span class="ident" id="1621312">r</span><span class="op" id="1621313">.</span><span class="ident" id="1621314">Stack0</span><span class="op" id="1621320">)</span><span class="op" id="1621321">;</span>&nbsp;<span class="ident" id="1621323">i</span><span class="op" id="1621324">++</span>&nbsp;<span class="op" id="1621327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621331">r</span><span class="op" id="1621332">.</span><span class="ident" id="1621333">Stack0</span><span class="op" id="1621339">[</span><span class="ident" id="1621340">i</span><span class="op" id="1621341">]</span>&nbsp;<span class="op" id="1621343">=</span>&nbsp;<span class="num" id="1621345">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1621348">}</span><br>
<span class="lineno"></span><span class="op" id="1621350">}</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span><span class="keyword" id="1621353">func</span>&nbsp;<span class="ident" id="1621358">iterate_memprof</span><span class="op" id="1621373">(</span><span class="ident" id="1621374">fn</span>&nbsp;<span class="keyword" id="1621377">func</span><span class="op" id="1621381">(</span><span class="op" id="1621382">*</span><span class="ident" id="1621383">bucket</span><span class="op" id="1621389">,</span>&nbsp;<span class="builtintype" id="1621391">uintptr</span><span class="op" id="1621398">,</span>&nbsp;<span class="op" id="1621400">*</span><span class="builtintype" id="1621401">uintptr</span><span class="op" id="1621408">,</span>&nbsp;<span class="builtintype" id="1621410">uintptr</span><span class="op" id="1621417">,</span>&nbsp;<span class="builtintype" id="1621419">uintptr</span><span class="op" id="1621426">,</span>&nbsp;<span class="builtintype" id="1621428">uintptr</span><span class="op" id="1621435">)</span><span class="op" id="1621436">)</span>&nbsp;<span class="op" id="1621438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621441">lock</span><span class="op" id="1621445">(</span><span class="op" id="1621446">&amp;</span><span class="ident" id="1621447">proflock</span><span class="op" id="1621455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1621458">for</span>&nbsp;<span class="ident" id="1621462">b</span>&nbsp;<span class="op" id="1621464">:=</span>&nbsp;<span class="ident" id="1621467">mbuckets</span><span class="op" id="1621475">;</span>&nbsp;<span class="ident" id="1621477">b</span>&nbsp;<span class="op" id="1621479">!=</span>&nbsp;<span class="ident" id="1621482">nil</span><span class="op" id="1621485">;</span>&nbsp;<span class="ident" id="1621487">b</span>&nbsp;<span class="op" id="1621489">=</span>&nbsp;<span class="ident" id="1621491">b</span><span class="op" id="1621492">.</span><span class="ident" id="1621493">allnext</span>&nbsp;<span class="op" id="1621501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621505">mp</span>&nbsp;<span class="op" id="1621508">:=</span>&nbsp;<span class="ident" id="1621511">b</span><span class="op" id="1621512">.</span><span class="ident" id="1621513">mp</span><span class="op" id="1621515">(</span><span class="op" id="1621516">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621520">fn</span><span class="op" id="1621522">(</span><span class="ident" id="1621523">b</span><span class="op" id="1621524">,</span>&nbsp;<span class="builtintype" id="1621526">uintptr</span><span class="op" id="1621533">(</span><span class="ident" id="1621534">b</span><span class="op" id="1621535">.</span><span class="ident" id="1621536">nstk</span><span class="op" id="1621540">)</span><span class="op" id="1621541">,</span>&nbsp;<span class="op" id="1621543">&amp;</span><span class="ident" id="1621544">b</span><span class="op" id="1621545">.</span><span class="ident" id="1621546">stk</span><span class="op" id="1621549">(</span><span class="op" id="1621550">)</span><span class="op" id="1621551">[</span><span class="num" id="1621552">0</span><span class="op" id="1621553">]</span><span class="op" id="1621554">,</span>&nbsp;<span class="ident" id="1621556">b</span><span class="op" id="1621557">.</span><span class="ident" id="1621558">size</span><span class="op" id="1621562">,</span>&nbsp;<span class="ident" id="1621564">mp</span><span class="op" id="1621566">.</span><span class="ident" id="1621567">allocs</span><span class="op" id="1621573">,</span>&nbsp;<span class="ident" id="1621575">mp</span><span class="op" id="1621577">.</span><span class="ident" id="1621578">frees</span><span class="op" id="1621583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1621586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621589">unlock</span><span class="op" id="1621595">(</span><span class="op" id="1621596">&amp;</span><span class="ident" id="1621597">proflock</span><span class="op" id="1621605">)</span><br>
<span class="lineno"></span><span class="op" id="1621607">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span><span class="comment" id="1621610">//&nbsp;BlockProfileRecord&nbsp;describes&nbsp;blocking&nbsp;events&nbsp;originated</span><br>
<span class="lineno"></span><span class="comment" id="1621669">//&nbsp;at&nbsp;a&nbsp;particular&nbsp;call&nbsp;sequence&nbsp;(stack&nbsp;trace).</span><br>
<span class="lineno"></span><span class="keyword" id="1621717">type</span>&nbsp;<span class="ident" id="1621722">BlockProfileRecord</span>&nbsp;<span class="keyword" id="1621741">struct</span>&nbsp;<span class="op" id="1621748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621751">Count</span>&nbsp;&nbsp;<span class="ident" id="1621758">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621765">Cycles</span>&nbsp;<span class="ident" id="1621772">int64</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621779">StackRecord</span><br>
<span class="lineno"></span><span class="op" id="1621791">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1621794">//&nbsp;BlockProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;current&nbsp;blocking&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1621876">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;BlockProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno">470</span><span class="comment" id="1621955">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;BlockProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1622026">//</span><br>
<span class="lineno"></span><span class="comment" id="1622029">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1622085">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.blockprofile&nbsp;flag&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1622142">//&nbsp;of&nbsp;calling&nbsp;BlockProfile&nbsp;directly.</span><br>
<span class="lineno">475</span><span class="keyword" id="1622179">func</span>&nbsp;<span class="ident" id="1622184">BlockProfile</span><span class="op" id="1622196">(</span><span class="ident" id="1622197">p</span>&nbsp;<span class="op" id="1622199">[</span><span class="op" id="1622200">]</span><span class="ident" id="1622201">BlockProfileRecord</span><span class="op" id="1622219">)</span>&nbsp;<span class="op" id="1622221">(</span><span class="ident" id="1622222">n</span>&nbsp;<span class="builtintype" id="1622224">int</span><span class="op" id="1622227">,</span>&nbsp;<span class="ident" id="1622229">ok</span>&nbsp;<span class="builtintype" id="1622232">bool</span><span class="op" id="1622236">)</span>&nbsp;<span class="op" id="1622238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622241">lock</span><span class="op" id="1622245">(</span><span class="op" id="1622246">&amp;</span><span class="ident" id="1622247">proflock</span><span class="op" id="1622255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1622258">for</span>&nbsp;<span class="ident" id="1622262">b</span>&nbsp;<span class="op" id="1622264">:=</span>&nbsp;<span class="ident" id="1622267">bbuckets</span><span class="op" id="1622275">;</span>&nbsp;<span class="ident" id="1622277">b</span>&nbsp;<span class="op" id="1622279">!=</span>&nbsp;<span class="ident" id="1622282">nil</span><span class="op" id="1622285">;</span>&nbsp;<span class="ident" id="1622287">b</span>&nbsp;<span class="op" id="1622289">=</span>&nbsp;<span class="ident" id="1622291">b</span><span class="op" id="1622292">.</span><span class="ident" id="1622293">allnext</span>&nbsp;<span class="op" id="1622301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622305">n</span><span class="op" id="1622306">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1622310">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1622313">if</span>&nbsp;<span class="ident" id="1622316">n</span>&nbsp;<span class="op" id="1622318">&lt;=</span>&nbsp;<span class="builtinfunc" id="1622321">len</span><span class="op" id="1622324">(</span><span class="ident" id="1622325">p</span><span class="op" id="1622326">)</span>&nbsp;<span class="op" id="1622328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622332">ok</span>&nbsp;<span class="op" id="1622335">=</span>&nbsp;<span class="builtintype" id="1622337">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1622344">for</span>&nbsp;<span class="ident" id="1622348">b</span>&nbsp;<span class="op" id="1622350">:=</span>&nbsp;<span class="ident" id="1622353">bbuckets</span><span class="op" id="1622361">;</span>&nbsp;<span class="ident" id="1622363">b</span>&nbsp;<span class="op" id="1622365">!=</span>&nbsp;<span class="ident" id="1622368">nil</span><span class="op" id="1622371">;</span>&nbsp;<span class="ident" id="1622373">b</span>&nbsp;<span class="op" id="1622375">=</span>&nbsp;<span class="ident" id="1622377">b</span><span class="op" id="1622378">.</span><span class="ident" id="1622379">allnext</span>&nbsp;<span class="op" id="1622387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622392">bp</span>&nbsp;<span class="op" id="1622395">:=</span>&nbsp;<span class="ident" id="1622398">b</span><span class="op" id="1622399">.</span><span class="ident" id="1622400">bp</span><span class="op" id="1622402">(</span><span class="op" id="1622403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622408">r</span>&nbsp;<span class="op" id="1622410">:=</span>&nbsp;<span class="op" id="1622413">&amp;</span><span class="ident" id="1622414">p</span><span class="op" id="1622415">[</span><span class="num" id="1622416">0</span><span class="op" id="1622417">]</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622422">r</span><span class="op" id="1622423">.</span><span class="ident" id="1622424">Count</span>&nbsp;<span class="op" id="1622430">=</span>&nbsp;<span class="ident" id="1622432">int64</span><span class="op" id="1622437">(</span><span class="ident" id="1622438">bp</span><span class="op" id="1622440">.</span><span class="ident" id="1622441">count</span><span class="op" id="1622446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622451">r</span><span class="op" id="1622452">.</span><span class="ident" id="1622453">Cycles</span>&nbsp;<span class="op" id="1622460">=</span>&nbsp;<span class="ident" id="1622462">int64</span><span class="op" id="1622467">(</span><span class="ident" id="1622468">bp</span><span class="op" id="1622470">.</span><span class="ident" id="1622471">cycles</span><span class="op" id="1622477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622482">i</span>&nbsp;<span class="op" id="1622484">:=</span>&nbsp;<span class="builtinfunc" id="1622487">copy</span><span class="op" id="1622491">(</span><span class="ident" id="1622492">r</span><span class="op" id="1622493">.</span><span class="ident" id="1622494">Stack0</span><span class="op" id="1622500">[</span><span class="op" id="1622501">:</span><span class="op" id="1622502">]</span><span class="op" id="1622503">,</span>&nbsp;<span class="ident" id="1622505">b</span><span class="op" id="1622506">.</span><span class="ident" id="1622507">stk</span><span class="op" id="1622510">(</span><span class="op" id="1622511">)</span><span class="op" id="1622512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1622517">for</span>&nbsp;<span class="op" id="1622521">;</span>&nbsp;<span class="ident" id="1622523">i</span>&nbsp;<span class="op" id="1622525">&lt;</span>&nbsp;<span class="builtinfunc" id="1622527">len</span><span class="op" id="1622530">(</span><span class="ident" id="1622531">r</span><span class="op" id="1622532">.</span><span class="ident" id="1622533">Stack0</span><span class="op" id="1622539">)</span><span class="op" id="1622540">;</span>&nbsp;<span class="ident" id="1622542">i</span><span class="op" id="1622543">++</span>&nbsp;<span class="op" id="1622546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622552">r</span><span class="op" id="1622553">.</span><span class="ident" id="1622554">Stack0</span><span class="op" id="1622560">[</span><span class="ident" id="1622561">i</span><span class="op" id="1622562">]</span>&nbsp;<span class="op" id="1622564">=</span>&nbsp;<span class="num" id="1622566">0</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1622571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622576">p</span>&nbsp;<span class="op" id="1622578">=</span>&nbsp;<span class="ident" id="1622580">p</span><span class="op" id="1622581">[</span><span class="num" id="1622582">1</span><span class="op" id="1622583">:</span><span class="op" id="1622584">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1622588">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1622591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622594">unlock</span><span class="op" id="1622600">(</span><span class="op" id="1622601">&amp;</span><span class="ident" id="1622602">proflock</span><span class="op" id="1622610">)</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1622613">return</span><br>
<span class="lineno"></span><span class="op" id="1622620">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1622623">//&nbsp;ThreadCreateProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;thread&nbsp;creation&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1622711">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;ThreadCreateProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno">500</span><span class="comment" id="1622797">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;ThreadCreateProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1622875">//</span><br>
<span class="lineno"></span><span class="comment" id="1622878">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1622939">//&nbsp;of&nbsp;calling&nbsp;ThreadCreateProfile&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1622983">func</span>&nbsp;<span class="ident" id="1622988">ThreadCreateProfile</span><span class="op" id="1623007">(</span><span class="ident" id="1623008">p</span>&nbsp;<span class="op" id="1623010">[</span><span class="op" id="1623011">]</span><span class="ident" id="1623012">StackRecord</span><span class="op" id="1623023">)</span>&nbsp;<span class="op" id="1623025">(</span><span class="ident" id="1623026">n</span>&nbsp;<span class="builtintype" id="1623028">int</span><span class="op" id="1623031">,</span>&nbsp;<span class="ident" id="1623033">ok</span>&nbsp;<span class="builtintype" id="1623036">bool</span><span class="op" id="1623040">)</span>&nbsp;<span class="op" id="1623042">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623045">first</span>&nbsp;<span class="op" id="1623051">:=</span>&nbsp;<span class="op" id="1623054">(</span><span class="op" id="1623055">*</span><span class="ident" id="1623056">m</span><span class="op" id="1623057">)</span><span class="op" id="1623058">(</span><span class="ident" id="1623059">atomicloadp</span><span class="op" id="1623070">(</span><span class="ident" id="1623071">unsafe</span><span class="op" id="1623077">.</span><span class="ident" id="1623078">Pointer</span><span class="op" id="1623085">(</span><span class="op" id="1623086">&amp;</span><span class="ident" id="1623087">allm</span><span class="op" id="1623091">)</span><span class="op" id="1623092">)</span><span class="op" id="1623093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1623096">for</span>&nbsp;<span class="ident" id="1623100">mp</span>&nbsp;<span class="op" id="1623103">:=</span>&nbsp;<span class="ident" id="1623106">first</span><span class="op" id="1623111">;</span>&nbsp;<span class="ident" id="1623113">mp</span>&nbsp;<span class="op" id="1623116">!=</span>&nbsp;<span class="ident" id="1623119">nil</span><span class="op" id="1623122">;</span>&nbsp;<span class="ident" id="1623124">mp</span>&nbsp;<span class="op" id="1623127">=</span>&nbsp;<span class="ident" id="1623129">mp</span><span class="op" id="1623131">.</span><span class="ident" id="1623132">alllink</span>&nbsp;<span class="op" id="1623140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623144">n</span><span class="op" id="1623145">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1623149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1623152">if</span>&nbsp;<span class="ident" id="1623155">n</span>&nbsp;<span class="op" id="1623157">&lt;=</span>&nbsp;<span class="builtinfunc" id="1623160">len</span><span class="op" id="1623163">(</span><span class="ident" id="1623164">p</span><span class="op" id="1623165">)</span>&nbsp;<span class="op" id="1623167">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623171">ok</span>&nbsp;<span class="op" id="1623174">=</span>&nbsp;<span class="builtintype" id="1623176">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623183">i</span>&nbsp;<span class="op" id="1623185">:=</span>&nbsp;<span class="num" id="1623188">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1623192">for</span>&nbsp;<span class="ident" id="1623196">mp</span>&nbsp;<span class="op" id="1623199">:=</span>&nbsp;<span class="ident" id="1623202">first</span><span class="op" id="1623207">;</span>&nbsp;<span class="ident" id="1623209">mp</span>&nbsp;<span class="op" id="1623212">!=</span>&nbsp;<span class="ident" id="1623215">nil</span><span class="op" id="1623218">;</span>&nbsp;<span class="ident" id="1623220">mp</span>&nbsp;<span class="op" id="1623223">=</span>&nbsp;<span class="ident" id="1623225">mp</span><span class="op" id="1623227">.</span><span class="ident" id="1623228">alllink</span>&nbsp;<span class="op" id="1623236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1623241">for</span>&nbsp;<span class="ident" id="1623245">s</span>&nbsp;<span class="op" id="1623247">:=</span>&nbsp;<span class="keyword" id="1623250">range</span>&nbsp;<span class="ident" id="1623256">mp</span><span class="op" id="1623258">.</span><span class="ident" id="1623259">createstack</span>&nbsp;<span class="op" id="1623271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623277">p</span><span class="op" id="1623278">[</span><span class="ident" id="1623279">i</span><span class="op" id="1623280">]</span><span class="op" id="1623281">.</span><span class="ident" id="1623282">Stack0</span><span class="op" id="1623288">[</span><span class="ident" id="1623289">s</span><span class="op" id="1623290">]</span>&nbsp;<span class="op" id="1623292">=</span>&nbsp;<span class="builtintype" id="1623294">uintptr</span><span class="op" id="1623301">(</span><span class="ident" id="1623302">mp</span><span class="op" id="1623304">.</span><span class="ident" id="1623305">createstack</span><span class="op" id="1623316">[</span><span class="ident" id="1623317">s</span><span class="op" id="1623318">]</span><span class="op" id="1623319">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1623324">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623329">i</span><span class="op" id="1623330">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1623335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1623338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1623341">return</span><br>
<span class="lineno">520</span><span class="op" id="1623348">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1623351">var</span>&nbsp;<span class="ident" id="1623355">allgs</span>&nbsp;<span class="op" id="1623361">[</span><span class="op" id="1623362">]</span><span class="op" id="1623363">*</span><span class="ident" id="1623364">g</span>&nbsp;<span class="comment" id="1623366">//&nbsp;proc.c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1623377">//&nbsp;GoroutineProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;active&nbsp;goroutine&nbsp;stack&nbsp;profile.</span><br>
<span class="lineno">525</span><span class="comment" id="1623469">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;GoroutineProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno"></span><span class="comment" id="1623552">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;GoroutineProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1623627">//</span><br>
<span class="lineno"></span><span class="comment" id="1623630">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1623691">//&nbsp;of&nbsp;calling&nbsp;GoroutineProfile&nbsp;directly.</span><br>
<span class="lineno">530</span><span class="keyword" id="1623732">func</span>&nbsp;<span class="ident" id="1623737">GoroutineProfile</span><span class="op" id="1623753">(</span><span class="ident" id="1623754">p</span>&nbsp;<span class="op" id="1623756">[</span><span class="op" id="1623757">]</span><span class="ident" id="1623758">StackRecord</span><span class="op" id="1623769">)</span>&nbsp;<span class="op" id="1623771">(</span><span class="ident" id="1623772">n</span>&nbsp;<span class="builtintype" id="1623774">int</span><span class="op" id="1623777">,</span>&nbsp;<span class="ident" id="1623779">ok</span>&nbsp;<span class="builtintype" id="1623782">bool</span><span class="op" id="1623786">)</span>&nbsp;<span class="op" id="1623788">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623792">n</span>&nbsp;<span class="op" id="1623794">=</span>&nbsp;<span class="ident" id="1623796">NumGoroutine</span><span class="op" id="1623808">(</span><span class="op" id="1623809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1623812">if</span>&nbsp;<span class="ident" id="1623815">n</span>&nbsp;<span class="op" id="1623817">&lt;=</span>&nbsp;<span class="builtinfunc" id="1623820">len</span><span class="op" id="1623823">(</span><span class="ident" id="1623824">p</span><span class="op" id="1623825">)</span>&nbsp;<span class="op" id="1623827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623831">gp</span>&nbsp;<span class="op" id="1623834">:=</span>&nbsp;<span class="ident" id="1623837">getg</span><span class="op" id="1623841">(</span><span class="op" id="1623842">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623846">semacquire</span><span class="op" id="1623856">(</span><span class="op" id="1623857">&amp;</span><span class="ident" id="1623858">worldsema</span><span class="op" id="1623867">,</span>&nbsp;<span class="builtintype" id="1623869">false</span><span class="op" id="1623874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623878">gp</span><span class="op" id="1623880">.</span><span class="ident" id="1623881">m</span><span class="op" id="1623882">.</span><span class="ident" id="1623883">gcing</span>&nbsp;<span class="op" id="1623889">=</span>&nbsp;<span class="num" id="1623891">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623895">onM</span><span class="op" id="1623898">(</span><span class="ident" id="1623899">stoptheworld</span><span class="op" id="1623911">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623916">n</span>&nbsp;<span class="op" id="1623918">=</span>&nbsp;<span class="ident" id="1623920">NumGoroutine</span><span class="op" id="1623932">(</span><span class="op" id="1623933">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1623937">if</span>&nbsp;<span class="ident" id="1623940">n</span>&nbsp;<span class="op" id="1623942">&lt;=</span>&nbsp;<span class="builtinfunc" id="1623945">len</span><span class="op" id="1623948">(</span><span class="ident" id="1623949">p</span><span class="op" id="1623950">)</span>&nbsp;<span class="op" id="1623952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623957">ok</span>&nbsp;<span class="op" id="1623960">=</span>&nbsp;<span class="builtintype" id="1623962">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623970">r</span>&nbsp;<span class="op" id="1623972">:=</span>&nbsp;<span class="ident" id="1623975">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623980">sp</span>&nbsp;<span class="op" id="1623983">:=</span>&nbsp;<span class="ident" id="1623986">getcallersp</span><span class="op" id="1623997">(</span><span class="ident" id="1623998">unsafe</span><span class="op" id="1624004">.</span><span class="ident" id="1624005">Pointer</span><span class="op" id="1624012">(</span><span class="op" id="1624013">&amp;</span><span class="ident" id="1624014">p</span><span class="op" id="1624015">)</span><span class="op" id="1624016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624021">pc</span>&nbsp;<span class="op" id="1624024">:=</span>&nbsp;<span class="ident" id="1624027">getcallerpc</span><span class="op" id="1624038">(</span><span class="ident" id="1624039">unsafe</span><span class="op" id="1624045">.</span><span class="ident" id="1624046">Pointer</span><span class="op" id="1624053">(</span><span class="op" id="1624054">&amp;</span><span class="ident" id="1624055">p</span><span class="op" id="1624056">)</span><span class="op" id="1624057">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624062">onM</span><span class="op" id="1624065">(</span><span class="keyword" id="1624066">func</span><span class="op" id="1624070">(</span><span class="op" id="1624071">)</span>&nbsp;<span class="op" id="1624073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624079">saveg</span><span class="op" id="1624084">(</span><span class="ident" id="1624085">pc</span><span class="op" id="1624087">,</span>&nbsp;<span class="ident" id="1624089">sp</span><span class="op" id="1624091">,</span>&nbsp;<span class="ident" id="1624093">gp</span><span class="op" id="1624095">,</span>&nbsp;<span class="op" id="1624097">&amp;</span><span class="ident" id="1624098">r</span><span class="op" id="1624099">[</span><span class="num" id="1624100">0</span><span class="op" id="1624101">]</span><span class="op" id="1624102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1624107">}</span><span class="op" id="1624108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624113">r</span>&nbsp;<span class="op" id="1624115">=</span>&nbsp;<span class="ident" id="1624117">r</span><span class="op" id="1624118">[</span><span class="num" id="1624119">1</span><span class="op" id="1624120">:</span><span class="op" id="1624121">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1624126">for</span>&nbsp;<span class="ident" id="1624130">_</span><span class="op" id="1624131">,</span>&nbsp;<span class="ident" id="1624133">gp1</span>&nbsp;<span class="op" id="1624137">:=</span>&nbsp;<span class="keyword" id="1624140">range</span>&nbsp;<span class="ident" id="1624146">allgs</span>&nbsp;<span class="op" id="1624152">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1624158">if</span>&nbsp;<span class="ident" id="1624161">gp1</span>&nbsp;<span class="op" id="1624165">==</span>&nbsp;<span class="ident" id="1624168">gp</span>&nbsp;<span class="op" id="1624171">||</span>&nbsp;<span class="ident" id="1624174">readgstatus</span><span class="op" id="1624185">(</span><span class="ident" id="1624186">gp1</span><span class="op" id="1624189">)</span>&nbsp;<span class="op" id="1624191">==</span>&nbsp;<span class="ident" id="1624194">_Gdead</span>&nbsp;<span class="op" id="1624201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1624208">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1624221">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624227">saveg</span><span class="op" id="1624232">(</span><span class="op" id="1624233">^</span><span class="builtintype" id="1624234">uintptr</span><span class="op" id="1624241">(</span><span class="num" id="1624242">0</span><span class="op" id="1624243">)</span><span class="op" id="1624244">,</span>&nbsp;<span class="op" id="1624246">^</span><span class="builtintype" id="1624247">uintptr</span><span class="op" id="1624254">(</span><span class="num" id="1624255">0</span><span class="op" id="1624256">)</span><span class="op" id="1624257">,</span>&nbsp;<span class="ident" id="1624259">gp1</span><span class="op" id="1624262">,</span>&nbsp;<span class="op" id="1624264">&amp;</span><span class="ident" id="1624265">r</span><span class="op" id="1624266">[</span><span class="num" id="1624267">0</span><span class="op" id="1624268">]</span><span class="op" id="1624269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624275">r</span>&nbsp;<span class="op" id="1624277">=</span>&nbsp;<span class="ident" id="1624279">r</span><span class="op" id="1624280">[</span><span class="num" id="1624281">1</span><span class="op" id="1624282">:</span><span class="op" id="1624283">]</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1624288">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1624292">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624297">gp</span><span class="op" id="1624299">.</span><span class="ident" id="1624300">m</span><span class="op" id="1624301">.</span><span class="ident" id="1624302">gcing</span>&nbsp;<span class="op" id="1624308">=</span>&nbsp;<span class="num" id="1624310">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624314">semrelease</span><span class="op" id="1624324">(</span><span class="op" id="1624325">&amp;</span><span class="ident" id="1624326">worldsema</span><span class="op" id="1624335">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624339">onM</span><span class="op" id="1624342">(</span><span class="ident" id="1624343">starttheworld</span><span class="op" id="1624356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1624359">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1624363">return</span>&nbsp;<span class="ident" id="1624370">n</span><span class="op" id="1624371">,</span>&nbsp;<span class="ident" id="1624373">ok</span><br>
<span class="lineno"></span><span class="op" id="1624376">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span><span class="keyword" id="1624379">func</span>&nbsp;<span class="ident" id="1624384">saveg</span><span class="op" id="1624389">(</span><span class="ident" id="1624390">pc</span><span class="op" id="1624392">,</span>&nbsp;<span class="ident" id="1624394">sp</span>&nbsp;<span class="builtintype" id="1624397">uintptr</span><span class="op" id="1624404">,</span>&nbsp;<span class="ident" id="1624406">gp</span>&nbsp;<span class="op" id="1624409">*</span><span class="ident" id="1624410">g</span><span class="op" id="1624411">,</span>&nbsp;<span class="ident" id="1624413">r</span>&nbsp;<span class="op" id="1624415">*</span><span class="ident" id="1624416">StackRecord</span><span class="op" id="1624427">)</span>&nbsp;<span class="op" id="1624429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624432">n</span>&nbsp;<span class="op" id="1624434">:=</span>&nbsp;<span class="ident" id="1624437">gentraceback</span><span class="op" id="1624449">(</span><span class="ident" id="1624450">pc</span><span class="op" id="1624452">,</span>&nbsp;<span class="ident" id="1624454">sp</span><span class="op" id="1624456">,</span>&nbsp;<span class="num" id="1624458">0</span><span class="op" id="1624459">,</span>&nbsp;<span class="ident" id="1624461">gp</span><span class="op" id="1624463">,</span>&nbsp;<span class="num" id="1624465">0</span><span class="op" id="1624466">,</span>&nbsp;<span class="op" id="1624468">&amp;</span><span class="ident" id="1624469">r</span><span class="op" id="1624470">.</span><span class="ident" id="1624471">Stack0</span><span class="op" id="1624477">[</span><span class="num" id="1624478">0</span><span class="op" id="1624479">]</span><span class="op" id="1624480">,</span>&nbsp;<span class="builtinfunc" id="1624482">len</span><span class="op" id="1624485">(</span><span class="ident" id="1624486">r</span><span class="op" id="1624487">.</span><span class="ident" id="1624488">Stack0</span><span class="op" id="1624494">)</span><span class="op" id="1624495">,</span>&nbsp;<span class="ident" id="1624497">nil</span><span class="op" id="1624500">,</span>&nbsp;<span class="ident" id="1624502">nil</span><span class="op" id="1624505">,</span>&nbsp;<span class="num" id="1624507">0</span><span class="op" id="1624508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1624511">if</span>&nbsp;<span class="ident" id="1624514">n</span>&nbsp;<span class="op" id="1624516">&lt;</span>&nbsp;<span class="builtinfunc" id="1624518">len</span><span class="op" id="1624521">(</span><span class="ident" id="1624522">r</span><span class="op" id="1624523">.</span><span class="ident" id="1624524">Stack0</span><span class="op" id="1624530">)</span>&nbsp;<span class="op" id="1624532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624536">r</span><span class="op" id="1624537">.</span><span class="ident" id="1624538">Stack0</span><span class="op" id="1624544">[</span><span class="ident" id="1624545">n</span><span class="op" id="1624546">]</span>&nbsp;<span class="op" id="1624548">=</span>&nbsp;<span class="num" id="1624550">0</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1624553">}</span><br>
<span class="lineno"></span><span class="op" id="1624555">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1624558">//&nbsp;Stack&nbsp;formats&nbsp;a&nbsp;stack&nbsp;trace&nbsp;of&nbsp;the&nbsp;calling&nbsp;goroutine&nbsp;into&nbsp;buf</span><br>
<span class="lineno"></span><span class="comment" id="1624623">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written&nbsp;to&nbsp;buf.</span><br>
<span class="lineno">575</span><span class="comment" id="1624674">//&nbsp;If&nbsp;all&nbsp;is&nbsp;true,&nbsp;Stack&nbsp;formats&nbsp;stack&nbsp;traces&nbsp;of&nbsp;all&nbsp;other&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="1624744">//&nbsp;into&nbsp;buf&nbsp;after&nbsp;the&nbsp;trace&nbsp;for&nbsp;the&nbsp;current&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="1624799">func</span>&nbsp;<span class="ident" id="1624804">Stack</span><span class="op" id="1624809">(</span><span class="ident" id="1624810">buf</span>&nbsp;<span class="op" id="1624814">[</span><span class="op" id="1624815">]</span><span class="builtintype" id="1624816">byte</span><span class="op" id="1624820">,</span>&nbsp;<span class="ident" id="1624822">all</span>&nbsp;<span class="builtintype" id="1624826">bool</span><span class="op" id="1624830">)</span>&nbsp;<span class="builtintype" id="1624832">int</span>&nbsp;<span class="op" id="1624836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624839">mp</span>&nbsp;<span class="op" id="1624842">:=</span>&nbsp;<span class="ident" id="1624845">acquirem</span><span class="op" id="1624853">(</span><span class="op" id="1624854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624857">gp</span>&nbsp;<span class="op" id="1624860">:=</span>&nbsp;<span class="ident" id="1624863">mp</span><span class="op" id="1624865">.</span><span class="ident" id="1624866">curg</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1624872">if</span>&nbsp;<span class="ident" id="1624875">all</span>&nbsp;<span class="op" id="1624879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624883">semacquire</span><span class="op" id="1624893">(</span><span class="op" id="1624894">&amp;</span><span class="ident" id="1624895">worldsema</span><span class="op" id="1624904">,</span>&nbsp;<span class="builtintype" id="1624906">false</span><span class="op" id="1624911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624915">mp</span><span class="op" id="1624917">.</span><span class="ident" id="1624918">gcing</span>&nbsp;<span class="op" id="1624924">=</span>&nbsp;<span class="num" id="1624926">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624930">releasem</span><span class="op" id="1624938">(</span><span class="ident" id="1624939">mp</span><span class="op" id="1624941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624945">onM</span><span class="op" id="1624948">(</span><span class="ident" id="1624949">stoptheworld</span><span class="op" id="1624961">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1624965">if</span>&nbsp;<span class="ident" id="1624968">mp</span>&nbsp;<span class="op" id="1624971">!=</span>&nbsp;<span class="ident" id="1624974">acquirem</span><span class="op" id="1624982">(</span><span class="op" id="1624983">)</span>&nbsp;<span class="op" id="1624985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624990">gothrow</span><span class="op" id="1624997">(</span><span class="string" id="1624998">&#34;Stack:&nbsp;rescheduled&#34;</span><span class="op" id="1625018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1625022">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1625025">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625029">n</span>&nbsp;<span class="op" id="1625031">:=</span>&nbsp;<span class="num" id="1625034">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1625037">if</span>&nbsp;<span class="builtinfunc" id="1625040">len</span><span class="op" id="1625043">(</span><span class="ident" id="1625044">buf</span><span class="op" id="1625047">)</span>&nbsp;<span class="op" id="1625049">&gt;</span>&nbsp;<span class="num" id="1625051">0</span>&nbsp;<span class="op" id="1625053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625057">sp</span>&nbsp;<span class="op" id="1625060">:=</span>&nbsp;<span class="ident" id="1625063">getcallersp</span><span class="op" id="1625074">(</span><span class="ident" id="1625075">unsafe</span><span class="op" id="1625081">.</span><span class="ident" id="1625082">Pointer</span><span class="op" id="1625089">(</span><span class="op" id="1625090">&amp;</span><span class="ident" id="1625091">buf</span><span class="op" id="1625094">)</span><span class="op" id="1625095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625099">pc</span>&nbsp;<span class="op" id="1625102">:=</span>&nbsp;<span class="ident" id="1625105">getcallerpc</span><span class="op" id="1625116">(</span><span class="ident" id="1625117">unsafe</span><span class="op" id="1625123">.</span><span class="ident" id="1625124">Pointer</span><span class="op" id="1625131">(</span><span class="op" id="1625132">&amp;</span><span class="ident" id="1625133">buf</span><span class="op" id="1625136">)</span><span class="op" id="1625137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625141">onM</span><span class="op" id="1625144">(</span><span class="keyword" id="1625145">func</span><span class="op" id="1625149">(</span><span class="op" id="1625150">)</span>&nbsp;<span class="op" id="1625152">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625157">g0</span>&nbsp;<span class="op" id="1625160">:=</span>&nbsp;<span class="ident" id="1625163">getg</span><span class="op" id="1625167">(</span><span class="op" id="1625168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625173">g0</span><span class="op" id="1625175">.</span><span class="ident" id="1625176">writebuf</span>&nbsp;<span class="op" id="1625185">=</span>&nbsp;<span class="ident" id="1625187">buf</span><span class="op" id="1625190">[</span><span class="num" id="1625191">0</span><span class="op" id="1625192">:</span><span class="num" id="1625193">0</span><span class="op" id="1625194">:</span><span class="builtinfunc" id="1625195">len</span><span class="op" id="1625198">(</span><span class="ident" id="1625199">buf</span><span class="op" id="1625202">)</span><span class="op" id="1625203">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625208">goroutineheader</span><span class="op" id="1625223">(</span><span class="ident" id="1625224">gp</span><span class="op" id="1625226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625231">traceback</span><span class="op" id="1625240">(</span><span class="ident" id="1625241">pc</span><span class="op" id="1625243">,</span>&nbsp;<span class="ident" id="1625245">sp</span><span class="op" id="1625247">,</span>&nbsp;<span class="num" id="1625249">0</span><span class="op" id="1625250">,</span>&nbsp;<span class="ident" id="1625252">gp</span><span class="op" id="1625254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1625259">if</span>&nbsp;<span class="ident" id="1625262">all</span>&nbsp;<span class="op" id="1625266">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625272">tracebackothers</span><span class="op" id="1625287">(</span><span class="ident" id="1625288">gp</span><span class="op" id="1625290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1625295">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625300">n</span>&nbsp;<span class="op" id="1625302">=</span>&nbsp;<span class="builtinfunc" id="1625304">len</span><span class="op" id="1625307">(</span><span class="ident" id="1625308">g0</span><span class="op" id="1625310">.</span><span class="ident" id="1625311">writebuf</span><span class="op" id="1625319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625324">g0</span><span class="op" id="1625326">.</span><span class="ident" id="1625327">writebuf</span>&nbsp;<span class="op" id="1625336">=</span>&nbsp;<span class="ident" id="1625338">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1625344">}</span><span class="op" id="1625345">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1625348">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1625352">if</span>&nbsp;<span class="ident" id="1625355">all</span>&nbsp;<span class="op" id="1625359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625363">mp</span><span class="op" id="1625365">.</span><span class="ident" id="1625366">gcing</span>&nbsp;<span class="op" id="1625372">=</span>&nbsp;<span class="num" id="1625374">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625378">semrelease</span><span class="op" id="1625388">(</span><span class="op" id="1625389">&amp;</span><span class="ident" id="1625390">worldsema</span><span class="op" id="1625399">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625403">onM</span><span class="op" id="1625406">(</span><span class="ident" id="1625407">starttheworld</span><span class="op" id="1625420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1625423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625426">releasem</span><span class="op" id="1625434">(</span><span class="ident" id="1625435">mp</span><span class="op" id="1625437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1625440">return</span>&nbsp;<span class="ident" id="1625447">n</span><br>
<span class="lineno"></span><span class="op" id="1625449">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span><span class="comment" id="1625452">//&nbsp;Tracing&nbsp;of&nbsp;alloc/free/gc.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1625482">var</span>&nbsp;<span class="ident" id="1625486">tracelock</span>&nbsp;<span class="ident" id="1625496">mutex</span><br>
<span class="lineno"></span><br>
<span class="lineno">620</span><span class="keyword" id="1625503">func</span>&nbsp;<span class="ident" id="1625508">tracealloc</span><span class="op" id="1625518">(</span><span class="ident" id="1625519">p</span>&nbsp;<span class="ident" id="1625521">unsafe</span><span class="op" id="1625527">.</span><span class="ident" id="1625528">Pointer</span><span class="op" id="1625535">,</span>&nbsp;<span class="ident" id="1625537">size</span>&nbsp;<span class="builtintype" id="1625542">uintptr</span><span class="op" id="1625549">,</span>&nbsp;<span class="ident" id="1625551">typ</span>&nbsp;<span class="op" id="1625555">*</span><span class="ident" id="1625556">_type</span><span class="op" id="1625561">)</span>&nbsp;<span class="op" id="1625563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625566">lock</span><span class="op" id="1625570">(</span><span class="op" id="1625571">&amp;</span><span class="ident" id="1625572">tracelock</span><span class="op" id="1625581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625584">gp</span>&nbsp;<span class="op" id="1625587">:=</span>&nbsp;<span class="ident" id="1625590">getg</span><span class="op" id="1625594">(</span><span class="op" id="1625595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625598">gp</span><span class="op" id="1625600">.</span><span class="ident" id="1625601">m</span><span class="op" id="1625602">.</span><span class="ident" id="1625603">traceback</span>&nbsp;<span class="op" id="1625613">=</span>&nbsp;<span class="num" id="1625615">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1625618">if</span>&nbsp;<span class="ident" id="1625621">typ</span>&nbsp;<span class="op" id="1625625">==</span>&nbsp;<span class="ident" id="1625628">nil</span>&nbsp;<span class="op" id="1625632">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1625636">print</span><span class="op" id="1625641">(</span><span class="string" id="1625642">&#34;tracealloc(&#34;</span><span class="op" id="1625655">,</span>&nbsp;<span class="ident" id="1625657">p</span><span class="op" id="1625658">,</span>&nbsp;<span class="string" id="1625660">&#34;,&nbsp;&#34;</span><span class="op" id="1625664">,</span>&nbsp;<span class="ident" id="1625666">hex</span><span class="op" id="1625669">(</span><span class="ident" id="1625670">size</span><span class="op" id="1625674">)</span><span class="op" id="1625675">,</span>&nbsp;<span class="string" id="1625677">&#34;)\n&#34;</span><span class="op" id="1625682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1625685">}</span>&nbsp;<span class="keyword" id="1625687">else</span>&nbsp;<span class="op" id="1625692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1625696">print</span><span class="op" id="1625701">(</span><span class="string" id="1625702">&#34;tracealloc(&#34;</span><span class="op" id="1625715">,</span>&nbsp;<span class="ident" id="1625717">p</span><span class="op" id="1625718">,</span>&nbsp;<span class="string" id="1625720">&#34;,&nbsp;&#34;</span><span class="op" id="1625724">,</span>&nbsp;<span class="ident" id="1625726">hex</span><span class="op" id="1625729">(</span><span class="ident" id="1625730">size</span><span class="op" id="1625734">)</span><span class="op" id="1625735">,</span>&nbsp;<span class="string" id="1625737">&#34;,&nbsp;&#34;</span><span class="op" id="1625741">,</span>&nbsp;<span class="op" id="1625743">*</span><span class="ident" id="1625744">typ</span><span class="op" id="1625747">.</span><span class="ident" id="1625748">_string</span><span class="op" id="1625755">,</span>&nbsp;<span class="string" id="1625757">&#34;)\n&#34;</span><span class="op" id="1625762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1625765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1625768">if</span>&nbsp;<span class="ident" id="1625771">gp</span><span class="op" id="1625773">.</span><span class="ident" id="1625774">m</span><span class="op" id="1625775">.</span><span class="ident" id="1625776">curg</span>&nbsp;<span class="op" id="1625781">==</span>&nbsp;<span class="ident" id="1625784">nil</span>&nbsp;<span class="op" id="1625788">||</span>&nbsp;<span class="ident" id="1625791">gp</span>&nbsp;<span class="op" id="1625794">==</span>&nbsp;<span class="ident" id="1625797">gp</span><span class="op" id="1625799">.</span><span class="ident" id="1625800">m</span><span class="op" id="1625801">.</span><span class="ident" id="1625802">curg</span>&nbsp;<span class="op" id="1625807">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625811">goroutineheader</span><span class="op" id="1625826">(</span><span class="ident" id="1625827">gp</span><span class="op" id="1625829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625833">pc</span>&nbsp;<span class="op" id="1625836">:=</span>&nbsp;<span class="ident" id="1625839">getcallerpc</span><span class="op" id="1625850">(</span><span class="ident" id="1625851">unsafe</span><span class="op" id="1625857">.</span><span class="ident" id="1625858">Pointer</span><span class="op" id="1625865">(</span><span class="op" id="1625866">&amp;</span><span class="ident" id="1625867">p</span><span class="op" id="1625868">)</span><span class="op" id="1625869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625873">sp</span>&nbsp;<span class="op" id="1625876">:=</span>&nbsp;<span class="ident" id="1625879">getcallersp</span><span class="op" id="1625890">(</span><span class="ident" id="1625891">unsafe</span><span class="op" id="1625897">.</span><span class="ident" id="1625898">Pointer</span><span class="op" id="1625905">(</span><span class="op" id="1625906">&amp;</span><span class="ident" id="1625907">p</span><span class="op" id="1625908">)</span><span class="op" id="1625909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625913">onM</span><span class="op" id="1625916">(</span><span class="keyword" id="1625917">func</span><span class="op" id="1625921">(</span><span class="op" id="1625922">)</span>&nbsp;<span class="op" id="1625924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625929">traceback</span><span class="op" id="1625938">(</span><span class="ident" id="1625939">pc</span><span class="op" id="1625941">,</span>&nbsp;<span class="ident" id="1625943">sp</span><span class="op" id="1625945">,</span>&nbsp;<span class="num" id="1625947">0</span><span class="op" id="1625948">,</span>&nbsp;<span class="ident" id="1625950">gp</span><span class="op" id="1625952">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1625956">}</span><span class="op" id="1625957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1625960">}</span>&nbsp;<span class="keyword" id="1625962">else</span>&nbsp;<span class="op" id="1625967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625971">goroutineheader</span><span class="op" id="1625986">(</span><span class="ident" id="1625987">gp</span><span class="op" id="1625989">.</span><span class="ident" id="1625990">m</span><span class="op" id="1625991">.</span><span class="ident" id="1625992">curg</span><span class="op" id="1625996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626000">traceback</span><span class="op" id="1626009">(</span><span class="op" id="1626010">^</span><span class="builtintype" id="1626011">uintptr</span><span class="op" id="1626018">(</span><span class="num" id="1626019">0</span><span class="op" id="1626020">)</span><span class="op" id="1626021">,</span>&nbsp;<span class="op" id="1626023">^</span><span class="builtintype" id="1626024">uintptr</span><span class="op" id="1626031">(</span><span class="num" id="1626032">0</span><span class="op" id="1626033">)</span><span class="op" id="1626034">,</span>&nbsp;<span class="num" id="1626036">0</span><span class="op" id="1626037">,</span>&nbsp;<span class="ident" id="1626039">gp</span><span class="op" id="1626041">.</span><span class="ident" id="1626042">m</span><span class="op" id="1626043">.</span><span class="ident" id="1626044">curg</span><span class="op" id="1626048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1626051">}</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1626054">print</span><span class="op" id="1626059">(</span><span class="string" id="1626060">&#34;\n&#34;</span><span class="op" id="1626064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626067">gp</span><span class="op" id="1626069">.</span><span class="ident" id="1626070">m</span><span class="op" id="1626071">.</span><span class="ident" id="1626072">traceback</span>&nbsp;<span class="op" id="1626082">=</span>&nbsp;<span class="num" id="1626084">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626087">unlock</span><span class="op" id="1626093">(</span><span class="op" id="1626094">&amp;</span><span class="ident" id="1626095">tracelock</span><span class="op" id="1626104">)</span><br>
<span class="lineno"></span><span class="op" id="1626106">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">645</span><span class="keyword" id="1626109">func</span>&nbsp;<span class="ident" id="1626114">tracefree</span><span class="op" id="1626123">(</span><span class="ident" id="1626124">p</span>&nbsp;<span class="ident" id="1626126">unsafe</span><span class="op" id="1626132">.</span><span class="ident" id="1626133">Pointer</span><span class="op" id="1626140">,</span>&nbsp;<span class="ident" id="1626142">size</span>&nbsp;<span class="builtintype" id="1626147">uintptr</span><span class="op" id="1626154">)</span>&nbsp;<span class="op" id="1626156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626159">lock</span><span class="op" id="1626163">(</span><span class="op" id="1626164">&amp;</span><span class="ident" id="1626165">tracelock</span><span class="op" id="1626174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626177">gp</span>&nbsp;<span class="op" id="1626180">:=</span>&nbsp;<span class="ident" id="1626183">getg</span><span class="op" id="1626187">(</span><span class="op" id="1626188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626191">gp</span><span class="op" id="1626193">.</span><span class="ident" id="1626194">m</span><span class="op" id="1626195">.</span><span class="ident" id="1626196">traceback</span>&nbsp;<span class="op" id="1626206">=</span>&nbsp;<span class="num" id="1626208">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1626211">print</span><span class="op" id="1626216">(</span><span class="string" id="1626217">&#34;tracefree(&#34;</span><span class="op" id="1626229">,</span>&nbsp;<span class="ident" id="1626231">p</span><span class="op" id="1626232">,</span>&nbsp;<span class="string" id="1626234">&#34;,&nbsp;&#34;</span><span class="op" id="1626238">,</span>&nbsp;<span class="ident" id="1626240">hex</span><span class="op" id="1626243">(</span><span class="ident" id="1626244">size</span><span class="op" id="1626248">)</span><span class="op" id="1626249">,</span>&nbsp;<span class="string" id="1626251">&#34;)\n&#34;</span><span class="op" id="1626256">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626259">goroutineheader</span><span class="op" id="1626274">(</span><span class="ident" id="1626275">gp</span><span class="op" id="1626277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626280">pc</span>&nbsp;<span class="op" id="1626283">:=</span>&nbsp;<span class="ident" id="1626286">getcallerpc</span><span class="op" id="1626297">(</span><span class="ident" id="1626298">unsafe</span><span class="op" id="1626304">.</span><span class="ident" id="1626305">Pointer</span><span class="op" id="1626312">(</span><span class="op" id="1626313">&amp;</span><span class="ident" id="1626314">p</span><span class="op" id="1626315">)</span><span class="op" id="1626316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626319">sp</span>&nbsp;<span class="op" id="1626322">:=</span>&nbsp;<span class="ident" id="1626325">getcallersp</span><span class="op" id="1626336">(</span><span class="ident" id="1626337">unsafe</span><span class="op" id="1626343">.</span><span class="ident" id="1626344">Pointer</span><span class="op" id="1626351">(</span><span class="op" id="1626352">&amp;</span><span class="ident" id="1626353">p</span><span class="op" id="1626354">)</span><span class="op" id="1626355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626358">onM</span><span class="op" id="1626361">(</span><span class="keyword" id="1626362">func</span><span class="op" id="1626366">(</span><span class="op" id="1626367">)</span>&nbsp;<span class="op" id="1626369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626373">traceback</span><span class="op" id="1626382">(</span><span class="ident" id="1626383">pc</span><span class="op" id="1626385">,</span>&nbsp;<span class="ident" id="1626387">sp</span><span class="op" id="1626389">,</span>&nbsp;<span class="num" id="1626391">0</span><span class="op" id="1626392">,</span>&nbsp;<span class="ident" id="1626394">gp</span><span class="op" id="1626396">)</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1626399">}</span><span class="op" id="1626400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1626403">print</span><span class="op" id="1626408">(</span><span class="string" id="1626409">&#34;\n&#34;</span><span class="op" id="1626413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626416">gp</span><span class="op" id="1626418">.</span><span class="ident" id="1626419">m</span><span class="op" id="1626420">.</span><span class="ident" id="1626421">traceback</span>&nbsp;<span class="op" id="1626431">=</span>&nbsp;<span class="num" id="1626433">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626436">unlock</span><span class="op" id="1626442">(</span><span class="op" id="1626443">&amp;</span><span class="ident" id="1626444">tracelock</span><span class="op" id="1626453">)</span><br>
<span class="lineno"></span><span class="op" id="1626455">}</span><br>
<span class="lineno">660</span><br>
<span class="lineno"></span><span class="keyword" id="1626458">func</span>&nbsp;<span class="ident" id="1626463">tracegc</span><span class="op" id="1626470">(</span><span class="op" id="1626471">)</span>&nbsp;<span class="op" id="1626473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626476">lock</span><span class="op" id="1626480">(</span><span class="op" id="1626481">&amp;</span><span class="ident" id="1626482">tracelock</span><span class="op" id="1626491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626494">gp</span>&nbsp;<span class="op" id="1626497">:=</span>&nbsp;<span class="ident" id="1626500">getg</span><span class="op" id="1626504">(</span><span class="op" id="1626505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626508">gp</span><span class="op" id="1626510">.</span><span class="ident" id="1626511">m</span><span class="op" id="1626512">.</span><span class="ident" id="1626513">traceback</span>&nbsp;<span class="op" id="1626523">=</span>&nbsp;<span class="num" id="1626525">2</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1626528">print</span><span class="op" id="1626533">(</span><span class="string" id="1626534">&#34;tracegc()\n&#34;</span><span class="op" id="1626547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1626550">//&nbsp;running&nbsp;on&nbsp;m-&gt;g0&nbsp;stack;&nbsp;show&nbsp;all&nbsp;non-g0&nbsp;goroutines</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626605">tracebackothers</span><span class="op" id="1626620">(</span><span class="ident" id="1626621">gp</span><span class="op" id="1626623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1626626">print</span><span class="op" id="1626631">(</span><span class="string" id="1626632">&#34;end&nbsp;tracegc\n&#34;</span><span class="op" id="1626647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1626650">print</span><span class="op" id="1626655">(</span><span class="string" id="1626656">&#34;\n&#34;</span><span class="op" id="1626660">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626663">gp</span><span class="op" id="1626665">.</span><span class="ident" id="1626666">m</span><span class="op" id="1626667">.</span><span class="ident" id="1626668">traceback</span>&nbsp;<span class="op" id="1626678">=</span>&nbsp;<span class="num" id="1626680">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626683">unlock</span><span class="op" id="1626689">(</span><span class="op" id="1626690">&amp;</span><span class="ident" id="1626691">tracelock</span><span class="op" id="1626700">)</span><br>
<span class="lineno"></span><span class="op" id="1626702">}</span>
</div>
</body>
</html>
