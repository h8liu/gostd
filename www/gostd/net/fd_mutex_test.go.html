<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="8203060">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8203115">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8203169">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="8203220">package</span>&nbsp;<span class="ident" id="8203228">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8203233">import</span>&nbsp;<span class="op" id="8203240">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8203243">&#34;math/rand&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8203256">&#34;runtime&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8203267">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8203278">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="8203285">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8203288">func</span>&nbsp;<span class="ident" id="8203293">TestMutexLock</span><span class="op" id="8203306">(</span><span class="ident" id="8203307">t</span>&nbsp;<span class="op" id="8203309">*</span><span class="ident" id="8203310">testing</span><span class="op" id="8203317">.</span><span class="ident" id="8203318">T</span><span class="op" id="8203319">)</span>&nbsp;<span class="op" id="8203321">{</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8203324">var</span>&nbsp;<span class="ident" id="8203328">mu</span>&nbsp;<span class="ident" id="8203331">fdMutex</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8203341">if</span>&nbsp;<span class="op" id="8203344">!</span><span class="ident" id="8203345">mu</span><span class="op" id="8203347">.</span><span class="ident" id="8203348">Incref</span><span class="op" id="8203354">(</span><span class="op" id="8203355">)</span>&nbsp;<span class="op" id="8203357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8203361">t</span><span class="op" id="8203362">.</span><span class="ident" id="8203363">Fatal</span><span class="op" id="8203368">(</span><span class="string" id="8203369">&#34;broken&#34;</span><span class="op" id="8203377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8203380">}</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8203383">if</span>&nbsp;<span class="ident" id="8203386">mu</span><span class="op" id="8203388">.</span><span class="ident" id="8203389">Decref</span><span class="op" id="8203395">(</span><span class="op" id="8203396">)</span>&nbsp;<span class="op" id="8203398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8203402">t</span><span class="op" id="8203403">.</span><span class="ident" id="8203404">Fatal</span><span class="op" id="8203409">(</span><span class="string" id="8203410">&#34;broken&#34;</span><span class="op" id="8203418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8203421">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8203425">if</span>&nbsp;<span class="op" id="8203428">!</span><span class="ident" id="8203429">mu</span><span class="op" id="8203431">.</span><span class="ident" id="8203432">RWLock</span><span class="op" id="8203438">(</span><span class="builtintype" id="8203439">true</span><span class="op" id="8203443">)</span>&nbsp;<span class="op" id="8203445">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8203449">t</span><span class="op" id="8203450">.</span><span class="ident" id="8203451">Fatal</span><span class="op" id="8203456">(</span><span class="string" id="8203457">&#34;broken&#34;</span><span class="op" id="8203465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8203468">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8203471">if</span>&nbsp;<span class="ident" id="8203474">mu</span><span class="op" id="8203476">.</span><span class="ident" id="8203477">RWUnlock</span><span class="op" id="8203485">(</span><span class="builtintype" id="8203486">true</span><span class="op" id="8203490">)</span>&nbsp;<span class="op" id="8203492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8203496">t</span><span class="op" id="8203497">.</span><span class="ident" id="8203498">Fatal</span><span class="op" id="8203503">(</span><span class="string" id="8203504">&#34;broken&#34;</span><span class="op" id="8203512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8203515">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8203519">if</span>&nbsp;<span class="op" id="8203522">!</span><span class="ident" id="8203523">mu</span><span class="op" id="8203525">.</span><span class="ident" id="8203526">RWLock</span><span class="op" id="8203532">(</span><span class="builtintype" id="8203533">false</span><span class="op" id="8203538">)</span>&nbsp;<span class="op" id="8203540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8203544">t</span><span class="op" id="8203545">.</span><span class="ident" id="8203546">Fatal</span><span class="op" id="8203551">(</span><span class="string" id="8203552">&#34;broken&#34;</span><span class="op" id="8203560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8203563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8203566">if</span>&nbsp;<span class="ident" id="8203569">mu</span><span class="op" id="8203571">.</span><span class="ident" id="8203572">RWUnlock</span><span class="op" id="8203580">(</span><span class="builtintype" id="8203581">false</span><span class="op" id="8203586">)</span>&nbsp;<span class="op" id="8203588">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8203592">t</span><span class="op" id="8203593">.</span><span class="ident" id="8203594">Fatal</span><span class="op" id="8203599">(</span><span class="string" id="8203600">&#34;broken&#34;</span><span class="op" id="8203608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8203611">}</span><br>
<span class="lineno"></span><span class="op" id="8203613">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8203616">func</span>&nbsp;<span class="ident" id="8203621">TestMutexClose</span><span class="op" id="8203635">(</span><span class="ident" id="8203636">t</span>&nbsp;<span class="op" id="8203638">*</span><span class="ident" id="8203639">testing</span><span class="op" id="8203646">.</span><span class="ident" id="8203647">T</span><span class="op" id="8203648">)</span>&nbsp;<span class="op" id="8203650">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8203653">var</span>&nbsp;<span class="ident" id="8203657">mu</span>&nbsp;<span class="ident" id="8203660">fdMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8203669">if</span>&nbsp;<span class="op" id="8203672">!</span><span class="ident" id="8203673">mu</span><span class="op" id="8203675">.</span><span class="ident" id="8203676">IncrefAndClose</span><span class="op" id="8203690">(</span><span class="op" id="8203691">)</span>&nbsp;<span class="op" id="8203693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8203697">t</span><span class="op" id="8203698">.</span><span class="ident" id="8203699">Fatal</span><span class="op" id="8203704">(</span><span class="string" id="8203705">&#34;broken&#34;</span><span class="op" id="8203713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8203716">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8203720">if</span>&nbsp;<span class="ident" id="8203723">mu</span><span class="op" id="8203725">.</span><span class="ident" id="8203726">Incref</span><span class="op" id="8203732">(</span><span class="op" id="8203733">)</span>&nbsp;<span class="op" id="8203735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8203739">t</span><span class="op" id="8203740">.</span><span class="ident" id="8203741">Fatal</span><span class="op" id="8203746">(</span><span class="string" id="8203747">&#34;broken&#34;</span><span class="op" id="8203755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8203758">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8203761">if</span>&nbsp;<span class="ident" id="8203764">mu</span><span class="op" id="8203766">.</span><span class="ident" id="8203767">RWLock</span><span class="op" id="8203773">(</span><span class="builtintype" id="8203774">true</span><span class="op" id="8203778">)</span>&nbsp;<span class="op" id="8203780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8203784">t</span><span class="op" id="8203785">.</span><span class="ident" id="8203786">Fatal</span><span class="op" id="8203791">(</span><span class="string" id="8203792">&#34;broken&#34;</span><span class="op" id="8203800">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8203803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8203806">if</span>&nbsp;<span class="ident" id="8203809">mu</span><span class="op" id="8203811">.</span><span class="ident" id="8203812">RWLock</span><span class="op" id="8203818">(</span><span class="builtintype" id="8203819">false</span><span class="op" id="8203824">)</span>&nbsp;<span class="op" id="8203826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8203830">t</span><span class="op" id="8203831">.</span><span class="ident" id="8203832">Fatal</span><span class="op" id="8203837">(</span><span class="string" id="8203838">&#34;broken&#34;</span><span class="op" id="8203846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8203849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8203852">if</span>&nbsp;<span class="ident" id="8203855">mu</span><span class="op" id="8203857">.</span><span class="ident" id="8203858">IncrefAndClose</span><span class="op" id="8203872">(</span><span class="op" id="8203873">)</span>&nbsp;<span class="op" id="8203875">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8203879">t</span><span class="op" id="8203880">.</span><span class="ident" id="8203881">Fatal</span><span class="op" id="8203886">(</span><span class="string" id="8203887">&#34;broken&#34;</span><span class="op" id="8203895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8203898">}</span><br>
<span class="lineno"></span><span class="op" id="8203900">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8203903">func</span>&nbsp;<span class="ident" id="8203908">TestMutexCloseUnblock</span><span class="op" id="8203929">(</span><span class="ident" id="8203930">t</span>&nbsp;<span class="op" id="8203932">*</span><span class="ident" id="8203933">testing</span><span class="op" id="8203940">.</span><span class="ident" id="8203941">T</span><span class="op" id="8203942">)</span>&nbsp;<span class="op" id="8203944">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8203947">c</span>&nbsp;<span class="op" id="8203949">:=</span>&nbsp;<span class="builtinfunc" id="8203952">make</span><span class="op" id="8203956">(</span><span class="keyword" id="8203957">chan</span>&nbsp;<span class="builtintype" id="8203962">bool</span><span class="op" id="8203966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8203969">var</span>&nbsp;<span class="ident" id="8203973">mu</span>&nbsp;<span class="ident" id="8203976">fdMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8203985">mu</span><span class="op" id="8203987">.</span><span class="ident" id="8203988">RWLock</span><span class="op" id="8203994">(</span><span class="builtintype" id="8203995">true</span><span class="op" id="8203999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8204002">for</span>&nbsp;<span class="ident" id="8204006">i</span>&nbsp;<span class="op" id="8204008">:=</span>&nbsp;<span class="num" id="8204011">0</span><span class="op" id="8204012">;</span>&nbsp;<span class="ident" id="8204014">i</span>&nbsp;<span class="op" id="8204016">&lt;</span>&nbsp;<span class="num" id="8204018">4</span><span class="op" id="8204019">;</span>&nbsp;<span class="ident" id="8204021">i</span><span class="op" id="8204022">++</span>&nbsp;<span class="op" id="8204025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8204029">go</span>&nbsp;<span class="keyword" id="8204032">func</span><span class="op" id="8204036">(</span><span class="op" id="8204037">)</span>&nbsp;<span class="op" id="8204039">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8204044">if</span>&nbsp;<span class="ident" id="8204047">mu</span><span class="op" id="8204049">.</span><span class="ident" id="8204050">RWLock</span><span class="op" id="8204056">(</span><span class="builtintype" id="8204057">true</span><span class="op" id="8204061">)</span>&nbsp;<span class="op" id="8204063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8204069">t</span><span class="op" id="8204070">.</span><span class="ident" id="8204071">Error</span><span class="op" id="8204076">(</span><span class="string" id="8204077">&#34;broken&#34;</span><span class="op" id="8204085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8204091">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8204101">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8204106">c</span>&nbsp;<span class="op" id="8204108">&lt;-</span>&nbsp;<span class="builtintype" id="8204111">true</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8204118">}</span><span class="op" id="8204119">(</span><span class="op" id="8204120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8204123">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8204126">//&nbsp;Concurrent&nbsp;goroutines&nbsp;must&nbsp;not&nbsp;be&nbsp;able&nbsp;to&nbsp;read&nbsp;lock&nbsp;the&nbsp;mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8204193">time</span><span class="op" id="8204197">.</span><span class="ident" id="8204198">Sleep</span><span class="op" id="8204203">(</span><span class="ident" id="8204204">time</span><span class="op" id="8204208">.</span><span class="ident" id="8204209">Millisecond</span><span class="op" id="8204220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8204223">select</span>&nbsp;<span class="op" id="8204230">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8204233">case</span>&nbsp;<span class="op" id="8204238">&lt;-</span><span class="ident" id="8204240">c</span><span class="op" id="8204241">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8204245">t</span><span class="op" id="8204246">.</span><span class="ident" id="8204247">Fatal</span><span class="op" id="8204252">(</span><span class="string" id="8204253">&#34;broken&#34;</span><span class="op" id="8204261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8204264">default</span><span class="op" id="8204271">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8204274">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8204277">mu</span><span class="op" id="8204279">.</span><span class="ident" id="8204280">IncrefAndClose</span><span class="op" id="8204294">(</span><span class="op" id="8204295">)</span>&nbsp;<span class="comment" id="8204297">//&nbsp;Must&nbsp;unblock&nbsp;the&nbsp;readers.</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8204327">for</span>&nbsp;<span class="ident" id="8204331">i</span>&nbsp;<span class="op" id="8204333">:=</span>&nbsp;<span class="num" id="8204336">0</span><span class="op" id="8204337">;</span>&nbsp;<span class="ident" id="8204339">i</span>&nbsp;<span class="op" id="8204341">&lt;</span>&nbsp;<span class="num" id="8204343">4</span><span class="op" id="8204344">;</span>&nbsp;<span class="ident" id="8204346">i</span><span class="op" id="8204347">++</span>&nbsp;<span class="op" id="8204350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8204354">select</span>&nbsp;<span class="op" id="8204361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8204365">case</span>&nbsp;<span class="op" id="8204370">&lt;-</span><span class="ident" id="8204372">c</span><span class="op" id="8204373">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8204377">case</span>&nbsp;<span class="op" id="8204382">&lt;-</span><span class="ident" id="8204384">time</span><span class="op" id="8204388">.</span><span class="ident" id="8204389">After</span><span class="op" id="8204394">(</span><span class="num" id="8204395">10</span>&nbsp;<span class="op" id="8204398">*</span>&nbsp;<span class="ident" id="8204400">time</span><span class="op" id="8204404">.</span><span class="ident" id="8204405">Second</span><span class="op" id="8204411">)</span><span class="op" id="8204412">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8204417">t</span><span class="op" id="8204418">.</span><span class="ident" id="8204419">Fatal</span><span class="op" id="8204424">(</span><span class="string" id="8204425">&#34;broken&#34;</span><span class="op" id="8204433">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8204437">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8204440">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8204443">if</span>&nbsp;<span class="ident" id="8204446">mu</span><span class="op" id="8204448">.</span><span class="ident" id="8204449">Decref</span><span class="op" id="8204455">(</span><span class="op" id="8204456">)</span>&nbsp;<span class="op" id="8204458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8204462">t</span><span class="op" id="8204463">.</span><span class="ident" id="8204464">Fatal</span><span class="op" id="8204469">(</span><span class="string" id="8204470">&#34;broken&#34;</span><span class="op" id="8204478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8204481">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8204484">if</span>&nbsp;<span class="op" id="8204487">!</span><span class="ident" id="8204488">mu</span><span class="op" id="8204490">.</span><span class="ident" id="8204491">RWUnlock</span><span class="op" id="8204499">(</span><span class="builtintype" id="8204500">true</span><span class="op" id="8204504">)</span>&nbsp;<span class="op" id="8204506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8204510">t</span><span class="op" id="8204511">.</span><span class="ident" id="8204512">Fatal</span><span class="op" id="8204517">(</span><span class="string" id="8204518">&#34;broken&#34;</span><span class="op" id="8204526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8204529">}</span><br>
<span class="lineno"></span><span class="op" id="8204531">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="8204534">func</span>&nbsp;<span class="ident" id="8204539">TestMutexPanic</span><span class="op" id="8204553">(</span><span class="ident" id="8204554">t</span>&nbsp;<span class="op" id="8204556">*</span><span class="ident" id="8204557">testing</span><span class="op" id="8204564">.</span><span class="ident" id="8204565">T</span><span class="op" id="8204566">)</span>&nbsp;<span class="op" id="8204568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8204571">ensurePanics</span>&nbsp;<span class="op" id="8204584">:=</span>&nbsp;<span class="keyword" id="8204587">func</span><span class="op" id="8204591">(</span><span class="ident" id="8204592">f</span>&nbsp;<span class="keyword" id="8204594">func</span><span class="op" id="8204598">(</span><span class="op" id="8204599">)</span><span class="op" id="8204600">)</span>&nbsp;<span class="op" id="8204602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8204606">defer</span>&nbsp;<span class="keyword" id="8204612">func</span><span class="op" id="8204616">(</span><span class="op" id="8204617">)</span>&nbsp;<span class="op" id="8204619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8204624">if</span>&nbsp;<span class="builtinfunc" id="8204627">recover</span><span class="op" id="8204634">(</span><span class="op" id="8204635">)</span>&nbsp;<span class="op" id="8204637">==</span>&nbsp;<span class="ident" id="8204640">nil</span>&nbsp;<span class="op" id="8204644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8204650">t</span><span class="op" id="8204651">.</span><span class="ident" id="8204652">Fatal</span><span class="op" id="8204657">(</span><span class="string" id="8204658">&#34;does&nbsp;not&nbsp;panic&#34;</span><span class="op" id="8204674">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8204679">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8204683">}</span><span class="op" id="8204684">(</span><span class="op" id="8204685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8204689">f</span><span class="op" id="8204690">(</span><span class="op" id="8204691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8204694">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8204698">var</span>&nbsp;<span class="ident" id="8204702">mu</span>&nbsp;<span class="ident" id="8204705">fdMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8204714">ensurePanics</span><span class="op" id="8204726">(</span><span class="keyword" id="8204727">func</span><span class="op" id="8204731">(</span><span class="op" id="8204732">)</span>&nbsp;<span class="op" id="8204734">{</span>&nbsp;<span class="ident" id="8204736">mu</span><span class="op" id="8204738">.</span><span class="ident" id="8204739">Decref</span><span class="op" id="8204745">(</span><span class="op" id="8204746">)</span>&nbsp;<span class="op" id="8204748">}</span><span class="op" id="8204749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8204752">ensurePanics</span><span class="op" id="8204764">(</span><span class="keyword" id="8204765">func</span><span class="op" id="8204769">(</span><span class="op" id="8204770">)</span>&nbsp;<span class="op" id="8204772">{</span>&nbsp;<span class="ident" id="8204774">mu</span><span class="op" id="8204776">.</span><span class="ident" id="8204777">RWUnlock</span><span class="op" id="8204785">(</span><span class="builtintype" id="8204786">true</span><span class="op" id="8204790">)</span>&nbsp;<span class="op" id="8204792">}</span><span class="op" id="8204793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8204796">ensurePanics</span><span class="op" id="8204808">(</span><span class="keyword" id="8204809">func</span><span class="op" id="8204813">(</span><span class="op" id="8204814">)</span>&nbsp;<span class="op" id="8204816">{</span>&nbsp;<span class="ident" id="8204818">mu</span><span class="op" id="8204820">.</span><span class="ident" id="8204821">RWUnlock</span><span class="op" id="8204829">(</span><span class="builtintype" id="8204830">false</span><span class="op" id="8204835">)</span>&nbsp;<span class="op" id="8204837">}</span><span class="op" id="8204838">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8204842">ensurePanics</span><span class="op" id="8204854">(</span><span class="keyword" id="8204855">func</span><span class="op" id="8204859">(</span><span class="op" id="8204860">)</span>&nbsp;<span class="op" id="8204862">{</span>&nbsp;<span class="ident" id="8204864">mu</span><span class="op" id="8204866">.</span><span class="ident" id="8204867">Incref</span><span class="op" id="8204873">(</span><span class="op" id="8204874">)</span><span class="op" id="8204875">;</span>&nbsp;<span class="ident" id="8204877">mu</span><span class="op" id="8204879">.</span><span class="ident" id="8204880">Decref</span><span class="op" id="8204886">(</span><span class="op" id="8204887">)</span><span class="op" id="8204888">;</span>&nbsp;<span class="ident" id="8204890">mu</span><span class="op" id="8204892">.</span><span class="ident" id="8204893">Decref</span><span class="op" id="8204899">(</span><span class="op" id="8204900">)</span>&nbsp;<span class="op" id="8204902">}</span><span class="op" id="8204903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8204906">ensurePanics</span><span class="op" id="8204918">(</span><span class="keyword" id="8204919">func</span><span class="op" id="8204923">(</span><span class="op" id="8204924">)</span>&nbsp;<span class="op" id="8204926">{</span>&nbsp;<span class="ident" id="8204928">mu</span><span class="op" id="8204930">.</span><span class="ident" id="8204931">RWLock</span><span class="op" id="8204937">(</span><span class="builtintype" id="8204938">true</span><span class="op" id="8204942">)</span><span class="op" id="8204943">;</span>&nbsp;<span class="ident" id="8204945">mu</span><span class="op" id="8204947">.</span><span class="ident" id="8204948">RWUnlock</span><span class="op" id="8204956">(</span><span class="builtintype" id="8204957">true</span><span class="op" id="8204961">)</span><span class="op" id="8204962">;</span>&nbsp;<span class="ident" id="8204964">mu</span><span class="op" id="8204966">.</span><span class="ident" id="8204967">RWUnlock</span><span class="op" id="8204975">(</span><span class="builtintype" id="8204976">true</span><span class="op" id="8204980">)</span>&nbsp;<span class="op" id="8204982">}</span><span class="op" id="8204983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8204986">ensurePanics</span><span class="op" id="8204998">(</span><span class="keyword" id="8204999">func</span><span class="op" id="8205003">(</span><span class="op" id="8205004">)</span>&nbsp;<span class="op" id="8205006">{</span>&nbsp;<span class="ident" id="8205008">mu</span><span class="op" id="8205010">.</span><span class="ident" id="8205011">RWLock</span><span class="op" id="8205017">(</span><span class="builtintype" id="8205018">false</span><span class="op" id="8205023">)</span><span class="op" id="8205024">;</span>&nbsp;<span class="ident" id="8205026">mu</span><span class="op" id="8205028">.</span><span class="ident" id="8205029">RWUnlock</span><span class="op" id="8205037">(</span><span class="builtintype" id="8205038">false</span><span class="op" id="8205043">)</span><span class="op" id="8205044">;</span>&nbsp;<span class="ident" id="8205046">mu</span><span class="op" id="8205048">.</span><span class="ident" id="8205049">RWUnlock</span><span class="op" id="8205057">(</span><span class="builtintype" id="8205058">false</span><span class="op" id="8205063">)</span>&nbsp;<span class="op" id="8205065">}</span><span class="op" id="8205066">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8205070">//&nbsp;ensure&nbsp;that&nbsp;it&#39;s&nbsp;still&nbsp;not&nbsp;broken</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8205108">mu</span><span class="op" id="8205110">.</span><span class="ident" id="8205111">Incref</span><span class="op" id="8205117">(</span><span class="op" id="8205118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8205121">mu</span><span class="op" id="8205123">.</span><span class="ident" id="8205124">Decref</span><span class="op" id="8205130">(</span><span class="op" id="8205131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8205134">mu</span><span class="op" id="8205136">.</span><span class="ident" id="8205137">RWLock</span><span class="op" id="8205143">(</span><span class="builtintype" id="8205144">true</span><span class="op" id="8205148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8205151">mu</span><span class="op" id="8205153">.</span><span class="ident" id="8205154">RWUnlock</span><span class="op" id="8205162">(</span><span class="builtintype" id="8205163">true</span><span class="op" id="8205167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8205170">mu</span><span class="op" id="8205172">.</span><span class="ident" id="8205173">RWLock</span><span class="op" id="8205179">(</span><span class="builtintype" id="8205180">false</span><span class="op" id="8205185">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8205188">mu</span><span class="op" id="8205190">.</span><span class="ident" id="8205191">RWUnlock</span><span class="op" id="8205199">(</span><span class="builtintype" id="8205200">false</span><span class="op" id="8205205">)</span><br>
<span class="lineno"></span><span class="op" id="8205207">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8205210">func</span>&nbsp;<span class="ident" id="8205215">TestMutexStress</span><span class="op" id="8205230">(</span><span class="ident" id="8205231">t</span>&nbsp;<span class="op" id="8205233">*</span><span class="ident" id="8205234">testing</span><span class="op" id="8205241">.</span><span class="ident" id="8205242">T</span><span class="op" id="8205243">)</span>&nbsp;<span class="op" id="8205245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8205248">P</span>&nbsp;<span class="op" id="8205250">:=</span>&nbsp;<span class="num" id="8205253">8</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8205256">N</span>&nbsp;<span class="op" id="8205258">:=</span>&nbsp;<span class="builtintype" id="8205261">int</span><span class="op" id="8205264">(</span><span class="num" id="8205265">1e6</span><span class="op" id="8205268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8205271">if</span>&nbsp;<span class="ident" id="8205274">testing</span><span class="op" id="8205281">.</span><span class="ident" id="8205282">Short</span><span class="op" id="8205287">(</span><span class="op" id="8205288">)</span>&nbsp;<span class="op" id="8205290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8205294">P</span>&nbsp;<span class="op" id="8205296">=</span>&nbsp;<span class="num" id="8205298">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8205302">N</span>&nbsp;<span class="op" id="8205304">=</span>&nbsp;<span class="num" id="8205306">1e4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8205311">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8205314">defer</span>&nbsp;<span class="ident" id="8205320">runtime</span><span class="op" id="8205327">.</span><span class="ident" id="8205328">GOMAXPROCS</span><span class="op" id="8205338">(</span><span class="ident" id="8205339">runtime</span><span class="op" id="8205346">.</span><span class="ident" id="8205347">GOMAXPROCS</span><span class="op" id="8205357">(</span><span class="ident" id="8205358">P</span><span class="op" id="8205359">)</span><span class="op" id="8205360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8205363">done</span>&nbsp;<span class="op" id="8205368">:=</span>&nbsp;<span class="builtinfunc" id="8205371">make</span><span class="op" id="8205375">(</span><span class="keyword" id="8205376">chan</span>&nbsp;<span class="builtintype" id="8205381">bool</span><span class="op" id="8205385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8205388">var</span>&nbsp;<span class="ident" id="8205392">mu</span>&nbsp;<span class="ident" id="8205395">fdMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8205404">var</span>&nbsp;<span class="ident" id="8205408">readState</span>&nbsp;<span class="op" id="8205418">[</span><span class="num" id="8205419">2</span><span class="op" id="8205420">]</span><span class="ident" id="8205421">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8205429">var</span>&nbsp;<span class="ident" id="8205433">writeState</span>&nbsp;<span class="op" id="8205444">[</span><span class="num" id="8205445">2</span><span class="op" id="8205446">]</span><span class="ident" id="8205447">uint64</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8205455">for</span>&nbsp;<span class="ident" id="8205459">p</span>&nbsp;<span class="op" id="8205461">:=</span>&nbsp;<span class="num" id="8205464">0</span><span class="op" id="8205465">;</span>&nbsp;<span class="ident" id="8205467">p</span>&nbsp;<span class="op" id="8205469">&lt;</span>&nbsp;<span class="ident" id="8205471">P</span><span class="op" id="8205472">;</span>&nbsp;<span class="ident" id="8205474">p</span><span class="op" id="8205475">++</span>&nbsp;<span class="op" id="8205478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8205482">go</span>&nbsp;<span class="keyword" id="8205485">func</span><span class="op" id="8205489">(</span><span class="op" id="8205490">)</span>&nbsp;<span class="op" id="8205492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8205497">r</span>&nbsp;<span class="op" id="8205499">:=</span>&nbsp;<span class="ident" id="8205502">rand</span><span class="op" id="8205506">.</span><span class="ident" id="8205507">New</span><span class="op" id="8205510">(</span><span class="ident" id="8205511">rand</span><span class="op" id="8205515">.</span><span class="ident" id="8205516">NewSource</span><span class="op" id="8205525">(</span><span class="ident" id="8205526">rand</span><span class="op" id="8205530">.</span><span class="ident" id="8205531">Int63</span><span class="op" id="8205536">(</span><span class="op" id="8205537">)</span><span class="op" id="8205538">)</span><span class="op" id="8205539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8205544">for</span>&nbsp;<span class="ident" id="8205548">i</span>&nbsp;<span class="op" id="8205550">:=</span>&nbsp;<span class="num" id="8205553">0</span><span class="op" id="8205554">;</span>&nbsp;<span class="ident" id="8205556">i</span>&nbsp;<span class="op" id="8205558">&lt;</span>&nbsp;<span class="ident" id="8205560">N</span><span class="op" id="8205561">;</span>&nbsp;<span class="ident" id="8205563">i</span><span class="op" id="8205564">++</span>&nbsp;<span class="op" id="8205567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8205573">switch</span>&nbsp;<span class="ident" id="8205580">r</span><span class="op" id="8205581">.</span><span class="ident" id="8205582">Intn</span><span class="op" id="8205586">(</span><span class="num" id="8205587">3</span><span class="op" id="8205588">)</span>&nbsp;<span class="op" id="8205590">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8205596">case</span>&nbsp;<span class="num" id="8205601">0</span><span class="op" id="8205602">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8205609">if</span>&nbsp;<span class="op" id="8205612">!</span><span class="ident" id="8205613">mu</span><span class="op" id="8205615">.</span><span class="ident" id="8205616">Incref</span><span class="op" id="8205622">(</span><span class="op" id="8205623">)</span>&nbsp;<span class="op" id="8205625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8205633">t</span><span class="op" id="8205634">.</span><span class="ident" id="8205635">Error</span><span class="op" id="8205640">(</span><span class="string" id="8205641">&#34;broken&#34;</span><span class="op" id="8205649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8205657">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8205669">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8205676">if</span>&nbsp;<span class="ident" id="8205679">mu</span><span class="op" id="8205681">.</span><span class="ident" id="8205682">Decref</span><span class="op" id="8205688">(</span><span class="op" id="8205689">)</span>&nbsp;<span class="op" id="8205691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8205699">t</span><span class="op" id="8205700">.</span><span class="ident" id="8205701">Error</span><span class="op" id="8205706">(</span><span class="string" id="8205707">&#34;broken&#34;</span><span class="op" id="8205715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8205723">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8205735">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8205741">case</span>&nbsp;<span class="num" id="8205746">1</span><span class="op" id="8205747">:</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8205754">if</span>&nbsp;<span class="op" id="8205757">!</span><span class="ident" id="8205758">mu</span><span class="op" id="8205760">.</span><span class="ident" id="8205761">RWLock</span><span class="op" id="8205767">(</span><span class="builtintype" id="8205768">true</span><span class="op" id="8205772">)</span>&nbsp;<span class="op" id="8205774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8205782">t</span><span class="op" id="8205783">.</span><span class="ident" id="8205784">Error</span><span class="op" id="8205789">(</span><span class="string" id="8205790">&#34;broken&#34;</span><span class="op" id="8205798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8205806">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8205818">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8205825">//&nbsp;Ensure&nbsp;that&nbsp;it&nbsp;provides&nbsp;mutual&nbsp;exclusion&nbsp;for&nbsp;readers.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8205887">if</span>&nbsp;<span class="ident" id="8205890">readState</span><span class="op" id="8205899">[</span><span class="num" id="8205900">0</span><span class="op" id="8205901">]</span>&nbsp;<span class="op" id="8205903">!=</span>&nbsp;<span class="ident" id="8205906">readState</span><span class="op" id="8205915">[</span><span class="num" id="8205916">1</span><span class="op" id="8205917">]</span>&nbsp;<span class="op" id="8205919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8205927">t</span><span class="op" id="8205928">.</span><span class="ident" id="8205929">Error</span><span class="op" id="8205934">(</span><span class="string" id="8205935">&#34;broken&#34;</span><span class="op" id="8205943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8205951">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8205963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8205970">readState</span><span class="op" id="8205979">[</span><span class="num" id="8205980">0</span><span class="op" id="8205981">]</span><span class="op" id="8205982">++</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8205990">readState</span><span class="op" id="8205999">[</span><span class="num" id="8206000">1</span><span class="op" id="8206001">]</span><span class="op" id="8206002">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8206010">if</span>&nbsp;<span class="ident" id="8206013">mu</span><span class="op" id="8206015">.</span><span class="ident" id="8206016">RWUnlock</span><span class="op" id="8206024">(</span><span class="builtintype" id="8206025">true</span><span class="op" id="8206029">)</span>&nbsp;<span class="op" id="8206031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8206039">t</span><span class="op" id="8206040">.</span><span class="ident" id="8206041">Error</span><span class="op" id="8206046">(</span><span class="string" id="8206047">&#34;broken&#34;</span><span class="op" id="8206055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8206063">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8206075">}</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8206081">case</span>&nbsp;<span class="num" id="8206086">2</span><span class="op" id="8206087">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8206094">if</span>&nbsp;<span class="op" id="8206097">!</span><span class="ident" id="8206098">mu</span><span class="op" id="8206100">.</span><span class="ident" id="8206101">RWLock</span><span class="op" id="8206107">(</span><span class="builtintype" id="8206108">false</span><span class="op" id="8206113">)</span>&nbsp;<span class="op" id="8206115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8206123">t</span><span class="op" id="8206124">.</span><span class="ident" id="8206125">Error</span><span class="op" id="8206130">(</span><span class="string" id="8206131">&#34;broken&#34;</span><span class="op" id="8206139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8206147">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8206159">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8206166">//&nbsp;Ensure&nbsp;that&nbsp;it&nbsp;provides&nbsp;mutual&nbsp;exclusion&nbsp;for&nbsp;writers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8206228">if</span>&nbsp;<span class="ident" id="8206231">writeState</span><span class="op" id="8206241">[</span><span class="num" id="8206242">0</span><span class="op" id="8206243">]</span>&nbsp;<span class="op" id="8206245">!=</span>&nbsp;<span class="ident" id="8206248">writeState</span><span class="op" id="8206258">[</span><span class="num" id="8206259">1</span><span class="op" id="8206260">]</span>&nbsp;<span class="op" id="8206262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8206270">t</span><span class="op" id="8206271">.</span><span class="ident" id="8206272">Error</span><span class="op" id="8206277">(</span><span class="string" id="8206278">&#34;broken&#34;</span><span class="op" id="8206286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8206294">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8206306">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8206313">writeState</span><span class="op" id="8206323">[</span><span class="num" id="8206324">0</span><span class="op" id="8206325">]</span><span class="op" id="8206326">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8206334">writeState</span><span class="op" id="8206344">[</span><span class="num" id="8206345">1</span><span class="op" id="8206346">]</span><span class="op" id="8206347">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8206355">if</span>&nbsp;<span class="ident" id="8206358">mu</span><span class="op" id="8206360">.</span><span class="ident" id="8206361">RWUnlock</span><span class="op" id="8206369">(</span><span class="builtintype" id="8206370">false</span><span class="op" id="8206375">)</span>&nbsp;<span class="op" id="8206377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8206385">t</span><span class="op" id="8206386">.</span><span class="ident" id="8206387">Error</span><span class="op" id="8206392">(</span><span class="string" id="8206393">&#34;broken&#34;</span><span class="op" id="8206401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8206409">return</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8206421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8206427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8206432">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8206437">done</span>&nbsp;<span class="op" id="8206442">&lt;-</span>&nbsp;<span class="builtintype" id="8206445">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8206452">}</span><span class="op" id="8206453">(</span><span class="op" id="8206454">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8206457">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8206460">for</span>&nbsp;<span class="ident" id="8206464">p</span>&nbsp;<span class="op" id="8206466">:=</span>&nbsp;<span class="num" id="8206469">0</span><span class="op" id="8206470">;</span>&nbsp;<span class="ident" id="8206472">p</span>&nbsp;<span class="op" id="8206474">&lt;</span>&nbsp;<span class="ident" id="8206476">P</span><span class="op" id="8206477">;</span>&nbsp;<span class="ident" id="8206479">p</span><span class="op" id="8206480">++</span>&nbsp;<span class="op" id="8206483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8206487">&lt;-</span><span class="ident" id="8206489">done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8206495">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8206498">if</span>&nbsp;<span class="op" id="8206501">!</span><span class="ident" id="8206502">mu</span><span class="op" id="8206504">.</span><span class="ident" id="8206505">IncrefAndClose</span><span class="op" id="8206519">(</span><span class="op" id="8206520">)</span>&nbsp;<span class="op" id="8206522">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8206526">t</span><span class="op" id="8206527">.</span><span class="ident" id="8206528">Fatal</span><span class="op" id="8206533">(</span><span class="string" id="8206534">&#34;broken&#34;</span><span class="op" id="8206542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8206545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8206548">if</span>&nbsp;<span class="op" id="8206551">!</span><span class="ident" id="8206552">mu</span><span class="op" id="8206554">.</span><span class="ident" id="8206555">Decref</span><span class="op" id="8206561">(</span><span class="op" id="8206562">)</span>&nbsp;<span class="op" id="8206564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8206568">t</span><span class="op" id="8206569">.</span><span class="ident" id="8206570">Fatal</span><span class="op" id="8206575">(</span><span class="string" id="8206576">&#34;broken&#34;</span><span class="op" id="8206584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8206587">}</span><br>
<span class="lineno">195</span><span class="op" id="8206589">}</span>
</div>
</body>
</html>
