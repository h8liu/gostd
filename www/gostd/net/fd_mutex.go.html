<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4040675">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4040730">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4040784">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4040835">package</span>&nbsp;<span class="ident" id="4040843">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4040848">import</span>&nbsp;<span class="string" id="4040855">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4040870">//&nbsp;fdMutex&nbsp;is&nbsp;a&nbsp;specialized&nbsp;synchronization&nbsp;primitive</span><br>
<span class="lineno">10</span><span class="comment" id="4040924">//&nbsp;that&nbsp;manages&nbsp;lifetime&nbsp;of&nbsp;an&nbsp;fd&nbsp;and&nbsp;serializes&nbsp;access</span><br>
<span class="lineno"></span><span class="comment" id="4040980">//&nbsp;to&nbsp;Read&nbsp;and&nbsp;Write&nbsp;methods&nbsp;on&nbsp;netFD.</span><br>
<span class="lineno"></span><span class="keyword" id="4041019">type</span>&nbsp;<span class="ident" id="4041024">fdMutex</span>&nbsp;<span class="keyword" id="4041032">struct</span>&nbsp;<span class="op" id="4041039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4041042">state</span>&nbsp;<span class="ident" id="4041048">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4041056">rsema</span>&nbsp;<span class="builtintype" id="4041062">uint32</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4041070">wsema</span>&nbsp;<span class="builtintype" id="4041076">uint32</span><br>
<span class="lineno"></span><span class="op" id="4041083">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4041086">//&nbsp;fdMutex.state&nbsp;is&nbsp;organized&nbsp;as&nbsp;follows:</span><br>
<span class="lineno"></span><span class="comment" id="4041128">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;whether&nbsp;netFD&nbsp;is&nbsp;closed,&nbsp;if&nbsp;set&nbsp;all&nbsp;subsequent&nbsp;lock&nbsp;operations&nbsp;will&nbsp;fail.</span><br>
<span class="lineno">20</span><span class="comment" id="4041213">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;lock&nbsp;for&nbsp;read&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="4041250">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;lock&nbsp;for&nbsp;write&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="4041288">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;total&nbsp;number&nbsp;of&nbsp;references&nbsp;(read+write+misc).</span><br>
<span class="lineno"></span><span class="comment" id="4041347">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;read&nbsp;waiters.</span><br>
<span class="lineno"></span><span class="comment" id="4041396">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;write&nbsp;waiters.</span><br>
<span class="lineno">25</span><span class="keyword" id="4041446">const</span>&nbsp;<span class="op" id="4041452">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4041455">mutexClosed</span>&nbsp;&nbsp;<span class="op" id="4041468">=</span>&nbsp;<span class="num" id="4041470">1</span>&nbsp;<span class="op" id="4041472">&lt;&lt;</span>&nbsp;<span class="num" id="4041475">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4041478">mutexRLock</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4041491">=</span>&nbsp;<span class="num" id="4041493">1</span>&nbsp;<span class="op" id="4041495">&lt;&lt;</span>&nbsp;<span class="num" id="4041498">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4041501">mutexWLock</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4041514">=</span>&nbsp;<span class="num" id="4041516">1</span>&nbsp;<span class="op" id="4041518">&lt;&lt;</span>&nbsp;<span class="num" id="4041521">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4041524">mutexRef</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4041537">=</span>&nbsp;<span class="num" id="4041539">1</span>&nbsp;<span class="op" id="4041541">&lt;&lt;</span>&nbsp;<span class="num" id="4041544">3</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4041547">mutexRefMask</span>&nbsp;<span class="op" id="4041560">=</span>&nbsp;<span class="op" id="4041562">(</span><span class="num" id="4041563">1</span><span class="op" id="4041564">&lt;&lt;</span><span class="num" id="4041566">20</span>&nbsp;<span class="op" id="4041569">-</span>&nbsp;<span class="num" id="4041571">1</span><span class="op" id="4041572">)</span>&nbsp;<span class="op" id="4041574">&lt;&lt;</span>&nbsp;<span class="num" id="4041577">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4041580">mutexRWait</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4041593">=</span>&nbsp;<span class="num" id="4041595">1</span>&nbsp;<span class="op" id="4041597">&lt;&lt;</span>&nbsp;<span class="num" id="4041600">23</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4041604">mutexRMask</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4041617">=</span>&nbsp;<span class="op" id="4041619">(</span><span class="num" id="4041620">1</span><span class="op" id="4041621">&lt;&lt;</span><span class="num" id="4041623">20</span>&nbsp;<span class="op" id="4041626">-</span>&nbsp;<span class="num" id="4041628">1</span><span class="op" id="4041629">)</span>&nbsp;<span class="op" id="4041631">&lt;&lt;</span>&nbsp;<span class="num" id="4041634">23</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4041638">mutexWWait</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4041651">=</span>&nbsp;<span class="num" id="4041653">1</span>&nbsp;<span class="op" id="4041655">&lt;&lt;</span>&nbsp;<span class="num" id="4041658">43</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4041662">mutexWMask</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4041675">=</span>&nbsp;<span class="op" id="4041677">(</span><span class="num" id="4041678">1</span><span class="op" id="4041679">&lt;&lt;</span><span class="num" id="4041681">20</span>&nbsp;<span class="op" id="4041684">-</span>&nbsp;<span class="num" id="4041686">1</span><span class="op" id="4041687">)</span>&nbsp;<span class="op" id="4041689">&lt;&lt;</span>&nbsp;<span class="num" id="4041692">43</span><br>
<span class="lineno">35</span><span class="op" id="4041695">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4041698">//&nbsp;Read&nbsp;operations&nbsp;must&nbsp;do&nbsp;RWLock(true)/RWUnlock(true).</span><br>
<span class="lineno"></span><span class="comment" id="4041754">//&nbsp;Write&nbsp;operations&nbsp;must&nbsp;do&nbsp;RWLock(false)/RWUnlock(false).</span><br>
<span class="lineno"></span><span class="comment" id="4041813">//&nbsp;Misc&nbsp;operations&nbsp;must&nbsp;do&nbsp;Incref/Decref.&nbsp;Misc&nbsp;operations&nbsp;include&nbsp;functions&nbsp;like</span><br>
<span class="lineno">40</span><span class="comment" id="4041894">//&nbsp;setsockopt&nbsp;and&nbsp;setDeadline.&nbsp;They&nbsp;need&nbsp;to&nbsp;use&nbsp;Incref/Decref&nbsp;to&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="4041971">//&nbsp;they&nbsp;operate&nbsp;on&nbsp;the&nbsp;correct&nbsp;fd&nbsp;in&nbsp;presence&nbsp;of&nbsp;a&nbsp;concurrent&nbsp;Close&nbsp;call</span><br>
<span class="lineno"></span><span class="comment" id="4042044">//&nbsp;(otherwise&nbsp;fd&nbsp;can&nbsp;be&nbsp;closed&nbsp;under&nbsp;their&nbsp;feet).</span><br>
<span class="lineno"></span><span class="comment" id="4042094">//&nbsp;Close&nbsp;operation&nbsp;must&nbsp;do&nbsp;IncrefAndClose/Decref.</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="4042145">//&nbsp;RWLock/Incref&nbsp;return&nbsp;whether&nbsp;fd&nbsp;is&nbsp;open.</span><br>
<span class="lineno"></span><span class="comment" id="4042189">//&nbsp;RWUnlock/Decref&nbsp;return&nbsp;whether&nbsp;fd&nbsp;is&nbsp;closed&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;remaining&nbsp;references.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4042276">func</span>&nbsp;<span class="op" id="4042281">(</span><span class="ident" id="4042282">mu</span>&nbsp;<span class="op" id="4042285">*</span><span class="ident" id="4042286">fdMutex</span><span class="op" id="4042293">)</span>&nbsp;<span class="ident" id="4042295">Incref</span><span class="op" id="4042301">(</span><span class="op" id="4042302">)</span>&nbsp;<span class="builtintype" id="4042304">bool</span>&nbsp;<span class="op" id="4042309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4042312">for</span>&nbsp;<span class="op" id="4042316">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4042320">old</span>&nbsp;<span class="op" id="4042324">:=</span>&nbsp;<span class="ident" id="4042327">atomic</span><span class="op" id="4042333">.</span><span class="ident" id="4042334">LoadUint64</span><span class="op" id="4042344">(</span><span class="op" id="4042345">&amp;</span><span class="ident" id="4042346">mu</span><span class="op" id="4042348">.</span><span class="ident" id="4042349">state</span><span class="op" id="4042354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4042358">if</span>&nbsp;<span class="ident" id="4042361">old</span><span class="op" id="4042364">&amp;</span><span class="ident" id="4042365">mutexClosed</span>&nbsp;<span class="op" id="4042377">!=</span>&nbsp;<span class="num" id="4042380">0</span>&nbsp;<span class="op" id="4042382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4042387">return</span>&nbsp;<span class="builtintype" id="4042394">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4042402">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4042406">new</span>&nbsp;<span class="op" id="4042410">:=</span>&nbsp;<span class="ident" id="4042413">old</span>&nbsp;<span class="op" id="4042417">+</span>&nbsp;<span class="ident" id="4042419">mutexRef</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4042430">if</span>&nbsp;<span class="builtinfunc" id="4042433">new</span><span class="op" id="4042436">&amp;</span><span class="ident" id="4042437">mutexRefMask</span>&nbsp;<span class="op" id="4042450">==</span>&nbsp;<span class="num" id="4042453">0</span>&nbsp;<span class="op" id="4042455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4042460">panic</span><span class="op" id="4042465">(</span><span class="string" id="4042466">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="4042493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4042497">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4042501">if</span>&nbsp;<span class="ident" id="4042504">atomic</span><span class="op" id="4042510">.</span><span class="ident" id="4042511">CompareAndSwapUint64</span><span class="op" id="4042531">(</span><span class="op" id="4042532">&amp;</span><span class="ident" id="4042533">mu</span><span class="op" id="4042535">.</span><span class="ident" id="4042536">state</span><span class="op" id="4042541">,</span>&nbsp;<span class="ident" id="4042543">old</span><span class="op" id="4042546">,</span>&nbsp;<span class="builtinfunc" id="4042548">new</span><span class="op" id="4042551">)</span>&nbsp;<span class="op" id="4042553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4042558">return</span>&nbsp;<span class="builtintype" id="4042565">true</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4042572">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4042575">}</span><br>
<span class="lineno"></span><span class="op" id="4042577">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4042580">func</span>&nbsp;<span class="op" id="4042585">(</span><span class="ident" id="4042586">mu</span>&nbsp;<span class="op" id="4042589">*</span><span class="ident" id="4042590">fdMutex</span><span class="op" id="4042597">)</span>&nbsp;<span class="ident" id="4042599">IncrefAndClose</span><span class="op" id="4042613">(</span><span class="op" id="4042614">)</span>&nbsp;<span class="builtintype" id="4042616">bool</span>&nbsp;<span class="op" id="4042621">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4042624">for</span>&nbsp;<span class="op" id="4042628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4042632">old</span>&nbsp;<span class="op" id="4042636">:=</span>&nbsp;<span class="ident" id="4042639">atomic</span><span class="op" id="4042645">.</span><span class="ident" id="4042646">LoadUint64</span><span class="op" id="4042656">(</span><span class="op" id="4042657">&amp;</span><span class="ident" id="4042658">mu</span><span class="op" id="4042660">.</span><span class="ident" id="4042661">state</span><span class="op" id="4042666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4042670">if</span>&nbsp;<span class="ident" id="4042673">old</span><span class="op" id="4042676">&amp;</span><span class="ident" id="4042677">mutexClosed</span>&nbsp;<span class="op" id="4042689">!=</span>&nbsp;<span class="num" id="4042692">0</span>&nbsp;<span class="op" id="4042694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4042699">return</span>&nbsp;<span class="builtintype" id="4042706">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4042714">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4042718">//&nbsp;Mark&nbsp;as&nbsp;closed&nbsp;and&nbsp;acquire&nbsp;a&nbsp;reference.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4042763">new</span>&nbsp;<span class="op" id="4042767">:=</span>&nbsp;<span class="op" id="4042770">(</span><span class="ident" id="4042771">old</span>&nbsp;<span class="op" id="4042775">|</span>&nbsp;<span class="ident" id="4042777">mutexClosed</span><span class="op" id="4042788">)</span>&nbsp;<span class="op" id="4042790">+</span>&nbsp;<span class="ident" id="4042792">mutexRef</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4042803">if</span>&nbsp;<span class="builtinfunc" id="4042806">new</span><span class="op" id="4042809">&amp;</span><span class="ident" id="4042810">mutexRefMask</span>&nbsp;<span class="op" id="4042823">==</span>&nbsp;<span class="num" id="4042826">0</span>&nbsp;<span class="op" id="4042828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4042833">panic</span><span class="op" id="4042838">(</span><span class="string" id="4042839">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="4042866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4042870">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4042874">//&nbsp;Remove&nbsp;all&nbsp;read&nbsp;and&nbsp;write&nbsp;waiters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4042914">new</span>&nbsp;<span class="op" id="4042918">&amp;^=</span>&nbsp;<span class="ident" id="4042922">mutexRMask</span>&nbsp;<span class="op" id="4042933">|</span>&nbsp;<span class="ident" id="4042935">mutexWMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4042948">if</span>&nbsp;<span class="ident" id="4042951">atomic</span><span class="op" id="4042957">.</span><span class="ident" id="4042958">CompareAndSwapUint64</span><span class="op" id="4042978">(</span><span class="op" id="4042979">&amp;</span><span class="ident" id="4042980">mu</span><span class="op" id="4042982">.</span><span class="ident" id="4042983">state</span><span class="op" id="4042988">,</span>&nbsp;<span class="ident" id="4042990">old</span><span class="op" id="4042993">,</span>&nbsp;<span class="builtinfunc" id="4042995">new</span><span class="op" id="4042998">)</span>&nbsp;<span class="op" id="4043000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4043005">//&nbsp;Wake&nbsp;all&nbsp;read&nbsp;and&nbsp;write&nbsp;waiters,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4043044">//&nbsp;they&nbsp;will&nbsp;observe&nbsp;closed&nbsp;flag&nbsp;after&nbsp;wakeup.</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4043094">for</span>&nbsp;<span class="ident" id="4043098">old</span><span class="op" id="4043101">&amp;</span><span class="ident" id="4043102">mutexRMask</span>&nbsp;<span class="op" id="4043113">!=</span>&nbsp;<span class="num" id="4043116">0</span>&nbsp;<span class="op" id="4043118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4043124">old</span>&nbsp;<span class="op" id="4043128">-=</span>&nbsp;<span class="ident" id="4043131">mutexRWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4043146">runtime_Semrelease</span><span class="op" id="4043164">(</span><span class="op" id="4043165">&amp;</span><span class="ident" id="4043166">mu</span><span class="op" id="4043168">.</span><span class="ident" id="4043169">rsema</span><span class="op" id="4043174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4043179">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4043184">for</span>&nbsp;<span class="ident" id="4043188">old</span><span class="op" id="4043191">&amp;</span><span class="ident" id="4043192">mutexWMask</span>&nbsp;<span class="op" id="4043203">!=</span>&nbsp;<span class="num" id="4043206">0</span>&nbsp;<span class="op" id="4043208">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4043214">old</span>&nbsp;<span class="op" id="4043218">-=</span>&nbsp;<span class="ident" id="4043221">mutexWWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4043236">runtime_Semrelease</span><span class="op" id="4043254">(</span><span class="op" id="4043255">&amp;</span><span class="ident" id="4043256">mu</span><span class="op" id="4043258">.</span><span class="ident" id="4043259">wsema</span><span class="op" id="4043264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4043269">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4043274">return</span>&nbsp;<span class="builtintype" id="4043281">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4043288">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4043291">}</span><br>
<span class="lineno"></span><span class="op" id="4043293">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4043296">func</span>&nbsp;<span class="op" id="4043301">(</span><span class="ident" id="4043302">mu</span>&nbsp;<span class="op" id="4043305">*</span><span class="ident" id="4043306">fdMutex</span><span class="op" id="4043313">)</span>&nbsp;<span class="ident" id="4043315">Decref</span><span class="op" id="4043321">(</span><span class="op" id="4043322">)</span>&nbsp;<span class="builtintype" id="4043324">bool</span>&nbsp;<span class="op" id="4043329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4043332">for</span>&nbsp;<span class="op" id="4043336">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4043340">old</span>&nbsp;<span class="op" id="4043344">:=</span>&nbsp;<span class="ident" id="4043347">atomic</span><span class="op" id="4043353">.</span><span class="ident" id="4043354">LoadUint64</span><span class="op" id="4043364">(</span><span class="op" id="4043365">&amp;</span><span class="ident" id="4043366">mu</span><span class="op" id="4043368">.</span><span class="ident" id="4043369">state</span><span class="op" id="4043374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4043378">if</span>&nbsp;<span class="ident" id="4043381">old</span><span class="op" id="4043384">&amp;</span><span class="ident" id="4043385">mutexRefMask</span>&nbsp;<span class="op" id="4043398">==</span>&nbsp;<span class="num" id="4043401">0</span>&nbsp;<span class="op" id="4043403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4043408">panic</span><span class="op" id="4043413">(</span><span class="string" id="4043414">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="4043441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4043445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4043449">new</span>&nbsp;<span class="op" id="4043453">:=</span>&nbsp;<span class="ident" id="4043456">old</span>&nbsp;<span class="op" id="4043460">-</span>&nbsp;<span class="ident" id="4043462">mutexRef</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4043473">if</span>&nbsp;<span class="ident" id="4043476">atomic</span><span class="op" id="4043482">.</span><span class="ident" id="4043483">CompareAndSwapUint64</span><span class="op" id="4043503">(</span><span class="op" id="4043504">&amp;</span><span class="ident" id="4043505">mu</span><span class="op" id="4043507">.</span><span class="ident" id="4043508">state</span><span class="op" id="4043513">,</span>&nbsp;<span class="ident" id="4043515">old</span><span class="op" id="4043518">,</span>&nbsp;<span class="builtinfunc" id="4043520">new</span><span class="op" id="4043523">)</span>&nbsp;<span class="op" id="4043525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4043530">return</span>&nbsp;<span class="builtinfunc" id="4043537">new</span><span class="op" id="4043540">&amp;</span><span class="op" id="4043541">(</span><span class="ident" id="4043542">mutexClosed</span><span class="op" id="4043553">|</span><span class="ident" id="4043554">mutexRefMask</span><span class="op" id="4043566">)</span>&nbsp;<span class="op" id="4043568">==</span>&nbsp;<span class="ident" id="4043571">mutexClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4043585">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4043588">}</span><br>
<span class="lineno"></span><span class="op" id="4043590">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="4043593">func</span>&nbsp;<span class="op" id="4043598">(</span><span class="ident" id="4043599">mu</span>&nbsp;<span class="op" id="4043602">*</span><span class="ident" id="4043603">fdMutex</span><span class="op" id="4043610">)</span>&nbsp;<span class="ident" id="4043612">RWLock</span><span class="op" id="4043618">(</span><span class="ident" id="4043619">read</span>&nbsp;<span class="builtintype" id="4043624">bool</span><span class="op" id="4043628">)</span>&nbsp;<span class="builtintype" id="4043630">bool</span>&nbsp;<span class="op" id="4043635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4043638">var</span>&nbsp;<span class="ident" id="4043642">mutexBit</span><span class="op" id="4043650">,</span>&nbsp;<span class="ident" id="4043652">mutexWait</span><span class="op" id="4043661">,</span>&nbsp;<span class="ident" id="4043663">mutexMask</span>&nbsp;<span class="ident" id="4043673">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4043681">var</span>&nbsp;<span class="ident" id="4043685">mutexSema</span>&nbsp;<span class="op" id="4043695">*</span><span class="builtintype" id="4043696">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4043704">if</span>&nbsp;<span class="ident" id="4043707">read</span>&nbsp;<span class="op" id="4043712">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4043716">mutexBit</span>&nbsp;<span class="op" id="4043725">=</span>&nbsp;<span class="ident" id="4043727">mutexRLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4043740">mutexWait</span>&nbsp;<span class="op" id="4043750">=</span>&nbsp;<span class="ident" id="4043752">mutexRWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4043765">mutexMask</span>&nbsp;<span class="op" id="4043775">=</span>&nbsp;<span class="ident" id="4043777">mutexRMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4043790">mutexSema</span>&nbsp;<span class="op" id="4043800">=</span>&nbsp;<span class="op" id="4043802">&amp;</span><span class="ident" id="4043803">mu</span><span class="op" id="4043805">.</span><span class="ident" id="4043806">rsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4043813">}</span>&nbsp;<span class="keyword" id="4043815">else</span>&nbsp;<span class="op" id="4043820">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4043824">mutexBit</span>&nbsp;<span class="op" id="4043833">=</span>&nbsp;<span class="ident" id="4043835">mutexWLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4043848">mutexWait</span>&nbsp;<span class="op" id="4043858">=</span>&nbsp;<span class="ident" id="4043860">mutexWWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4043873">mutexMask</span>&nbsp;<span class="op" id="4043883">=</span>&nbsp;<span class="ident" id="4043885">mutexWMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4043898">mutexSema</span>&nbsp;<span class="op" id="4043908">=</span>&nbsp;<span class="op" id="4043910">&amp;</span><span class="ident" id="4043911">mu</span><span class="op" id="4043913">.</span><span class="ident" id="4043914">wsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4043921">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4043924">for</span>&nbsp;<span class="op" id="4043928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4043932">old</span>&nbsp;<span class="op" id="4043936">:=</span>&nbsp;<span class="ident" id="4043939">atomic</span><span class="op" id="4043945">.</span><span class="ident" id="4043946">LoadUint64</span><span class="op" id="4043956">(</span><span class="op" id="4043957">&amp;</span><span class="ident" id="4043958">mu</span><span class="op" id="4043960">.</span><span class="ident" id="4043961">state</span><span class="op" id="4043966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4043970">if</span>&nbsp;<span class="ident" id="4043973">old</span><span class="op" id="4043976">&amp;</span><span class="ident" id="4043977">mutexClosed</span>&nbsp;<span class="op" id="4043989">!=</span>&nbsp;<span class="num" id="4043992">0</span>&nbsp;<span class="op" id="4043994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4043999">return</span>&nbsp;<span class="builtintype" id="4044006">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4044014">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4044018">var</span>&nbsp;<span class="builtinfunc" id="4044022">new</span>&nbsp;<span class="ident" id="4044026">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4044035">if</span>&nbsp;<span class="ident" id="4044038">old</span><span class="op" id="4044041">&amp;</span><span class="ident" id="4044042">mutexBit</span>&nbsp;<span class="op" id="4044051">==</span>&nbsp;<span class="num" id="4044054">0</span>&nbsp;<span class="op" id="4044056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4044061">//&nbsp;Lock&nbsp;is&nbsp;free,&nbsp;acquire&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4044093">new</span>&nbsp;<span class="op" id="4044097">=</span>&nbsp;<span class="op" id="4044099">(</span><span class="ident" id="4044100">old</span>&nbsp;<span class="op" id="4044104">|</span>&nbsp;<span class="ident" id="4044106">mutexBit</span><span class="op" id="4044114">)</span>&nbsp;<span class="op" id="4044116">+</span>&nbsp;<span class="ident" id="4044118">mutexRef</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4044130">if</span>&nbsp;<span class="builtinfunc" id="4044133">new</span><span class="op" id="4044136">&amp;</span><span class="ident" id="4044137">mutexRefMask</span>&nbsp;<span class="op" id="4044150">==</span>&nbsp;<span class="num" id="4044153">0</span>&nbsp;<span class="op" id="4044155">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4044161">panic</span><span class="op" id="4044166">(</span><span class="string" id="4044167">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="4044194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4044199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4044203">}</span>&nbsp;<span class="keyword" id="4044205">else</span>&nbsp;<span class="op" id="4044210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4044215">//&nbsp;Wait&nbsp;for&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4044236">new</span>&nbsp;<span class="op" id="4044240">=</span>&nbsp;<span class="ident" id="4044242">old</span>&nbsp;<span class="op" id="4044246">+</span>&nbsp;<span class="ident" id="4044248">mutexWait</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4044261">if</span>&nbsp;<span class="builtinfunc" id="4044264">new</span><span class="op" id="4044267">&amp;</span><span class="ident" id="4044268">mutexMask</span>&nbsp;<span class="op" id="4044278">==</span>&nbsp;<span class="num" id="4044281">0</span>&nbsp;<span class="op" id="4044283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4044289">panic</span><span class="op" id="4044294">(</span><span class="string" id="4044295">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="4044322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4044327">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4044331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4044335">if</span>&nbsp;<span class="ident" id="4044338">atomic</span><span class="op" id="4044344">.</span><span class="ident" id="4044345">CompareAndSwapUint64</span><span class="op" id="4044365">(</span><span class="op" id="4044366">&amp;</span><span class="ident" id="4044367">mu</span><span class="op" id="4044369">.</span><span class="ident" id="4044370">state</span><span class="op" id="4044375">,</span>&nbsp;<span class="ident" id="4044377">old</span><span class="op" id="4044380">,</span>&nbsp;<span class="builtinfunc" id="4044382">new</span><span class="op" id="4044385">)</span>&nbsp;<span class="op" id="4044387">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4044392">if</span>&nbsp;<span class="ident" id="4044395">old</span><span class="op" id="4044398">&amp;</span><span class="ident" id="4044399">mutexBit</span>&nbsp;<span class="op" id="4044408">==</span>&nbsp;<span class="num" id="4044411">0</span>&nbsp;<span class="op" id="4044413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4044419">return</span>&nbsp;<span class="builtintype" id="4044426">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4044434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4044439">runtime_Semacquire</span><span class="op" id="4044457">(</span><span class="ident" id="4044458">mutexSema</span><span class="op" id="4044467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4044472">//&nbsp;The&nbsp;signaller&nbsp;has&nbsp;subtracted&nbsp;mutexWait.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4044517">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4044520">}</span><br>
<span class="lineno"></span><span class="op" id="4044522">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4044525">func</span>&nbsp;<span class="op" id="4044530">(</span><span class="ident" id="4044531">mu</span>&nbsp;<span class="op" id="4044534">*</span><span class="ident" id="4044535">fdMutex</span><span class="op" id="4044542">)</span>&nbsp;<span class="ident" id="4044544">RWUnlock</span><span class="op" id="4044552">(</span><span class="ident" id="4044553">read</span>&nbsp;<span class="builtintype" id="4044558">bool</span><span class="op" id="4044562">)</span>&nbsp;<span class="builtintype" id="4044564">bool</span>&nbsp;<span class="op" id="4044569">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4044572">var</span>&nbsp;<span class="ident" id="4044576">mutexBit</span><span class="op" id="4044584">,</span>&nbsp;<span class="ident" id="4044586">mutexWait</span><span class="op" id="4044595">,</span>&nbsp;<span class="ident" id="4044597">mutexMask</span>&nbsp;<span class="ident" id="4044607">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4044615">var</span>&nbsp;<span class="ident" id="4044619">mutexSema</span>&nbsp;<span class="op" id="4044629">*</span><span class="builtintype" id="4044630">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4044638">if</span>&nbsp;<span class="ident" id="4044641">read</span>&nbsp;<span class="op" id="4044646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4044650">mutexBit</span>&nbsp;<span class="op" id="4044659">=</span>&nbsp;<span class="ident" id="4044661">mutexRLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4044674">mutexWait</span>&nbsp;<span class="op" id="4044684">=</span>&nbsp;<span class="ident" id="4044686">mutexRWait</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4044699">mutexMask</span>&nbsp;<span class="op" id="4044709">=</span>&nbsp;<span class="ident" id="4044711">mutexRMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4044724">mutexSema</span>&nbsp;<span class="op" id="4044734">=</span>&nbsp;<span class="op" id="4044736">&amp;</span><span class="ident" id="4044737">mu</span><span class="op" id="4044739">.</span><span class="ident" id="4044740">rsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4044747">}</span>&nbsp;<span class="keyword" id="4044749">else</span>&nbsp;<span class="op" id="4044754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4044758">mutexBit</span>&nbsp;<span class="op" id="4044767">=</span>&nbsp;<span class="ident" id="4044769">mutexWLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4044782">mutexWait</span>&nbsp;<span class="op" id="4044792">=</span>&nbsp;<span class="ident" id="4044794">mutexWWait</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4044807">mutexMask</span>&nbsp;<span class="op" id="4044817">=</span>&nbsp;<span class="ident" id="4044819">mutexWMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4044832">mutexSema</span>&nbsp;<span class="op" id="4044842">=</span>&nbsp;<span class="op" id="4044844">&amp;</span><span class="ident" id="4044845">mu</span><span class="op" id="4044847">.</span><span class="ident" id="4044848">wsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4044855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4044858">for</span>&nbsp;<span class="op" id="4044862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4044866">old</span>&nbsp;<span class="op" id="4044870">:=</span>&nbsp;<span class="ident" id="4044873">atomic</span><span class="op" id="4044879">.</span><span class="ident" id="4044880">LoadUint64</span><span class="op" id="4044890">(</span><span class="op" id="4044891">&amp;</span><span class="ident" id="4044892">mu</span><span class="op" id="4044894">.</span><span class="ident" id="4044895">state</span><span class="op" id="4044900">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4044904">if</span>&nbsp;<span class="ident" id="4044907">old</span><span class="op" id="4044910">&amp;</span><span class="ident" id="4044911">mutexBit</span>&nbsp;<span class="op" id="4044920">==</span>&nbsp;<span class="num" id="4044923">0</span>&nbsp;<span class="op" id="4044925">||</span>&nbsp;<span class="ident" id="4044928">old</span><span class="op" id="4044931">&amp;</span><span class="ident" id="4044932">mutexRefMask</span>&nbsp;<span class="op" id="4044945">==</span>&nbsp;<span class="num" id="4044948">0</span>&nbsp;<span class="op" id="4044950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4044955">panic</span><span class="op" id="4044960">(</span><span class="string" id="4044961">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="4044988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4044992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4044996">//&nbsp;Drop&nbsp;lock,&nbsp;drop&nbsp;reference&nbsp;and&nbsp;wake&nbsp;read&nbsp;waiter&nbsp;if&nbsp;present.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4045060">new</span>&nbsp;<span class="op" id="4045064">:=</span>&nbsp;<span class="op" id="4045067">(</span><span class="ident" id="4045068">old</span>&nbsp;<span class="op" id="4045072">&amp;^</span>&nbsp;<span class="ident" id="4045075">mutexBit</span><span class="op" id="4045083">)</span>&nbsp;<span class="op" id="4045085">-</span>&nbsp;<span class="ident" id="4045087">mutexRef</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4045098">if</span>&nbsp;<span class="ident" id="4045101">old</span><span class="op" id="4045104">&amp;</span><span class="ident" id="4045105">mutexMask</span>&nbsp;<span class="op" id="4045115">!=</span>&nbsp;<span class="num" id="4045118">0</span>&nbsp;<span class="op" id="4045120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4045125">new</span>&nbsp;<span class="op" id="4045129">-=</span>&nbsp;<span class="ident" id="4045132">mutexWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4045144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4045148">if</span>&nbsp;<span class="ident" id="4045151">atomic</span><span class="op" id="4045157">.</span><span class="ident" id="4045158">CompareAndSwapUint64</span><span class="op" id="4045178">(</span><span class="op" id="4045179">&amp;</span><span class="ident" id="4045180">mu</span><span class="op" id="4045182">.</span><span class="ident" id="4045183">state</span><span class="op" id="4045188">,</span>&nbsp;<span class="ident" id="4045190">old</span><span class="op" id="4045193">,</span>&nbsp;<span class="builtinfunc" id="4045195">new</span><span class="op" id="4045198">)</span>&nbsp;<span class="op" id="4045200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4045205">if</span>&nbsp;<span class="ident" id="4045208">old</span><span class="op" id="4045211">&amp;</span><span class="ident" id="4045212">mutexMask</span>&nbsp;<span class="op" id="4045222">!=</span>&nbsp;<span class="num" id="4045225">0</span>&nbsp;<span class="op" id="4045227">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4045233">runtime_Semrelease</span><span class="op" id="4045251">(</span><span class="ident" id="4045252">mutexSema</span><span class="op" id="4045261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4045266">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4045271">return</span>&nbsp;<span class="builtinfunc" id="4045278">new</span><span class="op" id="4045281">&amp;</span><span class="op" id="4045282">(</span><span class="ident" id="4045283">mutexClosed</span><span class="op" id="4045294">|</span><span class="ident" id="4045295">mutexRefMask</span><span class="op" id="4045307">)</span>&nbsp;<span class="op" id="4045309">==</span>&nbsp;<span class="ident" id="4045312">mutexClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4045326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4045329">}</span><br>
<span class="lineno">180</span><span class="op" id="4045331">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4045334">//&nbsp;Implemented&nbsp;in&nbsp;runtime&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="4045369">func</span>&nbsp;<span class="ident" id="4045374">runtime_Semacquire</span><span class="op" id="4045392">(</span><span class="ident" id="4045393">sema</span>&nbsp;<span class="op" id="4045398">*</span><span class="builtintype" id="4045399">uint32</span><span class="op" id="4045405">)</span><br>
<span class="lineno"></span><span class="keyword" id="4045407">func</span>&nbsp;<span class="ident" id="4045412">runtime_Semrelease</span><span class="op" id="4045430">(</span><span class="ident" id="4045431">sema</span>&nbsp;<span class="op" id="4045436">*</span><span class="builtintype" id="4045437">uint32</span><span class="op" id="4045443">)</span>
</div>
</body>
</html>
