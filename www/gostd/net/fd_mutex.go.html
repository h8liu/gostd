<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html" class="current">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3884203">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3884258">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3884312">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3884363">package</span>&nbsp;<span class="ident" id="3884371">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3884376">import</span>&nbsp;<span class="string" id="3884383">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3884398">//&nbsp;fdMutex&nbsp;is&nbsp;a&nbsp;specialized&nbsp;synchronization&nbsp;primitive</span><br>
<span class="lineno">10</span><span class="comment" id="3884452">//&nbsp;that&nbsp;manages&nbsp;lifetime&nbsp;of&nbsp;an&nbsp;fd&nbsp;and&nbsp;serializes&nbsp;access</span><br>
<span class="lineno"></span><span class="comment" id="3884508">//&nbsp;to&nbsp;Read&nbsp;and&nbsp;Write&nbsp;methods&nbsp;on&nbsp;netFD.</span><br>
<span class="lineno"></span><span class="keyword" id="3884547">type</span>&nbsp;<span class="ident" id="3884552">fdMutex</span>&nbsp;<span class="keyword" id="3884560">struct</span>&nbsp;<span class="op" id="3884567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3884570">state</span>&nbsp;<span class="ident" id="3884576">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3884584">rsema</span>&nbsp;<span class="builtintype" id="3884590">uint32</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3884598">wsema</span>&nbsp;<span class="builtintype" id="3884604">uint32</span><br>
<span class="lineno"></span><span class="op" id="3884611">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3884614">//&nbsp;fdMutex.state&nbsp;is&nbsp;organized&nbsp;as&nbsp;follows:</span><br>
<span class="lineno"></span><span class="comment" id="3884656">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;whether&nbsp;netFD&nbsp;is&nbsp;closed,&nbsp;if&nbsp;set&nbsp;all&nbsp;subsequent&nbsp;lock&nbsp;operations&nbsp;will&nbsp;fail.</span><br>
<span class="lineno">20</span><span class="comment" id="3884741">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;lock&nbsp;for&nbsp;read&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="3884778">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;lock&nbsp;for&nbsp;write&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="3884816">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;total&nbsp;number&nbsp;of&nbsp;references&nbsp;(read+write+misc).</span><br>
<span class="lineno"></span><span class="comment" id="3884875">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;read&nbsp;waiters.</span><br>
<span class="lineno"></span><span class="comment" id="3884924">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;write&nbsp;waiters.</span><br>
<span class="lineno">25</span><span class="keyword" id="3884974">const</span>&nbsp;<span class="op" id="3884980">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3884983">mutexClosed</span>&nbsp;&nbsp;<span class="op" id="3884996">=</span>&nbsp;<span class="num" id="3884998">1</span>&nbsp;<span class="op" id="3885000">&lt;&lt;</span>&nbsp;<span class="num" id="3885003">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3885006">mutexRLock</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3885019">=</span>&nbsp;<span class="num" id="3885021">1</span>&nbsp;<span class="op" id="3885023">&lt;&lt;</span>&nbsp;<span class="num" id="3885026">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3885029">mutexWLock</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3885042">=</span>&nbsp;<span class="num" id="3885044">1</span>&nbsp;<span class="op" id="3885046">&lt;&lt;</span>&nbsp;<span class="num" id="3885049">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3885052">mutexRef</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3885065">=</span>&nbsp;<span class="num" id="3885067">1</span>&nbsp;<span class="op" id="3885069">&lt;&lt;</span>&nbsp;<span class="num" id="3885072">3</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3885075">mutexRefMask</span>&nbsp;<span class="op" id="3885088">=</span>&nbsp;<span class="op" id="3885090">(</span><span class="num" id="3885091">1</span><span class="op" id="3885092">&lt;&lt;</span><span class="num" id="3885094">20</span>&nbsp;<span class="op" id="3885097">-</span>&nbsp;<span class="num" id="3885099">1</span><span class="op" id="3885100">)</span>&nbsp;<span class="op" id="3885102">&lt;&lt;</span>&nbsp;<span class="num" id="3885105">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3885108">mutexRWait</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3885121">=</span>&nbsp;<span class="num" id="3885123">1</span>&nbsp;<span class="op" id="3885125">&lt;&lt;</span>&nbsp;<span class="num" id="3885128">23</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3885132">mutexRMask</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3885145">=</span>&nbsp;<span class="op" id="3885147">(</span><span class="num" id="3885148">1</span><span class="op" id="3885149">&lt;&lt;</span><span class="num" id="3885151">20</span>&nbsp;<span class="op" id="3885154">-</span>&nbsp;<span class="num" id="3885156">1</span><span class="op" id="3885157">)</span>&nbsp;<span class="op" id="3885159">&lt;&lt;</span>&nbsp;<span class="num" id="3885162">23</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3885166">mutexWWait</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3885179">=</span>&nbsp;<span class="num" id="3885181">1</span>&nbsp;<span class="op" id="3885183">&lt;&lt;</span>&nbsp;<span class="num" id="3885186">43</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3885190">mutexWMask</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3885203">=</span>&nbsp;<span class="op" id="3885205">(</span><span class="num" id="3885206">1</span><span class="op" id="3885207">&lt;&lt;</span><span class="num" id="3885209">20</span>&nbsp;<span class="op" id="3885212">-</span>&nbsp;<span class="num" id="3885214">1</span><span class="op" id="3885215">)</span>&nbsp;<span class="op" id="3885217">&lt;&lt;</span>&nbsp;<span class="num" id="3885220">43</span><br>
<span class="lineno">35</span><span class="op" id="3885223">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3885226">//&nbsp;Read&nbsp;operations&nbsp;must&nbsp;do&nbsp;RWLock(true)/RWUnlock(true).</span><br>
<span class="lineno"></span><span class="comment" id="3885282">//&nbsp;Write&nbsp;operations&nbsp;must&nbsp;do&nbsp;RWLock(false)/RWUnlock(false).</span><br>
<span class="lineno"></span><span class="comment" id="3885341">//&nbsp;Misc&nbsp;operations&nbsp;must&nbsp;do&nbsp;Incref/Decref.&nbsp;Misc&nbsp;operations&nbsp;include&nbsp;functions&nbsp;like</span><br>
<span class="lineno">40</span><span class="comment" id="3885422">//&nbsp;setsockopt&nbsp;and&nbsp;setDeadline.&nbsp;They&nbsp;need&nbsp;to&nbsp;use&nbsp;Incref/Decref&nbsp;to&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3885499">//&nbsp;they&nbsp;operate&nbsp;on&nbsp;the&nbsp;correct&nbsp;fd&nbsp;in&nbsp;presence&nbsp;of&nbsp;a&nbsp;concurrent&nbsp;Close&nbsp;call</span><br>
<span class="lineno"></span><span class="comment" id="3885572">//&nbsp;(otherwise&nbsp;fd&nbsp;can&nbsp;be&nbsp;closed&nbsp;under&nbsp;their&nbsp;feet).</span><br>
<span class="lineno"></span><span class="comment" id="3885622">//&nbsp;Close&nbsp;operation&nbsp;must&nbsp;do&nbsp;IncrefAndClose/Decref.</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="3885673">//&nbsp;RWLock/Incref&nbsp;return&nbsp;whether&nbsp;fd&nbsp;is&nbsp;open.</span><br>
<span class="lineno"></span><span class="comment" id="3885717">//&nbsp;RWUnlock/Decref&nbsp;return&nbsp;whether&nbsp;fd&nbsp;is&nbsp;closed&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;remaining&nbsp;references.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3885804">func</span>&nbsp;<span class="op" id="3885809">(</span><span class="ident" id="3885810">mu</span>&nbsp;<span class="op" id="3885813">*</span><span class="ident" id="3885814">fdMutex</span><span class="op" id="3885821">)</span>&nbsp;<span class="ident" id="3885823">Incref</span><span class="op" id="3885829">(</span><span class="op" id="3885830">)</span>&nbsp;<span class="builtintype" id="3885832">bool</span>&nbsp;<span class="op" id="3885837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3885840">for</span>&nbsp;<span class="op" id="3885844">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3885848">old</span>&nbsp;<span class="op" id="3885852">:=</span>&nbsp;<span class="ident" id="3885855">atomic</span><span class="op" id="3885861">.</span><span class="ident" id="3885862">LoadUint64</span><span class="op" id="3885872">(</span><span class="op" id="3885873">&amp;</span><span class="ident" id="3885874">mu</span><span class="op" id="3885876">.</span><span class="ident" id="3885877">state</span><span class="op" id="3885882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3885886">if</span>&nbsp;<span class="ident" id="3885889">old</span><span class="op" id="3885892">&amp;</span><span class="ident" id="3885893">mutexClosed</span>&nbsp;<span class="op" id="3885905">!=</span>&nbsp;<span class="num" id="3885908">0</span>&nbsp;<span class="op" id="3885910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3885915">return</span>&nbsp;<span class="builtintype" id="3885922">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3885930">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3885934">new</span>&nbsp;<span class="op" id="3885938">:=</span>&nbsp;<span class="ident" id="3885941">old</span>&nbsp;<span class="op" id="3885945">+</span>&nbsp;<span class="ident" id="3885947">mutexRef</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3885958">if</span>&nbsp;<span class="builtinfunc" id="3885961">new</span><span class="op" id="3885964">&amp;</span><span class="ident" id="3885965">mutexRefMask</span>&nbsp;<span class="op" id="3885978">==</span>&nbsp;<span class="num" id="3885981">0</span>&nbsp;<span class="op" id="3885983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3885988">panic</span><span class="op" id="3885993">(</span><span class="string" id="3885994">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3886021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3886025">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3886029">if</span>&nbsp;<span class="ident" id="3886032">atomic</span><span class="op" id="3886038">.</span><span class="ident" id="3886039">CompareAndSwapUint64</span><span class="op" id="3886059">(</span><span class="op" id="3886060">&amp;</span><span class="ident" id="3886061">mu</span><span class="op" id="3886063">.</span><span class="ident" id="3886064">state</span><span class="op" id="3886069">,</span>&nbsp;<span class="ident" id="3886071">old</span><span class="op" id="3886074">,</span>&nbsp;<span class="builtinfunc" id="3886076">new</span><span class="op" id="3886079">)</span>&nbsp;<span class="op" id="3886081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3886086">return</span>&nbsp;<span class="builtintype" id="3886093">true</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3886100">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3886103">}</span><br>
<span class="lineno"></span><span class="op" id="3886105">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3886108">func</span>&nbsp;<span class="op" id="3886113">(</span><span class="ident" id="3886114">mu</span>&nbsp;<span class="op" id="3886117">*</span><span class="ident" id="3886118">fdMutex</span><span class="op" id="3886125">)</span>&nbsp;<span class="ident" id="3886127">IncrefAndClose</span><span class="op" id="3886141">(</span><span class="op" id="3886142">)</span>&nbsp;<span class="builtintype" id="3886144">bool</span>&nbsp;<span class="op" id="3886149">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3886152">for</span>&nbsp;<span class="op" id="3886156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3886160">old</span>&nbsp;<span class="op" id="3886164">:=</span>&nbsp;<span class="ident" id="3886167">atomic</span><span class="op" id="3886173">.</span><span class="ident" id="3886174">LoadUint64</span><span class="op" id="3886184">(</span><span class="op" id="3886185">&amp;</span><span class="ident" id="3886186">mu</span><span class="op" id="3886188">.</span><span class="ident" id="3886189">state</span><span class="op" id="3886194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3886198">if</span>&nbsp;<span class="ident" id="3886201">old</span><span class="op" id="3886204">&amp;</span><span class="ident" id="3886205">mutexClosed</span>&nbsp;<span class="op" id="3886217">!=</span>&nbsp;<span class="num" id="3886220">0</span>&nbsp;<span class="op" id="3886222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3886227">return</span>&nbsp;<span class="builtintype" id="3886234">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3886242">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3886246">//&nbsp;Mark&nbsp;as&nbsp;closed&nbsp;and&nbsp;acquire&nbsp;a&nbsp;reference.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3886291">new</span>&nbsp;<span class="op" id="3886295">:=</span>&nbsp;<span class="op" id="3886298">(</span><span class="ident" id="3886299">old</span>&nbsp;<span class="op" id="3886303">|</span>&nbsp;<span class="ident" id="3886305">mutexClosed</span><span class="op" id="3886316">)</span>&nbsp;<span class="op" id="3886318">+</span>&nbsp;<span class="ident" id="3886320">mutexRef</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3886331">if</span>&nbsp;<span class="builtinfunc" id="3886334">new</span><span class="op" id="3886337">&amp;</span><span class="ident" id="3886338">mutexRefMask</span>&nbsp;<span class="op" id="3886351">==</span>&nbsp;<span class="num" id="3886354">0</span>&nbsp;<span class="op" id="3886356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3886361">panic</span><span class="op" id="3886366">(</span><span class="string" id="3886367">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3886394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3886398">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3886402">//&nbsp;Remove&nbsp;all&nbsp;read&nbsp;and&nbsp;write&nbsp;waiters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3886442">new</span>&nbsp;<span class="op" id="3886446">&amp;^=</span>&nbsp;<span class="ident" id="3886450">mutexRMask</span>&nbsp;<span class="op" id="3886461">|</span>&nbsp;<span class="ident" id="3886463">mutexWMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3886476">if</span>&nbsp;<span class="ident" id="3886479">atomic</span><span class="op" id="3886485">.</span><span class="ident" id="3886486">CompareAndSwapUint64</span><span class="op" id="3886506">(</span><span class="op" id="3886507">&amp;</span><span class="ident" id="3886508">mu</span><span class="op" id="3886510">.</span><span class="ident" id="3886511">state</span><span class="op" id="3886516">,</span>&nbsp;<span class="ident" id="3886518">old</span><span class="op" id="3886521">,</span>&nbsp;<span class="builtinfunc" id="3886523">new</span><span class="op" id="3886526">)</span>&nbsp;<span class="op" id="3886528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3886533">//&nbsp;Wake&nbsp;all&nbsp;read&nbsp;and&nbsp;write&nbsp;waiters,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3886572">//&nbsp;they&nbsp;will&nbsp;observe&nbsp;closed&nbsp;flag&nbsp;after&nbsp;wakeup.</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3886622">for</span>&nbsp;<span class="ident" id="3886626">old</span><span class="op" id="3886629">&amp;</span><span class="ident" id="3886630">mutexRMask</span>&nbsp;<span class="op" id="3886641">!=</span>&nbsp;<span class="num" id="3886644">0</span>&nbsp;<span class="op" id="3886646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3886652">old</span>&nbsp;<span class="op" id="3886656">-=</span>&nbsp;<span class="ident" id="3886659">mutexRWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3886674">runtime_Semrelease</span><span class="op" id="3886692">(</span><span class="op" id="3886693">&amp;</span><span class="ident" id="3886694">mu</span><span class="op" id="3886696">.</span><span class="ident" id="3886697">rsema</span><span class="op" id="3886702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3886707">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3886712">for</span>&nbsp;<span class="ident" id="3886716">old</span><span class="op" id="3886719">&amp;</span><span class="ident" id="3886720">mutexWMask</span>&nbsp;<span class="op" id="3886731">!=</span>&nbsp;<span class="num" id="3886734">0</span>&nbsp;<span class="op" id="3886736">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3886742">old</span>&nbsp;<span class="op" id="3886746">-=</span>&nbsp;<span class="ident" id="3886749">mutexWWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3886764">runtime_Semrelease</span><span class="op" id="3886782">(</span><span class="op" id="3886783">&amp;</span><span class="ident" id="3886784">mu</span><span class="op" id="3886786">.</span><span class="ident" id="3886787">wsema</span><span class="op" id="3886792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3886797">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3886802">return</span>&nbsp;<span class="builtintype" id="3886809">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3886816">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3886819">}</span><br>
<span class="lineno"></span><span class="op" id="3886821">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3886824">func</span>&nbsp;<span class="op" id="3886829">(</span><span class="ident" id="3886830">mu</span>&nbsp;<span class="op" id="3886833">*</span><span class="ident" id="3886834">fdMutex</span><span class="op" id="3886841">)</span>&nbsp;<span class="ident" id="3886843">Decref</span><span class="op" id="3886849">(</span><span class="op" id="3886850">)</span>&nbsp;<span class="builtintype" id="3886852">bool</span>&nbsp;<span class="op" id="3886857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3886860">for</span>&nbsp;<span class="op" id="3886864">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3886868">old</span>&nbsp;<span class="op" id="3886872">:=</span>&nbsp;<span class="ident" id="3886875">atomic</span><span class="op" id="3886881">.</span><span class="ident" id="3886882">LoadUint64</span><span class="op" id="3886892">(</span><span class="op" id="3886893">&amp;</span><span class="ident" id="3886894">mu</span><span class="op" id="3886896">.</span><span class="ident" id="3886897">state</span><span class="op" id="3886902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3886906">if</span>&nbsp;<span class="ident" id="3886909">old</span><span class="op" id="3886912">&amp;</span><span class="ident" id="3886913">mutexRefMask</span>&nbsp;<span class="op" id="3886926">==</span>&nbsp;<span class="num" id="3886929">0</span>&nbsp;<span class="op" id="3886931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3886936">panic</span><span class="op" id="3886941">(</span><span class="string" id="3886942">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3886969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3886973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3886977">new</span>&nbsp;<span class="op" id="3886981">:=</span>&nbsp;<span class="ident" id="3886984">old</span>&nbsp;<span class="op" id="3886988">-</span>&nbsp;<span class="ident" id="3886990">mutexRef</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3887001">if</span>&nbsp;<span class="ident" id="3887004">atomic</span><span class="op" id="3887010">.</span><span class="ident" id="3887011">CompareAndSwapUint64</span><span class="op" id="3887031">(</span><span class="op" id="3887032">&amp;</span><span class="ident" id="3887033">mu</span><span class="op" id="3887035">.</span><span class="ident" id="3887036">state</span><span class="op" id="3887041">,</span>&nbsp;<span class="ident" id="3887043">old</span><span class="op" id="3887046">,</span>&nbsp;<span class="builtinfunc" id="3887048">new</span><span class="op" id="3887051">)</span>&nbsp;<span class="op" id="3887053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3887058">return</span>&nbsp;<span class="builtinfunc" id="3887065">new</span><span class="op" id="3887068">&amp;</span><span class="op" id="3887069">(</span><span class="ident" id="3887070">mutexClosed</span><span class="op" id="3887081">|</span><span class="ident" id="3887082">mutexRefMask</span><span class="op" id="3887094">)</span>&nbsp;<span class="op" id="3887096">==</span>&nbsp;<span class="ident" id="3887099">mutexClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3887113">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3887116">}</span><br>
<span class="lineno"></span><span class="op" id="3887118">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="3887121">func</span>&nbsp;<span class="op" id="3887126">(</span><span class="ident" id="3887127">mu</span>&nbsp;<span class="op" id="3887130">*</span><span class="ident" id="3887131">fdMutex</span><span class="op" id="3887138">)</span>&nbsp;<span class="ident" id="3887140">RWLock</span><span class="op" id="3887146">(</span><span class="ident" id="3887147">read</span>&nbsp;<span class="builtintype" id="3887152">bool</span><span class="op" id="3887156">)</span>&nbsp;<span class="builtintype" id="3887158">bool</span>&nbsp;<span class="op" id="3887163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3887166">var</span>&nbsp;<span class="ident" id="3887170">mutexBit</span><span class="op" id="3887178">,</span>&nbsp;<span class="ident" id="3887180">mutexWait</span><span class="op" id="3887189">,</span>&nbsp;<span class="ident" id="3887191">mutexMask</span>&nbsp;<span class="ident" id="3887201">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3887209">var</span>&nbsp;<span class="ident" id="3887213">mutexSema</span>&nbsp;<span class="op" id="3887223">*</span><span class="builtintype" id="3887224">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3887232">if</span>&nbsp;<span class="ident" id="3887235">read</span>&nbsp;<span class="op" id="3887240">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3887244">mutexBit</span>&nbsp;<span class="op" id="3887253">=</span>&nbsp;<span class="ident" id="3887255">mutexRLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3887268">mutexWait</span>&nbsp;<span class="op" id="3887278">=</span>&nbsp;<span class="ident" id="3887280">mutexRWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3887293">mutexMask</span>&nbsp;<span class="op" id="3887303">=</span>&nbsp;<span class="ident" id="3887305">mutexRMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3887318">mutexSema</span>&nbsp;<span class="op" id="3887328">=</span>&nbsp;<span class="op" id="3887330">&amp;</span><span class="ident" id="3887331">mu</span><span class="op" id="3887333">.</span><span class="ident" id="3887334">rsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3887341">}</span>&nbsp;<span class="keyword" id="3887343">else</span>&nbsp;<span class="op" id="3887348">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3887352">mutexBit</span>&nbsp;<span class="op" id="3887361">=</span>&nbsp;<span class="ident" id="3887363">mutexWLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3887376">mutexWait</span>&nbsp;<span class="op" id="3887386">=</span>&nbsp;<span class="ident" id="3887388">mutexWWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3887401">mutexMask</span>&nbsp;<span class="op" id="3887411">=</span>&nbsp;<span class="ident" id="3887413">mutexWMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3887426">mutexSema</span>&nbsp;<span class="op" id="3887436">=</span>&nbsp;<span class="op" id="3887438">&amp;</span><span class="ident" id="3887439">mu</span><span class="op" id="3887441">.</span><span class="ident" id="3887442">wsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3887449">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3887452">for</span>&nbsp;<span class="op" id="3887456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3887460">old</span>&nbsp;<span class="op" id="3887464">:=</span>&nbsp;<span class="ident" id="3887467">atomic</span><span class="op" id="3887473">.</span><span class="ident" id="3887474">LoadUint64</span><span class="op" id="3887484">(</span><span class="op" id="3887485">&amp;</span><span class="ident" id="3887486">mu</span><span class="op" id="3887488">.</span><span class="ident" id="3887489">state</span><span class="op" id="3887494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3887498">if</span>&nbsp;<span class="ident" id="3887501">old</span><span class="op" id="3887504">&amp;</span><span class="ident" id="3887505">mutexClosed</span>&nbsp;<span class="op" id="3887517">!=</span>&nbsp;<span class="num" id="3887520">0</span>&nbsp;<span class="op" id="3887522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3887527">return</span>&nbsp;<span class="builtintype" id="3887534">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3887542">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3887546">var</span>&nbsp;<span class="builtinfunc" id="3887550">new</span>&nbsp;<span class="ident" id="3887554">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3887563">if</span>&nbsp;<span class="ident" id="3887566">old</span><span class="op" id="3887569">&amp;</span><span class="ident" id="3887570">mutexBit</span>&nbsp;<span class="op" id="3887579">==</span>&nbsp;<span class="num" id="3887582">0</span>&nbsp;<span class="op" id="3887584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3887589">//&nbsp;Lock&nbsp;is&nbsp;free,&nbsp;acquire&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3887621">new</span>&nbsp;<span class="op" id="3887625">=</span>&nbsp;<span class="op" id="3887627">(</span><span class="ident" id="3887628">old</span>&nbsp;<span class="op" id="3887632">|</span>&nbsp;<span class="ident" id="3887634">mutexBit</span><span class="op" id="3887642">)</span>&nbsp;<span class="op" id="3887644">+</span>&nbsp;<span class="ident" id="3887646">mutexRef</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3887658">if</span>&nbsp;<span class="builtinfunc" id="3887661">new</span><span class="op" id="3887664">&amp;</span><span class="ident" id="3887665">mutexRefMask</span>&nbsp;<span class="op" id="3887678">==</span>&nbsp;<span class="num" id="3887681">0</span>&nbsp;<span class="op" id="3887683">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3887689">panic</span><span class="op" id="3887694">(</span><span class="string" id="3887695">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3887722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3887727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3887731">}</span>&nbsp;<span class="keyword" id="3887733">else</span>&nbsp;<span class="op" id="3887738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3887743">//&nbsp;Wait&nbsp;for&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3887764">new</span>&nbsp;<span class="op" id="3887768">=</span>&nbsp;<span class="ident" id="3887770">old</span>&nbsp;<span class="op" id="3887774">+</span>&nbsp;<span class="ident" id="3887776">mutexWait</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3887789">if</span>&nbsp;<span class="builtinfunc" id="3887792">new</span><span class="op" id="3887795">&amp;</span><span class="ident" id="3887796">mutexMask</span>&nbsp;<span class="op" id="3887806">==</span>&nbsp;<span class="num" id="3887809">0</span>&nbsp;<span class="op" id="3887811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3887817">panic</span><span class="op" id="3887822">(</span><span class="string" id="3887823">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3887850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3887855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3887859">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3887863">if</span>&nbsp;<span class="ident" id="3887866">atomic</span><span class="op" id="3887872">.</span><span class="ident" id="3887873">CompareAndSwapUint64</span><span class="op" id="3887893">(</span><span class="op" id="3887894">&amp;</span><span class="ident" id="3887895">mu</span><span class="op" id="3887897">.</span><span class="ident" id="3887898">state</span><span class="op" id="3887903">,</span>&nbsp;<span class="ident" id="3887905">old</span><span class="op" id="3887908">,</span>&nbsp;<span class="builtinfunc" id="3887910">new</span><span class="op" id="3887913">)</span>&nbsp;<span class="op" id="3887915">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3887920">if</span>&nbsp;<span class="ident" id="3887923">old</span><span class="op" id="3887926">&amp;</span><span class="ident" id="3887927">mutexBit</span>&nbsp;<span class="op" id="3887936">==</span>&nbsp;<span class="num" id="3887939">0</span>&nbsp;<span class="op" id="3887941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3887947">return</span>&nbsp;<span class="builtintype" id="3887954">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3887962">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3887967">runtime_Semacquire</span><span class="op" id="3887985">(</span><span class="ident" id="3887986">mutexSema</span><span class="op" id="3887995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3888000">//&nbsp;The&nbsp;signaller&nbsp;has&nbsp;subtracted&nbsp;mutexWait.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3888045">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3888048">}</span><br>
<span class="lineno"></span><span class="op" id="3888050">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3888053">func</span>&nbsp;<span class="op" id="3888058">(</span><span class="ident" id="3888059">mu</span>&nbsp;<span class="op" id="3888062">*</span><span class="ident" id="3888063">fdMutex</span><span class="op" id="3888070">)</span>&nbsp;<span class="ident" id="3888072">RWUnlock</span><span class="op" id="3888080">(</span><span class="ident" id="3888081">read</span>&nbsp;<span class="builtintype" id="3888086">bool</span><span class="op" id="3888090">)</span>&nbsp;<span class="builtintype" id="3888092">bool</span>&nbsp;<span class="op" id="3888097">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3888100">var</span>&nbsp;<span class="ident" id="3888104">mutexBit</span><span class="op" id="3888112">,</span>&nbsp;<span class="ident" id="3888114">mutexWait</span><span class="op" id="3888123">,</span>&nbsp;<span class="ident" id="3888125">mutexMask</span>&nbsp;<span class="ident" id="3888135">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3888143">var</span>&nbsp;<span class="ident" id="3888147">mutexSema</span>&nbsp;<span class="op" id="3888157">*</span><span class="builtintype" id="3888158">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3888166">if</span>&nbsp;<span class="ident" id="3888169">read</span>&nbsp;<span class="op" id="3888174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3888178">mutexBit</span>&nbsp;<span class="op" id="3888187">=</span>&nbsp;<span class="ident" id="3888189">mutexRLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3888202">mutexWait</span>&nbsp;<span class="op" id="3888212">=</span>&nbsp;<span class="ident" id="3888214">mutexRWait</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3888227">mutexMask</span>&nbsp;<span class="op" id="3888237">=</span>&nbsp;<span class="ident" id="3888239">mutexRMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3888252">mutexSema</span>&nbsp;<span class="op" id="3888262">=</span>&nbsp;<span class="op" id="3888264">&amp;</span><span class="ident" id="3888265">mu</span><span class="op" id="3888267">.</span><span class="ident" id="3888268">rsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3888275">}</span>&nbsp;<span class="keyword" id="3888277">else</span>&nbsp;<span class="op" id="3888282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3888286">mutexBit</span>&nbsp;<span class="op" id="3888295">=</span>&nbsp;<span class="ident" id="3888297">mutexWLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3888310">mutexWait</span>&nbsp;<span class="op" id="3888320">=</span>&nbsp;<span class="ident" id="3888322">mutexWWait</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3888335">mutexMask</span>&nbsp;<span class="op" id="3888345">=</span>&nbsp;<span class="ident" id="3888347">mutexWMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3888360">mutexSema</span>&nbsp;<span class="op" id="3888370">=</span>&nbsp;<span class="op" id="3888372">&amp;</span><span class="ident" id="3888373">mu</span><span class="op" id="3888375">.</span><span class="ident" id="3888376">wsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3888383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3888386">for</span>&nbsp;<span class="op" id="3888390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3888394">old</span>&nbsp;<span class="op" id="3888398">:=</span>&nbsp;<span class="ident" id="3888401">atomic</span><span class="op" id="3888407">.</span><span class="ident" id="3888408">LoadUint64</span><span class="op" id="3888418">(</span><span class="op" id="3888419">&amp;</span><span class="ident" id="3888420">mu</span><span class="op" id="3888422">.</span><span class="ident" id="3888423">state</span><span class="op" id="3888428">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3888432">if</span>&nbsp;<span class="ident" id="3888435">old</span><span class="op" id="3888438">&amp;</span><span class="ident" id="3888439">mutexBit</span>&nbsp;<span class="op" id="3888448">==</span>&nbsp;<span class="num" id="3888451">0</span>&nbsp;<span class="op" id="3888453">||</span>&nbsp;<span class="ident" id="3888456">old</span><span class="op" id="3888459">&amp;</span><span class="ident" id="3888460">mutexRefMask</span>&nbsp;<span class="op" id="3888473">==</span>&nbsp;<span class="num" id="3888476">0</span>&nbsp;<span class="op" id="3888478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3888483">panic</span><span class="op" id="3888488">(</span><span class="string" id="3888489">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3888516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3888520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3888524">//&nbsp;Drop&nbsp;lock,&nbsp;drop&nbsp;reference&nbsp;and&nbsp;wake&nbsp;read&nbsp;waiter&nbsp;if&nbsp;present.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3888588">new</span>&nbsp;<span class="op" id="3888592">:=</span>&nbsp;<span class="op" id="3888595">(</span><span class="ident" id="3888596">old</span>&nbsp;<span class="op" id="3888600">&amp;^</span>&nbsp;<span class="ident" id="3888603">mutexBit</span><span class="op" id="3888611">)</span>&nbsp;<span class="op" id="3888613">-</span>&nbsp;<span class="ident" id="3888615">mutexRef</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3888626">if</span>&nbsp;<span class="ident" id="3888629">old</span><span class="op" id="3888632">&amp;</span><span class="ident" id="3888633">mutexMask</span>&nbsp;<span class="op" id="3888643">!=</span>&nbsp;<span class="num" id="3888646">0</span>&nbsp;<span class="op" id="3888648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3888653">new</span>&nbsp;<span class="op" id="3888657">-=</span>&nbsp;<span class="ident" id="3888660">mutexWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3888672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3888676">if</span>&nbsp;<span class="ident" id="3888679">atomic</span><span class="op" id="3888685">.</span><span class="ident" id="3888686">CompareAndSwapUint64</span><span class="op" id="3888706">(</span><span class="op" id="3888707">&amp;</span><span class="ident" id="3888708">mu</span><span class="op" id="3888710">.</span><span class="ident" id="3888711">state</span><span class="op" id="3888716">,</span>&nbsp;<span class="ident" id="3888718">old</span><span class="op" id="3888721">,</span>&nbsp;<span class="builtinfunc" id="3888723">new</span><span class="op" id="3888726">)</span>&nbsp;<span class="op" id="3888728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3888733">if</span>&nbsp;<span class="ident" id="3888736">old</span><span class="op" id="3888739">&amp;</span><span class="ident" id="3888740">mutexMask</span>&nbsp;<span class="op" id="3888750">!=</span>&nbsp;<span class="num" id="3888753">0</span>&nbsp;<span class="op" id="3888755">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3888761">runtime_Semrelease</span><span class="op" id="3888779">(</span><span class="ident" id="3888780">mutexSema</span><span class="op" id="3888789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3888794">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3888799">return</span>&nbsp;<span class="builtinfunc" id="3888806">new</span><span class="op" id="3888809">&amp;</span><span class="op" id="3888810">(</span><span class="ident" id="3888811">mutexClosed</span><span class="op" id="3888822">|</span><span class="ident" id="3888823">mutexRefMask</span><span class="op" id="3888835">)</span>&nbsp;<span class="op" id="3888837">==</span>&nbsp;<span class="ident" id="3888840">mutexClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3888854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3888857">}</span><br>
<span class="lineno">180</span><span class="op" id="3888859">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3888862">//&nbsp;Implemented&nbsp;in&nbsp;runtime&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="3888897">func</span>&nbsp;<span class="ident" id="3888902">runtime_Semacquire</span><span class="op" id="3888920">(</span><span class="ident" id="3888921">sema</span>&nbsp;<span class="op" id="3888926">*</span><span class="builtintype" id="3888927">uint32</span><span class="op" id="3888933">)</span><br>
<span class="lineno"></span><span class="keyword" id="3888935">func</span>&nbsp;<span class="ident" id="3888940">runtime_Semrelease</span><span class="op" id="3888958">(</span><span class="ident" id="3888959">sema</span>&nbsp;<span class="op" id="3888964">*</span><span class="builtintype" id="3888965">uint32</span><span class="op" id="3888971">)</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
