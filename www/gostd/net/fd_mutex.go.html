<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3609342">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3609397">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3609451">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3609502">package</span>&nbsp;<span class="ident" id="3609510">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3609515">import</span>&nbsp;<span class="string" id="3609522">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3609537">//&nbsp;fdMutex&nbsp;is&nbsp;a&nbsp;specialized&nbsp;synchronization&nbsp;primitive</span><br>
<span class="lineno">10</span><span class="comment" id="3609591">//&nbsp;that&nbsp;manages&nbsp;lifetime&nbsp;of&nbsp;an&nbsp;fd&nbsp;and&nbsp;serializes&nbsp;access</span><br>
<span class="lineno"></span><span class="comment" id="3609647">//&nbsp;to&nbsp;Read&nbsp;and&nbsp;Write&nbsp;methods&nbsp;on&nbsp;netFD.</span><br>
<span class="lineno"></span><span class="keyword" id="3609686">type</span>&nbsp;<span class="ident" id="3609691">fdMutex</span>&nbsp;<span class="keyword" id="3609699">struct</span>&nbsp;<span class="op" id="3609706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3609709">state</span>&nbsp;<span class="ident" id="3609715">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3609723">rsema</span>&nbsp;<span class="builtintype" id="3609729">uint32</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3609737">wsema</span>&nbsp;<span class="builtintype" id="3609743">uint32</span><br>
<span class="lineno"></span><span class="op" id="3609750">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3609753">//&nbsp;fdMutex.state&nbsp;is&nbsp;organized&nbsp;as&nbsp;follows:</span><br>
<span class="lineno"></span><span class="comment" id="3609795">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;whether&nbsp;netFD&nbsp;is&nbsp;closed,&nbsp;if&nbsp;set&nbsp;all&nbsp;subsequent&nbsp;lock&nbsp;operations&nbsp;will&nbsp;fail.</span><br>
<span class="lineno">20</span><span class="comment" id="3609880">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;lock&nbsp;for&nbsp;read&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="3609917">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;lock&nbsp;for&nbsp;write&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="3609955">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;total&nbsp;number&nbsp;of&nbsp;references&nbsp;(read+write+misc).</span><br>
<span class="lineno"></span><span class="comment" id="3610014">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;read&nbsp;waiters.</span><br>
<span class="lineno"></span><span class="comment" id="3610063">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;write&nbsp;waiters.</span><br>
<span class="lineno">25</span><span class="keyword" id="3610113">const</span>&nbsp;<span class="op" id="3610119">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3610122">mutexClosed</span>&nbsp;&nbsp;<span class="op" id="3610135">=</span>&nbsp;<span class="num" id="3610137">1</span>&nbsp;<span class="op" id="3610139">&lt;&lt;</span>&nbsp;<span class="num" id="3610142">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3610145">mutexRLock</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3610158">=</span>&nbsp;<span class="num" id="3610160">1</span>&nbsp;<span class="op" id="3610162">&lt;&lt;</span>&nbsp;<span class="num" id="3610165">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3610168">mutexWLock</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3610181">=</span>&nbsp;<span class="num" id="3610183">1</span>&nbsp;<span class="op" id="3610185">&lt;&lt;</span>&nbsp;<span class="num" id="3610188">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3610191">mutexRef</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3610204">=</span>&nbsp;<span class="num" id="3610206">1</span>&nbsp;<span class="op" id="3610208">&lt;&lt;</span>&nbsp;<span class="num" id="3610211">3</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3610214">mutexRefMask</span>&nbsp;<span class="op" id="3610227">=</span>&nbsp;<span class="op" id="3610229">(</span><span class="num" id="3610230">1</span><span class="op" id="3610231">&lt;&lt;</span><span class="num" id="3610233">20</span>&nbsp;<span class="op" id="3610236">-</span>&nbsp;<span class="num" id="3610238">1</span><span class="op" id="3610239">)</span>&nbsp;<span class="op" id="3610241">&lt;&lt;</span>&nbsp;<span class="num" id="3610244">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3610247">mutexRWait</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3610260">=</span>&nbsp;<span class="num" id="3610262">1</span>&nbsp;<span class="op" id="3610264">&lt;&lt;</span>&nbsp;<span class="num" id="3610267">23</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3610271">mutexRMask</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3610284">=</span>&nbsp;<span class="op" id="3610286">(</span><span class="num" id="3610287">1</span><span class="op" id="3610288">&lt;&lt;</span><span class="num" id="3610290">20</span>&nbsp;<span class="op" id="3610293">-</span>&nbsp;<span class="num" id="3610295">1</span><span class="op" id="3610296">)</span>&nbsp;<span class="op" id="3610298">&lt;&lt;</span>&nbsp;<span class="num" id="3610301">23</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3610305">mutexWWait</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3610318">=</span>&nbsp;<span class="num" id="3610320">1</span>&nbsp;<span class="op" id="3610322">&lt;&lt;</span>&nbsp;<span class="num" id="3610325">43</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3610329">mutexWMask</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3610342">=</span>&nbsp;<span class="op" id="3610344">(</span><span class="num" id="3610345">1</span><span class="op" id="3610346">&lt;&lt;</span><span class="num" id="3610348">20</span>&nbsp;<span class="op" id="3610351">-</span>&nbsp;<span class="num" id="3610353">1</span><span class="op" id="3610354">)</span>&nbsp;<span class="op" id="3610356">&lt;&lt;</span>&nbsp;<span class="num" id="3610359">43</span><br>
<span class="lineno">35</span><span class="op" id="3610362">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3610365">//&nbsp;Read&nbsp;operations&nbsp;must&nbsp;do&nbsp;RWLock(true)/RWUnlock(true).</span><br>
<span class="lineno"></span><span class="comment" id="3610421">//&nbsp;Write&nbsp;operations&nbsp;must&nbsp;do&nbsp;RWLock(false)/RWUnlock(false).</span><br>
<span class="lineno"></span><span class="comment" id="3610480">//&nbsp;Misc&nbsp;operations&nbsp;must&nbsp;do&nbsp;Incref/Decref.&nbsp;Misc&nbsp;operations&nbsp;include&nbsp;functions&nbsp;like</span><br>
<span class="lineno">40</span><span class="comment" id="3610561">//&nbsp;setsockopt&nbsp;and&nbsp;setDeadline.&nbsp;They&nbsp;need&nbsp;to&nbsp;use&nbsp;Incref/Decref&nbsp;to&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3610638">//&nbsp;they&nbsp;operate&nbsp;on&nbsp;the&nbsp;correct&nbsp;fd&nbsp;in&nbsp;presence&nbsp;of&nbsp;a&nbsp;concurrent&nbsp;Close&nbsp;call</span><br>
<span class="lineno"></span><span class="comment" id="3610711">//&nbsp;(otherwise&nbsp;fd&nbsp;can&nbsp;be&nbsp;closed&nbsp;under&nbsp;their&nbsp;feet).</span><br>
<span class="lineno"></span><span class="comment" id="3610761">//&nbsp;Close&nbsp;operation&nbsp;must&nbsp;do&nbsp;IncrefAndClose/Decref.</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="3610812">//&nbsp;RWLock/Incref&nbsp;return&nbsp;whether&nbsp;fd&nbsp;is&nbsp;open.</span><br>
<span class="lineno"></span><span class="comment" id="3610856">//&nbsp;RWUnlock/Decref&nbsp;return&nbsp;whether&nbsp;fd&nbsp;is&nbsp;closed&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;remaining&nbsp;references.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3610943">func</span>&nbsp;<span class="op" id="3610948">(</span><span class="ident" id="3610949">mu</span>&nbsp;<span class="op" id="3610952">*</span><span class="ident" id="3610953">fdMutex</span><span class="op" id="3610960">)</span>&nbsp;<span class="ident" id="3610962">Incref</span><span class="op" id="3610968">(</span><span class="op" id="3610969">)</span>&nbsp;<span class="builtintype" id="3610971">bool</span>&nbsp;<span class="op" id="3610976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3610979">for</span>&nbsp;<span class="op" id="3610983">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3610987">old</span>&nbsp;<span class="op" id="3610991">:=</span>&nbsp;<span class="ident" id="3610994">atomic</span><span class="op" id="3611000">.</span><span class="ident" id="3611001">LoadUint64</span><span class="op" id="3611011">(</span><span class="op" id="3611012">&amp;</span><span class="ident" id="3611013">mu</span><span class="op" id="3611015">.</span><span class="ident" id="3611016">state</span><span class="op" id="3611021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3611025">if</span>&nbsp;<span class="ident" id="3611028">old</span><span class="op" id="3611031">&amp;</span><span class="ident" id="3611032">mutexClosed</span>&nbsp;<span class="op" id="3611044">!=</span>&nbsp;<span class="num" id="3611047">0</span>&nbsp;<span class="op" id="3611049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3611054">return</span>&nbsp;<span class="builtintype" id="3611061">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3611069">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3611073">new</span>&nbsp;<span class="op" id="3611077">:=</span>&nbsp;<span class="ident" id="3611080">old</span>&nbsp;<span class="op" id="3611084">+</span>&nbsp;<span class="ident" id="3611086">mutexRef</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3611097">if</span>&nbsp;<span class="builtinfunc" id="3611100">new</span><span class="op" id="3611103">&amp;</span><span class="ident" id="3611104">mutexRefMask</span>&nbsp;<span class="op" id="3611117">==</span>&nbsp;<span class="num" id="3611120">0</span>&nbsp;<span class="op" id="3611122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3611127">panic</span><span class="op" id="3611132">(</span><span class="string" id="3611133">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3611160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3611164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3611168">if</span>&nbsp;<span class="ident" id="3611171">atomic</span><span class="op" id="3611177">.</span><span class="ident" id="3611178">CompareAndSwapUint64</span><span class="op" id="3611198">(</span><span class="op" id="3611199">&amp;</span><span class="ident" id="3611200">mu</span><span class="op" id="3611202">.</span><span class="ident" id="3611203">state</span><span class="op" id="3611208">,</span>&nbsp;<span class="ident" id="3611210">old</span><span class="op" id="3611213">,</span>&nbsp;<span class="builtinfunc" id="3611215">new</span><span class="op" id="3611218">)</span>&nbsp;<span class="op" id="3611220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3611225">return</span>&nbsp;<span class="builtintype" id="3611232">true</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3611239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3611242">}</span><br>
<span class="lineno"></span><span class="op" id="3611244">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3611247">func</span>&nbsp;<span class="op" id="3611252">(</span><span class="ident" id="3611253">mu</span>&nbsp;<span class="op" id="3611256">*</span><span class="ident" id="3611257">fdMutex</span><span class="op" id="3611264">)</span>&nbsp;<span class="ident" id="3611266">IncrefAndClose</span><span class="op" id="3611280">(</span><span class="op" id="3611281">)</span>&nbsp;<span class="builtintype" id="3611283">bool</span>&nbsp;<span class="op" id="3611288">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3611291">for</span>&nbsp;<span class="op" id="3611295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3611299">old</span>&nbsp;<span class="op" id="3611303">:=</span>&nbsp;<span class="ident" id="3611306">atomic</span><span class="op" id="3611312">.</span><span class="ident" id="3611313">LoadUint64</span><span class="op" id="3611323">(</span><span class="op" id="3611324">&amp;</span><span class="ident" id="3611325">mu</span><span class="op" id="3611327">.</span><span class="ident" id="3611328">state</span><span class="op" id="3611333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3611337">if</span>&nbsp;<span class="ident" id="3611340">old</span><span class="op" id="3611343">&amp;</span><span class="ident" id="3611344">mutexClosed</span>&nbsp;<span class="op" id="3611356">!=</span>&nbsp;<span class="num" id="3611359">0</span>&nbsp;<span class="op" id="3611361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3611366">return</span>&nbsp;<span class="builtintype" id="3611373">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3611381">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3611385">//&nbsp;Mark&nbsp;as&nbsp;closed&nbsp;and&nbsp;acquire&nbsp;a&nbsp;reference.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3611430">new</span>&nbsp;<span class="op" id="3611434">:=</span>&nbsp;<span class="op" id="3611437">(</span><span class="ident" id="3611438">old</span>&nbsp;<span class="op" id="3611442">|</span>&nbsp;<span class="ident" id="3611444">mutexClosed</span><span class="op" id="3611455">)</span>&nbsp;<span class="op" id="3611457">+</span>&nbsp;<span class="ident" id="3611459">mutexRef</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3611470">if</span>&nbsp;<span class="builtinfunc" id="3611473">new</span><span class="op" id="3611476">&amp;</span><span class="ident" id="3611477">mutexRefMask</span>&nbsp;<span class="op" id="3611490">==</span>&nbsp;<span class="num" id="3611493">0</span>&nbsp;<span class="op" id="3611495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3611500">panic</span><span class="op" id="3611505">(</span><span class="string" id="3611506">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3611533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3611537">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3611541">//&nbsp;Remove&nbsp;all&nbsp;read&nbsp;and&nbsp;write&nbsp;waiters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3611581">new</span>&nbsp;<span class="op" id="3611585">&amp;^=</span>&nbsp;<span class="ident" id="3611589">mutexRMask</span>&nbsp;<span class="op" id="3611600">|</span>&nbsp;<span class="ident" id="3611602">mutexWMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3611615">if</span>&nbsp;<span class="ident" id="3611618">atomic</span><span class="op" id="3611624">.</span><span class="ident" id="3611625">CompareAndSwapUint64</span><span class="op" id="3611645">(</span><span class="op" id="3611646">&amp;</span><span class="ident" id="3611647">mu</span><span class="op" id="3611649">.</span><span class="ident" id="3611650">state</span><span class="op" id="3611655">,</span>&nbsp;<span class="ident" id="3611657">old</span><span class="op" id="3611660">,</span>&nbsp;<span class="builtinfunc" id="3611662">new</span><span class="op" id="3611665">)</span>&nbsp;<span class="op" id="3611667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3611672">//&nbsp;Wake&nbsp;all&nbsp;read&nbsp;and&nbsp;write&nbsp;waiters,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3611711">//&nbsp;they&nbsp;will&nbsp;observe&nbsp;closed&nbsp;flag&nbsp;after&nbsp;wakeup.</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3611761">for</span>&nbsp;<span class="ident" id="3611765">old</span><span class="op" id="3611768">&amp;</span><span class="ident" id="3611769">mutexRMask</span>&nbsp;<span class="op" id="3611780">!=</span>&nbsp;<span class="num" id="3611783">0</span>&nbsp;<span class="op" id="3611785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3611791">old</span>&nbsp;<span class="op" id="3611795">-=</span>&nbsp;<span class="ident" id="3611798">mutexRWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3611813">runtime_Semrelease</span><span class="op" id="3611831">(</span><span class="op" id="3611832">&amp;</span><span class="ident" id="3611833">mu</span><span class="op" id="3611835">.</span><span class="ident" id="3611836">rsema</span><span class="op" id="3611841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3611846">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3611851">for</span>&nbsp;<span class="ident" id="3611855">old</span><span class="op" id="3611858">&amp;</span><span class="ident" id="3611859">mutexWMask</span>&nbsp;<span class="op" id="3611870">!=</span>&nbsp;<span class="num" id="3611873">0</span>&nbsp;<span class="op" id="3611875">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3611881">old</span>&nbsp;<span class="op" id="3611885">-=</span>&nbsp;<span class="ident" id="3611888">mutexWWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3611903">runtime_Semrelease</span><span class="op" id="3611921">(</span><span class="op" id="3611922">&amp;</span><span class="ident" id="3611923">mu</span><span class="op" id="3611925">.</span><span class="ident" id="3611926">wsema</span><span class="op" id="3611931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3611936">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3611941">return</span>&nbsp;<span class="builtintype" id="3611948">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3611955">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3611958">}</span><br>
<span class="lineno"></span><span class="op" id="3611960">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3611963">func</span>&nbsp;<span class="op" id="3611968">(</span><span class="ident" id="3611969">mu</span>&nbsp;<span class="op" id="3611972">*</span><span class="ident" id="3611973">fdMutex</span><span class="op" id="3611980">)</span>&nbsp;<span class="ident" id="3611982">Decref</span><span class="op" id="3611988">(</span><span class="op" id="3611989">)</span>&nbsp;<span class="builtintype" id="3611991">bool</span>&nbsp;<span class="op" id="3611996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3611999">for</span>&nbsp;<span class="op" id="3612003">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3612007">old</span>&nbsp;<span class="op" id="3612011">:=</span>&nbsp;<span class="ident" id="3612014">atomic</span><span class="op" id="3612020">.</span><span class="ident" id="3612021">LoadUint64</span><span class="op" id="3612031">(</span><span class="op" id="3612032">&amp;</span><span class="ident" id="3612033">mu</span><span class="op" id="3612035">.</span><span class="ident" id="3612036">state</span><span class="op" id="3612041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3612045">if</span>&nbsp;<span class="ident" id="3612048">old</span><span class="op" id="3612051">&amp;</span><span class="ident" id="3612052">mutexRefMask</span>&nbsp;<span class="op" id="3612065">==</span>&nbsp;<span class="num" id="3612068">0</span>&nbsp;<span class="op" id="3612070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3612075">panic</span><span class="op" id="3612080">(</span><span class="string" id="3612081">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3612108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3612112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3612116">new</span>&nbsp;<span class="op" id="3612120">:=</span>&nbsp;<span class="ident" id="3612123">old</span>&nbsp;<span class="op" id="3612127">-</span>&nbsp;<span class="ident" id="3612129">mutexRef</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3612140">if</span>&nbsp;<span class="ident" id="3612143">atomic</span><span class="op" id="3612149">.</span><span class="ident" id="3612150">CompareAndSwapUint64</span><span class="op" id="3612170">(</span><span class="op" id="3612171">&amp;</span><span class="ident" id="3612172">mu</span><span class="op" id="3612174">.</span><span class="ident" id="3612175">state</span><span class="op" id="3612180">,</span>&nbsp;<span class="ident" id="3612182">old</span><span class="op" id="3612185">,</span>&nbsp;<span class="builtinfunc" id="3612187">new</span><span class="op" id="3612190">)</span>&nbsp;<span class="op" id="3612192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3612197">return</span>&nbsp;<span class="builtinfunc" id="3612204">new</span><span class="op" id="3612207">&amp;</span><span class="op" id="3612208">(</span><span class="ident" id="3612209">mutexClosed</span><span class="op" id="3612220">|</span><span class="ident" id="3612221">mutexRefMask</span><span class="op" id="3612233">)</span>&nbsp;<span class="op" id="3612235">==</span>&nbsp;<span class="ident" id="3612238">mutexClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3612252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3612255">}</span><br>
<span class="lineno"></span><span class="op" id="3612257">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="3612260">func</span>&nbsp;<span class="op" id="3612265">(</span><span class="ident" id="3612266">mu</span>&nbsp;<span class="op" id="3612269">*</span><span class="ident" id="3612270">fdMutex</span><span class="op" id="3612277">)</span>&nbsp;<span class="ident" id="3612279">RWLock</span><span class="op" id="3612285">(</span><span class="ident" id="3612286">read</span>&nbsp;<span class="builtintype" id="3612291">bool</span><span class="op" id="3612295">)</span>&nbsp;<span class="builtintype" id="3612297">bool</span>&nbsp;<span class="op" id="3612302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3612305">var</span>&nbsp;<span class="ident" id="3612309">mutexBit</span><span class="op" id="3612317">,</span>&nbsp;<span class="ident" id="3612319">mutexWait</span><span class="op" id="3612328">,</span>&nbsp;<span class="ident" id="3612330">mutexMask</span>&nbsp;<span class="ident" id="3612340">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3612348">var</span>&nbsp;<span class="ident" id="3612352">mutexSema</span>&nbsp;<span class="op" id="3612362">*</span><span class="builtintype" id="3612363">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3612371">if</span>&nbsp;<span class="ident" id="3612374">read</span>&nbsp;<span class="op" id="3612379">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3612383">mutexBit</span>&nbsp;<span class="op" id="3612392">=</span>&nbsp;<span class="ident" id="3612394">mutexRLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3612407">mutexWait</span>&nbsp;<span class="op" id="3612417">=</span>&nbsp;<span class="ident" id="3612419">mutexRWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3612432">mutexMask</span>&nbsp;<span class="op" id="3612442">=</span>&nbsp;<span class="ident" id="3612444">mutexRMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3612457">mutexSema</span>&nbsp;<span class="op" id="3612467">=</span>&nbsp;<span class="op" id="3612469">&amp;</span><span class="ident" id="3612470">mu</span><span class="op" id="3612472">.</span><span class="ident" id="3612473">rsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3612480">}</span>&nbsp;<span class="keyword" id="3612482">else</span>&nbsp;<span class="op" id="3612487">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3612491">mutexBit</span>&nbsp;<span class="op" id="3612500">=</span>&nbsp;<span class="ident" id="3612502">mutexWLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3612515">mutexWait</span>&nbsp;<span class="op" id="3612525">=</span>&nbsp;<span class="ident" id="3612527">mutexWWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3612540">mutexMask</span>&nbsp;<span class="op" id="3612550">=</span>&nbsp;<span class="ident" id="3612552">mutexWMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3612565">mutexSema</span>&nbsp;<span class="op" id="3612575">=</span>&nbsp;<span class="op" id="3612577">&amp;</span><span class="ident" id="3612578">mu</span><span class="op" id="3612580">.</span><span class="ident" id="3612581">wsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3612588">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3612591">for</span>&nbsp;<span class="op" id="3612595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3612599">old</span>&nbsp;<span class="op" id="3612603">:=</span>&nbsp;<span class="ident" id="3612606">atomic</span><span class="op" id="3612612">.</span><span class="ident" id="3612613">LoadUint64</span><span class="op" id="3612623">(</span><span class="op" id="3612624">&amp;</span><span class="ident" id="3612625">mu</span><span class="op" id="3612627">.</span><span class="ident" id="3612628">state</span><span class="op" id="3612633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3612637">if</span>&nbsp;<span class="ident" id="3612640">old</span><span class="op" id="3612643">&amp;</span><span class="ident" id="3612644">mutexClosed</span>&nbsp;<span class="op" id="3612656">!=</span>&nbsp;<span class="num" id="3612659">0</span>&nbsp;<span class="op" id="3612661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3612666">return</span>&nbsp;<span class="builtintype" id="3612673">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3612681">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3612685">var</span>&nbsp;<span class="builtinfunc" id="3612689">new</span>&nbsp;<span class="ident" id="3612693">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3612702">if</span>&nbsp;<span class="ident" id="3612705">old</span><span class="op" id="3612708">&amp;</span><span class="ident" id="3612709">mutexBit</span>&nbsp;<span class="op" id="3612718">==</span>&nbsp;<span class="num" id="3612721">0</span>&nbsp;<span class="op" id="3612723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3612728">//&nbsp;Lock&nbsp;is&nbsp;free,&nbsp;acquire&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3612760">new</span>&nbsp;<span class="op" id="3612764">=</span>&nbsp;<span class="op" id="3612766">(</span><span class="ident" id="3612767">old</span>&nbsp;<span class="op" id="3612771">|</span>&nbsp;<span class="ident" id="3612773">mutexBit</span><span class="op" id="3612781">)</span>&nbsp;<span class="op" id="3612783">+</span>&nbsp;<span class="ident" id="3612785">mutexRef</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3612797">if</span>&nbsp;<span class="builtinfunc" id="3612800">new</span><span class="op" id="3612803">&amp;</span><span class="ident" id="3612804">mutexRefMask</span>&nbsp;<span class="op" id="3612817">==</span>&nbsp;<span class="num" id="3612820">0</span>&nbsp;<span class="op" id="3612822">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3612828">panic</span><span class="op" id="3612833">(</span><span class="string" id="3612834">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3612861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3612866">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3612870">}</span>&nbsp;<span class="keyword" id="3612872">else</span>&nbsp;<span class="op" id="3612877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3612882">//&nbsp;Wait&nbsp;for&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3612903">new</span>&nbsp;<span class="op" id="3612907">=</span>&nbsp;<span class="ident" id="3612909">old</span>&nbsp;<span class="op" id="3612913">+</span>&nbsp;<span class="ident" id="3612915">mutexWait</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3612928">if</span>&nbsp;<span class="builtinfunc" id="3612931">new</span><span class="op" id="3612934">&amp;</span><span class="ident" id="3612935">mutexMask</span>&nbsp;<span class="op" id="3612945">==</span>&nbsp;<span class="num" id="3612948">0</span>&nbsp;<span class="op" id="3612950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3612956">panic</span><span class="op" id="3612961">(</span><span class="string" id="3612962">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3612989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3612994">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3612998">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3613002">if</span>&nbsp;<span class="ident" id="3613005">atomic</span><span class="op" id="3613011">.</span><span class="ident" id="3613012">CompareAndSwapUint64</span><span class="op" id="3613032">(</span><span class="op" id="3613033">&amp;</span><span class="ident" id="3613034">mu</span><span class="op" id="3613036">.</span><span class="ident" id="3613037">state</span><span class="op" id="3613042">,</span>&nbsp;<span class="ident" id="3613044">old</span><span class="op" id="3613047">,</span>&nbsp;<span class="builtinfunc" id="3613049">new</span><span class="op" id="3613052">)</span>&nbsp;<span class="op" id="3613054">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3613059">if</span>&nbsp;<span class="ident" id="3613062">old</span><span class="op" id="3613065">&amp;</span><span class="ident" id="3613066">mutexBit</span>&nbsp;<span class="op" id="3613075">==</span>&nbsp;<span class="num" id="3613078">0</span>&nbsp;<span class="op" id="3613080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3613086">return</span>&nbsp;<span class="builtintype" id="3613093">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3613101">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3613106">runtime_Semacquire</span><span class="op" id="3613124">(</span><span class="ident" id="3613125">mutexSema</span><span class="op" id="3613134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3613139">//&nbsp;The&nbsp;signaller&nbsp;has&nbsp;subtracted&nbsp;mutexWait.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3613184">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3613187">}</span><br>
<span class="lineno"></span><span class="op" id="3613189">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3613192">func</span>&nbsp;<span class="op" id="3613197">(</span><span class="ident" id="3613198">mu</span>&nbsp;<span class="op" id="3613201">*</span><span class="ident" id="3613202">fdMutex</span><span class="op" id="3613209">)</span>&nbsp;<span class="ident" id="3613211">RWUnlock</span><span class="op" id="3613219">(</span><span class="ident" id="3613220">read</span>&nbsp;<span class="builtintype" id="3613225">bool</span><span class="op" id="3613229">)</span>&nbsp;<span class="builtintype" id="3613231">bool</span>&nbsp;<span class="op" id="3613236">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3613239">var</span>&nbsp;<span class="ident" id="3613243">mutexBit</span><span class="op" id="3613251">,</span>&nbsp;<span class="ident" id="3613253">mutexWait</span><span class="op" id="3613262">,</span>&nbsp;<span class="ident" id="3613264">mutexMask</span>&nbsp;<span class="ident" id="3613274">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3613282">var</span>&nbsp;<span class="ident" id="3613286">mutexSema</span>&nbsp;<span class="op" id="3613296">*</span><span class="builtintype" id="3613297">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3613305">if</span>&nbsp;<span class="ident" id="3613308">read</span>&nbsp;<span class="op" id="3613313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3613317">mutexBit</span>&nbsp;<span class="op" id="3613326">=</span>&nbsp;<span class="ident" id="3613328">mutexRLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3613341">mutexWait</span>&nbsp;<span class="op" id="3613351">=</span>&nbsp;<span class="ident" id="3613353">mutexRWait</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3613366">mutexMask</span>&nbsp;<span class="op" id="3613376">=</span>&nbsp;<span class="ident" id="3613378">mutexRMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3613391">mutexSema</span>&nbsp;<span class="op" id="3613401">=</span>&nbsp;<span class="op" id="3613403">&amp;</span><span class="ident" id="3613404">mu</span><span class="op" id="3613406">.</span><span class="ident" id="3613407">rsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3613414">}</span>&nbsp;<span class="keyword" id="3613416">else</span>&nbsp;<span class="op" id="3613421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3613425">mutexBit</span>&nbsp;<span class="op" id="3613434">=</span>&nbsp;<span class="ident" id="3613436">mutexWLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3613449">mutexWait</span>&nbsp;<span class="op" id="3613459">=</span>&nbsp;<span class="ident" id="3613461">mutexWWait</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3613474">mutexMask</span>&nbsp;<span class="op" id="3613484">=</span>&nbsp;<span class="ident" id="3613486">mutexWMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3613499">mutexSema</span>&nbsp;<span class="op" id="3613509">=</span>&nbsp;<span class="op" id="3613511">&amp;</span><span class="ident" id="3613512">mu</span><span class="op" id="3613514">.</span><span class="ident" id="3613515">wsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3613522">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3613525">for</span>&nbsp;<span class="op" id="3613529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3613533">old</span>&nbsp;<span class="op" id="3613537">:=</span>&nbsp;<span class="ident" id="3613540">atomic</span><span class="op" id="3613546">.</span><span class="ident" id="3613547">LoadUint64</span><span class="op" id="3613557">(</span><span class="op" id="3613558">&amp;</span><span class="ident" id="3613559">mu</span><span class="op" id="3613561">.</span><span class="ident" id="3613562">state</span><span class="op" id="3613567">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3613571">if</span>&nbsp;<span class="ident" id="3613574">old</span><span class="op" id="3613577">&amp;</span><span class="ident" id="3613578">mutexBit</span>&nbsp;<span class="op" id="3613587">==</span>&nbsp;<span class="num" id="3613590">0</span>&nbsp;<span class="op" id="3613592">||</span>&nbsp;<span class="ident" id="3613595">old</span><span class="op" id="3613598">&amp;</span><span class="ident" id="3613599">mutexRefMask</span>&nbsp;<span class="op" id="3613612">==</span>&nbsp;<span class="num" id="3613615">0</span>&nbsp;<span class="op" id="3613617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3613622">panic</span><span class="op" id="3613627">(</span><span class="string" id="3613628">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3613655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3613659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3613663">//&nbsp;Drop&nbsp;lock,&nbsp;drop&nbsp;reference&nbsp;and&nbsp;wake&nbsp;read&nbsp;waiter&nbsp;if&nbsp;present.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3613727">new</span>&nbsp;<span class="op" id="3613731">:=</span>&nbsp;<span class="op" id="3613734">(</span><span class="ident" id="3613735">old</span>&nbsp;<span class="op" id="3613739">&amp;^</span>&nbsp;<span class="ident" id="3613742">mutexBit</span><span class="op" id="3613750">)</span>&nbsp;<span class="op" id="3613752">-</span>&nbsp;<span class="ident" id="3613754">mutexRef</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3613765">if</span>&nbsp;<span class="ident" id="3613768">old</span><span class="op" id="3613771">&amp;</span><span class="ident" id="3613772">mutexMask</span>&nbsp;<span class="op" id="3613782">!=</span>&nbsp;<span class="num" id="3613785">0</span>&nbsp;<span class="op" id="3613787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3613792">new</span>&nbsp;<span class="op" id="3613796">-=</span>&nbsp;<span class="ident" id="3613799">mutexWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3613811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3613815">if</span>&nbsp;<span class="ident" id="3613818">atomic</span><span class="op" id="3613824">.</span><span class="ident" id="3613825">CompareAndSwapUint64</span><span class="op" id="3613845">(</span><span class="op" id="3613846">&amp;</span><span class="ident" id="3613847">mu</span><span class="op" id="3613849">.</span><span class="ident" id="3613850">state</span><span class="op" id="3613855">,</span>&nbsp;<span class="ident" id="3613857">old</span><span class="op" id="3613860">,</span>&nbsp;<span class="builtinfunc" id="3613862">new</span><span class="op" id="3613865">)</span>&nbsp;<span class="op" id="3613867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3613872">if</span>&nbsp;<span class="ident" id="3613875">old</span><span class="op" id="3613878">&amp;</span><span class="ident" id="3613879">mutexMask</span>&nbsp;<span class="op" id="3613889">!=</span>&nbsp;<span class="num" id="3613892">0</span>&nbsp;<span class="op" id="3613894">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3613900">runtime_Semrelease</span><span class="op" id="3613918">(</span><span class="ident" id="3613919">mutexSema</span><span class="op" id="3613928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3613933">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3613938">return</span>&nbsp;<span class="builtinfunc" id="3613945">new</span><span class="op" id="3613948">&amp;</span><span class="op" id="3613949">(</span><span class="ident" id="3613950">mutexClosed</span><span class="op" id="3613961">|</span><span class="ident" id="3613962">mutexRefMask</span><span class="op" id="3613974">)</span>&nbsp;<span class="op" id="3613976">==</span>&nbsp;<span class="ident" id="3613979">mutexClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3613993">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3613996">}</span><br>
<span class="lineno">180</span><span class="op" id="3613998">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3614001">//&nbsp;Implemented&nbsp;in&nbsp;runtime&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="3614036">func</span>&nbsp;<span class="ident" id="3614041">runtime_Semacquire</span><span class="op" id="3614059">(</span><span class="ident" id="3614060">sema</span>&nbsp;<span class="op" id="3614065">*</span><span class="builtintype" id="3614066">uint32</span><span class="op" id="3614072">)</span><br>
<span class="lineno"></span><span class="keyword" id="3614074">func</span>&nbsp;<span class="ident" id="3614079">runtime_Semrelease</span><span class="op" id="3614097">(</span><span class="ident" id="3614098">sema</span>&nbsp;<span class="op" id="3614103">*</span><span class="builtintype" id="3614104">uint32</span><span class="op" id="3614110">)</span>
</div>
</body>
</html>
