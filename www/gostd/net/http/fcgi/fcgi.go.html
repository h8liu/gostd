<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/fcgi</h2>
<ul>
<li><a href="/gostd/net/http/fcgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi.go.html" class="current">fcgi.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi_test.go.html">fcgi_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6331152">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6331207">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6331261">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6331312">//&nbsp;Package&nbsp;fcgi&nbsp;implements&nbsp;the&nbsp;FastCGI&nbsp;protocol.</span><br>
<span class="lineno"></span><span class="comment" id="6331361">//&nbsp;Currently&nbsp;only&nbsp;the&nbsp;responder&nbsp;role&nbsp;is&nbsp;supported.</span><br>
<span class="lineno"></span><span class="comment" id="6331412">//&nbsp;The&nbsp;protocol&nbsp;is&nbsp;defined&nbsp;at&nbsp;http://www.fastcgi.com/drupal/node/6?q=node/22</span><br>
<span class="lineno"></span><span class="keyword" id="6331489">package</span>&nbsp;<span class="ident" id="6331497">fcgi</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="6331503">//&nbsp;This&nbsp;file&nbsp;defines&nbsp;the&nbsp;raw&nbsp;protocol&nbsp;and&nbsp;some&nbsp;utilities&nbsp;used&nbsp;by&nbsp;the&nbsp;child&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="6331582">//&nbsp;the&nbsp;host.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6331596">import</span>&nbsp;<span class="op" id="6331603">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6331606">&#34;bufio&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6331615">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6331624">&#34;encoding/binary&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6331643">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6331653">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6331659">&#34;sync&#34;</span><br>
<span class="lineno">20</span><span class="op" id="6331666">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6331669">//&nbsp;recType&nbsp;is&nbsp;a&nbsp;record&nbsp;type,&nbsp;as&nbsp;defined&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="6331712">//&nbsp;http://www.fastcgi.com/devkit/doc/fcgi-spec.html#S8</span><br>
<span class="lineno"></span><span class="keyword" id="6331767">type</span>&nbsp;<span class="ident" id="6331772">recType</span>&nbsp;<span class="builtintype" id="6331780">uint8</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="6331787">const</span>&nbsp;<span class="op" id="6331793">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6331796">typeBeginRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6331816">recType</span>&nbsp;<span class="op" id="6331824">=</span>&nbsp;<span class="num" id="6331826">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6331829">typeAbortRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6331849">recType</span>&nbsp;<span class="op" id="6331857">=</span>&nbsp;<span class="num" id="6331859">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6331862">typeEndRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6331882">recType</span>&nbsp;<span class="op" id="6331890">=</span>&nbsp;<span class="num" id="6331892">3</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6331895">typeParams</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6331915">recType</span>&nbsp;<span class="op" id="6331923">=</span>&nbsp;<span class="num" id="6331925">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6331928">typeStdin</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6331948">recType</span>&nbsp;<span class="op" id="6331956">=</span>&nbsp;<span class="num" id="6331958">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6331961">typeStdout</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6331981">recType</span>&nbsp;<span class="op" id="6331989">=</span>&nbsp;<span class="num" id="6331991">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6331994">typeStderr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332014">recType</span>&nbsp;<span class="op" id="6332022">=</span>&nbsp;<span class="num" id="6332024">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332027">typeData</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332047">recType</span>&nbsp;<span class="op" id="6332055">=</span>&nbsp;<span class="num" id="6332057">8</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332060">typeGetValues</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332080">recType</span>&nbsp;<span class="op" id="6332088">=</span>&nbsp;<span class="num" id="6332090">9</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332093">typeGetValuesResult</span>&nbsp;<span class="ident" id="6332113">recType</span>&nbsp;<span class="op" id="6332121">=</span>&nbsp;<span class="num" id="6332123">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332127">typeUnknownType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332147">recType</span>&nbsp;<span class="op" id="6332155">=</span>&nbsp;<span class="num" id="6332157">11</span><br>
<span class="lineno"></span><span class="op" id="6332160">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="6332163">//&nbsp;keep&nbsp;the&nbsp;connection&nbsp;between&nbsp;web-server&nbsp;and&nbsp;responder&nbsp;open&nbsp;after&nbsp;request</span><br>
<span class="lineno"></span><span class="keyword" id="6332238">const</span>&nbsp;<span class="ident" id="6332244">flagKeepConn</span>&nbsp;<span class="op" id="6332257">=</span>&nbsp;<span class="num" id="6332259">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6332262">const</span>&nbsp;<span class="op" id="6332268">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332271">maxWrite</span>&nbsp;<span class="op" id="6332280">=</span>&nbsp;<span class="num" id="6332282">65535</span>&nbsp;<span class="comment" id="6332288">//&nbsp;maximum&nbsp;record&nbsp;body</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332312">maxPad</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6332321">=</span>&nbsp;<span class="num" id="6332323">255</span><br>
<span class="lineno"></span><span class="op" id="6332327">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6332330">const</span>&nbsp;<span class="op" id="6332336">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332339">roleResponder</span>&nbsp;<span class="op" id="6332353">=</span>&nbsp;<span class="ident" id="6332355">iota</span>&nbsp;<span class="op" id="6332360">+</span>&nbsp;<span class="num" id="6332362">1</span>&nbsp;<span class="comment" id="6332364">//&nbsp;only&nbsp;Responders&nbsp;are&nbsp;implemented.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332401">roleAuthorizer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332417">roleFilter</span><br>
<span class="lineno"></span><span class="op" id="6332428">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6332431">const</span>&nbsp;<span class="op" id="6332437">(</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332440">statusRequestComplete</span>&nbsp;<span class="op" id="6332462">=</span>&nbsp;<span class="ident" id="6332464">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332470">statusCantMultiplex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332491">statusOverloaded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332509">statusUnknownRole</span><br>
<span class="lineno"></span><span class="op" id="6332527">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="6332530">const</span>&nbsp;<span class="ident" id="6332536">headerLen</span>&nbsp;<span class="op" id="6332546">=</span>&nbsp;<span class="num" id="6332548">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6332551">type</span>&nbsp;<span class="ident" id="6332556">header</span>&nbsp;<span class="keyword" id="6332563">struct</span>&nbsp;<span class="op" id="6332570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332573">Version</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6332587">uint8</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332594">Type</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332608">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332617">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6332631">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332639">ContentLength</span>&nbsp;<span class="builtintype" id="6332653">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332661">PaddingLength</span>&nbsp;<span class="builtintype" id="6332675">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332682">Reserved</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6332696">uint8</span><br>
<span class="lineno">70</span><span class="op" id="6332702">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6332705">type</span>&nbsp;<span class="ident" id="6332710">beginRequest</span>&nbsp;<span class="keyword" id="6332723">struct</span>&nbsp;<span class="op" id="6332730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332733">role</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6332742">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332750">flags</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6332759">uint8</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332766">reserved</span>&nbsp;<span class="op" id="6332775">[</span><span class="num" id="6332776">5</span><span class="op" id="6332777">]</span><span class="builtintype" id="6332778">uint8</span><br>
<span class="lineno"></span><span class="op" id="6332784">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6332787">func</span>&nbsp;<span class="op" id="6332792">(</span><span class="ident" id="6332793">br</span>&nbsp;<span class="op" id="6332796">*</span><span class="ident" id="6332797">beginRequest</span><span class="op" id="6332809">)</span>&nbsp;<span class="ident" id="6332811">read</span><span class="op" id="6332815">(</span><span class="ident" id="6332816">content</span>&nbsp;<span class="op" id="6332824">[</span><span class="op" id="6332825">]</span><span class="builtintype" id="6332826">byte</span><span class="op" id="6332830">)</span>&nbsp;<span class="builtintype" id="6332832">error</span>&nbsp;<span class="op" id="6332838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6332841">if</span>&nbsp;<span class="builtinfunc" id="6332844">len</span><span class="op" id="6332847">(</span><span class="ident" id="6332848">content</span><span class="op" id="6332855">)</span>&nbsp;<span class="op" id="6332857">!=</span>&nbsp;<span class="num" id="6332860">8</span>&nbsp;<span class="op" id="6332862">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6332866">return</span>&nbsp;<span class="ident" id="6332873">errors</span><span class="op" id="6332879">.</span><span class="ident" id="6332880">New</span><span class="op" id="6332883">(</span><span class="string" id="6332884">&#34;fcgi:&nbsp;invalid&nbsp;begin&nbsp;request&nbsp;record&#34;</span><span class="op" id="6332920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6332923">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332926">br</span><span class="op" id="6332928">.</span><span class="ident" id="6332929">role</span>&nbsp;<span class="op" id="6332934">=</span>&nbsp;<span class="ident" id="6332936">binary</span><span class="op" id="6332942">.</span><span class="ident" id="6332943">BigEndian</span><span class="op" id="6332952">.</span><span class="ident" id="6332953">Uint16</span><span class="op" id="6332959">(</span><span class="ident" id="6332960">content</span><span class="op" id="6332967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332970">br</span><span class="op" id="6332972">.</span><span class="ident" id="6332973">flags</span>&nbsp;<span class="op" id="6332979">=</span>&nbsp;<span class="ident" id="6332981">content</span><span class="op" id="6332988">[</span><span class="num" id="6332989">2</span><span class="op" id="6332990">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6332993">return</span>&nbsp;<span class="builtintype" id="6333000">nil</span><br>
<span class="lineno">85</span><span class="op" id="6333004">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6333007">//&nbsp;for&nbsp;padding&nbsp;so&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;to&nbsp;allocate&nbsp;all&nbsp;the&nbsp;time</span><br>
<span class="lineno"></span><span class="comment" id="6333064">//&nbsp;not&nbsp;synchronized&nbsp;because&nbsp;we&nbsp;don&#39;t&nbsp;care&nbsp;what&nbsp;the&nbsp;contents&nbsp;are</span><br>
<span class="lineno"></span><span class="keyword" id="6333128">var</span>&nbsp;<span class="ident" id="6333132">pad</span>&nbsp;<span class="op" id="6333136">[</span><span class="ident" id="6333137">maxPad</span><span class="op" id="6333143">]</span><span class="builtintype" id="6333144">byte</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="6333150">func</span>&nbsp;<span class="op" id="6333155">(</span><span class="ident" id="6333156">h</span>&nbsp;<span class="op" id="6333158">*</span><span class="ident" id="6333159">header</span><span class="op" id="6333165">)</span>&nbsp;<span class="ident" id="6333167">init</span><span class="op" id="6333171">(</span><span class="ident" id="6333172">recType</span>&nbsp;<span class="ident" id="6333180">recType</span><span class="op" id="6333187">,</span>&nbsp;<span class="ident" id="6333189">reqId</span>&nbsp;<span class="builtintype" id="6333195">uint16</span><span class="op" id="6333201">,</span>&nbsp;<span class="ident" id="6333203">contentLength</span>&nbsp;<span class="builtintype" id="6333217">int</span><span class="op" id="6333220">)</span>&nbsp;<span class="op" id="6333222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6333225">h</span><span class="op" id="6333226">.</span><span class="ident" id="6333227">Version</span>&nbsp;<span class="op" id="6333235">=</span>&nbsp;<span class="num" id="6333237">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6333240">h</span><span class="op" id="6333241">.</span><span class="ident" id="6333242">Type</span>&nbsp;<span class="op" id="6333247">=</span>&nbsp;<span class="ident" id="6333249">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6333258">h</span><span class="op" id="6333259">.</span><span class="ident" id="6333260">Id</span>&nbsp;<span class="op" id="6333263">=</span>&nbsp;<span class="ident" id="6333265">reqId</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6333272">h</span><span class="op" id="6333273">.</span><span class="ident" id="6333274">ContentLength</span>&nbsp;<span class="op" id="6333288">=</span>&nbsp;<span class="builtintype" id="6333290">uint16</span><span class="op" id="6333296">(</span><span class="ident" id="6333297">contentLength</span><span class="op" id="6333310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6333313">h</span><span class="op" id="6333314">.</span><span class="ident" id="6333315">PaddingLength</span>&nbsp;<span class="op" id="6333329">=</span>&nbsp;<span class="builtintype" id="6333331">uint8</span><span class="op" id="6333336">(</span><span class="op" id="6333337">-</span><span class="ident" id="6333338">contentLength</span>&nbsp;<span class="op" id="6333352">&amp;</span>&nbsp;<span class="num" id="6333354">7</span><span class="op" id="6333355">)</span><br>
<span class="lineno"></span><span class="op" id="6333357">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6333360">//&nbsp;conn&nbsp;sends&nbsp;records&nbsp;over&nbsp;rwc</span><br>
<span class="lineno">100</span><span class="keyword" id="6333391">type</span>&nbsp;<span class="ident" id="6333396">conn</span>&nbsp;<span class="keyword" id="6333401">struct</span>&nbsp;<span class="op" id="6333408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6333411">mutex</span>&nbsp;<span class="ident" id="6333417">sync</span><span class="op" id="6333421">.</span><span class="ident" id="6333422">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6333429">rwc</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6333435">io</span><span class="op" id="6333437">.</span><span class="ident" id="6333438">ReadWriteCloser</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6333456">//&nbsp;to&nbsp;avoid&nbsp;allocations</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6333481">buf</span>&nbsp;<span class="ident" id="6333485">bytes</span><span class="op" id="6333490">.</span><span class="ident" id="6333491">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6333499">h</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6333503">header</span><br>
<span class="lineno"></span><span class="op" id="6333510">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6333513">func</span>&nbsp;<span class="ident" id="6333518">newConn</span><span class="op" id="6333525">(</span><span class="ident" id="6333526">rwc</span>&nbsp;<span class="ident" id="6333530">io</span><span class="op" id="6333532">.</span><span class="ident" id="6333533">ReadWriteCloser</span><span class="op" id="6333548">)</span>&nbsp;<span class="op" id="6333550">*</span><span class="ident" id="6333551">conn</span>&nbsp;<span class="op" id="6333556">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6333559">return</span>&nbsp;<span class="op" id="6333566">&amp;</span><span class="ident" id="6333567">conn</span><span class="op" id="6333571">{</span><span class="ident" id="6333572">rwc</span><span class="op" id="6333575">:</span>&nbsp;<span class="ident" id="6333577">rwc</span><span class="op" id="6333580">}</span><br>
<span class="lineno"></span><span class="op" id="6333582">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6333585">func</span>&nbsp;<span class="op" id="6333590">(</span><span class="ident" id="6333591">c</span>&nbsp;<span class="op" id="6333593">*</span><span class="ident" id="6333594">conn</span><span class="op" id="6333598">)</span>&nbsp;<span class="ident" id="6333600">Close</span><span class="op" id="6333605">(</span><span class="op" id="6333606">)</span>&nbsp;<span class="builtintype" id="6333608">error</span>&nbsp;<span class="op" id="6333614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6333617">c</span><span class="op" id="6333618">.</span><span class="ident" id="6333619">mutex</span><span class="op" id="6333624">.</span><span class="ident" id="6333625">Lock</span><span class="op" id="6333629">(</span><span class="op" id="6333630">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6333633">defer</span>&nbsp;<span class="ident" id="6333639">c</span><span class="op" id="6333640">.</span><span class="ident" id="6333641">mutex</span><span class="op" id="6333646">.</span><span class="ident" id="6333647">Unlock</span><span class="op" id="6333653">(</span><span class="op" id="6333654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6333657">return</span>&nbsp;<span class="ident" id="6333664">c</span><span class="op" id="6333665">.</span><span class="ident" id="6333666">rwc</span><span class="op" id="6333669">.</span><span class="ident" id="6333670">Close</span><span class="op" id="6333675">(</span><span class="op" id="6333676">)</span><br>
<span class="lineno"></span><span class="op" id="6333678">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6333681">type</span>&nbsp;<span class="ident" id="6333686">record</span>&nbsp;<span class="keyword" id="6333693">struct</span>&nbsp;<span class="op" id="6333700">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6333703">h</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6333707">header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6333715">buf</span>&nbsp;<span class="op" id="6333719">[</span><span class="ident" id="6333720">maxWrite</span>&nbsp;<span class="op" id="6333729">+</span>&nbsp;<span class="ident" id="6333731">maxPad</span><span class="op" id="6333737">]</span><span class="builtintype" id="6333738">byte</span><br>
<span class="lineno"></span><span class="op" id="6333743">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6333746">func</span>&nbsp;<span class="op" id="6333751">(</span><span class="ident" id="6333752">rec</span>&nbsp;<span class="op" id="6333756">*</span><span class="ident" id="6333757">record</span><span class="op" id="6333763">)</span>&nbsp;<span class="ident" id="6333765">read</span><span class="op" id="6333769">(</span><span class="ident" id="6333770">r</span>&nbsp;<span class="ident" id="6333772">io</span><span class="op" id="6333774">.</span><span class="ident" id="6333775">Reader</span><span class="op" id="6333781">)</span>&nbsp;<span class="op" id="6333783">(</span><span class="ident" id="6333784">err</span>&nbsp;<span class="builtintype" id="6333788">error</span><span class="op" id="6333793">)</span>&nbsp;<span class="op" id="6333795">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6333798">if</span>&nbsp;<span class="ident" id="6333801">err</span>&nbsp;<span class="op" id="6333805">=</span>&nbsp;<span class="ident" id="6333807">binary</span><span class="op" id="6333813">.</span><span class="ident" id="6333814">Read</span><span class="op" id="6333818">(</span><span class="ident" id="6333819">r</span><span class="op" id="6333820">,</span>&nbsp;<span class="ident" id="6333822">binary</span><span class="op" id="6333828">.</span><span class="ident" id="6333829">BigEndian</span><span class="op" id="6333838">,</span>&nbsp;<span class="op" id="6333840">&amp;</span><span class="ident" id="6333841">rec</span><span class="op" id="6333844">.</span><span class="ident" id="6333845">h</span><span class="op" id="6333846">)</span><span class="op" id="6333847">;</span>&nbsp;<span class="ident" id="6333849">err</span>&nbsp;<span class="op" id="6333853">!=</span>&nbsp;<span class="builtintype" id="6333856">nil</span>&nbsp;<span class="op" id="6333860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6333864">return</span>&nbsp;<span class="ident" id="6333871">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6333876">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6333879">if</span>&nbsp;<span class="ident" id="6333882">rec</span><span class="op" id="6333885">.</span><span class="ident" id="6333886">h</span><span class="op" id="6333887">.</span><span class="ident" id="6333888">Version</span>&nbsp;<span class="op" id="6333896">!=</span>&nbsp;<span class="num" id="6333899">1</span>&nbsp;<span class="op" id="6333901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6333905">return</span>&nbsp;<span class="ident" id="6333912">errors</span><span class="op" id="6333918">.</span><span class="ident" id="6333919">New</span><span class="op" id="6333922">(</span><span class="string" id="6333923">&#34;fcgi:&nbsp;invalid&nbsp;header&nbsp;version&#34;</span><span class="op" id="6333953">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6333956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6333959">n</span>&nbsp;<span class="op" id="6333961">:=</span>&nbsp;<span class="builtintype" id="6333964">int</span><span class="op" id="6333967">(</span><span class="ident" id="6333968">rec</span><span class="op" id="6333971">.</span><span class="ident" id="6333972">h</span><span class="op" id="6333973">.</span><span class="ident" id="6333974">ContentLength</span><span class="op" id="6333987">)</span>&nbsp;<span class="op" id="6333989">+</span>&nbsp;<span class="builtintype" id="6333991">int</span><span class="op" id="6333994">(</span><span class="ident" id="6333995">rec</span><span class="op" id="6333998">.</span><span class="ident" id="6333999">h</span><span class="op" id="6334000">.</span><span class="ident" id="6334001">PaddingLength</span><span class="op" id="6334014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6334017">if</span>&nbsp;<span class="ident" id="6334020">_</span><span class="op" id="6334021">,</span>&nbsp;<span class="ident" id="6334023">err</span>&nbsp;<span class="op" id="6334027">=</span>&nbsp;<span class="ident" id="6334029">io</span><span class="op" id="6334031">.</span><span class="ident" id="6334032">ReadFull</span><span class="op" id="6334040">(</span><span class="ident" id="6334041">r</span><span class="op" id="6334042">,</span>&nbsp;<span class="ident" id="6334044">rec</span><span class="op" id="6334047">.</span><span class="ident" id="6334048">buf</span><span class="op" id="6334051">[</span><span class="op" id="6334052">:</span><span class="ident" id="6334053">n</span><span class="op" id="6334054">]</span><span class="op" id="6334055">)</span><span class="op" id="6334056">;</span>&nbsp;<span class="ident" id="6334058">err</span>&nbsp;<span class="op" id="6334062">!=</span>&nbsp;<span class="builtintype" id="6334065">nil</span>&nbsp;<span class="op" id="6334069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6334073">return</span>&nbsp;<span class="ident" id="6334080">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6334085">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6334088">return</span>&nbsp;<span class="builtintype" id="6334095">nil</span><br>
<span class="lineno"></span><span class="op" id="6334099">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6334102">func</span>&nbsp;<span class="op" id="6334107">(</span><span class="ident" id="6334108">r</span>&nbsp;<span class="op" id="6334110">*</span><span class="ident" id="6334111">record</span><span class="op" id="6334117">)</span>&nbsp;<span class="ident" id="6334119">content</span><span class="op" id="6334126">(</span><span class="op" id="6334127">)</span>&nbsp;<span class="op" id="6334129">[</span><span class="op" id="6334130">]</span><span class="builtintype" id="6334131">byte</span>&nbsp;<span class="op" id="6334136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6334139">return</span>&nbsp;<span class="ident" id="6334146">r</span><span class="op" id="6334147">.</span><span class="ident" id="6334148">buf</span><span class="op" id="6334151">[</span><span class="op" id="6334152">:</span><span class="ident" id="6334153">r</span><span class="op" id="6334154">.</span><span class="ident" id="6334155">h</span><span class="op" id="6334156">.</span><span class="ident" id="6334157">ContentLength</span><span class="op" id="6334170">]</span><br>
<span class="lineno">140</span><span class="op" id="6334172">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6334175">//&nbsp;writeRecord&nbsp;writes&nbsp;and&nbsp;sends&nbsp;a&nbsp;single&nbsp;record.</span><br>
<span class="lineno"></span><span class="keyword" id="6334224">func</span>&nbsp;<span class="op" id="6334229">(</span><span class="ident" id="6334230">c</span>&nbsp;<span class="op" id="6334232">*</span><span class="ident" id="6334233">conn</span><span class="op" id="6334237">)</span>&nbsp;<span class="ident" id="6334239">writeRecord</span><span class="op" id="6334250">(</span><span class="ident" id="6334251">recType</span>&nbsp;<span class="ident" id="6334259">recType</span><span class="op" id="6334266">,</span>&nbsp;<span class="ident" id="6334268">reqId</span>&nbsp;<span class="builtintype" id="6334274">uint16</span><span class="op" id="6334280">,</span>&nbsp;<span class="ident" id="6334282">b</span>&nbsp;<span class="op" id="6334284">[</span><span class="op" id="6334285">]</span><span class="builtintype" id="6334286">byte</span><span class="op" id="6334290">)</span>&nbsp;<span class="builtintype" id="6334292">error</span>&nbsp;<span class="op" id="6334298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6334301">c</span><span class="op" id="6334302">.</span><span class="ident" id="6334303">mutex</span><span class="op" id="6334308">.</span><span class="ident" id="6334309">Lock</span><span class="op" id="6334313">(</span><span class="op" id="6334314">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6334317">defer</span>&nbsp;<span class="ident" id="6334323">c</span><span class="op" id="6334324">.</span><span class="ident" id="6334325">mutex</span><span class="op" id="6334330">.</span><span class="ident" id="6334331">Unlock</span><span class="op" id="6334337">(</span><span class="op" id="6334338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6334341">c</span><span class="op" id="6334342">.</span><span class="ident" id="6334343">buf</span><span class="op" id="6334346">.</span><span class="ident" id="6334347">Reset</span><span class="op" id="6334352">(</span><span class="op" id="6334353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6334356">c</span><span class="op" id="6334357">.</span><span class="ident" id="6334358">h</span><span class="op" id="6334359">.</span><span class="ident" id="6334360">init</span><span class="op" id="6334364">(</span><span class="ident" id="6334365">recType</span><span class="op" id="6334372">,</span>&nbsp;<span class="ident" id="6334374">reqId</span><span class="op" id="6334379">,</span>&nbsp;<span class="builtinfunc" id="6334381">len</span><span class="op" id="6334384">(</span><span class="ident" id="6334385">b</span><span class="op" id="6334386">)</span><span class="op" id="6334387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6334390">if</span>&nbsp;<span class="ident" id="6334393">err</span>&nbsp;<span class="op" id="6334397">:=</span>&nbsp;<span class="ident" id="6334400">binary</span><span class="op" id="6334406">.</span><span class="ident" id="6334407">Write</span><span class="op" id="6334412">(</span><span class="op" id="6334413">&amp;</span><span class="ident" id="6334414">c</span><span class="op" id="6334415">.</span><span class="ident" id="6334416">buf</span><span class="op" id="6334419">,</span>&nbsp;<span class="ident" id="6334421">binary</span><span class="op" id="6334427">.</span><span class="ident" id="6334428">BigEndian</span><span class="op" id="6334437">,</span>&nbsp;<span class="ident" id="6334439">c</span><span class="op" id="6334440">.</span><span class="ident" id="6334441">h</span><span class="op" id="6334442">)</span><span class="op" id="6334443">;</span>&nbsp;<span class="ident" id="6334445">err</span>&nbsp;<span class="op" id="6334449">!=</span>&nbsp;<span class="builtintype" id="6334452">nil</span>&nbsp;<span class="op" id="6334456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6334460">return</span>&nbsp;<span class="ident" id="6334467">err</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6334472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6334475">if</span>&nbsp;<span class="ident" id="6334478">_</span><span class="op" id="6334479">,</span>&nbsp;<span class="ident" id="6334481">err</span>&nbsp;<span class="op" id="6334485">:=</span>&nbsp;<span class="ident" id="6334488">c</span><span class="op" id="6334489">.</span><span class="ident" id="6334490">buf</span><span class="op" id="6334493">.</span><span class="ident" id="6334494">Write</span><span class="op" id="6334499">(</span><span class="ident" id="6334500">b</span><span class="op" id="6334501">)</span><span class="op" id="6334502">;</span>&nbsp;<span class="ident" id="6334504">err</span>&nbsp;<span class="op" id="6334508">!=</span>&nbsp;<span class="builtintype" id="6334511">nil</span>&nbsp;<span class="op" id="6334515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6334519">return</span>&nbsp;<span class="ident" id="6334526">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6334531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6334534">if</span>&nbsp;<span class="ident" id="6334537">_</span><span class="op" id="6334538">,</span>&nbsp;<span class="ident" id="6334540">err</span>&nbsp;<span class="op" id="6334544">:=</span>&nbsp;<span class="ident" id="6334547">c</span><span class="op" id="6334548">.</span><span class="ident" id="6334549">buf</span><span class="op" id="6334552">.</span><span class="ident" id="6334553">Write</span><span class="op" id="6334558">(</span><span class="ident" id="6334559">pad</span><span class="op" id="6334562">[</span><span class="op" id="6334563">:</span><span class="ident" id="6334564">c</span><span class="op" id="6334565">.</span><span class="ident" id="6334566">h</span><span class="op" id="6334567">.</span><span class="ident" id="6334568">PaddingLength</span><span class="op" id="6334581">]</span><span class="op" id="6334582">)</span><span class="op" id="6334583">;</span>&nbsp;<span class="ident" id="6334585">err</span>&nbsp;<span class="op" id="6334589">!=</span>&nbsp;<span class="builtintype" id="6334592">nil</span>&nbsp;<span class="op" id="6334596">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6334600">return</span>&nbsp;<span class="ident" id="6334607">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6334612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6334615">_</span><span class="op" id="6334616">,</span>&nbsp;<span class="ident" id="6334618">err</span>&nbsp;<span class="op" id="6334622">:=</span>&nbsp;<span class="ident" id="6334625">c</span><span class="op" id="6334626">.</span><span class="ident" id="6334627">rwc</span><span class="op" id="6334630">.</span><span class="ident" id="6334631">Write</span><span class="op" id="6334636">(</span><span class="ident" id="6334637">c</span><span class="op" id="6334638">.</span><span class="ident" id="6334639">buf</span><span class="op" id="6334642">.</span><span class="ident" id="6334643">Bytes</span><span class="op" id="6334648">(</span><span class="op" id="6334649">)</span><span class="op" id="6334650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6334653">return</span>&nbsp;<span class="ident" id="6334660">err</span><br>
<span class="lineno"></span><span class="op" id="6334664">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="keyword" id="6334667">func</span>&nbsp;<span class="op" id="6334672">(</span><span class="ident" id="6334673">c</span>&nbsp;<span class="op" id="6334675">*</span><span class="ident" id="6334676">conn</span><span class="op" id="6334680">)</span>&nbsp;<span class="ident" id="6334682">writeBeginRequest</span><span class="op" id="6334699">(</span><span class="ident" id="6334700">reqId</span>&nbsp;<span class="builtintype" id="6334706">uint16</span><span class="op" id="6334712">,</span>&nbsp;<span class="ident" id="6334714">role</span>&nbsp;<span class="builtintype" id="6334719">uint16</span><span class="op" id="6334725">,</span>&nbsp;<span class="ident" id="6334727">flags</span>&nbsp;<span class="builtintype" id="6334733">uint8</span><span class="op" id="6334738">)</span>&nbsp;<span class="builtintype" id="6334740">error</span>&nbsp;<span class="op" id="6334746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6334749">b</span>&nbsp;<span class="op" id="6334751">:=</span>&nbsp;<span class="op" id="6334754">[</span><span class="num" id="6334755">8</span><span class="op" id="6334756">]</span><span class="builtintype" id="6334757">byte</span><span class="op" id="6334761">{</span><span class="builtintype" id="6334762">byte</span><span class="op" id="6334766">(</span><span class="ident" id="6334767">role</span>&nbsp;<span class="op" id="6334772">&gt;&gt;</span>&nbsp;<span class="num" id="6334775">8</span><span class="op" id="6334776">)</span><span class="op" id="6334777">,</span>&nbsp;<span class="builtintype" id="6334779">byte</span><span class="op" id="6334783">(</span><span class="ident" id="6334784">role</span><span class="op" id="6334788">)</span><span class="op" id="6334789">,</span>&nbsp;<span class="ident" id="6334791">flags</span><span class="op" id="6334796">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6334799">return</span>&nbsp;<span class="ident" id="6334806">c</span><span class="op" id="6334807">.</span><span class="ident" id="6334808">writeRecord</span><span class="op" id="6334819">(</span><span class="ident" id="6334820">typeBeginRequest</span><span class="op" id="6334836">,</span>&nbsp;<span class="ident" id="6334838">reqId</span><span class="op" id="6334843">,</span>&nbsp;<span class="ident" id="6334845">b</span><span class="op" id="6334846">[</span><span class="op" id="6334847">:</span><span class="op" id="6334848">]</span><span class="op" id="6334849">)</span><br>
<span class="lineno"></span><span class="op" id="6334851">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="keyword" id="6334854">func</span>&nbsp;<span class="op" id="6334859">(</span><span class="ident" id="6334860">c</span>&nbsp;<span class="op" id="6334862">*</span><span class="ident" id="6334863">conn</span><span class="op" id="6334867">)</span>&nbsp;<span class="ident" id="6334869">writeEndRequest</span><span class="op" id="6334884">(</span><span class="ident" id="6334885">reqId</span>&nbsp;<span class="builtintype" id="6334891">uint16</span><span class="op" id="6334897">,</span>&nbsp;<span class="ident" id="6334899">appStatus</span>&nbsp;<span class="builtintype" id="6334909">int</span><span class="op" id="6334912">,</span>&nbsp;<span class="ident" id="6334914">protocolStatus</span>&nbsp;<span class="builtintype" id="6334929">uint8</span><span class="op" id="6334934">)</span>&nbsp;<span class="builtintype" id="6334936">error</span>&nbsp;<span class="op" id="6334942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6334945">b</span>&nbsp;<span class="op" id="6334947">:=</span>&nbsp;<span class="builtinfunc" id="6334950">make</span><span class="op" id="6334954">(</span><span class="op" id="6334955">[</span><span class="op" id="6334956">]</span><span class="builtintype" id="6334957">byte</span><span class="op" id="6334961">,</span>&nbsp;<span class="num" id="6334963">8</span><span class="op" id="6334964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6334967">binary</span><span class="op" id="6334973">.</span><span class="ident" id="6334974">BigEndian</span><span class="op" id="6334983">.</span><span class="ident" id="6334984">PutUint32</span><span class="op" id="6334993">(</span><span class="ident" id="6334994">b</span><span class="op" id="6334995">,</span>&nbsp;<span class="builtintype" id="6334997">uint32</span><span class="op" id="6335003">(</span><span class="ident" id="6335004">appStatus</span><span class="op" id="6335013">)</span><span class="op" id="6335014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335017">b</span><span class="op" id="6335018">[</span><span class="num" id="6335019">4</span><span class="op" id="6335020">]</span>&nbsp;<span class="op" id="6335022">=</span>&nbsp;<span class="ident" id="6335024">protocolStatus</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6335040">return</span>&nbsp;<span class="ident" id="6335047">c</span><span class="op" id="6335048">.</span><span class="ident" id="6335049">writeRecord</span><span class="op" id="6335060">(</span><span class="ident" id="6335061">typeEndRequest</span><span class="op" id="6335075">,</span>&nbsp;<span class="ident" id="6335077">reqId</span><span class="op" id="6335082">,</span>&nbsp;<span class="ident" id="6335084">b</span><span class="op" id="6335085">)</span><br>
<span class="lineno"></span><span class="op" id="6335087">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6335090">func</span>&nbsp;<span class="op" id="6335095">(</span><span class="ident" id="6335096">c</span>&nbsp;<span class="op" id="6335098">*</span><span class="ident" id="6335099">conn</span><span class="op" id="6335103">)</span>&nbsp;<span class="ident" id="6335105">writePairs</span><span class="op" id="6335115">(</span><span class="ident" id="6335116">recType</span>&nbsp;<span class="ident" id="6335124">recType</span><span class="op" id="6335131">,</span>&nbsp;<span class="ident" id="6335133">reqId</span>&nbsp;<span class="builtintype" id="6335139">uint16</span><span class="op" id="6335145">,</span>&nbsp;<span class="ident" id="6335147">pairs</span>&nbsp;<span class="keyword" id="6335153">map</span><span class="op" id="6335156">[</span><span class="builtintype" id="6335157">string</span><span class="op" id="6335163">]</span><span class="builtintype" id="6335164">string</span><span class="op" id="6335170">)</span>&nbsp;<span class="builtintype" id="6335172">error</span>&nbsp;<span class="op" id="6335178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335181">w</span>&nbsp;<span class="op" id="6335183">:=</span>&nbsp;<span class="ident" id="6335186">newWriter</span><span class="op" id="6335195">(</span><span class="ident" id="6335196">c</span><span class="op" id="6335197">,</span>&nbsp;<span class="ident" id="6335199">recType</span><span class="op" id="6335206">,</span>&nbsp;<span class="ident" id="6335208">reqId</span><span class="op" id="6335213">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335216">b</span>&nbsp;<span class="op" id="6335218">:=</span>&nbsp;<span class="builtinfunc" id="6335221">make</span><span class="op" id="6335225">(</span><span class="op" id="6335226">[</span><span class="op" id="6335227">]</span><span class="builtintype" id="6335228">byte</span><span class="op" id="6335232">,</span>&nbsp;<span class="num" id="6335234">8</span><span class="op" id="6335235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6335238">for</span>&nbsp;<span class="ident" id="6335242">k</span><span class="op" id="6335243">,</span>&nbsp;<span class="ident" id="6335245">v</span>&nbsp;<span class="op" id="6335247">:=</span>&nbsp;<span class="keyword" id="6335250">range</span>&nbsp;<span class="ident" id="6335256">pairs</span>&nbsp;<span class="op" id="6335262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335266">n</span>&nbsp;<span class="op" id="6335268">:=</span>&nbsp;<span class="ident" id="6335271">encodeSize</span><span class="op" id="6335281">(</span><span class="ident" id="6335282">b</span><span class="op" id="6335283">,</span>&nbsp;<span class="builtintype" id="6335285">uint32</span><span class="op" id="6335291">(</span><span class="builtinfunc" id="6335292">len</span><span class="op" id="6335295">(</span><span class="ident" id="6335296">k</span><span class="op" id="6335297">)</span><span class="op" id="6335298">)</span><span class="op" id="6335299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335303">n</span>&nbsp;<span class="op" id="6335305">+=</span>&nbsp;<span class="ident" id="6335308">encodeSize</span><span class="op" id="6335318">(</span><span class="ident" id="6335319">b</span><span class="op" id="6335320">[</span><span class="ident" id="6335321">n</span><span class="op" id="6335322">:</span><span class="op" id="6335323">]</span><span class="op" id="6335324">,</span>&nbsp;<span class="builtintype" id="6335326">uint32</span><span class="op" id="6335332">(</span><span class="builtinfunc" id="6335333">len</span><span class="op" id="6335336">(</span><span class="ident" id="6335337">v</span><span class="op" id="6335338">)</span><span class="op" id="6335339">)</span><span class="op" id="6335340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6335344">if</span>&nbsp;<span class="ident" id="6335347">_</span><span class="op" id="6335348">,</span>&nbsp;<span class="ident" id="6335350">err</span>&nbsp;<span class="op" id="6335354">:=</span>&nbsp;<span class="ident" id="6335357">w</span><span class="op" id="6335358">.</span><span class="ident" id="6335359">Write</span><span class="op" id="6335364">(</span><span class="ident" id="6335365">b</span><span class="op" id="6335366">[</span><span class="op" id="6335367">:</span><span class="ident" id="6335368">n</span><span class="op" id="6335369">]</span><span class="op" id="6335370">)</span><span class="op" id="6335371">;</span>&nbsp;<span class="ident" id="6335373">err</span>&nbsp;<span class="op" id="6335377">!=</span>&nbsp;<span class="builtintype" id="6335380">nil</span>&nbsp;<span class="op" id="6335384">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6335389">return</span>&nbsp;<span class="ident" id="6335396">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6335402">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6335406">if</span>&nbsp;<span class="ident" id="6335409">_</span><span class="op" id="6335410">,</span>&nbsp;<span class="ident" id="6335412">err</span>&nbsp;<span class="op" id="6335416">:=</span>&nbsp;<span class="ident" id="6335419">w</span><span class="op" id="6335420">.</span><span class="ident" id="6335421">WriteString</span><span class="op" id="6335432">(</span><span class="ident" id="6335433">k</span><span class="op" id="6335434">)</span><span class="op" id="6335435">;</span>&nbsp;<span class="ident" id="6335437">err</span>&nbsp;<span class="op" id="6335441">!=</span>&nbsp;<span class="builtintype" id="6335444">nil</span>&nbsp;<span class="op" id="6335448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6335453">return</span>&nbsp;<span class="ident" id="6335460">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6335466">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6335470">if</span>&nbsp;<span class="ident" id="6335473">_</span><span class="op" id="6335474">,</span>&nbsp;<span class="ident" id="6335476">err</span>&nbsp;<span class="op" id="6335480">:=</span>&nbsp;<span class="ident" id="6335483">w</span><span class="op" id="6335484">.</span><span class="ident" id="6335485">WriteString</span><span class="op" id="6335496">(</span><span class="ident" id="6335497">v</span><span class="op" id="6335498">)</span><span class="op" id="6335499">;</span>&nbsp;<span class="ident" id="6335501">err</span>&nbsp;<span class="op" id="6335505">!=</span>&nbsp;<span class="builtintype" id="6335508">nil</span>&nbsp;<span class="op" id="6335512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6335517">return</span>&nbsp;<span class="ident" id="6335524">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6335530">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6335533">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335536">w</span><span class="op" id="6335537">.</span><span class="ident" id="6335538">Close</span><span class="op" id="6335543">(</span><span class="op" id="6335544">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6335547">return</span>&nbsp;<span class="builtintype" id="6335554">nil</span><br>
<span class="lineno"></span><span class="op" id="6335558">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6335561">func</span>&nbsp;<span class="ident" id="6335566">readSize</span><span class="op" id="6335574">(</span><span class="ident" id="6335575">s</span>&nbsp;<span class="op" id="6335577">[</span><span class="op" id="6335578">]</span><span class="builtintype" id="6335579">byte</span><span class="op" id="6335583">)</span>&nbsp;<span class="op" id="6335585">(</span><span class="builtintype" id="6335586">uint32</span><span class="op" id="6335592">,</span>&nbsp;<span class="builtintype" id="6335594">int</span><span class="op" id="6335597">)</span>&nbsp;<span class="op" id="6335599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6335602">if</span>&nbsp;<span class="builtinfunc" id="6335605">len</span><span class="op" id="6335608">(</span><span class="ident" id="6335609">s</span><span class="op" id="6335610">)</span>&nbsp;<span class="op" id="6335612">==</span>&nbsp;<span class="num" id="6335615">0</span>&nbsp;<span class="op" id="6335617">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6335621">return</span>&nbsp;<span class="num" id="6335628">0</span><span class="op" id="6335629">,</span>&nbsp;<span class="num" id="6335631">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6335634">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335637">size</span><span class="op" id="6335641">,</span>&nbsp;<span class="ident" id="6335643">n</span>&nbsp;<span class="op" id="6335645">:=</span>&nbsp;<span class="builtintype" id="6335648">uint32</span><span class="op" id="6335654">(</span><span class="ident" id="6335655">s</span><span class="op" id="6335656">[</span><span class="num" id="6335657">0</span><span class="op" id="6335658">]</span><span class="op" id="6335659">)</span><span class="op" id="6335660">,</span>&nbsp;<span class="num" id="6335662">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6335665">if</span>&nbsp;<span class="ident" id="6335668">size</span><span class="op" id="6335672">&amp;</span><span class="op" id="6335673">(</span><span class="num" id="6335674">1</span><span class="op" id="6335675">&lt;&lt;</span><span class="num" id="6335677">7</span><span class="op" id="6335678">)</span>&nbsp;<span class="op" id="6335680">!=</span>&nbsp;<span class="num" id="6335683">0</span>&nbsp;<span class="op" id="6335685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6335689">if</span>&nbsp;<span class="builtinfunc" id="6335692">len</span><span class="op" id="6335695">(</span><span class="ident" id="6335696">s</span><span class="op" id="6335697">)</span>&nbsp;<span class="op" id="6335699">&lt;</span>&nbsp;<span class="num" id="6335701">4</span>&nbsp;<span class="op" id="6335703">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6335708">return</span>&nbsp;<span class="num" id="6335715">0</span><span class="op" id="6335716">,</span>&nbsp;<span class="num" id="6335718">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6335722">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335726">n</span>&nbsp;<span class="op" id="6335728">=</span>&nbsp;<span class="num" id="6335730">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335734">size</span>&nbsp;<span class="op" id="6335739">=</span>&nbsp;<span class="ident" id="6335741">binary</span><span class="op" id="6335747">.</span><span class="ident" id="6335748">BigEndian</span><span class="op" id="6335757">.</span><span class="ident" id="6335758">Uint32</span><span class="op" id="6335764">(</span><span class="ident" id="6335765">s</span><span class="op" id="6335766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335770">size</span>&nbsp;<span class="op" id="6335775">&amp;^=</span>&nbsp;<span class="num" id="6335779">1</span>&nbsp;<span class="op" id="6335781">&lt;&lt;</span>&nbsp;<span class="num" id="6335784">31</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6335788">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6335791">return</span>&nbsp;<span class="ident" id="6335798">size</span><span class="op" id="6335802">,</span>&nbsp;<span class="ident" id="6335804">n</span><br>
<span class="lineno"></span><span class="op" id="6335806">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6335809">func</span>&nbsp;<span class="ident" id="6335814">readString</span><span class="op" id="6335824">(</span><span class="ident" id="6335825">s</span>&nbsp;<span class="op" id="6335827">[</span><span class="op" id="6335828">]</span><span class="builtintype" id="6335829">byte</span><span class="op" id="6335833">,</span>&nbsp;<span class="ident" id="6335835">size</span>&nbsp;<span class="builtintype" id="6335840">uint32</span><span class="op" id="6335846">)</span>&nbsp;<span class="builtintype" id="6335848">string</span>&nbsp;<span class="op" id="6335855">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6335858">if</span>&nbsp;<span class="ident" id="6335861">size</span>&nbsp;<span class="op" id="6335866">&gt;</span>&nbsp;<span class="builtintype" id="6335868">uint32</span><span class="op" id="6335874">(</span><span class="builtinfunc" id="6335875">len</span><span class="op" id="6335878">(</span><span class="ident" id="6335879">s</span><span class="op" id="6335880">)</span><span class="op" id="6335881">)</span>&nbsp;<span class="op" id="6335883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6335887">return</span>&nbsp;<span class="string" id="6335894">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6335898">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6335901">return</span>&nbsp;<span class="builtintype" id="6335908">string</span><span class="op" id="6335914">(</span><span class="ident" id="6335915">s</span><span class="op" id="6335916">[</span><span class="op" id="6335917">:</span><span class="ident" id="6335918">size</span><span class="op" id="6335922">]</span><span class="op" id="6335923">)</span><br>
<span class="lineno"></span><span class="op" id="6335925">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="6335928">func</span>&nbsp;<span class="ident" id="6335933">encodeSize</span><span class="op" id="6335943">(</span><span class="ident" id="6335944">b</span>&nbsp;<span class="op" id="6335946">[</span><span class="op" id="6335947">]</span><span class="builtintype" id="6335948">byte</span><span class="op" id="6335952">,</span>&nbsp;<span class="ident" id="6335954">size</span>&nbsp;<span class="builtintype" id="6335959">uint32</span><span class="op" id="6335965">)</span>&nbsp;<span class="builtintype" id="6335967">int</span>&nbsp;<span class="op" id="6335971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6335974">if</span>&nbsp;<span class="ident" id="6335977">size</span>&nbsp;<span class="op" id="6335982">&gt;</span>&nbsp;<span class="num" id="6335984">127</span>&nbsp;<span class="op" id="6335988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335992">size</span>&nbsp;<span class="op" id="6335997">|=</span>&nbsp;<span class="num" id="6336000">1</span>&nbsp;<span class="op" id="6336002">&lt;&lt;</span>&nbsp;<span class="num" id="6336005">31</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6336010">binary</span><span class="op" id="6336016">.</span><span class="ident" id="6336017">BigEndian</span><span class="op" id="6336026">.</span><span class="ident" id="6336027">PutUint32</span><span class="op" id="6336036">(</span><span class="ident" id="6336037">b</span><span class="op" id="6336038">,</span>&nbsp;<span class="ident" id="6336040">size</span><span class="op" id="6336044">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6336048">return</span>&nbsp;<span class="num" id="6336055">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6336058">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6336061">b</span><span class="op" id="6336062">[</span><span class="num" id="6336063">0</span><span class="op" id="6336064">]</span>&nbsp;<span class="op" id="6336066">=</span>&nbsp;<span class="builtintype" id="6336068">byte</span><span class="op" id="6336072">(</span><span class="ident" id="6336073">size</span><span class="op" id="6336077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6336080">return</span>&nbsp;<span class="num" id="6336087">1</span><br>
<span class="lineno"></span><span class="op" id="6336089">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="comment" id="6336092">//&nbsp;bufWriter&nbsp;encapsulates&nbsp;bufio.Writer&nbsp;but&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;stream&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="6336174">//&nbsp;Closed.</span><br>
<span class="lineno"></span><span class="keyword" id="6336185">type</span>&nbsp;<span class="ident" id="6336190">bufWriter</span>&nbsp;<span class="keyword" id="6336200">struct</span>&nbsp;<span class="op" id="6336207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6336210">closer</span>&nbsp;<span class="ident" id="6336217">io</span><span class="op" id="6336219">.</span><span class="ident" id="6336220">Closer</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6336228">*</span><span class="ident" id="6336229">bufio</span><span class="op" id="6336234">.</span><span class="ident" id="6336235">Writer</span><br>
<span class="lineno"></span><span class="op" id="6336242">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6336245">func</span>&nbsp;<span class="op" id="6336250">(</span><span class="ident" id="6336251">w</span>&nbsp;<span class="op" id="6336253">*</span><span class="ident" id="6336254">bufWriter</span><span class="op" id="6336263">)</span>&nbsp;<span class="ident" id="6336265">Close</span><span class="op" id="6336270">(</span><span class="op" id="6336271">)</span>&nbsp;<span class="builtintype" id="6336273">error</span>&nbsp;<span class="op" id="6336279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6336282">if</span>&nbsp;<span class="ident" id="6336285">err</span>&nbsp;<span class="op" id="6336289">:=</span>&nbsp;<span class="ident" id="6336292">w</span><span class="op" id="6336293">.</span><span class="ident" id="6336294">Writer</span><span class="op" id="6336300">.</span><span class="ident" id="6336301">Flush</span><span class="op" id="6336306">(</span><span class="op" id="6336307">)</span><span class="op" id="6336308">;</span>&nbsp;<span class="ident" id="6336310">err</span>&nbsp;<span class="op" id="6336314">!=</span>&nbsp;<span class="builtintype" id="6336317">nil</span>&nbsp;<span class="op" id="6336321">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6336325">w</span><span class="op" id="6336326">.</span><span class="ident" id="6336327">closer</span><span class="op" id="6336333">.</span><span class="ident" id="6336334">Close</span><span class="op" id="6336339">(</span><span class="op" id="6336340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6336344">return</span>&nbsp;<span class="ident" id="6336351">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6336356">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6336359">return</span>&nbsp;<span class="ident" id="6336366">w</span><span class="op" id="6336367">.</span><span class="ident" id="6336368">closer</span><span class="op" id="6336374">.</span><span class="ident" id="6336375">Close</span><span class="op" id="6336380">(</span><span class="op" id="6336381">)</span><br>
<span class="lineno"></span><span class="op" id="6336383">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span><span class="keyword" id="6336386">func</span>&nbsp;<span class="ident" id="6336391">newWriter</span><span class="op" id="6336400">(</span><span class="ident" id="6336401">c</span>&nbsp;<span class="op" id="6336403">*</span><span class="ident" id="6336404">conn</span><span class="op" id="6336408">,</span>&nbsp;<span class="ident" id="6336410">recType</span>&nbsp;<span class="ident" id="6336418">recType</span><span class="op" id="6336425">,</span>&nbsp;<span class="ident" id="6336427">reqId</span>&nbsp;<span class="builtintype" id="6336433">uint16</span><span class="op" id="6336439">)</span>&nbsp;<span class="op" id="6336441">*</span><span class="ident" id="6336442">bufWriter</span>&nbsp;<span class="op" id="6336452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6336455">s</span>&nbsp;<span class="op" id="6336457">:=</span>&nbsp;<span class="op" id="6336460">&amp;</span><span class="ident" id="6336461">streamWriter</span><span class="op" id="6336473">{</span><span class="ident" id="6336474">c</span><span class="op" id="6336475">:</span>&nbsp;<span class="ident" id="6336477">c</span><span class="op" id="6336478">,</span>&nbsp;<span class="ident" id="6336480">recType</span><span class="op" id="6336487">:</span>&nbsp;<span class="ident" id="6336489">recType</span><span class="op" id="6336496">,</span>&nbsp;<span class="ident" id="6336498">reqId</span><span class="op" id="6336503">:</span>&nbsp;<span class="ident" id="6336505">reqId</span><span class="op" id="6336510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6336513">w</span>&nbsp;<span class="op" id="6336515">:=</span>&nbsp;<span class="ident" id="6336518">bufio</span><span class="op" id="6336523">.</span><span class="ident" id="6336524">NewWriterSize</span><span class="op" id="6336537">(</span><span class="ident" id="6336538">s</span><span class="op" id="6336539">,</span>&nbsp;<span class="ident" id="6336541">maxWrite</span><span class="op" id="6336549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6336552">return</span>&nbsp;<span class="op" id="6336559">&amp;</span><span class="ident" id="6336560">bufWriter</span><span class="op" id="6336569">{</span><span class="ident" id="6336570">s</span><span class="op" id="6336571">,</span>&nbsp;<span class="ident" id="6336573">w</span><span class="op" id="6336574">}</span><br>
<span class="lineno">245</span><span class="op" id="6336576">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6336579">//&nbsp;streamWriter&nbsp;abstracts&nbsp;out&nbsp;the&nbsp;separation&nbsp;of&nbsp;a&nbsp;stream&nbsp;into&nbsp;discrete&nbsp;records.</span><br>
<span class="lineno"></span><span class="comment" id="6336659">//&nbsp;It&nbsp;only&nbsp;writes&nbsp;maxWrite&nbsp;bytes&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span><span class="keyword" id="6336703">type</span>&nbsp;<span class="ident" id="6336708">streamWriter</span>&nbsp;<span class="keyword" id="6336721">struct</span>&nbsp;<span class="op" id="6336728">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6336731">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6336739">*</span><span class="ident" id="6336740">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6336746">recType</span>&nbsp;<span class="ident" id="6336754">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6336763">reqId</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6336771">uint16</span><br>
<span class="lineno"></span><span class="op" id="6336778">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="keyword" id="6336781">func</span>&nbsp;<span class="op" id="6336786">(</span><span class="ident" id="6336787">w</span>&nbsp;<span class="op" id="6336789">*</span><span class="ident" id="6336790">streamWriter</span><span class="op" id="6336802">)</span>&nbsp;<span class="ident" id="6336804">Write</span><span class="op" id="6336809">(</span><span class="ident" id="6336810">p</span>&nbsp;<span class="op" id="6336812">[</span><span class="op" id="6336813">]</span><span class="builtintype" id="6336814">byte</span><span class="op" id="6336818">)</span>&nbsp;<span class="op" id="6336820">(</span><span class="builtintype" id="6336821">int</span><span class="op" id="6336824">,</span>&nbsp;<span class="builtintype" id="6336826">error</span><span class="op" id="6336831">)</span>&nbsp;<span class="op" id="6336833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6336836">nn</span>&nbsp;<span class="op" id="6336839">:=</span>&nbsp;<span class="num" id="6336842">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6336845">for</span>&nbsp;<span class="builtinfunc" id="6336849">len</span><span class="op" id="6336852">(</span><span class="ident" id="6336853">p</span><span class="op" id="6336854">)</span>&nbsp;<span class="op" id="6336856">&gt;</span>&nbsp;<span class="num" id="6336858">0</span>&nbsp;<span class="op" id="6336860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6336864">n</span>&nbsp;<span class="op" id="6336866">:=</span>&nbsp;<span class="builtinfunc" id="6336869">len</span><span class="op" id="6336872">(</span><span class="ident" id="6336873">p</span><span class="op" id="6336874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6336878">if</span>&nbsp;<span class="ident" id="6336881">n</span>&nbsp;<span class="op" id="6336883">&gt;</span>&nbsp;<span class="ident" id="6336885">maxWrite</span>&nbsp;<span class="op" id="6336894">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6336899">n</span>&nbsp;<span class="op" id="6336901">=</span>&nbsp;<span class="ident" id="6336903">maxWrite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6336914">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6336918">if</span>&nbsp;<span class="ident" id="6336921">err</span>&nbsp;<span class="op" id="6336925">:=</span>&nbsp;<span class="ident" id="6336928">w</span><span class="op" id="6336929">.</span><span class="ident" id="6336930">c</span><span class="op" id="6336931">.</span><span class="ident" id="6336932">writeRecord</span><span class="op" id="6336943">(</span><span class="ident" id="6336944">w</span><span class="op" id="6336945">.</span><span class="ident" id="6336946">recType</span><span class="op" id="6336953">,</span>&nbsp;<span class="ident" id="6336955">w</span><span class="op" id="6336956">.</span><span class="ident" id="6336957">reqId</span><span class="op" id="6336962">,</span>&nbsp;<span class="ident" id="6336964">p</span><span class="op" id="6336965">[</span><span class="op" id="6336966">:</span><span class="ident" id="6336967">n</span><span class="op" id="6336968">]</span><span class="op" id="6336969">)</span><span class="op" id="6336970">;</span>&nbsp;<span class="ident" id="6336972">err</span>&nbsp;<span class="op" id="6336976">!=</span>&nbsp;<span class="builtintype" id="6336979">nil</span>&nbsp;<span class="op" id="6336983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6336988">return</span>&nbsp;<span class="ident" id="6336995">nn</span><span class="op" id="6336997">,</span>&nbsp;<span class="ident" id="6336999">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6337005">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6337009">nn</span>&nbsp;<span class="op" id="6337012">+=</span>&nbsp;<span class="ident" id="6337015">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6337019">p</span>&nbsp;<span class="op" id="6337021">=</span>&nbsp;<span class="ident" id="6337023">p</span><span class="op" id="6337024">[</span><span class="ident" id="6337025">n</span><span class="op" id="6337026">:</span><span class="op" id="6337027">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6337030">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6337033">return</span>&nbsp;<span class="ident" id="6337040">nn</span><span class="op" id="6337042">,</span>&nbsp;<span class="builtintype" id="6337044">nil</span><br>
<span class="lineno"></span><span class="op" id="6337048">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="keyword" id="6337051">func</span>&nbsp;<span class="op" id="6337056">(</span><span class="ident" id="6337057">w</span>&nbsp;<span class="op" id="6337059">*</span><span class="ident" id="6337060">streamWriter</span><span class="op" id="6337072">)</span>&nbsp;<span class="ident" id="6337074">Close</span><span class="op" id="6337079">(</span><span class="op" id="6337080">)</span>&nbsp;<span class="builtintype" id="6337082">error</span>&nbsp;<span class="op" id="6337088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6337091">//&nbsp;send&nbsp;empty&nbsp;record&nbsp;to&nbsp;close&nbsp;the&nbsp;stream</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6337133">return</span>&nbsp;<span class="ident" id="6337140">w</span><span class="op" id="6337141">.</span><span class="ident" id="6337142">c</span><span class="op" id="6337143">.</span><span class="ident" id="6337144">writeRecord</span><span class="op" id="6337155">(</span><span class="ident" id="6337156">w</span><span class="op" id="6337157">.</span><span class="ident" id="6337158">recType</span><span class="op" id="6337165">,</span>&nbsp;<span class="ident" id="6337167">w</span><span class="op" id="6337168">.</span><span class="ident" id="6337169">reqId</span><span class="op" id="6337174">,</span>&nbsp;<span class="builtintype" id="6337176">nil</span><span class="op" id="6337179">)</span><br>
<span class="lineno"></span><span class="op" id="6337181">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
