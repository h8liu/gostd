<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html" class="current">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8515081">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8515136">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8515190">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="8515241">package</span>&nbsp;<span class="ident" id="8515249">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8515254">import</span>&nbsp;<span class="op" id="8515261">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8515264">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8515273">&#34;fmt&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8515280">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8515286">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8515293">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8515304">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8515315">&#34;time&#34;</span><br>
<span class="lineno">15</span><span class="op" id="8515322">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8515325">var</span>&nbsp;<span class="ident" id="8515329">rsaCertPEM</span>&nbsp;<span class="op" id="8515340">=</span>&nbsp;<span class="string" id="8515342">`-----BEGIN&nbsp;CERTIFICATE-----<br>
<span class="lineno"></span>MIIB0zCCAX2gAwIBAgIJAI/M7BYjwB+uMA0GCSqGSIb3DQEBBQUAMEUxCzAJBgNV<br>
<span class="lineno"></span>BAYTAkFVMRMwEQYDVQQIDApTb21lLVN0YXRlMSEwHwYDVQQKDBhJbnRlcm5ldCBX<br>
<span class="lineno">20</span>aWRnaXRzIFB0eSBMdGQwHhcNMTIwOTEyMjE1MjAyWhcNMTUwOTEyMjE1MjAyWjBF<br>
<span class="lineno"></span>MQswCQYDVQQGEwJBVTETMBEGA1UECAwKU29tZS1TdGF0ZTEhMB8GA1UECgwYSW50<br>
<span class="lineno"></span>ZXJuZXQgV2lkZ2l0cyBQdHkgTHRkMFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBANLJ<br>
<span class="lineno"></span>hPHhITqQbPklG3ibCVxwGMRfp/v4XqhfdQHdcVfHap6NQ5Wok/4xIA+ui35/MmNa<br>
<span class="lineno"></span>rtNuC+BdZ1tMuVCPFZcCAwEAAaNQME4wHQYDVR0OBBYEFJvKs8RfJaXTH08W+SGv<br>
<span class="lineno">25</span>zQyKn0H8MB8GA1UdIwQYMBaAFJvKs8RfJaXTH08W+SGvzQyKn0H8MAwGA1UdEwQF<br>
<span class="lineno"></span>MAMBAf8wDQYJKoZIhvcNAQEFBQADQQBJlffJHybjDGxRMqaRmDhX0+6v02TUKZsW<br>
<span class="lineno"></span>r5QuVbpQhH6u+0UgcW0jp9QwpxoPTLTWGXEWBBBurxFwiCBhkQ+V<br>
<span class="lineno"></span>-----END&nbsp;CERTIFICATE-----<br>
<span class="lineno"></span>`</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="8516038">var</span>&nbsp;<span class="ident" id="8516042">rsaKeyPEM</span>&nbsp;<span class="op" id="8516052">=</span>&nbsp;<span class="string" id="8516054">`-----BEGIN&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----<br>
<span class="lineno"></span>MIIBOwIBAAJBANLJhPHhITqQbPklG3ibCVxwGMRfp/v4XqhfdQHdcVfHap6NQ5Wo<br>
<span class="lineno"></span>k/4xIA+ui35/MmNartNuC+BdZ1tMuVCPFZcCAwEAAQJAEJ2N+zsR0Xn8/Q6twa4G<br>
<span class="lineno"></span>6OB1M1WO+k+ztnX/1SvNeWu8D6GImtupLTYgjZcHufykj09jiHmjHx8u8ZZB/o1N<br>
<span class="lineno">35</span>MQIhAPW+eyZo7ay3lMz1V01WVjNKK9QSn1MJlb06h/LuYv9FAiEA25WPedKgVyCW<br>
<span class="lineno"></span>SmUwbPw8fnTcpqDWE3yTO3vKcebqMSsCIBF3UmVue8YU3jybC3NxuXq3wNm34R8T<br>
<span class="lineno"></span>xVLHwDXh/6NJAiEAl2oHGGLz64BuAfjKrqwz7qMYr9HCLIe/YsoWq/olzScCIQDi<br>
<span class="lineno"></span>D2lWusoe2/nEqfDVVWGWlyJ7yOmqaVm/iNUN9B2N2g==<br>
<span class="lineno"></span>-----END&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----<br>
<span class="lineno">40</span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8516555">//&nbsp;keyPEM&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;rsaKeyPEM,&nbsp;but&nbsp;declares&nbsp;itself&nbsp;as&nbsp;just</span><br>
<span class="lineno"></span><span class="comment" id="8516619">//&nbsp;&#34;PRIVATE&nbsp;KEY&#34;,&nbsp;not&nbsp;&#34;RSA&nbsp;PRIVATE&nbsp;KEY&#34;.&nbsp;&nbsp;http://golang.org/issue/4477</span><br>
<span class="lineno"></span><span class="keyword" id="8516690">var</span>&nbsp;<span class="ident" id="8516694">keyPEM</span>&nbsp;<span class="op" id="8516701">=</span>&nbsp;<span class="string" id="8516703">`-----BEGIN&nbsp;PRIVATE&nbsp;KEY-----<br>
<span class="lineno">45</span>MIIBOwIBAAJBANLJhPHhITqQbPklG3ibCVxwGMRfp/v4XqhfdQHdcVfHap6NQ5Wo<br>
<span class="lineno"></span>k/4xIA+ui35/MmNartNuC+BdZ1tMuVCPFZcCAwEAAQJAEJ2N+zsR0Xn8/Q6twa4G<br>
<span class="lineno"></span>6OB1M1WO+k+ztnX/1SvNeWu8D6GImtupLTYgjZcHufykj09jiHmjHx8u8ZZB/o1N<br>
<span class="lineno"></span>MQIhAPW+eyZo7ay3lMz1V01WVjNKK9QSn1MJlb06h/LuYv9FAiEA25WPedKgVyCW<br>
<span class="lineno"></span>SmUwbPw8fnTcpqDWE3yTO3vKcebqMSsCIBF3UmVue8YU3jybC3NxuXq3wNm34R8T<br>
<span class="lineno">50</span>xVLHwDXh/6NJAiEAl2oHGGLz64BuAfjKrqwz7qMYr9HCLIe/YsoWq/olzScCIQDi<br>
<span class="lineno"></span>D2lWusoe2/nEqfDVVWGWlyJ7yOmqaVm/iNUN9B2N2g==<br>
<span class="lineno"></span>-----END&nbsp;PRIVATE&nbsp;KEY-----<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="8517196">var</span>&nbsp;<span class="ident" id="8517200">ecdsaCertPEM</span>&nbsp;<span class="op" id="8517213">=</span>&nbsp;<span class="string" id="8517215">`-----BEGIN&nbsp;CERTIFICATE-----<br>
<span class="lineno"></span>MIIB/jCCAWICCQDscdUxw16XFDAJBgcqhkjOPQQBMEUxCzAJBgNVBAYTAkFVMRMw<br>
<span class="lineno"></span>EQYDVQQIEwpTb21lLVN0YXRlMSEwHwYDVQQKExhJbnRlcm5ldCBXaWRnaXRzIFB0<br>
<span class="lineno"></span>eSBMdGQwHhcNMTIxMTE0MTI0MDQ4WhcNMTUxMTE0MTI0MDQ4WjBFMQswCQYDVQQG<br>
<span class="lineno"></span>EwJBVTETMBEGA1UECBMKU29tZS1TdGF0ZTEhMB8GA1UEChMYSW50ZXJuZXQgV2lk<br>
<span class="lineno">60</span>Z2l0cyBQdHkgTHRkMIGbMBAGByqGSM49AgEGBSuBBAAjA4GGAAQBY9+my9OoeSUR<br>
<span class="lineno"></span>lDQdV/x8LsOuLilthhiS1Tz4aGDHIPwC1mlvnf7fg5lecYpMCrLLhauAc1UJXcgl<br>
<span class="lineno"></span>01xoLuzgtAEAgv2P/jgytzRSpUYvgLBt1UA0leLYBy6mQQbrNEuqT3INapKIcUv8<br>
<span class="lineno"></span>XxYP0xMEUksLPq6Ca+CRSqTtrd/23uTnapkwCQYHKoZIzj0EAQOBigAwgYYCQXJo<br>
<span class="lineno"></span>A7Sl2nLVf+4Iu/tAX/IF4MavARKC4PPHK3zfuGfPR3oCCcsAoz3kAzOeijvd0iXb<br>
<span class="lineno">65</span>H5jBImIxPL4WxQNiBTexAkF8D1EtpYuWdlVQ80/h/f4pBcGiXPqX5h2PQSQY7hP1<br>
<span class="lineno"></span>+jwM1FGS4fREIOvlBYr/SzzQRtwrvrzGYxDEDbsC0ZGRnA==<br>
<span class="lineno"></span>-----END&nbsp;CERTIFICATE-----<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="keyword" id="8517972">var</span>&nbsp;<span class="ident" id="8517976">ecdsaKeyPEM</span>&nbsp;<span class="op" id="8517988">=</span>&nbsp;<span class="string" id="8517990">`-----BEGIN&nbsp;EC&nbsp;PARAMETERS-----<br>
<span class="lineno"></span>BgUrgQQAIw==<br>
<span class="lineno"></span>-----END&nbsp;EC&nbsp;PARAMETERS-----<br>
<span class="lineno"></span>-----BEGIN&nbsp;EC&nbsp;PRIVATE&nbsp;KEY-----<br>
<span class="lineno"></span>MIHcAgEBBEIBrsoKp0oqcv6/JovJJDoDVSGWdirrkgCWxrprGlzB9o0X8fV675X0<br>
<span class="lineno">75</span>NwuBenXFfeZvVcwluO7/Q9wkYoPd/t3jGImgBwYFK4EEACOhgYkDgYYABAFj36bL<br>
<span class="lineno"></span>06h5JRGUNB1X/Hwuw64uKW2GGJLVPPhoYMcg/ALWaW+d/t+DmV5xikwKssuFq4Bz<br>
<span class="lineno"></span>VQldyCXTXGgu7OC0AQCC/Y/+ODK3NFKlRi+AsG3VQDSV4tgHLqZBBus0S6pPcg1q<br>
<span class="lineno"></span>kohxS/xfFg/TEwRSSws+roJr4JFKpO2t3/be5OdqmQ==<br>
<span class="lineno"></span>-----END&nbsp;EC&nbsp;PRIVATE&nbsp;KEY-----<br>
<span class="lineno">80</span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8518430">var</span>&nbsp;<span class="ident" id="8518434">keyPairTests</span>&nbsp;<span class="op" id="8518447">=</span>&nbsp;<span class="op" id="8518449">[</span><span class="op" id="8518450">]</span><span class="keyword" id="8518451">struct</span>&nbsp;<span class="op" id="8518458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8518461">algo</span>&nbsp;<span class="builtintype" id="8518466">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8518474">cert</span>&nbsp;<span class="builtintype" id="8518479">string</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8518487">key</span>&nbsp;&nbsp;<span class="builtintype" id="8518492">string</span><br>
<span class="lineno"></span><span class="op" id="8518499">}</span><span class="op" id="8518500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8518503">{</span><span class="string" id="8518504">&#34;ECDSA&#34;</span><span class="op" id="8518511">,</span>&nbsp;<span class="ident" id="8518513">ecdsaCertPEM</span><span class="op" id="8518525">,</span>&nbsp;<span class="ident" id="8518527">ecdsaKeyPEM</span><span class="op" id="8518538">}</span><span class="op" id="8518539">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8518542">{</span><span class="string" id="8518543">&#34;RSA&#34;</span><span class="op" id="8518548">,</span>&nbsp;<span class="ident" id="8518550">rsaCertPEM</span><span class="op" id="8518560">,</span>&nbsp;<span class="ident" id="8518562">rsaKeyPEM</span><span class="op" id="8518571">}</span><span class="op" id="8518572">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8518575">{</span><span class="string" id="8518576">&#34;RSA-untyped&#34;</span><span class="op" id="8518589">,</span>&nbsp;<span class="ident" id="8518591">rsaCertPEM</span><span class="op" id="8518601">,</span>&nbsp;<span class="ident" id="8518603">keyPEM</span><span class="op" id="8518609">}</span><span class="op" id="8518610">,</span>&nbsp;<span class="comment" id="8518612">//&nbsp;golang.org/issue/4477</span><br>
<span class="lineno">90</span><span class="op" id="8518637">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8518640">func</span>&nbsp;<span class="ident" id="8518645">TestX509KeyPair</span><span class="op" id="8518660">(</span><span class="ident" id="8518661">t</span>&nbsp;<span class="op" id="8518663">*</span><span class="ident" id="8518664">testing</span><span class="op" id="8518671">.</span><span class="ident" id="8518672">T</span><span class="op" id="8518673">)</span>&nbsp;<span class="op" id="8518675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8518678">var</span>&nbsp;<span class="ident" id="8518682">pem</span>&nbsp;<span class="op" id="8518686">[</span><span class="op" id="8518687">]</span><span class="builtintype" id="8518688">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8518694">for</span>&nbsp;<span class="ident" id="8518698">_</span><span class="op" id="8518699">,</span>&nbsp;<span class="ident" id="8518701">test</span>&nbsp;<span class="op" id="8518706">:=</span>&nbsp;<span class="keyword" id="8518709">range</span>&nbsp;<span class="ident" id="8518715">keyPairTests</span>&nbsp;<span class="op" id="8518728">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8518732">pem</span>&nbsp;<span class="op" id="8518736">=</span>&nbsp;<span class="op" id="8518738">[</span><span class="op" id="8518739">]</span><span class="builtintype" id="8518740">byte</span><span class="op" id="8518744">(</span><span class="ident" id="8518745">test</span><span class="op" id="8518749">.</span><span class="ident" id="8518750">cert</span>&nbsp;<span class="op" id="8518755">+</span>&nbsp;<span class="ident" id="8518757">test</span><span class="op" id="8518761">.</span><span class="ident" id="8518762">key</span><span class="op" id="8518765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8518769">if</span>&nbsp;<span class="ident" id="8518772">_</span><span class="op" id="8518773">,</span>&nbsp;<span class="ident" id="8518775">err</span>&nbsp;<span class="op" id="8518779">:=</span>&nbsp;<span class="ident" id="8518782">X509KeyPair</span><span class="op" id="8518793">(</span><span class="ident" id="8518794">pem</span><span class="op" id="8518797">,</span>&nbsp;<span class="ident" id="8518799">pem</span><span class="op" id="8518802">)</span><span class="op" id="8518803">;</span>&nbsp;<span class="ident" id="8518805">err</span>&nbsp;<span class="op" id="8518809">!=</span>&nbsp;<span class="ident" id="8518812">nil</span>&nbsp;<span class="op" id="8518816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8518821">t</span><span class="op" id="8518822">.</span><span class="ident" id="8518823">Errorf</span><span class="op" id="8518829">(</span><span class="string" id="8518830">&#34;Failed&nbsp;to&nbsp;load&nbsp;%s&nbsp;cert&nbsp;followed&nbsp;by&nbsp;%s&nbsp;key:&nbsp;%s&#34;</span><span class="op" id="8518877">,</span>&nbsp;<span class="ident" id="8518879">test</span><span class="op" id="8518883">.</span><span class="ident" id="8518884">algo</span><span class="op" id="8518888">,</span>&nbsp;<span class="ident" id="8518890">test</span><span class="op" id="8518894">.</span><span class="ident" id="8518895">algo</span><span class="op" id="8518899">,</span>&nbsp;<span class="ident" id="8518901">err</span><span class="op" id="8518904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8518908">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8518912">pem</span>&nbsp;<span class="op" id="8518916">=</span>&nbsp;<span class="op" id="8518918">[</span><span class="op" id="8518919">]</span><span class="builtintype" id="8518920">byte</span><span class="op" id="8518924">(</span><span class="ident" id="8518925">test</span><span class="op" id="8518929">.</span><span class="ident" id="8518930">key</span>&nbsp;<span class="op" id="8518934">+</span>&nbsp;<span class="ident" id="8518936">test</span><span class="op" id="8518940">.</span><span class="ident" id="8518941">cert</span><span class="op" id="8518945">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8518949">if</span>&nbsp;<span class="ident" id="8518952">_</span><span class="op" id="8518953">,</span>&nbsp;<span class="ident" id="8518955">err</span>&nbsp;<span class="op" id="8518959">:=</span>&nbsp;<span class="ident" id="8518962">X509KeyPair</span><span class="op" id="8518973">(</span><span class="ident" id="8518974">pem</span><span class="op" id="8518977">,</span>&nbsp;<span class="ident" id="8518979">pem</span><span class="op" id="8518982">)</span><span class="op" id="8518983">;</span>&nbsp;<span class="ident" id="8518985">err</span>&nbsp;<span class="op" id="8518989">!=</span>&nbsp;<span class="ident" id="8518992">nil</span>&nbsp;<span class="op" id="8518996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519001">t</span><span class="op" id="8519002">.</span><span class="ident" id="8519003">Errorf</span><span class="op" id="8519009">(</span><span class="string" id="8519010">&#34;Failed&nbsp;to&nbsp;load&nbsp;%s&nbsp;key&nbsp;followed&nbsp;by&nbsp;%s&nbsp;cert:&nbsp;%s&#34;</span><span class="op" id="8519057">,</span>&nbsp;<span class="ident" id="8519059">test</span><span class="op" id="8519063">.</span><span class="ident" id="8519064">algo</span><span class="op" id="8519068">,</span>&nbsp;<span class="ident" id="8519070">test</span><span class="op" id="8519074">.</span><span class="ident" id="8519075">algo</span><span class="op" id="8519079">,</span>&nbsp;<span class="ident" id="8519081">err</span><span class="op" id="8519084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8519088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8519091">}</span><br>
<span class="lineno"></span><span class="op" id="8519093">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="8519096">func</span>&nbsp;<span class="ident" id="8519101">TestX509MixedKeyPair</span><span class="op" id="8519121">(</span><span class="ident" id="8519122">t</span>&nbsp;<span class="op" id="8519124">*</span><span class="ident" id="8519125">testing</span><span class="op" id="8519132">.</span><span class="ident" id="8519133">T</span><span class="op" id="8519134">)</span>&nbsp;<span class="op" id="8519136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8519139">if</span>&nbsp;<span class="ident" id="8519142">_</span><span class="op" id="8519143">,</span>&nbsp;<span class="ident" id="8519145">err</span>&nbsp;<span class="op" id="8519149">:=</span>&nbsp;<span class="ident" id="8519152">X509KeyPair</span><span class="op" id="8519163">(</span><span class="op" id="8519164">[</span><span class="op" id="8519165">]</span><span class="builtintype" id="8519166">byte</span><span class="op" id="8519170">(</span><span class="ident" id="8519171">rsaCertPEM</span><span class="op" id="8519181">)</span><span class="op" id="8519182">,</span>&nbsp;<span class="op" id="8519184">[</span><span class="op" id="8519185">]</span><span class="builtintype" id="8519186">byte</span><span class="op" id="8519190">(</span><span class="ident" id="8519191">ecdsaKeyPEM</span><span class="op" id="8519202">)</span><span class="op" id="8519203">)</span><span class="op" id="8519204">;</span>&nbsp;<span class="ident" id="8519206">err</span>&nbsp;<span class="op" id="8519210">==</span>&nbsp;<span class="ident" id="8519213">nil</span>&nbsp;<span class="op" id="8519217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519221">t</span><span class="op" id="8519222">.</span><span class="ident" id="8519223">Error</span><span class="op" id="8519228">(</span><span class="string" id="8519229">&#34;Load&nbsp;of&nbsp;RSA&nbsp;certificate&nbsp;succeeded&nbsp;with&nbsp;ECDSA&nbsp;private&nbsp;key&#34;</span><span class="op" id="8519287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8519290">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8519293">if</span>&nbsp;<span class="ident" id="8519296">_</span><span class="op" id="8519297">,</span>&nbsp;<span class="ident" id="8519299">err</span>&nbsp;<span class="op" id="8519303">:=</span>&nbsp;<span class="ident" id="8519306">X509KeyPair</span><span class="op" id="8519317">(</span><span class="op" id="8519318">[</span><span class="op" id="8519319">]</span><span class="builtintype" id="8519320">byte</span><span class="op" id="8519324">(</span><span class="ident" id="8519325">ecdsaCertPEM</span><span class="op" id="8519337">)</span><span class="op" id="8519338">,</span>&nbsp;<span class="op" id="8519340">[</span><span class="op" id="8519341">]</span><span class="builtintype" id="8519342">byte</span><span class="op" id="8519346">(</span><span class="ident" id="8519347">rsaKeyPEM</span><span class="op" id="8519356">)</span><span class="op" id="8519357">)</span><span class="op" id="8519358">;</span>&nbsp;<span class="ident" id="8519360">err</span>&nbsp;<span class="op" id="8519364">==</span>&nbsp;<span class="ident" id="8519367">nil</span>&nbsp;<span class="op" id="8519371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519375">t</span><span class="op" id="8519376">.</span><span class="ident" id="8519377">Error</span><span class="op" id="8519382">(</span><span class="string" id="8519383">&#34;Load&nbsp;of&nbsp;ECDSA&nbsp;certificate&nbsp;succeeded&nbsp;with&nbsp;RSA&nbsp;private&nbsp;key&#34;</span><span class="op" id="8519441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8519444">}</span><br>
<span class="lineno"></span><span class="op" id="8519446">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="8519449">func</span>&nbsp;<span class="ident" id="8519454">newLocalListener</span><span class="op" id="8519470">(</span><span class="ident" id="8519471">t</span>&nbsp;<span class="op" id="8519473">*</span><span class="ident" id="8519474">testing</span><span class="op" id="8519481">.</span><span class="ident" id="8519482">T</span><span class="op" id="8519483">)</span>&nbsp;<span class="ident" id="8519485">net</span><span class="op" id="8519488">.</span><span class="ident" id="8519489">Listener</span>&nbsp;<span class="op" id="8519498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519501">ln</span><span class="op" id="8519503">,</span>&nbsp;<span class="ident" id="8519505">err</span>&nbsp;<span class="op" id="8519509">:=</span>&nbsp;<span class="ident" id="8519512">net</span><span class="op" id="8519515">.</span><span class="ident" id="8519516">Listen</span><span class="op" id="8519522">(</span><span class="string" id="8519523">&#34;tcp&#34;</span><span class="op" id="8519528">,</span>&nbsp;<span class="string" id="8519530">&#34;127.0.0.1:0&#34;</span><span class="op" id="8519543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8519546">if</span>&nbsp;<span class="ident" id="8519549">err</span>&nbsp;<span class="op" id="8519553">!=</span>&nbsp;<span class="ident" id="8519556">nil</span>&nbsp;<span class="op" id="8519560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519564">ln</span><span class="op" id="8519566">,</span>&nbsp;<span class="ident" id="8519568">err</span>&nbsp;<span class="op" id="8519572">=</span>&nbsp;<span class="ident" id="8519574">net</span><span class="op" id="8519577">.</span><span class="ident" id="8519578">Listen</span><span class="op" id="8519584">(</span><span class="string" id="8519585">&#34;tcp6&#34;</span><span class="op" id="8519591">,</span>&nbsp;<span class="string" id="8519593">&#34;[::1]:0&#34;</span><span class="op" id="8519602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8519605">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8519608">if</span>&nbsp;<span class="ident" id="8519611">err</span>&nbsp;<span class="op" id="8519615">!=</span>&nbsp;<span class="ident" id="8519618">nil</span>&nbsp;<span class="op" id="8519622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519626">t</span><span class="op" id="8519627">.</span><span class="ident" id="8519628">Fatal</span><span class="op" id="8519633">(</span><span class="ident" id="8519634">err</span><span class="op" id="8519637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8519640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8519643">return</span>&nbsp;<span class="ident" id="8519650">ln</span><br>
<span class="lineno"></span><span class="op" id="8519653">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="8519656">func</span>&nbsp;<span class="ident" id="8519661">TestDialTimeout</span><span class="op" id="8519676">(</span><span class="ident" id="8519677">t</span>&nbsp;<span class="op" id="8519679">*</span><span class="ident" id="8519680">testing</span><span class="op" id="8519687">.</span><span class="ident" id="8519688">T</span><span class="op" id="8519689">)</span>&nbsp;<span class="op" id="8519691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8519694">if</span>&nbsp;<span class="ident" id="8519697">testing</span><span class="op" id="8519704">.</span><span class="ident" id="8519705">Short</span><span class="op" id="8519710">(</span><span class="op" id="8519711">)</span>&nbsp;<span class="op" id="8519713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519717">t</span><span class="op" id="8519718">.</span><span class="ident" id="8519719">Skip</span><span class="op" id="8519723">(</span><span class="string" id="8519724">&#34;skipping&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="8519748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8519751">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519754">listener</span>&nbsp;<span class="op" id="8519763">:=</span>&nbsp;<span class="ident" id="8519766">newLocalListener</span><span class="op" id="8519782">(</span><span class="ident" id="8519783">t</span><span class="op" id="8519784">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519788">addr</span>&nbsp;<span class="op" id="8519793">:=</span>&nbsp;<span class="ident" id="8519796">listener</span><span class="op" id="8519804">.</span><span class="ident" id="8519805">Addr</span><span class="op" id="8519809">(</span><span class="op" id="8519810">)</span><span class="op" id="8519811">.</span><span class="ident" id="8519812">String</span><span class="op" id="8519818">(</span><span class="op" id="8519819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8519822">defer</span>&nbsp;<span class="ident" id="8519828">listener</span><span class="op" id="8519836">.</span><span class="ident" id="8519837">Close</span><span class="op" id="8519842">(</span><span class="op" id="8519843">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519847">complete</span>&nbsp;<span class="op" id="8519856">:=</span>&nbsp;<span class="builtinfunc" id="8519859">make</span><span class="op" id="8519863">(</span><span class="keyword" id="8519864">chan</span>&nbsp;<span class="builtintype" id="8519869">bool</span><span class="op" id="8519873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8519876">defer</span>&nbsp;<span class="builtinfunc" id="8519882">close</span><span class="op" id="8519887">(</span><span class="ident" id="8519888">complete</span><span class="op" id="8519896">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8519900">go</span>&nbsp;<span class="keyword" id="8519903">func</span><span class="op" id="8519907">(</span><span class="op" id="8519908">)</span>&nbsp;<span class="op" id="8519910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519914">conn</span><span class="op" id="8519918">,</span>&nbsp;<span class="ident" id="8519920">err</span>&nbsp;<span class="op" id="8519924">:=</span>&nbsp;<span class="ident" id="8519927">listener</span><span class="op" id="8519935">.</span><span class="ident" id="8519936">Accept</span><span class="op" id="8519942">(</span><span class="op" id="8519943">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8519947">if</span>&nbsp;<span class="ident" id="8519950">err</span>&nbsp;<span class="op" id="8519954">!=</span>&nbsp;<span class="ident" id="8519957">nil</span>&nbsp;<span class="op" id="8519961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519966">t</span><span class="op" id="8519967">.</span><span class="ident" id="8519968">Error</span><span class="op" id="8519973">(</span><span class="ident" id="8519974">err</span><span class="op" id="8519977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8519982">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8519991">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8519995">&lt;-</span><span class="ident" id="8519997">complete</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520008">conn</span><span class="op" id="8520012">.</span><span class="ident" id="8520013">Close</span><span class="op" id="8520018">(</span><span class="op" id="8520019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8520022">}</span><span class="op" id="8520023">(</span><span class="op" id="8520024">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520028">dialer</span>&nbsp;<span class="op" id="8520035">:=</span>&nbsp;<span class="op" id="8520038">&amp;</span><span class="ident" id="8520039">net</span><span class="op" id="8520042">.</span><span class="ident" id="8520043">Dialer</span><span class="op" id="8520049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520053">Timeout</span><span class="op" id="8520060">:</span>&nbsp;<span class="num" id="8520062">10</span>&nbsp;<span class="op" id="8520065">*</span>&nbsp;<span class="ident" id="8520067">time</span><span class="op" id="8520071">.</span><span class="ident" id="8520072">Millisecond</span><span class="op" id="8520083">,</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8520086">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8520090">var</span>&nbsp;<span class="ident" id="8520094">err</span>&nbsp;<span class="builtintype" id="8520098">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8520105">if</span>&nbsp;<span class="ident" id="8520108">_</span><span class="op" id="8520109">,</span>&nbsp;<span class="ident" id="8520111">err</span>&nbsp;<span class="op" id="8520115">=</span>&nbsp;<span class="ident" id="8520117">DialWithDialer</span><span class="op" id="8520131">(</span><span class="ident" id="8520132">dialer</span><span class="op" id="8520138">,</span>&nbsp;<span class="string" id="8520140">&#34;tcp&#34;</span><span class="op" id="8520145">,</span>&nbsp;<span class="ident" id="8520147">addr</span><span class="op" id="8520151">,</span>&nbsp;<span class="ident" id="8520153">nil</span><span class="op" id="8520156">)</span><span class="op" id="8520157">;</span>&nbsp;<span class="ident" id="8520159">err</span>&nbsp;<span class="op" id="8520163">==</span>&nbsp;<span class="ident" id="8520166">nil</span>&nbsp;<span class="op" id="8520170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520174">t</span><span class="op" id="8520175">.</span><span class="ident" id="8520176">Fatal</span><span class="op" id="8520181">(</span><span class="string" id="8520182">&#34;DialWithTimeout&nbsp;completed&nbsp;successfully&#34;</span><span class="op" id="8520222">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8520225">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8520229">if</span>&nbsp;<span class="op" id="8520232">!</span><span class="ident" id="8520233">strings</span><span class="op" id="8520240">.</span><span class="ident" id="8520241">Contains</span><span class="op" id="8520249">(</span><span class="ident" id="8520250">err</span><span class="op" id="8520253">.</span><span class="ident" id="8520254">Error</span><span class="op" id="8520259">(</span><span class="op" id="8520260">)</span><span class="op" id="8520261">,</span>&nbsp;<span class="string" id="8520263">&#34;timed&nbsp;out&#34;</span><span class="op" id="8520274">)</span>&nbsp;<span class="op" id="8520276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520280">t</span><span class="op" id="8520281">.</span><span class="ident" id="8520282">Errorf</span><span class="op" id="8520288">(</span><span class="string" id="8520289">&#34;resulting&nbsp;error&nbsp;not&nbsp;a&nbsp;timeout:&nbsp;%s&#34;</span><span class="op" id="8520324">,</span>&nbsp;<span class="ident" id="8520326">err</span><span class="op" id="8520329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8520332">}</span><br>
<span class="lineno">160</span><span class="op" id="8520334">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8520337">//&nbsp;tests&nbsp;that&nbsp;Conn.Read&nbsp;returns&nbsp;(non-zero,&nbsp;io.EOF)&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="8520399">//&nbsp;(non-zero,&nbsp;nil)&nbsp;when&nbsp;a&nbsp;Close&nbsp;(alertCloseNotify)&nbsp;is&nbsp;sitting&nbsp;right</span><br>
<span class="lineno"></span><span class="comment" id="8520467">//&nbsp;behind&nbsp;the&nbsp;application&nbsp;data&nbsp;in&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno">165</span><span class="keyword" id="8520513">func</span>&nbsp;<span class="ident" id="8520518">TestConnReadNonzeroAndEOF</span><span class="op" id="8520543">(</span><span class="ident" id="8520544">t</span>&nbsp;<span class="op" id="8520546">*</span><span class="ident" id="8520547">testing</span><span class="op" id="8520554">.</span><span class="ident" id="8520555">T</span><span class="op" id="8520556">)</span>&nbsp;<span class="op" id="8520558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8520561">//&nbsp;This&nbsp;test&nbsp;is&nbsp;racy:&nbsp;it&nbsp;assumes&nbsp;that&nbsp;after&nbsp;a&nbsp;write&nbsp;to&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8520619">//&nbsp;localhost&nbsp;TCP&nbsp;connection,&nbsp;the&nbsp;peer&nbsp;TCP&nbsp;connection&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8520677">//&nbsp;immediately&nbsp;read&nbsp;it.&nbsp;&nbsp;Because&nbsp;it&#39;s&nbsp;racy,&nbsp;we&nbsp;skip&nbsp;this&nbsp;test</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8520740">//&nbsp;in&nbsp;short&nbsp;mode,&nbsp;and&nbsp;then&nbsp;retry&nbsp;it&nbsp;several&nbsp;times&nbsp;with&nbsp;an</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8520799">//&nbsp;increasing&nbsp;sleep&nbsp;in&nbsp;between&nbsp;our&nbsp;final&nbsp;write&nbsp;(via&nbsp;srv.Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8520862">//&nbsp;below)&nbsp;and&nbsp;the&nbsp;following&nbsp;read.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8520897">if</span>&nbsp;<span class="ident" id="8520900">testing</span><span class="op" id="8520907">.</span><span class="ident" id="8520908">Short</span><span class="op" id="8520913">(</span><span class="op" id="8520914">)</span>&nbsp;<span class="op" id="8520916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520920">t</span><span class="op" id="8520921">.</span><span class="ident" id="8520922">Skip</span><span class="op" id="8520926">(</span><span class="string" id="8520927">&#34;skipping&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="8520951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8520954">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8520957">var</span>&nbsp;<span class="ident" id="8520961">err</span>&nbsp;<span class="builtintype" id="8520965">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8520972">for</span>&nbsp;<span class="ident" id="8520976">delay</span>&nbsp;<span class="op" id="8520982">:=</span>&nbsp;<span class="ident" id="8520985">time</span><span class="op" id="8520989">.</span><span class="ident" id="8520990">Millisecond</span><span class="op" id="8521001">;</span>&nbsp;<span class="ident" id="8521003">delay</span>&nbsp;<span class="op" id="8521009">&lt;=</span>&nbsp;<span class="num" id="8521012">64</span><span class="op" id="8521014">*</span><span class="ident" id="8521015">time</span><span class="op" id="8521019">.</span><span class="ident" id="8521020">Millisecond</span><span class="op" id="8521031">;</span>&nbsp;<span class="ident" id="8521033">delay</span>&nbsp;<span class="op" id="8521039">*=</span>&nbsp;<span class="num" id="8521042">2</span>&nbsp;<span class="op" id="8521044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8521048">if</span>&nbsp;<span class="ident" id="8521051">err</span>&nbsp;<span class="op" id="8521055">=</span>&nbsp;<span class="ident" id="8521057">testConnReadNonzeroAndEOF</span><span class="op" id="8521082">(</span><span class="ident" id="8521083">t</span><span class="op" id="8521084">,</span>&nbsp;<span class="ident" id="8521086">delay</span><span class="op" id="8521091">)</span><span class="op" id="8521092">;</span>&nbsp;<span class="ident" id="8521094">err</span>&nbsp;<span class="op" id="8521098">==</span>&nbsp;<span class="ident" id="8521101">nil</span>&nbsp;<span class="op" id="8521105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8521110">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8521119">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8521122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521125">t</span><span class="op" id="8521126">.</span><span class="ident" id="8521127">Error</span><span class="op" id="8521132">(</span><span class="ident" id="8521133">err</span><span class="op" id="8521136">)</span><br>
<span class="lineno"></span><span class="op" id="8521138">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8521141">func</span>&nbsp;<span class="ident" id="8521146">testConnReadNonzeroAndEOF</span><span class="op" id="8521171">(</span><span class="ident" id="8521172">t</span>&nbsp;<span class="op" id="8521174">*</span><span class="ident" id="8521175">testing</span><span class="op" id="8521182">.</span><span class="ident" id="8521183">T</span><span class="op" id="8521184">,</span>&nbsp;<span class="ident" id="8521186">delay</span>&nbsp;<span class="ident" id="8521192">time</span><span class="op" id="8521196">.</span><span class="ident" id="8521197">Duration</span><span class="op" id="8521205">)</span>&nbsp;<span class="builtintype" id="8521207">error</span>&nbsp;<span class="op" id="8521213">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521216">ln</span>&nbsp;<span class="op" id="8521219">:=</span>&nbsp;<span class="ident" id="8521222">newLocalListener</span><span class="op" id="8521238">(</span><span class="ident" id="8521239">t</span><span class="op" id="8521240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8521243">defer</span>&nbsp;<span class="ident" id="8521249">ln</span><span class="op" id="8521251">.</span><span class="ident" id="8521252">Close</span><span class="op" id="8521257">(</span><span class="op" id="8521258">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521262">srvCh</span>&nbsp;<span class="op" id="8521268">:=</span>&nbsp;<span class="builtinfunc" id="8521271">make</span><span class="op" id="8521275">(</span><span class="keyword" id="8521276">chan</span>&nbsp;<span class="op" id="8521281">*</span><span class="ident" id="8521282">Conn</span><span class="op" id="8521286">,</span>&nbsp;<span class="num" id="8521288">1</span><span class="op" id="8521289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8521292">var</span>&nbsp;<span class="ident" id="8521296">serr</span>&nbsp;<span class="builtintype" id="8521301">error</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8521308">go</span>&nbsp;<span class="keyword" id="8521311">func</span><span class="op" id="8521315">(</span><span class="op" id="8521316">)</span>&nbsp;<span class="op" id="8521318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521322">sconn</span><span class="op" id="8521327">,</span>&nbsp;<span class="ident" id="8521329">err</span>&nbsp;<span class="op" id="8521333">:=</span>&nbsp;<span class="ident" id="8521336">ln</span><span class="op" id="8521338">.</span><span class="ident" id="8521339">Accept</span><span class="op" id="8521345">(</span><span class="op" id="8521346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8521350">if</span>&nbsp;<span class="ident" id="8521353">err</span>&nbsp;<span class="op" id="8521357">!=</span>&nbsp;<span class="ident" id="8521360">nil</span>&nbsp;<span class="op" id="8521364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521369">serr</span>&nbsp;<span class="op" id="8521374">=</span>&nbsp;<span class="ident" id="8521376">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521383">srvCh</span>&nbsp;<span class="op" id="8521389">&lt;-</span>&nbsp;<span class="ident" id="8521392">nil</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8521399">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8521408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521412">serverConfig</span>&nbsp;<span class="op" id="8521425">:=</span>&nbsp;<span class="op" id="8521428">*</span><span class="ident" id="8521429">testConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521442">srv</span>&nbsp;<span class="op" id="8521446">:=</span>&nbsp;<span class="ident" id="8521449">Server</span><span class="op" id="8521455">(</span><span class="ident" id="8521456">sconn</span><span class="op" id="8521461">,</span>&nbsp;<span class="op" id="8521463">&amp;</span><span class="ident" id="8521464">serverConfig</span><span class="op" id="8521476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8521480">if</span>&nbsp;<span class="ident" id="8521483">err</span>&nbsp;<span class="op" id="8521487">:=</span>&nbsp;<span class="ident" id="8521490">srv</span><span class="op" id="8521493">.</span><span class="ident" id="8521494">Handshake</span><span class="op" id="8521503">(</span><span class="op" id="8521504">)</span><span class="op" id="8521505">;</span>&nbsp;<span class="ident" id="8521507">err</span>&nbsp;<span class="op" id="8521511">!=</span>&nbsp;<span class="ident" id="8521514">nil</span>&nbsp;<span class="op" id="8521518">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521523">serr</span>&nbsp;<span class="op" id="8521528">=</span>&nbsp;<span class="ident" id="8521530">fmt</span><span class="op" id="8521533">.</span><span class="ident" id="8521534">Errorf</span><span class="op" id="8521540">(</span><span class="string" id="8521541">&#34;handshake:&nbsp;%v&#34;</span><span class="op" id="8521556">,</span>&nbsp;<span class="ident" id="8521558">err</span><span class="op" id="8521561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521566">srvCh</span>&nbsp;<span class="op" id="8521572">&lt;-</span>&nbsp;<span class="ident" id="8521575">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8521582">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8521591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521595">srvCh</span>&nbsp;<span class="op" id="8521601">&lt;-</span>&nbsp;<span class="ident" id="8521604">srv</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8521609">}</span><span class="op" id="8521610">(</span><span class="op" id="8521611">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521615">clientConfig</span>&nbsp;<span class="op" id="8521628">:=</span>&nbsp;<span class="op" id="8521631">*</span><span class="ident" id="8521632">testConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521644">conn</span><span class="op" id="8521648">,</span>&nbsp;<span class="ident" id="8521650">err</span>&nbsp;<span class="op" id="8521654">:=</span>&nbsp;<span class="ident" id="8521657">Dial</span><span class="op" id="8521661">(</span><span class="string" id="8521662">&#34;tcp&#34;</span><span class="op" id="8521667">,</span>&nbsp;<span class="ident" id="8521669">ln</span><span class="op" id="8521671">.</span><span class="ident" id="8521672">Addr</span><span class="op" id="8521676">(</span><span class="op" id="8521677">)</span><span class="op" id="8521678">.</span><span class="ident" id="8521679">String</span><span class="op" id="8521685">(</span><span class="op" id="8521686">)</span><span class="op" id="8521687">,</span>&nbsp;<span class="op" id="8521689">&amp;</span><span class="ident" id="8521690">clientConfig</span><span class="op" id="8521702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8521705">if</span>&nbsp;<span class="ident" id="8521708">err</span>&nbsp;<span class="op" id="8521712">!=</span>&nbsp;<span class="ident" id="8521715">nil</span>&nbsp;<span class="op" id="8521719">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521723">t</span><span class="op" id="8521724">.</span><span class="ident" id="8521725">Fatal</span><span class="op" id="8521730">(</span><span class="ident" id="8521731">err</span><span class="op" id="8521734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8521737">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8521740">defer</span>&nbsp;<span class="ident" id="8521746">conn</span><span class="op" id="8521750">.</span><span class="ident" id="8521751">Close</span><span class="op" id="8521756">(</span><span class="op" id="8521757">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521761">srv</span>&nbsp;<span class="op" id="8521765">:=</span>&nbsp;<span class="op" id="8521768">&lt;-</span><span class="ident" id="8521770">srvCh</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8521777">if</span>&nbsp;<span class="ident" id="8521780">srv</span>&nbsp;<span class="op" id="8521784">==</span>&nbsp;<span class="ident" id="8521787">nil</span>&nbsp;<span class="op" id="8521791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8521795">return</span>&nbsp;<span class="ident" id="8521802">serr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8521808">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521812">buf</span>&nbsp;<span class="op" id="8521816">:=</span>&nbsp;<span class="builtinfunc" id="8521819">make</span><span class="op" id="8521823">(</span><span class="op" id="8521824">[</span><span class="op" id="8521825">]</span><span class="builtintype" id="8521826">byte</span><span class="op" id="8521830">,</span>&nbsp;<span class="num" id="8521832">6</span><span class="op" id="8521833">)</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521837">srv</span><span class="op" id="8521840">.</span><span class="ident" id="8521841">Write</span><span class="op" id="8521846">(</span><span class="op" id="8521847">[</span><span class="op" id="8521848">]</span><span class="builtintype" id="8521849">byte</span><span class="op" id="8521853">(</span><span class="string" id="8521854">&#34;foobar&#34;</span><span class="op" id="8521862">)</span><span class="op" id="8521863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521866">n</span><span class="op" id="8521867">,</span>&nbsp;<span class="ident" id="8521869">err</span>&nbsp;<span class="op" id="8521873">:=</span>&nbsp;<span class="ident" id="8521876">conn</span><span class="op" id="8521880">.</span><span class="ident" id="8521881">Read</span><span class="op" id="8521885">(</span><span class="ident" id="8521886">buf</span><span class="op" id="8521889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8521892">if</span>&nbsp;<span class="ident" id="8521895">n</span>&nbsp;<span class="op" id="8521897">!=</span>&nbsp;<span class="num" id="8521900">6</span>&nbsp;<span class="op" id="8521902">||</span>&nbsp;<span class="ident" id="8521905">err</span>&nbsp;<span class="op" id="8521909">!=</span>&nbsp;<span class="ident" id="8521912">nil</span>&nbsp;<span class="op" id="8521916">||</span>&nbsp;<span class="builtintype" id="8521919">string</span><span class="op" id="8521925">(</span><span class="ident" id="8521926">buf</span><span class="op" id="8521929">)</span>&nbsp;<span class="op" id="8521931">!=</span>&nbsp;<span class="string" id="8521934">&#34;foobar&#34;</span>&nbsp;<span class="op" id="8521943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8521947">return</span>&nbsp;<span class="ident" id="8521954">fmt</span><span class="op" id="8521957">.</span><span class="ident" id="8521958">Errorf</span><span class="op" id="8521964">(</span><span class="string" id="8521965">&#34;Read&nbsp;=&nbsp;%d,&nbsp;%v,&nbsp;data&nbsp;%q;&nbsp;want&nbsp;6,&nbsp;nil,&nbsp;foobar&#34;</span><span class="op" id="8522010">,</span>&nbsp;<span class="ident" id="8522012">n</span><span class="op" id="8522013">,</span>&nbsp;<span class="ident" id="8522015">err</span><span class="op" id="8522018">,</span>&nbsp;<span class="ident" id="8522020">buf</span><span class="op" id="8522023">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8522026">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8522030">srv</span><span class="op" id="8522033">.</span><span class="ident" id="8522034">Write</span><span class="op" id="8522039">(</span><span class="op" id="8522040">[</span><span class="op" id="8522041">]</span><span class="builtintype" id="8522042">byte</span><span class="op" id="8522046">(</span><span class="string" id="8522047">&#34;abcdef&#34;</span><span class="op" id="8522055">)</span><span class="op" id="8522056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8522059">srv</span><span class="op" id="8522062">.</span><span class="ident" id="8522063">Close</span><span class="op" id="8522068">(</span><span class="op" id="8522069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8522072">time</span><span class="op" id="8522076">.</span><span class="ident" id="8522077">Sleep</span><span class="op" id="8522082">(</span><span class="ident" id="8522083">delay</span><span class="op" id="8522088">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8522091">n</span><span class="op" id="8522092">,</span>&nbsp;<span class="ident" id="8522094">err</span>&nbsp;<span class="op" id="8522098">=</span>&nbsp;<span class="ident" id="8522100">conn</span><span class="op" id="8522104">.</span><span class="ident" id="8522105">Read</span><span class="op" id="8522109">(</span><span class="ident" id="8522110">buf</span><span class="op" id="8522113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8522116">if</span>&nbsp;<span class="ident" id="8522119">n</span>&nbsp;<span class="op" id="8522121">!=</span>&nbsp;<span class="num" id="8522124">6</span>&nbsp;<span class="op" id="8522126">||</span>&nbsp;<span class="builtintype" id="8522129">string</span><span class="op" id="8522135">(</span><span class="ident" id="8522136">buf</span><span class="op" id="8522139">)</span>&nbsp;<span class="op" id="8522141">!=</span>&nbsp;<span class="string" id="8522144">&#34;abcdef&#34;</span>&nbsp;<span class="op" id="8522153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8522157">return</span>&nbsp;<span class="ident" id="8522164">fmt</span><span class="op" id="8522167">.</span><span class="ident" id="8522168">Errorf</span><span class="op" id="8522174">(</span><span class="string" id="8522175">&#34;Read&nbsp;=&nbsp;%d,&nbsp;buf=&nbsp;%q;&nbsp;want&nbsp;6,&nbsp;abcdef&#34;</span><span class="op" id="8522211">,</span>&nbsp;<span class="ident" id="8522213">n</span><span class="op" id="8522214">,</span>&nbsp;<span class="ident" id="8522216">buf</span><span class="op" id="8522219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8522222">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8522225">if</span>&nbsp;<span class="ident" id="8522228">err</span>&nbsp;<span class="op" id="8522232">!=</span>&nbsp;<span class="ident" id="8522235">io</span><span class="op" id="8522237">.</span><span class="ident" id="8522238">EOF</span>&nbsp;<span class="op" id="8522242">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8522246">return</span>&nbsp;<span class="ident" id="8522253">fmt</span><span class="op" id="8522256">.</span><span class="ident" id="8522257">Errorf</span><span class="op" id="8522263">(</span><span class="string" id="8522264">&#34;Second&nbsp;Read&nbsp;error&nbsp;=&nbsp;%v;&nbsp;want&nbsp;io.EOF&#34;</span><span class="op" id="8522301">,</span>&nbsp;<span class="ident" id="8522303">err</span><span class="op" id="8522306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8522309">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8522312">return</span>&nbsp;<span class="ident" id="8522319">nil</span><br>
<span class="lineno"></span><span class="op" id="8522323">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span><span class="keyword" id="8522326">func</span>&nbsp;<span class="ident" id="8522331">TestTLSUniqueMatches</span><span class="op" id="8522351">(</span><span class="ident" id="8522352">t</span>&nbsp;<span class="op" id="8522354">*</span><span class="ident" id="8522355">testing</span><span class="op" id="8522362">.</span><span class="ident" id="8522363">T</span><span class="op" id="8522364">)</span>&nbsp;<span class="op" id="8522366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8522369">ln</span>&nbsp;<span class="op" id="8522372">:=</span>&nbsp;<span class="ident" id="8522375">newLocalListener</span><span class="op" id="8522391">(</span><span class="ident" id="8522392">t</span><span class="op" id="8522393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8522396">defer</span>&nbsp;<span class="ident" id="8522402">ln</span><span class="op" id="8522404">.</span><span class="ident" id="8522405">Close</span><span class="op" id="8522410">(</span><span class="op" id="8522411">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8522415">serverTLSUniques</span>&nbsp;<span class="op" id="8522432">:=</span>&nbsp;<span class="builtinfunc" id="8522435">make</span><span class="op" id="8522439">(</span><span class="keyword" id="8522440">chan</span>&nbsp;<span class="op" id="8522445">[</span><span class="op" id="8522446">]</span><span class="builtintype" id="8522447">byte</span><span class="op" id="8522451">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8522454">go</span>&nbsp;<span class="keyword" id="8522457">func</span><span class="op" id="8522461">(</span><span class="op" id="8522462">)</span>&nbsp;<span class="op" id="8522464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8522468">for</span>&nbsp;<span class="ident" id="8522472">i</span>&nbsp;<span class="op" id="8522474">:=</span>&nbsp;<span class="num" id="8522477">0</span><span class="op" id="8522478">;</span>&nbsp;<span class="ident" id="8522480">i</span>&nbsp;<span class="op" id="8522482">&lt;</span>&nbsp;<span class="num" id="8522484">2</span><span class="op" id="8522485">;</span>&nbsp;<span class="ident" id="8522487">i</span><span class="op" id="8522488">++</span>&nbsp;<span class="op" id="8522491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8522496">sconn</span><span class="op" id="8522501">,</span>&nbsp;<span class="ident" id="8522503">err</span>&nbsp;<span class="op" id="8522507">:=</span>&nbsp;<span class="ident" id="8522510">ln</span><span class="op" id="8522512">.</span><span class="ident" id="8522513">Accept</span><span class="op" id="8522519">(</span><span class="op" id="8522520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8522525">if</span>&nbsp;<span class="ident" id="8522528">err</span>&nbsp;<span class="op" id="8522532">!=</span>&nbsp;<span class="ident" id="8522535">nil</span>&nbsp;<span class="op" id="8522539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8522545">t</span><span class="op" id="8522546">.</span><span class="ident" id="8522547">Fatal</span><span class="op" id="8522552">(</span><span class="ident" id="8522553">err</span><span class="op" id="8522556">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8522561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8522566">serverConfig</span>&nbsp;<span class="op" id="8522579">:=</span>&nbsp;<span class="op" id="8522582">*</span><span class="ident" id="8522583">testConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8522597">srv</span>&nbsp;<span class="op" id="8522601">:=</span>&nbsp;<span class="ident" id="8522604">Server</span><span class="op" id="8522610">(</span><span class="ident" id="8522611">sconn</span><span class="op" id="8522616">,</span>&nbsp;<span class="op" id="8522618">&amp;</span><span class="ident" id="8522619">serverConfig</span><span class="op" id="8522631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8522636">if</span>&nbsp;<span class="ident" id="8522639">err</span>&nbsp;<span class="op" id="8522643">:=</span>&nbsp;<span class="ident" id="8522646">srv</span><span class="op" id="8522649">.</span><span class="ident" id="8522650">Handshake</span><span class="op" id="8522659">(</span><span class="op" id="8522660">)</span><span class="op" id="8522661">;</span>&nbsp;<span class="ident" id="8522663">err</span>&nbsp;<span class="op" id="8522667">!=</span>&nbsp;<span class="ident" id="8522670">nil</span>&nbsp;<span class="op" id="8522674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8522680">t</span><span class="op" id="8522681">.</span><span class="ident" id="8522682">Fatal</span><span class="op" id="8522687">(</span><span class="ident" id="8522688">err</span><span class="op" id="8522691">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8522696">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8522701">serverTLSUniques</span>&nbsp;<span class="op" id="8522718">&lt;-</span>&nbsp;<span class="ident" id="8522721">srv</span><span class="op" id="8522724">.</span><span class="ident" id="8522725">ConnectionState</span><span class="op" id="8522740">(</span><span class="op" id="8522741">)</span><span class="op" id="8522742">.</span><span class="ident" id="8522743">TLSUnique</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8522755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8522758">}</span><span class="op" id="8522759">(</span><span class="op" id="8522760">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8522764">clientConfig</span>&nbsp;<span class="op" id="8522777">:=</span>&nbsp;<span class="op" id="8522780">*</span><span class="ident" id="8522781">testConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8522793">clientConfig</span><span class="op" id="8522805">.</span><span class="ident" id="8522806">ClientSessionCache</span>&nbsp;<span class="op" id="8522825">=</span>&nbsp;<span class="ident" id="8522827">NewLRUClientSessionCache</span><span class="op" id="8522851">(</span><span class="num" id="8522852">1</span><span class="op" id="8522853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8522856">conn</span><span class="op" id="8522860">,</span>&nbsp;<span class="ident" id="8522862">err</span>&nbsp;<span class="op" id="8522866">:=</span>&nbsp;<span class="ident" id="8522869">Dial</span><span class="op" id="8522873">(</span><span class="string" id="8522874">&#34;tcp&#34;</span><span class="op" id="8522879">,</span>&nbsp;<span class="ident" id="8522881">ln</span><span class="op" id="8522883">.</span><span class="ident" id="8522884">Addr</span><span class="op" id="8522888">(</span><span class="op" id="8522889">)</span><span class="op" id="8522890">.</span><span class="ident" id="8522891">String</span><span class="op" id="8522897">(</span><span class="op" id="8522898">)</span><span class="op" id="8522899">,</span>&nbsp;<span class="op" id="8522901">&amp;</span><span class="ident" id="8522902">clientConfig</span><span class="op" id="8522914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8522917">if</span>&nbsp;<span class="ident" id="8522920">err</span>&nbsp;<span class="op" id="8522924">!=</span>&nbsp;<span class="ident" id="8522927">nil</span>&nbsp;<span class="op" id="8522931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8522935">t</span><span class="op" id="8522936">.</span><span class="ident" id="8522937">Fatal</span><span class="op" id="8522942">(</span><span class="ident" id="8522943">err</span><span class="op" id="8522946">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8522949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8522952">if</span>&nbsp;<span class="op" id="8522955">!</span><span class="ident" id="8522956">bytes</span><span class="op" id="8522961">.</span><span class="ident" id="8522962">Equal</span><span class="op" id="8522967">(</span><span class="ident" id="8522968">conn</span><span class="op" id="8522972">.</span><span class="ident" id="8522973">ConnectionState</span><span class="op" id="8522988">(</span><span class="op" id="8522989">)</span><span class="op" id="8522990">.</span><span class="ident" id="8522991">TLSUnique</span><span class="op" id="8523000">,</span>&nbsp;<span class="op" id="8523002">&lt;-</span><span class="ident" id="8523004">serverTLSUniques</span><span class="op" id="8523020">)</span>&nbsp;<span class="op" id="8523022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8523026">t</span><span class="op" id="8523027">.</span><span class="ident" id="8523028">Error</span><span class="op" id="8523033">(</span><span class="string" id="8523034">&#34;client&nbsp;and&nbsp;server&nbsp;channel&nbsp;bindings&nbsp;differ&#34;</span><span class="op" id="8523077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8523080">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8523083">conn</span><span class="op" id="8523087">.</span><span class="ident" id="8523088">Close</span><span class="op" id="8523093">(</span><span class="op" id="8523094">)</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8523098">conn</span><span class="op" id="8523102">,</span>&nbsp;<span class="ident" id="8523104">err</span>&nbsp;<span class="op" id="8523108">=</span>&nbsp;<span class="ident" id="8523110">Dial</span><span class="op" id="8523114">(</span><span class="string" id="8523115">&#34;tcp&#34;</span><span class="op" id="8523120">,</span>&nbsp;<span class="ident" id="8523122">ln</span><span class="op" id="8523124">.</span><span class="ident" id="8523125">Addr</span><span class="op" id="8523129">(</span><span class="op" id="8523130">)</span><span class="op" id="8523131">.</span><span class="ident" id="8523132">String</span><span class="op" id="8523138">(</span><span class="op" id="8523139">)</span><span class="op" id="8523140">,</span>&nbsp;<span class="op" id="8523142">&amp;</span><span class="ident" id="8523143">clientConfig</span><span class="op" id="8523155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8523158">if</span>&nbsp;<span class="ident" id="8523161">err</span>&nbsp;<span class="op" id="8523165">!=</span>&nbsp;<span class="ident" id="8523168">nil</span>&nbsp;<span class="op" id="8523172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8523176">t</span><span class="op" id="8523177">.</span><span class="ident" id="8523178">Fatal</span><span class="op" id="8523183">(</span><span class="ident" id="8523184">err</span><span class="op" id="8523187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8523190">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8523193">defer</span>&nbsp;<span class="ident" id="8523199">conn</span><span class="op" id="8523203">.</span><span class="ident" id="8523204">Close</span><span class="op" id="8523209">(</span><span class="op" id="8523210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8523213">if</span>&nbsp;<span class="op" id="8523216">!</span><span class="ident" id="8523217">conn</span><span class="op" id="8523221">.</span><span class="ident" id="8523222">ConnectionState</span><span class="op" id="8523237">(</span><span class="op" id="8523238">)</span><span class="op" id="8523239">.</span><span class="ident" id="8523240">DidResume</span>&nbsp;<span class="op" id="8523250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8523254">t</span><span class="op" id="8523255">.</span><span class="ident" id="8523256">Error</span><span class="op" id="8523261">(</span><span class="string" id="8523262">&#34;second&nbsp;session&nbsp;did&nbsp;not&nbsp;use&nbsp;resumption&#34;</span><span class="op" id="8523301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8523304">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8523307">if</span>&nbsp;<span class="op" id="8523310">!</span><span class="ident" id="8523311">bytes</span><span class="op" id="8523316">.</span><span class="ident" id="8523317">Equal</span><span class="op" id="8523322">(</span><span class="ident" id="8523323">conn</span><span class="op" id="8523327">.</span><span class="ident" id="8523328">ConnectionState</span><span class="op" id="8523343">(</span><span class="op" id="8523344">)</span><span class="op" id="8523345">.</span><span class="ident" id="8523346">TLSUnique</span><span class="op" id="8523355">,</span>&nbsp;<span class="op" id="8523357">&lt;-</span><span class="ident" id="8523359">serverTLSUniques</span><span class="op" id="8523375">)</span>&nbsp;<span class="op" id="8523377">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8523381">t</span><span class="op" id="8523382">.</span><span class="ident" id="8523383">Error</span><span class="op" id="8523388">(</span><span class="string" id="8523389">&#34;client&nbsp;and&nbsp;server&nbsp;channel&nbsp;bindings&nbsp;differ&nbsp;when&nbsp;session&nbsp;resumption&nbsp;is&nbsp;used&#34;</span><span class="op" id="8523464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8523467">}</span><br>
<span class="lineno"></span><span class="op" id="8523469">}</span>
</div>
</body>
</html>
