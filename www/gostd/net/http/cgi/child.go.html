<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/cgi</h2>
<ul>
<li><a href="/gostd/net/http/cgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/cgi/child_test.go.html">child_test.go</a></li>
<li><a href="/gostd/net/http/cgi/host.go.html">host.go</a></li>
<li><a href="/gostd/net/http/cgi/host_test.go.html">host_test.go</a></li>
<li><a href="/gostd/net/http/cgi/matryoshka_test.go.html">matryoshka_test.go</a></li>
<li><a href="/gostd/net/http/cgi/posix_test.go.html">posix_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5194514">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5194569">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5194623">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5194674">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;CGI&nbsp;from&nbsp;the&nbsp;perspective&nbsp;of&nbsp;a&nbsp;child</span><br>
<span class="lineno"></span><span class="comment" id="5194734">//&nbsp;process.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5194747">package</span>&nbsp;<span class="ident" id="5194755">cgi</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="5194760">import</span>&nbsp;<span class="op" id="5194767">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5194770">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5194779">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5194793">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5194803">&#34;fmt&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5194810">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5194816">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5194829">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5194836">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5194848">&#34;net/url&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5194859">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5194865">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5194876">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="5194886">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="5194889">//&nbsp;Request&nbsp;returns&nbsp;the&nbsp;HTTP&nbsp;request&nbsp;as&nbsp;represented&nbsp;in&nbsp;the&nbsp;current</span><br>
<span class="lineno"></span><span class="comment" id="5194955">//&nbsp;environment.&nbsp;This&nbsp;assumes&nbsp;the&nbsp;current&nbsp;program&nbsp;is&nbsp;being&nbsp;run</span><br>
<span class="lineno"></span><span class="comment" id="5195017">//&nbsp;by&nbsp;a&nbsp;web&nbsp;server&nbsp;in&nbsp;a&nbsp;CGI&nbsp;environment.</span><br>
<span class="lineno"></span><span class="comment" id="5195058">//&nbsp;The&nbsp;returned&nbsp;Request&#39;s&nbsp;Body&nbsp;is&nbsp;populated,&nbsp;if&nbsp;applicable.</span><br>
<span class="lineno"></span><span class="keyword" id="5195118">func</span>&nbsp;<span class="ident" id="5195123">Request</span><span class="op" id="5195130">(</span><span class="op" id="5195131">)</span>&nbsp;<span class="op" id="5195133">(</span><span class="op" id="5195134">*</span><span class="ident" id="5195135">http</span><span class="op" id="5195139">.</span><span class="ident" id="5195140">Request</span><span class="op" id="5195147">,</span>&nbsp;<span class="builtintype" id="5195149">error</span><span class="op" id="5195154">)</span>&nbsp;<span class="op" id="5195156">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5195159">r</span><span class="op" id="5195160">,</span>&nbsp;<span class="ident" id="5195162">err</span>&nbsp;<span class="op" id="5195166">:=</span>&nbsp;<span class="ident" id="5195169">RequestFromMap</span><span class="op" id="5195183">(</span><span class="ident" id="5195184">envMap</span><span class="op" id="5195190">(</span><span class="ident" id="5195191">os</span><span class="op" id="5195193">.</span><span class="ident" id="5195194">Environ</span><span class="op" id="5195201">(</span><span class="op" id="5195202">)</span><span class="op" id="5195203">)</span><span class="op" id="5195204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5195207">if</span>&nbsp;<span class="ident" id="5195210">err</span>&nbsp;<span class="op" id="5195214">!=</span>&nbsp;<span class="ident" id="5195217">nil</span>&nbsp;<span class="op" id="5195221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5195225">return</span>&nbsp;<span class="ident" id="5195232">nil</span><span class="op" id="5195235">,</span>&nbsp;<span class="ident" id="5195237">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5195242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5195245">if</span>&nbsp;<span class="ident" id="5195248">r</span><span class="op" id="5195249">.</span><span class="ident" id="5195250">ContentLength</span>&nbsp;<span class="op" id="5195264">&gt;</span>&nbsp;<span class="num" id="5195266">0</span>&nbsp;<span class="op" id="5195268">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5195272">r</span><span class="op" id="5195273">.</span><span class="ident" id="5195274">Body</span>&nbsp;<span class="op" id="5195279">=</span>&nbsp;<span class="ident" id="5195281">ioutil</span><span class="op" id="5195287">.</span><span class="ident" id="5195288">NopCloser</span><span class="op" id="5195297">(</span><span class="ident" id="5195298">io</span><span class="op" id="5195300">.</span><span class="ident" id="5195301">LimitReader</span><span class="op" id="5195312">(</span><span class="ident" id="5195313">os</span><span class="op" id="5195315">.</span><span class="ident" id="5195316">Stdin</span><span class="op" id="5195321">,</span>&nbsp;<span class="ident" id="5195323">r</span><span class="op" id="5195324">.</span><span class="ident" id="5195325">ContentLength</span><span class="op" id="5195338">)</span><span class="op" id="5195339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5195342">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5195345">return</span>&nbsp;<span class="ident" id="5195352">r</span><span class="op" id="5195353">,</span>&nbsp;<span class="ident" id="5195355">nil</span><br>
<span class="lineno"></span><span class="op" id="5195359">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="5195362">func</span>&nbsp;<span class="ident" id="5195367">envMap</span><span class="op" id="5195373">(</span><span class="ident" id="5195374">env</span>&nbsp;<span class="op" id="5195378">[</span><span class="op" id="5195379">]</span><span class="builtintype" id="5195380">string</span><span class="op" id="5195386">)</span>&nbsp;<span class="keyword" id="5195388">map</span><span class="op" id="5195391">[</span><span class="builtintype" id="5195392">string</span><span class="op" id="5195398">]</span><span class="builtintype" id="5195399">string</span>&nbsp;<span class="op" id="5195406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5195409">m</span>&nbsp;<span class="op" id="5195411">:=</span>&nbsp;<span class="builtinfunc" id="5195414">make</span><span class="op" id="5195418">(</span><span class="keyword" id="5195419">map</span><span class="op" id="5195422">[</span><span class="builtintype" id="5195423">string</span><span class="op" id="5195429">]</span><span class="builtintype" id="5195430">string</span><span class="op" id="5195436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5195439">for</span>&nbsp;<span class="ident" id="5195443">_</span><span class="op" id="5195444">,</span>&nbsp;<span class="ident" id="5195446">kv</span>&nbsp;<span class="op" id="5195449">:=</span>&nbsp;<span class="keyword" id="5195452">range</span>&nbsp;<span class="ident" id="5195458">env</span>&nbsp;<span class="op" id="5195462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5195466">if</span>&nbsp;<span class="ident" id="5195469">idx</span>&nbsp;<span class="op" id="5195473">:=</span>&nbsp;<span class="ident" id="5195476">strings</span><span class="op" id="5195483">.</span><span class="ident" id="5195484">Index</span><span class="op" id="5195489">(</span><span class="ident" id="5195490">kv</span><span class="op" id="5195492">,</span>&nbsp;<span class="string" id="5195494">&#34;=&#34;</span><span class="op" id="5195497">)</span><span class="op" id="5195498">;</span>&nbsp;<span class="ident" id="5195500">idx</span>&nbsp;<span class="op" id="5195504">!=</span>&nbsp;<span class="op" id="5195507">-</span><span class="num" id="5195508">1</span>&nbsp;<span class="op" id="5195510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5195515">m</span><span class="op" id="5195516">[</span><span class="ident" id="5195517">kv</span><span class="op" id="5195519">[</span><span class="op" id="5195520">:</span><span class="ident" id="5195521">idx</span><span class="op" id="5195524">]</span><span class="op" id="5195525">]</span>&nbsp;<span class="op" id="5195527">=</span>&nbsp;<span class="ident" id="5195529">kv</span><span class="op" id="5195531">[</span><span class="ident" id="5195532">idx</span><span class="op" id="5195535">+</span><span class="num" id="5195536">1</span><span class="op" id="5195537">:</span><span class="op" id="5195538">]</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5195542">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5195545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5195548">return</span>&nbsp;<span class="ident" id="5195555">m</span><br>
<span class="lineno"></span><span class="op" id="5195557">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="5195560">//&nbsp;RequestFromMap&nbsp;creates&nbsp;an&nbsp;http.Request&nbsp;from&nbsp;CGI&nbsp;variables.</span><br>
<span class="lineno"></span><span class="comment" id="5195622">//&nbsp;The&nbsp;returned&nbsp;Request&#39;s&nbsp;Body&nbsp;field&nbsp;is&nbsp;not&nbsp;populated.</span><br>
<span class="lineno"></span><span class="keyword" id="5195677">func</span>&nbsp;<span class="ident" id="5195682">RequestFromMap</span><span class="op" id="5195696">(</span><span class="ident" id="5195697">params</span>&nbsp;<span class="keyword" id="5195704">map</span><span class="op" id="5195707">[</span><span class="builtintype" id="5195708">string</span><span class="op" id="5195714">]</span><span class="builtintype" id="5195715">string</span><span class="op" id="5195721">)</span>&nbsp;<span class="op" id="5195723">(</span><span class="op" id="5195724">*</span><span class="ident" id="5195725">http</span><span class="op" id="5195729">.</span><span class="ident" id="5195730">Request</span><span class="op" id="5195737">,</span>&nbsp;<span class="builtintype" id="5195739">error</span><span class="op" id="5195744">)</span>&nbsp;<span class="op" id="5195746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5195749">r</span>&nbsp;<span class="op" id="5195751">:=</span>&nbsp;<span class="builtinfunc" id="5195754">new</span><span class="op" id="5195757">(</span><span class="ident" id="5195758">http</span><span class="op" id="5195762">.</span><span class="ident" id="5195763">Request</span><span class="op" id="5195770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5195773">r</span><span class="op" id="5195774">.</span><span class="ident" id="5195775">Method</span>&nbsp;<span class="op" id="5195782">=</span>&nbsp;<span class="ident" id="5195784">params</span><span class="op" id="5195790">[</span><span class="string" id="5195791">&#34;REQUEST_METHOD&#34;</span><span class="op" id="5195807">]</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5195810">if</span>&nbsp;<span class="ident" id="5195813">r</span><span class="op" id="5195814">.</span><span class="ident" id="5195815">Method</span>&nbsp;<span class="op" id="5195822">==</span>&nbsp;<span class="string" id="5195825">&#34;&#34;</span>&nbsp;<span class="op" id="5195828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5195832">return</span>&nbsp;<span class="ident" id="5195839">nil</span><span class="op" id="5195842">,</span>&nbsp;<span class="ident" id="5195844">errors</span><span class="op" id="5195850">.</span><span class="ident" id="5195851">New</span><span class="op" id="5195854">(</span><span class="string" id="5195855">&#34;cgi:&nbsp;no&nbsp;REQUEST_METHOD&nbsp;in&nbsp;environment&#34;</span><span class="op" id="5195894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5195897">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5195901">r</span><span class="op" id="5195902">.</span><span class="ident" id="5195903">Proto</span>&nbsp;<span class="op" id="5195909">=</span>&nbsp;<span class="ident" id="5195911">params</span><span class="op" id="5195917">[</span><span class="string" id="5195918">&#34;SERVER_PROTOCOL&#34;</span><span class="op" id="5195935">]</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5195938">var</span>&nbsp;<span class="ident" id="5195942">ok</span>&nbsp;<span class="builtintype" id="5195945">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5195951">r</span><span class="op" id="5195952">.</span><span class="ident" id="5195953">ProtoMajor</span><span class="op" id="5195963">,</span>&nbsp;<span class="ident" id="5195965">r</span><span class="op" id="5195966">.</span><span class="ident" id="5195967">ProtoMinor</span><span class="op" id="5195977">,</span>&nbsp;<span class="ident" id="5195979">ok</span>&nbsp;<span class="op" id="5195982">=</span>&nbsp;<span class="ident" id="5195984">http</span><span class="op" id="5195988">.</span><span class="ident" id="5195989">ParseHTTPVersion</span><span class="op" id="5196005">(</span><span class="ident" id="5196006">r</span><span class="op" id="5196007">.</span><span class="ident" id="5196008">Proto</span><span class="op" id="5196013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5196016">if</span>&nbsp;<span class="op" id="5196019">!</span><span class="ident" id="5196020">ok</span>&nbsp;<span class="op" id="5196023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5196027">return</span>&nbsp;<span class="ident" id="5196034">nil</span><span class="op" id="5196037">,</span>&nbsp;<span class="ident" id="5196039">errors</span><span class="op" id="5196045">.</span><span class="ident" id="5196046">New</span><span class="op" id="5196049">(</span><span class="string" id="5196050">&#34;cgi:&nbsp;invalid&nbsp;SERVER_PROTOCOL&nbsp;version&#34;</span><span class="op" id="5196088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5196091">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5196095">r</span><span class="op" id="5196096">.</span><span class="ident" id="5196097">Close</span>&nbsp;<span class="op" id="5196103">=</span>&nbsp;<span class="builtintype" id="5196105">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5196111">r</span><span class="op" id="5196112">.</span><span class="ident" id="5196113">Trailer</span>&nbsp;<span class="op" id="5196121">=</span>&nbsp;<span class="ident" id="5196123">http</span><span class="op" id="5196127">.</span><span class="ident" id="5196128">Header</span><span class="op" id="5196134">{</span><span class="op" id="5196135">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5196138">r</span><span class="op" id="5196139">.</span><span class="ident" id="5196140">Header</span>&nbsp;<span class="op" id="5196147">=</span>&nbsp;<span class="ident" id="5196149">http</span><span class="op" id="5196153">.</span><span class="ident" id="5196154">Header</span><span class="op" id="5196160">{</span><span class="op" id="5196161">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5196165">r</span><span class="op" id="5196166">.</span><span class="ident" id="5196167">Host</span>&nbsp;<span class="op" id="5196172">=</span>&nbsp;<span class="ident" id="5196174">params</span><span class="op" id="5196180">[</span><span class="string" id="5196181">&#34;HTTP_HOST&#34;</span><span class="op" id="5196192">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5196196">if</span>&nbsp;<span class="ident" id="5196199">lenstr</span>&nbsp;<span class="op" id="5196206">:=</span>&nbsp;<span class="ident" id="5196209">params</span><span class="op" id="5196215">[</span><span class="string" id="5196216">&#34;CONTENT_LENGTH&#34;</span><span class="op" id="5196232">]</span><span class="op" id="5196233">;</span>&nbsp;<span class="ident" id="5196235">lenstr</span>&nbsp;<span class="op" id="5196242">!=</span>&nbsp;<span class="string" id="5196245">&#34;&#34;</span>&nbsp;<span class="op" id="5196248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5196252">clen</span><span class="op" id="5196256">,</span>&nbsp;<span class="ident" id="5196258">err</span>&nbsp;<span class="op" id="5196262">:=</span>&nbsp;<span class="ident" id="5196265">strconv</span><span class="op" id="5196272">.</span><span class="ident" id="5196273">ParseInt</span><span class="op" id="5196281">(</span><span class="ident" id="5196282">lenstr</span><span class="op" id="5196288">,</span>&nbsp;<span class="num" id="5196290">10</span><span class="op" id="5196292">,</span>&nbsp;<span class="num" id="5196294">64</span><span class="op" id="5196296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5196300">if</span>&nbsp;<span class="ident" id="5196303">err</span>&nbsp;<span class="op" id="5196307">!=</span>&nbsp;<span class="ident" id="5196310">nil</span>&nbsp;<span class="op" id="5196314">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5196319">return</span>&nbsp;<span class="ident" id="5196326">nil</span><span class="op" id="5196329">,</span>&nbsp;<span class="ident" id="5196331">errors</span><span class="op" id="5196337">.</span><span class="ident" id="5196338">New</span><span class="op" id="5196341">(</span><span class="string" id="5196342">&#34;cgi:&nbsp;bad&nbsp;CONTENT_LENGTH&nbsp;in&nbsp;environment:&nbsp;&#34;</span>&nbsp;<span class="op" id="5196385">+</span>&nbsp;<span class="ident" id="5196387">lenstr</span><span class="op" id="5196393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5196397">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5196401">r</span><span class="op" id="5196402">.</span><span class="ident" id="5196403">ContentLength</span>&nbsp;<span class="op" id="5196417">=</span>&nbsp;<span class="ident" id="5196419">clen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5196425">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5196429">if</span>&nbsp;<span class="ident" id="5196432">ct</span>&nbsp;<span class="op" id="5196435">:=</span>&nbsp;<span class="ident" id="5196438">params</span><span class="op" id="5196444">[</span><span class="string" id="5196445">&#34;CONTENT_TYPE&#34;</span><span class="op" id="5196459">]</span><span class="op" id="5196460">;</span>&nbsp;<span class="ident" id="5196462">ct</span>&nbsp;<span class="op" id="5196465">!=</span>&nbsp;<span class="string" id="5196468">&#34;&#34;</span>&nbsp;<span class="op" id="5196471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5196475">r</span><span class="op" id="5196476">.</span><span class="ident" id="5196477">Header</span><span class="op" id="5196483">.</span><span class="ident" id="5196484">Set</span><span class="op" id="5196487">(</span><span class="string" id="5196488">&#34;Content-Type&#34;</span><span class="op" id="5196502">,</span>&nbsp;<span class="ident" id="5196504">ct</span><span class="op" id="5196506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5196509">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5196513">//&nbsp;Copy&nbsp;&#34;HTTP_FOO_BAR&#34;&nbsp;variables&nbsp;to&nbsp;&#34;Foo-Bar&#34;&nbsp;Headers</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5196568">for</span>&nbsp;<span class="ident" id="5196572">k</span><span class="op" id="5196573">,</span>&nbsp;<span class="ident" id="5196575">v</span>&nbsp;<span class="op" id="5196577">:=</span>&nbsp;<span class="keyword" id="5196580">range</span>&nbsp;<span class="ident" id="5196586">params</span>&nbsp;<span class="op" id="5196593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5196597">if</span>&nbsp;<span class="op" id="5196600">!</span><span class="ident" id="5196601">strings</span><span class="op" id="5196608">.</span><span class="ident" id="5196609">HasPrefix</span><span class="op" id="5196618">(</span><span class="ident" id="5196619">k</span><span class="op" id="5196620">,</span>&nbsp;<span class="string" id="5196622">&#34;HTTP_&#34;</span><span class="op" id="5196629">)</span>&nbsp;<span class="op" id="5196631">||</span>&nbsp;<span class="ident" id="5196634">k</span>&nbsp;<span class="op" id="5196636">==</span>&nbsp;<span class="string" id="5196639">&#34;HTTP_HOST&#34;</span>&nbsp;<span class="op" id="5196651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5196656">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5196667">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5196671">r</span><span class="op" id="5196672">.</span><span class="ident" id="5196673">Header</span><span class="op" id="5196679">.</span><span class="ident" id="5196680">Add</span><span class="op" id="5196683">(</span><span class="ident" id="5196684">strings</span><span class="op" id="5196691">.</span><span class="ident" id="5196692">Replace</span><span class="op" id="5196699">(</span><span class="ident" id="5196700">k</span><span class="op" id="5196701">[</span><span class="num" id="5196702">5</span><span class="op" id="5196703">:</span><span class="op" id="5196704">]</span><span class="op" id="5196705">,</span>&nbsp;<span class="string" id="5196707">&#34;_&#34;</span><span class="op" id="5196710">,</span>&nbsp;<span class="string" id="5196712">&#34;-&#34;</span><span class="op" id="5196715">,</span>&nbsp;<span class="op" id="5196717">-</span><span class="num" id="5196718">1</span><span class="op" id="5196719">)</span><span class="op" id="5196720">,</span>&nbsp;<span class="ident" id="5196722">v</span><span class="op" id="5196723">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5196726">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5196730">//&nbsp;TODO:&nbsp;cookies.&nbsp;&nbsp;parsing&nbsp;them&nbsp;isn&#39;t&nbsp;exported,&nbsp;though.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5196788">uriStr</span>&nbsp;<span class="op" id="5196795">:=</span>&nbsp;<span class="ident" id="5196798">params</span><span class="op" id="5196804">[</span><span class="string" id="5196805">&#34;REQUEST_URI&#34;</span><span class="op" id="5196818">]</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5196821">if</span>&nbsp;<span class="ident" id="5196824">uriStr</span>&nbsp;<span class="op" id="5196831">==</span>&nbsp;<span class="string" id="5196834">&#34;&#34;</span>&nbsp;<span class="op" id="5196837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5196841">//&nbsp;Fallback&nbsp;to&nbsp;SCRIPT_NAME,&nbsp;PATH_INFO&nbsp;and&nbsp;QUERY_STRING.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5196899">uriStr</span>&nbsp;<span class="op" id="5196906">=</span>&nbsp;<span class="ident" id="5196908">params</span><span class="op" id="5196914">[</span><span class="string" id="5196915">&#34;SCRIPT_NAME&#34;</span><span class="op" id="5196928">]</span>&nbsp;<span class="op" id="5196930">+</span>&nbsp;<span class="ident" id="5196932">params</span><span class="op" id="5196938">[</span><span class="string" id="5196939">&#34;PATH_INFO&#34;</span><span class="op" id="5196950">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5196954">s</span>&nbsp;<span class="op" id="5196956">:=</span>&nbsp;<span class="ident" id="5196959">params</span><span class="op" id="5196965">[</span><span class="string" id="5196966">&#34;QUERY_STRING&#34;</span><span class="op" id="5196980">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5196984">if</span>&nbsp;<span class="ident" id="5196987">s</span>&nbsp;<span class="op" id="5196989">!=</span>&nbsp;<span class="string" id="5196992">&#34;&#34;</span>&nbsp;<span class="op" id="5196995">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5197000">uriStr</span>&nbsp;<span class="op" id="5197007">+=</span>&nbsp;<span class="string" id="5197010">&#34;?&#34;</span>&nbsp;<span class="op" id="5197014">+</span>&nbsp;<span class="ident" id="5197016">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5197020">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5197023">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5197027">//&nbsp;There&#39;s&nbsp;apparently&nbsp;a&nbsp;de-facto&nbsp;standard&nbsp;for&nbsp;this.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5197080">//&nbsp;http://docstore.mik.ua/orelly/linux/cgi/ch03_02.htm#ch03-35636</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5197147">if</span>&nbsp;<span class="ident" id="5197150">s</span>&nbsp;<span class="op" id="5197152">:=</span>&nbsp;<span class="ident" id="5197155">params</span><span class="op" id="5197161">[</span><span class="string" id="5197162">&#34;HTTPS&#34;</span><span class="op" id="5197169">]</span><span class="op" id="5197170">;</span>&nbsp;<span class="ident" id="5197172">s</span>&nbsp;<span class="op" id="5197174">==</span>&nbsp;<span class="string" id="5197177">&#34;on&#34;</span>&nbsp;<span class="op" id="5197182">||</span>&nbsp;<span class="ident" id="5197185">s</span>&nbsp;<span class="op" id="5197187">==</span>&nbsp;<span class="string" id="5197190">&#34;ON&#34;</span>&nbsp;<span class="op" id="5197195">||</span>&nbsp;<span class="ident" id="5197198">s</span>&nbsp;<span class="op" id="5197200">==</span>&nbsp;<span class="string" id="5197203">&#34;1&#34;</span>&nbsp;<span class="op" id="5197207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5197211">r</span><span class="op" id="5197212">.</span><span class="ident" id="5197213">TLS</span>&nbsp;<span class="op" id="5197217">=</span>&nbsp;<span class="op" id="5197219">&amp;</span><span class="ident" id="5197220">tls</span><span class="op" id="5197223">.</span><span class="ident" id="5197224">ConnectionState</span><span class="op" id="5197239">{</span><span class="ident" id="5197240">HandshakeComplete</span><span class="op" id="5197257">:</span>&nbsp;<span class="builtintype" id="5197259">true</span><span class="op" id="5197263">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5197266">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5197270">if</span>&nbsp;<span class="ident" id="5197273">r</span><span class="op" id="5197274">.</span><span class="ident" id="5197275">Host</span>&nbsp;<span class="op" id="5197280">!=</span>&nbsp;<span class="string" id="5197283">&#34;&#34;</span>&nbsp;<span class="op" id="5197286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5197290">//&nbsp;Hostname&nbsp;is&nbsp;provided,&nbsp;so&nbsp;we&nbsp;can&nbsp;reasonably&nbsp;construct&nbsp;a&nbsp;URL.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5197355">rawurl</span>&nbsp;<span class="op" id="5197362">:=</span>&nbsp;<span class="ident" id="5197365">r</span><span class="op" id="5197366">.</span><span class="ident" id="5197367">Host</span>&nbsp;<span class="op" id="5197372">+</span>&nbsp;<span class="ident" id="5197374">uriStr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5197383">if</span>&nbsp;<span class="ident" id="5197386">r</span><span class="op" id="5197387">.</span><span class="ident" id="5197388">TLS</span>&nbsp;<span class="op" id="5197392">==</span>&nbsp;<span class="ident" id="5197395">nil</span>&nbsp;<span class="op" id="5197399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5197404">rawurl</span>&nbsp;<span class="op" id="5197411">=</span>&nbsp;<span class="string" id="5197413">&#34;http://&#34;</span>&nbsp;<span class="op" id="5197423">+</span>&nbsp;<span class="ident" id="5197425">rawurl</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5197434">}</span>&nbsp;<span class="keyword" id="5197436">else</span>&nbsp;<span class="op" id="5197441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5197446">rawurl</span>&nbsp;<span class="op" id="5197453">=</span>&nbsp;<span class="string" id="5197455">&#34;https://&#34;</span>&nbsp;<span class="op" id="5197466">+</span>&nbsp;<span class="ident" id="5197468">rawurl</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5197477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5197481">url</span><span class="op" id="5197484">,</span>&nbsp;<span class="ident" id="5197486">err</span>&nbsp;<span class="op" id="5197490">:=</span>&nbsp;<span class="ident" id="5197493">url</span><span class="op" id="5197496">.</span><span class="ident" id="5197497">Parse</span><span class="op" id="5197502">(</span><span class="ident" id="5197503">rawurl</span><span class="op" id="5197509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5197513">if</span>&nbsp;<span class="ident" id="5197516">err</span>&nbsp;<span class="op" id="5197520">!=</span>&nbsp;<span class="ident" id="5197523">nil</span>&nbsp;<span class="op" id="5197527">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5197532">return</span>&nbsp;<span class="ident" id="5197539">nil</span><span class="op" id="5197542">,</span>&nbsp;<span class="ident" id="5197544">errors</span><span class="op" id="5197550">.</span><span class="ident" id="5197551">New</span><span class="op" id="5197554">(</span><span class="string" id="5197555">&#34;cgi:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;host&nbsp;and&nbsp;REQUEST_URI&nbsp;into&nbsp;a&nbsp;URL:&nbsp;&#34;</span>&nbsp;<span class="op" id="5197612">+</span>&nbsp;<span class="ident" id="5197614">rawurl</span><span class="op" id="5197620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5197624">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5197628">r</span><span class="op" id="5197629">.</span><span class="ident" id="5197630">URL</span>&nbsp;<span class="op" id="5197634">=</span>&nbsp;<span class="ident" id="5197636">url</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5197641">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5197644">//&nbsp;Fallback&nbsp;logic&nbsp;if&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;a&nbsp;Host&nbsp;header&nbsp;or&nbsp;the&nbsp;URL</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5197705">//&nbsp;failed&nbsp;to&nbsp;parse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5197725">if</span>&nbsp;<span class="ident" id="5197728">r</span><span class="op" id="5197729">.</span><span class="ident" id="5197730">URL</span>&nbsp;<span class="op" id="5197734">==</span>&nbsp;<span class="ident" id="5197737">nil</span>&nbsp;<span class="op" id="5197741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5197745">url</span><span class="op" id="5197748">,</span>&nbsp;<span class="ident" id="5197750">err</span>&nbsp;<span class="op" id="5197754">:=</span>&nbsp;<span class="ident" id="5197757">url</span><span class="op" id="5197760">.</span><span class="ident" id="5197761">Parse</span><span class="op" id="5197766">(</span><span class="ident" id="5197767">uriStr</span><span class="op" id="5197773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5197777">if</span>&nbsp;<span class="ident" id="5197780">err</span>&nbsp;<span class="op" id="5197784">!=</span>&nbsp;<span class="ident" id="5197787">nil</span>&nbsp;<span class="op" id="5197791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5197796">return</span>&nbsp;<span class="ident" id="5197803">nil</span><span class="op" id="5197806">,</span>&nbsp;<span class="ident" id="5197808">errors</span><span class="op" id="5197814">.</span><span class="ident" id="5197815">New</span><span class="op" id="5197818">(</span><span class="string" id="5197819">&#34;cgi:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;REQUEST_URI&nbsp;into&nbsp;a&nbsp;URL:&nbsp;&#34;</span>&nbsp;<span class="op" id="5197867">+</span>&nbsp;<span class="ident" id="5197869">uriStr</span><span class="op" id="5197875">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5197879">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5197883">r</span><span class="op" id="5197884">.</span><span class="ident" id="5197885">URL</span>&nbsp;<span class="op" id="5197889">=</span>&nbsp;<span class="ident" id="5197891">url</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5197896">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5197900">//&nbsp;Request.RemoteAddr&nbsp;has&nbsp;its&nbsp;port&nbsp;set&nbsp;by&nbsp;Go&#39;s&nbsp;standard&nbsp;http</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5197962">//&nbsp;server,&nbsp;so&nbsp;we&nbsp;do&nbsp;here&nbsp;too.&nbsp;We&nbsp;don&#39;t&nbsp;have&nbsp;one,&nbsp;though,&nbsp;so&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5198026">//&nbsp;use&nbsp;a&nbsp;dummy&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5198047">r</span><span class="op" id="5198048">.</span><span class="ident" id="5198049">RemoteAddr</span>&nbsp;<span class="op" id="5198060">=</span>&nbsp;<span class="ident" id="5198062">net</span><span class="op" id="5198065">.</span><span class="ident" id="5198066">JoinHostPort</span><span class="op" id="5198078">(</span><span class="ident" id="5198079">params</span><span class="op" id="5198085">[</span><span class="string" id="5198086">&#34;REMOTE_ADDR&#34;</span><span class="op" id="5198099">]</span><span class="op" id="5198100">,</span>&nbsp;<span class="string" id="5198102">&#34;0&#34;</span><span class="op" id="5198105">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5198109">return</span>&nbsp;<span class="ident" id="5198116">r</span><span class="op" id="5198117">,</span>&nbsp;<span class="ident" id="5198119">nil</span><br>
<span class="lineno">140</span><span class="op" id="5198123">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5198126">//&nbsp;Serve&nbsp;executes&nbsp;the&nbsp;provided&nbsp;Handler&nbsp;on&nbsp;the&nbsp;currently&nbsp;active&nbsp;CGI</span><br>
<span class="lineno"></span><span class="comment" id="5198193">//&nbsp;request,&nbsp;if&nbsp;any.&nbsp;If&nbsp;there&#39;s&nbsp;no&nbsp;current&nbsp;CGI&nbsp;environment</span><br>
<span class="lineno"></span><span class="comment" id="5198251">//&nbsp;an&nbsp;error&nbsp;is&nbsp;returned.&nbsp;The&nbsp;provided&nbsp;handler&nbsp;may&nbsp;be&nbsp;nil&nbsp;to&nbsp;use</span><br>
<span class="lineno">145</span><span class="comment" id="5198315">//&nbsp;http.DefaultServeMux.</span><br>
<span class="lineno"></span><span class="keyword" id="5198340">func</span>&nbsp;<span class="ident" id="5198345">Serve</span><span class="op" id="5198350">(</span><span class="ident" id="5198351">handler</span>&nbsp;<span class="ident" id="5198359">http</span><span class="op" id="5198363">.</span><span class="ident" id="5198364">Handler</span><span class="op" id="5198371">)</span>&nbsp;<span class="builtintype" id="5198373">error</span>&nbsp;<span class="op" id="5198379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5198382">req</span><span class="op" id="5198385">,</span>&nbsp;<span class="ident" id="5198387">err</span>&nbsp;<span class="op" id="5198391">:=</span>&nbsp;<span class="ident" id="5198394">Request</span><span class="op" id="5198401">(</span><span class="op" id="5198402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5198405">if</span>&nbsp;<span class="ident" id="5198408">err</span>&nbsp;<span class="op" id="5198412">!=</span>&nbsp;<span class="ident" id="5198415">nil</span>&nbsp;<span class="op" id="5198419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5198423">return</span>&nbsp;<span class="ident" id="5198430">err</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5198435">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5198438">if</span>&nbsp;<span class="ident" id="5198441">handler</span>&nbsp;<span class="op" id="5198449">==</span>&nbsp;<span class="ident" id="5198452">nil</span>&nbsp;<span class="op" id="5198456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5198460">handler</span>&nbsp;<span class="op" id="5198468">=</span>&nbsp;<span class="ident" id="5198470">http</span><span class="op" id="5198474">.</span><span class="ident" id="5198475">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5198492">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5198495">rw</span>&nbsp;<span class="op" id="5198498">:=</span>&nbsp;<span class="op" id="5198501">&amp;</span><span class="ident" id="5198502">response</span><span class="op" id="5198510">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5198514">req</span><span class="op" id="5198517">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5198522">req</span><span class="op" id="5198525">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5198529">header</span><span class="op" id="5198535">:</span>&nbsp;<span class="builtinfunc" id="5198537">make</span><span class="op" id="5198541">(</span><span class="ident" id="5198542">http</span><span class="op" id="5198546">.</span><span class="ident" id="5198547">Header</span><span class="op" id="5198553">)</span><span class="op" id="5198554">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5198558">bufw</span><span class="op" id="5198562">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5198566">bufio</span><span class="op" id="5198571">.</span><span class="ident" id="5198572">NewWriter</span><span class="op" id="5198581">(</span><span class="ident" id="5198582">os</span><span class="op" id="5198584">.</span><span class="ident" id="5198585">Stdout</span><span class="op" id="5198591">)</span><span class="op" id="5198592">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5198595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5198598">handler</span><span class="op" id="5198605">.</span><span class="ident" id="5198606">ServeHTTP</span><span class="op" id="5198615">(</span><span class="ident" id="5198616">rw</span><span class="op" id="5198618">,</span>&nbsp;<span class="ident" id="5198620">req</span><span class="op" id="5198623">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5198626">rw</span><span class="op" id="5198628">.</span><span class="ident" id="5198629">Write</span><span class="op" id="5198634">(</span><span class="ident" id="5198635">nil</span><span class="op" id="5198638">)</span>&nbsp;<span class="comment" id="5198640">//&nbsp;make&nbsp;sure&nbsp;a&nbsp;response&nbsp;is&nbsp;sent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5198673">if</span>&nbsp;<span class="ident" id="5198676">err</span>&nbsp;<span class="op" id="5198680">=</span>&nbsp;<span class="ident" id="5198682">rw</span><span class="op" id="5198684">.</span><span class="ident" id="5198685">bufw</span><span class="op" id="5198689">.</span><span class="ident" id="5198690">Flush</span><span class="op" id="5198695">(</span><span class="op" id="5198696">)</span><span class="op" id="5198697">;</span>&nbsp;<span class="ident" id="5198699">err</span>&nbsp;<span class="op" id="5198703">!=</span>&nbsp;<span class="ident" id="5198706">nil</span>&nbsp;<span class="op" id="5198710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5198714">return</span>&nbsp;<span class="ident" id="5198721">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5198726">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5198729">return</span>&nbsp;<span class="ident" id="5198736">nil</span><br>
<span class="lineno">165</span><span class="op" id="5198740">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5198743">type</span>&nbsp;<span class="ident" id="5198748">response</span>&nbsp;<span class="keyword" id="5198757">struct</span>&nbsp;<span class="op" id="5198764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5198767">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5198778">*</span><span class="ident" id="5198779">http</span><span class="op" id="5198783">.</span><span class="ident" id="5198784">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5198793">header</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5198804">http</span><span class="op" id="5198808">.</span><span class="ident" id="5198809">Header</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5198817">bufw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5198828">*</span><span class="ident" id="5198829">bufio</span><span class="op" id="5198834">.</span><span class="ident" id="5198835">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5198843">headerSent</span>&nbsp;<span class="builtintype" id="5198854">bool</span><br>
<span class="lineno"></span><span class="op" id="5198859">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5198862">func</span>&nbsp;<span class="op" id="5198867">(</span><span class="ident" id="5198868">r</span>&nbsp;<span class="op" id="5198870">*</span><span class="ident" id="5198871">response</span><span class="op" id="5198879">)</span>&nbsp;<span class="ident" id="5198881">Flush</span><span class="op" id="5198886">(</span><span class="op" id="5198887">)</span>&nbsp;<span class="op" id="5198889">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5198892">r</span><span class="op" id="5198893">.</span><span class="ident" id="5198894">bufw</span><span class="op" id="5198898">.</span><span class="ident" id="5198899">Flush</span><span class="op" id="5198904">(</span><span class="op" id="5198905">)</span><br>
<span class="lineno"></span><span class="op" id="5198907">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5198910">func</span>&nbsp;<span class="op" id="5198915">(</span><span class="ident" id="5198916">r</span>&nbsp;<span class="op" id="5198918">*</span><span class="ident" id="5198919">response</span><span class="op" id="5198927">)</span>&nbsp;<span class="ident" id="5198929">Header</span><span class="op" id="5198935">(</span><span class="op" id="5198936">)</span>&nbsp;<span class="ident" id="5198938">http</span><span class="op" id="5198942">.</span><span class="ident" id="5198943">Header</span>&nbsp;<span class="op" id="5198950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5198953">return</span>&nbsp;<span class="ident" id="5198960">r</span><span class="op" id="5198961">.</span><span class="ident" id="5198962">header</span><br>
<span class="lineno">180</span><span class="op" id="5198969">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5198972">func</span>&nbsp;<span class="op" id="5198977">(</span><span class="ident" id="5198978">r</span>&nbsp;<span class="op" id="5198980">*</span><span class="ident" id="5198981">response</span><span class="op" id="5198989">)</span>&nbsp;<span class="ident" id="5198991">Write</span><span class="op" id="5198996">(</span><span class="ident" id="5198997">p</span>&nbsp;<span class="op" id="5198999">[</span><span class="op" id="5199000">]</span><span class="builtintype" id="5199001">byte</span><span class="op" id="5199005">)</span>&nbsp;<span class="op" id="5199007">(</span><span class="ident" id="5199008">n</span>&nbsp;<span class="builtintype" id="5199010">int</span><span class="op" id="5199013">,</span>&nbsp;<span class="ident" id="5199015">err</span>&nbsp;<span class="builtintype" id="5199019">error</span><span class="op" id="5199024">)</span>&nbsp;<span class="op" id="5199026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5199029">if</span>&nbsp;<span class="op" id="5199032">!</span><span class="ident" id="5199033">r</span><span class="op" id="5199034">.</span><span class="ident" id="5199035">headerSent</span>&nbsp;<span class="op" id="5199046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5199050">r</span><span class="op" id="5199051">.</span><span class="ident" id="5199052">WriteHeader</span><span class="op" id="5199063">(</span><span class="ident" id="5199064">http</span><span class="op" id="5199068">.</span><span class="ident" id="5199069">StatusOK</span><span class="op" id="5199077">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5199080">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5199083">return</span>&nbsp;<span class="ident" id="5199090">r</span><span class="op" id="5199091">.</span><span class="ident" id="5199092">bufw</span><span class="op" id="5199096">.</span><span class="ident" id="5199097">Write</span><span class="op" id="5199102">(</span><span class="ident" id="5199103">p</span><span class="op" id="5199104">)</span><br>
<span class="lineno"></span><span class="op" id="5199106">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5199109">func</span>&nbsp;<span class="op" id="5199114">(</span><span class="ident" id="5199115">r</span>&nbsp;<span class="op" id="5199117">*</span><span class="ident" id="5199118">response</span><span class="op" id="5199126">)</span>&nbsp;<span class="ident" id="5199128">WriteHeader</span><span class="op" id="5199139">(</span><span class="ident" id="5199140">code</span>&nbsp;<span class="builtintype" id="5199145">int</span><span class="op" id="5199148">)</span>&nbsp;<span class="op" id="5199150">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5199153">if</span>&nbsp;<span class="ident" id="5199156">r</span><span class="op" id="5199157">.</span><span class="ident" id="5199158">headerSent</span>&nbsp;<span class="op" id="5199169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5199173">//&nbsp;Note:&nbsp;explicitly&nbsp;using&nbsp;Stderr,&nbsp;as&nbsp;Stdout&nbsp;is&nbsp;our&nbsp;HTTP&nbsp;output.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5199239">fmt</span><span class="op" id="5199242">.</span><span class="ident" id="5199243">Fprintf</span><span class="op" id="5199250">(</span><span class="ident" id="5199251">os</span><span class="op" id="5199253">.</span><span class="ident" id="5199254">Stderr</span><span class="op" id="5199260">,</span>&nbsp;<span class="string" id="5199262">&#34;CGI&nbsp;attempted&nbsp;to&nbsp;write&nbsp;header&nbsp;twice&nbsp;on&nbsp;request&nbsp;for&nbsp;%s&#34;</span><span class="op" id="5199317">,</span>&nbsp;<span class="ident" id="5199319">r</span><span class="op" id="5199320">.</span><span class="ident" id="5199321">req</span><span class="op" id="5199324">.</span><span class="ident" id="5199325">URL</span><span class="op" id="5199328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5199332">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5199340">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5199343">r</span><span class="op" id="5199344">.</span><span class="ident" id="5199345">headerSent</span>&nbsp;<span class="op" id="5199356">=</span>&nbsp;<span class="builtintype" id="5199358">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5199364">fmt</span><span class="op" id="5199367">.</span><span class="ident" id="5199368">Fprintf</span><span class="op" id="5199375">(</span><span class="ident" id="5199376">r</span><span class="op" id="5199377">.</span><span class="ident" id="5199378">bufw</span><span class="op" id="5199382">,</span>&nbsp;<span class="string" id="5199384">&#34;Status:&nbsp;%d&nbsp;%s\r\n&#34;</span><span class="op" id="5199403">,</span>&nbsp;<span class="ident" id="5199405">code</span><span class="op" id="5199409">,</span>&nbsp;<span class="ident" id="5199411">http</span><span class="op" id="5199415">.</span><span class="ident" id="5199416">StatusText</span><span class="op" id="5199426">(</span><span class="ident" id="5199427">code</span><span class="op" id="5199431">)</span><span class="op" id="5199432">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5199436">//&nbsp;Set&nbsp;a&nbsp;default&nbsp;Content-Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5199467">if</span>&nbsp;<span class="ident" id="5199470">_</span><span class="op" id="5199471">,</span>&nbsp;<span class="ident" id="5199473">hasType</span>&nbsp;<span class="op" id="5199481">:=</span>&nbsp;<span class="ident" id="5199484">r</span><span class="op" id="5199485">.</span><span class="ident" id="5199486">header</span><span class="op" id="5199492">[</span><span class="string" id="5199493">&#34;Content-Type&#34;</span><span class="op" id="5199507">]</span><span class="op" id="5199508">;</span>&nbsp;<span class="op" id="5199510">!</span><span class="ident" id="5199511">hasType</span>&nbsp;<span class="op" id="5199519">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5199523">r</span><span class="op" id="5199524">.</span><span class="ident" id="5199525">header</span><span class="op" id="5199531">.</span><span class="ident" id="5199532">Add</span><span class="op" id="5199535">(</span><span class="string" id="5199536">&#34;Content-Type&#34;</span><span class="op" id="5199550">,</span>&nbsp;<span class="string" id="5199552">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="5199578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5199581">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5199585">r</span><span class="op" id="5199586">.</span><span class="ident" id="5199587">header</span><span class="op" id="5199593">.</span><span class="ident" id="5199594">Write</span><span class="op" id="5199599">(</span><span class="ident" id="5199600">r</span><span class="op" id="5199601">.</span><span class="ident" id="5199602">bufw</span><span class="op" id="5199606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5199609">r</span><span class="op" id="5199610">.</span><span class="ident" id="5199611">bufw</span><span class="op" id="5199615">.</span><span class="ident" id="5199616">WriteString</span><span class="op" id="5199627">(</span><span class="string" id="5199628">&#34;\r\n&#34;</span><span class="op" id="5199634">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5199637">r</span><span class="op" id="5199638">.</span><span class="ident" id="5199639">bufw</span><span class="op" id="5199643">.</span><span class="ident" id="5199644">Flush</span><span class="op" id="5199649">(</span><span class="op" id="5199650">)</span><br>
<span class="lineno"></span><span class="op" id="5199652">}</span>
</div>
</body>
</html>
