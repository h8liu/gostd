<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>mime/multipart</h2>
<ul>
<li><a href="/gostd/mime/multipart/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/mime/multipart/formdata.go.html">formdata.go</a></li>
<li><a href="/gostd/mime/multipart/formdata_test.go.html">formdata_test.go</a></li>
<li><a href="/gostd/mime/multipart/multipart.go.html">multipart.go</a></li>
<li><a href="/gostd/mime/multipart/multipart_test.go.html">multipart_test.go</a></li>
<li><a href="/gostd/mime/multipart/quotedprintable.go.html">quotedprintable.go</a></li>
<li><a href="/gostd/mime/multipart/quotedprintable_test.go.html">quotedprintable_test.go</a></li>
<li><a href="/gostd/mime/multipart/writer.go.html">writer.go</a></li>
<li><a href="/gostd/mime/multipart/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5236739">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5236794">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5236848">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="5236898">//</span><br>
<span class="lineno">5</span><br>
<span class="lineno"></span><span class="comment" id="5236902">/*<br>
<span class="lineno"></span>Package&nbsp;multipart&nbsp;implements&nbsp;MIME&nbsp;multipart&nbsp;parsing,&nbsp;as&nbsp;defined&nbsp;in&nbsp;RFC<br>
<span class="lineno"></span>2046.<br>
<span class="lineno"></span><br>
<span class="lineno">10</span>The&nbsp;implementation&nbsp;is&nbsp;sufficient&nbsp;for&nbsp;HTTP&nbsp;(RFC&nbsp;2388)&nbsp;and&nbsp;the&nbsp;multipart<br>
<span class="lineno"></span>bodies&nbsp;generated&nbsp;by&nbsp;popular&nbsp;browsers.<br>
<span class="lineno"></span>*/</span><br>
<span class="lineno"></span><span class="keyword" id="5237095">package</span>&nbsp;<span class="ident" id="5237103">multipart</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="5237114">import</span>&nbsp;<span class="op" id="5237121">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5237124">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5237133">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5237142">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5237149">&#34;io&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5237155">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5237168">&#34;mime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5237176">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span><span class="op" id="5237192">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="5237195">var</span>&nbsp;<span class="ident" id="5237199">emptyParams</span>&nbsp;<span class="op" id="5237211">=</span>&nbsp;<span class="builtinfunc" id="5237213">make</span><span class="op" id="5237217">(</span><span class="keyword" id="5237218">map</span><span class="op" id="5237221">[</span><span class="builtintype" id="5237222">string</span><span class="op" id="5237228">]</span><span class="builtintype" id="5237229">string</span><span class="op" id="5237235">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5237238">//&nbsp;A&nbsp;Part&nbsp;represents&nbsp;a&nbsp;single&nbsp;part&nbsp;in&nbsp;a&nbsp;multipart&nbsp;body.</span><br>
<span class="lineno"></span><span class="keyword" id="5237294">type</span>&nbsp;<span class="ident" id="5237299">Part</span>&nbsp;<span class="keyword" id="5237304">struct</span>&nbsp;<span class="op" id="5237311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5237314">//&nbsp;The&nbsp;headers&nbsp;of&nbsp;the&nbsp;body,&nbsp;if&nbsp;any,&nbsp;with&nbsp;the&nbsp;keys&nbsp;canonicalized</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5237379">//&nbsp;in&nbsp;the&nbsp;same&nbsp;fashion&nbsp;that&nbsp;the&nbsp;Go&nbsp;http.Request&nbsp;headers&nbsp;are.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5237441">//&nbsp;For&nbsp;example,&nbsp;&#34;foo-bar&#34;&nbsp;changes&nbsp;case&nbsp;to&nbsp;&#34;Foo-Bar&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5237494">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5237498">//&nbsp;As&nbsp;a&nbsp;special&nbsp;case,&nbsp;if&nbsp;the&nbsp;&#34;Content-Transfer-Encoding&#34;&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5237563">//&nbsp;has&nbsp;a&nbsp;value&nbsp;of&nbsp;&#34;quoted-printable&#34;,&nbsp;that&nbsp;header&nbsp;is&nbsp;instead</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5237625">//&nbsp;hidden&nbsp;from&nbsp;this&nbsp;map&nbsp;and&nbsp;the&nbsp;body&nbsp;is&nbsp;transparently&nbsp;decoded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5237688">//&nbsp;during&nbsp;Read&nbsp;calls.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5237711">Header</span>&nbsp;<span class="ident" id="5237718">textproto</span><span class="op" id="5237727">.</span><span class="ident" id="5237728">MIMEHeader</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5237741">buffer</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5237751">*</span><span class="ident" id="5237752">bytes</span><span class="op" id="5237757">.</span><span class="ident" id="5237758">Buffer</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5237766">mr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5237776">*</span><span class="ident" id="5237777">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5237785">bytesRead</span>&nbsp;<span class="builtintype" id="5237795">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5237801">disposition</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5237819">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5237827">dispositionParams</span>&nbsp;<span class="keyword" id="5237845">map</span><span class="op" id="5237848">[</span><span class="builtintype" id="5237849">string</span><span class="op" id="5237855">]</span><span class="builtintype" id="5237856">string</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5237865">//&nbsp;r&nbsp;is&nbsp;either&nbsp;a&nbsp;reader&nbsp;directly&nbsp;reading&nbsp;from&nbsp;mr,&nbsp;or&nbsp;it&#39;s&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5237926">//&nbsp;wrapper&nbsp;around&nbsp;such&nbsp;a&nbsp;reader,&nbsp;decoding&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5237973">//&nbsp;Content-Transfer-Encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5238003">r</span>&nbsp;<span class="ident" id="5238005">io</span><span class="op" id="5238007">.</span><span class="ident" id="5238008">Reader</span><br>
<span class="lineno">50</span><span class="op" id="5238015">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5238018">//&nbsp;FormName&nbsp;returns&nbsp;the&nbsp;name&nbsp;parameter&nbsp;if&nbsp;p&nbsp;has&nbsp;a&nbsp;Content-Disposition</span><br>
<span class="lineno"></span><span class="comment" id="5238088">//&nbsp;of&nbsp;type&nbsp;&#34;form-data&#34;.&nbsp;&nbsp;Otherwise&nbsp;it&nbsp;returns&nbsp;the&nbsp;empty&nbsp;string.</span><br>
<span class="lineno"></span><span class="keyword" id="5238152">func</span>&nbsp;<span class="op" id="5238157">(</span><span class="ident" id="5238158">p</span>&nbsp;<span class="op" id="5238160">*</span><span class="ident" id="5238161">Part</span><span class="op" id="5238165">)</span>&nbsp;<span class="ident" id="5238167">FormName</span><span class="op" id="5238175">(</span><span class="op" id="5238176">)</span>&nbsp;<span class="builtintype" id="5238178">string</span>&nbsp;<span class="op" id="5238185">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5238188">//&nbsp;See&nbsp;http://tools.ietf.org/html/rfc2183&nbsp;section&nbsp;2&nbsp;for&nbsp;EBNF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5238250">//&nbsp;of&nbsp;Content-Disposition&nbsp;value&nbsp;format.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5238291">if</span>&nbsp;<span class="ident" id="5238294">p</span><span class="op" id="5238295">.</span><span class="ident" id="5238296">dispositionParams</span>&nbsp;<span class="op" id="5238314">==</span>&nbsp;<span class="ident" id="5238317">nil</span>&nbsp;<span class="op" id="5238321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5238325">p</span><span class="op" id="5238326">.</span><span class="ident" id="5238327">parseContentDisposition</span><span class="op" id="5238350">(</span><span class="op" id="5238351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5238354">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5238357">if</span>&nbsp;<span class="ident" id="5238360">p</span><span class="op" id="5238361">.</span><span class="ident" id="5238362">disposition</span>&nbsp;<span class="op" id="5238374">!=</span>&nbsp;<span class="string" id="5238377">&#34;form-data&#34;</span>&nbsp;<span class="op" id="5238389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5238393">return</span>&nbsp;<span class="string" id="5238400">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5238404">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5238407">return</span>&nbsp;<span class="ident" id="5238414">p</span><span class="op" id="5238415">.</span><span class="ident" id="5238416">dispositionParams</span><span class="op" id="5238433">[</span><span class="string" id="5238434">&#34;name&#34;</span><span class="op" id="5238440">]</span><br>
<span class="lineno"></span><span class="op" id="5238442">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="5238445">//&nbsp;FileName&nbsp;returns&nbsp;the&nbsp;filename&nbsp;parameter&nbsp;of&nbsp;the&nbsp;Part&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="5238502">//&nbsp;Content-Disposition&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="5238533">func</span>&nbsp;<span class="op" id="5238538">(</span><span class="ident" id="5238539">p</span>&nbsp;<span class="op" id="5238541">*</span><span class="ident" id="5238542">Part</span><span class="op" id="5238546">)</span>&nbsp;<span class="ident" id="5238548">FileName</span><span class="op" id="5238556">(</span><span class="op" id="5238557">)</span>&nbsp;<span class="builtintype" id="5238559">string</span>&nbsp;<span class="op" id="5238566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5238569">if</span>&nbsp;<span class="ident" id="5238572">p</span><span class="op" id="5238573">.</span><span class="ident" id="5238574">dispositionParams</span>&nbsp;<span class="op" id="5238592">==</span>&nbsp;<span class="ident" id="5238595">nil</span>&nbsp;<span class="op" id="5238599">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5238603">p</span><span class="op" id="5238604">.</span><span class="ident" id="5238605">parseContentDisposition</span><span class="op" id="5238628">(</span><span class="op" id="5238629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5238632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5238635">return</span>&nbsp;<span class="ident" id="5238642">p</span><span class="op" id="5238643">.</span><span class="ident" id="5238644">dispositionParams</span><span class="op" id="5238661">[</span><span class="string" id="5238662">&#34;filename&#34;</span><span class="op" id="5238672">]</span><br>
<span class="lineno"></span><span class="op" id="5238674">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="keyword" id="5238677">func</span>&nbsp;<span class="op" id="5238682">(</span><span class="ident" id="5238683">p</span>&nbsp;<span class="op" id="5238685">*</span><span class="ident" id="5238686">Part</span><span class="op" id="5238690">)</span>&nbsp;<span class="ident" id="5238692">parseContentDisposition</span><span class="op" id="5238715">(</span><span class="op" id="5238716">)</span>&nbsp;<span class="op" id="5238718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5238721">v</span>&nbsp;<span class="op" id="5238723">:=</span>&nbsp;<span class="ident" id="5238726">p</span><span class="op" id="5238727">.</span><span class="ident" id="5238728">Header</span><span class="op" id="5238734">.</span><span class="ident" id="5238735">Get</span><span class="op" id="5238738">(</span><span class="string" id="5238739">&#34;Content-Disposition&#34;</span><span class="op" id="5238760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5238763">var</span>&nbsp;<span class="ident" id="5238767">err</span>&nbsp;<span class="builtintype" id="5238771">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5238778">p</span><span class="op" id="5238779">.</span><span class="ident" id="5238780">disposition</span><span class="op" id="5238791">,</span>&nbsp;<span class="ident" id="5238793">p</span><span class="op" id="5238794">.</span><span class="ident" id="5238795">dispositionParams</span><span class="op" id="5238812">,</span>&nbsp;<span class="ident" id="5238814">err</span>&nbsp;<span class="op" id="5238818">=</span>&nbsp;<span class="ident" id="5238820">mime</span><span class="op" id="5238824">.</span><span class="ident" id="5238825">ParseMediaType</span><span class="op" id="5238839">(</span><span class="ident" id="5238840">v</span><span class="op" id="5238841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5238844">if</span>&nbsp;<span class="ident" id="5238847">err</span>&nbsp;<span class="op" id="5238851">!=</span>&nbsp;<span class="ident" id="5238854">nil</span>&nbsp;<span class="op" id="5238858">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5238862">p</span><span class="op" id="5238863">.</span><span class="ident" id="5238864">dispositionParams</span>&nbsp;<span class="op" id="5238882">=</span>&nbsp;<span class="ident" id="5238884">emptyParams</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5238897">}</span><br>
<span class="lineno"></span><span class="op" id="5238899">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5238902">//&nbsp;NewReader&nbsp;creates&nbsp;a&nbsp;new&nbsp;multipart&nbsp;Reader&nbsp;reading&nbsp;from&nbsp;r&nbsp;using&nbsp;the</span><br>
<span class="lineno">85</span><span class="comment" id="5238971">//&nbsp;given&nbsp;MIME&nbsp;boundary.</span><br>
<span class="lineno"></span><span class="comment" id="5238995">//</span><br>
<span class="lineno"></span><span class="comment" id="5238998">//&nbsp;The&nbsp;boundary&nbsp;is&nbsp;usually&nbsp;obtained&nbsp;from&nbsp;the&nbsp;&#34;boundary&#34;&nbsp;parameter&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5239067">//&nbsp;the&nbsp;message&#39;s&nbsp;&#34;Content-Type&#34;&nbsp;header.&nbsp;Use&nbsp;mime.ParseMediaType&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5239134">//&nbsp;parse&nbsp;such&nbsp;headers.</span><br>
<span class="lineno">90</span><span class="keyword" id="5239157">func</span>&nbsp;<span class="ident" id="5239162">NewReader</span><span class="op" id="5239171">(</span><span class="ident" id="5239172">r</span>&nbsp;<span class="ident" id="5239174">io</span><span class="op" id="5239176">.</span><span class="ident" id="5239177">Reader</span><span class="op" id="5239183">,</span>&nbsp;<span class="ident" id="5239185">boundary</span>&nbsp;<span class="builtintype" id="5239194">string</span><span class="op" id="5239200">)</span>&nbsp;<span class="op" id="5239202">*</span><span class="ident" id="5239203">Reader</span>&nbsp;<span class="op" id="5239210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239213">b</span>&nbsp;<span class="op" id="5239215">:=</span>&nbsp;<span class="op" id="5239218">[</span><span class="op" id="5239219">]</span><span class="builtintype" id="5239220">byte</span><span class="op" id="5239224">(</span><span class="string" id="5239225">&#34;\r\n--&#34;</span>&nbsp;<span class="op" id="5239234">+</span>&nbsp;<span class="ident" id="5239236">boundary</span>&nbsp;<span class="op" id="5239245">+</span>&nbsp;<span class="string" id="5239247">&#34;--&#34;</span><span class="op" id="5239251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5239254">return</span>&nbsp;<span class="op" id="5239261">&amp;</span><span class="ident" id="5239262">Reader</span><span class="op" id="5239268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239272">bufReader</span><span class="op" id="5239281">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5239290">bufio</span><span class="op" id="5239295">.</span><span class="ident" id="5239296">NewReader</span><span class="op" id="5239305">(</span><span class="ident" id="5239306">r</span><span class="op" id="5239307">)</span><span class="op" id="5239308">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239312">nl</span><span class="op" id="5239314">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5239330">b</span><span class="op" id="5239331">[</span><span class="op" id="5239332">:</span><span class="num" id="5239333">2</span><span class="op" id="5239334">]</span><span class="op" id="5239335">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239339">nlDashBoundary</span><span class="op" id="5239353">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5239357">b</span><span class="op" id="5239358">[</span><span class="op" id="5239359">:</span><span class="builtinfunc" id="5239360">len</span><span class="op" id="5239363">(</span><span class="ident" id="5239364">b</span><span class="op" id="5239365">)</span><span class="op" id="5239366">-</span><span class="num" id="5239367">2</span><span class="op" id="5239368">]</span><span class="op" id="5239369">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239373">dashBoundaryDash</span><span class="op" id="5239389">:</span>&nbsp;<span class="ident" id="5239391">b</span><span class="op" id="5239392">[</span><span class="num" id="5239393">2</span><span class="op" id="5239394">:</span><span class="op" id="5239395">]</span><span class="op" id="5239396">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239400">dashBoundary</span><span class="op" id="5239412">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5239418">b</span><span class="op" id="5239419">[</span><span class="num" id="5239420">2</span>&nbsp;<span class="op" id="5239422">:</span>&nbsp;<span class="builtinfunc" id="5239424">len</span><span class="op" id="5239427">(</span><span class="ident" id="5239428">b</span><span class="op" id="5239429">)</span><span class="op" id="5239430">-</span><span class="num" id="5239431">2</span><span class="op" id="5239432">]</span><span class="op" id="5239433">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5239436">}</span><br>
<span class="lineno"></span><span class="op" id="5239438">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="5239441">func</span>&nbsp;<span class="ident" id="5239446">newPart</span><span class="op" id="5239453">(</span><span class="ident" id="5239454">mr</span>&nbsp;<span class="op" id="5239457">*</span><span class="ident" id="5239458">Reader</span><span class="op" id="5239464">)</span>&nbsp;<span class="op" id="5239466">(</span><span class="op" id="5239467">*</span><span class="ident" id="5239468">Part</span><span class="op" id="5239472">,</span>&nbsp;<span class="builtintype" id="5239474">error</span><span class="op" id="5239479">)</span>&nbsp;<span class="op" id="5239481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239484">bp</span>&nbsp;<span class="op" id="5239487">:=</span>&nbsp;<span class="op" id="5239490">&amp;</span><span class="ident" id="5239491">Part</span><span class="op" id="5239495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239499">Header</span><span class="op" id="5239505">:</span>&nbsp;<span class="builtinfunc" id="5239507">make</span><span class="op" id="5239511">(</span><span class="keyword" id="5239512">map</span><span class="op" id="5239515">[</span><span class="builtintype" id="5239516">string</span><span class="op" id="5239522">]</span><span class="op" id="5239523">[</span><span class="op" id="5239524">]</span><span class="builtintype" id="5239525">string</span><span class="op" id="5239531">)</span><span class="op" id="5239532">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239536">mr</span><span class="op" id="5239538">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5239544">mr</span><span class="op" id="5239546">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239550">buffer</span><span class="op" id="5239556">:</span>&nbsp;<span class="builtinfunc" id="5239558">new</span><span class="op" id="5239561">(</span><span class="ident" id="5239562">bytes</span><span class="op" id="5239567">.</span><span class="ident" id="5239568">Buffer</span><span class="op" id="5239574">)</span><span class="op" id="5239575">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5239578">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5239581">if</span>&nbsp;<span class="ident" id="5239584">err</span>&nbsp;<span class="op" id="5239588">:=</span>&nbsp;<span class="ident" id="5239591">bp</span><span class="op" id="5239593">.</span><span class="ident" id="5239594">populateHeaders</span><span class="op" id="5239609">(</span><span class="op" id="5239610">)</span><span class="op" id="5239611">;</span>&nbsp;<span class="ident" id="5239613">err</span>&nbsp;<span class="op" id="5239617">!=</span>&nbsp;<span class="ident" id="5239620">nil</span>&nbsp;<span class="op" id="5239624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5239628">return</span>&nbsp;<span class="ident" id="5239635">nil</span><span class="op" id="5239638">,</span>&nbsp;<span class="ident" id="5239640">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5239645">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239648">bp</span><span class="op" id="5239650">.</span><span class="ident" id="5239651">r</span>&nbsp;<span class="op" id="5239653">=</span>&nbsp;<span class="ident" id="5239655">partReader</span><span class="op" id="5239665">{</span><span class="ident" id="5239666">bp</span><span class="op" id="5239668">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5239671">const</span>&nbsp;<span class="ident" id="5239677">cte</span>&nbsp;<span class="op" id="5239681">=</span>&nbsp;<span class="string" id="5239683">&#34;Content-Transfer-Encoding&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5239712">if</span>&nbsp;<span class="ident" id="5239715">bp</span><span class="op" id="5239717">.</span><span class="ident" id="5239718">Header</span><span class="op" id="5239724">.</span><span class="ident" id="5239725">Get</span><span class="op" id="5239728">(</span><span class="ident" id="5239729">cte</span><span class="op" id="5239732">)</span>&nbsp;<span class="op" id="5239734">==</span>&nbsp;<span class="string" id="5239737">&#34;quoted-printable&#34;</span>&nbsp;<span class="op" id="5239756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239760">bp</span><span class="op" id="5239762">.</span><span class="ident" id="5239763">Header</span><span class="op" id="5239769">.</span><span class="ident" id="5239770">Del</span><span class="op" id="5239773">(</span><span class="ident" id="5239774">cte</span><span class="op" id="5239777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239781">bp</span><span class="op" id="5239783">.</span><span class="ident" id="5239784">r</span>&nbsp;<span class="op" id="5239786">=</span>&nbsp;<span class="ident" id="5239788">newQuotedPrintableReader</span><span class="op" id="5239812">(</span><span class="ident" id="5239813">bp</span><span class="op" id="5239815">.</span><span class="ident" id="5239816">r</span><span class="op" id="5239817">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5239820">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5239823">return</span>&nbsp;<span class="ident" id="5239830">bp</span><span class="op" id="5239832">,</span>&nbsp;<span class="ident" id="5239834">nil</span><br>
<span class="lineno"></span><span class="op" id="5239838">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5239841">func</span>&nbsp;<span class="op" id="5239846">(</span><span class="ident" id="5239847">bp</span>&nbsp;<span class="op" id="5239850">*</span><span class="ident" id="5239851">Part</span><span class="op" id="5239855">)</span>&nbsp;<span class="ident" id="5239857">populateHeaders</span><span class="op" id="5239872">(</span><span class="op" id="5239873">)</span>&nbsp;<span class="builtintype" id="5239875">error</span>&nbsp;<span class="op" id="5239881">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239884">r</span>&nbsp;<span class="op" id="5239886">:=</span>&nbsp;<span class="ident" id="5239889">textproto</span><span class="op" id="5239898">.</span><span class="ident" id="5239899">NewReader</span><span class="op" id="5239908">(</span><span class="ident" id="5239909">bp</span><span class="op" id="5239911">.</span><span class="ident" id="5239912">mr</span><span class="op" id="5239914">.</span><span class="ident" id="5239915">bufReader</span><span class="op" id="5239924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239927">header</span><span class="op" id="5239933">,</span>&nbsp;<span class="ident" id="5239935">err</span>&nbsp;<span class="op" id="5239939">:=</span>&nbsp;<span class="ident" id="5239942">r</span><span class="op" id="5239943">.</span><span class="ident" id="5239944">ReadMIMEHeader</span><span class="op" id="5239958">(</span><span class="op" id="5239959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5239962">if</span>&nbsp;<span class="ident" id="5239965">err</span>&nbsp;<span class="op" id="5239969">==</span>&nbsp;<span class="ident" id="5239972">nil</span>&nbsp;<span class="op" id="5239976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239980">bp</span><span class="op" id="5239982">.</span><span class="ident" id="5239983">Header</span>&nbsp;<span class="op" id="5239990">=</span>&nbsp;<span class="ident" id="5239992">header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5240000">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5240003">return</span>&nbsp;<span class="ident" id="5240010">err</span><br>
<span class="lineno"></span><span class="op" id="5240014">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5240017">//&nbsp;Read&nbsp;reads&nbsp;the&nbsp;body&nbsp;of&nbsp;a&nbsp;part,&nbsp;after&nbsp;its&nbsp;headers&nbsp;and&nbsp;before&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5240084">//&nbsp;next&nbsp;part&nbsp;(if&nbsp;any)&nbsp;begins.</span><br>
<span class="lineno">130</span><span class="keyword" id="5240114">func</span>&nbsp;<span class="op" id="5240119">(</span><span class="ident" id="5240120">p</span>&nbsp;<span class="op" id="5240122">*</span><span class="ident" id="5240123">Part</span><span class="op" id="5240127">)</span>&nbsp;<span class="ident" id="5240129">Read</span><span class="op" id="5240133">(</span><span class="ident" id="5240134">d</span>&nbsp;<span class="op" id="5240136">[</span><span class="op" id="5240137">]</span><span class="builtintype" id="5240138">byte</span><span class="op" id="5240142">)</span>&nbsp;<span class="op" id="5240144">(</span><span class="ident" id="5240145">n</span>&nbsp;<span class="builtintype" id="5240147">int</span><span class="op" id="5240150">,</span>&nbsp;<span class="ident" id="5240152">err</span>&nbsp;<span class="builtintype" id="5240156">error</span><span class="op" id="5240161">)</span>&nbsp;<span class="op" id="5240163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5240166">return</span>&nbsp;<span class="ident" id="5240173">p</span><span class="op" id="5240174">.</span><span class="ident" id="5240175">r</span><span class="op" id="5240176">.</span><span class="ident" id="5240177">Read</span><span class="op" id="5240181">(</span><span class="ident" id="5240182">d</span><span class="op" id="5240183">)</span><br>
<span class="lineno"></span><span class="op" id="5240185">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5240188">//&nbsp;partReader&nbsp;implements&nbsp;io.Reader&nbsp;by&nbsp;reading&nbsp;raw&nbsp;bytes&nbsp;directly&nbsp;from&nbsp;the</span><br>
<span class="lineno">135</span><span class="comment" id="5240262">//&nbsp;wrapped&nbsp;*Part,&nbsp;without&nbsp;doing&nbsp;any&nbsp;Transfer-Encoding&nbsp;decoding.</span><br>
<span class="lineno"></span><span class="keyword" id="5240326">type</span>&nbsp;<span class="ident" id="5240331">partReader</span>&nbsp;<span class="keyword" id="5240342">struct</span>&nbsp;<span class="op" id="5240349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5240352">p</span>&nbsp;<span class="op" id="5240354">*</span><span class="ident" id="5240355">Part</span><br>
<span class="lineno"></span><span class="op" id="5240360">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="keyword" id="5240363">func</span>&nbsp;<span class="op" id="5240368">(</span><span class="ident" id="5240369">pr</span>&nbsp;<span class="ident" id="5240372">partReader</span><span class="op" id="5240382">)</span>&nbsp;<span class="ident" id="5240384">Read</span><span class="op" id="5240388">(</span><span class="ident" id="5240389">d</span>&nbsp;<span class="op" id="5240391">[</span><span class="op" id="5240392">]</span><span class="builtintype" id="5240393">byte</span><span class="op" id="5240397">)</span>&nbsp;<span class="op" id="5240399">(</span><span class="ident" id="5240400">n</span>&nbsp;<span class="builtintype" id="5240402">int</span><span class="op" id="5240405">,</span>&nbsp;<span class="ident" id="5240407">err</span>&nbsp;<span class="builtintype" id="5240411">error</span><span class="op" id="5240416">)</span>&nbsp;<span class="op" id="5240418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5240421">p</span>&nbsp;<span class="op" id="5240423">:=</span>&nbsp;<span class="ident" id="5240426">pr</span><span class="op" id="5240428">.</span><span class="ident" id="5240429">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5240432">defer</span>&nbsp;<span class="keyword" id="5240438">func</span><span class="op" id="5240442">(</span><span class="op" id="5240443">)</span>&nbsp;<span class="op" id="5240445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5240449">p</span><span class="op" id="5240450">.</span><span class="ident" id="5240451">bytesRead</span>&nbsp;<span class="op" id="5240461">+=</span>&nbsp;<span class="ident" id="5240464">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5240467">}</span><span class="op" id="5240468">(</span><span class="op" id="5240469">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5240472">if</span>&nbsp;<span class="ident" id="5240475">p</span><span class="op" id="5240476">.</span><span class="ident" id="5240477">buffer</span><span class="op" id="5240483">.</span><span class="ident" id="5240484">Len</span><span class="op" id="5240487">(</span><span class="op" id="5240488">)</span>&nbsp;<span class="op" id="5240490">&gt;=</span>&nbsp;<span class="builtinfunc" id="5240493">len</span><span class="op" id="5240496">(</span><span class="ident" id="5240497">d</span><span class="op" id="5240498">)</span>&nbsp;<span class="op" id="5240500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5240504">//&nbsp;Internal&nbsp;buffer&nbsp;of&nbsp;unconsumed&nbsp;data&nbsp;is&nbsp;large&nbsp;enough&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5240564">//&nbsp;the&nbsp;read&nbsp;request.&nbsp;&nbsp;No&nbsp;need&nbsp;to&nbsp;parse&nbsp;more&nbsp;at&nbsp;the&nbsp;moment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5240625">return</span>&nbsp;<span class="ident" id="5240632">p</span><span class="op" id="5240633">.</span><span class="ident" id="5240634">buffer</span><span class="op" id="5240640">.</span><span class="ident" id="5240641">Read</span><span class="op" id="5240645">(</span><span class="ident" id="5240646">d</span><span class="op" id="5240647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5240650">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5240653">peek</span><span class="op" id="5240657">,</span>&nbsp;<span class="ident" id="5240659">err</span>&nbsp;<span class="op" id="5240663">:=</span>&nbsp;<span class="ident" id="5240666">p</span><span class="op" id="5240667">.</span><span class="ident" id="5240668">mr</span><span class="op" id="5240670">.</span><span class="ident" id="5240671">bufReader</span><span class="op" id="5240680">.</span><span class="ident" id="5240681">Peek</span><span class="op" id="5240685">(</span><span class="num" id="5240686">4096</span><span class="op" id="5240690">)</span>&nbsp;<span class="comment" id="5240692">//&nbsp;TODO(bradfitz):&nbsp;add&nbsp;buffer&nbsp;size&nbsp;accessor</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5240738">//&nbsp;Look&nbsp;for&nbsp;an&nbsp;immediate&nbsp;empty&nbsp;part&nbsp;without&nbsp;a&nbsp;leading&nbsp;\r\n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5240798">//&nbsp;before&nbsp;the&nbsp;boundary&nbsp;separator.&nbsp;&nbsp;Some&nbsp;MIME&nbsp;code&nbsp;makes&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5240861">//&nbsp;parts&nbsp;like&nbsp;this.&nbsp;Most&nbsp;browsers,&nbsp;however,&nbsp;write&nbsp;the&nbsp;\r\n</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5240921">//&nbsp;before&nbsp;the&nbsp;subsequent&nbsp;boundary&nbsp;even&nbsp;for&nbsp;empty&nbsp;parts&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5240981">//&nbsp;won&#39;t&nbsp;hit&nbsp;this&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241006">if</span>&nbsp;<span class="ident" id="5241009">p</span><span class="op" id="5241010">.</span><span class="ident" id="5241011">bytesRead</span>&nbsp;<span class="op" id="5241021">==</span>&nbsp;<span class="num" id="5241024">0</span>&nbsp;<span class="op" id="5241026">&amp;&amp;</span>&nbsp;<span class="ident" id="5241029">p</span><span class="op" id="5241030">.</span><span class="ident" id="5241031">mr</span><span class="op" id="5241033">.</span><span class="ident" id="5241034">peekBufferIsEmptyPart</span><span class="op" id="5241055">(</span><span class="ident" id="5241056">peek</span><span class="op" id="5241060">)</span>&nbsp;<span class="op" id="5241062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241066">return</span>&nbsp;<span class="num" id="5241073">0</span><span class="op" id="5241074">,</span>&nbsp;<span class="ident" id="5241076">io</span><span class="op" id="5241078">.</span><span class="ident" id="5241079">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5241084">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5241087">unexpectedEOF</span>&nbsp;<span class="op" id="5241101">:=</span>&nbsp;<span class="ident" id="5241104">err</span>&nbsp;<span class="op" id="5241108">==</span>&nbsp;<span class="ident" id="5241111">io</span><span class="op" id="5241113">.</span><span class="ident" id="5241114">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241119">if</span>&nbsp;<span class="ident" id="5241122">err</span>&nbsp;<span class="op" id="5241126">!=</span>&nbsp;<span class="ident" id="5241129">nil</span>&nbsp;<span class="op" id="5241133">&amp;&amp;</span>&nbsp;<span class="op" id="5241136">!</span><span class="ident" id="5241137">unexpectedEOF</span>&nbsp;<span class="op" id="5241151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241155">return</span>&nbsp;<span class="num" id="5241162">0</span><span class="op" id="5241163">,</span>&nbsp;<span class="ident" id="5241165">fmt</span><span class="op" id="5241168">.</span><span class="ident" id="5241169">Errorf</span><span class="op" id="5241175">(</span><span class="string" id="5241176">&#34;multipart:&nbsp;Part&nbsp;Read:&nbsp;%v&#34;</span><span class="op" id="5241202">,</span>&nbsp;<span class="ident" id="5241204">err</span><span class="op" id="5241207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5241210">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241213">if</span>&nbsp;<span class="ident" id="5241216">peek</span>&nbsp;<span class="op" id="5241221">==</span>&nbsp;<span class="ident" id="5241224">nil</span>&nbsp;<span class="op" id="5241228">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5241232">panic</span><span class="op" id="5241237">(</span><span class="string" id="5241238">&#34;nil&nbsp;peek&nbsp;buf&#34;</span><span class="op" id="5241252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5241255">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5241259">//&nbsp;Search&nbsp;the&nbsp;peek&nbsp;buffer&nbsp;for&nbsp;&#34;\r\n--boundary&#34;.&nbsp;If&nbsp;found,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5241318">//&nbsp;consume&nbsp;everything&nbsp;up&nbsp;to&nbsp;the&nbsp;boundary.&nbsp;If&nbsp;not,&nbsp;consume&nbsp;only</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5241382">//&nbsp;as&nbsp;much&nbsp;of&nbsp;the&nbsp;peek&nbsp;buffer&nbsp;as&nbsp;cannot&nbsp;hold&nbsp;the&nbsp;boundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5241441">//&nbsp;string.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5241453">nCopy</span>&nbsp;<span class="op" id="5241459">:=</span>&nbsp;<span class="num" id="5241462">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5241465">foundBoundary</span>&nbsp;<span class="op" id="5241479">:=</span>&nbsp;<span class="builtintype" id="5241482">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241489">if</span>&nbsp;<span class="ident" id="5241492">idx</span>&nbsp;<span class="op" id="5241496">:=</span>&nbsp;<span class="ident" id="5241499">bytes</span><span class="op" id="5241504">.</span><span class="ident" id="5241505">Index</span><span class="op" id="5241510">(</span><span class="ident" id="5241511">peek</span><span class="op" id="5241515">,</span>&nbsp;<span class="ident" id="5241517">p</span><span class="op" id="5241518">.</span><span class="ident" id="5241519">mr</span><span class="op" id="5241521">.</span><span class="ident" id="5241522">nlDashBoundary</span><span class="op" id="5241536">)</span><span class="op" id="5241537">;</span>&nbsp;<span class="ident" id="5241539">idx</span>&nbsp;<span class="op" id="5241543">!=</span>&nbsp;<span class="op" id="5241546">-</span><span class="num" id="5241547">1</span>&nbsp;<span class="op" id="5241549">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5241553">nCopy</span>&nbsp;<span class="op" id="5241559">=</span>&nbsp;<span class="ident" id="5241561">idx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5241567">foundBoundary</span>&nbsp;<span class="op" id="5241581">=</span>&nbsp;<span class="builtintype" id="5241583">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5241589">}</span>&nbsp;<span class="keyword" id="5241591">else</span>&nbsp;<span class="keyword" id="5241596">if</span>&nbsp;<span class="ident" id="5241599">safeCount</span>&nbsp;<span class="op" id="5241609">:=</span>&nbsp;<span class="builtinfunc" id="5241612">len</span><span class="op" id="5241615">(</span><span class="ident" id="5241616">peek</span><span class="op" id="5241620">)</span>&nbsp;<span class="op" id="5241622">-</span>&nbsp;<span class="builtinfunc" id="5241624">len</span><span class="op" id="5241627">(</span><span class="ident" id="5241628">p</span><span class="op" id="5241629">.</span><span class="ident" id="5241630">mr</span><span class="op" id="5241632">.</span><span class="ident" id="5241633">nlDashBoundary</span><span class="op" id="5241647">)</span><span class="op" id="5241648">;</span>&nbsp;<span class="ident" id="5241650">safeCount</span>&nbsp;<span class="op" id="5241660">&gt;</span>&nbsp;<span class="num" id="5241662">0</span>&nbsp;<span class="op" id="5241664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5241668">nCopy</span>&nbsp;<span class="op" id="5241674">=</span>&nbsp;<span class="ident" id="5241676">safeCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5241687">}</span>&nbsp;<span class="keyword" id="5241689">else</span>&nbsp;<span class="keyword" id="5241694">if</span>&nbsp;<span class="ident" id="5241697">unexpectedEOF</span>&nbsp;<span class="op" id="5241711">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5241715">//&nbsp;If&nbsp;we&#39;ve&nbsp;run&nbsp;out&nbsp;of&nbsp;peek&nbsp;buffer&nbsp;and&nbsp;the&nbsp;boundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5241769">//&nbsp;wasn&#39;t&nbsp;found&nbsp;(and&nbsp;can&#39;t&nbsp;possibly&nbsp;fit),&nbsp;we&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5241826">//&nbsp;hit&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;file&nbsp;unexpectedly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241869">return</span>&nbsp;<span class="num" id="5241876">0</span><span class="op" id="5241877">,</span>&nbsp;<span class="ident" id="5241879">io</span><span class="op" id="5241881">.</span><span class="ident" id="5241882">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5241900">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241903">if</span>&nbsp;<span class="ident" id="5241906">nCopy</span>&nbsp;<span class="op" id="5241912">&gt;</span>&nbsp;<span class="num" id="5241914">0</span>&nbsp;<span class="op" id="5241916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241920">if</span>&nbsp;<span class="ident" id="5241923">_</span><span class="op" id="5241924">,</span>&nbsp;<span class="ident" id="5241926">err</span>&nbsp;<span class="op" id="5241930">:=</span>&nbsp;<span class="ident" id="5241933">io</span><span class="op" id="5241935">.</span><span class="ident" id="5241936">CopyN</span><span class="op" id="5241941">(</span><span class="ident" id="5241942">p</span><span class="op" id="5241943">.</span><span class="ident" id="5241944">buffer</span><span class="op" id="5241950">,</span>&nbsp;<span class="ident" id="5241952">p</span><span class="op" id="5241953">.</span><span class="ident" id="5241954">mr</span><span class="op" id="5241956">.</span><span class="ident" id="5241957">bufReader</span><span class="op" id="5241966">,</span>&nbsp;<span class="ident" id="5241968">int64</span><span class="op" id="5241973">(</span><span class="ident" id="5241974">nCopy</span><span class="op" id="5241979">)</span><span class="op" id="5241980">)</span><span class="op" id="5241981">;</span>&nbsp;<span class="ident" id="5241983">err</span>&nbsp;<span class="op" id="5241987">!=</span>&nbsp;<span class="ident" id="5241990">nil</span>&nbsp;<span class="op" id="5241994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241999">return</span>&nbsp;<span class="num" id="5242006">0</span><span class="op" id="5242007">,</span>&nbsp;<span class="ident" id="5242009">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5242015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5242018">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5242021">n</span><span class="op" id="5242022">,</span>&nbsp;<span class="ident" id="5242024">err</span>&nbsp;<span class="op" id="5242028">=</span>&nbsp;<span class="ident" id="5242030">p</span><span class="op" id="5242031">.</span><span class="ident" id="5242032">buffer</span><span class="op" id="5242038">.</span><span class="ident" id="5242039">Read</span><span class="op" id="5242043">(</span><span class="ident" id="5242044">d</span><span class="op" id="5242045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5242048">if</span>&nbsp;<span class="ident" id="5242051">err</span>&nbsp;<span class="op" id="5242055">==</span>&nbsp;<span class="ident" id="5242058">io</span><span class="op" id="5242060">.</span><span class="ident" id="5242061">EOF</span>&nbsp;<span class="op" id="5242065">&amp;&amp;</span>&nbsp;<span class="op" id="5242068">!</span><span class="ident" id="5242069">foundBoundary</span>&nbsp;<span class="op" id="5242083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5242087">//&nbsp;If&nbsp;the&nbsp;boundary&nbsp;hasn&#39;t&nbsp;been&nbsp;reached&nbsp;there&#39;s&nbsp;more&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5242144">//&nbsp;read,&nbsp;so&nbsp;don&#39;t&nbsp;pass&nbsp;through&nbsp;an&nbsp;EOF&nbsp;from&nbsp;the&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5242200">err</span>&nbsp;<span class="op" id="5242204">=</span>&nbsp;<span class="ident" id="5242206">nil</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5242211">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5242214">return</span><br>
<span class="lineno"></span><span class="op" id="5242221">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5242224">func</span>&nbsp;<span class="op" id="5242229">(</span><span class="ident" id="5242230">p</span>&nbsp;<span class="op" id="5242232">*</span><span class="ident" id="5242233">Part</span><span class="op" id="5242237">)</span>&nbsp;<span class="ident" id="5242239">Close</span><span class="op" id="5242244">(</span><span class="op" id="5242245">)</span>&nbsp;<span class="builtintype" id="5242247">error</span>&nbsp;<span class="op" id="5242253">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5242256">io</span><span class="op" id="5242258">.</span><span class="ident" id="5242259">Copy</span><span class="op" id="5242263">(</span><span class="ident" id="5242264">ioutil</span><span class="op" id="5242270">.</span><span class="ident" id="5242271">Discard</span><span class="op" id="5242278">,</span>&nbsp;<span class="ident" id="5242280">p</span><span class="op" id="5242281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5242284">return</span>&nbsp;<span class="ident" id="5242291">nil</span><br>
<span class="lineno"></span><span class="op" id="5242295">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5242298">//&nbsp;Reader&nbsp;is&nbsp;an&nbsp;iterator&nbsp;over&nbsp;parts&nbsp;in&nbsp;a&nbsp;MIME&nbsp;multipart&nbsp;body.</span><br>
<span class="lineno">205</span><span class="comment" id="5242360">//&nbsp;Reader&#39;s&nbsp;underlying&nbsp;parser&nbsp;consumes&nbsp;its&nbsp;input&nbsp;as&nbsp;needed.&nbsp;&nbsp;Seeking</span><br>
<span class="lineno"></span><span class="comment" id="5242429">//&nbsp;isn&#39;t&nbsp;supported.</span><br>
<span class="lineno"></span><span class="keyword" id="5242449">type</span>&nbsp;<span class="ident" id="5242454">Reader</span>&nbsp;<span class="keyword" id="5242461">struct</span>&nbsp;<span class="op" id="5242468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5242471">bufReader</span>&nbsp;<span class="op" id="5242481">*</span><span class="ident" id="5242482">bufio</span><span class="op" id="5242487">.</span><span class="ident" id="5242488">Reader</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5242497">currentPart</span>&nbsp;<span class="op" id="5242509">*</span><span class="ident" id="5242510">Part</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5242516">partsRead</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5242528">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5242534">nl</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5242551">[</span><span class="op" id="5242552">]</span><span class="builtintype" id="5242553">byte</span>&nbsp;<span class="comment" id="5242558">//&nbsp;&#34;\r\n&#34;&nbsp;or&nbsp;&#34;\n&#34;&nbsp;(set&nbsp;after&nbsp;seeing&nbsp;first&nbsp;boundary&nbsp;line)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5242616">nlDashBoundary</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5242633">[</span><span class="op" id="5242634">]</span><span class="builtintype" id="5242635">byte</span>&nbsp;<span class="comment" id="5242640">//&nbsp;nl&nbsp;+&nbsp;&#34;--boundary&#34;</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5242662">dashBoundaryDash</span>&nbsp;<span class="op" id="5242679">[</span><span class="op" id="5242680">]</span><span class="builtintype" id="5242681">byte</span>&nbsp;<span class="comment" id="5242686">//&nbsp;&#34;--boundary--&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5242705">dashBoundary</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5242722">[</span><span class="op" id="5242723">]</span><span class="builtintype" id="5242724">byte</span>&nbsp;<span class="comment" id="5242729">//&nbsp;&#34;--boundary&#34;</span><br>
<span class="lineno"></span><span class="op" id="5242745">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5242748">//&nbsp;NextPart&nbsp;returns&nbsp;the&nbsp;next&nbsp;part&nbsp;in&nbsp;the&nbsp;multipart&nbsp;or&nbsp;an&nbsp;error.</span><br>
<span class="lineno">220</span><span class="comment" id="5242812">//&nbsp;When&nbsp;there&nbsp;are&nbsp;no&nbsp;more&nbsp;parts,&nbsp;the&nbsp;error&nbsp;io.EOF&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="5242875">func</span>&nbsp;<span class="op" id="5242880">(</span><span class="ident" id="5242881">r</span>&nbsp;<span class="op" id="5242883">*</span><span class="ident" id="5242884">Reader</span><span class="op" id="5242890">)</span>&nbsp;<span class="ident" id="5242892">NextPart</span><span class="op" id="5242900">(</span><span class="op" id="5242901">)</span>&nbsp;<span class="op" id="5242903">(</span><span class="op" id="5242904">*</span><span class="ident" id="5242905">Part</span><span class="op" id="5242909">,</span>&nbsp;<span class="builtintype" id="5242911">error</span><span class="op" id="5242916">)</span>&nbsp;<span class="op" id="5242918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5242921">if</span>&nbsp;<span class="ident" id="5242924">r</span><span class="op" id="5242925">.</span><span class="ident" id="5242926">currentPart</span>&nbsp;<span class="op" id="5242938">!=</span>&nbsp;<span class="ident" id="5242941">nil</span>&nbsp;<span class="op" id="5242945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5242949">r</span><span class="op" id="5242950">.</span><span class="ident" id="5242951">currentPart</span><span class="op" id="5242962">.</span><span class="ident" id="5242963">Close</span><span class="op" id="5242968">(</span><span class="op" id="5242969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5242972">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5242976">expectNewPart</span>&nbsp;<span class="op" id="5242990">:=</span>&nbsp;<span class="builtintype" id="5242993">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5243000">for</span>&nbsp;<span class="op" id="5243004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5243008">line</span><span class="op" id="5243012">,</span>&nbsp;<span class="ident" id="5243014">err</span>&nbsp;<span class="op" id="5243018">:=</span>&nbsp;<span class="ident" id="5243021">r</span><span class="op" id="5243022">.</span><span class="ident" id="5243023">bufReader</span><span class="op" id="5243032">.</span><span class="ident" id="5243033">ReadSlice</span><span class="op" id="5243042">(</span><span class="string" id="5243043">&#39;\n&#39;</span><span class="op" id="5243047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5243051">if</span>&nbsp;<span class="ident" id="5243054">err</span>&nbsp;<span class="op" id="5243058">==</span>&nbsp;<span class="ident" id="5243061">io</span><span class="op" id="5243063">.</span><span class="ident" id="5243064">EOF</span>&nbsp;<span class="op" id="5243068">&amp;&amp;</span>&nbsp;<span class="ident" id="5243071">r</span><span class="op" id="5243072">.</span><span class="ident" id="5243073">isFinalBoundary</span><span class="op" id="5243088">(</span><span class="ident" id="5243089">line</span><span class="op" id="5243093">)</span>&nbsp;<span class="op" id="5243095">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5243100">//&nbsp;If&nbsp;the&nbsp;buffer&nbsp;ends&nbsp;in&nbsp;&#34;--boundary--&#34;&nbsp;without&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5243155">//&nbsp;trailing&nbsp;&#34;\r\n&#34;,&nbsp;ReadSlice&nbsp;will&nbsp;return&nbsp;an&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5243209">//&nbsp;(since&nbsp;it&#39;s&nbsp;missing&nbsp;the&nbsp;&#39;\n&#39;),&nbsp;but&nbsp;this&nbsp;is&nbsp;a&nbsp;valid</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5243266">//&nbsp;multipart&nbsp;EOF&nbsp;so&nbsp;we&nbsp;need&nbsp;to&nbsp;return&nbsp;io.EOF&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5243325">//&nbsp;a&nbsp;fmt-wrapped&nbsp;one.</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5243350">return</span>&nbsp;<span class="ident" id="5243357">nil</span><span class="op" id="5243360">,</span>&nbsp;<span class="ident" id="5243362">io</span><span class="op" id="5243364">.</span><span class="ident" id="5243365">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5243371">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5243375">if</span>&nbsp;<span class="ident" id="5243378">err</span>&nbsp;<span class="op" id="5243382">!=</span>&nbsp;<span class="ident" id="5243385">nil</span>&nbsp;<span class="op" id="5243389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5243394">return</span>&nbsp;<span class="ident" id="5243401">nil</span><span class="op" id="5243404">,</span>&nbsp;<span class="ident" id="5243406">fmt</span><span class="op" id="5243409">.</span><span class="ident" id="5243410">Errorf</span><span class="op" id="5243416">(</span><span class="string" id="5243417">&#34;multipart:&nbsp;NextPart:&nbsp;%v&#34;</span><span class="op" id="5243442">,</span>&nbsp;<span class="ident" id="5243444">err</span><span class="op" id="5243447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5243451">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5243456">if</span>&nbsp;<span class="ident" id="5243459">r</span><span class="op" id="5243460">.</span><span class="ident" id="5243461">isBoundaryDelimiterLine</span><span class="op" id="5243484">(</span><span class="ident" id="5243485">line</span><span class="op" id="5243489">)</span>&nbsp;<span class="op" id="5243491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5243496">r</span><span class="op" id="5243497">.</span><span class="ident" id="5243498">partsRead</span><span class="op" id="5243507">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5243513">bp</span><span class="op" id="5243515">,</span>&nbsp;<span class="ident" id="5243517">err</span>&nbsp;<span class="op" id="5243521">:=</span>&nbsp;<span class="ident" id="5243524">newPart</span><span class="op" id="5243531">(</span><span class="ident" id="5243532">r</span><span class="op" id="5243533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5243538">if</span>&nbsp;<span class="ident" id="5243541">err</span>&nbsp;<span class="op" id="5243545">!=</span>&nbsp;<span class="ident" id="5243548">nil</span>&nbsp;<span class="op" id="5243552">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5243558">return</span>&nbsp;<span class="ident" id="5243565">nil</span><span class="op" id="5243568">,</span>&nbsp;<span class="ident" id="5243570">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5243577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5243582">r</span><span class="op" id="5243583">.</span><span class="ident" id="5243584">currentPart</span>&nbsp;<span class="op" id="5243596">=</span>&nbsp;<span class="ident" id="5243598">bp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5243604">return</span>&nbsp;<span class="ident" id="5243611">bp</span><span class="op" id="5243613">,</span>&nbsp;<span class="ident" id="5243615">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5243621">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5243626">if</span>&nbsp;<span class="ident" id="5243629">r</span><span class="op" id="5243630">.</span><span class="ident" id="5243631">isFinalBoundary</span><span class="op" id="5243646">(</span><span class="ident" id="5243647">line</span><span class="op" id="5243651">)</span>&nbsp;<span class="op" id="5243653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5243658">//&nbsp;Expected&nbsp;EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5243677">return</span>&nbsp;<span class="ident" id="5243684">nil</span><span class="op" id="5243687">,</span>&nbsp;<span class="ident" id="5243689">io</span><span class="op" id="5243691">.</span><span class="ident" id="5243692">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5243698">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5243703">if</span>&nbsp;<span class="ident" id="5243706">expectNewPart</span>&nbsp;<span class="op" id="5243720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5243725">return</span>&nbsp;<span class="ident" id="5243732">nil</span><span class="op" id="5243735">,</span>&nbsp;<span class="ident" id="5243737">fmt</span><span class="op" id="5243740">.</span><span class="ident" id="5243741">Errorf</span><span class="op" id="5243747">(</span><span class="string" id="5243748">&#34;multipart:&nbsp;expecting&nbsp;a&nbsp;new&nbsp;Part;&nbsp;got&nbsp;line&nbsp;%q&#34;</span><span class="op" id="5243794">,</span>&nbsp;<span class="builtintype" id="5243796">string</span><span class="op" id="5243802">(</span><span class="ident" id="5243803">line</span><span class="op" id="5243807">)</span><span class="op" id="5243808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5243812">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5243817">if</span>&nbsp;<span class="ident" id="5243820">r</span><span class="op" id="5243821">.</span><span class="ident" id="5243822">partsRead</span>&nbsp;<span class="op" id="5243832">==</span>&nbsp;<span class="num" id="5243835">0</span>&nbsp;<span class="op" id="5243837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5243842">//&nbsp;skip&nbsp;line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5243858">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5243869">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5243874">//&nbsp;Consume&nbsp;the&nbsp;&#34;\n&#34;&nbsp;or&nbsp;&#34;\r\n&#34;&nbsp;separator&nbsp;between&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5243928">//&nbsp;body&nbsp;of&nbsp;the&nbsp;previous&nbsp;part&nbsp;and&nbsp;the&nbsp;boundary&nbsp;line&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5243984">//&nbsp;now&nbsp;expect&nbsp;will&nbsp;follow.&nbsp;(either&nbsp;a&nbsp;new&nbsp;part&nbsp;or&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5244039">//&nbsp;end&nbsp;boundary)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5244058">if</span>&nbsp;<span class="ident" id="5244061">bytes</span><span class="op" id="5244066">.</span><span class="ident" id="5244067">Equal</span><span class="op" id="5244072">(</span><span class="ident" id="5244073">line</span><span class="op" id="5244077">,</span>&nbsp;<span class="ident" id="5244079">r</span><span class="op" id="5244080">.</span><span class="ident" id="5244081">nl</span><span class="op" id="5244083">)</span>&nbsp;<span class="op" id="5244085">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5244090">expectNewPart</span>&nbsp;<span class="op" id="5244104">=</span>&nbsp;<span class="builtintype" id="5244106">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5244114">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5244125">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5244130">return</span>&nbsp;<span class="ident" id="5244137">nil</span><span class="op" id="5244140">,</span>&nbsp;<span class="ident" id="5244142">fmt</span><span class="op" id="5244145">.</span><span class="ident" id="5244146">Errorf</span><span class="op" id="5244152">(</span><span class="string" id="5244153">&#34;multipart:&nbsp;unexpected&nbsp;line&nbsp;in&nbsp;Next():&nbsp;%q&#34;</span><span class="op" id="5244195">,</span>&nbsp;<span class="ident" id="5244197">line</span><span class="op" id="5244201">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5244204">}</span><br>
<span class="lineno"></span><span class="op" id="5244206">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5244209">//&nbsp;isFinalBoundary&nbsp;reports&nbsp;whether&nbsp;line&nbsp;is&nbsp;the&nbsp;final&nbsp;boundary&nbsp;line</span><br>
<span class="lineno"></span><span class="comment" id="5244276">//&nbsp;indicating&nbsp;that&nbsp;all&nbsp;parts&nbsp;are&nbsp;over.</span><br>
<span class="lineno">280</span><span class="comment" id="5244315">//&nbsp;It&nbsp;matches&nbsp;`^--boundary--[&nbsp;\t]*(\r\n)?$`</span><br>
<span class="lineno"></span><span class="keyword" id="5244359">func</span>&nbsp;<span class="op" id="5244364">(</span><span class="ident" id="5244365">mr</span>&nbsp;<span class="op" id="5244368">*</span><span class="ident" id="5244369">Reader</span><span class="op" id="5244375">)</span>&nbsp;<span class="ident" id="5244377">isFinalBoundary</span><span class="op" id="5244392">(</span><span class="ident" id="5244393">line</span>&nbsp;<span class="op" id="5244398">[</span><span class="op" id="5244399">]</span><span class="builtintype" id="5244400">byte</span><span class="op" id="5244404">)</span>&nbsp;<span class="builtintype" id="5244406">bool</span>&nbsp;<span class="op" id="5244411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5244414">if</span>&nbsp;<span class="op" id="5244417">!</span><span class="ident" id="5244418">bytes</span><span class="op" id="5244423">.</span><span class="ident" id="5244424">HasPrefix</span><span class="op" id="5244433">(</span><span class="ident" id="5244434">line</span><span class="op" id="5244438">,</span>&nbsp;<span class="ident" id="5244440">mr</span><span class="op" id="5244442">.</span><span class="ident" id="5244443">dashBoundaryDash</span><span class="op" id="5244459">)</span>&nbsp;<span class="op" id="5244461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5244465">return</span>&nbsp;<span class="builtintype" id="5244472">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5244479">}</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5244482">rest</span>&nbsp;<span class="op" id="5244487">:=</span>&nbsp;<span class="ident" id="5244490">line</span><span class="op" id="5244494">[</span><span class="builtinfunc" id="5244495">len</span><span class="op" id="5244498">(</span><span class="ident" id="5244499">mr</span><span class="op" id="5244501">.</span><span class="ident" id="5244502">dashBoundaryDash</span><span class="op" id="5244518">)</span><span class="op" id="5244519">:</span><span class="op" id="5244520">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5244523">rest</span>&nbsp;<span class="op" id="5244528">=</span>&nbsp;<span class="ident" id="5244530">skipLWSPChar</span><span class="op" id="5244542">(</span><span class="ident" id="5244543">rest</span><span class="op" id="5244547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5244550">return</span>&nbsp;<span class="builtinfunc" id="5244557">len</span><span class="op" id="5244560">(</span><span class="ident" id="5244561">rest</span><span class="op" id="5244565">)</span>&nbsp;<span class="op" id="5244567">==</span>&nbsp;<span class="num" id="5244570">0</span>&nbsp;<span class="op" id="5244572">||</span>&nbsp;<span class="ident" id="5244575">bytes</span><span class="op" id="5244580">.</span><span class="ident" id="5244581">Equal</span><span class="op" id="5244586">(</span><span class="ident" id="5244587">rest</span><span class="op" id="5244591">,</span>&nbsp;<span class="ident" id="5244593">mr</span><span class="op" id="5244595">.</span><span class="ident" id="5244596">nl</span><span class="op" id="5244598">)</span><br>
<span class="lineno"></span><span class="op" id="5244600">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span><span class="keyword" id="5244603">func</span>&nbsp;<span class="op" id="5244608">(</span><span class="ident" id="5244609">mr</span>&nbsp;<span class="op" id="5244612">*</span><span class="ident" id="5244613">Reader</span><span class="op" id="5244619">)</span>&nbsp;<span class="ident" id="5244621">isBoundaryDelimiterLine</span><span class="op" id="5244644">(</span><span class="ident" id="5244645">line</span>&nbsp;<span class="op" id="5244650">[</span><span class="op" id="5244651">]</span><span class="builtintype" id="5244652">byte</span><span class="op" id="5244656">)</span>&nbsp;<span class="op" id="5244658">(</span><span class="ident" id="5244659">ret</span>&nbsp;<span class="builtintype" id="5244663">bool</span><span class="op" id="5244667">)</span>&nbsp;<span class="op" id="5244669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5244672">//&nbsp;http://tools.ietf.org/html/rfc2046#section-5.1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5244723">//&nbsp;&nbsp;&nbsp;The&nbsp;boundary&nbsp;delimiter&nbsp;line&nbsp;is&nbsp;then&nbsp;defined&nbsp;as&nbsp;a&nbsp;line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5244783">//&nbsp;&nbsp;&nbsp;consisting&nbsp;entirely&nbsp;of&nbsp;two&nbsp;hyphen&nbsp;characters&nbsp;(&#34;-&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5244840">//&nbsp;&nbsp;&nbsp;decimal&nbsp;value&nbsp;45)&nbsp;followed&nbsp;by&nbsp;the&nbsp;boundary&nbsp;parameter</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5244899">//&nbsp;&nbsp;&nbsp;value&nbsp;from&nbsp;the&nbsp;Content-Type&nbsp;header&nbsp;field,&nbsp;optional&nbsp;linear</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5244963">//&nbsp;&nbsp;&nbsp;whitespace,&nbsp;and&nbsp;a&nbsp;terminating&nbsp;CRLF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5245005">if</span>&nbsp;<span class="op" id="5245008">!</span><span class="ident" id="5245009">bytes</span><span class="op" id="5245014">.</span><span class="ident" id="5245015">HasPrefix</span><span class="op" id="5245024">(</span><span class="ident" id="5245025">line</span><span class="op" id="5245029">,</span>&nbsp;<span class="ident" id="5245031">mr</span><span class="op" id="5245033">.</span><span class="ident" id="5245034">dashBoundary</span><span class="op" id="5245046">)</span>&nbsp;<span class="op" id="5245048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5245052">return</span>&nbsp;<span class="builtintype" id="5245059">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5245066">}</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5245069">rest</span>&nbsp;<span class="op" id="5245074">:=</span>&nbsp;<span class="ident" id="5245077">line</span><span class="op" id="5245081">[</span><span class="builtinfunc" id="5245082">len</span><span class="op" id="5245085">(</span><span class="ident" id="5245086">mr</span><span class="op" id="5245088">.</span><span class="ident" id="5245089">dashBoundary</span><span class="op" id="5245101">)</span><span class="op" id="5245102">:</span><span class="op" id="5245103">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5245106">rest</span>&nbsp;<span class="op" id="5245111">=</span>&nbsp;<span class="ident" id="5245113">skipLWSPChar</span><span class="op" id="5245125">(</span><span class="ident" id="5245126">rest</span><span class="op" id="5245130">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5245134">//&nbsp;On&nbsp;the&nbsp;first&nbsp;part,&nbsp;see&nbsp;our&nbsp;lines&nbsp;are&nbsp;ending&nbsp;in&nbsp;\n&nbsp;instead&nbsp;of&nbsp;\r\n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5245204">//&nbsp;and&nbsp;switch&nbsp;into&nbsp;that&nbsp;mode&nbsp;if&nbsp;so.&nbsp;&nbsp;This&nbsp;is&nbsp;a&nbsp;violation&nbsp;of&nbsp;the&nbsp;spec,</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5245275">//&nbsp;but&nbsp;occurs&nbsp;in&nbsp;practice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5245303">if</span>&nbsp;<span class="ident" id="5245306">mr</span><span class="op" id="5245308">.</span><span class="ident" id="5245309">partsRead</span>&nbsp;<span class="op" id="5245319">==</span>&nbsp;<span class="num" id="5245322">0</span>&nbsp;<span class="op" id="5245324">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5245327">len</span><span class="op" id="5245330">(</span><span class="ident" id="5245331">rest</span><span class="op" id="5245335">)</span>&nbsp;<span class="op" id="5245337">==</span>&nbsp;<span class="num" id="5245340">1</span>&nbsp;<span class="op" id="5245342">&amp;&amp;</span>&nbsp;<span class="ident" id="5245345">rest</span><span class="op" id="5245349">[</span><span class="num" id="5245350">0</span><span class="op" id="5245351">]</span>&nbsp;<span class="op" id="5245353">==</span>&nbsp;<span class="string" id="5245356">&#39;\n&#39;</span>&nbsp;<span class="op" id="5245361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5245365">mr</span><span class="op" id="5245367">.</span><span class="ident" id="5245368">nl</span>&nbsp;<span class="op" id="5245371">=</span>&nbsp;<span class="ident" id="5245373">mr</span><span class="op" id="5245375">.</span><span class="ident" id="5245376">nl</span><span class="op" id="5245378">[</span><span class="num" id="5245379">1</span><span class="op" id="5245380">:</span><span class="op" id="5245381">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5245385">mr</span><span class="op" id="5245387">.</span><span class="ident" id="5245388">nlDashBoundary</span>&nbsp;<span class="op" id="5245403">=</span>&nbsp;<span class="ident" id="5245405">mr</span><span class="op" id="5245407">.</span><span class="ident" id="5245408">nlDashBoundary</span><span class="op" id="5245422">[</span><span class="num" id="5245423">1</span><span class="op" id="5245424">:</span><span class="op" id="5245425">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5245428">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5245431">return</span>&nbsp;<span class="ident" id="5245438">bytes</span><span class="op" id="5245443">.</span><span class="ident" id="5245444">Equal</span><span class="op" id="5245449">(</span><span class="ident" id="5245450">rest</span><span class="op" id="5245454">,</span>&nbsp;<span class="ident" id="5245456">mr</span><span class="op" id="5245458">.</span><span class="ident" id="5245459">nl</span><span class="op" id="5245461">)</span><br>
<span class="lineno"></span><span class="op" id="5245463">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5245466">//&nbsp;peekBufferIsEmptyPart&nbsp;reports&nbsp;whether&nbsp;the&nbsp;provided&nbsp;peek-ahead</span><br>
<span class="lineno"></span><span class="comment" id="5245531">//&nbsp;buffer&nbsp;represents&nbsp;an&nbsp;empty&nbsp;part.&nbsp;It&nbsp;is&nbsp;called&nbsp;only&nbsp;if&nbsp;we&#39;ve&nbsp;not</span><br>
<span class="lineno">315</span><span class="comment" id="5245598">//&nbsp;already&nbsp;read&nbsp;any&nbsp;bytes&nbsp;in&nbsp;this&nbsp;part&nbsp;and&nbsp;checks&nbsp;for&nbsp;the&nbsp;case&nbsp;of&nbsp;MIME</span><br>
<span class="lineno"></span><span class="comment" id="5245669">//&nbsp;software&nbsp;not&nbsp;writing&nbsp;the&nbsp;\r\n&nbsp;on&nbsp;empty&nbsp;parts.&nbsp;Some&nbsp;does,&nbsp;some</span><br>
<span class="lineno"></span><span class="comment" id="5245734">//&nbsp;doesn&#39;t.</span><br>
<span class="lineno"></span><span class="comment" id="5245746">//</span><br>
<span class="lineno"></span><span class="comment" id="5245749">//&nbsp;This&nbsp;checks&nbsp;that&nbsp;what&nbsp;follows&nbsp;the&nbsp;&#34;--boundary&#34;&nbsp;is&nbsp;actually&nbsp;the&nbsp;end</span><br>
<span class="lineno">320</span><span class="comment" id="5245819">//&nbsp;(&#34;--boundary--&#34;&nbsp;with&nbsp;optional&nbsp;whitespace)&nbsp;or&nbsp;optional&nbsp;whitespace</span><br>
<span class="lineno"></span><span class="comment" id="5245887">//&nbsp;and&nbsp;then&nbsp;a&nbsp;newline,&nbsp;so&nbsp;we&nbsp;don&#39;t&nbsp;catch&nbsp;&#34;--boundaryFAKE&#34;,&nbsp;in&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="5245955">//&nbsp;case&nbsp;the&nbsp;whole&nbsp;line&nbsp;is&nbsp;part&nbsp;of&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="5245999">func</span>&nbsp;<span class="op" id="5246004">(</span><span class="ident" id="5246005">mr</span>&nbsp;<span class="op" id="5246008">*</span><span class="ident" id="5246009">Reader</span><span class="op" id="5246015">)</span>&nbsp;<span class="ident" id="5246017">peekBufferIsEmptyPart</span><span class="op" id="5246038">(</span><span class="ident" id="5246039">peek</span>&nbsp;<span class="op" id="5246044">[</span><span class="op" id="5246045">]</span><span class="builtintype" id="5246046">byte</span><span class="op" id="5246050">)</span>&nbsp;<span class="builtintype" id="5246052">bool</span>&nbsp;<span class="op" id="5246057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5246060">//&nbsp;End&nbsp;of&nbsp;parts&nbsp;case.</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5246083">//&nbsp;Test&nbsp;whether&nbsp;peek&nbsp;matches&nbsp;`^--boundary--[&nbsp;\t]*(?:\r\n|$)`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5246145">if</span>&nbsp;<span class="ident" id="5246148">bytes</span><span class="op" id="5246153">.</span><span class="ident" id="5246154">HasPrefix</span><span class="op" id="5246163">(</span><span class="ident" id="5246164">peek</span><span class="op" id="5246168">,</span>&nbsp;<span class="ident" id="5246170">mr</span><span class="op" id="5246172">.</span><span class="ident" id="5246173">dashBoundaryDash</span><span class="op" id="5246189">)</span>&nbsp;<span class="op" id="5246191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5246195">rest</span>&nbsp;<span class="op" id="5246200">:=</span>&nbsp;<span class="ident" id="5246203">peek</span><span class="op" id="5246207">[</span><span class="builtinfunc" id="5246208">len</span><span class="op" id="5246211">(</span><span class="ident" id="5246212">mr</span><span class="op" id="5246214">.</span><span class="ident" id="5246215">dashBoundaryDash</span><span class="op" id="5246231">)</span><span class="op" id="5246232">:</span><span class="op" id="5246233">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5246237">rest</span>&nbsp;<span class="op" id="5246242">=</span>&nbsp;<span class="ident" id="5246244">skipLWSPChar</span><span class="op" id="5246256">(</span><span class="ident" id="5246257">rest</span><span class="op" id="5246261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5246265">return</span>&nbsp;<span class="ident" id="5246272">bytes</span><span class="op" id="5246277">.</span><span class="ident" id="5246278">HasPrefix</span><span class="op" id="5246287">(</span><span class="ident" id="5246288">rest</span><span class="op" id="5246292">,</span>&nbsp;<span class="ident" id="5246294">mr</span><span class="op" id="5246296">.</span><span class="ident" id="5246297">nl</span><span class="op" id="5246299">)</span>&nbsp;<span class="op" id="5246301">||</span>&nbsp;<span class="builtinfunc" id="5246304">len</span><span class="op" id="5246307">(</span><span class="ident" id="5246308">rest</span><span class="op" id="5246312">)</span>&nbsp;<span class="op" id="5246314">==</span>&nbsp;<span class="num" id="5246317">0</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5246320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5246323">if</span>&nbsp;<span class="op" id="5246326">!</span><span class="ident" id="5246327">bytes</span><span class="op" id="5246332">.</span><span class="ident" id="5246333">HasPrefix</span><span class="op" id="5246342">(</span><span class="ident" id="5246343">peek</span><span class="op" id="5246347">,</span>&nbsp;<span class="ident" id="5246349">mr</span><span class="op" id="5246351">.</span><span class="ident" id="5246352">dashBoundary</span><span class="op" id="5246364">)</span>&nbsp;<span class="op" id="5246366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5246370">return</span>&nbsp;<span class="builtintype" id="5246377">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5246384">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5246387">//&nbsp;Test&nbsp;whether&nbsp;rest&nbsp;matches&nbsp;`^[&nbsp;\t]*\r\n`)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5246432">rest</span>&nbsp;<span class="op" id="5246437">:=</span>&nbsp;<span class="ident" id="5246440">peek</span><span class="op" id="5246444">[</span><span class="builtinfunc" id="5246445">len</span><span class="op" id="5246448">(</span><span class="ident" id="5246449">mr</span><span class="op" id="5246451">.</span><span class="ident" id="5246452">dashBoundary</span><span class="op" id="5246464">)</span><span class="op" id="5246465">:</span><span class="op" id="5246466">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5246469">rest</span>&nbsp;<span class="op" id="5246474">=</span>&nbsp;<span class="ident" id="5246476">skipLWSPChar</span><span class="op" id="5246488">(</span><span class="ident" id="5246489">rest</span><span class="op" id="5246493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5246496">return</span>&nbsp;<span class="ident" id="5246503">bytes</span><span class="op" id="5246508">.</span><span class="ident" id="5246509">HasPrefix</span><span class="op" id="5246518">(</span><span class="ident" id="5246519">rest</span><span class="op" id="5246523">,</span>&nbsp;<span class="ident" id="5246525">mr</span><span class="op" id="5246527">.</span><span class="ident" id="5246528">nl</span><span class="op" id="5246530">)</span><br>
<span class="lineno"></span><span class="op" id="5246532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span><span class="comment" id="5246535">//&nbsp;skipLWSPChar&nbsp;returns&nbsp;b&nbsp;with&nbsp;leading&nbsp;spaces&nbsp;and&nbsp;tabs&nbsp;removed.</span><br>
<span class="lineno"></span><span class="comment" id="5246599">//&nbsp;RFC&nbsp;822&nbsp;defines:</span><br>
<span class="lineno"></span><span class="comment" id="5246619">//&nbsp;&nbsp;&nbsp;&nbsp;LWSP-char&nbsp;=&nbsp;SPACE&nbsp;/&nbsp;HTAB</span><br>
<span class="lineno"></span><span class="keyword" id="5246650">func</span>&nbsp;<span class="ident" id="5246655">skipLWSPChar</span><span class="op" id="5246667">(</span><span class="ident" id="5246668">b</span>&nbsp;<span class="op" id="5246670">[</span><span class="op" id="5246671">]</span><span class="builtintype" id="5246672">byte</span><span class="op" id="5246676">)</span>&nbsp;<span class="op" id="5246678">[</span><span class="op" id="5246679">]</span><span class="builtintype" id="5246680">byte</span>&nbsp;<span class="op" id="5246685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5246688">for</span>&nbsp;<span class="builtinfunc" id="5246692">len</span><span class="op" id="5246695">(</span><span class="ident" id="5246696">b</span><span class="op" id="5246697">)</span>&nbsp;<span class="op" id="5246699">&gt;</span>&nbsp;<span class="num" id="5246701">0</span>&nbsp;<span class="op" id="5246703">&amp;&amp;</span>&nbsp;<span class="op" id="5246706">(</span><span class="ident" id="5246707">b</span><span class="op" id="5246708">[</span><span class="num" id="5246709">0</span><span class="op" id="5246710">]</span>&nbsp;<span class="op" id="5246712">==</span>&nbsp;<span class="string" id="5246715">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="5246719">||</span>&nbsp;<span class="ident" id="5246722">b</span><span class="op" id="5246723">[</span><span class="num" id="5246724">0</span><span class="op" id="5246725">]</span>&nbsp;<span class="op" id="5246727">==</span>&nbsp;<span class="string" id="5246730">&#39;\t&#39;</span><span class="op" id="5246734">)</span>&nbsp;<span class="op" id="5246736">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5246740">b</span>&nbsp;<span class="op" id="5246742">=</span>&nbsp;<span class="ident" id="5246744">b</span><span class="op" id="5246745">[</span><span class="num" id="5246746">1</span><span class="op" id="5246747">:</span><span class="op" id="5246748">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5246751">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5246754">return</span>&nbsp;<span class="ident" id="5246761">b</span><br>
<span class="lineno"></span><span class="op" id="5246763">}</span>
</div>
</body>
</html>
