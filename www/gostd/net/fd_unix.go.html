<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html" class="current">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3891985">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3892040">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3892094">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3892145">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3892215">package</span>&nbsp;<span class="ident" id="3892223">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3892228">import</span>&nbsp;<span class="op" id="3892235">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3892238">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3892244">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3892250">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3892261">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3892276">&#34;syscall&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3892287">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3892294">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3892297">//&nbsp;Network&nbsp;file&nbsp;descriptor.</span><br>
<span class="lineno"></span><span class="keyword" id="3892325">type</span>&nbsp;<span class="ident" id="3892330">netFD</span>&nbsp;<span class="keyword" id="3892336">struct</span>&nbsp;<span class="op" id="3892343">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3892346">//&nbsp;locking/lifetime&nbsp;of&nbsp;sysfd&nbsp;+&nbsp;serialize&nbsp;access&nbsp;to&nbsp;Read&nbsp;and&nbsp;Write&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3892421">fdmu</span>&nbsp;<span class="ident" id="3892426">fdMutex</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3892436">//&nbsp;immutable&nbsp;until&nbsp;Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3892462">sysfd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3892474">int</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3892479">family</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3892491">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3892496">sotype</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3892508">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3892513">isConnected</span>&nbsp;<span class="builtintype" id="3892525">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3892531">net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3892543">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3892551">laddr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3892563">Addr</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3892569">raddr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3892581">Addr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3892588">//&nbsp;wait&nbsp;server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3892604">pd</span>&nbsp;<span class="ident" id="3892607">pollDesc</span><br>
<span class="lineno"></span><span class="op" id="3892616">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="3892619">func</span>&nbsp;<span class="ident" id="3892624">sysInit</span><span class="op" id="3892631">(</span><span class="op" id="3892632">)</span>&nbsp;<span class="op" id="3892634">{</span><br>
<span class="lineno"></span><span class="op" id="3892636">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3892639">func</span>&nbsp;<span class="ident" id="3892644">dial</span><span class="op" id="3892648">(</span><span class="ident" id="3892649">network</span>&nbsp;<span class="builtintype" id="3892657">string</span><span class="op" id="3892663">,</span>&nbsp;<span class="ident" id="3892665">ra</span>&nbsp;<span class="ident" id="3892668">Addr</span><span class="op" id="3892672">,</span>&nbsp;<span class="ident" id="3892674">dialer</span>&nbsp;<span class="keyword" id="3892681">func</span><span class="op" id="3892685">(</span><span class="ident" id="3892686">time</span><span class="op" id="3892690">.</span><span class="ident" id="3892691">Time</span><span class="op" id="3892695">)</span>&nbsp;<span class="op" id="3892697">(</span><span class="ident" id="3892698">Conn</span><span class="op" id="3892702">,</span>&nbsp;<span class="builtintype" id="3892704">error</span><span class="op" id="3892709">)</span><span class="op" id="3892710">,</span>&nbsp;<span class="ident" id="3892712">deadline</span>&nbsp;<span class="ident" id="3892721">time</span><span class="op" id="3892725">.</span><span class="ident" id="3892726">Time</span><span class="op" id="3892730">)</span>&nbsp;<span class="op" id="3892732">(</span><span class="ident" id="3892733">Conn</span><span class="op" id="3892737">,</span>&nbsp;<span class="builtintype" id="3892739">error</span><span class="op" id="3892744">)</span>&nbsp;<span class="op" id="3892746">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3892749">return</span>&nbsp;<span class="ident" id="3892756">dialer</span><span class="op" id="3892762">(</span><span class="ident" id="3892763">deadline</span><span class="op" id="3892771">)</span><br>
<span class="lineno"></span><span class="op" id="3892773">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3892776">func</span>&nbsp;<span class="ident" id="3892781">newFD</span><span class="op" id="3892786">(</span><span class="ident" id="3892787">sysfd</span><span class="op" id="3892792">,</span>&nbsp;<span class="ident" id="3892794">family</span><span class="op" id="3892800">,</span>&nbsp;<span class="ident" id="3892802">sotype</span>&nbsp;<span class="builtintype" id="3892809">int</span><span class="op" id="3892812">,</span>&nbsp;<span class="ident" id="3892814">net</span>&nbsp;<span class="builtintype" id="3892818">string</span><span class="op" id="3892824">)</span>&nbsp;<span class="op" id="3892826">(</span><span class="op" id="3892827">*</span><span class="ident" id="3892828">netFD</span><span class="op" id="3892833">,</span>&nbsp;<span class="builtintype" id="3892835">error</span><span class="op" id="3892840">)</span>&nbsp;<span class="op" id="3892842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3892845">return</span>&nbsp;<span class="op" id="3892852">&amp;</span><span class="ident" id="3892853">netFD</span><span class="op" id="3892858">{</span><span class="ident" id="3892859">sysfd</span><span class="op" id="3892864">:</span>&nbsp;<span class="ident" id="3892866">sysfd</span><span class="op" id="3892871">,</span>&nbsp;<span class="ident" id="3892873">family</span><span class="op" id="3892879">:</span>&nbsp;<span class="ident" id="3892881">family</span><span class="op" id="3892887">,</span>&nbsp;<span class="ident" id="3892889">sotype</span><span class="op" id="3892895">:</span>&nbsp;<span class="ident" id="3892897">sotype</span><span class="op" id="3892903">,</span>&nbsp;<span class="ident" id="3892905">net</span><span class="op" id="3892908">:</span>&nbsp;<span class="ident" id="3892910">net</span><span class="op" id="3892913">}</span><span class="op" id="3892914">,</span>&nbsp;<span class="builtintype" id="3892916">nil</span><br>
<span class="lineno">45</span><span class="op" id="3892920">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3892923">func</span>&nbsp;<span class="op" id="3892928">(</span><span class="ident" id="3892929">fd</span>&nbsp;<span class="op" id="3892932">*</span><span class="ident" id="3892933">netFD</span><span class="op" id="3892938">)</span>&nbsp;<span class="ident" id="3892940">init</span><span class="op" id="3892944">(</span><span class="op" id="3892945">)</span>&nbsp;<span class="builtintype" id="3892947">error</span>&nbsp;<span class="op" id="3892953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3892956">if</span>&nbsp;<span class="ident" id="3892959">err</span>&nbsp;<span class="op" id="3892963">:=</span>&nbsp;<span class="ident" id="3892966">fd</span><span class="op" id="3892968">.</span><span class="ident" id="3892969">pd</span><span class="op" id="3892971">.</span><span class="ident" id="3892972">Init</span><span class="op" id="3892976">(</span><span class="ident" id="3892977">fd</span><span class="op" id="3892979">)</span><span class="op" id="3892980">;</span>&nbsp;<span class="ident" id="3892982">err</span>&nbsp;<span class="op" id="3892986">!=</span>&nbsp;<span class="builtintype" id="3892989">nil</span>&nbsp;<span class="op" id="3892993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3892997">return</span>&nbsp;<span class="ident" id="3893004">err</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3893009">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3893012">return</span>&nbsp;<span class="builtintype" id="3893019">nil</span><br>
<span class="lineno"></span><span class="op" id="3893023">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3893026">func</span>&nbsp;<span class="op" id="3893031">(</span><span class="ident" id="3893032">fd</span>&nbsp;<span class="op" id="3893035">*</span><span class="ident" id="3893036">netFD</span><span class="op" id="3893041">)</span>&nbsp;<span class="ident" id="3893043">setAddr</span><span class="op" id="3893050">(</span><span class="ident" id="3893051">laddr</span><span class="op" id="3893056">,</span>&nbsp;<span class="ident" id="3893058">raddr</span>&nbsp;<span class="ident" id="3893064">Addr</span><span class="op" id="3893068">)</span>&nbsp;<span class="op" id="3893070">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3893073">fd</span><span class="op" id="3893075">.</span><span class="ident" id="3893076">laddr</span>&nbsp;<span class="op" id="3893082">=</span>&nbsp;<span class="ident" id="3893084">laddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3893091">fd</span><span class="op" id="3893093">.</span><span class="ident" id="3893094">raddr</span>&nbsp;<span class="op" id="3893100">=</span>&nbsp;<span class="ident" id="3893102">raddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3893109">runtime</span><span class="op" id="3893116">.</span><span class="ident" id="3893117">SetFinalizer</span><span class="op" id="3893129">(</span><span class="ident" id="3893130">fd</span><span class="op" id="3893132">,</span>&nbsp;<span class="op" id="3893134">(</span><span class="op" id="3893135">*</span><span class="ident" id="3893136">netFD</span><span class="op" id="3893141">)</span><span class="op" id="3893142">.</span><span class="ident" id="3893143">Close</span><span class="op" id="3893148">)</span><br>
<span class="lineno"></span><span class="op" id="3893150">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="3893153">func</span>&nbsp;<span class="op" id="3893158">(</span><span class="ident" id="3893159">fd</span>&nbsp;<span class="op" id="3893162">*</span><span class="ident" id="3893163">netFD</span><span class="op" id="3893168">)</span>&nbsp;<span class="ident" id="3893170">name</span><span class="op" id="3893174">(</span><span class="op" id="3893175">)</span>&nbsp;<span class="builtintype" id="3893177">string</span>&nbsp;<span class="op" id="3893184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3893187">var</span>&nbsp;<span class="ident" id="3893191">ls</span><span class="op" id="3893193">,</span>&nbsp;<span class="ident" id="3893195">rs</span>&nbsp;<span class="builtintype" id="3893198">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3893206">if</span>&nbsp;<span class="ident" id="3893209">fd</span><span class="op" id="3893211">.</span><span class="ident" id="3893212">laddr</span>&nbsp;<span class="op" id="3893218">!=</span>&nbsp;<span class="builtintype" id="3893221">nil</span>&nbsp;<span class="op" id="3893225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3893229">ls</span>&nbsp;<span class="op" id="3893232">=</span>&nbsp;<span class="ident" id="3893234">fd</span><span class="op" id="3893236">.</span><span class="ident" id="3893237">laddr</span><span class="op" id="3893242">.</span><span class="ident" id="3893243">String</span><span class="op" id="3893249">(</span><span class="op" id="3893250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3893253">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3893256">if</span>&nbsp;<span class="ident" id="3893259">fd</span><span class="op" id="3893261">.</span><span class="ident" id="3893262">raddr</span>&nbsp;<span class="op" id="3893268">!=</span>&nbsp;<span class="builtintype" id="3893271">nil</span>&nbsp;<span class="op" id="3893275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3893279">rs</span>&nbsp;<span class="op" id="3893282">=</span>&nbsp;<span class="ident" id="3893284">fd</span><span class="op" id="3893286">.</span><span class="ident" id="3893287">raddr</span><span class="op" id="3893292">.</span><span class="ident" id="3893293">String</span><span class="op" id="3893299">(</span><span class="op" id="3893300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3893303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3893306">return</span>&nbsp;<span class="ident" id="3893313">fd</span><span class="op" id="3893315">.</span><span class="ident" id="3893316">net</span>&nbsp;<span class="op" id="3893320">+</span>&nbsp;<span class="string" id="3893322">&#34;:&#34;</span>&nbsp;<span class="op" id="3893326">+</span>&nbsp;<span class="ident" id="3893328">ls</span>&nbsp;<span class="op" id="3893331">+</span>&nbsp;<span class="string" id="3893333">&#34;-&gt;&#34;</span>&nbsp;<span class="op" id="3893338">+</span>&nbsp;<span class="ident" id="3893340">rs</span><br>
<span class="lineno"></span><span class="op" id="3893343">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="3893346">func</span>&nbsp;<span class="op" id="3893351">(</span><span class="ident" id="3893352">fd</span>&nbsp;<span class="op" id="3893355">*</span><span class="ident" id="3893356">netFD</span><span class="op" id="3893361">)</span>&nbsp;<span class="ident" id="3893363">connect</span><span class="op" id="3893370">(</span><span class="ident" id="3893371">la</span><span class="op" id="3893373">,</span>&nbsp;<span class="ident" id="3893375">ra</span>&nbsp;<span class="ident" id="3893378">syscall</span><span class="op" id="3893385">.</span><span class="ident" id="3893386">Sockaddr</span><span class="op" id="3893394">,</span>&nbsp;<span class="ident" id="3893396">deadline</span>&nbsp;<span class="ident" id="3893405">time</span><span class="op" id="3893409">.</span><span class="ident" id="3893410">Time</span><span class="op" id="3893414">)</span>&nbsp;<span class="builtintype" id="3893416">error</span>&nbsp;<span class="op" id="3893422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3893425">//&nbsp;Do&nbsp;not&nbsp;need&nbsp;to&nbsp;call&nbsp;fd.writeLock&nbsp;here,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3893468">//&nbsp;because&nbsp;fd&nbsp;is&nbsp;not&nbsp;yet&nbsp;accessible&nbsp;to&nbsp;user,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3893514">//&nbsp;so&nbsp;no&nbsp;concurrent&nbsp;operations&nbsp;are&nbsp;possible.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3893560">switch</span>&nbsp;<span class="ident" id="3893567">err</span>&nbsp;<span class="op" id="3893571">:=</span>&nbsp;<span class="ident" id="3893574">syscall</span><span class="op" id="3893581">.</span><span class="ident" id="3893582">Connect</span><span class="op" id="3893589">(</span><span class="ident" id="3893590">fd</span><span class="op" id="3893592">.</span><span class="ident" id="3893593">sysfd</span><span class="op" id="3893598">,</span>&nbsp;<span class="ident" id="3893600">ra</span><span class="op" id="3893602">)</span><span class="op" id="3893603">;</span>&nbsp;<span class="ident" id="3893605">err</span>&nbsp;<span class="op" id="3893609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3893612">case</span>&nbsp;<span class="ident" id="3893617">syscall</span><span class="op" id="3893624">.</span><span class="ident" id="3893625">EINPROGRESS</span><span class="op" id="3893636">,</span>&nbsp;<span class="ident" id="3893638">syscall</span><span class="op" id="3893645">.</span><span class="ident" id="3893646">EALREADY</span><span class="op" id="3893654">,</span>&nbsp;<span class="ident" id="3893656">syscall</span><span class="op" id="3893663">.</span><span class="ident" id="3893664">EINTR</span><span class="op" id="3893669">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3893672">case</span>&nbsp;<span class="builtintype" id="3893677">nil</span><span class="op" id="3893680">,</span>&nbsp;<span class="ident" id="3893682">syscall</span><span class="op" id="3893689">.</span><span class="ident" id="3893690">EISCONN</span><span class="op" id="3893697">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3893701">if</span>&nbsp;<span class="op" id="3893704">!</span><span class="ident" id="3893705">deadline</span><span class="op" id="3893713">.</span><span class="ident" id="3893714">IsZero</span><span class="op" id="3893720">(</span><span class="op" id="3893721">)</span>&nbsp;<span class="op" id="3893723">&amp;&amp;</span>&nbsp;<span class="ident" id="3893726">deadline</span><span class="op" id="3893734">.</span><span class="ident" id="3893735">Before</span><span class="op" id="3893741">(</span><span class="ident" id="3893742">time</span><span class="op" id="3893746">.</span><span class="ident" id="3893747">Now</span><span class="op" id="3893750">(</span><span class="op" id="3893751">)</span><span class="op" id="3893752">)</span>&nbsp;<span class="op" id="3893754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3893759">return</span>&nbsp;<span class="ident" id="3893766">errTimeout</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3893779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3893783">if</span>&nbsp;<span class="ident" id="3893786">err</span>&nbsp;<span class="op" id="3893790">:=</span>&nbsp;<span class="ident" id="3893793">fd</span><span class="op" id="3893795">.</span><span class="ident" id="3893796">init</span><span class="op" id="3893800">(</span><span class="op" id="3893801">)</span><span class="op" id="3893802">;</span>&nbsp;<span class="ident" id="3893804">err</span>&nbsp;<span class="op" id="3893808">!=</span>&nbsp;<span class="builtintype" id="3893811">nil</span>&nbsp;<span class="op" id="3893815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3893820">return</span>&nbsp;<span class="ident" id="3893827">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3893833">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3893837">return</span>&nbsp;<span class="builtintype" id="3893844">nil</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3893849">case</span>&nbsp;<span class="ident" id="3893854">syscall</span><span class="op" id="3893861">.</span><span class="ident" id="3893862">EINVAL</span><span class="op" id="3893868">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3893872">//&nbsp;On&nbsp;Solaris&nbsp;we&nbsp;can&nbsp;see&nbsp;EINVAL&nbsp;if&nbsp;the&nbsp;socket&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3893924">//&nbsp;already&nbsp;been&nbsp;accepted&nbsp;and&nbsp;closed&nbsp;by&nbsp;the&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3893977">//&nbsp;Treat&nbsp;this&nbsp;as&nbsp;a&nbsp;successful&nbsp;connection--writes&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3894031">//&nbsp;the&nbsp;socket&nbsp;will&nbsp;see&nbsp;EOF.&nbsp;&nbsp;For&nbsp;details&nbsp;and&nbsp;a&nbsp;test</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3894085">//&nbsp;case&nbsp;in&nbsp;C&nbsp;see&nbsp;http://golang.org/issue/6828.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3894134">if</span>&nbsp;<span class="ident" id="3894137">runtime</span><span class="op" id="3894144">.</span><span class="ident" id="3894145">GOOS</span>&nbsp;<span class="op" id="3894150">==</span>&nbsp;<span class="string" id="3894153">&#34;solaris&#34;</span>&nbsp;<span class="op" id="3894163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3894168">return</span>&nbsp;<span class="builtintype" id="3894175">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3894181">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3894185">fallthrough</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3894198">default</span><span class="op" id="3894205">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3894209">return</span>&nbsp;<span class="ident" id="3894216">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3894221">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3894224">if</span>&nbsp;<span class="ident" id="3894227">err</span>&nbsp;<span class="op" id="3894231">:=</span>&nbsp;<span class="ident" id="3894234">fd</span><span class="op" id="3894236">.</span><span class="ident" id="3894237">init</span><span class="op" id="3894241">(</span><span class="op" id="3894242">)</span><span class="op" id="3894243">;</span>&nbsp;<span class="ident" id="3894245">err</span>&nbsp;<span class="op" id="3894249">!=</span>&nbsp;<span class="builtintype" id="3894252">nil</span>&nbsp;<span class="op" id="3894256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3894260">return</span>&nbsp;<span class="ident" id="3894267">err</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3894272">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3894275">if</span>&nbsp;<span class="op" id="3894278">!</span><span class="ident" id="3894279">deadline</span><span class="op" id="3894287">.</span><span class="ident" id="3894288">IsZero</span><span class="op" id="3894294">(</span><span class="op" id="3894295">)</span>&nbsp;<span class="op" id="3894297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3894301">fd</span><span class="op" id="3894303">.</span><span class="ident" id="3894304">setWriteDeadline</span><span class="op" id="3894320">(</span><span class="ident" id="3894321">deadline</span><span class="op" id="3894329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3894333">defer</span>&nbsp;<span class="ident" id="3894339">fd</span><span class="op" id="3894341">.</span><span class="ident" id="3894342">setWriteDeadline</span><span class="op" id="3894358">(</span><span class="ident" id="3894359">noDeadline</span><span class="op" id="3894369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3894372">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3894375">for</span>&nbsp;<span class="op" id="3894379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3894383">//&nbsp;Performing&nbsp;multiple&nbsp;connect&nbsp;system&nbsp;calls&nbsp;on&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3894434">//&nbsp;non-blocking&nbsp;socket&nbsp;under&nbsp;Unix&nbsp;variants&nbsp;does&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3894488">//&nbsp;necessarily&nbsp;result&nbsp;in&nbsp;earlier&nbsp;errors&nbsp;being</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3894536">//&nbsp;returned.&nbsp;Instead,&nbsp;once&nbsp;runtime-integrated&nbsp;network</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3894592">//&nbsp;poller&nbsp;tells&nbsp;us&nbsp;that&nbsp;the&nbsp;socket&nbsp;is&nbsp;ready,&nbsp;get&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3894647">//&nbsp;SO_ERROR&nbsp;socket&nbsp;option&nbsp;to&nbsp;see&nbsp;if&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3894700">//&nbsp;succeeded&nbsp;or&nbsp;failed.&nbsp;See&nbsp;issue&nbsp;7474&nbsp;for&nbsp;further</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3894753">//&nbsp;details.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3894767">if</span>&nbsp;<span class="ident" id="3894770">err</span>&nbsp;<span class="op" id="3894774">:=</span>&nbsp;<span class="ident" id="3894777">fd</span><span class="op" id="3894779">.</span><span class="ident" id="3894780">pd</span><span class="op" id="3894782">.</span><span class="ident" id="3894783">WaitWrite</span><span class="op" id="3894792">(</span><span class="op" id="3894793">)</span><span class="op" id="3894794">;</span>&nbsp;<span class="ident" id="3894796">err</span>&nbsp;<span class="op" id="3894800">!=</span>&nbsp;<span class="builtintype" id="3894803">nil</span>&nbsp;<span class="op" id="3894807">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3894812">return</span>&nbsp;<span class="ident" id="3894819">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3894825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3894829">nerr</span><span class="op" id="3894833">,</span>&nbsp;<span class="ident" id="3894835">err</span>&nbsp;<span class="op" id="3894839">:=</span>&nbsp;<span class="ident" id="3894842">syscall</span><span class="op" id="3894849">.</span><span class="ident" id="3894850">GetsockoptInt</span><span class="op" id="3894863">(</span><span class="ident" id="3894864">fd</span><span class="op" id="3894866">.</span><span class="ident" id="3894867">sysfd</span><span class="op" id="3894872">,</span>&nbsp;<span class="ident" id="3894874">syscall</span><span class="op" id="3894881">.</span><span class="ident" id="3894882">SOL_SOCKET</span><span class="op" id="3894892">,</span>&nbsp;<span class="ident" id="3894894">syscall</span><span class="op" id="3894901">.</span><span class="ident" id="3894902">SO_ERROR</span><span class="op" id="3894910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3894914">if</span>&nbsp;<span class="ident" id="3894917">err</span>&nbsp;<span class="op" id="3894921">!=</span>&nbsp;<span class="builtintype" id="3894924">nil</span>&nbsp;<span class="op" id="3894928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3894933">return</span>&nbsp;<span class="ident" id="3894940">err</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3894946">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3894950">switch</span>&nbsp;<span class="ident" id="3894957">err</span>&nbsp;<span class="op" id="3894961">:=</span>&nbsp;<span class="ident" id="3894964">syscall</span><span class="op" id="3894971">.</span><span class="ident" id="3894972">Errno</span><span class="op" id="3894977">(</span><span class="ident" id="3894978">nerr</span><span class="op" id="3894982">)</span><span class="op" id="3894983">;</span>&nbsp;<span class="ident" id="3894985">err</span>&nbsp;<span class="op" id="3894989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3894993">case</span>&nbsp;<span class="ident" id="3894998">syscall</span><span class="op" id="3895005">.</span><span class="ident" id="3895006">EINPROGRESS</span><span class="op" id="3895017">,</span>&nbsp;<span class="ident" id="3895019">syscall</span><span class="op" id="3895026">.</span><span class="ident" id="3895027">EALREADY</span><span class="op" id="3895035">,</span>&nbsp;<span class="ident" id="3895037">syscall</span><span class="op" id="3895044">.</span><span class="ident" id="3895045">EINTR</span><span class="op" id="3895050">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3895054">case</span>&nbsp;<span class="ident" id="3895059">syscall</span><span class="op" id="3895066">.</span><span class="ident" id="3895067">Errno</span><span class="op" id="3895072">(</span><span class="num" id="3895073">0</span><span class="op" id="3895074">)</span><span class="op" id="3895075">,</span>&nbsp;<span class="ident" id="3895077">syscall</span><span class="op" id="3895084">.</span><span class="ident" id="3895085">EISCONN</span><span class="op" id="3895092">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3895097">return</span>&nbsp;<span class="builtintype" id="3895104">nil</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3895110">default</span><span class="op" id="3895117">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3895122">return</span>&nbsp;<span class="ident" id="3895129">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3895135">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3895138">}</span><br>
<span class="lineno"></span><span class="op" id="3895140">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="keyword" id="3895143">func</span>&nbsp;<span class="op" id="3895148">(</span><span class="ident" id="3895149">fd</span>&nbsp;<span class="op" id="3895152">*</span><span class="ident" id="3895153">netFD</span><span class="op" id="3895158">)</span>&nbsp;<span class="ident" id="3895160">destroy</span><span class="op" id="3895167">(</span><span class="op" id="3895168">)</span>&nbsp;<span class="op" id="3895170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3895173">//&nbsp;Poller&nbsp;may&nbsp;want&nbsp;to&nbsp;unregister&nbsp;fd&nbsp;in&nbsp;readiness&nbsp;notification&nbsp;mechanism,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3895247">//&nbsp;so&nbsp;this&nbsp;must&nbsp;be&nbsp;executed&nbsp;before&nbsp;closesocket.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3895296">fd</span><span class="op" id="3895298">.</span><span class="ident" id="3895299">pd</span><span class="op" id="3895301">.</span><span class="ident" id="3895302">Close</span><span class="op" id="3895307">(</span><span class="op" id="3895308">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3895311">closesocket</span><span class="op" id="3895322">(</span><span class="ident" id="3895323">fd</span><span class="op" id="3895325">.</span><span class="ident" id="3895326">sysfd</span><span class="op" id="3895331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3895334">fd</span><span class="op" id="3895336">.</span><span class="ident" id="3895337">sysfd</span>&nbsp;<span class="op" id="3895343">=</span>&nbsp;<span class="op" id="3895345">-</span><span class="num" id="3895346">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3895349">runtime</span><span class="op" id="3895356">.</span><span class="ident" id="3895357">SetFinalizer</span><span class="op" id="3895369">(</span><span class="ident" id="3895370">fd</span><span class="op" id="3895372">,</span>&nbsp;<span class="builtintype" id="3895374">nil</span><span class="op" id="3895377">)</span><br>
<span class="lineno"></span><span class="op" id="3895379">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="3895382">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd.</span><br>
<span class="lineno"></span><span class="comment" id="3895413">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3895459">func</span>&nbsp;<span class="op" id="3895464">(</span><span class="ident" id="3895465">fd</span>&nbsp;<span class="op" id="3895468">*</span><span class="ident" id="3895469">netFD</span><span class="op" id="3895474">)</span>&nbsp;<span class="ident" id="3895476">incref</span><span class="op" id="3895482">(</span><span class="op" id="3895483">)</span>&nbsp;<span class="builtintype" id="3895485">error</span>&nbsp;<span class="op" id="3895491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3895494">if</span>&nbsp;<span class="op" id="3895497">!</span><span class="ident" id="3895498">fd</span><span class="op" id="3895500">.</span><span class="ident" id="3895501">fdmu</span><span class="op" id="3895505">.</span><span class="ident" id="3895506">Incref</span><span class="op" id="3895512">(</span><span class="op" id="3895513">)</span>&nbsp;<span class="op" id="3895515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3895519">return</span>&nbsp;<span class="ident" id="3895526">errClosing</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3895538">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3895541">return</span>&nbsp;<span class="builtintype" id="3895548">nil</span><br>
<span class="lineno"></span><span class="op" id="3895552">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3895555">//&nbsp;Remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD&nbsp;and&nbsp;close&nbsp;if&nbsp;we&#39;ve&nbsp;been&nbsp;asked&nbsp;to&nbsp;do&nbsp;so</span><br>
<span class="lineno">150</span><span class="comment" id="3895627">//&nbsp;(and&nbsp;there&nbsp;are&nbsp;no&nbsp;references&nbsp;left).</span><br>
<span class="lineno"></span><span class="keyword" id="3895666">func</span>&nbsp;<span class="op" id="3895671">(</span><span class="ident" id="3895672">fd</span>&nbsp;<span class="op" id="3895675">*</span><span class="ident" id="3895676">netFD</span><span class="op" id="3895681">)</span>&nbsp;<span class="ident" id="3895683">decref</span><span class="op" id="3895689">(</span><span class="op" id="3895690">)</span>&nbsp;<span class="op" id="3895692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3895695">if</span>&nbsp;<span class="ident" id="3895698">fd</span><span class="op" id="3895700">.</span><span class="ident" id="3895701">fdmu</span><span class="op" id="3895705">.</span><span class="ident" id="3895706">Decref</span><span class="op" id="3895712">(</span><span class="op" id="3895713">)</span>&nbsp;<span class="op" id="3895715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3895719">fd</span><span class="op" id="3895721">.</span><span class="ident" id="3895722">destroy</span><span class="op" id="3895729">(</span><span class="op" id="3895730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3895733">}</span><br>
<span class="lineno">155</span><span class="op" id="3895735">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3895738">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd&nbsp;and&nbsp;lock&nbsp;for&nbsp;reading.</span><br>
<span class="lineno"></span><span class="comment" id="3895790">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3895836">func</span>&nbsp;<span class="op" id="3895841">(</span><span class="ident" id="3895842">fd</span>&nbsp;<span class="op" id="3895845">*</span><span class="ident" id="3895846">netFD</span><span class="op" id="3895851">)</span>&nbsp;<span class="ident" id="3895853">readLock</span><span class="op" id="3895861">(</span><span class="op" id="3895862">)</span>&nbsp;<span class="builtintype" id="3895864">error</span>&nbsp;<span class="op" id="3895870">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3895873">if</span>&nbsp;<span class="op" id="3895876">!</span><span class="ident" id="3895877">fd</span><span class="op" id="3895879">.</span><span class="ident" id="3895880">fdmu</span><span class="op" id="3895884">.</span><span class="ident" id="3895885">RWLock</span><span class="op" id="3895891">(</span><span class="builtintype" id="3895892">true</span><span class="op" id="3895896">)</span>&nbsp;<span class="op" id="3895898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3895902">return</span>&nbsp;<span class="ident" id="3895909">errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3895921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3895924">return</span>&nbsp;<span class="builtintype" id="3895931">nil</span><br>
<span class="lineno"></span><span class="op" id="3895935">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="3895938">//&nbsp;Unlock&nbsp;for&nbsp;reading&nbsp;and&nbsp;remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD.</span><br>
<span class="lineno"></span><span class="keyword" id="3895995">func</span>&nbsp;<span class="op" id="3896000">(</span><span class="ident" id="3896001">fd</span>&nbsp;<span class="op" id="3896004">*</span><span class="ident" id="3896005">netFD</span><span class="op" id="3896010">)</span>&nbsp;<span class="ident" id="3896012">readUnlock</span><span class="op" id="3896022">(</span><span class="op" id="3896023">)</span>&nbsp;<span class="op" id="3896025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3896028">if</span>&nbsp;<span class="ident" id="3896031">fd</span><span class="op" id="3896033">.</span><span class="ident" id="3896034">fdmu</span><span class="op" id="3896038">.</span><span class="ident" id="3896039">RWUnlock</span><span class="op" id="3896047">(</span><span class="builtintype" id="3896048">true</span><span class="op" id="3896052">)</span>&nbsp;<span class="op" id="3896054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3896058">fd</span><span class="op" id="3896060">.</span><span class="ident" id="3896061">destroy</span><span class="op" id="3896068">(</span><span class="op" id="3896069">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3896072">}</span><br>
<span class="lineno"></span><span class="op" id="3896074">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3896077">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd&nbsp;and&nbsp;lock&nbsp;for&nbsp;writing.</span><br>
<span class="lineno"></span><span class="comment" id="3896129">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno">175</span><span class="keyword" id="3896175">func</span>&nbsp;<span class="op" id="3896180">(</span><span class="ident" id="3896181">fd</span>&nbsp;<span class="op" id="3896184">*</span><span class="ident" id="3896185">netFD</span><span class="op" id="3896190">)</span>&nbsp;<span class="ident" id="3896192">writeLock</span><span class="op" id="3896201">(</span><span class="op" id="3896202">)</span>&nbsp;<span class="builtintype" id="3896204">error</span>&nbsp;<span class="op" id="3896210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3896213">if</span>&nbsp;<span class="op" id="3896216">!</span><span class="ident" id="3896217">fd</span><span class="op" id="3896219">.</span><span class="ident" id="3896220">fdmu</span><span class="op" id="3896224">.</span><span class="ident" id="3896225">RWLock</span><span class="op" id="3896231">(</span><span class="builtintype" id="3896232">false</span><span class="op" id="3896237">)</span>&nbsp;<span class="op" id="3896239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3896243">return</span>&nbsp;<span class="ident" id="3896250">errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3896262">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3896265">return</span>&nbsp;<span class="builtintype" id="3896272">nil</span><br>
<span class="lineno">180</span><span class="op" id="3896276">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3896279">//&nbsp;Unlock&nbsp;for&nbsp;writing&nbsp;and&nbsp;remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD.</span><br>
<span class="lineno"></span><span class="keyword" id="3896336">func</span>&nbsp;<span class="op" id="3896341">(</span><span class="ident" id="3896342">fd</span>&nbsp;<span class="op" id="3896345">*</span><span class="ident" id="3896346">netFD</span><span class="op" id="3896351">)</span>&nbsp;<span class="ident" id="3896353">writeUnlock</span><span class="op" id="3896364">(</span><span class="op" id="3896365">)</span>&nbsp;<span class="op" id="3896367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3896370">if</span>&nbsp;<span class="ident" id="3896373">fd</span><span class="op" id="3896375">.</span><span class="ident" id="3896376">fdmu</span><span class="op" id="3896380">.</span><span class="ident" id="3896381">RWUnlock</span><span class="op" id="3896389">(</span><span class="builtintype" id="3896390">false</span><span class="op" id="3896395">)</span>&nbsp;<span class="op" id="3896397">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3896401">fd</span><span class="op" id="3896403">.</span><span class="ident" id="3896404">destroy</span><span class="op" id="3896411">(</span><span class="op" id="3896412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3896415">}</span><br>
<span class="lineno"></span><span class="op" id="3896417">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3896420">func</span>&nbsp;<span class="op" id="3896425">(</span><span class="ident" id="3896426">fd</span>&nbsp;<span class="op" id="3896429">*</span><span class="ident" id="3896430">netFD</span><span class="op" id="3896435">)</span>&nbsp;<span class="ident" id="3896437">Close</span><span class="op" id="3896442">(</span><span class="op" id="3896443">)</span>&nbsp;<span class="builtintype" id="3896445">error</span>&nbsp;<span class="op" id="3896451">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3896454">fd</span><span class="op" id="3896456">.</span><span class="ident" id="3896457">pd</span><span class="op" id="3896459">.</span><span class="ident" id="3896460">Lock</span><span class="op" id="3896464">(</span><span class="op" id="3896465">)</span>&nbsp;<span class="comment" id="3896467">//&nbsp;needed&nbsp;for&nbsp;both&nbsp;fd.incref(true)&nbsp;and&nbsp;pollDesc.Evict</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3896522">if</span>&nbsp;<span class="op" id="3896525">!</span><span class="ident" id="3896526">fd</span><span class="op" id="3896528">.</span><span class="ident" id="3896529">fdmu</span><span class="op" id="3896533">.</span><span class="ident" id="3896534">IncrefAndClose</span><span class="op" id="3896548">(</span><span class="op" id="3896549">)</span>&nbsp;<span class="op" id="3896551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3896555">fd</span><span class="op" id="3896557">.</span><span class="ident" id="3896558">pd</span><span class="op" id="3896560">.</span><span class="ident" id="3896561">Unlock</span><span class="op" id="3896567">(</span><span class="op" id="3896568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3896572">return</span>&nbsp;<span class="ident" id="3896579">errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3896591">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3896594">//&nbsp;Unblock&nbsp;any&nbsp;I/O.&nbsp;&nbsp;Once&nbsp;it&nbsp;all&nbsp;unblocks&nbsp;and&nbsp;returns,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3896650">//&nbsp;so&nbsp;that&nbsp;it&nbsp;cannot&nbsp;be&nbsp;referring&nbsp;to&nbsp;fd.sysfd&nbsp;anymore,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3896706">//&nbsp;the&nbsp;final&nbsp;decref&nbsp;will&nbsp;close&nbsp;fd.sysfd.&nbsp;&nbsp;This&nbsp;should&nbsp;happen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3896768">//&nbsp;fairly&nbsp;quickly,&nbsp;since&nbsp;all&nbsp;the&nbsp;I/O&nbsp;is&nbsp;non-blocking,&nbsp;and&nbsp;any</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3896831">//&nbsp;attempts&nbsp;to&nbsp;block&nbsp;in&nbsp;the&nbsp;pollDesc&nbsp;will&nbsp;return&nbsp;errClosing.</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3896893">doWakeup</span>&nbsp;<span class="op" id="3896902">:=</span>&nbsp;<span class="ident" id="3896905">fd</span><span class="op" id="3896907">.</span><span class="ident" id="3896908">pd</span><span class="op" id="3896910">.</span><span class="ident" id="3896911">Evict</span><span class="op" id="3896916">(</span><span class="op" id="3896917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3896920">fd</span><span class="op" id="3896922">.</span><span class="ident" id="3896923">pd</span><span class="op" id="3896925">.</span><span class="ident" id="3896926">Unlock</span><span class="op" id="3896932">(</span><span class="op" id="3896933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3896936">fd</span><span class="op" id="3896938">.</span><span class="ident" id="3896939">decref</span><span class="op" id="3896945">(</span><span class="op" id="3896946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3896949">if</span>&nbsp;<span class="ident" id="3896952">doWakeup</span>&nbsp;<span class="op" id="3896961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3896965">fd</span><span class="op" id="3896967">.</span><span class="ident" id="3896968">pd</span><span class="op" id="3896970">.</span><span class="ident" id="3896971">Wakeup</span><span class="op" id="3896977">(</span><span class="op" id="3896978">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3896981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3896984">return</span>&nbsp;<span class="builtintype" id="3896991">nil</span><br>
<span class="lineno"></span><span class="op" id="3896995">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3896998">func</span>&nbsp;<span class="op" id="3897003">(</span><span class="ident" id="3897004">fd</span>&nbsp;<span class="op" id="3897007">*</span><span class="ident" id="3897008">netFD</span><span class="op" id="3897013">)</span>&nbsp;<span class="ident" id="3897015">shutdown</span><span class="op" id="3897023">(</span><span class="ident" id="3897024">how</span>&nbsp;<span class="builtintype" id="3897028">int</span><span class="op" id="3897031">)</span>&nbsp;<span class="builtintype" id="3897033">error</span>&nbsp;<span class="op" id="3897039">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3897042">if</span>&nbsp;<span class="ident" id="3897045">err</span>&nbsp;<span class="op" id="3897049">:=</span>&nbsp;<span class="ident" id="3897052">fd</span><span class="op" id="3897054">.</span><span class="ident" id="3897055">incref</span><span class="op" id="3897061">(</span><span class="op" id="3897062">)</span><span class="op" id="3897063">;</span>&nbsp;<span class="ident" id="3897065">err</span>&nbsp;<span class="op" id="3897069">!=</span>&nbsp;<span class="builtintype" id="3897072">nil</span>&nbsp;<span class="op" id="3897076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3897080">return</span>&nbsp;<span class="ident" id="3897087">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3897092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3897095">defer</span>&nbsp;<span class="ident" id="3897101">fd</span><span class="op" id="3897103">.</span><span class="ident" id="3897104">decref</span><span class="op" id="3897110">(</span><span class="op" id="3897111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3897114">err</span>&nbsp;<span class="op" id="3897118">:=</span>&nbsp;<span class="ident" id="3897121">syscall</span><span class="op" id="3897128">.</span><span class="ident" id="3897129">Shutdown</span><span class="op" id="3897137">(</span><span class="ident" id="3897138">fd</span><span class="op" id="3897140">.</span><span class="ident" id="3897141">sysfd</span><span class="op" id="3897146">,</span>&nbsp;<span class="ident" id="3897148">how</span><span class="op" id="3897151">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3897154">if</span>&nbsp;<span class="ident" id="3897157">err</span>&nbsp;<span class="op" id="3897161">!=</span>&nbsp;<span class="builtintype" id="3897164">nil</span>&nbsp;<span class="op" id="3897168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3897172">return</span>&nbsp;<span class="op" id="3897179">&amp;</span><span class="ident" id="3897180">OpError</span><span class="op" id="3897187">{</span><span class="string" id="3897188">&#34;shutdown&#34;</span><span class="op" id="3897198">,</span>&nbsp;<span class="ident" id="3897200">fd</span><span class="op" id="3897202">.</span><span class="ident" id="3897203">net</span><span class="op" id="3897206">,</span>&nbsp;<span class="ident" id="3897208">fd</span><span class="op" id="3897210">.</span><span class="ident" id="3897211">laddr</span><span class="op" id="3897216">,</span>&nbsp;<span class="ident" id="3897218">err</span><span class="op" id="3897221">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3897224">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3897227">return</span>&nbsp;<span class="builtintype" id="3897234">nil</span><br>
<span class="lineno"></span><span class="op" id="3897238">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="keyword" id="3897241">func</span>&nbsp;<span class="op" id="3897246">(</span><span class="ident" id="3897247">fd</span>&nbsp;<span class="op" id="3897250">*</span><span class="ident" id="3897251">netFD</span><span class="op" id="3897256">)</span>&nbsp;<span class="ident" id="3897258">closeRead</span><span class="op" id="3897267">(</span><span class="op" id="3897268">)</span>&nbsp;<span class="builtintype" id="3897270">error</span>&nbsp;<span class="op" id="3897276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3897279">return</span>&nbsp;<span class="ident" id="3897286">fd</span><span class="op" id="3897288">.</span><span class="ident" id="3897289">shutdown</span><span class="op" id="3897297">(</span><span class="ident" id="3897298">syscall</span><span class="op" id="3897305">.</span><span class="ident" id="3897306">SHUT_RD</span><span class="op" id="3897313">)</span><br>
<span class="lineno"></span><span class="op" id="3897315">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="3897318">func</span>&nbsp;<span class="op" id="3897323">(</span><span class="ident" id="3897324">fd</span>&nbsp;<span class="op" id="3897327">*</span><span class="ident" id="3897328">netFD</span><span class="op" id="3897333">)</span>&nbsp;<span class="ident" id="3897335">closeWrite</span><span class="op" id="3897345">(</span><span class="op" id="3897346">)</span>&nbsp;<span class="builtintype" id="3897348">error</span>&nbsp;<span class="op" id="3897354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3897357">return</span>&nbsp;<span class="ident" id="3897364">fd</span><span class="op" id="3897366">.</span><span class="ident" id="3897367">shutdown</span><span class="op" id="3897375">(</span><span class="ident" id="3897376">syscall</span><span class="op" id="3897383">.</span><span class="ident" id="3897384">SHUT_WR</span><span class="op" id="3897391">)</span><br>
<span class="lineno"></span><span class="op" id="3897393">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3897396">func</span>&nbsp;<span class="op" id="3897401">(</span><span class="ident" id="3897402">fd</span>&nbsp;<span class="op" id="3897405">*</span><span class="ident" id="3897406">netFD</span><span class="op" id="3897411">)</span>&nbsp;<span class="ident" id="3897413">Read</span><span class="op" id="3897417">(</span><span class="ident" id="3897418">p</span>&nbsp;<span class="op" id="3897420">[</span><span class="op" id="3897421">]</span><span class="builtintype" id="3897422">byte</span><span class="op" id="3897426">)</span>&nbsp;<span class="op" id="3897428">(</span><span class="ident" id="3897429">n</span>&nbsp;<span class="builtintype" id="3897431">int</span><span class="op" id="3897434">,</span>&nbsp;<span class="ident" id="3897436">err</span>&nbsp;<span class="builtintype" id="3897440">error</span><span class="op" id="3897445">)</span>&nbsp;<span class="op" id="3897447">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3897450">if</span>&nbsp;<span class="ident" id="3897453">err</span>&nbsp;<span class="op" id="3897457">:=</span>&nbsp;<span class="ident" id="3897460">fd</span><span class="op" id="3897462">.</span><span class="ident" id="3897463">readLock</span><span class="op" id="3897471">(</span><span class="op" id="3897472">)</span><span class="op" id="3897473">;</span>&nbsp;<span class="ident" id="3897475">err</span>&nbsp;<span class="op" id="3897479">!=</span>&nbsp;<span class="builtintype" id="3897482">nil</span>&nbsp;<span class="op" id="3897486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3897490">return</span>&nbsp;<span class="num" id="3897497">0</span><span class="op" id="3897498">,</span>&nbsp;<span class="ident" id="3897500">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3897505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3897508">defer</span>&nbsp;<span class="ident" id="3897514">fd</span><span class="op" id="3897516">.</span><span class="ident" id="3897517">readUnlock</span><span class="op" id="3897527">(</span><span class="op" id="3897528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3897531">if</span>&nbsp;<span class="ident" id="3897534">err</span>&nbsp;<span class="op" id="3897538">:=</span>&nbsp;<span class="ident" id="3897541">fd</span><span class="op" id="3897543">.</span><span class="ident" id="3897544">pd</span><span class="op" id="3897546">.</span><span class="ident" id="3897547">PrepareRead</span><span class="op" id="3897558">(</span><span class="op" id="3897559">)</span><span class="op" id="3897560">;</span>&nbsp;<span class="ident" id="3897562">err</span>&nbsp;<span class="op" id="3897566">!=</span>&nbsp;<span class="builtintype" id="3897569">nil</span>&nbsp;<span class="op" id="3897573">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3897577">return</span>&nbsp;<span class="num" id="3897584">0</span><span class="op" id="3897585">,</span>&nbsp;<span class="op" id="3897587">&amp;</span><span class="ident" id="3897588">OpError</span><span class="op" id="3897595">{</span><span class="string" id="3897596">&#34;read&#34;</span><span class="op" id="3897602">,</span>&nbsp;<span class="ident" id="3897604">fd</span><span class="op" id="3897606">.</span><span class="ident" id="3897607">net</span><span class="op" id="3897610">,</span>&nbsp;<span class="ident" id="3897612">fd</span><span class="op" id="3897614">.</span><span class="ident" id="3897615">raddr</span><span class="op" id="3897620">,</span>&nbsp;<span class="ident" id="3897622">err</span><span class="op" id="3897625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3897628">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3897631">for</span>&nbsp;<span class="op" id="3897635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3897639">n</span><span class="op" id="3897640">,</span>&nbsp;<span class="ident" id="3897642">err</span>&nbsp;<span class="op" id="3897646">=</span>&nbsp;<span class="ident" id="3897648">syscall</span><span class="op" id="3897655">.</span><span class="ident" id="3897656">Read</span><span class="op" id="3897660">(</span><span class="builtintype" id="3897661">int</span><span class="op" id="3897664">(</span><span class="ident" id="3897665">fd</span><span class="op" id="3897667">.</span><span class="ident" id="3897668">sysfd</span><span class="op" id="3897673">)</span><span class="op" id="3897674">,</span>&nbsp;<span class="ident" id="3897676">p</span><span class="op" id="3897677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3897681">if</span>&nbsp;<span class="ident" id="3897684">err</span>&nbsp;<span class="op" id="3897688">!=</span>&nbsp;<span class="builtintype" id="3897691">nil</span>&nbsp;<span class="op" id="3897695">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3897700">n</span>&nbsp;<span class="op" id="3897702">=</span>&nbsp;<span class="num" id="3897704">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3897709">if</span>&nbsp;<span class="ident" id="3897712">err</span>&nbsp;<span class="op" id="3897716">==</span>&nbsp;<span class="ident" id="3897719">syscall</span><span class="op" id="3897726">.</span><span class="ident" id="3897727">EAGAIN</span>&nbsp;<span class="op" id="3897734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3897740">if</span>&nbsp;<span class="ident" id="3897743">err</span>&nbsp;<span class="op" id="3897747">=</span>&nbsp;<span class="ident" id="3897749">fd</span><span class="op" id="3897751">.</span><span class="ident" id="3897752">pd</span><span class="op" id="3897754">.</span><span class="ident" id="3897755">WaitRead</span><span class="op" id="3897763">(</span><span class="op" id="3897764">)</span><span class="op" id="3897765">;</span>&nbsp;<span class="ident" id="3897767">err</span>&nbsp;<span class="op" id="3897771">==</span>&nbsp;<span class="builtintype" id="3897774">nil</span>&nbsp;<span class="op" id="3897778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3897785">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3897798">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3897803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3897807">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3897811">err</span>&nbsp;<span class="op" id="3897815">=</span>&nbsp;<span class="ident" id="3897817">chkReadErr</span><span class="op" id="3897827">(</span><span class="ident" id="3897828">n</span><span class="op" id="3897829">,</span>&nbsp;<span class="ident" id="3897831">err</span><span class="op" id="3897834">,</span>&nbsp;<span class="ident" id="3897836">fd</span><span class="op" id="3897838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3897842">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3897849">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3897852">if</span>&nbsp;<span class="ident" id="3897855">err</span>&nbsp;<span class="op" id="3897859">!=</span>&nbsp;<span class="builtintype" id="3897862">nil</span>&nbsp;<span class="op" id="3897866">&amp;&amp;</span>&nbsp;<span class="ident" id="3897869">err</span>&nbsp;<span class="op" id="3897873">!=</span>&nbsp;<span class="ident" id="3897876">io</span><span class="op" id="3897878">.</span><span class="ident" id="3897879">EOF</span>&nbsp;<span class="op" id="3897883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3897887">err</span>&nbsp;<span class="op" id="3897891">=</span>&nbsp;<span class="op" id="3897893">&amp;</span><span class="ident" id="3897894">OpError</span><span class="op" id="3897901">{</span><span class="string" id="3897902">&#34;read&#34;</span><span class="op" id="3897908">,</span>&nbsp;<span class="ident" id="3897910">fd</span><span class="op" id="3897912">.</span><span class="ident" id="3897913">net</span><span class="op" id="3897916">,</span>&nbsp;<span class="ident" id="3897918">fd</span><span class="op" id="3897920">.</span><span class="ident" id="3897921">raddr</span><span class="op" id="3897926">,</span>&nbsp;<span class="ident" id="3897928">err</span><span class="op" id="3897931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3897934">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3897937">return</span><br>
<span class="lineno"></span><span class="op" id="3897944">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="3897947">func</span>&nbsp;<span class="op" id="3897952">(</span><span class="ident" id="3897953">fd</span>&nbsp;<span class="op" id="3897956">*</span><span class="ident" id="3897957">netFD</span><span class="op" id="3897962">)</span>&nbsp;<span class="ident" id="3897964">readFrom</span><span class="op" id="3897972">(</span><span class="ident" id="3897973">p</span>&nbsp;<span class="op" id="3897975">[</span><span class="op" id="3897976">]</span><span class="builtintype" id="3897977">byte</span><span class="op" id="3897981">)</span>&nbsp;<span class="op" id="3897983">(</span><span class="ident" id="3897984">n</span>&nbsp;<span class="builtintype" id="3897986">int</span><span class="op" id="3897989">,</span>&nbsp;<span class="ident" id="3897991">sa</span>&nbsp;<span class="ident" id="3897994">syscall</span><span class="op" id="3898001">.</span><span class="ident" id="3898002">Sockaddr</span><span class="op" id="3898010">,</span>&nbsp;<span class="ident" id="3898012">err</span>&nbsp;<span class="builtintype" id="3898016">error</span><span class="op" id="3898021">)</span>&nbsp;<span class="op" id="3898023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3898026">if</span>&nbsp;<span class="ident" id="3898029">err</span>&nbsp;<span class="op" id="3898033">:=</span>&nbsp;<span class="ident" id="3898036">fd</span><span class="op" id="3898038">.</span><span class="ident" id="3898039">readLock</span><span class="op" id="3898047">(</span><span class="op" id="3898048">)</span><span class="op" id="3898049">;</span>&nbsp;<span class="ident" id="3898051">err</span>&nbsp;<span class="op" id="3898055">!=</span>&nbsp;<span class="builtintype" id="3898058">nil</span>&nbsp;<span class="op" id="3898062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3898066">return</span>&nbsp;<span class="num" id="3898073">0</span><span class="op" id="3898074">,</span>&nbsp;<span class="builtintype" id="3898076">nil</span><span class="op" id="3898079">,</span>&nbsp;<span class="ident" id="3898081">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3898086">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3898089">defer</span>&nbsp;<span class="ident" id="3898095">fd</span><span class="op" id="3898097">.</span><span class="ident" id="3898098">readUnlock</span><span class="op" id="3898108">(</span><span class="op" id="3898109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3898112">if</span>&nbsp;<span class="ident" id="3898115">err</span>&nbsp;<span class="op" id="3898119">:=</span>&nbsp;<span class="ident" id="3898122">fd</span><span class="op" id="3898124">.</span><span class="ident" id="3898125">pd</span><span class="op" id="3898127">.</span><span class="ident" id="3898128">PrepareRead</span><span class="op" id="3898139">(</span><span class="op" id="3898140">)</span><span class="op" id="3898141">;</span>&nbsp;<span class="ident" id="3898143">err</span>&nbsp;<span class="op" id="3898147">!=</span>&nbsp;<span class="builtintype" id="3898150">nil</span>&nbsp;<span class="op" id="3898154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3898158">return</span>&nbsp;<span class="num" id="3898165">0</span><span class="op" id="3898166">,</span>&nbsp;<span class="builtintype" id="3898168">nil</span><span class="op" id="3898171">,</span>&nbsp;<span class="op" id="3898173">&amp;</span><span class="ident" id="3898174">OpError</span><span class="op" id="3898181">{</span><span class="string" id="3898182">&#34;read&#34;</span><span class="op" id="3898188">,</span>&nbsp;<span class="ident" id="3898190">fd</span><span class="op" id="3898192">.</span><span class="ident" id="3898193">net</span><span class="op" id="3898196">,</span>&nbsp;<span class="ident" id="3898198">fd</span><span class="op" id="3898200">.</span><span class="ident" id="3898201">laddr</span><span class="op" id="3898206">,</span>&nbsp;<span class="ident" id="3898208">err</span><span class="op" id="3898211">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3898214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3898217">for</span>&nbsp;<span class="op" id="3898221">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3898225">n</span><span class="op" id="3898226">,</span>&nbsp;<span class="ident" id="3898228">sa</span><span class="op" id="3898230">,</span>&nbsp;<span class="ident" id="3898232">err</span>&nbsp;<span class="op" id="3898236">=</span>&nbsp;<span class="ident" id="3898238">syscall</span><span class="op" id="3898245">.</span><span class="ident" id="3898246">Recvfrom</span><span class="op" id="3898254">(</span><span class="ident" id="3898255">fd</span><span class="op" id="3898257">.</span><span class="ident" id="3898258">sysfd</span><span class="op" id="3898263">,</span>&nbsp;<span class="ident" id="3898265">p</span><span class="op" id="3898266">,</span>&nbsp;<span class="num" id="3898268">0</span><span class="op" id="3898269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3898273">if</span>&nbsp;<span class="ident" id="3898276">err</span>&nbsp;<span class="op" id="3898280">!=</span>&nbsp;<span class="builtintype" id="3898283">nil</span>&nbsp;<span class="op" id="3898287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3898292">n</span>&nbsp;<span class="op" id="3898294">=</span>&nbsp;<span class="num" id="3898296">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3898301">if</span>&nbsp;<span class="ident" id="3898304">err</span>&nbsp;<span class="op" id="3898308">==</span>&nbsp;<span class="ident" id="3898311">syscall</span><span class="op" id="3898318">.</span><span class="ident" id="3898319">EAGAIN</span>&nbsp;<span class="op" id="3898326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3898332">if</span>&nbsp;<span class="ident" id="3898335">err</span>&nbsp;<span class="op" id="3898339">=</span>&nbsp;<span class="ident" id="3898341">fd</span><span class="op" id="3898343">.</span><span class="ident" id="3898344">pd</span><span class="op" id="3898346">.</span><span class="ident" id="3898347">WaitRead</span><span class="op" id="3898355">(</span><span class="op" id="3898356">)</span><span class="op" id="3898357">;</span>&nbsp;<span class="ident" id="3898359">err</span>&nbsp;<span class="op" id="3898363">==</span>&nbsp;<span class="builtintype" id="3898366">nil</span>&nbsp;<span class="op" id="3898370">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3898377">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3898390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3898395">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3898399">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3898403">err</span>&nbsp;<span class="op" id="3898407">=</span>&nbsp;<span class="ident" id="3898409">chkReadErr</span><span class="op" id="3898419">(</span><span class="ident" id="3898420">n</span><span class="op" id="3898421">,</span>&nbsp;<span class="ident" id="3898423">err</span><span class="op" id="3898426">,</span>&nbsp;<span class="ident" id="3898428">fd</span><span class="op" id="3898430">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3898434">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3898441">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3898444">if</span>&nbsp;<span class="ident" id="3898447">err</span>&nbsp;<span class="op" id="3898451">!=</span>&nbsp;<span class="builtintype" id="3898454">nil</span>&nbsp;<span class="op" id="3898458">&amp;&amp;</span>&nbsp;<span class="ident" id="3898461">err</span>&nbsp;<span class="op" id="3898465">!=</span>&nbsp;<span class="ident" id="3898468">io</span><span class="op" id="3898470">.</span><span class="ident" id="3898471">EOF</span>&nbsp;<span class="op" id="3898475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3898479">err</span>&nbsp;<span class="op" id="3898483">=</span>&nbsp;<span class="op" id="3898485">&amp;</span><span class="ident" id="3898486">OpError</span><span class="op" id="3898493">{</span><span class="string" id="3898494">&#34;read&#34;</span><span class="op" id="3898500">,</span>&nbsp;<span class="ident" id="3898502">fd</span><span class="op" id="3898504">.</span><span class="ident" id="3898505">net</span><span class="op" id="3898508">,</span>&nbsp;<span class="ident" id="3898510">fd</span><span class="op" id="3898512">.</span><span class="ident" id="3898513">laddr</span><span class="op" id="3898518">,</span>&nbsp;<span class="ident" id="3898520">err</span><span class="op" id="3898523">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3898526">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3898529">return</span><br>
<span class="lineno"></span><span class="op" id="3898536">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3898539">func</span>&nbsp;<span class="op" id="3898544">(</span><span class="ident" id="3898545">fd</span>&nbsp;<span class="op" id="3898548">*</span><span class="ident" id="3898549">netFD</span><span class="op" id="3898554">)</span>&nbsp;<span class="ident" id="3898556">readMsg</span><span class="op" id="3898563">(</span><span class="ident" id="3898564">p</span>&nbsp;<span class="op" id="3898566">[</span><span class="op" id="3898567">]</span><span class="builtintype" id="3898568">byte</span><span class="op" id="3898572">,</span>&nbsp;<span class="ident" id="3898574">oob</span>&nbsp;<span class="op" id="3898578">[</span><span class="op" id="3898579">]</span><span class="builtintype" id="3898580">byte</span><span class="op" id="3898584">)</span>&nbsp;<span class="op" id="3898586">(</span><span class="ident" id="3898587">n</span><span class="op" id="3898588">,</span>&nbsp;<span class="ident" id="3898590">oobn</span><span class="op" id="3898594">,</span>&nbsp;<span class="ident" id="3898596">flags</span>&nbsp;<span class="builtintype" id="3898602">int</span><span class="op" id="3898605">,</span>&nbsp;<span class="ident" id="3898607">sa</span>&nbsp;<span class="ident" id="3898610">syscall</span><span class="op" id="3898617">.</span><span class="ident" id="3898618">Sockaddr</span><span class="op" id="3898626">,</span>&nbsp;<span class="ident" id="3898628">err</span>&nbsp;<span class="builtintype" id="3898632">error</span><span class="op" id="3898637">)</span>&nbsp;<span class="op" id="3898639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3898642">if</span>&nbsp;<span class="ident" id="3898645">err</span>&nbsp;<span class="op" id="3898649">:=</span>&nbsp;<span class="ident" id="3898652">fd</span><span class="op" id="3898654">.</span><span class="ident" id="3898655">readLock</span><span class="op" id="3898663">(</span><span class="op" id="3898664">)</span><span class="op" id="3898665">;</span>&nbsp;<span class="ident" id="3898667">err</span>&nbsp;<span class="op" id="3898671">!=</span>&nbsp;<span class="builtintype" id="3898674">nil</span>&nbsp;<span class="op" id="3898678">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3898682">return</span>&nbsp;<span class="num" id="3898689">0</span><span class="op" id="3898690">,</span>&nbsp;<span class="num" id="3898692">0</span><span class="op" id="3898693">,</span>&nbsp;<span class="num" id="3898695">0</span><span class="op" id="3898696">,</span>&nbsp;<span class="builtintype" id="3898698">nil</span><span class="op" id="3898701">,</span>&nbsp;<span class="ident" id="3898703">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3898708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3898711">defer</span>&nbsp;<span class="ident" id="3898717">fd</span><span class="op" id="3898719">.</span><span class="ident" id="3898720">readUnlock</span><span class="op" id="3898730">(</span><span class="op" id="3898731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3898734">if</span>&nbsp;<span class="ident" id="3898737">err</span>&nbsp;<span class="op" id="3898741">:=</span>&nbsp;<span class="ident" id="3898744">fd</span><span class="op" id="3898746">.</span><span class="ident" id="3898747">pd</span><span class="op" id="3898749">.</span><span class="ident" id="3898750">PrepareRead</span><span class="op" id="3898761">(</span><span class="op" id="3898762">)</span><span class="op" id="3898763">;</span>&nbsp;<span class="ident" id="3898765">err</span>&nbsp;<span class="op" id="3898769">!=</span>&nbsp;<span class="builtintype" id="3898772">nil</span>&nbsp;<span class="op" id="3898776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3898780">return</span>&nbsp;<span class="num" id="3898787">0</span><span class="op" id="3898788">,</span>&nbsp;<span class="num" id="3898790">0</span><span class="op" id="3898791">,</span>&nbsp;<span class="num" id="3898793">0</span><span class="op" id="3898794">,</span>&nbsp;<span class="builtintype" id="3898796">nil</span><span class="op" id="3898799">,</span>&nbsp;<span class="op" id="3898801">&amp;</span><span class="ident" id="3898802">OpError</span><span class="op" id="3898809">{</span><span class="string" id="3898810">&#34;read&#34;</span><span class="op" id="3898816">,</span>&nbsp;<span class="ident" id="3898818">fd</span><span class="op" id="3898820">.</span><span class="ident" id="3898821">net</span><span class="op" id="3898824">,</span>&nbsp;<span class="ident" id="3898826">fd</span><span class="op" id="3898828">.</span><span class="ident" id="3898829">laddr</span><span class="op" id="3898834">,</span>&nbsp;<span class="ident" id="3898836">err</span><span class="op" id="3898839">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3898842">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3898845">for</span>&nbsp;<span class="op" id="3898849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3898853">n</span><span class="op" id="3898854">,</span>&nbsp;<span class="ident" id="3898856">oobn</span><span class="op" id="3898860">,</span>&nbsp;<span class="ident" id="3898862">flags</span><span class="op" id="3898867">,</span>&nbsp;<span class="ident" id="3898869">sa</span><span class="op" id="3898871">,</span>&nbsp;<span class="ident" id="3898873">err</span>&nbsp;<span class="op" id="3898877">=</span>&nbsp;<span class="ident" id="3898879">syscall</span><span class="op" id="3898886">.</span><span class="ident" id="3898887">Recvmsg</span><span class="op" id="3898894">(</span><span class="ident" id="3898895">fd</span><span class="op" id="3898897">.</span><span class="ident" id="3898898">sysfd</span><span class="op" id="3898903">,</span>&nbsp;<span class="ident" id="3898905">p</span><span class="op" id="3898906">,</span>&nbsp;<span class="ident" id="3898908">oob</span><span class="op" id="3898911">,</span>&nbsp;<span class="num" id="3898913">0</span><span class="op" id="3898914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3898918">if</span>&nbsp;<span class="ident" id="3898921">err</span>&nbsp;<span class="op" id="3898925">!=</span>&nbsp;<span class="builtintype" id="3898928">nil</span>&nbsp;<span class="op" id="3898932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3898937">//&nbsp;TODO(dfc)&nbsp;should&nbsp;n&nbsp;and&nbsp;oobn&nbsp;be&nbsp;set&nbsp;to&nbsp;0</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3898983">if</span>&nbsp;<span class="ident" id="3898986">err</span>&nbsp;<span class="op" id="3898990">==</span>&nbsp;<span class="ident" id="3898993">syscall</span><span class="op" id="3899000">.</span><span class="ident" id="3899001">EAGAIN</span>&nbsp;<span class="op" id="3899008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899014">if</span>&nbsp;<span class="ident" id="3899017">err</span>&nbsp;<span class="op" id="3899021">=</span>&nbsp;<span class="ident" id="3899023">fd</span><span class="op" id="3899025">.</span><span class="ident" id="3899026">pd</span><span class="op" id="3899028">.</span><span class="ident" id="3899029">WaitRead</span><span class="op" id="3899037">(</span><span class="op" id="3899038">)</span><span class="op" id="3899039">;</span>&nbsp;<span class="ident" id="3899041">err</span>&nbsp;<span class="op" id="3899045">==</span>&nbsp;<span class="builtintype" id="3899048">nil</span>&nbsp;<span class="op" id="3899052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899059">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3899072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3899077">}</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3899081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3899085">err</span>&nbsp;<span class="op" id="3899089">=</span>&nbsp;<span class="ident" id="3899091">chkReadErr</span><span class="op" id="3899101">(</span><span class="ident" id="3899102">n</span><span class="op" id="3899103">,</span>&nbsp;<span class="ident" id="3899105">err</span><span class="op" id="3899108">,</span>&nbsp;<span class="ident" id="3899110">fd</span><span class="op" id="3899112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899116">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3899123">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899126">if</span>&nbsp;<span class="ident" id="3899129">err</span>&nbsp;<span class="op" id="3899133">!=</span>&nbsp;<span class="builtintype" id="3899136">nil</span>&nbsp;<span class="op" id="3899140">&amp;&amp;</span>&nbsp;<span class="ident" id="3899143">err</span>&nbsp;<span class="op" id="3899147">!=</span>&nbsp;<span class="ident" id="3899150">io</span><span class="op" id="3899152">.</span><span class="ident" id="3899153">EOF</span>&nbsp;<span class="op" id="3899157">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3899161">err</span>&nbsp;<span class="op" id="3899165">=</span>&nbsp;<span class="op" id="3899167">&amp;</span><span class="ident" id="3899168">OpError</span><span class="op" id="3899175">{</span><span class="string" id="3899176">&#34;read&#34;</span><span class="op" id="3899182">,</span>&nbsp;<span class="ident" id="3899184">fd</span><span class="op" id="3899186">.</span><span class="ident" id="3899187">net</span><span class="op" id="3899190">,</span>&nbsp;<span class="ident" id="3899192">fd</span><span class="op" id="3899194">.</span><span class="ident" id="3899195">laddr</span><span class="op" id="3899200">,</span>&nbsp;<span class="ident" id="3899202">err</span><span class="op" id="3899205">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3899208">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899211">return</span><br>
<span class="lineno"></span><span class="op" id="3899218">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">310</span><span class="keyword" id="3899221">func</span>&nbsp;<span class="ident" id="3899226">chkReadErr</span><span class="op" id="3899236">(</span><span class="ident" id="3899237">n</span>&nbsp;<span class="builtintype" id="3899239">int</span><span class="op" id="3899242">,</span>&nbsp;<span class="ident" id="3899244">err</span>&nbsp;<span class="builtintype" id="3899248">error</span><span class="op" id="3899253">,</span>&nbsp;<span class="ident" id="3899255">fd</span>&nbsp;<span class="op" id="3899258">*</span><span class="ident" id="3899259">netFD</span><span class="op" id="3899264">)</span>&nbsp;<span class="builtintype" id="3899266">error</span>&nbsp;<span class="op" id="3899272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899275">if</span>&nbsp;<span class="ident" id="3899278">n</span>&nbsp;<span class="op" id="3899280">==</span>&nbsp;<span class="num" id="3899283">0</span>&nbsp;<span class="op" id="3899285">&amp;&amp;</span>&nbsp;<span class="ident" id="3899288">err</span>&nbsp;<span class="op" id="3899292">==</span>&nbsp;<span class="builtintype" id="3899295">nil</span>&nbsp;<span class="op" id="3899299">&amp;&amp;</span>&nbsp;<span class="ident" id="3899302">fd</span><span class="op" id="3899304">.</span><span class="ident" id="3899305">sotype</span>&nbsp;<span class="op" id="3899312">!=</span>&nbsp;<span class="ident" id="3899315">syscall</span><span class="op" id="3899322">.</span><span class="ident" id="3899323">SOCK_DGRAM</span>&nbsp;<span class="op" id="3899334">&amp;&amp;</span>&nbsp;<span class="ident" id="3899337">fd</span><span class="op" id="3899339">.</span><span class="ident" id="3899340">sotype</span>&nbsp;<span class="op" id="3899347">!=</span>&nbsp;<span class="ident" id="3899350">syscall</span><span class="op" id="3899357">.</span><span class="ident" id="3899358">SOCK_RAW</span>&nbsp;<span class="op" id="3899367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899371">return</span>&nbsp;<span class="ident" id="3899378">io</span><span class="op" id="3899380">.</span><span class="ident" id="3899381">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3899386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899389">return</span>&nbsp;<span class="ident" id="3899396">err</span><br>
<span class="lineno">315</span><span class="op" id="3899400">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3899403">func</span>&nbsp;<span class="op" id="3899408">(</span><span class="ident" id="3899409">fd</span>&nbsp;<span class="op" id="3899412">*</span><span class="ident" id="3899413">netFD</span><span class="op" id="3899418">)</span>&nbsp;<span class="ident" id="3899420">Write</span><span class="op" id="3899425">(</span><span class="ident" id="3899426">p</span>&nbsp;<span class="op" id="3899428">[</span><span class="op" id="3899429">]</span><span class="builtintype" id="3899430">byte</span><span class="op" id="3899434">)</span>&nbsp;<span class="op" id="3899436">(</span><span class="ident" id="3899437">nn</span>&nbsp;<span class="builtintype" id="3899440">int</span><span class="op" id="3899443">,</span>&nbsp;<span class="ident" id="3899445">err</span>&nbsp;<span class="builtintype" id="3899449">error</span><span class="op" id="3899454">)</span>&nbsp;<span class="op" id="3899456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899459">if</span>&nbsp;<span class="ident" id="3899462">err</span>&nbsp;<span class="op" id="3899466">:=</span>&nbsp;<span class="ident" id="3899469">fd</span><span class="op" id="3899471">.</span><span class="ident" id="3899472">writeLock</span><span class="op" id="3899481">(</span><span class="op" id="3899482">)</span><span class="op" id="3899483">;</span>&nbsp;<span class="ident" id="3899485">err</span>&nbsp;<span class="op" id="3899489">!=</span>&nbsp;<span class="builtintype" id="3899492">nil</span>&nbsp;<span class="op" id="3899496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899500">return</span>&nbsp;<span class="num" id="3899507">0</span><span class="op" id="3899508">,</span>&nbsp;<span class="ident" id="3899510">err</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3899515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899518">defer</span>&nbsp;<span class="ident" id="3899524">fd</span><span class="op" id="3899526">.</span><span class="ident" id="3899527">writeUnlock</span><span class="op" id="3899538">(</span><span class="op" id="3899539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899542">if</span>&nbsp;<span class="ident" id="3899545">err</span>&nbsp;<span class="op" id="3899549">:=</span>&nbsp;<span class="ident" id="3899552">fd</span><span class="op" id="3899554">.</span><span class="ident" id="3899555">pd</span><span class="op" id="3899557">.</span><span class="ident" id="3899558">PrepareWrite</span><span class="op" id="3899570">(</span><span class="op" id="3899571">)</span><span class="op" id="3899572">;</span>&nbsp;<span class="ident" id="3899574">err</span>&nbsp;<span class="op" id="3899578">!=</span>&nbsp;<span class="builtintype" id="3899581">nil</span>&nbsp;<span class="op" id="3899585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899589">return</span>&nbsp;<span class="num" id="3899596">0</span><span class="op" id="3899597">,</span>&nbsp;<span class="op" id="3899599">&amp;</span><span class="ident" id="3899600">OpError</span><span class="op" id="3899607">{</span><span class="string" id="3899608">&#34;write&#34;</span><span class="op" id="3899615">,</span>&nbsp;<span class="ident" id="3899617">fd</span><span class="op" id="3899619">.</span><span class="ident" id="3899620">net</span><span class="op" id="3899623">,</span>&nbsp;<span class="ident" id="3899625">fd</span><span class="op" id="3899627">.</span><span class="ident" id="3899628">raddr</span><span class="op" id="3899633">,</span>&nbsp;<span class="ident" id="3899635">err</span><span class="op" id="3899638">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3899641">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899644">for</span>&nbsp;<span class="op" id="3899648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899652">var</span>&nbsp;<span class="ident" id="3899656">n</span>&nbsp;<span class="builtintype" id="3899658">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3899664">n</span><span class="op" id="3899665">,</span>&nbsp;<span class="ident" id="3899667">err</span>&nbsp;<span class="op" id="3899671">=</span>&nbsp;<span class="ident" id="3899673">syscall</span><span class="op" id="3899680">.</span><span class="ident" id="3899681">Write</span><span class="op" id="3899686">(</span><span class="builtintype" id="3899687">int</span><span class="op" id="3899690">(</span><span class="ident" id="3899691">fd</span><span class="op" id="3899693">.</span><span class="ident" id="3899694">sysfd</span><span class="op" id="3899699">)</span><span class="op" id="3899700">,</span>&nbsp;<span class="ident" id="3899702">p</span><span class="op" id="3899703">[</span><span class="ident" id="3899704">nn</span><span class="op" id="3899706">:</span><span class="op" id="3899707">]</span><span class="op" id="3899708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899712">if</span>&nbsp;<span class="ident" id="3899715">n</span>&nbsp;<span class="op" id="3899717">&gt;</span>&nbsp;<span class="num" id="3899719">0</span>&nbsp;<span class="op" id="3899721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3899726">nn</span>&nbsp;<span class="op" id="3899729">+=</span>&nbsp;<span class="ident" id="3899732">n</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3899736">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899740">if</span>&nbsp;<span class="ident" id="3899743">nn</span>&nbsp;<span class="op" id="3899746">==</span>&nbsp;<span class="builtinfunc" id="3899749">len</span><span class="op" id="3899752">(</span><span class="ident" id="3899753">p</span><span class="op" id="3899754">)</span>&nbsp;<span class="op" id="3899756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899761">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3899769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899773">if</span>&nbsp;<span class="ident" id="3899776">err</span>&nbsp;<span class="op" id="3899780">==</span>&nbsp;<span class="ident" id="3899783">syscall</span><span class="op" id="3899790">.</span><span class="ident" id="3899791">EAGAIN</span>&nbsp;<span class="op" id="3899798">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899803">if</span>&nbsp;<span class="ident" id="3899806">err</span>&nbsp;<span class="op" id="3899810">=</span>&nbsp;<span class="ident" id="3899812">fd</span><span class="op" id="3899814">.</span><span class="ident" id="3899815">pd</span><span class="op" id="3899817">.</span><span class="ident" id="3899818">WaitWrite</span><span class="op" id="3899827">(</span><span class="op" id="3899828">)</span><span class="op" id="3899829">;</span>&nbsp;<span class="ident" id="3899831">err</span>&nbsp;<span class="op" id="3899835">==</span>&nbsp;<span class="builtintype" id="3899838">nil</span>&nbsp;<span class="op" id="3899842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899848">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3899860">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3899864">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899868">if</span>&nbsp;<span class="ident" id="3899871">err</span>&nbsp;<span class="op" id="3899875">!=</span>&nbsp;<span class="builtintype" id="3899878">nil</span>&nbsp;<span class="op" id="3899882">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3899887">n</span>&nbsp;<span class="op" id="3899889">=</span>&nbsp;<span class="num" id="3899891">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899896">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3899904">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899908">if</span>&nbsp;<span class="ident" id="3899911">n</span>&nbsp;<span class="op" id="3899913">==</span>&nbsp;<span class="num" id="3899916">0</span>&nbsp;<span class="op" id="3899918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3899923">err</span>&nbsp;<span class="op" id="3899927">=</span>&nbsp;<span class="ident" id="3899929">io</span><span class="op" id="3899931">.</span><span class="ident" id="3899932">ErrUnexpectedEOF</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899952">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3899960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3899963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899966">if</span>&nbsp;<span class="ident" id="3899969">err</span>&nbsp;<span class="op" id="3899973">!=</span>&nbsp;<span class="builtintype" id="3899976">nil</span>&nbsp;<span class="op" id="3899980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3899984">err</span>&nbsp;<span class="op" id="3899988">=</span>&nbsp;<span class="op" id="3899990">&amp;</span><span class="ident" id="3899991">OpError</span><span class="op" id="3899998">{</span><span class="string" id="3899999">&#34;write&#34;</span><span class="op" id="3900006">,</span>&nbsp;<span class="ident" id="3900008">fd</span><span class="op" id="3900010">.</span><span class="ident" id="3900011">net</span><span class="op" id="3900014">,</span>&nbsp;<span class="ident" id="3900016">fd</span><span class="op" id="3900018">.</span><span class="ident" id="3900019">raddr</span><span class="op" id="3900024">,</span>&nbsp;<span class="ident" id="3900026">err</span><span class="op" id="3900029">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3900032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3900035">return</span>&nbsp;<span class="ident" id="3900042">nn</span><span class="op" id="3900044">,</span>&nbsp;<span class="ident" id="3900046">err</span><br>
<span class="lineno"></span><span class="op" id="3900050">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3900053">func</span>&nbsp;<span class="op" id="3900058">(</span><span class="ident" id="3900059">fd</span>&nbsp;<span class="op" id="3900062">*</span><span class="ident" id="3900063">netFD</span><span class="op" id="3900068">)</span>&nbsp;<span class="ident" id="3900070">writeTo</span><span class="op" id="3900077">(</span><span class="ident" id="3900078">p</span>&nbsp;<span class="op" id="3900080">[</span><span class="op" id="3900081">]</span><span class="builtintype" id="3900082">byte</span><span class="op" id="3900086">,</span>&nbsp;<span class="ident" id="3900088">sa</span>&nbsp;<span class="ident" id="3900091">syscall</span><span class="op" id="3900098">.</span><span class="ident" id="3900099">Sockaddr</span><span class="op" id="3900107">)</span>&nbsp;<span class="op" id="3900109">(</span><span class="ident" id="3900110">n</span>&nbsp;<span class="builtintype" id="3900112">int</span><span class="op" id="3900115">,</span>&nbsp;<span class="ident" id="3900117">err</span>&nbsp;<span class="builtintype" id="3900121">error</span><span class="op" id="3900126">)</span>&nbsp;<span class="op" id="3900128">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3900131">if</span>&nbsp;<span class="ident" id="3900134">err</span>&nbsp;<span class="op" id="3900138">:=</span>&nbsp;<span class="ident" id="3900141">fd</span><span class="op" id="3900143">.</span><span class="ident" id="3900144">writeLock</span><span class="op" id="3900153">(</span><span class="op" id="3900154">)</span><span class="op" id="3900155">;</span>&nbsp;<span class="ident" id="3900157">err</span>&nbsp;<span class="op" id="3900161">!=</span>&nbsp;<span class="builtintype" id="3900164">nil</span>&nbsp;<span class="op" id="3900168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3900172">return</span>&nbsp;<span class="num" id="3900179">0</span><span class="op" id="3900180">,</span>&nbsp;<span class="ident" id="3900182">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3900187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3900190">defer</span>&nbsp;<span class="ident" id="3900196">fd</span><span class="op" id="3900198">.</span><span class="ident" id="3900199">writeUnlock</span><span class="op" id="3900210">(</span><span class="op" id="3900211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3900214">if</span>&nbsp;<span class="ident" id="3900217">err</span>&nbsp;<span class="op" id="3900221">:=</span>&nbsp;<span class="ident" id="3900224">fd</span><span class="op" id="3900226">.</span><span class="ident" id="3900227">pd</span><span class="op" id="3900229">.</span><span class="ident" id="3900230">PrepareWrite</span><span class="op" id="3900242">(</span><span class="op" id="3900243">)</span><span class="op" id="3900244">;</span>&nbsp;<span class="ident" id="3900246">err</span>&nbsp;<span class="op" id="3900250">!=</span>&nbsp;<span class="builtintype" id="3900253">nil</span>&nbsp;<span class="op" id="3900257">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3900261">return</span>&nbsp;<span class="num" id="3900268">0</span><span class="op" id="3900269">,</span>&nbsp;<span class="op" id="3900271">&amp;</span><span class="ident" id="3900272">OpError</span><span class="op" id="3900279">{</span><span class="string" id="3900280">&#34;write&#34;</span><span class="op" id="3900287">,</span>&nbsp;<span class="ident" id="3900289">fd</span><span class="op" id="3900291">.</span><span class="ident" id="3900292">net</span><span class="op" id="3900295">,</span>&nbsp;<span class="ident" id="3900297">fd</span><span class="op" id="3900299">.</span><span class="ident" id="3900300">raddr</span><span class="op" id="3900305">,</span>&nbsp;<span class="ident" id="3900307">err</span><span class="op" id="3900310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3900313">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3900316">for</span>&nbsp;<span class="op" id="3900320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3900324">err</span>&nbsp;<span class="op" id="3900328">=</span>&nbsp;<span class="ident" id="3900330">syscall</span><span class="op" id="3900337">.</span><span class="ident" id="3900338">Sendto</span><span class="op" id="3900344">(</span><span class="ident" id="3900345">fd</span><span class="op" id="3900347">.</span><span class="ident" id="3900348">sysfd</span><span class="op" id="3900353">,</span>&nbsp;<span class="ident" id="3900355">p</span><span class="op" id="3900356">,</span>&nbsp;<span class="num" id="3900358">0</span><span class="op" id="3900359">,</span>&nbsp;<span class="ident" id="3900361">sa</span><span class="op" id="3900363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3900367">if</span>&nbsp;<span class="ident" id="3900370">err</span>&nbsp;<span class="op" id="3900374">==</span>&nbsp;<span class="ident" id="3900377">syscall</span><span class="op" id="3900384">.</span><span class="ident" id="3900385">EAGAIN</span>&nbsp;<span class="op" id="3900392">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3900397">if</span>&nbsp;<span class="ident" id="3900400">err</span>&nbsp;<span class="op" id="3900404">=</span>&nbsp;<span class="ident" id="3900406">fd</span><span class="op" id="3900408">.</span><span class="ident" id="3900409">pd</span><span class="op" id="3900411">.</span><span class="ident" id="3900412">WaitWrite</span><span class="op" id="3900421">(</span><span class="op" id="3900422">)</span><span class="op" id="3900423">;</span>&nbsp;<span class="ident" id="3900425">err</span>&nbsp;<span class="op" id="3900429">==</span>&nbsp;<span class="builtintype" id="3900432">nil</span>&nbsp;<span class="op" id="3900436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3900442">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3900454">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3900458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3900462">break</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3900469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3900472">if</span>&nbsp;<span class="ident" id="3900475">err</span>&nbsp;<span class="op" id="3900479">==</span>&nbsp;<span class="builtintype" id="3900482">nil</span>&nbsp;<span class="op" id="3900486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3900490">n</span>&nbsp;<span class="op" id="3900492">=</span>&nbsp;<span class="builtinfunc" id="3900494">len</span><span class="op" id="3900497">(</span><span class="ident" id="3900498">p</span><span class="op" id="3900499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3900502">}</span>&nbsp;<span class="keyword" id="3900504">else</span>&nbsp;<span class="op" id="3900509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3900513">err</span>&nbsp;<span class="op" id="3900517">=</span>&nbsp;<span class="op" id="3900519">&amp;</span><span class="ident" id="3900520">OpError</span><span class="op" id="3900527">{</span><span class="string" id="3900528">&#34;write&#34;</span><span class="op" id="3900535">,</span>&nbsp;<span class="ident" id="3900537">fd</span><span class="op" id="3900539">.</span><span class="ident" id="3900540">net</span><span class="op" id="3900543">,</span>&nbsp;<span class="ident" id="3900545">fd</span><span class="op" id="3900547">.</span><span class="ident" id="3900548">raddr</span><span class="op" id="3900553">,</span>&nbsp;<span class="ident" id="3900555">err</span><span class="op" id="3900558">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3900561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3900564">return</span><br>
<span class="lineno"></span><span class="op" id="3900571">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3900574">func</span>&nbsp;<span class="op" id="3900579">(</span><span class="ident" id="3900580">fd</span>&nbsp;<span class="op" id="3900583">*</span><span class="ident" id="3900584">netFD</span><span class="op" id="3900589">)</span>&nbsp;<span class="ident" id="3900591">writeMsg</span><span class="op" id="3900599">(</span><span class="ident" id="3900600">p</span>&nbsp;<span class="op" id="3900602">[</span><span class="op" id="3900603">]</span><span class="builtintype" id="3900604">byte</span><span class="op" id="3900608">,</span>&nbsp;<span class="ident" id="3900610">oob</span>&nbsp;<span class="op" id="3900614">[</span><span class="op" id="3900615">]</span><span class="builtintype" id="3900616">byte</span><span class="op" id="3900620">,</span>&nbsp;<span class="ident" id="3900622">sa</span>&nbsp;<span class="ident" id="3900625">syscall</span><span class="op" id="3900632">.</span><span class="ident" id="3900633">Sockaddr</span><span class="op" id="3900641">)</span>&nbsp;<span class="op" id="3900643">(</span><span class="ident" id="3900644">n</span>&nbsp;<span class="builtintype" id="3900646">int</span><span class="op" id="3900649">,</span>&nbsp;<span class="ident" id="3900651">oobn</span>&nbsp;<span class="builtintype" id="3900656">int</span><span class="op" id="3900659">,</span>&nbsp;<span class="ident" id="3900661">err</span>&nbsp;<span class="builtintype" id="3900665">error</span><span class="op" id="3900670">)</span>&nbsp;<span class="op" id="3900672">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3900675">if</span>&nbsp;<span class="ident" id="3900678">err</span>&nbsp;<span class="op" id="3900682">:=</span>&nbsp;<span class="ident" id="3900685">fd</span><span class="op" id="3900687">.</span><span class="ident" id="3900688">writeLock</span><span class="op" id="3900697">(</span><span class="op" id="3900698">)</span><span class="op" id="3900699">;</span>&nbsp;<span class="ident" id="3900701">err</span>&nbsp;<span class="op" id="3900705">!=</span>&nbsp;<span class="builtintype" id="3900708">nil</span>&nbsp;<span class="op" id="3900712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3900716">return</span>&nbsp;<span class="num" id="3900723">0</span><span class="op" id="3900724">,</span>&nbsp;<span class="num" id="3900726">0</span><span class="op" id="3900727">,</span>&nbsp;<span class="ident" id="3900729">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3900734">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3900737">defer</span>&nbsp;<span class="ident" id="3900743">fd</span><span class="op" id="3900745">.</span><span class="ident" id="3900746">writeUnlock</span><span class="op" id="3900757">(</span><span class="op" id="3900758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3900761">if</span>&nbsp;<span class="ident" id="3900764">err</span>&nbsp;<span class="op" id="3900768">:=</span>&nbsp;<span class="ident" id="3900771">fd</span><span class="op" id="3900773">.</span><span class="ident" id="3900774">pd</span><span class="op" id="3900776">.</span><span class="ident" id="3900777">PrepareWrite</span><span class="op" id="3900789">(</span><span class="op" id="3900790">)</span><span class="op" id="3900791">;</span>&nbsp;<span class="ident" id="3900793">err</span>&nbsp;<span class="op" id="3900797">!=</span>&nbsp;<span class="builtintype" id="3900800">nil</span>&nbsp;<span class="op" id="3900804">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3900808">return</span>&nbsp;<span class="num" id="3900815">0</span><span class="op" id="3900816">,</span>&nbsp;<span class="num" id="3900818">0</span><span class="op" id="3900819">,</span>&nbsp;<span class="op" id="3900821">&amp;</span><span class="ident" id="3900822">OpError</span><span class="op" id="3900829">{</span><span class="string" id="3900830">&#34;write&#34;</span><span class="op" id="3900837">,</span>&nbsp;<span class="ident" id="3900839">fd</span><span class="op" id="3900841">.</span><span class="ident" id="3900842">net</span><span class="op" id="3900845">,</span>&nbsp;<span class="ident" id="3900847">fd</span><span class="op" id="3900849">.</span><span class="ident" id="3900850">raddr</span><span class="op" id="3900855">,</span>&nbsp;<span class="ident" id="3900857">err</span><span class="op" id="3900860">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3900863">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3900866">for</span>&nbsp;<span class="op" id="3900870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3900874">n</span><span class="op" id="3900875">,</span>&nbsp;<span class="ident" id="3900877">err</span>&nbsp;<span class="op" id="3900881">=</span>&nbsp;<span class="ident" id="3900883">syscall</span><span class="op" id="3900890">.</span><span class="ident" id="3900891">SendmsgN</span><span class="op" id="3900899">(</span><span class="ident" id="3900900">fd</span><span class="op" id="3900902">.</span><span class="ident" id="3900903">sysfd</span><span class="op" id="3900908">,</span>&nbsp;<span class="ident" id="3900910">p</span><span class="op" id="3900911">,</span>&nbsp;<span class="ident" id="3900913">oob</span><span class="op" id="3900916">,</span>&nbsp;<span class="ident" id="3900918">sa</span><span class="op" id="3900920">,</span>&nbsp;<span class="num" id="3900922">0</span><span class="op" id="3900923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3900927">if</span>&nbsp;<span class="ident" id="3900930">err</span>&nbsp;<span class="op" id="3900934">==</span>&nbsp;<span class="ident" id="3900937">syscall</span><span class="op" id="3900944">.</span><span class="ident" id="3900945">EAGAIN</span>&nbsp;<span class="op" id="3900952">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3900957">if</span>&nbsp;<span class="ident" id="3900960">err</span>&nbsp;<span class="op" id="3900964">=</span>&nbsp;<span class="ident" id="3900966">fd</span><span class="op" id="3900968">.</span><span class="ident" id="3900969">pd</span><span class="op" id="3900971">.</span><span class="ident" id="3900972">WaitWrite</span><span class="op" id="3900981">(</span><span class="op" id="3900982">)</span><span class="op" id="3900983">;</span>&nbsp;<span class="ident" id="3900985">err</span>&nbsp;<span class="op" id="3900989">==</span>&nbsp;<span class="builtintype" id="3900992">nil</span>&nbsp;<span class="op" id="3900996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3901002">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3901014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3901018">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3901022">break</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3901029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3901032">if</span>&nbsp;<span class="ident" id="3901035">err</span>&nbsp;<span class="op" id="3901039">==</span>&nbsp;<span class="builtintype" id="3901042">nil</span>&nbsp;<span class="op" id="3901046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3901050">oobn</span>&nbsp;<span class="op" id="3901055">=</span>&nbsp;<span class="builtinfunc" id="3901057">len</span><span class="op" id="3901060">(</span><span class="ident" id="3901061">oob</span><span class="op" id="3901064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3901067">}</span>&nbsp;<span class="keyword" id="3901069">else</span>&nbsp;<span class="op" id="3901074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3901078">err</span>&nbsp;<span class="op" id="3901082">=</span>&nbsp;<span class="op" id="3901084">&amp;</span><span class="ident" id="3901085">OpError</span><span class="op" id="3901092">{</span><span class="string" id="3901093">&#34;write&#34;</span><span class="op" id="3901100">,</span>&nbsp;<span class="ident" id="3901102">fd</span><span class="op" id="3901104">.</span><span class="ident" id="3901105">net</span><span class="op" id="3901108">,</span>&nbsp;<span class="ident" id="3901110">fd</span><span class="op" id="3901112">.</span><span class="ident" id="3901113">raddr</span><span class="op" id="3901118">,</span>&nbsp;<span class="ident" id="3901120">err</span><span class="op" id="3901123">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3901126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3901129">return</span><br>
<span class="lineno"></span><span class="op" id="3901136">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3901139">func</span>&nbsp;<span class="op" id="3901144">(</span><span class="ident" id="3901145">fd</span>&nbsp;<span class="op" id="3901148">*</span><span class="ident" id="3901149">netFD</span><span class="op" id="3901154">)</span>&nbsp;<span class="ident" id="3901156">accept</span><span class="op" id="3901162">(</span><span class="op" id="3901163">)</span>&nbsp;<span class="op" id="3901165">(</span><span class="ident" id="3901166">netfd</span>&nbsp;<span class="op" id="3901172">*</span><span class="ident" id="3901173">netFD</span><span class="op" id="3901178">,</span>&nbsp;<span class="ident" id="3901180">err</span>&nbsp;<span class="builtintype" id="3901184">error</span><span class="op" id="3901189">)</span>&nbsp;<span class="op" id="3901191">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3901194">if</span>&nbsp;<span class="ident" id="3901197">err</span>&nbsp;<span class="op" id="3901201">:=</span>&nbsp;<span class="ident" id="3901204">fd</span><span class="op" id="3901206">.</span><span class="ident" id="3901207">readLock</span><span class="op" id="3901215">(</span><span class="op" id="3901216">)</span><span class="op" id="3901217">;</span>&nbsp;<span class="ident" id="3901219">err</span>&nbsp;<span class="op" id="3901223">!=</span>&nbsp;<span class="builtintype" id="3901226">nil</span>&nbsp;<span class="op" id="3901230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3901234">return</span>&nbsp;<span class="builtintype" id="3901241">nil</span><span class="op" id="3901244">,</span>&nbsp;<span class="ident" id="3901246">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3901251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3901254">defer</span>&nbsp;<span class="ident" id="3901260">fd</span><span class="op" id="3901262">.</span><span class="ident" id="3901263">readUnlock</span><span class="op" id="3901273">(</span><span class="op" id="3901274">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3901278">var</span>&nbsp;<span class="ident" id="3901282">s</span>&nbsp;<span class="builtintype" id="3901284">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3901289">var</span>&nbsp;<span class="ident" id="3901293">rsa</span>&nbsp;<span class="ident" id="3901297">syscall</span><span class="op" id="3901304">.</span><span class="ident" id="3901305">Sockaddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3901315">if</span>&nbsp;<span class="ident" id="3901318">err</span>&nbsp;<span class="op" id="3901322">=</span>&nbsp;<span class="ident" id="3901324">fd</span><span class="op" id="3901326">.</span><span class="ident" id="3901327">pd</span><span class="op" id="3901329">.</span><span class="ident" id="3901330">PrepareRead</span><span class="op" id="3901341">(</span><span class="op" id="3901342">)</span><span class="op" id="3901343">;</span>&nbsp;<span class="ident" id="3901345">err</span>&nbsp;<span class="op" id="3901349">!=</span>&nbsp;<span class="builtintype" id="3901352">nil</span>&nbsp;<span class="op" id="3901356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3901360">return</span>&nbsp;<span class="builtintype" id="3901367">nil</span><span class="op" id="3901370">,</span>&nbsp;<span class="op" id="3901372">&amp;</span><span class="ident" id="3901373">OpError</span><span class="op" id="3901380">{</span><span class="string" id="3901381">&#34;accept&#34;</span><span class="op" id="3901389">,</span>&nbsp;<span class="ident" id="3901391">fd</span><span class="op" id="3901393">.</span><span class="ident" id="3901394">net</span><span class="op" id="3901397">,</span>&nbsp;<span class="ident" id="3901399">fd</span><span class="op" id="3901401">.</span><span class="ident" id="3901402">laddr</span><span class="op" id="3901407">,</span>&nbsp;<span class="ident" id="3901409">err</span><span class="op" id="3901412">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3901415">}</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3901418">for</span>&nbsp;<span class="op" id="3901422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3901426">s</span><span class="op" id="3901427">,</span>&nbsp;<span class="ident" id="3901429">rsa</span><span class="op" id="3901432">,</span>&nbsp;<span class="ident" id="3901434">err</span>&nbsp;<span class="op" id="3901438">=</span>&nbsp;<span class="ident" id="3901440">accept</span><span class="op" id="3901446">(</span><span class="ident" id="3901447">fd</span><span class="op" id="3901449">.</span><span class="ident" id="3901450">sysfd</span><span class="op" id="3901455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3901459">if</span>&nbsp;<span class="ident" id="3901462">err</span>&nbsp;<span class="op" id="3901466">!=</span>&nbsp;<span class="builtintype" id="3901469">nil</span>&nbsp;<span class="op" id="3901473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3901478">if</span>&nbsp;<span class="ident" id="3901481">err</span>&nbsp;<span class="op" id="3901485">==</span>&nbsp;<span class="ident" id="3901488">syscall</span><span class="op" id="3901495">.</span><span class="ident" id="3901496">EAGAIN</span>&nbsp;<span class="op" id="3901503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3901509">if</span>&nbsp;<span class="ident" id="3901512">err</span>&nbsp;<span class="op" id="3901516">=</span>&nbsp;<span class="ident" id="3901518">fd</span><span class="op" id="3901520">.</span><span class="ident" id="3901521">pd</span><span class="op" id="3901523">.</span><span class="ident" id="3901524">WaitRead</span><span class="op" id="3901532">(</span><span class="op" id="3901533">)</span><span class="op" id="3901534">;</span>&nbsp;<span class="ident" id="3901536">err</span>&nbsp;<span class="op" id="3901540">==</span>&nbsp;<span class="builtintype" id="3901543">nil</span>&nbsp;<span class="op" id="3901547">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3901554">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3901567">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3901572">}</span>&nbsp;<span class="keyword" id="3901574">else</span>&nbsp;<span class="keyword" id="3901579">if</span>&nbsp;<span class="ident" id="3901582">err</span>&nbsp;<span class="op" id="3901586">==</span>&nbsp;<span class="ident" id="3901589">syscall</span><span class="op" id="3901596">.</span><span class="ident" id="3901597">ECONNABORTED</span>&nbsp;<span class="op" id="3901610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3901616">//&nbsp;This&nbsp;means&nbsp;that&nbsp;a&nbsp;socket&nbsp;on&nbsp;the&nbsp;listen&nbsp;queue&nbsp;was&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3901679">//&nbsp;before&nbsp;we&nbsp;Accept()ed&nbsp;it;&nbsp;it&#39;s&nbsp;a&nbsp;silly&nbsp;error,&nbsp;so&nbsp;try&nbsp;again.</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3901745">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3901757">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3901762">return</span>&nbsp;<span class="builtintype" id="3901769">nil</span><span class="op" id="3901772">,</span>&nbsp;<span class="op" id="3901774">&amp;</span><span class="ident" id="3901775">OpError</span><span class="op" id="3901782">{</span><span class="string" id="3901783">&#34;accept&#34;</span><span class="op" id="3901791">,</span>&nbsp;<span class="ident" id="3901793">fd</span><span class="op" id="3901795">.</span><span class="ident" id="3901796">net</span><span class="op" id="3901799">,</span>&nbsp;<span class="ident" id="3901801">fd</span><span class="op" id="3901803">.</span><span class="ident" id="3901804">laddr</span><span class="op" id="3901809">,</span>&nbsp;<span class="ident" id="3901811">err</span><span class="op" id="3901814">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3901818">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3901822">break</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3901829">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3901833">if</span>&nbsp;<span class="ident" id="3901836">netfd</span><span class="op" id="3901841">,</span>&nbsp;<span class="ident" id="3901843">err</span>&nbsp;<span class="op" id="3901847">=</span>&nbsp;<span class="ident" id="3901849">newFD</span><span class="op" id="3901854">(</span><span class="ident" id="3901855">s</span><span class="op" id="3901856">,</span>&nbsp;<span class="ident" id="3901858">fd</span><span class="op" id="3901860">.</span><span class="ident" id="3901861">family</span><span class="op" id="3901867">,</span>&nbsp;<span class="ident" id="3901869">fd</span><span class="op" id="3901871">.</span><span class="ident" id="3901872">sotype</span><span class="op" id="3901878">,</span>&nbsp;<span class="ident" id="3901880">fd</span><span class="op" id="3901882">.</span><span class="ident" id="3901883">net</span><span class="op" id="3901886">)</span><span class="op" id="3901887">;</span>&nbsp;<span class="ident" id="3901889">err</span>&nbsp;<span class="op" id="3901893">!=</span>&nbsp;<span class="builtintype" id="3901896">nil</span>&nbsp;<span class="op" id="3901900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3901904">closesocket</span><span class="op" id="3901915">(</span><span class="ident" id="3901916">s</span><span class="op" id="3901917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3901921">return</span>&nbsp;<span class="builtintype" id="3901928">nil</span><span class="op" id="3901931">,</span>&nbsp;<span class="ident" id="3901933">err</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3901938">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3901941">if</span>&nbsp;<span class="ident" id="3901944">err</span>&nbsp;<span class="op" id="3901948">=</span>&nbsp;<span class="ident" id="3901950">netfd</span><span class="op" id="3901955">.</span><span class="ident" id="3901956">init</span><span class="op" id="3901960">(</span><span class="op" id="3901961">)</span><span class="op" id="3901962">;</span>&nbsp;<span class="ident" id="3901964">err</span>&nbsp;<span class="op" id="3901968">!=</span>&nbsp;<span class="builtintype" id="3901971">nil</span>&nbsp;<span class="op" id="3901975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3901979">fd</span><span class="op" id="3901981">.</span><span class="ident" id="3901982">Close</span><span class="op" id="3901987">(</span><span class="op" id="3901988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3901992">return</span>&nbsp;<span class="builtintype" id="3901999">nil</span><span class="op" id="3902002">,</span>&nbsp;<span class="ident" id="3902004">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3902009">}</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3902012">lsa</span><span class="op" id="3902015">,</span>&nbsp;<span class="ident" id="3902017">_</span>&nbsp;<span class="op" id="3902019">:=</span>&nbsp;<span class="ident" id="3902022">syscall</span><span class="op" id="3902029">.</span><span class="ident" id="3902030">Getsockname</span><span class="op" id="3902041">(</span><span class="ident" id="3902042">netfd</span><span class="op" id="3902047">.</span><span class="ident" id="3902048">sysfd</span><span class="op" id="3902053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3902056">netfd</span><span class="op" id="3902061">.</span><span class="ident" id="3902062">setAddr</span><span class="op" id="3902069">(</span><span class="ident" id="3902070">netfd</span><span class="op" id="3902075">.</span><span class="ident" id="3902076">addrFunc</span><span class="op" id="3902084">(</span><span class="op" id="3902085">)</span><span class="op" id="3902086">(</span><span class="ident" id="3902087">lsa</span><span class="op" id="3902090">)</span><span class="op" id="3902091">,</span>&nbsp;<span class="ident" id="3902093">netfd</span><span class="op" id="3902098">.</span><span class="ident" id="3902099">addrFunc</span><span class="op" id="3902107">(</span><span class="op" id="3902108">)</span><span class="op" id="3902109">(</span><span class="ident" id="3902110">rsa</span><span class="op" id="3902113">)</span><span class="op" id="3902114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3902117">return</span>&nbsp;<span class="ident" id="3902124">netfd</span><span class="op" id="3902129">,</span>&nbsp;<span class="builtintype" id="3902131">nil</span><br>
<span class="lineno"></span><span class="op" id="3902135">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span><span class="comment" id="3902138">//&nbsp;tryDupCloexec&nbsp;indicates&nbsp;whether&nbsp;F_DUPFD_CLOEXEC&nbsp;should&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="comment" id="3902205">//&nbsp;If&nbsp;the&nbsp;kernel&nbsp;doesn&#39;t&nbsp;support&nbsp;it,&nbsp;this&nbsp;is&nbsp;set&nbsp;to&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="3902260">var</span>&nbsp;<span class="ident" id="3902264">tryDupCloexec</span>&nbsp;<span class="op" id="3902278">=</span>&nbsp;<span class="builtintype" id="3902280">int32</span><span class="op" id="3902285">(</span><span class="num" id="3902286">1</span><span class="op" id="3902287">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3902290">func</span>&nbsp;<span class="ident" id="3902295">dupCloseOnExec</span><span class="op" id="3902309">(</span><span class="ident" id="3902310">fd</span>&nbsp;<span class="builtintype" id="3902313">int</span><span class="op" id="3902316">)</span>&nbsp;<span class="op" id="3902318">(</span><span class="ident" id="3902319">newfd</span>&nbsp;<span class="builtintype" id="3902325">int</span><span class="op" id="3902328">,</span>&nbsp;<span class="ident" id="3902330">err</span>&nbsp;<span class="builtintype" id="3902334">error</span><span class="op" id="3902339">)</span>&nbsp;<span class="op" id="3902341">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3902344">if</span>&nbsp;<span class="ident" id="3902347">atomic</span><span class="op" id="3902353">.</span><span class="ident" id="3902354">LoadInt32</span><span class="op" id="3902363">(</span><span class="op" id="3902364">&amp;</span><span class="ident" id="3902365">tryDupCloexec</span><span class="op" id="3902378">)</span>&nbsp;<span class="op" id="3902380">==</span>&nbsp;<span class="num" id="3902383">1</span>&nbsp;<span class="op" id="3902385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3902389">r0</span><span class="op" id="3902391">,</span>&nbsp;<span class="ident" id="3902393">_</span><span class="op" id="3902394">,</span>&nbsp;<span class="ident" id="3902396">e1</span>&nbsp;<span class="op" id="3902399">:=</span>&nbsp;<span class="ident" id="3902402">syscall</span><span class="op" id="3902409">.</span><span class="ident" id="3902410">Syscall</span><span class="op" id="3902417">(</span><span class="ident" id="3902418">syscall</span><span class="op" id="3902425">.</span><span class="ident" id="3902426">SYS_FCNTL</span><span class="op" id="3902435">,</span>&nbsp;<span class="builtintype" id="3902437">uintptr</span><span class="op" id="3902444">(</span><span class="ident" id="3902445">fd</span><span class="op" id="3902447">)</span><span class="op" id="3902448">,</span>&nbsp;<span class="ident" id="3902450">syscall</span><span class="op" id="3902457">.</span><span class="ident" id="3902458">F_DUPFD_CLOEXEC</span><span class="op" id="3902473">,</span>&nbsp;<span class="num" id="3902475">0</span><span class="op" id="3902476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3902480">if</span>&nbsp;<span class="ident" id="3902483">runtime</span><span class="op" id="3902490">.</span><span class="ident" id="3902491">GOOS</span>&nbsp;<span class="op" id="3902496">==</span>&nbsp;<span class="string" id="3902499">&#34;darwin&#34;</span>&nbsp;<span class="op" id="3902508">&amp;&amp;</span>&nbsp;<span class="ident" id="3902511">e1</span>&nbsp;<span class="op" id="3902514">==</span>&nbsp;<span class="ident" id="3902517">syscall</span><span class="op" id="3902524">.</span><span class="ident" id="3902525">EBADF</span>&nbsp;<span class="op" id="3902531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3902536">//&nbsp;On&nbsp;OS&nbsp;X&nbsp;10.6&nbsp;and&nbsp;below&nbsp;(but&nbsp;we&nbsp;only&nbsp;support</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3902586">//&nbsp;&gt;=&nbsp;10.6),&nbsp;F_DUPFD_CLOEXEC&nbsp;is&nbsp;unsupported</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3902633">//&nbsp;and&nbsp;fcntl&nbsp;there&nbsp;falls&nbsp;back&nbsp;(undocumented)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3902681">//&nbsp;to&nbsp;doing&nbsp;an&nbsp;ioctl&nbsp;instead,&nbsp;returning&nbsp;EBADF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3902730">//&nbsp;in&nbsp;this&nbsp;case&nbsp;because&nbsp;fd&nbsp;is&nbsp;not&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3902774">//&nbsp;expected&nbsp;device&nbsp;fd&nbsp;type.&nbsp;&nbsp;Treat&nbsp;it&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3902818">//&nbsp;EINVAL&nbsp;instead,&nbsp;so&nbsp;we&nbsp;fall&nbsp;back&nbsp;to&nbsp;the</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3902863">//&nbsp;normal&nbsp;dup&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3902886">//&nbsp;TODO:&nbsp;only&nbsp;do&nbsp;this&nbsp;on&nbsp;10.6&nbsp;if&nbsp;we&nbsp;can&nbsp;detect&nbsp;10.6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3902941">//&nbsp;cheaply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3902956">e1</span>&nbsp;<span class="op" id="3902959">=</span>&nbsp;<span class="ident" id="3902961">syscall</span><span class="op" id="3902968">.</span><span class="ident" id="3902969">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3902978">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3902982">switch</span>&nbsp;<span class="ident" id="3902989">e1</span>&nbsp;<span class="op" id="3902992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3902996">case</span>&nbsp;<span class="num" id="3903001">0</span><span class="op" id="3903002">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3903007">return</span>&nbsp;<span class="builtintype" id="3903014">int</span><span class="op" id="3903017">(</span><span class="ident" id="3903018">r0</span><span class="op" id="3903020">)</span><span class="op" id="3903021">,</span>&nbsp;<span class="builtintype" id="3903023">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3903029">case</span>&nbsp;<span class="ident" id="3903034">syscall</span><span class="op" id="3903041">.</span><span class="ident" id="3903042">EINVAL</span><span class="op" id="3903048">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3903053">//&nbsp;Old&nbsp;kernel.&nbsp;Fall&nbsp;back&nbsp;to&nbsp;the&nbsp;portable&nbsp;way</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3903101">//&nbsp;from&nbsp;now&nbsp;on.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3903120">atomic</span><span class="op" id="3903126">.</span><span class="ident" id="3903127">StoreInt32</span><span class="op" id="3903137">(</span><span class="op" id="3903138">&amp;</span><span class="ident" id="3903139">tryDupCloexec</span><span class="op" id="3903152">,</span>&nbsp;<span class="num" id="3903154">0</span><span class="op" id="3903155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3903159">default</span><span class="op" id="3903166">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3903171">return</span>&nbsp;<span class="op" id="3903178">-</span><span class="num" id="3903179">1</span><span class="op" id="3903180">,</span>&nbsp;<span class="ident" id="3903182">e1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3903187">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3903190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3903193">return</span>&nbsp;<span class="ident" id="3903200">dupCloseOnExecOld</span><span class="op" id="3903217">(</span><span class="ident" id="3903218">fd</span><span class="op" id="3903220">)</span><br>
<span class="lineno"></span><span class="op" id="3903222">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3903225">//&nbsp;dupCloseOnExecUnixOld&nbsp;is&nbsp;the&nbsp;traditional&nbsp;way&nbsp;to&nbsp;dup&nbsp;an&nbsp;fd&nbsp;and</span><br>
<span class="lineno">480</span><span class="comment" id="3903290">//&nbsp;set&nbsp;its&nbsp;O_CLOEXEC&nbsp;bit,&nbsp;using&nbsp;two&nbsp;system&nbsp;calls.</span><br>
<span class="lineno"></span><span class="keyword" id="3903340">func</span>&nbsp;<span class="ident" id="3903345">dupCloseOnExecOld</span><span class="op" id="3903362">(</span><span class="ident" id="3903363">fd</span>&nbsp;<span class="builtintype" id="3903366">int</span><span class="op" id="3903369">)</span>&nbsp;<span class="op" id="3903371">(</span><span class="ident" id="3903372">newfd</span>&nbsp;<span class="builtintype" id="3903378">int</span><span class="op" id="3903381">,</span>&nbsp;<span class="ident" id="3903383">err</span>&nbsp;<span class="builtintype" id="3903387">error</span><span class="op" id="3903392">)</span>&nbsp;<span class="op" id="3903394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3903397">syscall</span><span class="op" id="3903404">.</span><span class="ident" id="3903405">ForkLock</span><span class="op" id="3903413">.</span><span class="ident" id="3903414">RLock</span><span class="op" id="3903419">(</span><span class="op" id="3903420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3903423">defer</span>&nbsp;<span class="ident" id="3903429">syscall</span><span class="op" id="3903436">.</span><span class="ident" id="3903437">ForkLock</span><span class="op" id="3903445">.</span><span class="ident" id="3903446">RUnlock</span><span class="op" id="3903453">(</span><span class="op" id="3903454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3903457">newfd</span><span class="op" id="3903462">,</span>&nbsp;<span class="ident" id="3903464">err</span>&nbsp;<span class="op" id="3903468">=</span>&nbsp;<span class="ident" id="3903470">syscall</span><span class="op" id="3903477">.</span><span class="ident" id="3903478">Dup</span><span class="op" id="3903481">(</span><span class="ident" id="3903482">fd</span><span class="op" id="3903484">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3903487">if</span>&nbsp;<span class="ident" id="3903490">err</span>&nbsp;<span class="op" id="3903494">!=</span>&nbsp;<span class="builtintype" id="3903497">nil</span>&nbsp;<span class="op" id="3903501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3903505">return</span>&nbsp;<span class="op" id="3903512">-</span><span class="num" id="3903513">1</span><span class="op" id="3903514">,</span>&nbsp;<span class="ident" id="3903516">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3903521">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3903524">syscall</span><span class="op" id="3903531">.</span><span class="ident" id="3903532">CloseOnExec</span><span class="op" id="3903543">(</span><span class="ident" id="3903544">newfd</span><span class="op" id="3903549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3903552">return</span><br>
<span class="lineno">490</span><span class="op" id="3903559">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3903562">func</span>&nbsp;<span class="op" id="3903567">(</span><span class="ident" id="3903568">fd</span>&nbsp;<span class="op" id="3903571">*</span><span class="ident" id="3903572">netFD</span><span class="op" id="3903577">)</span>&nbsp;<span class="ident" id="3903579">dup</span><span class="op" id="3903582">(</span><span class="op" id="3903583">)</span>&nbsp;<span class="op" id="3903585">(</span><span class="ident" id="3903586">f</span>&nbsp;<span class="op" id="3903588">*</span><span class="ident" id="3903589">os</span><span class="op" id="3903591">.</span><span class="ident" id="3903592">File</span><span class="op" id="3903596">,</span>&nbsp;<span class="ident" id="3903598">err</span>&nbsp;<span class="builtintype" id="3903602">error</span><span class="op" id="3903607">)</span>&nbsp;<span class="op" id="3903609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3903612">ns</span><span class="op" id="3903614">,</span>&nbsp;<span class="ident" id="3903616">err</span>&nbsp;<span class="op" id="3903620">:=</span>&nbsp;<span class="ident" id="3903623">dupCloseOnExec</span><span class="op" id="3903637">(</span><span class="ident" id="3903638">fd</span><span class="op" id="3903640">.</span><span class="ident" id="3903641">sysfd</span><span class="op" id="3903646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3903649">if</span>&nbsp;<span class="ident" id="3903652">err</span>&nbsp;<span class="op" id="3903656">!=</span>&nbsp;<span class="builtintype" id="3903659">nil</span>&nbsp;<span class="op" id="3903663">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3903667">return</span>&nbsp;<span class="builtintype" id="3903674">nil</span><span class="op" id="3903677">,</span>&nbsp;<span class="op" id="3903679">&amp;</span><span class="ident" id="3903680">OpError</span><span class="op" id="3903687">{</span><span class="string" id="3903688">&#34;dup&#34;</span><span class="op" id="3903693">,</span>&nbsp;<span class="ident" id="3903695">fd</span><span class="op" id="3903697">.</span><span class="ident" id="3903698">net</span><span class="op" id="3903701">,</span>&nbsp;<span class="ident" id="3903703">fd</span><span class="op" id="3903705">.</span><span class="ident" id="3903706">laddr</span><span class="op" id="3903711">,</span>&nbsp;<span class="ident" id="3903713">err</span><span class="op" id="3903716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3903719">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3903723">//&nbsp;We&nbsp;want&nbsp;blocking&nbsp;mode&nbsp;for&nbsp;the&nbsp;new&nbsp;fd,&nbsp;hence&nbsp;the&nbsp;double&nbsp;negative.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3903792">//&nbsp;This&nbsp;also&nbsp;puts&nbsp;the&nbsp;old&nbsp;fd&nbsp;into&nbsp;blocking&nbsp;mode,&nbsp;meaning&nbsp;that</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3903855">//&nbsp;I/O&nbsp;will&nbsp;block&nbsp;the&nbsp;thread&nbsp;instead&nbsp;of&nbsp;letting&nbsp;us&nbsp;use&nbsp;the&nbsp;epoll&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3903929">//&nbsp;Everything&nbsp;will&nbsp;still&nbsp;work,&nbsp;just&nbsp;with&nbsp;more&nbsp;threads.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3903985">if</span>&nbsp;<span class="ident" id="3903988">err</span>&nbsp;<span class="op" id="3903992">=</span>&nbsp;<span class="ident" id="3903994">syscall</span><span class="op" id="3904001">.</span><span class="ident" id="3904002">SetNonblock</span><span class="op" id="3904013">(</span><span class="ident" id="3904014">ns</span><span class="op" id="3904016">,</span>&nbsp;<span class="builtintype" id="3904018">false</span><span class="op" id="3904023">)</span><span class="op" id="3904024">;</span>&nbsp;<span class="ident" id="3904026">err</span>&nbsp;<span class="op" id="3904030">!=</span>&nbsp;<span class="builtintype" id="3904033">nil</span>&nbsp;<span class="op" id="3904037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3904041">return</span>&nbsp;<span class="builtintype" id="3904048">nil</span><span class="op" id="3904051">,</span>&nbsp;<span class="op" id="3904053">&amp;</span><span class="ident" id="3904054">OpError</span><span class="op" id="3904061">{</span><span class="string" id="3904062">&#34;setnonblock&#34;</span><span class="op" id="3904075">,</span>&nbsp;<span class="ident" id="3904077">fd</span><span class="op" id="3904079">.</span><span class="ident" id="3904080">net</span><span class="op" id="3904083">,</span>&nbsp;<span class="ident" id="3904085">fd</span><span class="op" id="3904087">.</span><span class="ident" id="3904088">laddr</span><span class="op" id="3904093">,</span>&nbsp;<span class="ident" id="3904095">err</span><span class="op" id="3904098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3904101">}</span><br>
<span class="lineno">505</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3904105">return</span>&nbsp;<span class="ident" id="3904112">os</span><span class="op" id="3904114">.</span><span class="ident" id="3904115">NewFile</span><span class="op" id="3904122">(</span><span class="builtintype" id="3904123">uintptr</span><span class="op" id="3904130">(</span><span class="ident" id="3904131">ns</span><span class="op" id="3904133">)</span><span class="op" id="3904134">,</span>&nbsp;<span class="ident" id="3904136">fd</span><span class="op" id="3904138">.</span><span class="ident" id="3904139">name</span><span class="op" id="3904143">(</span><span class="op" id="3904144">)</span><span class="op" id="3904145">)</span><span class="op" id="3904146">,</span>&nbsp;<span class="builtintype" id="3904148">nil</span><br>
<span class="lineno"></span><span class="op" id="3904152">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3904155">func</span>&nbsp;<span class="ident" id="3904160">closesocket</span><span class="op" id="3904171">(</span><span class="ident" id="3904172">s</span>&nbsp;<span class="builtintype" id="3904174">int</span><span class="op" id="3904177">)</span>&nbsp;<span class="builtintype" id="3904179">error</span>&nbsp;<span class="op" id="3904185">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3904188">return</span>&nbsp;<span class="ident" id="3904195">syscall</span><span class="op" id="3904202">.</span><span class="ident" id="3904203">Close</span><span class="op" id="3904208">(</span><span class="ident" id="3904209">s</span><span class="op" id="3904210">)</span><br>
<span class="lineno"></span><span class="op" id="3904212">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3904215">func</span>&nbsp;<span class="ident" id="3904220">skipRawSocketTests</span><span class="op" id="3904238">(</span><span class="op" id="3904239">)</span>&nbsp;<span class="op" id="3904241">(</span><span class="ident" id="3904242">skip</span>&nbsp;<span class="builtintype" id="3904247">bool</span><span class="op" id="3904251">,</span>&nbsp;<span class="ident" id="3904253">skipmsg</span>&nbsp;<span class="builtintype" id="3904261">string</span><span class="op" id="3904267">,</span>&nbsp;<span class="ident" id="3904269">err</span>&nbsp;<span class="builtintype" id="3904273">error</span><span class="op" id="3904278">)</span>&nbsp;<span class="op" id="3904280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3904283">if</span>&nbsp;<span class="ident" id="3904286">os</span><span class="op" id="3904288">.</span><span class="ident" id="3904289">Getuid</span><span class="op" id="3904295">(</span><span class="op" id="3904296">)</span>&nbsp;<span class="op" id="3904298">!=</span>&nbsp;<span class="num" id="3904301">0</span>&nbsp;<span class="op" id="3904303">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3904307">return</span>&nbsp;<span class="builtintype" id="3904314">true</span><span class="op" id="3904318">,</span>&nbsp;<span class="string" id="3904320">&#34;skipping&nbsp;test;&nbsp;must&nbsp;be&nbsp;root&#34;</span><span class="op" id="3904349">,</span>&nbsp;<span class="builtintype" id="3904351">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3904356">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3904359">return</span>&nbsp;<span class="builtintype" id="3904366">false</span><span class="op" id="3904371">,</span>&nbsp;<span class="string" id="3904373">&#34;&#34;</span><span class="op" id="3904375">,</span>&nbsp;<span class="builtintype" id="3904377">nil</span><br>
<span class="lineno"></span><span class="op" id="3904381">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
