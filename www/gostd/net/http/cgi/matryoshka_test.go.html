<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/cgi</h2>
<ul>
<li><a href="/gostd/net/http/cgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/cgi/child_test.go.html">child_test.go</a></li>
<li><a href="/gostd/net/http/cgi/host.go.html">host.go</a></li>
<li><a href="/gostd/net/http/cgi/host_test.go.html">host_test.go</a></li>
<li><a href="/gostd/net/http/cgi/matryoshka_test.go.html">matryoshka_test.go</a></li>
<li><a href="/gostd/net/http/cgi/posix_test.go.html">posix_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7240984">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7241039">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7241093">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="7241144">//&nbsp;Tests&nbsp;a&nbsp;Go&nbsp;CGI&nbsp;program&nbsp;running&nbsp;under&nbsp;a&nbsp;Go&nbsp;CGI&nbsp;host&nbsp;process.</span><br>
<span class="lineno"></span><span class="comment" id="7241207">//&nbsp;Further,&nbsp;the&nbsp;two&nbsp;programs&nbsp;are&nbsp;the&nbsp;same&nbsp;binary,&nbsp;just&nbsp;checking</span><br>
<span class="lineno"></span><span class="comment" id="7241271">//&nbsp;their&nbsp;environment&nbsp;to&nbsp;figure&nbsp;out&nbsp;what&nbsp;mode&nbsp;to&nbsp;run&nbsp;in.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7241328">package</span>&nbsp;<span class="ident" id="7241336">cgi</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="7241341">import</span>&nbsp;<span class="op" id="7241348">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7241351">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7241360">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7241370">&#34;fmt&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7241377">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7241383">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7241395">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7241416">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7241422">&#34;runtime&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7241433">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7241444">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7241451">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7241454">//&nbsp;This&nbsp;test&nbsp;is&nbsp;a&nbsp;CGI&nbsp;host&nbsp;(testing&nbsp;host.go)&nbsp;that&nbsp;runs&nbsp;its&nbsp;own&nbsp;binary</span><br>
<span class="lineno">25</span><span class="comment" id="7241524">//&nbsp;as&nbsp;a&nbsp;child&nbsp;process&nbsp;testing&nbsp;the&nbsp;other&nbsp;half&nbsp;of&nbsp;CGI&nbsp;(child.go).</span><br>
<span class="lineno"></span><span class="keyword" id="7241588">func</span>&nbsp;<span class="ident" id="7241593">TestHostingOurselves</span><span class="op" id="7241613">(</span><span class="ident" id="7241614">t</span>&nbsp;<span class="op" id="7241616">*</span><span class="ident" id="7241617">testing</span><span class="op" id="7241624">.</span><span class="ident" id="7241625">T</span><span class="op" id="7241626">)</span>&nbsp;<span class="op" id="7241628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7241631">if</span>&nbsp;<span class="ident" id="7241634">runtime</span><span class="op" id="7241641">.</span><span class="ident" id="7241642">GOOS</span>&nbsp;<span class="op" id="7241647">==</span>&nbsp;<span class="string" id="7241650">&#34;nacl&#34;</span>&nbsp;<span class="op" id="7241657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7241661">t</span><span class="op" id="7241662">.</span><span class="ident" id="7241663">Skip</span><span class="op" id="7241667">(</span><span class="string" id="7241668">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="7241686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7241689">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7241693">h</span>&nbsp;<span class="op" id="7241695">:=</span>&nbsp;<span class="op" id="7241698">&amp;</span><span class="ident" id="7241699">Handler</span><span class="op" id="7241706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7241710">Path</span><span class="op" id="7241714">:</span>&nbsp;<span class="ident" id="7241716">os</span><span class="op" id="7241718">.</span><span class="ident" id="7241719">Args</span><span class="op" id="7241723">[</span><span class="num" id="7241724">0</span><span class="op" id="7241725">]</span><span class="op" id="7241726">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7241730">Root</span><span class="op" id="7241734">:</span>&nbsp;<span class="string" id="7241736">&#34;/test.go&#34;</span><span class="op" id="7241746">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7241750">Args</span><span class="op" id="7241754">:</span>&nbsp;<span class="op" id="7241756">[</span><span class="op" id="7241757">]</span><span class="builtintype" id="7241758">string</span><span class="op" id="7241764">{</span><span class="string" id="7241765">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="7241798">}</span><span class="op" id="7241799">,</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7241802">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7241805">expectedMap</span>&nbsp;<span class="op" id="7241817">:=</span>&nbsp;<span class="keyword" id="7241820">map</span><span class="op" id="7241823">[</span><span class="builtintype" id="7241824">string</span><span class="op" id="7241830">]</span><span class="builtintype" id="7241831">string</span><span class="op" id="7241837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7241841">&#34;test&#34;</span><span class="op" id="7241847">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7241866">&#34;Hello&nbsp;CGI-in-CGI&#34;</span><span class="op" id="7241884">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7241888">&#34;param-a&#34;</span><span class="op" id="7241897">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7241913">&#34;b&#34;</span><span class="op" id="7241916">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7241920">&#34;param-foo&#34;</span><span class="op" id="7241931">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7241945">&#34;bar&#34;</span><span class="op" id="7241950">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7241954">&#34;env-GATEWAY_INTERFACE&#34;</span><span class="op" id="7241977">:</span>&nbsp;<span class="string" id="7241979">&#34;CGI/1.1&#34;</span><span class="op" id="7241988">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7241992">&#34;env-HTTP_HOST&#34;</span><span class="op" id="7242007">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7242017">&#34;example.com&#34;</span><span class="op" id="7242030">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7242034">&#34;env-PATH_INFO&#34;</span><span class="op" id="7242049">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7242059">&#34;&#34;</span><span class="op" id="7242061">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7242065">&#34;env-QUERY_STRING&#34;</span><span class="op" id="7242083">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7242090">&#34;foo=bar&amp;a=b&#34;</span><span class="op" id="7242103">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7242107">&#34;env-REMOTE_ADDR&#34;</span><span class="op" id="7242124">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7242132">&#34;1.2.3.4&#34;</span><span class="op" id="7242141">,</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7242145">&#34;env-REMOTE_HOST&#34;</span><span class="op" id="7242162">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7242170">&#34;1.2.3.4&#34;</span><span class="op" id="7242179">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7242183">&#34;env-REQUEST_METHOD&#34;</span><span class="op" id="7242203">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7242208">&#34;GET&#34;</span><span class="op" id="7242213">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7242217">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7242234">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7242242">&#34;/test.go?foo=bar&amp;a=b&#34;</span><span class="op" id="7242264">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7242268">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7242289">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="7242293">os</span><span class="op" id="7242295">.</span><span class="ident" id="7242296">Args</span><span class="op" id="7242300">[</span><span class="num" id="7242301">0</span><span class="op" id="7242302">]</span><span class="op" id="7242303">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7242307">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="7242324">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7242332">&#34;/test.go&#34;</span><span class="op" id="7242342">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7242346">&#34;env-SERVER_NAME&#34;</span><span class="op" id="7242363">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7242371">&#34;example.com&#34;</span><span class="op" id="7242384">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7242388">&#34;env-SERVER_PORT&#34;</span><span class="op" id="7242405">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7242413">&#34;80&#34;</span><span class="op" id="7242417">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7242421">&#34;env-SERVER_SOFTWARE&#34;</span><span class="op" id="7242442">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="7242446">&#34;go&#34;</span><span class="op" id="7242450">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7242453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7242456">replay</span>&nbsp;<span class="op" id="7242463">:=</span>&nbsp;<span class="ident" id="7242466">runCgiTest</span><span class="op" id="7242476">(</span><span class="ident" id="7242477">t</span><span class="op" id="7242478">,</span>&nbsp;<span class="ident" id="7242480">h</span><span class="op" id="7242481">,</span>&nbsp;<span class="string" id="7242483">&#34;GET&nbsp;/test.go?foo=bar&amp;a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7242541">,</span>&nbsp;<span class="ident" id="7242543">expectedMap</span><span class="op" id="7242554">)</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7242558">if</span>&nbsp;<span class="ident" id="7242561">expected</span><span class="op" id="7242569">,</span>&nbsp;<span class="ident" id="7242571">got</span>&nbsp;<span class="op" id="7242575">:=</span>&nbsp;<span class="string" id="7242578">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="7242604">,</span>&nbsp;<span class="ident" id="7242606">replay</span><span class="op" id="7242612">.</span><span class="ident" id="7242613">Header</span><span class="op" id="7242619">(</span><span class="op" id="7242620">)</span><span class="op" id="7242621">.</span><span class="ident" id="7242622">Get</span><span class="op" id="7242625">(</span><span class="string" id="7242626">&#34;Content-Type&#34;</span><span class="op" id="7242640">)</span><span class="op" id="7242641">;</span>&nbsp;<span class="ident" id="7242643">got</span>&nbsp;<span class="op" id="7242647">!=</span>&nbsp;<span class="ident" id="7242650">expected</span>&nbsp;<span class="op" id="7242659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7242663">t</span><span class="op" id="7242664">.</span><span class="ident" id="7242665">Errorf</span><span class="op" id="7242671">(</span><span class="string" id="7242672">&#34;got&nbsp;a&nbsp;Content-Type&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7242711">,</span>&nbsp;<span class="ident" id="7242713">got</span><span class="op" id="7242716">,</span>&nbsp;<span class="ident" id="7242718">expected</span><span class="op" id="7242726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7242729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7242732">if</span>&nbsp;<span class="ident" id="7242735">expected</span><span class="op" id="7242743">,</span>&nbsp;<span class="ident" id="7242745">got</span>&nbsp;<span class="op" id="7242749">:=</span>&nbsp;<span class="string" id="7242752">&#34;X-Test-Value&#34;</span><span class="op" id="7242766">,</span>&nbsp;<span class="ident" id="7242768">replay</span><span class="op" id="7242774">.</span><span class="ident" id="7242775">Header</span><span class="op" id="7242781">(</span><span class="op" id="7242782">)</span><span class="op" id="7242783">.</span><span class="ident" id="7242784">Get</span><span class="op" id="7242787">(</span><span class="string" id="7242788">&#34;X-Test-Header&#34;</span><span class="op" id="7242803">)</span><span class="op" id="7242804">;</span>&nbsp;<span class="ident" id="7242806">got</span>&nbsp;<span class="op" id="7242810">!=</span>&nbsp;<span class="ident" id="7242813">expected</span>&nbsp;<span class="op" id="7242822">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7242826">t</span><span class="op" id="7242827">.</span><span class="ident" id="7242828">Errorf</span><span class="op" id="7242834">(</span><span class="string" id="7242835">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7242875">,</span>&nbsp;<span class="ident" id="7242877">got</span><span class="op" id="7242880">,</span>&nbsp;<span class="ident" id="7242882">expected</span><span class="op" id="7242890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7242893">}</span><br>
<span class="lineno"></span><span class="op" id="7242895">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7242898">type</span>&nbsp;<span class="ident" id="7242903">customWriterRecorder</span>&nbsp;<span class="keyword" id="7242924">struct</span>&nbsp;<span class="op" id="7242931">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7242934">w</span>&nbsp;<span class="ident" id="7242936">io</span><span class="op" id="7242938">.</span><span class="ident" id="7242939">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7242947">*</span><span class="ident" id="7242948">httptest</span><span class="op" id="7242956">.</span><span class="ident" id="7242957">ResponseRecorder</span><br>
<span class="lineno"></span><span class="op" id="7242974">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7242977">func</span>&nbsp;<span class="op" id="7242982">(</span><span class="ident" id="7242983">r</span>&nbsp;<span class="op" id="7242985">*</span><span class="ident" id="7242986">customWriterRecorder</span><span class="op" id="7243006">)</span>&nbsp;<span class="ident" id="7243008">Write</span><span class="op" id="7243013">(</span><span class="ident" id="7243014">p</span>&nbsp;<span class="op" id="7243016">[</span><span class="op" id="7243017">]</span><span class="builtintype" id="7243018">byte</span><span class="op" id="7243022">)</span>&nbsp;<span class="op" id="7243024">(</span><span class="ident" id="7243025">n</span>&nbsp;<span class="builtintype" id="7243027">int</span><span class="op" id="7243030">,</span>&nbsp;<span class="ident" id="7243032">err</span>&nbsp;<span class="builtintype" id="7243036">error</span><span class="op" id="7243041">)</span>&nbsp;<span class="op" id="7243043">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7243046">return</span>&nbsp;<span class="ident" id="7243053">r</span><span class="op" id="7243054">.</span><span class="ident" id="7243055">w</span><span class="op" id="7243056">.</span><span class="ident" id="7243057">Write</span><span class="op" id="7243062">(</span><span class="ident" id="7243063">p</span><span class="op" id="7243064">)</span><br>
<span class="lineno"></span><span class="op" id="7243066">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7243069">type</span>&nbsp;<span class="ident" id="7243074">limitWriter</span>&nbsp;<span class="keyword" id="7243086">struct</span>&nbsp;<span class="op" id="7243093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7243096">w</span>&nbsp;<span class="ident" id="7243098">io</span><span class="op" id="7243100">.</span><span class="ident" id="7243101">Writer</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7243109">n</span>&nbsp;<span class="builtintype" id="7243111">int</span><br>
<span class="lineno"></span><span class="op" id="7243115">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7243118">func</span>&nbsp;<span class="op" id="7243123">(</span><span class="ident" id="7243124">w</span>&nbsp;<span class="op" id="7243126">*</span><span class="ident" id="7243127">limitWriter</span><span class="op" id="7243138">)</span>&nbsp;<span class="ident" id="7243140">Write</span><span class="op" id="7243145">(</span><span class="ident" id="7243146">p</span>&nbsp;<span class="op" id="7243148">[</span><span class="op" id="7243149">]</span><span class="builtintype" id="7243150">byte</span><span class="op" id="7243154">)</span>&nbsp;<span class="op" id="7243156">(</span><span class="ident" id="7243157">n</span>&nbsp;<span class="builtintype" id="7243159">int</span><span class="op" id="7243162">,</span>&nbsp;<span class="ident" id="7243164">err</span>&nbsp;<span class="builtintype" id="7243168">error</span><span class="op" id="7243173">)</span>&nbsp;<span class="op" id="7243175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7243178">if</span>&nbsp;<span class="builtinfunc" id="7243181">len</span><span class="op" id="7243184">(</span><span class="ident" id="7243185">p</span><span class="op" id="7243186">)</span>&nbsp;<span class="op" id="7243188">&gt;</span>&nbsp;<span class="ident" id="7243190">w</span><span class="op" id="7243191">.</span><span class="ident" id="7243192">n</span>&nbsp;<span class="op" id="7243194">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7243198">p</span>&nbsp;<span class="op" id="7243200">=</span>&nbsp;<span class="ident" id="7243202">p</span><span class="op" id="7243203">[</span><span class="op" id="7243204">:</span><span class="ident" id="7243205">w</span><span class="op" id="7243206">.</span><span class="ident" id="7243207">n</span><span class="op" id="7243208">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7243211">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7243214">if</span>&nbsp;<span class="builtinfunc" id="7243217">len</span><span class="op" id="7243220">(</span><span class="ident" id="7243221">p</span><span class="op" id="7243222">)</span>&nbsp;<span class="op" id="7243224">&gt;</span>&nbsp;<span class="num" id="7243226">0</span>&nbsp;<span class="op" id="7243228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7243232">n</span><span class="op" id="7243233">,</span>&nbsp;<span class="ident" id="7243235">err</span>&nbsp;<span class="op" id="7243239">=</span>&nbsp;<span class="ident" id="7243241">w</span><span class="op" id="7243242">.</span><span class="ident" id="7243243">w</span><span class="op" id="7243244">.</span><span class="ident" id="7243245">Write</span><span class="op" id="7243250">(</span><span class="ident" id="7243251">p</span><span class="op" id="7243252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7243256">w</span><span class="op" id="7243257">.</span><span class="ident" id="7243258">n</span>&nbsp;<span class="op" id="7243260">-=</span>&nbsp;<span class="ident" id="7243263">n</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7243266">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7243269">if</span>&nbsp;<span class="ident" id="7243272">w</span><span class="op" id="7243273">.</span><span class="ident" id="7243274">n</span>&nbsp;<span class="op" id="7243276">==</span>&nbsp;<span class="num" id="7243279">0</span>&nbsp;<span class="op" id="7243281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7243285">err</span>&nbsp;<span class="op" id="7243289">=</span>&nbsp;<span class="ident" id="7243291">errors</span><span class="op" id="7243297">.</span><span class="ident" id="7243298">New</span><span class="op" id="7243301">(</span><span class="string" id="7243302">&#34;past&nbsp;write&nbsp;limit&#34;</span><span class="op" id="7243320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7243323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7243326">return</span><br>
<span class="lineno">90</span><span class="op" id="7243333">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7243336">//&nbsp;If&nbsp;there&#39;s&nbsp;an&nbsp;error&nbsp;copying&nbsp;the&nbsp;child&#39;s&nbsp;output&nbsp;to&nbsp;the&nbsp;parent,&nbsp;test</span><br>
<span class="lineno"></span><span class="comment" id="7243406">//&nbsp;that&nbsp;we&nbsp;kill&nbsp;the&nbsp;child.</span><br>
<span class="lineno"></span><span class="keyword" id="7243433">func</span>&nbsp;<span class="ident" id="7243438">TestKillChildAfterCopyError</span><span class="op" id="7243465">(</span><span class="ident" id="7243466">t</span>&nbsp;<span class="op" id="7243468">*</span><span class="ident" id="7243469">testing</span><span class="op" id="7243476">.</span><span class="ident" id="7243477">T</span><span class="op" id="7243478">)</span>&nbsp;<span class="op" id="7243480">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7243483">if</span>&nbsp;<span class="ident" id="7243486">runtime</span><span class="op" id="7243493">.</span><span class="ident" id="7243494">GOOS</span>&nbsp;<span class="op" id="7243499">==</span>&nbsp;<span class="string" id="7243502">&#34;nacl&#34;</span>&nbsp;<span class="op" id="7243509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7243513">t</span><span class="op" id="7243514">.</span><span class="ident" id="7243515">Skip</span><span class="op" id="7243519">(</span><span class="string" id="7243520">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="7243538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7243541">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7243545">defer</span>&nbsp;<span class="keyword" id="7243551">func</span><span class="op" id="7243555">(</span><span class="op" id="7243556">)</span>&nbsp;<span class="op" id="7243558">{</span>&nbsp;<span class="ident" id="7243560">testHookStartProcess</span>&nbsp;<span class="op" id="7243581">=</span>&nbsp;<span class="ident" id="7243583">nil</span>&nbsp;<span class="op" id="7243587">}</span><span class="op" id="7243588">(</span><span class="op" id="7243589">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7243592">proc</span>&nbsp;<span class="op" id="7243597">:=</span>&nbsp;<span class="builtinfunc" id="7243600">make</span><span class="op" id="7243604">(</span><span class="keyword" id="7243605">chan</span>&nbsp;<span class="op" id="7243610">*</span><span class="ident" id="7243611">os</span><span class="op" id="7243613">.</span><span class="ident" id="7243614">Process</span><span class="op" id="7243621">,</span>&nbsp;<span class="num" id="7243623">1</span><span class="op" id="7243624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7243627">testHookStartProcess</span>&nbsp;<span class="op" id="7243648">=</span>&nbsp;<span class="keyword" id="7243650">func</span><span class="op" id="7243654">(</span><span class="ident" id="7243655">p</span>&nbsp;<span class="op" id="7243657">*</span><span class="ident" id="7243658">os</span><span class="op" id="7243660">.</span><span class="ident" id="7243661">Process</span><span class="op" id="7243668">)</span>&nbsp;<span class="op" id="7243670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7243674">proc</span>&nbsp;<span class="op" id="7243679">&lt;-</span>&nbsp;<span class="ident" id="7243682">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7243685">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7243689">h</span>&nbsp;<span class="op" id="7243691">:=</span>&nbsp;<span class="op" id="7243694">&amp;</span><span class="ident" id="7243695">Handler</span><span class="op" id="7243702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7243706">Path</span><span class="op" id="7243710">:</span>&nbsp;<span class="ident" id="7243712">os</span><span class="op" id="7243714">.</span><span class="ident" id="7243715">Args</span><span class="op" id="7243719">[</span><span class="num" id="7243720">0</span><span class="op" id="7243721">]</span><span class="op" id="7243722">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7243726">Root</span><span class="op" id="7243730">:</span>&nbsp;<span class="string" id="7243732">&#34;/test.go&#34;</span><span class="op" id="7243742">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7243746">Args</span><span class="op" id="7243750">:</span>&nbsp;<span class="op" id="7243752">[</span><span class="op" id="7243753">]</span><span class="builtintype" id="7243754">string</span><span class="op" id="7243760">{</span><span class="string" id="7243761">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="7243794">}</span><span class="op" id="7243795">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7243798">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7243801">req</span><span class="op" id="7243804">,</span>&nbsp;<span class="ident" id="7243806">_</span>&nbsp;<span class="op" id="7243808">:=</span>&nbsp;<span class="ident" id="7243811">http</span><span class="op" id="7243815">.</span><span class="ident" id="7243816">NewRequest</span><span class="op" id="7243826">(</span><span class="string" id="7243827">&#34;GET&#34;</span><span class="op" id="7243832">,</span>&nbsp;<span class="string" id="7243834">&#34;http://example.com/test.cgi?write-forever=1&#34;</span><span class="op" id="7243879">,</span>&nbsp;<span class="ident" id="7243881">nil</span><span class="op" id="7243884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7243887">rec</span>&nbsp;<span class="op" id="7243891">:=</span>&nbsp;<span class="ident" id="7243894">httptest</span><span class="op" id="7243902">.</span><span class="ident" id="7243903">NewRecorder</span><span class="op" id="7243914">(</span><span class="op" id="7243915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7243918">var</span>&nbsp;<span class="ident" id="7243922">out</span>&nbsp;<span class="ident" id="7243926">bytes</span><span class="op" id="7243931">.</span><span class="ident" id="7243932">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7243940">const</span>&nbsp;<span class="ident" id="7243946">writeLen</span>&nbsp;<span class="op" id="7243955">=</span>&nbsp;<span class="num" id="7243957">50</span>&nbsp;<span class="op" id="7243960">&lt;&lt;</span>&nbsp;<span class="num" id="7243963">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7243967">rw</span>&nbsp;<span class="op" id="7243970">:=</span>&nbsp;<span class="op" id="7243973">&amp;</span><span class="ident" id="7243974">customWriterRecorder</span><span class="op" id="7243994">{</span><span class="op" id="7243995">&amp;</span><span class="ident" id="7243996">limitWriter</span><span class="op" id="7244007">{</span><span class="op" id="7244008">&amp;</span><span class="ident" id="7244009">out</span><span class="op" id="7244012">,</span>&nbsp;<span class="ident" id="7244014">writeLen</span><span class="op" id="7244022">}</span><span class="op" id="7244023">,</span>&nbsp;<span class="ident" id="7244025">rec</span><span class="op" id="7244028">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7244032">donec</span>&nbsp;<span class="op" id="7244038">:=</span>&nbsp;<span class="builtinfunc" id="7244041">make</span><span class="op" id="7244045">(</span><span class="keyword" id="7244046">chan</span>&nbsp;<span class="builtintype" id="7244051">bool</span><span class="op" id="7244055">,</span>&nbsp;<span class="num" id="7244057">1</span><span class="op" id="7244058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7244061">go</span>&nbsp;<span class="keyword" id="7244064">func</span><span class="op" id="7244068">(</span><span class="op" id="7244069">)</span>&nbsp;<span class="op" id="7244071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7244075">h</span><span class="op" id="7244076">.</span><span class="ident" id="7244077">ServeHTTP</span><span class="op" id="7244086">(</span><span class="ident" id="7244087">rw</span><span class="op" id="7244089">,</span>&nbsp;<span class="ident" id="7244091">req</span><span class="op" id="7244094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7244098">donec</span>&nbsp;<span class="op" id="7244104">&lt;-</span>&nbsp;<span class="builtintype" id="7244107">true</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7244113">}</span><span class="op" id="7244114">(</span><span class="op" id="7244115">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7244119">select</span>&nbsp;<span class="op" id="7244126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7244129">case</span>&nbsp;<span class="op" id="7244134">&lt;-</span><span class="ident" id="7244136">donec</span><span class="op" id="7244141">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7244145">if</span>&nbsp;<span class="ident" id="7244148">out</span><span class="op" id="7244151">.</span><span class="ident" id="7244152">Len</span><span class="op" id="7244155">(</span><span class="op" id="7244156">)</span>&nbsp;<span class="op" id="7244158">!=</span>&nbsp;<span class="ident" id="7244161">writeLen</span>&nbsp;<span class="op" id="7244170">||</span>&nbsp;<span class="ident" id="7244173">out</span><span class="op" id="7244176">.</span><span class="ident" id="7244177">Bytes</span><span class="op" id="7244182">(</span><span class="op" id="7244183">)</span><span class="op" id="7244184">[</span><span class="num" id="7244185">0</span><span class="op" id="7244186">]</span>&nbsp;<span class="op" id="7244188">!=</span>&nbsp;<span class="string" id="7244191">&#39;a&#39;</span>&nbsp;<span class="op" id="7244195">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7244200">t</span><span class="op" id="7244201">.</span><span class="ident" id="7244202">Errorf</span><span class="op" id="7244208">(</span><span class="string" id="7244209">&#34;unexpected&nbsp;output:&nbsp;%q&#34;</span><span class="op" id="7244232">,</span>&nbsp;<span class="ident" id="7244234">out</span><span class="op" id="7244237">.</span><span class="ident" id="7244238">Bytes</span><span class="op" id="7244243">(</span><span class="op" id="7244244">)</span><span class="op" id="7244245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7244249">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7244252">case</span>&nbsp;<span class="op" id="7244257">&lt;-</span><span class="ident" id="7244259">time</span><span class="op" id="7244263">.</span><span class="ident" id="7244264">After</span><span class="op" id="7244269">(</span><span class="num" id="7244270">5</span>&nbsp;<span class="op" id="7244272">*</span>&nbsp;<span class="ident" id="7244274">time</span><span class="op" id="7244278">.</span><span class="ident" id="7244279">Second</span><span class="op" id="7244285">)</span><span class="op" id="7244286">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7244290">t</span><span class="op" id="7244291">.</span><span class="ident" id="7244292">Errorf</span><span class="op" id="7244298">(</span><span class="string" id="7244299">&#34;timeout.&nbsp;ServeHTTP&nbsp;hung&nbsp;and&nbsp;didn&#39;t&nbsp;kill&nbsp;the&nbsp;child&nbsp;process?&#34;</span><span class="op" id="7244359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7244363">select</span>&nbsp;<span class="op" id="7244370">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7244374">case</span>&nbsp;<span class="ident" id="7244379">p</span>&nbsp;<span class="op" id="7244381">:=</span>&nbsp;<span class="op" id="7244384">&lt;-</span><span class="ident" id="7244386">proc</span><span class="op" id="7244390">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7244395">p</span><span class="op" id="7244396">.</span><span class="ident" id="7244397">Kill</span><span class="op" id="7244401">(</span><span class="op" id="7244402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7244407">t</span><span class="op" id="7244408">.</span><span class="ident" id="7244409">Logf</span><span class="op" id="7244413">(</span><span class="string" id="7244414">&#34;killed&nbsp;process&#34;</span><span class="op" id="7244430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7244434">default</span><span class="op" id="7244441">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7244446">t</span><span class="op" id="7244447">.</span><span class="ident" id="7244448">Logf</span><span class="op" id="7244452">(</span><span class="string" id="7244453">&#34;didn&#39;t&nbsp;kill&nbsp;process&#34;</span><span class="op" id="7244474">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7244478">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7244481">}</span><br>
<span class="lineno"></span><span class="op" id="7244483">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7244486">//&nbsp;Test&nbsp;that&nbsp;a&nbsp;child&nbsp;handler&nbsp;writing&nbsp;only&nbsp;headers&nbsp;works.</span><br>
<span class="lineno">140</span><span class="comment" id="7244543">//&nbsp;golang.org/issue/7196</span><br>
<span class="lineno"></span><span class="keyword" id="7244568">func</span>&nbsp;<span class="ident" id="7244573">TestChildOnlyHeaders</span><span class="op" id="7244593">(</span><span class="ident" id="7244594">t</span>&nbsp;<span class="op" id="7244596">*</span><span class="ident" id="7244597">testing</span><span class="op" id="7244604">.</span><span class="ident" id="7244605">T</span><span class="op" id="7244606">)</span>&nbsp;<span class="op" id="7244608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7244611">if</span>&nbsp;<span class="ident" id="7244614">runtime</span><span class="op" id="7244621">.</span><span class="ident" id="7244622">GOOS</span>&nbsp;<span class="op" id="7244627">==</span>&nbsp;<span class="string" id="7244630">&#34;nacl&#34;</span>&nbsp;<span class="op" id="7244637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7244641">t</span><span class="op" id="7244642">.</span><span class="ident" id="7244643">Skip</span><span class="op" id="7244647">(</span><span class="string" id="7244648">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="7244666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7244669">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7244673">h</span>&nbsp;<span class="op" id="7244675">:=</span>&nbsp;<span class="op" id="7244678">&amp;</span><span class="ident" id="7244679">Handler</span><span class="op" id="7244686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7244690">Path</span><span class="op" id="7244694">:</span>&nbsp;<span class="ident" id="7244696">os</span><span class="op" id="7244698">.</span><span class="ident" id="7244699">Args</span><span class="op" id="7244703">[</span><span class="num" id="7244704">0</span><span class="op" id="7244705">]</span><span class="op" id="7244706">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7244710">Root</span><span class="op" id="7244714">:</span>&nbsp;<span class="string" id="7244716">&#34;/test.go&#34;</span><span class="op" id="7244726">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7244730">Args</span><span class="op" id="7244734">:</span>&nbsp;<span class="op" id="7244736">[</span><span class="op" id="7244737">]</span><span class="builtintype" id="7244738">string</span><span class="op" id="7244744">{</span><span class="string" id="7244745">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="7244778">}</span><span class="op" id="7244779">,</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7244782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7244785">expectedMap</span>&nbsp;<span class="op" id="7244797">:=</span>&nbsp;<span class="keyword" id="7244800">map</span><span class="op" id="7244803">[</span><span class="builtintype" id="7244804">string</span><span class="op" id="7244810">]</span><span class="builtintype" id="7244811">string</span><span class="op" id="7244817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7244821">&#34;_body&#34;</span><span class="op" id="7244828">:</span>&nbsp;<span class="string" id="7244830">&#34;&#34;</span><span class="op" id="7244832">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7244835">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7244838">replay</span>&nbsp;<span class="op" id="7244845">:=</span>&nbsp;<span class="ident" id="7244848">runCgiTest</span><span class="op" id="7244858">(</span><span class="ident" id="7244859">t</span><span class="op" id="7244860">,</span>&nbsp;<span class="ident" id="7244862">h</span><span class="op" id="7244863">,</span>&nbsp;<span class="string" id="7244865">&#34;GET&nbsp;/test.go?no-body=1&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7244921">,</span>&nbsp;<span class="ident" id="7244923">expectedMap</span><span class="op" id="7244934">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7244937">if</span>&nbsp;<span class="ident" id="7244940">expected</span><span class="op" id="7244948">,</span>&nbsp;<span class="ident" id="7244950">got</span>&nbsp;<span class="op" id="7244954">:=</span>&nbsp;<span class="string" id="7244957">&#34;X-Test-Value&#34;</span><span class="op" id="7244971">,</span>&nbsp;<span class="ident" id="7244973">replay</span><span class="op" id="7244979">.</span><span class="ident" id="7244980">Header</span><span class="op" id="7244986">(</span><span class="op" id="7244987">)</span><span class="op" id="7244988">.</span><span class="ident" id="7244989">Get</span><span class="op" id="7244992">(</span><span class="string" id="7244993">&#34;X-Test-Header&#34;</span><span class="op" id="7245008">)</span><span class="op" id="7245009">;</span>&nbsp;<span class="ident" id="7245011">got</span>&nbsp;<span class="op" id="7245015">!=</span>&nbsp;<span class="ident" id="7245018">expected</span>&nbsp;<span class="op" id="7245027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7245031">t</span><span class="op" id="7245032">.</span><span class="ident" id="7245033">Errorf</span><span class="op" id="7245039">(</span><span class="string" id="7245040">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7245080">,</span>&nbsp;<span class="ident" id="7245082">got</span><span class="op" id="7245085">,</span>&nbsp;<span class="ident" id="7245087">expected</span><span class="op" id="7245095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7245098">}</span><br>
<span class="lineno"></span><span class="op" id="7245100">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment" id="7245103">//&nbsp;golang.org/issue/7198</span><br>
<span class="lineno"></span><span class="keyword" id="7245128">func</span>&nbsp;<span class="ident" id="7245133">Test500WithNoHeaders</span><span class="op" id="7245153">(</span><span class="ident" id="7245154">t</span>&nbsp;<span class="op" id="7245156">*</span><span class="ident" id="7245157">testing</span><span class="op" id="7245164">.</span><span class="ident" id="7245165">T</span><span class="op" id="7245166">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7245172">{</span>&nbsp;<span class="ident" id="7245174">want500Test</span><span class="op" id="7245185">(</span><span class="ident" id="7245186">t</span><span class="op" id="7245187">,</span>&nbsp;<span class="string" id="7245189">&#34;/immediate-disconnect&#34;</span><span class="op" id="7245212">)</span>&nbsp;<span class="op" id="7245214">}</span><br>
<span class="lineno"></span><span class="keyword" id="7245216">func</span>&nbsp;<span class="ident" id="7245221">Test500WithNoContentType</span><span class="op" id="7245245">(</span><span class="ident" id="7245246">t</span>&nbsp;<span class="op" id="7245248">*</span><span class="ident" id="7245249">testing</span><span class="op" id="7245256">.</span><span class="ident" id="7245257">T</span><span class="op" id="7245258">)</span>&nbsp;<span class="op" id="7245260">{</span>&nbsp;<span class="ident" id="7245262">want500Test</span><span class="op" id="7245273">(</span><span class="ident" id="7245274">t</span><span class="op" id="7245275">,</span>&nbsp;<span class="string" id="7245277">&#34;/no-content-type&#34;</span><span class="op" id="7245295">)</span>&nbsp;<span class="op" id="7245297">}</span><br>
<span class="lineno"></span><span class="keyword" id="7245299">func</span>&nbsp;<span class="ident" id="7245304">Test500WithEmptyHeaders</span><span class="op" id="7245327">(</span><span class="ident" id="7245328">t</span>&nbsp;<span class="op" id="7245330">*</span><span class="ident" id="7245331">testing</span><span class="op" id="7245338">.</span><span class="ident" id="7245339">T</span><span class="op" id="7245340">)</span>&nbsp;&nbsp;<span class="op" id="7245343">{</span>&nbsp;<span class="ident" id="7245345">want500Test</span><span class="op" id="7245356">(</span><span class="ident" id="7245357">t</span><span class="op" id="7245358">,</span>&nbsp;<span class="string" id="7245360">&#34;/empty-headers&#34;</span><span class="op" id="7245376">)</span>&nbsp;<span class="op" id="7245378">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="7245381">func</span>&nbsp;<span class="ident" id="7245386">want500Test</span><span class="op" id="7245397">(</span><span class="ident" id="7245398">t</span>&nbsp;<span class="op" id="7245400">*</span><span class="ident" id="7245401">testing</span><span class="op" id="7245408">.</span><span class="ident" id="7245409">T</span><span class="op" id="7245410">,</span>&nbsp;<span class="ident" id="7245412">path</span>&nbsp;<span class="builtintype" id="7245417">string</span><span class="op" id="7245423">)</span>&nbsp;<span class="op" id="7245425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7245428">h</span>&nbsp;<span class="op" id="7245430">:=</span>&nbsp;<span class="op" id="7245433">&amp;</span><span class="ident" id="7245434">Handler</span><span class="op" id="7245441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7245445">Path</span><span class="op" id="7245449">:</span>&nbsp;<span class="ident" id="7245451">os</span><span class="op" id="7245453">.</span><span class="ident" id="7245454">Args</span><span class="op" id="7245458">[</span><span class="num" id="7245459">0</span><span class="op" id="7245460">]</span><span class="op" id="7245461">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7245465">Root</span><span class="op" id="7245469">:</span>&nbsp;<span class="string" id="7245471">&#34;/test.go&#34;</span><span class="op" id="7245481">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7245485">Args</span><span class="op" id="7245489">:</span>&nbsp;<span class="op" id="7245491">[</span><span class="op" id="7245492">]</span><span class="builtintype" id="7245493">string</span><span class="op" id="7245499">{</span><span class="string" id="7245500">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="7245533">}</span><span class="op" id="7245534">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7245537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7245540">expectedMap</span>&nbsp;<span class="op" id="7245552">:=</span>&nbsp;<span class="keyword" id="7245555">map</span><span class="op" id="7245558">[</span><span class="builtintype" id="7245559">string</span><span class="op" id="7245565">]</span><span class="builtintype" id="7245566">string</span><span class="op" id="7245572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7245576">&#34;_body&#34;</span><span class="op" id="7245583">:</span>&nbsp;<span class="string" id="7245585">&#34;&#34;</span><span class="op" id="7245587">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7245590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7245593">replay</span>&nbsp;<span class="op" id="7245600">:=</span>&nbsp;<span class="ident" id="7245603">runCgiTest</span><span class="op" id="7245613">(</span><span class="ident" id="7245614">t</span><span class="op" id="7245615">,</span>&nbsp;<span class="ident" id="7245617">h</span><span class="op" id="7245618">,</span>&nbsp;<span class="string" id="7245620">&#34;GET&nbsp;&#34;</span><span class="op" id="7245626">+</span><span class="ident" id="7245627">path</span><span class="op" id="7245631">+</span><span class="string" id="7245632">&#34;&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7245666">,</span>&nbsp;<span class="ident" id="7245668">expectedMap</span><span class="op" id="7245679">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7245682">if</span>&nbsp;<span class="ident" id="7245685">replay</span><span class="op" id="7245691">.</span><span class="ident" id="7245692">Code</span>&nbsp;<span class="op" id="7245697">!=</span>&nbsp;<span class="num" id="7245700">500</span>&nbsp;<span class="op" id="7245704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7245708">t</span><span class="op" id="7245709">.</span><span class="ident" id="7245710">Errorf</span><span class="op" id="7245716">(</span><span class="string" id="7245717">&#34;Got&nbsp;code&nbsp;%d;&nbsp;want&nbsp;500&#34;</span><span class="op" id="7245740">,</span>&nbsp;<span class="ident" id="7245742">replay</span><span class="op" id="7245748">.</span><span class="ident" id="7245749">Code</span><span class="op" id="7245753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7245756">}</span><br>
<span class="lineno"></span><span class="op" id="7245758">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="7245761">type</span>&nbsp;<span class="ident" id="7245766">neverEnding</span>&nbsp;<span class="builtintype" id="7245778">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7245784">func</span>&nbsp;<span class="op" id="7245789">(</span><span class="ident" id="7245790">b</span>&nbsp;<span class="ident" id="7245792">neverEnding</span><span class="op" id="7245803">)</span>&nbsp;<span class="ident" id="7245805">Read</span><span class="op" id="7245809">(</span><span class="ident" id="7245810">p</span>&nbsp;<span class="op" id="7245812">[</span><span class="op" id="7245813">]</span><span class="builtintype" id="7245814">byte</span><span class="op" id="7245818">)</span>&nbsp;<span class="op" id="7245820">(</span><span class="ident" id="7245821">n</span>&nbsp;<span class="builtintype" id="7245823">int</span><span class="op" id="7245826">,</span>&nbsp;<span class="ident" id="7245828">err</span>&nbsp;<span class="builtintype" id="7245832">error</span><span class="op" id="7245837">)</span>&nbsp;<span class="op" id="7245839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7245842">for</span>&nbsp;<span class="ident" id="7245846">i</span>&nbsp;<span class="op" id="7245848">:=</span>&nbsp;<span class="keyword" id="7245851">range</span>&nbsp;<span class="ident" id="7245857">p</span>&nbsp;<span class="op" id="7245859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7245863">p</span><span class="op" id="7245864">[</span><span class="ident" id="7245865">i</span><span class="op" id="7245866">]</span>&nbsp;<span class="op" id="7245868">=</span>&nbsp;<span class="builtintype" id="7245870">byte</span><span class="op" id="7245874">(</span><span class="ident" id="7245875">b</span><span class="op" id="7245876">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7245879">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7245882">return</span>&nbsp;<span class="builtinfunc" id="7245889">len</span><span class="op" id="7245892">(</span><span class="ident" id="7245893">p</span><span class="op" id="7245894">)</span><span class="op" id="7245895">,</span>&nbsp;<span class="ident" id="7245897">nil</span><br>
<span class="lineno"></span><span class="op" id="7245901">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7245904">//&nbsp;Note:&nbsp;not&nbsp;actually&nbsp;a&nbsp;test.</span><br>
<span class="lineno">190</span><span class="keyword" id="7245934">func</span>&nbsp;<span class="ident" id="7245939">TestBeChildCGIProcess</span><span class="op" id="7245960">(</span><span class="ident" id="7245961">t</span>&nbsp;<span class="op" id="7245963">*</span><span class="ident" id="7245964">testing</span><span class="op" id="7245971">.</span><span class="ident" id="7245972">T</span><span class="op" id="7245973">)</span>&nbsp;<span class="op" id="7245975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7245978">if</span>&nbsp;<span class="ident" id="7245981">os</span><span class="op" id="7245983">.</span><span class="ident" id="7245984">Getenv</span><span class="op" id="7245990">(</span><span class="string" id="7245991">&#34;REQUEST_METHOD&#34;</span><span class="op" id="7246007">)</span>&nbsp;<span class="op" id="7246009">==</span>&nbsp;<span class="string" id="7246012">&#34;&#34;</span>&nbsp;<span class="op" id="7246015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7246019">//&nbsp;Not&nbsp;in&nbsp;a&nbsp;CGI&nbsp;environment;&nbsp;skipping&nbsp;test.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7246065">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7246073">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7246076">switch</span>&nbsp;<span class="ident" id="7246083">os</span><span class="op" id="7246085">.</span><span class="ident" id="7246086">Getenv</span><span class="op" id="7246092">(</span><span class="string" id="7246093">&#34;REQUEST_URI&#34;</span><span class="op" id="7246106">)</span>&nbsp;<span class="op" id="7246108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7246111">case</span>&nbsp;<span class="string" id="7246116">&#34;/immediate-disconnect&#34;</span><span class="op" id="7246139">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7246143">os</span><span class="op" id="7246145">.</span><span class="ident" id="7246146">Exit</span><span class="op" id="7246150">(</span><span class="num" id="7246151">0</span><span class="op" id="7246152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7246155">case</span>&nbsp;<span class="string" id="7246160">&#34;/no-content-type&#34;</span><span class="op" id="7246178">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7246182">fmt</span><span class="op" id="7246185">.</span><span class="ident" id="7246186">Printf</span><span class="op" id="7246192">(</span><span class="string" id="7246193">&#34;Content-Length:&nbsp;6\n\nHello\n&#34;</span><span class="op" id="7246223">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7246227">os</span><span class="op" id="7246229">.</span><span class="ident" id="7246230">Exit</span><span class="op" id="7246234">(</span><span class="num" id="7246235">0</span><span class="op" id="7246236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7246239">case</span>&nbsp;<span class="string" id="7246244">&#34;/empty-headers&#34;</span><span class="op" id="7246260">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7246264">fmt</span><span class="op" id="7246267">.</span><span class="ident" id="7246268">Printf</span><span class="op" id="7246274">(</span><span class="string" id="7246275">&#34;\nHello&#34;</span><span class="op" id="7246284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7246288">os</span><span class="op" id="7246290">.</span><span class="ident" id="7246291">Exit</span><span class="op" id="7246295">(</span><span class="num" id="7246296">0</span><span class="op" id="7246297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7246300">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7246303">Serve</span><span class="op" id="7246308">(</span><span class="ident" id="7246309">http</span><span class="op" id="7246313">.</span><span class="ident" id="7246314">HandlerFunc</span><span class="op" id="7246325">(</span><span class="keyword" id="7246326">func</span><span class="op" id="7246330">(</span><span class="ident" id="7246331">rw</span>&nbsp;<span class="ident" id="7246334">http</span><span class="op" id="7246338">.</span><span class="ident" id="7246339">ResponseWriter</span><span class="op" id="7246353">,</span>&nbsp;<span class="ident" id="7246355">req</span>&nbsp;<span class="op" id="7246359">*</span><span class="ident" id="7246360">http</span><span class="op" id="7246364">.</span><span class="ident" id="7246365">Request</span><span class="op" id="7246372">)</span>&nbsp;<span class="op" id="7246374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7246378">rw</span><span class="op" id="7246380">.</span><span class="ident" id="7246381">Header</span><span class="op" id="7246387">(</span><span class="op" id="7246388">)</span><span class="op" id="7246389">.</span><span class="ident" id="7246390">Set</span><span class="op" id="7246393">(</span><span class="string" id="7246394">&#34;X-Test-Header&#34;</span><span class="op" id="7246409">,</span>&nbsp;<span class="string" id="7246411">&#34;X-Test-Value&#34;</span><span class="op" id="7246425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7246429">req</span><span class="op" id="7246432">.</span><span class="ident" id="7246433">ParseForm</span><span class="op" id="7246442">(</span><span class="op" id="7246443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7246447">if</span>&nbsp;<span class="ident" id="7246450">req</span><span class="op" id="7246453">.</span><span class="ident" id="7246454">FormValue</span><span class="op" id="7246463">(</span><span class="string" id="7246464">&#34;no-body&#34;</span><span class="op" id="7246473">)</span>&nbsp;<span class="op" id="7246475">==</span>&nbsp;<span class="string" id="7246478">&#34;1&#34;</span>&nbsp;<span class="op" id="7246482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7246487">return</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7246496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7246500">if</span>&nbsp;<span class="ident" id="7246503">req</span><span class="op" id="7246506">.</span><span class="ident" id="7246507">FormValue</span><span class="op" id="7246516">(</span><span class="string" id="7246517">&#34;write-forever&#34;</span><span class="op" id="7246532">)</span>&nbsp;<span class="op" id="7246534">==</span>&nbsp;<span class="string" id="7246537">&#34;1&#34;</span>&nbsp;<span class="op" id="7246541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7246546">io</span><span class="op" id="7246548">.</span><span class="ident" id="7246549">Copy</span><span class="op" id="7246553">(</span><span class="ident" id="7246554">rw</span><span class="op" id="7246556">,</span>&nbsp;<span class="ident" id="7246558">neverEnding</span><span class="op" id="7246569">(</span><span class="string" id="7246570">&#39;a&#39;</span><span class="op" id="7246573">)</span><span class="op" id="7246574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7246579">for</span>&nbsp;<span class="op" id="7246583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7246589">time</span><span class="op" id="7246593">.</span><span class="ident" id="7246594">Sleep</span><span class="op" id="7246599">(</span><span class="num" id="7246600">5</span>&nbsp;<span class="op" id="7246602">*</span>&nbsp;<span class="ident" id="7246604">time</span><span class="op" id="7246608">.</span><span class="ident" id="7246609">Second</span><span class="op" id="7246615">)</span>&nbsp;<span class="comment" id="7246617">//&nbsp;hang&nbsp;forever,&nbsp;until&nbsp;killed</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7246650">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7246654">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7246658">fmt</span><span class="op" id="7246661">.</span><span class="ident" id="7246662">Fprintf</span><span class="op" id="7246669">(</span><span class="ident" id="7246670">rw</span><span class="op" id="7246672">,</span>&nbsp;<span class="string" id="7246674">&#34;test=Hello&nbsp;CGI-in-CGI\n&#34;</span><span class="op" id="7246699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7246703">for</span>&nbsp;<span class="ident" id="7246707">k</span><span class="op" id="7246708">,</span>&nbsp;<span class="ident" id="7246710">vv</span>&nbsp;<span class="op" id="7246713">:=</span>&nbsp;<span class="keyword" id="7246716">range</span>&nbsp;<span class="ident" id="7246722">req</span><span class="op" id="7246725">.</span><span class="ident" id="7246726">Form</span>&nbsp;<span class="op" id="7246731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7246736">for</span>&nbsp;<span class="ident" id="7246740">_</span><span class="op" id="7246741">,</span>&nbsp;<span class="ident" id="7246743">v</span>&nbsp;<span class="op" id="7246745">:=</span>&nbsp;<span class="keyword" id="7246748">range</span>&nbsp;<span class="ident" id="7246754">vv</span>&nbsp;<span class="op" id="7246757">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7246763">fmt</span><span class="op" id="7246766">.</span><span class="ident" id="7246767">Fprintf</span><span class="op" id="7246774">(</span><span class="ident" id="7246775">rw</span><span class="op" id="7246777">,</span>&nbsp;<span class="string" id="7246779">&#34;param-%s=%s\n&#34;</span><span class="op" id="7246794">,</span>&nbsp;<span class="ident" id="7246796">k</span><span class="op" id="7246797">,</span>&nbsp;<span class="ident" id="7246799">v</span><span class="op" id="7246800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7246805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7246809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7246813">for</span>&nbsp;<span class="ident" id="7246817">_</span><span class="op" id="7246818">,</span>&nbsp;<span class="ident" id="7246820">kv</span>&nbsp;<span class="op" id="7246823">:=</span>&nbsp;<span class="keyword" id="7246826">range</span>&nbsp;<span class="ident" id="7246832">os</span><span class="op" id="7246834">.</span><span class="ident" id="7246835">Environ</span><span class="op" id="7246842">(</span><span class="op" id="7246843">)</span>&nbsp;<span class="op" id="7246845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7246850">fmt</span><span class="op" id="7246853">.</span><span class="ident" id="7246854">Fprintf</span><span class="op" id="7246861">(</span><span class="ident" id="7246862">rw</span><span class="op" id="7246864">,</span>&nbsp;<span class="string" id="7246866">&#34;env-%s\n&#34;</span><span class="op" id="7246876">,</span>&nbsp;<span class="ident" id="7246878">kv</span><span class="op" id="7246880">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7246884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7246887">}</span><span class="op" id="7246888">)</span><span class="op" id="7246889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7246892">os</span><span class="op" id="7246894">.</span><span class="ident" id="7246895">Exit</span><span class="op" id="7246899">(</span><span class="num" id="7246900">0</span><span class="op" id="7246901">)</span><br>
<span class="lineno"></span><span class="op" id="7246903">}</span>
</div>
</body>
</html>
