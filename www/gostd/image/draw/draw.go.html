<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/draw</h2>
<ul>
<li><a href="/gostd/image/draw/bench_test.go.html">bench_test.go</a></li>
<li><a href="/gostd/image/draw/clip_test.go.html">clip_test.go</a></li>
<li><a href="/gostd/image/draw/draw.go.html" class="current">draw.go</a></li>
<li><a href="/gostd/image/draw/draw_test.go.html">draw_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5482997">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5483053">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5483107">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5483158">//&nbsp;Package&nbsp;draw&nbsp;provides&nbsp;image&nbsp;composition&nbsp;functions.</span><br>
<span class="lineno"></span><span class="comment" id="5483212">//</span><br>
<span class="lineno"></span><span class="comment" id="5483215">//&nbsp;See&nbsp;&#34;The&nbsp;Go&nbsp;image/draw&nbsp;package&#34;&nbsp;for&nbsp;an&nbsp;introduction&nbsp;to&nbsp;this&nbsp;package:</span><br>
<span class="lineno"></span><span class="comment" id="5483287">//&nbsp;http://golang.org/doc/articles/image_draw.html</span><br>
<span class="lineno"></span><span class="keyword" id="5483337">package</span>&nbsp;<span class="ident" id="5483345">draw</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="5483351">import</span>&nbsp;<span class="op" id="5483358">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5483361">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5483370">&#34;image/color&#34;</span><br>
<span class="lineno"></span><span class="op" id="5483384">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="5483387">//&nbsp;m&nbsp;is&nbsp;the&nbsp;maximum&nbsp;color&nbsp;value&nbsp;returned&nbsp;by&nbsp;image.Color.RGBA.</span><br>
<span class="lineno"></span><span class="keyword" id="5483449">const</span>&nbsp;<span class="ident" id="5483455">m</span>&nbsp;<span class="op" id="5483457">=</span>&nbsp;<span class="num" id="5483459">1</span><span class="op" id="5483460">&lt;&lt;</span><span class="num" id="5483462">16</span>&nbsp;<span class="op" id="5483465">-</span>&nbsp;<span class="num" id="5483467">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5483470">//&nbsp;Image&nbsp;is&nbsp;an&nbsp;image.Image&nbsp;with&nbsp;a&nbsp;Set&nbsp;method&nbsp;to&nbsp;change&nbsp;a&nbsp;single&nbsp;pixel.</span><br>
<span class="lineno">20</span><span class="keyword" id="5483541">type</span>&nbsp;<span class="ident" id="5483546">Image</span>&nbsp;<span class="keyword" id="5483552">interface</span>&nbsp;<span class="op" id="5483562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5483565">image</span><span class="op" id="5483570">.</span><span class="ident" id="5483571">Image</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5483578">Set</span><span class="op" id="5483581">(</span><span class="ident" id="5483582">x</span><span class="op" id="5483583">,</span>&nbsp;<span class="ident" id="5483585">y</span>&nbsp;<span class="builtintype" id="5483587">int</span><span class="op" id="5483590">,</span>&nbsp;<span class="ident" id="5483592">c</span>&nbsp;<span class="ident" id="5483594">color</span><span class="op" id="5483599">.</span><span class="ident" id="5483600">Color</span><span class="op" id="5483605">)</span><br>
<span class="lineno"></span><span class="op" id="5483607">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="5483610">//&nbsp;Quantizer&nbsp;produces&nbsp;a&nbsp;palette&nbsp;for&nbsp;an&nbsp;image.</span><br>
<span class="lineno"></span><span class="keyword" id="5483656">type</span>&nbsp;<span class="ident" id="5483661">Quantizer</span>&nbsp;<span class="keyword" id="5483671">interface</span>&nbsp;<span class="op" id="5483681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5483684">//&nbsp;Quantize&nbsp;appends&nbsp;up&nbsp;to&nbsp;cap(p)&nbsp;-&nbsp;len(p)&nbsp;colors&nbsp;to&nbsp;p&nbsp;and&nbsp;returns&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5483755">//&nbsp;updated&nbsp;palette&nbsp;suitable&nbsp;for&nbsp;converting&nbsp;m&nbsp;to&nbsp;a&nbsp;paletted&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5483822">Quantize</span><span class="op" id="5483830">(</span><span class="ident" id="5483831">p</span>&nbsp;<span class="ident" id="5483833">color</span><span class="op" id="5483838">.</span><span class="ident" id="5483839">Palette</span><span class="op" id="5483846">,</span>&nbsp;<span class="ident" id="5483848">m</span>&nbsp;<span class="ident" id="5483850">image</span><span class="op" id="5483855">.</span><span class="ident" id="5483856">Image</span><span class="op" id="5483861">)</span>&nbsp;<span class="ident" id="5483863">color</span><span class="op" id="5483868">.</span><span class="ident" id="5483869">Palette</span><br>
<span class="lineno">30</span><span class="op" id="5483877">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5483880">//&nbsp;Op&nbsp;is&nbsp;a&nbsp;Porter-Duff&nbsp;compositing&nbsp;operator.</span><br>
<span class="lineno"></span><span class="keyword" id="5483925">type</span>&nbsp;<span class="ident" id="5483930">Op</span>&nbsp;<span class="builtintype" id="5483933">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="5483938">const</span>&nbsp;<span class="op" id="5483944">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5483947">//&nbsp;Over&nbsp;specifies&nbsp;``(src&nbsp;in&nbsp;mask)&nbsp;over&nbsp;dst&#39;&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5483994">Over</span>&nbsp;<span class="ident" id="5483999">Op</span>&nbsp;<span class="op" id="5484002">=</span>&nbsp;<span class="ident" id="5484004">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5484010">//&nbsp;Src&nbsp;specifies&nbsp;``src&nbsp;in&nbsp;mask&#39;&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5484045">Src</span><br>
<span class="lineno">40</span><span class="op" id="5484049">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5484052">//&nbsp;Draw&nbsp;implements&nbsp;the&nbsp;Drawer&nbsp;interface&nbsp;by&nbsp;calling&nbsp;the&nbsp;Draw&nbsp;function&nbsp;with&nbsp;this</span><br>
<span class="lineno"></span><span class="comment" id="5484131">//&nbsp;Op.</span><br>
<span class="lineno"></span><span class="keyword" id="5484138">func</span>&nbsp;<span class="op" id="5484143">(</span><span class="ident" id="5484144">op</span>&nbsp;<span class="ident" id="5484147">Op</span><span class="op" id="5484149">)</span>&nbsp;<span class="ident" id="5484151">Draw</span><span class="op" id="5484155">(</span><span class="ident" id="5484156">dst</span>&nbsp;<span class="ident" id="5484160">Image</span><span class="op" id="5484165">,</span>&nbsp;<span class="ident" id="5484167">r</span>&nbsp;<span class="ident" id="5484169">image</span><span class="op" id="5484174">.</span><span class="ident" id="5484175">Rectangle</span><span class="op" id="5484184">,</span>&nbsp;<span class="ident" id="5484186">src</span>&nbsp;<span class="ident" id="5484190">image</span><span class="op" id="5484195">.</span><span class="ident" id="5484196">Image</span><span class="op" id="5484201">,</span>&nbsp;<span class="ident" id="5484203">sp</span>&nbsp;<span class="ident" id="5484206">image</span><span class="op" id="5484211">.</span><span class="ident" id="5484212">Point</span><span class="op" id="5484217">)</span>&nbsp;<span class="op" id="5484219">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5484222">DrawMask</span><span class="op" id="5484230">(</span><span class="ident" id="5484231">dst</span><span class="op" id="5484234">,</span>&nbsp;<span class="ident" id="5484236">r</span><span class="op" id="5484237">,</span>&nbsp;<span class="ident" id="5484239">src</span><span class="op" id="5484242">,</span>&nbsp;<span class="ident" id="5484244">sp</span><span class="op" id="5484246">,</span>&nbsp;<span class="ident" id="5484248">nil</span><span class="op" id="5484251">,</span>&nbsp;<span class="ident" id="5484253">image</span><span class="op" id="5484258">.</span><span class="ident" id="5484259">Point</span><span class="op" id="5484264">{</span><span class="op" id="5484265">}</span><span class="op" id="5484266">,</span>&nbsp;<span class="ident" id="5484268">op</span><span class="op" id="5484270">)</span><br>
<span class="lineno"></span><span class="op" id="5484272">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5484275">//&nbsp;Drawer&nbsp;contains&nbsp;the&nbsp;Draw&nbsp;method.</span><br>
<span class="lineno"></span><span class="keyword" id="5484311">type</span>&nbsp;<span class="ident" id="5484316">Drawer</span>&nbsp;<span class="keyword" id="5484323">interface</span>&nbsp;<span class="op" id="5484333">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5484336">//&nbsp;Draw&nbsp;aligns&nbsp;r.Min&nbsp;in&nbsp;dst&nbsp;with&nbsp;sp&nbsp;in&nbsp;src&nbsp;and&nbsp;then&nbsp;replaces&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5484402">//&nbsp;rectangle&nbsp;r&nbsp;in&nbsp;dst&nbsp;with&nbsp;the&nbsp;result&nbsp;of&nbsp;drawing&nbsp;src&nbsp;on&nbsp;dst.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5484464">Draw</span><span class="op" id="5484468">(</span><span class="ident" id="5484469">dst</span>&nbsp;<span class="ident" id="5484473">Image</span><span class="op" id="5484478">,</span>&nbsp;<span class="ident" id="5484480">r</span>&nbsp;<span class="ident" id="5484482">image</span><span class="op" id="5484487">.</span><span class="ident" id="5484488">Rectangle</span><span class="op" id="5484497">,</span>&nbsp;<span class="ident" id="5484499">src</span>&nbsp;<span class="ident" id="5484503">image</span><span class="op" id="5484508">.</span><span class="ident" id="5484509">Image</span><span class="op" id="5484514">,</span>&nbsp;<span class="ident" id="5484516">sp</span>&nbsp;<span class="ident" id="5484519">image</span><span class="op" id="5484524">.</span><span class="ident" id="5484525">Point</span><span class="op" id="5484530">)</span><br>
<span class="lineno"></span><span class="op" id="5484532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="5484535">//&nbsp;FloydSteinberg&nbsp;is&nbsp;a&nbsp;Drawer&nbsp;that&nbsp;is&nbsp;the&nbsp;Src&nbsp;Op&nbsp;with&nbsp;Floyd-Steinberg&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="5484611">//&nbsp;diffusion.</span><br>
<span class="lineno"></span><span class="keyword" id="5484625">var</span>&nbsp;<span class="ident" id="5484629">FloydSteinberg</span>&nbsp;<span class="ident" id="5484644">Drawer</span>&nbsp;<span class="op" id="5484651">=</span>&nbsp;<span class="ident" id="5484653">floydSteinberg</span><span class="op" id="5484667">{</span><span class="op" id="5484668">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5484671">type</span>&nbsp;<span class="ident" id="5484676">floydSteinberg</span>&nbsp;<span class="keyword" id="5484691">struct</span><span class="op" id="5484697">{</span><span class="op" id="5484698">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="5484701">func</span>&nbsp;<span class="op" id="5484706">(</span><span class="ident" id="5484707">floydSteinberg</span><span class="op" id="5484721">)</span>&nbsp;<span class="ident" id="5484723">Draw</span><span class="op" id="5484727">(</span><span class="ident" id="5484728">dst</span>&nbsp;<span class="ident" id="5484732">Image</span><span class="op" id="5484737">,</span>&nbsp;<span class="ident" id="5484739">r</span>&nbsp;<span class="ident" id="5484741">image</span><span class="op" id="5484746">.</span><span class="ident" id="5484747">Rectangle</span><span class="op" id="5484756">,</span>&nbsp;<span class="ident" id="5484758">src</span>&nbsp;<span class="ident" id="5484762">image</span><span class="op" id="5484767">.</span><span class="ident" id="5484768">Image</span><span class="op" id="5484773">,</span>&nbsp;<span class="ident" id="5484775">sp</span>&nbsp;<span class="ident" id="5484778">image</span><span class="op" id="5484783">.</span><span class="ident" id="5484784">Point</span><span class="op" id="5484789">)</span>&nbsp;<span class="op" id="5484791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5484794">clip</span><span class="op" id="5484798">(</span><span class="ident" id="5484799">dst</span><span class="op" id="5484802">,</span>&nbsp;<span class="op" id="5484804">&amp;</span><span class="ident" id="5484805">r</span><span class="op" id="5484806">,</span>&nbsp;<span class="ident" id="5484808">src</span><span class="op" id="5484811">,</span>&nbsp;<span class="op" id="5484813">&amp;</span><span class="ident" id="5484814">sp</span><span class="op" id="5484816">,</span>&nbsp;<span class="ident" id="5484818">nil</span><span class="op" id="5484821">,</span>&nbsp;<span class="ident" id="5484823">nil</span><span class="op" id="5484826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5484829">if</span>&nbsp;<span class="ident" id="5484832">r</span><span class="op" id="5484833">.</span><span class="ident" id="5484834">Empty</span><span class="op" id="5484839">(</span><span class="op" id="5484840">)</span>&nbsp;<span class="op" id="5484842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5484846">return</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5484854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5484857">drawPaletted</span><span class="op" id="5484869">(</span><span class="ident" id="5484870">dst</span><span class="op" id="5484873">,</span>&nbsp;<span class="ident" id="5484875">r</span><span class="op" id="5484876">,</span>&nbsp;<span class="ident" id="5484878">src</span><span class="op" id="5484881">,</span>&nbsp;<span class="ident" id="5484883">sp</span><span class="op" id="5484885">,</span>&nbsp;<span class="builtintype" id="5484887">true</span><span class="op" id="5484891">)</span><br>
<span class="lineno"></span><span class="op" id="5484893">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5484896">//&nbsp;clip&nbsp;clips&nbsp;r&nbsp;against&nbsp;each&nbsp;image&#39;s&nbsp;bounds&nbsp;(after&nbsp;translating&nbsp;into&nbsp;the</span><br>
<span class="lineno">70</span><span class="comment" id="5484968">//&nbsp;destination&nbsp;image&#39;s&nbsp;co-ordinate&nbsp;space)&nbsp;and&nbsp;shifts&nbsp;the&nbsp;points&nbsp;sp&nbsp;and&nbsp;mp&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="5485045">//&nbsp;the&nbsp;same&nbsp;amount&nbsp;as&nbsp;the&nbsp;change&nbsp;in&nbsp;r.Min.</span><br>
<span class="lineno"></span><span class="keyword" id="5485088">func</span>&nbsp;<span class="ident" id="5485093">clip</span><span class="op" id="5485097">(</span><span class="ident" id="5485098">dst</span>&nbsp;<span class="ident" id="5485102">Image</span><span class="op" id="5485107">,</span>&nbsp;<span class="ident" id="5485109">r</span>&nbsp;<span class="op" id="5485111">*</span><span class="ident" id="5485112">image</span><span class="op" id="5485117">.</span><span class="ident" id="5485118">Rectangle</span><span class="op" id="5485127">,</span>&nbsp;<span class="ident" id="5485129">src</span>&nbsp;<span class="ident" id="5485133">image</span><span class="op" id="5485138">.</span><span class="ident" id="5485139">Image</span><span class="op" id="5485144">,</span>&nbsp;<span class="ident" id="5485146">sp</span>&nbsp;<span class="op" id="5485149">*</span><span class="ident" id="5485150">image</span><span class="op" id="5485155">.</span><span class="ident" id="5485156">Point</span><span class="op" id="5485161">,</span>&nbsp;<span class="ident" id="5485163">mask</span>&nbsp;<span class="ident" id="5485168">image</span><span class="op" id="5485173">.</span><span class="ident" id="5485174">Image</span><span class="op" id="5485179">,</span>&nbsp;<span class="ident" id="5485181">mp</span>&nbsp;<span class="op" id="5485184">*</span><span class="ident" id="5485185">image</span><span class="op" id="5485190">.</span><span class="ident" id="5485191">Point</span><span class="op" id="5485196">)</span>&nbsp;<span class="op" id="5485198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5485201">orig</span>&nbsp;<span class="op" id="5485206">:=</span>&nbsp;<span class="ident" id="5485209">r</span><span class="op" id="5485210">.</span><span class="ident" id="5485211">Min</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5485216">*</span><span class="ident" id="5485217">r</span>&nbsp;<span class="op" id="5485219">=</span>&nbsp;<span class="ident" id="5485221">r</span><span class="op" id="5485222">.</span><span class="ident" id="5485223">Intersect</span><span class="op" id="5485232">(</span><span class="ident" id="5485233">dst</span><span class="op" id="5485236">.</span><span class="ident" id="5485237">Bounds</span><span class="op" id="5485243">(</span><span class="op" id="5485244">)</span><span class="op" id="5485245">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5485248">*</span><span class="ident" id="5485249">r</span>&nbsp;<span class="op" id="5485251">=</span>&nbsp;<span class="ident" id="5485253">r</span><span class="op" id="5485254">.</span><span class="ident" id="5485255">Intersect</span><span class="op" id="5485264">(</span><span class="ident" id="5485265">src</span><span class="op" id="5485268">.</span><span class="ident" id="5485269">Bounds</span><span class="op" id="5485275">(</span><span class="op" id="5485276">)</span><span class="op" id="5485277">.</span><span class="ident" id="5485278">Add</span><span class="op" id="5485281">(</span><span class="ident" id="5485282">orig</span><span class="op" id="5485286">.</span><span class="ident" id="5485287">Sub</span><span class="op" id="5485290">(</span><span class="op" id="5485291">*</span><span class="ident" id="5485292">sp</span><span class="op" id="5485294">)</span><span class="op" id="5485295">)</span><span class="op" id="5485296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5485299">if</span>&nbsp;<span class="ident" id="5485302">mask</span>&nbsp;<span class="op" id="5485307">!=</span>&nbsp;<span class="ident" id="5485310">nil</span>&nbsp;<span class="op" id="5485314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5485318">*</span><span class="ident" id="5485319">r</span>&nbsp;<span class="op" id="5485321">=</span>&nbsp;<span class="ident" id="5485323">r</span><span class="op" id="5485324">.</span><span class="ident" id="5485325">Intersect</span><span class="op" id="5485334">(</span><span class="ident" id="5485335">mask</span><span class="op" id="5485339">.</span><span class="ident" id="5485340">Bounds</span><span class="op" id="5485346">(</span><span class="op" id="5485347">)</span><span class="op" id="5485348">.</span><span class="ident" id="5485349">Add</span><span class="op" id="5485352">(</span><span class="ident" id="5485353">orig</span><span class="op" id="5485357">.</span><span class="ident" id="5485358">Sub</span><span class="op" id="5485361">(</span><span class="op" id="5485362">*</span><span class="ident" id="5485363">mp</span><span class="op" id="5485365">)</span><span class="op" id="5485366">)</span><span class="op" id="5485367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5485370">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5485373">dx</span>&nbsp;<span class="op" id="5485376">:=</span>&nbsp;<span class="ident" id="5485379">r</span><span class="op" id="5485380">.</span><span class="ident" id="5485381">Min</span><span class="op" id="5485384">.</span><span class="ident" id="5485385">X</span>&nbsp;<span class="op" id="5485387">-</span>&nbsp;<span class="ident" id="5485389">orig</span><span class="op" id="5485393">.</span><span class="ident" id="5485394">X</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5485397">dy</span>&nbsp;<span class="op" id="5485400">:=</span>&nbsp;<span class="ident" id="5485403">r</span><span class="op" id="5485404">.</span><span class="ident" id="5485405">Min</span><span class="op" id="5485408">.</span><span class="ident" id="5485409">Y</span>&nbsp;<span class="op" id="5485411">-</span>&nbsp;<span class="ident" id="5485413">orig</span><span class="op" id="5485417">.</span><span class="ident" id="5485418">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5485421">if</span>&nbsp;<span class="ident" id="5485424">dx</span>&nbsp;<span class="op" id="5485427">==</span>&nbsp;<span class="num" id="5485430">0</span>&nbsp;<span class="op" id="5485432">&amp;&amp;</span>&nbsp;<span class="ident" id="5485435">dy</span>&nbsp;<span class="op" id="5485438">==</span>&nbsp;<span class="num" id="5485441">0</span>&nbsp;<span class="op" id="5485443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5485447">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5485455">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5485458">(</span><span class="op" id="5485459">*</span><span class="ident" id="5485460">sp</span><span class="op" id="5485462">)</span><span class="op" id="5485463">.</span><span class="ident" id="5485464">X</span>&nbsp;<span class="op" id="5485466">+=</span>&nbsp;<span class="ident" id="5485469">dx</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5485473">(</span><span class="op" id="5485474">*</span><span class="ident" id="5485475">sp</span><span class="op" id="5485477">)</span><span class="op" id="5485478">.</span><span class="ident" id="5485479">Y</span>&nbsp;<span class="op" id="5485481">+=</span>&nbsp;<span class="ident" id="5485484">dy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5485488">(</span><span class="op" id="5485489">*</span><span class="ident" id="5485490">mp</span><span class="op" id="5485492">)</span><span class="op" id="5485493">.</span><span class="ident" id="5485494">X</span>&nbsp;<span class="op" id="5485496">+=</span>&nbsp;<span class="ident" id="5485499">dx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5485503">(</span><span class="op" id="5485504">*</span><span class="ident" id="5485505">mp</span><span class="op" id="5485507">)</span><span class="op" id="5485508">.</span><span class="ident" id="5485509">Y</span>&nbsp;<span class="op" id="5485511">+=</span>&nbsp;<span class="ident" id="5485514">dy</span><br>
<span class="lineno"></span><span class="op" id="5485517">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="5485520">func</span>&nbsp;<span class="ident" id="5485525">processBackward</span><span class="op" id="5485540">(</span><span class="ident" id="5485541">dst</span>&nbsp;<span class="ident" id="5485545">Image</span><span class="op" id="5485550">,</span>&nbsp;<span class="ident" id="5485552">r</span>&nbsp;<span class="ident" id="5485554">image</span><span class="op" id="5485559">.</span><span class="ident" id="5485560">Rectangle</span><span class="op" id="5485569">,</span>&nbsp;<span class="ident" id="5485571">src</span>&nbsp;<span class="ident" id="5485575">image</span><span class="op" id="5485580">.</span><span class="ident" id="5485581">Image</span><span class="op" id="5485586">,</span>&nbsp;<span class="ident" id="5485588">sp</span>&nbsp;<span class="ident" id="5485591">image</span><span class="op" id="5485596">.</span><span class="ident" id="5485597">Point</span><span class="op" id="5485602">)</span>&nbsp;<span class="builtintype" id="5485604">bool</span>&nbsp;<span class="op" id="5485609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5485612">return</span>&nbsp;<span class="ident" id="5485619">image</span><span class="op" id="5485624">.</span><span class="ident" id="5485625">Image</span><span class="op" id="5485630">(</span><span class="ident" id="5485631">dst</span><span class="op" id="5485634">)</span>&nbsp;<span class="op" id="5485636">==</span>&nbsp;<span class="ident" id="5485639">src</span>&nbsp;<span class="op" id="5485643">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5485648">r</span><span class="op" id="5485649">.</span><span class="ident" id="5485650">Overlaps</span><span class="op" id="5485658">(</span><span class="ident" id="5485659">r</span><span class="op" id="5485660">.</span><span class="ident" id="5485661">Add</span><span class="op" id="5485664">(</span><span class="ident" id="5485665">sp</span><span class="op" id="5485667">.</span><span class="ident" id="5485668">Sub</span><span class="op" id="5485671">(</span><span class="ident" id="5485672">r</span><span class="op" id="5485673">.</span><span class="ident" id="5485674">Min</span><span class="op" id="5485677">)</span><span class="op" id="5485678">)</span><span class="op" id="5485679">)</span>&nbsp;<span class="op" id="5485681">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5485686">(</span><span class="ident" id="5485687">sp</span><span class="op" id="5485689">.</span><span class="ident" id="5485690">Y</span>&nbsp;<span class="op" id="5485692">&lt;</span>&nbsp;<span class="ident" id="5485694">r</span><span class="op" id="5485695">.</span><span class="ident" id="5485696">Min</span><span class="op" id="5485699">.</span><span class="ident" id="5485700">Y</span>&nbsp;<span class="op" id="5485702">||</span>&nbsp;<span class="op" id="5485705">(</span><span class="ident" id="5485706">sp</span><span class="op" id="5485708">.</span><span class="ident" id="5485709">Y</span>&nbsp;<span class="op" id="5485711">==</span>&nbsp;<span class="ident" id="5485714">r</span><span class="op" id="5485715">.</span><span class="ident" id="5485716">Min</span><span class="op" id="5485719">.</span><span class="ident" id="5485720">Y</span>&nbsp;<span class="op" id="5485722">&amp;&amp;</span>&nbsp;<span class="ident" id="5485725">sp</span><span class="op" id="5485727">.</span><span class="ident" id="5485728">X</span>&nbsp;<span class="op" id="5485730">&lt;</span>&nbsp;<span class="ident" id="5485732">r</span><span class="op" id="5485733">.</span><span class="ident" id="5485734">Min</span><span class="op" id="5485737">.</span><span class="ident" id="5485738">X</span><span class="op" id="5485739">)</span><span class="op" id="5485740">)</span><br>
<span class="lineno"></span><span class="op" id="5485742">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="5485745">//&nbsp;Draw&nbsp;calls&nbsp;DrawMask&nbsp;with&nbsp;a&nbsp;nil&nbsp;mask.</span><br>
<span class="lineno"></span><span class="keyword" id="5485785">func</span>&nbsp;<span class="ident" id="5485790">Draw</span><span class="op" id="5485794">(</span><span class="ident" id="5485795">dst</span>&nbsp;<span class="ident" id="5485799">Image</span><span class="op" id="5485804">,</span>&nbsp;<span class="ident" id="5485806">r</span>&nbsp;<span class="ident" id="5485808">image</span><span class="op" id="5485813">.</span><span class="ident" id="5485814">Rectangle</span><span class="op" id="5485823">,</span>&nbsp;<span class="ident" id="5485825">src</span>&nbsp;<span class="ident" id="5485829">image</span><span class="op" id="5485834">.</span><span class="ident" id="5485835">Image</span><span class="op" id="5485840">,</span>&nbsp;<span class="ident" id="5485842">sp</span>&nbsp;<span class="ident" id="5485845">image</span><span class="op" id="5485850">.</span><span class="ident" id="5485851">Point</span><span class="op" id="5485856">,</span>&nbsp;<span class="ident" id="5485858">op</span>&nbsp;<span class="ident" id="5485861">Op</span><span class="op" id="5485863">)</span>&nbsp;<span class="op" id="5485865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5485868">DrawMask</span><span class="op" id="5485876">(</span><span class="ident" id="5485877">dst</span><span class="op" id="5485880">,</span>&nbsp;<span class="ident" id="5485882">r</span><span class="op" id="5485883">,</span>&nbsp;<span class="ident" id="5485885">src</span><span class="op" id="5485888">,</span>&nbsp;<span class="ident" id="5485890">sp</span><span class="op" id="5485892">,</span>&nbsp;<span class="ident" id="5485894">nil</span><span class="op" id="5485897">,</span>&nbsp;<span class="ident" id="5485899">image</span><span class="op" id="5485904">.</span><span class="ident" id="5485905">Point</span><span class="op" id="5485910">{</span><span class="op" id="5485911">}</span><span class="op" id="5485912">,</span>&nbsp;<span class="ident" id="5485914">op</span><span class="op" id="5485916">)</span><br>
<span class="lineno"></span><span class="op" id="5485918">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="5485921">//&nbsp;DrawMask&nbsp;aligns&nbsp;r.Min&nbsp;in&nbsp;dst&nbsp;with&nbsp;sp&nbsp;in&nbsp;src&nbsp;and&nbsp;mp&nbsp;in&nbsp;mask&nbsp;and&nbsp;then&nbsp;replaces&nbsp;the&nbsp;rectangle&nbsp;r</span><br>
<span class="lineno"></span><span class="comment" id="5486017">//&nbsp;in&nbsp;dst&nbsp;with&nbsp;the&nbsp;result&nbsp;of&nbsp;a&nbsp;Porter-Duff&nbsp;composition.&nbsp;A&nbsp;nil&nbsp;mask&nbsp;is&nbsp;treated&nbsp;as&nbsp;opaque.</span><br>
<span class="lineno"></span><span class="keyword" id="5486106">func</span>&nbsp;<span class="ident" id="5486111">DrawMask</span><span class="op" id="5486119">(</span><span class="ident" id="5486120">dst</span>&nbsp;<span class="ident" id="5486124">Image</span><span class="op" id="5486129">,</span>&nbsp;<span class="ident" id="5486131">r</span>&nbsp;<span class="ident" id="5486133">image</span><span class="op" id="5486138">.</span><span class="ident" id="5486139">Rectangle</span><span class="op" id="5486148">,</span>&nbsp;<span class="ident" id="5486150">src</span>&nbsp;<span class="ident" id="5486154">image</span><span class="op" id="5486159">.</span><span class="ident" id="5486160">Image</span><span class="op" id="5486165">,</span>&nbsp;<span class="ident" id="5486167">sp</span>&nbsp;<span class="ident" id="5486170">image</span><span class="op" id="5486175">.</span><span class="ident" id="5486176">Point</span><span class="op" id="5486181">,</span>&nbsp;<span class="ident" id="5486183">mask</span>&nbsp;<span class="ident" id="5486188">image</span><span class="op" id="5486193">.</span><span class="ident" id="5486194">Image</span><span class="op" id="5486199">,</span>&nbsp;<span class="ident" id="5486201">mp</span>&nbsp;<span class="ident" id="5486204">image</span><span class="op" id="5486209">.</span><span class="ident" id="5486210">Point</span><span class="op" id="5486215">,</span>&nbsp;<span class="ident" id="5486217">op</span>&nbsp;<span class="ident" id="5486220">Op</span><span class="op" id="5486222">)</span>&nbsp;<span class="op" id="5486224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5486227">clip</span><span class="op" id="5486231">(</span><span class="ident" id="5486232">dst</span><span class="op" id="5486235">,</span>&nbsp;<span class="op" id="5486237">&amp;</span><span class="ident" id="5486238">r</span><span class="op" id="5486239">,</span>&nbsp;<span class="ident" id="5486241">src</span><span class="op" id="5486244">,</span>&nbsp;<span class="op" id="5486246">&amp;</span><span class="ident" id="5486247">sp</span><span class="op" id="5486249">,</span>&nbsp;<span class="ident" id="5486251">mask</span><span class="op" id="5486255">,</span>&nbsp;<span class="op" id="5486257">&amp;</span><span class="ident" id="5486258">mp</span><span class="op" id="5486260">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5486263">if</span>&nbsp;<span class="ident" id="5486266">r</span><span class="op" id="5486267">.</span><span class="ident" id="5486268">Empty</span><span class="op" id="5486273">(</span><span class="op" id="5486274">)</span>&nbsp;<span class="op" id="5486276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5486280">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5486288">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5486292">//&nbsp;Fast&nbsp;paths&nbsp;for&nbsp;special&nbsp;cases.&nbsp;If&nbsp;none&nbsp;of&nbsp;them&nbsp;apply,&nbsp;then&nbsp;we&nbsp;fall&nbsp;back&nbsp;to&nbsp;a&nbsp;general&nbsp;but&nbsp;slow&nbsp;implementation.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5486405">switch</span>&nbsp;<span class="ident" id="5486412">dst0</span>&nbsp;<span class="op" id="5486417">:=</span>&nbsp;<span class="ident" id="5486420">dst</span><span class="op" id="5486423">.</span><span class="op" id="5486424">(</span><span class="keyword" id="5486425">type</span><span class="op" id="5486429">)</span>&nbsp;<span class="op" id="5486431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5486434">case</span>&nbsp;<span class="op" id="5486439">*</span><span class="ident" id="5486440">image</span><span class="op" id="5486445">.</span><span class="ident" id="5486446">RGBA</span><span class="op" id="5486450">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5486454">if</span>&nbsp;<span class="ident" id="5486457">op</span>&nbsp;<span class="op" id="5486460">==</span>&nbsp;<span class="ident" id="5486463">Over</span>&nbsp;<span class="op" id="5486468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5486473">if</span>&nbsp;<span class="ident" id="5486476">mask</span>&nbsp;<span class="op" id="5486481">==</span>&nbsp;<span class="ident" id="5486484">nil</span>&nbsp;<span class="op" id="5486488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5486494">switch</span>&nbsp;<span class="ident" id="5486501">src0</span>&nbsp;<span class="op" id="5486506">:=</span>&nbsp;<span class="ident" id="5486509">src</span><span class="op" id="5486512">.</span><span class="op" id="5486513">(</span><span class="keyword" id="5486514">type</span><span class="op" id="5486518">)</span>&nbsp;<span class="op" id="5486520">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5486526">case</span>&nbsp;<span class="op" id="5486531">*</span><span class="ident" id="5486532">image</span><span class="op" id="5486537">.</span><span class="ident" id="5486538">Uniform</span><span class="op" id="5486545">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5486552">drawFillOver</span><span class="op" id="5486564">(</span><span class="ident" id="5486565">dst0</span><span class="op" id="5486569">,</span>&nbsp;<span class="ident" id="5486571">r</span><span class="op" id="5486572">,</span>&nbsp;<span class="ident" id="5486574">src0</span><span class="op" id="5486578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5486585">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5486596">case</span>&nbsp;<span class="op" id="5486601">*</span><span class="ident" id="5486602">image</span><span class="op" id="5486607">.</span><span class="ident" id="5486608">RGBA</span><span class="op" id="5486612">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5486619">drawCopyOver</span><span class="op" id="5486631">(</span><span class="ident" id="5486632">dst0</span><span class="op" id="5486636">,</span>&nbsp;<span class="ident" id="5486638">r</span><span class="op" id="5486639">,</span>&nbsp;<span class="ident" id="5486641">src0</span><span class="op" id="5486645">,</span>&nbsp;<span class="ident" id="5486647">sp</span><span class="op" id="5486649">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5486656">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5486667">case</span>&nbsp;<span class="op" id="5486672">*</span><span class="ident" id="5486673">image</span><span class="op" id="5486678">.</span><span class="ident" id="5486679">NRGBA</span><span class="op" id="5486684">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5486691">drawNRGBAOver</span><span class="op" id="5486704">(</span><span class="ident" id="5486705">dst0</span><span class="op" id="5486709">,</span>&nbsp;<span class="ident" id="5486711">r</span><span class="op" id="5486712">,</span>&nbsp;<span class="ident" id="5486714">src0</span><span class="op" id="5486718">,</span>&nbsp;<span class="ident" id="5486720">sp</span><span class="op" id="5486722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5486729">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5486740">case</span>&nbsp;<span class="op" id="5486745">*</span><span class="ident" id="5486746">image</span><span class="op" id="5486751">.</span><span class="ident" id="5486752">YCbCr</span><span class="op" id="5486757">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5486764">if</span>&nbsp;<span class="ident" id="5486767">drawYCbCr</span><span class="op" id="5486776">(</span><span class="ident" id="5486777">dst0</span><span class="op" id="5486781">,</span>&nbsp;<span class="ident" id="5486783">r</span><span class="op" id="5486784">,</span>&nbsp;<span class="ident" id="5486786">src0</span><span class="op" id="5486790">,</span>&nbsp;<span class="ident" id="5486792">sp</span><span class="op" id="5486794">)</span>&nbsp;<span class="op" id="5486796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5486804">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5486816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5486822">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5486827">}</span>&nbsp;<span class="keyword" id="5486829">else</span>&nbsp;<span class="keyword" id="5486834">if</span>&nbsp;<span class="ident" id="5486837">mask0</span><span class="op" id="5486842">,</span>&nbsp;<span class="ident" id="5486844">ok</span>&nbsp;<span class="op" id="5486847">:=</span>&nbsp;<span class="ident" id="5486850">mask</span><span class="op" id="5486854">.</span><span class="op" id="5486855">(</span><span class="op" id="5486856">*</span><span class="ident" id="5486857">image</span><span class="op" id="5486862">.</span><span class="ident" id="5486863">Alpha</span><span class="op" id="5486868">)</span><span class="op" id="5486869">;</span>&nbsp;<span class="ident" id="5486871">ok</span>&nbsp;<span class="op" id="5486874">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5486880">switch</span>&nbsp;<span class="ident" id="5486887">src0</span>&nbsp;<span class="op" id="5486892">:=</span>&nbsp;<span class="ident" id="5486895">src</span><span class="op" id="5486898">.</span><span class="op" id="5486899">(</span><span class="keyword" id="5486900">type</span><span class="op" id="5486904">)</span>&nbsp;<span class="op" id="5486906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5486912">case</span>&nbsp;<span class="op" id="5486917">*</span><span class="ident" id="5486918">image</span><span class="op" id="5486923">.</span><span class="ident" id="5486924">Uniform</span><span class="op" id="5486931">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5486938">drawGlyphOver</span><span class="op" id="5486951">(</span><span class="ident" id="5486952">dst0</span><span class="op" id="5486956">,</span>&nbsp;<span class="ident" id="5486958">r</span><span class="op" id="5486959">,</span>&nbsp;<span class="ident" id="5486961">src0</span><span class="op" id="5486965">,</span>&nbsp;<span class="ident" id="5486967">mask0</span><span class="op" id="5486972">,</span>&nbsp;<span class="ident" id="5486974">mp</span><span class="op" id="5486976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5486983">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5486994">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5486999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5487003">}</span>&nbsp;<span class="keyword" id="5487005">else</span>&nbsp;<span class="op" id="5487010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5487015">if</span>&nbsp;<span class="ident" id="5487018">mask</span>&nbsp;<span class="op" id="5487023">==</span>&nbsp;<span class="ident" id="5487026">nil</span>&nbsp;<span class="op" id="5487030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5487036">switch</span>&nbsp;<span class="ident" id="5487043">src0</span>&nbsp;<span class="op" id="5487048">:=</span>&nbsp;<span class="ident" id="5487051">src</span><span class="op" id="5487054">.</span><span class="op" id="5487055">(</span><span class="keyword" id="5487056">type</span><span class="op" id="5487060">)</span>&nbsp;<span class="op" id="5487062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5487068">case</span>&nbsp;<span class="op" id="5487073">*</span><span class="ident" id="5487074">image</span><span class="op" id="5487079">.</span><span class="ident" id="5487080">Uniform</span><span class="op" id="5487087">:</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5487094">drawFillSrc</span><span class="op" id="5487105">(</span><span class="ident" id="5487106">dst0</span><span class="op" id="5487110">,</span>&nbsp;<span class="ident" id="5487112">r</span><span class="op" id="5487113">,</span>&nbsp;<span class="ident" id="5487115">src0</span><span class="op" id="5487119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5487126">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5487137">case</span>&nbsp;<span class="op" id="5487142">*</span><span class="ident" id="5487143">image</span><span class="op" id="5487148">.</span><span class="ident" id="5487149">RGBA</span><span class="op" id="5487153">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5487160">drawCopySrc</span><span class="op" id="5487171">(</span><span class="ident" id="5487172">dst0</span><span class="op" id="5487176">,</span>&nbsp;<span class="ident" id="5487178">r</span><span class="op" id="5487179">,</span>&nbsp;<span class="ident" id="5487181">src0</span><span class="op" id="5487185">,</span>&nbsp;<span class="ident" id="5487187">sp</span><span class="op" id="5487189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5487196">return</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5487207">case</span>&nbsp;<span class="op" id="5487212">*</span><span class="ident" id="5487213">image</span><span class="op" id="5487218">.</span><span class="ident" id="5487219">NRGBA</span><span class="op" id="5487224">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5487231">drawNRGBASrc</span><span class="op" id="5487243">(</span><span class="ident" id="5487244">dst0</span><span class="op" id="5487248">,</span>&nbsp;<span class="ident" id="5487250">r</span><span class="op" id="5487251">,</span>&nbsp;<span class="ident" id="5487253">src0</span><span class="op" id="5487257">,</span>&nbsp;<span class="ident" id="5487259">sp</span><span class="op" id="5487261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5487268">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5487279">case</span>&nbsp;<span class="op" id="5487284">*</span><span class="ident" id="5487285">image</span><span class="op" id="5487290">.</span><span class="ident" id="5487291">YCbCr</span><span class="op" id="5487296">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5487303">if</span>&nbsp;<span class="ident" id="5487306">drawYCbCr</span><span class="op" id="5487315">(</span><span class="ident" id="5487316">dst0</span><span class="op" id="5487320">,</span>&nbsp;<span class="ident" id="5487322">r</span><span class="op" id="5487323">,</span>&nbsp;<span class="ident" id="5487325">src0</span><span class="op" id="5487329">,</span>&nbsp;<span class="ident" id="5487331">sp</span><span class="op" id="5487333">)</span>&nbsp;<span class="op" id="5487335">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5487343">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5487355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5487361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5487366">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5487370">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5487374">drawRGBA</span><span class="op" id="5487382">(</span><span class="ident" id="5487383">dst0</span><span class="op" id="5487387">,</span>&nbsp;<span class="ident" id="5487389">r</span><span class="op" id="5487390">,</span>&nbsp;<span class="ident" id="5487392">src</span><span class="op" id="5487395">,</span>&nbsp;<span class="ident" id="5487397">sp</span><span class="op" id="5487399">,</span>&nbsp;<span class="ident" id="5487401">mask</span><span class="op" id="5487405">,</span>&nbsp;<span class="ident" id="5487407">mp</span><span class="op" id="5487409">,</span>&nbsp;<span class="ident" id="5487411">op</span><span class="op" id="5487413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5487417">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5487425">case</span>&nbsp;<span class="op" id="5487430">*</span><span class="ident" id="5487431">image</span><span class="op" id="5487436">.</span><span class="ident" id="5487437">Paletted</span><span class="op" id="5487445">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5487449">if</span>&nbsp;<span class="ident" id="5487452">op</span>&nbsp;<span class="op" id="5487455">==</span>&nbsp;<span class="ident" id="5487458">Src</span>&nbsp;<span class="op" id="5487462">&amp;&amp;</span>&nbsp;<span class="ident" id="5487465">mask</span>&nbsp;<span class="op" id="5487470">==</span>&nbsp;<span class="ident" id="5487473">nil</span>&nbsp;<span class="op" id="5487477">&amp;&amp;</span>&nbsp;<span class="op" id="5487480">!</span><span class="ident" id="5487481">processBackward</span><span class="op" id="5487496">(</span><span class="ident" id="5487497">dst</span><span class="op" id="5487500">,</span>&nbsp;<span class="ident" id="5487502">r</span><span class="op" id="5487503">,</span>&nbsp;<span class="ident" id="5487505">src</span><span class="op" id="5487508">,</span>&nbsp;<span class="ident" id="5487510">sp</span><span class="op" id="5487512">)</span>&nbsp;<span class="op" id="5487514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5487519">drawPaletted</span><span class="op" id="5487531">(</span><span class="ident" id="5487532">dst0</span><span class="op" id="5487536">,</span>&nbsp;<span class="ident" id="5487538">r</span><span class="op" id="5487539">,</span>&nbsp;<span class="ident" id="5487541">src</span><span class="op" id="5487544">,</span>&nbsp;<span class="ident" id="5487546">sp</span><span class="op" id="5487548">,</span>&nbsp;<span class="builtintype" id="5487550">false</span><span class="op" id="5487555">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5487559">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5487562">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5487566">x0</span><span class="op" id="5487568">,</span>&nbsp;<span class="ident" id="5487570">x1</span><span class="op" id="5487572">,</span>&nbsp;<span class="ident" id="5487574">dx</span>&nbsp;<span class="op" id="5487577">:=</span>&nbsp;<span class="ident" id="5487580">r</span><span class="op" id="5487581">.</span><span class="ident" id="5487582">Min</span><span class="op" id="5487585">.</span><span class="ident" id="5487586">X</span><span class="op" id="5487587">,</span>&nbsp;<span class="ident" id="5487589">r</span><span class="op" id="5487590">.</span><span class="ident" id="5487591">Max</span><span class="op" id="5487594">.</span><span class="ident" id="5487595">X</span><span class="op" id="5487596">,</span>&nbsp;<span class="num" id="5487598">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5487601">y0</span><span class="op" id="5487603">,</span>&nbsp;<span class="ident" id="5487605">y1</span><span class="op" id="5487607">,</span>&nbsp;<span class="ident" id="5487609">dy</span>&nbsp;<span class="op" id="5487612">:=</span>&nbsp;<span class="ident" id="5487615">r</span><span class="op" id="5487616">.</span><span class="ident" id="5487617">Min</span><span class="op" id="5487620">.</span><span class="ident" id="5487621">Y</span><span class="op" id="5487622">,</span>&nbsp;<span class="ident" id="5487624">r</span><span class="op" id="5487625">.</span><span class="ident" id="5487626">Max</span><span class="op" id="5487629">.</span><span class="ident" id="5487630">Y</span><span class="op" id="5487631">,</span>&nbsp;<span class="num" id="5487633">1</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5487636">if</span>&nbsp;<span class="ident" id="5487639">processBackward</span><span class="op" id="5487654">(</span><span class="ident" id="5487655">dst</span><span class="op" id="5487658">,</span>&nbsp;<span class="ident" id="5487660">r</span><span class="op" id="5487661">,</span>&nbsp;<span class="ident" id="5487663">src</span><span class="op" id="5487666">,</span>&nbsp;<span class="ident" id="5487668">sp</span><span class="op" id="5487670">)</span>&nbsp;<span class="op" id="5487672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5487676">x0</span><span class="op" id="5487678">,</span>&nbsp;<span class="ident" id="5487680">x1</span><span class="op" id="5487682">,</span>&nbsp;<span class="ident" id="5487684">dx</span>&nbsp;<span class="op" id="5487687">=</span>&nbsp;<span class="ident" id="5487689">x1</span><span class="op" id="5487691">-</span><span class="num" id="5487692">1</span><span class="op" id="5487693">,</span>&nbsp;<span class="ident" id="5487695">x0</span><span class="op" id="5487697">-</span><span class="num" id="5487698">1</span><span class="op" id="5487699">,</span>&nbsp;<span class="op" id="5487701">-</span><span class="num" id="5487702">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5487706">y0</span><span class="op" id="5487708">,</span>&nbsp;<span class="ident" id="5487710">y1</span><span class="op" id="5487712">,</span>&nbsp;<span class="ident" id="5487714">dy</span>&nbsp;<span class="op" id="5487717">=</span>&nbsp;<span class="ident" id="5487719">y1</span><span class="op" id="5487721">-</span><span class="num" id="5487722">1</span><span class="op" id="5487723">,</span>&nbsp;<span class="ident" id="5487725">y0</span><span class="op" id="5487727">-</span><span class="num" id="5487728">1</span><span class="op" id="5487729">,</span>&nbsp;<span class="op" id="5487731">-</span><span class="num" id="5487732">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5487735">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5487739">var</span>&nbsp;<span class="ident" id="5487743">out</span>&nbsp;<span class="ident" id="5487747">color</span><span class="op" id="5487752">.</span><span class="ident" id="5487753">RGBA64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5487761">sy</span>&nbsp;<span class="op" id="5487764">:=</span>&nbsp;<span class="ident" id="5487767">sp</span><span class="op" id="5487769">.</span><span class="ident" id="5487770">Y</span>&nbsp;<span class="op" id="5487772">+</span>&nbsp;<span class="ident" id="5487774">y0</span>&nbsp;<span class="op" id="5487777">-</span>&nbsp;<span class="ident" id="5487779">r</span><span class="op" id="5487780">.</span><span class="ident" id="5487781">Min</span><span class="op" id="5487784">.</span><span class="ident" id="5487785">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5487788">my</span>&nbsp;<span class="op" id="5487791">:=</span>&nbsp;<span class="ident" id="5487794">mp</span><span class="op" id="5487796">.</span><span class="ident" id="5487797">Y</span>&nbsp;<span class="op" id="5487799">+</span>&nbsp;<span class="ident" id="5487801">y0</span>&nbsp;<span class="op" id="5487804">-</span>&nbsp;<span class="ident" id="5487806">r</span><span class="op" id="5487807">.</span><span class="ident" id="5487808">Min</span><span class="op" id="5487811">.</span><span class="ident" id="5487812">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5487815">for</span>&nbsp;<span class="ident" id="5487819">y</span>&nbsp;<span class="op" id="5487821">:=</span>&nbsp;<span class="ident" id="5487824">y0</span><span class="op" id="5487826">;</span>&nbsp;<span class="ident" id="5487828">y</span>&nbsp;<span class="op" id="5487830">!=</span>&nbsp;<span class="ident" id="5487833">y1</span><span class="op" id="5487835">;</span>&nbsp;<span class="ident" id="5487837">y</span><span class="op" id="5487838">,</span>&nbsp;<span class="ident" id="5487840">sy</span><span class="op" id="5487842">,</span>&nbsp;<span class="ident" id="5487844">my</span>&nbsp;<span class="op" id="5487847">=</span>&nbsp;<span class="ident" id="5487849">y</span><span class="op" id="5487850">+</span><span class="ident" id="5487851">dy</span><span class="op" id="5487853">,</span>&nbsp;<span class="ident" id="5487855">sy</span><span class="op" id="5487857">+</span><span class="ident" id="5487858">dy</span><span class="op" id="5487860">,</span>&nbsp;<span class="ident" id="5487862">my</span><span class="op" id="5487864">+</span><span class="ident" id="5487865">dy</span>&nbsp;<span class="op" id="5487868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5487872">sx</span>&nbsp;<span class="op" id="5487875">:=</span>&nbsp;<span class="ident" id="5487878">sp</span><span class="op" id="5487880">.</span><span class="ident" id="5487881">X</span>&nbsp;<span class="op" id="5487883">+</span>&nbsp;<span class="ident" id="5487885">x0</span>&nbsp;<span class="op" id="5487888">-</span>&nbsp;<span class="ident" id="5487890">r</span><span class="op" id="5487891">.</span><span class="ident" id="5487892">Min</span><span class="op" id="5487895">.</span><span class="ident" id="5487896">X</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5487900">mx</span>&nbsp;<span class="op" id="5487903">:=</span>&nbsp;<span class="ident" id="5487906">mp</span><span class="op" id="5487908">.</span><span class="ident" id="5487909">X</span>&nbsp;<span class="op" id="5487911">+</span>&nbsp;<span class="ident" id="5487913">x0</span>&nbsp;<span class="op" id="5487916">-</span>&nbsp;<span class="ident" id="5487918">r</span><span class="op" id="5487919">.</span><span class="ident" id="5487920">Min</span><span class="op" id="5487923">.</span><span class="ident" id="5487924">X</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5487928">for</span>&nbsp;<span class="ident" id="5487932">x</span>&nbsp;<span class="op" id="5487934">:=</span>&nbsp;<span class="ident" id="5487937">x0</span><span class="op" id="5487939">;</span>&nbsp;<span class="ident" id="5487941">x</span>&nbsp;<span class="op" id="5487943">!=</span>&nbsp;<span class="ident" id="5487946">x1</span><span class="op" id="5487948">;</span>&nbsp;<span class="ident" id="5487950">x</span><span class="op" id="5487951">,</span>&nbsp;<span class="ident" id="5487953">sx</span><span class="op" id="5487955">,</span>&nbsp;<span class="ident" id="5487957">mx</span>&nbsp;<span class="op" id="5487960">=</span>&nbsp;<span class="ident" id="5487962">x</span><span class="op" id="5487963">+</span><span class="ident" id="5487964">dx</span><span class="op" id="5487966">,</span>&nbsp;<span class="ident" id="5487968">sx</span><span class="op" id="5487970">+</span><span class="ident" id="5487971">dx</span><span class="op" id="5487973">,</span>&nbsp;<span class="ident" id="5487975">mx</span><span class="op" id="5487977">+</span><span class="ident" id="5487978">dx</span>&nbsp;<span class="op" id="5487981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5487986">ma</span>&nbsp;<span class="op" id="5487989">:=</span>&nbsp;<span class="builtintype" id="5487992">uint32</span><span class="op" id="5487998">(</span><span class="ident" id="5487999">m</span><span class="op" id="5488000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5488005">if</span>&nbsp;<span class="ident" id="5488008">mask</span>&nbsp;<span class="op" id="5488013">!=</span>&nbsp;<span class="ident" id="5488016">nil</span>&nbsp;<span class="op" id="5488020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5488026">_</span><span class="op" id="5488027">,</span>&nbsp;<span class="ident" id="5488029">_</span><span class="op" id="5488030">,</span>&nbsp;<span class="ident" id="5488032">_</span><span class="op" id="5488033">,</span>&nbsp;<span class="ident" id="5488035">ma</span>&nbsp;<span class="op" id="5488038">=</span>&nbsp;<span class="ident" id="5488040">mask</span><span class="op" id="5488044">.</span><span class="ident" id="5488045">At</span><span class="op" id="5488047">(</span><span class="ident" id="5488048">mx</span><span class="op" id="5488050">,</span>&nbsp;<span class="ident" id="5488052">my</span><span class="op" id="5488054">)</span><span class="op" id="5488055">.</span><span class="ident" id="5488056">RGBA</span><span class="op" id="5488060">(</span><span class="op" id="5488061">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5488066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5488071">switch</span>&nbsp;<span class="op" id="5488078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5488083">case</span>&nbsp;<span class="ident" id="5488088">ma</span>&nbsp;<span class="op" id="5488091">==</span>&nbsp;<span class="num" id="5488094">0</span><span class="op" id="5488095">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5488101">if</span>&nbsp;<span class="ident" id="5488104">op</span>&nbsp;<span class="op" id="5488107">==</span>&nbsp;<span class="ident" id="5488110">Over</span>&nbsp;<span class="op" id="5488115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5488122">//&nbsp;No-op.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5488136">}</span>&nbsp;<span class="keyword" id="5488138">else</span>&nbsp;<span class="op" id="5488143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5488150">dst</span><span class="op" id="5488153">.</span><span class="ident" id="5488154">Set</span><span class="op" id="5488157">(</span><span class="ident" id="5488158">x</span><span class="op" id="5488159">,</span>&nbsp;<span class="ident" id="5488161">y</span><span class="op" id="5488162">,</span>&nbsp;<span class="ident" id="5488164">color</span><span class="op" id="5488169">.</span><span class="ident" id="5488170">Transparent</span><span class="op" id="5488181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5488187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5488192">case</span>&nbsp;<span class="ident" id="5488197">ma</span>&nbsp;<span class="op" id="5488200">==</span>&nbsp;<span class="ident" id="5488203">m</span>&nbsp;<span class="op" id="5488205">&amp;&amp;</span>&nbsp;<span class="ident" id="5488208">op</span>&nbsp;<span class="op" id="5488211">==</span>&nbsp;<span class="ident" id="5488214">Src</span><span class="op" id="5488217">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5488223">dst</span><span class="op" id="5488226">.</span><span class="ident" id="5488227">Set</span><span class="op" id="5488230">(</span><span class="ident" id="5488231">x</span><span class="op" id="5488232">,</span>&nbsp;<span class="ident" id="5488234">y</span><span class="op" id="5488235">,</span>&nbsp;<span class="ident" id="5488237">src</span><span class="op" id="5488240">.</span><span class="ident" id="5488241">At</span><span class="op" id="5488243">(</span><span class="ident" id="5488244">sx</span><span class="op" id="5488246">,</span>&nbsp;<span class="ident" id="5488248">sy</span><span class="op" id="5488250">)</span><span class="op" id="5488251">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5488256">default</span><span class="op" id="5488263">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5488269">sr</span><span class="op" id="5488271">,</span>&nbsp;<span class="ident" id="5488273">sg</span><span class="op" id="5488275">,</span>&nbsp;<span class="ident" id="5488277">sb</span><span class="op" id="5488279">,</span>&nbsp;<span class="ident" id="5488281">sa</span>&nbsp;<span class="op" id="5488284">:=</span>&nbsp;<span class="ident" id="5488287">src</span><span class="op" id="5488290">.</span><span class="ident" id="5488291">At</span><span class="op" id="5488293">(</span><span class="ident" id="5488294">sx</span><span class="op" id="5488296">,</span>&nbsp;<span class="ident" id="5488298">sy</span><span class="op" id="5488300">)</span><span class="op" id="5488301">.</span><span class="ident" id="5488302">RGBA</span><span class="op" id="5488306">(</span><span class="op" id="5488307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5488313">if</span>&nbsp;<span class="ident" id="5488316">op</span>&nbsp;<span class="op" id="5488319">==</span>&nbsp;<span class="ident" id="5488322">Over</span>&nbsp;<span class="op" id="5488327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5488334">dr</span><span class="op" id="5488336">,</span>&nbsp;<span class="ident" id="5488338">dg</span><span class="op" id="5488340">,</span>&nbsp;<span class="ident" id="5488342">db</span><span class="op" id="5488344">,</span>&nbsp;<span class="ident" id="5488346">da</span>&nbsp;<span class="op" id="5488349">:=</span>&nbsp;<span class="ident" id="5488352">dst</span><span class="op" id="5488355">.</span><span class="ident" id="5488356">At</span><span class="op" id="5488358">(</span><span class="ident" id="5488359">x</span><span class="op" id="5488360">,</span>&nbsp;<span class="ident" id="5488362">y</span><span class="op" id="5488363">)</span><span class="op" id="5488364">.</span><span class="ident" id="5488365">RGBA</span><span class="op" id="5488369">(</span><span class="op" id="5488370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5488377">a</span>&nbsp;<span class="op" id="5488379">:=</span>&nbsp;<span class="ident" id="5488382">m</span>&nbsp;<span class="op" id="5488384">-</span>&nbsp;<span class="op" id="5488386">(</span><span class="ident" id="5488387">sa</span>&nbsp;<span class="op" id="5488390">*</span>&nbsp;<span class="ident" id="5488392">ma</span>&nbsp;<span class="op" id="5488395">/</span>&nbsp;<span class="ident" id="5488397">m</span><span class="op" id="5488398">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5488405">out</span><span class="op" id="5488408">.</span><span class="ident" id="5488409">R</span>&nbsp;<span class="op" id="5488411">=</span>&nbsp;<span class="builtintype" id="5488413">uint16</span><span class="op" id="5488419">(</span><span class="op" id="5488420">(</span><span class="ident" id="5488421">dr</span><span class="op" id="5488423">*</span><span class="ident" id="5488424">a</span>&nbsp;<span class="op" id="5488426">+</span>&nbsp;<span class="ident" id="5488428">sr</span><span class="op" id="5488430">*</span><span class="ident" id="5488431">ma</span><span class="op" id="5488433">)</span>&nbsp;<span class="op" id="5488435">/</span>&nbsp;<span class="ident" id="5488437">m</span><span class="op" id="5488438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5488445">out</span><span class="op" id="5488448">.</span><span class="ident" id="5488449">G</span>&nbsp;<span class="op" id="5488451">=</span>&nbsp;<span class="builtintype" id="5488453">uint16</span><span class="op" id="5488459">(</span><span class="op" id="5488460">(</span><span class="ident" id="5488461">dg</span><span class="op" id="5488463">*</span><span class="ident" id="5488464">a</span>&nbsp;<span class="op" id="5488466">+</span>&nbsp;<span class="ident" id="5488468">sg</span><span class="op" id="5488470">*</span><span class="ident" id="5488471">ma</span><span class="op" id="5488473">)</span>&nbsp;<span class="op" id="5488475">/</span>&nbsp;<span class="ident" id="5488477">m</span><span class="op" id="5488478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5488485">out</span><span class="op" id="5488488">.</span><span class="ident" id="5488489">B</span>&nbsp;<span class="op" id="5488491">=</span>&nbsp;<span class="builtintype" id="5488493">uint16</span><span class="op" id="5488499">(</span><span class="op" id="5488500">(</span><span class="ident" id="5488501">db</span><span class="op" id="5488503">*</span><span class="ident" id="5488504">a</span>&nbsp;<span class="op" id="5488506">+</span>&nbsp;<span class="ident" id="5488508">sb</span><span class="op" id="5488510">*</span><span class="ident" id="5488511">ma</span><span class="op" id="5488513">)</span>&nbsp;<span class="op" id="5488515">/</span>&nbsp;<span class="ident" id="5488517">m</span><span class="op" id="5488518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5488525">out</span><span class="op" id="5488528">.</span><span class="ident" id="5488529">A</span>&nbsp;<span class="op" id="5488531">=</span>&nbsp;<span class="builtintype" id="5488533">uint16</span><span class="op" id="5488539">(</span><span class="op" id="5488540">(</span><span class="ident" id="5488541">da</span><span class="op" id="5488543">*</span><span class="ident" id="5488544">a</span>&nbsp;<span class="op" id="5488546">+</span>&nbsp;<span class="ident" id="5488548">sa</span><span class="op" id="5488550">*</span><span class="ident" id="5488551">ma</span><span class="op" id="5488553">)</span>&nbsp;<span class="op" id="5488555">/</span>&nbsp;<span class="ident" id="5488557">m</span><span class="op" id="5488558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5488564">}</span>&nbsp;<span class="keyword" id="5488566">else</span>&nbsp;<span class="op" id="5488571">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5488578">out</span><span class="op" id="5488581">.</span><span class="ident" id="5488582">R</span>&nbsp;<span class="op" id="5488584">=</span>&nbsp;<span class="builtintype" id="5488586">uint16</span><span class="op" id="5488592">(</span><span class="ident" id="5488593">sr</span>&nbsp;<span class="op" id="5488596">*</span>&nbsp;<span class="ident" id="5488598">ma</span>&nbsp;<span class="op" id="5488601">/</span>&nbsp;<span class="ident" id="5488603">m</span><span class="op" id="5488604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5488611">out</span><span class="op" id="5488614">.</span><span class="ident" id="5488615">G</span>&nbsp;<span class="op" id="5488617">=</span>&nbsp;<span class="builtintype" id="5488619">uint16</span><span class="op" id="5488625">(</span><span class="ident" id="5488626">sg</span>&nbsp;<span class="op" id="5488629">*</span>&nbsp;<span class="ident" id="5488631">ma</span>&nbsp;<span class="op" id="5488634">/</span>&nbsp;<span class="ident" id="5488636">m</span><span class="op" id="5488637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5488644">out</span><span class="op" id="5488647">.</span><span class="ident" id="5488648">B</span>&nbsp;<span class="op" id="5488650">=</span>&nbsp;<span class="builtintype" id="5488652">uint16</span><span class="op" id="5488658">(</span><span class="ident" id="5488659">sb</span>&nbsp;<span class="op" id="5488662">*</span>&nbsp;<span class="ident" id="5488664">ma</span>&nbsp;<span class="op" id="5488667">/</span>&nbsp;<span class="ident" id="5488669">m</span><span class="op" id="5488670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5488677">out</span><span class="op" id="5488680">.</span><span class="ident" id="5488681">A</span>&nbsp;<span class="op" id="5488683">=</span>&nbsp;<span class="builtintype" id="5488685">uint16</span><span class="op" id="5488691">(</span><span class="ident" id="5488692">sa</span>&nbsp;<span class="op" id="5488695">*</span>&nbsp;<span class="ident" id="5488697">ma</span>&nbsp;<span class="op" id="5488700">/</span>&nbsp;<span class="ident" id="5488702">m</span><span class="op" id="5488703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5488709">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5488715">//&nbsp;The&nbsp;third&nbsp;argument&nbsp;is&nbsp;&amp;out&nbsp;instead&nbsp;of&nbsp;out&nbsp;(and&nbsp;out&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5488776">//&nbsp;declared&nbsp;outside&nbsp;of&nbsp;the&nbsp;inner&nbsp;loop)&nbsp;to&nbsp;avoid&nbsp;the&nbsp;implicit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5488841">//&nbsp;conversion&nbsp;to&nbsp;color.Color&nbsp;here&nbsp;allocating&nbsp;memory&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5488904">//&nbsp;inner&nbsp;loop&nbsp;if&nbsp;sizeof(color.RGBA64)&nbsp;&gt;&nbsp;sizeof(uintptr).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5488965">dst</span><span class="op" id="5488968">.</span><span class="ident" id="5488969">Set</span><span class="op" id="5488972">(</span><span class="ident" id="5488973">x</span><span class="op" id="5488974">,</span>&nbsp;<span class="ident" id="5488976">y</span><span class="op" id="5488977">,</span>&nbsp;<span class="op" id="5488979">&amp;</span><span class="ident" id="5488980">out</span><span class="op" id="5488983">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5488988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5488992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5488995">}</span><br>
<span class="lineno"></span><span class="op" id="5488997">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span><span class="keyword" id="5489000">func</span>&nbsp;<span class="ident" id="5489005">drawFillOver</span><span class="op" id="5489017">(</span><span class="ident" id="5489018">dst</span>&nbsp;<span class="op" id="5489022">*</span><span class="ident" id="5489023">image</span><span class="op" id="5489028">.</span><span class="ident" id="5489029">RGBA</span><span class="op" id="5489033">,</span>&nbsp;<span class="ident" id="5489035">r</span>&nbsp;<span class="ident" id="5489037">image</span><span class="op" id="5489042">.</span><span class="ident" id="5489043">Rectangle</span><span class="op" id="5489052">,</span>&nbsp;<span class="ident" id="5489054">src</span>&nbsp;<span class="op" id="5489058">*</span><span class="ident" id="5489059">image</span><span class="op" id="5489064">.</span><span class="ident" id="5489065">Uniform</span><span class="op" id="5489072">)</span>&nbsp;<span class="op" id="5489074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5489077">sr</span><span class="op" id="5489079">,</span>&nbsp;<span class="ident" id="5489081">sg</span><span class="op" id="5489083">,</span>&nbsp;<span class="ident" id="5489085">sb</span><span class="op" id="5489087">,</span>&nbsp;<span class="ident" id="5489089">sa</span>&nbsp;<span class="op" id="5489092">:=</span>&nbsp;<span class="ident" id="5489095">src</span><span class="op" id="5489098">.</span><span class="ident" id="5489099">RGBA</span><span class="op" id="5489103">(</span><span class="op" id="5489104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5489107">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5489165">a</span>&nbsp;<span class="op" id="5489167">:=</span>&nbsp;<span class="op" id="5489170">(</span><span class="ident" id="5489171">m</span>&nbsp;<span class="op" id="5489173">-</span>&nbsp;<span class="ident" id="5489175">sa</span><span class="op" id="5489177">)</span>&nbsp;<span class="op" id="5489179">*</span>&nbsp;<span class="num" id="5489181">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5489188">i0</span>&nbsp;<span class="op" id="5489191">:=</span>&nbsp;<span class="ident" id="5489194">dst</span><span class="op" id="5489197">.</span><span class="ident" id="5489198">PixOffset</span><span class="op" id="5489207">(</span><span class="ident" id="5489208">r</span><span class="op" id="5489209">.</span><span class="ident" id="5489210">Min</span><span class="op" id="5489213">.</span><span class="ident" id="5489214">X</span><span class="op" id="5489215">,</span>&nbsp;<span class="ident" id="5489217">r</span><span class="op" id="5489218">.</span><span class="ident" id="5489219">Min</span><span class="op" id="5489222">.</span><span class="ident" id="5489223">Y</span><span class="op" id="5489224">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5489227">i1</span>&nbsp;<span class="op" id="5489230">:=</span>&nbsp;<span class="ident" id="5489233">i0</span>&nbsp;<span class="op" id="5489236">+</span>&nbsp;<span class="ident" id="5489238">r</span><span class="op" id="5489239">.</span><span class="ident" id="5489240">Dx</span><span class="op" id="5489242">(</span><span class="op" id="5489243">)</span><span class="op" id="5489244">*</span><span class="num" id="5489245">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5489248">for</span>&nbsp;<span class="ident" id="5489252">y</span>&nbsp;<span class="op" id="5489254">:=</span>&nbsp;<span class="ident" id="5489257">r</span><span class="op" id="5489258">.</span><span class="ident" id="5489259">Min</span><span class="op" id="5489262">.</span><span class="ident" id="5489263">Y</span><span class="op" id="5489264">;</span>&nbsp;<span class="ident" id="5489266">y</span>&nbsp;<span class="op" id="5489268">!=</span>&nbsp;<span class="ident" id="5489271">r</span><span class="op" id="5489272">.</span><span class="ident" id="5489273">Max</span><span class="op" id="5489276">.</span><span class="ident" id="5489277">Y</span><span class="op" id="5489278">;</span>&nbsp;<span class="ident" id="5489280">y</span><span class="op" id="5489281">++</span>&nbsp;<span class="op" id="5489284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5489288">for</span>&nbsp;<span class="ident" id="5489292">i</span>&nbsp;<span class="op" id="5489294">:=</span>&nbsp;<span class="ident" id="5489297">i0</span><span class="op" id="5489299">;</span>&nbsp;<span class="ident" id="5489301">i</span>&nbsp;<span class="op" id="5489303">&lt;</span>&nbsp;<span class="ident" id="5489305">i1</span><span class="op" id="5489307">;</span>&nbsp;<span class="ident" id="5489309">i</span>&nbsp;<span class="op" id="5489311">+=</span>&nbsp;<span class="num" id="5489314">4</span>&nbsp;<span class="op" id="5489316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5489321">dr</span>&nbsp;<span class="op" id="5489324">:=</span>&nbsp;<span class="builtintype" id="5489327">uint32</span><span class="op" id="5489333">(</span><span class="ident" id="5489334">dst</span><span class="op" id="5489337">.</span><span class="ident" id="5489338">Pix</span><span class="op" id="5489341">[</span><span class="ident" id="5489342">i</span><span class="op" id="5489343">+</span><span class="num" id="5489344">0</span><span class="op" id="5489345">]</span><span class="op" id="5489346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5489351">dg</span>&nbsp;<span class="op" id="5489354">:=</span>&nbsp;<span class="builtintype" id="5489357">uint32</span><span class="op" id="5489363">(</span><span class="ident" id="5489364">dst</span><span class="op" id="5489367">.</span><span class="ident" id="5489368">Pix</span><span class="op" id="5489371">[</span><span class="ident" id="5489372">i</span><span class="op" id="5489373">+</span><span class="num" id="5489374">1</span><span class="op" id="5489375">]</span><span class="op" id="5489376">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5489381">db</span>&nbsp;<span class="op" id="5489384">:=</span>&nbsp;<span class="builtintype" id="5489387">uint32</span><span class="op" id="5489393">(</span><span class="ident" id="5489394">dst</span><span class="op" id="5489397">.</span><span class="ident" id="5489398">Pix</span><span class="op" id="5489401">[</span><span class="ident" id="5489402">i</span><span class="op" id="5489403">+</span><span class="num" id="5489404">2</span><span class="op" id="5489405">]</span><span class="op" id="5489406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5489411">da</span>&nbsp;<span class="op" id="5489414">:=</span>&nbsp;<span class="builtintype" id="5489417">uint32</span><span class="op" id="5489423">(</span><span class="ident" id="5489424">dst</span><span class="op" id="5489427">.</span><span class="ident" id="5489428">Pix</span><span class="op" id="5489431">[</span><span class="ident" id="5489432">i</span><span class="op" id="5489433">+</span><span class="num" id="5489434">3</span><span class="op" id="5489435">]</span><span class="op" id="5489436">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5489442">dst</span><span class="op" id="5489445">.</span><span class="ident" id="5489446">Pix</span><span class="op" id="5489449">[</span><span class="ident" id="5489450">i</span><span class="op" id="5489451">+</span><span class="num" id="5489452">0</span><span class="op" id="5489453">]</span>&nbsp;<span class="op" id="5489455">=</span>&nbsp;<span class="builtintype" id="5489457">uint8</span><span class="op" id="5489462">(</span><span class="op" id="5489463">(</span><span class="ident" id="5489464">dr</span><span class="op" id="5489466">*</span><span class="ident" id="5489467">a</span><span class="op" id="5489468">/</span><span class="ident" id="5489469">m</span>&nbsp;<span class="op" id="5489471">+</span>&nbsp;<span class="ident" id="5489473">sr</span><span class="op" id="5489475">)</span>&nbsp;<span class="op" id="5489477">&gt;&gt;</span>&nbsp;<span class="num" id="5489480">8</span><span class="op" id="5489481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5489486">dst</span><span class="op" id="5489489">.</span><span class="ident" id="5489490">Pix</span><span class="op" id="5489493">[</span><span class="ident" id="5489494">i</span><span class="op" id="5489495">+</span><span class="num" id="5489496">1</span><span class="op" id="5489497">]</span>&nbsp;<span class="op" id="5489499">=</span>&nbsp;<span class="builtintype" id="5489501">uint8</span><span class="op" id="5489506">(</span><span class="op" id="5489507">(</span><span class="ident" id="5489508">dg</span><span class="op" id="5489510">*</span><span class="ident" id="5489511">a</span><span class="op" id="5489512">/</span><span class="ident" id="5489513">m</span>&nbsp;<span class="op" id="5489515">+</span>&nbsp;<span class="ident" id="5489517">sg</span><span class="op" id="5489519">)</span>&nbsp;<span class="op" id="5489521">&gt;&gt;</span>&nbsp;<span class="num" id="5489524">8</span><span class="op" id="5489525">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5489530">dst</span><span class="op" id="5489533">.</span><span class="ident" id="5489534">Pix</span><span class="op" id="5489537">[</span><span class="ident" id="5489538">i</span><span class="op" id="5489539">+</span><span class="num" id="5489540">2</span><span class="op" id="5489541">]</span>&nbsp;<span class="op" id="5489543">=</span>&nbsp;<span class="builtintype" id="5489545">uint8</span><span class="op" id="5489550">(</span><span class="op" id="5489551">(</span><span class="ident" id="5489552">db</span><span class="op" id="5489554">*</span><span class="ident" id="5489555">a</span><span class="op" id="5489556">/</span><span class="ident" id="5489557">m</span>&nbsp;<span class="op" id="5489559">+</span>&nbsp;<span class="ident" id="5489561">sb</span><span class="op" id="5489563">)</span>&nbsp;<span class="op" id="5489565">&gt;&gt;</span>&nbsp;<span class="num" id="5489568">8</span><span class="op" id="5489569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5489574">dst</span><span class="op" id="5489577">.</span><span class="ident" id="5489578">Pix</span><span class="op" id="5489581">[</span><span class="ident" id="5489582">i</span><span class="op" id="5489583">+</span><span class="num" id="5489584">3</span><span class="op" id="5489585">]</span>&nbsp;<span class="op" id="5489587">=</span>&nbsp;<span class="builtintype" id="5489589">uint8</span><span class="op" id="5489594">(</span><span class="op" id="5489595">(</span><span class="ident" id="5489596">da</span><span class="op" id="5489598">*</span><span class="ident" id="5489599">a</span><span class="op" id="5489600">/</span><span class="ident" id="5489601">m</span>&nbsp;<span class="op" id="5489603">+</span>&nbsp;<span class="ident" id="5489605">sa</span><span class="op" id="5489607">)</span>&nbsp;<span class="op" id="5489609">&gt;&gt;</span>&nbsp;<span class="num" id="5489612">8</span><span class="op" id="5489613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5489617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5489621">i0</span>&nbsp;<span class="op" id="5489624">+=</span>&nbsp;<span class="ident" id="5489627">dst</span><span class="op" id="5489630">.</span><span class="ident" id="5489631">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5489640">i1</span>&nbsp;<span class="op" id="5489643">+=</span>&nbsp;<span class="ident" id="5489646">dst</span><span class="op" id="5489649">.</span><span class="ident" id="5489650">Stride</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5489658">}</span><br>
<span class="lineno"></span><span class="op" id="5489660">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5489663">func</span>&nbsp;<span class="ident" id="5489668">drawFillSrc</span><span class="op" id="5489679">(</span><span class="ident" id="5489680">dst</span>&nbsp;<span class="op" id="5489684">*</span><span class="ident" id="5489685">image</span><span class="op" id="5489690">.</span><span class="ident" id="5489691">RGBA</span><span class="op" id="5489695">,</span>&nbsp;<span class="ident" id="5489697">r</span>&nbsp;<span class="ident" id="5489699">image</span><span class="op" id="5489704">.</span><span class="ident" id="5489705">Rectangle</span><span class="op" id="5489714">,</span>&nbsp;<span class="ident" id="5489716">src</span>&nbsp;<span class="op" id="5489720">*</span><span class="ident" id="5489721">image</span><span class="op" id="5489726">.</span><span class="ident" id="5489727">Uniform</span><span class="op" id="5489734">)</span>&nbsp;<span class="op" id="5489736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5489739">sr</span><span class="op" id="5489741">,</span>&nbsp;<span class="ident" id="5489743">sg</span><span class="op" id="5489745">,</span>&nbsp;<span class="ident" id="5489747">sb</span><span class="op" id="5489749">,</span>&nbsp;<span class="ident" id="5489751">sa</span>&nbsp;<span class="op" id="5489754">:=</span>&nbsp;<span class="ident" id="5489757">src</span><span class="op" id="5489760">.</span><span class="ident" id="5489761">RGBA</span><span class="op" id="5489765">(</span><span class="op" id="5489766">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5489769">//&nbsp;The&nbsp;built-in&nbsp;copy&nbsp;function&nbsp;is&nbsp;faster&nbsp;than&nbsp;a&nbsp;straightforward&nbsp;for&nbsp;loop&nbsp;to&nbsp;fill&nbsp;the&nbsp;destination&nbsp;with</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5489871">//&nbsp;the&nbsp;color,&nbsp;but&nbsp;copy&nbsp;requires&nbsp;a&nbsp;slice&nbsp;source.&nbsp;We&nbsp;therefore&nbsp;use&nbsp;a&nbsp;for&nbsp;loop&nbsp;to&nbsp;fill&nbsp;the&nbsp;first&nbsp;row,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5489975">//&nbsp;then&nbsp;use&nbsp;the&nbsp;first&nbsp;row&nbsp;as&nbsp;the&nbsp;slice&nbsp;source&nbsp;for&nbsp;the&nbsp;remaining&nbsp;rows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5490046">i0</span>&nbsp;<span class="op" id="5490049">:=</span>&nbsp;<span class="ident" id="5490052">dst</span><span class="op" id="5490055">.</span><span class="ident" id="5490056">PixOffset</span><span class="op" id="5490065">(</span><span class="ident" id="5490066">r</span><span class="op" id="5490067">.</span><span class="ident" id="5490068">Min</span><span class="op" id="5490071">.</span><span class="ident" id="5490072">X</span><span class="op" id="5490073">,</span>&nbsp;<span class="ident" id="5490075">r</span><span class="op" id="5490076">.</span><span class="ident" id="5490077">Min</span><span class="op" id="5490080">.</span><span class="ident" id="5490081">Y</span><span class="op" id="5490082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5490085">i1</span>&nbsp;<span class="op" id="5490088">:=</span>&nbsp;<span class="ident" id="5490091">i0</span>&nbsp;<span class="op" id="5490094">+</span>&nbsp;<span class="ident" id="5490096">r</span><span class="op" id="5490097">.</span><span class="ident" id="5490098">Dx</span><span class="op" id="5490100">(</span><span class="op" id="5490101">)</span><span class="op" id="5490102">*</span><span class="num" id="5490103">4</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5490106">for</span>&nbsp;<span class="ident" id="5490110">i</span>&nbsp;<span class="op" id="5490112">:=</span>&nbsp;<span class="ident" id="5490115">i0</span><span class="op" id="5490117">;</span>&nbsp;<span class="ident" id="5490119">i</span>&nbsp;<span class="op" id="5490121">&lt;</span>&nbsp;<span class="ident" id="5490123">i1</span><span class="op" id="5490125">;</span>&nbsp;<span class="ident" id="5490127">i</span>&nbsp;<span class="op" id="5490129">+=</span>&nbsp;<span class="num" id="5490132">4</span>&nbsp;<span class="op" id="5490134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5490138">dst</span><span class="op" id="5490141">.</span><span class="ident" id="5490142">Pix</span><span class="op" id="5490145">[</span><span class="ident" id="5490146">i</span><span class="op" id="5490147">+</span><span class="num" id="5490148">0</span><span class="op" id="5490149">]</span>&nbsp;<span class="op" id="5490151">=</span>&nbsp;<span class="builtintype" id="5490153">uint8</span><span class="op" id="5490158">(</span><span class="ident" id="5490159">sr</span>&nbsp;<span class="op" id="5490162">&gt;&gt;</span>&nbsp;<span class="num" id="5490165">8</span><span class="op" id="5490166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5490170">dst</span><span class="op" id="5490173">.</span><span class="ident" id="5490174">Pix</span><span class="op" id="5490177">[</span><span class="ident" id="5490178">i</span><span class="op" id="5490179">+</span><span class="num" id="5490180">1</span><span class="op" id="5490181">]</span>&nbsp;<span class="op" id="5490183">=</span>&nbsp;<span class="builtintype" id="5490185">uint8</span><span class="op" id="5490190">(</span><span class="ident" id="5490191">sg</span>&nbsp;<span class="op" id="5490194">&gt;&gt;</span>&nbsp;<span class="num" id="5490197">8</span><span class="op" id="5490198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5490202">dst</span><span class="op" id="5490205">.</span><span class="ident" id="5490206">Pix</span><span class="op" id="5490209">[</span><span class="ident" id="5490210">i</span><span class="op" id="5490211">+</span><span class="num" id="5490212">2</span><span class="op" id="5490213">]</span>&nbsp;<span class="op" id="5490215">=</span>&nbsp;<span class="builtintype" id="5490217">uint8</span><span class="op" id="5490222">(</span><span class="ident" id="5490223">sb</span>&nbsp;<span class="op" id="5490226">&gt;&gt;</span>&nbsp;<span class="num" id="5490229">8</span><span class="op" id="5490230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5490234">dst</span><span class="op" id="5490237">.</span><span class="ident" id="5490238">Pix</span><span class="op" id="5490241">[</span><span class="ident" id="5490242">i</span><span class="op" id="5490243">+</span><span class="num" id="5490244">3</span><span class="op" id="5490245">]</span>&nbsp;<span class="op" id="5490247">=</span>&nbsp;<span class="builtintype" id="5490249">uint8</span><span class="op" id="5490254">(</span><span class="ident" id="5490255">sa</span>&nbsp;<span class="op" id="5490258">&gt;&gt;</span>&nbsp;<span class="num" id="5490261">8</span><span class="op" id="5490262">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5490265">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5490268">firstRow</span>&nbsp;<span class="op" id="5490277">:=</span>&nbsp;<span class="ident" id="5490280">dst</span><span class="op" id="5490283">.</span><span class="ident" id="5490284">Pix</span><span class="op" id="5490287">[</span><span class="ident" id="5490288">i0</span><span class="op" id="5490290">:</span><span class="ident" id="5490291">i1</span><span class="op" id="5490293">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5490296">for</span>&nbsp;<span class="ident" id="5490300">y</span>&nbsp;<span class="op" id="5490302">:=</span>&nbsp;<span class="ident" id="5490305">r</span><span class="op" id="5490306">.</span><span class="ident" id="5490307">Min</span><span class="op" id="5490310">.</span><span class="ident" id="5490311">Y</span>&nbsp;<span class="op" id="5490313">+</span>&nbsp;<span class="num" id="5490315">1</span><span class="op" id="5490316">;</span>&nbsp;<span class="ident" id="5490318">y</span>&nbsp;<span class="op" id="5490320">&lt;</span>&nbsp;<span class="ident" id="5490322">r</span><span class="op" id="5490323">.</span><span class="ident" id="5490324">Max</span><span class="op" id="5490327">.</span><span class="ident" id="5490328">Y</span><span class="op" id="5490329">;</span>&nbsp;<span class="ident" id="5490331">y</span><span class="op" id="5490332">++</span>&nbsp;<span class="op" id="5490335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5490339">i0</span>&nbsp;<span class="op" id="5490342">+=</span>&nbsp;<span class="ident" id="5490345">dst</span><span class="op" id="5490348">.</span><span class="ident" id="5490349">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5490358">i1</span>&nbsp;<span class="op" id="5490361">+=</span>&nbsp;<span class="ident" id="5490364">dst</span><span class="op" id="5490367">.</span><span class="ident" id="5490368">Stride</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5490377">copy</span><span class="op" id="5490381">(</span><span class="ident" id="5490382">dst</span><span class="op" id="5490385">.</span><span class="ident" id="5490386">Pix</span><span class="op" id="5490389">[</span><span class="ident" id="5490390">i0</span><span class="op" id="5490392">:</span><span class="ident" id="5490393">i1</span><span class="op" id="5490395">]</span><span class="op" id="5490396">,</span>&nbsp;<span class="ident" id="5490398">firstRow</span><span class="op" id="5490406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5490409">}</span><br>
<span class="lineno"></span><span class="op" id="5490411">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5490414">func</span>&nbsp;<span class="ident" id="5490419">drawCopyOver</span><span class="op" id="5490431">(</span><span class="ident" id="5490432">dst</span>&nbsp;<span class="op" id="5490436">*</span><span class="ident" id="5490437">image</span><span class="op" id="5490442">.</span><span class="ident" id="5490443">RGBA</span><span class="op" id="5490447">,</span>&nbsp;<span class="ident" id="5490449">r</span>&nbsp;<span class="ident" id="5490451">image</span><span class="op" id="5490456">.</span><span class="ident" id="5490457">Rectangle</span><span class="op" id="5490466">,</span>&nbsp;<span class="ident" id="5490468">src</span>&nbsp;<span class="op" id="5490472">*</span><span class="ident" id="5490473">image</span><span class="op" id="5490478">.</span><span class="ident" id="5490479">RGBA</span><span class="op" id="5490483">,</span>&nbsp;<span class="ident" id="5490485">sp</span>&nbsp;<span class="ident" id="5490488">image</span><span class="op" id="5490493">.</span><span class="ident" id="5490494">Point</span><span class="op" id="5490499">)</span>&nbsp;<span class="op" id="5490501">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5490504">dx</span><span class="op" id="5490506">,</span>&nbsp;<span class="ident" id="5490508">dy</span>&nbsp;<span class="op" id="5490511">:=</span>&nbsp;<span class="ident" id="5490514">r</span><span class="op" id="5490515">.</span><span class="ident" id="5490516">Dx</span><span class="op" id="5490518">(</span><span class="op" id="5490519">)</span><span class="op" id="5490520">,</span>&nbsp;<span class="ident" id="5490522">r</span><span class="op" id="5490523">.</span><span class="ident" id="5490524">Dy</span><span class="op" id="5490526">(</span><span class="op" id="5490527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5490530">d0</span>&nbsp;<span class="op" id="5490533">:=</span>&nbsp;<span class="ident" id="5490536">dst</span><span class="op" id="5490539">.</span><span class="ident" id="5490540">PixOffset</span><span class="op" id="5490549">(</span><span class="ident" id="5490550">r</span><span class="op" id="5490551">.</span><span class="ident" id="5490552">Min</span><span class="op" id="5490555">.</span><span class="ident" id="5490556">X</span><span class="op" id="5490557">,</span>&nbsp;<span class="ident" id="5490559">r</span><span class="op" id="5490560">.</span><span class="ident" id="5490561">Min</span><span class="op" id="5490564">.</span><span class="ident" id="5490565">Y</span><span class="op" id="5490566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5490569">s0</span>&nbsp;<span class="op" id="5490572">:=</span>&nbsp;<span class="ident" id="5490575">src</span><span class="op" id="5490578">.</span><span class="ident" id="5490579">PixOffset</span><span class="op" id="5490588">(</span><span class="ident" id="5490589">sp</span><span class="op" id="5490591">.</span><span class="ident" id="5490592">X</span><span class="op" id="5490593">,</span>&nbsp;<span class="ident" id="5490595">sp</span><span class="op" id="5490597">.</span><span class="ident" id="5490598">Y</span><span class="op" id="5490599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5490602">var</span>&nbsp;<span class="op" id="5490606">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5490610">ddelta</span><span class="op" id="5490616">,</span>&nbsp;<span class="ident" id="5490618">sdelta</span>&nbsp;<span class="builtintype" id="5490625">int</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5490631">i0</span><span class="op" id="5490633">,</span>&nbsp;<span class="ident" id="5490635">i1</span><span class="op" id="5490637">,</span>&nbsp;<span class="ident" id="5490639">idelta</span>&nbsp;<span class="builtintype" id="5490646">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5490651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5490654">if</span>&nbsp;<span class="ident" id="5490657">r</span><span class="op" id="5490658">.</span><span class="ident" id="5490659">Min</span><span class="op" id="5490662">.</span><span class="ident" id="5490663">Y</span>&nbsp;<span class="op" id="5490665">&lt;</span>&nbsp;<span class="ident" id="5490667">sp</span><span class="op" id="5490669">.</span><span class="ident" id="5490670">Y</span>&nbsp;<span class="op" id="5490672">||</span>&nbsp;<span class="ident" id="5490675">r</span><span class="op" id="5490676">.</span><span class="ident" id="5490677">Min</span><span class="op" id="5490680">.</span><span class="ident" id="5490681">Y</span>&nbsp;<span class="op" id="5490683">==</span>&nbsp;<span class="ident" id="5490686">sp</span><span class="op" id="5490688">.</span><span class="ident" id="5490689">Y</span>&nbsp;<span class="op" id="5490691">&amp;&amp;</span>&nbsp;<span class="ident" id="5490694">r</span><span class="op" id="5490695">.</span><span class="ident" id="5490696">Min</span><span class="op" id="5490699">.</span><span class="ident" id="5490700">X</span>&nbsp;<span class="op" id="5490702">&lt;=</span>&nbsp;<span class="ident" id="5490705">sp</span><span class="op" id="5490707">.</span><span class="ident" id="5490708">X</span>&nbsp;<span class="op" id="5490710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5490714">ddelta</span>&nbsp;<span class="op" id="5490721">=</span>&nbsp;<span class="ident" id="5490723">dst</span><span class="op" id="5490726">.</span><span class="ident" id="5490727">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5490736">sdelta</span>&nbsp;<span class="op" id="5490743">=</span>&nbsp;<span class="ident" id="5490745">src</span><span class="op" id="5490748">.</span><span class="ident" id="5490749">Stride</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5490758">i0</span><span class="op" id="5490760">,</span>&nbsp;<span class="ident" id="5490762">i1</span><span class="op" id="5490764">,</span>&nbsp;<span class="ident" id="5490766">idelta</span>&nbsp;<span class="op" id="5490773">=</span>&nbsp;<span class="num" id="5490775">0</span><span class="op" id="5490776">,</span>&nbsp;<span class="ident" id="5490778">dx</span><span class="op" id="5490780">*</span><span class="num" id="5490781">4</span><span class="op" id="5490782">,</span>&nbsp;<span class="op" id="5490784">+</span><span class="num" id="5490785">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5490788">}</span>&nbsp;<span class="keyword" id="5490790">else</span>&nbsp;<span class="op" id="5490795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5490799">//&nbsp;If&nbsp;the&nbsp;source&nbsp;start&nbsp;point&nbsp;is&nbsp;higher&nbsp;than&nbsp;the&nbsp;destination&nbsp;start&nbsp;point,&nbsp;or&nbsp;equal&nbsp;height&nbsp;but&nbsp;to&nbsp;the&nbsp;left,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5490907">//&nbsp;then&nbsp;we&nbsp;compose&nbsp;the&nbsp;rows&nbsp;in&nbsp;right-to-left,&nbsp;bottom-up&nbsp;order&nbsp;instead&nbsp;of&nbsp;left-to-right,&nbsp;top-down.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491007">d0</span>&nbsp;<span class="op" id="5491010">+=</span>&nbsp;<span class="op" id="5491013">(</span><span class="ident" id="5491014">dy</span>&nbsp;<span class="op" id="5491017">-</span>&nbsp;<span class="num" id="5491019">1</span><span class="op" id="5491020">)</span>&nbsp;<span class="op" id="5491022">*</span>&nbsp;<span class="ident" id="5491024">dst</span><span class="op" id="5491027">.</span><span class="ident" id="5491028">Stride</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491037">s0</span>&nbsp;<span class="op" id="5491040">+=</span>&nbsp;<span class="op" id="5491043">(</span><span class="ident" id="5491044">dy</span>&nbsp;<span class="op" id="5491047">-</span>&nbsp;<span class="num" id="5491049">1</span><span class="op" id="5491050">)</span>&nbsp;<span class="op" id="5491052">*</span>&nbsp;<span class="ident" id="5491054">src</span><span class="op" id="5491057">.</span><span class="ident" id="5491058">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491067">ddelta</span>&nbsp;<span class="op" id="5491074">=</span>&nbsp;<span class="op" id="5491076">-</span><span class="ident" id="5491077">dst</span><span class="op" id="5491080">.</span><span class="ident" id="5491081">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491090">sdelta</span>&nbsp;<span class="op" id="5491097">=</span>&nbsp;<span class="op" id="5491099">-</span><span class="ident" id="5491100">src</span><span class="op" id="5491103">.</span><span class="ident" id="5491104">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491113">i0</span><span class="op" id="5491115">,</span>&nbsp;<span class="ident" id="5491117">i1</span><span class="op" id="5491119">,</span>&nbsp;<span class="ident" id="5491121">idelta</span>&nbsp;<span class="op" id="5491128">=</span>&nbsp;<span class="op" id="5491130">(</span><span class="ident" id="5491131">dx</span><span class="op" id="5491133">-</span><span class="num" id="5491134">1</span><span class="op" id="5491135">)</span><span class="op" id="5491136">*</span><span class="num" id="5491137">4</span><span class="op" id="5491138">,</span>&nbsp;<span class="op" id="5491140">-</span><span class="num" id="5491141">4</span><span class="op" id="5491142">,</span>&nbsp;<span class="op" id="5491144">-</span><span class="num" id="5491145">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5491148">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5491151">for</span>&nbsp;<span class="op" id="5491155">;</span>&nbsp;<span class="ident" id="5491157">dy</span>&nbsp;<span class="op" id="5491160">&gt;</span>&nbsp;<span class="num" id="5491162">0</span><span class="op" id="5491163">;</span>&nbsp;<span class="ident" id="5491165">dy</span><span class="op" id="5491167">--</span>&nbsp;<span class="op" id="5491170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491174">dpix</span>&nbsp;<span class="op" id="5491179">:=</span>&nbsp;<span class="ident" id="5491182">dst</span><span class="op" id="5491185">.</span><span class="ident" id="5491186">Pix</span><span class="op" id="5491189">[</span><span class="ident" id="5491190">d0</span><span class="op" id="5491192">:</span><span class="op" id="5491193">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491197">spix</span>&nbsp;<span class="op" id="5491202">:=</span>&nbsp;<span class="ident" id="5491205">src</span><span class="op" id="5491208">.</span><span class="ident" id="5491209">Pix</span><span class="op" id="5491212">[</span><span class="ident" id="5491213">s0</span><span class="op" id="5491215">:</span><span class="op" id="5491216">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5491220">for</span>&nbsp;<span class="ident" id="5491224">i</span>&nbsp;<span class="op" id="5491226">:=</span>&nbsp;<span class="ident" id="5491229">i0</span><span class="op" id="5491231">;</span>&nbsp;<span class="ident" id="5491233">i</span>&nbsp;<span class="op" id="5491235">!=</span>&nbsp;<span class="ident" id="5491238">i1</span><span class="op" id="5491240">;</span>&nbsp;<span class="ident" id="5491242">i</span>&nbsp;<span class="op" id="5491244">+=</span>&nbsp;<span class="ident" id="5491247">idelta</span>&nbsp;<span class="op" id="5491254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491259">sr</span>&nbsp;<span class="op" id="5491262">:=</span>&nbsp;<span class="builtintype" id="5491265">uint32</span><span class="op" id="5491271">(</span><span class="ident" id="5491272">spix</span><span class="op" id="5491276">[</span><span class="ident" id="5491277">i</span><span class="op" id="5491278">+</span><span class="num" id="5491279">0</span><span class="op" id="5491280">]</span><span class="op" id="5491281">)</span>&nbsp;<span class="op" id="5491283">*</span>&nbsp;<span class="num" id="5491285">0x101</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491294">sg</span>&nbsp;<span class="op" id="5491297">:=</span>&nbsp;<span class="builtintype" id="5491300">uint32</span><span class="op" id="5491306">(</span><span class="ident" id="5491307">spix</span><span class="op" id="5491311">[</span><span class="ident" id="5491312">i</span><span class="op" id="5491313">+</span><span class="num" id="5491314">1</span><span class="op" id="5491315">]</span><span class="op" id="5491316">)</span>&nbsp;<span class="op" id="5491318">*</span>&nbsp;<span class="num" id="5491320">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491329">sb</span>&nbsp;<span class="op" id="5491332">:=</span>&nbsp;<span class="builtintype" id="5491335">uint32</span><span class="op" id="5491341">(</span><span class="ident" id="5491342">spix</span><span class="op" id="5491346">[</span><span class="ident" id="5491347">i</span><span class="op" id="5491348">+</span><span class="num" id="5491349">2</span><span class="op" id="5491350">]</span><span class="op" id="5491351">)</span>&nbsp;<span class="op" id="5491353">*</span>&nbsp;<span class="num" id="5491355">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491364">sa</span>&nbsp;<span class="op" id="5491367">:=</span>&nbsp;<span class="builtintype" id="5491370">uint32</span><span class="op" id="5491376">(</span><span class="ident" id="5491377">spix</span><span class="op" id="5491381">[</span><span class="ident" id="5491382">i</span><span class="op" id="5491383">+</span><span class="num" id="5491384">3</span><span class="op" id="5491385">]</span><span class="op" id="5491386">)</span>&nbsp;<span class="op" id="5491388">*</span>&nbsp;<span class="num" id="5491390">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491400">dr</span>&nbsp;<span class="op" id="5491403">:=</span>&nbsp;<span class="builtintype" id="5491406">uint32</span><span class="op" id="5491412">(</span><span class="ident" id="5491413">dpix</span><span class="op" id="5491417">[</span><span class="ident" id="5491418">i</span><span class="op" id="5491419">+</span><span class="num" id="5491420">0</span><span class="op" id="5491421">]</span><span class="op" id="5491422">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491427">dg</span>&nbsp;<span class="op" id="5491430">:=</span>&nbsp;<span class="builtintype" id="5491433">uint32</span><span class="op" id="5491439">(</span><span class="ident" id="5491440">dpix</span><span class="op" id="5491444">[</span><span class="ident" id="5491445">i</span><span class="op" id="5491446">+</span><span class="num" id="5491447">1</span><span class="op" id="5491448">]</span><span class="op" id="5491449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491454">db</span>&nbsp;<span class="op" id="5491457">:=</span>&nbsp;<span class="builtintype" id="5491460">uint32</span><span class="op" id="5491466">(</span><span class="ident" id="5491467">dpix</span><span class="op" id="5491471">[</span><span class="ident" id="5491472">i</span><span class="op" id="5491473">+</span><span class="num" id="5491474">2</span><span class="op" id="5491475">]</span><span class="op" id="5491476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491481">da</span>&nbsp;<span class="op" id="5491484">:=</span>&nbsp;<span class="builtintype" id="5491487">uint32</span><span class="op" id="5491493">(</span><span class="ident" id="5491494">dpix</span><span class="op" id="5491498">[</span><span class="ident" id="5491499">i</span><span class="op" id="5491500">+</span><span class="num" id="5491501">3</span><span class="op" id="5491502">]</span><span class="op" id="5491503">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5491509">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491569">a</span>&nbsp;<span class="op" id="5491571">:=</span>&nbsp;<span class="op" id="5491574">(</span><span class="ident" id="5491575">m</span>&nbsp;<span class="op" id="5491577">-</span>&nbsp;<span class="ident" id="5491579">sa</span><span class="op" id="5491581">)</span>&nbsp;<span class="op" id="5491583">*</span>&nbsp;<span class="num" id="5491585">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491595">dpix</span><span class="op" id="5491599">[</span><span class="ident" id="5491600">i</span><span class="op" id="5491601">+</span><span class="num" id="5491602">0</span><span class="op" id="5491603">]</span>&nbsp;<span class="op" id="5491605">=</span>&nbsp;<span class="builtintype" id="5491607">uint8</span><span class="op" id="5491612">(</span><span class="op" id="5491613">(</span><span class="ident" id="5491614">dr</span><span class="op" id="5491616">*</span><span class="ident" id="5491617">a</span><span class="op" id="5491618">/</span><span class="ident" id="5491619">m</span>&nbsp;<span class="op" id="5491621">+</span>&nbsp;<span class="ident" id="5491623">sr</span><span class="op" id="5491625">)</span>&nbsp;<span class="op" id="5491627">&gt;&gt;</span>&nbsp;<span class="num" id="5491630">8</span><span class="op" id="5491631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491636">dpix</span><span class="op" id="5491640">[</span><span class="ident" id="5491641">i</span><span class="op" id="5491642">+</span><span class="num" id="5491643">1</span><span class="op" id="5491644">]</span>&nbsp;<span class="op" id="5491646">=</span>&nbsp;<span class="builtintype" id="5491648">uint8</span><span class="op" id="5491653">(</span><span class="op" id="5491654">(</span><span class="ident" id="5491655">dg</span><span class="op" id="5491657">*</span><span class="ident" id="5491658">a</span><span class="op" id="5491659">/</span><span class="ident" id="5491660">m</span>&nbsp;<span class="op" id="5491662">+</span>&nbsp;<span class="ident" id="5491664">sg</span><span class="op" id="5491666">)</span>&nbsp;<span class="op" id="5491668">&gt;&gt;</span>&nbsp;<span class="num" id="5491671">8</span><span class="op" id="5491672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491677">dpix</span><span class="op" id="5491681">[</span><span class="ident" id="5491682">i</span><span class="op" id="5491683">+</span><span class="num" id="5491684">2</span><span class="op" id="5491685">]</span>&nbsp;<span class="op" id="5491687">=</span>&nbsp;<span class="builtintype" id="5491689">uint8</span><span class="op" id="5491694">(</span><span class="op" id="5491695">(</span><span class="ident" id="5491696">db</span><span class="op" id="5491698">*</span><span class="ident" id="5491699">a</span><span class="op" id="5491700">/</span><span class="ident" id="5491701">m</span>&nbsp;<span class="op" id="5491703">+</span>&nbsp;<span class="ident" id="5491705">sb</span><span class="op" id="5491707">)</span>&nbsp;<span class="op" id="5491709">&gt;&gt;</span>&nbsp;<span class="num" id="5491712">8</span><span class="op" id="5491713">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491718">dpix</span><span class="op" id="5491722">[</span><span class="ident" id="5491723">i</span><span class="op" id="5491724">+</span><span class="num" id="5491725">3</span><span class="op" id="5491726">]</span>&nbsp;<span class="op" id="5491728">=</span>&nbsp;<span class="builtintype" id="5491730">uint8</span><span class="op" id="5491735">(</span><span class="op" id="5491736">(</span><span class="ident" id="5491737">da</span><span class="op" id="5491739">*</span><span class="ident" id="5491740">a</span><span class="op" id="5491741">/</span><span class="ident" id="5491742">m</span>&nbsp;<span class="op" id="5491744">+</span>&nbsp;<span class="ident" id="5491746">sa</span><span class="op" id="5491748">)</span>&nbsp;<span class="op" id="5491750">&gt;&gt;</span>&nbsp;<span class="num" id="5491753">8</span><span class="op" id="5491754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5491758">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491762">d0</span>&nbsp;<span class="op" id="5491765">+=</span>&nbsp;<span class="ident" id="5491768">ddelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491777">s0</span>&nbsp;<span class="op" id="5491780">+=</span>&nbsp;<span class="ident" id="5491783">sdelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5491791">}</span><br>
<span class="lineno">305</span><span class="op" id="5491793">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5491796">func</span>&nbsp;<span class="ident" id="5491801">drawCopySrc</span><span class="op" id="5491812">(</span><span class="ident" id="5491813">dst</span>&nbsp;<span class="op" id="5491817">*</span><span class="ident" id="5491818">image</span><span class="op" id="5491823">.</span><span class="ident" id="5491824">RGBA</span><span class="op" id="5491828">,</span>&nbsp;<span class="ident" id="5491830">r</span>&nbsp;<span class="ident" id="5491832">image</span><span class="op" id="5491837">.</span><span class="ident" id="5491838">Rectangle</span><span class="op" id="5491847">,</span>&nbsp;<span class="ident" id="5491849">src</span>&nbsp;<span class="op" id="5491853">*</span><span class="ident" id="5491854">image</span><span class="op" id="5491859">.</span><span class="ident" id="5491860">RGBA</span><span class="op" id="5491864">,</span>&nbsp;<span class="ident" id="5491866">sp</span>&nbsp;<span class="ident" id="5491869">image</span><span class="op" id="5491874">.</span><span class="ident" id="5491875">Point</span><span class="op" id="5491880">)</span>&nbsp;<span class="op" id="5491882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491885">n</span><span class="op" id="5491886">,</span>&nbsp;<span class="ident" id="5491888">dy</span>&nbsp;<span class="op" id="5491891">:=</span>&nbsp;<span class="num" id="5491894">4</span><span class="op" id="5491895">*</span><span class="ident" id="5491896">r</span><span class="op" id="5491897">.</span><span class="ident" id="5491898">Dx</span><span class="op" id="5491900">(</span><span class="op" id="5491901">)</span><span class="op" id="5491902">,</span>&nbsp;<span class="ident" id="5491904">r</span><span class="op" id="5491905">.</span><span class="ident" id="5491906">Dy</span><span class="op" id="5491908">(</span><span class="op" id="5491909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491912">d0</span>&nbsp;<span class="op" id="5491915">:=</span>&nbsp;<span class="ident" id="5491918">dst</span><span class="op" id="5491921">.</span><span class="ident" id="5491922">PixOffset</span><span class="op" id="5491931">(</span><span class="ident" id="5491932">r</span><span class="op" id="5491933">.</span><span class="ident" id="5491934">Min</span><span class="op" id="5491937">.</span><span class="ident" id="5491938">X</span><span class="op" id="5491939">,</span>&nbsp;<span class="ident" id="5491941">r</span><span class="op" id="5491942">.</span><span class="ident" id="5491943">Min</span><span class="op" id="5491946">.</span><span class="ident" id="5491947">Y</span><span class="op" id="5491948">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491951">s0</span>&nbsp;<span class="op" id="5491954">:=</span>&nbsp;<span class="ident" id="5491957">src</span><span class="op" id="5491960">.</span><span class="ident" id="5491961">PixOffset</span><span class="op" id="5491970">(</span><span class="ident" id="5491971">sp</span><span class="op" id="5491973">.</span><span class="ident" id="5491974">X</span><span class="op" id="5491975">,</span>&nbsp;<span class="ident" id="5491977">sp</span><span class="op" id="5491979">.</span><span class="ident" id="5491980">Y</span><span class="op" id="5491981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5491984">var</span>&nbsp;<span class="ident" id="5491988">ddelta</span><span class="op" id="5491994">,</span>&nbsp;<span class="ident" id="5491996">sdelta</span>&nbsp;<span class="builtintype" id="5492003">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5492008">if</span>&nbsp;<span class="ident" id="5492011">r</span><span class="op" id="5492012">.</span><span class="ident" id="5492013">Min</span><span class="op" id="5492016">.</span><span class="ident" id="5492017">Y</span>&nbsp;<span class="op" id="5492019">&lt;=</span>&nbsp;<span class="ident" id="5492022">sp</span><span class="op" id="5492024">.</span><span class="ident" id="5492025">Y</span>&nbsp;<span class="op" id="5492027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5492031">ddelta</span>&nbsp;<span class="op" id="5492038">=</span>&nbsp;<span class="ident" id="5492040">dst</span><span class="op" id="5492043">.</span><span class="ident" id="5492044">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5492053">sdelta</span>&nbsp;<span class="op" id="5492060">=</span>&nbsp;<span class="ident" id="5492062">src</span><span class="op" id="5492065">.</span><span class="ident" id="5492066">Stride</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5492074">}</span>&nbsp;<span class="keyword" id="5492076">else</span>&nbsp;<span class="op" id="5492081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5492085">//&nbsp;If&nbsp;the&nbsp;source&nbsp;start&nbsp;point&nbsp;is&nbsp;higher&nbsp;than&nbsp;the&nbsp;destination&nbsp;start&nbsp;point,&nbsp;then&nbsp;we&nbsp;compose&nbsp;the&nbsp;rows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5492185">//&nbsp;in&nbsp;bottom-up&nbsp;order&nbsp;instead&nbsp;of&nbsp;top-down.&nbsp;Unlike&nbsp;the&nbsp;drawCopyOver&nbsp;function,&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5492281">//&nbsp;check&nbsp;the&nbsp;x&nbsp;co-ordinates&nbsp;because&nbsp;the&nbsp;built-in&nbsp;copy&nbsp;function&nbsp;can&nbsp;handle&nbsp;overlapping&nbsp;slices.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5492377">d0</span>&nbsp;<span class="op" id="5492380">+=</span>&nbsp;<span class="op" id="5492383">(</span><span class="ident" id="5492384">dy</span>&nbsp;<span class="op" id="5492387">-</span>&nbsp;<span class="num" id="5492389">1</span><span class="op" id="5492390">)</span>&nbsp;<span class="op" id="5492392">*</span>&nbsp;<span class="ident" id="5492394">dst</span><span class="op" id="5492397">.</span><span class="ident" id="5492398">Stride</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5492407">s0</span>&nbsp;<span class="op" id="5492410">+=</span>&nbsp;<span class="op" id="5492413">(</span><span class="ident" id="5492414">dy</span>&nbsp;<span class="op" id="5492417">-</span>&nbsp;<span class="num" id="5492419">1</span><span class="op" id="5492420">)</span>&nbsp;<span class="op" id="5492422">*</span>&nbsp;<span class="ident" id="5492424">src</span><span class="op" id="5492427">.</span><span class="ident" id="5492428">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5492437">ddelta</span>&nbsp;<span class="op" id="5492444">=</span>&nbsp;<span class="op" id="5492446">-</span><span class="ident" id="5492447">dst</span><span class="op" id="5492450">.</span><span class="ident" id="5492451">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5492460">sdelta</span>&nbsp;<span class="op" id="5492467">=</span>&nbsp;<span class="op" id="5492469">-</span><span class="ident" id="5492470">src</span><span class="op" id="5492473">.</span><span class="ident" id="5492474">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5492482">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5492485">for</span>&nbsp;<span class="op" id="5492489">;</span>&nbsp;<span class="ident" id="5492491">dy</span>&nbsp;<span class="op" id="5492494">&gt;</span>&nbsp;<span class="num" id="5492496">0</span><span class="op" id="5492497">;</span>&nbsp;<span class="ident" id="5492499">dy</span><span class="op" id="5492501">--</span>&nbsp;<span class="op" id="5492504">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5492508">copy</span><span class="op" id="5492512">(</span><span class="ident" id="5492513">dst</span><span class="op" id="5492516">.</span><span class="ident" id="5492517">Pix</span><span class="op" id="5492520">[</span><span class="ident" id="5492521">d0</span><span class="op" id="5492523">:</span><span class="ident" id="5492524">d0</span><span class="op" id="5492526">+</span><span class="ident" id="5492527">n</span><span class="op" id="5492528">]</span><span class="op" id="5492529">,</span>&nbsp;<span class="ident" id="5492531">src</span><span class="op" id="5492534">.</span><span class="ident" id="5492535">Pix</span><span class="op" id="5492538">[</span><span class="ident" id="5492539">s0</span><span class="op" id="5492541">:</span><span class="ident" id="5492542">s0</span><span class="op" id="5492544">+</span><span class="ident" id="5492545">n</span><span class="op" id="5492546">]</span><span class="op" id="5492547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5492551">d0</span>&nbsp;<span class="op" id="5492554">+=</span>&nbsp;<span class="ident" id="5492557">ddelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5492566">s0</span>&nbsp;<span class="op" id="5492569">+=</span>&nbsp;<span class="ident" id="5492572">sdelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5492580">}</span><br>
<span class="lineno"></span><span class="op" id="5492582">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span><span class="keyword" id="5492585">func</span>&nbsp;<span class="ident" id="5492590">drawNRGBAOver</span><span class="op" id="5492603">(</span><span class="ident" id="5492604">dst</span>&nbsp;<span class="op" id="5492608">*</span><span class="ident" id="5492609">image</span><span class="op" id="5492614">.</span><span class="ident" id="5492615">RGBA</span><span class="op" id="5492619">,</span>&nbsp;<span class="ident" id="5492621">r</span>&nbsp;<span class="ident" id="5492623">image</span><span class="op" id="5492628">.</span><span class="ident" id="5492629">Rectangle</span><span class="op" id="5492638">,</span>&nbsp;<span class="ident" id="5492640">src</span>&nbsp;<span class="op" id="5492644">*</span><span class="ident" id="5492645">image</span><span class="op" id="5492650">.</span><span class="ident" id="5492651">NRGBA</span><span class="op" id="5492656">,</span>&nbsp;<span class="ident" id="5492658">sp</span>&nbsp;<span class="ident" id="5492661">image</span><span class="op" id="5492666">.</span><span class="ident" id="5492667">Point</span><span class="op" id="5492672">)</span>&nbsp;<span class="op" id="5492674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5492677">i0</span>&nbsp;<span class="op" id="5492680">:=</span>&nbsp;<span class="op" id="5492683">(</span><span class="ident" id="5492684">r</span><span class="op" id="5492685">.</span><span class="ident" id="5492686">Min</span><span class="op" id="5492689">.</span><span class="ident" id="5492690">X</span>&nbsp;<span class="op" id="5492692">-</span>&nbsp;<span class="ident" id="5492694">dst</span><span class="op" id="5492697">.</span><span class="ident" id="5492698">Rect</span><span class="op" id="5492702">.</span><span class="ident" id="5492703">Min</span><span class="op" id="5492706">.</span><span class="ident" id="5492707">X</span><span class="op" id="5492708">)</span>&nbsp;<span class="op" id="5492710">*</span>&nbsp;<span class="num" id="5492712">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5492715">i1</span>&nbsp;<span class="op" id="5492718">:=</span>&nbsp;<span class="op" id="5492721">(</span><span class="ident" id="5492722">r</span><span class="op" id="5492723">.</span><span class="ident" id="5492724">Max</span><span class="op" id="5492727">.</span><span class="ident" id="5492728">X</span>&nbsp;<span class="op" id="5492730">-</span>&nbsp;<span class="ident" id="5492732">dst</span><span class="op" id="5492735">.</span><span class="ident" id="5492736">Rect</span><span class="op" id="5492740">.</span><span class="ident" id="5492741">Min</span><span class="op" id="5492744">.</span><span class="ident" id="5492745">X</span><span class="op" id="5492746">)</span>&nbsp;<span class="op" id="5492748">*</span>&nbsp;<span class="num" id="5492750">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5492753">si0</span>&nbsp;<span class="op" id="5492757">:=</span>&nbsp;<span class="op" id="5492760">(</span><span class="ident" id="5492761">sp</span><span class="op" id="5492763">.</span><span class="ident" id="5492764">X</span>&nbsp;<span class="op" id="5492766">-</span>&nbsp;<span class="ident" id="5492768">src</span><span class="op" id="5492771">.</span><span class="ident" id="5492772">Rect</span><span class="op" id="5492776">.</span><span class="ident" id="5492777">Min</span><span class="op" id="5492780">.</span><span class="ident" id="5492781">X</span><span class="op" id="5492782">)</span>&nbsp;<span class="op" id="5492784">*</span>&nbsp;<span class="num" id="5492786">4</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5492789">yMax</span>&nbsp;<span class="op" id="5492794">:=</span>&nbsp;<span class="ident" id="5492797">r</span><span class="op" id="5492798">.</span><span class="ident" id="5492799">Max</span><span class="op" id="5492802">.</span><span class="ident" id="5492803">Y</span>&nbsp;<span class="op" id="5492805">-</span>&nbsp;<span class="ident" id="5492807">dst</span><span class="op" id="5492810">.</span><span class="ident" id="5492811">Rect</span><span class="op" id="5492815">.</span><span class="ident" id="5492816">Min</span><span class="op" id="5492819">.</span><span class="ident" id="5492820">Y</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5492824">y</span>&nbsp;<span class="op" id="5492826">:=</span>&nbsp;<span class="ident" id="5492829">r</span><span class="op" id="5492830">.</span><span class="ident" id="5492831">Min</span><span class="op" id="5492834">.</span><span class="ident" id="5492835">Y</span>&nbsp;<span class="op" id="5492837">-</span>&nbsp;<span class="ident" id="5492839">dst</span><span class="op" id="5492842">.</span><span class="ident" id="5492843">Rect</span><span class="op" id="5492847">.</span><span class="ident" id="5492848">Min</span><span class="op" id="5492851">.</span><span class="ident" id="5492852">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5492855">sy</span>&nbsp;<span class="op" id="5492858">:=</span>&nbsp;<span class="ident" id="5492861">sp</span><span class="op" id="5492863">.</span><span class="ident" id="5492864">Y</span>&nbsp;<span class="op" id="5492866">-</span>&nbsp;<span class="ident" id="5492868">src</span><span class="op" id="5492871">.</span><span class="ident" id="5492872">Rect</span><span class="op" id="5492876">.</span><span class="ident" id="5492877">Min</span><span class="op" id="5492880">.</span><span class="ident" id="5492881">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5492884">for</span>&nbsp;<span class="op" id="5492888">;</span>&nbsp;<span class="ident" id="5492890">y</span>&nbsp;<span class="op" id="5492892">!=</span>&nbsp;<span class="ident" id="5492895">yMax</span><span class="op" id="5492899">;</span>&nbsp;<span class="ident" id="5492901">y</span><span class="op" id="5492902">,</span>&nbsp;<span class="ident" id="5492904">sy</span>&nbsp;<span class="op" id="5492907">=</span>&nbsp;<span class="ident" id="5492909">y</span><span class="op" id="5492910">+</span><span class="num" id="5492911">1</span><span class="op" id="5492912">,</span>&nbsp;<span class="ident" id="5492914">sy</span><span class="op" id="5492916">+</span><span class="num" id="5492917">1</span>&nbsp;<span class="op" id="5492919">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5492923">dpix</span>&nbsp;<span class="op" id="5492928">:=</span>&nbsp;<span class="ident" id="5492931">dst</span><span class="op" id="5492934">.</span><span class="ident" id="5492935">Pix</span><span class="op" id="5492938">[</span><span class="ident" id="5492939">y</span><span class="op" id="5492940">*</span><span class="ident" id="5492941">dst</span><span class="op" id="5492944">.</span><span class="ident" id="5492945">Stride</span><span class="op" id="5492951">:</span><span class="op" id="5492952">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5492956">spix</span>&nbsp;<span class="op" id="5492961">:=</span>&nbsp;<span class="ident" id="5492964">src</span><span class="op" id="5492967">.</span><span class="ident" id="5492968">Pix</span><span class="op" id="5492971">[</span><span class="ident" id="5492972">sy</span><span class="op" id="5492974">*</span><span class="ident" id="5492975">src</span><span class="op" id="5492978">.</span><span class="ident" id="5492979">Stride</span><span class="op" id="5492985">:</span><span class="op" id="5492986">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5492991">for</span>&nbsp;<span class="ident" id="5492995">i</span><span class="op" id="5492996">,</span>&nbsp;<span class="ident" id="5492998">si</span>&nbsp;<span class="op" id="5493001">:=</span>&nbsp;<span class="ident" id="5493004">i0</span><span class="op" id="5493006">,</span>&nbsp;<span class="ident" id="5493008">si0</span><span class="op" id="5493011">;</span>&nbsp;<span class="ident" id="5493013">i</span>&nbsp;<span class="op" id="5493015">&lt;</span>&nbsp;<span class="ident" id="5493017">i1</span><span class="op" id="5493019">;</span>&nbsp;<span class="ident" id="5493021">i</span><span class="op" id="5493022">,</span>&nbsp;<span class="ident" id="5493024">si</span>&nbsp;<span class="op" id="5493027">=</span>&nbsp;<span class="ident" id="5493029">i</span><span class="op" id="5493030">+</span><span class="num" id="5493031">4</span><span class="op" id="5493032">,</span>&nbsp;<span class="ident" id="5493034">si</span><span class="op" id="5493036">+</span><span class="num" id="5493037">4</span>&nbsp;<span class="op" id="5493039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5493044">//&nbsp;Convert&nbsp;from&nbsp;non-premultiplied&nbsp;color&nbsp;to&nbsp;pre-multiplied&nbsp;color.</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493112">sa</span>&nbsp;<span class="op" id="5493115">:=</span>&nbsp;<span class="builtintype" id="5493118">uint32</span><span class="op" id="5493124">(</span><span class="ident" id="5493125">spix</span><span class="op" id="5493129">[</span><span class="ident" id="5493130">si</span><span class="op" id="5493132">+</span><span class="num" id="5493133">3</span><span class="op" id="5493134">]</span><span class="op" id="5493135">)</span>&nbsp;<span class="op" id="5493137">*</span>&nbsp;<span class="num" id="5493139">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493148">sr</span>&nbsp;<span class="op" id="5493151">:=</span>&nbsp;<span class="builtintype" id="5493154">uint32</span><span class="op" id="5493160">(</span><span class="ident" id="5493161">spix</span><span class="op" id="5493165">[</span><span class="ident" id="5493166">si</span><span class="op" id="5493168">+</span><span class="num" id="5493169">0</span><span class="op" id="5493170">]</span><span class="op" id="5493171">)</span>&nbsp;<span class="op" id="5493173">*</span>&nbsp;<span class="ident" id="5493175">sa</span>&nbsp;<span class="op" id="5493178">/</span>&nbsp;<span class="num" id="5493180">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493188">sg</span>&nbsp;<span class="op" id="5493191">:=</span>&nbsp;<span class="builtintype" id="5493194">uint32</span><span class="op" id="5493200">(</span><span class="ident" id="5493201">spix</span><span class="op" id="5493205">[</span><span class="ident" id="5493206">si</span><span class="op" id="5493208">+</span><span class="num" id="5493209">1</span><span class="op" id="5493210">]</span><span class="op" id="5493211">)</span>&nbsp;<span class="op" id="5493213">*</span>&nbsp;<span class="ident" id="5493215">sa</span>&nbsp;<span class="op" id="5493218">/</span>&nbsp;<span class="num" id="5493220">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493228">sb</span>&nbsp;<span class="op" id="5493231">:=</span>&nbsp;<span class="builtintype" id="5493234">uint32</span><span class="op" id="5493240">(</span><span class="ident" id="5493241">spix</span><span class="op" id="5493245">[</span><span class="ident" id="5493246">si</span><span class="op" id="5493248">+</span><span class="num" id="5493249">2</span><span class="op" id="5493250">]</span><span class="op" id="5493251">)</span>&nbsp;<span class="op" id="5493253">*</span>&nbsp;<span class="ident" id="5493255">sa</span>&nbsp;<span class="op" id="5493258">/</span>&nbsp;<span class="num" id="5493260">0xff</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493269">dr</span>&nbsp;<span class="op" id="5493272">:=</span>&nbsp;<span class="builtintype" id="5493275">uint32</span><span class="op" id="5493281">(</span><span class="ident" id="5493282">dpix</span><span class="op" id="5493286">[</span><span class="ident" id="5493287">i</span><span class="op" id="5493288">+</span><span class="num" id="5493289">0</span><span class="op" id="5493290">]</span><span class="op" id="5493291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493296">dg</span>&nbsp;<span class="op" id="5493299">:=</span>&nbsp;<span class="builtintype" id="5493302">uint32</span><span class="op" id="5493308">(</span><span class="ident" id="5493309">dpix</span><span class="op" id="5493313">[</span><span class="ident" id="5493314">i</span><span class="op" id="5493315">+</span><span class="num" id="5493316">1</span><span class="op" id="5493317">]</span><span class="op" id="5493318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493323">db</span>&nbsp;<span class="op" id="5493326">:=</span>&nbsp;<span class="builtintype" id="5493329">uint32</span><span class="op" id="5493335">(</span><span class="ident" id="5493336">dpix</span><span class="op" id="5493340">[</span><span class="ident" id="5493341">i</span><span class="op" id="5493342">+</span><span class="num" id="5493343">2</span><span class="op" id="5493344">]</span><span class="op" id="5493345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493350">da</span>&nbsp;<span class="op" id="5493353">:=</span>&nbsp;<span class="builtintype" id="5493356">uint32</span><span class="op" id="5493362">(</span><span class="ident" id="5493363">dpix</span><span class="op" id="5493367">[</span><span class="ident" id="5493368">i</span><span class="op" id="5493369">+</span><span class="num" id="5493370">3</span><span class="op" id="5493371">]</span><span class="op" id="5493372">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5493378">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493438">a</span>&nbsp;<span class="op" id="5493440">:=</span>&nbsp;<span class="op" id="5493443">(</span><span class="ident" id="5493444">m</span>&nbsp;<span class="op" id="5493446">-</span>&nbsp;<span class="ident" id="5493448">sa</span><span class="op" id="5493450">)</span>&nbsp;<span class="op" id="5493452">*</span>&nbsp;<span class="num" id="5493454">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493464">dpix</span><span class="op" id="5493468">[</span><span class="ident" id="5493469">i</span><span class="op" id="5493470">+</span><span class="num" id="5493471">0</span><span class="op" id="5493472">]</span>&nbsp;<span class="op" id="5493474">=</span>&nbsp;<span class="builtintype" id="5493476">uint8</span><span class="op" id="5493481">(</span><span class="op" id="5493482">(</span><span class="ident" id="5493483">dr</span><span class="op" id="5493485">*</span><span class="ident" id="5493486">a</span><span class="op" id="5493487">/</span><span class="ident" id="5493488">m</span>&nbsp;<span class="op" id="5493490">+</span>&nbsp;<span class="ident" id="5493492">sr</span><span class="op" id="5493494">)</span>&nbsp;<span class="op" id="5493496">&gt;&gt;</span>&nbsp;<span class="num" id="5493499">8</span><span class="op" id="5493500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493505">dpix</span><span class="op" id="5493509">[</span><span class="ident" id="5493510">i</span><span class="op" id="5493511">+</span><span class="num" id="5493512">1</span><span class="op" id="5493513">]</span>&nbsp;<span class="op" id="5493515">=</span>&nbsp;<span class="builtintype" id="5493517">uint8</span><span class="op" id="5493522">(</span><span class="op" id="5493523">(</span><span class="ident" id="5493524">dg</span><span class="op" id="5493526">*</span><span class="ident" id="5493527">a</span><span class="op" id="5493528">/</span><span class="ident" id="5493529">m</span>&nbsp;<span class="op" id="5493531">+</span>&nbsp;<span class="ident" id="5493533">sg</span><span class="op" id="5493535">)</span>&nbsp;<span class="op" id="5493537">&gt;&gt;</span>&nbsp;<span class="num" id="5493540">8</span><span class="op" id="5493541">)</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493546">dpix</span><span class="op" id="5493550">[</span><span class="ident" id="5493551">i</span><span class="op" id="5493552">+</span><span class="num" id="5493553">2</span><span class="op" id="5493554">]</span>&nbsp;<span class="op" id="5493556">=</span>&nbsp;<span class="builtintype" id="5493558">uint8</span><span class="op" id="5493563">(</span><span class="op" id="5493564">(</span><span class="ident" id="5493565">db</span><span class="op" id="5493567">*</span><span class="ident" id="5493568">a</span><span class="op" id="5493569">/</span><span class="ident" id="5493570">m</span>&nbsp;<span class="op" id="5493572">+</span>&nbsp;<span class="ident" id="5493574">sb</span><span class="op" id="5493576">)</span>&nbsp;<span class="op" id="5493578">&gt;&gt;</span>&nbsp;<span class="num" id="5493581">8</span><span class="op" id="5493582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493587">dpix</span><span class="op" id="5493591">[</span><span class="ident" id="5493592">i</span><span class="op" id="5493593">+</span><span class="num" id="5493594">3</span><span class="op" id="5493595">]</span>&nbsp;<span class="op" id="5493597">=</span>&nbsp;<span class="builtintype" id="5493599">uint8</span><span class="op" id="5493604">(</span><span class="op" id="5493605">(</span><span class="ident" id="5493606">da</span><span class="op" id="5493608">*</span><span class="ident" id="5493609">a</span><span class="op" id="5493610">/</span><span class="ident" id="5493611">m</span>&nbsp;<span class="op" id="5493613">+</span>&nbsp;<span class="ident" id="5493615">sa</span><span class="op" id="5493617">)</span>&nbsp;<span class="op" id="5493619">&gt;&gt;</span>&nbsp;<span class="num" id="5493622">8</span><span class="op" id="5493623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5493627">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5493630">}</span><br>
<span class="lineno"></span><span class="op" id="5493632">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span><span class="keyword" id="5493635">func</span>&nbsp;<span class="ident" id="5493640">drawNRGBASrc</span><span class="op" id="5493652">(</span><span class="ident" id="5493653">dst</span>&nbsp;<span class="op" id="5493657">*</span><span class="ident" id="5493658">image</span><span class="op" id="5493663">.</span><span class="ident" id="5493664">RGBA</span><span class="op" id="5493668">,</span>&nbsp;<span class="ident" id="5493670">r</span>&nbsp;<span class="ident" id="5493672">image</span><span class="op" id="5493677">.</span><span class="ident" id="5493678">Rectangle</span><span class="op" id="5493687">,</span>&nbsp;<span class="ident" id="5493689">src</span>&nbsp;<span class="op" id="5493693">*</span><span class="ident" id="5493694">image</span><span class="op" id="5493699">.</span><span class="ident" id="5493700">NRGBA</span><span class="op" id="5493705">,</span>&nbsp;<span class="ident" id="5493707">sp</span>&nbsp;<span class="ident" id="5493710">image</span><span class="op" id="5493715">.</span><span class="ident" id="5493716">Point</span><span class="op" id="5493721">)</span>&nbsp;<span class="op" id="5493723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493726">i0</span>&nbsp;<span class="op" id="5493729">:=</span>&nbsp;<span class="op" id="5493732">(</span><span class="ident" id="5493733">r</span><span class="op" id="5493734">.</span><span class="ident" id="5493735">Min</span><span class="op" id="5493738">.</span><span class="ident" id="5493739">X</span>&nbsp;<span class="op" id="5493741">-</span>&nbsp;<span class="ident" id="5493743">dst</span><span class="op" id="5493746">.</span><span class="ident" id="5493747">Rect</span><span class="op" id="5493751">.</span><span class="ident" id="5493752">Min</span><span class="op" id="5493755">.</span><span class="ident" id="5493756">X</span><span class="op" id="5493757">)</span>&nbsp;<span class="op" id="5493759">*</span>&nbsp;<span class="num" id="5493761">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493764">i1</span>&nbsp;<span class="op" id="5493767">:=</span>&nbsp;<span class="op" id="5493770">(</span><span class="ident" id="5493771">r</span><span class="op" id="5493772">.</span><span class="ident" id="5493773">Max</span><span class="op" id="5493776">.</span><span class="ident" id="5493777">X</span>&nbsp;<span class="op" id="5493779">-</span>&nbsp;<span class="ident" id="5493781">dst</span><span class="op" id="5493784">.</span><span class="ident" id="5493785">Rect</span><span class="op" id="5493789">.</span><span class="ident" id="5493790">Min</span><span class="op" id="5493793">.</span><span class="ident" id="5493794">X</span><span class="op" id="5493795">)</span>&nbsp;<span class="op" id="5493797">*</span>&nbsp;<span class="num" id="5493799">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493802">si0</span>&nbsp;<span class="op" id="5493806">:=</span>&nbsp;<span class="op" id="5493809">(</span><span class="ident" id="5493810">sp</span><span class="op" id="5493812">.</span><span class="ident" id="5493813">X</span>&nbsp;<span class="op" id="5493815">-</span>&nbsp;<span class="ident" id="5493817">src</span><span class="op" id="5493820">.</span><span class="ident" id="5493821">Rect</span><span class="op" id="5493825">.</span><span class="ident" id="5493826">Min</span><span class="op" id="5493829">.</span><span class="ident" id="5493830">X</span><span class="op" id="5493831">)</span>&nbsp;<span class="op" id="5493833">*</span>&nbsp;<span class="num" id="5493835">4</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493838">yMax</span>&nbsp;<span class="op" id="5493843">:=</span>&nbsp;<span class="ident" id="5493846">r</span><span class="op" id="5493847">.</span><span class="ident" id="5493848">Max</span><span class="op" id="5493851">.</span><span class="ident" id="5493852">Y</span>&nbsp;<span class="op" id="5493854">-</span>&nbsp;<span class="ident" id="5493856">dst</span><span class="op" id="5493859">.</span><span class="ident" id="5493860">Rect</span><span class="op" id="5493864">.</span><span class="ident" id="5493865">Min</span><span class="op" id="5493868">.</span><span class="ident" id="5493869">Y</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493873">y</span>&nbsp;<span class="op" id="5493875">:=</span>&nbsp;<span class="ident" id="5493878">r</span><span class="op" id="5493879">.</span><span class="ident" id="5493880">Min</span><span class="op" id="5493883">.</span><span class="ident" id="5493884">Y</span>&nbsp;<span class="op" id="5493886">-</span>&nbsp;<span class="ident" id="5493888">dst</span><span class="op" id="5493891">.</span><span class="ident" id="5493892">Rect</span><span class="op" id="5493896">.</span><span class="ident" id="5493897">Min</span><span class="op" id="5493900">.</span><span class="ident" id="5493901">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493904">sy</span>&nbsp;<span class="op" id="5493907">:=</span>&nbsp;<span class="ident" id="5493910">sp</span><span class="op" id="5493912">.</span><span class="ident" id="5493913">Y</span>&nbsp;<span class="op" id="5493915">-</span>&nbsp;<span class="ident" id="5493917">src</span><span class="op" id="5493920">.</span><span class="ident" id="5493921">Rect</span><span class="op" id="5493925">.</span><span class="ident" id="5493926">Min</span><span class="op" id="5493929">.</span><span class="ident" id="5493930">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5493933">for</span>&nbsp;<span class="op" id="5493937">;</span>&nbsp;<span class="ident" id="5493939">y</span>&nbsp;<span class="op" id="5493941">!=</span>&nbsp;<span class="ident" id="5493944">yMax</span><span class="op" id="5493948">;</span>&nbsp;<span class="ident" id="5493950">y</span><span class="op" id="5493951">,</span>&nbsp;<span class="ident" id="5493953">sy</span>&nbsp;<span class="op" id="5493956">=</span>&nbsp;<span class="ident" id="5493958">y</span><span class="op" id="5493959">+</span><span class="num" id="5493960">1</span><span class="op" id="5493961">,</span>&nbsp;<span class="ident" id="5493963">sy</span><span class="op" id="5493965">+</span><span class="num" id="5493966">1</span>&nbsp;<span class="op" id="5493968">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493972">dpix</span>&nbsp;<span class="op" id="5493977">:=</span>&nbsp;<span class="ident" id="5493980">dst</span><span class="op" id="5493983">.</span><span class="ident" id="5493984">Pix</span><span class="op" id="5493987">[</span><span class="ident" id="5493988">y</span><span class="op" id="5493989">*</span><span class="ident" id="5493990">dst</span><span class="op" id="5493993">.</span><span class="ident" id="5493994">Stride</span><span class="op" id="5494000">:</span><span class="op" id="5494001">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5494005">spix</span>&nbsp;<span class="op" id="5494010">:=</span>&nbsp;<span class="ident" id="5494013">src</span><span class="op" id="5494016">.</span><span class="ident" id="5494017">Pix</span><span class="op" id="5494020">[</span><span class="ident" id="5494021">sy</span><span class="op" id="5494023">*</span><span class="ident" id="5494024">src</span><span class="op" id="5494027">.</span><span class="ident" id="5494028">Stride</span><span class="op" id="5494034">:</span><span class="op" id="5494035">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5494040">for</span>&nbsp;<span class="ident" id="5494044">i</span><span class="op" id="5494045">,</span>&nbsp;<span class="ident" id="5494047">si</span>&nbsp;<span class="op" id="5494050">:=</span>&nbsp;<span class="ident" id="5494053">i0</span><span class="op" id="5494055">,</span>&nbsp;<span class="ident" id="5494057">si0</span><span class="op" id="5494060">;</span>&nbsp;<span class="ident" id="5494062">i</span>&nbsp;<span class="op" id="5494064">&lt;</span>&nbsp;<span class="ident" id="5494066">i1</span><span class="op" id="5494068">;</span>&nbsp;<span class="ident" id="5494070">i</span><span class="op" id="5494071">,</span>&nbsp;<span class="ident" id="5494073">si</span>&nbsp;<span class="op" id="5494076">=</span>&nbsp;<span class="ident" id="5494078">i</span><span class="op" id="5494079">+</span><span class="num" id="5494080">4</span><span class="op" id="5494081">,</span>&nbsp;<span class="ident" id="5494083">si</span><span class="op" id="5494085">+</span><span class="num" id="5494086">4</span>&nbsp;<span class="op" id="5494088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5494093">//&nbsp;Convert&nbsp;from&nbsp;non-premultiplied&nbsp;color&nbsp;to&nbsp;pre-multiplied&nbsp;color.</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5494161">sa</span>&nbsp;<span class="op" id="5494164">:=</span>&nbsp;<span class="builtintype" id="5494167">uint32</span><span class="op" id="5494173">(</span><span class="ident" id="5494174">spix</span><span class="op" id="5494178">[</span><span class="ident" id="5494179">si</span><span class="op" id="5494181">+</span><span class="num" id="5494182">3</span><span class="op" id="5494183">]</span><span class="op" id="5494184">)</span>&nbsp;<span class="op" id="5494186">*</span>&nbsp;<span class="num" id="5494188">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5494197">sr</span>&nbsp;<span class="op" id="5494200">:=</span>&nbsp;<span class="builtintype" id="5494203">uint32</span><span class="op" id="5494209">(</span><span class="ident" id="5494210">spix</span><span class="op" id="5494214">[</span><span class="ident" id="5494215">si</span><span class="op" id="5494217">+</span><span class="num" id="5494218">0</span><span class="op" id="5494219">]</span><span class="op" id="5494220">)</span>&nbsp;<span class="op" id="5494222">*</span>&nbsp;<span class="ident" id="5494224">sa</span>&nbsp;<span class="op" id="5494227">/</span>&nbsp;<span class="num" id="5494229">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5494237">sg</span>&nbsp;<span class="op" id="5494240">:=</span>&nbsp;<span class="builtintype" id="5494243">uint32</span><span class="op" id="5494249">(</span><span class="ident" id="5494250">spix</span><span class="op" id="5494254">[</span><span class="ident" id="5494255">si</span><span class="op" id="5494257">+</span><span class="num" id="5494258">1</span><span class="op" id="5494259">]</span><span class="op" id="5494260">)</span>&nbsp;<span class="op" id="5494262">*</span>&nbsp;<span class="ident" id="5494264">sa</span>&nbsp;<span class="op" id="5494267">/</span>&nbsp;<span class="num" id="5494269">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5494277">sb</span>&nbsp;<span class="op" id="5494280">:=</span>&nbsp;<span class="builtintype" id="5494283">uint32</span><span class="op" id="5494289">(</span><span class="ident" id="5494290">spix</span><span class="op" id="5494294">[</span><span class="ident" id="5494295">si</span><span class="op" id="5494297">+</span><span class="num" id="5494298">2</span><span class="op" id="5494299">]</span><span class="op" id="5494300">)</span>&nbsp;<span class="op" id="5494302">*</span>&nbsp;<span class="ident" id="5494304">sa</span>&nbsp;<span class="op" id="5494307">/</span>&nbsp;<span class="num" id="5494309">0xff</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5494318">dpix</span><span class="op" id="5494322">[</span><span class="ident" id="5494323">i</span><span class="op" id="5494324">+</span><span class="num" id="5494325">0</span><span class="op" id="5494326">]</span>&nbsp;<span class="op" id="5494328">=</span>&nbsp;<span class="builtintype" id="5494330">uint8</span><span class="op" id="5494335">(</span><span class="ident" id="5494336">sr</span>&nbsp;<span class="op" id="5494339">&gt;&gt;</span>&nbsp;<span class="num" id="5494342">8</span><span class="op" id="5494343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5494348">dpix</span><span class="op" id="5494352">[</span><span class="ident" id="5494353">i</span><span class="op" id="5494354">+</span><span class="num" id="5494355">1</span><span class="op" id="5494356">]</span>&nbsp;<span class="op" id="5494358">=</span>&nbsp;<span class="builtintype" id="5494360">uint8</span><span class="op" id="5494365">(</span><span class="ident" id="5494366">sg</span>&nbsp;<span class="op" id="5494369">&gt;&gt;</span>&nbsp;<span class="num" id="5494372">8</span><span class="op" id="5494373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5494378">dpix</span><span class="op" id="5494382">[</span><span class="ident" id="5494383">i</span><span class="op" id="5494384">+</span><span class="num" id="5494385">2</span><span class="op" id="5494386">]</span>&nbsp;<span class="op" id="5494388">=</span>&nbsp;<span class="builtintype" id="5494390">uint8</span><span class="op" id="5494395">(</span><span class="ident" id="5494396">sb</span>&nbsp;<span class="op" id="5494399">&gt;&gt;</span>&nbsp;<span class="num" id="5494402">8</span><span class="op" id="5494403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5494408">dpix</span><span class="op" id="5494412">[</span><span class="ident" id="5494413">i</span><span class="op" id="5494414">+</span><span class="num" id="5494415">3</span><span class="op" id="5494416">]</span>&nbsp;<span class="op" id="5494418">=</span>&nbsp;<span class="builtintype" id="5494420">uint8</span><span class="op" id="5494425">(</span><span class="ident" id="5494426">sa</span>&nbsp;<span class="op" id="5494429">&gt;&gt;</span>&nbsp;<span class="num" id="5494432">8</span><span class="op" id="5494433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5494437">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5494440">}</span><br>
<span class="lineno"></span><span class="op" id="5494442">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5494445">func</span>&nbsp;<span class="ident" id="5494450">drawYCbCr</span><span class="op" id="5494459">(</span><span class="ident" id="5494460">dst</span>&nbsp;<span class="op" id="5494464">*</span><span class="ident" id="5494465">image</span><span class="op" id="5494470">.</span><span class="ident" id="5494471">RGBA</span><span class="op" id="5494475">,</span>&nbsp;<span class="ident" id="5494477">r</span>&nbsp;<span class="ident" id="5494479">image</span><span class="op" id="5494484">.</span><span class="ident" id="5494485">Rectangle</span><span class="op" id="5494494">,</span>&nbsp;<span class="ident" id="5494496">src</span>&nbsp;<span class="op" id="5494500">*</span><span class="ident" id="5494501">image</span><span class="op" id="5494506">.</span><span class="ident" id="5494507">YCbCr</span><span class="op" id="5494512">,</span>&nbsp;<span class="ident" id="5494514">sp</span>&nbsp;<span class="ident" id="5494517">image</span><span class="op" id="5494522">.</span><span class="ident" id="5494523">Point</span><span class="op" id="5494528">)</span>&nbsp;<span class="op" id="5494530">(</span><span class="ident" id="5494531">ok</span>&nbsp;<span class="builtintype" id="5494534">bool</span><span class="op" id="5494538">)</span>&nbsp;<span class="op" id="5494540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5494543">//&nbsp;An&nbsp;image.YCbCr&nbsp;is&nbsp;always&nbsp;fully&nbsp;opaque,&nbsp;and&nbsp;so&nbsp;if&nbsp;the&nbsp;mask&nbsp;is&nbsp;implicitly&nbsp;nil</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5494623">//&nbsp;(i.e.&nbsp;fully&nbsp;opaque)&nbsp;then&nbsp;the&nbsp;op&nbsp;is&nbsp;effectively&nbsp;always&nbsp;Src.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5494686">x0</span>&nbsp;<span class="op" id="5494689">:=</span>&nbsp;<span class="op" id="5494692">(</span><span class="ident" id="5494693">r</span><span class="op" id="5494694">.</span><span class="ident" id="5494695">Min</span><span class="op" id="5494698">.</span><span class="ident" id="5494699">X</span>&nbsp;<span class="op" id="5494701">-</span>&nbsp;<span class="ident" id="5494703">dst</span><span class="op" id="5494706">.</span><span class="ident" id="5494707">Rect</span><span class="op" id="5494711">.</span><span class="ident" id="5494712">Min</span><span class="op" id="5494715">.</span><span class="ident" id="5494716">X</span><span class="op" id="5494717">)</span>&nbsp;<span class="op" id="5494719">*</span>&nbsp;<span class="num" id="5494721">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5494724">x1</span>&nbsp;<span class="op" id="5494727">:=</span>&nbsp;<span class="op" id="5494730">(</span><span class="ident" id="5494731">r</span><span class="op" id="5494732">.</span><span class="ident" id="5494733">Max</span><span class="op" id="5494736">.</span><span class="ident" id="5494737">X</span>&nbsp;<span class="op" id="5494739">-</span>&nbsp;<span class="ident" id="5494741">dst</span><span class="op" id="5494744">.</span><span class="ident" id="5494745">Rect</span><span class="op" id="5494749">.</span><span class="ident" id="5494750">Min</span><span class="op" id="5494753">.</span><span class="ident" id="5494754">X</span><span class="op" id="5494755">)</span>&nbsp;<span class="op" id="5494757">*</span>&nbsp;<span class="num" id="5494759">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5494762">y0</span>&nbsp;<span class="op" id="5494765">:=</span>&nbsp;<span class="ident" id="5494768">r</span><span class="op" id="5494769">.</span><span class="ident" id="5494770">Min</span><span class="op" id="5494773">.</span><span class="ident" id="5494774">Y</span>&nbsp;<span class="op" id="5494776">-</span>&nbsp;<span class="ident" id="5494778">dst</span><span class="op" id="5494781">.</span><span class="ident" id="5494782">Rect</span><span class="op" id="5494786">.</span><span class="ident" id="5494787">Min</span><span class="op" id="5494790">.</span><span class="ident" id="5494791">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5494794">y1</span>&nbsp;<span class="op" id="5494797">:=</span>&nbsp;<span class="ident" id="5494800">r</span><span class="op" id="5494801">.</span><span class="ident" id="5494802">Max</span><span class="op" id="5494805">.</span><span class="ident" id="5494806">Y</span>&nbsp;<span class="op" id="5494808">-</span>&nbsp;<span class="ident" id="5494810">dst</span><span class="op" id="5494813">.</span><span class="ident" id="5494814">Rect</span><span class="op" id="5494818">.</span><span class="ident" id="5494819">Min</span><span class="op" id="5494822">.</span><span class="ident" id="5494823">Y</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5494826">switch</span>&nbsp;<span class="ident" id="5494833">src</span><span class="op" id="5494836">.</span><span class="ident" id="5494837">SubsampleRatio</span>&nbsp;<span class="op" id="5494852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5494855">case</span>&nbsp;<span class="ident" id="5494860">image</span><span class="op" id="5494865">.</span><span class="ident" id="5494866">YCbCrSubsampleRatio444</span><span class="op" id="5494888">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5494892">for</span>&nbsp;<span class="ident" id="5494896">y</span><span class="op" id="5494897">,</span>&nbsp;<span class="ident" id="5494899">sy</span>&nbsp;<span class="op" id="5494902">:=</span>&nbsp;<span class="ident" id="5494905">y0</span><span class="op" id="5494907">,</span>&nbsp;<span class="ident" id="5494909">sp</span><span class="op" id="5494911">.</span><span class="ident" id="5494912">Y</span><span class="op" id="5494913">;</span>&nbsp;<span class="ident" id="5494915">y</span>&nbsp;<span class="op" id="5494917">!=</span>&nbsp;<span class="ident" id="5494920">y1</span><span class="op" id="5494922">;</span>&nbsp;<span class="ident" id="5494924">y</span><span class="op" id="5494925">,</span>&nbsp;<span class="ident" id="5494927">sy</span>&nbsp;<span class="op" id="5494930">=</span>&nbsp;<span class="ident" id="5494932">y</span><span class="op" id="5494933">+</span><span class="num" id="5494934">1</span><span class="op" id="5494935">,</span>&nbsp;<span class="ident" id="5494937">sy</span><span class="op" id="5494939">+</span><span class="num" id="5494940">1</span>&nbsp;<span class="op" id="5494942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5494947">dpix</span>&nbsp;<span class="op" id="5494952">:=</span>&nbsp;<span class="ident" id="5494955">dst</span><span class="op" id="5494958">.</span><span class="ident" id="5494959">Pix</span><span class="op" id="5494962">[</span><span class="ident" id="5494963">y</span><span class="op" id="5494964">*</span><span class="ident" id="5494965">dst</span><span class="op" id="5494968">.</span><span class="ident" id="5494969">Stride</span><span class="op" id="5494975">:</span><span class="op" id="5494976">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5494981">yi</span>&nbsp;<span class="op" id="5494984">:=</span>&nbsp;<span class="op" id="5494987">(</span><span class="ident" id="5494988">sy</span><span class="op" id="5494990">-</span><span class="ident" id="5494991">src</span><span class="op" id="5494994">.</span><span class="ident" id="5494995">Rect</span><span class="op" id="5494999">.</span><span class="ident" id="5495000">Min</span><span class="op" id="5495003">.</span><span class="ident" id="5495004">Y</span><span class="op" id="5495005">)</span><span class="op" id="5495006">*</span><span class="ident" id="5495007">src</span><span class="op" id="5495010">.</span><span class="ident" id="5495011">YStride</span>&nbsp;<span class="op" id="5495019">+</span>&nbsp;<span class="op" id="5495021">(</span><span class="ident" id="5495022">sp</span><span class="op" id="5495024">.</span><span class="ident" id="5495025">X</span>&nbsp;<span class="op" id="5495027">-</span>&nbsp;<span class="ident" id="5495029">src</span><span class="op" id="5495032">.</span><span class="ident" id="5495033">Rect</span><span class="op" id="5495037">.</span><span class="ident" id="5495038">Min</span><span class="op" id="5495041">.</span><span class="ident" id="5495042">X</span><span class="op" id="5495043">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5495048">ci</span>&nbsp;<span class="op" id="5495051">:=</span>&nbsp;<span class="op" id="5495054">(</span><span class="ident" id="5495055">sy</span><span class="op" id="5495057">-</span><span class="ident" id="5495058">src</span><span class="op" id="5495061">.</span><span class="ident" id="5495062">Rect</span><span class="op" id="5495066">.</span><span class="ident" id="5495067">Min</span><span class="op" id="5495070">.</span><span class="ident" id="5495071">Y</span><span class="op" id="5495072">)</span><span class="op" id="5495073">*</span><span class="ident" id="5495074">src</span><span class="op" id="5495077">.</span><span class="ident" id="5495078">CStride</span>&nbsp;<span class="op" id="5495086">+</span>&nbsp;<span class="op" id="5495088">(</span><span class="ident" id="5495089">sp</span><span class="op" id="5495091">.</span><span class="ident" id="5495092">X</span>&nbsp;<span class="op" id="5495094">-</span>&nbsp;<span class="ident" id="5495096">src</span><span class="op" id="5495099">.</span><span class="ident" id="5495100">Rect</span><span class="op" id="5495104">.</span><span class="ident" id="5495105">Min</span><span class="op" id="5495108">.</span><span class="ident" id="5495109">X</span><span class="op" id="5495110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5495115">for</span>&nbsp;<span class="ident" id="5495119">x</span>&nbsp;<span class="op" id="5495121">:=</span>&nbsp;<span class="ident" id="5495124">x0</span><span class="op" id="5495126">;</span>&nbsp;<span class="ident" id="5495128">x</span>&nbsp;<span class="op" id="5495130">!=</span>&nbsp;<span class="ident" id="5495133">x1</span><span class="op" id="5495135">;</span>&nbsp;<span class="ident" id="5495137">x</span><span class="op" id="5495138">,</span>&nbsp;<span class="ident" id="5495140">yi</span><span class="op" id="5495142">,</span>&nbsp;<span class="ident" id="5495144">ci</span>&nbsp;<span class="op" id="5495147">=</span>&nbsp;<span class="ident" id="5495149">x</span><span class="op" id="5495150">+</span><span class="num" id="5495151">4</span><span class="op" id="5495152">,</span>&nbsp;<span class="ident" id="5495154">yi</span><span class="op" id="5495156">+</span><span class="num" id="5495157">1</span><span class="op" id="5495158">,</span>&nbsp;<span class="ident" id="5495160">ci</span><span class="op" id="5495162">+</span><span class="num" id="5495163">1</span>&nbsp;<span class="op" id="5495165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5495171">rr</span><span class="op" id="5495173">,</span>&nbsp;<span class="ident" id="5495175">gg</span><span class="op" id="5495177">,</span>&nbsp;<span class="ident" id="5495179">bb</span>&nbsp;<span class="op" id="5495182">:=</span>&nbsp;<span class="ident" id="5495185">color</span><span class="op" id="5495190">.</span><span class="ident" id="5495191">YCbCrToRGB</span><span class="op" id="5495201">(</span><span class="ident" id="5495202">src</span><span class="op" id="5495205">.</span><span class="ident" id="5495206">Y</span><span class="op" id="5495207">[</span><span class="ident" id="5495208">yi</span><span class="op" id="5495210">]</span><span class="op" id="5495211">,</span>&nbsp;<span class="ident" id="5495213">src</span><span class="op" id="5495216">.</span><span class="ident" id="5495217">Cb</span><span class="op" id="5495219">[</span><span class="ident" id="5495220">ci</span><span class="op" id="5495222">]</span><span class="op" id="5495223">,</span>&nbsp;<span class="ident" id="5495225">src</span><span class="op" id="5495228">.</span><span class="ident" id="5495229">Cr</span><span class="op" id="5495231">[</span><span class="ident" id="5495232">ci</span><span class="op" id="5495234">]</span><span class="op" id="5495235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5495241">dpix</span><span class="op" id="5495245">[</span><span class="ident" id="5495246">x</span><span class="op" id="5495247">+</span><span class="num" id="5495248">0</span><span class="op" id="5495249">]</span>&nbsp;<span class="op" id="5495251">=</span>&nbsp;<span class="ident" id="5495253">rr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5495260">dpix</span><span class="op" id="5495264">[</span><span class="ident" id="5495265">x</span><span class="op" id="5495266">+</span><span class="num" id="5495267">1</span><span class="op" id="5495268">]</span>&nbsp;<span class="op" id="5495270">=</span>&nbsp;<span class="ident" id="5495272">gg</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5495279">dpix</span><span class="op" id="5495283">[</span><span class="ident" id="5495284">x</span><span class="op" id="5495285">+</span><span class="num" id="5495286">2</span><span class="op" id="5495287">]</span>&nbsp;<span class="op" id="5495289">=</span>&nbsp;<span class="ident" id="5495291">bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5495298">dpix</span><span class="op" id="5495302">[</span><span class="ident" id="5495303">x</span><span class="op" id="5495304">+</span><span class="num" id="5495305">3</span><span class="op" id="5495306">]</span>&nbsp;<span class="op" id="5495308">=</span>&nbsp;<span class="num" id="5495310">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5495317">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5495321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5495324">case</span>&nbsp;<span class="ident" id="5495329">image</span><span class="op" id="5495334">.</span><span class="ident" id="5495335">YCbCrSubsampleRatio422</span><span class="op" id="5495357">:</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5495361">for</span>&nbsp;<span class="ident" id="5495365">y</span><span class="op" id="5495366">,</span>&nbsp;<span class="ident" id="5495368">sy</span>&nbsp;<span class="op" id="5495371">:=</span>&nbsp;<span class="ident" id="5495374">y0</span><span class="op" id="5495376">,</span>&nbsp;<span class="ident" id="5495378">sp</span><span class="op" id="5495380">.</span><span class="ident" id="5495381">Y</span><span class="op" id="5495382">;</span>&nbsp;<span class="ident" id="5495384">y</span>&nbsp;<span class="op" id="5495386">!=</span>&nbsp;<span class="ident" id="5495389">y1</span><span class="op" id="5495391">;</span>&nbsp;<span class="ident" id="5495393">y</span><span class="op" id="5495394">,</span>&nbsp;<span class="ident" id="5495396">sy</span>&nbsp;<span class="op" id="5495399">=</span>&nbsp;<span class="ident" id="5495401">y</span><span class="op" id="5495402">+</span><span class="num" id="5495403">1</span><span class="op" id="5495404">,</span>&nbsp;<span class="ident" id="5495406">sy</span><span class="op" id="5495408">+</span><span class="num" id="5495409">1</span>&nbsp;<span class="op" id="5495411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5495416">dpix</span>&nbsp;<span class="op" id="5495421">:=</span>&nbsp;<span class="ident" id="5495424">dst</span><span class="op" id="5495427">.</span><span class="ident" id="5495428">Pix</span><span class="op" id="5495431">[</span><span class="ident" id="5495432">y</span><span class="op" id="5495433">*</span><span class="ident" id="5495434">dst</span><span class="op" id="5495437">.</span><span class="ident" id="5495438">Stride</span><span class="op" id="5495444">:</span><span class="op" id="5495445">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5495450">yi</span>&nbsp;<span class="op" id="5495453">:=</span>&nbsp;<span class="op" id="5495456">(</span><span class="ident" id="5495457">sy</span><span class="op" id="5495459">-</span><span class="ident" id="5495460">src</span><span class="op" id="5495463">.</span><span class="ident" id="5495464">Rect</span><span class="op" id="5495468">.</span><span class="ident" id="5495469">Min</span><span class="op" id="5495472">.</span><span class="ident" id="5495473">Y</span><span class="op" id="5495474">)</span><span class="op" id="5495475">*</span><span class="ident" id="5495476">src</span><span class="op" id="5495479">.</span><span class="ident" id="5495480">YStride</span>&nbsp;<span class="op" id="5495488">+</span>&nbsp;<span class="op" id="5495490">(</span><span class="ident" id="5495491">sp</span><span class="op" id="5495493">.</span><span class="ident" id="5495494">X</span>&nbsp;<span class="op" id="5495496">-</span>&nbsp;<span class="ident" id="5495498">src</span><span class="op" id="5495501">.</span><span class="ident" id="5495502">Rect</span><span class="op" id="5495506">.</span><span class="ident" id="5495507">Min</span><span class="op" id="5495510">.</span><span class="ident" id="5495511">X</span><span class="op" id="5495512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5495517">ciBase</span>&nbsp;<span class="op" id="5495524">:=</span>&nbsp;<span class="op" id="5495527">(</span><span class="ident" id="5495528">sy</span><span class="op" id="5495530">-</span><span class="ident" id="5495531">src</span><span class="op" id="5495534">.</span><span class="ident" id="5495535">Rect</span><span class="op" id="5495539">.</span><span class="ident" id="5495540">Min</span><span class="op" id="5495543">.</span><span class="ident" id="5495544">Y</span><span class="op" id="5495545">)</span><span class="op" id="5495546">*</span><span class="ident" id="5495547">src</span><span class="op" id="5495550">.</span><span class="ident" id="5495551">CStride</span>&nbsp;<span class="op" id="5495559">-</span>&nbsp;<span class="ident" id="5495561">src</span><span class="op" id="5495564">.</span><span class="ident" id="5495565">Rect</span><span class="op" id="5495569">.</span><span class="ident" id="5495570">Min</span><span class="op" id="5495573">.</span><span class="ident" id="5495574">X</span><span class="op" id="5495575">/</span><span class="num" id="5495576">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5495581">for</span>&nbsp;<span class="ident" id="5495585">x</span><span class="op" id="5495586">,</span>&nbsp;<span class="ident" id="5495588">sx</span>&nbsp;<span class="op" id="5495591">:=</span>&nbsp;<span class="ident" id="5495594">x0</span><span class="op" id="5495596">,</span>&nbsp;<span class="ident" id="5495598">sp</span><span class="op" id="5495600">.</span><span class="ident" id="5495601">X</span><span class="op" id="5495602">;</span>&nbsp;<span class="ident" id="5495604">x</span>&nbsp;<span class="op" id="5495606">!=</span>&nbsp;<span class="ident" id="5495609">x1</span><span class="op" id="5495611">;</span>&nbsp;<span class="ident" id="5495613">x</span><span class="op" id="5495614">,</span>&nbsp;<span class="ident" id="5495616">sx</span><span class="op" id="5495618">,</span>&nbsp;<span class="ident" id="5495620">yi</span>&nbsp;<span class="op" id="5495623">=</span>&nbsp;<span class="ident" id="5495625">x</span><span class="op" id="5495626">+</span><span class="num" id="5495627">4</span><span class="op" id="5495628">,</span>&nbsp;<span class="ident" id="5495630">sx</span><span class="op" id="5495632">+</span><span class="num" id="5495633">1</span><span class="op" id="5495634">,</span>&nbsp;<span class="ident" id="5495636">yi</span><span class="op" id="5495638">+</span><span class="num" id="5495639">1</span>&nbsp;<span class="op" id="5495641">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5495647">ci</span>&nbsp;<span class="op" id="5495650">:=</span>&nbsp;<span class="ident" id="5495653">ciBase</span>&nbsp;<span class="op" id="5495660">+</span>&nbsp;<span class="ident" id="5495662">sx</span><span class="op" id="5495664">/</span><span class="num" id="5495665">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5495671">rr</span><span class="op" id="5495673">,</span>&nbsp;<span class="ident" id="5495675">gg</span><span class="op" id="5495677">,</span>&nbsp;<span class="ident" id="5495679">bb</span>&nbsp;<span class="op" id="5495682">:=</span>&nbsp;<span class="ident" id="5495685">color</span><span class="op" id="5495690">.</span><span class="ident" id="5495691">YCbCrToRGB</span><span class="op" id="5495701">(</span><span class="ident" id="5495702">src</span><span class="op" id="5495705">.</span><span class="ident" id="5495706">Y</span><span class="op" id="5495707">[</span><span class="ident" id="5495708">yi</span><span class="op" id="5495710">]</span><span class="op" id="5495711">,</span>&nbsp;<span class="ident" id="5495713">src</span><span class="op" id="5495716">.</span><span class="ident" id="5495717">Cb</span><span class="op" id="5495719">[</span><span class="ident" id="5495720">ci</span><span class="op" id="5495722">]</span><span class="op" id="5495723">,</span>&nbsp;<span class="ident" id="5495725">src</span><span class="op" id="5495728">.</span><span class="ident" id="5495729">Cr</span><span class="op" id="5495731">[</span><span class="ident" id="5495732">ci</span><span class="op" id="5495734">]</span><span class="op" id="5495735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5495741">dpix</span><span class="op" id="5495745">[</span><span class="ident" id="5495746">x</span><span class="op" id="5495747">+</span><span class="num" id="5495748">0</span><span class="op" id="5495749">]</span>&nbsp;<span class="op" id="5495751">=</span>&nbsp;<span class="ident" id="5495753">rr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5495760">dpix</span><span class="op" id="5495764">[</span><span class="ident" id="5495765">x</span><span class="op" id="5495766">+</span><span class="num" id="5495767">1</span><span class="op" id="5495768">]</span>&nbsp;<span class="op" id="5495770">=</span>&nbsp;<span class="ident" id="5495772">gg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5495779">dpix</span><span class="op" id="5495783">[</span><span class="ident" id="5495784">x</span><span class="op" id="5495785">+</span><span class="num" id="5495786">2</span><span class="op" id="5495787">]</span>&nbsp;<span class="op" id="5495789">=</span>&nbsp;<span class="ident" id="5495791">bb</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5495798">dpix</span><span class="op" id="5495802">[</span><span class="ident" id="5495803">x</span><span class="op" id="5495804">+</span><span class="num" id="5495805">3</span><span class="op" id="5495806">]</span>&nbsp;<span class="op" id="5495808">=</span>&nbsp;<span class="num" id="5495810">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5495817">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5495821">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5495824">case</span>&nbsp;<span class="ident" id="5495829">image</span><span class="op" id="5495834">.</span><span class="ident" id="5495835">YCbCrSubsampleRatio420</span><span class="op" id="5495857">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5495861">for</span>&nbsp;<span class="ident" id="5495865">y</span><span class="op" id="5495866">,</span>&nbsp;<span class="ident" id="5495868">sy</span>&nbsp;<span class="op" id="5495871">:=</span>&nbsp;<span class="ident" id="5495874">y0</span><span class="op" id="5495876">,</span>&nbsp;<span class="ident" id="5495878">sp</span><span class="op" id="5495880">.</span><span class="ident" id="5495881">Y</span><span class="op" id="5495882">;</span>&nbsp;<span class="ident" id="5495884">y</span>&nbsp;<span class="op" id="5495886">!=</span>&nbsp;<span class="ident" id="5495889">y1</span><span class="op" id="5495891">;</span>&nbsp;<span class="ident" id="5495893">y</span><span class="op" id="5495894">,</span>&nbsp;<span class="ident" id="5495896">sy</span>&nbsp;<span class="op" id="5495899">=</span>&nbsp;<span class="ident" id="5495901">y</span><span class="op" id="5495902">+</span><span class="num" id="5495903">1</span><span class="op" id="5495904">,</span>&nbsp;<span class="ident" id="5495906">sy</span><span class="op" id="5495908">+</span><span class="num" id="5495909">1</span>&nbsp;<span class="op" id="5495911">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5495916">dpix</span>&nbsp;<span class="op" id="5495921">:=</span>&nbsp;<span class="ident" id="5495924">dst</span><span class="op" id="5495927">.</span><span class="ident" id="5495928">Pix</span><span class="op" id="5495931">[</span><span class="ident" id="5495932">y</span><span class="op" id="5495933">*</span><span class="ident" id="5495934">dst</span><span class="op" id="5495937">.</span><span class="ident" id="5495938">Stride</span><span class="op" id="5495944">:</span><span class="op" id="5495945">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5495950">yi</span>&nbsp;<span class="op" id="5495953">:=</span>&nbsp;<span class="op" id="5495956">(</span><span class="ident" id="5495957">sy</span><span class="op" id="5495959">-</span><span class="ident" id="5495960">src</span><span class="op" id="5495963">.</span><span class="ident" id="5495964">Rect</span><span class="op" id="5495968">.</span><span class="ident" id="5495969">Min</span><span class="op" id="5495972">.</span><span class="ident" id="5495973">Y</span><span class="op" id="5495974">)</span><span class="op" id="5495975">*</span><span class="ident" id="5495976">src</span><span class="op" id="5495979">.</span><span class="ident" id="5495980">YStride</span>&nbsp;<span class="op" id="5495988">+</span>&nbsp;<span class="op" id="5495990">(</span><span class="ident" id="5495991">sp</span><span class="op" id="5495993">.</span><span class="ident" id="5495994">X</span>&nbsp;<span class="op" id="5495996">-</span>&nbsp;<span class="ident" id="5495998">src</span><span class="op" id="5496001">.</span><span class="ident" id="5496002">Rect</span><span class="op" id="5496006">.</span><span class="ident" id="5496007">Min</span><span class="op" id="5496010">.</span><span class="ident" id="5496011">X</span><span class="op" id="5496012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496017">ciBase</span>&nbsp;<span class="op" id="5496024">:=</span>&nbsp;<span class="op" id="5496027">(</span><span class="ident" id="5496028">sy</span><span class="op" id="5496030">/</span><span class="num" id="5496031">2</span><span class="op" id="5496032">-</span><span class="ident" id="5496033">src</span><span class="op" id="5496036">.</span><span class="ident" id="5496037">Rect</span><span class="op" id="5496041">.</span><span class="ident" id="5496042">Min</span><span class="op" id="5496045">.</span><span class="ident" id="5496046">Y</span><span class="op" id="5496047">/</span><span class="num" id="5496048">2</span><span class="op" id="5496049">)</span><span class="op" id="5496050">*</span><span class="ident" id="5496051">src</span><span class="op" id="5496054">.</span><span class="ident" id="5496055">CStride</span>&nbsp;<span class="op" id="5496063">-</span>&nbsp;<span class="ident" id="5496065">src</span><span class="op" id="5496068">.</span><span class="ident" id="5496069">Rect</span><span class="op" id="5496073">.</span><span class="ident" id="5496074">Min</span><span class="op" id="5496077">.</span><span class="ident" id="5496078">X</span><span class="op" id="5496079">/</span><span class="num" id="5496080">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5496085">for</span>&nbsp;<span class="ident" id="5496089">x</span><span class="op" id="5496090">,</span>&nbsp;<span class="ident" id="5496092">sx</span>&nbsp;<span class="op" id="5496095">:=</span>&nbsp;<span class="ident" id="5496098">x0</span><span class="op" id="5496100">,</span>&nbsp;<span class="ident" id="5496102">sp</span><span class="op" id="5496104">.</span><span class="ident" id="5496105">X</span><span class="op" id="5496106">;</span>&nbsp;<span class="ident" id="5496108">x</span>&nbsp;<span class="op" id="5496110">!=</span>&nbsp;<span class="ident" id="5496113">x1</span><span class="op" id="5496115">;</span>&nbsp;<span class="ident" id="5496117">x</span><span class="op" id="5496118">,</span>&nbsp;<span class="ident" id="5496120">sx</span><span class="op" id="5496122">,</span>&nbsp;<span class="ident" id="5496124">yi</span>&nbsp;<span class="op" id="5496127">=</span>&nbsp;<span class="ident" id="5496129">x</span><span class="op" id="5496130">+</span><span class="num" id="5496131">4</span><span class="op" id="5496132">,</span>&nbsp;<span class="ident" id="5496134">sx</span><span class="op" id="5496136">+</span><span class="num" id="5496137">1</span><span class="op" id="5496138">,</span>&nbsp;<span class="ident" id="5496140">yi</span><span class="op" id="5496142">+</span><span class="num" id="5496143">1</span>&nbsp;<span class="op" id="5496145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496151">ci</span>&nbsp;<span class="op" id="5496154">:=</span>&nbsp;<span class="ident" id="5496157">ciBase</span>&nbsp;<span class="op" id="5496164">+</span>&nbsp;<span class="ident" id="5496166">sx</span><span class="op" id="5496168">/</span><span class="num" id="5496169">2</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496175">rr</span><span class="op" id="5496177">,</span>&nbsp;<span class="ident" id="5496179">gg</span><span class="op" id="5496181">,</span>&nbsp;<span class="ident" id="5496183">bb</span>&nbsp;<span class="op" id="5496186">:=</span>&nbsp;<span class="ident" id="5496189">color</span><span class="op" id="5496194">.</span><span class="ident" id="5496195">YCbCrToRGB</span><span class="op" id="5496205">(</span><span class="ident" id="5496206">src</span><span class="op" id="5496209">.</span><span class="ident" id="5496210">Y</span><span class="op" id="5496211">[</span><span class="ident" id="5496212">yi</span><span class="op" id="5496214">]</span><span class="op" id="5496215">,</span>&nbsp;<span class="ident" id="5496217">src</span><span class="op" id="5496220">.</span><span class="ident" id="5496221">Cb</span><span class="op" id="5496223">[</span><span class="ident" id="5496224">ci</span><span class="op" id="5496226">]</span><span class="op" id="5496227">,</span>&nbsp;<span class="ident" id="5496229">src</span><span class="op" id="5496232">.</span><span class="ident" id="5496233">Cr</span><span class="op" id="5496235">[</span><span class="ident" id="5496236">ci</span><span class="op" id="5496238">]</span><span class="op" id="5496239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496245">dpix</span><span class="op" id="5496249">[</span><span class="ident" id="5496250">x</span><span class="op" id="5496251">+</span><span class="num" id="5496252">0</span><span class="op" id="5496253">]</span>&nbsp;<span class="op" id="5496255">=</span>&nbsp;<span class="ident" id="5496257">rr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496264">dpix</span><span class="op" id="5496268">[</span><span class="ident" id="5496269">x</span><span class="op" id="5496270">+</span><span class="num" id="5496271">1</span><span class="op" id="5496272">]</span>&nbsp;<span class="op" id="5496274">=</span>&nbsp;<span class="ident" id="5496276">gg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496283">dpix</span><span class="op" id="5496287">[</span><span class="ident" id="5496288">x</span><span class="op" id="5496289">+</span><span class="num" id="5496290">2</span><span class="op" id="5496291">]</span>&nbsp;<span class="op" id="5496293">=</span>&nbsp;<span class="ident" id="5496295">bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496302">dpix</span><span class="op" id="5496306">[</span><span class="ident" id="5496307">x</span><span class="op" id="5496308">+</span><span class="num" id="5496309">3</span><span class="op" id="5496310">]</span>&nbsp;<span class="op" id="5496312">=</span>&nbsp;<span class="num" id="5496314">255</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5496321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5496325">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5496328">case</span>&nbsp;<span class="ident" id="5496333">image</span><span class="op" id="5496338">.</span><span class="ident" id="5496339">YCbCrSubsampleRatio440</span><span class="op" id="5496361">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5496365">for</span>&nbsp;<span class="ident" id="5496369">y</span><span class="op" id="5496370">,</span>&nbsp;<span class="ident" id="5496372">sy</span>&nbsp;<span class="op" id="5496375">:=</span>&nbsp;<span class="ident" id="5496378">y0</span><span class="op" id="5496380">,</span>&nbsp;<span class="ident" id="5496382">sp</span><span class="op" id="5496384">.</span><span class="ident" id="5496385">Y</span><span class="op" id="5496386">;</span>&nbsp;<span class="ident" id="5496388">y</span>&nbsp;<span class="op" id="5496390">!=</span>&nbsp;<span class="ident" id="5496393">y1</span><span class="op" id="5496395">;</span>&nbsp;<span class="ident" id="5496397">y</span><span class="op" id="5496398">,</span>&nbsp;<span class="ident" id="5496400">sy</span>&nbsp;<span class="op" id="5496403">=</span>&nbsp;<span class="ident" id="5496405">y</span><span class="op" id="5496406">+</span><span class="num" id="5496407">1</span><span class="op" id="5496408">,</span>&nbsp;<span class="ident" id="5496410">sy</span><span class="op" id="5496412">+</span><span class="num" id="5496413">1</span>&nbsp;<span class="op" id="5496415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496420">dpix</span>&nbsp;<span class="op" id="5496425">:=</span>&nbsp;<span class="ident" id="5496428">dst</span><span class="op" id="5496431">.</span><span class="ident" id="5496432">Pix</span><span class="op" id="5496435">[</span><span class="ident" id="5496436">y</span><span class="op" id="5496437">*</span><span class="ident" id="5496438">dst</span><span class="op" id="5496441">.</span><span class="ident" id="5496442">Stride</span><span class="op" id="5496448">:</span><span class="op" id="5496449">]</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496454">yi</span>&nbsp;<span class="op" id="5496457">:=</span>&nbsp;<span class="op" id="5496460">(</span><span class="ident" id="5496461">sy</span><span class="op" id="5496463">-</span><span class="ident" id="5496464">src</span><span class="op" id="5496467">.</span><span class="ident" id="5496468">Rect</span><span class="op" id="5496472">.</span><span class="ident" id="5496473">Min</span><span class="op" id="5496476">.</span><span class="ident" id="5496477">Y</span><span class="op" id="5496478">)</span><span class="op" id="5496479">*</span><span class="ident" id="5496480">src</span><span class="op" id="5496483">.</span><span class="ident" id="5496484">YStride</span>&nbsp;<span class="op" id="5496492">+</span>&nbsp;<span class="op" id="5496494">(</span><span class="ident" id="5496495">sp</span><span class="op" id="5496497">.</span><span class="ident" id="5496498">X</span>&nbsp;<span class="op" id="5496500">-</span>&nbsp;<span class="ident" id="5496502">src</span><span class="op" id="5496505">.</span><span class="ident" id="5496506">Rect</span><span class="op" id="5496510">.</span><span class="ident" id="5496511">Min</span><span class="op" id="5496514">.</span><span class="ident" id="5496515">X</span><span class="op" id="5496516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496521">ci</span>&nbsp;<span class="op" id="5496524">:=</span>&nbsp;<span class="op" id="5496527">(</span><span class="ident" id="5496528">sy</span><span class="op" id="5496530">/</span><span class="num" id="5496531">2</span><span class="op" id="5496532">-</span><span class="ident" id="5496533">src</span><span class="op" id="5496536">.</span><span class="ident" id="5496537">Rect</span><span class="op" id="5496541">.</span><span class="ident" id="5496542">Min</span><span class="op" id="5496545">.</span><span class="ident" id="5496546">Y</span><span class="op" id="5496547">/</span><span class="num" id="5496548">2</span><span class="op" id="5496549">)</span><span class="op" id="5496550">*</span><span class="ident" id="5496551">src</span><span class="op" id="5496554">.</span><span class="ident" id="5496555">CStride</span>&nbsp;<span class="op" id="5496563">+</span>&nbsp;<span class="op" id="5496565">(</span><span class="ident" id="5496566">sp</span><span class="op" id="5496568">.</span><span class="ident" id="5496569">X</span>&nbsp;<span class="op" id="5496571">-</span>&nbsp;<span class="ident" id="5496573">src</span><span class="op" id="5496576">.</span><span class="ident" id="5496577">Rect</span><span class="op" id="5496581">.</span><span class="ident" id="5496582">Min</span><span class="op" id="5496585">.</span><span class="ident" id="5496586">X</span><span class="op" id="5496587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5496592">for</span>&nbsp;<span class="ident" id="5496596">x</span>&nbsp;<span class="op" id="5496598">:=</span>&nbsp;<span class="ident" id="5496601">x0</span><span class="op" id="5496603">;</span>&nbsp;<span class="ident" id="5496605">x</span>&nbsp;<span class="op" id="5496607">!=</span>&nbsp;<span class="ident" id="5496610">x1</span><span class="op" id="5496612">;</span>&nbsp;<span class="ident" id="5496614">x</span><span class="op" id="5496615">,</span>&nbsp;<span class="ident" id="5496617">yi</span><span class="op" id="5496619">,</span>&nbsp;<span class="ident" id="5496621">ci</span>&nbsp;<span class="op" id="5496624">=</span>&nbsp;<span class="ident" id="5496626">x</span><span class="op" id="5496627">+</span><span class="num" id="5496628">4</span><span class="op" id="5496629">,</span>&nbsp;<span class="ident" id="5496631">yi</span><span class="op" id="5496633">+</span><span class="num" id="5496634">1</span><span class="op" id="5496635">,</span>&nbsp;<span class="ident" id="5496637">ci</span><span class="op" id="5496639">+</span><span class="num" id="5496640">1</span>&nbsp;<span class="op" id="5496642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496648">rr</span><span class="op" id="5496650">,</span>&nbsp;<span class="ident" id="5496652">gg</span><span class="op" id="5496654">,</span>&nbsp;<span class="ident" id="5496656">bb</span>&nbsp;<span class="op" id="5496659">:=</span>&nbsp;<span class="ident" id="5496662">color</span><span class="op" id="5496667">.</span><span class="ident" id="5496668">YCbCrToRGB</span><span class="op" id="5496678">(</span><span class="ident" id="5496679">src</span><span class="op" id="5496682">.</span><span class="ident" id="5496683">Y</span><span class="op" id="5496684">[</span><span class="ident" id="5496685">yi</span><span class="op" id="5496687">]</span><span class="op" id="5496688">,</span>&nbsp;<span class="ident" id="5496690">src</span><span class="op" id="5496693">.</span><span class="ident" id="5496694">Cb</span><span class="op" id="5496696">[</span><span class="ident" id="5496697">ci</span><span class="op" id="5496699">]</span><span class="op" id="5496700">,</span>&nbsp;<span class="ident" id="5496702">src</span><span class="op" id="5496705">.</span><span class="ident" id="5496706">Cr</span><span class="op" id="5496708">[</span><span class="ident" id="5496709">ci</span><span class="op" id="5496711">]</span><span class="op" id="5496712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496718">dpix</span><span class="op" id="5496722">[</span><span class="ident" id="5496723">x</span><span class="op" id="5496724">+</span><span class="num" id="5496725">0</span><span class="op" id="5496726">]</span>&nbsp;<span class="op" id="5496728">=</span>&nbsp;<span class="ident" id="5496730">rr</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496737">dpix</span><span class="op" id="5496741">[</span><span class="ident" id="5496742">x</span><span class="op" id="5496743">+</span><span class="num" id="5496744">1</span><span class="op" id="5496745">]</span>&nbsp;<span class="op" id="5496747">=</span>&nbsp;<span class="ident" id="5496749">gg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496756">dpix</span><span class="op" id="5496760">[</span><span class="ident" id="5496761">x</span><span class="op" id="5496762">+</span><span class="num" id="5496763">2</span><span class="op" id="5496764">]</span>&nbsp;<span class="op" id="5496766">=</span>&nbsp;<span class="ident" id="5496768">bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496775">dpix</span><span class="op" id="5496779">[</span><span class="ident" id="5496780">x</span><span class="op" id="5496781">+</span><span class="num" id="5496782">3</span><span class="op" id="5496783">]</span>&nbsp;<span class="op" id="5496785">=</span>&nbsp;<span class="num" id="5496787">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5496794">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5496798">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5496801">default</span><span class="op" id="5496808">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5496812">return</span>&nbsp;<span class="builtintype" id="5496819">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5496826">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5496829">return</span>&nbsp;<span class="builtintype" id="5496836">true</span><br>
<span class="lineno"></span><span class="op" id="5496841">}</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span><span class="keyword" id="5496844">func</span>&nbsp;<span class="ident" id="5496849">drawGlyphOver</span><span class="op" id="5496862">(</span><span class="ident" id="5496863">dst</span>&nbsp;<span class="op" id="5496867">*</span><span class="ident" id="5496868">image</span><span class="op" id="5496873">.</span><span class="ident" id="5496874">RGBA</span><span class="op" id="5496878">,</span>&nbsp;<span class="ident" id="5496880">r</span>&nbsp;<span class="ident" id="5496882">image</span><span class="op" id="5496887">.</span><span class="ident" id="5496888">Rectangle</span><span class="op" id="5496897">,</span>&nbsp;<span class="ident" id="5496899">src</span>&nbsp;<span class="op" id="5496903">*</span><span class="ident" id="5496904">image</span><span class="op" id="5496909">.</span><span class="ident" id="5496910">Uniform</span><span class="op" id="5496917">,</span>&nbsp;<span class="ident" id="5496919">mask</span>&nbsp;<span class="op" id="5496924">*</span><span class="ident" id="5496925">image</span><span class="op" id="5496930">.</span><span class="ident" id="5496931">Alpha</span><span class="op" id="5496936">,</span>&nbsp;<span class="ident" id="5496938">mp</span>&nbsp;<span class="ident" id="5496941">image</span><span class="op" id="5496946">.</span><span class="ident" id="5496947">Point</span><span class="op" id="5496952">)</span>&nbsp;<span class="op" id="5496954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496957">i0</span>&nbsp;<span class="op" id="5496960">:=</span>&nbsp;<span class="ident" id="5496963">dst</span><span class="op" id="5496966">.</span><span class="ident" id="5496967">PixOffset</span><span class="op" id="5496976">(</span><span class="ident" id="5496977">r</span><span class="op" id="5496978">.</span><span class="ident" id="5496979">Min</span><span class="op" id="5496982">.</span><span class="ident" id="5496983">X</span><span class="op" id="5496984">,</span>&nbsp;<span class="ident" id="5496986">r</span><span class="op" id="5496987">.</span><span class="ident" id="5496988">Min</span><span class="op" id="5496991">.</span><span class="ident" id="5496992">Y</span><span class="op" id="5496993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496996">i1</span>&nbsp;<span class="op" id="5496999">:=</span>&nbsp;<span class="ident" id="5497002">i0</span>&nbsp;<span class="op" id="5497005">+</span>&nbsp;<span class="ident" id="5497007">r</span><span class="op" id="5497008">.</span><span class="ident" id="5497009">Dx</span><span class="op" id="5497011">(</span><span class="op" id="5497012">)</span><span class="op" id="5497013">*</span><span class="num" id="5497014">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5497017">mi0</span>&nbsp;<span class="op" id="5497021">:=</span>&nbsp;<span class="ident" id="5497024">mask</span><span class="op" id="5497028">.</span><span class="ident" id="5497029">PixOffset</span><span class="op" id="5497038">(</span><span class="ident" id="5497039">mp</span><span class="op" id="5497041">.</span><span class="ident" id="5497042">X</span><span class="op" id="5497043">,</span>&nbsp;<span class="ident" id="5497045">mp</span><span class="op" id="5497047">.</span><span class="ident" id="5497048">Y</span><span class="op" id="5497049">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5497052">sr</span><span class="op" id="5497054">,</span>&nbsp;<span class="ident" id="5497056">sg</span><span class="op" id="5497058">,</span>&nbsp;<span class="ident" id="5497060">sb</span><span class="op" id="5497062">,</span>&nbsp;<span class="ident" id="5497064">sa</span>&nbsp;<span class="op" id="5497067">:=</span>&nbsp;<span class="ident" id="5497070">src</span><span class="op" id="5497073">.</span><span class="ident" id="5497074">RGBA</span><span class="op" id="5497078">(</span><span class="op" id="5497079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5497082">for</span>&nbsp;<span class="ident" id="5497086">y</span><span class="op" id="5497087">,</span>&nbsp;<span class="ident" id="5497089">my</span>&nbsp;<span class="op" id="5497092">:=</span>&nbsp;<span class="ident" id="5497095">r</span><span class="op" id="5497096">.</span><span class="ident" id="5497097">Min</span><span class="op" id="5497100">.</span><span class="ident" id="5497101">Y</span><span class="op" id="5497102">,</span>&nbsp;<span class="ident" id="5497104">mp</span><span class="op" id="5497106">.</span><span class="ident" id="5497107">Y</span><span class="op" id="5497108">;</span>&nbsp;<span class="ident" id="5497110">y</span>&nbsp;<span class="op" id="5497112">!=</span>&nbsp;<span class="ident" id="5497115">r</span><span class="op" id="5497116">.</span><span class="ident" id="5497117">Max</span><span class="op" id="5497120">.</span><span class="ident" id="5497121">Y</span><span class="op" id="5497122">;</span>&nbsp;<span class="ident" id="5497124">y</span><span class="op" id="5497125">,</span>&nbsp;<span class="ident" id="5497127">my</span>&nbsp;<span class="op" id="5497130">=</span>&nbsp;<span class="ident" id="5497132">y</span><span class="op" id="5497133">+</span><span class="num" id="5497134">1</span><span class="op" id="5497135">,</span>&nbsp;<span class="ident" id="5497137">my</span><span class="op" id="5497139">+</span><span class="num" id="5497140">1</span>&nbsp;<span class="op" id="5497142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5497146">for</span>&nbsp;<span class="ident" id="5497150">i</span><span class="op" id="5497151">,</span>&nbsp;<span class="ident" id="5497153">mi</span>&nbsp;<span class="op" id="5497156">:=</span>&nbsp;<span class="ident" id="5497159">i0</span><span class="op" id="5497161">,</span>&nbsp;<span class="ident" id="5497163">mi0</span><span class="op" id="5497166">;</span>&nbsp;<span class="ident" id="5497168">i</span>&nbsp;<span class="op" id="5497170">&lt;</span>&nbsp;<span class="ident" id="5497172">i1</span><span class="op" id="5497174">;</span>&nbsp;<span class="ident" id="5497176">i</span><span class="op" id="5497177">,</span>&nbsp;<span class="ident" id="5497179">mi</span>&nbsp;<span class="op" id="5497182">=</span>&nbsp;<span class="ident" id="5497184">i</span><span class="op" id="5497185">+</span><span class="num" id="5497186">4</span><span class="op" id="5497187">,</span>&nbsp;<span class="ident" id="5497189">mi</span><span class="op" id="5497191">+</span><span class="num" id="5497192">1</span>&nbsp;<span class="op" id="5497194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5497199">ma</span>&nbsp;<span class="op" id="5497202">:=</span>&nbsp;<span class="builtintype" id="5497205">uint32</span><span class="op" id="5497211">(</span><span class="ident" id="5497212">mask</span><span class="op" id="5497216">.</span><span class="ident" id="5497217">Pix</span><span class="op" id="5497220">[</span><span class="ident" id="5497221">mi</span><span class="op" id="5497223">]</span><span class="op" id="5497224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5497229">if</span>&nbsp;<span class="ident" id="5497232">ma</span>&nbsp;<span class="op" id="5497235">==</span>&nbsp;<span class="num" id="5497238">0</span>&nbsp;<span class="op" id="5497240">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5497246">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5497258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5497263">ma</span>&nbsp;<span class="op" id="5497266">|=</span>&nbsp;<span class="ident" id="5497269">ma</span>&nbsp;<span class="op" id="5497272">&lt;&lt;</span>&nbsp;<span class="num" id="5497275">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5497281">dr</span>&nbsp;<span class="op" id="5497284">:=</span>&nbsp;<span class="builtintype" id="5497287">uint32</span><span class="op" id="5497293">(</span><span class="ident" id="5497294">dst</span><span class="op" id="5497297">.</span><span class="ident" id="5497298">Pix</span><span class="op" id="5497301">[</span><span class="ident" id="5497302">i</span><span class="op" id="5497303">+</span><span class="num" id="5497304">0</span><span class="op" id="5497305">]</span><span class="op" id="5497306">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5497311">dg</span>&nbsp;<span class="op" id="5497314">:=</span>&nbsp;<span class="builtintype" id="5497317">uint32</span><span class="op" id="5497323">(</span><span class="ident" id="5497324">dst</span><span class="op" id="5497327">.</span><span class="ident" id="5497328">Pix</span><span class="op" id="5497331">[</span><span class="ident" id="5497332">i</span><span class="op" id="5497333">+</span><span class="num" id="5497334">1</span><span class="op" id="5497335">]</span><span class="op" id="5497336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5497341">db</span>&nbsp;<span class="op" id="5497344">:=</span>&nbsp;<span class="builtintype" id="5497347">uint32</span><span class="op" id="5497353">(</span><span class="ident" id="5497354">dst</span><span class="op" id="5497357">.</span><span class="ident" id="5497358">Pix</span><span class="op" id="5497361">[</span><span class="ident" id="5497362">i</span><span class="op" id="5497363">+</span><span class="num" id="5497364">2</span><span class="op" id="5497365">]</span><span class="op" id="5497366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5497371">da</span>&nbsp;<span class="op" id="5497374">:=</span>&nbsp;<span class="builtintype" id="5497377">uint32</span><span class="op" id="5497383">(</span><span class="ident" id="5497384">dst</span><span class="op" id="5497387">.</span><span class="ident" id="5497388">Pix</span><span class="op" id="5497391">[</span><span class="ident" id="5497392">i</span><span class="op" id="5497393">+</span><span class="num" id="5497394">3</span><span class="op" id="5497395">]</span><span class="op" id="5497396">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5497402">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5497462">a</span>&nbsp;<span class="op" id="5497464">:=</span>&nbsp;<span class="op" id="5497467">(</span><span class="ident" id="5497468">m</span>&nbsp;<span class="op" id="5497470">-</span>&nbsp;<span class="op" id="5497472">(</span><span class="ident" id="5497473">sa</span>&nbsp;<span class="op" id="5497476">*</span>&nbsp;<span class="ident" id="5497478">ma</span>&nbsp;<span class="op" id="5497481">/</span>&nbsp;<span class="ident" id="5497483">m</span><span class="op" id="5497484">)</span><span class="op" id="5497485">)</span>&nbsp;<span class="op" id="5497487">*</span>&nbsp;<span class="num" id="5497489">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5497499">dst</span><span class="op" id="5497502">.</span><span class="ident" id="5497503">Pix</span><span class="op" id="5497506">[</span><span class="ident" id="5497507">i</span><span class="op" id="5497508">+</span><span class="num" id="5497509">0</span><span class="op" id="5497510">]</span>&nbsp;<span class="op" id="5497512">=</span>&nbsp;<span class="builtintype" id="5497514">uint8</span><span class="op" id="5497519">(</span><span class="op" id="5497520">(</span><span class="ident" id="5497521">dr</span><span class="op" id="5497523">*</span><span class="ident" id="5497524">a</span>&nbsp;<span class="op" id="5497526">+</span>&nbsp;<span class="ident" id="5497528">sr</span><span class="op" id="5497530">*</span><span class="ident" id="5497531">ma</span><span class="op" id="5497533">)</span>&nbsp;<span class="op" id="5497535">/</span>&nbsp;<span class="ident" id="5497537">m</span>&nbsp;<span class="op" id="5497539">&gt;&gt;</span>&nbsp;<span class="num" id="5497542">8</span><span class="op" id="5497543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5497548">dst</span><span class="op" id="5497551">.</span><span class="ident" id="5497552">Pix</span><span class="op" id="5497555">[</span><span class="ident" id="5497556">i</span><span class="op" id="5497557">+</span><span class="num" id="5497558">1</span><span class="op" id="5497559">]</span>&nbsp;<span class="op" id="5497561">=</span>&nbsp;<span class="builtintype" id="5497563">uint8</span><span class="op" id="5497568">(</span><span class="op" id="5497569">(</span><span class="ident" id="5497570">dg</span><span class="op" id="5497572">*</span><span class="ident" id="5497573">a</span>&nbsp;<span class="op" id="5497575">+</span>&nbsp;<span class="ident" id="5497577">sg</span><span class="op" id="5497579">*</span><span class="ident" id="5497580">ma</span><span class="op" id="5497582">)</span>&nbsp;<span class="op" id="5497584">/</span>&nbsp;<span class="ident" id="5497586">m</span>&nbsp;<span class="op" id="5497588">&gt;&gt;</span>&nbsp;<span class="num" id="5497591">8</span><span class="op" id="5497592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5497597">dst</span><span class="op" id="5497600">.</span><span class="ident" id="5497601">Pix</span><span class="op" id="5497604">[</span><span class="ident" id="5497605">i</span><span class="op" id="5497606">+</span><span class="num" id="5497607">2</span><span class="op" id="5497608">]</span>&nbsp;<span class="op" id="5497610">=</span>&nbsp;<span class="builtintype" id="5497612">uint8</span><span class="op" id="5497617">(</span><span class="op" id="5497618">(</span><span class="ident" id="5497619">db</span><span class="op" id="5497621">*</span><span class="ident" id="5497622">a</span>&nbsp;<span class="op" id="5497624">+</span>&nbsp;<span class="ident" id="5497626">sb</span><span class="op" id="5497628">*</span><span class="ident" id="5497629">ma</span><span class="op" id="5497631">)</span>&nbsp;<span class="op" id="5497633">/</span>&nbsp;<span class="ident" id="5497635">m</span>&nbsp;<span class="op" id="5497637">&gt;&gt;</span>&nbsp;<span class="num" id="5497640">8</span><span class="op" id="5497641">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5497646">dst</span><span class="op" id="5497649">.</span><span class="ident" id="5497650">Pix</span><span class="op" id="5497653">[</span><span class="ident" id="5497654">i</span><span class="op" id="5497655">+</span><span class="num" id="5497656">3</span><span class="op" id="5497657">]</span>&nbsp;<span class="op" id="5497659">=</span>&nbsp;<span class="builtintype" id="5497661">uint8</span><span class="op" id="5497666">(</span><span class="op" id="5497667">(</span><span class="ident" id="5497668">da</span><span class="op" id="5497670">*</span><span class="ident" id="5497671">a</span>&nbsp;<span class="op" id="5497673">+</span>&nbsp;<span class="ident" id="5497675">sa</span><span class="op" id="5497677">*</span><span class="ident" id="5497678">ma</span><span class="op" id="5497680">)</span>&nbsp;<span class="op" id="5497682">/</span>&nbsp;<span class="ident" id="5497684">m</span>&nbsp;<span class="op" id="5497686">&gt;&gt;</span>&nbsp;<span class="num" id="5497689">8</span><span class="op" id="5497690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5497694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5497698">i0</span>&nbsp;<span class="op" id="5497701">+=</span>&nbsp;<span class="ident" id="5497704">dst</span><span class="op" id="5497707">.</span><span class="ident" id="5497708">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5497717">i1</span>&nbsp;<span class="op" id="5497720">+=</span>&nbsp;<span class="ident" id="5497723">dst</span><span class="op" id="5497726">.</span><span class="ident" id="5497727">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5497736">mi0</span>&nbsp;<span class="op" id="5497740">+=</span>&nbsp;<span class="ident" id="5497743">mask</span><span class="op" id="5497747">.</span><span class="ident" id="5497748">Stride</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5497756">}</span><br>
<span class="lineno"></span><span class="op" id="5497758">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5497761">func</span>&nbsp;<span class="ident" id="5497766">drawRGBA</span><span class="op" id="5497774">(</span><span class="ident" id="5497775">dst</span>&nbsp;<span class="op" id="5497779">*</span><span class="ident" id="5497780">image</span><span class="op" id="5497785">.</span><span class="ident" id="5497786">RGBA</span><span class="op" id="5497790">,</span>&nbsp;<span class="ident" id="5497792">r</span>&nbsp;<span class="ident" id="5497794">image</span><span class="op" id="5497799">.</span><span class="ident" id="5497800">Rectangle</span><span class="op" id="5497809">,</span>&nbsp;<span class="ident" id="5497811">src</span>&nbsp;<span class="ident" id="5497815">image</span><span class="op" id="5497820">.</span><span class="ident" id="5497821">Image</span><span class="op" id="5497826">,</span>&nbsp;<span class="ident" id="5497828">sp</span>&nbsp;<span class="ident" id="5497831">image</span><span class="op" id="5497836">.</span><span class="ident" id="5497837">Point</span><span class="op" id="5497842">,</span>&nbsp;<span class="ident" id="5497844">mask</span>&nbsp;<span class="ident" id="5497849">image</span><span class="op" id="5497854">.</span><span class="ident" id="5497855">Image</span><span class="op" id="5497860">,</span>&nbsp;<span class="ident" id="5497862">mp</span>&nbsp;<span class="ident" id="5497865">image</span><span class="op" id="5497870">.</span><span class="ident" id="5497871">Point</span><span class="op" id="5497876">,</span>&nbsp;<span class="ident" id="5497878">op</span>&nbsp;<span class="ident" id="5497881">Op</span><span class="op" id="5497883">)</span>&nbsp;<span class="op" id="5497885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5497888">x0</span><span class="op" id="5497890">,</span>&nbsp;<span class="ident" id="5497892">x1</span><span class="op" id="5497894">,</span>&nbsp;<span class="ident" id="5497896">dx</span>&nbsp;<span class="op" id="5497899">:=</span>&nbsp;<span class="ident" id="5497902">r</span><span class="op" id="5497903">.</span><span class="ident" id="5497904">Min</span><span class="op" id="5497907">.</span><span class="ident" id="5497908">X</span><span class="op" id="5497909">,</span>&nbsp;<span class="ident" id="5497911">r</span><span class="op" id="5497912">.</span><span class="ident" id="5497913">Max</span><span class="op" id="5497916">.</span><span class="ident" id="5497917">X</span><span class="op" id="5497918">,</span>&nbsp;<span class="num" id="5497920">1</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5497923">y0</span><span class="op" id="5497925">,</span>&nbsp;<span class="ident" id="5497927">y1</span><span class="op" id="5497929">,</span>&nbsp;<span class="ident" id="5497931">dy</span>&nbsp;<span class="op" id="5497934">:=</span>&nbsp;<span class="ident" id="5497937">r</span><span class="op" id="5497938">.</span><span class="ident" id="5497939">Min</span><span class="op" id="5497942">.</span><span class="ident" id="5497943">Y</span><span class="op" id="5497944">,</span>&nbsp;<span class="ident" id="5497946">r</span><span class="op" id="5497947">.</span><span class="ident" id="5497948">Max</span><span class="op" id="5497951">.</span><span class="ident" id="5497952">Y</span><span class="op" id="5497953">,</span>&nbsp;<span class="num" id="5497955">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5497958">if</span>&nbsp;<span class="ident" id="5497961">image</span><span class="op" id="5497966">.</span><span class="ident" id="5497967">Image</span><span class="op" id="5497972">(</span><span class="ident" id="5497973">dst</span><span class="op" id="5497976">)</span>&nbsp;<span class="op" id="5497978">==</span>&nbsp;<span class="ident" id="5497981">src</span>&nbsp;<span class="op" id="5497985">&amp;&amp;</span>&nbsp;<span class="ident" id="5497988">r</span><span class="op" id="5497989">.</span><span class="ident" id="5497990">Overlaps</span><span class="op" id="5497998">(</span><span class="ident" id="5497999">r</span><span class="op" id="5498000">.</span><span class="ident" id="5498001">Add</span><span class="op" id="5498004">(</span><span class="ident" id="5498005">sp</span><span class="op" id="5498007">.</span><span class="ident" id="5498008">Sub</span><span class="op" id="5498011">(</span><span class="ident" id="5498012">r</span><span class="op" id="5498013">.</span><span class="ident" id="5498014">Min</span><span class="op" id="5498017">)</span><span class="op" id="5498018">)</span><span class="op" id="5498019">)</span>&nbsp;<span class="op" id="5498021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5498025">if</span>&nbsp;<span class="ident" id="5498028">sp</span><span class="op" id="5498030">.</span><span class="ident" id="5498031">Y</span>&nbsp;<span class="op" id="5498033">&lt;</span>&nbsp;<span class="ident" id="5498035">r</span><span class="op" id="5498036">.</span><span class="ident" id="5498037">Min</span><span class="op" id="5498040">.</span><span class="ident" id="5498041">Y</span>&nbsp;<span class="op" id="5498043">||</span>&nbsp;<span class="ident" id="5498046">sp</span><span class="op" id="5498048">.</span><span class="ident" id="5498049">Y</span>&nbsp;<span class="op" id="5498051">==</span>&nbsp;<span class="ident" id="5498054">r</span><span class="op" id="5498055">.</span><span class="ident" id="5498056">Min</span><span class="op" id="5498059">.</span><span class="ident" id="5498060">Y</span>&nbsp;<span class="op" id="5498062">&amp;&amp;</span>&nbsp;<span class="ident" id="5498065">sp</span><span class="op" id="5498067">.</span><span class="ident" id="5498068">X</span>&nbsp;<span class="op" id="5498070">&lt;</span>&nbsp;<span class="ident" id="5498072">r</span><span class="op" id="5498073">.</span><span class="ident" id="5498074">Min</span><span class="op" id="5498077">.</span><span class="ident" id="5498078">X</span>&nbsp;<span class="op" id="5498080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5498085">x0</span><span class="op" id="5498087">,</span>&nbsp;<span class="ident" id="5498089">x1</span><span class="op" id="5498091">,</span>&nbsp;<span class="ident" id="5498093">dx</span>&nbsp;<span class="op" id="5498096">=</span>&nbsp;<span class="ident" id="5498098">x1</span><span class="op" id="5498100">-</span><span class="num" id="5498101">1</span><span class="op" id="5498102">,</span>&nbsp;<span class="ident" id="5498104">x0</span><span class="op" id="5498106">-</span><span class="num" id="5498107">1</span><span class="op" id="5498108">,</span>&nbsp;<span class="op" id="5498110">-</span><span class="num" id="5498111">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5498116">y0</span><span class="op" id="5498118">,</span>&nbsp;<span class="ident" id="5498120">y1</span><span class="op" id="5498122">,</span>&nbsp;<span class="ident" id="5498124">dy</span>&nbsp;<span class="op" id="5498127">=</span>&nbsp;<span class="ident" id="5498129">y1</span><span class="op" id="5498131">-</span><span class="num" id="5498132">1</span><span class="op" id="5498133">,</span>&nbsp;<span class="ident" id="5498135">y0</span><span class="op" id="5498137">-</span><span class="num" id="5498138">1</span><span class="op" id="5498139">,</span>&nbsp;<span class="op" id="5498141">-</span><span class="num" id="5498142">1</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5498146">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5498149">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5498153">sy</span>&nbsp;<span class="op" id="5498156">:=</span>&nbsp;<span class="ident" id="5498159">sp</span><span class="op" id="5498161">.</span><span class="ident" id="5498162">Y</span>&nbsp;<span class="op" id="5498164">+</span>&nbsp;<span class="ident" id="5498166">y0</span>&nbsp;<span class="op" id="5498169">-</span>&nbsp;<span class="ident" id="5498171">r</span><span class="op" id="5498172">.</span><span class="ident" id="5498173">Min</span><span class="op" id="5498176">.</span><span class="ident" id="5498177">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5498180">my</span>&nbsp;<span class="op" id="5498183">:=</span>&nbsp;<span class="ident" id="5498186">mp</span><span class="op" id="5498188">.</span><span class="ident" id="5498189">Y</span>&nbsp;<span class="op" id="5498191">+</span>&nbsp;<span class="ident" id="5498193">y0</span>&nbsp;<span class="op" id="5498196">-</span>&nbsp;<span class="ident" id="5498198">r</span><span class="op" id="5498199">.</span><span class="ident" id="5498200">Min</span><span class="op" id="5498203">.</span><span class="ident" id="5498204">Y</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5498207">sx0</span>&nbsp;<span class="op" id="5498211">:=</span>&nbsp;<span class="ident" id="5498214">sp</span><span class="op" id="5498216">.</span><span class="ident" id="5498217">X</span>&nbsp;<span class="op" id="5498219">+</span>&nbsp;<span class="ident" id="5498221">x0</span>&nbsp;<span class="op" id="5498224">-</span>&nbsp;<span class="ident" id="5498226">r</span><span class="op" id="5498227">.</span><span class="ident" id="5498228">Min</span><span class="op" id="5498231">.</span><span class="ident" id="5498232">X</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5498235">mx0</span>&nbsp;<span class="op" id="5498239">:=</span>&nbsp;<span class="ident" id="5498242">mp</span><span class="op" id="5498244">.</span><span class="ident" id="5498245">X</span>&nbsp;<span class="op" id="5498247">+</span>&nbsp;<span class="ident" id="5498249">x0</span>&nbsp;<span class="op" id="5498252">-</span>&nbsp;<span class="ident" id="5498254">r</span><span class="op" id="5498255">.</span><span class="ident" id="5498256">Min</span><span class="op" id="5498259">.</span><span class="ident" id="5498260">X</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5498263">sx1</span>&nbsp;<span class="op" id="5498267">:=</span>&nbsp;<span class="ident" id="5498270">sx0</span>&nbsp;<span class="op" id="5498274">+</span>&nbsp;<span class="op" id="5498276">(</span><span class="ident" id="5498277">x1</span>&nbsp;<span class="op" id="5498280">-</span>&nbsp;<span class="ident" id="5498282">x0</span><span class="op" id="5498284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5498287">i0</span>&nbsp;<span class="op" id="5498290">:=</span>&nbsp;<span class="ident" id="5498293">dst</span><span class="op" id="5498296">.</span><span class="ident" id="5498297">PixOffset</span><span class="op" id="5498306">(</span><span class="ident" id="5498307">x0</span><span class="op" id="5498309">,</span>&nbsp;<span class="ident" id="5498311">y0</span><span class="op" id="5498313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5498316">di</span>&nbsp;<span class="op" id="5498319">:=</span>&nbsp;<span class="ident" id="5498322">dx</span>&nbsp;<span class="op" id="5498325">*</span>&nbsp;<span class="num" id="5498327">4</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5498330">for</span>&nbsp;<span class="ident" id="5498334">y</span>&nbsp;<span class="op" id="5498336">:=</span>&nbsp;<span class="ident" id="5498339">y0</span><span class="op" id="5498341">;</span>&nbsp;<span class="ident" id="5498343">y</span>&nbsp;<span class="op" id="5498345">!=</span>&nbsp;<span class="ident" id="5498348">y1</span><span class="op" id="5498350">;</span>&nbsp;<span class="ident" id="5498352">y</span><span class="op" id="5498353">,</span>&nbsp;<span class="ident" id="5498355">sy</span><span class="op" id="5498357">,</span>&nbsp;<span class="ident" id="5498359">my</span>&nbsp;<span class="op" id="5498362">=</span>&nbsp;<span class="ident" id="5498364">y</span><span class="op" id="5498365">+</span><span class="ident" id="5498366">dy</span><span class="op" id="5498368">,</span>&nbsp;<span class="ident" id="5498370">sy</span><span class="op" id="5498372">+</span><span class="ident" id="5498373">dy</span><span class="op" id="5498375">,</span>&nbsp;<span class="ident" id="5498377">my</span><span class="op" id="5498379">+</span><span class="ident" id="5498380">dy</span>&nbsp;<span class="op" id="5498383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5498387">for</span>&nbsp;<span class="ident" id="5498391">i</span><span class="op" id="5498392">,</span>&nbsp;<span class="ident" id="5498394">sx</span><span class="op" id="5498396">,</span>&nbsp;<span class="ident" id="5498398">mx</span>&nbsp;<span class="op" id="5498401">:=</span>&nbsp;<span class="ident" id="5498404">i0</span><span class="op" id="5498406">,</span>&nbsp;<span class="ident" id="5498408">sx0</span><span class="op" id="5498411">,</span>&nbsp;<span class="ident" id="5498413">mx0</span><span class="op" id="5498416">;</span>&nbsp;<span class="ident" id="5498418">sx</span>&nbsp;<span class="op" id="5498421">!=</span>&nbsp;<span class="ident" id="5498424">sx1</span><span class="op" id="5498427">;</span>&nbsp;<span class="ident" id="5498429">i</span><span class="op" id="5498430">,</span>&nbsp;<span class="ident" id="5498432">sx</span><span class="op" id="5498434">,</span>&nbsp;<span class="ident" id="5498436">mx</span>&nbsp;<span class="op" id="5498439">=</span>&nbsp;<span class="ident" id="5498441">i</span><span class="op" id="5498442">+</span><span class="ident" id="5498443">di</span><span class="op" id="5498445">,</span>&nbsp;<span class="ident" id="5498447">sx</span><span class="op" id="5498449">+</span><span class="ident" id="5498450">dx</span><span class="op" id="5498452">,</span>&nbsp;<span class="ident" id="5498454">mx</span><span class="op" id="5498456">+</span><span class="ident" id="5498457">dx</span>&nbsp;<span class="op" id="5498460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5498465">ma</span>&nbsp;<span class="op" id="5498468">:=</span>&nbsp;<span class="builtintype" id="5498471">uint32</span><span class="op" id="5498477">(</span><span class="ident" id="5498478">m</span><span class="op" id="5498479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5498484">if</span>&nbsp;<span class="ident" id="5498487">mask</span>&nbsp;<span class="op" id="5498492">!=</span>&nbsp;<span class="ident" id="5498495">nil</span>&nbsp;<span class="op" id="5498499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5498505">_</span><span class="op" id="5498506">,</span>&nbsp;<span class="ident" id="5498508">_</span><span class="op" id="5498509">,</span>&nbsp;<span class="ident" id="5498511">_</span><span class="op" id="5498512">,</span>&nbsp;<span class="ident" id="5498514">ma</span>&nbsp;<span class="op" id="5498517">=</span>&nbsp;<span class="ident" id="5498519">mask</span><span class="op" id="5498523">.</span><span class="ident" id="5498524">At</span><span class="op" id="5498526">(</span><span class="ident" id="5498527">mx</span><span class="op" id="5498529">,</span>&nbsp;<span class="ident" id="5498531">my</span><span class="op" id="5498533">)</span><span class="op" id="5498534">.</span><span class="ident" id="5498535">RGBA</span><span class="op" id="5498539">(</span><span class="op" id="5498540">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5498545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5498550">sr</span><span class="op" id="5498552">,</span>&nbsp;<span class="ident" id="5498554">sg</span><span class="op" id="5498556">,</span>&nbsp;<span class="ident" id="5498558">sb</span><span class="op" id="5498560">,</span>&nbsp;<span class="ident" id="5498562">sa</span>&nbsp;<span class="op" id="5498565">:=</span>&nbsp;<span class="ident" id="5498568">src</span><span class="op" id="5498571">.</span><span class="ident" id="5498572">At</span><span class="op" id="5498574">(</span><span class="ident" id="5498575">sx</span><span class="op" id="5498577">,</span>&nbsp;<span class="ident" id="5498579">sy</span><span class="op" id="5498581">)</span><span class="op" id="5498582">.</span><span class="ident" id="5498583">RGBA</span><span class="op" id="5498587">(</span><span class="op" id="5498588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5498593">if</span>&nbsp;<span class="ident" id="5498596">op</span>&nbsp;<span class="op" id="5498599">==</span>&nbsp;<span class="ident" id="5498602">Over</span>&nbsp;<span class="op" id="5498607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5498613">dr</span>&nbsp;<span class="op" id="5498616">:=</span>&nbsp;<span class="builtintype" id="5498619">uint32</span><span class="op" id="5498625">(</span><span class="ident" id="5498626">dst</span><span class="op" id="5498629">.</span><span class="ident" id="5498630">Pix</span><span class="op" id="5498633">[</span><span class="ident" id="5498634">i</span><span class="op" id="5498635">+</span><span class="num" id="5498636">0</span><span class="op" id="5498637">]</span><span class="op" id="5498638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5498644">dg</span>&nbsp;<span class="op" id="5498647">:=</span>&nbsp;<span class="builtintype" id="5498650">uint32</span><span class="op" id="5498656">(</span><span class="ident" id="5498657">dst</span><span class="op" id="5498660">.</span><span class="ident" id="5498661">Pix</span><span class="op" id="5498664">[</span><span class="ident" id="5498665">i</span><span class="op" id="5498666">+</span><span class="num" id="5498667">1</span><span class="op" id="5498668">]</span><span class="op" id="5498669">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5498675">db</span>&nbsp;<span class="op" id="5498678">:=</span>&nbsp;<span class="builtintype" id="5498681">uint32</span><span class="op" id="5498687">(</span><span class="ident" id="5498688">dst</span><span class="op" id="5498691">.</span><span class="ident" id="5498692">Pix</span><span class="op" id="5498695">[</span><span class="ident" id="5498696">i</span><span class="op" id="5498697">+</span><span class="num" id="5498698">2</span><span class="op" id="5498699">]</span><span class="op" id="5498700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5498706">da</span>&nbsp;<span class="op" id="5498709">:=</span>&nbsp;<span class="builtintype" id="5498712">uint32</span><span class="op" id="5498718">(</span><span class="ident" id="5498719">dst</span><span class="op" id="5498722">.</span><span class="ident" id="5498723">Pix</span><span class="op" id="5498726">[</span><span class="ident" id="5498727">i</span><span class="op" id="5498728">+</span><span class="num" id="5498729">3</span><span class="op" id="5498730">]</span><span class="op" id="5498731">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5498738">//&nbsp;dr,&nbsp;dg,&nbsp;db&nbsp;and&nbsp;da&nbsp;are&nbsp;all&nbsp;8-bit&nbsp;color&nbsp;at&nbsp;the&nbsp;moment,&nbsp;ranging&nbsp;in&nbsp;[0,255].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5498818">//&nbsp;We&nbsp;work&nbsp;in&nbsp;16-bit&nbsp;color,&nbsp;and&nbsp;so&nbsp;would&nbsp;normally&nbsp;do:</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5498876">//&nbsp;dr&nbsp;|=&nbsp;dr&nbsp;&lt;&lt;&nbsp;8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5498897">//&nbsp;and&nbsp;similarly&nbsp;for&nbsp;dg,&nbsp;db&nbsp;and&nbsp;da,&nbsp;but&nbsp;instead&nbsp;we&nbsp;multiply&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5498963">//&nbsp;(which&nbsp;is&nbsp;a&nbsp;16-bit&nbsp;color,&nbsp;ranging&nbsp;in&nbsp;[0,65535])&nbsp;by&nbsp;0x101.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5499028">//&nbsp;This&nbsp;yields&nbsp;the&nbsp;same&nbsp;result,&nbsp;but&nbsp;is&nbsp;fewer&nbsp;arithmetic&nbsp;operations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5499100">a</span>&nbsp;<span class="op" id="5499102">:=</span>&nbsp;<span class="op" id="5499105">(</span><span class="ident" id="5499106">m</span>&nbsp;<span class="op" id="5499108">-</span>&nbsp;<span class="op" id="5499110">(</span><span class="ident" id="5499111">sa</span>&nbsp;<span class="op" id="5499114">*</span>&nbsp;<span class="ident" id="5499116">ma</span>&nbsp;<span class="op" id="5499119">/</span>&nbsp;<span class="ident" id="5499121">m</span><span class="op" id="5499122">)</span><span class="op" id="5499123">)</span>&nbsp;<span class="op" id="5499125">*</span>&nbsp;<span class="num" id="5499127">0x101</span><br>
<span class="lineno">530</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5499138">dst</span><span class="op" id="5499141">.</span><span class="ident" id="5499142">Pix</span><span class="op" id="5499145">[</span><span class="ident" id="5499146">i</span><span class="op" id="5499147">+</span><span class="num" id="5499148">0</span><span class="op" id="5499149">]</span>&nbsp;<span class="op" id="5499151">=</span>&nbsp;<span class="builtintype" id="5499153">uint8</span><span class="op" id="5499158">(</span><span class="op" id="5499159">(</span><span class="ident" id="5499160">dr</span><span class="op" id="5499162">*</span><span class="ident" id="5499163">a</span>&nbsp;<span class="op" id="5499165">+</span>&nbsp;<span class="ident" id="5499167">sr</span><span class="op" id="5499169">*</span><span class="ident" id="5499170">ma</span><span class="op" id="5499172">)</span>&nbsp;<span class="op" id="5499174">/</span>&nbsp;<span class="ident" id="5499176">m</span>&nbsp;<span class="op" id="5499178">&gt;&gt;</span>&nbsp;<span class="num" id="5499181">8</span><span class="op" id="5499182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5499188">dst</span><span class="op" id="5499191">.</span><span class="ident" id="5499192">Pix</span><span class="op" id="5499195">[</span><span class="ident" id="5499196">i</span><span class="op" id="5499197">+</span><span class="num" id="5499198">1</span><span class="op" id="5499199">]</span>&nbsp;<span class="op" id="5499201">=</span>&nbsp;<span class="builtintype" id="5499203">uint8</span><span class="op" id="5499208">(</span><span class="op" id="5499209">(</span><span class="ident" id="5499210">dg</span><span class="op" id="5499212">*</span><span class="ident" id="5499213">a</span>&nbsp;<span class="op" id="5499215">+</span>&nbsp;<span class="ident" id="5499217">sg</span><span class="op" id="5499219">*</span><span class="ident" id="5499220">ma</span><span class="op" id="5499222">)</span>&nbsp;<span class="op" id="5499224">/</span>&nbsp;<span class="ident" id="5499226">m</span>&nbsp;<span class="op" id="5499228">&gt;&gt;</span>&nbsp;<span class="num" id="5499231">8</span><span class="op" id="5499232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5499238">dst</span><span class="op" id="5499241">.</span><span class="ident" id="5499242">Pix</span><span class="op" id="5499245">[</span><span class="ident" id="5499246">i</span><span class="op" id="5499247">+</span><span class="num" id="5499248">2</span><span class="op" id="5499249">]</span>&nbsp;<span class="op" id="5499251">=</span>&nbsp;<span class="builtintype" id="5499253">uint8</span><span class="op" id="5499258">(</span><span class="op" id="5499259">(</span><span class="ident" id="5499260">db</span><span class="op" id="5499262">*</span><span class="ident" id="5499263">a</span>&nbsp;<span class="op" id="5499265">+</span>&nbsp;<span class="ident" id="5499267">sb</span><span class="op" id="5499269">*</span><span class="ident" id="5499270">ma</span><span class="op" id="5499272">)</span>&nbsp;<span class="op" id="5499274">/</span>&nbsp;<span class="ident" id="5499276">m</span>&nbsp;<span class="op" id="5499278">&gt;&gt;</span>&nbsp;<span class="num" id="5499281">8</span><span class="op" id="5499282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5499288">dst</span><span class="op" id="5499291">.</span><span class="ident" id="5499292">Pix</span><span class="op" id="5499295">[</span><span class="ident" id="5499296">i</span><span class="op" id="5499297">+</span><span class="num" id="5499298">3</span><span class="op" id="5499299">]</span>&nbsp;<span class="op" id="5499301">=</span>&nbsp;<span class="builtintype" id="5499303">uint8</span><span class="op" id="5499308">(</span><span class="op" id="5499309">(</span><span class="ident" id="5499310">da</span><span class="op" id="5499312">*</span><span class="ident" id="5499313">a</span>&nbsp;<span class="op" id="5499315">+</span>&nbsp;<span class="ident" id="5499317">sa</span><span class="op" id="5499319">*</span><span class="ident" id="5499320">ma</span><span class="op" id="5499322">)</span>&nbsp;<span class="op" id="5499324">/</span>&nbsp;<span class="ident" id="5499326">m</span>&nbsp;<span class="op" id="5499328">&gt;&gt;</span>&nbsp;<span class="num" id="5499331">8</span><span class="op" id="5499332">)</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5499338">}</span>&nbsp;<span class="keyword" id="5499340">else</span>&nbsp;<span class="op" id="5499345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5499351">dst</span><span class="op" id="5499354">.</span><span class="ident" id="5499355">Pix</span><span class="op" id="5499358">[</span><span class="ident" id="5499359">i</span><span class="op" id="5499360">+</span><span class="num" id="5499361">0</span><span class="op" id="5499362">]</span>&nbsp;<span class="op" id="5499364">=</span>&nbsp;<span class="builtintype" id="5499366">uint8</span><span class="op" id="5499371">(</span><span class="ident" id="5499372">sr</span>&nbsp;<span class="op" id="5499375">*</span>&nbsp;<span class="ident" id="5499377">ma</span>&nbsp;<span class="op" id="5499380">/</span>&nbsp;<span class="ident" id="5499382">m</span>&nbsp;<span class="op" id="5499384">&gt;&gt;</span>&nbsp;<span class="num" id="5499387">8</span><span class="op" id="5499388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5499394">dst</span><span class="op" id="5499397">.</span><span class="ident" id="5499398">Pix</span><span class="op" id="5499401">[</span><span class="ident" id="5499402">i</span><span class="op" id="5499403">+</span><span class="num" id="5499404">1</span><span class="op" id="5499405">]</span>&nbsp;<span class="op" id="5499407">=</span>&nbsp;<span class="builtintype" id="5499409">uint8</span><span class="op" id="5499414">(</span><span class="ident" id="5499415">sg</span>&nbsp;<span class="op" id="5499418">*</span>&nbsp;<span class="ident" id="5499420">ma</span>&nbsp;<span class="op" id="5499423">/</span>&nbsp;<span class="ident" id="5499425">m</span>&nbsp;<span class="op" id="5499427">&gt;&gt;</span>&nbsp;<span class="num" id="5499430">8</span><span class="op" id="5499431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5499437">dst</span><span class="op" id="5499440">.</span><span class="ident" id="5499441">Pix</span><span class="op" id="5499444">[</span><span class="ident" id="5499445">i</span><span class="op" id="5499446">+</span><span class="num" id="5499447">2</span><span class="op" id="5499448">]</span>&nbsp;<span class="op" id="5499450">=</span>&nbsp;<span class="builtintype" id="5499452">uint8</span><span class="op" id="5499457">(</span><span class="ident" id="5499458">sb</span>&nbsp;<span class="op" id="5499461">*</span>&nbsp;<span class="ident" id="5499463">ma</span>&nbsp;<span class="op" id="5499466">/</span>&nbsp;<span class="ident" id="5499468">m</span>&nbsp;<span class="op" id="5499470">&gt;&gt;</span>&nbsp;<span class="num" id="5499473">8</span><span class="op" id="5499474">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5499480">dst</span><span class="op" id="5499483">.</span><span class="ident" id="5499484">Pix</span><span class="op" id="5499487">[</span><span class="ident" id="5499488">i</span><span class="op" id="5499489">+</span><span class="num" id="5499490">3</span><span class="op" id="5499491">]</span>&nbsp;<span class="op" id="5499493">=</span>&nbsp;<span class="builtintype" id="5499495">uint8</span><span class="op" id="5499500">(</span><span class="ident" id="5499501">sa</span>&nbsp;<span class="op" id="5499504">*</span>&nbsp;<span class="ident" id="5499506">ma</span>&nbsp;<span class="op" id="5499509">/</span>&nbsp;<span class="ident" id="5499511">m</span>&nbsp;<span class="op" id="5499513">&gt;&gt;</span>&nbsp;<span class="num" id="5499516">8</span><span class="op" id="5499517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5499522">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5499526">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5499530">i0</span>&nbsp;<span class="op" id="5499533">+=</span>&nbsp;<span class="ident" id="5499536">dy</span>&nbsp;<span class="op" id="5499539">*</span>&nbsp;<span class="ident" id="5499541">dst</span><span class="op" id="5499544">.</span><span class="ident" id="5499545">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5499553">}</span><br>
<span class="lineno">545</span><span class="op" id="5499555">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5499558">//&nbsp;clamp&nbsp;clamps&nbsp;i&nbsp;to&nbsp;the&nbsp;interval&nbsp;[0,&nbsp;0xffff].</span><br>
<span class="lineno"></span><span class="keyword" id="5499605">func</span>&nbsp;<span class="ident" id="5499610">clamp</span><span class="op" id="5499615">(</span><span class="ident" id="5499616">i</span>&nbsp;<span class="builtintype" id="5499618">int32</span><span class="op" id="5499623">)</span>&nbsp;<span class="builtintype" id="5499625">int32</span>&nbsp;<span class="op" id="5499631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5499634">if</span>&nbsp;<span class="ident" id="5499637">i</span>&nbsp;<span class="op" id="5499639">&lt;</span>&nbsp;<span class="num" id="5499641">0</span>&nbsp;<span class="op" id="5499643">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5499647">return</span>&nbsp;<span class="num" id="5499654">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5499657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5499660">if</span>&nbsp;<span class="ident" id="5499663">i</span>&nbsp;<span class="op" id="5499665">&gt;</span>&nbsp;<span class="num" id="5499667">0xffff</span>&nbsp;<span class="op" id="5499674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5499678">return</span>&nbsp;<span class="num" id="5499685">0xffff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5499693">}</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5499696">return</span>&nbsp;<span class="ident" id="5499703">i</span><br>
<span class="lineno"></span><span class="op" id="5499705">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5499708">func</span>&nbsp;<span class="ident" id="5499713">drawPaletted</span><span class="op" id="5499725">(</span><span class="ident" id="5499726">dst</span>&nbsp;<span class="ident" id="5499730">Image</span><span class="op" id="5499735">,</span>&nbsp;<span class="ident" id="5499737">r</span>&nbsp;<span class="ident" id="5499739">image</span><span class="op" id="5499744">.</span><span class="ident" id="5499745">Rectangle</span><span class="op" id="5499754">,</span>&nbsp;<span class="ident" id="5499756">src</span>&nbsp;<span class="ident" id="5499760">image</span><span class="op" id="5499765">.</span><span class="ident" id="5499766">Image</span><span class="op" id="5499771">,</span>&nbsp;<span class="ident" id="5499773">sp</span>&nbsp;<span class="ident" id="5499776">image</span><span class="op" id="5499781">.</span><span class="ident" id="5499782">Point</span><span class="op" id="5499787">,</span>&nbsp;<span class="ident" id="5499789">floydSteinberg</span>&nbsp;<span class="builtintype" id="5499804">bool</span><span class="op" id="5499808">)</span>&nbsp;<span class="op" id="5499810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5499813">//&nbsp;TODO(nigeltao):&nbsp;handle&nbsp;the&nbsp;case&nbsp;where&nbsp;the&nbsp;dst&nbsp;and&nbsp;src&nbsp;overlap.</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5499880">//&nbsp;Does&nbsp;it&nbsp;even&nbsp;make&nbsp;sense&nbsp;to&nbsp;try&nbsp;and&nbsp;do&nbsp;Floyd-Steinberg&nbsp;whilst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5499945">//&nbsp;walking&nbsp;the&nbsp;image&nbsp;backward&nbsp;(right-to-left&nbsp;bottom-to-top)?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5500008">//&nbsp;If&nbsp;dst&nbsp;is&nbsp;an&nbsp;*image.Paletted,&nbsp;we&nbsp;have&nbsp;a&nbsp;fast&nbsp;path&nbsp;for&nbsp;dst.Set&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5500078">//&nbsp;dst.At.&nbsp;The&nbsp;dst.Set&nbsp;equivalent&nbsp;is&nbsp;a&nbsp;batch&nbsp;version&nbsp;of&nbsp;the&nbsp;algorithm</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5500149">//&nbsp;used&nbsp;by&nbsp;color.Palette&#39;s&nbsp;Index&nbsp;method&nbsp;in&nbsp;image/color/color.go,&nbsp;plus</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5500220">//&nbsp;optional&nbsp;Floyd-Steinberg&nbsp;error&nbsp;diffusion.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5500266">palette</span><span class="op" id="5500273">,</span>&nbsp;<span class="ident" id="5500275">pix</span><span class="op" id="5500278">,</span>&nbsp;<span class="ident" id="5500280">stride</span>&nbsp;<span class="op" id="5500287">:=</span>&nbsp;<span class="op" id="5500290">[</span><span class="op" id="5500291">]</span><span class="op" id="5500292">[</span><span class="num" id="5500293">3</span><span class="op" id="5500294">]</span><span class="builtintype" id="5500295">int32</span><span class="op" id="5500300">(</span><span class="ident" id="5500301">nil</span><span class="op" id="5500304">)</span><span class="op" id="5500305">,</span>&nbsp;<span class="op" id="5500307">[</span><span class="op" id="5500308">]</span><span class="builtintype" id="5500309">byte</span><span class="op" id="5500313">(</span><span class="ident" id="5500314">nil</span><span class="op" id="5500317">)</span><span class="op" id="5500318">,</span>&nbsp;<span class="num" id="5500320">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5500323">if</span>&nbsp;<span class="ident" id="5500326">p</span><span class="op" id="5500327">,</span>&nbsp;<span class="ident" id="5500329">ok</span>&nbsp;<span class="op" id="5500332">:=</span>&nbsp;<span class="ident" id="5500335">dst</span><span class="op" id="5500338">.</span><span class="op" id="5500339">(</span><span class="op" id="5500340">*</span><span class="ident" id="5500341">image</span><span class="op" id="5500346">.</span><span class="ident" id="5500347">Paletted</span><span class="op" id="5500355">)</span><span class="op" id="5500356">;</span>&nbsp;<span class="ident" id="5500358">ok</span>&nbsp;<span class="op" id="5500361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5500365">palette</span>&nbsp;<span class="op" id="5500373">=</span>&nbsp;<span class="builtinfunc" id="5500375">make</span><span class="op" id="5500379">(</span><span class="op" id="5500380">[</span><span class="op" id="5500381">]</span><span class="op" id="5500382">[</span><span class="num" id="5500383">3</span><span class="op" id="5500384">]</span><span class="builtintype" id="5500385">int32</span><span class="op" id="5500390">,</span>&nbsp;<span class="builtinfunc" id="5500392">len</span><span class="op" id="5500395">(</span><span class="ident" id="5500396">p</span><span class="op" id="5500397">.</span><span class="ident" id="5500398">Palette</span><span class="op" id="5500405">)</span><span class="op" id="5500406">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5500410">for</span>&nbsp;<span class="ident" id="5500414">i</span><span class="op" id="5500415">,</span>&nbsp;<span class="ident" id="5500417">col</span>&nbsp;<span class="op" id="5500421">:=</span>&nbsp;<span class="keyword" id="5500424">range</span>&nbsp;<span class="ident" id="5500430">p</span><span class="op" id="5500431">.</span><span class="ident" id="5500432">Palette</span>&nbsp;<span class="op" id="5500440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5500445">r</span><span class="op" id="5500446">,</span>&nbsp;<span class="ident" id="5500448">g</span><span class="op" id="5500449">,</span>&nbsp;<span class="ident" id="5500451">b</span><span class="op" id="5500452">,</span>&nbsp;<span class="ident" id="5500454">_</span>&nbsp;<span class="op" id="5500456">:=</span>&nbsp;<span class="ident" id="5500459">col</span><span class="op" id="5500462">.</span><span class="ident" id="5500463">RGBA</span><span class="op" id="5500467">(</span><span class="op" id="5500468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5500473">palette</span><span class="op" id="5500480">[</span><span class="ident" id="5500481">i</span><span class="op" id="5500482">]</span><span class="op" id="5500483">[</span><span class="num" id="5500484">0</span><span class="op" id="5500485">]</span>&nbsp;<span class="op" id="5500487">=</span>&nbsp;<span class="builtintype" id="5500489">int32</span><span class="op" id="5500494">(</span><span class="ident" id="5500495">r</span><span class="op" id="5500496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5500501">palette</span><span class="op" id="5500508">[</span><span class="ident" id="5500509">i</span><span class="op" id="5500510">]</span><span class="op" id="5500511">[</span><span class="num" id="5500512">1</span><span class="op" id="5500513">]</span>&nbsp;<span class="op" id="5500515">=</span>&nbsp;<span class="builtintype" id="5500517">int32</span><span class="op" id="5500522">(</span><span class="ident" id="5500523">g</span><span class="op" id="5500524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5500529">palette</span><span class="op" id="5500536">[</span><span class="ident" id="5500537">i</span><span class="op" id="5500538">]</span><span class="op" id="5500539">[</span><span class="num" id="5500540">2</span><span class="op" id="5500541">]</span>&nbsp;<span class="op" id="5500543">=</span>&nbsp;<span class="builtintype" id="5500545">int32</span><span class="op" id="5500550">(</span><span class="ident" id="5500551">b</span><span class="op" id="5500552">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5500556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5500560">pix</span><span class="op" id="5500563">,</span>&nbsp;<span class="ident" id="5500565">stride</span>&nbsp;<span class="op" id="5500572">=</span>&nbsp;<span class="ident" id="5500574">p</span><span class="op" id="5500575">.</span><span class="ident" id="5500576">Pix</span><span class="op" id="5500579">[</span><span class="ident" id="5500580">p</span><span class="op" id="5500581">.</span><span class="ident" id="5500582">PixOffset</span><span class="op" id="5500591">(</span><span class="ident" id="5500592">r</span><span class="op" id="5500593">.</span><span class="ident" id="5500594">Min</span><span class="op" id="5500597">.</span><span class="ident" id="5500598">X</span><span class="op" id="5500599">,</span>&nbsp;<span class="ident" id="5500601">r</span><span class="op" id="5500602">.</span><span class="ident" id="5500603">Min</span><span class="op" id="5500606">.</span><span class="ident" id="5500607">Y</span><span class="op" id="5500608">)</span><span class="op" id="5500609">:</span><span class="op" id="5500610">]</span><span class="op" id="5500611">,</span>&nbsp;<span class="ident" id="5500613">p</span><span class="op" id="5500614">.</span><span class="ident" id="5500615">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5500623">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5500627">//&nbsp;quantErrorCurr&nbsp;and&nbsp;quantErrorNext&nbsp;are&nbsp;the&nbsp;Floyd-Steinberg&nbsp;quantization</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5500702">//&nbsp;errors&nbsp;that&nbsp;have&nbsp;been&nbsp;propagated&nbsp;to&nbsp;the&nbsp;pixels&nbsp;in&nbsp;the&nbsp;current&nbsp;and&nbsp;next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5500777">//&nbsp;rows.&nbsp;The&nbsp;+2&nbsp;simplifies&nbsp;calculation&nbsp;near&nbsp;the&nbsp;edges.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5500833">var</span>&nbsp;<span class="ident" id="5500837">quantErrorCurr</span><span class="op" id="5500851">,</span>&nbsp;<span class="ident" id="5500853">quantErrorNext</span>&nbsp;<span class="op" id="5500868">[</span><span class="op" id="5500869">]</span><span class="op" id="5500870">[</span><span class="num" id="5500871">3</span><span class="op" id="5500872">]</span><span class="builtintype" id="5500873">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5500880">if</span>&nbsp;<span class="ident" id="5500883">floydSteinberg</span>&nbsp;<span class="op" id="5500898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5500902">quantErrorCurr</span>&nbsp;<span class="op" id="5500917">=</span>&nbsp;<span class="builtinfunc" id="5500919">make</span><span class="op" id="5500923">(</span><span class="op" id="5500924">[</span><span class="op" id="5500925">]</span><span class="op" id="5500926">[</span><span class="num" id="5500927">3</span><span class="op" id="5500928">]</span><span class="builtintype" id="5500929">int32</span><span class="op" id="5500934">,</span>&nbsp;<span class="ident" id="5500936">r</span><span class="op" id="5500937">.</span><span class="ident" id="5500938">Dx</span><span class="op" id="5500940">(</span><span class="op" id="5500941">)</span><span class="op" id="5500942">+</span><span class="num" id="5500943">2</span><span class="op" id="5500944">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5500948">quantErrorNext</span>&nbsp;<span class="op" id="5500963">=</span>&nbsp;<span class="builtinfunc" id="5500965">make</span><span class="op" id="5500969">(</span><span class="op" id="5500970">[</span><span class="op" id="5500971">]</span><span class="op" id="5500972">[</span><span class="num" id="5500973">3</span><span class="op" id="5500974">]</span><span class="builtintype" id="5500975">int32</span><span class="op" id="5500980">,</span>&nbsp;<span class="ident" id="5500982">r</span><span class="op" id="5500983">.</span><span class="ident" id="5500984">Dx</span><span class="op" id="5500986">(</span><span class="op" id="5500987">)</span><span class="op" id="5500988">+</span><span class="num" id="5500989">2</span><span class="op" id="5500990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5500993">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5500997">//&nbsp;Loop&nbsp;over&nbsp;each&nbsp;source&nbsp;pixel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5501030">out</span>&nbsp;<span class="op" id="5501034">:=</span>&nbsp;<span class="ident" id="5501037">color</span><span class="op" id="5501042">.</span><span class="ident" id="5501043">RGBA64</span><span class="op" id="5501049">{</span><span class="ident" id="5501050">A</span><span class="op" id="5501051">:</span>&nbsp;<span class="num" id="5501053">0xffff</span><span class="op" id="5501059">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5501062">for</span>&nbsp;<span class="ident" id="5501066">y</span>&nbsp;<span class="op" id="5501068">:=</span>&nbsp;<span class="num" id="5501071">0</span><span class="op" id="5501072">;</span>&nbsp;<span class="ident" id="5501074">y</span>&nbsp;<span class="op" id="5501076">!=</span>&nbsp;<span class="ident" id="5501079">r</span><span class="op" id="5501080">.</span><span class="ident" id="5501081">Dy</span><span class="op" id="5501083">(</span><span class="op" id="5501084">)</span><span class="op" id="5501085">;</span>&nbsp;<span class="ident" id="5501087">y</span><span class="op" id="5501088">++</span>&nbsp;<span class="op" id="5501091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5501095">for</span>&nbsp;<span class="ident" id="5501099">x</span>&nbsp;<span class="op" id="5501101">:=</span>&nbsp;<span class="num" id="5501104">0</span><span class="op" id="5501105">;</span>&nbsp;<span class="ident" id="5501107">x</span>&nbsp;<span class="op" id="5501109">!=</span>&nbsp;<span class="ident" id="5501112">r</span><span class="op" id="5501113">.</span><span class="ident" id="5501114">Dx</span><span class="op" id="5501116">(</span><span class="op" id="5501117">)</span><span class="op" id="5501118">;</span>&nbsp;<span class="ident" id="5501120">x</span><span class="op" id="5501121">++</span>&nbsp;<span class="op" id="5501124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5501129">//&nbsp;er,&nbsp;eg&nbsp;and&nbsp;eb&nbsp;are&nbsp;the&nbsp;pixel&#39;s&nbsp;R,G,B&nbsp;values&nbsp;plus&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5501187">//&nbsp;optional&nbsp;Floyd-Steinberg&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5501225">sr</span><span class="op" id="5501227">,</span>&nbsp;<span class="ident" id="5501229">sg</span><span class="op" id="5501231">,</span>&nbsp;<span class="ident" id="5501233">sb</span><span class="op" id="5501235">,</span>&nbsp;<span class="ident" id="5501237">_</span>&nbsp;<span class="op" id="5501239">:=</span>&nbsp;<span class="ident" id="5501242">src</span><span class="op" id="5501245">.</span><span class="ident" id="5501246">At</span><span class="op" id="5501248">(</span><span class="ident" id="5501249">sp</span><span class="op" id="5501251">.</span><span class="ident" id="5501252">X</span><span class="op" id="5501253">+</span><span class="ident" id="5501254">x</span><span class="op" id="5501255">,</span>&nbsp;<span class="ident" id="5501257">sp</span><span class="op" id="5501259">.</span><span class="ident" id="5501260">Y</span><span class="op" id="5501261">+</span><span class="ident" id="5501262">y</span><span class="op" id="5501263">)</span><span class="op" id="5501264">.</span><span class="ident" id="5501265">RGBA</span><span class="op" id="5501269">(</span><span class="op" id="5501270">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5501275">er</span><span class="op" id="5501277">,</span>&nbsp;<span class="ident" id="5501279">eg</span><span class="op" id="5501281">,</span>&nbsp;<span class="ident" id="5501283">eb</span>&nbsp;<span class="op" id="5501286">:=</span>&nbsp;<span class="builtintype" id="5501289">int32</span><span class="op" id="5501294">(</span><span class="ident" id="5501295">sr</span><span class="op" id="5501297">)</span><span class="op" id="5501298">,</span>&nbsp;<span class="builtintype" id="5501300">int32</span><span class="op" id="5501305">(</span><span class="ident" id="5501306">sg</span><span class="op" id="5501308">)</span><span class="op" id="5501309">,</span>&nbsp;<span class="builtintype" id="5501311">int32</span><span class="op" id="5501316">(</span><span class="ident" id="5501317">sb</span><span class="op" id="5501319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5501324">if</span>&nbsp;<span class="ident" id="5501327">floydSteinberg</span>&nbsp;<span class="op" id="5501342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5501348">er</span>&nbsp;<span class="op" id="5501351">=</span>&nbsp;<span class="ident" id="5501353">clamp</span><span class="op" id="5501358">(</span><span class="ident" id="5501359">er</span>&nbsp;<span class="op" id="5501362">+</span>&nbsp;<span class="ident" id="5501364">quantErrorCurr</span><span class="op" id="5501378">[</span><span class="ident" id="5501379">x</span><span class="op" id="5501380">+</span><span class="num" id="5501381">1</span><span class="op" id="5501382">]</span><span class="op" id="5501383">[</span><span class="num" id="5501384">0</span><span class="op" id="5501385">]</span><span class="op" id="5501386">/</span><span class="num" id="5501387">16</span><span class="op" id="5501389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5501395">eg</span>&nbsp;<span class="op" id="5501398">=</span>&nbsp;<span class="ident" id="5501400">clamp</span><span class="op" id="5501405">(</span><span class="ident" id="5501406">eg</span>&nbsp;<span class="op" id="5501409">+</span>&nbsp;<span class="ident" id="5501411">quantErrorCurr</span><span class="op" id="5501425">[</span><span class="ident" id="5501426">x</span><span class="op" id="5501427">+</span><span class="num" id="5501428">1</span><span class="op" id="5501429">]</span><span class="op" id="5501430">[</span><span class="num" id="5501431">1</span><span class="op" id="5501432">]</span><span class="op" id="5501433">/</span><span class="num" id="5501434">16</span><span class="op" id="5501436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5501442">eb</span>&nbsp;<span class="op" id="5501445">=</span>&nbsp;<span class="ident" id="5501447">clamp</span><span class="op" id="5501452">(</span><span class="ident" id="5501453">eb</span>&nbsp;<span class="op" id="5501456">+</span>&nbsp;<span class="ident" id="5501458">quantErrorCurr</span><span class="op" id="5501472">[</span><span class="ident" id="5501473">x</span><span class="op" id="5501474">+</span><span class="num" id="5501475">1</span><span class="op" id="5501476">]</span><span class="op" id="5501477">[</span><span class="num" id="5501478">2</span><span class="op" id="5501479">]</span><span class="op" id="5501480">/</span><span class="num" id="5501481">16</span><span class="op" id="5501483">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5501488">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5501494">if</span>&nbsp;<span class="ident" id="5501497">palette</span>&nbsp;<span class="op" id="5501505">!=</span>&nbsp;<span class="ident" id="5501508">nil</span>&nbsp;<span class="op" id="5501512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5501518">//&nbsp;Find&nbsp;the&nbsp;closest&nbsp;palette&nbsp;color&nbsp;in&nbsp;Euclidean&nbsp;R,G,B&nbsp;space:&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5501586">//&nbsp;one&nbsp;that&nbsp;minimizes&nbsp;sum-squared-difference.&nbsp;We&nbsp;shift&nbsp;by&nbsp;1&nbsp;bit</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5501654">//&nbsp;to&nbsp;avoid&nbsp;potential&nbsp;uint32&nbsp;overflow&nbsp;in&nbsp;sum-squared-difference.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5501723">//&nbsp;TODO(nigeltao):&nbsp;consider&nbsp;smarter&nbsp;algorithms.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5501775">bestIndex</span><span class="op" id="5501784">,</span>&nbsp;<span class="ident" id="5501786">bestSSD</span>&nbsp;<span class="op" id="5501794">:=</span>&nbsp;<span class="num" id="5501797">0</span><span class="op" id="5501798">,</span>&nbsp;<span class="builtintype" id="5501800">uint32</span><span class="op" id="5501806">(</span><span class="num" id="5501807">1</span><span class="op" id="5501808">&lt;&lt;</span><span class="num" id="5501810">32</span><span class="op" id="5501812">-</span><span class="num" id="5501813">1</span><span class="op" id="5501814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5501820">for</span>&nbsp;<span class="ident" id="5501824">index</span><span class="op" id="5501829">,</span>&nbsp;<span class="ident" id="5501831">p</span>&nbsp;<span class="op" id="5501833">:=</span>&nbsp;<span class="keyword" id="5501836">range</span>&nbsp;<span class="ident" id="5501842">palette</span>&nbsp;<span class="op" id="5501850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5501857">delta</span>&nbsp;<span class="op" id="5501863">:=</span>&nbsp;<span class="op" id="5501866">(</span><span class="ident" id="5501867">er</span>&nbsp;<span class="op" id="5501870">-</span>&nbsp;<span class="ident" id="5501872">p</span><span class="op" id="5501873">[</span><span class="num" id="5501874">0</span><span class="op" id="5501875">]</span><span class="op" id="5501876">)</span>&nbsp;<span class="op" id="5501878">&gt;&gt;</span>&nbsp;<span class="num" id="5501881">1</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5501888">ssd</span>&nbsp;<span class="op" id="5501892">:=</span>&nbsp;<span class="builtintype" id="5501895">uint32</span><span class="op" id="5501901">(</span><span class="ident" id="5501902">delta</span>&nbsp;<span class="op" id="5501908">*</span>&nbsp;<span class="ident" id="5501910">delta</span><span class="op" id="5501915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5501922">delta</span>&nbsp;<span class="op" id="5501928">=</span>&nbsp;<span class="op" id="5501930">(</span><span class="ident" id="5501931">eg</span>&nbsp;<span class="op" id="5501934">-</span>&nbsp;<span class="ident" id="5501936">p</span><span class="op" id="5501937">[</span><span class="num" id="5501938">1</span><span class="op" id="5501939">]</span><span class="op" id="5501940">)</span>&nbsp;<span class="op" id="5501942">&gt;&gt;</span>&nbsp;<span class="num" id="5501945">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5501952">ssd</span>&nbsp;<span class="op" id="5501956">+=</span>&nbsp;<span class="builtintype" id="5501959">uint32</span><span class="op" id="5501965">(</span><span class="ident" id="5501966">delta</span>&nbsp;<span class="op" id="5501972">*</span>&nbsp;<span class="ident" id="5501974">delta</span><span class="op" id="5501979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5501986">delta</span>&nbsp;<span class="op" id="5501992">=</span>&nbsp;<span class="op" id="5501994">(</span><span class="ident" id="5501995">eb</span>&nbsp;<span class="op" id="5501998">-</span>&nbsp;<span class="ident" id="5502000">p</span><span class="op" id="5502001">[</span><span class="num" id="5502002">2</span><span class="op" id="5502003">]</span><span class="op" id="5502004">)</span>&nbsp;<span class="op" id="5502006">&gt;&gt;</span>&nbsp;<span class="num" id="5502009">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5502016">ssd</span>&nbsp;<span class="op" id="5502020">+=</span>&nbsp;<span class="builtintype" id="5502023">uint32</span><span class="op" id="5502029">(</span><span class="ident" id="5502030">delta</span>&nbsp;<span class="op" id="5502036">*</span>&nbsp;<span class="ident" id="5502038">delta</span><span class="op" id="5502043">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5502050">if</span>&nbsp;<span class="ident" id="5502053">ssd</span>&nbsp;<span class="op" id="5502057">&lt;</span>&nbsp;<span class="ident" id="5502059">bestSSD</span>&nbsp;<span class="op" id="5502067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5502075">bestIndex</span><span class="op" id="5502084">,</span>&nbsp;<span class="ident" id="5502086">bestSSD</span>&nbsp;<span class="op" id="5502094">=</span>&nbsp;<span class="ident" id="5502096">index</span><span class="op" id="5502101">,</span>&nbsp;<span class="ident" id="5502103">ssd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5502113">if</span>&nbsp;<span class="ident" id="5502116">ssd</span>&nbsp;<span class="op" id="5502120">==</span>&nbsp;<span class="num" id="5502123">0</span>&nbsp;<span class="op" id="5502125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5502134">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5502146">}</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5502153">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5502159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5502165">pix</span><span class="op" id="5502168">[</span><span class="ident" id="5502169">y</span><span class="op" id="5502170">*</span><span class="ident" id="5502171">stride</span><span class="op" id="5502177">+</span><span class="ident" id="5502178">x</span><span class="op" id="5502179">]</span>&nbsp;<span class="op" id="5502181">=</span>&nbsp;<span class="builtintype" id="5502183">byte</span><span class="op" id="5502187">(</span><span class="ident" id="5502188">bestIndex</span><span class="op" id="5502197">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5502204">if</span>&nbsp;<span class="op" id="5502207">!</span><span class="ident" id="5502208">floydSteinberg</span>&nbsp;<span class="op" id="5502223">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5502230">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5502243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5502249">er</span>&nbsp;<span class="op" id="5502252">-=</span>&nbsp;<span class="builtintype" id="5502255">int32</span><span class="op" id="5502260">(</span><span class="ident" id="5502261">palette</span><span class="op" id="5502268">[</span><span class="ident" id="5502269">bestIndex</span><span class="op" id="5502278">]</span><span class="op" id="5502279">[</span><span class="num" id="5502280">0</span><span class="op" id="5502281">]</span><span class="op" id="5502282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5502288">eg</span>&nbsp;<span class="op" id="5502291">-=</span>&nbsp;<span class="builtintype" id="5502294">int32</span><span class="op" id="5502299">(</span><span class="ident" id="5502300">palette</span><span class="op" id="5502307">[</span><span class="ident" id="5502308">bestIndex</span><span class="op" id="5502317">]</span><span class="op" id="5502318">[</span><span class="num" id="5502319">1</span><span class="op" id="5502320">]</span><span class="op" id="5502321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5502327">eb</span>&nbsp;<span class="op" id="5502330">-=</span>&nbsp;<span class="builtintype" id="5502333">int32</span><span class="op" id="5502338">(</span><span class="ident" id="5502339">palette</span><span class="op" id="5502346">[</span><span class="ident" id="5502347">bestIndex</span><span class="op" id="5502356">]</span><span class="op" id="5502357">[</span><span class="num" id="5502358">2</span><span class="op" id="5502359">]</span><span class="op" id="5502360">)</span><br>
<span class="lineno">630</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5502366">}</span>&nbsp;<span class="keyword" id="5502368">else</span>&nbsp;<span class="op" id="5502373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5502379">out</span><span class="op" id="5502382">.</span><span class="ident" id="5502383">R</span>&nbsp;<span class="op" id="5502385">=</span>&nbsp;<span class="builtintype" id="5502387">uint16</span><span class="op" id="5502393">(</span><span class="ident" id="5502394">er</span><span class="op" id="5502396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5502402">out</span><span class="op" id="5502405">.</span><span class="ident" id="5502406">G</span>&nbsp;<span class="op" id="5502408">=</span>&nbsp;<span class="builtintype" id="5502410">uint16</span><span class="op" id="5502416">(</span><span class="ident" id="5502417">eg</span><span class="op" id="5502419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5502425">out</span><span class="op" id="5502428">.</span><span class="ident" id="5502429">B</span>&nbsp;<span class="op" id="5502431">=</span>&nbsp;<span class="builtintype" id="5502433">uint16</span><span class="op" id="5502439">(</span><span class="ident" id="5502440">eb</span><span class="op" id="5502442">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5502448">//&nbsp;The&nbsp;third&nbsp;argument&nbsp;is&nbsp;&amp;out&nbsp;instead&nbsp;of&nbsp;out&nbsp;(and&nbsp;out&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5502509">//&nbsp;declared&nbsp;outside&nbsp;of&nbsp;the&nbsp;inner&nbsp;loop)&nbsp;to&nbsp;avoid&nbsp;the&nbsp;implicit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5502574">//&nbsp;conversion&nbsp;to&nbsp;color.Color&nbsp;here&nbsp;allocating&nbsp;memory&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5502637">//&nbsp;inner&nbsp;loop&nbsp;if&nbsp;sizeof(color.RGBA64)&nbsp;&gt;&nbsp;sizeof(uintptr).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5502698">dst</span><span class="op" id="5502701">.</span><span class="ident" id="5502702">Set</span><span class="op" id="5502705">(</span><span class="ident" id="5502706">r</span><span class="op" id="5502707">.</span><span class="ident" id="5502708">Min</span><span class="op" id="5502711">.</span><span class="ident" id="5502712">X</span><span class="op" id="5502713">+</span><span class="ident" id="5502714">x</span><span class="op" id="5502715">,</span>&nbsp;<span class="ident" id="5502717">r</span><span class="op" id="5502718">.</span><span class="ident" id="5502719">Min</span><span class="op" id="5502722">.</span><span class="ident" id="5502723">Y</span><span class="op" id="5502724">+</span><span class="ident" id="5502725">y</span><span class="op" id="5502726">,</span>&nbsp;<span class="op" id="5502728">&amp;</span><span class="ident" id="5502729">out</span><span class="op" id="5502732">)</span><br>
<span class="lineno">640</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5502739">if</span>&nbsp;<span class="op" id="5502742">!</span><span class="ident" id="5502743">floydSteinberg</span>&nbsp;<span class="op" id="5502758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5502765">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5502778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5502784">sr</span><span class="op" id="5502786">,</span>&nbsp;<span class="ident" id="5502788">sg</span><span class="op" id="5502790">,</span>&nbsp;<span class="ident" id="5502792">sb</span><span class="op" id="5502794">,</span>&nbsp;<span class="ident" id="5502796">_</span>&nbsp;<span class="op" id="5502798">=</span>&nbsp;<span class="ident" id="5502800">dst</span><span class="op" id="5502803">.</span><span class="ident" id="5502804">At</span><span class="op" id="5502806">(</span><span class="ident" id="5502807">r</span><span class="op" id="5502808">.</span><span class="ident" id="5502809">Min</span><span class="op" id="5502812">.</span><span class="ident" id="5502813">X</span><span class="op" id="5502814">+</span><span class="ident" id="5502815">x</span><span class="op" id="5502816">,</span>&nbsp;<span class="ident" id="5502818">r</span><span class="op" id="5502819">.</span><span class="ident" id="5502820">Min</span><span class="op" id="5502823">.</span><span class="ident" id="5502824">Y</span><span class="op" id="5502825">+</span><span class="ident" id="5502826">y</span><span class="op" id="5502827">)</span><span class="op" id="5502828">.</span><span class="ident" id="5502829">RGBA</span><span class="op" id="5502833">(</span><span class="op" id="5502834">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5502840">er</span>&nbsp;<span class="op" id="5502843">-=</span>&nbsp;<span class="builtintype" id="5502846">int32</span><span class="op" id="5502851">(</span><span class="ident" id="5502852">sr</span><span class="op" id="5502854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5502860">eg</span>&nbsp;<span class="op" id="5502863">-=</span>&nbsp;<span class="builtintype" id="5502866">int32</span><span class="op" id="5502871">(</span><span class="ident" id="5502872">sg</span><span class="op" id="5502874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5502880">eb</span>&nbsp;<span class="op" id="5502883">-=</span>&nbsp;<span class="builtintype" id="5502886">int32</span><span class="op" id="5502891">(</span><span class="ident" id="5502892">sb</span><span class="op" id="5502894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5502899">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5502905">//&nbsp;Propagate&nbsp;the&nbsp;Floyd-Steinberg&nbsp;quantization&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5502961">quantErrorNext</span><span class="op" id="5502975">[</span><span class="ident" id="5502976">x</span><span class="op" id="5502977">+</span><span class="num" id="5502978">0</span><span class="op" id="5502979">]</span><span class="op" id="5502980">[</span><span class="num" id="5502981">0</span><span class="op" id="5502982">]</span>&nbsp;<span class="op" id="5502984">+=</span>&nbsp;<span class="ident" id="5502987">er</span>&nbsp;<span class="op" id="5502990">*</span>&nbsp;<span class="num" id="5502992">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5502997">quantErrorNext</span><span class="op" id="5503011">[</span><span class="ident" id="5503012">x</span><span class="op" id="5503013">+</span><span class="num" id="5503014">0</span><span class="op" id="5503015">]</span><span class="op" id="5503016">[</span><span class="num" id="5503017">1</span><span class="op" id="5503018">]</span>&nbsp;<span class="op" id="5503020">+=</span>&nbsp;<span class="ident" id="5503023">eg</span>&nbsp;<span class="op" id="5503026">*</span>&nbsp;<span class="num" id="5503028">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503033">quantErrorNext</span><span class="op" id="5503047">[</span><span class="ident" id="5503048">x</span><span class="op" id="5503049">+</span><span class="num" id="5503050">0</span><span class="op" id="5503051">]</span><span class="op" id="5503052">[</span><span class="num" id="5503053">2</span><span class="op" id="5503054">]</span>&nbsp;<span class="op" id="5503056">+=</span>&nbsp;<span class="ident" id="5503059">eb</span>&nbsp;<span class="op" id="5503062">*</span>&nbsp;<span class="num" id="5503064">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503069">quantErrorNext</span><span class="op" id="5503083">[</span><span class="ident" id="5503084">x</span><span class="op" id="5503085">+</span><span class="num" id="5503086">1</span><span class="op" id="5503087">]</span><span class="op" id="5503088">[</span><span class="num" id="5503089">0</span><span class="op" id="5503090">]</span>&nbsp;<span class="op" id="5503092">+=</span>&nbsp;<span class="ident" id="5503095">er</span>&nbsp;<span class="op" id="5503098">*</span>&nbsp;<span class="num" id="5503100">5</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503105">quantErrorNext</span><span class="op" id="5503119">[</span><span class="ident" id="5503120">x</span><span class="op" id="5503121">+</span><span class="num" id="5503122">1</span><span class="op" id="5503123">]</span><span class="op" id="5503124">[</span><span class="num" id="5503125">1</span><span class="op" id="5503126">]</span>&nbsp;<span class="op" id="5503128">+=</span>&nbsp;<span class="ident" id="5503131">eg</span>&nbsp;<span class="op" id="5503134">*</span>&nbsp;<span class="num" id="5503136">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503141">quantErrorNext</span><span class="op" id="5503155">[</span><span class="ident" id="5503156">x</span><span class="op" id="5503157">+</span><span class="num" id="5503158">1</span><span class="op" id="5503159">]</span><span class="op" id="5503160">[</span><span class="num" id="5503161">2</span><span class="op" id="5503162">]</span>&nbsp;<span class="op" id="5503164">+=</span>&nbsp;<span class="ident" id="5503167">eb</span>&nbsp;<span class="op" id="5503170">*</span>&nbsp;<span class="num" id="5503172">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503177">quantErrorNext</span><span class="op" id="5503191">[</span><span class="ident" id="5503192">x</span><span class="op" id="5503193">+</span><span class="num" id="5503194">2</span><span class="op" id="5503195">]</span><span class="op" id="5503196">[</span><span class="num" id="5503197">0</span><span class="op" id="5503198">]</span>&nbsp;<span class="op" id="5503200">+=</span>&nbsp;<span class="ident" id="5503203">er</span>&nbsp;<span class="op" id="5503206">*</span>&nbsp;<span class="num" id="5503208">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503213">quantErrorNext</span><span class="op" id="5503227">[</span><span class="ident" id="5503228">x</span><span class="op" id="5503229">+</span><span class="num" id="5503230">2</span><span class="op" id="5503231">]</span><span class="op" id="5503232">[</span><span class="num" id="5503233">1</span><span class="op" id="5503234">]</span>&nbsp;<span class="op" id="5503236">+=</span>&nbsp;<span class="ident" id="5503239">eg</span>&nbsp;<span class="op" id="5503242">*</span>&nbsp;<span class="num" id="5503244">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503249">quantErrorNext</span><span class="op" id="5503263">[</span><span class="ident" id="5503264">x</span><span class="op" id="5503265">+</span><span class="num" id="5503266">2</span><span class="op" id="5503267">]</span><span class="op" id="5503268">[</span><span class="num" id="5503269">2</span><span class="op" id="5503270">]</span>&nbsp;<span class="op" id="5503272">+=</span>&nbsp;<span class="ident" id="5503275">eb</span>&nbsp;<span class="op" id="5503278">*</span>&nbsp;<span class="num" id="5503280">1</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503285">quantErrorCurr</span><span class="op" id="5503299">[</span><span class="ident" id="5503300">x</span><span class="op" id="5503301">+</span><span class="num" id="5503302">2</span><span class="op" id="5503303">]</span><span class="op" id="5503304">[</span><span class="num" id="5503305">0</span><span class="op" id="5503306">]</span>&nbsp;<span class="op" id="5503308">+=</span>&nbsp;<span class="ident" id="5503311">er</span>&nbsp;<span class="op" id="5503314">*</span>&nbsp;<span class="num" id="5503316">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503321">quantErrorCurr</span><span class="op" id="5503335">[</span><span class="ident" id="5503336">x</span><span class="op" id="5503337">+</span><span class="num" id="5503338">2</span><span class="op" id="5503339">]</span><span class="op" id="5503340">[</span><span class="num" id="5503341">1</span><span class="op" id="5503342">]</span>&nbsp;<span class="op" id="5503344">+=</span>&nbsp;<span class="ident" id="5503347">eg</span>&nbsp;<span class="op" id="5503350">*</span>&nbsp;<span class="num" id="5503352">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503357">quantErrorCurr</span><span class="op" id="5503371">[</span><span class="ident" id="5503372">x</span><span class="op" id="5503373">+</span><span class="num" id="5503374">2</span><span class="op" id="5503375">]</span><span class="op" id="5503376">[</span><span class="num" id="5503377">2</span><span class="op" id="5503378">]</span>&nbsp;<span class="op" id="5503380">+=</span>&nbsp;<span class="ident" id="5503383">eb</span>&nbsp;<span class="op" id="5503386">*</span>&nbsp;<span class="num" id="5503388">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5503392">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5503397">//&nbsp;Recycle&nbsp;the&nbsp;quantization&nbsp;error&nbsp;buffers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5503442">if</span>&nbsp;<span class="ident" id="5503445">floydSteinberg</span>&nbsp;<span class="op" id="5503460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503465">quantErrorCurr</span><span class="op" id="5503479">,</span>&nbsp;<span class="ident" id="5503481">quantErrorNext</span>&nbsp;<span class="op" id="5503496">=</span>&nbsp;<span class="ident" id="5503498">quantErrorNext</span><span class="op" id="5503512">,</span>&nbsp;<span class="ident" id="5503514">quantErrorCurr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5503532">for</span>&nbsp;<span class="ident" id="5503536">i</span>&nbsp;<span class="op" id="5503538">:=</span>&nbsp;<span class="keyword" id="5503541">range</span>&nbsp;<span class="ident" id="5503547">quantErrorNext</span>&nbsp;<span class="op" id="5503562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503568">quantErrorNext</span><span class="op" id="5503582">[</span><span class="ident" id="5503583">i</span><span class="op" id="5503584">]</span>&nbsp;<span class="op" id="5503586">=</span>&nbsp;<span class="op" id="5503588">[</span><span class="num" id="5503589">3</span><span class="op" id="5503590">]</span><span class="builtintype" id="5503591">int32</span><span class="op" id="5503596">{</span><span class="op" id="5503597">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5503602">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5503606">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5503609">}</span><br>
<span class="lineno"></span><span class="op" id="5503611">}</span>
</div>
</body>
</html>
