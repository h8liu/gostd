<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>expvar</h2>
<ul>
<li><a href="/gostd/expvar/expvar.go.html" class="current">expvar.go</a></li>
<li><a href="/gostd/expvar/expvar_test.go.html">expvar_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6177924">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6177979">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6178033">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6178084">//&nbsp;Package&nbsp;expvar&nbsp;provides&nbsp;a&nbsp;standardized&nbsp;interface&nbsp;to&nbsp;public&nbsp;variables,&nbsp;such</span><br>
<span class="lineno"></span><span class="comment" id="6178162">//&nbsp;as&nbsp;operation&nbsp;counters&nbsp;in&nbsp;servers.&nbsp;It&nbsp;exposes&nbsp;these&nbsp;variables&nbsp;via&nbsp;HTTP&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="6178238">//&nbsp;/debug/vars&nbsp;in&nbsp;JSON&nbsp;format.</span><br>
<span class="lineno"></span><span class="comment" id="6178269">//</span><br>
<span class="lineno"></span><span class="comment" id="6178272">//&nbsp;Operations&nbsp;to&nbsp;set&nbsp;or&nbsp;modify&nbsp;these&nbsp;public&nbsp;variables&nbsp;are&nbsp;atomic.</span><br>
<span class="lineno">10</span><span class="comment" id="6178338">//</span><br>
<span class="lineno"></span><span class="comment" id="6178341">//&nbsp;In&nbsp;addition&nbsp;to&nbsp;adding&nbsp;the&nbsp;HTTP&nbsp;handler,&nbsp;this&nbsp;package&nbsp;registers&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6178411">//&nbsp;following&nbsp;variables:</span><br>
<span class="lineno"></span><span class="comment" id="6178435">//</span><br>
<span class="lineno"></span><span class="comment" id="6178438">//&nbsp;&nbsp;&nbsp;&nbsp;cmdline&nbsp;&nbsp;&nbsp;os.Args</span><br>
<span class="lineno">15</span><span class="comment" id="6178459">//&nbsp;&nbsp;&nbsp;&nbsp;memstats&nbsp;&nbsp;runtime.Memstats</span><br>
<span class="lineno"></span><span class="comment" id="6178489">//</span><br>
<span class="lineno"></span><span class="comment" id="6178492">//&nbsp;The&nbsp;package&nbsp;is&nbsp;sometimes&nbsp;only&nbsp;imported&nbsp;for&nbsp;the&nbsp;side&nbsp;effect&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="6178557">//&nbsp;registering&nbsp;its&nbsp;HTTP&nbsp;handler&nbsp;and&nbsp;the&nbsp;above&nbsp;variables.&nbsp;&nbsp;To&nbsp;use&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="6178625">//&nbsp;this&nbsp;way,&nbsp;link&nbsp;this&nbsp;package&nbsp;into&nbsp;your&nbsp;program:</span><br>
<span class="lineno">20</span><span class="comment" id="6178675">//&nbsp;&nbsp;&nbsp;&nbsp;import&nbsp;_&nbsp;&#34;expvar&#34;</span><br>
<span class="lineno"></span><span class="comment" id="6178696">//</span><br>
<span class="lineno"></span><span class="keyword" id="6178699">package</span>&nbsp;<span class="ident" id="6178707">expvar</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6178715">import</span>&nbsp;<span class="op" id="6178722">(</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6178725">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6178734">&#34;encoding/json&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6178751">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6178758">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6178765">&#34;net/http&#34;</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6178777">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6178783">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6178794">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6178802">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6178813">&#34;sync&#34;</span><br>
<span class="lineno">35</span><span class="op" id="6178820">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6178823">//&nbsp;Var&nbsp;is&nbsp;an&nbsp;abstract&nbsp;type&nbsp;for&nbsp;all&nbsp;exported&nbsp;variables.</span><br>
<span class="lineno"></span><span class="keyword" id="6178878">type</span>&nbsp;<span class="ident" id="6178883">Var</span>&nbsp;<span class="keyword" id="6178887">interface</span>&nbsp;<span class="op" id="6178897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6178900">String</span><span class="op" id="6178906">(</span><span class="op" id="6178907">)</span>&nbsp;<span class="builtintype" id="6178909">string</span><br>
<span class="lineno">40</span><span class="op" id="6178916">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6178919">//&nbsp;Int&nbsp;is&nbsp;a&nbsp;64-bit&nbsp;integer&nbsp;variable&nbsp;that&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6178989">type</span>&nbsp;<span class="ident" id="6178994">Int</span>&nbsp;<span class="keyword" id="6178998">struct</span>&nbsp;<span class="op" id="6179005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6179008">mu</span>&nbsp;<span class="ident" id="6179011">sync</span><span class="op" id="6179015">.</span><span class="ident" id="6179016">RWMutex</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6179025">i</span>&nbsp;&nbsp;<span class="ident" id="6179028">int64</span><br>
<span class="lineno"></span><span class="op" id="6179034">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6179037">func</span>&nbsp;<span class="op" id="6179042">(</span><span class="ident" id="6179043">v</span>&nbsp;<span class="op" id="6179045">*</span><span class="ident" id="6179046">Int</span><span class="op" id="6179049">)</span>&nbsp;<span class="ident" id="6179051">String</span><span class="op" id="6179057">(</span><span class="op" id="6179058">)</span>&nbsp;<span class="builtintype" id="6179060">string</span>&nbsp;<span class="op" id="6179067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6179070">v</span><span class="op" id="6179071">.</span><span class="ident" id="6179072">mu</span><span class="op" id="6179074">.</span><span class="ident" id="6179075">RLock</span><span class="op" id="6179080">(</span><span class="op" id="6179081">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6179084">defer</span>&nbsp;<span class="ident" id="6179090">v</span><span class="op" id="6179091">.</span><span class="ident" id="6179092">mu</span><span class="op" id="6179094">.</span><span class="ident" id="6179095">RUnlock</span><span class="op" id="6179102">(</span><span class="op" id="6179103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6179106">return</span>&nbsp;<span class="ident" id="6179113">strconv</span><span class="op" id="6179120">.</span><span class="ident" id="6179121">FormatInt</span><span class="op" id="6179130">(</span><span class="ident" id="6179131">v</span><span class="op" id="6179132">.</span><span class="ident" id="6179133">i</span><span class="op" id="6179134">,</span>&nbsp;<span class="num" id="6179136">10</span><span class="op" id="6179138">)</span><br>
<span class="lineno"></span><span class="op" id="6179140">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6179143">func</span>&nbsp;<span class="op" id="6179148">(</span><span class="ident" id="6179149">v</span>&nbsp;<span class="op" id="6179151">*</span><span class="ident" id="6179152">Int</span><span class="op" id="6179155">)</span>&nbsp;<span class="ident" id="6179157">Add</span><span class="op" id="6179160">(</span><span class="ident" id="6179161">delta</span>&nbsp;<span class="ident" id="6179167">int64</span><span class="op" id="6179172">)</span>&nbsp;<span class="op" id="6179174">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6179177">v</span><span class="op" id="6179178">.</span><span class="ident" id="6179179">mu</span><span class="op" id="6179181">.</span><span class="ident" id="6179182">Lock</span><span class="op" id="6179186">(</span><span class="op" id="6179187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6179190">defer</span>&nbsp;<span class="ident" id="6179196">v</span><span class="op" id="6179197">.</span><span class="ident" id="6179198">mu</span><span class="op" id="6179200">.</span><span class="ident" id="6179201">Unlock</span><span class="op" id="6179207">(</span><span class="op" id="6179208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6179211">v</span><span class="op" id="6179212">.</span><span class="ident" id="6179213">i</span>&nbsp;<span class="op" id="6179215">+=</span>&nbsp;<span class="ident" id="6179218">delta</span><br>
<span class="lineno"></span><span class="op" id="6179224">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="6179227">func</span>&nbsp;<span class="op" id="6179232">(</span><span class="ident" id="6179233">v</span>&nbsp;<span class="op" id="6179235">*</span><span class="ident" id="6179236">Int</span><span class="op" id="6179239">)</span>&nbsp;<span class="ident" id="6179241">Set</span><span class="op" id="6179244">(</span><span class="ident" id="6179245">value</span>&nbsp;<span class="ident" id="6179251">int64</span><span class="op" id="6179256">)</span>&nbsp;<span class="op" id="6179258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6179261">v</span><span class="op" id="6179262">.</span><span class="ident" id="6179263">mu</span><span class="op" id="6179265">.</span><span class="ident" id="6179266">Lock</span><span class="op" id="6179270">(</span><span class="op" id="6179271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6179274">defer</span>&nbsp;<span class="ident" id="6179280">v</span><span class="op" id="6179281">.</span><span class="ident" id="6179282">mu</span><span class="op" id="6179284">.</span><span class="ident" id="6179285">Unlock</span><span class="op" id="6179291">(</span><span class="op" id="6179292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6179295">v</span><span class="op" id="6179296">.</span><span class="ident" id="6179297">i</span>&nbsp;<span class="op" id="6179299">=</span>&nbsp;<span class="ident" id="6179301">value</span><br>
<span class="lineno"></span><span class="op" id="6179307">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="6179310">//&nbsp;Float&nbsp;is&nbsp;a&nbsp;64-bit&nbsp;float&nbsp;variable&nbsp;that&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6179380">type</span>&nbsp;<span class="ident" id="6179385">Float</span>&nbsp;<span class="keyword" id="6179391">struct</span>&nbsp;<span class="op" id="6179398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6179401">mu</span>&nbsp;<span class="ident" id="6179404">sync</span><span class="op" id="6179408">.</span><span class="ident" id="6179409">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6179418">f</span>&nbsp;&nbsp;<span class="builtintype" id="6179421">float64</span><br>
<span class="lineno">70</span><span class="op" id="6179429">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6179432">func</span>&nbsp;<span class="op" id="6179437">(</span><span class="ident" id="6179438">v</span>&nbsp;<span class="op" id="6179440">*</span><span class="ident" id="6179441">Float</span><span class="op" id="6179446">)</span>&nbsp;<span class="ident" id="6179448">String</span><span class="op" id="6179454">(</span><span class="op" id="6179455">)</span>&nbsp;<span class="builtintype" id="6179457">string</span>&nbsp;<span class="op" id="6179464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6179467">v</span><span class="op" id="6179468">.</span><span class="ident" id="6179469">mu</span><span class="op" id="6179471">.</span><span class="ident" id="6179472">RLock</span><span class="op" id="6179477">(</span><span class="op" id="6179478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6179481">defer</span>&nbsp;<span class="ident" id="6179487">v</span><span class="op" id="6179488">.</span><span class="ident" id="6179489">mu</span><span class="op" id="6179491">.</span><span class="ident" id="6179492">RUnlock</span><span class="op" id="6179499">(</span><span class="op" id="6179500">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6179503">return</span>&nbsp;<span class="ident" id="6179510">strconv</span><span class="op" id="6179517">.</span><span class="ident" id="6179518">FormatFloat</span><span class="op" id="6179529">(</span><span class="ident" id="6179530">v</span><span class="op" id="6179531">.</span><span class="ident" id="6179532">f</span><span class="op" id="6179533">,</span>&nbsp;<span class="string" id="6179535">&#39;g&#39;</span><span class="op" id="6179538">,</span>&nbsp;<span class="op" id="6179540">-</span><span class="num" id="6179541">1</span><span class="op" id="6179542">,</span>&nbsp;<span class="num" id="6179544">64</span><span class="op" id="6179546">)</span><br>
<span class="lineno"></span><span class="op" id="6179548">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6179551">//&nbsp;Add&nbsp;adds&nbsp;delta&nbsp;to&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="6179575">func</span>&nbsp;<span class="op" id="6179580">(</span><span class="ident" id="6179581">v</span>&nbsp;<span class="op" id="6179583">*</span><span class="ident" id="6179584">Float</span><span class="op" id="6179589">)</span>&nbsp;<span class="ident" id="6179591">Add</span><span class="op" id="6179594">(</span><span class="ident" id="6179595">delta</span>&nbsp;<span class="builtintype" id="6179601">float64</span><span class="op" id="6179608">)</span>&nbsp;<span class="op" id="6179610">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6179613">v</span><span class="op" id="6179614">.</span><span class="ident" id="6179615">mu</span><span class="op" id="6179617">.</span><span class="ident" id="6179618">Lock</span><span class="op" id="6179622">(</span><span class="op" id="6179623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6179626">defer</span>&nbsp;<span class="ident" id="6179632">v</span><span class="op" id="6179633">.</span><span class="ident" id="6179634">mu</span><span class="op" id="6179636">.</span><span class="ident" id="6179637">Unlock</span><span class="op" id="6179643">(</span><span class="op" id="6179644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6179647">v</span><span class="op" id="6179648">.</span><span class="ident" id="6179649">f</span>&nbsp;<span class="op" id="6179651">+=</span>&nbsp;<span class="ident" id="6179654">delta</span><br>
<span class="lineno"></span><span class="op" id="6179660">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="comment" id="6179663">//&nbsp;Set&nbsp;sets&nbsp;v&nbsp;to&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="6179687">func</span>&nbsp;<span class="op" id="6179692">(</span><span class="ident" id="6179693">v</span>&nbsp;<span class="op" id="6179695">*</span><span class="ident" id="6179696">Float</span><span class="op" id="6179701">)</span>&nbsp;<span class="ident" id="6179703">Set</span><span class="op" id="6179706">(</span><span class="ident" id="6179707">value</span>&nbsp;<span class="builtintype" id="6179713">float64</span><span class="op" id="6179720">)</span>&nbsp;<span class="op" id="6179722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6179725">v</span><span class="op" id="6179726">.</span><span class="ident" id="6179727">mu</span><span class="op" id="6179729">.</span><span class="ident" id="6179730">Lock</span><span class="op" id="6179734">(</span><span class="op" id="6179735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6179738">defer</span>&nbsp;<span class="ident" id="6179744">v</span><span class="op" id="6179745">.</span><span class="ident" id="6179746">mu</span><span class="op" id="6179748">.</span><span class="ident" id="6179749">Unlock</span><span class="op" id="6179755">(</span><span class="op" id="6179756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6179759">v</span><span class="op" id="6179760">.</span><span class="ident" id="6179761">f</span>&nbsp;<span class="op" id="6179763">=</span>&nbsp;<span class="ident" id="6179765">value</span><br>
<span class="lineno">90</span><span class="op" id="6179771">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6179774">//&nbsp;Map&nbsp;is&nbsp;a&nbsp;string-to-Var&nbsp;map&nbsp;variable&nbsp;that&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6179847">type</span>&nbsp;<span class="ident" id="6179852">Map</span>&nbsp;<span class="keyword" id="6179856">struct</span>&nbsp;<span class="op" id="6179863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6179866">mu</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6179871">sync</span><span class="op" id="6179875">.</span><span class="ident" id="6179876">RWMutex</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6179885">m</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6179890">map</span><span class="op" id="6179893">[</span><span class="builtintype" id="6179894">string</span><span class="op" id="6179900">]</span><span class="ident" id="6179901">Var</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6179906">keys</span>&nbsp;<span class="op" id="6179911">[</span><span class="op" id="6179912">]</span><span class="builtintype" id="6179913">string</span>&nbsp;<span class="comment" id="6179920">//&nbsp;sorted</span><br>
<span class="lineno"></span><span class="op" id="6179930">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6179933">//&nbsp;KeyValue&nbsp;represents&nbsp;a&nbsp;single&nbsp;entry&nbsp;in&nbsp;a&nbsp;Map.</span><br>
<span class="lineno">100</span><span class="keyword" id="6179981">type</span>&nbsp;<span class="ident" id="6179986">KeyValue</span>&nbsp;<span class="keyword" id="6179995">struct</span>&nbsp;<span class="op" id="6180002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6180005">Key</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6180011">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6180019">Value</span>&nbsp;<span class="ident" id="6180025">Var</span><br>
<span class="lineno"></span><span class="op" id="6180029">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="6180032">func</span>&nbsp;<span class="op" id="6180037">(</span><span class="ident" id="6180038">v</span>&nbsp;<span class="op" id="6180040">*</span><span class="ident" id="6180041">Map</span><span class="op" id="6180044">)</span>&nbsp;<span class="ident" id="6180046">String</span><span class="op" id="6180052">(</span><span class="op" id="6180053">)</span>&nbsp;<span class="builtintype" id="6180055">string</span>&nbsp;<span class="op" id="6180062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6180065">v</span><span class="op" id="6180066">.</span><span class="ident" id="6180067">mu</span><span class="op" id="6180069">.</span><span class="ident" id="6180070">RLock</span><span class="op" id="6180075">(</span><span class="op" id="6180076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6180079">defer</span>&nbsp;<span class="ident" id="6180085">v</span><span class="op" id="6180086">.</span><span class="ident" id="6180087">mu</span><span class="op" id="6180089">.</span><span class="ident" id="6180090">RUnlock</span><span class="op" id="6180097">(</span><span class="op" id="6180098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6180101">var</span>&nbsp;<span class="ident" id="6180105">b</span>&nbsp;<span class="ident" id="6180107">bytes</span><span class="op" id="6180112">.</span><span class="ident" id="6180113">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6180121">fmt</span><span class="op" id="6180124">.</span><span class="ident" id="6180125">Fprintf</span><span class="op" id="6180132">(</span><span class="op" id="6180133">&amp;</span><span class="ident" id="6180134">b</span><span class="op" id="6180135">,</span>&nbsp;<span class="string" id="6180137">&#34;{&#34;</span><span class="op" id="6180140">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6180143">first</span>&nbsp;<span class="op" id="6180149">:=</span>&nbsp;<span class="builtintype" id="6180152">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6180158">v</span><span class="op" id="6180159">.</span><span class="ident" id="6180160">doLocked</span><span class="op" id="6180168">(</span><span class="keyword" id="6180169">func</span><span class="op" id="6180173">(</span><span class="ident" id="6180174">kv</span>&nbsp;<span class="ident" id="6180177">KeyValue</span><span class="op" id="6180185">)</span>&nbsp;<span class="op" id="6180187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6180191">if</span>&nbsp;<span class="op" id="6180194">!</span><span class="ident" id="6180195">first</span>&nbsp;<span class="op" id="6180201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6180206">fmt</span><span class="op" id="6180209">.</span><span class="ident" id="6180210">Fprintf</span><span class="op" id="6180217">(</span><span class="op" id="6180218">&amp;</span><span class="ident" id="6180219">b</span><span class="op" id="6180220">,</span>&nbsp;<span class="string" id="6180222">&#34;,&nbsp;&#34;</span><span class="op" id="6180226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6180230">}</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6180234">fmt</span><span class="op" id="6180237">.</span><span class="ident" id="6180238">Fprintf</span><span class="op" id="6180245">(</span><span class="op" id="6180246">&amp;</span><span class="ident" id="6180247">b</span><span class="op" id="6180248">,</span>&nbsp;<span class="string" id="6180250">&#34;%q:&nbsp;%v&#34;</span><span class="op" id="6180258">,</span>&nbsp;<span class="ident" id="6180260">kv</span><span class="op" id="6180262">.</span><span class="ident" id="6180263">Key</span><span class="op" id="6180266">,</span>&nbsp;<span class="ident" id="6180268">kv</span><span class="op" id="6180270">.</span><span class="ident" id="6180271">Value</span><span class="op" id="6180276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6180280">first</span>&nbsp;<span class="op" id="6180286">=</span>&nbsp;<span class="builtintype" id="6180288">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6180295">}</span><span class="op" id="6180296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6180299">fmt</span><span class="op" id="6180302">.</span><span class="ident" id="6180303">Fprintf</span><span class="op" id="6180310">(</span><span class="op" id="6180311">&amp;</span><span class="ident" id="6180312">b</span><span class="op" id="6180313">,</span>&nbsp;<span class="string" id="6180315">&#34;}&#34;</span><span class="op" id="6180318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6180321">return</span>&nbsp;<span class="ident" id="6180328">b</span><span class="op" id="6180329">.</span><span class="ident" id="6180330">String</span><span class="op" id="6180336">(</span><span class="op" id="6180337">)</span><br>
<span class="lineno">120</span><span class="op" id="6180339">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6180342">func</span>&nbsp;<span class="op" id="6180347">(</span><span class="ident" id="6180348">v</span>&nbsp;<span class="op" id="6180350">*</span><span class="ident" id="6180351">Map</span><span class="op" id="6180354">)</span>&nbsp;<span class="ident" id="6180356">Init</span><span class="op" id="6180360">(</span><span class="op" id="6180361">)</span>&nbsp;<span class="op" id="6180363">*</span><span class="ident" id="6180364">Map</span>&nbsp;<span class="op" id="6180368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6180371">v</span><span class="op" id="6180372">.</span><span class="ident" id="6180373">m</span>&nbsp;<span class="op" id="6180375">=</span>&nbsp;<span class="builtinfunc" id="6180377">make</span><span class="op" id="6180381">(</span><span class="keyword" id="6180382">map</span><span class="op" id="6180385">[</span><span class="builtintype" id="6180386">string</span><span class="op" id="6180392">]</span><span class="ident" id="6180393">Var</span><span class="op" id="6180396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6180399">return</span>&nbsp;<span class="ident" id="6180406">v</span><br>
<span class="lineno">125</span><span class="op" id="6180408">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6180411">//&nbsp;updateKeys&nbsp;updates&nbsp;the&nbsp;sorted&nbsp;list&nbsp;of&nbsp;keys&nbsp;in&nbsp;v.keys.</span><br>
<span class="lineno"></span><span class="comment" id="6180468">//&nbsp;must&nbsp;be&nbsp;called&nbsp;with&nbsp;v.mu&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword" id="6180502">func</span>&nbsp;<span class="op" id="6180507">(</span><span class="ident" id="6180508">v</span>&nbsp;<span class="op" id="6180510">*</span><span class="ident" id="6180511">Map</span><span class="op" id="6180514">)</span>&nbsp;<span class="ident" id="6180516">updateKeys</span><span class="op" id="6180526">(</span><span class="op" id="6180527">)</span>&nbsp;<span class="op" id="6180529">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6180532">if</span>&nbsp;<span class="builtinfunc" id="6180535">len</span><span class="op" id="6180538">(</span><span class="ident" id="6180539">v</span><span class="op" id="6180540">.</span><span class="ident" id="6180541">m</span><span class="op" id="6180542">)</span>&nbsp;<span class="op" id="6180544">==</span>&nbsp;<span class="builtinfunc" id="6180547">len</span><span class="op" id="6180550">(</span><span class="ident" id="6180551">v</span><span class="op" id="6180552">.</span><span class="ident" id="6180553">keys</span><span class="op" id="6180557">)</span>&nbsp;<span class="op" id="6180559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6180563">//&nbsp;No&nbsp;new&nbsp;key.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6180580">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6180588">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6180591">v</span><span class="op" id="6180592">.</span><span class="ident" id="6180593">keys</span>&nbsp;<span class="op" id="6180598">=</span>&nbsp;<span class="ident" id="6180600">v</span><span class="op" id="6180601">.</span><span class="ident" id="6180602">keys</span><span class="op" id="6180606">[</span><span class="op" id="6180607">:</span><span class="num" id="6180608">0</span><span class="op" id="6180609">]</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6180612">for</span>&nbsp;<span class="ident" id="6180616">k</span>&nbsp;<span class="op" id="6180618">:=</span>&nbsp;<span class="keyword" id="6180621">range</span>&nbsp;<span class="ident" id="6180627">v</span><span class="op" id="6180628">.</span><span class="ident" id="6180629">m</span>&nbsp;<span class="op" id="6180631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6180635">v</span><span class="op" id="6180636">.</span><span class="ident" id="6180637">keys</span>&nbsp;<span class="op" id="6180642">=</span>&nbsp;<span class="builtinfunc" id="6180644">append</span><span class="op" id="6180650">(</span><span class="ident" id="6180651">v</span><span class="op" id="6180652">.</span><span class="ident" id="6180653">keys</span><span class="op" id="6180657">,</span>&nbsp;<span class="ident" id="6180659">k</span><span class="op" id="6180660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6180663">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6180666">sort</span><span class="op" id="6180670">.</span><span class="ident" id="6180671">Strings</span><span class="op" id="6180678">(</span><span class="ident" id="6180679">v</span><span class="op" id="6180680">.</span><span class="ident" id="6180681">keys</span><span class="op" id="6180685">)</span><br>
<span class="lineno"></span><span class="op" id="6180687">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="keyword" id="6180690">func</span>&nbsp;<span class="op" id="6180695">(</span><span class="ident" id="6180696">v</span>&nbsp;<span class="op" id="6180698">*</span><span class="ident" id="6180699">Map</span><span class="op" id="6180702">)</span>&nbsp;<span class="ident" id="6180704">Get</span><span class="op" id="6180707">(</span><span class="ident" id="6180708">key</span>&nbsp;<span class="builtintype" id="6180712">string</span><span class="op" id="6180718">)</span>&nbsp;<span class="ident" id="6180720">Var</span>&nbsp;<span class="op" id="6180724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6180727">v</span><span class="op" id="6180728">.</span><span class="ident" id="6180729">mu</span><span class="op" id="6180731">.</span><span class="ident" id="6180732">RLock</span><span class="op" id="6180737">(</span><span class="op" id="6180738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6180741">defer</span>&nbsp;<span class="ident" id="6180747">v</span><span class="op" id="6180748">.</span><span class="ident" id="6180749">mu</span><span class="op" id="6180751">.</span><span class="ident" id="6180752">RUnlock</span><span class="op" id="6180759">(</span><span class="op" id="6180760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6180763">return</span>&nbsp;<span class="ident" id="6180770">v</span><span class="op" id="6180771">.</span><span class="ident" id="6180772">m</span><span class="op" id="6180773">[</span><span class="ident" id="6180774">key</span><span class="op" id="6180777">]</span><br>
<span class="lineno">145</span><span class="op" id="6180779">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6180782">func</span>&nbsp;<span class="op" id="6180787">(</span><span class="ident" id="6180788">v</span>&nbsp;<span class="op" id="6180790">*</span><span class="ident" id="6180791">Map</span><span class="op" id="6180794">)</span>&nbsp;<span class="ident" id="6180796">Set</span><span class="op" id="6180799">(</span><span class="ident" id="6180800">key</span>&nbsp;<span class="builtintype" id="6180804">string</span><span class="op" id="6180810">,</span>&nbsp;<span class="ident" id="6180812">av</span>&nbsp;<span class="ident" id="6180815">Var</span><span class="op" id="6180818">)</span>&nbsp;<span class="op" id="6180820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6180823">v</span><span class="op" id="6180824">.</span><span class="ident" id="6180825">mu</span><span class="op" id="6180827">.</span><span class="ident" id="6180828">Lock</span><span class="op" id="6180832">(</span><span class="op" id="6180833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6180836">defer</span>&nbsp;<span class="ident" id="6180842">v</span><span class="op" id="6180843">.</span><span class="ident" id="6180844">mu</span><span class="op" id="6180846">.</span><span class="ident" id="6180847">Unlock</span><span class="op" id="6180853">(</span><span class="op" id="6180854">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6180857">v</span><span class="op" id="6180858">.</span><span class="ident" id="6180859">m</span><span class="op" id="6180860">[</span><span class="ident" id="6180861">key</span><span class="op" id="6180864">]</span>&nbsp;<span class="op" id="6180866">=</span>&nbsp;<span class="ident" id="6180868">av</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6180872">v</span><span class="op" id="6180873">.</span><span class="ident" id="6180874">updateKeys</span><span class="op" id="6180884">(</span><span class="op" id="6180885">)</span><br>
<span class="lineno"></span><span class="op" id="6180887">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6180890">func</span>&nbsp;<span class="op" id="6180895">(</span><span class="ident" id="6180896">v</span>&nbsp;<span class="op" id="6180898">*</span><span class="ident" id="6180899">Map</span><span class="op" id="6180902">)</span>&nbsp;<span class="ident" id="6180904">Add</span><span class="op" id="6180907">(</span><span class="ident" id="6180908">key</span>&nbsp;<span class="builtintype" id="6180912">string</span><span class="op" id="6180918">,</span>&nbsp;<span class="ident" id="6180920">delta</span>&nbsp;<span class="ident" id="6180926">int64</span><span class="op" id="6180931">)</span>&nbsp;<span class="op" id="6180933">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6180936">v</span><span class="op" id="6180937">.</span><span class="ident" id="6180938">mu</span><span class="op" id="6180940">.</span><span class="ident" id="6180941">RLock</span><span class="op" id="6180946">(</span><span class="op" id="6180947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6180950">av</span><span class="op" id="6180952">,</span>&nbsp;<span class="ident" id="6180954">ok</span>&nbsp;<span class="op" id="6180957">:=</span>&nbsp;<span class="ident" id="6180960">v</span><span class="op" id="6180961">.</span><span class="ident" id="6180962">m</span><span class="op" id="6180963">[</span><span class="ident" id="6180964">key</span><span class="op" id="6180967">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6180970">v</span><span class="op" id="6180971">.</span><span class="ident" id="6180972">mu</span><span class="op" id="6180974">.</span><span class="ident" id="6180975">RUnlock</span><span class="op" id="6180982">(</span><span class="op" id="6180983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6180986">if</span>&nbsp;<span class="op" id="6180989">!</span><span class="ident" id="6180990">ok</span>&nbsp;<span class="op" id="6180993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6180997">//&nbsp;check&nbsp;again&nbsp;under&nbsp;the&nbsp;write&nbsp;lock</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181035">v</span><span class="op" id="6181036">.</span><span class="ident" id="6181037">mu</span><span class="op" id="6181039">.</span><span class="ident" id="6181040">Lock</span><span class="op" id="6181044">(</span><span class="op" id="6181045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181049">av</span><span class="op" id="6181051">,</span>&nbsp;<span class="ident" id="6181053">ok</span>&nbsp;<span class="op" id="6181056">=</span>&nbsp;<span class="ident" id="6181058">v</span><span class="op" id="6181059">.</span><span class="ident" id="6181060">m</span><span class="op" id="6181061">[</span><span class="ident" id="6181062">key</span><span class="op" id="6181065">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6181069">if</span>&nbsp;<span class="op" id="6181072">!</span><span class="ident" id="6181073">ok</span>&nbsp;<span class="op" id="6181076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181081">av</span>&nbsp;<span class="op" id="6181084">=</span>&nbsp;<span class="builtinfunc" id="6181086">new</span><span class="op" id="6181089">(</span><span class="ident" id="6181090">Int</span><span class="op" id="6181093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181098">v</span><span class="op" id="6181099">.</span><span class="ident" id="6181100">m</span><span class="op" id="6181101">[</span><span class="ident" id="6181102">key</span><span class="op" id="6181105">]</span>&nbsp;<span class="op" id="6181107">=</span>&nbsp;<span class="ident" id="6181109">av</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181115">v</span><span class="op" id="6181116">.</span><span class="ident" id="6181117">updateKeys</span><span class="op" id="6181127">(</span><span class="op" id="6181128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6181132">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181136">v</span><span class="op" id="6181137">.</span><span class="ident" id="6181138">mu</span><span class="op" id="6181140">.</span><span class="ident" id="6181141">Unlock</span><span class="op" id="6181147">(</span><span class="op" id="6181148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6181151">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6181155">//&nbsp;Add&nbsp;to&nbsp;Int;&nbsp;ignore&nbsp;otherwise.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6181189">if</span>&nbsp;<span class="ident" id="6181192">iv</span><span class="op" id="6181194">,</span>&nbsp;<span class="ident" id="6181196">ok</span>&nbsp;<span class="op" id="6181199">:=</span>&nbsp;<span class="ident" id="6181202">av</span><span class="op" id="6181204">.</span><span class="op" id="6181205">(</span><span class="op" id="6181206">*</span><span class="ident" id="6181207">Int</span><span class="op" id="6181210">)</span><span class="op" id="6181211">;</span>&nbsp;<span class="ident" id="6181213">ok</span>&nbsp;<span class="op" id="6181216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181220">iv</span><span class="op" id="6181222">.</span><span class="ident" id="6181223">Add</span><span class="op" id="6181226">(</span><span class="ident" id="6181227">delta</span><span class="op" id="6181232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6181235">}</span><br>
<span class="lineno"></span><span class="op" id="6181237">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span><span class="comment" id="6181240">//&nbsp;AddFloat&nbsp;adds&nbsp;delta&nbsp;to&nbsp;the&nbsp;*Float&nbsp;value&nbsp;stored&nbsp;under&nbsp;the&nbsp;given&nbsp;map&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="6181315">func</span>&nbsp;<span class="op" id="6181320">(</span><span class="ident" id="6181321">v</span>&nbsp;<span class="op" id="6181323">*</span><span class="ident" id="6181324">Map</span><span class="op" id="6181327">)</span>&nbsp;<span class="ident" id="6181329">AddFloat</span><span class="op" id="6181337">(</span><span class="ident" id="6181338">key</span>&nbsp;<span class="builtintype" id="6181342">string</span><span class="op" id="6181348">,</span>&nbsp;<span class="ident" id="6181350">delta</span>&nbsp;<span class="builtintype" id="6181356">float64</span><span class="op" id="6181363">)</span>&nbsp;<span class="op" id="6181365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181368">v</span><span class="op" id="6181369">.</span><span class="ident" id="6181370">mu</span><span class="op" id="6181372">.</span><span class="ident" id="6181373">RLock</span><span class="op" id="6181378">(</span><span class="op" id="6181379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181382">av</span><span class="op" id="6181384">,</span>&nbsp;<span class="ident" id="6181386">ok</span>&nbsp;<span class="op" id="6181389">:=</span>&nbsp;<span class="ident" id="6181392">v</span><span class="op" id="6181393">.</span><span class="ident" id="6181394">m</span><span class="op" id="6181395">[</span><span class="ident" id="6181396">key</span><span class="op" id="6181399">]</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181402">v</span><span class="op" id="6181403">.</span><span class="ident" id="6181404">mu</span><span class="op" id="6181406">.</span><span class="ident" id="6181407">RUnlock</span><span class="op" id="6181414">(</span><span class="op" id="6181415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6181418">if</span>&nbsp;<span class="op" id="6181421">!</span><span class="ident" id="6181422">ok</span>&nbsp;<span class="op" id="6181425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6181429">//&nbsp;check&nbsp;again&nbsp;under&nbsp;the&nbsp;write&nbsp;lock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181467">v</span><span class="op" id="6181468">.</span><span class="ident" id="6181469">mu</span><span class="op" id="6181471">.</span><span class="ident" id="6181472">Lock</span><span class="op" id="6181476">(</span><span class="op" id="6181477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181481">av</span><span class="op" id="6181483">,</span>&nbsp;<span class="ident" id="6181485">ok</span>&nbsp;<span class="op" id="6181488">=</span>&nbsp;<span class="ident" id="6181490">v</span><span class="op" id="6181491">.</span><span class="ident" id="6181492">m</span><span class="op" id="6181493">[</span><span class="ident" id="6181494">key</span><span class="op" id="6181497">]</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6181501">if</span>&nbsp;<span class="op" id="6181504">!</span><span class="ident" id="6181505">ok</span>&nbsp;<span class="op" id="6181508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181513">av</span>&nbsp;<span class="op" id="6181516">=</span>&nbsp;<span class="builtinfunc" id="6181518">new</span><span class="op" id="6181521">(</span><span class="ident" id="6181522">Float</span><span class="op" id="6181527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181532">v</span><span class="op" id="6181533">.</span><span class="ident" id="6181534">m</span><span class="op" id="6181535">[</span><span class="ident" id="6181536">key</span><span class="op" id="6181539">]</span>&nbsp;<span class="op" id="6181541">=</span>&nbsp;<span class="ident" id="6181543">av</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181549">v</span><span class="op" id="6181550">.</span><span class="ident" id="6181551">updateKeys</span><span class="op" id="6181561">(</span><span class="op" id="6181562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6181566">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181570">v</span><span class="op" id="6181571">.</span><span class="ident" id="6181572">mu</span><span class="op" id="6181574">.</span><span class="ident" id="6181575">Unlock</span><span class="op" id="6181581">(</span><span class="op" id="6181582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6181585">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6181589">//&nbsp;Add&nbsp;to&nbsp;Float;&nbsp;ignore&nbsp;otherwise.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6181625">if</span>&nbsp;<span class="ident" id="6181628">iv</span><span class="op" id="6181630">,</span>&nbsp;<span class="ident" id="6181632">ok</span>&nbsp;<span class="op" id="6181635">:=</span>&nbsp;<span class="ident" id="6181638">av</span><span class="op" id="6181640">.</span><span class="op" id="6181641">(</span><span class="op" id="6181642">*</span><span class="ident" id="6181643">Float</span><span class="op" id="6181648">)</span><span class="op" id="6181649">;</span>&nbsp;<span class="ident" id="6181651">ok</span>&nbsp;<span class="op" id="6181654">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181658">iv</span><span class="op" id="6181660">.</span><span class="ident" id="6181661">Add</span><span class="op" id="6181664">(</span><span class="ident" id="6181665">delta</span><span class="op" id="6181670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6181673">}</span><br>
<span class="lineno"></span><span class="op" id="6181675">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6181678">//&nbsp;Do&nbsp;calls&nbsp;f&nbsp;for&nbsp;each&nbsp;entry&nbsp;in&nbsp;the&nbsp;map.</span><br>
<span class="lineno">200</span><span class="comment" id="6181719">//&nbsp;The&nbsp;map&nbsp;is&nbsp;locked&nbsp;during&nbsp;the&nbsp;iteration,</span><br>
<span class="lineno"></span><span class="comment" id="6181762">//&nbsp;but&nbsp;existing&nbsp;entries&nbsp;may&nbsp;be&nbsp;concurrently&nbsp;updated.</span><br>
<span class="lineno"></span><span class="keyword" id="6181815">func</span>&nbsp;<span class="op" id="6181820">(</span><span class="ident" id="6181821">v</span>&nbsp;<span class="op" id="6181823">*</span><span class="ident" id="6181824">Map</span><span class="op" id="6181827">)</span>&nbsp;<span class="ident" id="6181829">Do</span><span class="op" id="6181831">(</span><span class="ident" id="6181832">f</span>&nbsp;<span class="keyword" id="6181834">func</span><span class="op" id="6181838">(</span><span class="ident" id="6181839">KeyValue</span><span class="op" id="6181847">)</span><span class="op" id="6181848">)</span>&nbsp;<span class="op" id="6181850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181853">v</span><span class="op" id="6181854">.</span><span class="ident" id="6181855">mu</span><span class="op" id="6181857">.</span><span class="ident" id="6181858">RLock</span><span class="op" id="6181863">(</span><span class="op" id="6181864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6181867">defer</span>&nbsp;<span class="ident" id="6181873">v</span><span class="op" id="6181874">.</span><span class="ident" id="6181875">mu</span><span class="op" id="6181877">.</span><span class="ident" id="6181878">RUnlock</span><span class="op" id="6181885">(</span><span class="op" id="6181886">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181889">v</span><span class="op" id="6181890">.</span><span class="ident" id="6181891">doLocked</span><span class="op" id="6181899">(</span><span class="ident" id="6181900">f</span><span class="op" id="6181901">)</span><br>
<span class="lineno"></span><span class="op" id="6181903">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6181906">//&nbsp;doLocked&nbsp;calls&nbsp;f&nbsp;for&nbsp;each&nbsp;entry&nbsp;in&nbsp;the&nbsp;map.</span><br>
<span class="lineno"></span><span class="comment" id="6181953">//&nbsp;v.mu&nbsp;must&nbsp;be&nbsp;held&nbsp;for&nbsp;reads.</span><br>
<span class="lineno">210</span><span class="keyword" id="6181985">func</span>&nbsp;<span class="op" id="6181990">(</span><span class="ident" id="6181991">v</span>&nbsp;<span class="op" id="6181993">*</span><span class="ident" id="6181994">Map</span><span class="op" id="6181997">)</span>&nbsp;<span class="ident" id="6181999">doLocked</span><span class="op" id="6182007">(</span><span class="ident" id="6182008">f</span>&nbsp;<span class="keyword" id="6182010">func</span><span class="op" id="6182014">(</span><span class="ident" id="6182015">KeyValue</span><span class="op" id="6182023">)</span><span class="op" id="6182024">)</span>&nbsp;<span class="op" id="6182026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6182029">for</span>&nbsp;<span class="ident" id="6182033">_</span><span class="op" id="6182034">,</span>&nbsp;<span class="ident" id="6182036">k</span>&nbsp;<span class="op" id="6182038">:=</span>&nbsp;<span class="keyword" id="6182041">range</span>&nbsp;<span class="ident" id="6182047">v</span><span class="op" id="6182048">.</span><span class="ident" id="6182049">keys</span>&nbsp;<span class="op" id="6182054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6182058">f</span><span class="op" id="6182059">(</span><span class="ident" id="6182060">KeyValue</span><span class="op" id="6182068">{</span><span class="ident" id="6182069">k</span><span class="op" id="6182070">,</span>&nbsp;<span class="ident" id="6182072">v</span><span class="op" id="6182073">.</span><span class="ident" id="6182074">m</span><span class="op" id="6182075">[</span><span class="ident" id="6182076">k</span><span class="op" id="6182077">]</span><span class="op" id="6182078">}</span><span class="op" id="6182079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6182082">}</span><br>
<span class="lineno"></span><span class="op" id="6182084">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="comment" id="6182087">//&nbsp;String&nbsp;is&nbsp;a&nbsp;string&nbsp;variable,&nbsp;and&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6182152">type</span>&nbsp;<span class="ident" id="6182157">String</span>&nbsp;<span class="keyword" id="6182164">struct</span>&nbsp;<span class="op" id="6182171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6182174">mu</span>&nbsp;<span class="ident" id="6182177">sync</span><span class="op" id="6182181">.</span><span class="ident" id="6182182">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6182191">s</span>&nbsp;&nbsp;<span class="builtintype" id="6182194">string</span><br>
<span class="lineno">220</span><span class="op" id="6182201">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6182204">func</span>&nbsp;<span class="op" id="6182209">(</span><span class="ident" id="6182210">v</span>&nbsp;<span class="op" id="6182212">*</span><span class="ident" id="6182213">String</span><span class="op" id="6182219">)</span>&nbsp;<span class="ident" id="6182221">String</span><span class="op" id="6182227">(</span><span class="op" id="6182228">)</span>&nbsp;<span class="builtintype" id="6182230">string</span>&nbsp;<span class="op" id="6182237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6182240">v</span><span class="op" id="6182241">.</span><span class="ident" id="6182242">mu</span><span class="op" id="6182244">.</span><span class="ident" id="6182245">RLock</span><span class="op" id="6182250">(</span><span class="op" id="6182251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6182254">defer</span>&nbsp;<span class="ident" id="6182260">v</span><span class="op" id="6182261">.</span><span class="ident" id="6182262">mu</span><span class="op" id="6182264">.</span><span class="ident" id="6182265">RUnlock</span><span class="op" id="6182272">(</span><span class="op" id="6182273">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6182276">return</span>&nbsp;<span class="ident" id="6182283">strconv</span><span class="op" id="6182290">.</span><span class="ident" id="6182291">Quote</span><span class="op" id="6182296">(</span><span class="ident" id="6182297">v</span><span class="op" id="6182298">.</span><span class="ident" id="6182299">s</span><span class="op" id="6182300">)</span><br>
<span class="lineno"></span><span class="op" id="6182302">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6182305">func</span>&nbsp;<span class="op" id="6182310">(</span><span class="ident" id="6182311">v</span>&nbsp;<span class="op" id="6182313">*</span><span class="ident" id="6182314">String</span><span class="op" id="6182320">)</span>&nbsp;<span class="ident" id="6182322">Set</span><span class="op" id="6182325">(</span><span class="ident" id="6182326">value</span>&nbsp;<span class="builtintype" id="6182332">string</span><span class="op" id="6182338">)</span>&nbsp;<span class="op" id="6182340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6182343">v</span><span class="op" id="6182344">.</span><span class="ident" id="6182345">mu</span><span class="op" id="6182347">.</span><span class="ident" id="6182348">Lock</span><span class="op" id="6182352">(</span><span class="op" id="6182353">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6182356">defer</span>&nbsp;<span class="ident" id="6182362">v</span><span class="op" id="6182363">.</span><span class="ident" id="6182364">mu</span><span class="op" id="6182366">.</span><span class="ident" id="6182367">Unlock</span><span class="op" id="6182373">(</span><span class="op" id="6182374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6182377">v</span><span class="op" id="6182378">.</span><span class="ident" id="6182379">s</span>&nbsp;<span class="op" id="6182381">=</span>&nbsp;<span class="ident" id="6182383">value</span><br>
<span class="lineno"></span><span class="op" id="6182389">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6182392">//&nbsp;Func&nbsp;implements&nbsp;Var&nbsp;by&nbsp;calling&nbsp;the&nbsp;function</span><br>
<span class="lineno">235</span><span class="comment" id="6182439">//&nbsp;and&nbsp;formatting&nbsp;the&nbsp;returned&nbsp;value&nbsp;using&nbsp;JSON.</span><br>
<span class="lineno"></span><span class="keyword" id="6182488">type</span>&nbsp;<span class="ident" id="6182493">Func</span>&nbsp;<span class="keyword" id="6182498">func</span><span class="op" id="6182502">(</span><span class="op" id="6182503">)</span>&nbsp;<span class="keyword" id="6182505">interface</span><span class="op" id="6182514">{</span><span class="op" id="6182515">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6182518">func</span>&nbsp;<span class="op" id="6182523">(</span><span class="ident" id="6182524">f</span>&nbsp;<span class="ident" id="6182526">Func</span><span class="op" id="6182530">)</span>&nbsp;<span class="ident" id="6182532">String</span><span class="op" id="6182538">(</span><span class="op" id="6182539">)</span>&nbsp;<span class="builtintype" id="6182541">string</span>&nbsp;<span class="op" id="6182548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6182551">v</span><span class="op" id="6182552">,</span>&nbsp;<span class="ident" id="6182554">_</span>&nbsp;<span class="op" id="6182556">:=</span>&nbsp;<span class="ident" id="6182559">json</span><span class="op" id="6182563">.</span><span class="ident" id="6182564">Marshal</span><span class="op" id="6182571">(</span><span class="ident" id="6182572">f</span><span class="op" id="6182573">(</span><span class="op" id="6182574">)</span><span class="op" id="6182575">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6182578">return</span>&nbsp;<span class="builtintype" id="6182585">string</span><span class="op" id="6182591">(</span><span class="ident" id="6182592">v</span><span class="op" id="6182593">)</span><br>
<span class="lineno"></span><span class="op" id="6182595">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6182598">//&nbsp;All&nbsp;published&nbsp;variables.</span><br>
<span class="lineno"></span><span class="keyword" id="6182626">var</span>&nbsp;<span class="op" id="6182630">(</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6182633">mutex</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6182641">sync</span><span class="op" id="6182645">.</span><span class="ident" id="6182646">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6182655">vars</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6182663">=</span>&nbsp;<span class="builtinfunc" id="6182665">make</span><span class="op" id="6182669">(</span><span class="keyword" id="6182670">map</span><span class="op" id="6182673">[</span><span class="builtintype" id="6182674">string</span><span class="op" id="6182680">]</span><span class="ident" id="6182681">Var</span><span class="op" id="6182684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6182687">varKeys</span>&nbsp;<span class="op" id="6182695">[</span><span class="op" id="6182696">]</span><span class="builtintype" id="6182697">string</span>&nbsp;<span class="comment" id="6182704">//&nbsp;sorted</span><br>
<span class="lineno"></span><span class="op" id="6182714">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span><span class="comment" id="6182717">//&nbsp;Publish&nbsp;declares&nbsp;a&nbsp;named&nbsp;exported&nbsp;variable.&nbsp;This&nbsp;should&nbsp;be&nbsp;called&nbsp;from&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="6182793">//&nbsp;package&#39;s&nbsp;init&nbsp;function&nbsp;when&nbsp;it&nbsp;creates&nbsp;its&nbsp;Vars.&nbsp;If&nbsp;the&nbsp;name&nbsp;is&nbsp;already</span><br>
<span class="lineno"></span><span class="comment" id="6182869">//&nbsp;registered&nbsp;then&nbsp;this&nbsp;will&nbsp;log.Panic.</span><br>
<span class="lineno"></span><span class="keyword" id="6182909">func</span>&nbsp;<span class="ident" id="6182914">Publish</span><span class="op" id="6182921">(</span><span class="ident" id="6182922">name</span>&nbsp;<span class="builtintype" id="6182927">string</span><span class="op" id="6182933">,</span>&nbsp;<span class="ident" id="6182935">v</span>&nbsp;<span class="ident" id="6182937">Var</span><span class="op" id="6182940">)</span>&nbsp;<span class="op" id="6182942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6182945">mutex</span><span class="op" id="6182950">.</span><span class="ident" id="6182951">Lock</span><span class="op" id="6182955">(</span><span class="op" id="6182956">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6182959">defer</span>&nbsp;<span class="ident" id="6182965">mutex</span><span class="op" id="6182970">.</span><span class="ident" id="6182971">Unlock</span><span class="op" id="6182977">(</span><span class="op" id="6182978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6182981">if</span>&nbsp;<span class="ident" id="6182984">_</span><span class="op" id="6182985">,</span>&nbsp;<span class="ident" id="6182987">existing</span>&nbsp;<span class="op" id="6182996">:=</span>&nbsp;<span class="ident" id="6182999">vars</span><span class="op" id="6183003">[</span><span class="ident" id="6183004">name</span><span class="op" id="6183008">]</span><span class="op" id="6183009">;</span>&nbsp;<span class="ident" id="6183011">existing</span>&nbsp;<span class="op" id="6183020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6183024">log</span><span class="op" id="6183027">.</span><span class="ident" id="6183028">Panicln</span><span class="op" id="6183035">(</span><span class="string" id="6183036">&#34;Reuse&nbsp;of&nbsp;exported&nbsp;var&nbsp;name:&#34;</span><span class="op" id="6183065">,</span>&nbsp;<span class="ident" id="6183067">name</span><span class="op" id="6183071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6183074">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6183077">vars</span><span class="op" id="6183081">[</span><span class="ident" id="6183082">name</span><span class="op" id="6183086">]</span>&nbsp;<span class="op" id="6183088">=</span>&nbsp;<span class="ident" id="6183090">v</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6183093">varKeys</span>&nbsp;<span class="op" id="6183101">=</span>&nbsp;<span class="builtinfunc" id="6183103">append</span><span class="op" id="6183109">(</span><span class="ident" id="6183110">varKeys</span><span class="op" id="6183117">,</span>&nbsp;<span class="ident" id="6183119">name</span><span class="op" id="6183123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6183126">sort</span><span class="op" id="6183130">.</span><span class="ident" id="6183131">Strings</span><span class="op" id="6183138">(</span><span class="ident" id="6183139">varKeys</span><span class="op" id="6183146">)</span><br>
<span class="lineno"></span><span class="op" id="6183148">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6183151">//&nbsp;Get&nbsp;retrieves&nbsp;a&nbsp;named&nbsp;exported&nbsp;variable.</span><br>
<span class="lineno">265</span><span class="keyword" id="6183195">func</span>&nbsp;<span class="ident" id="6183200">Get</span><span class="op" id="6183203">(</span><span class="ident" id="6183204">name</span>&nbsp;<span class="builtintype" id="6183209">string</span><span class="op" id="6183215">)</span>&nbsp;<span class="ident" id="6183217">Var</span>&nbsp;<span class="op" id="6183221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6183224">mutex</span><span class="op" id="6183229">.</span><span class="ident" id="6183230">RLock</span><span class="op" id="6183235">(</span><span class="op" id="6183236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6183239">defer</span>&nbsp;<span class="ident" id="6183245">mutex</span><span class="op" id="6183250">.</span><span class="ident" id="6183251">RUnlock</span><span class="op" id="6183258">(</span><span class="op" id="6183259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6183262">return</span>&nbsp;<span class="ident" id="6183269">vars</span><span class="op" id="6183273">[</span><span class="ident" id="6183274">name</span><span class="op" id="6183278">]</span><br>
<span class="lineno"></span><span class="op" id="6183280">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="comment" id="6183283">//&nbsp;Convenience&nbsp;functions&nbsp;for&nbsp;creating&nbsp;new&nbsp;exported&nbsp;variables.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6183346">func</span>&nbsp;<span class="ident" id="6183351">NewInt</span><span class="op" id="6183357">(</span><span class="ident" id="6183358">name</span>&nbsp;<span class="builtintype" id="6183363">string</span><span class="op" id="6183369">)</span>&nbsp;<span class="op" id="6183371">*</span><span class="ident" id="6183372">Int</span>&nbsp;<span class="op" id="6183376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6183379">v</span>&nbsp;<span class="op" id="6183381">:=</span>&nbsp;<span class="builtinfunc" id="6183384">new</span><span class="op" id="6183387">(</span><span class="ident" id="6183388">Int</span><span class="op" id="6183391">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6183394">Publish</span><span class="op" id="6183401">(</span><span class="ident" id="6183402">name</span><span class="op" id="6183406">,</span>&nbsp;<span class="ident" id="6183408">v</span><span class="op" id="6183409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6183412">return</span>&nbsp;<span class="ident" id="6183419">v</span><br>
<span class="lineno"></span><span class="op" id="6183421">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6183424">func</span>&nbsp;<span class="ident" id="6183429">NewFloat</span><span class="op" id="6183437">(</span><span class="ident" id="6183438">name</span>&nbsp;<span class="builtintype" id="6183443">string</span><span class="op" id="6183449">)</span>&nbsp;<span class="op" id="6183451">*</span><span class="ident" id="6183452">Float</span>&nbsp;<span class="op" id="6183458">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6183461">v</span>&nbsp;<span class="op" id="6183463">:=</span>&nbsp;<span class="builtinfunc" id="6183466">new</span><span class="op" id="6183469">(</span><span class="ident" id="6183470">Float</span><span class="op" id="6183475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6183478">Publish</span><span class="op" id="6183485">(</span><span class="ident" id="6183486">name</span><span class="op" id="6183490">,</span>&nbsp;<span class="ident" id="6183492">v</span><span class="op" id="6183493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6183496">return</span>&nbsp;<span class="ident" id="6183503">v</span><br>
<span class="lineno"></span><span class="op" id="6183505">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="6183508">func</span>&nbsp;<span class="ident" id="6183513">NewMap</span><span class="op" id="6183519">(</span><span class="ident" id="6183520">name</span>&nbsp;<span class="builtintype" id="6183525">string</span><span class="op" id="6183531">)</span>&nbsp;<span class="op" id="6183533">*</span><span class="ident" id="6183534">Map</span>&nbsp;<span class="op" id="6183538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6183541">v</span>&nbsp;<span class="op" id="6183543">:=</span>&nbsp;<span class="builtinfunc" id="6183546">new</span><span class="op" id="6183549">(</span><span class="ident" id="6183550">Map</span><span class="op" id="6183553">)</span><span class="op" id="6183554">.</span><span class="ident" id="6183555">Init</span><span class="op" id="6183559">(</span><span class="op" id="6183560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6183563">Publish</span><span class="op" id="6183570">(</span><span class="ident" id="6183571">name</span><span class="op" id="6183575">,</span>&nbsp;<span class="ident" id="6183577">v</span><span class="op" id="6183578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6183581">return</span>&nbsp;<span class="ident" id="6183588">v</span><br>
<span class="lineno"></span><span class="op" id="6183590">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span><span class="keyword" id="6183593">func</span>&nbsp;<span class="ident" id="6183598">NewString</span><span class="op" id="6183607">(</span><span class="ident" id="6183608">name</span>&nbsp;<span class="builtintype" id="6183613">string</span><span class="op" id="6183619">)</span>&nbsp;<span class="op" id="6183621">*</span><span class="ident" id="6183622">String</span>&nbsp;<span class="op" id="6183629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6183632">v</span>&nbsp;<span class="op" id="6183634">:=</span>&nbsp;<span class="builtinfunc" id="6183637">new</span><span class="op" id="6183640">(</span><span class="ident" id="6183641">String</span><span class="op" id="6183647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6183650">Publish</span><span class="op" id="6183657">(</span><span class="ident" id="6183658">name</span><span class="op" id="6183662">,</span>&nbsp;<span class="ident" id="6183664">v</span><span class="op" id="6183665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6183668">return</span>&nbsp;<span class="ident" id="6183675">v</span><br>
<span class="lineno">295</span><span class="op" id="6183677">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6183680">//&nbsp;Do&nbsp;calls&nbsp;f&nbsp;for&nbsp;each&nbsp;exported&nbsp;variable.</span><br>
<span class="lineno"></span><span class="comment" id="6183722">//&nbsp;The&nbsp;global&nbsp;variable&nbsp;map&nbsp;is&nbsp;locked&nbsp;during&nbsp;the&nbsp;iteration,</span><br>
<span class="lineno"></span><span class="comment" id="6183781">//&nbsp;but&nbsp;existing&nbsp;entries&nbsp;may&nbsp;be&nbsp;concurrently&nbsp;updated.</span><br>
<span class="lineno">300</span><span class="keyword" id="6183834">func</span>&nbsp;<span class="ident" id="6183839">Do</span><span class="op" id="6183841">(</span><span class="ident" id="6183842">f</span>&nbsp;<span class="keyword" id="6183844">func</span><span class="op" id="6183848">(</span><span class="ident" id="6183849">KeyValue</span><span class="op" id="6183857">)</span><span class="op" id="6183858">)</span>&nbsp;<span class="op" id="6183860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6183863">mutex</span><span class="op" id="6183868">.</span><span class="ident" id="6183869">RLock</span><span class="op" id="6183874">(</span><span class="op" id="6183875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6183878">defer</span>&nbsp;<span class="ident" id="6183884">mutex</span><span class="op" id="6183889">.</span><span class="ident" id="6183890">RUnlock</span><span class="op" id="6183897">(</span><span class="op" id="6183898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6183901">for</span>&nbsp;<span class="ident" id="6183905">_</span><span class="op" id="6183906">,</span>&nbsp;<span class="ident" id="6183908">k</span>&nbsp;<span class="op" id="6183910">:=</span>&nbsp;<span class="keyword" id="6183913">range</span>&nbsp;<span class="ident" id="6183919">varKeys</span>&nbsp;<span class="op" id="6183927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6183931">f</span><span class="op" id="6183932">(</span><span class="ident" id="6183933">KeyValue</span><span class="op" id="6183941">{</span><span class="ident" id="6183942">k</span><span class="op" id="6183943">,</span>&nbsp;<span class="ident" id="6183945">vars</span><span class="op" id="6183949">[</span><span class="ident" id="6183950">k</span><span class="op" id="6183951">]</span><span class="op" id="6183952">}</span><span class="op" id="6183953">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6183956">}</span><br>
<span class="lineno"></span><span class="op" id="6183958">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6183961">func</span>&nbsp;<span class="ident" id="6183966">expvarHandler</span><span class="op" id="6183979">(</span><span class="ident" id="6183980">w</span>&nbsp;<span class="ident" id="6183982">http</span><span class="op" id="6183986">.</span><span class="ident" id="6183987">ResponseWriter</span><span class="op" id="6184001">,</span>&nbsp;<span class="ident" id="6184003">r</span>&nbsp;<span class="op" id="6184005">*</span><span class="ident" id="6184006">http</span><span class="op" id="6184010">.</span><span class="ident" id="6184011">Request</span><span class="op" id="6184018">)</span>&nbsp;<span class="op" id="6184020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6184023">w</span><span class="op" id="6184024">.</span><span class="ident" id="6184025">Header</span><span class="op" id="6184031">(</span><span class="op" id="6184032">)</span><span class="op" id="6184033">.</span><span class="ident" id="6184034">Set</span><span class="op" id="6184037">(</span><span class="string" id="6184038">&#34;Content-Type&#34;</span><span class="op" id="6184052">,</span>&nbsp;<span class="string" id="6184054">&#34;application/json;&nbsp;charset=utf-8&#34;</span><span class="op" id="6184087">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6184090">fmt</span><span class="op" id="6184093">.</span><span class="ident" id="6184094">Fprintf</span><span class="op" id="6184101">(</span><span class="ident" id="6184102">w</span><span class="op" id="6184103">,</span>&nbsp;<span class="string" id="6184105">&#34;{\n&#34;</span><span class="op" id="6184110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6184113">first</span>&nbsp;<span class="op" id="6184119">:=</span>&nbsp;<span class="builtintype" id="6184122">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6184128">Do</span><span class="op" id="6184130">(</span><span class="keyword" id="6184131">func</span><span class="op" id="6184135">(</span><span class="ident" id="6184136">kv</span>&nbsp;<span class="ident" id="6184139">KeyValue</span><span class="op" id="6184147">)</span>&nbsp;<span class="op" id="6184149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6184153">if</span>&nbsp;<span class="op" id="6184156">!</span><span class="ident" id="6184157">first</span>&nbsp;<span class="op" id="6184163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6184168">fmt</span><span class="op" id="6184171">.</span><span class="ident" id="6184172">Fprintf</span><span class="op" id="6184179">(</span><span class="ident" id="6184180">w</span><span class="op" id="6184181">,</span>&nbsp;<span class="string" id="6184183">&#34;,\n&#34;</span><span class="op" id="6184188">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6184192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6184196">first</span>&nbsp;<span class="op" id="6184202">=</span>&nbsp;<span class="builtintype" id="6184204">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6184212">fmt</span><span class="op" id="6184215">.</span><span class="ident" id="6184216">Fprintf</span><span class="op" id="6184223">(</span><span class="ident" id="6184224">w</span><span class="op" id="6184225">,</span>&nbsp;<span class="string" id="6184227">&#34;%q:&nbsp;%s&#34;</span><span class="op" id="6184235">,</span>&nbsp;<span class="ident" id="6184237">kv</span><span class="op" id="6184239">.</span><span class="ident" id="6184240">Key</span><span class="op" id="6184243">,</span>&nbsp;<span class="ident" id="6184245">kv</span><span class="op" id="6184247">.</span><span class="ident" id="6184248">Value</span><span class="op" id="6184253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6184256">}</span><span class="op" id="6184257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6184260">fmt</span><span class="op" id="6184263">.</span><span class="ident" id="6184264">Fprintf</span><span class="op" id="6184271">(</span><span class="ident" id="6184272">w</span><span class="op" id="6184273">,</span>&nbsp;<span class="string" id="6184275">&#34;\n}\n&#34;</span><span class="op" id="6184282">)</span><br>
<span class="lineno">320</span><span class="op" id="6184284">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6184287">func</span>&nbsp;<span class="ident" id="6184292">cmdline</span><span class="op" id="6184299">(</span><span class="op" id="6184300">)</span>&nbsp;<span class="keyword" id="6184302">interface</span><span class="op" id="6184311">{</span><span class="op" id="6184312">}</span>&nbsp;<span class="op" id="6184314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6184317">return</span>&nbsp;<span class="ident" id="6184324">os</span><span class="op" id="6184326">.</span><span class="ident" id="6184327">Args</span><br>
<span class="lineno"></span><span class="op" id="6184332">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span><span class="keyword" id="6184335">func</span>&nbsp;<span class="ident" id="6184340">memstats</span><span class="op" id="6184348">(</span><span class="op" id="6184349">)</span>&nbsp;<span class="keyword" id="6184351">interface</span><span class="op" id="6184360">{</span><span class="op" id="6184361">}</span>&nbsp;<span class="op" id="6184363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6184366">stats</span>&nbsp;<span class="op" id="6184372">:=</span>&nbsp;<span class="builtinfunc" id="6184375">new</span><span class="op" id="6184378">(</span><span class="ident" id="6184379">runtime</span><span class="op" id="6184386">.</span><span class="ident" id="6184387">MemStats</span><span class="op" id="6184395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6184398">runtime</span><span class="op" id="6184405">.</span><span class="ident" id="6184406">ReadMemStats</span><span class="op" id="6184418">(</span><span class="ident" id="6184419">stats</span><span class="op" id="6184424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6184427">return</span>&nbsp;<span class="op" id="6184434">*</span><span class="ident" id="6184435">stats</span><br>
<span class="lineno">330</span><span class="op" id="6184441">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6184444">func</span>&nbsp;<span class="ident" id="6184449">init</span><span class="op" id="6184453">(</span><span class="op" id="6184454">)</span>&nbsp;<span class="op" id="6184456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6184459">http</span><span class="op" id="6184463">.</span><span class="ident" id="6184464">HandleFunc</span><span class="op" id="6184474">(</span><span class="string" id="6184475">&#34;/debug/vars&#34;</span><span class="op" id="6184488">,</span>&nbsp;<span class="ident" id="6184490">expvarHandler</span><span class="op" id="6184503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6184506">Publish</span><span class="op" id="6184513">(</span><span class="string" id="6184514">&#34;cmdline&#34;</span><span class="op" id="6184523">,</span>&nbsp;<span class="ident" id="6184525">Func</span><span class="op" id="6184529">(</span><span class="ident" id="6184530">cmdline</span><span class="op" id="6184537">)</span><span class="op" id="6184538">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6184541">Publish</span><span class="op" id="6184548">(</span><span class="string" id="6184549">&#34;memstats&#34;</span><span class="op" id="6184559">,</span>&nbsp;<span class="ident" id="6184561">Func</span><span class="op" id="6184565">(</span><span class="ident" id="6184566">memstats</span><span class="op" id="6184574">)</span><span class="op" id="6184575">)</span><br>
<span class="lineno"></span><span class="op" id="6184577">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
