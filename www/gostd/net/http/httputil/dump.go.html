<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5350078">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5350133">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5350187">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5350238">package</span>&nbsp;<span class="ident" id="5350246">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5350256">import</span>&nbsp;<span class="op" id="5350263">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5350266">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5350275">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5350284">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5350294">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5350301">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5350307">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5350320">&#34;net&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5350327">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5350339">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5350350">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5350361">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="5350368">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="5350371">//&nbsp;One&nbsp;of&nbsp;the&nbsp;copies,&nbsp;say&nbsp;from&nbsp;b&nbsp;to&nbsp;r2,&nbsp;could&nbsp;be&nbsp;avoided&nbsp;by&nbsp;using&nbsp;a&nbsp;more</span><br>
<span class="lineno"></span><span class="comment" id="5350444">//&nbsp;elaborate&nbsp;trick&nbsp;where&nbsp;the&nbsp;other&nbsp;copy&nbsp;is&nbsp;made&nbsp;during&nbsp;Request/Response.Write.</span><br>
<span class="lineno"></span><span class="comment" id="5350523">//&nbsp;This&nbsp;would&nbsp;complicate&nbsp;things&nbsp;too&nbsp;much,&nbsp;given&nbsp;that&nbsp;these&nbsp;functions&nbsp;are&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="5350600">//&nbsp;debugging&nbsp;only.</span><br>
<span class="lineno">25</span><span class="keyword" id="5350619">func</span>&nbsp;<span class="ident" id="5350624">drainBody</span><span class="op" id="5350633">(</span><span class="ident" id="5350634">b</span>&nbsp;<span class="ident" id="5350636">io</span><span class="op" id="5350638">.</span><span class="ident" id="5350639">ReadCloser</span><span class="op" id="5350649">)</span>&nbsp;<span class="op" id="5350651">(</span><span class="ident" id="5350652">r1</span><span class="op" id="5350654">,</span>&nbsp;<span class="ident" id="5350656">r2</span>&nbsp;<span class="ident" id="5350659">io</span><span class="op" id="5350661">.</span><span class="ident" id="5350662">ReadCloser</span><span class="op" id="5350672">,</span>&nbsp;<span class="ident" id="5350674">err</span>&nbsp;<span class="builtintype" id="5350678">error</span><span class="op" id="5350683">)</span>&nbsp;<span class="op" id="5350685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5350688">var</span>&nbsp;<span class="ident" id="5350692">buf</span>&nbsp;<span class="ident" id="5350696">bytes</span><span class="op" id="5350701">.</span><span class="ident" id="5350702">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5350710">if</span>&nbsp;<span class="ident" id="5350713">_</span><span class="op" id="5350714">,</span>&nbsp;<span class="ident" id="5350716">err</span>&nbsp;<span class="op" id="5350720">=</span>&nbsp;<span class="ident" id="5350722">buf</span><span class="op" id="5350725">.</span><span class="ident" id="5350726">ReadFrom</span><span class="op" id="5350734">(</span><span class="ident" id="5350735">b</span><span class="op" id="5350736">)</span><span class="op" id="5350737">;</span>&nbsp;<span class="ident" id="5350739">err</span>&nbsp;<span class="op" id="5350743">!=</span>&nbsp;<span class="ident" id="5350746">nil</span>&nbsp;<span class="op" id="5350750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5350754">return</span>&nbsp;<span class="ident" id="5350761">nil</span><span class="op" id="5350764">,</span>&nbsp;<span class="ident" id="5350766">nil</span><span class="op" id="5350769">,</span>&nbsp;<span class="ident" id="5350771">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5350776">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5350779">if</span>&nbsp;<span class="ident" id="5350782">err</span>&nbsp;<span class="op" id="5350786">=</span>&nbsp;<span class="ident" id="5350788">b</span><span class="op" id="5350789">.</span><span class="ident" id="5350790">Close</span><span class="op" id="5350795">(</span><span class="op" id="5350796">)</span><span class="op" id="5350797">;</span>&nbsp;<span class="ident" id="5350799">err</span>&nbsp;<span class="op" id="5350803">!=</span>&nbsp;<span class="ident" id="5350806">nil</span>&nbsp;<span class="op" id="5350810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5350814">return</span>&nbsp;<span class="ident" id="5350821">nil</span><span class="op" id="5350824">,</span>&nbsp;<span class="ident" id="5350826">nil</span><span class="op" id="5350829">,</span>&nbsp;<span class="ident" id="5350831">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5350836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5350839">return</span>&nbsp;<span class="ident" id="5350846">ioutil</span><span class="op" id="5350852">.</span><span class="ident" id="5350853">NopCloser</span><span class="op" id="5350862">(</span><span class="op" id="5350863">&amp;</span><span class="ident" id="5350864">buf</span><span class="op" id="5350867">)</span><span class="op" id="5350868">,</span>&nbsp;<span class="ident" id="5350870">ioutil</span><span class="op" id="5350876">.</span><span class="ident" id="5350877">NopCloser</span><span class="op" id="5350886">(</span><span class="ident" id="5350887">bytes</span><span class="op" id="5350892">.</span><span class="ident" id="5350893">NewReader</span><span class="op" id="5350902">(</span><span class="ident" id="5350903">buf</span><span class="op" id="5350906">.</span><span class="ident" id="5350907">Bytes</span><span class="op" id="5350912">(</span><span class="op" id="5350913">)</span><span class="op" id="5350914">)</span><span class="op" id="5350915">)</span><span class="op" id="5350916">,</span>&nbsp;<span class="ident" id="5350918">nil</span><br>
<span class="lineno"></span><span class="op" id="5350922">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="5350925">//&nbsp;dumpConn&nbsp;is&nbsp;a&nbsp;net.Conn&nbsp;which&nbsp;writes&nbsp;to&nbsp;Writer&nbsp;and&nbsp;reads&nbsp;from&nbsp;Reader</span><br>
<span class="lineno"></span><span class="keyword" id="5350996">type</span>&nbsp;<span class="ident" id="5351001">dumpConn</span>&nbsp;<span class="keyword" id="5351010">struct</span>&nbsp;<span class="op" id="5351017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5351020">io</span><span class="op" id="5351022">.</span><span class="ident" id="5351023">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5351031">io</span><span class="op" id="5351033">.</span><span class="ident" id="5351034">Reader</span><br>
<span class="lineno">40</span><span class="op" id="5351041">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5351044">func</span>&nbsp;<span class="op" id="5351049">(</span><span class="ident" id="5351050">c</span>&nbsp;<span class="op" id="5351052">*</span><span class="ident" id="5351053">dumpConn</span><span class="op" id="5351061">)</span>&nbsp;<span class="ident" id="5351063">Close</span><span class="op" id="5351068">(</span><span class="op" id="5351069">)</span>&nbsp;<span class="builtintype" id="5351071">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5351099">{</span>&nbsp;<span class="keyword" id="5351101">return</span>&nbsp;<span class="ident" id="5351108">nil</span>&nbsp;<span class="op" id="5351112">}</span><br>
<span class="lineno"></span><span class="keyword" id="5351114">func</span>&nbsp;<span class="op" id="5351119">(</span><span class="ident" id="5351120">c</span>&nbsp;<span class="op" id="5351122">*</span><span class="ident" id="5351123">dumpConn</span><span class="op" id="5351131">)</span>&nbsp;<span class="ident" id="5351133">LocalAddr</span><span class="op" id="5351142">(</span><span class="op" id="5351143">)</span>&nbsp;<span class="ident" id="5351145">net</span><span class="op" id="5351148">.</span><span class="ident" id="5351149">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5351169">{</span>&nbsp;<span class="keyword" id="5351171">return</span>&nbsp;<span class="ident" id="5351178">nil</span>&nbsp;<span class="op" id="5351182">}</span><br>
<span class="lineno"></span><span class="keyword" id="5351184">func</span>&nbsp;<span class="op" id="5351189">(</span><span class="ident" id="5351190">c</span>&nbsp;<span class="op" id="5351192">*</span><span class="ident" id="5351193">dumpConn</span><span class="op" id="5351201">)</span>&nbsp;<span class="ident" id="5351203">RemoteAddr</span><span class="op" id="5351213">(</span><span class="op" id="5351214">)</span>&nbsp;<span class="ident" id="5351216">net</span><span class="op" id="5351219">.</span><span class="ident" id="5351220">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5351239">{</span>&nbsp;<span class="keyword" id="5351241">return</span>&nbsp;<span class="ident" id="5351248">nil</span>&nbsp;<span class="op" id="5351252">}</span><br>
<span class="lineno">45</span><span class="keyword" id="5351254">func</span>&nbsp;<span class="op" id="5351259">(</span><span class="ident" id="5351260">c</span>&nbsp;<span class="op" id="5351262">*</span><span class="ident" id="5351263">dumpConn</span><span class="op" id="5351271">)</span>&nbsp;<span class="ident" id="5351273">SetDeadline</span><span class="op" id="5351284">(</span><span class="ident" id="5351285">t</span>&nbsp;<span class="ident" id="5351287">time</span><span class="op" id="5351291">.</span><span class="ident" id="5351292">Time</span><span class="op" id="5351296">)</span>&nbsp;<span class="builtintype" id="5351298">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5351309">{</span>&nbsp;<span class="keyword" id="5351311">return</span>&nbsp;<span class="ident" id="5351318">nil</span>&nbsp;<span class="op" id="5351322">}</span><br>
<span class="lineno"></span><span class="keyword" id="5351324">func</span>&nbsp;<span class="op" id="5351329">(</span><span class="ident" id="5351330">c</span>&nbsp;<span class="op" id="5351332">*</span><span class="ident" id="5351333">dumpConn</span><span class="op" id="5351341">)</span>&nbsp;<span class="ident" id="5351343">SetReadDeadline</span><span class="op" id="5351358">(</span><span class="ident" id="5351359">t</span>&nbsp;<span class="ident" id="5351361">time</span><span class="op" id="5351365">.</span><span class="ident" id="5351366">Time</span><span class="op" id="5351370">)</span>&nbsp;<span class="builtintype" id="5351372">error</span>&nbsp;&nbsp;<span class="op" id="5351379">{</span>&nbsp;<span class="keyword" id="5351381">return</span>&nbsp;<span class="ident" id="5351388">nil</span>&nbsp;<span class="op" id="5351392">}</span><br>
<span class="lineno"></span><span class="keyword" id="5351394">func</span>&nbsp;<span class="op" id="5351399">(</span><span class="ident" id="5351400">c</span>&nbsp;<span class="op" id="5351402">*</span><span class="ident" id="5351403">dumpConn</span><span class="op" id="5351411">)</span>&nbsp;<span class="ident" id="5351413">SetWriteDeadline</span><span class="op" id="5351429">(</span><span class="ident" id="5351430">t</span>&nbsp;<span class="ident" id="5351432">time</span><span class="op" id="5351436">.</span><span class="ident" id="5351437">Time</span><span class="op" id="5351441">)</span>&nbsp;<span class="builtintype" id="5351443">error</span>&nbsp;<span class="op" id="5351449">{</span>&nbsp;<span class="keyword" id="5351451">return</span>&nbsp;<span class="ident" id="5351458">nil</span>&nbsp;<span class="op" id="5351462">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5351465">type</span>&nbsp;<span class="ident" id="5351470">neverEnding</span>&nbsp;<span class="builtintype" id="5351482">byte</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="5351488">func</span>&nbsp;<span class="op" id="5351493">(</span><span class="ident" id="5351494">b</span>&nbsp;<span class="ident" id="5351496">neverEnding</span><span class="op" id="5351507">)</span>&nbsp;<span class="ident" id="5351509">Read</span><span class="op" id="5351513">(</span><span class="ident" id="5351514">p</span>&nbsp;<span class="op" id="5351516">[</span><span class="op" id="5351517">]</span><span class="builtintype" id="5351518">byte</span><span class="op" id="5351522">)</span>&nbsp;<span class="op" id="5351524">(</span><span class="ident" id="5351525">n</span>&nbsp;<span class="builtintype" id="5351527">int</span><span class="op" id="5351530">,</span>&nbsp;<span class="ident" id="5351532">err</span>&nbsp;<span class="builtintype" id="5351536">error</span><span class="op" id="5351541">)</span>&nbsp;<span class="op" id="5351543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5351546">for</span>&nbsp;<span class="ident" id="5351550">i</span>&nbsp;<span class="op" id="5351552">:=</span>&nbsp;<span class="keyword" id="5351555">range</span>&nbsp;<span class="ident" id="5351561">p</span>&nbsp;<span class="op" id="5351563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5351567">p</span><span class="op" id="5351568">[</span><span class="ident" id="5351569">i</span><span class="op" id="5351570">]</span>&nbsp;<span class="op" id="5351572">=</span>&nbsp;<span class="builtintype" id="5351574">byte</span><span class="op" id="5351578">(</span><span class="ident" id="5351579">b</span><span class="op" id="5351580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5351583">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5351586">return</span>&nbsp;<span class="builtinfunc" id="5351593">len</span><span class="op" id="5351596">(</span><span class="ident" id="5351597">p</span><span class="op" id="5351598">)</span><span class="op" id="5351599">,</span>&nbsp;<span class="ident" id="5351601">nil</span><br>
<span class="lineno"></span><span class="op" id="5351605">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5351608">//&nbsp;DumpRequestOut&nbsp;is&nbsp;like&nbsp;DumpRequest&nbsp;but&nbsp;includes</span><br>
<span class="lineno"></span><span class="comment" id="5351659">//&nbsp;headers&nbsp;that&nbsp;the&nbsp;standard&nbsp;http.Transport&nbsp;adds,</span><br>
<span class="lineno">60</span><span class="comment" id="5351709">//&nbsp;such&nbsp;as&nbsp;User-Agent.</span><br>
<span class="lineno"></span><span class="keyword" id="5351732">func</span>&nbsp;<span class="ident" id="5351737">DumpRequestOut</span><span class="op" id="5351751">(</span><span class="ident" id="5351752">req</span>&nbsp;<span class="op" id="5351756">*</span><span class="ident" id="5351757">http</span><span class="op" id="5351761">.</span><span class="ident" id="5351762">Request</span><span class="op" id="5351769">,</span>&nbsp;<span class="ident" id="5351771">body</span>&nbsp;<span class="builtintype" id="5351776">bool</span><span class="op" id="5351780">)</span>&nbsp;<span class="op" id="5351782">(</span><span class="op" id="5351783">[</span><span class="op" id="5351784">]</span><span class="builtintype" id="5351785">byte</span><span class="op" id="5351789">,</span>&nbsp;<span class="builtintype" id="5351791">error</span><span class="op" id="5351796">)</span>&nbsp;<span class="op" id="5351798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5351801">save</span>&nbsp;<span class="op" id="5351806">:=</span>&nbsp;<span class="ident" id="5351809">req</span><span class="op" id="5351812">.</span><span class="ident" id="5351813">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5351819">dummyBody</span>&nbsp;<span class="op" id="5351829">:=</span>&nbsp;<span class="builtintype" id="5351832">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5351839">if</span>&nbsp;<span class="op" id="5351842">!</span><span class="ident" id="5351843">body</span>&nbsp;<span class="op" id="5351848">||</span>&nbsp;<span class="ident" id="5351851">req</span><span class="op" id="5351854">.</span><span class="ident" id="5351855">Body</span>&nbsp;<span class="op" id="5351860">==</span>&nbsp;<span class="ident" id="5351863">nil</span>&nbsp;<span class="op" id="5351867">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5351871">req</span><span class="op" id="5351874">.</span><span class="ident" id="5351875">Body</span>&nbsp;<span class="op" id="5351880">=</span>&nbsp;<span class="ident" id="5351882">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5351888">if</span>&nbsp;<span class="ident" id="5351891">req</span><span class="op" id="5351894">.</span><span class="ident" id="5351895">ContentLength</span>&nbsp;<span class="op" id="5351909">!=</span>&nbsp;<span class="num" id="5351912">0</span>&nbsp;<span class="op" id="5351914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5351919">req</span><span class="op" id="5351922">.</span><span class="ident" id="5351923">Body</span>&nbsp;<span class="op" id="5351928">=</span>&nbsp;<span class="ident" id="5351930">ioutil</span><span class="op" id="5351936">.</span><span class="ident" id="5351937">NopCloser</span><span class="op" id="5351946">(</span><span class="ident" id="5351947">io</span><span class="op" id="5351949">.</span><span class="ident" id="5351950">LimitReader</span><span class="op" id="5351961">(</span><span class="ident" id="5351962">neverEnding</span><span class="op" id="5351973">(</span><span class="string" id="5351974">&#39;x&#39;</span><span class="op" id="5351977">)</span><span class="op" id="5351978">,</span>&nbsp;<span class="ident" id="5351980">req</span><span class="op" id="5351983">.</span><span class="ident" id="5351984">ContentLength</span><span class="op" id="5351997">)</span><span class="op" id="5351998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5352003">dummyBody</span>&nbsp;<span class="op" id="5352013">=</span>&nbsp;<span class="builtintype" id="5352015">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5352022">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5352025">}</span>&nbsp;<span class="keyword" id="5352027">else</span>&nbsp;<span class="op" id="5352032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5352036">var</span>&nbsp;<span class="ident" id="5352040">err</span>&nbsp;<span class="builtintype" id="5352044">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5352052">save</span><span class="op" id="5352056">,</span>&nbsp;<span class="ident" id="5352058">req</span><span class="op" id="5352061">.</span><span class="ident" id="5352062">Body</span><span class="op" id="5352066">,</span>&nbsp;<span class="ident" id="5352068">err</span>&nbsp;<span class="op" id="5352072">=</span>&nbsp;<span class="ident" id="5352074">drainBody</span><span class="op" id="5352083">(</span><span class="ident" id="5352084">req</span><span class="op" id="5352087">.</span><span class="ident" id="5352088">Body</span><span class="op" id="5352092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5352096">if</span>&nbsp;<span class="ident" id="5352099">err</span>&nbsp;<span class="op" id="5352103">!=</span>&nbsp;<span class="ident" id="5352106">nil</span>&nbsp;<span class="op" id="5352110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5352115">return</span>&nbsp;<span class="ident" id="5352122">nil</span><span class="op" id="5352125">,</span>&nbsp;<span class="ident" id="5352127">err</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5352133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5352136">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5352140">//&nbsp;Since&nbsp;we&#39;re&nbsp;using&nbsp;the&nbsp;actual&nbsp;Transport&nbsp;code&nbsp;to&nbsp;write&nbsp;the&nbsp;request,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5352210">//&nbsp;switch&nbsp;to&nbsp;http&nbsp;so&nbsp;the&nbsp;Transport&nbsp;doesn&#39;t&nbsp;try&nbsp;to&nbsp;do&nbsp;an&nbsp;SSL</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5352271">//&nbsp;negotiation&nbsp;with&nbsp;our&nbsp;dumpConn&nbsp;and&nbsp;its&nbsp;bytes.Buffer&nbsp;&amp;&nbsp;pipe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5352334">//&nbsp;The&nbsp;wire&nbsp;format&nbsp;for&nbsp;https&nbsp;and&nbsp;http&nbsp;are&nbsp;the&nbsp;same,&nbsp;anyway.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5352395">reqSend</span>&nbsp;<span class="op" id="5352403">:=</span>&nbsp;<span class="ident" id="5352406">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5352411">if</span>&nbsp;<span class="ident" id="5352414">req</span><span class="op" id="5352417">.</span><span class="ident" id="5352418">URL</span><span class="op" id="5352421">.</span><span class="ident" id="5352422">Scheme</span>&nbsp;<span class="op" id="5352429">==</span>&nbsp;<span class="string" id="5352432">&#34;https&#34;</span>&nbsp;<span class="op" id="5352440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5352444">reqSend</span>&nbsp;<span class="op" id="5352452">=</span>&nbsp;<span class="builtinfunc" id="5352454">new</span><span class="op" id="5352457">(</span><span class="ident" id="5352458">http</span><span class="op" id="5352462">.</span><span class="ident" id="5352463">Request</span><span class="op" id="5352470">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5352474">*</span><span class="ident" id="5352475">reqSend</span>&nbsp;<span class="op" id="5352483">=</span>&nbsp;<span class="op" id="5352485">*</span><span class="ident" id="5352486">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5352492">reqSend</span><span class="op" id="5352499">.</span><span class="ident" id="5352500">URL</span>&nbsp;<span class="op" id="5352504">=</span>&nbsp;<span class="builtinfunc" id="5352506">new</span><span class="op" id="5352509">(</span><span class="ident" id="5352510">url</span><span class="op" id="5352513">.</span><span class="ident" id="5352514">URL</span><span class="op" id="5352517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5352521">*</span><span class="ident" id="5352522">reqSend</span><span class="op" id="5352529">.</span><span class="ident" id="5352530">URL</span>&nbsp;<span class="op" id="5352534">=</span>&nbsp;<span class="op" id="5352536">*</span><span class="ident" id="5352537">req</span><span class="op" id="5352540">.</span><span class="ident" id="5352541">URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5352547">reqSend</span><span class="op" id="5352554">.</span><span class="ident" id="5352555">URL</span><span class="op" id="5352558">.</span><span class="ident" id="5352559">Scheme</span>&nbsp;<span class="op" id="5352566">=</span>&nbsp;<span class="string" id="5352568">&#34;http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5352576">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5352580">//&nbsp;Use&nbsp;the&nbsp;actual&nbsp;Transport&nbsp;code&nbsp;to&nbsp;record&nbsp;what&nbsp;we&nbsp;would&nbsp;send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5352643">//&nbsp;on&nbsp;the&nbsp;wire,&nbsp;but&nbsp;not&nbsp;using&nbsp;TCP.&nbsp;&nbsp;Use&nbsp;a&nbsp;Transport&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5352703">//&nbsp;custom&nbsp;dialer&nbsp;that&nbsp;returns&nbsp;a&nbsp;fake&nbsp;net.Conn&nbsp;that&nbsp;waits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5352761">//&nbsp;for&nbsp;the&nbsp;full&nbsp;input&nbsp;(and&nbsp;recording&nbsp;it),&nbsp;and&nbsp;then&nbsp;responds</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5352822">//&nbsp;with&nbsp;a&nbsp;dummy&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5352849">var</span>&nbsp;<span class="ident" id="5352853">buf</span>&nbsp;<span class="ident" id="5352857">bytes</span><span class="op" id="5352862">.</span><span class="ident" id="5352863">Buffer</span>&nbsp;<span class="comment" id="5352870">//&nbsp;records&nbsp;the&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5352893">pr</span><span class="op" id="5352895">,</span>&nbsp;<span class="ident" id="5352897">pw</span>&nbsp;<span class="op" id="5352900">:=</span>&nbsp;<span class="ident" id="5352903">io</span><span class="op" id="5352905">.</span><span class="ident" id="5352906">Pipe</span><span class="op" id="5352910">(</span><span class="op" id="5352911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5352914">defer</span>&nbsp;<span class="ident" id="5352920">pr</span><span class="op" id="5352922">.</span><span class="ident" id="5352923">Close</span><span class="op" id="5352928">(</span><span class="op" id="5352929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5352932">defer</span>&nbsp;<span class="ident" id="5352938">pw</span><span class="op" id="5352940">.</span><span class="ident" id="5352941">Close</span><span class="op" id="5352946">(</span><span class="op" id="5352947">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5352950">dr</span>&nbsp;<span class="op" id="5352953">:=</span>&nbsp;<span class="op" id="5352956">&amp;</span><span class="ident" id="5352957">delegateReader</span><span class="op" id="5352971">{</span><span class="ident" id="5352972">c</span><span class="op" id="5352973">:</span>&nbsp;<span class="builtinfunc" id="5352975">make</span><span class="op" id="5352979">(</span><span class="keyword" id="5352980">chan</span>&nbsp;<span class="ident" id="5352985">io</span><span class="op" id="5352987">.</span><span class="ident" id="5352988">Reader</span><span class="op" id="5352994">)</span><span class="op" id="5352995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5352998">//&nbsp;Wait&nbsp;for&nbsp;the&nbsp;request&nbsp;before&nbsp;replying&nbsp;with&nbsp;a&nbsp;dummy&nbsp;response:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5353062">go</span>&nbsp;<span class="keyword" id="5353065">func</span><span class="op" id="5353069">(</span><span class="op" id="5353070">)</span>&nbsp;<span class="op" id="5353072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5353076">req</span><span class="op" id="5353079">,</span>&nbsp;<span class="ident" id="5353081">err</span>&nbsp;<span class="op" id="5353085">:=</span>&nbsp;<span class="ident" id="5353088">http</span><span class="op" id="5353092">.</span><span class="ident" id="5353093">ReadRequest</span><span class="op" id="5353104">(</span><span class="ident" id="5353105">bufio</span><span class="op" id="5353110">.</span><span class="ident" id="5353111">NewReader</span><span class="op" id="5353120">(</span><span class="ident" id="5353121">pr</span><span class="op" id="5353123">)</span><span class="op" id="5353124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5353128">if</span>&nbsp;<span class="ident" id="5353131">err</span>&nbsp;<span class="op" id="5353135">==</span>&nbsp;<span class="ident" id="5353138">nil</span>&nbsp;<span class="op" id="5353142">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5353147">//&nbsp;Ensure&nbsp;all&nbsp;the&nbsp;body&nbsp;is&nbsp;read;&nbsp;otherwise</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5353192">//&nbsp;we&#39;ll&nbsp;get&nbsp;a&nbsp;partial&nbsp;dump.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5353224">io</span><span class="op" id="5353226">.</span><span class="ident" id="5353227">Copy</span><span class="op" id="5353231">(</span><span class="ident" id="5353232">ioutil</span><span class="op" id="5353238">.</span><span class="ident" id="5353239">Discard</span><span class="op" id="5353246">,</span>&nbsp;<span class="ident" id="5353248">req</span><span class="op" id="5353251">.</span><span class="ident" id="5353252">Body</span><span class="op" id="5353256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5353261">req</span><span class="op" id="5353264">.</span><span class="ident" id="5353265">Body</span><span class="op" id="5353269">.</span><span class="ident" id="5353270">Close</span><span class="op" id="5353275">(</span><span class="op" id="5353276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5353280">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5353284">dr</span><span class="op" id="5353286">.</span><span class="ident" id="5353287">c</span>&nbsp;<span class="op" id="5353289">&lt;-</span>&nbsp;<span class="ident" id="5353292">strings</span><span class="op" id="5353299">.</span><span class="ident" id="5353300">NewReader</span><span class="op" id="5353309">(</span><span class="string" id="5353310">&#34;HTTP/1.1&nbsp;204&nbsp;No&nbsp;Content\r\n\r\n&#34;</span><span class="op" id="5353343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5353346">}</span><span class="op" id="5353347">(</span><span class="op" id="5353348">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5353352">t</span>&nbsp;<span class="op" id="5353354">:=</span>&nbsp;<span class="op" id="5353357">&amp;</span><span class="ident" id="5353358">http</span><span class="op" id="5353362">.</span><span class="ident" id="5353363">Transport</span><span class="op" id="5353372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5353376">DisableKeepAlives</span><span class="op" id="5353393">:</span>&nbsp;<span class="builtintype" id="5353395">true</span><span class="op" id="5353399">,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5353403">Dial</span><span class="op" id="5353407">:</span>&nbsp;<span class="keyword" id="5353409">func</span><span class="op" id="5353413">(</span><span class="ident" id="5353414">net</span><span class="op" id="5353417">,</span>&nbsp;<span class="ident" id="5353419">addr</span>&nbsp;<span class="builtintype" id="5353424">string</span><span class="op" id="5353430">)</span>&nbsp;<span class="op" id="5353432">(</span><span class="ident" id="5353433">net</span><span class="op" id="5353436">.</span><span class="ident" id="5353437">Conn</span><span class="op" id="5353441">,</span>&nbsp;<span class="builtintype" id="5353443">error</span><span class="op" id="5353448">)</span>&nbsp;<span class="op" id="5353450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5353455">return</span>&nbsp;<span class="op" id="5353462">&amp;</span><span class="ident" id="5353463">dumpConn</span><span class="op" id="5353471">{</span><span class="ident" id="5353472">io</span><span class="op" id="5353474">.</span><span class="ident" id="5353475">MultiWriter</span><span class="op" id="5353486">(</span><span class="op" id="5353487">&amp;</span><span class="ident" id="5353488">buf</span><span class="op" id="5353491">,</span>&nbsp;<span class="ident" id="5353493">pw</span><span class="op" id="5353495">)</span><span class="op" id="5353496">,</span>&nbsp;<span class="ident" id="5353498">dr</span><span class="op" id="5353500">}</span><span class="op" id="5353501">,</span>&nbsp;<span class="ident" id="5353503">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5353509">}</span><span class="op" id="5353510">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5353513">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5353517">_</span><span class="op" id="5353518">,</span>&nbsp;<span class="ident" id="5353520">err</span>&nbsp;<span class="op" id="5353524">:=</span>&nbsp;<span class="ident" id="5353527">t</span><span class="op" id="5353528">.</span><span class="ident" id="5353529">RoundTrip</span><span class="op" id="5353538">(</span><span class="ident" id="5353539">reqSend</span><span class="op" id="5353546">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5353550">req</span><span class="op" id="5353553">.</span><span class="ident" id="5353554">Body</span>&nbsp;<span class="op" id="5353559">=</span>&nbsp;<span class="ident" id="5353561">save</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5353567">if</span>&nbsp;<span class="ident" id="5353570">err</span>&nbsp;<span class="op" id="5353574">!=</span>&nbsp;<span class="ident" id="5353577">nil</span>&nbsp;<span class="op" id="5353581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5353585">return</span>&nbsp;<span class="ident" id="5353592">nil</span><span class="op" id="5353595">,</span>&nbsp;<span class="ident" id="5353597">err</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5353602">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5353605">dump</span>&nbsp;<span class="op" id="5353610">:=</span>&nbsp;<span class="ident" id="5353613">buf</span><span class="op" id="5353616">.</span><span class="ident" id="5353617">Bytes</span><span class="op" id="5353622">(</span><span class="op" id="5353623">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5353627">//&nbsp;If&nbsp;we&nbsp;used&nbsp;a&nbsp;dummy&nbsp;body&nbsp;above,&nbsp;remove&nbsp;it&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5353677">//&nbsp;TODO:&nbsp;if&nbsp;the&nbsp;req.ContentLength&nbsp;is&nbsp;large,&nbsp;we&nbsp;allocate&nbsp;memory</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5353741">//&nbsp;unnecessarily&nbsp;just&nbsp;to&nbsp;slice&nbsp;it&nbsp;off&nbsp;here.&nbsp;&nbsp;But&nbsp;this&nbsp;is&nbsp;just</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5353804">//&nbsp;a&nbsp;debug&nbsp;function,&nbsp;so&nbsp;this&nbsp;is&nbsp;acceptable&nbsp;for&nbsp;now.&nbsp;We&nbsp;could</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5353866">//&nbsp;discard&nbsp;the&nbsp;body&nbsp;earlier&nbsp;if&nbsp;this&nbsp;matters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5353912">if</span>&nbsp;<span class="ident" id="5353915">dummyBody</span>&nbsp;<span class="op" id="5353925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5353929">if</span>&nbsp;<span class="ident" id="5353932">i</span>&nbsp;<span class="op" id="5353934">:=</span>&nbsp;<span class="ident" id="5353937">bytes</span><span class="op" id="5353942">.</span><span class="ident" id="5353943">Index</span><span class="op" id="5353948">(</span><span class="ident" id="5353949">dump</span><span class="op" id="5353953">,</span>&nbsp;<span class="op" id="5353955">[</span><span class="op" id="5353956">]</span><span class="builtintype" id="5353957">byte</span><span class="op" id="5353961">(</span><span class="string" id="5353962">&#34;\r\n\r\n&#34;</span><span class="op" id="5353972">)</span><span class="op" id="5353973">)</span><span class="op" id="5353974">;</span>&nbsp;<span class="ident" id="5353976">i</span>&nbsp;<span class="op" id="5353978">&gt;=</span>&nbsp;<span class="num" id="5353981">0</span>&nbsp;<span class="op" id="5353983">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5353988">dump</span>&nbsp;<span class="op" id="5353993">=</span>&nbsp;<span class="ident" id="5353995">dump</span><span class="op" id="5353999">[</span><span class="op" id="5354000">:</span><span class="ident" id="5354001">i</span><span class="op" id="5354002">+</span><span class="num" id="5354003">4</span><span class="op" id="5354004">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5354008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5354011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5354014">return</span>&nbsp;<span class="ident" id="5354021">dump</span><span class="op" id="5354025">,</span>&nbsp;<span class="ident" id="5354027">nil</span><br>
<span class="lineno"></span><span class="op" id="5354031">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="comment" id="5354034">//&nbsp;delegateReader&nbsp;is&nbsp;a&nbsp;reader&nbsp;that&nbsp;delegates&nbsp;to&nbsp;another&nbsp;reader,</span><br>
<span class="lineno"></span><span class="comment" id="5354098">//&nbsp;once&nbsp;it&nbsp;arrives&nbsp;on&nbsp;a&nbsp;channel.</span><br>
<span class="lineno"></span><span class="keyword" id="5354131">type</span>&nbsp;<span class="ident" id="5354136">delegateReader</span>&nbsp;<span class="keyword" id="5354151">struct</span>&nbsp;<span class="op" id="5354158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5354161">c</span>&nbsp;<span class="keyword" id="5354163">chan</span>&nbsp;<span class="ident" id="5354168">io</span><span class="op" id="5354170">.</span><span class="ident" id="5354171">Reader</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5354179">r</span>&nbsp;<span class="ident" id="5354181">io</span><span class="op" id="5354183">.</span><span class="ident" id="5354184">Reader</span>&nbsp;<span class="comment" id="5354191">//&nbsp;nil&nbsp;until&nbsp;received&nbsp;from&nbsp;c</span><br>
<span class="lineno"></span><span class="op" id="5354220">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5354223">func</span>&nbsp;<span class="op" id="5354228">(</span><span class="ident" id="5354229">r</span>&nbsp;<span class="op" id="5354231">*</span><span class="ident" id="5354232">delegateReader</span><span class="op" id="5354246">)</span>&nbsp;<span class="ident" id="5354248">Read</span><span class="op" id="5354252">(</span><span class="ident" id="5354253">p</span>&nbsp;<span class="op" id="5354255">[</span><span class="op" id="5354256">]</span><span class="builtintype" id="5354257">byte</span><span class="op" id="5354261">)</span>&nbsp;<span class="op" id="5354263">(</span><span class="builtintype" id="5354264">int</span><span class="op" id="5354267">,</span>&nbsp;<span class="builtintype" id="5354269">error</span><span class="op" id="5354274">)</span>&nbsp;<span class="op" id="5354276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5354279">if</span>&nbsp;<span class="ident" id="5354282">r</span><span class="op" id="5354283">.</span><span class="ident" id="5354284">r</span>&nbsp;<span class="op" id="5354286">==</span>&nbsp;<span class="ident" id="5354289">nil</span>&nbsp;<span class="op" id="5354293">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5354297">r</span><span class="op" id="5354298">.</span><span class="ident" id="5354299">r</span>&nbsp;<span class="op" id="5354301">=</span>&nbsp;<span class="op" id="5354303">&lt;-</span><span class="ident" id="5354305">r</span><span class="op" id="5354306">.</span><span class="ident" id="5354307">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5354310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5354313">return</span>&nbsp;<span class="ident" id="5354320">r</span><span class="op" id="5354321">.</span><span class="ident" id="5354322">r</span><span class="op" id="5354323">.</span><span class="ident" id="5354324">Read</span><span class="op" id="5354328">(</span><span class="ident" id="5354329">p</span><span class="op" id="5354330">)</span><br>
<span class="lineno"></span><span class="op" id="5354332">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span><span class="comment" id="5354335">//&nbsp;Return&nbsp;value&nbsp;if&nbsp;nonempty,&nbsp;def&nbsp;otherwise.</span><br>
<span class="lineno"></span><span class="keyword" id="5354379">func</span>&nbsp;<span class="ident" id="5354384">valueOrDefault</span><span class="op" id="5354398">(</span><span class="ident" id="5354399">value</span><span class="op" id="5354404">,</span>&nbsp;<span class="ident" id="5354406">def</span>&nbsp;<span class="builtintype" id="5354410">string</span><span class="op" id="5354416">)</span>&nbsp;<span class="builtintype" id="5354418">string</span>&nbsp;<span class="op" id="5354425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5354428">if</span>&nbsp;<span class="ident" id="5354431">value</span>&nbsp;<span class="op" id="5354437">!=</span>&nbsp;<span class="string" id="5354440">&#34;&#34;</span>&nbsp;<span class="op" id="5354443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5354447">return</span>&nbsp;<span class="ident" id="5354454">value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5354461">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5354464">return</span>&nbsp;<span class="ident" id="5354471">def</span><br>
<span class="lineno"></span><span class="op" id="5354475">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5354478">var</span>&nbsp;<span class="ident" id="5354482">reqWriteExcludeHeaderDump</span>&nbsp;<span class="op" id="5354508">=</span>&nbsp;<span class="keyword" id="5354510">map</span><span class="op" id="5354513">[</span><span class="builtintype" id="5354514">string</span><span class="op" id="5354520">]</span><span class="builtintype" id="5354521">bool</span><span class="op" id="5354525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5354528">&#34;Host&#34;</span><span class="op" id="5354534">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5354549">true</span><span class="op" id="5354553">,</span>&nbsp;<span class="comment" id="5354555">//&nbsp;not&nbsp;in&nbsp;Header&nbsp;map&nbsp;anyway</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5354584">&#34;Content-Length&#34;</span><span class="op" id="5354600">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5354605">true</span><span class="op" id="5354609">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5354612">&#34;Transfer-Encoding&#34;</span><span class="op" id="5354631">:</span>&nbsp;<span class="builtintype" id="5354633">true</span><span class="op" id="5354637">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5354640">&#34;Trailer&#34;</span><span class="op" id="5354649">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5354661">true</span><span class="op" id="5354665">,</span><br>
<span class="lineno"></span><span class="op" id="5354667">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="comment" id="5354670">//&nbsp;dumpAsReceived&nbsp;writes&nbsp;req&nbsp;to&nbsp;w&nbsp;in&nbsp;the&nbsp;form&nbsp;as&nbsp;it&nbsp;was&nbsp;received,&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="5354739">//&nbsp;at&nbsp;least&nbsp;as&nbsp;accurately&nbsp;as&nbsp;possible&nbsp;from&nbsp;the&nbsp;information&nbsp;retained&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="5354810">//&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span><span class="keyword" id="5354826">func</span>&nbsp;<span class="ident" id="5354831">dumpAsReceived</span><span class="op" id="5354845">(</span><span class="ident" id="5354846">req</span>&nbsp;<span class="op" id="5354850">*</span><span class="ident" id="5354851">http</span><span class="op" id="5354855">.</span><span class="ident" id="5354856">Request</span><span class="op" id="5354863">,</span>&nbsp;<span class="ident" id="5354865">w</span>&nbsp;<span class="ident" id="5354867">io</span><span class="op" id="5354869">.</span><span class="ident" id="5354870">Writer</span><span class="op" id="5354876">)</span>&nbsp;<span class="builtintype" id="5354878">error</span>&nbsp;<span class="op" id="5354884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5354887">return</span>&nbsp;<span class="ident" id="5354894">nil</span><br>
<span class="lineno">175</span><span class="op" id="5354898">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5354901">//&nbsp;DumpRequest&nbsp;returns&nbsp;the&nbsp;as-received&nbsp;wire&nbsp;representation&nbsp;of&nbsp;req,</span><br>
<span class="lineno"></span><span class="comment" id="5354968">//&nbsp;optionally&nbsp;including&nbsp;the&nbsp;request&nbsp;body,&nbsp;for&nbsp;debugging.</span><br>
<span class="lineno"></span><span class="comment" id="5355025">//&nbsp;DumpRequest&nbsp;is&nbsp;semantically&nbsp;a&nbsp;no-op,&nbsp;but&nbsp;in&nbsp;order&nbsp;to</span><br>
<span class="lineno">180</span><span class="comment" id="5355081">//&nbsp;dump&nbsp;the&nbsp;body,&nbsp;it&nbsp;reads&nbsp;the&nbsp;body&nbsp;data&nbsp;into&nbsp;memory&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5355138">//&nbsp;changes&nbsp;req.Body&nbsp;to&nbsp;refer&nbsp;to&nbsp;the&nbsp;in-memory&nbsp;copy.</span><br>
<span class="lineno"></span><span class="comment" id="5355190">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;http.Request.Write&nbsp;details&nbsp;which&nbsp;fields</span><br>
<span class="lineno"></span><span class="comment" id="5355255">//&nbsp;of&nbsp;req&nbsp;are&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="5355275">func</span>&nbsp;<span class="ident" id="5355280">DumpRequest</span><span class="op" id="5355291">(</span><span class="ident" id="5355292">req</span>&nbsp;<span class="op" id="5355296">*</span><span class="ident" id="5355297">http</span><span class="op" id="5355301">.</span><span class="ident" id="5355302">Request</span><span class="op" id="5355309">,</span>&nbsp;<span class="ident" id="5355311">body</span>&nbsp;<span class="builtintype" id="5355316">bool</span><span class="op" id="5355320">)</span>&nbsp;<span class="op" id="5355322">(</span><span class="ident" id="5355323">dump</span>&nbsp;<span class="op" id="5355328">[</span><span class="op" id="5355329">]</span><span class="builtintype" id="5355330">byte</span><span class="op" id="5355334">,</span>&nbsp;<span class="ident" id="5355336">err</span>&nbsp;<span class="builtintype" id="5355340">error</span><span class="op" id="5355345">)</span>&nbsp;<span class="op" id="5355347">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5355350">save</span>&nbsp;<span class="op" id="5355355">:=</span>&nbsp;<span class="ident" id="5355358">req</span><span class="op" id="5355361">.</span><span class="ident" id="5355362">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5355368">if</span>&nbsp;<span class="op" id="5355371">!</span><span class="ident" id="5355372">body</span>&nbsp;<span class="op" id="5355377">||</span>&nbsp;<span class="ident" id="5355380">req</span><span class="op" id="5355383">.</span><span class="ident" id="5355384">Body</span>&nbsp;<span class="op" id="5355389">==</span>&nbsp;<span class="ident" id="5355392">nil</span>&nbsp;<span class="op" id="5355396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5355400">req</span><span class="op" id="5355403">.</span><span class="ident" id="5355404">Body</span>&nbsp;<span class="op" id="5355409">=</span>&nbsp;<span class="ident" id="5355411">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5355416">}</span>&nbsp;<span class="keyword" id="5355418">else</span>&nbsp;<span class="op" id="5355423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5355427">save</span><span class="op" id="5355431">,</span>&nbsp;<span class="ident" id="5355433">req</span><span class="op" id="5355436">.</span><span class="ident" id="5355437">Body</span><span class="op" id="5355441">,</span>&nbsp;<span class="ident" id="5355443">err</span>&nbsp;<span class="op" id="5355447">=</span>&nbsp;<span class="ident" id="5355449">drainBody</span><span class="op" id="5355458">(</span><span class="ident" id="5355459">req</span><span class="op" id="5355462">.</span><span class="ident" id="5355463">Body</span><span class="op" id="5355467">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5355471">if</span>&nbsp;<span class="ident" id="5355474">err</span>&nbsp;<span class="op" id="5355478">!=</span>&nbsp;<span class="ident" id="5355481">nil</span>&nbsp;<span class="op" id="5355485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5355490">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5355499">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5355502">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5355506">var</span>&nbsp;<span class="ident" id="5355510">b</span>&nbsp;<span class="ident" id="5355512">bytes</span><span class="op" id="5355517">.</span><span class="ident" id="5355518">Buffer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5355527">fmt</span><span class="op" id="5355530">.</span><span class="ident" id="5355531">Fprintf</span><span class="op" id="5355538">(</span><span class="op" id="5355539">&amp;</span><span class="ident" id="5355540">b</span><span class="op" id="5355541">,</span>&nbsp;<span class="string" id="5355543">&#34;%s&nbsp;%s&nbsp;HTTP/%d.%d\r\n&#34;</span><span class="op" id="5355565">,</span>&nbsp;<span class="ident" id="5355567">valueOrDefault</span><span class="op" id="5355581">(</span><span class="ident" id="5355582">req</span><span class="op" id="5355585">.</span><span class="ident" id="5355586">Method</span><span class="op" id="5355592">,</span>&nbsp;<span class="string" id="5355594">&#34;GET&#34;</span><span class="op" id="5355599">)</span><span class="op" id="5355600">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5355604">req</span><span class="op" id="5355607">.</span><span class="ident" id="5355608">URL</span><span class="op" id="5355611">.</span><span class="ident" id="5355612">RequestURI</span><span class="op" id="5355622">(</span><span class="op" id="5355623">)</span><span class="op" id="5355624">,</span>&nbsp;<span class="ident" id="5355626">req</span><span class="op" id="5355629">.</span><span class="ident" id="5355630">ProtoMajor</span><span class="op" id="5355640">,</span>&nbsp;<span class="ident" id="5355642">req</span><span class="op" id="5355645">.</span><span class="ident" id="5355646">ProtoMinor</span><span class="op" id="5355656">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5355660">host</span>&nbsp;<span class="op" id="5355665">:=</span>&nbsp;<span class="ident" id="5355668">req</span><span class="op" id="5355671">.</span><span class="ident" id="5355672">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5355678">if</span>&nbsp;<span class="ident" id="5355681">host</span>&nbsp;<span class="op" id="5355686">==</span>&nbsp;<span class="string" id="5355689">&#34;&#34;</span>&nbsp;<span class="op" id="5355692">&amp;&amp;</span>&nbsp;<span class="ident" id="5355695">req</span><span class="op" id="5355698">.</span><span class="ident" id="5355699">URL</span>&nbsp;<span class="op" id="5355703">!=</span>&nbsp;<span class="ident" id="5355706">nil</span>&nbsp;<span class="op" id="5355710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5355714">host</span>&nbsp;<span class="op" id="5355719">=</span>&nbsp;<span class="ident" id="5355721">req</span><span class="op" id="5355724">.</span><span class="ident" id="5355725">URL</span><span class="op" id="5355728">.</span><span class="ident" id="5355729">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5355735">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5355738">if</span>&nbsp;<span class="ident" id="5355741">host</span>&nbsp;<span class="op" id="5355746">!=</span>&nbsp;<span class="string" id="5355749">&#34;&#34;</span>&nbsp;<span class="op" id="5355752">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5355756">fmt</span><span class="op" id="5355759">.</span><span class="ident" id="5355760">Fprintf</span><span class="op" id="5355767">(</span><span class="op" id="5355768">&amp;</span><span class="ident" id="5355769">b</span><span class="op" id="5355770">,</span>&nbsp;<span class="string" id="5355772">&#34;Host:&nbsp;%s\r\n&#34;</span><span class="op" id="5355786">,</span>&nbsp;<span class="ident" id="5355788">host</span><span class="op" id="5355792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5355795">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5355799">chunked</span>&nbsp;<span class="op" id="5355807">:=</span>&nbsp;<span class="builtinfunc" id="5355810">len</span><span class="op" id="5355813">(</span><span class="ident" id="5355814">req</span><span class="op" id="5355817">.</span><span class="ident" id="5355818">TransferEncoding</span><span class="op" id="5355834">)</span>&nbsp;<span class="op" id="5355836">&gt;</span>&nbsp;<span class="num" id="5355838">0</span>&nbsp;<span class="op" id="5355840">&amp;&amp;</span>&nbsp;<span class="ident" id="5355843">req</span><span class="op" id="5355846">.</span><span class="ident" id="5355847">TransferEncoding</span><span class="op" id="5355863">[</span><span class="num" id="5355864">0</span><span class="op" id="5355865">]</span>&nbsp;<span class="op" id="5355867">==</span>&nbsp;<span class="string" id="5355870">&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5355881">if</span>&nbsp;<span class="builtinfunc" id="5355884">len</span><span class="op" id="5355887">(</span><span class="ident" id="5355888">req</span><span class="op" id="5355891">.</span><span class="ident" id="5355892">TransferEncoding</span><span class="op" id="5355908">)</span>&nbsp;<span class="op" id="5355910">&gt;</span>&nbsp;<span class="num" id="5355912">0</span>&nbsp;<span class="op" id="5355914">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5355918">fmt</span><span class="op" id="5355921">.</span><span class="ident" id="5355922">Fprintf</span><span class="op" id="5355929">(</span><span class="op" id="5355930">&amp;</span><span class="ident" id="5355931">b</span><span class="op" id="5355932">,</span>&nbsp;<span class="string" id="5355934">&#34;Transfer-Encoding:&nbsp;%s\r\n&#34;</span><span class="op" id="5355961">,</span>&nbsp;<span class="ident" id="5355963">strings</span><span class="op" id="5355970">.</span><span class="ident" id="5355971">Join</span><span class="op" id="5355975">(</span><span class="ident" id="5355976">req</span><span class="op" id="5355979">.</span><span class="ident" id="5355980">TransferEncoding</span><span class="op" id="5355996">,</span>&nbsp;<span class="string" id="5355998">&#34;,&#34;</span><span class="op" id="5356001">)</span><span class="op" id="5356002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5356005">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5356008">if</span>&nbsp;<span class="ident" id="5356011">req</span><span class="op" id="5356014">.</span><span class="ident" id="5356015">Close</span>&nbsp;<span class="op" id="5356021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5356025">fmt</span><span class="op" id="5356028">.</span><span class="ident" id="5356029">Fprintf</span><span class="op" id="5356036">(</span><span class="op" id="5356037">&amp;</span><span class="ident" id="5356038">b</span><span class="op" id="5356039">,</span>&nbsp;<span class="string" id="5356041">&#34;Connection:&nbsp;close\r\n&#34;</span><span class="op" id="5356064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5356067">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5356071">err</span>&nbsp;<span class="op" id="5356075">=</span>&nbsp;<span class="ident" id="5356077">req</span><span class="op" id="5356080">.</span><span class="ident" id="5356081">Header</span><span class="op" id="5356087">.</span><span class="ident" id="5356088">WriteSubset</span><span class="op" id="5356099">(</span><span class="op" id="5356100">&amp;</span><span class="ident" id="5356101">b</span><span class="op" id="5356102">,</span>&nbsp;<span class="ident" id="5356104">reqWriteExcludeHeaderDump</span><span class="op" id="5356129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5356132">if</span>&nbsp;<span class="ident" id="5356135">err</span>&nbsp;<span class="op" id="5356139">!=</span>&nbsp;<span class="ident" id="5356142">nil</span>&nbsp;<span class="op" id="5356146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5356150">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5356158">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5356162">io</span><span class="op" id="5356164">.</span><span class="ident" id="5356165">WriteString</span><span class="op" id="5356176">(</span><span class="op" id="5356177">&amp;</span><span class="ident" id="5356178">b</span><span class="op" id="5356179">,</span>&nbsp;<span class="string" id="5356181">&#34;\r\n&#34;</span><span class="op" id="5356187">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5356191">if</span>&nbsp;<span class="ident" id="5356194">req</span><span class="op" id="5356197">.</span><span class="ident" id="5356198">Body</span>&nbsp;<span class="op" id="5356203">!=</span>&nbsp;<span class="ident" id="5356206">nil</span>&nbsp;<span class="op" id="5356210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5356214">var</span>&nbsp;<span class="ident" id="5356218">dest</span>&nbsp;<span class="ident" id="5356223">io</span><span class="op" id="5356225">.</span><span class="ident" id="5356226">Writer</span>&nbsp;<span class="op" id="5356233">=</span>&nbsp;<span class="op" id="5356235">&amp;</span><span class="ident" id="5356236">b</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5356240">if</span>&nbsp;<span class="ident" id="5356243">chunked</span>&nbsp;<span class="op" id="5356251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5356256">dest</span>&nbsp;<span class="op" id="5356261">=</span>&nbsp;<span class="ident" id="5356263">NewChunkedWriter</span><span class="op" id="5356279">(</span><span class="ident" id="5356280">dest</span><span class="op" id="5356284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5356288">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5356292">_</span><span class="op" id="5356293">,</span>&nbsp;<span class="ident" id="5356295">err</span>&nbsp;<span class="op" id="5356299">=</span>&nbsp;<span class="ident" id="5356301">io</span><span class="op" id="5356303">.</span><span class="ident" id="5356304">Copy</span><span class="op" id="5356308">(</span><span class="ident" id="5356309">dest</span><span class="op" id="5356313">,</span>&nbsp;<span class="ident" id="5356315">req</span><span class="op" id="5356318">.</span><span class="ident" id="5356319">Body</span><span class="op" id="5356323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5356327">if</span>&nbsp;<span class="ident" id="5356330">chunked</span>&nbsp;<span class="op" id="5356338">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5356343">dest</span><span class="op" id="5356347">.</span><span class="op" id="5356348">(</span><span class="ident" id="5356349">io</span><span class="op" id="5356351">.</span><span class="ident" id="5356352">Closer</span><span class="op" id="5356358">)</span><span class="op" id="5356359">.</span><span class="ident" id="5356360">Close</span><span class="op" id="5356365">(</span><span class="op" id="5356366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5356371">io</span><span class="op" id="5356373">.</span><span class="ident" id="5356374">WriteString</span><span class="op" id="5356385">(</span><span class="op" id="5356386">&amp;</span><span class="ident" id="5356387">b</span><span class="op" id="5356388">,</span>&nbsp;<span class="string" id="5356390">&#34;\r\n&#34;</span><span class="op" id="5356396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5356400">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5356403">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5356407">req</span><span class="op" id="5356410">.</span><span class="ident" id="5356411">Body</span>&nbsp;<span class="op" id="5356416">=</span>&nbsp;<span class="ident" id="5356418">save</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5356424">if</span>&nbsp;<span class="ident" id="5356427">err</span>&nbsp;<span class="op" id="5356431">!=</span>&nbsp;<span class="ident" id="5356434">nil</span>&nbsp;<span class="op" id="5356438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5356442">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5356450">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5356453">dump</span>&nbsp;<span class="op" id="5356458">=</span>&nbsp;<span class="ident" id="5356460">b</span><span class="op" id="5356461">.</span><span class="ident" id="5356462">Bytes</span><span class="op" id="5356467">(</span><span class="op" id="5356468">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5356471">return</span><br>
<span class="lineno"></span><span class="op" id="5356478">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5356481">//&nbsp;errNoBody&nbsp;is&nbsp;a&nbsp;sentinel&nbsp;error&nbsp;value&nbsp;used&nbsp;by&nbsp;failureToReadBody&nbsp;so&nbsp;we&nbsp;can&nbsp;detect</span><br>
<span class="lineno"></span><span class="comment" id="5356563">//&nbsp;that&nbsp;the&nbsp;lack&nbsp;of&nbsp;body&nbsp;was&nbsp;intentional.</span><br>
<span class="lineno">245</span><span class="keyword" id="5356605">var</span>&nbsp;<span class="ident" id="5356609">errNoBody</span>&nbsp;<span class="op" id="5356619">=</span>&nbsp;<span class="ident" id="5356621">errors</span><span class="op" id="5356627">.</span><span class="ident" id="5356628">New</span><span class="op" id="5356631">(</span><span class="string" id="5356632">&#34;sentinel&nbsp;error&nbsp;value&#34;</span><span class="op" id="5356654">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5356657">//&nbsp;failureToReadBody&nbsp;is&nbsp;a&nbsp;io.ReadCloser&nbsp;that&nbsp;just&nbsp;returns&nbsp;errNoBody&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="5356728">//&nbsp;Read.&nbsp;&nbsp;It&#39;s&nbsp;swapped&nbsp;in&nbsp;when&nbsp;we&nbsp;don&#39;t&nbsp;actually&nbsp;want&nbsp;to&nbsp;consume&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5356797">//&nbsp;body,&nbsp;but&nbsp;need&nbsp;a&nbsp;non-nil&nbsp;one,&nbsp;and&nbsp;want&nbsp;to&nbsp;distinguish&nbsp;the&nbsp;error</span><br>
<span class="lineno">250</span><span class="comment" id="5356864">//&nbsp;from&nbsp;reading&nbsp;the&nbsp;dummy&nbsp;body.</span><br>
<span class="lineno"></span><span class="keyword" id="5356896">type</span>&nbsp;<span class="ident" id="5356901">failureToReadBody</span>&nbsp;<span class="keyword" id="5356919">struct</span><span class="op" id="5356925">{</span><span class="op" id="5356926">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5356929">func</span>&nbsp;<span class="op" id="5356934">(</span><span class="ident" id="5356935">failureToReadBody</span><span class="op" id="5356952">)</span>&nbsp;<span class="ident" id="5356954">Read</span><span class="op" id="5356958">(</span><span class="op" id="5356959">[</span><span class="op" id="5356960">]</span><span class="builtintype" id="5356961">byte</span><span class="op" id="5356965">)</span>&nbsp;<span class="op" id="5356967">(</span><span class="builtintype" id="5356968">int</span><span class="op" id="5356971">,</span>&nbsp;<span class="builtintype" id="5356973">error</span><span class="op" id="5356978">)</span>&nbsp;<span class="op" id="5356980">{</span>&nbsp;<span class="keyword" id="5356982">return</span>&nbsp;<span class="num" id="5356989">0</span><span class="op" id="5356990">,</span>&nbsp;<span class="ident" id="5356992">errNoBody</span>&nbsp;<span class="op" id="5357002">}</span><br>
<span class="lineno"></span><span class="keyword" id="5357004">func</span>&nbsp;<span class="op" id="5357009">(</span><span class="ident" id="5357010">failureToReadBody</span><span class="op" id="5357027">)</span>&nbsp;<span class="ident" id="5357029">Close</span><span class="op" id="5357034">(</span><span class="op" id="5357035">)</span>&nbsp;<span class="builtintype" id="5357037">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5357055">{</span>&nbsp;<span class="keyword" id="5357057">return</span>&nbsp;<span class="ident" id="5357064">nil</span>&nbsp;<span class="op" id="5357068">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="5357071">var</span>&nbsp;<span class="ident" id="5357075">emptyBody</span>&nbsp;<span class="op" id="5357085">=</span>&nbsp;<span class="ident" id="5357087">ioutil</span><span class="op" id="5357093">.</span><span class="ident" id="5357094">NopCloser</span><span class="op" id="5357103">(</span><span class="ident" id="5357104">strings</span><span class="op" id="5357111">.</span><span class="ident" id="5357112">NewReader</span><span class="op" id="5357121">(</span><span class="string" id="5357122">&#34;&#34;</span><span class="op" id="5357124">)</span><span class="op" id="5357125">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5357128">//&nbsp;DumpResponse&nbsp;is&nbsp;like&nbsp;DumpRequest&nbsp;but&nbsp;dumps&nbsp;a&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="5357186">func</span>&nbsp;<span class="ident" id="5357191">DumpResponse</span><span class="op" id="5357203">(</span><span class="ident" id="5357204">resp</span>&nbsp;<span class="op" id="5357209">*</span><span class="ident" id="5357210">http</span><span class="op" id="5357214">.</span><span class="ident" id="5357215">Response</span><span class="op" id="5357223">,</span>&nbsp;<span class="ident" id="5357225">body</span>&nbsp;<span class="builtintype" id="5357230">bool</span><span class="op" id="5357234">)</span>&nbsp;<span class="op" id="5357236">(</span><span class="ident" id="5357237">dump</span>&nbsp;<span class="op" id="5357242">[</span><span class="op" id="5357243">]</span><span class="builtintype" id="5357244">byte</span><span class="op" id="5357248">,</span>&nbsp;<span class="ident" id="5357250">err</span>&nbsp;<span class="builtintype" id="5357254">error</span><span class="op" id="5357259">)</span>&nbsp;<span class="op" id="5357261">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5357264">var</span>&nbsp;<span class="ident" id="5357268">b</span>&nbsp;<span class="ident" id="5357270">bytes</span><span class="op" id="5357275">.</span><span class="ident" id="5357276">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5357284">save</span>&nbsp;<span class="op" id="5357289">:=</span>&nbsp;<span class="ident" id="5357292">resp</span><span class="op" id="5357296">.</span><span class="ident" id="5357297">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5357303">savecl</span>&nbsp;<span class="op" id="5357310">:=</span>&nbsp;<span class="ident" id="5357313">resp</span><span class="op" id="5357317">.</span><span class="ident" id="5357318">ContentLength</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5357334">if</span>&nbsp;<span class="op" id="5357337">!</span><span class="ident" id="5357338">body</span>&nbsp;<span class="op" id="5357343">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5357347">resp</span><span class="op" id="5357351">.</span><span class="ident" id="5357352">Body</span>&nbsp;<span class="op" id="5357357">=</span>&nbsp;<span class="ident" id="5357359">failureToReadBody</span><span class="op" id="5357376">{</span><span class="op" id="5357377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5357380">}</span>&nbsp;<span class="keyword" id="5357382">else</span>&nbsp;<span class="keyword" id="5357387">if</span>&nbsp;<span class="ident" id="5357390">resp</span><span class="op" id="5357394">.</span><span class="ident" id="5357395">Body</span>&nbsp;<span class="op" id="5357400">==</span>&nbsp;<span class="ident" id="5357403">nil</span>&nbsp;<span class="op" id="5357407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5357411">resp</span><span class="op" id="5357415">.</span><span class="ident" id="5357416">Body</span>&nbsp;<span class="op" id="5357421">=</span>&nbsp;<span class="ident" id="5357423">emptyBody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5357434">}</span>&nbsp;<span class="keyword" id="5357436">else</span>&nbsp;<span class="op" id="5357441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5357445">save</span><span class="op" id="5357449">,</span>&nbsp;<span class="ident" id="5357451">resp</span><span class="op" id="5357455">.</span><span class="ident" id="5357456">Body</span><span class="op" id="5357460">,</span>&nbsp;<span class="ident" id="5357462">err</span>&nbsp;<span class="op" id="5357466">=</span>&nbsp;<span class="ident" id="5357468">drainBody</span><span class="op" id="5357477">(</span><span class="ident" id="5357478">resp</span><span class="op" id="5357482">.</span><span class="ident" id="5357483">Body</span><span class="op" id="5357487">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5357491">if</span>&nbsp;<span class="ident" id="5357494">err</span>&nbsp;<span class="op" id="5357498">!=</span>&nbsp;<span class="ident" id="5357501">nil</span>&nbsp;<span class="op" id="5357505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5357510">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5357519">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5357522">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5357525">err</span>&nbsp;<span class="op" id="5357529">=</span>&nbsp;<span class="ident" id="5357531">resp</span><span class="op" id="5357535">.</span><span class="ident" id="5357536">Write</span><span class="op" id="5357541">(</span><span class="op" id="5357542">&amp;</span><span class="ident" id="5357543">b</span><span class="op" id="5357544">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5357547">if</span>&nbsp;<span class="ident" id="5357550">err</span>&nbsp;<span class="op" id="5357554">==</span>&nbsp;<span class="ident" id="5357557">errNoBody</span>&nbsp;<span class="op" id="5357567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5357571">err</span>&nbsp;<span class="op" id="5357575">=</span>&nbsp;<span class="ident" id="5357577">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5357582">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5357585">resp</span><span class="op" id="5357589">.</span><span class="ident" id="5357590">Body</span>&nbsp;<span class="op" id="5357595">=</span>&nbsp;<span class="ident" id="5357597">save</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5357603">resp</span><span class="op" id="5357607">.</span><span class="ident" id="5357608">ContentLength</span>&nbsp;<span class="op" id="5357622">=</span>&nbsp;<span class="ident" id="5357624">savecl</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5357632">if</span>&nbsp;<span class="ident" id="5357635">err</span>&nbsp;<span class="op" id="5357639">!=</span>&nbsp;<span class="ident" id="5357642">nil</span>&nbsp;<span class="op" id="5357646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5357650">return</span>&nbsp;<span class="ident" id="5357657">nil</span><span class="op" id="5357660">,</span>&nbsp;<span class="ident" id="5357662">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5357667">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5357670">return</span>&nbsp;<span class="ident" id="5357677">b</span><span class="op" id="5357678">.</span><span class="ident" id="5357679">Bytes</span><span class="op" id="5357684">(</span><span class="op" id="5357685">)</span><span class="op" id="5357686">,</span>&nbsp;<span class="ident" id="5357688">nil</span><br>
<span class="lineno"></span><span class="op" id="5357692">}</span>
</div>
</body>
</html>
