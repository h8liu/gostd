<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html" class="current">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1368158">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1368213">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1368267">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1368318">package</span>&nbsp;<span class="ident" id="1368326">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1368332">import</span>&nbsp;<span class="op" id="1368339">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1368342">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1368357">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><span class="op" id="1368366">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1368369">//&nbsp;An&nbsp;RWMutex&nbsp;is&nbsp;a&nbsp;reader/writer&nbsp;mutual&nbsp;exclusion&nbsp;lock.</span><br>
<span class="lineno"></span><span class="comment" id="1368425">//&nbsp;The&nbsp;lock&nbsp;can&nbsp;be&nbsp;held&nbsp;by&nbsp;an&nbsp;arbitrary&nbsp;number&nbsp;of&nbsp;readers</span><br>
<span class="lineno"></span><span class="comment" id="1368483">//&nbsp;or&nbsp;a&nbsp;single&nbsp;writer.</span><br>
<span class="lineno">15</span><span class="comment" id="1368506">//&nbsp;RWMutexes&nbsp;can&nbsp;be&nbsp;created&nbsp;as&nbsp;part&nbsp;of&nbsp;other</span><br>
<span class="lineno"></span><span class="comment" id="1368551">//&nbsp;structures;&nbsp;the&nbsp;zero&nbsp;value&nbsp;for&nbsp;a&nbsp;RWMutex&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1368598">//&nbsp;an&nbsp;unlocked&nbsp;mutex.</span><br>
<span class="lineno"></span><span class="keyword" id="1368620">type</span>&nbsp;<span class="ident" id="1368625">RWMutex</span>&nbsp;<span class="keyword" id="1368633">struct</span>&nbsp;<span class="op" id="1368640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1368643">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1368655">Mutex</span>&nbsp;&nbsp;<span class="comment" id="1368662">//&nbsp;held&nbsp;if&nbsp;there&nbsp;are&nbsp;pending&nbsp;writers</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1368700">writerSem</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1368712">uint32</span>&nbsp;<span class="comment" id="1368719">//&nbsp;semaphore&nbsp;for&nbsp;writers&nbsp;to&nbsp;wait&nbsp;for&nbsp;completing&nbsp;readers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1368776">readerSem</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1368788">uint32</span>&nbsp;<span class="comment" id="1368795">//&nbsp;semaphore&nbsp;for&nbsp;readers&nbsp;to&nbsp;wait&nbsp;for&nbsp;completing&nbsp;writers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1368852">readerCount</span>&nbsp;<span class="builtintype" id="1368864">int32</span>&nbsp;&nbsp;<span class="comment" id="1368871">//&nbsp;number&nbsp;of&nbsp;pending&nbsp;readers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1368901">readerWait</span>&nbsp;&nbsp;<span class="builtintype" id="1368913">int32</span>&nbsp;&nbsp;<span class="comment" id="1368920">//&nbsp;number&nbsp;of&nbsp;departing&nbsp;readers</span><br>
<span class="lineno"></span><span class="op" id="1368951">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="1368954">const</span>&nbsp;<span class="ident" id="1368960">rwmutexMaxReaders</span>&nbsp;<span class="op" id="1368978">=</span>&nbsp;<span class="num" id="1368980">1</span>&nbsp;<span class="op" id="1368982">&lt;&lt;</span>&nbsp;<span class="num" id="1368985">30</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1368989">//&nbsp;RLock&nbsp;locks&nbsp;rw&nbsp;for&nbsp;reading.</span><br>
<span class="lineno"></span><span class="keyword" id="1369020">func</span>&nbsp;<span class="op" id="1369025">(</span><span class="ident" id="1369026">rw</span>&nbsp;<span class="op" id="1369029">*</span><span class="ident" id="1369030">RWMutex</span><span class="op" id="1369037">)</span>&nbsp;<span class="ident" id="1369039">RLock</span><span class="op" id="1369044">(</span><span class="op" id="1369045">)</span>&nbsp;<span class="op" id="1369047">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1369050">if</span>&nbsp;<span class="ident" id="1369053">raceenabled</span>&nbsp;<span class="op" id="1369065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1369069">_</span>&nbsp;<span class="op" id="1369071">=</span>&nbsp;<span class="ident" id="1369073">rw</span><span class="op" id="1369075">.</span><span class="ident" id="1369076">w</span><span class="op" id="1369077">.</span><span class="ident" id="1369078">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1369086">raceDisable</span><span class="op" id="1369097">(</span><span class="op" id="1369098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1369101">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1369104">if</span>&nbsp;<span class="ident" id="1369107">atomic</span><span class="op" id="1369113">.</span><span class="ident" id="1369114">AddInt32</span><span class="op" id="1369122">(</span><span class="op" id="1369123">&amp;</span><span class="ident" id="1369124">rw</span><span class="op" id="1369126">.</span><span class="ident" id="1369127">readerCount</span><span class="op" id="1369138">,</span>&nbsp;<span class="num" id="1369140">1</span><span class="op" id="1369141">)</span>&nbsp;<span class="op" id="1369143">&lt;</span>&nbsp;<span class="num" id="1369145">0</span>&nbsp;<span class="op" id="1369147">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1369151">//&nbsp;A&nbsp;writer&nbsp;is&nbsp;pending,&nbsp;wait&nbsp;for&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1369190">runtime_Semacquire</span><span class="op" id="1369208">(</span><span class="op" id="1369209">&amp;</span><span class="ident" id="1369210">rw</span><span class="op" id="1369212">.</span><span class="ident" id="1369213">readerSem</span><span class="op" id="1369222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1369225">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1369228">if</span>&nbsp;<span class="ident" id="1369231">raceenabled</span>&nbsp;<span class="op" id="1369243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1369247">raceEnable</span><span class="op" id="1369257">(</span><span class="op" id="1369258">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1369262">raceAcquire</span><span class="op" id="1369273">(</span><span class="ident" id="1369274">unsafe</span><span class="op" id="1369280">.</span><span class="ident" id="1369281">Pointer</span><span class="op" id="1369288">(</span><span class="op" id="1369289">&amp;</span><span class="ident" id="1369290">rw</span><span class="op" id="1369292">.</span><span class="ident" id="1369293">readerSem</span><span class="op" id="1369302">)</span><span class="op" id="1369303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1369306">}</span><br>
<span class="lineno"></span><span class="op" id="1369308">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1369311">//&nbsp;RUnlock&nbsp;undoes&nbsp;a&nbsp;single&nbsp;RLock&nbsp;call;</span><br>
<span class="lineno">45</span><span class="comment" id="1369350">//&nbsp;it&nbsp;does&nbsp;not&nbsp;affect&nbsp;other&nbsp;simultaneous&nbsp;readers.</span><br>
<span class="lineno"></span><span class="comment" id="1369400">//&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error&nbsp;if&nbsp;rw&nbsp;is&nbsp;not&nbsp;locked&nbsp;for&nbsp;reading</span><br>
<span class="lineno"></span><span class="comment" id="1369458">//&nbsp;on&nbsp;entry&nbsp;to&nbsp;RUnlock.</span><br>
<span class="lineno"></span><span class="keyword" id="1369482">func</span>&nbsp;<span class="op" id="1369487">(</span><span class="ident" id="1369488">rw</span>&nbsp;<span class="op" id="1369491">*</span><span class="ident" id="1369492">RWMutex</span><span class="op" id="1369499">)</span>&nbsp;<span class="ident" id="1369501">RUnlock</span><span class="op" id="1369508">(</span><span class="op" id="1369509">)</span>&nbsp;<span class="op" id="1369511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1369514">if</span>&nbsp;<span class="ident" id="1369517">raceenabled</span>&nbsp;<span class="op" id="1369529">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1369533">_</span>&nbsp;<span class="op" id="1369535">=</span>&nbsp;<span class="ident" id="1369537">rw</span><span class="op" id="1369539">.</span><span class="ident" id="1369540">w</span><span class="op" id="1369541">.</span><span class="ident" id="1369542">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1369550">raceReleaseMerge</span><span class="op" id="1369566">(</span><span class="ident" id="1369567">unsafe</span><span class="op" id="1369573">.</span><span class="ident" id="1369574">Pointer</span><span class="op" id="1369581">(</span><span class="op" id="1369582">&amp;</span><span class="ident" id="1369583">rw</span><span class="op" id="1369585">.</span><span class="ident" id="1369586">writerSem</span><span class="op" id="1369595">)</span><span class="op" id="1369596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1369600">raceDisable</span><span class="op" id="1369611">(</span><span class="op" id="1369612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1369615">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1369618">if</span>&nbsp;<span class="ident" id="1369621">r</span>&nbsp;<span class="op" id="1369623">:=</span>&nbsp;<span class="ident" id="1369626">atomic</span><span class="op" id="1369632">.</span><span class="ident" id="1369633">AddInt32</span><span class="op" id="1369641">(</span><span class="op" id="1369642">&amp;</span><span class="ident" id="1369643">rw</span><span class="op" id="1369645">.</span><span class="ident" id="1369646">readerCount</span><span class="op" id="1369657">,</span>&nbsp;<span class="op" id="1369659">-</span><span class="num" id="1369660">1</span><span class="op" id="1369661">)</span><span class="op" id="1369662">;</span>&nbsp;<span class="ident" id="1369664">r</span>&nbsp;<span class="op" id="1369666">&lt;</span>&nbsp;<span class="num" id="1369668">0</span>&nbsp;<span class="op" id="1369670">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1369674">if</span>&nbsp;<span class="ident" id="1369677">r</span><span class="op" id="1369678">+</span><span class="num" id="1369679">1</span>&nbsp;<span class="op" id="1369681">==</span>&nbsp;<span class="num" id="1369684">0</span>&nbsp;<span class="op" id="1369686">||</span>&nbsp;<span class="ident" id="1369689">r</span><span class="op" id="1369690">+</span><span class="num" id="1369691">1</span>&nbsp;<span class="op" id="1369693">==</span>&nbsp;<span class="op" id="1369696">-</span><span class="ident" id="1369697">rwmutexMaxReaders</span>&nbsp;<span class="op" id="1369715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1369720">raceEnable</span><span class="op" id="1369730">(</span><span class="op" id="1369731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1369736">panic</span><span class="op" id="1369741">(</span><span class="string" id="1369742">&#34;sync:&nbsp;RUnlock&nbsp;of&nbsp;unlocked&nbsp;RWMutex&#34;</span><span class="op" id="1369777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1369781">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1369785">//&nbsp;A&nbsp;writer&nbsp;is&nbsp;pending.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1369811">if</span>&nbsp;<span class="ident" id="1369814">atomic</span><span class="op" id="1369820">.</span><span class="ident" id="1369821">AddInt32</span><span class="op" id="1369829">(</span><span class="op" id="1369830">&amp;</span><span class="ident" id="1369831">rw</span><span class="op" id="1369833">.</span><span class="ident" id="1369834">readerWait</span><span class="op" id="1369844">,</span>&nbsp;<span class="op" id="1369846">-</span><span class="num" id="1369847">1</span><span class="op" id="1369848">)</span>&nbsp;<span class="op" id="1369850">==</span>&nbsp;<span class="num" id="1369853">0</span>&nbsp;<span class="op" id="1369855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1369860">//&nbsp;The&nbsp;last&nbsp;reader&nbsp;unblocks&nbsp;the&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1369903">runtime_Semrelease</span><span class="op" id="1369921">(</span><span class="op" id="1369922">&amp;</span><span class="ident" id="1369923">rw</span><span class="op" id="1369925">.</span><span class="ident" id="1369926">writerSem</span><span class="op" id="1369935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1369939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1369942">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1369945">if</span>&nbsp;<span class="ident" id="1369948">raceenabled</span>&nbsp;<span class="op" id="1369960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1369964">raceEnable</span><span class="op" id="1369974">(</span><span class="op" id="1369975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1369978">}</span><br>
<span class="lineno"></span><span class="op" id="1369980">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="comment" id="1369983">//&nbsp;Lock&nbsp;locks&nbsp;rw&nbsp;for&nbsp;writing.</span><br>
<span class="lineno"></span><span class="comment" id="1370013">//&nbsp;If&nbsp;the&nbsp;lock&nbsp;is&nbsp;already&nbsp;locked&nbsp;for&nbsp;reading&nbsp;or&nbsp;writing,</span><br>
<span class="lineno"></span><span class="comment" id="1370070">//&nbsp;Lock&nbsp;blocks&nbsp;until&nbsp;the&nbsp;lock&nbsp;is&nbsp;available.</span><br>
<span class="lineno"></span><span class="comment" id="1370114">//&nbsp;To&nbsp;ensure&nbsp;that&nbsp;the&nbsp;lock&nbsp;eventually&nbsp;becomes&nbsp;available,</span><br>
<span class="lineno"></span><span class="comment" id="1370171">//&nbsp;a&nbsp;blocked&nbsp;Lock&nbsp;call&nbsp;excludes&nbsp;new&nbsp;readers&nbsp;from&nbsp;acquiring</span><br>
<span class="lineno">75</span><span class="comment" id="1370230">//&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="keyword" id="1370243">func</span>&nbsp;<span class="op" id="1370248">(</span><span class="ident" id="1370249">rw</span>&nbsp;<span class="op" id="1370252">*</span><span class="ident" id="1370253">RWMutex</span><span class="op" id="1370260">)</span>&nbsp;<span class="ident" id="1370262">Lock</span><span class="op" id="1370266">(</span><span class="op" id="1370267">)</span>&nbsp;<span class="op" id="1370269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1370272">if</span>&nbsp;<span class="ident" id="1370275">raceenabled</span>&nbsp;<span class="op" id="1370287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1370291">_</span>&nbsp;<span class="op" id="1370293">=</span>&nbsp;<span class="ident" id="1370295">rw</span><span class="op" id="1370297">.</span><span class="ident" id="1370298">w</span><span class="op" id="1370299">.</span><span class="ident" id="1370300">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1370308">raceDisable</span><span class="op" id="1370319">(</span><span class="op" id="1370320">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1370323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1370326">//&nbsp;First,&nbsp;resolve&nbsp;competition&nbsp;with&nbsp;other&nbsp;writers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1370377">rw</span><span class="op" id="1370379">.</span><span class="ident" id="1370380">w</span><span class="op" id="1370381">.</span><span class="ident" id="1370382">Lock</span><span class="op" id="1370386">(</span><span class="op" id="1370387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1370390">//&nbsp;Announce&nbsp;to&nbsp;readers&nbsp;there&nbsp;is&nbsp;a&nbsp;pending&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1370441">r</span>&nbsp;<span class="op" id="1370443">:=</span>&nbsp;<span class="ident" id="1370446">atomic</span><span class="op" id="1370452">.</span><span class="ident" id="1370453">AddInt32</span><span class="op" id="1370461">(</span><span class="op" id="1370462">&amp;</span><span class="ident" id="1370463">rw</span><span class="op" id="1370465">.</span><span class="ident" id="1370466">readerCount</span><span class="op" id="1370477">,</span>&nbsp;<span class="op" id="1370479">-</span><span class="ident" id="1370480">rwmutexMaxReaders</span><span class="op" id="1370497">)</span>&nbsp;<span class="op" id="1370499">+</span>&nbsp;<span class="ident" id="1370501">rwmutexMaxReaders</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1370520">//&nbsp;Wait&nbsp;for&nbsp;active&nbsp;readers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1370549">if</span>&nbsp;<span class="ident" id="1370552">r</span>&nbsp;<span class="op" id="1370554">!=</span>&nbsp;<span class="num" id="1370557">0</span>&nbsp;<span class="op" id="1370559">&amp;&amp;</span>&nbsp;<span class="ident" id="1370562">atomic</span><span class="op" id="1370568">.</span><span class="ident" id="1370569">AddInt32</span><span class="op" id="1370577">(</span><span class="op" id="1370578">&amp;</span><span class="ident" id="1370579">rw</span><span class="op" id="1370581">.</span><span class="ident" id="1370582">readerWait</span><span class="op" id="1370592">,</span>&nbsp;<span class="ident" id="1370594">r</span><span class="op" id="1370595">)</span>&nbsp;<span class="op" id="1370597">!=</span>&nbsp;<span class="num" id="1370600">0</span>&nbsp;<span class="op" id="1370602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1370606">runtime_Semacquire</span><span class="op" id="1370624">(</span><span class="op" id="1370625">&amp;</span><span class="ident" id="1370626">rw</span><span class="op" id="1370628">.</span><span class="ident" id="1370629">writerSem</span><span class="op" id="1370638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1370641">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1370644">if</span>&nbsp;<span class="ident" id="1370647">raceenabled</span>&nbsp;<span class="op" id="1370659">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1370663">raceEnable</span><span class="op" id="1370673">(</span><span class="op" id="1370674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1370678">raceAcquire</span><span class="op" id="1370689">(</span><span class="ident" id="1370690">unsafe</span><span class="op" id="1370696">.</span><span class="ident" id="1370697">Pointer</span><span class="op" id="1370704">(</span><span class="op" id="1370705">&amp;</span><span class="ident" id="1370706">rw</span><span class="op" id="1370708">.</span><span class="ident" id="1370709">readerSem</span><span class="op" id="1370718">)</span><span class="op" id="1370719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1370723">raceAcquire</span><span class="op" id="1370734">(</span><span class="ident" id="1370735">unsafe</span><span class="op" id="1370741">.</span><span class="ident" id="1370742">Pointer</span><span class="op" id="1370749">(</span><span class="op" id="1370750">&amp;</span><span class="ident" id="1370751">rw</span><span class="op" id="1370753">.</span><span class="ident" id="1370754">writerSem</span><span class="op" id="1370763">)</span><span class="op" id="1370764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1370767">}</span><br>
<span class="lineno"></span><span class="op" id="1370769">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="1370772">//&nbsp;Unlock&nbsp;unlocks&nbsp;rw&nbsp;for&nbsp;writing.&nbsp;&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error&nbsp;if&nbsp;rw&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1370839">//&nbsp;not&nbsp;locked&nbsp;for&nbsp;writing&nbsp;on&nbsp;entry&nbsp;to&nbsp;Unlock.</span><br>
<span class="lineno"></span><span class="comment" id="1370885">//</span><br>
<span class="lineno"></span><span class="comment" id="1370888">//&nbsp;As&nbsp;with&nbsp;Mutexes,&nbsp;a&nbsp;locked&nbsp;RWMutex&nbsp;is&nbsp;not&nbsp;associated&nbsp;with&nbsp;a&nbsp;particular</span><br>
<span class="lineno">100</span><span class="comment" id="1370961">//&nbsp;goroutine.&nbsp;&nbsp;One&nbsp;goroutine&nbsp;may&nbsp;RLock&nbsp;(Lock)&nbsp;an&nbsp;RWMutex&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="1371027">//&nbsp;arrange&nbsp;for&nbsp;another&nbsp;goroutine&nbsp;to&nbsp;RUnlock&nbsp;(Unlock)&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="1371084">func</span>&nbsp;<span class="op" id="1371089">(</span><span class="ident" id="1371090">rw</span>&nbsp;<span class="op" id="1371093">*</span><span class="ident" id="1371094">RWMutex</span><span class="op" id="1371101">)</span>&nbsp;<span class="ident" id="1371103">Unlock</span><span class="op" id="1371109">(</span><span class="op" id="1371110">)</span>&nbsp;<span class="op" id="1371112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1371115">if</span>&nbsp;<span class="ident" id="1371118">raceenabled</span>&nbsp;<span class="op" id="1371130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1371134">_</span>&nbsp;<span class="op" id="1371136">=</span>&nbsp;<span class="ident" id="1371138">rw</span><span class="op" id="1371140">.</span><span class="ident" id="1371141">w</span><span class="op" id="1371142">.</span><span class="ident" id="1371143">state</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1371151">raceRelease</span><span class="op" id="1371162">(</span><span class="ident" id="1371163">unsafe</span><span class="op" id="1371169">.</span><span class="ident" id="1371170">Pointer</span><span class="op" id="1371177">(</span><span class="op" id="1371178">&amp;</span><span class="ident" id="1371179">rw</span><span class="op" id="1371181">.</span><span class="ident" id="1371182">readerSem</span><span class="op" id="1371191">)</span><span class="op" id="1371192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1371196">raceRelease</span><span class="op" id="1371207">(</span><span class="ident" id="1371208">unsafe</span><span class="op" id="1371214">.</span><span class="ident" id="1371215">Pointer</span><span class="op" id="1371222">(</span><span class="op" id="1371223">&amp;</span><span class="ident" id="1371224">rw</span><span class="op" id="1371226">.</span><span class="ident" id="1371227">writerSem</span><span class="op" id="1371236">)</span><span class="op" id="1371237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1371241">raceDisable</span><span class="op" id="1371252">(</span><span class="op" id="1371253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1371256">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1371260">//&nbsp;Announce&nbsp;to&nbsp;readers&nbsp;there&nbsp;is&nbsp;no&nbsp;active&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1371311">r</span>&nbsp;<span class="op" id="1371313">:=</span>&nbsp;<span class="ident" id="1371316">atomic</span><span class="op" id="1371322">.</span><span class="ident" id="1371323">AddInt32</span><span class="op" id="1371331">(</span><span class="op" id="1371332">&amp;</span><span class="ident" id="1371333">rw</span><span class="op" id="1371335">.</span><span class="ident" id="1371336">readerCount</span><span class="op" id="1371347">,</span>&nbsp;<span class="ident" id="1371349">rwmutexMaxReaders</span><span class="op" id="1371366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1371369">if</span>&nbsp;<span class="ident" id="1371372">r</span>&nbsp;<span class="op" id="1371374">&gt;=</span>&nbsp;<span class="ident" id="1371377">rwmutexMaxReaders</span>&nbsp;<span class="op" id="1371395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1371399">raceEnable</span><span class="op" id="1371409">(</span><span class="op" id="1371410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1371414">panic</span><span class="op" id="1371419">(</span><span class="string" id="1371420">&#34;sync:&nbsp;Unlock&nbsp;of&nbsp;unlocked&nbsp;RWMutex&#34;</span><span class="op" id="1371454">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1371457">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1371460">//&nbsp;Unblock&nbsp;blocked&nbsp;readers,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1371497">for</span>&nbsp;<span class="ident" id="1371501">i</span>&nbsp;<span class="op" id="1371503">:=</span>&nbsp;<span class="num" id="1371506">0</span><span class="op" id="1371507">;</span>&nbsp;<span class="ident" id="1371509">i</span>&nbsp;<span class="op" id="1371511">&lt;</span>&nbsp;<span class="builtintype" id="1371513">int</span><span class="op" id="1371516">(</span><span class="ident" id="1371517">r</span><span class="op" id="1371518">)</span><span class="op" id="1371519">;</span>&nbsp;<span class="ident" id="1371521">i</span><span class="op" id="1371522">++</span>&nbsp;<span class="op" id="1371525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1371529">runtime_Semrelease</span><span class="op" id="1371547">(</span><span class="op" id="1371548">&amp;</span><span class="ident" id="1371549">rw</span><span class="op" id="1371551">.</span><span class="ident" id="1371552">readerSem</span><span class="op" id="1371561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1371564">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1371567">//&nbsp;Allow&nbsp;other&nbsp;writers&nbsp;to&nbsp;proceed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1371603">rw</span><span class="op" id="1371605">.</span><span class="ident" id="1371606">w</span><span class="op" id="1371607">.</span><span class="ident" id="1371608">Unlock</span><span class="op" id="1371614">(</span><span class="op" id="1371615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1371618">if</span>&nbsp;<span class="ident" id="1371621">raceenabled</span>&nbsp;<span class="op" id="1371633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1371637">raceEnable</span><span class="op" id="1371647">(</span><span class="op" id="1371648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1371651">}</span><br>
<span class="lineno">125</span><span class="op" id="1371653">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1371656">//&nbsp;RLocker&nbsp;returns&nbsp;a&nbsp;Locker&nbsp;interface&nbsp;that&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1371710">//&nbsp;the&nbsp;Lock&nbsp;and&nbsp;Unlock&nbsp;methods&nbsp;by&nbsp;calling&nbsp;rw.RLock&nbsp;and&nbsp;rw.RUnlock.</span><br>
<span class="lineno"></span><span class="keyword" id="1371777">func</span>&nbsp;<span class="op" id="1371782">(</span><span class="ident" id="1371783">rw</span>&nbsp;<span class="op" id="1371786">*</span><span class="ident" id="1371787">RWMutex</span><span class="op" id="1371794">)</span>&nbsp;<span class="ident" id="1371796">RLocker</span><span class="op" id="1371803">(</span><span class="op" id="1371804">)</span>&nbsp;<span class="ident" id="1371806">Locker</span>&nbsp;<span class="op" id="1371813">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1371816">return</span>&nbsp;<span class="op" id="1371823">(</span><span class="op" id="1371824">*</span><span class="ident" id="1371825">rlocker</span><span class="op" id="1371832">)</span><span class="op" id="1371833">(</span><span class="ident" id="1371834">rw</span><span class="op" id="1371836">)</span><br>
<span class="lineno"></span><span class="op" id="1371838">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1371841">type</span>&nbsp;<span class="ident" id="1371846">rlocker</span>&nbsp;<span class="ident" id="1371854">RWMutex</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="keyword" id="1371863">func</span>&nbsp;<span class="op" id="1371868">(</span><span class="ident" id="1371869">r</span>&nbsp;<span class="op" id="1371871">*</span><span class="ident" id="1371872">rlocker</span><span class="op" id="1371879">)</span>&nbsp;<span class="ident" id="1371881">Lock</span><span class="op" id="1371885">(</span><span class="op" id="1371886">)</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1371890">{</span>&nbsp;<span class="op" id="1371892">(</span><span class="op" id="1371893">*</span><span class="ident" id="1371894">RWMutex</span><span class="op" id="1371901">)</span><span class="op" id="1371902">(</span><span class="ident" id="1371903">r</span><span class="op" id="1371904">)</span><span class="op" id="1371905">.</span><span class="ident" id="1371906">RLock</span><span class="op" id="1371911">(</span><span class="op" id="1371912">)</span>&nbsp;<span class="op" id="1371914">}</span><br>
<span class="lineno"></span><span class="keyword" id="1371916">func</span>&nbsp;<span class="op" id="1371921">(</span><span class="ident" id="1371922">r</span>&nbsp;<span class="op" id="1371924">*</span><span class="ident" id="1371925">rlocker</span><span class="op" id="1371932">)</span>&nbsp;<span class="ident" id="1371934">Unlock</span><span class="op" id="1371940">(</span><span class="op" id="1371941">)</span>&nbsp;<span class="op" id="1371943">{</span>&nbsp;<span class="op" id="1371945">(</span><span class="op" id="1371946">*</span><span class="ident" id="1371947">RWMutex</span><span class="op" id="1371954">)</span><span class="op" id="1371955">(</span><span class="ident" id="1371956">r</span><span class="op" id="1371957">)</span><span class="op" id="1371958">.</span><span class="ident" id="1371959">RUnlock</span><span class="op" id="1371966">(</span><span class="op" id="1371967">)</span>&nbsp;<span class="op" id="1371969">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
