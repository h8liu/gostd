<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/cgi</h2>
<ul>
<li><a href="/gostd/net/http/cgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/cgi/child_test.go.html">child_test.go</a></li>
<li><a href="/gostd/net/http/cgi/host.go.html">host.go</a></li>
<li><a href="/gostd/net/http/cgi/host_test.go.html">host_test.go</a></li>
<li><a href="/gostd/net/http/cgi/matryoshka_test.go.html" class="current">matryoshka_test.go</a></li>
<li><a href="/gostd/net/http/cgi/posix_test.go.html">posix_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7968454">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7968509">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7968563">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="7968614">//&nbsp;Tests&nbsp;a&nbsp;Go&nbsp;CGI&nbsp;program&nbsp;running&nbsp;under&nbsp;a&nbsp;Go&nbsp;CGI&nbsp;host&nbsp;process.</span><br>
<span class="lineno"></span><span class="comment" id="7968677">//&nbsp;Further,&nbsp;the&nbsp;two&nbsp;programs&nbsp;are&nbsp;the&nbsp;same&nbsp;binary,&nbsp;just&nbsp;checking</span><br>
<span class="lineno"></span><span class="comment" id="7968741">//&nbsp;their&nbsp;environment&nbsp;to&nbsp;figure&nbsp;out&nbsp;what&nbsp;mode&nbsp;to&nbsp;run&nbsp;in.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7968798">package</span>&nbsp;<span class="ident" id="7968806">cgi</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="7968811">import</span>&nbsp;<span class="op" id="7968818">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7968821">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7968830">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7968840">&#34;fmt&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7968847">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7968853">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7968865">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7968886">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7968892">&#34;runtime&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7968903">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7968914">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7968921">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7968924">//&nbsp;This&nbsp;test&nbsp;is&nbsp;a&nbsp;CGI&nbsp;host&nbsp;(testing&nbsp;host.go)&nbsp;that&nbsp;runs&nbsp;its&nbsp;own&nbsp;binary</span><br>
<span class="lineno">25</span><span class="comment" id="7968994">//&nbsp;as&nbsp;a&nbsp;child&nbsp;process&nbsp;testing&nbsp;the&nbsp;other&nbsp;half&nbsp;of&nbsp;CGI&nbsp;(child.go).</span><br>
<span class="lineno"></span><span class="keyword" id="7969058">func</span>&nbsp;<span class="ident" id="7969063">TestHostingOurselves</span><span class="op" id="7969083">(</span><span class="ident" id="7969084">t</span>&nbsp;<span class="op" id="7969086">*</span><span class="ident" id="7969087">testing</span><span class="op" id="7969094">.</span><span class="ident" id="7969095">T</span><span class="op" id="7969096">)</span>&nbsp;<span class="op" id="7969098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7969101">if</span>&nbsp;<span class="ident" id="7969104">runtime</span><span class="op" id="7969111">.</span><span class="ident" id="7969112">GOOS</span>&nbsp;<span class="op" id="7969117">==</span>&nbsp;<span class="string" id="7969120">&#34;nacl&#34;</span>&nbsp;<span class="op" id="7969127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7969131">t</span><span class="op" id="7969132">.</span><span class="ident" id="7969133">Skip</span><span class="op" id="7969137">(</span><span class="string" id="7969138">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="7969156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7969159">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7969163">h</span>&nbsp;<span class="op" id="7969165">:=</span>&nbsp;<span class="op" id="7969168">&amp;</span><span class="ident" id="7969169">Handler</span><span class="op" id="7969176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7969180">Path</span><span class="op" id="7969184">:</span>&nbsp;<span class="ident" id="7969186">os</span><span class="op" id="7969188">.</span><span class="ident" id="7969189">Args</span><span class="op" id="7969193">[</span><span class="num" id="7969194">0</span><span class="op" id="7969195">]</span><span class="op" id="7969196">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7969200">Root</span><span class="op" id="7969204">:</span>&nbsp;<span class="string" id="7969206">&#34;/test.go&#34;</span><span class="op" id="7969216">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7969220">Args</span><span class="op" id="7969224">:</span>&nbsp;<span class="op" id="7969226">[</span><span class="op" id="7969227">]</span><span class="builtintype" id="7969228">string</span><span class="op" id="7969234">{</span><span class="string" id="7969235">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="7969268">}</span><span class="op" id="7969269">,</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7969272">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7969275">expectedMap</span>&nbsp;<span class="op" id="7969287">:=</span>&nbsp;<span class="keyword" id="7969290">map</span><span class="op" id="7969293">[</span><span class="builtintype" id="7969294">string</span><span class="op" id="7969300">]</span><span class="builtintype" id="7969301">string</span><span class="op" id="7969307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7969311">&#34;test&#34;</span><span class="op" id="7969317">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7969336">&#34;Hello&nbsp;CGI-in-CGI&#34;</span><span class="op" id="7969354">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7969358">&#34;param-a&#34;</span><span class="op" id="7969367">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7969383">&#34;b&#34;</span><span class="op" id="7969386">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7969390">&#34;param-foo&#34;</span><span class="op" id="7969401">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7969415">&#34;bar&#34;</span><span class="op" id="7969420">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7969424">&#34;env-GATEWAY_INTERFACE&#34;</span><span class="op" id="7969447">:</span>&nbsp;<span class="string" id="7969449">&#34;CGI/1.1&#34;</span><span class="op" id="7969458">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7969462">&#34;env-HTTP_HOST&#34;</span><span class="op" id="7969477">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7969487">&#34;example.com&#34;</span><span class="op" id="7969500">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7969504">&#34;env-PATH_INFO&#34;</span><span class="op" id="7969519">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7969529">&#34;&#34;</span><span class="op" id="7969531">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7969535">&#34;env-QUERY_STRING&#34;</span><span class="op" id="7969553">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7969560">&#34;foo=bar&amp;a=b&#34;</span><span class="op" id="7969573">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7969577">&#34;env-REMOTE_ADDR&#34;</span><span class="op" id="7969594">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7969602">&#34;1.2.3.4&#34;</span><span class="op" id="7969611">,</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7969615">&#34;env-REMOTE_HOST&#34;</span><span class="op" id="7969632">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7969640">&#34;1.2.3.4&#34;</span><span class="op" id="7969649">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7969653">&#34;env-REQUEST_METHOD&#34;</span><span class="op" id="7969673">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7969678">&#34;GET&#34;</span><span class="op" id="7969683">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7969687">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7969704">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7969712">&#34;/test.go?foo=bar&amp;a=b&#34;</span><span class="op" id="7969734">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7969738">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7969759">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="7969763">os</span><span class="op" id="7969765">.</span><span class="ident" id="7969766">Args</span><span class="op" id="7969770">[</span><span class="num" id="7969771">0</span><span class="op" id="7969772">]</span><span class="op" id="7969773">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7969777">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="7969794">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7969802">&#34;/test.go&#34;</span><span class="op" id="7969812">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7969816">&#34;env-SERVER_NAME&#34;</span><span class="op" id="7969833">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7969841">&#34;example.com&#34;</span><span class="op" id="7969854">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7969858">&#34;env-SERVER_PORT&#34;</span><span class="op" id="7969875">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7969883">&#34;80&#34;</span><span class="op" id="7969887">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7969891">&#34;env-SERVER_SOFTWARE&#34;</span><span class="op" id="7969912">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="7969916">&#34;go&#34;</span><span class="op" id="7969920">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7969923">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7969926">replay</span>&nbsp;<span class="op" id="7969933">:=</span>&nbsp;<span class="ident" id="7969936">runCgiTest</span><span class="op" id="7969946">(</span><span class="ident" id="7969947">t</span><span class="op" id="7969948">,</span>&nbsp;<span class="ident" id="7969950">h</span><span class="op" id="7969951">,</span>&nbsp;<span class="string" id="7969953">&#34;GET&nbsp;/test.go?foo=bar&amp;a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7970011">,</span>&nbsp;<span class="ident" id="7970013">expectedMap</span><span class="op" id="7970024">)</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7970028">if</span>&nbsp;<span class="ident" id="7970031">expected</span><span class="op" id="7970039">,</span>&nbsp;<span class="ident" id="7970041">got</span>&nbsp;<span class="op" id="7970045">:=</span>&nbsp;<span class="string" id="7970048">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="7970074">,</span>&nbsp;<span class="ident" id="7970076">replay</span><span class="op" id="7970082">.</span><span class="ident" id="7970083">Header</span><span class="op" id="7970089">(</span><span class="op" id="7970090">)</span><span class="op" id="7970091">.</span><span class="ident" id="7970092">Get</span><span class="op" id="7970095">(</span><span class="string" id="7970096">&#34;Content-Type&#34;</span><span class="op" id="7970110">)</span><span class="op" id="7970111">;</span>&nbsp;<span class="ident" id="7970113">got</span>&nbsp;<span class="op" id="7970117">!=</span>&nbsp;<span class="ident" id="7970120">expected</span>&nbsp;<span class="op" id="7970129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7970133">t</span><span class="op" id="7970134">.</span><span class="ident" id="7970135">Errorf</span><span class="op" id="7970141">(</span><span class="string" id="7970142">&#34;got&nbsp;a&nbsp;Content-Type&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7970181">,</span>&nbsp;<span class="ident" id="7970183">got</span><span class="op" id="7970186">,</span>&nbsp;<span class="ident" id="7970188">expected</span><span class="op" id="7970196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7970199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7970202">if</span>&nbsp;<span class="ident" id="7970205">expected</span><span class="op" id="7970213">,</span>&nbsp;<span class="ident" id="7970215">got</span>&nbsp;<span class="op" id="7970219">:=</span>&nbsp;<span class="string" id="7970222">&#34;X-Test-Value&#34;</span><span class="op" id="7970236">,</span>&nbsp;<span class="ident" id="7970238">replay</span><span class="op" id="7970244">.</span><span class="ident" id="7970245">Header</span><span class="op" id="7970251">(</span><span class="op" id="7970252">)</span><span class="op" id="7970253">.</span><span class="ident" id="7970254">Get</span><span class="op" id="7970257">(</span><span class="string" id="7970258">&#34;X-Test-Header&#34;</span><span class="op" id="7970273">)</span><span class="op" id="7970274">;</span>&nbsp;<span class="ident" id="7970276">got</span>&nbsp;<span class="op" id="7970280">!=</span>&nbsp;<span class="ident" id="7970283">expected</span>&nbsp;<span class="op" id="7970292">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7970296">t</span><span class="op" id="7970297">.</span><span class="ident" id="7970298">Errorf</span><span class="op" id="7970304">(</span><span class="string" id="7970305">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7970345">,</span>&nbsp;<span class="ident" id="7970347">got</span><span class="op" id="7970350">,</span>&nbsp;<span class="ident" id="7970352">expected</span><span class="op" id="7970360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7970363">}</span><br>
<span class="lineno"></span><span class="op" id="7970365">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7970368">type</span>&nbsp;<span class="ident" id="7970373">customWriterRecorder</span>&nbsp;<span class="keyword" id="7970394">struct</span>&nbsp;<span class="op" id="7970401">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7970404">w</span>&nbsp;<span class="ident" id="7970406">io</span><span class="op" id="7970408">.</span><span class="ident" id="7970409">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7970417">*</span><span class="ident" id="7970418">httptest</span><span class="op" id="7970426">.</span><span class="ident" id="7970427">ResponseRecorder</span><br>
<span class="lineno"></span><span class="op" id="7970444">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7970447">func</span>&nbsp;<span class="op" id="7970452">(</span><span class="ident" id="7970453">r</span>&nbsp;<span class="op" id="7970455">*</span><span class="ident" id="7970456">customWriterRecorder</span><span class="op" id="7970476">)</span>&nbsp;<span class="ident" id="7970478">Write</span><span class="op" id="7970483">(</span><span class="ident" id="7970484">p</span>&nbsp;<span class="op" id="7970486">[</span><span class="op" id="7970487">]</span><span class="builtintype" id="7970488">byte</span><span class="op" id="7970492">)</span>&nbsp;<span class="op" id="7970494">(</span><span class="ident" id="7970495">n</span>&nbsp;<span class="builtintype" id="7970497">int</span><span class="op" id="7970500">,</span>&nbsp;<span class="ident" id="7970502">err</span>&nbsp;<span class="builtintype" id="7970506">error</span><span class="op" id="7970511">)</span>&nbsp;<span class="op" id="7970513">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7970516">return</span>&nbsp;<span class="ident" id="7970523">r</span><span class="op" id="7970524">.</span><span class="ident" id="7970525">w</span><span class="op" id="7970526">.</span><span class="ident" id="7970527">Write</span><span class="op" id="7970532">(</span><span class="ident" id="7970533">p</span><span class="op" id="7970534">)</span><br>
<span class="lineno"></span><span class="op" id="7970536">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7970539">type</span>&nbsp;<span class="ident" id="7970544">limitWriter</span>&nbsp;<span class="keyword" id="7970556">struct</span>&nbsp;<span class="op" id="7970563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7970566">w</span>&nbsp;<span class="ident" id="7970568">io</span><span class="op" id="7970570">.</span><span class="ident" id="7970571">Writer</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7970579">n</span>&nbsp;<span class="builtintype" id="7970581">int</span><br>
<span class="lineno"></span><span class="op" id="7970585">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7970588">func</span>&nbsp;<span class="op" id="7970593">(</span><span class="ident" id="7970594">w</span>&nbsp;<span class="op" id="7970596">*</span><span class="ident" id="7970597">limitWriter</span><span class="op" id="7970608">)</span>&nbsp;<span class="ident" id="7970610">Write</span><span class="op" id="7970615">(</span><span class="ident" id="7970616">p</span>&nbsp;<span class="op" id="7970618">[</span><span class="op" id="7970619">]</span><span class="builtintype" id="7970620">byte</span><span class="op" id="7970624">)</span>&nbsp;<span class="op" id="7970626">(</span><span class="ident" id="7970627">n</span>&nbsp;<span class="builtintype" id="7970629">int</span><span class="op" id="7970632">,</span>&nbsp;<span class="ident" id="7970634">err</span>&nbsp;<span class="builtintype" id="7970638">error</span><span class="op" id="7970643">)</span>&nbsp;<span class="op" id="7970645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7970648">if</span>&nbsp;<span class="builtinfunc" id="7970651">len</span><span class="op" id="7970654">(</span><span class="ident" id="7970655">p</span><span class="op" id="7970656">)</span>&nbsp;<span class="op" id="7970658">&gt;</span>&nbsp;<span class="ident" id="7970660">w</span><span class="op" id="7970661">.</span><span class="ident" id="7970662">n</span>&nbsp;<span class="op" id="7970664">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7970668">p</span>&nbsp;<span class="op" id="7970670">=</span>&nbsp;<span class="ident" id="7970672">p</span><span class="op" id="7970673">[</span><span class="op" id="7970674">:</span><span class="ident" id="7970675">w</span><span class="op" id="7970676">.</span><span class="ident" id="7970677">n</span><span class="op" id="7970678">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7970681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7970684">if</span>&nbsp;<span class="builtinfunc" id="7970687">len</span><span class="op" id="7970690">(</span><span class="ident" id="7970691">p</span><span class="op" id="7970692">)</span>&nbsp;<span class="op" id="7970694">&gt;</span>&nbsp;<span class="num" id="7970696">0</span>&nbsp;<span class="op" id="7970698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7970702">n</span><span class="op" id="7970703">,</span>&nbsp;<span class="ident" id="7970705">err</span>&nbsp;<span class="op" id="7970709">=</span>&nbsp;<span class="ident" id="7970711">w</span><span class="op" id="7970712">.</span><span class="ident" id="7970713">w</span><span class="op" id="7970714">.</span><span class="ident" id="7970715">Write</span><span class="op" id="7970720">(</span><span class="ident" id="7970721">p</span><span class="op" id="7970722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7970726">w</span><span class="op" id="7970727">.</span><span class="ident" id="7970728">n</span>&nbsp;<span class="op" id="7970730">-=</span>&nbsp;<span class="ident" id="7970733">n</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7970736">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7970739">if</span>&nbsp;<span class="ident" id="7970742">w</span><span class="op" id="7970743">.</span><span class="ident" id="7970744">n</span>&nbsp;<span class="op" id="7970746">==</span>&nbsp;<span class="num" id="7970749">0</span>&nbsp;<span class="op" id="7970751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7970755">err</span>&nbsp;<span class="op" id="7970759">=</span>&nbsp;<span class="ident" id="7970761">errors</span><span class="op" id="7970767">.</span><span class="ident" id="7970768">New</span><span class="op" id="7970771">(</span><span class="string" id="7970772">&#34;past&nbsp;write&nbsp;limit&#34;</span><span class="op" id="7970790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7970793">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7970796">return</span><br>
<span class="lineno">90</span><span class="op" id="7970803">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7970806">//&nbsp;If&nbsp;there&#39;s&nbsp;an&nbsp;error&nbsp;copying&nbsp;the&nbsp;child&#39;s&nbsp;output&nbsp;to&nbsp;the&nbsp;parent,&nbsp;test</span><br>
<span class="lineno"></span><span class="comment" id="7970876">//&nbsp;that&nbsp;we&nbsp;kill&nbsp;the&nbsp;child.</span><br>
<span class="lineno"></span><span class="keyword" id="7970903">func</span>&nbsp;<span class="ident" id="7970908">TestKillChildAfterCopyError</span><span class="op" id="7970935">(</span><span class="ident" id="7970936">t</span>&nbsp;<span class="op" id="7970938">*</span><span class="ident" id="7970939">testing</span><span class="op" id="7970946">.</span><span class="ident" id="7970947">T</span><span class="op" id="7970948">)</span>&nbsp;<span class="op" id="7970950">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7970953">if</span>&nbsp;<span class="ident" id="7970956">runtime</span><span class="op" id="7970963">.</span><span class="ident" id="7970964">GOOS</span>&nbsp;<span class="op" id="7970969">==</span>&nbsp;<span class="string" id="7970972">&#34;nacl&#34;</span>&nbsp;<span class="op" id="7970979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7970983">t</span><span class="op" id="7970984">.</span><span class="ident" id="7970985">Skip</span><span class="op" id="7970989">(</span><span class="string" id="7970990">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="7971008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7971011">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7971015">defer</span>&nbsp;<span class="keyword" id="7971021">func</span><span class="op" id="7971025">(</span><span class="op" id="7971026">)</span>&nbsp;<span class="op" id="7971028">{</span>&nbsp;<span class="ident" id="7971030">testHookStartProcess</span>&nbsp;<span class="op" id="7971051">=</span>&nbsp;<span class="builtintype" id="7971053">nil</span>&nbsp;<span class="op" id="7971057">}</span><span class="op" id="7971058">(</span><span class="op" id="7971059">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7971062">proc</span>&nbsp;<span class="op" id="7971067">:=</span>&nbsp;<span class="builtinfunc" id="7971070">make</span><span class="op" id="7971074">(</span><span class="keyword" id="7971075">chan</span>&nbsp;<span class="op" id="7971080">*</span><span class="ident" id="7971081">os</span><span class="op" id="7971083">.</span><span class="ident" id="7971084">Process</span><span class="op" id="7971091">,</span>&nbsp;<span class="num" id="7971093">1</span><span class="op" id="7971094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7971097">testHookStartProcess</span>&nbsp;<span class="op" id="7971118">=</span>&nbsp;<span class="keyword" id="7971120">func</span><span class="op" id="7971124">(</span><span class="ident" id="7971125">p</span>&nbsp;<span class="op" id="7971127">*</span><span class="ident" id="7971128">os</span><span class="op" id="7971130">.</span><span class="ident" id="7971131">Process</span><span class="op" id="7971138">)</span>&nbsp;<span class="op" id="7971140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7971144">proc</span>&nbsp;<span class="op" id="7971149">&lt;-</span>&nbsp;<span class="ident" id="7971152">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7971155">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7971159">h</span>&nbsp;<span class="op" id="7971161">:=</span>&nbsp;<span class="op" id="7971164">&amp;</span><span class="ident" id="7971165">Handler</span><span class="op" id="7971172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7971176">Path</span><span class="op" id="7971180">:</span>&nbsp;<span class="ident" id="7971182">os</span><span class="op" id="7971184">.</span><span class="ident" id="7971185">Args</span><span class="op" id="7971189">[</span><span class="num" id="7971190">0</span><span class="op" id="7971191">]</span><span class="op" id="7971192">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7971196">Root</span><span class="op" id="7971200">:</span>&nbsp;<span class="string" id="7971202">&#34;/test.go&#34;</span><span class="op" id="7971212">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7971216">Args</span><span class="op" id="7971220">:</span>&nbsp;<span class="op" id="7971222">[</span><span class="op" id="7971223">]</span><span class="builtintype" id="7971224">string</span><span class="op" id="7971230">{</span><span class="string" id="7971231">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="7971264">}</span><span class="op" id="7971265">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7971268">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7971271">req</span><span class="op" id="7971274">,</span>&nbsp;<span class="ident" id="7971276">_</span>&nbsp;<span class="op" id="7971278">:=</span>&nbsp;<span class="ident" id="7971281">http</span><span class="op" id="7971285">.</span><span class="ident" id="7971286">NewRequest</span><span class="op" id="7971296">(</span><span class="string" id="7971297">&#34;GET&#34;</span><span class="op" id="7971302">,</span>&nbsp;<span class="string" id="7971304">&#34;http://example.com/test.cgi?write-forever=1&#34;</span><span class="op" id="7971349">,</span>&nbsp;<span class="builtintype" id="7971351">nil</span><span class="op" id="7971354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7971357">rec</span>&nbsp;<span class="op" id="7971361">:=</span>&nbsp;<span class="ident" id="7971364">httptest</span><span class="op" id="7971372">.</span><span class="ident" id="7971373">NewRecorder</span><span class="op" id="7971384">(</span><span class="op" id="7971385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7971388">var</span>&nbsp;<span class="ident" id="7971392">out</span>&nbsp;<span class="ident" id="7971396">bytes</span><span class="op" id="7971401">.</span><span class="ident" id="7971402">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7971410">const</span>&nbsp;<span class="ident" id="7971416">writeLen</span>&nbsp;<span class="op" id="7971425">=</span>&nbsp;<span class="num" id="7971427">50</span>&nbsp;<span class="op" id="7971430">&lt;&lt;</span>&nbsp;<span class="num" id="7971433">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7971437">rw</span>&nbsp;<span class="op" id="7971440">:=</span>&nbsp;<span class="op" id="7971443">&amp;</span><span class="ident" id="7971444">customWriterRecorder</span><span class="op" id="7971464">{</span><span class="op" id="7971465">&amp;</span><span class="ident" id="7971466">limitWriter</span><span class="op" id="7971477">{</span><span class="op" id="7971478">&amp;</span><span class="ident" id="7971479">out</span><span class="op" id="7971482">,</span>&nbsp;<span class="ident" id="7971484">writeLen</span><span class="op" id="7971492">}</span><span class="op" id="7971493">,</span>&nbsp;<span class="ident" id="7971495">rec</span><span class="op" id="7971498">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7971502">donec</span>&nbsp;<span class="op" id="7971508">:=</span>&nbsp;<span class="builtinfunc" id="7971511">make</span><span class="op" id="7971515">(</span><span class="keyword" id="7971516">chan</span>&nbsp;<span class="builtintype" id="7971521">bool</span><span class="op" id="7971525">,</span>&nbsp;<span class="num" id="7971527">1</span><span class="op" id="7971528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7971531">go</span>&nbsp;<span class="keyword" id="7971534">func</span><span class="op" id="7971538">(</span><span class="op" id="7971539">)</span>&nbsp;<span class="op" id="7971541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7971545">h</span><span class="op" id="7971546">.</span><span class="ident" id="7971547">ServeHTTP</span><span class="op" id="7971556">(</span><span class="ident" id="7971557">rw</span><span class="op" id="7971559">,</span>&nbsp;<span class="ident" id="7971561">req</span><span class="op" id="7971564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7971568">donec</span>&nbsp;<span class="op" id="7971574">&lt;-</span>&nbsp;<span class="builtintype" id="7971577">true</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7971583">}</span><span class="op" id="7971584">(</span><span class="op" id="7971585">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7971589">select</span>&nbsp;<span class="op" id="7971596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7971599">case</span>&nbsp;<span class="op" id="7971604">&lt;-</span><span class="ident" id="7971606">donec</span><span class="op" id="7971611">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7971615">if</span>&nbsp;<span class="ident" id="7971618">out</span><span class="op" id="7971621">.</span><span class="ident" id="7971622">Len</span><span class="op" id="7971625">(</span><span class="op" id="7971626">)</span>&nbsp;<span class="op" id="7971628">!=</span>&nbsp;<span class="ident" id="7971631">writeLen</span>&nbsp;<span class="op" id="7971640">||</span>&nbsp;<span class="ident" id="7971643">out</span><span class="op" id="7971646">.</span><span class="ident" id="7971647">Bytes</span><span class="op" id="7971652">(</span><span class="op" id="7971653">)</span><span class="op" id="7971654">[</span><span class="num" id="7971655">0</span><span class="op" id="7971656">]</span>&nbsp;<span class="op" id="7971658">!=</span>&nbsp;<span class="string" id="7971661">&#39;a&#39;</span>&nbsp;<span class="op" id="7971665">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7971670">t</span><span class="op" id="7971671">.</span><span class="ident" id="7971672">Errorf</span><span class="op" id="7971678">(</span><span class="string" id="7971679">&#34;unexpected&nbsp;output:&nbsp;%q&#34;</span><span class="op" id="7971702">,</span>&nbsp;<span class="ident" id="7971704">out</span><span class="op" id="7971707">.</span><span class="ident" id="7971708">Bytes</span><span class="op" id="7971713">(</span><span class="op" id="7971714">)</span><span class="op" id="7971715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7971719">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7971722">case</span>&nbsp;<span class="op" id="7971727">&lt;-</span><span class="ident" id="7971729">time</span><span class="op" id="7971733">.</span><span class="ident" id="7971734">After</span><span class="op" id="7971739">(</span><span class="num" id="7971740">5</span>&nbsp;<span class="op" id="7971742">*</span>&nbsp;<span class="ident" id="7971744">time</span><span class="op" id="7971748">.</span><span class="ident" id="7971749">Second</span><span class="op" id="7971755">)</span><span class="op" id="7971756">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7971760">t</span><span class="op" id="7971761">.</span><span class="ident" id="7971762">Errorf</span><span class="op" id="7971768">(</span><span class="string" id="7971769">&#34;timeout.&nbsp;ServeHTTP&nbsp;hung&nbsp;and&nbsp;didn&#39;t&nbsp;kill&nbsp;the&nbsp;child&nbsp;process?&#34;</span><span class="op" id="7971829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7971833">select</span>&nbsp;<span class="op" id="7971840">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7971844">case</span>&nbsp;<span class="ident" id="7971849">p</span>&nbsp;<span class="op" id="7971851">:=</span>&nbsp;<span class="op" id="7971854">&lt;-</span><span class="ident" id="7971856">proc</span><span class="op" id="7971860">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7971865">p</span><span class="op" id="7971866">.</span><span class="ident" id="7971867">Kill</span><span class="op" id="7971871">(</span><span class="op" id="7971872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7971877">t</span><span class="op" id="7971878">.</span><span class="ident" id="7971879">Logf</span><span class="op" id="7971883">(</span><span class="string" id="7971884">&#34;killed&nbsp;process&#34;</span><span class="op" id="7971900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7971904">default</span><span class="op" id="7971911">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7971916">t</span><span class="op" id="7971917">.</span><span class="ident" id="7971918">Logf</span><span class="op" id="7971922">(</span><span class="string" id="7971923">&#34;didn&#39;t&nbsp;kill&nbsp;process&#34;</span><span class="op" id="7971944">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7971948">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7971951">}</span><br>
<span class="lineno"></span><span class="op" id="7971953">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7971956">//&nbsp;Test&nbsp;that&nbsp;a&nbsp;child&nbsp;handler&nbsp;writing&nbsp;only&nbsp;headers&nbsp;works.</span><br>
<span class="lineno">140</span><span class="comment" id="7972013">//&nbsp;golang.org/issue/7196</span><br>
<span class="lineno"></span><span class="keyword" id="7972038">func</span>&nbsp;<span class="ident" id="7972043">TestChildOnlyHeaders</span><span class="op" id="7972063">(</span><span class="ident" id="7972064">t</span>&nbsp;<span class="op" id="7972066">*</span><span class="ident" id="7972067">testing</span><span class="op" id="7972074">.</span><span class="ident" id="7972075">T</span><span class="op" id="7972076">)</span>&nbsp;<span class="op" id="7972078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7972081">if</span>&nbsp;<span class="ident" id="7972084">runtime</span><span class="op" id="7972091">.</span><span class="ident" id="7972092">GOOS</span>&nbsp;<span class="op" id="7972097">==</span>&nbsp;<span class="string" id="7972100">&#34;nacl&#34;</span>&nbsp;<span class="op" id="7972107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7972111">t</span><span class="op" id="7972112">.</span><span class="ident" id="7972113">Skip</span><span class="op" id="7972117">(</span><span class="string" id="7972118">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="7972136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7972139">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7972143">h</span>&nbsp;<span class="op" id="7972145">:=</span>&nbsp;<span class="op" id="7972148">&amp;</span><span class="ident" id="7972149">Handler</span><span class="op" id="7972156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7972160">Path</span><span class="op" id="7972164">:</span>&nbsp;<span class="ident" id="7972166">os</span><span class="op" id="7972168">.</span><span class="ident" id="7972169">Args</span><span class="op" id="7972173">[</span><span class="num" id="7972174">0</span><span class="op" id="7972175">]</span><span class="op" id="7972176">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7972180">Root</span><span class="op" id="7972184">:</span>&nbsp;<span class="string" id="7972186">&#34;/test.go&#34;</span><span class="op" id="7972196">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7972200">Args</span><span class="op" id="7972204">:</span>&nbsp;<span class="op" id="7972206">[</span><span class="op" id="7972207">]</span><span class="builtintype" id="7972208">string</span><span class="op" id="7972214">{</span><span class="string" id="7972215">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="7972248">}</span><span class="op" id="7972249">,</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7972252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7972255">expectedMap</span>&nbsp;<span class="op" id="7972267">:=</span>&nbsp;<span class="keyword" id="7972270">map</span><span class="op" id="7972273">[</span><span class="builtintype" id="7972274">string</span><span class="op" id="7972280">]</span><span class="builtintype" id="7972281">string</span><span class="op" id="7972287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7972291">&#34;_body&#34;</span><span class="op" id="7972298">:</span>&nbsp;<span class="string" id="7972300">&#34;&#34;</span><span class="op" id="7972302">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7972305">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7972308">replay</span>&nbsp;<span class="op" id="7972315">:=</span>&nbsp;<span class="ident" id="7972318">runCgiTest</span><span class="op" id="7972328">(</span><span class="ident" id="7972329">t</span><span class="op" id="7972330">,</span>&nbsp;<span class="ident" id="7972332">h</span><span class="op" id="7972333">,</span>&nbsp;<span class="string" id="7972335">&#34;GET&nbsp;/test.go?no-body=1&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7972391">,</span>&nbsp;<span class="ident" id="7972393">expectedMap</span><span class="op" id="7972404">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7972407">if</span>&nbsp;<span class="ident" id="7972410">expected</span><span class="op" id="7972418">,</span>&nbsp;<span class="ident" id="7972420">got</span>&nbsp;<span class="op" id="7972424">:=</span>&nbsp;<span class="string" id="7972427">&#34;X-Test-Value&#34;</span><span class="op" id="7972441">,</span>&nbsp;<span class="ident" id="7972443">replay</span><span class="op" id="7972449">.</span><span class="ident" id="7972450">Header</span><span class="op" id="7972456">(</span><span class="op" id="7972457">)</span><span class="op" id="7972458">.</span><span class="ident" id="7972459">Get</span><span class="op" id="7972462">(</span><span class="string" id="7972463">&#34;X-Test-Header&#34;</span><span class="op" id="7972478">)</span><span class="op" id="7972479">;</span>&nbsp;<span class="ident" id="7972481">got</span>&nbsp;<span class="op" id="7972485">!=</span>&nbsp;<span class="ident" id="7972488">expected</span>&nbsp;<span class="op" id="7972497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7972501">t</span><span class="op" id="7972502">.</span><span class="ident" id="7972503">Errorf</span><span class="op" id="7972509">(</span><span class="string" id="7972510">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7972550">,</span>&nbsp;<span class="ident" id="7972552">got</span><span class="op" id="7972555">,</span>&nbsp;<span class="ident" id="7972557">expected</span><span class="op" id="7972565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7972568">}</span><br>
<span class="lineno"></span><span class="op" id="7972570">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment" id="7972573">//&nbsp;golang.org/issue/7198</span><br>
<span class="lineno"></span><span class="keyword" id="7972598">func</span>&nbsp;<span class="ident" id="7972603">Test500WithNoHeaders</span><span class="op" id="7972623">(</span><span class="ident" id="7972624">t</span>&nbsp;<span class="op" id="7972626">*</span><span class="ident" id="7972627">testing</span><span class="op" id="7972634">.</span><span class="ident" id="7972635">T</span><span class="op" id="7972636">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7972642">{</span>&nbsp;<span class="ident" id="7972644">want500Test</span><span class="op" id="7972655">(</span><span class="ident" id="7972656">t</span><span class="op" id="7972657">,</span>&nbsp;<span class="string" id="7972659">&#34;/immediate-disconnect&#34;</span><span class="op" id="7972682">)</span>&nbsp;<span class="op" id="7972684">}</span><br>
<span class="lineno"></span><span class="keyword" id="7972686">func</span>&nbsp;<span class="ident" id="7972691">Test500WithNoContentType</span><span class="op" id="7972715">(</span><span class="ident" id="7972716">t</span>&nbsp;<span class="op" id="7972718">*</span><span class="ident" id="7972719">testing</span><span class="op" id="7972726">.</span><span class="ident" id="7972727">T</span><span class="op" id="7972728">)</span>&nbsp;<span class="op" id="7972730">{</span>&nbsp;<span class="ident" id="7972732">want500Test</span><span class="op" id="7972743">(</span><span class="ident" id="7972744">t</span><span class="op" id="7972745">,</span>&nbsp;<span class="string" id="7972747">&#34;/no-content-type&#34;</span><span class="op" id="7972765">)</span>&nbsp;<span class="op" id="7972767">}</span><br>
<span class="lineno"></span><span class="keyword" id="7972769">func</span>&nbsp;<span class="ident" id="7972774">Test500WithEmptyHeaders</span><span class="op" id="7972797">(</span><span class="ident" id="7972798">t</span>&nbsp;<span class="op" id="7972800">*</span><span class="ident" id="7972801">testing</span><span class="op" id="7972808">.</span><span class="ident" id="7972809">T</span><span class="op" id="7972810">)</span>&nbsp;&nbsp;<span class="op" id="7972813">{</span>&nbsp;<span class="ident" id="7972815">want500Test</span><span class="op" id="7972826">(</span><span class="ident" id="7972827">t</span><span class="op" id="7972828">,</span>&nbsp;<span class="string" id="7972830">&#34;/empty-headers&#34;</span><span class="op" id="7972846">)</span>&nbsp;<span class="op" id="7972848">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="7972851">func</span>&nbsp;<span class="ident" id="7972856">want500Test</span><span class="op" id="7972867">(</span><span class="ident" id="7972868">t</span>&nbsp;<span class="op" id="7972870">*</span><span class="ident" id="7972871">testing</span><span class="op" id="7972878">.</span><span class="ident" id="7972879">T</span><span class="op" id="7972880">,</span>&nbsp;<span class="ident" id="7972882">path</span>&nbsp;<span class="builtintype" id="7972887">string</span><span class="op" id="7972893">)</span>&nbsp;<span class="op" id="7972895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7972898">h</span>&nbsp;<span class="op" id="7972900">:=</span>&nbsp;<span class="op" id="7972903">&amp;</span><span class="ident" id="7972904">Handler</span><span class="op" id="7972911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7972915">Path</span><span class="op" id="7972919">:</span>&nbsp;<span class="ident" id="7972921">os</span><span class="op" id="7972923">.</span><span class="ident" id="7972924">Args</span><span class="op" id="7972928">[</span><span class="num" id="7972929">0</span><span class="op" id="7972930">]</span><span class="op" id="7972931">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7972935">Root</span><span class="op" id="7972939">:</span>&nbsp;<span class="string" id="7972941">&#34;/test.go&#34;</span><span class="op" id="7972951">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7972955">Args</span><span class="op" id="7972959">:</span>&nbsp;<span class="op" id="7972961">[</span><span class="op" id="7972962">]</span><span class="builtintype" id="7972963">string</span><span class="op" id="7972969">{</span><span class="string" id="7972970">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="7973003">}</span><span class="op" id="7973004">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7973007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7973010">expectedMap</span>&nbsp;<span class="op" id="7973022">:=</span>&nbsp;<span class="keyword" id="7973025">map</span><span class="op" id="7973028">[</span><span class="builtintype" id="7973029">string</span><span class="op" id="7973035">]</span><span class="builtintype" id="7973036">string</span><span class="op" id="7973042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7973046">&#34;_body&#34;</span><span class="op" id="7973053">:</span>&nbsp;<span class="string" id="7973055">&#34;&#34;</span><span class="op" id="7973057">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7973060">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7973063">replay</span>&nbsp;<span class="op" id="7973070">:=</span>&nbsp;<span class="ident" id="7973073">runCgiTest</span><span class="op" id="7973083">(</span><span class="ident" id="7973084">t</span><span class="op" id="7973085">,</span>&nbsp;<span class="ident" id="7973087">h</span><span class="op" id="7973088">,</span>&nbsp;<span class="string" id="7973090">&#34;GET&nbsp;&#34;</span><span class="op" id="7973096">+</span><span class="ident" id="7973097">path</span><span class="op" id="7973101">+</span><span class="string" id="7973102">&#34;&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7973136">,</span>&nbsp;<span class="ident" id="7973138">expectedMap</span><span class="op" id="7973149">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7973152">if</span>&nbsp;<span class="ident" id="7973155">replay</span><span class="op" id="7973161">.</span><span class="ident" id="7973162">Code</span>&nbsp;<span class="op" id="7973167">!=</span>&nbsp;<span class="num" id="7973170">500</span>&nbsp;<span class="op" id="7973174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7973178">t</span><span class="op" id="7973179">.</span><span class="ident" id="7973180">Errorf</span><span class="op" id="7973186">(</span><span class="string" id="7973187">&#34;Got&nbsp;code&nbsp;%d;&nbsp;want&nbsp;500&#34;</span><span class="op" id="7973210">,</span>&nbsp;<span class="ident" id="7973212">replay</span><span class="op" id="7973218">.</span><span class="ident" id="7973219">Code</span><span class="op" id="7973223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7973226">}</span><br>
<span class="lineno"></span><span class="op" id="7973228">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="7973231">type</span>&nbsp;<span class="ident" id="7973236">neverEnding</span>&nbsp;<span class="builtintype" id="7973248">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7973254">func</span>&nbsp;<span class="op" id="7973259">(</span><span class="ident" id="7973260">b</span>&nbsp;<span class="ident" id="7973262">neverEnding</span><span class="op" id="7973273">)</span>&nbsp;<span class="ident" id="7973275">Read</span><span class="op" id="7973279">(</span><span class="ident" id="7973280">p</span>&nbsp;<span class="op" id="7973282">[</span><span class="op" id="7973283">]</span><span class="builtintype" id="7973284">byte</span><span class="op" id="7973288">)</span>&nbsp;<span class="op" id="7973290">(</span><span class="ident" id="7973291">n</span>&nbsp;<span class="builtintype" id="7973293">int</span><span class="op" id="7973296">,</span>&nbsp;<span class="ident" id="7973298">err</span>&nbsp;<span class="builtintype" id="7973302">error</span><span class="op" id="7973307">)</span>&nbsp;<span class="op" id="7973309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7973312">for</span>&nbsp;<span class="ident" id="7973316">i</span>&nbsp;<span class="op" id="7973318">:=</span>&nbsp;<span class="keyword" id="7973321">range</span>&nbsp;<span class="ident" id="7973327">p</span>&nbsp;<span class="op" id="7973329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7973333">p</span><span class="op" id="7973334">[</span><span class="ident" id="7973335">i</span><span class="op" id="7973336">]</span>&nbsp;<span class="op" id="7973338">=</span>&nbsp;<span class="builtintype" id="7973340">byte</span><span class="op" id="7973344">(</span><span class="ident" id="7973345">b</span><span class="op" id="7973346">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7973349">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7973352">return</span>&nbsp;<span class="builtinfunc" id="7973359">len</span><span class="op" id="7973362">(</span><span class="ident" id="7973363">p</span><span class="op" id="7973364">)</span><span class="op" id="7973365">,</span>&nbsp;<span class="builtintype" id="7973367">nil</span><br>
<span class="lineno"></span><span class="op" id="7973371">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7973374">//&nbsp;Note:&nbsp;not&nbsp;actually&nbsp;a&nbsp;test.</span><br>
<span class="lineno">190</span><span class="keyword" id="7973404">func</span>&nbsp;<span class="ident" id="7973409">TestBeChildCGIProcess</span><span class="op" id="7973430">(</span><span class="ident" id="7973431">t</span>&nbsp;<span class="op" id="7973433">*</span><span class="ident" id="7973434">testing</span><span class="op" id="7973441">.</span><span class="ident" id="7973442">T</span><span class="op" id="7973443">)</span>&nbsp;<span class="op" id="7973445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7973448">if</span>&nbsp;<span class="ident" id="7973451">os</span><span class="op" id="7973453">.</span><span class="ident" id="7973454">Getenv</span><span class="op" id="7973460">(</span><span class="string" id="7973461">&#34;REQUEST_METHOD&#34;</span><span class="op" id="7973477">)</span>&nbsp;<span class="op" id="7973479">==</span>&nbsp;<span class="string" id="7973482">&#34;&#34;</span>&nbsp;<span class="op" id="7973485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7973489">//&nbsp;Not&nbsp;in&nbsp;a&nbsp;CGI&nbsp;environment;&nbsp;skipping&nbsp;test.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7973535">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7973543">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7973546">switch</span>&nbsp;<span class="ident" id="7973553">os</span><span class="op" id="7973555">.</span><span class="ident" id="7973556">Getenv</span><span class="op" id="7973562">(</span><span class="string" id="7973563">&#34;REQUEST_URI&#34;</span><span class="op" id="7973576">)</span>&nbsp;<span class="op" id="7973578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7973581">case</span>&nbsp;<span class="string" id="7973586">&#34;/immediate-disconnect&#34;</span><span class="op" id="7973609">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7973613">os</span><span class="op" id="7973615">.</span><span class="ident" id="7973616">Exit</span><span class="op" id="7973620">(</span><span class="num" id="7973621">0</span><span class="op" id="7973622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7973625">case</span>&nbsp;<span class="string" id="7973630">&#34;/no-content-type&#34;</span><span class="op" id="7973648">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7973652">fmt</span><span class="op" id="7973655">.</span><span class="ident" id="7973656">Printf</span><span class="op" id="7973662">(</span><span class="string" id="7973663">&#34;Content-Length:&nbsp;6\n\nHello\n&#34;</span><span class="op" id="7973693">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7973697">os</span><span class="op" id="7973699">.</span><span class="ident" id="7973700">Exit</span><span class="op" id="7973704">(</span><span class="num" id="7973705">0</span><span class="op" id="7973706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7973709">case</span>&nbsp;<span class="string" id="7973714">&#34;/empty-headers&#34;</span><span class="op" id="7973730">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7973734">fmt</span><span class="op" id="7973737">.</span><span class="ident" id="7973738">Printf</span><span class="op" id="7973744">(</span><span class="string" id="7973745">&#34;\nHello&#34;</span><span class="op" id="7973754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7973758">os</span><span class="op" id="7973760">.</span><span class="ident" id="7973761">Exit</span><span class="op" id="7973765">(</span><span class="num" id="7973766">0</span><span class="op" id="7973767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7973770">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7973773">Serve</span><span class="op" id="7973778">(</span><span class="ident" id="7973779">http</span><span class="op" id="7973783">.</span><span class="ident" id="7973784">HandlerFunc</span><span class="op" id="7973795">(</span><span class="keyword" id="7973796">func</span><span class="op" id="7973800">(</span><span class="ident" id="7973801">rw</span>&nbsp;<span class="ident" id="7973804">http</span><span class="op" id="7973808">.</span><span class="ident" id="7973809">ResponseWriter</span><span class="op" id="7973823">,</span>&nbsp;<span class="ident" id="7973825">req</span>&nbsp;<span class="op" id="7973829">*</span><span class="ident" id="7973830">http</span><span class="op" id="7973834">.</span><span class="ident" id="7973835">Request</span><span class="op" id="7973842">)</span>&nbsp;<span class="op" id="7973844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7973848">rw</span><span class="op" id="7973850">.</span><span class="ident" id="7973851">Header</span><span class="op" id="7973857">(</span><span class="op" id="7973858">)</span><span class="op" id="7973859">.</span><span class="ident" id="7973860">Set</span><span class="op" id="7973863">(</span><span class="string" id="7973864">&#34;X-Test-Header&#34;</span><span class="op" id="7973879">,</span>&nbsp;<span class="string" id="7973881">&#34;X-Test-Value&#34;</span><span class="op" id="7973895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7973899">req</span><span class="op" id="7973902">.</span><span class="ident" id="7973903">ParseForm</span><span class="op" id="7973912">(</span><span class="op" id="7973913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7973917">if</span>&nbsp;<span class="ident" id="7973920">req</span><span class="op" id="7973923">.</span><span class="ident" id="7973924">FormValue</span><span class="op" id="7973933">(</span><span class="string" id="7973934">&#34;no-body&#34;</span><span class="op" id="7973943">)</span>&nbsp;<span class="op" id="7973945">==</span>&nbsp;<span class="string" id="7973948">&#34;1&#34;</span>&nbsp;<span class="op" id="7973952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7973957">return</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7973966">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7973970">if</span>&nbsp;<span class="ident" id="7973973">req</span><span class="op" id="7973976">.</span><span class="ident" id="7973977">FormValue</span><span class="op" id="7973986">(</span><span class="string" id="7973987">&#34;write-forever&#34;</span><span class="op" id="7974002">)</span>&nbsp;<span class="op" id="7974004">==</span>&nbsp;<span class="string" id="7974007">&#34;1&#34;</span>&nbsp;<span class="op" id="7974011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7974016">io</span><span class="op" id="7974018">.</span><span class="ident" id="7974019">Copy</span><span class="op" id="7974023">(</span><span class="ident" id="7974024">rw</span><span class="op" id="7974026">,</span>&nbsp;<span class="ident" id="7974028">neverEnding</span><span class="op" id="7974039">(</span><span class="string" id="7974040">&#39;a&#39;</span><span class="op" id="7974043">)</span><span class="op" id="7974044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7974049">for</span>&nbsp;<span class="op" id="7974053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7974059">time</span><span class="op" id="7974063">.</span><span class="ident" id="7974064">Sleep</span><span class="op" id="7974069">(</span><span class="num" id="7974070">5</span>&nbsp;<span class="op" id="7974072">*</span>&nbsp;<span class="ident" id="7974074">time</span><span class="op" id="7974078">.</span><span class="ident" id="7974079">Second</span><span class="op" id="7974085">)</span>&nbsp;<span class="comment" id="7974087">//&nbsp;hang&nbsp;forever,&nbsp;until&nbsp;killed</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7974120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7974124">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7974128">fmt</span><span class="op" id="7974131">.</span><span class="ident" id="7974132">Fprintf</span><span class="op" id="7974139">(</span><span class="ident" id="7974140">rw</span><span class="op" id="7974142">,</span>&nbsp;<span class="string" id="7974144">&#34;test=Hello&nbsp;CGI-in-CGI\n&#34;</span><span class="op" id="7974169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7974173">for</span>&nbsp;<span class="ident" id="7974177">k</span><span class="op" id="7974178">,</span>&nbsp;<span class="ident" id="7974180">vv</span>&nbsp;<span class="op" id="7974183">:=</span>&nbsp;<span class="keyword" id="7974186">range</span>&nbsp;<span class="ident" id="7974192">req</span><span class="op" id="7974195">.</span><span class="ident" id="7974196">Form</span>&nbsp;<span class="op" id="7974201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7974206">for</span>&nbsp;<span class="ident" id="7974210">_</span><span class="op" id="7974211">,</span>&nbsp;<span class="ident" id="7974213">v</span>&nbsp;<span class="op" id="7974215">:=</span>&nbsp;<span class="keyword" id="7974218">range</span>&nbsp;<span class="ident" id="7974224">vv</span>&nbsp;<span class="op" id="7974227">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7974233">fmt</span><span class="op" id="7974236">.</span><span class="ident" id="7974237">Fprintf</span><span class="op" id="7974244">(</span><span class="ident" id="7974245">rw</span><span class="op" id="7974247">,</span>&nbsp;<span class="string" id="7974249">&#34;param-%s=%s\n&#34;</span><span class="op" id="7974264">,</span>&nbsp;<span class="ident" id="7974266">k</span><span class="op" id="7974267">,</span>&nbsp;<span class="ident" id="7974269">v</span><span class="op" id="7974270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7974275">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7974279">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7974283">for</span>&nbsp;<span class="ident" id="7974287">_</span><span class="op" id="7974288">,</span>&nbsp;<span class="ident" id="7974290">kv</span>&nbsp;<span class="op" id="7974293">:=</span>&nbsp;<span class="keyword" id="7974296">range</span>&nbsp;<span class="ident" id="7974302">os</span><span class="op" id="7974304">.</span><span class="ident" id="7974305">Environ</span><span class="op" id="7974312">(</span><span class="op" id="7974313">)</span>&nbsp;<span class="op" id="7974315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7974320">fmt</span><span class="op" id="7974323">.</span><span class="ident" id="7974324">Fprintf</span><span class="op" id="7974331">(</span><span class="ident" id="7974332">rw</span><span class="op" id="7974334">,</span>&nbsp;<span class="string" id="7974336">&#34;env-%s\n&#34;</span><span class="op" id="7974346">,</span>&nbsp;<span class="ident" id="7974348">kv</span><span class="op" id="7974350">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7974354">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7974357">}</span><span class="op" id="7974358">)</span><span class="op" id="7974359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7974362">os</span><span class="op" id="7974364">.</span><span class="ident" id="7974365">Exit</span><span class="op" id="7974369">(</span><span class="num" id="7974370">0</span><span class="op" id="7974371">)</span><br>
<span class="lineno"></span><span class="op" id="7974373">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
