<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3390669">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3390725">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3390779">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3390830">package</span>&nbsp;<span class="ident" id="3390838">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3390844">import</span>&nbsp;<span class="op" id="3390851">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3390854">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3390860">&#34;net/textproto&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3390877">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3390885">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3390896">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3390904">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3390911">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="3390914">var</span>&nbsp;<span class="ident" id="3390918">raceEnabled</span>&nbsp;<span class="op" id="3390930">=</span>&nbsp;<span class="builtintype" id="3390932">false</span>&nbsp;<span class="comment" id="3390938">//&nbsp;set&nbsp;by&nbsp;race.go</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3390957">//&nbsp;A&nbsp;Header&nbsp;represents&nbsp;the&nbsp;key-value&nbsp;pairs&nbsp;in&nbsp;an&nbsp;HTTP&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="3391019">type</span>&nbsp;<span class="ident" id="3391024">Header</span>&nbsp;<span class="keyword" id="3391031">map</span><span class="op" id="3391034">[</span><span class="builtintype" id="3391035">string</span><span class="op" id="3391041">]</span><span class="op" id="3391042">[</span><span class="op" id="3391043">]</span><span class="builtintype" id="3391044">string</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="3391052">//&nbsp;Add&nbsp;adds&nbsp;the&nbsp;key,&nbsp;value&nbsp;pair&nbsp;to&nbsp;the&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="3391099">//&nbsp;It&nbsp;appends&nbsp;to&nbsp;any&nbsp;existing&nbsp;values&nbsp;associated&nbsp;with&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="3391157">func</span>&nbsp;<span class="op" id="3391162">(</span><span class="ident" id="3391163">h</span>&nbsp;<span class="ident" id="3391165">Header</span><span class="op" id="3391171">)</span>&nbsp;<span class="ident" id="3391173">Add</span><span class="op" id="3391176">(</span><span class="ident" id="3391177">key</span><span class="op" id="3391180">,</span>&nbsp;<span class="ident" id="3391182">value</span>&nbsp;<span class="builtintype" id="3391188">string</span><span class="op" id="3391194">)</span>&nbsp;<span class="op" id="3391196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3391199">textproto</span><span class="op" id="3391208">.</span><span class="ident" id="3391209">MIMEHeader</span><span class="op" id="3391219">(</span><span class="ident" id="3391220">h</span><span class="op" id="3391221">)</span><span class="op" id="3391222">.</span><span class="ident" id="3391223">Add</span><span class="op" id="3391226">(</span><span class="ident" id="3391227">key</span><span class="op" id="3391230">,</span>&nbsp;<span class="ident" id="3391232">value</span><span class="op" id="3391237">)</span><br>
<span class="lineno">25</span><span class="op" id="3391239">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3391242">//&nbsp;Set&nbsp;sets&nbsp;the&nbsp;header&nbsp;entries&nbsp;associated&nbsp;with&nbsp;key&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3391296">//&nbsp;the&nbsp;single&nbsp;element&nbsp;value.&nbsp;&nbsp;It&nbsp;replaces&nbsp;any&nbsp;existing</span><br>
<span class="lineno"></span><span class="comment" id="3391351">//&nbsp;values&nbsp;associated&nbsp;with&nbsp;key.</span><br>
<span class="lineno">30</span><span class="keyword" id="3391382">func</span>&nbsp;<span class="op" id="3391387">(</span><span class="ident" id="3391388">h</span>&nbsp;<span class="ident" id="3391390">Header</span><span class="op" id="3391396">)</span>&nbsp;<span class="ident" id="3391398">Set</span><span class="op" id="3391401">(</span><span class="ident" id="3391402">key</span><span class="op" id="3391405">,</span>&nbsp;<span class="ident" id="3391407">value</span>&nbsp;<span class="builtintype" id="3391413">string</span><span class="op" id="3391419">)</span>&nbsp;<span class="op" id="3391421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3391424">textproto</span><span class="op" id="3391433">.</span><span class="ident" id="3391434">MIMEHeader</span><span class="op" id="3391444">(</span><span class="ident" id="3391445">h</span><span class="op" id="3391446">)</span><span class="op" id="3391447">.</span><span class="ident" id="3391448">Set</span><span class="op" id="3391451">(</span><span class="ident" id="3391452">key</span><span class="op" id="3391455">,</span>&nbsp;<span class="ident" id="3391457">value</span><span class="op" id="3391462">)</span><br>
<span class="lineno"></span><span class="op" id="3391464">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3391467">//&nbsp;Get&nbsp;gets&nbsp;the&nbsp;first&nbsp;value&nbsp;associated&nbsp;with&nbsp;the&nbsp;given&nbsp;key.</span><br>
<span class="lineno">35</span><span class="comment" id="3391526">//&nbsp;If&nbsp;there&nbsp;are&nbsp;no&nbsp;values&nbsp;associated&nbsp;with&nbsp;the&nbsp;key,&nbsp;Get&nbsp;returns&nbsp;&#34;&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="3391593">//&nbsp;To&nbsp;access&nbsp;multiple&nbsp;values&nbsp;of&nbsp;a&nbsp;key,&nbsp;access&nbsp;the&nbsp;map&nbsp;directly</span><br>
<span class="lineno"></span><span class="comment" id="3391656">//&nbsp;with&nbsp;CanonicalHeaderKey.</span><br>
<span class="lineno"></span><span class="keyword" id="3391684">func</span>&nbsp;<span class="op" id="3391689">(</span><span class="ident" id="3391690">h</span>&nbsp;<span class="ident" id="3391692">Header</span><span class="op" id="3391698">)</span>&nbsp;<span class="ident" id="3391700">Get</span><span class="op" id="3391703">(</span><span class="ident" id="3391704">key</span>&nbsp;<span class="builtintype" id="3391708">string</span><span class="op" id="3391714">)</span>&nbsp;<span class="builtintype" id="3391716">string</span>&nbsp;<span class="op" id="3391723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3391726">return</span>&nbsp;<span class="ident" id="3391733">textproto</span><span class="op" id="3391742">.</span><span class="ident" id="3391743">MIMEHeader</span><span class="op" id="3391753">(</span><span class="ident" id="3391754">h</span><span class="op" id="3391755">)</span><span class="op" id="3391756">.</span><span class="ident" id="3391757">Get</span><span class="op" id="3391760">(</span><span class="ident" id="3391761">key</span><span class="op" id="3391764">)</span><br>
<span class="lineno">40</span><span class="op" id="3391766">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3391769">//&nbsp;get&nbsp;is&nbsp;like&nbsp;Get,&nbsp;but&nbsp;key&nbsp;must&nbsp;already&nbsp;be&nbsp;in&nbsp;CanonicalHeaderKey&nbsp;form.</span><br>
<span class="lineno"></span><span class="keyword" id="3391841">func</span>&nbsp;<span class="op" id="3391846">(</span><span class="ident" id="3391847">h</span>&nbsp;<span class="ident" id="3391849">Header</span><span class="op" id="3391855">)</span>&nbsp;<span class="ident" id="3391857">get</span><span class="op" id="3391860">(</span><span class="ident" id="3391861">key</span>&nbsp;<span class="builtintype" id="3391865">string</span><span class="op" id="3391871">)</span>&nbsp;<span class="builtintype" id="3391873">string</span>&nbsp;<span class="op" id="3391880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3391883">if</span>&nbsp;<span class="ident" id="3391886">v</span>&nbsp;<span class="op" id="3391888">:=</span>&nbsp;<span class="ident" id="3391891">h</span><span class="op" id="3391892">[</span><span class="ident" id="3391893">key</span><span class="op" id="3391896">]</span><span class="op" id="3391897">;</span>&nbsp;<span class="builtinfunc" id="3391899">len</span><span class="op" id="3391902">(</span><span class="ident" id="3391903">v</span><span class="op" id="3391904">)</span>&nbsp;<span class="op" id="3391906">&gt;</span>&nbsp;<span class="num" id="3391908">0</span>&nbsp;<span class="op" id="3391910">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3391914">return</span>&nbsp;<span class="ident" id="3391921">v</span><span class="op" id="3391922">[</span><span class="num" id="3391923">0</span><span class="op" id="3391924">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3391927">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3391930">return</span>&nbsp;<span class="string" id="3391937">&#34;&#34;</span><br>
<span class="lineno"></span><span class="op" id="3391940">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="3391943">//&nbsp;Del&nbsp;deletes&nbsp;the&nbsp;values&nbsp;associated&nbsp;with&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="3391990">func</span>&nbsp;<span class="op" id="3391995">(</span><span class="ident" id="3391996">h</span>&nbsp;<span class="ident" id="3391998">Header</span><span class="op" id="3392004">)</span>&nbsp;<span class="ident" id="3392006">Del</span><span class="op" id="3392009">(</span><span class="ident" id="3392010">key</span>&nbsp;<span class="builtintype" id="3392014">string</span><span class="op" id="3392020">)</span>&nbsp;<span class="op" id="3392022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3392025">textproto</span><span class="op" id="3392034">.</span><span class="ident" id="3392035">MIMEHeader</span><span class="op" id="3392045">(</span><span class="ident" id="3392046">h</span><span class="op" id="3392047">)</span><span class="op" id="3392048">.</span><span class="ident" id="3392049">Del</span><span class="op" id="3392052">(</span><span class="ident" id="3392053">key</span><span class="op" id="3392056">)</span><br>
<span class="lineno"></span><span class="op" id="3392058">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="3392061">//&nbsp;Write&nbsp;writes&nbsp;a&nbsp;header&nbsp;in&nbsp;wire&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword" id="3392102">func</span>&nbsp;<span class="op" id="3392107">(</span><span class="ident" id="3392108">h</span>&nbsp;<span class="ident" id="3392110">Header</span><span class="op" id="3392116">)</span>&nbsp;<span class="ident" id="3392118">Write</span><span class="op" id="3392123">(</span><span class="ident" id="3392124">w</span>&nbsp;<span class="ident" id="3392126">io</span><span class="op" id="3392128">.</span><span class="ident" id="3392129">Writer</span><span class="op" id="3392135">)</span>&nbsp;<span class="builtintype" id="3392137">error</span>&nbsp;<span class="op" id="3392143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3392146">return</span>&nbsp;<span class="ident" id="3392153">h</span><span class="op" id="3392154">.</span><span class="ident" id="3392155">WriteSubset</span><span class="op" id="3392166">(</span><span class="ident" id="3392167">w</span><span class="op" id="3392168">,</span>&nbsp;<span class="ident" id="3392170">nil</span><span class="op" id="3392173">)</span><br>
<span class="lineno"></span><span class="op" id="3392175">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="3392178">func</span>&nbsp;<span class="op" id="3392183">(</span><span class="ident" id="3392184">h</span>&nbsp;<span class="ident" id="3392186">Header</span><span class="op" id="3392192">)</span>&nbsp;<span class="ident" id="3392194">clone</span><span class="op" id="3392199">(</span><span class="op" id="3392200">)</span>&nbsp;<span class="ident" id="3392202">Header</span>&nbsp;<span class="op" id="3392209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3392212">h2</span>&nbsp;<span class="op" id="3392215">:=</span>&nbsp;<span class="builtinfunc" id="3392218">make</span><span class="op" id="3392222">(</span><span class="ident" id="3392223">Header</span><span class="op" id="3392229">,</span>&nbsp;<span class="builtinfunc" id="3392231">len</span><span class="op" id="3392234">(</span><span class="ident" id="3392235">h</span><span class="op" id="3392236">)</span><span class="op" id="3392237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3392240">for</span>&nbsp;<span class="ident" id="3392244">k</span><span class="op" id="3392245">,</span>&nbsp;<span class="ident" id="3392247">vv</span>&nbsp;<span class="op" id="3392250">:=</span>&nbsp;<span class="keyword" id="3392253">range</span>&nbsp;<span class="ident" id="3392259">h</span>&nbsp;<span class="op" id="3392261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3392265">vv2</span>&nbsp;<span class="op" id="3392269">:=</span>&nbsp;<span class="builtinfunc" id="3392272">make</span><span class="op" id="3392276">(</span><span class="op" id="3392277">[</span><span class="op" id="3392278">]</span><span class="builtintype" id="3392279">string</span><span class="op" id="3392285">,</span>&nbsp;<span class="builtinfunc" id="3392287">len</span><span class="op" id="3392290">(</span><span class="ident" id="3392291">vv</span><span class="op" id="3392293">)</span><span class="op" id="3392294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3392298">copy</span><span class="op" id="3392302">(</span><span class="ident" id="3392303">vv2</span><span class="op" id="3392306">,</span>&nbsp;<span class="ident" id="3392308">vv</span><span class="op" id="3392310">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3392314">h2</span><span class="op" id="3392316">[</span><span class="ident" id="3392317">k</span><span class="op" id="3392318">]</span>&nbsp;<span class="op" id="3392320">=</span>&nbsp;<span class="ident" id="3392322">vv2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3392327">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3392330">return</span>&nbsp;<span class="ident" id="3392337">h2</span><br>
<span class="lineno"></span><span class="op" id="3392340">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="keyword" id="3392343">var</span>&nbsp;<span class="ident" id="3392347">timeFormats</span>&nbsp;<span class="op" id="3392359">=</span>&nbsp;<span class="op" id="3392361">[</span><span class="op" id="3392362">]</span><span class="builtintype" id="3392363">string</span><span class="op" id="3392369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3392372">TimeFormat</span><span class="op" id="3392382">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3392385">time</span><span class="op" id="3392389">.</span><span class="ident" id="3392390">RFC850</span><span class="op" id="3392396">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3392399">time</span><span class="op" id="3392403">.</span><span class="ident" id="3392404">ANSIC</span><span class="op" id="3392409">,</span><br>
<span class="lineno"></span><span class="op" id="3392411">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="comment" id="3392414">//&nbsp;ParseTime&nbsp;parses&nbsp;a&nbsp;time&nbsp;header&nbsp;(such&nbsp;as&nbsp;the&nbsp;Date:&nbsp;header),</span><br>
<span class="lineno"></span><span class="comment" id="3392476">//&nbsp;trying&nbsp;each&nbsp;of&nbsp;the&nbsp;three&nbsp;formats&nbsp;allowed&nbsp;by&nbsp;HTTP/1.1:</span><br>
<span class="lineno"></span><span class="comment" id="3392533">//&nbsp;TimeFormat,&nbsp;time.RFC850,&nbsp;and&nbsp;time.ANSIC.</span><br>
<span class="lineno"></span><span class="keyword" id="3392577">func</span>&nbsp;<span class="ident" id="3392582">ParseTime</span><span class="op" id="3392591">(</span><span class="ident" id="3392592">text</span>&nbsp;<span class="builtintype" id="3392597">string</span><span class="op" id="3392603">)</span>&nbsp;<span class="op" id="3392605">(</span><span class="ident" id="3392606">t</span>&nbsp;<span class="ident" id="3392608">time</span><span class="op" id="3392612">.</span><span class="ident" id="3392613">Time</span><span class="op" id="3392617">,</span>&nbsp;<span class="ident" id="3392619">err</span>&nbsp;<span class="builtintype" id="3392623">error</span><span class="op" id="3392628">)</span>&nbsp;<span class="op" id="3392630">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3392633">for</span>&nbsp;<span class="ident" id="3392637">_</span><span class="op" id="3392638">,</span>&nbsp;<span class="ident" id="3392640">layout</span>&nbsp;<span class="op" id="3392647">:=</span>&nbsp;<span class="keyword" id="3392650">range</span>&nbsp;<span class="ident" id="3392656">timeFormats</span>&nbsp;<span class="op" id="3392668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3392672">t</span><span class="op" id="3392673">,</span>&nbsp;<span class="ident" id="3392675">err</span>&nbsp;<span class="op" id="3392679">=</span>&nbsp;<span class="ident" id="3392681">time</span><span class="op" id="3392685">.</span><span class="ident" id="3392686">Parse</span><span class="op" id="3392691">(</span><span class="ident" id="3392692">layout</span><span class="op" id="3392698">,</span>&nbsp;<span class="ident" id="3392700">text</span><span class="op" id="3392704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3392708">if</span>&nbsp;<span class="ident" id="3392711">err</span>&nbsp;<span class="op" id="3392715">==</span>&nbsp;<span class="ident" id="3392718">nil</span>&nbsp;<span class="op" id="3392722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3392727">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3392736">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3392739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3392742">return</span><br>
<span class="lineno"></span><span class="op" id="3392749">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3392752">var</span>&nbsp;<span class="ident" id="3392756">headerNewlineToSpace</span>&nbsp;<span class="op" id="3392777">=</span>&nbsp;<span class="ident" id="3392779">strings</span><span class="op" id="3392786">.</span><span class="ident" id="3392787">NewReplacer</span><span class="op" id="3392798">(</span><span class="string" id="3392799">&#34;\n&#34;</span><span class="op" id="3392803">,</span>&nbsp;<span class="string" id="3392805">&#34;&nbsp;&#34;</span><span class="op" id="3392808">,</span>&nbsp;<span class="string" id="3392810">&#34;\r&#34;</span><span class="op" id="3392814">,</span>&nbsp;<span class="string" id="3392816">&#34;&nbsp;&#34;</span><span class="op" id="3392819">)</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="3392822">type</span>&nbsp;<span class="ident" id="3392827">writeStringer</span>&nbsp;<span class="keyword" id="3392841">interface</span>&nbsp;<span class="op" id="3392851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3392854">WriteString</span><span class="op" id="3392865">(</span><span class="builtintype" id="3392866">string</span><span class="op" id="3392872">)</span>&nbsp;<span class="op" id="3392874">(</span><span class="builtintype" id="3392875">int</span><span class="op" id="3392878">,</span>&nbsp;<span class="builtintype" id="3392880">error</span><span class="op" id="3392885">)</span><br>
<span class="lineno"></span><span class="op" id="3392887">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="3392890">//&nbsp;stringWriter&nbsp;implements&nbsp;WriteString&nbsp;on&nbsp;a&nbsp;Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="3392942">type</span>&nbsp;<span class="ident" id="3392947">stringWriter</span>&nbsp;<span class="keyword" id="3392960">struct</span>&nbsp;<span class="op" id="3392967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3392970">w</span>&nbsp;<span class="ident" id="3392972">io</span><span class="op" id="3392974">.</span><span class="ident" id="3392975">Writer</span><br>
<span class="lineno"></span><span class="op" id="3392982">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="3392985">func</span>&nbsp;<span class="op" id="3392990">(</span><span class="ident" id="3392991">w</span>&nbsp;<span class="ident" id="3392993">stringWriter</span><span class="op" id="3393005">)</span>&nbsp;<span class="ident" id="3393007">WriteString</span><span class="op" id="3393018">(</span><span class="ident" id="3393019">s</span>&nbsp;<span class="builtintype" id="3393021">string</span><span class="op" id="3393027">)</span>&nbsp;<span class="op" id="3393029">(</span><span class="ident" id="3393030">n</span>&nbsp;<span class="builtintype" id="3393032">int</span><span class="op" id="3393035">,</span>&nbsp;<span class="ident" id="3393037">err</span>&nbsp;<span class="builtintype" id="3393041">error</span><span class="op" id="3393046">)</span>&nbsp;<span class="op" id="3393048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3393051">return</span>&nbsp;<span class="ident" id="3393058">w</span><span class="op" id="3393059">.</span><span class="ident" id="3393060">w</span><span class="op" id="3393061">.</span><span class="ident" id="3393062">Write</span><span class="op" id="3393067">(</span><span class="op" id="3393068">[</span><span class="op" id="3393069">]</span><span class="builtintype" id="3393070">byte</span><span class="op" id="3393074">(</span><span class="ident" id="3393075">s</span><span class="op" id="3393076">)</span><span class="op" id="3393077">)</span><br>
<span class="lineno"></span><span class="op" id="3393079">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3393082">type</span>&nbsp;<span class="ident" id="3393087">keyValues</span>&nbsp;<span class="keyword" id="3393097">struct</span>&nbsp;<span class="op" id="3393104">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3393107">key</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3393114">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3393122">values</span>&nbsp;<span class="op" id="3393129">[</span><span class="op" id="3393130">]</span><span class="builtintype" id="3393131">string</span><br>
<span class="lineno"></span><span class="op" id="3393138">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3393141">//&nbsp;A&nbsp;headerSorter&nbsp;implements&nbsp;sort.Interface&nbsp;by&nbsp;sorting&nbsp;a&nbsp;[]keyValues</span><br>
<span class="lineno">110</span><span class="comment" id="3393210">//&nbsp;by&nbsp;key.&nbsp;It&#39;s&nbsp;used&nbsp;as&nbsp;a&nbsp;pointer,&nbsp;so&nbsp;it&nbsp;can&nbsp;fit&nbsp;in&nbsp;a&nbsp;sort.Interface</span><br>
<span class="lineno"></span><span class="comment" id="3393279">//&nbsp;interface&nbsp;value&nbsp;without&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="keyword" id="3393318">type</span>&nbsp;<span class="ident" id="3393323">headerSorter</span>&nbsp;<span class="keyword" id="3393336">struct</span>&nbsp;<span class="op" id="3393343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3393346">kvs</span>&nbsp;<span class="op" id="3393350">[</span><span class="op" id="3393351">]</span><span class="ident" id="3393352">keyValues</span><br>
<span class="lineno"></span><span class="op" id="3393362">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="keyword" id="3393365">func</span>&nbsp;<span class="op" id="3393370">(</span><span class="ident" id="3393371">s</span>&nbsp;<span class="op" id="3393373">*</span><span class="ident" id="3393374">headerSorter</span><span class="op" id="3393386">)</span>&nbsp;<span class="ident" id="3393388">Len</span><span class="op" id="3393391">(</span><span class="op" id="3393392">)</span>&nbsp;<span class="builtintype" id="3393394">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3393408">{</span>&nbsp;<span class="keyword" id="3393410">return</span>&nbsp;<span class="builtinfunc" id="3393417">len</span><span class="op" id="3393420">(</span><span class="ident" id="3393421">s</span><span class="op" id="3393422">.</span><span class="ident" id="3393423">kvs</span><span class="op" id="3393426">)</span>&nbsp;<span class="op" id="3393428">}</span><br>
<span class="lineno"></span><span class="keyword" id="3393430">func</span>&nbsp;<span class="op" id="3393435">(</span><span class="ident" id="3393436">s</span>&nbsp;<span class="op" id="3393438">*</span><span class="ident" id="3393439">headerSorter</span><span class="op" id="3393451">)</span>&nbsp;<span class="ident" id="3393453">Swap</span><span class="op" id="3393457">(</span><span class="ident" id="3393458">i</span><span class="op" id="3393459">,</span>&nbsp;<span class="ident" id="3393461">j</span>&nbsp;<span class="builtintype" id="3393463">int</span><span class="op" id="3393466">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3393473">{</span>&nbsp;<span class="ident" id="3393475">s</span><span class="op" id="3393476">.</span><span class="ident" id="3393477">kvs</span><span class="op" id="3393480">[</span><span class="ident" id="3393481">i</span><span class="op" id="3393482">]</span><span class="op" id="3393483">,</span>&nbsp;<span class="ident" id="3393485">s</span><span class="op" id="3393486">.</span><span class="ident" id="3393487">kvs</span><span class="op" id="3393490">[</span><span class="ident" id="3393491">j</span><span class="op" id="3393492">]</span>&nbsp;<span class="op" id="3393494">=</span>&nbsp;<span class="ident" id="3393496">s</span><span class="op" id="3393497">.</span><span class="ident" id="3393498">kvs</span><span class="op" id="3393501">[</span><span class="ident" id="3393502">j</span><span class="op" id="3393503">]</span><span class="op" id="3393504">,</span>&nbsp;<span class="ident" id="3393506">s</span><span class="op" id="3393507">.</span><span class="ident" id="3393508">kvs</span><span class="op" id="3393511">[</span><span class="ident" id="3393512">i</span><span class="op" id="3393513">]</span>&nbsp;<span class="op" id="3393515">}</span><br>
<span class="lineno"></span><span class="keyword" id="3393517">func</span>&nbsp;<span class="op" id="3393522">(</span><span class="ident" id="3393523">s</span>&nbsp;<span class="op" id="3393525">*</span><span class="ident" id="3393526">headerSorter</span><span class="op" id="3393538">)</span>&nbsp;<span class="ident" id="3393540">Less</span><span class="op" id="3393544">(</span><span class="ident" id="3393545">i</span><span class="op" id="3393546">,</span>&nbsp;<span class="ident" id="3393548">j</span>&nbsp;<span class="builtintype" id="3393550">int</span><span class="op" id="3393553">)</span>&nbsp;<span class="builtintype" id="3393555">bool</span>&nbsp;<span class="op" id="3393560">{</span>&nbsp;<span class="keyword" id="3393562">return</span>&nbsp;<span class="ident" id="3393569">s</span><span class="op" id="3393570">.</span><span class="ident" id="3393571">kvs</span><span class="op" id="3393574">[</span><span class="ident" id="3393575">i</span><span class="op" id="3393576">]</span><span class="op" id="3393577">.</span><span class="ident" id="3393578">key</span>&nbsp;<span class="op" id="3393582">&lt;</span>&nbsp;<span class="ident" id="3393584">s</span><span class="op" id="3393585">.</span><span class="ident" id="3393586">kvs</span><span class="op" id="3393589">[</span><span class="ident" id="3393590">j</span><span class="op" id="3393591">]</span><span class="op" id="3393592">.</span><span class="ident" id="3393593">key</span>&nbsp;<span class="op" id="3393597">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="keyword" id="3393600">var</span>&nbsp;<span class="ident" id="3393604">headerSorterPool</span>&nbsp;<span class="op" id="3393621">=</span>&nbsp;<span class="ident" id="3393623">sync</span><span class="op" id="3393627">.</span><span class="ident" id="3393628">Pool</span><span class="op" id="3393632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3393635">New</span><span class="op" id="3393638">:</span>&nbsp;<span class="keyword" id="3393640">func</span><span class="op" id="3393644">(</span><span class="op" id="3393645">)</span>&nbsp;<span class="keyword" id="3393647">interface</span><span class="op" id="3393656">{</span><span class="op" id="3393657">}</span>&nbsp;<span class="op" id="3393659">{</span>&nbsp;<span class="keyword" id="3393661">return</span>&nbsp;<span class="builtinfunc" id="3393668">new</span><span class="op" id="3393671">(</span><span class="ident" id="3393672">headerSorter</span><span class="op" id="3393684">)</span>&nbsp;<span class="op" id="3393686">}</span><span class="op" id="3393687">,</span><br>
<span class="lineno"></span><span class="op" id="3393689">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3393692">//&nbsp;sortedKeyValues&nbsp;returns&nbsp;h&#39;s&nbsp;keys&nbsp;sorted&nbsp;in&nbsp;the&nbsp;returned&nbsp;kvs</span><br>
<span class="lineno">125</span><span class="comment" id="3393755">//&nbsp;slice.&nbsp;The&nbsp;headerSorter&nbsp;used&nbsp;to&nbsp;sort&nbsp;is&nbsp;also&nbsp;returned,&nbsp;for&nbsp;possible</span><br>
<span class="lineno"></span><span class="comment" id="3393826">//&nbsp;return&nbsp;to&nbsp;headerSorterCache.</span><br>
<span class="lineno"></span><span class="keyword" id="3393858">func</span>&nbsp;<span class="op" id="3393863">(</span><span class="ident" id="3393864">h</span>&nbsp;<span class="ident" id="3393866">Header</span><span class="op" id="3393872">)</span>&nbsp;<span class="ident" id="3393874">sortedKeyValues</span><span class="op" id="3393889">(</span><span class="ident" id="3393890">exclude</span>&nbsp;<span class="keyword" id="3393898">map</span><span class="op" id="3393901">[</span><span class="builtintype" id="3393902">string</span><span class="op" id="3393908">]</span><span class="builtintype" id="3393909">bool</span><span class="op" id="3393913">)</span>&nbsp;<span class="op" id="3393915">(</span><span class="ident" id="3393916">kvs</span>&nbsp;<span class="op" id="3393920">[</span><span class="op" id="3393921">]</span><span class="ident" id="3393922">keyValues</span><span class="op" id="3393931">,</span>&nbsp;<span class="ident" id="3393933">hs</span>&nbsp;<span class="op" id="3393936">*</span><span class="ident" id="3393937">headerSorter</span><span class="op" id="3393949">)</span>&nbsp;<span class="op" id="3393951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3393954">hs</span>&nbsp;<span class="op" id="3393957">=</span>&nbsp;<span class="ident" id="3393959">headerSorterPool</span><span class="op" id="3393975">.</span><span class="ident" id="3393976">Get</span><span class="op" id="3393979">(</span><span class="op" id="3393980">)</span><span class="op" id="3393981">.</span><span class="op" id="3393982">(</span><span class="op" id="3393983">*</span><span class="ident" id="3393984">headerSorter</span><span class="op" id="3393996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3393999">if</span>&nbsp;<span class="builtinfunc" id="3394002">cap</span><span class="op" id="3394005">(</span><span class="ident" id="3394006">hs</span><span class="op" id="3394008">.</span><span class="ident" id="3394009">kvs</span><span class="op" id="3394012">)</span>&nbsp;<span class="op" id="3394014">&lt;</span>&nbsp;<span class="builtinfunc" id="3394016">len</span><span class="op" id="3394019">(</span><span class="ident" id="3394020">h</span><span class="op" id="3394021">)</span>&nbsp;<span class="op" id="3394023">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3394027">hs</span><span class="op" id="3394029">.</span><span class="ident" id="3394030">kvs</span>&nbsp;<span class="op" id="3394034">=</span>&nbsp;<span class="builtinfunc" id="3394036">make</span><span class="op" id="3394040">(</span><span class="op" id="3394041">[</span><span class="op" id="3394042">]</span><span class="ident" id="3394043">keyValues</span><span class="op" id="3394052">,</span>&nbsp;<span class="num" id="3394054">0</span><span class="op" id="3394055">,</span>&nbsp;<span class="builtinfunc" id="3394057">len</span><span class="op" id="3394060">(</span><span class="ident" id="3394061">h</span><span class="op" id="3394062">)</span><span class="op" id="3394063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3394066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3394069">kvs</span>&nbsp;<span class="op" id="3394073">=</span>&nbsp;<span class="ident" id="3394075">hs</span><span class="op" id="3394077">.</span><span class="ident" id="3394078">kvs</span><span class="op" id="3394081">[</span><span class="op" id="3394082">:</span><span class="num" id="3394083">0</span><span class="op" id="3394084">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3394087">for</span>&nbsp;<span class="ident" id="3394091">k</span><span class="op" id="3394092">,</span>&nbsp;<span class="ident" id="3394094">vv</span>&nbsp;<span class="op" id="3394097">:=</span>&nbsp;<span class="keyword" id="3394100">range</span>&nbsp;<span class="ident" id="3394106">h</span>&nbsp;<span class="op" id="3394108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3394112">if</span>&nbsp;<span class="op" id="3394115">!</span><span class="ident" id="3394116">exclude</span><span class="op" id="3394123">[</span><span class="ident" id="3394124">k</span><span class="op" id="3394125">]</span>&nbsp;<span class="op" id="3394127">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3394132">kvs</span>&nbsp;<span class="op" id="3394136">=</span>&nbsp;<span class="builtinfunc" id="3394138">append</span><span class="op" id="3394144">(</span><span class="ident" id="3394145">kvs</span><span class="op" id="3394148">,</span>&nbsp;<span class="ident" id="3394150">keyValues</span><span class="op" id="3394159">{</span><span class="ident" id="3394160">k</span><span class="op" id="3394161">,</span>&nbsp;<span class="ident" id="3394163">vv</span><span class="op" id="3394165">}</span><span class="op" id="3394166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3394170">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3394173">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3394176">hs</span><span class="op" id="3394178">.</span><span class="ident" id="3394179">kvs</span>&nbsp;<span class="op" id="3394183">=</span>&nbsp;<span class="ident" id="3394185">kvs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3394190">sort</span><span class="op" id="3394194">.</span><span class="ident" id="3394195">Sort</span><span class="op" id="3394199">(</span><span class="ident" id="3394200">hs</span><span class="op" id="3394202">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3394205">return</span>&nbsp;<span class="ident" id="3394212">kvs</span><span class="op" id="3394215">,</span>&nbsp;<span class="ident" id="3394217">hs</span><br>
<span class="lineno"></span><span class="op" id="3394220">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3394223">//&nbsp;WriteSubset&nbsp;writes&nbsp;a&nbsp;header&nbsp;in&nbsp;wire&nbsp;format.</span><br>
<span class="lineno"></span><span class="comment" id="3394270">//&nbsp;If&nbsp;exclude&nbsp;is&nbsp;not&nbsp;nil,&nbsp;keys&nbsp;where&nbsp;exclude[key]&nbsp;==&nbsp;true&nbsp;are&nbsp;not&nbsp;written.</span><br>
<span class="lineno">145</span><span class="keyword" id="3394345">func</span>&nbsp;<span class="op" id="3394350">(</span><span class="ident" id="3394351">h</span>&nbsp;<span class="ident" id="3394353">Header</span><span class="op" id="3394359">)</span>&nbsp;<span class="ident" id="3394361">WriteSubset</span><span class="op" id="3394372">(</span><span class="ident" id="3394373">w</span>&nbsp;<span class="ident" id="3394375">io</span><span class="op" id="3394377">.</span><span class="ident" id="3394378">Writer</span><span class="op" id="3394384">,</span>&nbsp;<span class="ident" id="3394386">exclude</span>&nbsp;<span class="keyword" id="3394394">map</span><span class="op" id="3394397">[</span><span class="builtintype" id="3394398">string</span><span class="op" id="3394404">]</span><span class="builtintype" id="3394405">bool</span><span class="op" id="3394409">)</span>&nbsp;<span class="builtintype" id="3394411">error</span>&nbsp;<span class="op" id="3394417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3394420">ws</span><span class="op" id="3394422">,</span>&nbsp;<span class="ident" id="3394424">ok</span>&nbsp;<span class="op" id="3394427">:=</span>&nbsp;<span class="ident" id="3394430">w</span><span class="op" id="3394431">.</span><span class="op" id="3394432">(</span><span class="ident" id="3394433">writeStringer</span><span class="op" id="3394446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3394449">if</span>&nbsp;<span class="op" id="3394452">!</span><span class="ident" id="3394453">ok</span>&nbsp;<span class="op" id="3394456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3394460">ws</span>&nbsp;<span class="op" id="3394463">=</span>&nbsp;<span class="ident" id="3394465">stringWriter</span><span class="op" id="3394477">{</span><span class="ident" id="3394478">w</span><span class="op" id="3394479">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3394482">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3394485">kvs</span><span class="op" id="3394488">,</span>&nbsp;<span class="ident" id="3394490">sorter</span>&nbsp;<span class="op" id="3394497">:=</span>&nbsp;<span class="ident" id="3394500">h</span><span class="op" id="3394501">.</span><span class="ident" id="3394502">sortedKeyValues</span><span class="op" id="3394517">(</span><span class="ident" id="3394518">exclude</span><span class="op" id="3394525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3394528">for</span>&nbsp;<span class="ident" id="3394532">_</span><span class="op" id="3394533">,</span>&nbsp;<span class="ident" id="3394535">kv</span>&nbsp;<span class="op" id="3394538">:=</span>&nbsp;<span class="keyword" id="3394541">range</span>&nbsp;<span class="ident" id="3394547">kvs</span>&nbsp;<span class="op" id="3394551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3394555">for</span>&nbsp;<span class="ident" id="3394559">_</span><span class="op" id="3394560">,</span>&nbsp;<span class="ident" id="3394562">v</span>&nbsp;<span class="op" id="3394564">:=</span>&nbsp;<span class="keyword" id="3394567">range</span>&nbsp;<span class="ident" id="3394573">kv</span><span class="op" id="3394575">.</span><span class="ident" id="3394576">values</span>&nbsp;<span class="op" id="3394583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3394588">v</span>&nbsp;<span class="op" id="3394590">=</span>&nbsp;<span class="ident" id="3394592">headerNewlineToSpace</span><span class="op" id="3394612">.</span><span class="ident" id="3394613">Replace</span><span class="op" id="3394620">(</span><span class="ident" id="3394621">v</span><span class="op" id="3394622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3394627">v</span>&nbsp;<span class="op" id="3394629">=</span>&nbsp;<span class="ident" id="3394631">textproto</span><span class="op" id="3394640">.</span><span class="ident" id="3394641">TrimString</span><span class="op" id="3394651">(</span><span class="ident" id="3394652">v</span><span class="op" id="3394653">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3394658">for</span>&nbsp;<span class="ident" id="3394662">_</span><span class="op" id="3394663">,</span>&nbsp;<span class="ident" id="3394665">s</span>&nbsp;<span class="op" id="3394667">:=</span>&nbsp;<span class="keyword" id="3394670">range</span>&nbsp;<span class="op" id="3394676">[</span><span class="op" id="3394677">]</span><span class="builtintype" id="3394678">string</span><span class="op" id="3394684">{</span><span class="ident" id="3394685">kv</span><span class="op" id="3394687">.</span><span class="ident" id="3394688">key</span><span class="op" id="3394691">,</span>&nbsp;<span class="string" id="3394693">&#34;:&nbsp;&#34;</span><span class="op" id="3394697">,</span>&nbsp;<span class="ident" id="3394699">v</span><span class="op" id="3394700">,</span>&nbsp;<span class="string" id="3394702">&#34;\r\n&#34;</span><span class="op" id="3394708">}</span>&nbsp;<span class="op" id="3394710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3394716">if</span>&nbsp;<span class="ident" id="3394719">_</span><span class="op" id="3394720">,</span>&nbsp;<span class="ident" id="3394722">err</span>&nbsp;<span class="op" id="3394726">:=</span>&nbsp;<span class="ident" id="3394729">ws</span><span class="op" id="3394731">.</span><span class="ident" id="3394732">WriteString</span><span class="op" id="3394743">(</span><span class="ident" id="3394744">s</span><span class="op" id="3394745">)</span><span class="op" id="3394746">;</span>&nbsp;<span class="ident" id="3394748">err</span>&nbsp;<span class="op" id="3394752">!=</span>&nbsp;<span class="ident" id="3394755">nil</span>&nbsp;<span class="op" id="3394759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3394766">return</span>&nbsp;<span class="ident" id="3394773">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3394781">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3394786">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3394790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3394793">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3394796">headerSorterPool</span><span class="op" id="3394812">.</span><span class="ident" id="3394813">Put</span><span class="op" id="3394816">(</span><span class="ident" id="3394817">sorter</span><span class="op" id="3394823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3394826">return</span>&nbsp;<span class="ident" id="3394833">nil</span><br>
<span class="lineno"></span><span class="op" id="3394837">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="3394840">//&nbsp;CanonicalHeaderKey&nbsp;returns&nbsp;the&nbsp;canonical&nbsp;format&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3394898">//&nbsp;header&nbsp;key&nbsp;s.&nbsp;&nbsp;The&nbsp;canonicalization&nbsp;converts&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="3394956">//&nbsp;letter&nbsp;and&nbsp;any&nbsp;letter&nbsp;following&nbsp;a&nbsp;hyphen&nbsp;to&nbsp;upper&nbsp;case;</span><br>
<span class="lineno"></span><span class="comment" id="3395015">//&nbsp;the&nbsp;rest&nbsp;are&nbsp;converted&nbsp;to&nbsp;lowercase.&nbsp;&nbsp;For&nbsp;example,&nbsp;the</span><br>
<span class="lineno">170</span><span class="comment" id="3395073">//&nbsp;canonical&nbsp;key&nbsp;for&nbsp;&#34;accept-encoding&#34;&nbsp;is&nbsp;&#34;Accept-Encoding&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="3395134">func</span>&nbsp;<span class="ident" id="3395139">CanonicalHeaderKey</span><span class="op" id="3395157">(</span><span class="ident" id="3395158">s</span>&nbsp;<span class="builtintype" id="3395160">string</span><span class="op" id="3395166">)</span>&nbsp;<span class="builtintype" id="3395168">string</span>&nbsp;<span class="op" id="3395175">{</span>&nbsp;<span class="keyword" id="3395177">return</span>&nbsp;<span class="ident" id="3395184">textproto</span><span class="op" id="3395193">.</span><span class="ident" id="3395194">CanonicalMIMEHeaderKey</span><span class="op" id="3395216">(</span><span class="ident" id="3395217">s</span><span class="op" id="3395218">)</span>&nbsp;<span class="op" id="3395220">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3395223">//&nbsp;hasToken&nbsp;reports&nbsp;whether&nbsp;token&nbsp;appears&nbsp;with&nbsp;v,&nbsp;ASCII</span><br>
<span class="lineno"></span><span class="comment" id="3395279">//&nbsp;case-insensitive,&nbsp;with&nbsp;space&nbsp;or&nbsp;comma&nbsp;boundaries.</span><br>
<span class="lineno">175</span><span class="comment" id="3395332">//&nbsp;token&nbsp;must&nbsp;be&nbsp;all&nbsp;lowercase.</span><br>
<span class="lineno"></span><span class="comment" id="3395364">//&nbsp;v&nbsp;may&nbsp;contain&nbsp;mixed&nbsp;cased.</span><br>
<span class="lineno"></span><span class="keyword" id="3395394">func</span>&nbsp;<span class="ident" id="3395399">hasToken</span><span class="op" id="3395407">(</span><span class="ident" id="3395408">v</span><span class="op" id="3395409">,</span>&nbsp;<span class="ident" id="3395411">token</span>&nbsp;<span class="builtintype" id="3395417">string</span><span class="op" id="3395423">)</span>&nbsp;<span class="builtintype" id="3395425">bool</span>&nbsp;<span class="op" id="3395430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3395433">if</span>&nbsp;<span class="builtinfunc" id="3395436">len</span><span class="op" id="3395439">(</span><span class="ident" id="3395440">token</span><span class="op" id="3395445">)</span>&nbsp;<span class="op" id="3395447">&gt;</span>&nbsp;<span class="builtinfunc" id="3395449">len</span><span class="op" id="3395452">(</span><span class="ident" id="3395453">v</span><span class="op" id="3395454">)</span>&nbsp;<span class="op" id="3395456">||</span>&nbsp;<span class="ident" id="3395459">token</span>&nbsp;<span class="op" id="3395465">==</span>&nbsp;<span class="string" id="3395468">&#34;&#34;</span>&nbsp;<span class="op" id="3395471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3395475">return</span>&nbsp;<span class="builtintype" id="3395482">false</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3395489">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3395492">if</span>&nbsp;<span class="ident" id="3395495">v</span>&nbsp;<span class="op" id="3395497">==</span>&nbsp;<span class="ident" id="3395500">token</span>&nbsp;<span class="op" id="3395506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3395510">return</span>&nbsp;<span class="builtintype" id="3395517">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3395523">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3395526">for</span>&nbsp;<span class="ident" id="3395530">sp</span>&nbsp;<span class="op" id="3395533">:=</span>&nbsp;<span class="num" id="3395536">0</span><span class="op" id="3395537">;</span>&nbsp;<span class="ident" id="3395539">sp</span>&nbsp;<span class="op" id="3395542">&lt;=</span>&nbsp;<span class="builtinfunc" id="3395545">len</span><span class="op" id="3395548">(</span><span class="ident" id="3395549">v</span><span class="op" id="3395550">)</span><span class="op" id="3395551">-</span><span class="builtinfunc" id="3395552">len</span><span class="op" id="3395555">(</span><span class="ident" id="3395556">token</span><span class="op" id="3395561">)</span><span class="op" id="3395562">;</span>&nbsp;<span class="ident" id="3395564">sp</span><span class="op" id="3395566">++</span>&nbsp;<span class="op" id="3395569">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3395573">//&nbsp;Check&nbsp;that&nbsp;first&nbsp;character&nbsp;is&nbsp;good.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3395614">//&nbsp;The&nbsp;token&nbsp;is&nbsp;ASCII,&nbsp;so&nbsp;checking&nbsp;only&nbsp;a&nbsp;single&nbsp;byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3395670">//&nbsp;is&nbsp;sufficient.&nbsp;&nbsp;We&nbsp;skip&nbsp;this&nbsp;potential&nbsp;starting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3395723">//&nbsp;position&nbsp;if&nbsp;both&nbsp;the&nbsp;first&nbsp;byte&nbsp;and&nbsp;its&nbsp;potential</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3395778">//&nbsp;ASCII&nbsp;uppercase&nbsp;equivalent&nbsp;(b|0x20)&nbsp;don&#39;t&nbsp;match.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3395832">//&nbsp;False&nbsp;positives&nbsp;(&#39;^&#39;&nbsp;=&gt;&nbsp;&#39;~&#39;)&nbsp;are&nbsp;caught&nbsp;by&nbsp;EqualFold.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3395891">if</span>&nbsp;<span class="ident" id="3395894">b</span>&nbsp;<span class="op" id="3395896">:=</span>&nbsp;<span class="ident" id="3395899">v</span><span class="op" id="3395900">[</span><span class="ident" id="3395901">sp</span><span class="op" id="3395903">]</span><span class="op" id="3395904">;</span>&nbsp;<span class="ident" id="3395906">b</span>&nbsp;<span class="op" id="3395908">!=</span>&nbsp;<span class="ident" id="3395911">token</span><span class="op" id="3395916">[</span><span class="num" id="3395917">0</span><span class="op" id="3395918">]</span>&nbsp;<span class="op" id="3395920">&amp;&amp;</span>&nbsp;<span class="ident" id="3395923">b</span><span class="op" id="3395924">|</span><span class="num" id="3395925">0x20</span>&nbsp;<span class="op" id="3395930">!=</span>&nbsp;<span class="ident" id="3395933">token</span><span class="op" id="3395938">[</span><span class="num" id="3395939">0</span><span class="op" id="3395940">]</span>&nbsp;<span class="op" id="3395942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3395947">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3395958">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3395962">//&nbsp;Check&nbsp;that&nbsp;start&nbsp;pos&nbsp;is&nbsp;on&nbsp;a&nbsp;valid&nbsp;token&nbsp;boundary.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3396018">if</span>&nbsp;<span class="ident" id="3396021">sp</span>&nbsp;<span class="op" id="3396024">&gt;</span>&nbsp;<span class="num" id="3396026">0</span>&nbsp;<span class="op" id="3396028">&amp;&amp;</span>&nbsp;<span class="op" id="3396031">!</span><span class="ident" id="3396032">isTokenBoundary</span><span class="op" id="3396047">(</span><span class="ident" id="3396048">v</span><span class="op" id="3396049">[</span><span class="ident" id="3396050">sp</span><span class="op" id="3396052">-</span><span class="num" id="3396053">1</span><span class="op" id="3396054">]</span><span class="op" id="3396055">)</span>&nbsp;<span class="op" id="3396057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3396062">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3396073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3396077">//&nbsp;Check&nbsp;that&nbsp;end&nbsp;pos&nbsp;is&nbsp;on&nbsp;a&nbsp;valid&nbsp;token&nbsp;boundary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3396131">if</span>&nbsp;<span class="ident" id="3396134">endPos</span>&nbsp;<span class="op" id="3396141">:=</span>&nbsp;<span class="ident" id="3396144">sp</span>&nbsp;<span class="op" id="3396147">+</span>&nbsp;<span class="builtinfunc" id="3396149">len</span><span class="op" id="3396152">(</span><span class="ident" id="3396153">token</span><span class="op" id="3396158">)</span><span class="op" id="3396159">;</span>&nbsp;<span class="ident" id="3396161">endPos</span>&nbsp;<span class="op" id="3396168">!=</span>&nbsp;<span class="builtinfunc" id="3396171">len</span><span class="op" id="3396174">(</span><span class="ident" id="3396175">v</span><span class="op" id="3396176">)</span>&nbsp;<span class="op" id="3396178">&amp;&amp;</span>&nbsp;<span class="op" id="3396181">!</span><span class="ident" id="3396182">isTokenBoundary</span><span class="op" id="3396197">(</span><span class="ident" id="3396198">v</span><span class="op" id="3396199">[</span><span class="ident" id="3396200">endPos</span><span class="op" id="3396206">]</span><span class="op" id="3396207">)</span>&nbsp;<span class="op" id="3396209">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3396214">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3396225">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3396229">if</span>&nbsp;<span class="ident" id="3396232">strings</span><span class="op" id="3396239">.</span><span class="ident" id="3396240">EqualFold</span><span class="op" id="3396249">(</span><span class="ident" id="3396250">v</span><span class="op" id="3396251">[</span><span class="ident" id="3396252">sp</span><span class="op" id="3396254">:</span><span class="ident" id="3396255">sp</span><span class="op" id="3396257">+</span><span class="builtinfunc" id="3396258">len</span><span class="op" id="3396261">(</span><span class="ident" id="3396262">token</span><span class="op" id="3396267">)</span><span class="op" id="3396268">]</span><span class="op" id="3396269">,</span>&nbsp;<span class="ident" id="3396271">token</span><span class="op" id="3396276">)</span>&nbsp;<span class="op" id="3396278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3396283">return</span>&nbsp;<span class="builtintype" id="3396290">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3396297">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3396300">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3396303">return</span>&nbsp;<span class="builtintype" id="3396310">false</span><br>
<span class="lineno"></span><span class="op" id="3396316">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3396319">func</span>&nbsp;<span class="ident" id="3396324">isTokenBoundary</span><span class="op" id="3396339">(</span><span class="ident" id="3396340">b</span>&nbsp;<span class="builtintype" id="3396342">byte</span><span class="op" id="3396346">)</span>&nbsp;<span class="builtintype" id="3396348">bool</span>&nbsp;<span class="op" id="3396353">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3396356">return</span>&nbsp;<span class="ident" id="3396363">b</span>&nbsp;<span class="op" id="3396365">==</span>&nbsp;<span class="string" id="3396368">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="3396372">||</span>&nbsp;<span class="ident" id="3396375">b</span>&nbsp;<span class="op" id="3396377">==</span>&nbsp;<span class="string" id="3396380">&#39;,&#39;</span>&nbsp;<span class="op" id="3396384">||</span>&nbsp;<span class="ident" id="3396387">b</span>&nbsp;<span class="op" id="3396389">==</span>&nbsp;<span class="string" id="3396392">&#39;\t&#39;</span><br>
<span class="lineno"></span><span class="op" id="3396397">}</span>
</div>
</body>
</html>
