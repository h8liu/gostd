<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3449179">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3449234">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3449288">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3449339">package</span>&nbsp;<span class="ident" id="3449347">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3449352">import</span>&nbsp;<span class="op" id="3449359">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3449362">&#34;crypto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3449372">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3449388">&#34;crypto/elliptic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3449407">&#34;crypto/md5&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3449421">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3449435">&#34;crypto/sha1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3449450">&#34;crypto/sha256&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3449467">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3449482">&#34;encoding/asn1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3449499">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3449509">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3449515">&#34;math/big&#34;</span><br>
<span class="lineno">20</span><span class="op" id="3449526">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3449529">var</span>&nbsp;<span class="ident" id="3449533">errClientKeyExchange</span>&nbsp;<span class="op" id="3449554">=</span>&nbsp;<span class="ident" id="3449556">errors</span><span class="op" id="3449562">.</span><span class="ident" id="3449563">New</span><span class="op" id="3449566">(</span><span class="string" id="3449567">&#34;tls:&nbsp;invalid&nbsp;ClientKeyExchange&nbsp;message&#34;</span><span class="op" id="3449607">)</span><br>
<span class="lineno"></span><span class="keyword" id="3449609">var</span>&nbsp;<span class="ident" id="3449613">errServerKeyExchange</span>&nbsp;<span class="op" id="3449634">=</span>&nbsp;<span class="ident" id="3449636">errors</span><span class="op" id="3449642">.</span><span class="ident" id="3449643">New</span><span class="op" id="3449646">(</span><span class="string" id="3449647">&#34;tls:&nbsp;invalid&nbsp;ServerKeyExchange&nbsp;message&#34;</span><span class="op" id="3449687">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="3449690">//&nbsp;rsaKeyAgreement&nbsp;implements&nbsp;the&nbsp;standard&nbsp;TLS&nbsp;key&nbsp;agreement&nbsp;where&nbsp;the&nbsp;client</span><br>
<span class="lineno"></span><span class="comment" id="3449768">//&nbsp;encrypts&nbsp;the&nbsp;pre-master&nbsp;secret&nbsp;to&nbsp;the&nbsp;server&#39;s&nbsp;public&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="3449830">type</span>&nbsp;<span class="ident" id="3449835">rsaKeyAgreement</span>&nbsp;<span class="keyword" id="3449851">struct</span><span class="op" id="3449857">{</span><span class="op" id="3449858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3449861">func</span>&nbsp;<span class="op" id="3449866">(</span><span class="ident" id="3449867">ka</span>&nbsp;<span class="ident" id="3449870">rsaKeyAgreement</span><span class="op" id="3449885">)</span>&nbsp;<span class="ident" id="3449887">generateServerKeyExchange</span><span class="op" id="3449912">(</span><span class="ident" id="3449913">config</span>&nbsp;<span class="op" id="3449920">*</span><span class="ident" id="3449921">Config</span><span class="op" id="3449927">,</span>&nbsp;<span class="ident" id="3449929">cert</span>&nbsp;<span class="op" id="3449934">*</span><span class="ident" id="3449935">Certificate</span><span class="op" id="3449946">,</span>&nbsp;<span class="ident" id="3449948">clientHello</span>&nbsp;<span class="op" id="3449960">*</span><span class="ident" id="3449961">clientHelloMsg</span><span class="op" id="3449975">,</span>&nbsp;<span class="ident" id="3449977">hello</span>&nbsp;<span class="op" id="3449983">*</span><span class="ident" id="3449984">serverHelloMsg</span><span class="op" id="3449998">)</span>&nbsp;<span class="op" id="3450000">(</span><span class="op" id="3450001">*</span><span class="ident" id="3450002">serverKeyExchangeMsg</span><span class="op" id="3450022">,</span>&nbsp;<span class="builtintype" id="3450024">error</span><span class="op" id="3450029">)</span>&nbsp;<span class="op" id="3450031">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3450034">return</span>&nbsp;<span class="ident" id="3450041">nil</span><span class="op" id="3450044">,</span>&nbsp;<span class="ident" id="3450046">nil</span><br>
<span class="lineno"></span><span class="op" id="3450050">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3450053">func</span>&nbsp;<span class="op" id="3450058">(</span><span class="ident" id="3450059">ka</span>&nbsp;<span class="ident" id="3450062">rsaKeyAgreement</span><span class="op" id="3450077">)</span>&nbsp;<span class="ident" id="3450079">processClientKeyExchange</span><span class="op" id="3450103">(</span><span class="ident" id="3450104">config</span>&nbsp;<span class="op" id="3450111">*</span><span class="ident" id="3450112">Config</span><span class="op" id="3450118">,</span>&nbsp;<span class="ident" id="3450120">cert</span>&nbsp;<span class="op" id="3450125">*</span><span class="ident" id="3450126">Certificate</span><span class="op" id="3450137">,</span>&nbsp;<span class="ident" id="3450139">ckx</span>&nbsp;<span class="op" id="3450143">*</span><span class="ident" id="3450144">clientKeyExchangeMsg</span><span class="op" id="3450164">,</span>&nbsp;<span class="ident" id="3450166">version</span>&nbsp;<span class="builtintype" id="3450174">uint16</span><span class="op" id="3450180">)</span>&nbsp;<span class="op" id="3450182">(</span><span class="op" id="3450183">[</span><span class="op" id="3450184">]</span><span class="builtintype" id="3450185">byte</span><span class="op" id="3450189">,</span>&nbsp;<span class="builtintype" id="3450191">error</span><span class="op" id="3450196">)</span>&nbsp;<span class="op" id="3450198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3450201">preMasterSecret</span>&nbsp;<span class="op" id="3450217">:=</span>&nbsp;<span class="builtinfunc" id="3450220">make</span><span class="op" id="3450224">(</span><span class="op" id="3450225">[</span><span class="op" id="3450226">]</span><span class="builtintype" id="3450227">byte</span><span class="op" id="3450231">,</span>&nbsp;<span class="num" id="3450233">48</span><span class="op" id="3450235">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3450238">_</span><span class="op" id="3450239">,</span>&nbsp;<span class="ident" id="3450241">err</span>&nbsp;<span class="op" id="3450245">:=</span>&nbsp;<span class="ident" id="3450248">io</span><span class="op" id="3450250">.</span><span class="ident" id="3450251">ReadFull</span><span class="op" id="3450259">(</span><span class="ident" id="3450260">config</span><span class="op" id="3450266">.</span><span class="ident" id="3450267">rand</span><span class="op" id="3450271">(</span><span class="op" id="3450272">)</span><span class="op" id="3450273">,</span>&nbsp;<span class="ident" id="3450275">preMasterSecret</span><span class="op" id="3450290">[</span><span class="num" id="3450291">2</span><span class="op" id="3450292">:</span><span class="op" id="3450293">]</span><span class="op" id="3450294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3450297">if</span>&nbsp;<span class="ident" id="3450300">err</span>&nbsp;<span class="op" id="3450304">!=</span>&nbsp;<span class="ident" id="3450307">nil</span>&nbsp;<span class="op" id="3450311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3450315">return</span>&nbsp;<span class="ident" id="3450322">nil</span><span class="op" id="3450325">,</span>&nbsp;<span class="ident" id="3450327">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3450332">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3450336">if</span>&nbsp;<span class="builtinfunc" id="3450339">len</span><span class="op" id="3450342">(</span><span class="ident" id="3450343">ckx</span><span class="op" id="3450346">.</span><span class="ident" id="3450347">ciphertext</span><span class="op" id="3450357">)</span>&nbsp;<span class="op" id="3450359">&lt;</span>&nbsp;<span class="num" id="3450361">2</span>&nbsp;<span class="op" id="3450363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3450367">return</span>&nbsp;<span class="ident" id="3450374">nil</span><span class="op" id="3450377">,</span>&nbsp;<span class="ident" id="3450379">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3450401">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3450405">ciphertext</span>&nbsp;<span class="op" id="3450416">:=</span>&nbsp;<span class="ident" id="3450419">ckx</span><span class="op" id="3450422">.</span><span class="ident" id="3450423">ciphertext</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3450435">if</span>&nbsp;<span class="ident" id="3450438">version</span>&nbsp;<span class="op" id="3450446">!=</span>&nbsp;<span class="ident" id="3450449">VersionSSL30</span>&nbsp;<span class="op" id="3450462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3450466">ciphertextLen</span>&nbsp;<span class="op" id="3450480">:=</span>&nbsp;<span class="builtintype" id="3450483">int</span><span class="op" id="3450486">(</span><span class="ident" id="3450487">ckx</span><span class="op" id="3450490">.</span><span class="ident" id="3450491">ciphertext</span><span class="op" id="3450501">[</span><span class="num" id="3450502">0</span><span class="op" id="3450503">]</span><span class="op" id="3450504">)</span><span class="op" id="3450505">&lt;&lt;</span><span class="num" id="3450507">8</span>&nbsp;<span class="op" id="3450509">|</span>&nbsp;<span class="builtintype" id="3450511">int</span><span class="op" id="3450514">(</span><span class="ident" id="3450515">ckx</span><span class="op" id="3450518">.</span><span class="ident" id="3450519">ciphertext</span><span class="op" id="3450529">[</span><span class="num" id="3450530">1</span><span class="op" id="3450531">]</span><span class="op" id="3450532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3450536">if</span>&nbsp;<span class="ident" id="3450539">ciphertextLen</span>&nbsp;<span class="op" id="3450553">!=</span>&nbsp;<span class="builtinfunc" id="3450556">len</span><span class="op" id="3450559">(</span><span class="ident" id="3450560">ckx</span><span class="op" id="3450563">.</span><span class="ident" id="3450564">ciphertext</span><span class="op" id="3450574">)</span><span class="op" id="3450575">-</span><span class="num" id="3450576">2</span>&nbsp;<span class="op" id="3450578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3450583">return</span>&nbsp;<span class="ident" id="3450590">nil</span><span class="op" id="3450593">,</span>&nbsp;<span class="ident" id="3450595">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3450618">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3450622">ciphertext</span>&nbsp;<span class="op" id="3450633">=</span>&nbsp;<span class="ident" id="3450635">ckx</span><span class="op" id="3450638">.</span><span class="ident" id="3450639">ciphertext</span><span class="op" id="3450649">[</span><span class="num" id="3450650">2</span><span class="op" id="3450651">:</span><span class="op" id="3450652">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3450655">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3450659">err</span>&nbsp;<span class="op" id="3450663">=</span>&nbsp;<span class="ident" id="3450665">rsa</span><span class="op" id="3450668">.</span><span class="ident" id="3450669">DecryptPKCS1v15SessionKey</span><span class="op" id="3450694">(</span><span class="ident" id="3450695">config</span><span class="op" id="3450701">.</span><span class="ident" id="3450702">rand</span><span class="op" id="3450706">(</span><span class="op" id="3450707">)</span><span class="op" id="3450708">,</span>&nbsp;<span class="ident" id="3450710">cert</span><span class="op" id="3450714">.</span><span class="ident" id="3450715">PrivateKey</span><span class="op" id="3450725">.</span><span class="op" id="3450726">(</span><span class="op" id="3450727">*</span><span class="ident" id="3450728">rsa</span><span class="op" id="3450731">.</span><span class="ident" id="3450732">PrivateKey</span><span class="op" id="3450742">)</span><span class="op" id="3450743">,</span>&nbsp;<span class="ident" id="3450745">ciphertext</span><span class="op" id="3450755">,</span>&nbsp;<span class="ident" id="3450757">preMasterSecret</span><span class="op" id="3450772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3450775">if</span>&nbsp;<span class="ident" id="3450778">err</span>&nbsp;<span class="op" id="3450782">!=</span>&nbsp;<span class="ident" id="3450785">nil</span>&nbsp;<span class="op" id="3450789">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3450793">return</span>&nbsp;<span class="ident" id="3450800">nil</span><span class="op" id="3450803">,</span>&nbsp;<span class="ident" id="3450805">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3450810">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3450813">//&nbsp;We&nbsp;don&#39;t&nbsp;check&nbsp;the&nbsp;version&nbsp;number&nbsp;in&nbsp;the&nbsp;premaster&nbsp;secret.&nbsp;&nbsp;For&nbsp;one,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3450886">//&nbsp;by&nbsp;checking&nbsp;it,&nbsp;we&nbsp;would&nbsp;leak&nbsp;information&nbsp;about&nbsp;the&nbsp;validity&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3450958">//&nbsp;encrypted&nbsp;pre-master&nbsp;secret.&nbsp;Secondly,&nbsp;it&nbsp;provides&nbsp;only&nbsp;a&nbsp;small</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3451026">//&nbsp;benefit&nbsp;against&nbsp;a&nbsp;downgrade&nbsp;attack&nbsp;and&nbsp;some&nbsp;implementations&nbsp;send&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3451099">//&nbsp;wrong&nbsp;version&nbsp;anyway.&nbsp;See&nbsp;the&nbsp;discussion&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;section</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3451166">//&nbsp;7.4.7.1&nbsp;of&nbsp;RFC&nbsp;4346.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451191">return</span>&nbsp;<span class="ident" id="3451198">preMasterSecret</span><span class="op" id="3451213">,</span>&nbsp;<span class="ident" id="3451215">nil</span><br>
<span class="lineno"></span><span class="op" id="3451219">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="keyword" id="3451222">func</span>&nbsp;<span class="op" id="3451227">(</span><span class="ident" id="3451228">ka</span>&nbsp;<span class="ident" id="3451231">rsaKeyAgreement</span><span class="op" id="3451246">)</span>&nbsp;<span class="ident" id="3451248">processServerKeyExchange</span><span class="op" id="3451272">(</span><span class="ident" id="3451273">config</span>&nbsp;<span class="op" id="3451280">*</span><span class="ident" id="3451281">Config</span><span class="op" id="3451287">,</span>&nbsp;<span class="ident" id="3451289">clientHello</span>&nbsp;<span class="op" id="3451301">*</span><span class="ident" id="3451302">clientHelloMsg</span><span class="op" id="3451316">,</span>&nbsp;<span class="ident" id="3451318">serverHello</span>&nbsp;<span class="op" id="3451330">*</span><span class="ident" id="3451331">serverHelloMsg</span><span class="op" id="3451345">,</span>&nbsp;<span class="ident" id="3451347">cert</span>&nbsp;<span class="op" id="3451352">*</span><span class="ident" id="3451353">x509</span><span class="op" id="3451357">.</span><span class="ident" id="3451358">Certificate</span><span class="op" id="3451369">,</span>&nbsp;<span class="ident" id="3451371">skx</span>&nbsp;<span class="op" id="3451375">*</span><span class="ident" id="3451376">serverKeyExchangeMsg</span><span class="op" id="3451396">)</span>&nbsp;<span class="builtintype" id="3451398">error</span>&nbsp;<span class="op" id="3451404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451407">return</span>&nbsp;<span class="ident" id="3451414">errors</span><span class="op" id="3451420">.</span><span class="ident" id="3451421">New</span><span class="op" id="3451424">(</span><span class="string" id="3451425">&#34;tls:&nbsp;unexpected&nbsp;ServerKeyExchange&#34;</span><span class="op" id="3451460">)</span><br>
<span class="lineno"></span><span class="op" id="3451462">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="keyword" id="3451465">func</span>&nbsp;<span class="op" id="3451470">(</span><span class="ident" id="3451471">ka</span>&nbsp;<span class="ident" id="3451474">rsaKeyAgreement</span><span class="op" id="3451489">)</span>&nbsp;<span class="ident" id="3451491">generateClientKeyExchange</span><span class="op" id="3451516">(</span><span class="ident" id="3451517">config</span>&nbsp;<span class="op" id="3451524">*</span><span class="ident" id="3451525">Config</span><span class="op" id="3451531">,</span>&nbsp;<span class="ident" id="3451533">clientHello</span>&nbsp;<span class="op" id="3451545">*</span><span class="ident" id="3451546">clientHelloMsg</span><span class="op" id="3451560">,</span>&nbsp;<span class="ident" id="3451562">cert</span>&nbsp;<span class="op" id="3451567">*</span><span class="ident" id="3451568">x509</span><span class="op" id="3451572">.</span><span class="ident" id="3451573">Certificate</span><span class="op" id="3451584">)</span>&nbsp;<span class="op" id="3451586">(</span><span class="op" id="3451587">[</span><span class="op" id="3451588">]</span><span class="builtintype" id="3451589">byte</span><span class="op" id="3451593">,</span>&nbsp;<span class="op" id="3451595">*</span><span class="ident" id="3451596">clientKeyExchangeMsg</span><span class="op" id="3451616">,</span>&nbsp;<span class="builtintype" id="3451618">error</span><span class="op" id="3451623">)</span>&nbsp;<span class="op" id="3451625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3451628">preMasterSecret</span>&nbsp;<span class="op" id="3451644">:=</span>&nbsp;<span class="builtinfunc" id="3451647">make</span><span class="op" id="3451651">(</span><span class="op" id="3451652">[</span><span class="op" id="3451653">]</span><span class="builtintype" id="3451654">byte</span><span class="op" id="3451658">,</span>&nbsp;<span class="num" id="3451660">48</span><span class="op" id="3451662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3451665">preMasterSecret</span><span class="op" id="3451680">[</span><span class="num" id="3451681">0</span><span class="op" id="3451682">]</span>&nbsp;<span class="op" id="3451684">=</span>&nbsp;<span class="builtintype" id="3451686">byte</span><span class="op" id="3451690">(</span><span class="ident" id="3451691">clientHello</span><span class="op" id="3451702">.</span><span class="ident" id="3451703">vers</span>&nbsp;<span class="op" id="3451708">&gt;&gt;</span>&nbsp;<span class="num" id="3451711">8</span><span class="op" id="3451712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3451715">preMasterSecret</span><span class="op" id="3451730">[</span><span class="num" id="3451731">1</span><span class="op" id="3451732">]</span>&nbsp;<span class="op" id="3451734">=</span>&nbsp;<span class="builtintype" id="3451736">byte</span><span class="op" id="3451740">(</span><span class="ident" id="3451741">clientHello</span><span class="op" id="3451752">.</span><span class="ident" id="3451753">vers</span><span class="op" id="3451757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3451760">_</span><span class="op" id="3451761">,</span>&nbsp;<span class="ident" id="3451763">err</span>&nbsp;<span class="op" id="3451767">:=</span>&nbsp;<span class="ident" id="3451770">io</span><span class="op" id="3451772">.</span><span class="ident" id="3451773">ReadFull</span><span class="op" id="3451781">(</span><span class="ident" id="3451782">config</span><span class="op" id="3451788">.</span><span class="ident" id="3451789">rand</span><span class="op" id="3451793">(</span><span class="op" id="3451794">)</span><span class="op" id="3451795">,</span>&nbsp;<span class="ident" id="3451797">preMasterSecret</span><span class="op" id="3451812">[</span><span class="num" id="3451813">2</span><span class="op" id="3451814">:</span><span class="op" id="3451815">]</span><span class="op" id="3451816">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451819">if</span>&nbsp;<span class="ident" id="3451822">err</span>&nbsp;<span class="op" id="3451826">!=</span>&nbsp;<span class="ident" id="3451829">nil</span>&nbsp;<span class="op" id="3451833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451837">return</span>&nbsp;<span class="ident" id="3451844">nil</span><span class="op" id="3451847">,</span>&nbsp;<span class="ident" id="3451849">nil</span><span class="op" id="3451852">,</span>&nbsp;<span class="ident" id="3451854">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3451859">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3451863">encrypted</span><span class="op" id="3451872">,</span>&nbsp;<span class="ident" id="3451874">err</span>&nbsp;<span class="op" id="3451878">:=</span>&nbsp;<span class="ident" id="3451881">rsa</span><span class="op" id="3451884">.</span><span class="ident" id="3451885">EncryptPKCS1v15</span><span class="op" id="3451900">(</span><span class="ident" id="3451901">config</span><span class="op" id="3451907">.</span><span class="ident" id="3451908">rand</span><span class="op" id="3451912">(</span><span class="op" id="3451913">)</span><span class="op" id="3451914">,</span>&nbsp;<span class="ident" id="3451916">cert</span><span class="op" id="3451920">.</span><span class="ident" id="3451921">PublicKey</span><span class="op" id="3451930">.</span><span class="op" id="3451931">(</span><span class="op" id="3451932">*</span><span class="ident" id="3451933">rsa</span><span class="op" id="3451936">.</span><span class="ident" id="3451937">PublicKey</span><span class="op" id="3451946">)</span><span class="op" id="3451947">,</span>&nbsp;<span class="ident" id="3451949">preMasterSecret</span><span class="op" id="3451964">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451967">if</span>&nbsp;<span class="ident" id="3451970">err</span>&nbsp;<span class="op" id="3451974">!=</span>&nbsp;<span class="ident" id="3451977">nil</span>&nbsp;<span class="op" id="3451981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451985">return</span>&nbsp;<span class="ident" id="3451992">nil</span><span class="op" id="3451995">,</span>&nbsp;<span class="ident" id="3451997">nil</span><span class="op" id="3452000">,</span>&nbsp;<span class="ident" id="3452002">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3452007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452010">ckx</span>&nbsp;<span class="op" id="3452014">:=</span>&nbsp;<span class="builtinfunc" id="3452017">new</span><span class="op" id="3452020">(</span><span class="ident" id="3452021">clientKeyExchangeMsg</span><span class="op" id="3452041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452044">ckx</span><span class="op" id="3452047">.</span><span class="ident" id="3452048">ciphertext</span>&nbsp;<span class="op" id="3452059">=</span>&nbsp;<span class="builtinfunc" id="3452061">make</span><span class="op" id="3452065">(</span><span class="op" id="3452066">[</span><span class="op" id="3452067">]</span><span class="builtintype" id="3452068">byte</span><span class="op" id="3452072">,</span>&nbsp;<span class="builtinfunc" id="3452074">len</span><span class="op" id="3452077">(</span><span class="ident" id="3452078">encrypted</span><span class="op" id="3452087">)</span><span class="op" id="3452088">+</span><span class="num" id="3452089">2</span><span class="op" id="3452090">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452093">ckx</span><span class="op" id="3452096">.</span><span class="ident" id="3452097">ciphertext</span><span class="op" id="3452107">[</span><span class="num" id="3452108">0</span><span class="op" id="3452109">]</span>&nbsp;<span class="op" id="3452111">=</span>&nbsp;<span class="builtintype" id="3452113">byte</span><span class="op" id="3452117">(</span><span class="builtinfunc" id="3452118">len</span><span class="op" id="3452121">(</span><span class="ident" id="3452122">encrypted</span><span class="op" id="3452131">)</span>&nbsp;<span class="op" id="3452133">&gt;&gt;</span>&nbsp;<span class="num" id="3452136">8</span><span class="op" id="3452137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452140">ckx</span><span class="op" id="3452143">.</span><span class="ident" id="3452144">ciphertext</span><span class="op" id="3452154">[</span><span class="num" id="3452155">1</span><span class="op" id="3452156">]</span>&nbsp;<span class="op" id="3452158">=</span>&nbsp;<span class="builtintype" id="3452160">byte</span><span class="op" id="3452164">(</span><span class="builtinfunc" id="3452165">len</span><span class="op" id="3452168">(</span><span class="ident" id="3452169">encrypted</span><span class="op" id="3452178">)</span><span class="op" id="3452179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3452182">copy</span><span class="op" id="3452186">(</span><span class="ident" id="3452187">ckx</span><span class="op" id="3452190">.</span><span class="ident" id="3452191">ciphertext</span><span class="op" id="3452201">[</span><span class="num" id="3452202">2</span><span class="op" id="3452203">:</span><span class="op" id="3452204">]</span><span class="op" id="3452205">,</span>&nbsp;<span class="ident" id="3452207">encrypted</span><span class="op" id="3452216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3452219">return</span>&nbsp;<span class="ident" id="3452226">preMasterSecret</span><span class="op" id="3452241">,</span>&nbsp;<span class="ident" id="3452243">ckx</span><span class="op" id="3452246">,</span>&nbsp;<span class="ident" id="3452248">nil</span><br>
<span class="lineno"></span><span class="op" id="3452252">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="3452255">//&nbsp;sha1Hash&nbsp;calculates&nbsp;a&nbsp;SHA1&nbsp;hash&nbsp;over&nbsp;the&nbsp;given&nbsp;byte&nbsp;slices.</span><br>
<span class="lineno"></span><span class="keyword" id="3452318">func</span>&nbsp;<span class="ident" id="3452323">sha1Hash</span><span class="op" id="3452331">(</span><span class="ident" id="3452332">slices</span>&nbsp;<span class="op" id="3452339">[</span><span class="op" id="3452340">]</span><span class="op" id="3452341">[</span><span class="op" id="3452342">]</span><span class="builtintype" id="3452343">byte</span><span class="op" id="3452347">)</span>&nbsp;<span class="op" id="3452349">[</span><span class="op" id="3452350">]</span><span class="builtintype" id="3452351">byte</span>&nbsp;<span class="op" id="3452356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452359">hsha1</span>&nbsp;<span class="op" id="3452365">:=</span>&nbsp;<span class="ident" id="3452368">sha1</span><span class="op" id="3452372">.</span><span class="ident" id="3452373">New</span><span class="op" id="3452376">(</span><span class="op" id="3452377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3452380">for</span>&nbsp;<span class="ident" id="3452384">_</span><span class="op" id="3452385">,</span>&nbsp;<span class="ident" id="3452387">slice</span>&nbsp;<span class="op" id="3452393">:=</span>&nbsp;<span class="keyword" id="3452396">range</span>&nbsp;<span class="ident" id="3452402">slices</span>&nbsp;<span class="op" id="3452409">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452413">hsha1</span><span class="op" id="3452418">.</span><span class="ident" id="3452419">Write</span><span class="op" id="3452424">(</span><span class="ident" id="3452425">slice</span><span class="op" id="3452430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3452433">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3452436">return</span>&nbsp;<span class="ident" id="3452443">hsha1</span><span class="op" id="3452448">.</span><span class="ident" id="3452449">Sum</span><span class="op" id="3452452">(</span><span class="ident" id="3452453">nil</span><span class="op" id="3452456">)</span><br>
<span class="lineno"></span><span class="op" id="3452458">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="comment" id="3452461">//&nbsp;md5SHA1Hash&nbsp;implements&nbsp;TLS&nbsp;1.0&#39;s&nbsp;hybrid&nbsp;hash&nbsp;function&nbsp;which&nbsp;consists&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3452540">//&nbsp;concatenation&nbsp;of&nbsp;an&nbsp;MD5&nbsp;and&nbsp;SHA1&nbsp;hash.</span><br>
<span class="lineno"></span><span class="keyword" id="3452582">func</span>&nbsp;<span class="ident" id="3452587">md5SHA1Hash</span><span class="op" id="3452598">(</span><span class="ident" id="3452599">slices</span>&nbsp;<span class="op" id="3452606">[</span><span class="op" id="3452607">]</span><span class="op" id="3452608">[</span><span class="op" id="3452609">]</span><span class="builtintype" id="3452610">byte</span><span class="op" id="3452614">)</span>&nbsp;<span class="op" id="3452616">[</span><span class="op" id="3452617">]</span><span class="builtintype" id="3452618">byte</span>&nbsp;<span class="op" id="3452623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452626">md5sha1</span>&nbsp;<span class="op" id="3452634">:=</span>&nbsp;<span class="builtinfunc" id="3452637">make</span><span class="op" id="3452641">(</span><span class="op" id="3452642">[</span><span class="op" id="3452643">]</span><span class="builtintype" id="3452644">byte</span><span class="op" id="3452648">,</span>&nbsp;<span class="ident" id="3452650">md5</span><span class="op" id="3452653">.</span><span class="ident" id="3452654">Size</span><span class="op" id="3452658">+</span><span class="ident" id="3452659">sha1</span><span class="op" id="3452663">.</span><span class="ident" id="3452664">Size</span><span class="op" id="3452668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452671">hmd5</span>&nbsp;<span class="op" id="3452676">:=</span>&nbsp;<span class="ident" id="3452679">md5</span><span class="op" id="3452682">.</span><span class="ident" id="3452683">New</span><span class="op" id="3452686">(</span><span class="op" id="3452687">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3452690">for</span>&nbsp;<span class="ident" id="3452694">_</span><span class="op" id="3452695">,</span>&nbsp;<span class="ident" id="3452697">slice</span>&nbsp;<span class="op" id="3452703">:=</span>&nbsp;<span class="keyword" id="3452706">range</span>&nbsp;<span class="ident" id="3452712">slices</span>&nbsp;<span class="op" id="3452719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452723">hmd5</span><span class="op" id="3452727">.</span><span class="ident" id="3452728">Write</span><span class="op" id="3452733">(</span><span class="ident" id="3452734">slice</span><span class="op" id="3452739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3452742">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3452745">copy</span><span class="op" id="3452749">(</span><span class="ident" id="3452750">md5sha1</span><span class="op" id="3452757">,</span>&nbsp;<span class="ident" id="3452759">hmd5</span><span class="op" id="3452763">.</span><span class="ident" id="3452764">Sum</span><span class="op" id="3452767">(</span><span class="ident" id="3452768">nil</span><span class="op" id="3452771">)</span><span class="op" id="3452772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3452775">copy</span><span class="op" id="3452779">(</span><span class="ident" id="3452780">md5sha1</span><span class="op" id="3452787">[</span><span class="ident" id="3452788">md5</span><span class="op" id="3452791">.</span><span class="ident" id="3452792">Size</span><span class="op" id="3452796">:</span><span class="op" id="3452797">]</span><span class="op" id="3452798">,</span>&nbsp;<span class="ident" id="3452800">sha1Hash</span><span class="op" id="3452808">(</span><span class="ident" id="3452809">slices</span><span class="op" id="3452815">)</span><span class="op" id="3452816">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3452819">return</span>&nbsp;<span class="ident" id="3452826">md5sha1</span><br>
<span class="lineno"></span><span class="op" id="3452834">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3452837">//&nbsp;sha256Hash&nbsp;implements&nbsp;TLS&nbsp;1.2&#39;s&nbsp;hash&nbsp;function.</span><br>
<span class="lineno"></span><span class="keyword" id="3452887">func</span>&nbsp;<span class="ident" id="3452892">sha256Hash</span><span class="op" id="3452902">(</span><span class="ident" id="3452903">slices</span>&nbsp;<span class="op" id="3452910">[</span><span class="op" id="3452911">]</span><span class="op" id="3452912">[</span><span class="op" id="3452913">]</span><span class="builtintype" id="3452914">byte</span><span class="op" id="3452918">)</span>&nbsp;<span class="op" id="3452920">[</span><span class="op" id="3452921">]</span><span class="builtintype" id="3452922">byte</span>&nbsp;<span class="op" id="3452927">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452930">h</span>&nbsp;<span class="op" id="3452932">:=</span>&nbsp;<span class="ident" id="3452935">sha256</span><span class="op" id="3452941">.</span><span class="ident" id="3452942">New</span><span class="op" id="3452945">(</span><span class="op" id="3452946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3452949">for</span>&nbsp;<span class="ident" id="3452953">_</span><span class="op" id="3452954">,</span>&nbsp;<span class="ident" id="3452956">slice</span>&nbsp;<span class="op" id="3452962">:=</span>&nbsp;<span class="keyword" id="3452965">range</span>&nbsp;<span class="ident" id="3452971">slices</span>&nbsp;<span class="op" id="3452978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452982">h</span><span class="op" id="3452983">.</span><span class="ident" id="3452984">Write</span><span class="op" id="3452989">(</span><span class="ident" id="3452990">slice</span><span class="op" id="3452995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3452998">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3453001">return</span>&nbsp;<span class="ident" id="3453008">h</span><span class="op" id="3453009">.</span><span class="ident" id="3453010">Sum</span><span class="op" id="3453013">(</span><span class="ident" id="3453014">nil</span><span class="op" id="3453017">)</span><br>
<span class="lineno">120</span><span class="op" id="3453019">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3453022">//&nbsp;hashForServerKeyExchange&nbsp;hashes&nbsp;the&nbsp;given&nbsp;slices&nbsp;and&nbsp;returns&nbsp;their&nbsp;digest</span><br>
<span class="lineno"></span><span class="comment" id="3453099">//&nbsp;and&nbsp;the&nbsp;identifier&nbsp;of&nbsp;the&nbsp;hash&nbsp;function&nbsp;used.&nbsp;The&nbsp;hashFunc&nbsp;argument&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="3453178">//&nbsp;used&nbsp;for&nbsp;&gt;=&nbsp;TLS&nbsp;1.2&nbsp;and&nbsp;precisely&nbsp;identifies&nbsp;the&nbsp;hash&nbsp;function&nbsp;to&nbsp;use.</span><br>
<span class="lineno">125</span><span class="keyword" id="3453252">func</span>&nbsp;<span class="ident" id="3453257">hashForServerKeyExchange</span><span class="op" id="3453281">(</span><span class="ident" id="3453282">sigType</span><span class="op" id="3453289">,</span>&nbsp;<span class="ident" id="3453291">hashFunc</span>&nbsp;<span class="builtintype" id="3453300">uint8</span><span class="op" id="3453305">,</span>&nbsp;<span class="ident" id="3453307">version</span>&nbsp;<span class="builtintype" id="3453315">uint16</span><span class="op" id="3453321">,</span>&nbsp;<span class="ident" id="3453323">slices</span>&nbsp;<span class="op" id="3453330">...</span><span class="op" id="3453333">[</span><span class="op" id="3453334">]</span><span class="builtintype" id="3453335">byte</span><span class="op" id="3453339">)</span>&nbsp;<span class="op" id="3453341">(</span><span class="op" id="3453342">[</span><span class="op" id="3453343">]</span><span class="builtintype" id="3453344">byte</span><span class="op" id="3453348">,</span>&nbsp;<span class="ident" id="3453350">crypto</span><span class="op" id="3453356">.</span><span class="ident" id="3453357">Hash</span><span class="op" id="3453361">,</span>&nbsp;<span class="builtintype" id="3453363">error</span><span class="op" id="3453368">)</span>&nbsp;<span class="op" id="3453370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3453373">if</span>&nbsp;<span class="ident" id="3453376">version</span>&nbsp;<span class="op" id="3453384">&gt;=</span>&nbsp;<span class="ident" id="3453387">VersionTLS12</span>&nbsp;<span class="op" id="3453400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3453404">switch</span>&nbsp;<span class="ident" id="3453411">hashFunc</span>&nbsp;<span class="op" id="3453420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3453424">case</span>&nbsp;<span class="ident" id="3453429">hashSHA256</span><span class="op" id="3453439">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3453444">return</span>&nbsp;<span class="ident" id="3453451">sha256Hash</span><span class="op" id="3453461">(</span><span class="ident" id="3453462">slices</span><span class="op" id="3453468">)</span><span class="op" id="3453469">,</span>&nbsp;<span class="ident" id="3453471">crypto</span><span class="op" id="3453477">.</span><span class="ident" id="3453478">SHA256</span><span class="op" id="3453484">,</span>&nbsp;<span class="ident" id="3453486">nil</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3453492">case</span>&nbsp;<span class="ident" id="3453497">hashSHA1</span><span class="op" id="3453505">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3453510">return</span>&nbsp;<span class="ident" id="3453517">sha1Hash</span><span class="op" id="3453525">(</span><span class="ident" id="3453526">slices</span><span class="op" id="3453532">)</span><span class="op" id="3453533">,</span>&nbsp;<span class="ident" id="3453535">crypto</span><span class="op" id="3453541">.</span><span class="ident" id="3453542">SHA1</span><span class="op" id="3453546">,</span>&nbsp;<span class="ident" id="3453548">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3453554">default</span><span class="op" id="3453561">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3453566">return</span>&nbsp;<span class="ident" id="3453573">nil</span><span class="op" id="3453576">,</span>&nbsp;<span class="ident" id="3453578">crypto</span><span class="op" id="3453584">.</span><span class="ident" id="3453585">Hash</span><span class="op" id="3453589">(</span><span class="num" id="3453590">0</span><span class="op" id="3453591">)</span><span class="op" id="3453592">,</span>&nbsp;<span class="ident" id="3453594">errors</span><span class="op" id="3453600">.</span><span class="ident" id="3453601">New</span><span class="op" id="3453604">(</span><span class="string" id="3453605">&#34;tls:&nbsp;unknown&nbsp;hash&nbsp;function&nbsp;used&nbsp;by&nbsp;peer&#34;</span><span class="op" id="3453646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3453650">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3453653">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3453656">if</span>&nbsp;<span class="ident" id="3453659">sigType</span>&nbsp;<span class="op" id="3453667">==</span>&nbsp;<span class="ident" id="3453670">signatureECDSA</span>&nbsp;<span class="op" id="3453685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3453689">return</span>&nbsp;<span class="ident" id="3453696">sha1Hash</span><span class="op" id="3453704">(</span><span class="ident" id="3453705">slices</span><span class="op" id="3453711">)</span><span class="op" id="3453712">,</span>&nbsp;<span class="ident" id="3453714">crypto</span><span class="op" id="3453720">.</span><span class="ident" id="3453721">SHA1</span><span class="op" id="3453725">,</span>&nbsp;<span class="ident" id="3453727">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3453732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3453735">return</span>&nbsp;<span class="ident" id="3453742">md5SHA1Hash</span><span class="op" id="3453753">(</span><span class="ident" id="3453754">slices</span><span class="op" id="3453760">)</span><span class="op" id="3453761">,</span>&nbsp;<span class="ident" id="3453763">crypto</span><span class="op" id="3453769">.</span><span class="ident" id="3453770">MD5SHA1</span><span class="op" id="3453777">,</span>&nbsp;<span class="ident" id="3453779">nil</span><br>
<span class="lineno">140</span><span class="op" id="3453783">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3453786">//&nbsp;pickTLS12HashForSignature&nbsp;returns&nbsp;a&nbsp;TLS&nbsp;1.2&nbsp;hash&nbsp;identifier&nbsp;for&nbsp;signing&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3453863">//&nbsp;ServerKeyExchange&nbsp;given&nbsp;the&nbsp;signature&nbsp;type&nbsp;being&nbsp;used&nbsp;and&nbsp;the&nbsp;client&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3453937">//&nbsp;advertised&nbsp;list&nbsp;of&nbsp;supported&nbsp;signature&nbsp;and&nbsp;hash&nbsp;combinations.</span><br>
<span class="lineno">145</span><span class="keyword" id="3454002">func</span>&nbsp;<span class="ident" id="3454007">pickTLS12HashForSignature</span><span class="op" id="3454032">(</span><span class="ident" id="3454033">sigType</span>&nbsp;<span class="builtintype" id="3454041">uint8</span><span class="op" id="3454046">,</span>&nbsp;<span class="ident" id="3454048">clientSignatureAndHashes</span>&nbsp;<span class="op" id="3454073">[</span><span class="op" id="3454074">]</span><span class="ident" id="3454075">signatureAndHash</span><span class="op" id="3454091">)</span>&nbsp;<span class="op" id="3454093">(</span><span class="builtintype" id="3454094">uint8</span><span class="op" id="3454099">,</span>&nbsp;<span class="builtintype" id="3454101">error</span><span class="op" id="3454106">)</span>&nbsp;<span class="op" id="3454108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454111">if</span>&nbsp;<span class="builtinfunc" id="3454114">len</span><span class="op" id="3454117">(</span><span class="ident" id="3454118">clientSignatureAndHashes</span><span class="op" id="3454142">)</span>&nbsp;<span class="op" id="3454144">==</span>&nbsp;<span class="num" id="3454147">0</span>&nbsp;<span class="op" id="3454149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3454153">//&nbsp;If&nbsp;the&nbsp;client&nbsp;didn&#39;t&nbsp;specify&nbsp;any&nbsp;signature_algorithms</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3454212">//&nbsp;extension&nbsp;then&nbsp;we&nbsp;can&nbsp;assume&nbsp;that&nbsp;it&nbsp;supports&nbsp;SHA1.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3454273">//&nbsp;http://tools.ietf.org/html/rfc5246#section-7.4.1.4.1</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454331">return</span>&nbsp;<span class="ident" id="3454338">hashSHA1</span><span class="op" id="3454346">,</span>&nbsp;<span class="ident" id="3454348">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3454353">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454357">for</span>&nbsp;<span class="ident" id="3454361">_</span><span class="op" id="3454362">,</span>&nbsp;<span class="ident" id="3454364">sigAndHash</span>&nbsp;<span class="op" id="3454375">:=</span>&nbsp;<span class="keyword" id="3454378">range</span>&nbsp;<span class="ident" id="3454384">clientSignatureAndHashes</span>&nbsp;<span class="op" id="3454409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454413">if</span>&nbsp;<span class="ident" id="3454416">sigAndHash</span><span class="op" id="3454426">.</span><span class="ident" id="3454427">signature</span>&nbsp;<span class="op" id="3454437">!=</span>&nbsp;<span class="ident" id="3454440">sigType</span>&nbsp;<span class="op" id="3454448">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454453">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3454464">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454468">switch</span>&nbsp;<span class="ident" id="3454475">sigAndHash</span><span class="op" id="3454485">.</span><span class="ident" id="3454486">hash</span>&nbsp;<span class="op" id="3454491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454495">case</span>&nbsp;<span class="ident" id="3454500">hashSHA1</span><span class="op" id="3454508">,</span>&nbsp;<span class="ident" id="3454510">hashSHA256</span><span class="op" id="3454520">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454525">return</span>&nbsp;<span class="ident" id="3454532">sigAndHash</span><span class="op" id="3454542">.</span><span class="ident" id="3454543">hash</span><span class="op" id="3454547">,</span>&nbsp;<span class="ident" id="3454549">nil</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3454555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3454558">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454562">return</span>&nbsp;<span class="num" id="3454569">0</span><span class="op" id="3454570">,</span>&nbsp;<span class="ident" id="3454572">errors</span><span class="op" id="3454578">.</span><span class="ident" id="3454579">New</span><span class="op" id="3454582">(</span><span class="string" id="3454583">&#34;tls:&nbsp;client&nbsp;doesn&#39;t&nbsp;support&nbsp;any&nbsp;common&nbsp;hash&nbsp;functions&#34;</span><span class="op" id="3454638">)</span><br>
<span class="lineno"></span><span class="op" id="3454640">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="keyword" id="3454643">func</span>&nbsp;<span class="ident" id="3454648">curveForCurveID</span><span class="op" id="3454663">(</span><span class="ident" id="3454664">id</span>&nbsp;<span class="ident" id="3454667">CurveID</span><span class="op" id="3454674">)</span>&nbsp;<span class="op" id="3454676">(</span><span class="ident" id="3454677">elliptic</span><span class="op" id="3454685">.</span><span class="ident" id="3454686">Curve</span><span class="op" id="3454691">,</span>&nbsp;<span class="builtintype" id="3454693">bool</span><span class="op" id="3454697">)</span>&nbsp;<span class="op" id="3454699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454702">switch</span>&nbsp;<span class="ident" id="3454709">id</span>&nbsp;<span class="op" id="3454712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454715">case</span>&nbsp;<span class="ident" id="3454720">CurveP256</span><span class="op" id="3454729">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454733">return</span>&nbsp;<span class="ident" id="3454740">elliptic</span><span class="op" id="3454748">.</span><span class="ident" id="3454749">P256</span><span class="op" id="3454753">(</span><span class="op" id="3454754">)</span><span class="op" id="3454755">,</span>&nbsp;<span class="builtintype" id="3454757">true</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454763">case</span>&nbsp;<span class="ident" id="3454768">CurveP384</span><span class="op" id="3454777">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454781">return</span>&nbsp;<span class="ident" id="3454788">elliptic</span><span class="op" id="3454796">.</span><span class="ident" id="3454797">P384</span><span class="op" id="3454801">(</span><span class="op" id="3454802">)</span><span class="op" id="3454803">,</span>&nbsp;<span class="builtintype" id="3454805">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454811">case</span>&nbsp;<span class="ident" id="3454816">CurveP521</span><span class="op" id="3454825">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454829">return</span>&nbsp;<span class="ident" id="3454836">elliptic</span><span class="op" id="3454844">.</span><span class="ident" id="3454845">P521</span><span class="op" id="3454849">(</span><span class="op" id="3454850">)</span><span class="op" id="3454851">,</span>&nbsp;<span class="builtintype" id="3454853">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454859">default</span><span class="op" id="3454866">:</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454870">return</span>&nbsp;<span class="ident" id="3454877">nil</span><span class="op" id="3454880">,</span>&nbsp;<span class="builtintype" id="3454882">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3454889">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="op" id="3454892">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="comment" id="3454895">//&nbsp;ecdheRSAKeyAgreement&nbsp;implements&nbsp;a&nbsp;TLS&nbsp;key&nbsp;agreement&nbsp;where&nbsp;the&nbsp;server</span><br>
<span class="lineno"></span><span class="comment" id="3454967">//&nbsp;generates&nbsp;a&nbsp;ephemeral&nbsp;EC&nbsp;public/private&nbsp;key&nbsp;pair&nbsp;and&nbsp;signs&nbsp;it.&nbsp;The</span><br>
<span class="lineno"></span><span class="comment" id="3455037">//&nbsp;pre-master&nbsp;secret&nbsp;is&nbsp;then&nbsp;calculated&nbsp;using&nbsp;ECDH.&nbsp;The&nbsp;signature&nbsp;may</span><br>
<span class="lineno"></span><span class="comment" id="3455107">//&nbsp;either&nbsp;be&nbsp;ECDSA&nbsp;or&nbsp;RSA.</span><br>
<span class="lineno"></span><span class="keyword" id="3455134">type</span>&nbsp;<span class="ident" id="3455139">ecdheKeyAgreement</span>&nbsp;<span class="keyword" id="3455157">struct</span>&nbsp;<span class="op" id="3455164">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3455167">version</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3455178">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3455186">sigType</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3455197">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3455204">privateKey</span>&nbsp;<span class="op" id="3455215">[</span><span class="op" id="3455216">]</span><span class="builtintype" id="3455217">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3455223">curve</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3455234">elliptic</span><span class="op" id="3455242">.</span><span class="ident" id="3455243">Curve</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3455250">x</span><span class="op" id="3455251">,</span>&nbsp;<span class="ident" id="3455253">y</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3455261">*</span><span class="ident" id="3455262">big</span><span class="op" id="3455265">.</span><span class="ident" id="3455266">Int</span><br>
<span class="lineno">190</span><span class="op" id="3455270">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3455273">func</span>&nbsp;<span class="op" id="3455278">(</span><span class="ident" id="3455279">ka</span>&nbsp;<span class="op" id="3455282">*</span><span class="ident" id="3455283">ecdheKeyAgreement</span><span class="op" id="3455300">)</span>&nbsp;<span class="ident" id="3455302">generateServerKeyExchange</span><span class="op" id="3455327">(</span><span class="ident" id="3455328">config</span>&nbsp;<span class="op" id="3455335">*</span><span class="ident" id="3455336">Config</span><span class="op" id="3455342">,</span>&nbsp;<span class="ident" id="3455344">cert</span>&nbsp;<span class="op" id="3455349">*</span><span class="ident" id="3455350">Certificate</span><span class="op" id="3455361">,</span>&nbsp;<span class="ident" id="3455363">clientHello</span>&nbsp;<span class="op" id="3455375">*</span><span class="ident" id="3455376">clientHelloMsg</span><span class="op" id="3455390">,</span>&nbsp;<span class="ident" id="3455392">hello</span>&nbsp;<span class="op" id="3455398">*</span><span class="ident" id="3455399">serverHelloMsg</span><span class="op" id="3455413">)</span>&nbsp;<span class="op" id="3455415">(</span><span class="op" id="3455416">*</span><span class="ident" id="3455417">serverKeyExchangeMsg</span><span class="op" id="3455437">,</span>&nbsp;<span class="builtintype" id="3455439">error</span><span class="op" id="3455444">)</span>&nbsp;<span class="op" id="3455446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3455449">var</span>&nbsp;<span class="ident" id="3455453">curveid</span>&nbsp;<span class="ident" id="3455461">CurveID</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3455470">preferredCurves</span>&nbsp;<span class="op" id="3455486">:=</span>&nbsp;<span class="ident" id="3455489">config</span><span class="op" id="3455495">.</span><span class="ident" id="3455496">curvePreferences</span><span class="op" id="3455512">(</span><span class="op" id="3455513">)</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="ident" id="3455516">NextCandidate</span><span class="op" id="3455529">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3455532">for</span>&nbsp;<span class="ident" id="3455536">_</span><span class="op" id="3455537">,</span>&nbsp;<span class="ident" id="3455539">candidate</span>&nbsp;<span class="op" id="3455549">:=</span>&nbsp;<span class="keyword" id="3455552">range</span>&nbsp;<span class="ident" id="3455558">preferredCurves</span>&nbsp;<span class="op" id="3455574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3455578">for</span>&nbsp;<span class="ident" id="3455582">_</span><span class="op" id="3455583">,</span>&nbsp;<span class="ident" id="3455585">c</span>&nbsp;<span class="op" id="3455587">:=</span>&nbsp;<span class="keyword" id="3455590">range</span>&nbsp;<span class="ident" id="3455596">clientHello</span><span class="op" id="3455607">.</span><span class="ident" id="3455608">supportedCurves</span>&nbsp;<span class="op" id="3455624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3455629">if</span>&nbsp;<span class="ident" id="3455632">candidate</span>&nbsp;<span class="op" id="3455642">==</span>&nbsp;<span class="ident" id="3455645">c</span>&nbsp;<span class="op" id="3455647">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3455653">curveid</span>&nbsp;<span class="op" id="3455661">=</span>&nbsp;<span class="ident" id="3455663">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3455669">break</span>&nbsp;<span class="ident" id="3455675">NextCandidate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3455692">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3455696">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3455699">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3455703">if</span>&nbsp;<span class="ident" id="3455706">curveid</span>&nbsp;<span class="op" id="3455714">==</span>&nbsp;<span class="num" id="3455717">0</span>&nbsp;<span class="op" id="3455719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3455723">return</span>&nbsp;<span class="ident" id="3455730">nil</span><span class="op" id="3455733">,</span>&nbsp;<span class="ident" id="3455735">errors</span><span class="op" id="3455741">.</span><span class="ident" id="3455742">New</span><span class="op" id="3455745">(</span><span class="string" id="3455746">&#34;tls:&nbsp;no&nbsp;supported&nbsp;elliptic&nbsp;curves&nbsp;offered&#34;</span><span class="op" id="3455789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3455792">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3455796">var</span>&nbsp;<span class="ident" id="3455800">ok</span>&nbsp;<span class="builtintype" id="3455803">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3455809">if</span>&nbsp;<span class="ident" id="3455812">ka</span><span class="op" id="3455814">.</span><span class="ident" id="3455815">curve</span><span class="op" id="3455820">,</span>&nbsp;<span class="ident" id="3455822">ok</span>&nbsp;<span class="op" id="3455825">=</span>&nbsp;<span class="ident" id="3455827">curveForCurveID</span><span class="op" id="3455842">(</span><span class="ident" id="3455843">curveid</span><span class="op" id="3455850">)</span><span class="op" id="3455851">;</span>&nbsp;<span class="op" id="3455853">!</span><span class="ident" id="3455854">ok</span>&nbsp;<span class="op" id="3455857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3455861">return</span>&nbsp;<span class="ident" id="3455868">nil</span><span class="op" id="3455871">,</span>&nbsp;<span class="ident" id="3455873">errors</span><span class="op" id="3455879">.</span><span class="ident" id="3455880">New</span><span class="op" id="3455883">(</span><span class="string" id="3455884">&#34;tls:&nbsp;preferredCurves&nbsp;includes&nbsp;unsupported&nbsp;curve&#34;</span><span class="op" id="3455933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3455936">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3455940">var</span>&nbsp;<span class="ident" id="3455944">x</span><span class="op" id="3455945">,</span>&nbsp;<span class="ident" id="3455947">y</span>&nbsp;<span class="op" id="3455949">*</span><span class="ident" id="3455950">big</span><span class="op" id="3455953">.</span><span class="ident" id="3455954">Int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3455959">var</span>&nbsp;<span class="ident" id="3455963">err</span>&nbsp;<span class="builtintype" id="3455967">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3455974">ka</span><span class="op" id="3455976">.</span><span class="ident" id="3455977">privateKey</span><span class="op" id="3455987">,</span>&nbsp;<span class="ident" id="3455989">x</span><span class="op" id="3455990">,</span>&nbsp;<span class="ident" id="3455992">y</span><span class="op" id="3455993">,</span>&nbsp;<span class="ident" id="3455995">err</span>&nbsp;<span class="op" id="3455999">=</span>&nbsp;<span class="ident" id="3456001">elliptic</span><span class="op" id="3456009">.</span><span class="ident" id="3456010">GenerateKey</span><span class="op" id="3456021">(</span><span class="ident" id="3456022">ka</span><span class="op" id="3456024">.</span><span class="ident" id="3456025">curve</span><span class="op" id="3456030">,</span>&nbsp;<span class="ident" id="3456032">config</span><span class="op" id="3456038">.</span><span class="ident" id="3456039">rand</span><span class="op" id="3456043">(</span><span class="op" id="3456044">)</span><span class="op" id="3456045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456048">if</span>&nbsp;<span class="ident" id="3456051">err</span>&nbsp;<span class="op" id="3456055">!=</span>&nbsp;<span class="ident" id="3456058">nil</span>&nbsp;<span class="op" id="3456062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456066">return</span>&nbsp;<span class="ident" id="3456073">nil</span><span class="op" id="3456076">,</span>&nbsp;<span class="ident" id="3456078">err</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3456083">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456086">ecdhePublic</span>&nbsp;<span class="op" id="3456098">:=</span>&nbsp;<span class="ident" id="3456101">elliptic</span><span class="op" id="3456109">.</span><span class="ident" id="3456110">Marshal</span><span class="op" id="3456117">(</span><span class="ident" id="3456118">ka</span><span class="op" id="3456120">.</span><span class="ident" id="3456121">curve</span><span class="op" id="3456126">,</span>&nbsp;<span class="ident" id="3456128">x</span><span class="op" id="3456129">,</span>&nbsp;<span class="ident" id="3456131">y</span><span class="op" id="3456132">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3456136">//&nbsp;http://tools.ietf.org/html/rfc4492#section-5.4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456187">serverECDHParams</span>&nbsp;<span class="op" id="3456204">:=</span>&nbsp;<span class="builtinfunc" id="3456207">make</span><span class="op" id="3456211">(</span><span class="op" id="3456212">[</span><span class="op" id="3456213">]</span><span class="builtintype" id="3456214">byte</span><span class="op" id="3456218">,</span>&nbsp;<span class="num" id="3456220">1</span><span class="op" id="3456221">+</span><span class="num" id="3456222">2</span><span class="op" id="3456223">+</span><span class="num" id="3456224">1</span><span class="op" id="3456225">+</span><span class="builtinfunc" id="3456226">len</span><span class="op" id="3456229">(</span><span class="ident" id="3456230">ecdhePublic</span><span class="op" id="3456241">)</span><span class="op" id="3456242">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456245">serverECDHParams</span><span class="op" id="3456261">[</span><span class="num" id="3456262">0</span><span class="op" id="3456263">]</span>&nbsp;<span class="op" id="3456265">=</span>&nbsp;<span class="num" id="3456267">3</span>&nbsp;<span class="comment" id="3456269">//&nbsp;named&nbsp;curve</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456285">serverECDHParams</span><span class="op" id="3456301">[</span><span class="num" id="3456302">1</span><span class="op" id="3456303">]</span>&nbsp;<span class="op" id="3456305">=</span>&nbsp;<span class="builtintype" id="3456307">byte</span><span class="op" id="3456311">(</span><span class="ident" id="3456312">curveid</span>&nbsp;<span class="op" id="3456320">&gt;&gt;</span>&nbsp;<span class="num" id="3456323">8</span><span class="op" id="3456324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456327">serverECDHParams</span><span class="op" id="3456343">[</span><span class="num" id="3456344">2</span><span class="op" id="3456345">]</span>&nbsp;<span class="op" id="3456347">=</span>&nbsp;<span class="builtintype" id="3456349">byte</span><span class="op" id="3456353">(</span><span class="ident" id="3456354">curveid</span><span class="op" id="3456361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456364">serverECDHParams</span><span class="op" id="3456380">[</span><span class="num" id="3456381">3</span><span class="op" id="3456382">]</span>&nbsp;<span class="op" id="3456384">=</span>&nbsp;<span class="builtintype" id="3456386">byte</span><span class="op" id="3456390">(</span><span class="builtinfunc" id="3456391">len</span><span class="op" id="3456394">(</span><span class="ident" id="3456395">ecdhePublic</span><span class="op" id="3456406">)</span><span class="op" id="3456407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3456410">copy</span><span class="op" id="3456414">(</span><span class="ident" id="3456415">serverECDHParams</span><span class="op" id="3456431">[</span><span class="num" id="3456432">4</span><span class="op" id="3456433">:</span><span class="op" id="3456434">]</span><span class="op" id="3456435">,</span>&nbsp;<span class="ident" id="3456437">ecdhePublic</span><span class="op" id="3456448">)</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456452">var</span>&nbsp;<span class="ident" id="3456456">tls12HashId</span>&nbsp;<span class="builtintype" id="3456468">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456475">if</span>&nbsp;<span class="ident" id="3456478">ka</span><span class="op" id="3456480">.</span><span class="ident" id="3456481">version</span>&nbsp;<span class="op" id="3456489">&gt;=</span>&nbsp;<span class="ident" id="3456492">VersionTLS12</span>&nbsp;<span class="op" id="3456505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456509">if</span>&nbsp;<span class="ident" id="3456512">tls12HashId</span><span class="op" id="3456523">,</span>&nbsp;<span class="ident" id="3456525">err</span>&nbsp;<span class="op" id="3456529">=</span>&nbsp;<span class="ident" id="3456531">pickTLS12HashForSignature</span><span class="op" id="3456556">(</span><span class="ident" id="3456557">ka</span><span class="op" id="3456559">.</span><span class="ident" id="3456560">sigType</span><span class="op" id="3456567">,</span>&nbsp;<span class="ident" id="3456569">clientHello</span><span class="op" id="3456580">.</span><span class="ident" id="3456581">signatureAndHashes</span><span class="op" id="3456599">)</span><span class="op" id="3456600">;</span>&nbsp;<span class="ident" id="3456602">err</span>&nbsp;<span class="op" id="3456606">!=</span>&nbsp;<span class="ident" id="3456609">nil</span>&nbsp;<span class="op" id="3456613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456618">return</span>&nbsp;<span class="ident" id="3456625">nil</span><span class="op" id="3456628">,</span>&nbsp;<span class="ident" id="3456630">err</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3456636">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3456639">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456643">digest</span><span class="op" id="3456649">,</span>&nbsp;<span class="ident" id="3456651">hashFunc</span><span class="op" id="3456659">,</span>&nbsp;<span class="ident" id="3456661">err</span>&nbsp;<span class="op" id="3456665">:=</span>&nbsp;<span class="ident" id="3456668">hashForServerKeyExchange</span><span class="op" id="3456692">(</span><span class="ident" id="3456693">ka</span><span class="op" id="3456695">.</span><span class="ident" id="3456696">sigType</span><span class="op" id="3456703">,</span>&nbsp;<span class="ident" id="3456705">tls12HashId</span><span class="op" id="3456716">,</span>&nbsp;<span class="ident" id="3456718">ka</span><span class="op" id="3456720">.</span><span class="ident" id="3456721">version</span><span class="op" id="3456728">,</span>&nbsp;<span class="ident" id="3456730">clientHello</span><span class="op" id="3456741">.</span><span class="ident" id="3456742">random</span><span class="op" id="3456748">,</span>&nbsp;<span class="ident" id="3456750">hello</span><span class="op" id="3456755">.</span><span class="ident" id="3456756">random</span><span class="op" id="3456762">,</span>&nbsp;<span class="ident" id="3456764">serverECDHParams</span><span class="op" id="3456780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456783">if</span>&nbsp;<span class="ident" id="3456786">err</span>&nbsp;<span class="op" id="3456790">!=</span>&nbsp;<span class="ident" id="3456793">nil</span>&nbsp;<span class="op" id="3456797">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456801">return</span>&nbsp;<span class="ident" id="3456808">nil</span><span class="op" id="3456811">,</span>&nbsp;<span class="ident" id="3456813">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3456818">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456821">var</span>&nbsp;<span class="ident" id="3456825">sig</span>&nbsp;<span class="op" id="3456829">[</span><span class="op" id="3456830">]</span><span class="builtintype" id="3456831">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456837">switch</span>&nbsp;<span class="ident" id="3456844">ka</span><span class="op" id="3456846">.</span><span class="ident" id="3456847">sigType</span>&nbsp;<span class="op" id="3456855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456858">case</span>&nbsp;<span class="ident" id="3456863">signatureECDSA</span><span class="op" id="3456877">:</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456881">privKey</span><span class="op" id="3456888">,</span>&nbsp;<span class="ident" id="3456890">ok</span>&nbsp;<span class="op" id="3456893">:=</span>&nbsp;<span class="ident" id="3456896">cert</span><span class="op" id="3456900">.</span><span class="ident" id="3456901">PrivateKey</span><span class="op" id="3456911">.</span><span class="op" id="3456912">(</span><span class="op" id="3456913">*</span><span class="ident" id="3456914">ecdsa</span><span class="op" id="3456919">.</span><span class="ident" id="3456920">PrivateKey</span><span class="op" id="3456930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456934">if</span>&nbsp;<span class="op" id="3456937">!</span><span class="ident" id="3456938">ok</span>&nbsp;<span class="op" id="3456941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456946">return</span>&nbsp;<span class="ident" id="3456953">nil</span><span class="op" id="3456956">,</span>&nbsp;<span class="ident" id="3456958">errors</span><span class="op" id="3456964">.</span><span class="ident" id="3456965">New</span><span class="op" id="3456968">(</span><span class="string" id="3456969">&#34;ECDHE&nbsp;ECDSA&nbsp;requires&nbsp;an&nbsp;ECDSA&nbsp;server&nbsp;private&nbsp;key&#34;</span><span class="op" id="3457019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3457023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457027">r</span><span class="op" id="3457028">,</span>&nbsp;<span class="ident" id="3457030">s</span><span class="op" id="3457031">,</span>&nbsp;<span class="ident" id="3457033">err</span>&nbsp;<span class="op" id="3457037">:=</span>&nbsp;<span class="ident" id="3457040">ecdsa</span><span class="op" id="3457045">.</span><span class="ident" id="3457046">Sign</span><span class="op" id="3457050">(</span><span class="ident" id="3457051">config</span><span class="op" id="3457057">.</span><span class="ident" id="3457058">rand</span><span class="op" id="3457062">(</span><span class="op" id="3457063">)</span><span class="op" id="3457064">,</span>&nbsp;<span class="ident" id="3457066">privKey</span><span class="op" id="3457073">,</span>&nbsp;<span class="ident" id="3457075">digest</span><span class="op" id="3457081">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457085">if</span>&nbsp;<span class="ident" id="3457088">err</span>&nbsp;<span class="op" id="3457092">!=</span>&nbsp;<span class="ident" id="3457095">nil</span>&nbsp;<span class="op" id="3457099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457104">return</span>&nbsp;<span class="ident" id="3457111">nil</span><span class="op" id="3457114">,</span>&nbsp;<span class="ident" id="3457116">errors</span><span class="op" id="3457122">.</span><span class="ident" id="3457123">New</span><span class="op" id="3457126">(</span><span class="string" id="3457127">&#34;failed&nbsp;to&nbsp;sign&nbsp;ECDHE&nbsp;parameters:&nbsp;&#34;</span>&nbsp;<span class="op" id="3457163">+</span>&nbsp;<span class="ident" id="3457165">err</span><span class="op" id="3457168">.</span><span class="ident" id="3457169">Error</span><span class="op" id="3457174">(</span><span class="op" id="3457175">)</span><span class="op" id="3457176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3457180">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457184">sig</span><span class="op" id="3457187">,</span>&nbsp;<span class="ident" id="3457189">err</span>&nbsp;<span class="op" id="3457193">=</span>&nbsp;<span class="ident" id="3457195">asn1</span><span class="op" id="3457199">.</span><span class="ident" id="3457200">Marshal</span><span class="op" id="3457207">(</span><span class="ident" id="3457208">ecdsaSignature</span><span class="op" id="3457222">{</span><span class="ident" id="3457223">r</span><span class="op" id="3457224">,</span>&nbsp;<span class="ident" id="3457226">s</span><span class="op" id="3457227">}</span><span class="op" id="3457228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457231">case</span>&nbsp;<span class="ident" id="3457236">signatureRSA</span><span class="op" id="3457248">:</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457252">privKey</span><span class="op" id="3457259">,</span>&nbsp;<span class="ident" id="3457261">ok</span>&nbsp;<span class="op" id="3457264">:=</span>&nbsp;<span class="ident" id="3457267">cert</span><span class="op" id="3457271">.</span><span class="ident" id="3457272">PrivateKey</span><span class="op" id="3457282">.</span><span class="op" id="3457283">(</span><span class="op" id="3457284">*</span><span class="ident" id="3457285">rsa</span><span class="op" id="3457288">.</span><span class="ident" id="3457289">PrivateKey</span><span class="op" id="3457299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457303">if</span>&nbsp;<span class="op" id="3457306">!</span><span class="ident" id="3457307">ok</span>&nbsp;<span class="op" id="3457310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457315">return</span>&nbsp;<span class="ident" id="3457322">nil</span><span class="op" id="3457325">,</span>&nbsp;<span class="ident" id="3457327">errors</span><span class="op" id="3457333">.</span><span class="ident" id="3457334">New</span><span class="op" id="3457337">(</span><span class="string" id="3457338">&#34;ECDHE&nbsp;RSA&nbsp;requires&nbsp;a&nbsp;RSA&nbsp;server&nbsp;private&nbsp;key&#34;</span><span class="op" id="3457383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3457387">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457391">sig</span><span class="op" id="3457394">,</span>&nbsp;<span class="ident" id="3457396">err</span>&nbsp;<span class="op" id="3457400">=</span>&nbsp;<span class="ident" id="3457402">rsa</span><span class="op" id="3457405">.</span><span class="ident" id="3457406">SignPKCS1v15</span><span class="op" id="3457418">(</span><span class="ident" id="3457419">config</span><span class="op" id="3457425">.</span><span class="ident" id="3457426">rand</span><span class="op" id="3457430">(</span><span class="op" id="3457431">)</span><span class="op" id="3457432">,</span>&nbsp;<span class="ident" id="3457434">privKey</span><span class="op" id="3457441">,</span>&nbsp;<span class="ident" id="3457443">hashFunc</span><span class="op" id="3457451">,</span>&nbsp;<span class="ident" id="3457453">digest</span><span class="op" id="3457459">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457463">if</span>&nbsp;<span class="ident" id="3457466">err</span>&nbsp;<span class="op" id="3457470">!=</span>&nbsp;<span class="ident" id="3457473">nil</span>&nbsp;<span class="op" id="3457477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457482">return</span>&nbsp;<span class="ident" id="3457489">nil</span><span class="op" id="3457492">,</span>&nbsp;<span class="ident" id="3457494">errors</span><span class="op" id="3457500">.</span><span class="ident" id="3457501">New</span><span class="op" id="3457504">(</span><span class="string" id="3457505">&#34;failed&nbsp;to&nbsp;sign&nbsp;ECDHE&nbsp;parameters:&nbsp;&#34;</span>&nbsp;<span class="op" id="3457541">+</span>&nbsp;<span class="ident" id="3457543">err</span><span class="op" id="3457546">.</span><span class="ident" id="3457547">Error</span><span class="op" id="3457552">(</span><span class="op" id="3457553">)</span><span class="op" id="3457554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3457558">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457561">default</span><span class="op" id="3457568">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457572">return</span>&nbsp;<span class="ident" id="3457579">nil</span><span class="op" id="3457582">,</span>&nbsp;<span class="ident" id="3457584">errors</span><span class="op" id="3457590">.</span><span class="ident" id="3457591">New</span><span class="op" id="3457594">(</span><span class="string" id="3457595">&#34;unknown&nbsp;ECDHE&nbsp;signature&nbsp;algorithm&#34;</span><span class="op" id="3457630">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3457633">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457637">skx</span>&nbsp;<span class="op" id="3457641">:=</span>&nbsp;<span class="builtinfunc" id="3457644">new</span><span class="op" id="3457647">(</span><span class="ident" id="3457648">serverKeyExchangeMsg</span><span class="op" id="3457668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457671">sigAndHashLen</span>&nbsp;<span class="op" id="3457685">:=</span>&nbsp;<span class="num" id="3457688">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457691">if</span>&nbsp;<span class="ident" id="3457694">ka</span><span class="op" id="3457696">.</span><span class="ident" id="3457697">version</span>&nbsp;<span class="op" id="3457705">&gt;=</span>&nbsp;<span class="ident" id="3457708">VersionTLS12</span>&nbsp;<span class="op" id="3457721">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457725">sigAndHashLen</span>&nbsp;<span class="op" id="3457739">=</span>&nbsp;<span class="num" id="3457741">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3457744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457747">skx</span><span class="op" id="3457750">.</span><span class="ident" id="3457751">key</span>&nbsp;<span class="op" id="3457755">=</span>&nbsp;<span class="builtinfunc" id="3457757">make</span><span class="op" id="3457761">(</span><span class="op" id="3457762">[</span><span class="op" id="3457763">]</span><span class="builtintype" id="3457764">byte</span><span class="op" id="3457768">,</span>&nbsp;<span class="builtinfunc" id="3457770">len</span><span class="op" id="3457773">(</span><span class="ident" id="3457774">serverECDHParams</span><span class="op" id="3457790">)</span><span class="op" id="3457791">+</span><span class="ident" id="3457792">sigAndHashLen</span><span class="op" id="3457805">+</span><span class="num" id="3457806">2</span><span class="op" id="3457807">+</span><span class="builtinfunc" id="3457808">len</span><span class="op" id="3457811">(</span><span class="ident" id="3457812">sig</span><span class="op" id="3457815">)</span><span class="op" id="3457816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3457819">copy</span><span class="op" id="3457823">(</span><span class="ident" id="3457824">skx</span><span class="op" id="3457827">.</span><span class="ident" id="3457828">key</span><span class="op" id="3457831">,</span>&nbsp;<span class="ident" id="3457833">serverECDHParams</span><span class="op" id="3457849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457852">k</span>&nbsp;<span class="op" id="3457854">:=</span>&nbsp;<span class="ident" id="3457857">skx</span><span class="op" id="3457860">.</span><span class="ident" id="3457861">key</span><span class="op" id="3457864">[</span><span class="builtinfunc" id="3457865">len</span><span class="op" id="3457868">(</span><span class="ident" id="3457869">serverECDHParams</span><span class="op" id="3457885">)</span><span class="op" id="3457886">:</span><span class="op" id="3457887">]</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457890">if</span>&nbsp;<span class="ident" id="3457893">ka</span><span class="op" id="3457895">.</span><span class="ident" id="3457896">version</span>&nbsp;<span class="op" id="3457904">&gt;=</span>&nbsp;<span class="ident" id="3457907">VersionTLS12</span>&nbsp;<span class="op" id="3457920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457924">k</span><span class="op" id="3457925">[</span><span class="num" id="3457926">0</span><span class="op" id="3457927">]</span>&nbsp;<span class="op" id="3457929">=</span>&nbsp;<span class="ident" id="3457931">tls12HashId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457945">k</span><span class="op" id="3457946">[</span><span class="num" id="3457947">1</span><span class="op" id="3457948">]</span>&nbsp;<span class="op" id="3457950">=</span>&nbsp;<span class="ident" id="3457952">ka</span><span class="op" id="3457954">.</span><span class="ident" id="3457955">sigType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457965">k</span>&nbsp;<span class="op" id="3457967">=</span>&nbsp;<span class="ident" id="3457969">k</span><span class="op" id="3457970">[</span><span class="num" id="3457971">2</span><span class="op" id="3457972">:</span><span class="op" id="3457973">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3457976">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457979">k</span><span class="op" id="3457980">[</span><span class="num" id="3457981">0</span><span class="op" id="3457982">]</span>&nbsp;<span class="op" id="3457984">=</span>&nbsp;<span class="builtintype" id="3457986">byte</span><span class="op" id="3457990">(</span><span class="builtinfunc" id="3457991">len</span><span class="op" id="3457994">(</span><span class="ident" id="3457995">sig</span><span class="op" id="3457998">)</span>&nbsp;<span class="op" id="3458000">&gt;&gt;</span>&nbsp;<span class="num" id="3458003">8</span><span class="op" id="3458004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3458007">k</span><span class="op" id="3458008">[</span><span class="num" id="3458009">1</span><span class="op" id="3458010">]</span>&nbsp;<span class="op" id="3458012">=</span>&nbsp;<span class="builtintype" id="3458014">byte</span><span class="op" id="3458018">(</span><span class="builtinfunc" id="3458019">len</span><span class="op" id="3458022">(</span><span class="ident" id="3458023">sig</span><span class="op" id="3458026">)</span><span class="op" id="3458027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3458030">copy</span><span class="op" id="3458034">(</span><span class="ident" id="3458035">k</span><span class="op" id="3458036">[</span><span class="num" id="3458037">2</span><span class="op" id="3458038">:</span><span class="op" id="3458039">]</span><span class="op" id="3458040">,</span>&nbsp;<span class="ident" id="3458042">sig</span><span class="op" id="3458045">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458049">return</span>&nbsp;<span class="ident" id="3458056">skx</span><span class="op" id="3458059">,</span>&nbsp;<span class="ident" id="3458061">nil</span><br>
<span class="lineno">285</span><span class="op" id="3458065">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3458068">func</span>&nbsp;<span class="op" id="3458073">(</span><span class="ident" id="3458074">ka</span>&nbsp;<span class="op" id="3458077">*</span><span class="ident" id="3458078">ecdheKeyAgreement</span><span class="op" id="3458095">)</span>&nbsp;<span class="ident" id="3458097">processClientKeyExchange</span><span class="op" id="3458121">(</span><span class="ident" id="3458122">config</span>&nbsp;<span class="op" id="3458129">*</span><span class="ident" id="3458130">Config</span><span class="op" id="3458136">,</span>&nbsp;<span class="ident" id="3458138">cert</span>&nbsp;<span class="op" id="3458143">*</span><span class="ident" id="3458144">Certificate</span><span class="op" id="3458155">,</span>&nbsp;<span class="ident" id="3458157">ckx</span>&nbsp;<span class="op" id="3458161">*</span><span class="ident" id="3458162">clientKeyExchangeMsg</span><span class="op" id="3458182">,</span>&nbsp;<span class="ident" id="3458184">version</span>&nbsp;<span class="builtintype" id="3458192">uint16</span><span class="op" id="3458198">)</span>&nbsp;<span class="op" id="3458200">(</span><span class="op" id="3458201">[</span><span class="op" id="3458202">]</span><span class="builtintype" id="3458203">byte</span><span class="op" id="3458207">,</span>&nbsp;<span class="builtintype" id="3458209">error</span><span class="op" id="3458214">)</span>&nbsp;<span class="op" id="3458216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458219">if</span>&nbsp;<span class="builtinfunc" id="3458222">len</span><span class="op" id="3458225">(</span><span class="ident" id="3458226">ckx</span><span class="op" id="3458229">.</span><span class="ident" id="3458230">ciphertext</span><span class="op" id="3458240">)</span>&nbsp;<span class="op" id="3458242">==</span>&nbsp;<span class="num" id="3458245">0</span>&nbsp;<span class="op" id="3458247">||</span>&nbsp;<span class="builtintype" id="3458250">int</span><span class="op" id="3458253">(</span><span class="ident" id="3458254">ckx</span><span class="op" id="3458257">.</span><span class="ident" id="3458258">ciphertext</span><span class="op" id="3458268">[</span><span class="num" id="3458269">0</span><span class="op" id="3458270">]</span><span class="op" id="3458271">)</span>&nbsp;<span class="op" id="3458273">!=</span>&nbsp;<span class="builtinfunc" id="3458276">len</span><span class="op" id="3458279">(</span><span class="ident" id="3458280">ckx</span><span class="op" id="3458283">.</span><span class="ident" id="3458284">ciphertext</span><span class="op" id="3458294">)</span><span class="op" id="3458295">-</span><span class="num" id="3458296">1</span>&nbsp;<span class="op" id="3458298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458302">return</span>&nbsp;<span class="ident" id="3458309">nil</span><span class="op" id="3458312">,</span>&nbsp;<span class="ident" id="3458314">errClientKeyExchange</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3458336">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3458339">x</span><span class="op" id="3458340">,</span>&nbsp;<span class="ident" id="3458342">y</span>&nbsp;<span class="op" id="3458344">:=</span>&nbsp;<span class="ident" id="3458347">elliptic</span><span class="op" id="3458355">.</span><span class="ident" id="3458356">Unmarshal</span><span class="op" id="3458365">(</span><span class="ident" id="3458366">ka</span><span class="op" id="3458368">.</span><span class="ident" id="3458369">curve</span><span class="op" id="3458374">,</span>&nbsp;<span class="ident" id="3458376">ckx</span><span class="op" id="3458379">.</span><span class="ident" id="3458380">ciphertext</span><span class="op" id="3458390">[</span><span class="num" id="3458391">1</span><span class="op" id="3458392">:</span><span class="op" id="3458393">]</span><span class="op" id="3458394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458397">if</span>&nbsp;<span class="ident" id="3458400">x</span>&nbsp;<span class="op" id="3458402">==</span>&nbsp;<span class="ident" id="3458405">nil</span>&nbsp;<span class="op" id="3458409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458413">return</span>&nbsp;<span class="ident" id="3458420">nil</span><span class="op" id="3458423">,</span>&nbsp;<span class="ident" id="3458425">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3458447">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458450">if</span>&nbsp;<span class="op" id="3458453">!</span><span class="ident" id="3458454">ka</span><span class="op" id="3458456">.</span><span class="ident" id="3458457">curve</span><span class="op" id="3458462">.</span><span class="ident" id="3458463">IsOnCurve</span><span class="op" id="3458472">(</span><span class="ident" id="3458473">x</span><span class="op" id="3458474">,</span>&nbsp;<span class="ident" id="3458476">y</span><span class="op" id="3458477">)</span>&nbsp;<span class="op" id="3458479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458483">return</span>&nbsp;<span class="ident" id="3458490">nil</span><span class="op" id="3458493">,</span>&nbsp;<span class="ident" id="3458495">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3458517">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3458520">x</span><span class="op" id="3458521">,</span>&nbsp;<span class="ident" id="3458523">_</span>&nbsp;<span class="op" id="3458525">=</span>&nbsp;<span class="ident" id="3458527">ka</span><span class="op" id="3458529">.</span><span class="ident" id="3458530">curve</span><span class="op" id="3458535">.</span><span class="ident" id="3458536">ScalarMult</span><span class="op" id="3458546">(</span><span class="ident" id="3458547">x</span><span class="op" id="3458548">,</span>&nbsp;<span class="ident" id="3458550">y</span><span class="op" id="3458551">,</span>&nbsp;<span class="ident" id="3458553">ka</span><span class="op" id="3458555">.</span><span class="ident" id="3458556">privateKey</span><span class="op" id="3458566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3458569">preMasterSecret</span>&nbsp;<span class="op" id="3458585">:=</span>&nbsp;<span class="builtinfunc" id="3458588">make</span><span class="op" id="3458592">(</span><span class="op" id="3458593">[</span><span class="op" id="3458594">]</span><span class="builtintype" id="3458595">byte</span><span class="op" id="3458599">,</span>&nbsp;<span class="op" id="3458601">(</span><span class="ident" id="3458602">ka</span><span class="op" id="3458604">.</span><span class="ident" id="3458605">curve</span><span class="op" id="3458610">.</span><span class="ident" id="3458611">Params</span><span class="op" id="3458617">(</span><span class="op" id="3458618">)</span><span class="op" id="3458619">.</span><span class="ident" id="3458620">BitSize</span><span class="op" id="3458627">+</span><span class="num" id="3458628">7</span><span class="op" id="3458629">)</span><span class="op" id="3458630">&gt;&gt;</span><span class="num" id="3458632">3</span><span class="op" id="3458633">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3458636">xBytes</span>&nbsp;<span class="op" id="3458643">:=</span>&nbsp;<span class="ident" id="3458646">x</span><span class="op" id="3458647">.</span><span class="ident" id="3458648">Bytes</span><span class="op" id="3458653">(</span><span class="op" id="3458654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3458657">copy</span><span class="op" id="3458661">(</span><span class="ident" id="3458662">preMasterSecret</span><span class="op" id="3458677">[</span><span class="builtinfunc" id="3458678">len</span><span class="op" id="3458681">(</span><span class="ident" id="3458682">preMasterSecret</span><span class="op" id="3458697">)</span><span class="op" id="3458698">-</span><span class="builtinfunc" id="3458699">len</span><span class="op" id="3458702">(</span><span class="ident" id="3458703">xBytes</span><span class="op" id="3458709">)</span><span class="op" id="3458710">:</span><span class="op" id="3458711">]</span><span class="op" id="3458712">,</span>&nbsp;<span class="ident" id="3458714">xBytes</span><span class="op" id="3458720">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458724">return</span>&nbsp;<span class="ident" id="3458731">preMasterSecret</span><span class="op" id="3458746">,</span>&nbsp;<span class="ident" id="3458748">nil</span><br>
<span class="lineno"></span><span class="op" id="3458752">}</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span><span class="keyword" id="3458755">func</span>&nbsp;<span class="op" id="3458760">(</span><span class="ident" id="3458761">ka</span>&nbsp;<span class="op" id="3458764">*</span><span class="ident" id="3458765">ecdheKeyAgreement</span><span class="op" id="3458782">)</span>&nbsp;<span class="ident" id="3458784">processServerKeyExchange</span><span class="op" id="3458808">(</span><span class="ident" id="3458809">config</span>&nbsp;<span class="op" id="3458816">*</span><span class="ident" id="3458817">Config</span><span class="op" id="3458823">,</span>&nbsp;<span class="ident" id="3458825">clientHello</span>&nbsp;<span class="op" id="3458837">*</span><span class="ident" id="3458838">clientHelloMsg</span><span class="op" id="3458852">,</span>&nbsp;<span class="ident" id="3458854">serverHello</span>&nbsp;<span class="op" id="3458866">*</span><span class="ident" id="3458867">serverHelloMsg</span><span class="op" id="3458881">,</span>&nbsp;<span class="ident" id="3458883">cert</span>&nbsp;<span class="op" id="3458888">*</span><span class="ident" id="3458889">x509</span><span class="op" id="3458893">.</span><span class="ident" id="3458894">Certificate</span><span class="op" id="3458905">,</span>&nbsp;<span class="ident" id="3458907">skx</span>&nbsp;<span class="op" id="3458911">*</span><span class="ident" id="3458912">serverKeyExchangeMsg</span><span class="op" id="3458932">)</span>&nbsp;<span class="builtintype" id="3458934">error</span>&nbsp;<span class="op" id="3458940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458943">if</span>&nbsp;<span class="builtinfunc" id="3458946">len</span><span class="op" id="3458949">(</span><span class="ident" id="3458950">skx</span><span class="op" id="3458953">.</span><span class="ident" id="3458954">key</span><span class="op" id="3458957">)</span>&nbsp;<span class="op" id="3458959">&lt;</span>&nbsp;<span class="num" id="3458961">4</span>&nbsp;<span class="op" id="3458963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458967">return</span>&nbsp;<span class="ident" id="3458974">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3458996">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458999">if</span>&nbsp;<span class="ident" id="3459002">skx</span><span class="op" id="3459005">.</span><span class="ident" id="3459006">key</span><span class="op" id="3459009">[</span><span class="num" id="3459010">0</span><span class="op" id="3459011">]</span>&nbsp;<span class="op" id="3459013">!=</span>&nbsp;<span class="num" id="3459016">3</span>&nbsp;<span class="op" id="3459018">{</span>&nbsp;<span class="comment" id="3459020">//&nbsp;named&nbsp;curve</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459037">return</span>&nbsp;<span class="ident" id="3459044">errors</span><span class="op" id="3459050">.</span><span class="ident" id="3459051">New</span><span class="op" id="3459054">(</span><span class="string" id="3459055">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;curve&#34;</span><span class="op" id="3459095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3459098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459101">curveid</span>&nbsp;<span class="op" id="3459109">:=</span>&nbsp;<span class="ident" id="3459112">CurveID</span><span class="op" id="3459119">(</span><span class="ident" id="3459120">skx</span><span class="op" id="3459123">.</span><span class="ident" id="3459124">key</span><span class="op" id="3459127">[</span><span class="num" id="3459128">1</span><span class="op" id="3459129">]</span><span class="op" id="3459130">)</span><span class="op" id="3459131">&lt;&lt;</span><span class="num" id="3459133">8</span>&nbsp;<span class="op" id="3459135">|</span>&nbsp;<span class="ident" id="3459137">CurveID</span><span class="op" id="3459144">(</span><span class="ident" id="3459145">skx</span><span class="op" id="3459148">.</span><span class="ident" id="3459149">key</span><span class="op" id="3459152">[</span><span class="num" id="3459153">2</span><span class="op" id="3459154">]</span><span class="op" id="3459155">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459159">var</span>&nbsp;<span class="ident" id="3459163">ok</span>&nbsp;<span class="builtintype" id="3459166">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459172">if</span>&nbsp;<span class="ident" id="3459175">ka</span><span class="op" id="3459177">.</span><span class="ident" id="3459178">curve</span><span class="op" id="3459183">,</span>&nbsp;<span class="ident" id="3459185">ok</span>&nbsp;<span class="op" id="3459188">=</span>&nbsp;<span class="ident" id="3459190">curveForCurveID</span><span class="op" id="3459205">(</span><span class="ident" id="3459206">curveid</span><span class="op" id="3459213">)</span><span class="op" id="3459214">;</span>&nbsp;<span class="op" id="3459216">!</span><span class="ident" id="3459217">ok</span>&nbsp;<span class="op" id="3459220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459224">return</span>&nbsp;<span class="ident" id="3459231">errors</span><span class="op" id="3459237">.</span><span class="ident" id="3459238">New</span><span class="op" id="3459241">(</span><span class="string" id="3459242">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;curve&#34;</span><span class="op" id="3459282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3459285">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459289">publicLen</span>&nbsp;<span class="op" id="3459299">:=</span>&nbsp;<span class="builtintype" id="3459302">int</span><span class="op" id="3459305">(</span><span class="ident" id="3459306">skx</span><span class="op" id="3459309">.</span><span class="ident" id="3459310">key</span><span class="op" id="3459313">[</span><span class="num" id="3459314">3</span><span class="op" id="3459315">]</span><span class="op" id="3459316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459319">if</span>&nbsp;<span class="ident" id="3459322">publicLen</span><span class="op" id="3459331">+</span><span class="num" id="3459332">4</span>&nbsp;<span class="op" id="3459334">&gt;</span>&nbsp;<span class="builtinfunc" id="3459336">len</span><span class="op" id="3459339">(</span><span class="ident" id="3459340">skx</span><span class="op" id="3459343">.</span><span class="ident" id="3459344">key</span><span class="op" id="3459347">)</span>&nbsp;<span class="op" id="3459349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459353">return</span>&nbsp;<span class="ident" id="3459360">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3459382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459385">ka</span><span class="op" id="3459387">.</span><span class="ident" id="3459388">x</span><span class="op" id="3459389">,</span>&nbsp;<span class="ident" id="3459391">ka</span><span class="op" id="3459393">.</span><span class="ident" id="3459394">y</span>&nbsp;<span class="op" id="3459396">=</span>&nbsp;<span class="ident" id="3459398">elliptic</span><span class="op" id="3459406">.</span><span class="ident" id="3459407">Unmarshal</span><span class="op" id="3459416">(</span><span class="ident" id="3459417">ka</span><span class="op" id="3459419">.</span><span class="ident" id="3459420">curve</span><span class="op" id="3459425">,</span>&nbsp;<span class="ident" id="3459427">skx</span><span class="op" id="3459430">.</span><span class="ident" id="3459431">key</span><span class="op" id="3459434">[</span><span class="num" id="3459435">4</span><span class="op" id="3459436">:</span><span class="num" id="3459437">4</span><span class="op" id="3459438">+</span><span class="ident" id="3459439">publicLen</span><span class="op" id="3459448">]</span><span class="op" id="3459449">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459452">if</span>&nbsp;<span class="ident" id="3459455">ka</span><span class="op" id="3459457">.</span><span class="ident" id="3459458">x</span>&nbsp;<span class="op" id="3459460">==</span>&nbsp;<span class="ident" id="3459463">nil</span>&nbsp;<span class="op" id="3459467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459471">return</span>&nbsp;<span class="ident" id="3459478">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3459500">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459503">if</span>&nbsp;<span class="op" id="3459506">!</span><span class="ident" id="3459507">ka</span><span class="op" id="3459509">.</span><span class="ident" id="3459510">curve</span><span class="op" id="3459515">.</span><span class="ident" id="3459516">IsOnCurve</span><span class="op" id="3459525">(</span><span class="ident" id="3459526">ka</span><span class="op" id="3459528">.</span><span class="ident" id="3459529">x</span><span class="op" id="3459530">,</span>&nbsp;<span class="ident" id="3459532">ka</span><span class="op" id="3459534">.</span><span class="ident" id="3459535">y</span><span class="op" id="3459536">)</span>&nbsp;<span class="op" id="3459538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459542">return</span>&nbsp;<span class="ident" id="3459549">errServerKeyExchange</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3459571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459574">serverECDHParams</span>&nbsp;<span class="op" id="3459591">:=</span>&nbsp;<span class="ident" id="3459594">skx</span><span class="op" id="3459597">.</span><span class="ident" id="3459598">key</span><span class="op" id="3459601">[</span><span class="op" id="3459602">:</span><span class="num" id="3459603">4</span><span class="op" id="3459604">+</span><span class="ident" id="3459605">publicLen</span><span class="op" id="3459614">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459618">sig</span>&nbsp;<span class="op" id="3459622">:=</span>&nbsp;<span class="ident" id="3459625">skx</span><span class="op" id="3459628">.</span><span class="ident" id="3459629">key</span><span class="op" id="3459632">[</span><span class="num" id="3459633">4</span><span class="op" id="3459634">+</span><span class="ident" id="3459635">publicLen</span><span class="op" id="3459644">:</span><span class="op" id="3459645">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459648">if</span>&nbsp;<span class="builtinfunc" id="3459651">len</span><span class="op" id="3459654">(</span><span class="ident" id="3459655">sig</span><span class="op" id="3459658">)</span>&nbsp;<span class="op" id="3459660">&lt;</span>&nbsp;<span class="num" id="3459662">2</span>&nbsp;<span class="op" id="3459664">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459668">return</span>&nbsp;<span class="ident" id="3459675">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3459697">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459701">var</span>&nbsp;<span class="ident" id="3459705">tls12HashId</span>&nbsp;<span class="builtintype" id="3459717">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459724">if</span>&nbsp;<span class="ident" id="3459727">ka</span><span class="op" id="3459729">.</span><span class="ident" id="3459730">version</span>&nbsp;<span class="op" id="3459738">&gt;=</span>&nbsp;<span class="ident" id="3459741">VersionTLS12</span>&nbsp;<span class="op" id="3459754">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3459758">//&nbsp;handle&nbsp;SignatureAndHashAlgorithm</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459796">var</span>&nbsp;<span class="ident" id="3459800">sigAndHash</span>&nbsp;<span class="op" id="3459811">[</span><span class="op" id="3459812">]</span><span class="builtintype" id="3459813">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459821">sigAndHash</span><span class="op" id="3459831">,</span>&nbsp;<span class="ident" id="3459833">sig</span>&nbsp;<span class="op" id="3459837">=</span>&nbsp;<span class="ident" id="3459839">sig</span><span class="op" id="3459842">[</span><span class="op" id="3459843">:</span><span class="num" id="3459844">2</span><span class="op" id="3459845">]</span><span class="op" id="3459846">,</span>&nbsp;<span class="ident" id="3459848">sig</span><span class="op" id="3459851">[</span><span class="num" id="3459852">2</span><span class="op" id="3459853">:</span><span class="op" id="3459854">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459858">if</span>&nbsp;<span class="ident" id="3459861">sigAndHash</span><span class="op" id="3459871">[</span><span class="num" id="3459872">1</span><span class="op" id="3459873">]</span>&nbsp;<span class="op" id="3459875">!=</span>&nbsp;<span class="ident" id="3459878">ka</span><span class="op" id="3459880">.</span><span class="ident" id="3459881">sigType</span>&nbsp;<span class="op" id="3459889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459894">return</span>&nbsp;<span class="ident" id="3459901">errServerKeyExchange</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3459924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459928">tls12HashId</span>&nbsp;<span class="op" id="3459940">=</span>&nbsp;<span class="ident" id="3459942">sigAndHash</span><span class="op" id="3459952">[</span><span class="num" id="3459953">0</span><span class="op" id="3459954">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459958">if</span>&nbsp;<span class="builtinfunc" id="3459961">len</span><span class="op" id="3459964">(</span><span class="ident" id="3459965">sig</span><span class="op" id="3459968">)</span>&nbsp;<span class="op" id="3459970">&lt;</span>&nbsp;<span class="num" id="3459972">2</span>&nbsp;<span class="op" id="3459974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459979">return</span>&nbsp;<span class="ident" id="3459986">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3460009">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3460012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460015">sigLen</span>&nbsp;<span class="op" id="3460022">:=</span>&nbsp;<span class="builtintype" id="3460025">int</span><span class="op" id="3460028">(</span><span class="ident" id="3460029">sig</span><span class="op" id="3460032">[</span><span class="num" id="3460033">0</span><span class="op" id="3460034">]</span><span class="op" id="3460035">)</span><span class="op" id="3460036">&lt;&lt;</span><span class="num" id="3460038">8</span>&nbsp;<span class="op" id="3460040">|</span>&nbsp;<span class="builtintype" id="3460042">int</span><span class="op" id="3460045">(</span><span class="ident" id="3460046">sig</span><span class="op" id="3460049">[</span><span class="num" id="3460050">1</span><span class="op" id="3460051">]</span><span class="op" id="3460052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460055">if</span>&nbsp;<span class="ident" id="3460058">sigLen</span><span class="op" id="3460064">+</span><span class="num" id="3460065">2</span>&nbsp;<span class="op" id="3460067">!=</span>&nbsp;<span class="builtinfunc" id="3460070">len</span><span class="op" id="3460073">(</span><span class="ident" id="3460074">sig</span><span class="op" id="3460077">)</span>&nbsp;<span class="op" id="3460079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460083">return</span>&nbsp;<span class="ident" id="3460090">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3460112">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460115">sig</span>&nbsp;<span class="op" id="3460119">=</span>&nbsp;<span class="ident" id="3460121">sig</span><span class="op" id="3460124">[</span><span class="num" id="3460125">2</span><span class="op" id="3460126">:</span><span class="op" id="3460127">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460131">digest</span><span class="op" id="3460137">,</span>&nbsp;<span class="ident" id="3460139">hashFunc</span><span class="op" id="3460147">,</span>&nbsp;<span class="ident" id="3460149">err</span>&nbsp;<span class="op" id="3460153">:=</span>&nbsp;<span class="ident" id="3460156">hashForServerKeyExchange</span><span class="op" id="3460180">(</span><span class="ident" id="3460181">ka</span><span class="op" id="3460183">.</span><span class="ident" id="3460184">sigType</span><span class="op" id="3460191">,</span>&nbsp;<span class="ident" id="3460193">tls12HashId</span><span class="op" id="3460204">,</span>&nbsp;<span class="ident" id="3460206">ka</span><span class="op" id="3460208">.</span><span class="ident" id="3460209">version</span><span class="op" id="3460216">,</span>&nbsp;<span class="ident" id="3460218">clientHello</span><span class="op" id="3460229">.</span><span class="ident" id="3460230">random</span><span class="op" id="3460236">,</span>&nbsp;<span class="ident" id="3460238">serverHello</span><span class="op" id="3460249">.</span><span class="ident" id="3460250">random</span><span class="op" id="3460256">,</span>&nbsp;<span class="ident" id="3460258">serverECDHParams</span><span class="op" id="3460274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460277">if</span>&nbsp;<span class="ident" id="3460280">err</span>&nbsp;<span class="op" id="3460284">!=</span>&nbsp;<span class="ident" id="3460287">nil</span>&nbsp;<span class="op" id="3460291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460295">return</span>&nbsp;<span class="ident" id="3460302">err</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3460307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460310">switch</span>&nbsp;<span class="ident" id="3460317">ka</span><span class="op" id="3460319">.</span><span class="ident" id="3460320">sigType</span>&nbsp;<span class="op" id="3460328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460331">case</span>&nbsp;<span class="ident" id="3460336">signatureECDSA</span><span class="op" id="3460350">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460354">pubKey</span><span class="op" id="3460360">,</span>&nbsp;<span class="ident" id="3460362">ok</span>&nbsp;<span class="op" id="3460365">:=</span>&nbsp;<span class="ident" id="3460368">cert</span><span class="op" id="3460372">.</span><span class="ident" id="3460373">PublicKey</span><span class="op" id="3460382">.</span><span class="op" id="3460383">(</span><span class="op" id="3460384">*</span><span class="ident" id="3460385">ecdsa</span><span class="op" id="3460390">.</span><span class="ident" id="3460391">PublicKey</span><span class="op" id="3460400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460404">if</span>&nbsp;<span class="op" id="3460407">!</span><span class="ident" id="3460408">ok</span>&nbsp;<span class="op" id="3460411">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460416">return</span>&nbsp;<span class="ident" id="3460423">errors</span><span class="op" id="3460429">.</span><span class="ident" id="3460430">New</span><span class="op" id="3460433">(</span><span class="string" id="3460434">&#34;ECDHE&nbsp;ECDSA&nbsp;requires&nbsp;a&nbsp;ECDSA&nbsp;server&nbsp;public&nbsp;key&#34;</span><span class="op" id="3460482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3460486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460490">ecdsaSig</span>&nbsp;<span class="op" id="3460499">:=</span>&nbsp;<span class="builtinfunc" id="3460502">new</span><span class="op" id="3460505">(</span><span class="ident" id="3460506">ecdsaSignature</span><span class="op" id="3460520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460524">if</span>&nbsp;<span class="ident" id="3460527">_</span><span class="op" id="3460528">,</span>&nbsp;<span class="ident" id="3460530">err</span>&nbsp;<span class="op" id="3460534">:=</span>&nbsp;<span class="ident" id="3460537">asn1</span><span class="op" id="3460541">.</span><span class="ident" id="3460542">Unmarshal</span><span class="op" id="3460551">(</span><span class="ident" id="3460552">sig</span><span class="op" id="3460555">,</span>&nbsp;<span class="ident" id="3460557">ecdsaSig</span><span class="op" id="3460565">)</span><span class="op" id="3460566">;</span>&nbsp;<span class="ident" id="3460568">err</span>&nbsp;<span class="op" id="3460572">!=</span>&nbsp;<span class="ident" id="3460575">nil</span>&nbsp;<span class="op" id="3460579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460584">return</span>&nbsp;<span class="ident" id="3460591">err</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3460597">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460601">if</span>&nbsp;<span class="ident" id="3460604">ecdsaSig</span><span class="op" id="3460612">.</span><span class="ident" id="3460613">R</span><span class="op" id="3460614">.</span><span class="ident" id="3460615">Sign</span><span class="op" id="3460619">(</span><span class="op" id="3460620">)</span>&nbsp;<span class="op" id="3460622">&lt;=</span>&nbsp;<span class="num" id="3460625">0</span>&nbsp;<span class="op" id="3460627">||</span>&nbsp;<span class="ident" id="3460630">ecdsaSig</span><span class="op" id="3460638">.</span><span class="ident" id="3460639">S</span><span class="op" id="3460640">.</span><span class="ident" id="3460641">Sign</span><span class="op" id="3460645">(</span><span class="op" id="3460646">)</span>&nbsp;<span class="op" id="3460648">&lt;=</span>&nbsp;<span class="num" id="3460651">0</span>&nbsp;<span class="op" id="3460653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460658">return</span>&nbsp;<span class="ident" id="3460665">errors</span><span class="op" id="3460671">.</span><span class="ident" id="3460672">New</span><span class="op" id="3460675">(</span><span class="string" id="3460676">&#34;ECDSA&nbsp;signature&nbsp;contained&nbsp;zero&nbsp;or&nbsp;negative&nbsp;values&#34;</span><span class="op" id="3460727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3460731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460735">if</span>&nbsp;<span class="op" id="3460738">!</span><span class="ident" id="3460739">ecdsa</span><span class="op" id="3460744">.</span><span class="ident" id="3460745">Verify</span><span class="op" id="3460751">(</span><span class="ident" id="3460752">pubKey</span><span class="op" id="3460758">,</span>&nbsp;<span class="ident" id="3460760">digest</span><span class="op" id="3460766">,</span>&nbsp;<span class="ident" id="3460768">ecdsaSig</span><span class="op" id="3460776">.</span><span class="ident" id="3460777">R</span><span class="op" id="3460778">,</span>&nbsp;<span class="ident" id="3460780">ecdsaSig</span><span class="op" id="3460788">.</span><span class="ident" id="3460789">S</span><span class="op" id="3460790">)</span>&nbsp;<span class="op" id="3460792">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460797">return</span>&nbsp;<span class="ident" id="3460804">errors</span><span class="op" id="3460810">.</span><span class="ident" id="3460811">New</span><span class="op" id="3460814">(</span><span class="string" id="3460815">&#34;ECDSA&nbsp;verification&nbsp;failure&#34;</span><span class="op" id="3460843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3460847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460850">case</span>&nbsp;<span class="ident" id="3460855">signatureRSA</span><span class="op" id="3460867">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460871">pubKey</span><span class="op" id="3460877">,</span>&nbsp;<span class="ident" id="3460879">ok</span>&nbsp;<span class="op" id="3460882">:=</span>&nbsp;<span class="ident" id="3460885">cert</span><span class="op" id="3460889">.</span><span class="ident" id="3460890">PublicKey</span><span class="op" id="3460899">.</span><span class="op" id="3460900">(</span><span class="op" id="3460901">*</span><span class="ident" id="3460902">rsa</span><span class="op" id="3460905">.</span><span class="ident" id="3460906">PublicKey</span><span class="op" id="3460915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460919">if</span>&nbsp;<span class="op" id="3460922">!</span><span class="ident" id="3460923">ok</span>&nbsp;<span class="op" id="3460926">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460931">return</span>&nbsp;<span class="ident" id="3460938">errors</span><span class="op" id="3460944">.</span><span class="ident" id="3460945">New</span><span class="op" id="3460948">(</span><span class="string" id="3460949">&#34;ECDHE&nbsp;RSA&nbsp;requires&nbsp;a&nbsp;RSA&nbsp;server&nbsp;public&nbsp;key&#34;</span><span class="op" id="3460993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3460997">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3461001">if</span>&nbsp;<span class="ident" id="3461004">err</span>&nbsp;<span class="op" id="3461008">:=</span>&nbsp;<span class="ident" id="3461011">rsa</span><span class="op" id="3461014">.</span><span class="ident" id="3461015">VerifyPKCS1v15</span><span class="op" id="3461029">(</span><span class="ident" id="3461030">pubKey</span><span class="op" id="3461036">,</span>&nbsp;<span class="ident" id="3461038">hashFunc</span><span class="op" id="3461046">,</span>&nbsp;<span class="ident" id="3461048">digest</span><span class="op" id="3461054">,</span>&nbsp;<span class="ident" id="3461056">sig</span><span class="op" id="3461059">)</span><span class="op" id="3461060">;</span>&nbsp;<span class="ident" id="3461062">err</span>&nbsp;<span class="op" id="3461066">!=</span>&nbsp;<span class="ident" id="3461069">nil</span>&nbsp;<span class="op" id="3461073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3461078">return</span>&nbsp;<span class="ident" id="3461085">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3461091">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3461094">default</span><span class="op" id="3461101">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3461105">return</span>&nbsp;<span class="ident" id="3461112">errors</span><span class="op" id="3461118">.</span><span class="ident" id="3461119">New</span><span class="op" id="3461122">(</span><span class="string" id="3461123">&#34;unknown&nbsp;ECDHE&nbsp;signature&nbsp;algorithm&#34;</span><span class="op" id="3461158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3461161">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3461165">return</span>&nbsp;<span class="ident" id="3461172">nil</span><br>
<span class="lineno">390</span><span class="op" id="3461176">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3461179">func</span>&nbsp;<span class="op" id="3461184">(</span><span class="ident" id="3461185">ka</span>&nbsp;<span class="op" id="3461188">*</span><span class="ident" id="3461189">ecdheKeyAgreement</span><span class="op" id="3461206">)</span>&nbsp;<span class="ident" id="3461208">generateClientKeyExchange</span><span class="op" id="3461233">(</span><span class="ident" id="3461234">config</span>&nbsp;<span class="op" id="3461241">*</span><span class="ident" id="3461242">Config</span><span class="op" id="3461248">,</span>&nbsp;<span class="ident" id="3461250">clientHello</span>&nbsp;<span class="op" id="3461262">*</span><span class="ident" id="3461263">clientHelloMsg</span><span class="op" id="3461277">,</span>&nbsp;<span class="ident" id="3461279">cert</span>&nbsp;<span class="op" id="3461284">*</span><span class="ident" id="3461285">x509</span><span class="op" id="3461289">.</span><span class="ident" id="3461290">Certificate</span><span class="op" id="3461301">)</span>&nbsp;<span class="op" id="3461303">(</span><span class="op" id="3461304">[</span><span class="op" id="3461305">]</span><span class="builtintype" id="3461306">byte</span><span class="op" id="3461310">,</span>&nbsp;<span class="op" id="3461312">*</span><span class="ident" id="3461313">clientKeyExchangeMsg</span><span class="op" id="3461333">,</span>&nbsp;<span class="builtintype" id="3461335">error</span><span class="op" id="3461340">)</span>&nbsp;<span class="op" id="3461342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3461345">if</span>&nbsp;<span class="ident" id="3461348">ka</span><span class="op" id="3461350">.</span><span class="ident" id="3461351">curve</span>&nbsp;<span class="op" id="3461357">==</span>&nbsp;<span class="ident" id="3461360">nil</span>&nbsp;<span class="op" id="3461364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3461368">return</span>&nbsp;<span class="ident" id="3461375">nil</span><span class="op" id="3461378">,</span>&nbsp;<span class="ident" id="3461380">nil</span><span class="op" id="3461383">,</span>&nbsp;<span class="ident" id="3461385">errors</span><span class="op" id="3461391">.</span><span class="ident" id="3461392">New</span><span class="op" id="3461395">(</span><span class="string" id="3461396">&#34;missing&nbsp;ServerKeyExchange&nbsp;message&#34;</span><span class="op" id="3461431">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3461434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3461437">priv</span><span class="op" id="3461441">,</span>&nbsp;<span class="ident" id="3461443">mx</span><span class="op" id="3461445">,</span>&nbsp;<span class="ident" id="3461447">my</span><span class="op" id="3461449">,</span>&nbsp;<span class="ident" id="3461451">err</span>&nbsp;<span class="op" id="3461455">:=</span>&nbsp;<span class="ident" id="3461458">elliptic</span><span class="op" id="3461466">.</span><span class="ident" id="3461467">GenerateKey</span><span class="op" id="3461478">(</span><span class="ident" id="3461479">ka</span><span class="op" id="3461481">.</span><span class="ident" id="3461482">curve</span><span class="op" id="3461487">,</span>&nbsp;<span class="ident" id="3461489">config</span><span class="op" id="3461495">.</span><span class="ident" id="3461496">rand</span><span class="op" id="3461500">(</span><span class="op" id="3461501">)</span><span class="op" id="3461502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3461505">if</span>&nbsp;<span class="ident" id="3461508">err</span>&nbsp;<span class="op" id="3461512">!=</span>&nbsp;<span class="ident" id="3461515">nil</span>&nbsp;<span class="op" id="3461519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3461523">return</span>&nbsp;<span class="ident" id="3461530">nil</span><span class="op" id="3461533">,</span>&nbsp;<span class="ident" id="3461535">nil</span><span class="op" id="3461538">,</span>&nbsp;<span class="ident" id="3461540">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3461545">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3461548">x</span><span class="op" id="3461549">,</span>&nbsp;<span class="ident" id="3461551">_</span>&nbsp;<span class="op" id="3461553">:=</span>&nbsp;<span class="ident" id="3461556">ka</span><span class="op" id="3461558">.</span><span class="ident" id="3461559">curve</span><span class="op" id="3461564">.</span><span class="ident" id="3461565">ScalarMult</span><span class="op" id="3461575">(</span><span class="ident" id="3461576">ka</span><span class="op" id="3461578">.</span><span class="ident" id="3461579">x</span><span class="op" id="3461580">,</span>&nbsp;<span class="ident" id="3461582">ka</span><span class="op" id="3461584">.</span><span class="ident" id="3461585">y</span><span class="op" id="3461586">,</span>&nbsp;<span class="ident" id="3461588">priv</span><span class="op" id="3461592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3461595">preMasterSecret</span>&nbsp;<span class="op" id="3461611">:=</span>&nbsp;<span class="builtinfunc" id="3461614">make</span><span class="op" id="3461618">(</span><span class="op" id="3461619">[</span><span class="op" id="3461620">]</span><span class="builtintype" id="3461621">byte</span><span class="op" id="3461625">,</span>&nbsp;<span class="op" id="3461627">(</span><span class="ident" id="3461628">ka</span><span class="op" id="3461630">.</span><span class="ident" id="3461631">curve</span><span class="op" id="3461636">.</span><span class="ident" id="3461637">Params</span><span class="op" id="3461643">(</span><span class="op" id="3461644">)</span><span class="op" id="3461645">.</span><span class="ident" id="3461646">BitSize</span><span class="op" id="3461653">+</span><span class="num" id="3461654">7</span><span class="op" id="3461655">)</span><span class="op" id="3461656">&gt;&gt;</span><span class="num" id="3461658">3</span><span class="op" id="3461659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3461662">xBytes</span>&nbsp;<span class="op" id="3461669">:=</span>&nbsp;<span class="ident" id="3461672">x</span><span class="op" id="3461673">.</span><span class="ident" id="3461674">Bytes</span><span class="op" id="3461679">(</span><span class="op" id="3461680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3461683">copy</span><span class="op" id="3461687">(</span><span class="ident" id="3461688">preMasterSecret</span><span class="op" id="3461703">[</span><span class="builtinfunc" id="3461704">len</span><span class="op" id="3461707">(</span><span class="ident" id="3461708">preMasterSecret</span><span class="op" id="3461723">)</span><span class="op" id="3461724">-</span><span class="builtinfunc" id="3461725">len</span><span class="op" id="3461728">(</span><span class="ident" id="3461729">xBytes</span><span class="op" id="3461735">)</span><span class="op" id="3461736">:</span><span class="op" id="3461737">]</span><span class="op" id="3461738">,</span>&nbsp;<span class="ident" id="3461740">xBytes</span><span class="op" id="3461746">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3461750">serialized</span>&nbsp;<span class="op" id="3461761">:=</span>&nbsp;<span class="ident" id="3461764">elliptic</span><span class="op" id="3461772">.</span><span class="ident" id="3461773">Marshal</span><span class="op" id="3461780">(</span><span class="ident" id="3461781">ka</span><span class="op" id="3461783">.</span><span class="ident" id="3461784">curve</span><span class="op" id="3461789">,</span>&nbsp;<span class="ident" id="3461791">mx</span><span class="op" id="3461793">,</span>&nbsp;<span class="ident" id="3461795">my</span><span class="op" id="3461797">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3461801">ckx</span>&nbsp;<span class="op" id="3461805">:=</span>&nbsp;<span class="builtinfunc" id="3461808">new</span><span class="op" id="3461811">(</span><span class="ident" id="3461812">clientKeyExchangeMsg</span><span class="op" id="3461832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3461835">ckx</span><span class="op" id="3461838">.</span><span class="ident" id="3461839">ciphertext</span>&nbsp;<span class="op" id="3461850">=</span>&nbsp;<span class="builtinfunc" id="3461852">make</span><span class="op" id="3461856">(</span><span class="op" id="3461857">[</span><span class="op" id="3461858">]</span><span class="builtintype" id="3461859">byte</span><span class="op" id="3461863">,</span>&nbsp;<span class="num" id="3461865">1</span><span class="op" id="3461866">+</span><span class="builtinfunc" id="3461867">len</span><span class="op" id="3461870">(</span><span class="ident" id="3461871">serialized</span><span class="op" id="3461881">)</span><span class="op" id="3461882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3461885">ckx</span><span class="op" id="3461888">.</span><span class="ident" id="3461889">ciphertext</span><span class="op" id="3461899">[</span><span class="num" id="3461900">0</span><span class="op" id="3461901">]</span>&nbsp;<span class="op" id="3461903">=</span>&nbsp;<span class="builtintype" id="3461905">byte</span><span class="op" id="3461909">(</span><span class="builtinfunc" id="3461910">len</span><span class="op" id="3461913">(</span><span class="ident" id="3461914">serialized</span><span class="op" id="3461924">)</span><span class="op" id="3461925">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3461928">copy</span><span class="op" id="3461932">(</span><span class="ident" id="3461933">ckx</span><span class="op" id="3461936">.</span><span class="ident" id="3461937">ciphertext</span><span class="op" id="3461947">[</span><span class="num" id="3461948">1</span><span class="op" id="3461949">:</span><span class="op" id="3461950">]</span><span class="op" id="3461951">,</span>&nbsp;<span class="ident" id="3461953">serialized</span><span class="op" id="3461963">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3461967">return</span>&nbsp;<span class="ident" id="3461974">preMasterSecret</span><span class="op" id="3461989">,</span>&nbsp;<span class="ident" id="3461991">ckx</span><span class="op" id="3461994">,</span>&nbsp;<span class="ident" id="3461996">nil</span><br>
<span class="lineno"></span><span class="op" id="3462000">}</span>
</div>
</body>
</html>
