<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>compress/flate</h2>
<ul>
<li><a href="/gostd/compress/flate/copy.go.html">copy.go</a></li>
<li><a href="/gostd/compress/flate/copy_test.go.html">copy_test.go</a></li>
<li><a href="/gostd/compress/flate/deflate.go.html" class="current">deflate.go</a></li>
<li><a href="/gostd/compress/flate/deflate_test.go.html">deflate_test.go</a></li>
<li><a href="/gostd/compress/flate/fixedhuff.go.html">fixedhuff.go</a></li>
<li><a href="/gostd/compress/flate/flate_test.go.html">flate_test.go</a></li>
<li><a href="/gostd/compress/flate/huffman_bit_writer.go.html">huffman_bit_writer.go</a></li>
<li><a href="/gostd/compress/flate/huffman_code.go.html">huffman_code.go</a></li>
<li><a href="/gostd/compress/flate/inflate.go.html">inflate.go</a></li>
<li><a href="/gostd/compress/flate/inflate_test.go.html">inflate_test.go</a></li>
<li><a href="/gostd/compress/flate/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/compress/flate/reverse_bits.go.html">reverse_bits.go</a></li>
<li><a href="/gostd/compress/flate/token.go.html">token.go</a></li>
<li><a href="/gostd/compress/flate/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4110128">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4110183">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4110237">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4110288">package</span>&nbsp;<span class="ident" id="4110296">flate</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4110303">import</span>&nbsp;<span class="op" id="4110310">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4110313">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4110320">&#34;io&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4110326">&#34;math&#34;</span><br>
<span class="lineno"></span><span class="op" id="4110333">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4110336">const</span>&nbsp;<span class="op" id="4110342">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4110345">NoCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4110364">=</span>&nbsp;<span class="num" id="4110366">0</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4110369">BestSpeed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4110388">=</span>&nbsp;<span class="num" id="4110390">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4110393">fastCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4110412">=</span>&nbsp;<span class="num" id="4110414">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4110417">BestCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4110436">=</span>&nbsp;<span class="num" id="4110438">9</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4110441">DefaultCompression</span>&nbsp;<span class="op" id="4110460">=</span>&nbsp;<span class="op" id="4110462">-</span><span class="num" id="4110463">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4110466">logWindowSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4110485">=</span>&nbsp;<span class="num" id="4110487">15</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4110491">windowSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4110510">=</span>&nbsp;<span class="num" id="4110512">1</span>&nbsp;<span class="op" id="4110514">&lt;&lt;</span>&nbsp;<span class="ident" id="4110517">logWindowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4110532">windowMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4110551">=</span>&nbsp;<span class="ident" id="4110553">windowSize</span>&nbsp;<span class="op" id="4110564">-</span>&nbsp;<span class="num" id="4110566">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4110569">logMaxOffsetSize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4110588">=</span>&nbsp;<span class="num" id="4110590">15</span>&nbsp;&nbsp;<span class="comment" id="4110594">//&nbsp;Standard&nbsp;DEFLATE</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4110615">minMatchLength</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4110634">=</span>&nbsp;<span class="num" id="4110636">3</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4110640">//&nbsp;The&nbsp;smallest&nbsp;match&nbsp;that&nbsp;the&nbsp;compressor&nbsp;looks&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4110693">maxMatchLength</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4110712">=</span>&nbsp;<span class="num" id="4110714">258</span>&nbsp;<span class="comment" id="4110718">//&nbsp;The&nbsp;longest&nbsp;match&nbsp;for&nbsp;the&nbsp;compressor</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4110759">minOffsetSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4110778">=</span>&nbsp;<span class="num" id="4110780">1</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4110784">//&nbsp;The&nbsp;shortest&nbsp;offset&nbsp;that&nbsp;makes&nbsp;any&nbsp;sense</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4110830">//&nbsp;The&nbsp;maximum&nbsp;number&nbsp;of&nbsp;tokens&nbsp;we&nbsp;put&nbsp;into&nbsp;a&nbsp;single&nbsp;flat&nbsp;block,&nbsp;just&nbsp;too</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4110905">//&nbsp;stop&nbsp;things&nbsp;from&nbsp;getting&nbsp;too&nbsp;large.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4110945">maxFlateBlockTokens</span>&nbsp;<span class="op" id="4110965">=</span>&nbsp;<span class="num" id="4110967">1</span>&nbsp;<span class="op" id="4110969">&lt;&lt;</span>&nbsp;<span class="num" id="4110972">14</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4110976">maxStoreBlockSize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4110996">=</span>&nbsp;<span class="num" id="4110998">65535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4111005">hashBits</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4111025">=</span>&nbsp;<span class="num" id="4111027">17</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4111031">hashSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4111051">=</span>&nbsp;<span class="num" id="4111053">1</span>&nbsp;<span class="op" id="4111055">&lt;&lt;</span>&nbsp;<span class="ident" id="4111058">hashBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4111068">hashMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4111088">=</span>&nbsp;<span class="op" id="4111090">(</span><span class="num" id="4111091">1</span>&nbsp;<span class="op" id="4111093">&lt;&lt;</span>&nbsp;<span class="ident" id="4111096">hashBits</span><span class="op" id="4111104">)</span>&nbsp;<span class="op" id="4111106">-</span>&nbsp;<span class="num" id="4111108">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4111111">hashShift</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4111131">=</span>&nbsp;<span class="op" id="4111133">(</span><span class="ident" id="4111134">hashBits</span>&nbsp;<span class="op" id="4111143">+</span>&nbsp;<span class="ident" id="4111145">minMatchLength</span>&nbsp;<span class="op" id="4111160">-</span>&nbsp;<span class="num" id="4111162">1</span><span class="op" id="4111163">)</span>&nbsp;<span class="op" id="4111165">/</span>&nbsp;<span class="ident" id="4111167">minMatchLength</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4111183">maxHashOffset</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4111203">=</span>&nbsp;<span class="num" id="4111205">1</span>&nbsp;<span class="op" id="4111207">&lt;&lt;</span>&nbsp;<span class="num" id="4111210">24</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4111215">skipNever</span>&nbsp;<span class="op" id="4111225">=</span>&nbsp;<span class="ident" id="4111227">math</span><span class="op" id="4111231">.</span><span class="ident" id="4111232">MaxInt32</span><br>
<span class="lineno"></span><span class="op" id="4111241">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="4111244">type</span>&nbsp;<span class="ident" id="4111249">compressionLevel</span>&nbsp;<span class="keyword" id="4111266">struct</span>&nbsp;<span class="op" id="4111273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4111276">good</span><span class="op" id="4111280">,</span>&nbsp;<span class="ident" id="4111282">lazy</span><span class="op" id="4111286">,</span>&nbsp;<span class="ident" id="4111288">nice</span><span class="op" id="4111292">,</span>&nbsp;<span class="ident" id="4111294">chain</span><span class="op" id="4111299">,</span>&nbsp;<span class="ident" id="4111301">fastSkipHashing</span>&nbsp;<span class="builtintype" id="4111317">int</span><br>
<span class="lineno"></span><span class="op" id="4111321">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4111324">var</span>&nbsp;<span class="ident" id="4111328">levels</span>&nbsp;<span class="op" id="4111335">=</span>&nbsp;<span class="op" id="4111337">[</span><span class="op" id="4111338">]</span><span class="ident" id="4111339">compressionLevel</span><span class="op" id="4111355">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4111358">{</span><span class="op" id="4111359">}</span><span class="op" id="4111360">,</span>&nbsp;<span class="comment" id="4111362">//&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4111368">//&nbsp;For&nbsp;levels&nbsp;1-3&nbsp;we&nbsp;don&#39;t&nbsp;bother&nbsp;trying&nbsp;with&nbsp;lazy&nbsp;matches</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4111428">{</span><span class="num" id="4111429">3</span><span class="op" id="4111430">,</span>&nbsp;<span class="num" id="4111432">0</span><span class="op" id="4111433">,</span>&nbsp;<span class="num" id="4111435">8</span><span class="op" id="4111436">,</span>&nbsp;<span class="num" id="4111438">4</span><span class="op" id="4111439">,</span>&nbsp;<span class="num" id="4111441">4</span><span class="op" id="4111442">}</span><span class="op" id="4111443">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4111446">{</span><span class="num" id="4111447">3</span><span class="op" id="4111448">,</span>&nbsp;<span class="num" id="4111450">0</span><span class="op" id="4111451">,</span>&nbsp;<span class="num" id="4111453">16</span><span class="op" id="4111455">,</span>&nbsp;<span class="num" id="4111457">8</span><span class="op" id="4111458">,</span>&nbsp;<span class="num" id="4111460">5</span><span class="op" id="4111461">}</span><span class="op" id="4111462">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4111465">{</span><span class="num" id="4111466">3</span><span class="op" id="4111467">,</span>&nbsp;<span class="num" id="4111469">0</span><span class="op" id="4111470">,</span>&nbsp;<span class="num" id="4111472">32</span><span class="op" id="4111474">,</span>&nbsp;<span class="num" id="4111476">32</span><span class="op" id="4111478">,</span>&nbsp;<span class="num" id="4111480">6</span><span class="op" id="4111481">}</span><span class="op" id="4111482">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4111485">//&nbsp;Levels&nbsp;4-9&nbsp;use&nbsp;increasingly&nbsp;more&nbsp;lazy&nbsp;matching</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4111536">//&nbsp;and&nbsp;increasingly&nbsp;stringent&nbsp;conditions&nbsp;for&nbsp;&#34;good&nbsp;enough&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4111597">{</span><span class="num" id="4111598">4</span><span class="op" id="4111599">,</span>&nbsp;<span class="num" id="4111601">4</span><span class="op" id="4111602">,</span>&nbsp;<span class="num" id="4111604">16</span><span class="op" id="4111606">,</span>&nbsp;<span class="num" id="4111608">16</span><span class="op" id="4111610">,</span>&nbsp;<span class="ident" id="4111612">skipNever</span><span class="op" id="4111621">}</span><span class="op" id="4111622">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4111625">{</span><span class="num" id="4111626">8</span><span class="op" id="4111627">,</span>&nbsp;<span class="num" id="4111629">16</span><span class="op" id="4111631">,</span>&nbsp;<span class="num" id="4111633">32</span><span class="op" id="4111635">,</span>&nbsp;<span class="num" id="4111637">32</span><span class="op" id="4111639">,</span>&nbsp;<span class="ident" id="4111641">skipNever</span><span class="op" id="4111650">}</span><span class="op" id="4111651">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4111654">{</span><span class="num" id="4111655">8</span><span class="op" id="4111656">,</span>&nbsp;<span class="num" id="4111658">16</span><span class="op" id="4111660">,</span>&nbsp;<span class="num" id="4111662">128</span><span class="op" id="4111665">,</span>&nbsp;<span class="num" id="4111667">128</span><span class="op" id="4111670">,</span>&nbsp;<span class="ident" id="4111672">skipNever</span><span class="op" id="4111681">}</span><span class="op" id="4111682">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4111685">{</span><span class="num" id="4111686">8</span><span class="op" id="4111687">,</span>&nbsp;<span class="num" id="4111689">32</span><span class="op" id="4111691">,</span>&nbsp;<span class="num" id="4111693">128</span><span class="op" id="4111696">,</span>&nbsp;<span class="num" id="4111698">256</span><span class="op" id="4111701">,</span>&nbsp;<span class="ident" id="4111703">skipNever</span><span class="op" id="4111712">}</span><span class="op" id="4111713">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4111716">{</span><span class="num" id="4111717">32</span><span class="op" id="4111719">,</span>&nbsp;<span class="num" id="4111721">128</span><span class="op" id="4111724">,</span>&nbsp;<span class="num" id="4111726">258</span><span class="op" id="4111729">,</span>&nbsp;<span class="num" id="4111731">1024</span><span class="op" id="4111735">,</span>&nbsp;<span class="ident" id="4111737">skipNever</span><span class="op" id="4111746">}</span><span class="op" id="4111747">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4111750">{</span><span class="num" id="4111751">32</span><span class="op" id="4111753">,</span>&nbsp;<span class="num" id="4111755">258</span><span class="op" id="4111758">,</span>&nbsp;<span class="num" id="4111760">258</span><span class="op" id="4111763">,</span>&nbsp;<span class="num" id="4111765">4096</span><span class="op" id="4111769">,</span>&nbsp;<span class="ident" id="4111771">skipNever</span><span class="op" id="4111780">}</span><span class="op" id="4111781">,</span><br>
<span class="lineno"></span><span class="op" id="4111783">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="4111786">type</span>&nbsp;<span class="ident" id="4111791">compressor</span>&nbsp;<span class="keyword" id="4111802">struct</span>&nbsp;<span class="op" id="4111809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4111812">compressionLevel</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4111831">w</span>&nbsp;<span class="op" id="4111833">*</span><span class="ident" id="4111834">huffmanBitWriter</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4111853">//&nbsp;compression&nbsp;algorithm</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4111879">fill</span>&nbsp;<span class="keyword" id="4111884">func</span><span class="op" id="4111888">(</span><span class="op" id="4111889">*</span><span class="ident" id="4111890">compressor</span><span class="op" id="4111900">,</span>&nbsp;<span class="op" id="4111902">[</span><span class="op" id="4111903">]</span><span class="builtintype" id="4111904">byte</span><span class="op" id="4111908">)</span>&nbsp;<span class="builtintype" id="4111910">int</span>&nbsp;<span class="comment" id="4111914">//&nbsp;copy&nbsp;data&nbsp;to&nbsp;window</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4111938">step</span>&nbsp;<span class="keyword" id="4111943">func</span><span class="op" id="4111947">(</span><span class="op" id="4111948">*</span><span class="ident" id="4111949">compressor</span><span class="op" id="4111959">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4111973">//&nbsp;process&nbsp;window</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4111992">sync</span>&nbsp;<span class="builtintype" id="4111997">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4112027">//&nbsp;requesting&nbsp;flush</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4112049">//&nbsp;Input&nbsp;hash&nbsp;chains</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4112071">//&nbsp;hashHead[hashValue]&nbsp;contains&nbsp;the&nbsp;largest&nbsp;inputIndex&nbsp;with&nbsp;the&nbsp;specified&nbsp;hash&nbsp;value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4112157">//&nbsp;If&nbsp;hashHead[hashValue]&nbsp;is&nbsp;within&nbsp;the&nbsp;current&nbsp;window,&nbsp;then</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4112219">//&nbsp;hashPrev[hashHead[hashValue]&nbsp;&amp;&nbsp;windowMask]&nbsp;contains&nbsp;the&nbsp;previous&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4112294">//&nbsp;with&nbsp;the&nbsp;same&nbsp;hash&nbsp;value.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4112324">chainHead</span>&nbsp;&nbsp;<span class="builtintype" id="4112335">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4112340">hashHead</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4112351">[</span><span class="op" id="4112352">]</span><span class="builtintype" id="4112353">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4112358">hashPrev</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4112369">[</span><span class="op" id="4112370">]</span><span class="builtintype" id="4112371">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4112376">hashOffset</span>&nbsp;<span class="builtintype" id="4112387">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4112393">//&nbsp;input&nbsp;window:&nbsp;unprocessed&nbsp;data&nbsp;is&nbsp;window[index:windowEnd]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4112455">index</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4112469">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4112474">window</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4112488">[</span><span class="op" id="4112489">]</span><span class="builtintype" id="4112490">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4112496">windowEnd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4112510">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4112515">blockStart</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4112529">int</span>&nbsp;&nbsp;<span class="comment" id="4112534">//&nbsp;window&nbsp;index&nbsp;where&nbsp;current&nbsp;tokens&nbsp;start</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4112578">byteAvailable</span>&nbsp;<span class="builtintype" id="4112592">bool</span>&nbsp;<span class="comment" id="4112597">//&nbsp;if&nbsp;true,&nbsp;still&nbsp;need&nbsp;to&nbsp;process&nbsp;window[index-1].</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4112650">//&nbsp;queued&nbsp;output&nbsp;tokens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4112675">tokens</span>&nbsp;<span class="op" id="4112682">[</span><span class="op" id="4112683">]</span><span class="ident" id="4112684">token</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4112692">//&nbsp;deflate&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4112710">length</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4112725">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4112730">offset</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4112745">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4112750">hash</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4112765">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4112770">maxInsertIndex</span>&nbsp;<span class="builtintype" id="4112785">int</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4112790">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4112805">error</span><br>
<span class="lineno"></span><span class="op" id="4112811">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4112814">func</span>&nbsp;<span class="op" id="4112819">(</span><span class="ident" id="4112820">d</span>&nbsp;<span class="op" id="4112822">*</span><span class="ident" id="4112823">compressor</span><span class="op" id="4112833">)</span>&nbsp;<span class="ident" id="4112835">fillDeflate</span><span class="op" id="4112846">(</span><span class="ident" id="4112847">b</span>&nbsp;<span class="op" id="4112849">[</span><span class="op" id="4112850">]</span><span class="builtintype" id="4112851">byte</span><span class="op" id="4112855">)</span>&nbsp;<span class="builtintype" id="4112857">int</span>&nbsp;<span class="op" id="4112861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4112864">if</span>&nbsp;<span class="ident" id="4112867">d</span><span class="op" id="4112868">.</span><span class="ident" id="4112869">index</span>&nbsp;<span class="op" id="4112875">&gt;=</span>&nbsp;<span class="num" id="4112878">2</span><span class="op" id="4112879">*</span><span class="ident" id="4112880">windowSize</span><span class="op" id="4112890">-</span><span class="op" id="4112891">(</span><span class="ident" id="4112892">minMatchLength</span><span class="op" id="4112906">+</span><span class="ident" id="4112907">maxMatchLength</span><span class="op" id="4112921">)</span>&nbsp;<span class="op" id="4112923">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4112927">//&nbsp;shift&nbsp;the&nbsp;window&nbsp;by&nbsp;windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4112963">copy</span><span class="op" id="4112967">(</span><span class="ident" id="4112968">d</span><span class="op" id="4112969">.</span><span class="ident" id="4112970">window</span><span class="op" id="4112976">,</span>&nbsp;<span class="ident" id="4112978">d</span><span class="op" id="4112979">.</span><span class="ident" id="4112980">window</span><span class="op" id="4112986">[</span><span class="ident" id="4112987">windowSize</span><span class="op" id="4112997">:</span><span class="num" id="4112998">2</span><span class="op" id="4112999">*</span><span class="ident" id="4113000">windowSize</span><span class="op" id="4113010">]</span><span class="op" id="4113011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4113015">d</span><span class="op" id="4113016">.</span><span class="ident" id="4113017">index</span>&nbsp;<span class="op" id="4113023">-=</span>&nbsp;<span class="ident" id="4113026">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4113039">d</span><span class="op" id="4113040">.</span><span class="ident" id="4113041">windowEnd</span>&nbsp;<span class="op" id="4113051">-=</span>&nbsp;<span class="ident" id="4113054">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4113067">if</span>&nbsp;<span class="ident" id="4113070">d</span><span class="op" id="4113071">.</span><span class="ident" id="4113072">blockStart</span>&nbsp;<span class="op" id="4113083">&gt;=</span>&nbsp;<span class="ident" id="4113086">windowSize</span>&nbsp;<span class="op" id="4113097">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4113102">d</span><span class="op" id="4113103">.</span><span class="ident" id="4113104">blockStart</span>&nbsp;<span class="op" id="4113115">-=</span>&nbsp;<span class="ident" id="4113118">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4113131">}</span>&nbsp;<span class="keyword" id="4113133">else</span>&nbsp;<span class="op" id="4113138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4113143">d</span><span class="op" id="4113144">.</span><span class="ident" id="4113145">blockStart</span>&nbsp;<span class="op" id="4113156">=</span>&nbsp;<span class="ident" id="4113158">math</span><span class="op" id="4113162">.</span><span class="ident" id="4113163">MaxInt32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4113174">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4113178">d</span><span class="op" id="4113179">.</span><span class="ident" id="4113180">hashOffset</span>&nbsp;<span class="op" id="4113191">+=</span>&nbsp;<span class="ident" id="4113194">windowSize</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4113207">if</span>&nbsp;<span class="ident" id="4113210">d</span><span class="op" id="4113211">.</span><span class="ident" id="4113212">hashOffset</span>&nbsp;<span class="op" id="4113223">&gt;</span>&nbsp;<span class="ident" id="4113225">maxHashOffset</span>&nbsp;<span class="op" id="4113239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4113244">delta</span>&nbsp;<span class="op" id="4113250">:=</span>&nbsp;<span class="ident" id="4113253">d</span><span class="op" id="4113254">.</span><span class="ident" id="4113255">hashOffset</span>&nbsp;<span class="op" id="4113266">-</span>&nbsp;<span class="num" id="4113268">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4113273">d</span><span class="op" id="4113274">.</span><span class="ident" id="4113275">hashOffset</span>&nbsp;<span class="op" id="4113286">-=</span>&nbsp;<span class="ident" id="4113289">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4113298">d</span><span class="op" id="4113299">.</span><span class="ident" id="4113300">chainHead</span>&nbsp;<span class="op" id="4113310">-=</span>&nbsp;<span class="ident" id="4113313">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4113322">for</span>&nbsp;<span class="ident" id="4113326">i</span><span class="op" id="4113327">,</span>&nbsp;<span class="ident" id="4113329">v</span>&nbsp;<span class="op" id="4113331">:=</span>&nbsp;<span class="keyword" id="4113334">range</span>&nbsp;<span class="ident" id="4113340">d</span><span class="op" id="4113341">.</span><span class="ident" id="4113342">hashPrev</span>&nbsp;<span class="op" id="4113351">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4113357">if</span>&nbsp;<span class="ident" id="4113360">v</span>&nbsp;<span class="op" id="4113362">&gt;</span>&nbsp;<span class="ident" id="4113364">delta</span>&nbsp;<span class="op" id="4113370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4113377">d</span><span class="op" id="4113378">.</span><span class="ident" id="4113379">hashPrev</span><span class="op" id="4113387">[</span><span class="ident" id="4113388">i</span><span class="op" id="4113389">]</span>&nbsp;<span class="op" id="4113391">-=</span>&nbsp;<span class="ident" id="4113394">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4113404">}</span>&nbsp;<span class="keyword" id="4113406">else</span>&nbsp;<span class="op" id="4113411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4113418">d</span><span class="op" id="4113419">.</span><span class="ident" id="4113420">hashPrev</span><span class="op" id="4113428">[</span><span class="ident" id="4113429">i</span><span class="op" id="4113430">]</span>&nbsp;<span class="op" id="4113432">=</span>&nbsp;<span class="num" id="4113434">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4113440">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4113445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4113450">for</span>&nbsp;<span class="ident" id="4113454">i</span><span class="op" id="4113455">,</span>&nbsp;<span class="ident" id="4113457">v</span>&nbsp;<span class="op" id="4113459">:=</span>&nbsp;<span class="keyword" id="4113462">range</span>&nbsp;<span class="ident" id="4113468">d</span><span class="op" id="4113469">.</span><span class="ident" id="4113470">hashHead</span>&nbsp;<span class="op" id="4113479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4113485">if</span>&nbsp;<span class="ident" id="4113488">v</span>&nbsp;<span class="op" id="4113490">&gt;</span>&nbsp;<span class="ident" id="4113492">delta</span>&nbsp;<span class="op" id="4113498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4113505">d</span><span class="op" id="4113506">.</span><span class="ident" id="4113507">hashHead</span><span class="op" id="4113515">[</span><span class="ident" id="4113516">i</span><span class="op" id="4113517">]</span>&nbsp;<span class="op" id="4113519">-=</span>&nbsp;<span class="ident" id="4113522">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4113532">}</span>&nbsp;<span class="keyword" id="4113534">else</span>&nbsp;<span class="op" id="4113539">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4113546">d</span><span class="op" id="4113547">.</span><span class="ident" id="4113548">hashHead</span><span class="op" id="4113556">[</span><span class="ident" id="4113557">i</span><span class="op" id="4113558">]</span>&nbsp;<span class="op" id="4113560">=</span>&nbsp;<span class="num" id="4113562">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4113568">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4113573">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4113577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4113580">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4113583">n</span>&nbsp;<span class="op" id="4113585">:=</span>&nbsp;<span class="builtinfunc" id="4113588">copy</span><span class="op" id="4113592">(</span><span class="ident" id="4113593">d</span><span class="op" id="4113594">.</span><span class="ident" id="4113595">window</span><span class="op" id="4113601">[</span><span class="ident" id="4113602">d</span><span class="op" id="4113603">.</span><span class="ident" id="4113604">windowEnd</span><span class="op" id="4113613">:</span><span class="op" id="4113614">]</span><span class="op" id="4113615">,</span>&nbsp;<span class="ident" id="4113617">b</span><span class="op" id="4113618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4113621">d</span><span class="op" id="4113622">.</span><span class="ident" id="4113623">windowEnd</span>&nbsp;<span class="op" id="4113633">+=</span>&nbsp;<span class="ident" id="4113636">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4113639">return</span>&nbsp;<span class="ident" id="4113646">n</span><br>
<span class="lineno"></span><span class="op" id="4113648">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="keyword" id="4113651">func</span>&nbsp;<span class="op" id="4113656">(</span><span class="ident" id="4113657">d</span>&nbsp;<span class="op" id="4113659">*</span><span class="ident" id="4113660">compressor</span><span class="op" id="4113670">)</span>&nbsp;<span class="ident" id="4113672">writeBlock</span><span class="op" id="4113682">(</span><span class="ident" id="4113683">tokens</span>&nbsp;<span class="op" id="4113690">[</span><span class="op" id="4113691">]</span><span class="ident" id="4113692">token</span><span class="op" id="4113697">,</span>&nbsp;<span class="ident" id="4113699">index</span>&nbsp;<span class="builtintype" id="4113705">int</span><span class="op" id="4113708">,</span>&nbsp;<span class="ident" id="4113710">eof</span>&nbsp;<span class="builtintype" id="4113714">bool</span><span class="op" id="4113718">)</span>&nbsp;<span class="builtintype" id="4113720">error</span>&nbsp;<span class="op" id="4113726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4113729">if</span>&nbsp;<span class="ident" id="4113732">index</span>&nbsp;<span class="op" id="4113738">&gt;</span>&nbsp;<span class="num" id="4113740">0</span>&nbsp;<span class="op" id="4113742">||</span>&nbsp;<span class="ident" id="4113745">eof</span>&nbsp;<span class="op" id="4113749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4113753">var</span>&nbsp;<span class="ident" id="4113757">window</span>&nbsp;<span class="op" id="4113764">[</span><span class="op" id="4113765">]</span><span class="builtintype" id="4113766">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4113773">if</span>&nbsp;<span class="ident" id="4113776">d</span><span class="op" id="4113777">.</span><span class="ident" id="4113778">blockStart</span>&nbsp;<span class="op" id="4113789">&lt;=</span>&nbsp;<span class="ident" id="4113792">index</span>&nbsp;<span class="op" id="4113798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4113803">window</span>&nbsp;<span class="op" id="4113810">=</span>&nbsp;<span class="ident" id="4113812">d</span><span class="op" id="4113813">.</span><span class="ident" id="4113814">window</span><span class="op" id="4113820">[</span><span class="ident" id="4113821">d</span><span class="op" id="4113822">.</span><span class="ident" id="4113823">blockStart</span><span class="op" id="4113833">:</span><span class="ident" id="4113834">index</span><span class="op" id="4113839">]</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4113843">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4113847">d</span><span class="op" id="4113848">.</span><span class="ident" id="4113849">blockStart</span>&nbsp;<span class="op" id="4113860">=</span>&nbsp;<span class="ident" id="4113862">index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4113870">d</span><span class="op" id="4113871">.</span><span class="ident" id="4113872">w</span><span class="op" id="4113873">.</span><span class="ident" id="4113874">writeBlock</span><span class="op" id="4113884">(</span><span class="ident" id="4113885">tokens</span><span class="op" id="4113891">,</span>&nbsp;<span class="ident" id="4113893">eof</span><span class="op" id="4113896">,</span>&nbsp;<span class="ident" id="4113898">window</span><span class="op" id="4113904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4113908">return</span>&nbsp;<span class="ident" id="4113915">d</span><span class="op" id="4113916">.</span><span class="ident" id="4113917">w</span><span class="op" id="4113918">.</span><span class="ident" id="4113919">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4113924">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4113927">return</span>&nbsp;<span class="ident" id="4113934">nil</span><br>
<span class="lineno"></span><span class="op" id="4113938">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4113941">//&nbsp;Try&nbsp;to&nbsp;find&nbsp;a&nbsp;match&nbsp;starting&nbsp;at&nbsp;index&nbsp;whose&nbsp;length&nbsp;is&nbsp;greater&nbsp;than&nbsp;prevSize.</span><br>
<span class="lineno"></span><span class="comment" id="4114021">//&nbsp;We&nbsp;only&nbsp;look&nbsp;at&nbsp;chainCount&nbsp;possibilities&nbsp;before&nbsp;giving&nbsp;up.</span><br>
<span class="lineno">150</span><span class="keyword" id="4114083">func</span>&nbsp;<span class="op" id="4114088">(</span><span class="ident" id="4114089">d</span>&nbsp;<span class="op" id="4114091">*</span><span class="ident" id="4114092">compressor</span><span class="op" id="4114102">)</span>&nbsp;<span class="ident" id="4114104">findMatch</span><span class="op" id="4114113">(</span><span class="ident" id="4114114">pos</span>&nbsp;<span class="builtintype" id="4114118">int</span><span class="op" id="4114121">,</span>&nbsp;<span class="ident" id="4114123">prevHead</span>&nbsp;<span class="builtintype" id="4114132">int</span><span class="op" id="4114135">,</span>&nbsp;<span class="ident" id="4114137">prevLength</span>&nbsp;<span class="builtintype" id="4114148">int</span><span class="op" id="4114151">,</span>&nbsp;<span class="ident" id="4114153">lookahead</span>&nbsp;<span class="builtintype" id="4114163">int</span><span class="op" id="4114166">)</span>&nbsp;<span class="op" id="4114168">(</span><span class="ident" id="4114169">length</span><span class="op" id="4114175">,</span>&nbsp;<span class="ident" id="4114177">offset</span>&nbsp;<span class="builtintype" id="4114184">int</span><span class="op" id="4114187">,</span>&nbsp;<span class="ident" id="4114189">ok</span>&nbsp;<span class="builtintype" id="4114192">bool</span><span class="op" id="4114196">)</span>&nbsp;<span class="op" id="4114198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4114201">minMatchLook</span>&nbsp;<span class="op" id="4114214">:=</span>&nbsp;<span class="ident" id="4114217">maxMatchLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4114233">if</span>&nbsp;<span class="ident" id="4114236">lookahead</span>&nbsp;<span class="op" id="4114246">&lt;</span>&nbsp;<span class="ident" id="4114248">minMatchLook</span>&nbsp;<span class="op" id="4114261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4114265">minMatchLook</span>&nbsp;<span class="op" id="4114278">=</span>&nbsp;<span class="ident" id="4114280">lookahead</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4114291">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4114295">win</span>&nbsp;<span class="op" id="4114299">:=</span>&nbsp;<span class="ident" id="4114302">d</span><span class="op" id="4114303">.</span><span class="ident" id="4114304">window</span><span class="op" id="4114310">[</span><span class="num" id="4114311">0</span>&nbsp;<span class="op" id="4114313">:</span>&nbsp;<span class="ident" id="4114315">pos</span><span class="op" id="4114318">+</span><span class="ident" id="4114319">minMatchLook</span><span class="op" id="4114331">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4114335">//&nbsp;We&nbsp;quit&nbsp;when&nbsp;we&nbsp;get&nbsp;a&nbsp;match&nbsp;that&#39;s&nbsp;at&nbsp;least&nbsp;nice&nbsp;long</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4114393">nice</span>&nbsp;<span class="op" id="4114398">:=</span>&nbsp;<span class="builtinfunc" id="4114401">len</span><span class="op" id="4114404">(</span><span class="ident" id="4114405">win</span><span class="op" id="4114408">)</span>&nbsp;<span class="op" id="4114410">-</span>&nbsp;<span class="ident" id="4114412">pos</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4114417">if</span>&nbsp;<span class="ident" id="4114420">d</span><span class="op" id="4114421">.</span><span class="ident" id="4114422">nice</span>&nbsp;<span class="op" id="4114427">&lt;</span>&nbsp;<span class="ident" id="4114429">nice</span>&nbsp;<span class="op" id="4114434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4114438">nice</span>&nbsp;<span class="op" id="4114443">=</span>&nbsp;<span class="ident" id="4114445">d</span><span class="op" id="4114446">.</span><span class="ident" id="4114447">nice</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4114453">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4114457">//&nbsp;If&nbsp;we&#39;ve&nbsp;got&nbsp;a&nbsp;match&nbsp;that&#39;s&nbsp;good&nbsp;enough,&nbsp;only&nbsp;look&nbsp;in&nbsp;1/4&nbsp;the&nbsp;chain.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4114530">tries</span>&nbsp;<span class="op" id="4114536">:=</span>&nbsp;<span class="ident" id="4114539">d</span><span class="op" id="4114540">.</span><span class="ident" id="4114541">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4114548">length</span>&nbsp;<span class="op" id="4114555">=</span>&nbsp;<span class="ident" id="4114557">prevLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4114569">if</span>&nbsp;<span class="ident" id="4114572">length</span>&nbsp;<span class="op" id="4114579">&gt;=</span>&nbsp;<span class="ident" id="4114582">d</span><span class="op" id="4114583">.</span><span class="ident" id="4114584">good</span>&nbsp;<span class="op" id="4114589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4114593">tries</span>&nbsp;<span class="op" id="4114599">&gt;&gt;=</span>&nbsp;<span class="num" id="4114603">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4114606">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4114610">w0</span>&nbsp;<span class="op" id="4114613">:=</span>&nbsp;<span class="ident" id="4114616">win</span><span class="op" id="4114619">[</span><span class="ident" id="4114620">pos</span><span class="op" id="4114623">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4114626">w1</span>&nbsp;<span class="op" id="4114629">:=</span>&nbsp;<span class="ident" id="4114632">win</span><span class="op" id="4114635">[</span><span class="ident" id="4114636">pos</span><span class="op" id="4114639">+</span><span class="num" id="4114640">1</span><span class="op" id="4114641">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4114644">wEnd</span>&nbsp;<span class="op" id="4114649">:=</span>&nbsp;<span class="ident" id="4114652">win</span><span class="op" id="4114655">[</span><span class="ident" id="4114656">pos</span><span class="op" id="4114659">+</span><span class="ident" id="4114660">length</span><span class="op" id="4114666">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4114669">minIndex</span>&nbsp;<span class="op" id="4114678">:=</span>&nbsp;<span class="ident" id="4114681">pos</span>&nbsp;<span class="op" id="4114685">-</span>&nbsp;<span class="ident" id="4114687">windowSize</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4114700">for</span>&nbsp;<span class="ident" id="4114704">i</span>&nbsp;<span class="op" id="4114706">:=</span>&nbsp;<span class="ident" id="4114709">prevHead</span><span class="op" id="4114717">;</span>&nbsp;<span class="ident" id="4114719">tries</span>&nbsp;<span class="op" id="4114725">&gt;</span>&nbsp;<span class="num" id="4114727">0</span><span class="op" id="4114728">;</span>&nbsp;<span class="ident" id="4114730">tries</span><span class="op" id="4114735">--</span>&nbsp;<span class="op" id="4114738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4114742">if</span>&nbsp;<span class="ident" id="4114745">w0</span>&nbsp;<span class="op" id="4114748">==</span>&nbsp;<span class="ident" id="4114751">win</span><span class="op" id="4114754">[</span><span class="ident" id="4114755">i</span><span class="op" id="4114756">]</span>&nbsp;<span class="op" id="4114758">&amp;&amp;</span>&nbsp;<span class="ident" id="4114761">w1</span>&nbsp;<span class="op" id="4114764">==</span>&nbsp;<span class="ident" id="4114767">win</span><span class="op" id="4114770">[</span><span class="ident" id="4114771">i</span><span class="op" id="4114772">+</span><span class="num" id="4114773">1</span><span class="op" id="4114774">]</span>&nbsp;<span class="op" id="4114776">&amp;&amp;</span>&nbsp;<span class="ident" id="4114779">wEnd</span>&nbsp;<span class="op" id="4114784">==</span>&nbsp;<span class="ident" id="4114787">win</span><span class="op" id="4114790">[</span><span class="ident" id="4114791">i</span><span class="op" id="4114792">+</span><span class="ident" id="4114793">length</span><span class="op" id="4114799">]</span>&nbsp;<span class="op" id="4114801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4114806">//&nbsp;The&nbsp;hash&nbsp;function&nbsp;ensures&nbsp;that&nbsp;if&nbsp;win[i]&nbsp;and&nbsp;win[i+1]&nbsp;match,&nbsp;win[i+2]&nbsp;matches</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4114891">n</span>&nbsp;<span class="op" id="4114893">:=</span>&nbsp;<span class="num" id="4114896">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4114901">for</span>&nbsp;<span class="ident" id="4114905">pos</span><span class="op" id="4114908">+</span><span class="ident" id="4114909">n</span>&nbsp;<span class="op" id="4114911">&lt;</span>&nbsp;<span class="builtinfunc" id="4114913">len</span><span class="op" id="4114916">(</span><span class="ident" id="4114917">win</span><span class="op" id="4114920">)</span>&nbsp;<span class="op" id="4114922">&amp;&amp;</span>&nbsp;<span class="ident" id="4114925">win</span><span class="op" id="4114928">[</span><span class="ident" id="4114929">i</span><span class="op" id="4114930">+</span><span class="ident" id="4114931">n</span><span class="op" id="4114932">]</span>&nbsp;<span class="op" id="4114934">==</span>&nbsp;<span class="ident" id="4114937">win</span><span class="op" id="4114940">[</span><span class="ident" id="4114941">pos</span><span class="op" id="4114944">+</span><span class="ident" id="4114945">n</span><span class="op" id="4114946">]</span>&nbsp;<span class="op" id="4114948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4114954">n</span><span class="op" id="4114955">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4114961">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4114966">if</span>&nbsp;<span class="ident" id="4114969">n</span>&nbsp;<span class="op" id="4114971">&gt;</span>&nbsp;<span class="ident" id="4114973">length</span>&nbsp;<span class="op" id="4114980">&amp;&amp;</span>&nbsp;<span class="op" id="4114983">(</span><span class="ident" id="4114984">n</span>&nbsp;<span class="op" id="4114986">&gt;</span>&nbsp;<span class="num" id="4114988">3</span>&nbsp;<span class="op" id="4114990">||</span>&nbsp;<span class="ident" id="4114993">pos</span><span class="op" id="4114996">-</span><span class="ident" id="4114997">i</span>&nbsp;<span class="op" id="4114999">&lt;=</span>&nbsp;<span class="num" id="4115002">4096</span><span class="op" id="4115006">)</span>&nbsp;<span class="op" id="4115008">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4115014">length</span>&nbsp;<span class="op" id="4115021">=</span>&nbsp;<span class="ident" id="4115023">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4115029">offset</span>&nbsp;<span class="op" id="4115036">=</span>&nbsp;<span class="ident" id="4115038">pos</span>&nbsp;<span class="op" id="4115042">-</span>&nbsp;<span class="ident" id="4115044">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4115050">ok</span>&nbsp;<span class="op" id="4115053">=</span>&nbsp;<span class="builtintype" id="4115055">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4115064">if</span>&nbsp;<span class="ident" id="4115067">n</span>&nbsp;<span class="op" id="4115069">&gt;=</span>&nbsp;<span class="ident" id="4115072">nice</span>&nbsp;<span class="op" id="4115077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4115084">//&nbsp;The&nbsp;match&nbsp;is&nbsp;good&nbsp;enough&nbsp;that&nbsp;we&nbsp;don&#39;t&nbsp;try&nbsp;to&nbsp;find&nbsp;a&nbsp;better&nbsp;one.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4115157">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4115167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4115173">wEnd</span>&nbsp;<span class="op" id="4115178">=</span>&nbsp;<span class="ident" id="4115180">win</span><span class="op" id="4115183">[</span><span class="ident" id="4115184">pos</span><span class="op" id="4115187">+</span><span class="ident" id="4115188">n</span><span class="op" id="4115189">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4115194">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4115198">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4115202">if</span>&nbsp;<span class="ident" id="4115205">i</span>&nbsp;<span class="op" id="4115207">==</span>&nbsp;<span class="ident" id="4115210">minIndex</span>&nbsp;<span class="op" id="4115219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4115224">//&nbsp;hashPrev[i&nbsp;&amp;&nbsp;windowMask]&nbsp;has&nbsp;already&nbsp;been&nbsp;overwritten,&nbsp;so&nbsp;stop&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4115298">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4115306">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4115310">if</span>&nbsp;<span class="ident" id="4115313">i</span>&nbsp;<span class="op" id="4115315">=</span>&nbsp;<span class="ident" id="4115317">d</span><span class="op" id="4115318">.</span><span class="ident" id="4115319">hashPrev</span><span class="op" id="4115327">[</span><span class="ident" id="4115328">i</span><span class="op" id="4115329">&amp;</span><span class="ident" id="4115330">windowMask</span><span class="op" id="4115340">]</span>&nbsp;<span class="op" id="4115342">-</span>&nbsp;<span class="ident" id="4115344">d</span><span class="op" id="4115345">.</span><span class="ident" id="4115346">hashOffset</span><span class="op" id="4115356">;</span>&nbsp;<span class="ident" id="4115358">i</span>&nbsp;<span class="op" id="4115360">&lt;</span>&nbsp;<span class="ident" id="4115362">minIndex</span>&nbsp;<span class="op" id="4115371">||</span>&nbsp;<span class="ident" id="4115374">i</span>&nbsp;<span class="op" id="4115376">&lt;</span>&nbsp;<span class="num" id="4115378">0</span>&nbsp;<span class="op" id="4115380">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4115385">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4115393">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4115396">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4115399">return</span><br>
<span class="lineno"></span><span class="op" id="4115406">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="4115409">func</span>&nbsp;<span class="op" id="4115414">(</span><span class="ident" id="4115415">d</span>&nbsp;<span class="op" id="4115417">*</span><span class="ident" id="4115418">compressor</span><span class="op" id="4115428">)</span>&nbsp;<span class="ident" id="4115430">writeStoredBlock</span><span class="op" id="4115446">(</span><span class="ident" id="4115447">buf</span>&nbsp;<span class="op" id="4115451">[</span><span class="op" id="4115452">]</span><span class="builtintype" id="4115453">byte</span><span class="op" id="4115457">)</span>&nbsp;<span class="builtintype" id="4115459">error</span>&nbsp;<span class="op" id="4115465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4115468">if</span>&nbsp;<span class="ident" id="4115471">d</span><span class="op" id="4115472">.</span><span class="ident" id="4115473">w</span><span class="op" id="4115474">.</span><span class="ident" id="4115475">writeStoredHeader</span><span class="op" id="4115492">(</span><span class="builtinfunc" id="4115493">len</span><span class="op" id="4115496">(</span><span class="ident" id="4115497">buf</span><span class="op" id="4115500">)</span><span class="op" id="4115501">,</span>&nbsp;<span class="builtintype" id="4115503">false</span><span class="op" id="4115508">)</span><span class="op" id="4115509">;</span>&nbsp;<span class="ident" id="4115511">d</span><span class="op" id="4115512">.</span><span class="ident" id="4115513">w</span><span class="op" id="4115514">.</span><span class="ident" id="4115515">err</span>&nbsp;<span class="op" id="4115519">!=</span>&nbsp;<span class="ident" id="4115522">nil</span>&nbsp;<span class="op" id="4115526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4115530">return</span>&nbsp;<span class="ident" id="4115537">d</span><span class="op" id="4115538">.</span><span class="ident" id="4115539">w</span><span class="op" id="4115540">.</span><span class="ident" id="4115541">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4115546">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4115549">d</span><span class="op" id="4115550">.</span><span class="ident" id="4115551">w</span><span class="op" id="4115552">.</span><span class="ident" id="4115553">writeBytes</span><span class="op" id="4115563">(</span><span class="ident" id="4115564">buf</span><span class="op" id="4115567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4115570">return</span>&nbsp;<span class="ident" id="4115577">d</span><span class="op" id="4115578">.</span><span class="ident" id="4115579">w</span><span class="op" id="4115580">.</span><span class="ident" id="4115581">err</span><br>
<span class="lineno"></span><span class="op" id="4115585">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4115588">func</span>&nbsp;<span class="op" id="4115593">(</span><span class="ident" id="4115594">d</span>&nbsp;<span class="op" id="4115596">*</span><span class="ident" id="4115597">compressor</span><span class="op" id="4115607">)</span>&nbsp;<span class="ident" id="4115609">initDeflate</span><span class="op" id="4115620">(</span><span class="op" id="4115621">)</span>&nbsp;<span class="op" id="4115623">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4115626">d</span><span class="op" id="4115627">.</span><span class="ident" id="4115628">hashHead</span>&nbsp;<span class="op" id="4115637">=</span>&nbsp;<span class="builtinfunc" id="4115639">make</span><span class="op" id="4115643">(</span><span class="op" id="4115644">[</span><span class="op" id="4115645">]</span><span class="builtintype" id="4115646">int</span><span class="op" id="4115649">,</span>&nbsp;<span class="ident" id="4115651">hashSize</span><span class="op" id="4115659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4115662">d</span><span class="op" id="4115663">.</span><span class="ident" id="4115664">hashPrev</span>&nbsp;<span class="op" id="4115673">=</span>&nbsp;<span class="builtinfunc" id="4115675">make</span><span class="op" id="4115679">(</span><span class="op" id="4115680">[</span><span class="op" id="4115681">]</span><span class="builtintype" id="4115682">int</span><span class="op" id="4115685">,</span>&nbsp;<span class="ident" id="4115687">windowSize</span><span class="op" id="4115697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4115700">d</span><span class="op" id="4115701">.</span><span class="ident" id="4115702">window</span>&nbsp;<span class="op" id="4115709">=</span>&nbsp;<span class="builtinfunc" id="4115711">make</span><span class="op" id="4115715">(</span><span class="op" id="4115716">[</span><span class="op" id="4115717">]</span><span class="builtintype" id="4115718">byte</span><span class="op" id="4115722">,</span>&nbsp;<span class="num" id="4115724">2</span><span class="op" id="4115725">*</span><span class="ident" id="4115726">windowSize</span><span class="op" id="4115736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4115739">d</span><span class="op" id="4115740">.</span><span class="ident" id="4115741">hashOffset</span>&nbsp;<span class="op" id="4115752">=</span>&nbsp;<span class="num" id="4115754">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4115757">d</span><span class="op" id="4115758">.</span><span class="ident" id="4115759">tokens</span>&nbsp;<span class="op" id="4115766">=</span>&nbsp;<span class="builtinfunc" id="4115768">make</span><span class="op" id="4115772">(</span><span class="op" id="4115773">[</span><span class="op" id="4115774">]</span><span class="ident" id="4115775">token</span><span class="op" id="4115780">,</span>&nbsp;<span class="num" id="4115782">0</span><span class="op" id="4115783">,</span>&nbsp;<span class="ident" id="4115785">maxFlateBlockTokens</span><span class="op" id="4115804">+</span><span class="num" id="4115805">1</span><span class="op" id="4115806">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4115809">d</span><span class="op" id="4115810">.</span><span class="ident" id="4115811">length</span>&nbsp;<span class="op" id="4115818">=</span>&nbsp;<span class="ident" id="4115820">minMatchLength</span>&nbsp;<span class="op" id="4115835">-</span>&nbsp;<span class="num" id="4115837">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4115840">d</span><span class="op" id="4115841">.</span><span class="ident" id="4115842">offset</span>&nbsp;<span class="op" id="4115849">=</span>&nbsp;<span class="num" id="4115851">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4115854">d</span><span class="op" id="4115855">.</span><span class="ident" id="4115856">byteAvailable</span>&nbsp;<span class="op" id="4115870">=</span>&nbsp;<span class="builtintype" id="4115872">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4115879">d</span><span class="op" id="4115880">.</span><span class="ident" id="4115881">index</span>&nbsp;<span class="op" id="4115887">=</span>&nbsp;<span class="num" id="4115889">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4115892">d</span><span class="op" id="4115893">.</span><span class="ident" id="4115894">hash</span>&nbsp;<span class="op" id="4115899">=</span>&nbsp;<span class="num" id="4115901">0</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4115904">d</span><span class="op" id="4115905">.</span><span class="ident" id="4115906">chainHead</span>&nbsp;<span class="op" id="4115916">=</span>&nbsp;<span class="op" id="4115918">-</span><span class="num" id="4115919">1</span><br>
<span class="lineno"></span><span class="op" id="4115921">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4115924">func</span>&nbsp;<span class="op" id="4115929">(</span><span class="ident" id="4115930">d</span>&nbsp;<span class="op" id="4115932">*</span><span class="ident" id="4115933">compressor</span><span class="op" id="4115943">)</span>&nbsp;<span class="ident" id="4115945">deflate</span><span class="op" id="4115952">(</span><span class="op" id="4115953">)</span>&nbsp;<span class="op" id="4115955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4115958">if</span>&nbsp;<span class="ident" id="4115961">d</span><span class="op" id="4115962">.</span><span class="ident" id="4115963">windowEnd</span><span class="op" id="4115972">-</span><span class="ident" id="4115973">d</span><span class="op" id="4115974">.</span><span class="ident" id="4115975">index</span>&nbsp;<span class="op" id="4115981">&lt;</span>&nbsp;<span class="ident" id="4115983">minMatchLength</span><span class="op" id="4115997">+</span><span class="ident" id="4115998">maxMatchLength</span>&nbsp;<span class="op" id="4116013">&amp;&amp;</span>&nbsp;<span class="op" id="4116016">!</span><span class="ident" id="4116017">d</span><span class="op" id="4116018">.</span><span class="ident" id="4116019">sync</span>&nbsp;<span class="op" id="4116024">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4116028">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4116036">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4116040">d</span><span class="op" id="4116041">.</span><span class="ident" id="4116042">maxInsertIndex</span>&nbsp;<span class="op" id="4116057">=</span>&nbsp;<span class="ident" id="4116059">d</span><span class="op" id="4116060">.</span><span class="ident" id="4116061">windowEnd</span>&nbsp;<span class="op" id="4116071">-</span>&nbsp;<span class="op" id="4116073">(</span><span class="ident" id="4116074">minMatchLength</span>&nbsp;<span class="op" id="4116089">-</span>&nbsp;<span class="num" id="4116091">1</span><span class="op" id="4116092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4116095">if</span>&nbsp;<span class="ident" id="4116098">d</span><span class="op" id="4116099">.</span><span class="ident" id="4116100">index</span>&nbsp;<span class="op" id="4116106">&lt;</span>&nbsp;<span class="ident" id="4116108">d</span><span class="op" id="4116109">.</span><span class="ident" id="4116110">maxInsertIndex</span>&nbsp;<span class="op" id="4116125">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4116129">d</span><span class="op" id="4116130">.</span><span class="ident" id="4116131">hash</span>&nbsp;<span class="op" id="4116136">=</span>&nbsp;<span class="builtintype" id="4116138">int</span><span class="op" id="4116141">(</span><span class="ident" id="4116142">d</span><span class="op" id="4116143">.</span><span class="ident" id="4116144">window</span><span class="op" id="4116150">[</span><span class="ident" id="4116151">d</span><span class="op" id="4116152">.</span><span class="ident" id="4116153">index</span><span class="op" id="4116158">]</span><span class="op" id="4116159">)</span><span class="op" id="4116160">&lt;&lt;</span><span class="ident" id="4116162">hashShift</span>&nbsp;<span class="op" id="4116172">+</span>&nbsp;<span class="builtintype" id="4116174">int</span><span class="op" id="4116177">(</span><span class="ident" id="4116178">d</span><span class="op" id="4116179">.</span><span class="ident" id="4116180">window</span><span class="op" id="4116186">[</span><span class="ident" id="4116187">d</span><span class="op" id="4116188">.</span><span class="ident" id="4116189">index</span><span class="op" id="4116194">+</span><span class="num" id="4116195">1</span><span class="op" id="4116196">]</span><span class="op" id="4116197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4116200">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="4116203">Loop</span><span class="op" id="4116207">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4116210">for</span>&nbsp;<span class="op" id="4116214">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4116218">if</span>&nbsp;<span class="ident" id="4116221">d</span><span class="op" id="4116222">.</span><span class="ident" id="4116223">index</span>&nbsp;<span class="op" id="4116229">&gt;</span>&nbsp;<span class="ident" id="4116231">d</span><span class="op" id="4116232">.</span><span class="ident" id="4116233">windowEnd</span>&nbsp;<span class="op" id="4116243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4116248">panic</span><span class="op" id="4116253">(</span><span class="string" id="4116254">&#34;index&nbsp;&gt;&nbsp;windowEnd&#34;</span><span class="op" id="4116273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4116277">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4116281">lookahead</span>&nbsp;<span class="op" id="4116291">:=</span>&nbsp;<span class="ident" id="4116294">d</span><span class="op" id="4116295">.</span><span class="ident" id="4116296">windowEnd</span>&nbsp;<span class="op" id="4116306">-</span>&nbsp;<span class="ident" id="4116308">d</span><span class="op" id="4116309">.</span><span class="ident" id="4116310">index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4116318">if</span>&nbsp;<span class="ident" id="4116321">lookahead</span>&nbsp;<span class="op" id="4116331">&lt;</span>&nbsp;<span class="ident" id="4116333">minMatchLength</span><span class="op" id="4116347">+</span><span class="ident" id="4116348">maxMatchLength</span>&nbsp;<span class="op" id="4116363">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4116368">if</span>&nbsp;<span class="op" id="4116371">!</span><span class="ident" id="4116372">d</span><span class="op" id="4116373">.</span><span class="ident" id="4116374">sync</span>&nbsp;<span class="op" id="4116379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4116385">break</span>&nbsp;<span class="ident" id="4116391">Loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4116399">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4116404">if</span>&nbsp;<span class="ident" id="4116407">d</span><span class="op" id="4116408">.</span><span class="ident" id="4116409">index</span>&nbsp;<span class="op" id="4116415">&gt;</span>&nbsp;<span class="ident" id="4116417">d</span><span class="op" id="4116418">.</span><span class="ident" id="4116419">windowEnd</span>&nbsp;<span class="op" id="4116429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4116435">panic</span><span class="op" id="4116440">(</span><span class="string" id="4116441">&#34;index&nbsp;&gt;&nbsp;windowEnd&#34;</span><span class="op" id="4116460">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4116465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4116470">if</span>&nbsp;<span class="ident" id="4116473">lookahead</span>&nbsp;<span class="op" id="4116483">==</span>&nbsp;<span class="num" id="4116486">0</span>&nbsp;<span class="op" id="4116488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4116494">//&nbsp;Flush&nbsp;current&nbsp;output&nbsp;block&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4116536">if</span>&nbsp;<span class="ident" id="4116539">d</span><span class="op" id="4116540">.</span><span class="ident" id="4116541">byteAvailable</span>&nbsp;<span class="op" id="4116555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4116562">//&nbsp;There&nbsp;is&nbsp;still&nbsp;one&nbsp;pending&nbsp;token&nbsp;that&nbsp;needs&nbsp;to&nbsp;be&nbsp;flushed</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4116628">d</span><span class="op" id="4116629">.</span><span class="ident" id="4116630">tokens</span>&nbsp;<span class="op" id="4116637">=</span>&nbsp;<span class="builtinfunc" id="4116639">append</span><span class="op" id="4116645">(</span><span class="ident" id="4116646">d</span><span class="op" id="4116647">.</span><span class="ident" id="4116648">tokens</span><span class="op" id="4116654">,</span>&nbsp;<span class="ident" id="4116656">literalToken</span><span class="op" id="4116668">(</span><span class="builtintype" id="4116669">uint32</span><span class="op" id="4116675">(</span><span class="ident" id="4116676">d</span><span class="op" id="4116677">.</span><span class="ident" id="4116678">window</span><span class="op" id="4116684">[</span><span class="ident" id="4116685">d</span><span class="op" id="4116686">.</span><span class="ident" id="4116687">index</span><span class="op" id="4116692">-</span><span class="num" id="4116693">1</span><span class="op" id="4116694">]</span><span class="op" id="4116695">)</span><span class="op" id="4116696">)</span><span class="op" id="4116697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4116704">d</span><span class="op" id="4116705">.</span><span class="ident" id="4116706">byteAvailable</span>&nbsp;<span class="op" id="4116720">=</span>&nbsp;<span class="builtintype" id="4116722">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4116732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4116738">if</span>&nbsp;<span class="builtinfunc" id="4116741">len</span><span class="op" id="4116744">(</span><span class="ident" id="4116745">d</span><span class="op" id="4116746">.</span><span class="ident" id="4116747">tokens</span><span class="op" id="4116753">)</span>&nbsp;<span class="op" id="4116755">&gt;</span>&nbsp;<span class="num" id="4116757">0</span>&nbsp;<span class="op" id="4116759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4116766">if</span>&nbsp;<span class="ident" id="4116769">d</span><span class="op" id="4116770">.</span><span class="ident" id="4116771">err</span>&nbsp;<span class="op" id="4116775">=</span>&nbsp;<span class="ident" id="4116777">d</span><span class="op" id="4116778">.</span><span class="ident" id="4116779">writeBlock</span><span class="op" id="4116789">(</span><span class="ident" id="4116790">d</span><span class="op" id="4116791">.</span><span class="ident" id="4116792">tokens</span><span class="op" id="4116798">,</span>&nbsp;<span class="ident" id="4116800">d</span><span class="op" id="4116801">.</span><span class="ident" id="4116802">index</span><span class="op" id="4116807">,</span>&nbsp;<span class="builtintype" id="4116809">false</span><span class="op" id="4116814">)</span><span class="op" id="4116815">;</span>&nbsp;<span class="ident" id="4116817">d</span><span class="op" id="4116818">.</span><span class="ident" id="4116819">err</span>&nbsp;<span class="op" id="4116823">!=</span>&nbsp;<span class="ident" id="4116826">nil</span>&nbsp;<span class="op" id="4116830">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4116838">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4116850">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4116857">d</span><span class="op" id="4116858">.</span><span class="ident" id="4116859">tokens</span>&nbsp;<span class="op" id="4116866">=</span>&nbsp;<span class="ident" id="4116868">d</span><span class="op" id="4116869">.</span><span class="ident" id="4116870">tokens</span><span class="op" id="4116876">[</span><span class="op" id="4116877">:</span><span class="num" id="4116878">0</span><span class="op" id="4116879">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4116885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4116891">break</span>&nbsp;<span class="ident" id="4116897">Loop</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4116905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4116909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4116913">if</span>&nbsp;<span class="ident" id="4116916">d</span><span class="op" id="4116917">.</span><span class="ident" id="4116918">index</span>&nbsp;<span class="op" id="4116924">&lt;</span>&nbsp;<span class="ident" id="4116926">d</span><span class="op" id="4116927">.</span><span class="ident" id="4116928">maxInsertIndex</span>&nbsp;<span class="op" id="4116943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4116948">//&nbsp;Update&nbsp;the&nbsp;hash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4116970">d</span><span class="op" id="4116971">.</span><span class="ident" id="4116972">hash</span>&nbsp;<span class="op" id="4116977">=</span>&nbsp;<span class="op" id="4116979">(</span><span class="ident" id="4116980">d</span><span class="op" id="4116981">.</span><span class="ident" id="4116982">hash</span><span class="op" id="4116986">&lt;&lt;</span><span class="ident" id="4116988">hashShift</span>&nbsp;<span class="op" id="4116998">+</span>&nbsp;<span class="builtintype" id="4117000">int</span><span class="op" id="4117003">(</span><span class="ident" id="4117004">d</span><span class="op" id="4117005">.</span><span class="ident" id="4117006">window</span><span class="op" id="4117012">[</span><span class="ident" id="4117013">d</span><span class="op" id="4117014">.</span><span class="ident" id="4117015">index</span><span class="op" id="4117020">+</span><span class="num" id="4117021">2</span><span class="op" id="4117022">]</span><span class="op" id="4117023">)</span><span class="op" id="4117024">)</span>&nbsp;<span class="op" id="4117026">&amp;</span>&nbsp;<span class="ident" id="4117028">hashMask</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4117040">d</span><span class="op" id="4117041">.</span><span class="ident" id="4117042">chainHead</span>&nbsp;<span class="op" id="4117052">=</span>&nbsp;<span class="ident" id="4117054">d</span><span class="op" id="4117055">.</span><span class="ident" id="4117056">hashHead</span><span class="op" id="4117064">[</span><span class="ident" id="4117065">d</span><span class="op" id="4117066">.</span><span class="ident" id="4117067">hash</span><span class="op" id="4117071">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4117076">d</span><span class="op" id="4117077">.</span><span class="ident" id="4117078">hashPrev</span><span class="op" id="4117086">[</span><span class="ident" id="4117087">d</span><span class="op" id="4117088">.</span><span class="ident" id="4117089">index</span><span class="op" id="4117094">&amp;</span><span class="ident" id="4117095">windowMask</span><span class="op" id="4117105">]</span>&nbsp;<span class="op" id="4117107">=</span>&nbsp;<span class="ident" id="4117109">d</span><span class="op" id="4117110">.</span><span class="ident" id="4117111">chainHead</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4117124">d</span><span class="op" id="4117125">.</span><span class="ident" id="4117126">hashHead</span><span class="op" id="4117134">[</span><span class="ident" id="4117135">d</span><span class="op" id="4117136">.</span><span class="ident" id="4117137">hash</span><span class="op" id="4117141">]</span>&nbsp;<span class="op" id="4117143">=</span>&nbsp;<span class="ident" id="4117145">d</span><span class="op" id="4117146">.</span><span class="ident" id="4117147">index</span>&nbsp;<span class="op" id="4117153">+</span>&nbsp;<span class="ident" id="4117155">d</span><span class="op" id="4117156">.</span><span class="ident" id="4117157">hashOffset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4117170">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4117174">prevLength</span>&nbsp;<span class="op" id="4117185">:=</span>&nbsp;<span class="ident" id="4117188">d</span><span class="op" id="4117189">.</span><span class="ident" id="4117190">length</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4117199">prevOffset</span>&nbsp;<span class="op" id="4117210">:=</span>&nbsp;<span class="ident" id="4117213">d</span><span class="op" id="4117214">.</span><span class="ident" id="4117215">offset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4117224">d</span><span class="op" id="4117225">.</span><span class="ident" id="4117226">length</span>&nbsp;<span class="op" id="4117233">=</span>&nbsp;<span class="ident" id="4117235">minMatchLength</span>&nbsp;<span class="op" id="4117250">-</span>&nbsp;<span class="num" id="4117252">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4117256">d</span><span class="op" id="4117257">.</span><span class="ident" id="4117258">offset</span>&nbsp;<span class="op" id="4117265">=</span>&nbsp;<span class="num" id="4117267">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4117271">minIndex</span>&nbsp;<span class="op" id="4117280">:=</span>&nbsp;<span class="ident" id="4117283">d</span><span class="op" id="4117284">.</span><span class="ident" id="4117285">index</span>&nbsp;<span class="op" id="4117291">-</span>&nbsp;<span class="ident" id="4117293">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4117306">if</span>&nbsp;<span class="ident" id="4117309">minIndex</span>&nbsp;<span class="op" id="4117318">&lt;</span>&nbsp;<span class="num" id="4117320">0</span>&nbsp;<span class="op" id="4117322">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4117327">minIndex</span>&nbsp;<span class="op" id="4117336">=</span>&nbsp;<span class="num" id="4117338">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4117342">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4117347">if</span>&nbsp;<span class="ident" id="4117350">d</span><span class="op" id="4117351">.</span><span class="ident" id="4117352">chainHead</span><span class="op" id="4117361">-</span><span class="ident" id="4117362">d</span><span class="op" id="4117363">.</span><span class="ident" id="4117364">hashOffset</span>&nbsp;<span class="op" id="4117375">&gt;=</span>&nbsp;<span class="ident" id="4117378">minIndex</span>&nbsp;<span class="op" id="4117387">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4117393">(</span><span class="ident" id="4117394">d</span><span class="op" id="4117395">.</span><span class="ident" id="4117396">fastSkipHashing</span>&nbsp;<span class="op" id="4117412">!=</span>&nbsp;<span class="ident" id="4117415">skipNever</span>&nbsp;<span class="op" id="4117425">&amp;&amp;</span>&nbsp;<span class="ident" id="4117428">lookahead</span>&nbsp;<span class="op" id="4117438">&gt;</span>&nbsp;<span class="ident" id="4117440">minMatchLength</span><span class="op" id="4117454">-</span><span class="num" id="4117455">1</span>&nbsp;<span class="op" id="4117457">||</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4117464">d</span><span class="op" id="4117465">.</span><span class="ident" id="4117466">fastSkipHashing</span>&nbsp;<span class="op" id="4117482">==</span>&nbsp;<span class="ident" id="4117485">skipNever</span>&nbsp;<span class="op" id="4117495">&amp;&amp;</span>&nbsp;<span class="ident" id="4117498">lookahead</span>&nbsp;<span class="op" id="4117508">&gt;</span>&nbsp;<span class="ident" id="4117510">prevLength</span>&nbsp;<span class="op" id="4117521">&amp;&amp;</span>&nbsp;<span class="ident" id="4117524">prevLength</span>&nbsp;<span class="op" id="4117535">&lt;</span>&nbsp;<span class="ident" id="4117537">d</span><span class="op" id="4117538">.</span><span class="ident" id="4117539">lazy</span><span class="op" id="4117543">)</span>&nbsp;<span class="op" id="4117545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4117550">if</span>&nbsp;<span class="ident" id="4117553">newLength</span><span class="op" id="4117562">,</span>&nbsp;<span class="ident" id="4117564">newOffset</span><span class="op" id="4117573">,</span>&nbsp;<span class="ident" id="4117575">ok</span>&nbsp;<span class="op" id="4117578">:=</span>&nbsp;<span class="ident" id="4117581">d</span><span class="op" id="4117582">.</span><span class="ident" id="4117583">findMatch</span><span class="op" id="4117592">(</span><span class="ident" id="4117593">d</span><span class="op" id="4117594">.</span><span class="ident" id="4117595">index</span><span class="op" id="4117600">,</span>&nbsp;<span class="ident" id="4117602">d</span><span class="op" id="4117603">.</span><span class="ident" id="4117604">chainHead</span><span class="op" id="4117613">-</span><span class="ident" id="4117614">d</span><span class="op" id="4117615">.</span><span class="ident" id="4117616">hashOffset</span><span class="op" id="4117626">,</span>&nbsp;<span class="ident" id="4117628">minMatchLength</span><span class="op" id="4117642">-</span><span class="num" id="4117643">1</span><span class="op" id="4117644">,</span>&nbsp;<span class="ident" id="4117646">lookahead</span><span class="op" id="4117655">)</span><span class="op" id="4117656">;</span>&nbsp;<span class="ident" id="4117658">ok</span>&nbsp;<span class="op" id="4117661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4117667">d</span><span class="op" id="4117668">.</span><span class="ident" id="4117669">length</span>&nbsp;<span class="op" id="4117676">=</span>&nbsp;<span class="ident" id="4117678">newLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4117692">d</span><span class="op" id="4117693">.</span><span class="ident" id="4117694">offset</span>&nbsp;<span class="op" id="4117701">=</span>&nbsp;<span class="ident" id="4117703">newOffset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4117716">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4117720">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4117724">if</span>&nbsp;<span class="ident" id="4117727">d</span><span class="op" id="4117728">.</span><span class="ident" id="4117729">fastSkipHashing</span>&nbsp;<span class="op" id="4117745">!=</span>&nbsp;<span class="ident" id="4117748">skipNever</span>&nbsp;<span class="op" id="4117758">&amp;&amp;</span>&nbsp;<span class="ident" id="4117761">d</span><span class="op" id="4117762">.</span><span class="ident" id="4117763">length</span>&nbsp;<span class="op" id="4117770">&gt;=</span>&nbsp;<span class="ident" id="4117773">minMatchLength</span>&nbsp;<span class="op" id="4117788">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4117794">d</span><span class="op" id="4117795">.</span><span class="ident" id="4117796">fastSkipHashing</span>&nbsp;<span class="op" id="4117812">==</span>&nbsp;<span class="ident" id="4117815">skipNever</span>&nbsp;<span class="op" id="4117825">&amp;&amp;</span>&nbsp;<span class="ident" id="4117828">prevLength</span>&nbsp;<span class="op" id="4117839">&gt;=</span>&nbsp;<span class="ident" id="4117842">minMatchLength</span>&nbsp;<span class="op" id="4117857">&amp;&amp;</span>&nbsp;<span class="ident" id="4117860">d</span><span class="op" id="4117861">.</span><span class="ident" id="4117862">length</span>&nbsp;<span class="op" id="4117869">&lt;=</span>&nbsp;<span class="ident" id="4117872">prevLength</span>&nbsp;<span class="op" id="4117883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4117888">//&nbsp;There&nbsp;was&nbsp;a&nbsp;match&nbsp;at&nbsp;the&nbsp;previous&nbsp;step,&nbsp;and&nbsp;the&nbsp;current&nbsp;match&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4117959">//&nbsp;not&nbsp;better.&nbsp;Output&nbsp;the&nbsp;previous&nbsp;match.</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4118004">if</span>&nbsp;<span class="ident" id="4118007">d</span><span class="op" id="4118008">.</span><span class="ident" id="4118009">fastSkipHashing</span>&nbsp;<span class="op" id="4118025">!=</span>&nbsp;<span class="ident" id="4118028">skipNever</span>&nbsp;<span class="op" id="4118038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4118044">d</span><span class="op" id="4118045">.</span><span class="ident" id="4118046">tokens</span>&nbsp;<span class="op" id="4118053">=</span>&nbsp;<span class="builtinfunc" id="4118055">append</span><span class="op" id="4118061">(</span><span class="ident" id="4118062">d</span><span class="op" id="4118063">.</span><span class="ident" id="4118064">tokens</span><span class="op" id="4118070">,</span>&nbsp;<span class="ident" id="4118072">matchToken</span><span class="op" id="4118082">(</span><span class="builtintype" id="4118083">uint32</span><span class="op" id="4118089">(</span><span class="ident" id="4118090">d</span><span class="op" id="4118091">.</span><span class="ident" id="4118092">length</span><span class="op" id="4118098">-</span><span class="ident" id="4118099">minMatchLength</span><span class="op" id="4118113">)</span><span class="op" id="4118114">,</span>&nbsp;<span class="builtintype" id="4118116">uint32</span><span class="op" id="4118122">(</span><span class="ident" id="4118123">d</span><span class="op" id="4118124">.</span><span class="ident" id="4118125">offset</span><span class="op" id="4118131">-</span><span class="ident" id="4118132">minOffsetSize</span><span class="op" id="4118145">)</span><span class="op" id="4118146">)</span><span class="op" id="4118147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4118152">}</span>&nbsp;<span class="keyword" id="4118154">else</span>&nbsp;<span class="op" id="4118159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4118165">d</span><span class="op" id="4118166">.</span><span class="ident" id="4118167">tokens</span>&nbsp;<span class="op" id="4118174">=</span>&nbsp;<span class="builtinfunc" id="4118176">append</span><span class="op" id="4118182">(</span><span class="ident" id="4118183">d</span><span class="op" id="4118184">.</span><span class="ident" id="4118185">tokens</span><span class="op" id="4118191">,</span>&nbsp;<span class="ident" id="4118193">matchToken</span><span class="op" id="4118203">(</span><span class="builtintype" id="4118204">uint32</span><span class="op" id="4118210">(</span><span class="ident" id="4118211">prevLength</span><span class="op" id="4118221">-</span><span class="ident" id="4118222">minMatchLength</span><span class="op" id="4118236">)</span><span class="op" id="4118237">,</span>&nbsp;<span class="builtintype" id="4118239">uint32</span><span class="op" id="4118245">(</span><span class="ident" id="4118246">prevOffset</span><span class="op" id="4118256">-</span><span class="ident" id="4118257">minOffsetSize</span><span class="op" id="4118270">)</span><span class="op" id="4118271">)</span><span class="op" id="4118272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4118277">}</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4118282">//&nbsp;Insert&nbsp;in&nbsp;the&nbsp;hash&nbsp;table&nbsp;all&nbsp;strings&nbsp;up&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;match.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4118353">//&nbsp;index&nbsp;and&nbsp;index-1&nbsp;are&nbsp;already&nbsp;inserted.&nbsp;If&nbsp;there&nbsp;is&nbsp;not&nbsp;enough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4118422">//&nbsp;lookahead,&nbsp;the&nbsp;last&nbsp;two&nbsp;strings&nbsp;are&nbsp;not&nbsp;inserted&nbsp;into&nbsp;the&nbsp;hash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4118491">//&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4118504">if</span>&nbsp;<span class="ident" id="4118507">d</span><span class="op" id="4118508">.</span><span class="ident" id="4118509">length</span>&nbsp;<span class="op" id="4118516">&lt;=</span>&nbsp;<span class="ident" id="4118519">d</span><span class="op" id="4118520">.</span><span class="ident" id="4118521">fastSkipHashing</span>&nbsp;<span class="op" id="4118537">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4118543">var</span>&nbsp;<span class="ident" id="4118547">newIndex</span>&nbsp;<span class="builtintype" id="4118556">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4118564">if</span>&nbsp;<span class="ident" id="4118567">d</span><span class="op" id="4118568">.</span><span class="ident" id="4118569">fastSkipHashing</span>&nbsp;<span class="op" id="4118585">!=</span>&nbsp;<span class="ident" id="4118588">skipNever</span>&nbsp;<span class="op" id="4118598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4118605">newIndex</span>&nbsp;<span class="op" id="4118614">=</span>&nbsp;<span class="ident" id="4118616">d</span><span class="op" id="4118617">.</span><span class="ident" id="4118618">index</span>&nbsp;<span class="op" id="4118624">+</span>&nbsp;<span class="ident" id="4118626">d</span><span class="op" id="4118627">.</span><span class="ident" id="4118628">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4118639">}</span>&nbsp;<span class="keyword" id="4118641">else</span>&nbsp;<span class="op" id="4118646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4118653">newIndex</span>&nbsp;<span class="op" id="4118662">=</span>&nbsp;<span class="ident" id="4118664">d</span><span class="op" id="4118665">.</span><span class="ident" id="4118666">index</span>&nbsp;<span class="op" id="4118672">+</span>&nbsp;<span class="ident" id="4118674">prevLength</span>&nbsp;<span class="op" id="4118685">-</span>&nbsp;<span class="num" id="4118687">1</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4118693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4118699">for</span>&nbsp;<span class="ident" id="4118703">d</span><span class="op" id="4118704">.</span><span class="ident" id="4118705">index</span><span class="op" id="4118710">++</span><span class="op" id="4118712">;</span>&nbsp;<span class="ident" id="4118714">d</span><span class="op" id="4118715">.</span><span class="ident" id="4118716">index</span>&nbsp;<span class="op" id="4118722">&lt;</span>&nbsp;<span class="ident" id="4118724">newIndex</span><span class="op" id="4118732">;</span>&nbsp;<span class="ident" id="4118734">d</span><span class="op" id="4118735">.</span><span class="ident" id="4118736">index</span><span class="op" id="4118741">++</span>&nbsp;<span class="op" id="4118744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4118751">if</span>&nbsp;<span class="ident" id="4118754">d</span><span class="op" id="4118755">.</span><span class="ident" id="4118756">index</span>&nbsp;<span class="op" id="4118762">&lt;</span>&nbsp;<span class="ident" id="4118764">d</span><span class="op" id="4118765">.</span><span class="ident" id="4118766">maxInsertIndex</span>&nbsp;<span class="op" id="4118781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4118789">d</span><span class="op" id="4118790">.</span><span class="ident" id="4118791">hash</span>&nbsp;<span class="op" id="4118796">=</span>&nbsp;<span class="op" id="4118798">(</span><span class="ident" id="4118799">d</span><span class="op" id="4118800">.</span><span class="ident" id="4118801">hash</span><span class="op" id="4118805">&lt;&lt;</span><span class="ident" id="4118807">hashShift</span>&nbsp;<span class="op" id="4118817">+</span>&nbsp;<span class="builtintype" id="4118819">int</span><span class="op" id="4118822">(</span><span class="ident" id="4118823">d</span><span class="op" id="4118824">.</span><span class="ident" id="4118825">window</span><span class="op" id="4118831">[</span><span class="ident" id="4118832">d</span><span class="op" id="4118833">.</span><span class="ident" id="4118834">index</span><span class="op" id="4118839">+</span><span class="num" id="4118840">2</span><span class="op" id="4118841">]</span><span class="op" id="4118842">)</span><span class="op" id="4118843">)</span>&nbsp;<span class="op" id="4118845">&amp;</span>&nbsp;<span class="ident" id="4118847">hashMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4118862">//&nbsp;Get&nbsp;previous&nbsp;value&nbsp;with&nbsp;the&nbsp;same&nbsp;hash.</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4118910">//&nbsp;Our&nbsp;chain&nbsp;should&nbsp;point&nbsp;to&nbsp;the&nbsp;previous&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4118965">d</span><span class="op" id="4118966">.</span><span class="ident" id="4118967">hashPrev</span><span class="op" id="4118975">[</span><span class="ident" id="4118976">d</span><span class="op" id="4118977">.</span><span class="ident" id="4118978">index</span><span class="op" id="4118983">&amp;</span><span class="ident" id="4118984">windowMask</span><span class="op" id="4118994">]</span>&nbsp;<span class="op" id="4118996">=</span>&nbsp;<span class="ident" id="4118998">d</span><span class="op" id="4118999">.</span><span class="ident" id="4119000">hashHead</span><span class="op" id="4119008">[</span><span class="ident" id="4119009">d</span><span class="op" id="4119010">.</span><span class="ident" id="4119011">hash</span><span class="op" id="4119015">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4119023">//&nbsp;Set&nbsp;the&nbsp;head&nbsp;of&nbsp;the&nbsp;hash&nbsp;chain&nbsp;to&nbsp;us.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4119070">d</span><span class="op" id="4119071">.</span><span class="ident" id="4119072">hashHead</span><span class="op" id="4119080">[</span><span class="ident" id="4119081">d</span><span class="op" id="4119082">.</span><span class="ident" id="4119083">hash</span><span class="op" id="4119087">]</span>&nbsp;<span class="op" id="4119089">=</span>&nbsp;<span class="ident" id="4119091">d</span><span class="op" id="4119092">.</span><span class="ident" id="4119093">index</span>&nbsp;<span class="op" id="4119099">+</span>&nbsp;<span class="ident" id="4119101">d</span><span class="op" id="4119102">.</span><span class="ident" id="4119103">hashOffset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4119119">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4119125">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4119131">if</span>&nbsp;<span class="ident" id="4119134">d</span><span class="op" id="4119135">.</span><span class="ident" id="4119136">fastSkipHashing</span>&nbsp;<span class="op" id="4119152">==</span>&nbsp;<span class="ident" id="4119155">skipNever</span>&nbsp;<span class="op" id="4119165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4119172">d</span><span class="op" id="4119173">.</span><span class="ident" id="4119174">byteAvailable</span>&nbsp;<span class="op" id="4119188">=</span>&nbsp;<span class="builtintype" id="4119190">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4119201">d</span><span class="op" id="4119202">.</span><span class="ident" id="4119203">length</span>&nbsp;<span class="op" id="4119210">=</span>&nbsp;<span class="ident" id="4119212">minMatchLength</span>&nbsp;<span class="op" id="4119227">-</span>&nbsp;<span class="num" id="4119229">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4119235">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4119240">}</span>&nbsp;<span class="keyword" id="4119242">else</span>&nbsp;<span class="op" id="4119247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4119253">//&nbsp;For&nbsp;matches&nbsp;this&nbsp;long,&nbsp;we&nbsp;don&#39;t&nbsp;bother&nbsp;inserting&nbsp;each&nbsp;individual</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4119325">//&nbsp;item&nbsp;into&nbsp;the&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4119353">d</span><span class="op" id="4119354">.</span><span class="ident" id="4119355">index</span>&nbsp;<span class="op" id="4119361">+=</span>&nbsp;<span class="ident" id="4119364">d</span><span class="op" id="4119365">.</span><span class="ident" id="4119366">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4119377">if</span>&nbsp;<span class="ident" id="4119380">d</span><span class="op" id="4119381">.</span><span class="ident" id="4119382">index</span>&nbsp;<span class="op" id="4119388">&lt;</span>&nbsp;<span class="ident" id="4119390">d</span><span class="op" id="4119391">.</span><span class="ident" id="4119392">maxInsertIndex</span>&nbsp;<span class="op" id="4119407">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4119414">d</span><span class="op" id="4119415">.</span><span class="ident" id="4119416">hash</span>&nbsp;<span class="op" id="4119421">=</span>&nbsp;<span class="op" id="4119423">(</span><span class="builtintype" id="4119424">int</span><span class="op" id="4119427">(</span><span class="ident" id="4119428">d</span><span class="op" id="4119429">.</span><span class="ident" id="4119430">window</span><span class="op" id="4119436">[</span><span class="ident" id="4119437">d</span><span class="op" id="4119438">.</span><span class="ident" id="4119439">index</span><span class="op" id="4119444">]</span><span class="op" id="4119445">)</span><span class="op" id="4119446">&lt;&lt;</span><span class="ident" id="4119448">hashShift</span>&nbsp;<span class="op" id="4119458">+</span>&nbsp;<span class="builtintype" id="4119460">int</span><span class="op" id="4119463">(</span><span class="ident" id="4119464">d</span><span class="op" id="4119465">.</span><span class="ident" id="4119466">window</span><span class="op" id="4119472">[</span><span class="ident" id="4119473">d</span><span class="op" id="4119474">.</span><span class="ident" id="4119475">index</span><span class="op" id="4119480">+</span><span class="num" id="4119481">1</span><span class="op" id="4119482">]</span><span class="op" id="4119483">)</span><span class="op" id="4119484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4119490">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4119495">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4119500">if</span>&nbsp;<span class="builtinfunc" id="4119503">len</span><span class="op" id="4119506">(</span><span class="ident" id="4119507">d</span><span class="op" id="4119508">.</span><span class="ident" id="4119509">tokens</span><span class="op" id="4119515">)</span>&nbsp;<span class="op" id="4119517">==</span>&nbsp;<span class="ident" id="4119520">maxFlateBlockTokens</span>&nbsp;<span class="op" id="4119540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4119546">//&nbsp;The&nbsp;block&nbsp;includes&nbsp;the&nbsp;current&nbsp;character</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4119594">if</span>&nbsp;<span class="ident" id="4119597">d</span><span class="op" id="4119598">.</span><span class="ident" id="4119599">err</span>&nbsp;<span class="op" id="4119603">=</span>&nbsp;<span class="ident" id="4119605">d</span><span class="op" id="4119606">.</span><span class="ident" id="4119607">writeBlock</span><span class="op" id="4119617">(</span><span class="ident" id="4119618">d</span><span class="op" id="4119619">.</span><span class="ident" id="4119620">tokens</span><span class="op" id="4119626">,</span>&nbsp;<span class="ident" id="4119628">d</span><span class="op" id="4119629">.</span><span class="ident" id="4119630">index</span><span class="op" id="4119635">,</span>&nbsp;<span class="builtintype" id="4119637">false</span><span class="op" id="4119642">)</span><span class="op" id="4119643">;</span>&nbsp;<span class="ident" id="4119645">d</span><span class="op" id="4119646">.</span><span class="ident" id="4119647">err</span>&nbsp;<span class="op" id="4119651">!=</span>&nbsp;<span class="ident" id="4119654">nil</span>&nbsp;<span class="op" id="4119658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4119665">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4119676">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4119682">d</span><span class="op" id="4119683">.</span><span class="ident" id="4119684">tokens</span>&nbsp;<span class="op" id="4119691">=</span>&nbsp;<span class="ident" id="4119693">d</span><span class="op" id="4119694">.</span><span class="ident" id="4119695">tokens</span><span class="op" id="4119701">[</span><span class="op" id="4119702">:</span><span class="num" id="4119703">0</span><span class="op" id="4119704">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4119709">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4119713">}</span>&nbsp;<span class="keyword" id="4119715">else</span>&nbsp;<span class="op" id="4119720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4119725">if</span>&nbsp;<span class="ident" id="4119728">d</span><span class="op" id="4119729">.</span><span class="ident" id="4119730">fastSkipHashing</span>&nbsp;<span class="op" id="4119746">!=</span>&nbsp;<span class="ident" id="4119749">skipNever</span>&nbsp;<span class="op" id="4119759">||</span>&nbsp;<span class="ident" id="4119762">d</span><span class="op" id="4119763">.</span><span class="ident" id="4119764">byteAvailable</span>&nbsp;<span class="op" id="4119778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4119784">i</span>&nbsp;<span class="op" id="4119786">:=</span>&nbsp;<span class="ident" id="4119789">d</span><span class="op" id="4119790">.</span><span class="ident" id="4119791">index</span>&nbsp;<span class="op" id="4119797">-</span>&nbsp;<span class="num" id="4119799">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4119805">if</span>&nbsp;<span class="ident" id="4119808">d</span><span class="op" id="4119809">.</span><span class="ident" id="4119810">fastSkipHashing</span>&nbsp;<span class="op" id="4119826">!=</span>&nbsp;<span class="ident" id="4119829">skipNever</span>&nbsp;<span class="op" id="4119839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4119846">i</span>&nbsp;<span class="op" id="4119848">=</span>&nbsp;<span class="ident" id="4119850">d</span><span class="op" id="4119851">.</span><span class="ident" id="4119852">index</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4119862">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4119868">d</span><span class="op" id="4119869">.</span><span class="ident" id="4119870">tokens</span>&nbsp;<span class="op" id="4119877">=</span>&nbsp;<span class="builtinfunc" id="4119879">append</span><span class="op" id="4119885">(</span><span class="ident" id="4119886">d</span><span class="op" id="4119887">.</span><span class="ident" id="4119888">tokens</span><span class="op" id="4119894">,</span>&nbsp;<span class="ident" id="4119896">literalToken</span><span class="op" id="4119908">(</span><span class="builtintype" id="4119909">uint32</span><span class="op" id="4119915">(</span><span class="ident" id="4119916">d</span><span class="op" id="4119917">.</span><span class="ident" id="4119918">window</span><span class="op" id="4119924">[</span><span class="ident" id="4119925">i</span><span class="op" id="4119926">]</span><span class="op" id="4119927">)</span><span class="op" id="4119928">)</span><span class="op" id="4119929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4119935">if</span>&nbsp;<span class="builtinfunc" id="4119938">len</span><span class="op" id="4119941">(</span><span class="ident" id="4119942">d</span><span class="op" id="4119943">.</span><span class="ident" id="4119944">tokens</span><span class="op" id="4119950">)</span>&nbsp;<span class="op" id="4119952">==</span>&nbsp;<span class="ident" id="4119955">maxFlateBlockTokens</span>&nbsp;<span class="op" id="4119975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4119982">if</span>&nbsp;<span class="ident" id="4119985">d</span><span class="op" id="4119986">.</span><span class="ident" id="4119987">err</span>&nbsp;<span class="op" id="4119991">=</span>&nbsp;<span class="ident" id="4119993">d</span><span class="op" id="4119994">.</span><span class="ident" id="4119995">writeBlock</span><span class="op" id="4120005">(</span><span class="ident" id="4120006">d</span><span class="op" id="4120007">.</span><span class="ident" id="4120008">tokens</span><span class="op" id="4120014">,</span>&nbsp;<span class="ident" id="4120016">i</span><span class="op" id="4120017">+</span><span class="num" id="4120018">1</span><span class="op" id="4120019">,</span>&nbsp;<span class="builtintype" id="4120021">false</span><span class="op" id="4120026">)</span><span class="op" id="4120027">;</span>&nbsp;<span class="ident" id="4120029">d</span><span class="op" id="4120030">.</span><span class="ident" id="4120031">err</span>&nbsp;<span class="op" id="4120035">!=</span>&nbsp;<span class="ident" id="4120038">nil</span>&nbsp;<span class="op" id="4120042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4120050">return</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4120062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4120069">d</span><span class="op" id="4120070">.</span><span class="ident" id="4120071">tokens</span>&nbsp;<span class="op" id="4120078">=</span>&nbsp;<span class="ident" id="4120080">d</span><span class="op" id="4120081">.</span><span class="ident" id="4120082">tokens</span><span class="op" id="4120088">[</span><span class="op" id="4120089">:</span><span class="num" id="4120090">0</span><span class="op" id="4120091">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4120097">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4120102">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4120107">d</span><span class="op" id="4120108">.</span><span class="ident" id="4120109">index</span><span class="op" id="4120114">++</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4120120">if</span>&nbsp;<span class="ident" id="4120123">d</span><span class="op" id="4120124">.</span><span class="ident" id="4120125">fastSkipHashing</span>&nbsp;<span class="op" id="4120141">==</span>&nbsp;<span class="ident" id="4120144">skipNever</span>&nbsp;<span class="op" id="4120154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4120160">d</span><span class="op" id="4120161">.</span><span class="ident" id="4120162">byteAvailable</span>&nbsp;<span class="op" id="4120176">=</span>&nbsp;<span class="builtintype" id="4120178">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4120186">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4120190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4120193">}</span><br>
<span class="lineno">360</span><span class="op" id="4120195">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4120198">func</span>&nbsp;<span class="op" id="4120203">(</span><span class="ident" id="4120204">d</span>&nbsp;<span class="op" id="4120206">*</span><span class="ident" id="4120207">compressor</span><span class="op" id="4120217">)</span>&nbsp;<span class="ident" id="4120219">fillStore</span><span class="op" id="4120228">(</span><span class="ident" id="4120229">b</span>&nbsp;<span class="op" id="4120231">[</span><span class="op" id="4120232">]</span><span class="builtintype" id="4120233">byte</span><span class="op" id="4120237">)</span>&nbsp;<span class="builtintype" id="4120239">int</span>&nbsp;<span class="op" id="4120243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4120246">n</span>&nbsp;<span class="op" id="4120248">:=</span>&nbsp;<span class="builtinfunc" id="4120251">copy</span><span class="op" id="4120255">(</span><span class="ident" id="4120256">d</span><span class="op" id="4120257">.</span><span class="ident" id="4120258">window</span><span class="op" id="4120264">[</span><span class="ident" id="4120265">d</span><span class="op" id="4120266">.</span><span class="ident" id="4120267">windowEnd</span><span class="op" id="4120276">:</span><span class="op" id="4120277">]</span><span class="op" id="4120278">,</span>&nbsp;<span class="ident" id="4120280">b</span><span class="op" id="4120281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4120284">d</span><span class="op" id="4120285">.</span><span class="ident" id="4120286">windowEnd</span>&nbsp;<span class="op" id="4120296">+=</span>&nbsp;<span class="ident" id="4120299">n</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4120302">return</span>&nbsp;<span class="ident" id="4120309">n</span><br>
<span class="lineno"></span><span class="op" id="4120311">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4120314">func</span>&nbsp;<span class="op" id="4120319">(</span><span class="ident" id="4120320">d</span>&nbsp;<span class="op" id="4120322">*</span><span class="ident" id="4120323">compressor</span><span class="op" id="4120333">)</span>&nbsp;<span class="ident" id="4120335">store</span><span class="op" id="4120340">(</span><span class="op" id="4120341">)</span>&nbsp;<span class="op" id="4120343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4120346">if</span>&nbsp;<span class="ident" id="4120349">d</span><span class="op" id="4120350">.</span><span class="ident" id="4120351">windowEnd</span>&nbsp;<span class="op" id="4120361">&gt;</span>&nbsp;<span class="num" id="4120363">0</span>&nbsp;<span class="op" id="4120365">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4120369">d</span><span class="op" id="4120370">.</span><span class="ident" id="4120371">err</span>&nbsp;<span class="op" id="4120375">=</span>&nbsp;<span class="ident" id="4120377">d</span><span class="op" id="4120378">.</span><span class="ident" id="4120379">writeStoredBlock</span><span class="op" id="4120395">(</span><span class="ident" id="4120396">d</span><span class="op" id="4120397">.</span><span class="ident" id="4120398">window</span><span class="op" id="4120404">[</span><span class="op" id="4120405">:</span><span class="ident" id="4120406">d</span><span class="op" id="4120407">.</span><span class="ident" id="4120408">windowEnd</span><span class="op" id="4120417">]</span><span class="op" id="4120418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4120421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4120424">d</span><span class="op" id="4120425">.</span><span class="ident" id="4120426">windowEnd</span>&nbsp;<span class="op" id="4120436">=</span>&nbsp;<span class="num" id="4120438">0</span><br>
<span class="lineno"></span><span class="op" id="4120440">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">375</span><span class="keyword" id="4120443">func</span>&nbsp;<span class="op" id="4120448">(</span><span class="ident" id="4120449">d</span>&nbsp;<span class="op" id="4120451">*</span><span class="ident" id="4120452">compressor</span><span class="op" id="4120462">)</span>&nbsp;<span class="ident" id="4120464">write</span><span class="op" id="4120469">(</span><span class="ident" id="4120470">b</span>&nbsp;<span class="op" id="4120472">[</span><span class="op" id="4120473">]</span><span class="builtintype" id="4120474">byte</span><span class="op" id="4120478">)</span>&nbsp;<span class="op" id="4120480">(</span><span class="ident" id="4120481">n</span>&nbsp;<span class="builtintype" id="4120483">int</span><span class="op" id="4120486">,</span>&nbsp;<span class="ident" id="4120488">err</span>&nbsp;<span class="builtintype" id="4120492">error</span><span class="op" id="4120497">)</span>&nbsp;<span class="op" id="4120499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4120502">n</span>&nbsp;<span class="op" id="4120504">=</span>&nbsp;<span class="builtinfunc" id="4120506">len</span><span class="op" id="4120509">(</span><span class="ident" id="4120510">b</span><span class="op" id="4120511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4120514">b</span>&nbsp;<span class="op" id="4120516">=</span>&nbsp;<span class="ident" id="4120518">b</span><span class="op" id="4120519">[</span><span class="ident" id="4120520">d</span><span class="op" id="4120521">.</span><span class="ident" id="4120522">fill</span><span class="op" id="4120526">(</span><span class="ident" id="4120527">d</span><span class="op" id="4120528">,</span>&nbsp;<span class="ident" id="4120530">b</span><span class="op" id="4120531">)</span><span class="op" id="4120532">:</span><span class="op" id="4120533">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4120536">for</span>&nbsp;<span class="builtinfunc" id="4120540">len</span><span class="op" id="4120543">(</span><span class="ident" id="4120544">b</span><span class="op" id="4120545">)</span>&nbsp;<span class="op" id="4120547">&gt;</span>&nbsp;<span class="num" id="4120549">0</span>&nbsp;<span class="op" id="4120551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4120555">d</span><span class="op" id="4120556">.</span><span class="ident" id="4120557">step</span><span class="op" id="4120561">(</span><span class="ident" id="4120562">d</span><span class="op" id="4120563">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4120567">b</span>&nbsp;<span class="op" id="4120569">=</span>&nbsp;<span class="ident" id="4120571">b</span><span class="op" id="4120572">[</span><span class="ident" id="4120573">d</span><span class="op" id="4120574">.</span><span class="ident" id="4120575">fill</span><span class="op" id="4120579">(</span><span class="ident" id="4120580">d</span><span class="op" id="4120581">,</span>&nbsp;<span class="ident" id="4120583">b</span><span class="op" id="4120584">)</span><span class="op" id="4120585">:</span><span class="op" id="4120586">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4120589">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4120592">return</span>&nbsp;<span class="ident" id="4120599">n</span><span class="op" id="4120600">,</span>&nbsp;<span class="ident" id="4120602">d</span><span class="op" id="4120603">.</span><span class="ident" id="4120604">err</span><br>
<span class="lineno"></span><span class="op" id="4120608">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span><span class="keyword" id="4120611">func</span>&nbsp;<span class="op" id="4120616">(</span><span class="ident" id="4120617">d</span>&nbsp;<span class="op" id="4120619">*</span><span class="ident" id="4120620">compressor</span><span class="op" id="4120630">)</span>&nbsp;<span class="ident" id="4120632">syncFlush</span><span class="op" id="4120641">(</span><span class="op" id="4120642">)</span>&nbsp;<span class="builtintype" id="4120644">error</span>&nbsp;<span class="op" id="4120650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4120653">d</span><span class="op" id="4120654">.</span><span class="ident" id="4120655">sync</span>&nbsp;<span class="op" id="4120660">=</span>&nbsp;<span class="builtintype" id="4120662">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4120668">d</span><span class="op" id="4120669">.</span><span class="ident" id="4120670">step</span><span class="op" id="4120674">(</span><span class="ident" id="4120675">d</span><span class="op" id="4120676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4120679">if</span>&nbsp;<span class="ident" id="4120682">d</span><span class="op" id="4120683">.</span><span class="ident" id="4120684">err</span>&nbsp;<span class="op" id="4120688">==</span>&nbsp;<span class="ident" id="4120691">nil</span>&nbsp;<span class="op" id="4120695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4120699">d</span><span class="op" id="4120700">.</span><span class="ident" id="4120701">w</span><span class="op" id="4120702">.</span><span class="ident" id="4120703">writeStoredHeader</span><span class="op" id="4120720">(</span><span class="num" id="4120721">0</span><span class="op" id="4120722">,</span>&nbsp;<span class="builtintype" id="4120724">false</span><span class="op" id="4120729">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4120733">d</span><span class="op" id="4120734">.</span><span class="ident" id="4120735">w</span><span class="op" id="4120736">.</span><span class="ident" id="4120737">flush</span><span class="op" id="4120742">(</span><span class="op" id="4120743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4120747">d</span><span class="op" id="4120748">.</span><span class="ident" id="4120749">err</span>&nbsp;<span class="op" id="4120753">=</span>&nbsp;<span class="ident" id="4120755">d</span><span class="op" id="4120756">.</span><span class="ident" id="4120757">w</span><span class="op" id="4120758">.</span><span class="ident" id="4120759">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4120764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4120767">d</span><span class="op" id="4120768">.</span><span class="ident" id="4120769">sync</span>&nbsp;<span class="op" id="4120774">=</span>&nbsp;<span class="builtintype" id="4120776">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4120783">return</span>&nbsp;<span class="ident" id="4120790">d</span><span class="op" id="4120791">.</span><span class="ident" id="4120792">err</span><br>
<span class="lineno">395</span><span class="op" id="4120796">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4120799">func</span>&nbsp;<span class="op" id="4120804">(</span><span class="ident" id="4120805">d</span>&nbsp;<span class="op" id="4120807">*</span><span class="ident" id="4120808">compressor</span><span class="op" id="4120818">)</span>&nbsp;<span class="ident" id="4120820">init</span><span class="op" id="4120824">(</span><span class="ident" id="4120825">w</span>&nbsp;<span class="ident" id="4120827">io</span><span class="op" id="4120829">.</span><span class="ident" id="4120830">Writer</span><span class="op" id="4120836">,</span>&nbsp;<span class="ident" id="4120838">level</span>&nbsp;<span class="builtintype" id="4120844">int</span><span class="op" id="4120847">)</span>&nbsp;<span class="op" id="4120849">(</span><span class="ident" id="4120850">err</span>&nbsp;<span class="builtintype" id="4120854">error</span><span class="op" id="4120859">)</span>&nbsp;<span class="op" id="4120861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4120864">d</span><span class="op" id="4120865">.</span><span class="ident" id="4120866">w</span>&nbsp;<span class="op" id="4120868">=</span>&nbsp;<span class="ident" id="4120870">newHuffmanBitWriter</span><span class="op" id="4120889">(</span><span class="ident" id="4120890">w</span><span class="op" id="4120891">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4120895">switch</span>&nbsp;<span class="op" id="4120902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4120905">case</span>&nbsp;<span class="ident" id="4120910">level</span>&nbsp;<span class="op" id="4120916">==</span>&nbsp;<span class="ident" id="4120919">NoCompression</span><span class="op" id="4120932">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4120936">d</span><span class="op" id="4120937">.</span><span class="ident" id="4120938">window</span>&nbsp;<span class="op" id="4120945">=</span>&nbsp;<span class="builtinfunc" id="4120947">make</span><span class="op" id="4120951">(</span><span class="op" id="4120952">[</span><span class="op" id="4120953">]</span><span class="builtintype" id="4120954">byte</span><span class="op" id="4120958">,</span>&nbsp;<span class="ident" id="4120960">maxStoreBlockSize</span><span class="op" id="4120977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4120981">d</span><span class="op" id="4120982">.</span><span class="ident" id="4120983">fill</span>&nbsp;<span class="op" id="4120988">=</span>&nbsp;<span class="op" id="4120990">(</span><span class="op" id="4120991">*</span><span class="ident" id="4120992">compressor</span><span class="op" id="4121002">)</span><span class="op" id="4121003">.</span><span class="ident" id="4121004">fillStore</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4121016">d</span><span class="op" id="4121017">.</span><span class="ident" id="4121018">step</span>&nbsp;<span class="op" id="4121023">=</span>&nbsp;<span class="op" id="4121025">(</span><span class="op" id="4121026">*</span><span class="ident" id="4121027">compressor</span><span class="op" id="4121037">)</span><span class="op" id="4121038">.</span><span class="ident" id="4121039">store</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4121046">case</span>&nbsp;<span class="ident" id="4121051">level</span>&nbsp;<span class="op" id="4121057">==</span>&nbsp;<span class="ident" id="4121060">DefaultCompression</span><span class="op" id="4121078">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4121082">level</span>&nbsp;<span class="op" id="4121088">=</span>&nbsp;<span class="num" id="4121090">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4121094">fallthrough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4121107">case</span>&nbsp;<span class="num" id="4121112">1</span>&nbsp;<span class="op" id="4121114">&lt;=</span>&nbsp;<span class="ident" id="4121117">level</span>&nbsp;<span class="op" id="4121123">&amp;&amp;</span>&nbsp;<span class="ident" id="4121126">level</span>&nbsp;<span class="op" id="4121132">&lt;=</span>&nbsp;<span class="num" id="4121135">9</span><span class="op" id="4121136">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4121140">d</span><span class="op" id="4121141">.</span><span class="ident" id="4121142">compressionLevel</span>&nbsp;<span class="op" id="4121159">=</span>&nbsp;<span class="ident" id="4121161">levels</span><span class="op" id="4121167">[</span><span class="ident" id="4121168">level</span><span class="op" id="4121173">]</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4121177">d</span><span class="op" id="4121178">.</span><span class="ident" id="4121179">initDeflate</span><span class="op" id="4121190">(</span><span class="op" id="4121191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4121195">d</span><span class="op" id="4121196">.</span><span class="ident" id="4121197">fill</span>&nbsp;<span class="op" id="4121202">=</span>&nbsp;<span class="op" id="4121204">(</span><span class="op" id="4121205">*</span><span class="ident" id="4121206">compressor</span><span class="op" id="4121216">)</span><span class="op" id="4121217">.</span><span class="ident" id="4121218">fillDeflate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4121232">d</span><span class="op" id="4121233">.</span><span class="ident" id="4121234">step</span>&nbsp;<span class="op" id="4121239">=</span>&nbsp;<span class="op" id="4121241">(</span><span class="op" id="4121242">*</span><span class="ident" id="4121243">compressor</span><span class="op" id="4121253">)</span><span class="op" id="4121254">.</span><span class="ident" id="4121255">deflate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4121264">default</span><span class="op" id="4121271">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4121275">return</span>&nbsp;<span class="ident" id="4121282">fmt</span><span class="op" id="4121285">.</span><span class="ident" id="4121286">Errorf</span><span class="op" id="4121292">(</span><span class="string" id="4121293">&#34;flate:&nbsp;invalid&nbsp;compression&nbsp;level&nbsp;%d:&nbsp;want&nbsp;value&nbsp;in&nbsp;range&nbsp;[-1,&nbsp;9]&#34;</span><span class="op" id="4121359">,</span>&nbsp;<span class="ident" id="4121361">level</span><span class="op" id="4121366">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4121369">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4121372">return</span>&nbsp;<span class="ident" id="4121379">nil</span><br>
<span class="lineno"></span><span class="op" id="4121383">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4121386">var</span>&nbsp;<span class="ident" id="4121390">zeroes</span>&nbsp;<span class="op" id="4121397">[</span><span class="num" id="4121398">32</span><span class="op" id="4121400">]</span><span class="builtintype" id="4121401">int</span><br>
<span class="lineno">420</span><span class="keyword" id="4121405">var</span>&nbsp;<span class="ident" id="4121409">bzeroes</span>&nbsp;<span class="op" id="4121417">[</span><span class="num" id="4121418">256</span><span class="op" id="4121421">]</span><span class="builtintype" id="4121422">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4121428">func</span>&nbsp;<span class="op" id="4121433">(</span><span class="ident" id="4121434">d</span>&nbsp;<span class="op" id="4121436">*</span><span class="ident" id="4121437">compressor</span><span class="op" id="4121447">)</span>&nbsp;<span class="ident" id="4121449">reset</span><span class="op" id="4121454">(</span><span class="ident" id="4121455">w</span>&nbsp;<span class="ident" id="4121457">io</span><span class="op" id="4121459">.</span><span class="ident" id="4121460">Writer</span><span class="op" id="4121466">)</span>&nbsp;<span class="op" id="4121468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4121471">d</span><span class="op" id="4121472">.</span><span class="ident" id="4121473">w</span><span class="op" id="4121474">.</span><span class="ident" id="4121475">reset</span><span class="op" id="4121480">(</span><span class="ident" id="4121481">w</span><span class="op" id="4121482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4121485">d</span><span class="op" id="4121486">.</span><span class="ident" id="4121487">sync</span>&nbsp;<span class="op" id="4121492">=</span>&nbsp;<span class="builtintype" id="4121494">false</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4121501">d</span><span class="op" id="4121502">.</span><span class="ident" id="4121503">err</span>&nbsp;<span class="op" id="4121507">=</span>&nbsp;<span class="ident" id="4121509">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4121514">switch</span>&nbsp;<span class="ident" id="4121521">d</span><span class="op" id="4121522">.</span><span class="ident" id="4121523">compressionLevel</span><span class="op" id="4121539">.</span><span class="ident" id="4121540">chain</span>&nbsp;<span class="op" id="4121546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4121549">case</span>&nbsp;<span class="num" id="4121554">0</span><span class="op" id="4121555">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4121559">//&nbsp;level&nbsp;was&nbsp;NoCompression.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4121589">for</span>&nbsp;<span class="ident" id="4121593">i</span>&nbsp;<span class="op" id="4121595">:=</span>&nbsp;<span class="keyword" id="4121598">range</span>&nbsp;<span class="ident" id="4121604">d</span><span class="op" id="4121605">.</span><span class="ident" id="4121606">window</span>&nbsp;<span class="op" id="4121613">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4121618">d</span><span class="op" id="4121619">.</span><span class="ident" id="4121620">window</span><span class="op" id="4121626">[</span><span class="ident" id="4121627">i</span><span class="op" id="4121628">]</span>&nbsp;<span class="op" id="4121630">=</span>&nbsp;<span class="num" id="4121632">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4121636">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4121640">d</span><span class="op" id="4121641">.</span><span class="ident" id="4121642">windowEnd</span>&nbsp;<span class="op" id="4121652">=</span>&nbsp;<span class="num" id="4121654">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4121657">default</span><span class="op" id="4121664">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4121668">d</span><span class="op" id="4121669">.</span><span class="ident" id="4121670">chainHead</span>&nbsp;<span class="op" id="4121680">=</span>&nbsp;<span class="op" id="4121682">-</span><span class="num" id="4121683">1</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4121687">for</span>&nbsp;<span class="ident" id="4121691">s</span>&nbsp;<span class="op" id="4121693">:=</span>&nbsp;<span class="ident" id="4121696">d</span><span class="op" id="4121697">.</span><span class="ident" id="4121698">hashHead</span><span class="op" id="4121706">;</span>&nbsp;<span class="builtinfunc" id="4121708">len</span><span class="op" id="4121711">(</span><span class="ident" id="4121712">s</span><span class="op" id="4121713">)</span>&nbsp;<span class="op" id="4121715">&gt;</span>&nbsp;<span class="num" id="4121717">0</span><span class="op" id="4121718">;</span>&nbsp;<span class="op" id="4121720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4121725">n</span>&nbsp;<span class="op" id="4121727">:=</span>&nbsp;<span class="builtinfunc" id="4121730">copy</span><span class="op" id="4121734">(</span><span class="ident" id="4121735">s</span><span class="op" id="4121736">,</span>&nbsp;<span class="ident" id="4121738">zeroes</span><span class="op" id="4121744">[</span><span class="op" id="4121745">:</span><span class="op" id="4121746">]</span><span class="op" id="4121747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4121752">s</span>&nbsp;<span class="op" id="4121754">=</span>&nbsp;<span class="ident" id="4121756">s</span><span class="op" id="4121757">[</span><span class="ident" id="4121758">n</span><span class="op" id="4121759">:</span><span class="op" id="4121760">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4121764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4121768">for</span>&nbsp;<span class="ident" id="4121772">s</span>&nbsp;<span class="op" id="4121774">:=</span>&nbsp;<span class="ident" id="4121777">d</span><span class="op" id="4121778">.</span><span class="ident" id="4121779">hashPrev</span><span class="op" id="4121787">;</span>&nbsp;<span class="builtinfunc" id="4121789">len</span><span class="op" id="4121792">(</span><span class="ident" id="4121793">s</span><span class="op" id="4121794">)</span>&nbsp;<span class="op" id="4121796">&gt;</span>&nbsp;<span class="num" id="4121798">0</span><span class="op" id="4121799">;</span>&nbsp;<span class="ident" id="4121801">s</span>&nbsp;<span class="op" id="4121803">=</span>&nbsp;<span class="ident" id="4121805">s</span><span class="op" id="4121806">[</span><span class="builtinfunc" id="4121807">len</span><span class="op" id="4121810">(</span><span class="ident" id="4121811">zeroes</span><span class="op" id="4121817">)</span><span class="op" id="4121818">:</span><span class="op" id="4121819">]</span>&nbsp;<span class="op" id="4121821">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4121826">copy</span><span class="op" id="4121830">(</span><span class="ident" id="4121831">s</span><span class="op" id="4121832">,</span>&nbsp;<span class="ident" id="4121834">zeroes</span><span class="op" id="4121840">[</span><span class="op" id="4121841">:</span><span class="op" id="4121842">]</span><span class="op" id="4121843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4121847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4121851">d</span><span class="op" id="4121852">.</span><span class="ident" id="4121853">hashOffset</span>&nbsp;<span class="op" id="4121864">=</span>&nbsp;<span class="num" id="4121866">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4121871">d</span><span class="op" id="4121872">.</span><span class="ident" id="4121873">index</span><span class="op" id="4121878">,</span>&nbsp;<span class="ident" id="4121880">d</span><span class="op" id="4121881">.</span><span class="ident" id="4121882">windowEnd</span>&nbsp;<span class="op" id="4121892">=</span>&nbsp;<span class="num" id="4121894">0</span><span class="op" id="4121895">,</span>&nbsp;<span class="num" id="4121897">0</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4121901">for</span>&nbsp;<span class="ident" id="4121905">s</span>&nbsp;<span class="op" id="4121907">:=</span>&nbsp;<span class="ident" id="4121910">d</span><span class="op" id="4121911">.</span><span class="ident" id="4121912">window</span><span class="op" id="4121918">;</span>&nbsp;<span class="builtinfunc" id="4121920">len</span><span class="op" id="4121923">(</span><span class="ident" id="4121924">s</span><span class="op" id="4121925">)</span>&nbsp;<span class="op" id="4121927">&gt;</span>&nbsp;<span class="num" id="4121929">0</span><span class="op" id="4121930">;</span>&nbsp;<span class="op" id="4121932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4121937">n</span>&nbsp;<span class="op" id="4121939">:=</span>&nbsp;<span class="builtinfunc" id="4121942">copy</span><span class="op" id="4121946">(</span><span class="ident" id="4121947">s</span><span class="op" id="4121948">,</span>&nbsp;<span class="ident" id="4121950">bzeroes</span><span class="op" id="4121957">[</span><span class="op" id="4121958">:</span><span class="op" id="4121959">]</span><span class="op" id="4121960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4121965">s</span>&nbsp;<span class="op" id="4121967">=</span>&nbsp;<span class="ident" id="4121969">s</span><span class="op" id="4121970">[</span><span class="ident" id="4121971">n</span><span class="op" id="4121972">:</span><span class="op" id="4121973">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4121977">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4121981">d</span><span class="op" id="4121982">.</span><span class="ident" id="4121983">blockStart</span><span class="op" id="4121993">,</span>&nbsp;<span class="ident" id="4121995">d</span><span class="op" id="4121996">.</span><span class="ident" id="4121997">byteAvailable</span>&nbsp;<span class="op" id="4122011">=</span>&nbsp;<span class="num" id="4122013">0</span><span class="op" id="4122014">,</span>&nbsp;<span class="builtintype" id="4122016">false</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4122025">d</span><span class="op" id="4122026">.</span><span class="ident" id="4122027">tokens</span>&nbsp;<span class="op" id="4122034">=</span>&nbsp;<span class="ident" id="4122036">d</span><span class="op" id="4122037">.</span><span class="ident" id="4122038">tokens</span><span class="op" id="4122044">[</span><span class="op" id="4122045">:</span><span class="ident" id="4122046">maxFlateBlockTokens</span><span class="op" id="4122065">+</span><span class="num" id="4122066">1</span><span class="op" id="4122067">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4122071">for</span>&nbsp;<span class="ident" id="4122075">i</span>&nbsp;<span class="op" id="4122077">:=</span>&nbsp;<span class="num" id="4122080">0</span><span class="op" id="4122081">;</span>&nbsp;<span class="ident" id="4122083">i</span>&nbsp;<span class="op" id="4122085">&lt;=</span>&nbsp;<span class="ident" id="4122088">maxFlateBlockTokens</span><span class="op" id="4122107">;</span>&nbsp;<span class="ident" id="4122109">i</span><span class="op" id="4122110">++</span>&nbsp;<span class="op" id="4122113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4122118">d</span><span class="op" id="4122119">.</span><span class="ident" id="4122120">tokens</span><span class="op" id="4122126">[</span><span class="ident" id="4122127">i</span><span class="op" id="4122128">]</span>&nbsp;<span class="op" id="4122130">=</span>&nbsp;<span class="num" id="4122132">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4122136">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4122140">d</span><span class="op" id="4122141">.</span><span class="ident" id="4122142">tokens</span>&nbsp;<span class="op" id="4122149">=</span>&nbsp;<span class="ident" id="4122151">d</span><span class="op" id="4122152">.</span><span class="ident" id="4122153">tokens</span><span class="op" id="4122159">[</span><span class="op" id="4122160">:</span><span class="num" id="4122161">0</span><span class="op" id="4122162">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4122166">d</span><span class="op" id="4122167">.</span><span class="ident" id="4122168">length</span>&nbsp;<span class="op" id="4122175">=</span>&nbsp;<span class="ident" id="4122177">minMatchLength</span>&nbsp;<span class="op" id="4122192">-</span>&nbsp;<span class="num" id="4122194">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4122198">d</span><span class="op" id="4122199">.</span><span class="ident" id="4122200">offset</span>&nbsp;<span class="op" id="4122207">=</span>&nbsp;<span class="num" id="4122209">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4122213">d</span><span class="op" id="4122214">.</span><span class="ident" id="4122215">hash</span>&nbsp;<span class="op" id="4122220">=</span>&nbsp;<span class="num" id="4122222">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4122226">d</span><span class="op" id="4122227">.</span><span class="ident" id="4122228">maxInsertIndex</span>&nbsp;<span class="op" id="4122243">=</span>&nbsp;<span class="num" id="4122245">0</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4122248">}</span><br>
<span class="lineno"></span><span class="op" id="4122250">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4122253">func</span>&nbsp;<span class="op" id="4122258">(</span><span class="ident" id="4122259">d</span>&nbsp;<span class="op" id="4122261">*</span><span class="ident" id="4122262">compressor</span><span class="op" id="4122272">)</span>&nbsp;<span class="builtinfunc" id="4122274">close</span><span class="op" id="4122279">(</span><span class="op" id="4122280">)</span>&nbsp;<span class="builtintype" id="4122282">error</span>&nbsp;<span class="op" id="4122288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4122291">d</span><span class="op" id="4122292">.</span><span class="ident" id="4122293">sync</span>&nbsp;<span class="op" id="4122298">=</span>&nbsp;<span class="builtintype" id="4122300">true</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4122306">d</span><span class="op" id="4122307">.</span><span class="ident" id="4122308">step</span><span class="op" id="4122312">(</span><span class="ident" id="4122313">d</span><span class="op" id="4122314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4122317">if</span>&nbsp;<span class="ident" id="4122320">d</span><span class="op" id="4122321">.</span><span class="ident" id="4122322">err</span>&nbsp;<span class="op" id="4122326">!=</span>&nbsp;<span class="ident" id="4122329">nil</span>&nbsp;<span class="op" id="4122333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4122337">return</span>&nbsp;<span class="ident" id="4122344">d</span><span class="op" id="4122345">.</span><span class="ident" id="4122346">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4122351">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4122354">if</span>&nbsp;<span class="ident" id="4122357">d</span><span class="op" id="4122358">.</span><span class="ident" id="4122359">w</span><span class="op" id="4122360">.</span><span class="ident" id="4122361">writeStoredHeader</span><span class="op" id="4122378">(</span><span class="num" id="4122379">0</span><span class="op" id="4122380">,</span>&nbsp;<span class="builtintype" id="4122382">true</span><span class="op" id="4122386">)</span><span class="op" id="4122387">;</span>&nbsp;<span class="ident" id="4122389">d</span><span class="op" id="4122390">.</span><span class="ident" id="4122391">w</span><span class="op" id="4122392">.</span><span class="ident" id="4122393">err</span>&nbsp;<span class="op" id="4122397">!=</span>&nbsp;<span class="ident" id="4122400">nil</span>&nbsp;<span class="op" id="4122404">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4122408">return</span>&nbsp;<span class="ident" id="4122415">d</span><span class="op" id="4122416">.</span><span class="ident" id="4122417">w</span><span class="op" id="4122418">.</span><span class="ident" id="4122419">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4122424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4122427">d</span><span class="op" id="4122428">.</span><span class="ident" id="4122429">w</span><span class="op" id="4122430">.</span><span class="ident" id="4122431">flush</span><span class="op" id="4122436">(</span><span class="op" id="4122437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4122440">return</span>&nbsp;<span class="ident" id="4122447">d</span><span class="op" id="4122448">.</span><span class="ident" id="4122449">w</span><span class="op" id="4122450">.</span><span class="ident" id="4122451">err</span><br>
<span class="lineno"></span><span class="op" id="4122455">}</span><br>
<span class="lineno">475</span><br>
<span class="lineno"></span><span class="comment" id="4122458">//&nbsp;NewWriter&nbsp;returns&nbsp;a&nbsp;new&nbsp;Writer&nbsp;compressing&nbsp;data&nbsp;at&nbsp;the&nbsp;given&nbsp;level.</span><br>
<span class="lineno"></span><span class="comment" id="4122529">//&nbsp;Following&nbsp;zlib,&nbsp;levels&nbsp;range&nbsp;from&nbsp;1&nbsp;(BestSpeed)&nbsp;to&nbsp;9&nbsp;(BestCompression);</span><br>
<span class="lineno"></span><span class="comment" id="4122604">//&nbsp;higher&nbsp;levels&nbsp;typically&nbsp;run&nbsp;slower&nbsp;but&nbsp;compress&nbsp;more.&nbsp;Level&nbsp;0</span><br>
<span class="lineno"></span><span class="comment" id="4122669">//&nbsp;(NoCompression)&nbsp;does&nbsp;not&nbsp;attempt&nbsp;any&nbsp;compression;&nbsp;it&nbsp;only&nbsp;adds&nbsp;the</span><br>
<span class="lineno">480</span><span class="comment" id="4122739">//&nbsp;necessary&nbsp;DEFLATE&nbsp;framing.&nbsp;Level&nbsp;-1&nbsp;(DefaultCompression)&nbsp;uses&nbsp;the&nbsp;default</span><br>
<span class="lineno"></span><span class="comment" id="4122816">//&nbsp;compression&nbsp;level.</span><br>
<span class="lineno"></span><span class="comment" id="4122838">//</span><br>
<span class="lineno"></span><span class="comment" id="4122841">//&nbsp;If&nbsp;level&nbsp;is&nbsp;in&nbsp;the&nbsp;range&nbsp;[-1,&nbsp;9]&nbsp;then&nbsp;the&nbsp;error&nbsp;returned&nbsp;will&nbsp;be&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="4122914">//&nbsp;Otherwise&nbsp;the&nbsp;error&nbsp;returned&nbsp;will&nbsp;be&nbsp;non-nil.</span><br>
<span class="lineno">485</span><span class="keyword" id="4122963">func</span>&nbsp;<span class="ident" id="4122968">NewWriter</span><span class="op" id="4122977">(</span><span class="ident" id="4122978">w</span>&nbsp;<span class="ident" id="4122980">io</span><span class="op" id="4122982">.</span><span class="ident" id="4122983">Writer</span><span class="op" id="4122989">,</span>&nbsp;<span class="ident" id="4122991">level</span>&nbsp;<span class="builtintype" id="4122997">int</span><span class="op" id="4123000">)</span>&nbsp;<span class="op" id="4123002">(</span><span class="op" id="4123003">*</span><span class="ident" id="4123004">Writer</span><span class="op" id="4123010">,</span>&nbsp;<span class="builtintype" id="4123012">error</span><span class="op" id="4123017">)</span>&nbsp;<span class="op" id="4123019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4123022">var</span>&nbsp;<span class="ident" id="4123026">dw</span>&nbsp;<span class="ident" id="4123029">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4123037">if</span>&nbsp;<span class="ident" id="4123040">err</span>&nbsp;<span class="op" id="4123044">:=</span>&nbsp;<span class="ident" id="4123047">dw</span><span class="op" id="4123049">.</span><span class="ident" id="4123050">d</span><span class="op" id="4123051">.</span><span class="ident" id="4123052">init</span><span class="op" id="4123056">(</span><span class="ident" id="4123057">w</span><span class="op" id="4123058">,</span>&nbsp;<span class="ident" id="4123060">level</span><span class="op" id="4123065">)</span><span class="op" id="4123066">;</span>&nbsp;<span class="ident" id="4123068">err</span>&nbsp;<span class="op" id="4123072">!=</span>&nbsp;<span class="ident" id="4123075">nil</span>&nbsp;<span class="op" id="4123079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4123083">return</span>&nbsp;<span class="ident" id="4123090">nil</span><span class="op" id="4123093">,</span>&nbsp;<span class="ident" id="4123095">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4123100">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4123103">return</span>&nbsp;<span class="op" id="4123110">&amp;</span><span class="ident" id="4123111">dw</span><span class="op" id="4123113">,</span>&nbsp;<span class="ident" id="4123115">nil</span><br>
<span class="lineno"></span><span class="op" id="4123119">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4123122">//&nbsp;NewWriterDict&nbsp;is&nbsp;like&nbsp;NewWriter&nbsp;but&nbsp;initializes&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="4123181">//&nbsp;Writer&nbsp;with&nbsp;a&nbsp;preset&nbsp;dictionary.&nbsp;&nbsp;The&nbsp;returned&nbsp;Writer&nbsp;behaves</span><br>
<span class="lineno">495</span><span class="comment" id="4123246">//&nbsp;as&nbsp;if&nbsp;the&nbsp;dictionary&nbsp;had&nbsp;been&nbsp;written&nbsp;to&nbsp;it&nbsp;without&nbsp;producing</span><br>
<span class="lineno"></span><span class="comment" id="4123311">//&nbsp;any&nbsp;compressed&nbsp;output.&nbsp;&nbsp;The&nbsp;compressed&nbsp;data&nbsp;written&nbsp;to&nbsp;w</span><br>
<span class="lineno"></span><span class="comment" id="4123371">//&nbsp;can&nbsp;only&nbsp;be&nbsp;decompressed&nbsp;by&nbsp;a&nbsp;Reader&nbsp;initialized&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4123432">//&nbsp;same&nbsp;dictionary.</span><br>
<span class="lineno"></span><span class="keyword" id="4123452">func</span>&nbsp;<span class="ident" id="4123457">NewWriterDict</span><span class="op" id="4123470">(</span><span class="ident" id="4123471">w</span>&nbsp;<span class="ident" id="4123473">io</span><span class="op" id="4123475">.</span><span class="ident" id="4123476">Writer</span><span class="op" id="4123482">,</span>&nbsp;<span class="ident" id="4123484">level</span>&nbsp;<span class="builtintype" id="4123490">int</span><span class="op" id="4123493">,</span>&nbsp;<span class="ident" id="4123495">dict</span>&nbsp;<span class="op" id="4123500">[</span><span class="op" id="4123501">]</span><span class="builtintype" id="4123502">byte</span><span class="op" id="4123506">)</span>&nbsp;<span class="op" id="4123508">(</span><span class="op" id="4123509">*</span><span class="ident" id="4123510">Writer</span><span class="op" id="4123516">,</span>&nbsp;<span class="builtintype" id="4123518">error</span><span class="op" id="4123523">)</span>&nbsp;<span class="op" id="4123525">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4123528">dw</span>&nbsp;<span class="op" id="4123531">:=</span>&nbsp;<span class="op" id="4123534">&amp;</span><span class="ident" id="4123535">dictWriter</span><span class="op" id="4123545">{</span><span class="ident" id="4123546">w</span><span class="op" id="4123547">,</span>&nbsp;<span class="builtintype" id="4123549">false</span><span class="op" id="4123554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4123557">zw</span><span class="op" id="4123559">,</span>&nbsp;<span class="ident" id="4123561">err</span>&nbsp;<span class="op" id="4123565">:=</span>&nbsp;<span class="ident" id="4123568">NewWriter</span><span class="op" id="4123577">(</span><span class="ident" id="4123578">dw</span><span class="op" id="4123580">,</span>&nbsp;<span class="ident" id="4123582">level</span><span class="op" id="4123587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4123590">if</span>&nbsp;<span class="ident" id="4123593">err</span>&nbsp;<span class="op" id="4123597">!=</span>&nbsp;<span class="ident" id="4123600">nil</span>&nbsp;<span class="op" id="4123604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4123608">return</span>&nbsp;<span class="ident" id="4123615">nil</span><span class="op" id="4123618">,</span>&nbsp;<span class="ident" id="4123620">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4123625">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4123628">zw</span><span class="op" id="4123630">.</span><span class="ident" id="4123631">Write</span><span class="op" id="4123636">(</span><span class="ident" id="4123637">dict</span><span class="op" id="4123641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4123644">zw</span><span class="op" id="4123646">.</span><span class="ident" id="4123647">Flush</span><span class="op" id="4123652">(</span><span class="op" id="4123653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4123656">dw</span><span class="op" id="4123658">.</span><span class="ident" id="4123659">enabled</span>&nbsp;<span class="op" id="4123667">=</span>&nbsp;<span class="builtintype" id="4123669">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4123675">zw</span><span class="op" id="4123677">.</span><span class="ident" id="4123678">dict</span>&nbsp;<span class="op" id="4123683">=</span>&nbsp;<span class="builtinfunc" id="4123685">append</span><span class="op" id="4123691">(</span><span class="ident" id="4123692">zw</span><span class="op" id="4123694">.</span><span class="ident" id="4123695">dict</span><span class="op" id="4123699">,</span>&nbsp;<span class="ident" id="4123701">dict</span><span class="op" id="4123705">...</span><span class="op" id="4123708">)</span>&nbsp;<span class="comment" id="4123710">//&nbsp;duplicate&nbsp;dictionary&nbsp;for&nbsp;Reset&nbsp;method.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4123753">return</span>&nbsp;<span class="ident" id="4123760">zw</span><span class="op" id="4123762">,</span>&nbsp;<span class="ident" id="4123764">err</span><br>
<span class="lineno">510</span><span class="op" id="4123768">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4123771">type</span>&nbsp;<span class="ident" id="4123776">dictWriter</span>&nbsp;<span class="keyword" id="4123787">struct</span>&nbsp;<span class="op" id="4123794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4123797">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4123805">io</span><span class="op" id="4123807">.</span><span class="ident" id="4123808">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4123816">enabled</span>&nbsp;<span class="builtintype" id="4123824">bool</span><br>
<span class="lineno">515</span><span class="op" id="4123829">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4123832">func</span>&nbsp;<span class="op" id="4123837">(</span><span class="ident" id="4123838">w</span>&nbsp;<span class="op" id="4123840">*</span><span class="ident" id="4123841">dictWriter</span><span class="op" id="4123851">)</span>&nbsp;<span class="ident" id="4123853">Write</span><span class="op" id="4123858">(</span><span class="ident" id="4123859">b</span>&nbsp;<span class="op" id="4123861">[</span><span class="op" id="4123862">]</span><span class="builtintype" id="4123863">byte</span><span class="op" id="4123867">)</span>&nbsp;<span class="op" id="4123869">(</span><span class="ident" id="4123870">n</span>&nbsp;<span class="builtintype" id="4123872">int</span><span class="op" id="4123875">,</span>&nbsp;<span class="ident" id="4123877">err</span>&nbsp;<span class="builtintype" id="4123881">error</span><span class="op" id="4123886">)</span>&nbsp;<span class="op" id="4123888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4123891">if</span>&nbsp;<span class="ident" id="4123894">w</span><span class="op" id="4123895">.</span><span class="ident" id="4123896">enabled</span>&nbsp;<span class="op" id="4123904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4123908">return</span>&nbsp;<span class="ident" id="4123915">w</span><span class="op" id="4123916">.</span><span class="ident" id="4123917">w</span><span class="op" id="4123918">.</span><span class="ident" id="4123919">Write</span><span class="op" id="4123924">(</span><span class="ident" id="4123925">b</span><span class="op" id="4123926">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4123929">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4123932">return</span>&nbsp;<span class="builtinfunc" id="4123939">len</span><span class="op" id="4123942">(</span><span class="ident" id="4123943">b</span><span class="op" id="4123944">)</span><span class="op" id="4123945">,</span>&nbsp;<span class="ident" id="4123947">nil</span><br>
<span class="lineno"></span><span class="op" id="4123951">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4123954">//&nbsp;A&nbsp;Writer&nbsp;takes&nbsp;data&nbsp;written&nbsp;to&nbsp;it&nbsp;and&nbsp;writes&nbsp;the&nbsp;compressed</span><br>
<span class="lineno">525</span><span class="comment" id="4124017">//&nbsp;form&nbsp;of&nbsp;that&nbsp;data&nbsp;to&nbsp;an&nbsp;underlying&nbsp;writer&nbsp;(see&nbsp;NewWriter).</span><br>
<span class="lineno"></span><span class="keyword" id="4124079">type</span>&nbsp;<span class="ident" id="4124084">Writer</span>&nbsp;<span class="keyword" id="4124091">struct</span>&nbsp;<span class="op" id="4124098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4124101">d</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4124106">compressor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4124118">dict</span>&nbsp;<span class="op" id="4124123">[</span><span class="op" id="4124124">]</span><span class="builtintype" id="4124125">byte</span><br>
<span class="lineno"></span><span class="op" id="4124130">}</span><br>
<span class="lineno">530</span><br>
<span class="lineno"></span><span class="comment" id="4124133">//&nbsp;Write&nbsp;writes&nbsp;data&nbsp;to&nbsp;w,&nbsp;which&nbsp;will&nbsp;eventually&nbsp;write&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4124192">//&nbsp;compressed&nbsp;form&nbsp;of&nbsp;data&nbsp;to&nbsp;its&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4124245">func</span>&nbsp;<span class="op" id="4124250">(</span><span class="ident" id="4124251">w</span>&nbsp;<span class="op" id="4124253">*</span><span class="ident" id="4124254">Writer</span><span class="op" id="4124260">)</span>&nbsp;<span class="ident" id="4124262">Write</span><span class="op" id="4124267">(</span><span class="ident" id="4124268">data</span>&nbsp;<span class="op" id="4124273">[</span><span class="op" id="4124274">]</span><span class="builtintype" id="4124275">byte</span><span class="op" id="4124279">)</span>&nbsp;<span class="op" id="4124281">(</span><span class="ident" id="4124282">n</span>&nbsp;<span class="builtintype" id="4124284">int</span><span class="op" id="4124287">,</span>&nbsp;<span class="ident" id="4124289">err</span>&nbsp;<span class="builtintype" id="4124293">error</span><span class="op" id="4124298">)</span>&nbsp;<span class="op" id="4124300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4124303">return</span>&nbsp;<span class="ident" id="4124310">w</span><span class="op" id="4124311">.</span><span class="ident" id="4124312">d</span><span class="op" id="4124313">.</span><span class="ident" id="4124314">write</span><span class="op" id="4124319">(</span><span class="ident" id="4124320">data</span><span class="op" id="4124324">)</span><br>
<span class="lineno">535</span><span class="op" id="4124326">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4124329">//&nbsp;Flush&nbsp;flushes&nbsp;any&nbsp;pending&nbsp;compressed&nbsp;data&nbsp;to&nbsp;the&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="comment" id="4124400">//&nbsp;It&nbsp;is&nbsp;useful&nbsp;mainly&nbsp;in&nbsp;compressed&nbsp;network&nbsp;protocols,&nbsp;to&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="4124471">//&nbsp;a&nbsp;remote&nbsp;reader&nbsp;has&nbsp;enough&nbsp;data&nbsp;to&nbsp;reconstruct&nbsp;a&nbsp;packet.</span><br>
<span class="lineno">540</span><span class="comment" id="4124531">//&nbsp;Flush&nbsp;does&nbsp;not&nbsp;return&nbsp;until&nbsp;the&nbsp;data&nbsp;has&nbsp;been&nbsp;written.</span><br>
<span class="lineno"></span><span class="comment" id="4124589">//&nbsp;If&nbsp;the&nbsp;underlying&nbsp;writer&nbsp;returns&nbsp;an&nbsp;error,&nbsp;Flush&nbsp;returns&nbsp;that&nbsp;error.</span><br>
<span class="lineno"></span><span class="comment" id="4124661">//</span><br>
<span class="lineno"></span><span class="comment" id="4124664">//&nbsp;In&nbsp;the&nbsp;terminology&nbsp;of&nbsp;the&nbsp;zlib&nbsp;library,&nbsp;Flush&nbsp;is&nbsp;equivalent&nbsp;to&nbsp;Z_SYNC_FLUSH.</span><br>
<span class="lineno"></span><span class="keyword" id="4124744">func</span>&nbsp;<span class="op" id="4124749">(</span><span class="ident" id="4124750">w</span>&nbsp;<span class="op" id="4124752">*</span><span class="ident" id="4124753">Writer</span><span class="op" id="4124759">)</span>&nbsp;<span class="ident" id="4124761">Flush</span><span class="op" id="4124766">(</span><span class="op" id="4124767">)</span>&nbsp;<span class="builtintype" id="4124769">error</span>&nbsp;<span class="op" id="4124775">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4124778">//&nbsp;For&nbsp;more&nbsp;about&nbsp;flushing:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4124807">//&nbsp;http://www.bolet.org/~pornin/deflate-flush.html</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4124859">return</span>&nbsp;<span class="ident" id="4124866">w</span><span class="op" id="4124867">.</span><span class="ident" id="4124868">d</span><span class="op" id="4124869">.</span><span class="ident" id="4124870">syncFlush</span><span class="op" id="4124879">(</span><span class="op" id="4124880">)</span><br>
<span class="lineno"></span><span class="op" id="4124882">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">550</span><span class="comment" id="4124885">//&nbsp;Close&nbsp;flushes&nbsp;and&nbsp;closes&nbsp;the&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4124925">func</span>&nbsp;<span class="op" id="4124930">(</span><span class="ident" id="4124931">w</span>&nbsp;<span class="op" id="4124933">*</span><span class="ident" id="4124934">Writer</span><span class="op" id="4124940">)</span>&nbsp;<span class="ident" id="4124942">Close</span><span class="op" id="4124947">(</span><span class="op" id="4124948">)</span>&nbsp;<span class="builtintype" id="4124950">error</span>&nbsp;<span class="op" id="4124956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4124959">return</span>&nbsp;<span class="ident" id="4124966">w</span><span class="op" id="4124967">.</span><span class="ident" id="4124968">d</span><span class="op" id="4124969">.</span><span class="builtinfunc" id="4124970">close</span><span class="op" id="4124975">(</span><span class="op" id="4124976">)</span><br>
<span class="lineno"></span><span class="op" id="4124978">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">555</span><span class="comment" id="4124981">//&nbsp;Reset&nbsp;discards&nbsp;the&nbsp;writer&#39;s&nbsp;state&nbsp;and&nbsp;makes&nbsp;it&nbsp;equivalent&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4125045">//&nbsp;the&nbsp;result&nbsp;of&nbsp;NewWriter&nbsp;or&nbsp;NewWriterDict&nbsp;called&nbsp;with&nbsp;dst</span><br>
<span class="lineno"></span><span class="comment" id="4125105">//&nbsp;and&nbsp;w&#39;s&nbsp;level&nbsp;and&nbsp;dictionary.</span><br>
<span class="lineno"></span><span class="keyword" id="4125138">func</span>&nbsp;<span class="op" id="4125143">(</span><span class="ident" id="4125144">w</span>&nbsp;<span class="op" id="4125146">*</span><span class="ident" id="4125147">Writer</span><span class="op" id="4125153">)</span>&nbsp;<span class="ident" id="4125155">Reset</span><span class="op" id="4125160">(</span><span class="ident" id="4125161">dst</span>&nbsp;<span class="ident" id="4125165">io</span><span class="op" id="4125167">.</span><span class="ident" id="4125168">Writer</span><span class="op" id="4125174">)</span>&nbsp;<span class="op" id="4125176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4125179">if</span>&nbsp;<span class="ident" id="4125182">dw</span><span class="op" id="4125184">,</span>&nbsp;<span class="ident" id="4125186">ok</span>&nbsp;<span class="op" id="4125189">:=</span>&nbsp;<span class="ident" id="4125192">w</span><span class="op" id="4125193">.</span><span class="ident" id="4125194">d</span><span class="op" id="4125195">.</span><span class="ident" id="4125196">w</span><span class="op" id="4125197">.</span><span class="ident" id="4125198">w</span><span class="op" id="4125199">.</span><span class="op" id="4125200">(</span><span class="op" id="4125201">*</span><span class="ident" id="4125202">dictWriter</span><span class="op" id="4125212">)</span><span class="op" id="4125213">;</span>&nbsp;<span class="ident" id="4125215">ok</span>&nbsp;<span class="op" id="4125218">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4125222">//&nbsp;w&nbsp;was&nbsp;created&nbsp;with&nbsp;NewWriterDict</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4125260">dw</span><span class="op" id="4125262">.</span><span class="ident" id="4125263">w</span>&nbsp;<span class="op" id="4125265">=</span>&nbsp;<span class="ident" id="4125267">dst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4125273">w</span><span class="op" id="4125274">.</span><span class="ident" id="4125275">d</span><span class="op" id="4125276">.</span><span class="ident" id="4125277">reset</span><span class="op" id="4125282">(</span><span class="ident" id="4125283">dw</span><span class="op" id="4125285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4125289">dw</span><span class="op" id="4125291">.</span><span class="ident" id="4125292">enabled</span>&nbsp;<span class="op" id="4125300">=</span>&nbsp;<span class="builtintype" id="4125302">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4125310">w</span><span class="op" id="4125311">.</span><span class="ident" id="4125312">Write</span><span class="op" id="4125317">(</span><span class="ident" id="4125318">w</span><span class="op" id="4125319">.</span><span class="ident" id="4125320">dict</span><span class="op" id="4125324">)</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4125328">w</span><span class="op" id="4125329">.</span><span class="ident" id="4125330">Flush</span><span class="op" id="4125335">(</span><span class="op" id="4125336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4125340">dw</span><span class="op" id="4125342">.</span><span class="ident" id="4125343">enabled</span>&nbsp;<span class="op" id="4125351">=</span>&nbsp;<span class="builtintype" id="4125353">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4125359">}</span>&nbsp;<span class="keyword" id="4125361">else</span>&nbsp;<span class="op" id="4125366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4125370">//&nbsp;w&nbsp;was&nbsp;created&nbsp;with&nbsp;NewWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4125404">w</span><span class="op" id="4125405">.</span><span class="ident" id="4125406">d</span><span class="op" id="4125407">.</span><span class="ident" id="4125408">reset</span><span class="op" id="4125413">(</span><span class="ident" id="4125414">dst</span><span class="op" id="4125417">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4125420">}</span><br>
<span class="lineno"></span><span class="op" id="4125422">}</span>
</div>
</body>
</html>
