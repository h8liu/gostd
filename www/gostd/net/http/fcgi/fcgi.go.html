<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/fcgi</h2>
<ul>
<li><a href="/gostd/net/http/fcgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi.go.html" class="current">fcgi.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi_test.go.html">fcgi_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5625082">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5625137">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5625191">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5625242">//&nbsp;Package&nbsp;fcgi&nbsp;implements&nbsp;the&nbsp;FastCGI&nbsp;protocol.</span><br>
<span class="lineno"></span><span class="comment" id="5625291">//&nbsp;Currently&nbsp;only&nbsp;the&nbsp;responder&nbsp;role&nbsp;is&nbsp;supported.</span><br>
<span class="lineno"></span><span class="comment" id="5625342">//&nbsp;The&nbsp;protocol&nbsp;is&nbsp;defined&nbsp;at&nbsp;http://www.fastcgi.com/drupal/node/6?q=node/22</span><br>
<span class="lineno"></span><span class="keyword" id="5625419">package</span>&nbsp;<span class="ident" id="5625427">fcgi</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="5625433">//&nbsp;This&nbsp;file&nbsp;defines&nbsp;the&nbsp;raw&nbsp;protocol&nbsp;and&nbsp;some&nbsp;utilities&nbsp;used&nbsp;by&nbsp;the&nbsp;child&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5625512">//&nbsp;the&nbsp;host.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5625526">import</span>&nbsp;<span class="op" id="5625533">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5625536">&#34;bufio&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5625545">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5625554">&#34;encoding/binary&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5625573">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5625583">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5625589">&#34;sync&#34;</span><br>
<span class="lineno">20</span><span class="op" id="5625596">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5625599">//&nbsp;recType&nbsp;is&nbsp;a&nbsp;record&nbsp;type,&nbsp;as&nbsp;defined&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="5625642">//&nbsp;http://www.fastcgi.com/devkit/doc/fcgi-spec.html#S8</span><br>
<span class="lineno"></span><span class="keyword" id="5625697">type</span>&nbsp;<span class="ident" id="5625702">recType</span>&nbsp;<span class="builtintype" id="5625710">uint8</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="5625717">const</span>&nbsp;<span class="op" id="5625723">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5625726">typeBeginRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5625746">recType</span>&nbsp;<span class="op" id="5625754">=</span>&nbsp;<span class="num" id="5625756">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5625759">typeAbortRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5625779">recType</span>&nbsp;<span class="op" id="5625787">=</span>&nbsp;<span class="num" id="5625789">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5625792">typeEndRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5625812">recType</span>&nbsp;<span class="op" id="5625820">=</span>&nbsp;<span class="num" id="5625822">3</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5625825">typeParams</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5625845">recType</span>&nbsp;<span class="op" id="5625853">=</span>&nbsp;<span class="num" id="5625855">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5625858">typeStdin</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5625878">recType</span>&nbsp;<span class="op" id="5625886">=</span>&nbsp;<span class="num" id="5625888">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5625891">typeStdout</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5625911">recType</span>&nbsp;<span class="op" id="5625919">=</span>&nbsp;<span class="num" id="5625921">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5625924">typeStderr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5625944">recType</span>&nbsp;<span class="op" id="5625952">=</span>&nbsp;<span class="num" id="5625954">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5625957">typeData</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5625977">recType</span>&nbsp;<span class="op" id="5625985">=</span>&nbsp;<span class="num" id="5625987">8</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5625990">typeGetValues</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5626010">recType</span>&nbsp;<span class="op" id="5626018">=</span>&nbsp;<span class="num" id="5626020">9</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5626023">typeGetValuesResult</span>&nbsp;<span class="ident" id="5626043">recType</span>&nbsp;<span class="op" id="5626051">=</span>&nbsp;<span class="num" id="5626053">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5626057">typeUnknownType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5626077">recType</span>&nbsp;<span class="op" id="5626085">=</span>&nbsp;<span class="num" id="5626087">11</span><br>
<span class="lineno"></span><span class="op" id="5626090">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="5626093">//&nbsp;keep&nbsp;the&nbsp;connection&nbsp;between&nbsp;web-server&nbsp;and&nbsp;responder&nbsp;open&nbsp;after&nbsp;request</span><br>
<span class="lineno"></span><span class="keyword" id="5626168">const</span>&nbsp;<span class="ident" id="5626174">flagKeepConn</span>&nbsp;<span class="op" id="5626187">=</span>&nbsp;<span class="num" id="5626189">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5626192">const</span>&nbsp;<span class="op" id="5626198">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5626201">maxWrite</span>&nbsp;<span class="op" id="5626210">=</span>&nbsp;<span class="num" id="5626212">65535</span>&nbsp;<span class="comment" id="5626218">//&nbsp;maximum&nbsp;record&nbsp;body</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5626242">maxPad</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5626251">=</span>&nbsp;<span class="num" id="5626253">255</span><br>
<span class="lineno"></span><span class="op" id="5626257">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5626260">const</span>&nbsp;<span class="op" id="5626266">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5626269">roleResponder</span>&nbsp;<span class="op" id="5626283">=</span>&nbsp;<span class="ident" id="5626285">iota</span>&nbsp;<span class="op" id="5626290">+</span>&nbsp;<span class="num" id="5626292">1</span>&nbsp;<span class="comment" id="5626294">//&nbsp;only&nbsp;Responders&nbsp;are&nbsp;implemented.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5626331">roleAuthorizer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5626347">roleFilter</span><br>
<span class="lineno"></span><span class="op" id="5626358">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5626361">const</span>&nbsp;<span class="op" id="5626367">(</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5626370">statusRequestComplete</span>&nbsp;<span class="op" id="5626392">=</span>&nbsp;<span class="ident" id="5626394">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5626400">statusCantMultiplex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5626421">statusOverloaded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5626439">statusUnknownRole</span><br>
<span class="lineno"></span><span class="op" id="5626457">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="5626460">const</span>&nbsp;<span class="ident" id="5626466">headerLen</span>&nbsp;<span class="op" id="5626476">=</span>&nbsp;<span class="num" id="5626478">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5626481">type</span>&nbsp;<span class="ident" id="5626486">header</span>&nbsp;<span class="keyword" id="5626493">struct</span>&nbsp;<span class="op" id="5626500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5626503">Version</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5626517">uint8</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5626524">Type</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5626538">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5626547">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5626561">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5626569">ContentLength</span>&nbsp;<span class="builtintype" id="5626583">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5626591">PaddingLength</span>&nbsp;<span class="builtintype" id="5626605">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5626612">Reserved</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5626626">uint8</span><br>
<span class="lineno">70</span><span class="op" id="5626632">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5626635">type</span>&nbsp;<span class="ident" id="5626640">beginRequest</span>&nbsp;<span class="keyword" id="5626653">struct</span>&nbsp;<span class="op" id="5626660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5626663">role</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5626672">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5626680">flags</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5626689">uint8</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5626696">reserved</span>&nbsp;<span class="op" id="5626705">[</span><span class="num" id="5626706">5</span><span class="op" id="5626707">]</span><span class="builtintype" id="5626708">uint8</span><br>
<span class="lineno"></span><span class="op" id="5626714">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5626717">func</span>&nbsp;<span class="op" id="5626722">(</span><span class="ident" id="5626723">br</span>&nbsp;<span class="op" id="5626726">*</span><span class="ident" id="5626727">beginRequest</span><span class="op" id="5626739">)</span>&nbsp;<span class="ident" id="5626741">read</span><span class="op" id="5626745">(</span><span class="ident" id="5626746">content</span>&nbsp;<span class="op" id="5626754">[</span><span class="op" id="5626755">]</span><span class="builtintype" id="5626756">byte</span><span class="op" id="5626760">)</span>&nbsp;<span class="builtintype" id="5626762">error</span>&nbsp;<span class="op" id="5626768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5626771">if</span>&nbsp;<span class="builtinfunc" id="5626774">len</span><span class="op" id="5626777">(</span><span class="ident" id="5626778">content</span><span class="op" id="5626785">)</span>&nbsp;<span class="op" id="5626787">!=</span>&nbsp;<span class="num" id="5626790">8</span>&nbsp;<span class="op" id="5626792">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5626796">return</span>&nbsp;<span class="ident" id="5626803">errors</span><span class="op" id="5626809">.</span><span class="ident" id="5626810">New</span><span class="op" id="5626813">(</span><span class="string" id="5626814">&#34;fcgi:&nbsp;invalid&nbsp;begin&nbsp;request&nbsp;record&#34;</span><span class="op" id="5626850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5626853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5626856">br</span><span class="op" id="5626858">.</span><span class="ident" id="5626859">role</span>&nbsp;<span class="op" id="5626864">=</span>&nbsp;<span class="ident" id="5626866">binary</span><span class="op" id="5626872">.</span><span class="ident" id="5626873">BigEndian</span><span class="op" id="5626882">.</span><span class="ident" id="5626883">Uint16</span><span class="op" id="5626889">(</span><span class="ident" id="5626890">content</span><span class="op" id="5626897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5626900">br</span><span class="op" id="5626902">.</span><span class="ident" id="5626903">flags</span>&nbsp;<span class="op" id="5626909">=</span>&nbsp;<span class="ident" id="5626911">content</span><span class="op" id="5626918">[</span><span class="num" id="5626919">2</span><span class="op" id="5626920">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5626923">return</span>&nbsp;<span class="ident" id="5626930">nil</span><br>
<span class="lineno">85</span><span class="op" id="5626934">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5626937">//&nbsp;for&nbsp;padding&nbsp;so&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;to&nbsp;allocate&nbsp;all&nbsp;the&nbsp;time</span><br>
<span class="lineno"></span><span class="comment" id="5626994">//&nbsp;not&nbsp;synchronized&nbsp;because&nbsp;we&nbsp;don&#39;t&nbsp;care&nbsp;what&nbsp;the&nbsp;contents&nbsp;are</span><br>
<span class="lineno"></span><span class="keyword" id="5627058">var</span>&nbsp;<span class="ident" id="5627062">pad</span>&nbsp;<span class="op" id="5627066">[</span><span class="ident" id="5627067">maxPad</span><span class="op" id="5627073">]</span><span class="builtintype" id="5627074">byte</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="5627080">func</span>&nbsp;<span class="op" id="5627085">(</span><span class="ident" id="5627086">h</span>&nbsp;<span class="op" id="5627088">*</span><span class="ident" id="5627089">header</span><span class="op" id="5627095">)</span>&nbsp;<span class="ident" id="5627097">init</span><span class="op" id="5627101">(</span><span class="ident" id="5627102">recType</span>&nbsp;<span class="ident" id="5627110">recType</span><span class="op" id="5627117">,</span>&nbsp;<span class="ident" id="5627119">reqId</span>&nbsp;<span class="builtintype" id="5627125">uint16</span><span class="op" id="5627131">,</span>&nbsp;<span class="ident" id="5627133">contentLength</span>&nbsp;<span class="builtintype" id="5627147">int</span><span class="op" id="5627150">)</span>&nbsp;<span class="op" id="5627152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5627155">h</span><span class="op" id="5627156">.</span><span class="ident" id="5627157">Version</span>&nbsp;<span class="op" id="5627165">=</span>&nbsp;<span class="num" id="5627167">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5627170">h</span><span class="op" id="5627171">.</span><span class="ident" id="5627172">Type</span>&nbsp;<span class="op" id="5627177">=</span>&nbsp;<span class="ident" id="5627179">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5627188">h</span><span class="op" id="5627189">.</span><span class="ident" id="5627190">Id</span>&nbsp;<span class="op" id="5627193">=</span>&nbsp;<span class="ident" id="5627195">reqId</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5627202">h</span><span class="op" id="5627203">.</span><span class="ident" id="5627204">ContentLength</span>&nbsp;<span class="op" id="5627218">=</span>&nbsp;<span class="builtintype" id="5627220">uint16</span><span class="op" id="5627226">(</span><span class="ident" id="5627227">contentLength</span><span class="op" id="5627240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5627243">h</span><span class="op" id="5627244">.</span><span class="ident" id="5627245">PaddingLength</span>&nbsp;<span class="op" id="5627259">=</span>&nbsp;<span class="builtintype" id="5627261">uint8</span><span class="op" id="5627266">(</span><span class="op" id="5627267">-</span><span class="ident" id="5627268">contentLength</span>&nbsp;<span class="op" id="5627282">&amp;</span>&nbsp;<span class="num" id="5627284">7</span><span class="op" id="5627285">)</span><br>
<span class="lineno"></span><span class="op" id="5627287">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5627290">//&nbsp;conn&nbsp;sends&nbsp;records&nbsp;over&nbsp;rwc</span><br>
<span class="lineno">100</span><span class="keyword" id="5627321">type</span>&nbsp;<span class="ident" id="5627326">conn</span>&nbsp;<span class="keyword" id="5627331">struct</span>&nbsp;<span class="op" id="5627338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5627341">mutex</span>&nbsp;<span class="ident" id="5627347">sync</span><span class="op" id="5627351">.</span><span class="ident" id="5627352">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5627359">rwc</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5627365">io</span><span class="op" id="5627367">.</span><span class="ident" id="5627368">ReadWriteCloser</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5627386">//&nbsp;to&nbsp;avoid&nbsp;allocations</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5627411">buf</span>&nbsp;<span class="ident" id="5627415">bytes</span><span class="op" id="5627420">.</span><span class="ident" id="5627421">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5627429">h</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5627433">header</span><br>
<span class="lineno"></span><span class="op" id="5627440">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5627443">func</span>&nbsp;<span class="ident" id="5627448">newConn</span><span class="op" id="5627455">(</span><span class="ident" id="5627456">rwc</span>&nbsp;<span class="ident" id="5627460">io</span><span class="op" id="5627462">.</span><span class="ident" id="5627463">ReadWriteCloser</span><span class="op" id="5627478">)</span>&nbsp;<span class="op" id="5627480">*</span><span class="ident" id="5627481">conn</span>&nbsp;<span class="op" id="5627486">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5627489">return</span>&nbsp;<span class="op" id="5627496">&amp;</span><span class="ident" id="5627497">conn</span><span class="op" id="5627501">{</span><span class="ident" id="5627502">rwc</span><span class="op" id="5627505">:</span>&nbsp;<span class="ident" id="5627507">rwc</span><span class="op" id="5627510">}</span><br>
<span class="lineno"></span><span class="op" id="5627512">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5627515">func</span>&nbsp;<span class="op" id="5627520">(</span><span class="ident" id="5627521">c</span>&nbsp;<span class="op" id="5627523">*</span><span class="ident" id="5627524">conn</span><span class="op" id="5627528">)</span>&nbsp;<span class="ident" id="5627530">Close</span><span class="op" id="5627535">(</span><span class="op" id="5627536">)</span>&nbsp;<span class="builtintype" id="5627538">error</span>&nbsp;<span class="op" id="5627544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5627547">c</span><span class="op" id="5627548">.</span><span class="ident" id="5627549">mutex</span><span class="op" id="5627554">.</span><span class="ident" id="5627555">Lock</span><span class="op" id="5627559">(</span><span class="op" id="5627560">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5627563">defer</span>&nbsp;<span class="ident" id="5627569">c</span><span class="op" id="5627570">.</span><span class="ident" id="5627571">mutex</span><span class="op" id="5627576">.</span><span class="ident" id="5627577">Unlock</span><span class="op" id="5627583">(</span><span class="op" id="5627584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5627587">return</span>&nbsp;<span class="ident" id="5627594">c</span><span class="op" id="5627595">.</span><span class="ident" id="5627596">rwc</span><span class="op" id="5627599">.</span><span class="ident" id="5627600">Close</span><span class="op" id="5627605">(</span><span class="op" id="5627606">)</span><br>
<span class="lineno"></span><span class="op" id="5627608">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5627611">type</span>&nbsp;<span class="ident" id="5627616">record</span>&nbsp;<span class="keyword" id="5627623">struct</span>&nbsp;<span class="op" id="5627630">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5627633">h</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5627637">header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5627645">buf</span>&nbsp;<span class="op" id="5627649">[</span><span class="ident" id="5627650">maxWrite</span>&nbsp;<span class="op" id="5627659">+</span>&nbsp;<span class="ident" id="5627661">maxPad</span><span class="op" id="5627667">]</span><span class="builtintype" id="5627668">byte</span><br>
<span class="lineno"></span><span class="op" id="5627673">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5627676">func</span>&nbsp;<span class="op" id="5627681">(</span><span class="ident" id="5627682">rec</span>&nbsp;<span class="op" id="5627686">*</span><span class="ident" id="5627687">record</span><span class="op" id="5627693">)</span>&nbsp;<span class="ident" id="5627695">read</span><span class="op" id="5627699">(</span><span class="ident" id="5627700">r</span>&nbsp;<span class="ident" id="5627702">io</span><span class="op" id="5627704">.</span><span class="ident" id="5627705">Reader</span><span class="op" id="5627711">)</span>&nbsp;<span class="op" id="5627713">(</span><span class="ident" id="5627714">err</span>&nbsp;<span class="builtintype" id="5627718">error</span><span class="op" id="5627723">)</span>&nbsp;<span class="op" id="5627725">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5627728">if</span>&nbsp;<span class="ident" id="5627731">err</span>&nbsp;<span class="op" id="5627735">=</span>&nbsp;<span class="ident" id="5627737">binary</span><span class="op" id="5627743">.</span><span class="ident" id="5627744">Read</span><span class="op" id="5627748">(</span><span class="ident" id="5627749">r</span><span class="op" id="5627750">,</span>&nbsp;<span class="ident" id="5627752">binary</span><span class="op" id="5627758">.</span><span class="ident" id="5627759">BigEndian</span><span class="op" id="5627768">,</span>&nbsp;<span class="op" id="5627770">&amp;</span><span class="ident" id="5627771">rec</span><span class="op" id="5627774">.</span><span class="ident" id="5627775">h</span><span class="op" id="5627776">)</span><span class="op" id="5627777">;</span>&nbsp;<span class="ident" id="5627779">err</span>&nbsp;<span class="op" id="5627783">!=</span>&nbsp;<span class="ident" id="5627786">nil</span>&nbsp;<span class="op" id="5627790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5627794">return</span>&nbsp;<span class="ident" id="5627801">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5627806">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5627809">if</span>&nbsp;<span class="ident" id="5627812">rec</span><span class="op" id="5627815">.</span><span class="ident" id="5627816">h</span><span class="op" id="5627817">.</span><span class="ident" id="5627818">Version</span>&nbsp;<span class="op" id="5627826">!=</span>&nbsp;<span class="num" id="5627829">1</span>&nbsp;<span class="op" id="5627831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5627835">return</span>&nbsp;<span class="ident" id="5627842">errors</span><span class="op" id="5627848">.</span><span class="ident" id="5627849">New</span><span class="op" id="5627852">(</span><span class="string" id="5627853">&#34;fcgi:&nbsp;invalid&nbsp;header&nbsp;version&#34;</span><span class="op" id="5627883">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5627886">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5627889">n</span>&nbsp;<span class="op" id="5627891">:=</span>&nbsp;<span class="builtintype" id="5627894">int</span><span class="op" id="5627897">(</span><span class="ident" id="5627898">rec</span><span class="op" id="5627901">.</span><span class="ident" id="5627902">h</span><span class="op" id="5627903">.</span><span class="ident" id="5627904">ContentLength</span><span class="op" id="5627917">)</span>&nbsp;<span class="op" id="5627919">+</span>&nbsp;<span class="builtintype" id="5627921">int</span><span class="op" id="5627924">(</span><span class="ident" id="5627925">rec</span><span class="op" id="5627928">.</span><span class="ident" id="5627929">h</span><span class="op" id="5627930">.</span><span class="ident" id="5627931">PaddingLength</span><span class="op" id="5627944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5627947">if</span>&nbsp;<span class="ident" id="5627950">_</span><span class="op" id="5627951">,</span>&nbsp;<span class="ident" id="5627953">err</span>&nbsp;<span class="op" id="5627957">=</span>&nbsp;<span class="ident" id="5627959">io</span><span class="op" id="5627961">.</span><span class="ident" id="5627962">ReadFull</span><span class="op" id="5627970">(</span><span class="ident" id="5627971">r</span><span class="op" id="5627972">,</span>&nbsp;<span class="ident" id="5627974">rec</span><span class="op" id="5627977">.</span><span class="ident" id="5627978">buf</span><span class="op" id="5627981">[</span><span class="op" id="5627982">:</span><span class="ident" id="5627983">n</span><span class="op" id="5627984">]</span><span class="op" id="5627985">)</span><span class="op" id="5627986">;</span>&nbsp;<span class="ident" id="5627988">err</span>&nbsp;<span class="op" id="5627992">!=</span>&nbsp;<span class="ident" id="5627995">nil</span>&nbsp;<span class="op" id="5627999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5628003">return</span>&nbsp;<span class="ident" id="5628010">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5628015">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5628018">return</span>&nbsp;<span class="ident" id="5628025">nil</span><br>
<span class="lineno"></span><span class="op" id="5628029">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5628032">func</span>&nbsp;<span class="op" id="5628037">(</span><span class="ident" id="5628038">r</span>&nbsp;<span class="op" id="5628040">*</span><span class="ident" id="5628041">record</span><span class="op" id="5628047">)</span>&nbsp;<span class="ident" id="5628049">content</span><span class="op" id="5628056">(</span><span class="op" id="5628057">)</span>&nbsp;<span class="op" id="5628059">[</span><span class="op" id="5628060">]</span><span class="builtintype" id="5628061">byte</span>&nbsp;<span class="op" id="5628066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5628069">return</span>&nbsp;<span class="ident" id="5628076">r</span><span class="op" id="5628077">.</span><span class="ident" id="5628078">buf</span><span class="op" id="5628081">[</span><span class="op" id="5628082">:</span><span class="ident" id="5628083">r</span><span class="op" id="5628084">.</span><span class="ident" id="5628085">h</span><span class="op" id="5628086">.</span><span class="ident" id="5628087">ContentLength</span><span class="op" id="5628100">]</span><br>
<span class="lineno">140</span><span class="op" id="5628102">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5628105">//&nbsp;writeRecord&nbsp;writes&nbsp;and&nbsp;sends&nbsp;a&nbsp;single&nbsp;record.</span><br>
<span class="lineno"></span><span class="keyword" id="5628154">func</span>&nbsp;<span class="op" id="5628159">(</span><span class="ident" id="5628160">c</span>&nbsp;<span class="op" id="5628162">*</span><span class="ident" id="5628163">conn</span><span class="op" id="5628167">)</span>&nbsp;<span class="ident" id="5628169">writeRecord</span><span class="op" id="5628180">(</span><span class="ident" id="5628181">recType</span>&nbsp;<span class="ident" id="5628189">recType</span><span class="op" id="5628196">,</span>&nbsp;<span class="ident" id="5628198">reqId</span>&nbsp;<span class="builtintype" id="5628204">uint16</span><span class="op" id="5628210">,</span>&nbsp;<span class="ident" id="5628212">b</span>&nbsp;<span class="op" id="5628214">[</span><span class="op" id="5628215">]</span><span class="builtintype" id="5628216">byte</span><span class="op" id="5628220">)</span>&nbsp;<span class="builtintype" id="5628222">error</span>&nbsp;<span class="op" id="5628228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5628231">c</span><span class="op" id="5628232">.</span><span class="ident" id="5628233">mutex</span><span class="op" id="5628238">.</span><span class="ident" id="5628239">Lock</span><span class="op" id="5628243">(</span><span class="op" id="5628244">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5628247">defer</span>&nbsp;<span class="ident" id="5628253">c</span><span class="op" id="5628254">.</span><span class="ident" id="5628255">mutex</span><span class="op" id="5628260">.</span><span class="ident" id="5628261">Unlock</span><span class="op" id="5628267">(</span><span class="op" id="5628268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5628271">c</span><span class="op" id="5628272">.</span><span class="ident" id="5628273">buf</span><span class="op" id="5628276">.</span><span class="ident" id="5628277">Reset</span><span class="op" id="5628282">(</span><span class="op" id="5628283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5628286">c</span><span class="op" id="5628287">.</span><span class="ident" id="5628288">h</span><span class="op" id="5628289">.</span><span class="ident" id="5628290">init</span><span class="op" id="5628294">(</span><span class="ident" id="5628295">recType</span><span class="op" id="5628302">,</span>&nbsp;<span class="ident" id="5628304">reqId</span><span class="op" id="5628309">,</span>&nbsp;<span class="builtinfunc" id="5628311">len</span><span class="op" id="5628314">(</span><span class="ident" id="5628315">b</span><span class="op" id="5628316">)</span><span class="op" id="5628317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5628320">if</span>&nbsp;<span class="ident" id="5628323">err</span>&nbsp;<span class="op" id="5628327">:=</span>&nbsp;<span class="ident" id="5628330">binary</span><span class="op" id="5628336">.</span><span class="ident" id="5628337">Write</span><span class="op" id="5628342">(</span><span class="op" id="5628343">&amp;</span><span class="ident" id="5628344">c</span><span class="op" id="5628345">.</span><span class="ident" id="5628346">buf</span><span class="op" id="5628349">,</span>&nbsp;<span class="ident" id="5628351">binary</span><span class="op" id="5628357">.</span><span class="ident" id="5628358">BigEndian</span><span class="op" id="5628367">,</span>&nbsp;<span class="ident" id="5628369">c</span><span class="op" id="5628370">.</span><span class="ident" id="5628371">h</span><span class="op" id="5628372">)</span><span class="op" id="5628373">;</span>&nbsp;<span class="ident" id="5628375">err</span>&nbsp;<span class="op" id="5628379">!=</span>&nbsp;<span class="ident" id="5628382">nil</span>&nbsp;<span class="op" id="5628386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5628390">return</span>&nbsp;<span class="ident" id="5628397">err</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5628402">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5628405">if</span>&nbsp;<span class="ident" id="5628408">_</span><span class="op" id="5628409">,</span>&nbsp;<span class="ident" id="5628411">err</span>&nbsp;<span class="op" id="5628415">:=</span>&nbsp;<span class="ident" id="5628418">c</span><span class="op" id="5628419">.</span><span class="ident" id="5628420">buf</span><span class="op" id="5628423">.</span><span class="ident" id="5628424">Write</span><span class="op" id="5628429">(</span><span class="ident" id="5628430">b</span><span class="op" id="5628431">)</span><span class="op" id="5628432">;</span>&nbsp;<span class="ident" id="5628434">err</span>&nbsp;<span class="op" id="5628438">!=</span>&nbsp;<span class="ident" id="5628441">nil</span>&nbsp;<span class="op" id="5628445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5628449">return</span>&nbsp;<span class="ident" id="5628456">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5628461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5628464">if</span>&nbsp;<span class="ident" id="5628467">_</span><span class="op" id="5628468">,</span>&nbsp;<span class="ident" id="5628470">err</span>&nbsp;<span class="op" id="5628474">:=</span>&nbsp;<span class="ident" id="5628477">c</span><span class="op" id="5628478">.</span><span class="ident" id="5628479">buf</span><span class="op" id="5628482">.</span><span class="ident" id="5628483">Write</span><span class="op" id="5628488">(</span><span class="ident" id="5628489">pad</span><span class="op" id="5628492">[</span><span class="op" id="5628493">:</span><span class="ident" id="5628494">c</span><span class="op" id="5628495">.</span><span class="ident" id="5628496">h</span><span class="op" id="5628497">.</span><span class="ident" id="5628498">PaddingLength</span><span class="op" id="5628511">]</span><span class="op" id="5628512">)</span><span class="op" id="5628513">;</span>&nbsp;<span class="ident" id="5628515">err</span>&nbsp;<span class="op" id="5628519">!=</span>&nbsp;<span class="ident" id="5628522">nil</span>&nbsp;<span class="op" id="5628526">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5628530">return</span>&nbsp;<span class="ident" id="5628537">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5628542">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5628545">_</span><span class="op" id="5628546">,</span>&nbsp;<span class="ident" id="5628548">err</span>&nbsp;<span class="op" id="5628552">:=</span>&nbsp;<span class="ident" id="5628555">c</span><span class="op" id="5628556">.</span><span class="ident" id="5628557">rwc</span><span class="op" id="5628560">.</span><span class="ident" id="5628561">Write</span><span class="op" id="5628566">(</span><span class="ident" id="5628567">c</span><span class="op" id="5628568">.</span><span class="ident" id="5628569">buf</span><span class="op" id="5628572">.</span><span class="ident" id="5628573">Bytes</span><span class="op" id="5628578">(</span><span class="op" id="5628579">)</span><span class="op" id="5628580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5628583">return</span>&nbsp;<span class="ident" id="5628590">err</span><br>
<span class="lineno"></span><span class="op" id="5628594">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="keyword" id="5628597">func</span>&nbsp;<span class="op" id="5628602">(</span><span class="ident" id="5628603">c</span>&nbsp;<span class="op" id="5628605">*</span><span class="ident" id="5628606">conn</span><span class="op" id="5628610">)</span>&nbsp;<span class="ident" id="5628612">writeBeginRequest</span><span class="op" id="5628629">(</span><span class="ident" id="5628630">reqId</span>&nbsp;<span class="builtintype" id="5628636">uint16</span><span class="op" id="5628642">,</span>&nbsp;<span class="ident" id="5628644">role</span>&nbsp;<span class="builtintype" id="5628649">uint16</span><span class="op" id="5628655">,</span>&nbsp;<span class="ident" id="5628657">flags</span>&nbsp;<span class="builtintype" id="5628663">uint8</span><span class="op" id="5628668">)</span>&nbsp;<span class="builtintype" id="5628670">error</span>&nbsp;<span class="op" id="5628676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5628679">b</span>&nbsp;<span class="op" id="5628681">:=</span>&nbsp;<span class="op" id="5628684">[</span><span class="num" id="5628685">8</span><span class="op" id="5628686">]</span><span class="builtintype" id="5628687">byte</span><span class="op" id="5628691">{</span><span class="builtintype" id="5628692">byte</span><span class="op" id="5628696">(</span><span class="ident" id="5628697">role</span>&nbsp;<span class="op" id="5628702">&gt;&gt;</span>&nbsp;<span class="num" id="5628705">8</span><span class="op" id="5628706">)</span><span class="op" id="5628707">,</span>&nbsp;<span class="builtintype" id="5628709">byte</span><span class="op" id="5628713">(</span><span class="ident" id="5628714">role</span><span class="op" id="5628718">)</span><span class="op" id="5628719">,</span>&nbsp;<span class="ident" id="5628721">flags</span><span class="op" id="5628726">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5628729">return</span>&nbsp;<span class="ident" id="5628736">c</span><span class="op" id="5628737">.</span><span class="ident" id="5628738">writeRecord</span><span class="op" id="5628749">(</span><span class="ident" id="5628750">typeBeginRequest</span><span class="op" id="5628766">,</span>&nbsp;<span class="ident" id="5628768">reqId</span><span class="op" id="5628773">,</span>&nbsp;<span class="ident" id="5628775">b</span><span class="op" id="5628776">[</span><span class="op" id="5628777">:</span><span class="op" id="5628778">]</span><span class="op" id="5628779">)</span><br>
<span class="lineno"></span><span class="op" id="5628781">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="keyword" id="5628784">func</span>&nbsp;<span class="op" id="5628789">(</span><span class="ident" id="5628790">c</span>&nbsp;<span class="op" id="5628792">*</span><span class="ident" id="5628793">conn</span><span class="op" id="5628797">)</span>&nbsp;<span class="ident" id="5628799">writeEndRequest</span><span class="op" id="5628814">(</span><span class="ident" id="5628815">reqId</span>&nbsp;<span class="builtintype" id="5628821">uint16</span><span class="op" id="5628827">,</span>&nbsp;<span class="ident" id="5628829">appStatus</span>&nbsp;<span class="builtintype" id="5628839">int</span><span class="op" id="5628842">,</span>&nbsp;<span class="ident" id="5628844">protocolStatus</span>&nbsp;<span class="builtintype" id="5628859">uint8</span><span class="op" id="5628864">)</span>&nbsp;<span class="builtintype" id="5628866">error</span>&nbsp;<span class="op" id="5628872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5628875">b</span>&nbsp;<span class="op" id="5628877">:=</span>&nbsp;<span class="builtinfunc" id="5628880">make</span><span class="op" id="5628884">(</span><span class="op" id="5628885">[</span><span class="op" id="5628886">]</span><span class="builtintype" id="5628887">byte</span><span class="op" id="5628891">,</span>&nbsp;<span class="num" id="5628893">8</span><span class="op" id="5628894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5628897">binary</span><span class="op" id="5628903">.</span><span class="ident" id="5628904">BigEndian</span><span class="op" id="5628913">.</span><span class="ident" id="5628914">PutUint32</span><span class="op" id="5628923">(</span><span class="ident" id="5628924">b</span><span class="op" id="5628925">,</span>&nbsp;<span class="builtintype" id="5628927">uint32</span><span class="op" id="5628933">(</span><span class="ident" id="5628934">appStatus</span><span class="op" id="5628943">)</span><span class="op" id="5628944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5628947">b</span><span class="op" id="5628948">[</span><span class="num" id="5628949">4</span><span class="op" id="5628950">]</span>&nbsp;<span class="op" id="5628952">=</span>&nbsp;<span class="ident" id="5628954">protocolStatus</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5628970">return</span>&nbsp;<span class="ident" id="5628977">c</span><span class="op" id="5628978">.</span><span class="ident" id="5628979">writeRecord</span><span class="op" id="5628990">(</span><span class="ident" id="5628991">typeEndRequest</span><span class="op" id="5629005">,</span>&nbsp;<span class="ident" id="5629007">reqId</span><span class="op" id="5629012">,</span>&nbsp;<span class="ident" id="5629014">b</span><span class="op" id="5629015">)</span><br>
<span class="lineno"></span><span class="op" id="5629017">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5629020">func</span>&nbsp;<span class="op" id="5629025">(</span><span class="ident" id="5629026">c</span>&nbsp;<span class="op" id="5629028">*</span><span class="ident" id="5629029">conn</span><span class="op" id="5629033">)</span>&nbsp;<span class="ident" id="5629035">writePairs</span><span class="op" id="5629045">(</span><span class="ident" id="5629046">recType</span>&nbsp;<span class="ident" id="5629054">recType</span><span class="op" id="5629061">,</span>&nbsp;<span class="ident" id="5629063">reqId</span>&nbsp;<span class="builtintype" id="5629069">uint16</span><span class="op" id="5629075">,</span>&nbsp;<span class="ident" id="5629077">pairs</span>&nbsp;<span class="keyword" id="5629083">map</span><span class="op" id="5629086">[</span><span class="builtintype" id="5629087">string</span><span class="op" id="5629093">]</span><span class="builtintype" id="5629094">string</span><span class="op" id="5629100">)</span>&nbsp;<span class="builtintype" id="5629102">error</span>&nbsp;<span class="op" id="5629108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5629111">w</span>&nbsp;<span class="op" id="5629113">:=</span>&nbsp;<span class="ident" id="5629116">newWriter</span><span class="op" id="5629125">(</span><span class="ident" id="5629126">c</span><span class="op" id="5629127">,</span>&nbsp;<span class="ident" id="5629129">recType</span><span class="op" id="5629136">,</span>&nbsp;<span class="ident" id="5629138">reqId</span><span class="op" id="5629143">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5629146">b</span>&nbsp;<span class="op" id="5629148">:=</span>&nbsp;<span class="builtinfunc" id="5629151">make</span><span class="op" id="5629155">(</span><span class="op" id="5629156">[</span><span class="op" id="5629157">]</span><span class="builtintype" id="5629158">byte</span><span class="op" id="5629162">,</span>&nbsp;<span class="num" id="5629164">8</span><span class="op" id="5629165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5629168">for</span>&nbsp;<span class="ident" id="5629172">k</span><span class="op" id="5629173">,</span>&nbsp;<span class="ident" id="5629175">v</span>&nbsp;<span class="op" id="5629177">:=</span>&nbsp;<span class="keyword" id="5629180">range</span>&nbsp;<span class="ident" id="5629186">pairs</span>&nbsp;<span class="op" id="5629192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5629196">n</span>&nbsp;<span class="op" id="5629198">:=</span>&nbsp;<span class="ident" id="5629201">encodeSize</span><span class="op" id="5629211">(</span><span class="ident" id="5629212">b</span><span class="op" id="5629213">,</span>&nbsp;<span class="builtintype" id="5629215">uint32</span><span class="op" id="5629221">(</span><span class="builtinfunc" id="5629222">len</span><span class="op" id="5629225">(</span><span class="ident" id="5629226">k</span><span class="op" id="5629227">)</span><span class="op" id="5629228">)</span><span class="op" id="5629229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5629233">n</span>&nbsp;<span class="op" id="5629235">+=</span>&nbsp;<span class="ident" id="5629238">encodeSize</span><span class="op" id="5629248">(</span><span class="ident" id="5629249">b</span><span class="op" id="5629250">[</span><span class="ident" id="5629251">n</span><span class="op" id="5629252">:</span><span class="op" id="5629253">]</span><span class="op" id="5629254">,</span>&nbsp;<span class="builtintype" id="5629256">uint32</span><span class="op" id="5629262">(</span><span class="builtinfunc" id="5629263">len</span><span class="op" id="5629266">(</span><span class="ident" id="5629267">v</span><span class="op" id="5629268">)</span><span class="op" id="5629269">)</span><span class="op" id="5629270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5629274">if</span>&nbsp;<span class="ident" id="5629277">_</span><span class="op" id="5629278">,</span>&nbsp;<span class="ident" id="5629280">err</span>&nbsp;<span class="op" id="5629284">:=</span>&nbsp;<span class="ident" id="5629287">w</span><span class="op" id="5629288">.</span><span class="ident" id="5629289">Write</span><span class="op" id="5629294">(</span><span class="ident" id="5629295">b</span><span class="op" id="5629296">[</span><span class="op" id="5629297">:</span><span class="ident" id="5629298">n</span><span class="op" id="5629299">]</span><span class="op" id="5629300">)</span><span class="op" id="5629301">;</span>&nbsp;<span class="ident" id="5629303">err</span>&nbsp;<span class="op" id="5629307">!=</span>&nbsp;<span class="ident" id="5629310">nil</span>&nbsp;<span class="op" id="5629314">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5629319">return</span>&nbsp;<span class="ident" id="5629326">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5629332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5629336">if</span>&nbsp;<span class="ident" id="5629339">_</span><span class="op" id="5629340">,</span>&nbsp;<span class="ident" id="5629342">err</span>&nbsp;<span class="op" id="5629346">:=</span>&nbsp;<span class="ident" id="5629349">w</span><span class="op" id="5629350">.</span><span class="ident" id="5629351">WriteString</span><span class="op" id="5629362">(</span><span class="ident" id="5629363">k</span><span class="op" id="5629364">)</span><span class="op" id="5629365">;</span>&nbsp;<span class="ident" id="5629367">err</span>&nbsp;<span class="op" id="5629371">!=</span>&nbsp;<span class="ident" id="5629374">nil</span>&nbsp;<span class="op" id="5629378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5629383">return</span>&nbsp;<span class="ident" id="5629390">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5629396">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5629400">if</span>&nbsp;<span class="ident" id="5629403">_</span><span class="op" id="5629404">,</span>&nbsp;<span class="ident" id="5629406">err</span>&nbsp;<span class="op" id="5629410">:=</span>&nbsp;<span class="ident" id="5629413">w</span><span class="op" id="5629414">.</span><span class="ident" id="5629415">WriteString</span><span class="op" id="5629426">(</span><span class="ident" id="5629427">v</span><span class="op" id="5629428">)</span><span class="op" id="5629429">;</span>&nbsp;<span class="ident" id="5629431">err</span>&nbsp;<span class="op" id="5629435">!=</span>&nbsp;<span class="ident" id="5629438">nil</span>&nbsp;<span class="op" id="5629442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5629447">return</span>&nbsp;<span class="ident" id="5629454">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5629460">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5629463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5629466">w</span><span class="op" id="5629467">.</span><span class="ident" id="5629468">Close</span><span class="op" id="5629473">(</span><span class="op" id="5629474">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5629477">return</span>&nbsp;<span class="ident" id="5629484">nil</span><br>
<span class="lineno"></span><span class="op" id="5629488">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5629491">func</span>&nbsp;<span class="ident" id="5629496">readSize</span><span class="op" id="5629504">(</span><span class="ident" id="5629505">s</span>&nbsp;<span class="op" id="5629507">[</span><span class="op" id="5629508">]</span><span class="builtintype" id="5629509">byte</span><span class="op" id="5629513">)</span>&nbsp;<span class="op" id="5629515">(</span><span class="builtintype" id="5629516">uint32</span><span class="op" id="5629522">,</span>&nbsp;<span class="builtintype" id="5629524">int</span><span class="op" id="5629527">)</span>&nbsp;<span class="op" id="5629529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5629532">if</span>&nbsp;<span class="builtinfunc" id="5629535">len</span><span class="op" id="5629538">(</span><span class="ident" id="5629539">s</span><span class="op" id="5629540">)</span>&nbsp;<span class="op" id="5629542">==</span>&nbsp;<span class="num" id="5629545">0</span>&nbsp;<span class="op" id="5629547">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5629551">return</span>&nbsp;<span class="num" id="5629558">0</span><span class="op" id="5629559">,</span>&nbsp;<span class="num" id="5629561">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5629564">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5629567">size</span><span class="op" id="5629571">,</span>&nbsp;<span class="ident" id="5629573">n</span>&nbsp;<span class="op" id="5629575">:=</span>&nbsp;<span class="builtintype" id="5629578">uint32</span><span class="op" id="5629584">(</span><span class="ident" id="5629585">s</span><span class="op" id="5629586">[</span><span class="num" id="5629587">0</span><span class="op" id="5629588">]</span><span class="op" id="5629589">)</span><span class="op" id="5629590">,</span>&nbsp;<span class="num" id="5629592">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5629595">if</span>&nbsp;<span class="ident" id="5629598">size</span><span class="op" id="5629602">&amp;</span><span class="op" id="5629603">(</span><span class="num" id="5629604">1</span><span class="op" id="5629605">&lt;&lt;</span><span class="num" id="5629607">7</span><span class="op" id="5629608">)</span>&nbsp;<span class="op" id="5629610">!=</span>&nbsp;<span class="num" id="5629613">0</span>&nbsp;<span class="op" id="5629615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5629619">if</span>&nbsp;<span class="builtinfunc" id="5629622">len</span><span class="op" id="5629625">(</span><span class="ident" id="5629626">s</span><span class="op" id="5629627">)</span>&nbsp;<span class="op" id="5629629">&lt;</span>&nbsp;<span class="num" id="5629631">4</span>&nbsp;<span class="op" id="5629633">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5629638">return</span>&nbsp;<span class="num" id="5629645">0</span><span class="op" id="5629646">,</span>&nbsp;<span class="num" id="5629648">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5629652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5629656">n</span>&nbsp;<span class="op" id="5629658">=</span>&nbsp;<span class="num" id="5629660">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5629664">size</span>&nbsp;<span class="op" id="5629669">=</span>&nbsp;<span class="ident" id="5629671">binary</span><span class="op" id="5629677">.</span><span class="ident" id="5629678">BigEndian</span><span class="op" id="5629687">.</span><span class="ident" id="5629688">Uint32</span><span class="op" id="5629694">(</span><span class="ident" id="5629695">s</span><span class="op" id="5629696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5629700">size</span>&nbsp;<span class="op" id="5629705">&amp;^=</span>&nbsp;<span class="num" id="5629709">1</span>&nbsp;<span class="op" id="5629711">&lt;&lt;</span>&nbsp;<span class="num" id="5629714">31</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5629718">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5629721">return</span>&nbsp;<span class="ident" id="5629728">size</span><span class="op" id="5629732">,</span>&nbsp;<span class="ident" id="5629734">n</span><br>
<span class="lineno"></span><span class="op" id="5629736">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5629739">func</span>&nbsp;<span class="ident" id="5629744">readString</span><span class="op" id="5629754">(</span><span class="ident" id="5629755">s</span>&nbsp;<span class="op" id="5629757">[</span><span class="op" id="5629758">]</span><span class="builtintype" id="5629759">byte</span><span class="op" id="5629763">,</span>&nbsp;<span class="ident" id="5629765">size</span>&nbsp;<span class="builtintype" id="5629770">uint32</span><span class="op" id="5629776">)</span>&nbsp;<span class="builtintype" id="5629778">string</span>&nbsp;<span class="op" id="5629785">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5629788">if</span>&nbsp;<span class="ident" id="5629791">size</span>&nbsp;<span class="op" id="5629796">&gt;</span>&nbsp;<span class="builtintype" id="5629798">uint32</span><span class="op" id="5629804">(</span><span class="builtinfunc" id="5629805">len</span><span class="op" id="5629808">(</span><span class="ident" id="5629809">s</span><span class="op" id="5629810">)</span><span class="op" id="5629811">)</span>&nbsp;<span class="op" id="5629813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5629817">return</span>&nbsp;<span class="string" id="5629824">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5629828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5629831">return</span>&nbsp;<span class="builtintype" id="5629838">string</span><span class="op" id="5629844">(</span><span class="ident" id="5629845">s</span><span class="op" id="5629846">[</span><span class="op" id="5629847">:</span><span class="ident" id="5629848">size</span><span class="op" id="5629852">]</span><span class="op" id="5629853">)</span><br>
<span class="lineno"></span><span class="op" id="5629855">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="5629858">func</span>&nbsp;<span class="ident" id="5629863">encodeSize</span><span class="op" id="5629873">(</span><span class="ident" id="5629874">b</span>&nbsp;<span class="op" id="5629876">[</span><span class="op" id="5629877">]</span><span class="builtintype" id="5629878">byte</span><span class="op" id="5629882">,</span>&nbsp;<span class="ident" id="5629884">size</span>&nbsp;<span class="builtintype" id="5629889">uint32</span><span class="op" id="5629895">)</span>&nbsp;<span class="builtintype" id="5629897">int</span>&nbsp;<span class="op" id="5629901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5629904">if</span>&nbsp;<span class="ident" id="5629907">size</span>&nbsp;<span class="op" id="5629912">&gt;</span>&nbsp;<span class="num" id="5629914">127</span>&nbsp;<span class="op" id="5629918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5629922">size</span>&nbsp;<span class="op" id="5629927">|=</span>&nbsp;<span class="num" id="5629930">1</span>&nbsp;<span class="op" id="5629932">&lt;&lt;</span>&nbsp;<span class="num" id="5629935">31</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5629940">binary</span><span class="op" id="5629946">.</span><span class="ident" id="5629947">BigEndian</span><span class="op" id="5629956">.</span><span class="ident" id="5629957">PutUint32</span><span class="op" id="5629966">(</span><span class="ident" id="5629967">b</span><span class="op" id="5629968">,</span>&nbsp;<span class="ident" id="5629970">size</span><span class="op" id="5629974">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5629978">return</span>&nbsp;<span class="num" id="5629985">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5629988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5629991">b</span><span class="op" id="5629992">[</span><span class="num" id="5629993">0</span><span class="op" id="5629994">]</span>&nbsp;<span class="op" id="5629996">=</span>&nbsp;<span class="builtintype" id="5629998">byte</span><span class="op" id="5630002">(</span><span class="ident" id="5630003">size</span><span class="op" id="5630007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5630010">return</span>&nbsp;<span class="num" id="5630017">1</span><br>
<span class="lineno"></span><span class="op" id="5630019">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="comment" id="5630022">//&nbsp;bufWriter&nbsp;encapsulates&nbsp;bufio.Writer&nbsp;but&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;stream&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="5630104">//&nbsp;Closed.</span><br>
<span class="lineno"></span><span class="keyword" id="5630115">type</span>&nbsp;<span class="ident" id="5630120">bufWriter</span>&nbsp;<span class="keyword" id="5630130">struct</span>&nbsp;<span class="op" id="5630137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5630140">closer</span>&nbsp;<span class="ident" id="5630147">io</span><span class="op" id="5630149">.</span><span class="ident" id="5630150">Closer</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5630158">*</span><span class="ident" id="5630159">bufio</span><span class="op" id="5630164">.</span><span class="ident" id="5630165">Writer</span><br>
<span class="lineno"></span><span class="op" id="5630172">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5630175">func</span>&nbsp;<span class="op" id="5630180">(</span><span class="ident" id="5630181">w</span>&nbsp;<span class="op" id="5630183">*</span><span class="ident" id="5630184">bufWriter</span><span class="op" id="5630193">)</span>&nbsp;<span class="ident" id="5630195">Close</span><span class="op" id="5630200">(</span><span class="op" id="5630201">)</span>&nbsp;<span class="builtintype" id="5630203">error</span>&nbsp;<span class="op" id="5630209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5630212">if</span>&nbsp;<span class="ident" id="5630215">err</span>&nbsp;<span class="op" id="5630219">:=</span>&nbsp;<span class="ident" id="5630222">w</span><span class="op" id="5630223">.</span><span class="ident" id="5630224">Writer</span><span class="op" id="5630230">.</span><span class="ident" id="5630231">Flush</span><span class="op" id="5630236">(</span><span class="op" id="5630237">)</span><span class="op" id="5630238">;</span>&nbsp;<span class="ident" id="5630240">err</span>&nbsp;<span class="op" id="5630244">!=</span>&nbsp;<span class="ident" id="5630247">nil</span>&nbsp;<span class="op" id="5630251">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5630255">w</span><span class="op" id="5630256">.</span><span class="ident" id="5630257">closer</span><span class="op" id="5630263">.</span><span class="ident" id="5630264">Close</span><span class="op" id="5630269">(</span><span class="op" id="5630270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5630274">return</span>&nbsp;<span class="ident" id="5630281">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5630286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5630289">return</span>&nbsp;<span class="ident" id="5630296">w</span><span class="op" id="5630297">.</span><span class="ident" id="5630298">closer</span><span class="op" id="5630304">.</span><span class="ident" id="5630305">Close</span><span class="op" id="5630310">(</span><span class="op" id="5630311">)</span><br>
<span class="lineno"></span><span class="op" id="5630313">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span><span class="keyword" id="5630316">func</span>&nbsp;<span class="ident" id="5630321">newWriter</span><span class="op" id="5630330">(</span><span class="ident" id="5630331">c</span>&nbsp;<span class="op" id="5630333">*</span><span class="ident" id="5630334">conn</span><span class="op" id="5630338">,</span>&nbsp;<span class="ident" id="5630340">recType</span>&nbsp;<span class="ident" id="5630348">recType</span><span class="op" id="5630355">,</span>&nbsp;<span class="ident" id="5630357">reqId</span>&nbsp;<span class="builtintype" id="5630363">uint16</span><span class="op" id="5630369">)</span>&nbsp;<span class="op" id="5630371">*</span><span class="ident" id="5630372">bufWriter</span>&nbsp;<span class="op" id="5630382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5630385">s</span>&nbsp;<span class="op" id="5630387">:=</span>&nbsp;<span class="op" id="5630390">&amp;</span><span class="ident" id="5630391">streamWriter</span><span class="op" id="5630403">{</span><span class="ident" id="5630404">c</span><span class="op" id="5630405">:</span>&nbsp;<span class="ident" id="5630407">c</span><span class="op" id="5630408">,</span>&nbsp;<span class="ident" id="5630410">recType</span><span class="op" id="5630417">:</span>&nbsp;<span class="ident" id="5630419">recType</span><span class="op" id="5630426">,</span>&nbsp;<span class="ident" id="5630428">reqId</span><span class="op" id="5630433">:</span>&nbsp;<span class="ident" id="5630435">reqId</span><span class="op" id="5630440">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5630443">w</span>&nbsp;<span class="op" id="5630445">:=</span>&nbsp;<span class="ident" id="5630448">bufio</span><span class="op" id="5630453">.</span><span class="ident" id="5630454">NewWriterSize</span><span class="op" id="5630467">(</span><span class="ident" id="5630468">s</span><span class="op" id="5630469">,</span>&nbsp;<span class="ident" id="5630471">maxWrite</span><span class="op" id="5630479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5630482">return</span>&nbsp;<span class="op" id="5630489">&amp;</span><span class="ident" id="5630490">bufWriter</span><span class="op" id="5630499">{</span><span class="ident" id="5630500">s</span><span class="op" id="5630501">,</span>&nbsp;<span class="ident" id="5630503">w</span><span class="op" id="5630504">}</span><br>
<span class="lineno">245</span><span class="op" id="5630506">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5630509">//&nbsp;streamWriter&nbsp;abstracts&nbsp;out&nbsp;the&nbsp;separation&nbsp;of&nbsp;a&nbsp;stream&nbsp;into&nbsp;discrete&nbsp;records.</span><br>
<span class="lineno"></span><span class="comment" id="5630589">//&nbsp;It&nbsp;only&nbsp;writes&nbsp;maxWrite&nbsp;bytes&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span><span class="keyword" id="5630633">type</span>&nbsp;<span class="ident" id="5630638">streamWriter</span>&nbsp;<span class="keyword" id="5630651">struct</span>&nbsp;<span class="op" id="5630658">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5630661">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5630669">*</span><span class="ident" id="5630670">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5630676">recType</span>&nbsp;<span class="ident" id="5630684">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5630693">reqId</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5630701">uint16</span><br>
<span class="lineno"></span><span class="op" id="5630708">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="keyword" id="5630711">func</span>&nbsp;<span class="op" id="5630716">(</span><span class="ident" id="5630717">w</span>&nbsp;<span class="op" id="5630719">*</span><span class="ident" id="5630720">streamWriter</span><span class="op" id="5630732">)</span>&nbsp;<span class="ident" id="5630734">Write</span><span class="op" id="5630739">(</span><span class="ident" id="5630740">p</span>&nbsp;<span class="op" id="5630742">[</span><span class="op" id="5630743">]</span><span class="builtintype" id="5630744">byte</span><span class="op" id="5630748">)</span>&nbsp;<span class="op" id="5630750">(</span><span class="builtintype" id="5630751">int</span><span class="op" id="5630754">,</span>&nbsp;<span class="builtintype" id="5630756">error</span><span class="op" id="5630761">)</span>&nbsp;<span class="op" id="5630763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5630766">nn</span>&nbsp;<span class="op" id="5630769">:=</span>&nbsp;<span class="num" id="5630772">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5630775">for</span>&nbsp;<span class="builtinfunc" id="5630779">len</span><span class="op" id="5630782">(</span><span class="ident" id="5630783">p</span><span class="op" id="5630784">)</span>&nbsp;<span class="op" id="5630786">&gt;</span>&nbsp;<span class="num" id="5630788">0</span>&nbsp;<span class="op" id="5630790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5630794">n</span>&nbsp;<span class="op" id="5630796">:=</span>&nbsp;<span class="builtinfunc" id="5630799">len</span><span class="op" id="5630802">(</span><span class="ident" id="5630803">p</span><span class="op" id="5630804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5630808">if</span>&nbsp;<span class="ident" id="5630811">n</span>&nbsp;<span class="op" id="5630813">&gt;</span>&nbsp;<span class="ident" id="5630815">maxWrite</span>&nbsp;<span class="op" id="5630824">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5630829">n</span>&nbsp;<span class="op" id="5630831">=</span>&nbsp;<span class="ident" id="5630833">maxWrite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5630844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5630848">if</span>&nbsp;<span class="ident" id="5630851">err</span>&nbsp;<span class="op" id="5630855">:=</span>&nbsp;<span class="ident" id="5630858">w</span><span class="op" id="5630859">.</span><span class="ident" id="5630860">c</span><span class="op" id="5630861">.</span><span class="ident" id="5630862">writeRecord</span><span class="op" id="5630873">(</span><span class="ident" id="5630874">w</span><span class="op" id="5630875">.</span><span class="ident" id="5630876">recType</span><span class="op" id="5630883">,</span>&nbsp;<span class="ident" id="5630885">w</span><span class="op" id="5630886">.</span><span class="ident" id="5630887">reqId</span><span class="op" id="5630892">,</span>&nbsp;<span class="ident" id="5630894">p</span><span class="op" id="5630895">[</span><span class="op" id="5630896">:</span><span class="ident" id="5630897">n</span><span class="op" id="5630898">]</span><span class="op" id="5630899">)</span><span class="op" id="5630900">;</span>&nbsp;<span class="ident" id="5630902">err</span>&nbsp;<span class="op" id="5630906">!=</span>&nbsp;<span class="ident" id="5630909">nil</span>&nbsp;<span class="op" id="5630913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5630918">return</span>&nbsp;<span class="ident" id="5630925">nn</span><span class="op" id="5630927">,</span>&nbsp;<span class="ident" id="5630929">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5630935">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5630939">nn</span>&nbsp;<span class="op" id="5630942">+=</span>&nbsp;<span class="ident" id="5630945">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5630949">p</span>&nbsp;<span class="op" id="5630951">=</span>&nbsp;<span class="ident" id="5630953">p</span><span class="op" id="5630954">[</span><span class="ident" id="5630955">n</span><span class="op" id="5630956">:</span><span class="op" id="5630957">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5630960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5630963">return</span>&nbsp;<span class="ident" id="5630970">nn</span><span class="op" id="5630972">,</span>&nbsp;<span class="ident" id="5630974">nil</span><br>
<span class="lineno"></span><span class="op" id="5630978">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="keyword" id="5630981">func</span>&nbsp;<span class="op" id="5630986">(</span><span class="ident" id="5630987">w</span>&nbsp;<span class="op" id="5630989">*</span><span class="ident" id="5630990">streamWriter</span><span class="op" id="5631002">)</span>&nbsp;<span class="ident" id="5631004">Close</span><span class="op" id="5631009">(</span><span class="op" id="5631010">)</span>&nbsp;<span class="builtintype" id="5631012">error</span>&nbsp;<span class="op" id="5631018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5631021">//&nbsp;send&nbsp;empty&nbsp;record&nbsp;to&nbsp;close&nbsp;the&nbsp;stream</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5631063">return</span>&nbsp;<span class="ident" id="5631070">w</span><span class="op" id="5631071">.</span><span class="ident" id="5631072">c</span><span class="op" id="5631073">.</span><span class="ident" id="5631074">writeRecord</span><span class="op" id="5631085">(</span><span class="ident" id="5631086">w</span><span class="op" id="5631087">.</span><span class="ident" id="5631088">recType</span><span class="op" id="5631095">,</span>&nbsp;<span class="ident" id="5631097">w</span><span class="op" id="5631098">.</span><span class="ident" id="5631099">reqId</span><span class="op" id="5631104">,</span>&nbsp;<span class="ident" id="5631106">nil</span><span class="op" id="5631109">)</span><br>
<span class="lineno"></span><span class="op" id="5631111">}</span>
</div>
</body>
</html>
