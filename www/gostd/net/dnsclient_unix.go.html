<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html" class="current">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3849556">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3849611">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3849665">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3849716">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3849781">//&nbsp;DNS&nbsp;client:&nbsp;see&nbsp;RFC&nbsp;1035.</span><br>
<span class="lineno"></span><span class="comment" id="3849810">//&nbsp;Has&nbsp;to&nbsp;be&nbsp;linked&nbsp;into&nbsp;package&nbsp;net&nbsp;for&nbsp;Dial.</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="3849858">//&nbsp;TODO(rsc):</span><br>
<span class="lineno"></span><span class="comment" id="3849872">//&nbsp;&nbsp;&nbsp;&nbsp;Could&nbsp;potentially&nbsp;handle&nbsp;many&nbsp;outstanding&nbsp;lookups&nbsp;faster.</span><br>
<span class="lineno"></span><span class="comment" id="3849933">//&nbsp;&nbsp;&nbsp;&nbsp;Could&nbsp;have&nbsp;a&nbsp;small&nbsp;cache.</span><br>
<span class="lineno"></span><span class="comment" id="3849962">//&nbsp;&nbsp;&nbsp;&nbsp;Random&nbsp;UDP&nbsp;source&nbsp;port&nbsp;(net.Dial&nbsp;should&nbsp;do&nbsp;that&nbsp;for&nbsp;us).</span><br>
<span class="lineno"></span><span class="comment" id="3850022">//&nbsp;&nbsp;&nbsp;&nbsp;Random&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="3850046">package</span>&nbsp;<span class="ident" id="3850054">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3850059">import</span>&nbsp;<span class="op" id="3850066">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3850069">&#34;errors&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3850079">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3850085">&#34;math/rand&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3850098">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3850104">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3850112">&#34;time&#34;</span><br>
<span class="lineno">25</span><span class="op" id="3850119">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3850122">//&nbsp;A&nbsp;dnsConn&nbsp;represents&nbsp;a&nbsp;DNS&nbsp;transport&nbsp;endpoint.</span><br>
<span class="lineno"></span><span class="keyword" id="3850172">type</span>&nbsp;<span class="ident" id="3850177">dnsConn</span>&nbsp;<span class="keyword" id="3850185">interface</span>&nbsp;<span class="op" id="3850195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3850198">Conn</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3850205">//&nbsp;readDNSResponse&nbsp;reads&nbsp;a&nbsp;DNS&nbsp;response&nbsp;message&nbsp;from&nbsp;the&nbsp;DNS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3850267">//&nbsp;transport&nbsp;endpoint&nbsp;and&nbsp;returns&nbsp;the&nbsp;received&nbsp;DNS&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3850328">//&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3850341">readDNSResponse</span><span class="op" id="3850356">(</span><span class="op" id="3850357">)</span>&nbsp;<span class="op" id="3850359">(</span><span class="op" id="3850360">*</span><span class="ident" id="3850361">dnsMsg</span><span class="op" id="3850367">,</span>&nbsp;<span class="builtintype" id="3850369">error</span><span class="op" id="3850374">)</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3850378">//&nbsp;writeDNSQuery&nbsp;writes&nbsp;a&nbsp;DNS&nbsp;query&nbsp;message&nbsp;to&nbsp;the&nbsp;DNS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3850434">//&nbsp;connection&nbsp;endpoint.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3850459">writeDNSQuery</span><span class="op" id="3850472">(</span><span class="op" id="3850473">*</span><span class="ident" id="3850474">dnsMsg</span><span class="op" id="3850480">)</span>&nbsp;<span class="builtintype" id="3850482">error</span><br>
<span class="lineno"></span><span class="op" id="3850488">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="keyword" id="3850491">func</span>&nbsp;<span class="op" id="3850496">(</span><span class="ident" id="3850497">c</span>&nbsp;<span class="op" id="3850499">*</span><span class="ident" id="3850500">UDPConn</span><span class="op" id="3850507">)</span>&nbsp;<span class="ident" id="3850509">readDNSResponse</span><span class="op" id="3850524">(</span><span class="op" id="3850525">)</span>&nbsp;<span class="op" id="3850527">(</span><span class="op" id="3850528">*</span><span class="ident" id="3850529">dnsMsg</span><span class="op" id="3850535">,</span>&nbsp;<span class="builtintype" id="3850537">error</span><span class="op" id="3850542">)</span>&nbsp;<span class="op" id="3850544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3850547">b</span>&nbsp;<span class="op" id="3850549">:=</span>&nbsp;<span class="builtinfunc" id="3850552">make</span><span class="op" id="3850556">(</span><span class="op" id="3850557">[</span><span class="op" id="3850558">]</span><span class="builtintype" id="3850559">byte</span><span class="op" id="3850563">,</span>&nbsp;<span class="num" id="3850565">512</span><span class="op" id="3850568">)</span>&nbsp;<span class="comment" id="3850570">//&nbsp;see&nbsp;RFC&nbsp;1035</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3850587">n</span><span class="op" id="3850588">,</span>&nbsp;<span class="ident" id="3850590">err</span>&nbsp;<span class="op" id="3850594">:=</span>&nbsp;<span class="ident" id="3850597">c</span><span class="op" id="3850598">.</span><span class="ident" id="3850599">Read</span><span class="op" id="3850603">(</span><span class="ident" id="3850604">b</span><span class="op" id="3850605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3850608">if</span>&nbsp;<span class="ident" id="3850611">err</span>&nbsp;<span class="op" id="3850615">!=</span>&nbsp;<span class="builtintype" id="3850618">nil</span>&nbsp;<span class="op" id="3850622">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3850626">return</span>&nbsp;<span class="builtintype" id="3850633">nil</span><span class="op" id="3850636">,</span>&nbsp;<span class="ident" id="3850638">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3850643">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3850646">msg</span>&nbsp;<span class="op" id="3850650">:=</span>&nbsp;<span class="op" id="3850653">&amp;</span><span class="ident" id="3850654">dnsMsg</span><span class="op" id="3850660">{</span><span class="op" id="3850661">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3850664">if</span>&nbsp;<span class="op" id="3850667">!</span><span class="ident" id="3850668">msg</span><span class="op" id="3850671">.</span><span class="ident" id="3850672">Unpack</span><span class="op" id="3850678">(</span><span class="ident" id="3850679">b</span><span class="op" id="3850680">[</span><span class="op" id="3850681">:</span><span class="ident" id="3850682">n</span><span class="op" id="3850683">]</span><span class="op" id="3850684">)</span>&nbsp;<span class="op" id="3850686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3850690">return</span>&nbsp;<span class="builtintype" id="3850697">nil</span><span class="op" id="3850700">,</span>&nbsp;<span class="ident" id="3850702">errors</span><span class="op" id="3850708">.</span><span class="ident" id="3850709">New</span><span class="op" id="3850712">(</span><span class="string" id="3850713">&#34;cannot&nbsp;unmarshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="3850743">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3850746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3850749">return</span>&nbsp;<span class="ident" id="3850756">msg</span><span class="op" id="3850759">,</span>&nbsp;<span class="builtintype" id="3850761">nil</span><br>
<span class="lineno"></span><span class="op" id="3850765">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3850768">func</span>&nbsp;<span class="op" id="3850773">(</span><span class="ident" id="3850774">c</span>&nbsp;<span class="op" id="3850776">*</span><span class="ident" id="3850777">UDPConn</span><span class="op" id="3850784">)</span>&nbsp;<span class="ident" id="3850786">writeDNSQuery</span><span class="op" id="3850799">(</span><span class="ident" id="3850800">msg</span>&nbsp;<span class="op" id="3850804">*</span><span class="ident" id="3850805">dnsMsg</span><span class="op" id="3850811">)</span>&nbsp;<span class="builtintype" id="3850813">error</span>&nbsp;<span class="op" id="3850819">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3850822">b</span><span class="op" id="3850823">,</span>&nbsp;<span class="ident" id="3850825">ok</span>&nbsp;<span class="op" id="3850828">:=</span>&nbsp;<span class="ident" id="3850831">msg</span><span class="op" id="3850834">.</span><span class="ident" id="3850835">Pack</span><span class="op" id="3850839">(</span><span class="op" id="3850840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3850843">if</span>&nbsp;<span class="op" id="3850846">!</span><span class="ident" id="3850847">ok</span>&nbsp;<span class="op" id="3850850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3850854">return</span>&nbsp;<span class="ident" id="3850861">errors</span><span class="op" id="3850867">.</span><span class="ident" id="3850868">New</span><span class="op" id="3850871">(</span><span class="string" id="3850872">&#34;cannot&nbsp;marshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="3850900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3850903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3850906">if</span>&nbsp;<span class="ident" id="3850909">_</span><span class="op" id="3850910">,</span>&nbsp;<span class="ident" id="3850912">err</span>&nbsp;<span class="op" id="3850916">:=</span>&nbsp;<span class="ident" id="3850919">c</span><span class="op" id="3850920">.</span><span class="ident" id="3850921">Write</span><span class="op" id="3850926">(</span><span class="ident" id="3850927">b</span><span class="op" id="3850928">)</span><span class="op" id="3850929">;</span>&nbsp;<span class="ident" id="3850931">err</span>&nbsp;<span class="op" id="3850935">!=</span>&nbsp;<span class="builtintype" id="3850938">nil</span>&nbsp;<span class="op" id="3850942">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3850946">return</span>&nbsp;<span class="ident" id="3850953">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3850958">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3850961">return</span>&nbsp;<span class="builtintype" id="3850968">nil</span><br>
<span class="lineno"></span><span class="op" id="3850972">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="keyword" id="3850975">func</span>&nbsp;<span class="op" id="3850980">(</span><span class="ident" id="3850981">c</span>&nbsp;<span class="op" id="3850983">*</span><span class="ident" id="3850984">TCPConn</span><span class="op" id="3850991">)</span>&nbsp;<span class="ident" id="3850993">readDNSResponse</span><span class="op" id="3851008">(</span><span class="op" id="3851009">)</span>&nbsp;<span class="op" id="3851011">(</span><span class="op" id="3851012">*</span><span class="ident" id="3851013">dnsMsg</span><span class="op" id="3851019">,</span>&nbsp;<span class="builtintype" id="3851021">error</span><span class="op" id="3851026">)</span>&nbsp;<span class="op" id="3851028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3851031">b</span>&nbsp;<span class="op" id="3851033">:=</span>&nbsp;<span class="builtinfunc" id="3851036">make</span><span class="op" id="3851040">(</span><span class="op" id="3851041">[</span><span class="op" id="3851042">]</span><span class="builtintype" id="3851043">byte</span><span class="op" id="3851047">,</span>&nbsp;<span class="num" id="3851049">1280</span><span class="op" id="3851053">)</span>&nbsp;<span class="comment" id="3851055">//&nbsp;1280&nbsp;is&nbsp;a&nbsp;reasonable&nbsp;initial&nbsp;size&nbsp;for&nbsp;IP&nbsp;over&nbsp;Ethernet,&nbsp;see&nbsp;RFC&nbsp;4035</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851128">if</span>&nbsp;<span class="ident" id="3851131">_</span><span class="op" id="3851132">,</span>&nbsp;<span class="ident" id="3851134">err</span>&nbsp;<span class="op" id="3851138">:=</span>&nbsp;<span class="ident" id="3851141">io</span><span class="op" id="3851143">.</span><span class="ident" id="3851144">ReadFull</span><span class="op" id="3851152">(</span><span class="ident" id="3851153">c</span><span class="op" id="3851154">,</span>&nbsp;<span class="ident" id="3851156">b</span><span class="op" id="3851157">[</span><span class="op" id="3851158">:</span><span class="num" id="3851159">2</span><span class="op" id="3851160">]</span><span class="op" id="3851161">)</span><span class="op" id="3851162">;</span>&nbsp;<span class="ident" id="3851164">err</span>&nbsp;<span class="op" id="3851168">!=</span>&nbsp;<span class="builtintype" id="3851171">nil</span>&nbsp;<span class="op" id="3851175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851179">return</span>&nbsp;<span class="builtintype" id="3851186">nil</span><span class="op" id="3851189">,</span>&nbsp;<span class="ident" id="3851191">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3851196">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3851199">l</span>&nbsp;<span class="op" id="3851201">:=</span>&nbsp;<span class="builtintype" id="3851204">int</span><span class="op" id="3851207">(</span><span class="ident" id="3851208">b</span><span class="op" id="3851209">[</span><span class="num" id="3851210">0</span><span class="op" id="3851211">]</span><span class="op" id="3851212">)</span><span class="op" id="3851213">&lt;&lt;</span><span class="num" id="3851215">8</span>&nbsp;<span class="op" id="3851217">|</span>&nbsp;<span class="builtintype" id="3851219">int</span><span class="op" id="3851222">(</span><span class="ident" id="3851223">b</span><span class="op" id="3851224">[</span><span class="num" id="3851225">1</span><span class="op" id="3851226">]</span><span class="op" id="3851227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851230">if</span>&nbsp;<span class="ident" id="3851233">l</span>&nbsp;<span class="op" id="3851235">&gt;</span>&nbsp;<span class="builtinfunc" id="3851237">len</span><span class="op" id="3851240">(</span><span class="ident" id="3851241">b</span><span class="op" id="3851242">)</span>&nbsp;<span class="op" id="3851244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3851248">b</span>&nbsp;<span class="op" id="3851250">=</span>&nbsp;<span class="builtinfunc" id="3851252">make</span><span class="op" id="3851256">(</span><span class="op" id="3851257">[</span><span class="op" id="3851258">]</span><span class="builtintype" id="3851259">byte</span><span class="op" id="3851263">,</span>&nbsp;<span class="ident" id="3851265">l</span><span class="op" id="3851266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3851269">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3851272">n</span><span class="op" id="3851273">,</span>&nbsp;<span class="ident" id="3851275">err</span>&nbsp;<span class="op" id="3851279">:=</span>&nbsp;<span class="ident" id="3851282">io</span><span class="op" id="3851284">.</span><span class="ident" id="3851285">ReadFull</span><span class="op" id="3851293">(</span><span class="ident" id="3851294">c</span><span class="op" id="3851295">,</span>&nbsp;<span class="ident" id="3851297">b</span><span class="op" id="3851298">[</span><span class="op" id="3851299">:</span><span class="ident" id="3851300">l</span><span class="op" id="3851301">]</span><span class="op" id="3851302">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851305">if</span>&nbsp;<span class="ident" id="3851308">err</span>&nbsp;<span class="op" id="3851312">!=</span>&nbsp;<span class="builtintype" id="3851315">nil</span>&nbsp;<span class="op" id="3851319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851323">return</span>&nbsp;<span class="builtintype" id="3851330">nil</span><span class="op" id="3851333">,</span>&nbsp;<span class="ident" id="3851335">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3851340">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3851343">msg</span>&nbsp;<span class="op" id="3851347">:=</span>&nbsp;<span class="op" id="3851350">&amp;</span><span class="ident" id="3851351">dnsMsg</span><span class="op" id="3851357">{</span><span class="op" id="3851358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851361">if</span>&nbsp;<span class="op" id="3851364">!</span><span class="ident" id="3851365">msg</span><span class="op" id="3851368">.</span><span class="ident" id="3851369">Unpack</span><span class="op" id="3851375">(</span><span class="ident" id="3851376">b</span><span class="op" id="3851377">[</span><span class="op" id="3851378">:</span><span class="ident" id="3851379">n</span><span class="op" id="3851380">]</span><span class="op" id="3851381">)</span>&nbsp;<span class="op" id="3851383">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851387">return</span>&nbsp;<span class="builtintype" id="3851394">nil</span><span class="op" id="3851397">,</span>&nbsp;<span class="ident" id="3851399">errors</span><span class="op" id="3851405">.</span><span class="ident" id="3851406">New</span><span class="op" id="3851409">(</span><span class="string" id="3851410">&#34;cannot&nbsp;unmarshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="3851440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3851443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851446">return</span>&nbsp;<span class="ident" id="3851453">msg</span><span class="op" id="3851456">,</span>&nbsp;<span class="builtintype" id="3851458">nil</span><br>
<span class="lineno"></span><span class="op" id="3851462">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="keyword" id="3851465">func</span>&nbsp;<span class="op" id="3851470">(</span><span class="ident" id="3851471">c</span>&nbsp;<span class="op" id="3851473">*</span><span class="ident" id="3851474">TCPConn</span><span class="op" id="3851481">)</span>&nbsp;<span class="ident" id="3851483">writeDNSQuery</span><span class="op" id="3851496">(</span><span class="ident" id="3851497">msg</span>&nbsp;<span class="op" id="3851501">*</span><span class="ident" id="3851502">dnsMsg</span><span class="op" id="3851508">)</span>&nbsp;<span class="builtintype" id="3851510">error</span>&nbsp;<span class="op" id="3851516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3851519">b</span><span class="op" id="3851520">,</span>&nbsp;<span class="ident" id="3851522">ok</span>&nbsp;<span class="op" id="3851525">:=</span>&nbsp;<span class="ident" id="3851528">msg</span><span class="op" id="3851531">.</span><span class="ident" id="3851532">Pack</span><span class="op" id="3851536">(</span><span class="op" id="3851537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851540">if</span>&nbsp;<span class="op" id="3851543">!</span><span class="ident" id="3851544">ok</span>&nbsp;<span class="op" id="3851547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851551">return</span>&nbsp;<span class="ident" id="3851558">errors</span><span class="op" id="3851564">.</span><span class="ident" id="3851565">New</span><span class="op" id="3851568">(</span><span class="string" id="3851569">&#34;cannot&nbsp;marshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="3851597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3851600">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3851603">l</span>&nbsp;<span class="op" id="3851605">:=</span>&nbsp;<span class="builtintype" id="3851608">uint16</span><span class="op" id="3851614">(</span><span class="builtinfunc" id="3851615">len</span><span class="op" id="3851618">(</span><span class="ident" id="3851619">b</span><span class="op" id="3851620">)</span><span class="op" id="3851621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3851624">b</span>&nbsp;<span class="op" id="3851626">=</span>&nbsp;<span class="builtinfunc" id="3851628">append</span><span class="op" id="3851634">(</span><span class="op" id="3851635">[</span><span class="op" id="3851636">]</span><span class="builtintype" id="3851637">byte</span><span class="op" id="3851641">{</span><span class="builtintype" id="3851642">byte</span><span class="op" id="3851646">(</span><span class="ident" id="3851647">l</span>&nbsp;<span class="op" id="3851649">&gt;&gt;</span>&nbsp;<span class="num" id="3851652">8</span><span class="op" id="3851653">)</span><span class="op" id="3851654">,</span>&nbsp;<span class="builtintype" id="3851656">byte</span><span class="op" id="3851660">(</span><span class="ident" id="3851661">l</span><span class="op" id="3851662">)</span><span class="op" id="3851663">}</span><span class="op" id="3851664">,</span>&nbsp;<span class="ident" id="3851666">b</span><span class="op" id="3851667">...</span><span class="op" id="3851670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851673">if</span>&nbsp;<span class="ident" id="3851676">_</span><span class="op" id="3851677">,</span>&nbsp;<span class="ident" id="3851679">err</span>&nbsp;<span class="op" id="3851683">:=</span>&nbsp;<span class="ident" id="3851686">c</span><span class="op" id="3851687">.</span><span class="ident" id="3851688">Write</span><span class="op" id="3851693">(</span><span class="ident" id="3851694">b</span><span class="op" id="3851695">)</span><span class="op" id="3851696">;</span>&nbsp;<span class="ident" id="3851698">err</span>&nbsp;<span class="op" id="3851702">!=</span>&nbsp;<span class="builtintype" id="3851705">nil</span>&nbsp;<span class="op" id="3851709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851713">return</span>&nbsp;<span class="ident" id="3851720">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3851725">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851728">return</span>&nbsp;<span class="builtintype" id="3851735">nil</span><br>
<span class="lineno"></span><span class="op" id="3851739">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3851742">func</span>&nbsp;<span class="op" id="3851747">(</span><span class="ident" id="3851748">d</span>&nbsp;<span class="op" id="3851750">*</span><span class="ident" id="3851751">Dialer</span><span class="op" id="3851757">)</span>&nbsp;<span class="ident" id="3851759">dialDNS</span><span class="op" id="3851766">(</span><span class="ident" id="3851767">network</span><span class="op" id="3851774">,</span>&nbsp;<span class="ident" id="3851776">server</span>&nbsp;<span class="builtintype" id="3851783">string</span><span class="op" id="3851789">)</span>&nbsp;<span class="op" id="3851791">(</span><span class="ident" id="3851792">dnsConn</span><span class="op" id="3851799">,</span>&nbsp;<span class="builtintype" id="3851801">error</span><span class="op" id="3851806">)</span>&nbsp;<span class="op" id="3851808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851811">switch</span>&nbsp;<span class="ident" id="3851818">network</span>&nbsp;<span class="op" id="3851826">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851829">case</span>&nbsp;<span class="string" id="3851834">&#34;tcp&#34;</span><span class="op" id="3851839">,</span>&nbsp;<span class="string" id="3851841">&#34;tcp4&#34;</span><span class="op" id="3851847">,</span>&nbsp;<span class="string" id="3851849">&#34;tcp6&#34;</span><span class="op" id="3851855">,</span>&nbsp;<span class="string" id="3851857">&#34;udp&#34;</span><span class="op" id="3851862">,</span>&nbsp;<span class="string" id="3851864">&#34;udp4&#34;</span><span class="op" id="3851870">,</span>&nbsp;<span class="string" id="3851872">&#34;udp6&#34;</span><span class="op" id="3851878">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851881">default</span><span class="op" id="3851888">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851892">return</span>&nbsp;<span class="builtintype" id="3851899">nil</span><span class="op" id="3851902">,</span>&nbsp;<span class="ident" id="3851904">UnknownNetworkError</span><span class="op" id="3851923">(</span><span class="ident" id="3851924">network</span><span class="op" id="3851931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3851934">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3851937">//&nbsp;Calling&nbsp;Dial&nbsp;here&nbsp;is&nbsp;scary&nbsp;--&nbsp;we&nbsp;have&nbsp;to&nbsp;be&nbsp;sure&nbsp;not&nbsp;to</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3851997">//&nbsp;dial&nbsp;a&nbsp;name&nbsp;that&nbsp;will&nbsp;require&nbsp;a&nbsp;DNS&nbsp;lookup,&nbsp;or&nbsp;Dial&nbsp;will</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3852058">//&nbsp;call&nbsp;back&nbsp;here&nbsp;to&nbsp;translate&nbsp;it.&nbsp;The&nbsp;DNS&nbsp;config&nbsp;parser&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3852120">//&nbsp;already&nbsp;checked&nbsp;that&nbsp;all&nbsp;the&nbsp;cfg.servers[i]&nbsp;are&nbsp;IP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3852175">//&nbsp;addresses,&nbsp;which&nbsp;Dial&nbsp;will&nbsp;use&nbsp;without&nbsp;a&nbsp;DNS&nbsp;lookup.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3852232">c</span><span class="op" id="3852233">,</span>&nbsp;<span class="ident" id="3852235">err</span>&nbsp;<span class="op" id="3852239">:=</span>&nbsp;<span class="ident" id="3852242">d</span><span class="op" id="3852243">.</span><span class="ident" id="3852244">Dial</span><span class="op" id="3852248">(</span><span class="ident" id="3852249">network</span><span class="op" id="3852256">,</span>&nbsp;<span class="ident" id="3852258">server</span><span class="op" id="3852264">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852267">if</span>&nbsp;<span class="ident" id="3852270">err</span>&nbsp;<span class="op" id="3852274">!=</span>&nbsp;<span class="builtintype" id="3852277">nil</span>&nbsp;<span class="op" id="3852281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852285">return</span>&nbsp;<span class="builtintype" id="3852292">nil</span><span class="op" id="3852295">,</span>&nbsp;<span class="ident" id="3852297">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3852302">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852305">switch</span>&nbsp;<span class="ident" id="3852312">network</span>&nbsp;<span class="op" id="3852320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852323">case</span>&nbsp;<span class="string" id="3852328">&#34;tcp&#34;</span><span class="op" id="3852333">,</span>&nbsp;<span class="string" id="3852335">&#34;tcp4&#34;</span><span class="op" id="3852341">,</span>&nbsp;<span class="string" id="3852343">&#34;tcp6&#34;</span><span class="op" id="3852349">:</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852353">return</span>&nbsp;<span class="ident" id="3852360">c</span><span class="op" id="3852361">.</span><span class="op" id="3852362">(</span><span class="op" id="3852363">*</span><span class="ident" id="3852364">TCPConn</span><span class="op" id="3852371">)</span><span class="op" id="3852372">,</span>&nbsp;<span class="builtintype" id="3852374">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852379">case</span>&nbsp;<span class="string" id="3852384">&#34;udp&#34;</span><span class="op" id="3852389">,</span>&nbsp;<span class="string" id="3852391">&#34;udp4&#34;</span><span class="op" id="3852397">,</span>&nbsp;<span class="string" id="3852399">&#34;udp6&#34;</span><span class="op" id="3852405">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852409">return</span>&nbsp;<span class="ident" id="3852416">c</span><span class="op" id="3852417">.</span><span class="op" id="3852418">(</span><span class="op" id="3852419">*</span><span class="ident" id="3852420">UDPConn</span><span class="op" id="3852427">)</span><span class="op" id="3852428">,</span>&nbsp;<span class="builtintype" id="3852430">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3852435">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3852438">panic</span><span class="op" id="3852443">(</span><span class="string" id="3852444">&#34;unreachable&#34;</span><span class="op" id="3852457">)</span><br>
<span class="lineno">120</span><span class="op" id="3852459">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3852462">//&nbsp;exchange&nbsp;sends&nbsp;a&nbsp;query&nbsp;on&nbsp;the&nbsp;connection&nbsp;and&nbsp;hopes&nbsp;for&nbsp;a&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="3852532">func</span>&nbsp;<span class="ident" id="3852537">exchange</span><span class="op" id="3852545">(</span><span class="ident" id="3852546">server</span><span class="op" id="3852552">,</span>&nbsp;<span class="ident" id="3852554">name</span>&nbsp;<span class="builtintype" id="3852559">string</span><span class="op" id="3852565">,</span>&nbsp;<span class="ident" id="3852567">qtype</span>&nbsp;<span class="builtintype" id="3852573">uint16</span><span class="op" id="3852579">,</span>&nbsp;<span class="ident" id="3852581">timeout</span>&nbsp;<span class="ident" id="3852589">time</span><span class="op" id="3852593">.</span><span class="ident" id="3852594">Duration</span><span class="op" id="3852602">)</span>&nbsp;<span class="op" id="3852604">(</span><span class="op" id="3852605">*</span><span class="ident" id="3852606">dnsMsg</span><span class="op" id="3852612">,</span>&nbsp;<span class="builtintype" id="3852614">error</span><span class="op" id="3852619">)</span>&nbsp;<span class="op" id="3852621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3852624">d</span>&nbsp;<span class="op" id="3852626">:=</span>&nbsp;<span class="ident" id="3852629">Dialer</span><span class="op" id="3852635">{</span><span class="ident" id="3852636">Timeout</span><span class="op" id="3852643">:</span>&nbsp;<span class="ident" id="3852645">timeout</span><span class="op" id="3852652">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3852655">out</span>&nbsp;<span class="op" id="3852659">:=</span>&nbsp;<span class="ident" id="3852662">dnsMsg</span><span class="op" id="3852668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3852672">dnsMsgHdr</span><span class="op" id="3852681">:</span>&nbsp;<span class="ident" id="3852683">dnsMsgHdr</span><span class="op" id="3852692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3852697">recursion_desired</span><span class="op" id="3852714">:</span>&nbsp;<span class="builtintype" id="3852716">true</span><span class="op" id="3852720">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3852724">}</span><span class="op" id="3852725">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3852729">question</span><span class="op" id="3852737">:</span>&nbsp;<span class="op" id="3852739">[</span><span class="op" id="3852740">]</span><span class="ident" id="3852741">dnsQuestion</span><span class="op" id="3852752">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3852757">{</span><span class="ident" id="3852758">name</span><span class="op" id="3852762">,</span>&nbsp;<span class="ident" id="3852764">qtype</span><span class="op" id="3852769">,</span>&nbsp;<span class="ident" id="3852771">dnsClassINET</span><span class="op" id="3852783">}</span><span class="op" id="3852784">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3852788">}</span><span class="op" id="3852789">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3852792">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852795">for</span>&nbsp;<span class="ident" id="3852799">_</span><span class="op" id="3852800">,</span>&nbsp;<span class="ident" id="3852802">network</span>&nbsp;<span class="op" id="3852810">:=</span>&nbsp;<span class="keyword" id="3852813">range</span>&nbsp;<span class="op" id="3852819">[</span><span class="op" id="3852820">]</span><span class="builtintype" id="3852821">string</span><span class="op" id="3852827">{</span><span class="string" id="3852828">&#34;udp&#34;</span><span class="op" id="3852833">,</span>&nbsp;<span class="string" id="3852835">&#34;tcp&#34;</span><span class="op" id="3852840">}</span>&nbsp;<span class="op" id="3852842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3852846">c</span><span class="op" id="3852847">,</span>&nbsp;<span class="ident" id="3852849">err</span>&nbsp;<span class="op" id="3852853">:=</span>&nbsp;<span class="ident" id="3852856">d</span><span class="op" id="3852857">.</span><span class="ident" id="3852858">dialDNS</span><span class="op" id="3852865">(</span><span class="ident" id="3852866">network</span><span class="op" id="3852873">,</span>&nbsp;<span class="ident" id="3852875">server</span><span class="op" id="3852881">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852885">if</span>&nbsp;<span class="ident" id="3852888">err</span>&nbsp;<span class="op" id="3852892">!=</span>&nbsp;<span class="builtintype" id="3852895">nil</span>&nbsp;<span class="op" id="3852899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852904">return</span>&nbsp;<span class="builtintype" id="3852911">nil</span><span class="op" id="3852914">,</span>&nbsp;<span class="ident" id="3852916">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3852922">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852926">defer</span>&nbsp;<span class="ident" id="3852932">c</span><span class="op" id="3852933">.</span><span class="ident" id="3852934">Close</span><span class="op" id="3852939">(</span><span class="op" id="3852940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852944">if</span>&nbsp;<span class="ident" id="3852947">timeout</span>&nbsp;<span class="op" id="3852955">&gt;</span>&nbsp;<span class="num" id="3852957">0</span>&nbsp;<span class="op" id="3852959">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3852964">c</span><span class="op" id="3852965">.</span><span class="ident" id="3852966">SetDeadline</span><span class="op" id="3852977">(</span><span class="ident" id="3852978">time</span><span class="op" id="3852982">.</span><span class="ident" id="3852983">Now</span><span class="op" id="3852986">(</span><span class="op" id="3852987">)</span><span class="op" id="3852988">.</span><span class="ident" id="3852989">Add</span><span class="op" id="3852992">(</span><span class="ident" id="3852993">timeout</span><span class="op" id="3853000">)</span><span class="op" id="3853001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3853005">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3853009">out</span><span class="op" id="3853012">.</span><span class="ident" id="3853013">id</span>&nbsp;<span class="op" id="3853016">=</span>&nbsp;<span class="builtintype" id="3853018">uint16</span><span class="op" id="3853024">(</span><span class="ident" id="3853025">rand</span><span class="op" id="3853029">.</span><span class="ident" id="3853030">Int</span><span class="op" id="3853033">(</span><span class="op" id="3853034">)</span><span class="op" id="3853035">)</span>&nbsp;<span class="op" id="3853037">^</span>&nbsp;<span class="builtintype" id="3853039">uint16</span><span class="op" id="3853045">(</span><span class="ident" id="3853046">time</span><span class="op" id="3853050">.</span><span class="ident" id="3853051">Now</span><span class="op" id="3853054">(</span><span class="op" id="3853055">)</span><span class="op" id="3853056">.</span><span class="ident" id="3853057">UnixNano</span><span class="op" id="3853065">(</span><span class="op" id="3853066">)</span><span class="op" id="3853067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3853071">if</span>&nbsp;<span class="ident" id="3853074">err</span>&nbsp;<span class="op" id="3853078">:=</span>&nbsp;<span class="ident" id="3853081">c</span><span class="op" id="3853082">.</span><span class="ident" id="3853083">writeDNSQuery</span><span class="op" id="3853096">(</span><span class="op" id="3853097">&amp;</span><span class="ident" id="3853098">out</span><span class="op" id="3853101">)</span><span class="op" id="3853102">;</span>&nbsp;<span class="ident" id="3853104">err</span>&nbsp;<span class="op" id="3853108">!=</span>&nbsp;<span class="builtintype" id="3853111">nil</span>&nbsp;<span class="op" id="3853115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3853120">return</span>&nbsp;<span class="builtintype" id="3853127">nil</span><span class="op" id="3853130">,</span>&nbsp;<span class="ident" id="3853132">err</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3853138">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3853142">in</span><span class="op" id="3853144">,</span>&nbsp;<span class="ident" id="3853146">err</span>&nbsp;<span class="op" id="3853150">:=</span>&nbsp;<span class="ident" id="3853153">c</span><span class="op" id="3853154">.</span><span class="ident" id="3853155">readDNSResponse</span><span class="op" id="3853170">(</span><span class="op" id="3853171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3853175">if</span>&nbsp;<span class="ident" id="3853178">err</span>&nbsp;<span class="op" id="3853182">!=</span>&nbsp;<span class="builtintype" id="3853185">nil</span>&nbsp;<span class="op" id="3853189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3853194">return</span>&nbsp;<span class="builtintype" id="3853201">nil</span><span class="op" id="3853204">,</span>&nbsp;<span class="ident" id="3853206">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3853212">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3853216">if</span>&nbsp;<span class="ident" id="3853219">in</span><span class="op" id="3853221">.</span><span class="ident" id="3853222">id</span>&nbsp;<span class="op" id="3853225">!=</span>&nbsp;<span class="ident" id="3853228">out</span><span class="op" id="3853231">.</span><span class="ident" id="3853232">id</span>&nbsp;<span class="op" id="3853235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3853240">return</span>&nbsp;<span class="builtintype" id="3853247">nil</span><span class="op" id="3853250">,</span>&nbsp;<span class="ident" id="3853252">errors</span><span class="op" id="3853258">.</span><span class="ident" id="3853259">New</span><span class="op" id="3853262">(</span><span class="string" id="3853263">&#34;DNS&nbsp;message&nbsp;ID&nbsp;mismatch&#34;</span><span class="op" id="3853288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3853292">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3853296">if</span>&nbsp;<span class="ident" id="3853299">in</span><span class="op" id="3853301">.</span><span class="ident" id="3853302">truncated</span>&nbsp;<span class="op" id="3853312">{</span>&nbsp;<span class="comment" id="3853314">//&nbsp;see&nbsp;RFC&nbsp;5966</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3853333">continue</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3853344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3853348">return</span>&nbsp;<span class="ident" id="3853355">in</span><span class="op" id="3853357">,</span>&nbsp;<span class="builtintype" id="3853359">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3853364">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3853367">return</span>&nbsp;<span class="builtintype" id="3853374">nil</span><span class="op" id="3853377">,</span>&nbsp;<span class="ident" id="3853379">errors</span><span class="op" id="3853385">.</span><span class="ident" id="3853386">New</span><span class="op" id="3853389">(</span><span class="string" id="3853390">&#34;no&nbsp;answer&nbsp;from&nbsp;DNS&nbsp;server&#34;</span><span class="op" id="3853417">)</span><br>
<span class="lineno"></span><span class="op" id="3853419">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="comment" id="3853422">//&nbsp;Do&nbsp;a&nbsp;lookup&nbsp;for&nbsp;a&nbsp;single&nbsp;name,&nbsp;which&nbsp;must&nbsp;be&nbsp;rooted</span><br>
<span class="lineno"></span><span class="comment" id="3853477">//&nbsp;(otherwise&nbsp;answer&nbsp;will&nbsp;not&nbsp;find&nbsp;the&nbsp;answers).</span><br>
<span class="lineno"></span><span class="keyword" id="3853526">func</span>&nbsp;<span class="ident" id="3853531">tryOneName</span><span class="op" id="3853541">(</span><span class="ident" id="3853542">cfg</span>&nbsp;<span class="op" id="3853546">*</span><span class="ident" id="3853547">dnsConfig</span><span class="op" id="3853556">,</span>&nbsp;<span class="ident" id="3853558">name</span>&nbsp;<span class="builtintype" id="3853563">string</span><span class="op" id="3853569">,</span>&nbsp;<span class="ident" id="3853571">qtype</span>&nbsp;<span class="builtintype" id="3853577">uint16</span><span class="op" id="3853583">)</span>&nbsp;<span class="op" id="3853585">(</span><span class="builtintype" id="3853586">string</span><span class="op" id="3853592">,</span>&nbsp;<span class="op" id="3853594">[</span><span class="op" id="3853595">]</span><span class="ident" id="3853596">dnsRR</span><span class="op" id="3853601">,</span>&nbsp;<span class="builtintype" id="3853603">error</span><span class="op" id="3853608">)</span>&nbsp;<span class="op" id="3853610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3853613">if</span>&nbsp;<span class="builtinfunc" id="3853616">len</span><span class="op" id="3853619">(</span><span class="ident" id="3853620">cfg</span><span class="op" id="3853623">.</span><span class="ident" id="3853624">servers</span><span class="op" id="3853631">)</span>&nbsp;<span class="op" id="3853633">==</span>&nbsp;<span class="num" id="3853636">0</span>&nbsp;<span class="op" id="3853638">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3853642">return</span>&nbsp;<span class="string" id="3853649">&#34;&#34;</span><span class="op" id="3853651">,</span>&nbsp;<span class="builtintype" id="3853653">nil</span><span class="op" id="3853656">,</span>&nbsp;<span class="op" id="3853658">&amp;</span><span class="ident" id="3853659">DNSError</span><span class="op" id="3853667">{</span><span class="ident" id="3853668">Err</span><span class="op" id="3853671">:</span>&nbsp;<span class="string" id="3853673">&#34;no&nbsp;DNS&nbsp;servers&#34;</span><span class="op" id="3853689">,</span>&nbsp;<span class="ident" id="3853691">Name</span><span class="op" id="3853695">:</span>&nbsp;<span class="ident" id="3853697">name</span><span class="op" id="3853701">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3853704">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3853707">if</span>&nbsp;<span class="builtinfunc" id="3853710">len</span><span class="op" id="3853713">(</span><span class="ident" id="3853714">name</span><span class="op" id="3853718">)</span>&nbsp;<span class="op" id="3853720">&gt;=</span>&nbsp;<span class="num" id="3853723">256</span>&nbsp;<span class="op" id="3853727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3853731">return</span>&nbsp;<span class="string" id="3853738">&#34;&#34;</span><span class="op" id="3853740">,</span>&nbsp;<span class="builtintype" id="3853742">nil</span><span class="op" id="3853745">,</span>&nbsp;<span class="op" id="3853747">&amp;</span><span class="ident" id="3853748">DNSError</span><span class="op" id="3853756">{</span><span class="ident" id="3853757">Err</span><span class="op" id="3853760">:</span>&nbsp;<span class="string" id="3853762">&#34;DNS&nbsp;name&nbsp;too&nbsp;long&#34;</span><span class="op" id="3853781">,</span>&nbsp;<span class="ident" id="3853783">Name</span><span class="op" id="3853787">:</span>&nbsp;<span class="ident" id="3853789">name</span><span class="op" id="3853793">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3853796">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3853799">timeout</span>&nbsp;<span class="op" id="3853807">:=</span>&nbsp;<span class="ident" id="3853810">time</span><span class="op" id="3853814">.</span><span class="ident" id="3853815">Duration</span><span class="op" id="3853823">(</span><span class="ident" id="3853824">cfg</span><span class="op" id="3853827">.</span><span class="ident" id="3853828">timeout</span><span class="op" id="3853835">)</span>&nbsp;<span class="op" id="3853837">*</span>&nbsp;<span class="ident" id="3853839">time</span><span class="op" id="3853843">.</span><span class="ident" id="3853844">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3853852">var</span>&nbsp;<span class="ident" id="3853856">lastErr</span>&nbsp;<span class="builtintype" id="3853864">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3853871">for</span>&nbsp;<span class="ident" id="3853875">i</span>&nbsp;<span class="op" id="3853877">:=</span>&nbsp;<span class="num" id="3853880">0</span><span class="op" id="3853881">;</span>&nbsp;<span class="ident" id="3853883">i</span>&nbsp;<span class="op" id="3853885">&lt;</span>&nbsp;<span class="ident" id="3853887">cfg</span><span class="op" id="3853890">.</span><span class="ident" id="3853891">attempts</span><span class="op" id="3853899">;</span>&nbsp;<span class="ident" id="3853901">i</span><span class="op" id="3853902">++</span>&nbsp;<span class="op" id="3853905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3853909">for</span>&nbsp;<span class="ident" id="3853913">_</span><span class="op" id="3853914">,</span>&nbsp;<span class="ident" id="3853916">server</span>&nbsp;<span class="op" id="3853923">:=</span>&nbsp;<span class="keyword" id="3853926">range</span>&nbsp;<span class="ident" id="3853932">cfg</span><span class="op" id="3853935">.</span><span class="ident" id="3853936">servers</span>&nbsp;<span class="op" id="3853944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3853949">server</span>&nbsp;<span class="op" id="3853956">=</span>&nbsp;<span class="ident" id="3853958">JoinHostPort</span><span class="op" id="3853970">(</span><span class="ident" id="3853971">server</span><span class="op" id="3853977">,</span>&nbsp;<span class="string" id="3853979">&#34;53&#34;</span><span class="op" id="3853983">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3853988">msg</span><span class="op" id="3853991">,</span>&nbsp;<span class="ident" id="3853993">err</span>&nbsp;<span class="op" id="3853997">:=</span>&nbsp;<span class="ident" id="3854000">exchange</span><span class="op" id="3854008">(</span><span class="ident" id="3854009">server</span><span class="op" id="3854015">,</span>&nbsp;<span class="ident" id="3854017">name</span><span class="op" id="3854021">,</span>&nbsp;<span class="ident" id="3854023">qtype</span><span class="op" id="3854028">,</span>&nbsp;<span class="ident" id="3854030">timeout</span><span class="op" id="3854037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3854042">if</span>&nbsp;<span class="ident" id="3854045">err</span>&nbsp;<span class="op" id="3854049">!=</span>&nbsp;<span class="builtintype" id="3854052">nil</span>&nbsp;<span class="op" id="3854056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3854062">lastErr</span>&nbsp;<span class="op" id="3854070">=</span>&nbsp;<span class="op" id="3854072">&amp;</span><span class="ident" id="3854073">DNSError</span><span class="op" id="3854081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3854088">Err</span><span class="op" id="3854091">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3854096">err</span><span class="op" id="3854099">.</span><span class="ident" id="3854100">Error</span><span class="op" id="3854105">(</span><span class="op" id="3854106">)</span><span class="op" id="3854107">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3854114">Name</span><span class="op" id="3854118">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3854122">name</span><span class="op" id="3854126">,</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3854133">Server</span><span class="op" id="3854139">:</span>&nbsp;<span class="ident" id="3854141">server</span><span class="op" id="3854147">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3854153">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3854159">if</span>&nbsp;<span class="ident" id="3854162">nerr</span><span class="op" id="3854166">,</span>&nbsp;<span class="ident" id="3854168">ok</span>&nbsp;<span class="op" id="3854171">:=</span>&nbsp;<span class="ident" id="3854174">err</span><span class="op" id="3854177">.</span><span class="op" id="3854178">(</span><span class="ident" id="3854179">Error</span><span class="op" id="3854184">)</span><span class="op" id="3854185">;</span>&nbsp;<span class="ident" id="3854187">ok</span>&nbsp;<span class="op" id="3854190">&amp;&amp;</span>&nbsp;<span class="ident" id="3854193">nerr</span><span class="op" id="3854197">.</span><span class="ident" id="3854198">Timeout</span><span class="op" id="3854205">(</span><span class="op" id="3854206">)</span>&nbsp;<span class="op" id="3854208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3854215">lastErr</span><span class="op" id="3854222">.</span><span class="op" id="3854223">(</span><span class="op" id="3854224">*</span><span class="ident" id="3854225">DNSError</span><span class="op" id="3854233">)</span><span class="op" id="3854234">.</span><span class="ident" id="3854235">IsTimeout</span>&nbsp;<span class="op" id="3854245">=</span>&nbsp;<span class="builtintype" id="3854247">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3854256">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3854262">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3854274">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3854279">cname</span><span class="op" id="3854284">,</span>&nbsp;<span class="ident" id="3854286">addrs</span><span class="op" id="3854291">,</span>&nbsp;<span class="ident" id="3854293">err</span>&nbsp;<span class="op" id="3854297">:=</span>&nbsp;<span class="ident" id="3854300">answer</span><span class="op" id="3854306">(</span><span class="ident" id="3854307">name</span><span class="op" id="3854311">,</span>&nbsp;<span class="ident" id="3854313">server</span><span class="op" id="3854319">,</span>&nbsp;<span class="ident" id="3854321">msg</span><span class="op" id="3854324">,</span>&nbsp;<span class="ident" id="3854326">qtype</span><span class="op" id="3854331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3854336">if</span>&nbsp;<span class="ident" id="3854339">err</span>&nbsp;<span class="op" id="3854343">==</span>&nbsp;<span class="builtintype" id="3854346">nil</span>&nbsp;<span class="op" id="3854350">||</span>&nbsp;<span class="ident" id="3854353">err</span><span class="op" id="3854356">.</span><span class="op" id="3854357">(</span><span class="op" id="3854358">*</span><span class="ident" id="3854359">DNSError</span><span class="op" id="3854367">)</span><span class="op" id="3854368">.</span><span class="ident" id="3854369">Err</span>&nbsp;<span class="op" id="3854373">==</span>&nbsp;<span class="ident" id="3854376">noSuchHost</span>&nbsp;<span class="op" id="3854387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3854393">return</span>&nbsp;<span class="ident" id="3854400">cname</span><span class="op" id="3854405">,</span>&nbsp;<span class="ident" id="3854407">addrs</span><span class="op" id="3854412">,</span>&nbsp;<span class="ident" id="3854414">err</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3854421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3854426">lastErr</span>&nbsp;<span class="op" id="3854434">=</span>&nbsp;<span class="ident" id="3854436">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3854442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3854445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3854448">return</span>&nbsp;<span class="string" id="3854455">&#34;&#34;</span><span class="op" id="3854457">,</span>&nbsp;<span class="builtintype" id="3854459">nil</span><span class="op" id="3854462">,</span>&nbsp;<span class="ident" id="3854464">lastErr</span><br>
<span class="lineno">195</span><span class="op" id="3854472">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3854475">func</span>&nbsp;<span class="ident" id="3854480">convertRR_A</span><span class="op" id="3854491">(</span><span class="ident" id="3854492">records</span>&nbsp;<span class="op" id="3854500">[</span><span class="op" id="3854501">]</span><span class="ident" id="3854502">dnsRR</span><span class="op" id="3854507">)</span>&nbsp;<span class="op" id="3854509">[</span><span class="op" id="3854510">]</span><span class="ident" id="3854511">IP</span>&nbsp;<span class="op" id="3854514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3854517">addrs</span>&nbsp;<span class="op" id="3854523">:=</span>&nbsp;<span class="builtinfunc" id="3854526">make</span><span class="op" id="3854530">(</span><span class="op" id="3854531">[</span><span class="op" id="3854532">]</span><span class="ident" id="3854533">IP</span><span class="op" id="3854535">,</span>&nbsp;<span class="builtinfunc" id="3854537">len</span><span class="op" id="3854540">(</span><span class="ident" id="3854541">records</span><span class="op" id="3854548">)</span><span class="op" id="3854549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3854552">for</span>&nbsp;<span class="ident" id="3854556">i</span><span class="op" id="3854557">,</span>&nbsp;<span class="ident" id="3854559">rr</span>&nbsp;<span class="op" id="3854562">:=</span>&nbsp;<span class="keyword" id="3854565">range</span>&nbsp;<span class="ident" id="3854571">records</span>&nbsp;<span class="op" id="3854579">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3854583">a</span>&nbsp;<span class="op" id="3854585">:=</span>&nbsp;<span class="ident" id="3854588">rr</span><span class="op" id="3854590">.</span><span class="op" id="3854591">(</span><span class="op" id="3854592">*</span><span class="ident" id="3854593">dnsRR_A</span><span class="op" id="3854600">)</span><span class="op" id="3854601">.</span><span class="ident" id="3854602">A</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3854606">addrs</span><span class="op" id="3854611">[</span><span class="ident" id="3854612">i</span><span class="op" id="3854613">]</span>&nbsp;<span class="op" id="3854615">=</span>&nbsp;<span class="ident" id="3854617">IPv4</span><span class="op" id="3854621">(</span><span class="builtintype" id="3854622">byte</span><span class="op" id="3854626">(</span><span class="ident" id="3854627">a</span><span class="op" id="3854628">&gt;&gt;</span><span class="num" id="3854630">24</span><span class="op" id="3854632">)</span><span class="op" id="3854633">,</span>&nbsp;<span class="builtintype" id="3854635">byte</span><span class="op" id="3854639">(</span><span class="ident" id="3854640">a</span><span class="op" id="3854641">&gt;&gt;</span><span class="num" id="3854643">16</span><span class="op" id="3854645">)</span><span class="op" id="3854646">,</span>&nbsp;<span class="builtintype" id="3854648">byte</span><span class="op" id="3854652">(</span><span class="ident" id="3854653">a</span><span class="op" id="3854654">&gt;&gt;</span><span class="num" id="3854656">8</span><span class="op" id="3854657">)</span><span class="op" id="3854658">,</span>&nbsp;<span class="builtintype" id="3854660">byte</span><span class="op" id="3854664">(</span><span class="ident" id="3854665">a</span><span class="op" id="3854666">)</span><span class="op" id="3854667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3854670">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3854673">return</span>&nbsp;<span class="ident" id="3854680">addrs</span><br>
<span class="lineno"></span><span class="op" id="3854686">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="3854689">func</span>&nbsp;<span class="ident" id="3854694">convertRR_AAAA</span><span class="op" id="3854708">(</span><span class="ident" id="3854709">records</span>&nbsp;<span class="op" id="3854717">[</span><span class="op" id="3854718">]</span><span class="ident" id="3854719">dnsRR</span><span class="op" id="3854724">)</span>&nbsp;<span class="op" id="3854726">[</span><span class="op" id="3854727">]</span><span class="ident" id="3854728">IP</span>&nbsp;<span class="op" id="3854731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3854734">addrs</span>&nbsp;<span class="op" id="3854740">:=</span>&nbsp;<span class="builtinfunc" id="3854743">make</span><span class="op" id="3854747">(</span><span class="op" id="3854748">[</span><span class="op" id="3854749">]</span><span class="ident" id="3854750">IP</span><span class="op" id="3854752">,</span>&nbsp;<span class="builtinfunc" id="3854754">len</span><span class="op" id="3854757">(</span><span class="ident" id="3854758">records</span><span class="op" id="3854765">)</span><span class="op" id="3854766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3854769">for</span>&nbsp;<span class="ident" id="3854773">i</span><span class="op" id="3854774">,</span>&nbsp;<span class="ident" id="3854776">rr</span>&nbsp;<span class="op" id="3854779">:=</span>&nbsp;<span class="keyword" id="3854782">range</span>&nbsp;<span class="ident" id="3854788">records</span>&nbsp;<span class="op" id="3854796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3854800">a</span>&nbsp;<span class="op" id="3854802">:=</span>&nbsp;<span class="builtinfunc" id="3854805">make</span><span class="op" id="3854809">(</span><span class="ident" id="3854810">IP</span><span class="op" id="3854812">,</span>&nbsp;<span class="ident" id="3854814">IPv6len</span><span class="op" id="3854821">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3854825">copy</span><span class="op" id="3854829">(</span><span class="ident" id="3854830">a</span><span class="op" id="3854831">,</span>&nbsp;<span class="ident" id="3854833">rr</span><span class="op" id="3854835">.</span><span class="op" id="3854836">(</span><span class="op" id="3854837">*</span><span class="ident" id="3854838">dnsRR_AAAA</span><span class="op" id="3854848">)</span><span class="op" id="3854849">.</span><span class="ident" id="3854850">AAAA</span><span class="op" id="3854854">[</span><span class="op" id="3854855">:</span><span class="op" id="3854856">]</span><span class="op" id="3854857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3854861">addrs</span><span class="op" id="3854866">[</span><span class="ident" id="3854867">i</span><span class="op" id="3854868">]</span>&nbsp;<span class="op" id="3854870">=</span>&nbsp;<span class="ident" id="3854872">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3854875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3854878">return</span>&nbsp;<span class="ident" id="3854885">addrs</span><br>
<span class="lineno"></span><span class="op" id="3854891">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="3854894">var</span>&nbsp;<span class="ident" id="3854898">cfg</span>&nbsp;<span class="keyword" id="3854902">struct</span>&nbsp;<span class="op" id="3854909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3854912">ch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3854922">chan</span>&nbsp;<span class="keyword" id="3854927">struct</span><span class="op" id="3854933">{</span><span class="op" id="3854934">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3854937">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3854947">sync</span><span class="op" id="3854951">.</span><span class="ident" id="3854952">RWMutex</span>&nbsp;<span class="comment" id="3854960">//&nbsp;protects&nbsp;dnsConfig&nbsp;and&nbsp;dnserr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3854994">dnsConfig</span>&nbsp;<span class="op" id="3855004">*</span><span class="ident" id="3855005">dnsConfig</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3855016">dnserr</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3855026">error</span><br>
<span class="lineno"></span><span class="op" id="3855032">}</span><br>
<span class="lineno"></span><span class="keyword" id="3855034">var</span>&nbsp;<span class="ident" id="3855038">onceLoadConfig</span>&nbsp;<span class="ident" id="3855053">sync</span><span class="op" id="3855057">.</span><span class="ident" id="3855058">Once</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3855064">//&nbsp;Assume&nbsp;dns&nbsp;config&nbsp;file&nbsp;is&nbsp;/etc/resolv.conf&nbsp;here</span><br>
<span class="lineno">225</span><span class="keyword" id="3855115">func</span>&nbsp;<span class="ident" id="3855120">loadDefaultConfig</span><span class="op" id="3855137">(</span><span class="op" id="3855138">)</span>&nbsp;<span class="op" id="3855140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3855143">loadConfig</span><span class="op" id="3855153">(</span><span class="string" id="3855154">&#34;/etc/resolv.conf&#34;</span><span class="op" id="3855172">,</span>&nbsp;<span class="num" id="3855174">5</span><span class="op" id="3855175">*</span><span class="ident" id="3855176">time</span><span class="op" id="3855180">.</span><span class="ident" id="3855181">Second</span><span class="op" id="3855187">,</span>&nbsp;<span class="builtintype" id="3855189">nil</span><span class="op" id="3855192">)</span><br>
<span class="lineno"></span><span class="op" id="3855194">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3855197">func</span>&nbsp;<span class="ident" id="3855202">loadConfig</span><span class="op" id="3855212">(</span><span class="ident" id="3855213">resolvConfPath</span>&nbsp;<span class="builtintype" id="3855228">string</span><span class="op" id="3855234">,</span>&nbsp;<span class="ident" id="3855236">reloadTime</span>&nbsp;<span class="ident" id="3855247">time</span><span class="op" id="3855251">.</span><span class="ident" id="3855252">Duration</span><span class="op" id="3855260">,</span>&nbsp;<span class="ident" id="3855262">quit</span>&nbsp;<span class="op" id="3855267">&lt;-</span><span class="keyword" id="3855269">chan</span>&nbsp;<span class="keyword" id="3855274">chan</span>&nbsp;<span class="keyword" id="3855279">struct</span><span class="op" id="3855285">{</span><span class="op" id="3855286">}</span><span class="op" id="3855287">)</span>&nbsp;<span class="op" id="3855289">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3855292">var</span>&nbsp;<span class="ident" id="3855296">mtime</span>&nbsp;<span class="ident" id="3855302">time</span><span class="op" id="3855306">.</span><span class="ident" id="3855307">Time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3855313">cfg</span><span class="op" id="3855316">.</span><span class="ident" id="3855317">ch</span>&nbsp;<span class="op" id="3855320">=</span>&nbsp;<span class="builtinfunc" id="3855322">make</span><span class="op" id="3855326">(</span><span class="keyword" id="3855327">chan</span>&nbsp;<span class="keyword" id="3855332">struct</span><span class="op" id="3855338">{</span><span class="op" id="3855339">}</span><span class="op" id="3855340">,</span>&nbsp;<span class="num" id="3855342">1</span><span class="op" id="3855343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3855346">if</span>&nbsp;<span class="ident" id="3855349">fi</span><span class="op" id="3855351">,</span>&nbsp;<span class="ident" id="3855353">err</span>&nbsp;<span class="op" id="3855357">:=</span>&nbsp;<span class="ident" id="3855360">os</span><span class="op" id="3855362">.</span><span class="ident" id="3855363">Stat</span><span class="op" id="3855367">(</span><span class="ident" id="3855368">resolvConfPath</span><span class="op" id="3855382">)</span><span class="op" id="3855383">;</span>&nbsp;<span class="ident" id="3855385">err</span>&nbsp;<span class="op" id="3855389">!=</span>&nbsp;<span class="builtintype" id="3855392">nil</span>&nbsp;<span class="op" id="3855396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3855400">cfg</span><span class="op" id="3855403">.</span><span class="ident" id="3855404">dnserr</span>&nbsp;<span class="op" id="3855411">=</span>&nbsp;<span class="ident" id="3855413">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3855418">}</span>&nbsp;<span class="keyword" id="3855420">else</span>&nbsp;<span class="op" id="3855425">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3855429">mtime</span>&nbsp;<span class="op" id="3855435">=</span>&nbsp;<span class="ident" id="3855437">fi</span><span class="op" id="3855439">.</span><span class="ident" id="3855440">ModTime</span><span class="op" id="3855447">(</span><span class="op" id="3855448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3855452">cfg</span><span class="op" id="3855455">.</span><span class="ident" id="3855456">dnsConfig</span><span class="op" id="3855465">,</span>&nbsp;<span class="ident" id="3855467">cfg</span><span class="op" id="3855470">.</span><span class="ident" id="3855471">dnserr</span>&nbsp;<span class="op" id="3855478">=</span>&nbsp;<span class="ident" id="3855480">dnsReadConfig</span><span class="op" id="3855493">(</span><span class="ident" id="3855494">resolvConfPath</span><span class="op" id="3855508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3855511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3855514">go</span>&nbsp;<span class="keyword" id="3855517">func</span><span class="op" id="3855521">(</span><span class="op" id="3855522">)</span>&nbsp;<span class="op" id="3855524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3855528">for</span>&nbsp;<span class="op" id="3855532">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3855537">time</span><span class="op" id="3855541">.</span><span class="ident" id="3855542">Sleep</span><span class="op" id="3855547">(</span><span class="ident" id="3855548">reloadTime</span><span class="op" id="3855558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3855563">select</span>&nbsp;<span class="op" id="3855570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3855575">case</span>&nbsp;<span class="ident" id="3855580">qresp</span>&nbsp;<span class="op" id="3855586">:=</span>&nbsp;<span class="op" id="3855589">&lt;-</span><span class="ident" id="3855591">quit</span><span class="op" id="3855595">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3855601">qresp</span>&nbsp;<span class="op" id="3855607">&lt;-</span>&nbsp;<span class="keyword" id="3855610">struct</span><span class="op" id="3855616">{</span><span class="op" id="3855617">}</span><span class="op" id="3855618">{</span><span class="op" id="3855619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3855625">return</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3855635">case</span>&nbsp;<span class="op" id="3855640">&lt;-</span><span class="ident" id="3855642">cfg</span><span class="op" id="3855645">.</span><span class="ident" id="3855646">ch</span><span class="op" id="3855648">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3855653">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3855659">//&nbsp;In&nbsp;case&nbsp;of&nbsp;error,&nbsp;we&nbsp;keep&nbsp;the&nbsp;previous&nbsp;config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3855711">fi</span><span class="op" id="3855713">,</span>&nbsp;<span class="ident" id="3855715">err</span>&nbsp;<span class="op" id="3855719">:=</span>&nbsp;<span class="ident" id="3855722">os</span><span class="op" id="3855724">.</span><span class="ident" id="3855725">Stat</span><span class="op" id="3855729">(</span><span class="ident" id="3855730">resolvConfPath</span><span class="op" id="3855744">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3855749">if</span>&nbsp;<span class="ident" id="3855752">err</span>&nbsp;<span class="op" id="3855756">!=</span>&nbsp;<span class="builtintype" id="3855759">nil</span>&nbsp;<span class="op" id="3855763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3855769">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3855781">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3855786">//&nbsp;If&nbsp;the&nbsp;resolv.conf&nbsp;mtime&nbsp;didn&#39;t&nbsp;change,&nbsp;do&nbsp;not&nbsp;reload</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3855846">m</span>&nbsp;<span class="op" id="3855848">:=</span>&nbsp;<span class="ident" id="3855851">fi</span><span class="op" id="3855853">.</span><span class="ident" id="3855854">ModTime</span><span class="op" id="3855861">(</span><span class="op" id="3855862">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3855867">if</span>&nbsp;<span class="ident" id="3855870">m</span><span class="op" id="3855871">.</span><span class="ident" id="3855872">Equal</span><span class="op" id="3855877">(</span><span class="ident" id="3855878">mtime</span><span class="op" id="3855883">)</span>&nbsp;<span class="op" id="3855885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3855891">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3855903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3855908">mtime</span>&nbsp;<span class="op" id="3855914">=</span>&nbsp;<span class="ident" id="3855916">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3855921">//&nbsp;In&nbsp;case&nbsp;of&nbsp;error,&nbsp;we&nbsp;keep&nbsp;the&nbsp;previous&nbsp;config</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3855973">ncfg</span><span class="op" id="3855977">,</span>&nbsp;<span class="ident" id="3855979">err</span>&nbsp;<span class="op" id="3855983">:=</span>&nbsp;<span class="ident" id="3855986">dnsReadConfig</span><span class="op" id="3855999">(</span><span class="ident" id="3856000">resolvConfPath</span><span class="op" id="3856014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3856019">if</span>&nbsp;<span class="ident" id="3856022">err</span>&nbsp;<span class="op" id="3856026">!=</span>&nbsp;<span class="builtintype" id="3856029">nil</span>&nbsp;<span class="op" id="3856033">||</span>&nbsp;<span class="builtinfunc" id="3856036">len</span><span class="op" id="3856039">(</span><span class="ident" id="3856040">ncfg</span><span class="op" id="3856044">.</span><span class="ident" id="3856045">servers</span><span class="op" id="3856052">)</span>&nbsp;<span class="op" id="3856054">==</span>&nbsp;<span class="num" id="3856057">0</span>&nbsp;<span class="op" id="3856059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3856065">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3856077">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3856082">cfg</span><span class="op" id="3856085">.</span><span class="ident" id="3856086">mu</span><span class="op" id="3856088">.</span><span class="ident" id="3856089">Lock</span><span class="op" id="3856093">(</span><span class="op" id="3856094">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3856099">cfg</span><span class="op" id="3856102">.</span><span class="ident" id="3856103">dnsConfig</span>&nbsp;<span class="op" id="3856113">=</span>&nbsp;<span class="ident" id="3856115">ncfg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3856123">cfg</span><span class="op" id="3856126">.</span><span class="ident" id="3856127">dnserr</span>&nbsp;<span class="op" id="3856134">=</span>&nbsp;<span class="builtintype" id="3856136">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3856143">cfg</span><span class="op" id="3856146">.</span><span class="ident" id="3856147">mu</span><span class="op" id="3856149">.</span><span class="ident" id="3856150">Unlock</span><span class="op" id="3856156">(</span><span class="op" id="3856157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3856161">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3856164">}</span><span class="op" id="3856165">(</span><span class="op" id="3856166">)</span><br>
<span class="lineno">270</span><span class="op" id="3856168">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3856171">func</span>&nbsp;<span class="ident" id="3856176">lookup</span><span class="op" id="3856182">(</span><span class="ident" id="3856183">name</span>&nbsp;<span class="builtintype" id="3856188">string</span><span class="op" id="3856194">,</span>&nbsp;<span class="ident" id="3856196">qtype</span>&nbsp;<span class="builtintype" id="3856202">uint16</span><span class="op" id="3856208">)</span>&nbsp;<span class="op" id="3856210">(</span><span class="ident" id="3856211">cname</span>&nbsp;<span class="builtintype" id="3856217">string</span><span class="op" id="3856223">,</span>&nbsp;<span class="ident" id="3856225">addrs</span>&nbsp;<span class="op" id="3856231">[</span><span class="op" id="3856232">]</span><span class="ident" id="3856233">dnsRR</span><span class="op" id="3856238">,</span>&nbsp;<span class="ident" id="3856240">err</span>&nbsp;<span class="builtintype" id="3856244">error</span><span class="op" id="3856249">)</span>&nbsp;<span class="op" id="3856251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3856254">if</span>&nbsp;<span class="op" id="3856257">!</span><span class="ident" id="3856258">isDomainName</span><span class="op" id="3856270">(</span><span class="ident" id="3856271">name</span><span class="op" id="3856275">)</span>&nbsp;<span class="op" id="3856277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3856281">return</span>&nbsp;<span class="ident" id="3856288">name</span><span class="op" id="3856292">,</span>&nbsp;<span class="builtintype" id="3856294">nil</span><span class="op" id="3856297">,</span>&nbsp;<span class="op" id="3856299">&amp;</span><span class="ident" id="3856300">DNSError</span><span class="op" id="3856308">{</span><span class="ident" id="3856309">Err</span><span class="op" id="3856312">:</span>&nbsp;<span class="string" id="3856314">&#34;invalid&nbsp;domain&nbsp;name&#34;</span><span class="op" id="3856335">,</span>&nbsp;<span class="ident" id="3856337">Name</span><span class="op" id="3856341">:</span>&nbsp;<span class="ident" id="3856343">name</span><span class="op" id="3856347">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3856350">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3856353">onceLoadConfig</span><span class="op" id="3856367">.</span><span class="ident" id="3856368">Do</span><span class="op" id="3856370">(</span><span class="ident" id="3856371">loadDefaultConfig</span><span class="op" id="3856388">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3856392">select</span>&nbsp;<span class="op" id="3856399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3856402">case</span>&nbsp;<span class="ident" id="3856407">cfg</span><span class="op" id="3856410">.</span><span class="ident" id="3856411">ch</span>&nbsp;<span class="op" id="3856414">&lt;-</span>&nbsp;<span class="keyword" id="3856417">struct</span><span class="op" id="3856423">{</span><span class="op" id="3856424">}</span><span class="op" id="3856425">{</span><span class="op" id="3856426">}</span><span class="op" id="3856427">:</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3856430">default</span><span class="op" id="3856437">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3856440">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3856444">cfg</span><span class="op" id="3856447">.</span><span class="ident" id="3856448">mu</span><span class="op" id="3856450">.</span><span class="ident" id="3856451">RLock</span><span class="op" id="3856456">(</span><span class="op" id="3856457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3856460">defer</span>&nbsp;<span class="ident" id="3856466">cfg</span><span class="op" id="3856469">.</span><span class="ident" id="3856470">mu</span><span class="op" id="3856472">.</span><span class="ident" id="3856473">RUnlock</span><span class="op" id="3856480">(</span><span class="op" id="3856481">)</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3856485">if</span>&nbsp;<span class="ident" id="3856488">cfg</span><span class="op" id="3856491">.</span><span class="ident" id="3856492">dnserr</span>&nbsp;<span class="op" id="3856499">!=</span>&nbsp;<span class="builtintype" id="3856502">nil</span>&nbsp;<span class="op" id="3856506">||</span>&nbsp;<span class="ident" id="3856509">cfg</span><span class="op" id="3856512">.</span><span class="ident" id="3856513">dnsConfig</span>&nbsp;<span class="op" id="3856523">==</span>&nbsp;<span class="builtintype" id="3856526">nil</span>&nbsp;<span class="op" id="3856530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3856534">err</span>&nbsp;<span class="op" id="3856538">=</span>&nbsp;<span class="ident" id="3856540">cfg</span><span class="op" id="3856543">.</span><span class="ident" id="3856544">dnserr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3856553">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3856561">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3856564">//&nbsp;If&nbsp;name&nbsp;is&nbsp;rooted&nbsp;(trailing&nbsp;dot)&nbsp;or&nbsp;has&nbsp;enough&nbsp;dots,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3856621">//&nbsp;try&nbsp;it&nbsp;by&nbsp;itself&nbsp;first.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3856649">rooted</span>&nbsp;<span class="op" id="3856656">:=</span>&nbsp;<span class="builtinfunc" id="3856659">len</span><span class="op" id="3856662">(</span><span class="ident" id="3856663">name</span><span class="op" id="3856667">)</span>&nbsp;<span class="op" id="3856669">&gt;</span>&nbsp;<span class="num" id="3856671">0</span>&nbsp;<span class="op" id="3856673">&amp;&amp;</span>&nbsp;<span class="ident" id="3856676">name</span><span class="op" id="3856680">[</span><span class="builtinfunc" id="3856681">len</span><span class="op" id="3856684">(</span><span class="ident" id="3856685">name</span><span class="op" id="3856689">)</span><span class="op" id="3856690">-</span><span class="num" id="3856691">1</span><span class="op" id="3856692">]</span>&nbsp;<span class="op" id="3856694">==</span>&nbsp;<span class="string" id="3856697">&#39;.&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3856702">if</span>&nbsp;<span class="ident" id="3856705">rooted</span>&nbsp;<span class="op" id="3856712">||</span>&nbsp;<span class="ident" id="3856715">count</span><span class="op" id="3856720">(</span><span class="ident" id="3856721">name</span><span class="op" id="3856725">,</span>&nbsp;<span class="string" id="3856727">&#39;.&#39;</span><span class="op" id="3856730">)</span>&nbsp;<span class="op" id="3856732">&gt;=</span>&nbsp;<span class="ident" id="3856735">cfg</span><span class="op" id="3856738">.</span><span class="ident" id="3856739">dnsConfig</span><span class="op" id="3856748">.</span><span class="ident" id="3856749">ndots</span>&nbsp;<span class="op" id="3856755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3856759">rname</span>&nbsp;<span class="op" id="3856765">:=</span>&nbsp;<span class="ident" id="3856768">name</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3856775">if</span>&nbsp;<span class="op" id="3856778">!</span><span class="ident" id="3856779">rooted</span>&nbsp;<span class="op" id="3856786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3856791">rname</span>&nbsp;<span class="op" id="3856797">+=</span>&nbsp;<span class="string" id="3856800">&#34;.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3856806">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3856810">//&nbsp;Can&nbsp;try&nbsp;as&nbsp;ordinary&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3856841">cname</span><span class="op" id="3856846">,</span>&nbsp;<span class="ident" id="3856848">addrs</span><span class="op" id="3856853">,</span>&nbsp;<span class="ident" id="3856855">err</span>&nbsp;<span class="op" id="3856859">=</span>&nbsp;<span class="ident" id="3856861">tryOneName</span><span class="op" id="3856871">(</span><span class="ident" id="3856872">cfg</span><span class="op" id="3856875">.</span><span class="ident" id="3856876">dnsConfig</span><span class="op" id="3856885">,</span>&nbsp;<span class="ident" id="3856887">rname</span><span class="op" id="3856892">,</span>&nbsp;<span class="ident" id="3856894">qtype</span><span class="op" id="3856899">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3856903">if</span>&nbsp;<span class="ident" id="3856906">rooted</span>&nbsp;<span class="op" id="3856913">||</span>&nbsp;<span class="ident" id="3856916">err</span>&nbsp;<span class="op" id="3856920">==</span>&nbsp;<span class="builtintype" id="3856923">nil</span>&nbsp;<span class="op" id="3856927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3856932">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3856941">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3856944">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3856948">//&nbsp;Otherwise,&nbsp;try&nbsp;suffixes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3856977">for</span>&nbsp;<span class="ident" id="3856981">i</span>&nbsp;<span class="op" id="3856983">:=</span>&nbsp;<span class="num" id="3856986">0</span><span class="op" id="3856987">;</span>&nbsp;<span class="ident" id="3856989">i</span>&nbsp;<span class="op" id="3856991">&lt;</span>&nbsp;<span class="builtinfunc" id="3856993">len</span><span class="op" id="3856996">(</span><span class="ident" id="3856997">cfg</span><span class="op" id="3857000">.</span><span class="ident" id="3857001">dnsConfig</span><span class="op" id="3857010">.</span><span class="ident" id="3857011">search</span><span class="op" id="3857017">)</span><span class="op" id="3857018">;</span>&nbsp;<span class="ident" id="3857020">i</span><span class="op" id="3857021">++</span>&nbsp;<span class="op" id="3857024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3857028">rname</span>&nbsp;<span class="op" id="3857034">:=</span>&nbsp;<span class="ident" id="3857037">name</span>&nbsp;<span class="op" id="3857042">+</span>&nbsp;<span class="string" id="3857044">&#34;.&#34;</span>&nbsp;<span class="op" id="3857048">+</span>&nbsp;<span class="ident" id="3857050">cfg</span><span class="op" id="3857053">.</span><span class="ident" id="3857054">dnsConfig</span><span class="op" id="3857063">.</span><span class="ident" id="3857064">search</span><span class="op" id="3857070">[</span><span class="ident" id="3857071">i</span><span class="op" id="3857072">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3857076">if</span>&nbsp;<span class="ident" id="3857079">rname</span><span class="op" id="3857084">[</span><span class="builtinfunc" id="3857085">len</span><span class="op" id="3857088">(</span><span class="ident" id="3857089">rname</span><span class="op" id="3857094">)</span><span class="op" id="3857095">-</span><span class="num" id="3857096">1</span><span class="op" id="3857097">]</span>&nbsp;<span class="op" id="3857099">!=</span>&nbsp;<span class="string" id="3857102">&#39;.&#39;</span>&nbsp;<span class="op" id="3857106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3857111">rname</span>&nbsp;<span class="op" id="3857117">+=</span>&nbsp;<span class="string" id="3857120">&#34;.&#34;</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3857126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3857130">cname</span><span class="op" id="3857135">,</span>&nbsp;<span class="ident" id="3857137">addrs</span><span class="op" id="3857142">,</span>&nbsp;<span class="ident" id="3857144">err</span>&nbsp;<span class="op" id="3857148">=</span>&nbsp;<span class="ident" id="3857150">tryOneName</span><span class="op" id="3857160">(</span><span class="ident" id="3857161">cfg</span><span class="op" id="3857164">.</span><span class="ident" id="3857165">dnsConfig</span><span class="op" id="3857174">,</span>&nbsp;<span class="ident" id="3857176">rname</span><span class="op" id="3857181">,</span>&nbsp;<span class="ident" id="3857183">qtype</span><span class="op" id="3857188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3857192">if</span>&nbsp;<span class="ident" id="3857195">err</span>&nbsp;<span class="op" id="3857199">==</span>&nbsp;<span class="builtintype" id="3857202">nil</span>&nbsp;<span class="op" id="3857206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3857211">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3857220">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3857223">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3857227">//&nbsp;Last&nbsp;ditch&nbsp;effort:&nbsp;try&nbsp;unsuffixed&nbsp;only&nbsp;if&nbsp;we&nbsp;haven&#39;t&nbsp;already,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3857293">//&nbsp;that&nbsp;is,&nbsp;name&nbsp;is&nbsp;not&nbsp;rooted&nbsp;and&nbsp;has&nbsp;less&nbsp;than&nbsp;ndots&nbsp;dots.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3857355">if</span>&nbsp;<span class="ident" id="3857358">count</span><span class="op" id="3857363">(</span><span class="ident" id="3857364">name</span><span class="op" id="3857368">,</span>&nbsp;<span class="string" id="3857370">&#39;.&#39;</span><span class="op" id="3857373">)</span>&nbsp;<span class="op" id="3857375">&lt;</span>&nbsp;<span class="ident" id="3857377">cfg</span><span class="op" id="3857380">.</span><span class="ident" id="3857381">dnsConfig</span><span class="op" id="3857390">.</span><span class="ident" id="3857391">ndots</span>&nbsp;<span class="op" id="3857397">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3857401">cname</span><span class="op" id="3857406">,</span>&nbsp;<span class="ident" id="3857408">addrs</span><span class="op" id="3857413">,</span>&nbsp;<span class="ident" id="3857415">err</span>&nbsp;<span class="op" id="3857419">=</span>&nbsp;<span class="ident" id="3857421">tryOneName</span><span class="op" id="3857431">(</span><span class="ident" id="3857432">cfg</span><span class="op" id="3857435">.</span><span class="ident" id="3857436">dnsConfig</span><span class="op" id="3857445">,</span>&nbsp;<span class="ident" id="3857447">name</span><span class="op" id="3857451">+</span><span class="string" id="3857452">&#34;.&#34;</span><span class="op" id="3857455">,</span>&nbsp;<span class="ident" id="3857457">qtype</span><span class="op" id="3857462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3857466">if</span>&nbsp;<span class="ident" id="3857469">err</span>&nbsp;<span class="op" id="3857473">==</span>&nbsp;<span class="builtintype" id="3857476">nil</span>&nbsp;<span class="op" id="3857480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3857485">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3857494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3857497">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3857501">if</span>&nbsp;<span class="ident" id="3857504">e</span><span class="op" id="3857505">,</span>&nbsp;<span class="ident" id="3857507">ok</span>&nbsp;<span class="op" id="3857510">:=</span>&nbsp;<span class="ident" id="3857513">err</span><span class="op" id="3857516">.</span><span class="op" id="3857517">(</span><span class="op" id="3857518">*</span><span class="ident" id="3857519">DNSError</span><span class="op" id="3857527">)</span><span class="op" id="3857528">;</span>&nbsp;<span class="ident" id="3857530">ok</span>&nbsp;<span class="op" id="3857533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3857537">//&nbsp;Show&nbsp;original&nbsp;name&nbsp;passed&nbsp;to&nbsp;lookup,&nbsp;not&nbsp;suffixed&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3857597">//&nbsp;In&nbsp;general&nbsp;we&nbsp;might&nbsp;have&nbsp;tried&nbsp;many&nbsp;suffixes;&nbsp;showing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3857656">//&nbsp;just&nbsp;one&nbsp;is&nbsp;misleading.&nbsp;See&nbsp;also&nbsp;golang.org/issue/6324.</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3857717">e</span><span class="op" id="3857718">.</span><span class="ident" id="3857719">Name</span>&nbsp;<span class="op" id="3857724">=</span>&nbsp;<span class="ident" id="3857726">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3857732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3857735">return</span><br>
<span class="lineno"></span><span class="op" id="3857742">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span><span class="comment" id="3857745">//&nbsp;goLookupHost&nbsp;is&nbsp;the&nbsp;native&nbsp;Go&nbsp;implementation&nbsp;of&nbsp;LookupHost.</span><br>
<span class="lineno"></span><span class="comment" id="3857808">//&nbsp;Used&nbsp;only&nbsp;if&nbsp;cgoLookupHost&nbsp;refuses&nbsp;to&nbsp;handle&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span><span class="comment" id="3857868">//&nbsp;(that&nbsp;is,&nbsp;only&nbsp;if&nbsp;cgoLookupHost&nbsp;is&nbsp;the&nbsp;stub&nbsp;in&nbsp;cgo_stub.go).</span><br>
<span class="lineno"></span><span class="comment" id="3857932">//&nbsp;Normally&nbsp;we&nbsp;let&nbsp;cgo&nbsp;use&nbsp;the&nbsp;C&nbsp;library&nbsp;resolver&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3857993">//&nbsp;depending&nbsp;on&nbsp;our&nbsp;lookup&nbsp;code,&nbsp;so&nbsp;that&nbsp;Go&nbsp;and&nbsp;C&nbsp;get&nbsp;the&nbsp;same</span><br>
<span class="lineno">340</span><span class="comment" id="3858056">//&nbsp;answers.</span><br>
<span class="lineno"></span><span class="keyword" id="3858068">func</span>&nbsp;<span class="ident" id="3858073">goLookupHost</span><span class="op" id="3858085">(</span><span class="ident" id="3858086">name</span>&nbsp;<span class="builtintype" id="3858091">string</span><span class="op" id="3858097">)</span>&nbsp;<span class="op" id="3858099">(</span><span class="ident" id="3858100">addrs</span>&nbsp;<span class="op" id="3858106">[</span><span class="op" id="3858107">]</span><span class="builtintype" id="3858108">string</span><span class="op" id="3858114">,</span>&nbsp;<span class="ident" id="3858116">err</span>&nbsp;<span class="builtintype" id="3858120">error</span><span class="op" id="3858125">)</span>&nbsp;<span class="op" id="3858127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3858130">//&nbsp;Use&nbsp;entries&nbsp;from&nbsp;/etc/hosts&nbsp;if&nbsp;they&nbsp;match.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3858177">addrs</span>&nbsp;<span class="op" id="3858183">=</span>&nbsp;<span class="ident" id="3858185">lookupStaticHost</span><span class="op" id="3858201">(</span><span class="ident" id="3858202">name</span><span class="op" id="3858206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3858209">if</span>&nbsp;<span class="builtinfunc" id="3858212">len</span><span class="op" id="3858215">(</span><span class="ident" id="3858216">addrs</span><span class="op" id="3858221">)</span>&nbsp;<span class="op" id="3858223">&gt;</span>&nbsp;<span class="num" id="3858225">0</span>&nbsp;<span class="op" id="3858227">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3858231">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3858239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3858242">ips</span><span class="op" id="3858245">,</span>&nbsp;<span class="ident" id="3858247">err</span>&nbsp;<span class="op" id="3858251">:=</span>&nbsp;<span class="ident" id="3858254">goLookupIP</span><span class="op" id="3858264">(</span><span class="ident" id="3858265">name</span><span class="op" id="3858269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3858272">if</span>&nbsp;<span class="ident" id="3858275">err</span>&nbsp;<span class="op" id="3858279">!=</span>&nbsp;<span class="builtintype" id="3858282">nil</span>&nbsp;<span class="op" id="3858286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3858290">return</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3858298">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3858301">addrs</span>&nbsp;<span class="op" id="3858307">=</span>&nbsp;<span class="builtinfunc" id="3858309">make</span><span class="op" id="3858313">(</span><span class="op" id="3858314">[</span><span class="op" id="3858315">]</span><span class="builtintype" id="3858316">string</span><span class="op" id="3858322">,</span>&nbsp;<span class="num" id="3858324">0</span><span class="op" id="3858325">,</span>&nbsp;<span class="builtinfunc" id="3858327">len</span><span class="op" id="3858330">(</span><span class="ident" id="3858331">ips</span><span class="op" id="3858334">)</span><span class="op" id="3858335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3858338">for</span>&nbsp;<span class="ident" id="3858342">_</span><span class="op" id="3858343">,</span>&nbsp;<span class="ident" id="3858345">ip</span>&nbsp;<span class="op" id="3858348">:=</span>&nbsp;<span class="keyword" id="3858351">range</span>&nbsp;<span class="ident" id="3858357">ips</span>&nbsp;<span class="op" id="3858361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3858365">addrs</span>&nbsp;<span class="op" id="3858371">=</span>&nbsp;<span class="builtinfunc" id="3858373">append</span><span class="op" id="3858379">(</span><span class="ident" id="3858380">addrs</span><span class="op" id="3858385">,</span>&nbsp;<span class="ident" id="3858387">ip</span><span class="op" id="3858389">.</span><span class="ident" id="3858390">String</span><span class="op" id="3858396">(</span><span class="op" id="3858397">)</span><span class="op" id="3858398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3858401">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3858404">return</span><br>
<span class="lineno"></span><span class="op" id="3858411">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3858414">//&nbsp;goLookupIP&nbsp;is&nbsp;the&nbsp;native&nbsp;Go&nbsp;implementation&nbsp;of&nbsp;LookupIP.</span><br>
<span class="lineno"></span><span class="comment" id="3858473">//&nbsp;Used&nbsp;only&nbsp;if&nbsp;cgoLookupIP&nbsp;refuses&nbsp;to&nbsp;handle&nbsp;the&nbsp;request</span><br>
<span class="lineno">360</span><span class="comment" id="3858531">//&nbsp;(that&nbsp;is,&nbsp;only&nbsp;if&nbsp;cgoLookupIP&nbsp;is&nbsp;the&nbsp;stub&nbsp;in&nbsp;cgo_stub.go).</span><br>
<span class="lineno"></span><span class="comment" id="3858593">//&nbsp;Normally&nbsp;we&nbsp;let&nbsp;cgo&nbsp;use&nbsp;the&nbsp;C&nbsp;library&nbsp;resolver&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3858654">//&nbsp;depending&nbsp;on&nbsp;our&nbsp;lookup&nbsp;code,&nbsp;so&nbsp;that&nbsp;Go&nbsp;and&nbsp;C&nbsp;get&nbsp;the&nbsp;same</span><br>
<span class="lineno"></span><span class="comment" id="3858717">//&nbsp;answers.</span><br>
<span class="lineno"></span><span class="keyword" id="3858729">func</span>&nbsp;<span class="ident" id="3858734">goLookupIP</span><span class="op" id="3858744">(</span><span class="ident" id="3858745">name</span>&nbsp;<span class="builtintype" id="3858750">string</span><span class="op" id="3858756">)</span>&nbsp;<span class="op" id="3858758">(</span><span class="ident" id="3858759">addrs</span>&nbsp;<span class="op" id="3858765">[</span><span class="op" id="3858766">]</span><span class="ident" id="3858767">IP</span><span class="op" id="3858769">,</span>&nbsp;<span class="ident" id="3858771">err</span>&nbsp;<span class="builtintype" id="3858775">error</span><span class="op" id="3858780">)</span>&nbsp;<span class="op" id="3858782">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3858785">//&nbsp;Use&nbsp;entries&nbsp;from&nbsp;/etc/hosts&nbsp;if&nbsp;possible.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3858830">haddrs</span>&nbsp;<span class="op" id="3858837">:=</span>&nbsp;<span class="ident" id="3858840">lookupStaticHost</span><span class="op" id="3858856">(</span><span class="ident" id="3858857">name</span><span class="op" id="3858861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3858864">if</span>&nbsp;<span class="builtinfunc" id="3858867">len</span><span class="op" id="3858870">(</span><span class="ident" id="3858871">haddrs</span><span class="op" id="3858877">)</span>&nbsp;<span class="op" id="3858879">&gt;</span>&nbsp;<span class="num" id="3858881">0</span>&nbsp;<span class="op" id="3858883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3858887">for</span>&nbsp;<span class="ident" id="3858891">_</span><span class="op" id="3858892">,</span>&nbsp;<span class="ident" id="3858894">haddr</span>&nbsp;<span class="op" id="3858900">:=</span>&nbsp;<span class="keyword" id="3858903">range</span>&nbsp;<span class="ident" id="3858909">haddrs</span>&nbsp;<span class="op" id="3858916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3858921">if</span>&nbsp;<span class="ident" id="3858924">ip</span>&nbsp;<span class="op" id="3858927">:=</span>&nbsp;<span class="ident" id="3858930">ParseIP</span><span class="op" id="3858937">(</span><span class="ident" id="3858938">haddr</span><span class="op" id="3858943">)</span><span class="op" id="3858944">;</span>&nbsp;<span class="ident" id="3858946">ip</span>&nbsp;<span class="op" id="3858949">!=</span>&nbsp;<span class="builtintype" id="3858952">nil</span>&nbsp;<span class="op" id="3858956">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3858962">addrs</span>&nbsp;<span class="op" id="3858968">=</span>&nbsp;<span class="builtinfunc" id="3858970">append</span><span class="op" id="3858976">(</span><span class="ident" id="3858977">addrs</span><span class="op" id="3858982">,</span>&nbsp;<span class="ident" id="3858984">ip</span><span class="op" id="3858986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3858991">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3858995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3858999">if</span>&nbsp;<span class="builtinfunc" id="3859002">len</span><span class="op" id="3859005">(</span><span class="ident" id="3859006">addrs</span><span class="op" id="3859011">)</span>&nbsp;<span class="op" id="3859013">&gt;</span>&nbsp;<span class="num" id="3859015">0</span>&nbsp;<span class="op" id="3859017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3859022">return</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3859031">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3859034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3859037">type</span>&nbsp;<span class="ident" id="3859042">racer</span>&nbsp;<span class="keyword" id="3859048">struct</span>&nbsp;<span class="op" id="3859055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3859059">qtype</span>&nbsp;<span class="builtintype" id="3859065">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3859074">rrs</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3859080">[</span><span class="op" id="3859081">]</span><span class="ident" id="3859082">dnsRR</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3859090">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3859097">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3859100">lane</span>&nbsp;<span class="op" id="3859105">:=</span>&nbsp;<span class="builtinfunc" id="3859108">make</span><span class="op" id="3859112">(</span><span class="keyword" id="3859113">chan</span>&nbsp;<span class="ident" id="3859118">racer</span><span class="op" id="3859123">,</span>&nbsp;<span class="num" id="3859125">1</span><span class="op" id="3859126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3859129">qtypes</span>&nbsp;<span class="op" id="3859136">:=</span>&nbsp;<span class="op" id="3859139">[</span><span class="op" id="3859140">...</span><span class="op" id="3859143">]</span><span class="builtintype" id="3859144">uint16</span><span class="op" id="3859150">{</span><span class="ident" id="3859151">dnsTypeA</span><span class="op" id="3859159">,</span>&nbsp;<span class="ident" id="3859161">dnsTypeAAAA</span><span class="op" id="3859172">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3859175">for</span>&nbsp;<span class="ident" id="3859179">_</span><span class="op" id="3859180">,</span>&nbsp;<span class="ident" id="3859182">qtype</span>&nbsp;<span class="op" id="3859188">:=</span>&nbsp;<span class="keyword" id="3859191">range</span>&nbsp;<span class="ident" id="3859197">qtypes</span>&nbsp;<span class="op" id="3859204">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3859208">go</span>&nbsp;<span class="keyword" id="3859211">func</span><span class="op" id="3859215">(</span><span class="ident" id="3859216">qtype</span>&nbsp;<span class="builtintype" id="3859222">uint16</span><span class="op" id="3859228">)</span>&nbsp;<span class="op" id="3859230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3859235">_</span><span class="op" id="3859236">,</span>&nbsp;<span class="ident" id="3859238">rrs</span><span class="op" id="3859241">,</span>&nbsp;<span class="ident" id="3859243">err</span>&nbsp;<span class="op" id="3859247">:=</span>&nbsp;<span class="ident" id="3859250">lookup</span><span class="op" id="3859256">(</span><span class="ident" id="3859257">name</span><span class="op" id="3859261">,</span>&nbsp;<span class="ident" id="3859263">qtype</span><span class="op" id="3859268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3859273">lane</span>&nbsp;<span class="op" id="3859278">&lt;-</span>&nbsp;<span class="ident" id="3859281">racer</span><span class="op" id="3859286">{</span><span class="ident" id="3859287">qtype</span><span class="op" id="3859292">,</span>&nbsp;<span class="ident" id="3859294">rrs</span><span class="op" id="3859297">,</span>&nbsp;<span class="ident" id="3859299">err</span><span class="op" id="3859302">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3859306">}</span><span class="op" id="3859307">(</span><span class="ident" id="3859308">qtype</span><span class="op" id="3859313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3859316">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3859319">var</span>&nbsp;<span class="ident" id="3859323">lastErr</span>&nbsp;<span class="builtintype" id="3859331">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3859338">for</span>&nbsp;<span class="keyword" id="3859342">range</span>&nbsp;<span class="ident" id="3859348">qtypes</span>&nbsp;<span class="op" id="3859355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3859359">racer</span>&nbsp;<span class="op" id="3859365">:=</span>&nbsp;<span class="op" id="3859368">&lt;-</span><span class="ident" id="3859370">lane</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3859377">if</span>&nbsp;<span class="ident" id="3859380">racer</span><span class="op" id="3859385">.</span><span class="builtintype" id="3859386">error</span>&nbsp;<span class="op" id="3859392">!=</span>&nbsp;<span class="builtintype" id="3859395">nil</span>&nbsp;<span class="op" id="3859399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3859404">lastErr</span>&nbsp;<span class="op" id="3859412">=</span>&nbsp;<span class="ident" id="3859414">racer</span><span class="op" id="3859419">.</span><span class="builtintype" id="3859420">error</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3859429">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3859440">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3859444">switch</span>&nbsp;<span class="ident" id="3859451">racer</span><span class="op" id="3859456">.</span><span class="ident" id="3859457">qtype</span>&nbsp;<span class="op" id="3859463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3859467">case</span>&nbsp;<span class="ident" id="3859472">dnsTypeA</span><span class="op" id="3859480">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3859485">addrs</span>&nbsp;<span class="op" id="3859491">=</span>&nbsp;<span class="builtinfunc" id="3859493">append</span><span class="op" id="3859499">(</span><span class="ident" id="3859500">addrs</span><span class="op" id="3859505">,</span>&nbsp;<span class="ident" id="3859507">convertRR_A</span><span class="op" id="3859518">(</span><span class="ident" id="3859519">racer</span><span class="op" id="3859524">.</span><span class="ident" id="3859525">rrs</span><span class="op" id="3859528">)</span><span class="op" id="3859529">...</span><span class="op" id="3859532">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3859536">case</span>&nbsp;<span class="ident" id="3859541">dnsTypeAAAA</span><span class="op" id="3859552">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3859557">addrs</span>&nbsp;<span class="op" id="3859563">=</span>&nbsp;<span class="builtinfunc" id="3859565">append</span><span class="op" id="3859571">(</span><span class="ident" id="3859572">addrs</span><span class="op" id="3859577">,</span>&nbsp;<span class="ident" id="3859579">convertRR_AAAA</span><span class="op" id="3859593">(</span><span class="ident" id="3859594">racer</span><span class="op" id="3859599">.</span><span class="ident" id="3859600">rrs</span><span class="op" id="3859603">)</span><span class="op" id="3859604">...</span><span class="op" id="3859607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3859611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3859614">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3859617">if</span>&nbsp;<span class="builtinfunc" id="3859620">len</span><span class="op" id="3859623">(</span><span class="ident" id="3859624">addrs</span><span class="op" id="3859629">)</span>&nbsp;<span class="op" id="3859631">==</span>&nbsp;<span class="num" id="3859634">0</span>&nbsp;<span class="op" id="3859636">&amp;&amp;</span>&nbsp;<span class="ident" id="3859639">lastErr</span>&nbsp;<span class="op" id="3859647">!=</span>&nbsp;<span class="builtintype" id="3859650">nil</span>&nbsp;<span class="op" id="3859654">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3859658">return</span>&nbsp;<span class="builtintype" id="3859665">nil</span><span class="op" id="3859668">,</span>&nbsp;<span class="ident" id="3859670">lastErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3859679">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3859682">return</span>&nbsp;<span class="ident" id="3859689">addrs</span><span class="op" id="3859694">,</span>&nbsp;<span class="builtintype" id="3859696">nil</span><br>
<span class="lineno"></span><span class="op" id="3859700">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="comment" id="3859703">//&nbsp;goLookupCNAME&nbsp;is&nbsp;the&nbsp;native&nbsp;Go&nbsp;implementation&nbsp;of&nbsp;LookupCNAME.</span><br>
<span class="lineno"></span><span class="comment" id="3859768">//&nbsp;Used&nbsp;only&nbsp;if&nbsp;cgoLookupCNAME&nbsp;refuses&nbsp;to&nbsp;handle&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span><span class="comment" id="3859829">//&nbsp;(that&nbsp;is,&nbsp;only&nbsp;if&nbsp;cgoLookupCNAME&nbsp;is&nbsp;the&nbsp;stub&nbsp;in&nbsp;cgo_stub.go).</span><br>
<span class="lineno"></span><span class="comment" id="3859894">//&nbsp;Normally&nbsp;we&nbsp;let&nbsp;cgo&nbsp;use&nbsp;the&nbsp;C&nbsp;library&nbsp;resolver&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3859955">//&nbsp;depending&nbsp;on&nbsp;our&nbsp;lookup&nbsp;code,&nbsp;so&nbsp;that&nbsp;Go&nbsp;and&nbsp;C&nbsp;get&nbsp;the&nbsp;same</span><br>
<span class="lineno">415</span><span class="comment" id="3860018">//&nbsp;answers.</span><br>
<span class="lineno"></span><span class="keyword" id="3860030">func</span>&nbsp;<span class="ident" id="3860035">goLookupCNAME</span><span class="op" id="3860048">(</span><span class="ident" id="3860049">name</span>&nbsp;<span class="builtintype" id="3860054">string</span><span class="op" id="3860060">)</span>&nbsp;<span class="op" id="3860062">(</span><span class="ident" id="3860063">cname</span>&nbsp;<span class="builtintype" id="3860069">string</span><span class="op" id="3860075">,</span>&nbsp;<span class="ident" id="3860077">err</span>&nbsp;<span class="builtintype" id="3860081">error</span><span class="op" id="3860086">)</span>&nbsp;<span class="op" id="3860088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3860091">_</span><span class="op" id="3860092">,</span>&nbsp;<span class="ident" id="3860094">rr</span><span class="op" id="3860096">,</span>&nbsp;<span class="ident" id="3860098">err</span>&nbsp;<span class="op" id="3860102">:=</span>&nbsp;<span class="ident" id="3860105">lookup</span><span class="op" id="3860111">(</span><span class="ident" id="3860112">name</span><span class="op" id="3860116">,</span>&nbsp;<span class="ident" id="3860118">dnsTypeCNAME</span><span class="op" id="3860130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3860133">if</span>&nbsp;<span class="ident" id="3860136">err</span>&nbsp;<span class="op" id="3860140">!=</span>&nbsp;<span class="builtintype" id="3860143">nil</span>&nbsp;<span class="op" id="3860147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3860151">return</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3860159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3860162">cname</span>&nbsp;<span class="op" id="3860168">=</span>&nbsp;<span class="ident" id="3860170">rr</span><span class="op" id="3860172">[</span><span class="num" id="3860173">0</span><span class="op" id="3860174">]</span><span class="op" id="3860175">.</span><span class="op" id="3860176">(</span><span class="op" id="3860177">*</span><span class="ident" id="3860178">dnsRR_CNAME</span><span class="op" id="3860189">)</span><span class="op" id="3860190">.</span><span class="ident" id="3860191">Cname</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3860198">return</span><br>
<span class="lineno"></span><span class="op" id="3860205">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
