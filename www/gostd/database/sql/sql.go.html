<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>database/sql</h2>
<ul>
<li><a href="/gostd/database/sql/convert.go.html">convert.go</a></li>
<li><a href="/gostd/database/sql/convert_test.go.html">convert_test.go</a></li>
<li><a href="/gostd/database/sql/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/database/sql/fakedb_test.go.html">fakedb_test.go</a></li>
<li><a href="/gostd/database/sql/sql.go.html" class="current">sql.go</a></li>
<li><a href="/gostd/database/sql/sql_test.go.html">sql_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6309856">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6309911">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6309965">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6310016">//&nbsp;Package&nbsp;sql&nbsp;provides&nbsp;a&nbsp;generic&nbsp;interface&nbsp;around&nbsp;SQL&nbsp;(or&nbsp;SQL-like)</span><br>
<span class="lineno"></span><span class="comment" id="6310085">//&nbsp;databases.</span><br>
<span class="lineno"></span><span class="comment" id="6310099">//</span><br>
<span class="lineno"></span><span class="comment" id="6310102">//&nbsp;The&nbsp;sql&nbsp;package&nbsp;must&nbsp;be&nbsp;used&nbsp;in&nbsp;conjunction&nbsp;with&nbsp;a&nbsp;database&nbsp;driver.</span><br>
<span class="lineno"></span><span class="comment" id="6310173">//&nbsp;See&nbsp;http://golang.org/s/sqldrivers&nbsp;for&nbsp;a&nbsp;list&nbsp;of&nbsp;drivers.</span><br>
<span class="lineno">10</span><span class="comment" id="6310234">//</span><br>
<span class="lineno"></span><span class="comment" id="6310237">//&nbsp;For&nbsp;more&nbsp;usage&nbsp;examples,&nbsp;see&nbsp;the&nbsp;wiki&nbsp;page&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="6310286">//&nbsp;http://golang.org/s/sqlwiki.</span><br>
<span class="lineno"></span><span class="keyword" id="6310318">package</span>&nbsp;<span class="ident" id="6310326">sql</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="6310331">import</span>&nbsp;<span class="op" id="6310338">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6310341">&#34;database/sql/driver&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6310364">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6310374">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6310381">&#34;io&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6310387">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6310398">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6310406">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="6310413">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="6310416">var</span>&nbsp;<span class="ident" id="6310420">drivers</span>&nbsp;<span class="op" id="6310428">=</span>&nbsp;<span class="builtinfunc" id="6310430">make</span><span class="op" id="6310434">(</span><span class="keyword" id="6310435">map</span><span class="op" id="6310438">[</span><span class="builtintype" id="6310439">string</span><span class="op" id="6310445">]</span><span class="ident" id="6310446">driver</span><span class="op" id="6310452">.</span><span class="ident" id="6310453">Driver</span><span class="op" id="6310459">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6310462">//&nbsp;Register&nbsp;makes&nbsp;a&nbsp;database&nbsp;driver&nbsp;available&nbsp;by&nbsp;the&nbsp;provided&nbsp;name.</span><br>
<span class="lineno"></span><span class="comment" id="6310530">//&nbsp;If&nbsp;Register&nbsp;is&nbsp;called&nbsp;twice&nbsp;with&nbsp;the&nbsp;same&nbsp;name&nbsp;or&nbsp;if&nbsp;driver&nbsp;is&nbsp;nil,</span><br>
<span class="lineno"></span><span class="comment" id="6310601">//&nbsp;it&nbsp;panics.</span><br>
<span class="lineno">30</span><span class="keyword" id="6310615">func</span>&nbsp;<span class="ident" id="6310620">Register</span><span class="op" id="6310628">(</span><span class="ident" id="6310629">name</span>&nbsp;<span class="builtintype" id="6310634">string</span><span class="op" id="6310640">,</span>&nbsp;<span class="ident" id="6310642">driver</span>&nbsp;<span class="ident" id="6310649">driver</span><span class="op" id="6310655">.</span><span class="ident" id="6310656">Driver</span><span class="op" id="6310662">)</span>&nbsp;<span class="op" id="6310664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6310667">if</span>&nbsp;<span class="ident" id="6310670">driver</span>&nbsp;<span class="op" id="6310677">==</span>&nbsp;<span class="builtintype" id="6310680">nil</span>&nbsp;<span class="op" id="6310684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6310688">panic</span><span class="op" id="6310693">(</span><span class="string" id="6310694">&#34;sql:&nbsp;Register&nbsp;driver&nbsp;is&nbsp;nil&#34;</span><span class="op" id="6310723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6310726">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6310729">if</span>&nbsp;<span class="ident" id="6310732">_</span><span class="op" id="6310733">,</span>&nbsp;<span class="ident" id="6310735">dup</span>&nbsp;<span class="op" id="6310739">:=</span>&nbsp;<span class="ident" id="6310742">drivers</span><span class="op" id="6310749">[</span><span class="ident" id="6310750">name</span><span class="op" id="6310754">]</span><span class="op" id="6310755">;</span>&nbsp;<span class="ident" id="6310757">dup</span>&nbsp;<span class="op" id="6310761">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6310765">panic</span><span class="op" id="6310770">(</span><span class="string" id="6310771">&#34;sql:&nbsp;Register&nbsp;called&nbsp;twice&nbsp;for&nbsp;driver&nbsp;&#34;</span>&nbsp;<span class="op" id="6310812">+</span>&nbsp;<span class="ident" id="6310814">name</span><span class="op" id="6310818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6310821">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6310824">drivers</span><span class="op" id="6310831">[</span><span class="ident" id="6310832">name</span><span class="op" id="6310836">]</span>&nbsp;<span class="op" id="6310838">=</span>&nbsp;<span class="ident" id="6310840">driver</span><br>
<span class="lineno"></span><span class="op" id="6310847">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="6310850">func</span>&nbsp;<span class="ident" id="6310855">unregisterAllDrivers</span><span class="op" id="6310875">(</span><span class="op" id="6310876">)</span>&nbsp;<span class="op" id="6310878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6310881">//&nbsp;For&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6310896">drivers</span>&nbsp;<span class="op" id="6310904">=</span>&nbsp;<span class="builtinfunc" id="6310906">make</span><span class="op" id="6310910">(</span><span class="keyword" id="6310911">map</span><span class="op" id="6310914">[</span><span class="builtintype" id="6310915">string</span><span class="op" id="6310921">]</span><span class="ident" id="6310922">driver</span><span class="op" id="6310928">.</span><span class="ident" id="6310929">Driver</span><span class="op" id="6310935">)</span><br>
<span class="lineno"></span><span class="op" id="6310937">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="6310940">//&nbsp;Drivers&nbsp;returns&nbsp;a&nbsp;sorted&nbsp;list&nbsp;of&nbsp;the&nbsp;names&nbsp;of&nbsp;the&nbsp;registered&nbsp;drivers.</span><br>
<span class="lineno"></span><span class="keyword" id="6311013">func</span>&nbsp;<span class="ident" id="6311018">Drivers</span><span class="op" id="6311025">(</span><span class="op" id="6311026">)</span>&nbsp;<span class="op" id="6311028">[</span><span class="op" id="6311029">]</span><span class="builtintype" id="6311030">string</span>&nbsp;<span class="op" id="6311037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6311040">var</span>&nbsp;<span class="ident" id="6311044">list</span>&nbsp;<span class="op" id="6311049">[</span><span class="op" id="6311050">]</span><span class="builtintype" id="6311051">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6311059">for</span>&nbsp;<span class="ident" id="6311063">name</span>&nbsp;<span class="op" id="6311068">:=</span>&nbsp;<span class="keyword" id="6311071">range</span>&nbsp;<span class="ident" id="6311077">drivers</span>&nbsp;<span class="op" id="6311085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6311089">list</span>&nbsp;<span class="op" id="6311094">=</span>&nbsp;<span class="builtinfunc" id="6311096">append</span><span class="op" id="6311102">(</span><span class="ident" id="6311103">list</span><span class="op" id="6311107">,</span>&nbsp;<span class="ident" id="6311109">name</span><span class="op" id="6311113">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6311116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6311119">sort</span><span class="op" id="6311123">.</span><span class="ident" id="6311124">Strings</span><span class="op" id="6311131">(</span><span class="ident" id="6311132">list</span><span class="op" id="6311136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6311139">return</span>&nbsp;<span class="ident" id="6311146">list</span><br>
<span class="lineno"></span><span class="op" id="6311151">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="6311154">//&nbsp;RawBytes&nbsp;is&nbsp;a&nbsp;byte&nbsp;slice&nbsp;that&nbsp;holds&nbsp;a&nbsp;reference&nbsp;to&nbsp;memory&nbsp;owned&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="6311224">//&nbsp;the&nbsp;database&nbsp;itself.&nbsp;After&nbsp;a&nbsp;Scan&nbsp;into&nbsp;a&nbsp;RawBytes,&nbsp;the&nbsp;slice&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="6311296">//&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;call&nbsp;to&nbsp;Next,&nbsp;Scan,&nbsp;or&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="6311350">type</span>&nbsp;<span class="ident" id="6311355">RawBytes</span>&nbsp;<span class="op" id="6311364">[</span><span class="op" id="6311365">]</span><span class="builtintype" id="6311366">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="6311372">//&nbsp;NullString&nbsp;represents&nbsp;a&nbsp;string&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="6311424">//&nbsp;NullString&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="6311474">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination:</span><br>
<span class="lineno"></span><span class="comment" id="6311515">//</span><br>
<span class="lineno"></span><span class="comment" id="6311518">//&nbsp;&nbsp;var&nbsp;s&nbsp;NullString</span><br>
<span class="lineno">65</span><span class="comment" id="6311539">//&nbsp;&nbsp;err&nbsp;:=&nbsp;db.QueryRow(&#34;SELECT&nbsp;name&nbsp;FROM&nbsp;foo&nbsp;WHERE&nbsp;id=?&#34;,&nbsp;id).Scan(&amp;s)</span><br>
<span class="lineno"></span><span class="comment" id="6311610">//&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="6311618">//&nbsp;&nbsp;if&nbsp;s.Valid&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="6311635">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;use&nbsp;s.String</span><br>
<span class="lineno"></span><span class="comment" id="6311658">//&nbsp;&nbsp;}&nbsp;else&nbsp;{</span><br>
<span class="lineno">70</span><span class="comment" id="6311671">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;NULL&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="6311692">//&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="6311698">//</span><br>
<span class="lineno"></span><span class="keyword" id="6311701">type</span>&nbsp;<span class="ident" id="6311706">NullString</span>&nbsp;<span class="keyword" id="6311717">struct</span>&nbsp;<span class="op" id="6311724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6311727">String</span>&nbsp;<span class="builtintype" id="6311734">string</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6311742">Valid</span>&nbsp;&nbsp;<span class="builtintype" id="6311749">bool</span>&nbsp;<span class="comment" id="6311754">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;String&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="6311793">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6311796">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6311838">func</span>&nbsp;<span class="op" id="6311843">(</span><span class="ident" id="6311844">ns</span>&nbsp;<span class="op" id="6311847">*</span><span class="ident" id="6311848">NullString</span><span class="op" id="6311858">)</span>&nbsp;<span class="ident" id="6311860">Scan</span><span class="op" id="6311864">(</span><span class="ident" id="6311865">value</span>&nbsp;<span class="keyword" id="6311871">interface</span><span class="op" id="6311880">{</span><span class="op" id="6311881">}</span><span class="op" id="6311882">)</span>&nbsp;<span class="builtintype" id="6311884">error</span>&nbsp;<span class="op" id="6311890">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6311893">if</span>&nbsp;<span class="ident" id="6311896">value</span>&nbsp;<span class="op" id="6311902">==</span>&nbsp;<span class="builtintype" id="6311905">nil</span>&nbsp;<span class="op" id="6311909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6311913">ns</span><span class="op" id="6311915">.</span><span class="ident" id="6311916">String</span><span class="op" id="6311922">,</span>&nbsp;<span class="ident" id="6311924">ns</span><span class="op" id="6311926">.</span><span class="ident" id="6311927">Valid</span>&nbsp;<span class="op" id="6311933">=</span>&nbsp;<span class="string" id="6311935">&#34;&#34;</span><span class="op" id="6311937">,</span>&nbsp;<span class="builtintype" id="6311939">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6311947">return</span>&nbsp;<span class="builtintype" id="6311954">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6311959">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6311962">ns</span><span class="op" id="6311964">.</span><span class="ident" id="6311965">Valid</span>&nbsp;<span class="op" id="6311971">=</span>&nbsp;<span class="builtintype" id="6311973">true</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6311979">return</span>&nbsp;<span class="ident" id="6311986">convertAssign</span><span class="op" id="6311999">(</span><span class="op" id="6312000">&amp;</span><span class="ident" id="6312001">ns</span><span class="op" id="6312003">.</span><span class="ident" id="6312004">String</span><span class="op" id="6312010">,</span>&nbsp;<span class="ident" id="6312012">value</span><span class="op" id="6312017">)</span><br>
<span class="lineno"></span><span class="op" id="6312019">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6312022">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6312071">func</span>&nbsp;<span class="op" id="6312076">(</span><span class="ident" id="6312077">ns</span>&nbsp;<span class="ident" id="6312080">NullString</span><span class="op" id="6312090">)</span>&nbsp;<span class="ident" id="6312092">Value</span><span class="op" id="6312097">(</span><span class="op" id="6312098">)</span>&nbsp;<span class="op" id="6312100">(</span><span class="ident" id="6312101">driver</span><span class="op" id="6312107">.</span><span class="ident" id="6312108">Value</span><span class="op" id="6312113">,</span>&nbsp;<span class="builtintype" id="6312115">error</span><span class="op" id="6312120">)</span>&nbsp;<span class="op" id="6312122">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6312125">if</span>&nbsp;<span class="op" id="6312128">!</span><span class="ident" id="6312129">ns</span><span class="op" id="6312131">.</span><span class="ident" id="6312132">Valid</span>&nbsp;<span class="op" id="6312138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6312142">return</span>&nbsp;<span class="builtintype" id="6312149">nil</span><span class="op" id="6312152">,</span>&nbsp;<span class="builtintype" id="6312154">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6312159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6312162">return</span>&nbsp;<span class="ident" id="6312169">ns</span><span class="op" id="6312171">.</span><span class="ident" id="6312172">String</span><span class="op" id="6312178">,</span>&nbsp;<span class="builtintype" id="6312180">nil</span><br>
<span class="lineno"></span><span class="op" id="6312184">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="6312187">//&nbsp;NullInt64&nbsp;represents&nbsp;an&nbsp;int64&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="6312238">//&nbsp;NullInt64&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="6312287">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination,&nbsp;similar&nbsp;to&nbsp;NullString.</span><br>
<span class="lineno"></span><span class="keyword" id="6312351">type</span>&nbsp;<span class="ident" id="6312356">NullInt64</span>&nbsp;<span class="keyword" id="6312366">struct</span>&nbsp;<span class="op" id="6312373">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6312376">Int64</span>&nbsp;<span class="builtintype" id="6312382">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6312389">Valid</span>&nbsp;<span class="builtintype" id="6312395">bool</span>&nbsp;<span class="comment" id="6312400">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;Int64&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="6312438">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6312441">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno">105</span><span class="keyword" id="6312483">func</span>&nbsp;<span class="op" id="6312488">(</span><span class="ident" id="6312489">n</span>&nbsp;<span class="op" id="6312491">*</span><span class="ident" id="6312492">NullInt64</span><span class="op" id="6312501">)</span>&nbsp;<span class="ident" id="6312503">Scan</span><span class="op" id="6312507">(</span><span class="ident" id="6312508">value</span>&nbsp;<span class="keyword" id="6312514">interface</span><span class="op" id="6312523">{</span><span class="op" id="6312524">}</span><span class="op" id="6312525">)</span>&nbsp;<span class="builtintype" id="6312527">error</span>&nbsp;<span class="op" id="6312533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6312536">if</span>&nbsp;<span class="ident" id="6312539">value</span>&nbsp;<span class="op" id="6312545">==</span>&nbsp;<span class="builtintype" id="6312548">nil</span>&nbsp;<span class="op" id="6312552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6312556">n</span><span class="op" id="6312557">.</span><span class="ident" id="6312558">Int64</span><span class="op" id="6312563">,</span>&nbsp;<span class="ident" id="6312565">n</span><span class="op" id="6312566">.</span><span class="ident" id="6312567">Valid</span>&nbsp;<span class="op" id="6312573">=</span>&nbsp;<span class="num" id="6312575">0</span><span class="op" id="6312576">,</span>&nbsp;<span class="builtintype" id="6312578">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6312586">return</span>&nbsp;<span class="builtintype" id="6312593">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6312598">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6312601">n</span><span class="op" id="6312602">.</span><span class="ident" id="6312603">Valid</span>&nbsp;<span class="op" id="6312609">=</span>&nbsp;<span class="builtintype" id="6312611">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6312617">return</span>&nbsp;<span class="ident" id="6312624">convertAssign</span><span class="op" id="6312637">(</span><span class="op" id="6312638">&amp;</span><span class="ident" id="6312639">n</span><span class="op" id="6312640">.</span><span class="ident" id="6312641">Int64</span><span class="op" id="6312646">,</span>&nbsp;<span class="ident" id="6312648">value</span><span class="op" id="6312653">)</span><br>
<span class="lineno"></span><span class="op" id="6312655">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6312658">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno">115</span><span class="keyword" id="6312707">func</span>&nbsp;<span class="op" id="6312712">(</span><span class="ident" id="6312713">n</span>&nbsp;<span class="ident" id="6312715">NullInt64</span><span class="op" id="6312724">)</span>&nbsp;<span class="ident" id="6312726">Value</span><span class="op" id="6312731">(</span><span class="op" id="6312732">)</span>&nbsp;<span class="op" id="6312734">(</span><span class="ident" id="6312735">driver</span><span class="op" id="6312741">.</span><span class="ident" id="6312742">Value</span><span class="op" id="6312747">,</span>&nbsp;<span class="builtintype" id="6312749">error</span><span class="op" id="6312754">)</span>&nbsp;<span class="op" id="6312756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6312759">if</span>&nbsp;<span class="op" id="6312762">!</span><span class="ident" id="6312763">n</span><span class="op" id="6312764">.</span><span class="ident" id="6312765">Valid</span>&nbsp;<span class="op" id="6312771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6312775">return</span>&nbsp;<span class="builtintype" id="6312782">nil</span><span class="op" id="6312785">,</span>&nbsp;<span class="builtintype" id="6312787">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6312792">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6312795">return</span>&nbsp;<span class="ident" id="6312802">n</span><span class="op" id="6312803">.</span><span class="ident" id="6312804">Int64</span><span class="op" id="6312809">,</span>&nbsp;<span class="builtintype" id="6312811">nil</span><br>
<span class="lineno">120</span><span class="op" id="6312815">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6312818">//&nbsp;NullFloat64&nbsp;represents&nbsp;a&nbsp;float64&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="6312872">//&nbsp;NullFloat64&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="6312923">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination,&nbsp;similar&nbsp;to&nbsp;NullString.</span><br>
<span class="lineno">125</span><span class="keyword" id="6312987">type</span>&nbsp;<span class="ident" id="6312992">NullFloat64</span>&nbsp;<span class="keyword" id="6313004">struct</span>&nbsp;<span class="op" id="6313011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6313014">Float64</span>&nbsp;<span class="builtintype" id="6313022">float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6313031">Valid</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6313039">bool</span>&nbsp;<span class="comment" id="6313044">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;Float64&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="6313084">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="comment" id="6313087">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6313129">func</span>&nbsp;<span class="op" id="6313134">(</span><span class="ident" id="6313135">n</span>&nbsp;<span class="op" id="6313137">*</span><span class="ident" id="6313138">NullFloat64</span><span class="op" id="6313149">)</span>&nbsp;<span class="ident" id="6313151">Scan</span><span class="op" id="6313155">(</span><span class="ident" id="6313156">value</span>&nbsp;<span class="keyword" id="6313162">interface</span><span class="op" id="6313171">{</span><span class="op" id="6313172">}</span><span class="op" id="6313173">)</span>&nbsp;<span class="builtintype" id="6313175">error</span>&nbsp;<span class="op" id="6313181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6313184">if</span>&nbsp;<span class="ident" id="6313187">value</span>&nbsp;<span class="op" id="6313193">==</span>&nbsp;<span class="builtintype" id="6313196">nil</span>&nbsp;<span class="op" id="6313200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6313204">n</span><span class="op" id="6313205">.</span><span class="ident" id="6313206">Float64</span><span class="op" id="6313213">,</span>&nbsp;<span class="ident" id="6313215">n</span><span class="op" id="6313216">.</span><span class="ident" id="6313217">Valid</span>&nbsp;<span class="op" id="6313223">=</span>&nbsp;<span class="num" id="6313225">0</span><span class="op" id="6313226">,</span>&nbsp;<span class="builtintype" id="6313228">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6313236">return</span>&nbsp;<span class="builtintype" id="6313243">nil</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6313248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6313251">n</span><span class="op" id="6313252">.</span><span class="ident" id="6313253">Valid</span>&nbsp;<span class="op" id="6313259">=</span>&nbsp;<span class="builtintype" id="6313261">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6313267">return</span>&nbsp;<span class="ident" id="6313274">convertAssign</span><span class="op" id="6313287">(</span><span class="op" id="6313288">&amp;</span><span class="ident" id="6313289">n</span><span class="op" id="6313290">.</span><span class="ident" id="6313291">Float64</span><span class="op" id="6313298">,</span>&nbsp;<span class="ident" id="6313300">value</span><span class="op" id="6313305">)</span><br>
<span class="lineno"></span><span class="op" id="6313307">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="6313310">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6313359">func</span>&nbsp;<span class="op" id="6313364">(</span><span class="ident" id="6313365">n</span>&nbsp;<span class="ident" id="6313367">NullFloat64</span><span class="op" id="6313378">)</span>&nbsp;<span class="ident" id="6313380">Value</span><span class="op" id="6313385">(</span><span class="op" id="6313386">)</span>&nbsp;<span class="op" id="6313388">(</span><span class="ident" id="6313389">driver</span><span class="op" id="6313395">.</span><span class="ident" id="6313396">Value</span><span class="op" id="6313401">,</span>&nbsp;<span class="builtintype" id="6313403">error</span><span class="op" id="6313408">)</span>&nbsp;<span class="op" id="6313410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6313413">if</span>&nbsp;<span class="op" id="6313416">!</span><span class="ident" id="6313417">n</span><span class="op" id="6313418">.</span><span class="ident" id="6313419">Valid</span>&nbsp;<span class="op" id="6313425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6313429">return</span>&nbsp;<span class="builtintype" id="6313436">nil</span><span class="op" id="6313439">,</span>&nbsp;<span class="builtintype" id="6313441">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6313446">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6313449">return</span>&nbsp;<span class="ident" id="6313456">n</span><span class="op" id="6313457">.</span><span class="ident" id="6313458">Float64</span><span class="op" id="6313465">,</span>&nbsp;<span class="builtintype" id="6313467">nil</span><br>
<span class="lineno"></span><span class="op" id="6313471">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6313474">//&nbsp;NullBool&nbsp;represents&nbsp;a&nbsp;bool&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="6313522">//&nbsp;NullBool&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno">150</span><span class="comment" id="6313570">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination,&nbsp;similar&nbsp;to&nbsp;NullString.</span><br>
<span class="lineno"></span><span class="keyword" id="6313634">type</span>&nbsp;<span class="ident" id="6313639">NullBool</span>&nbsp;<span class="keyword" id="6313648">struct</span>&nbsp;<span class="op" id="6313655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6313658">Bool</span>&nbsp;&nbsp;<span class="builtintype" id="6313664">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6313670">Valid</span>&nbsp;<span class="builtintype" id="6313676">bool</span>&nbsp;<span class="comment" id="6313681">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;Bool&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="6313718">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="6313721">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6313763">func</span>&nbsp;<span class="op" id="6313768">(</span><span class="ident" id="6313769">n</span>&nbsp;<span class="op" id="6313771">*</span><span class="ident" id="6313772">NullBool</span><span class="op" id="6313780">)</span>&nbsp;<span class="ident" id="6313782">Scan</span><span class="op" id="6313786">(</span><span class="ident" id="6313787">value</span>&nbsp;<span class="keyword" id="6313793">interface</span><span class="op" id="6313802">{</span><span class="op" id="6313803">}</span><span class="op" id="6313804">)</span>&nbsp;<span class="builtintype" id="6313806">error</span>&nbsp;<span class="op" id="6313812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6313815">if</span>&nbsp;<span class="ident" id="6313818">value</span>&nbsp;<span class="op" id="6313824">==</span>&nbsp;<span class="builtintype" id="6313827">nil</span>&nbsp;<span class="op" id="6313831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6313835">n</span><span class="op" id="6313836">.</span><span class="ident" id="6313837">Bool</span><span class="op" id="6313841">,</span>&nbsp;<span class="ident" id="6313843">n</span><span class="op" id="6313844">.</span><span class="ident" id="6313845">Valid</span>&nbsp;<span class="op" id="6313851">=</span>&nbsp;<span class="builtintype" id="6313853">false</span><span class="op" id="6313858">,</span>&nbsp;<span class="builtintype" id="6313860">false</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6313868">return</span>&nbsp;<span class="builtintype" id="6313875">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6313880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6313883">n</span><span class="op" id="6313884">.</span><span class="ident" id="6313885">Valid</span>&nbsp;<span class="op" id="6313891">=</span>&nbsp;<span class="builtintype" id="6313893">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6313899">return</span>&nbsp;<span class="ident" id="6313906">convertAssign</span><span class="op" id="6313919">(</span><span class="op" id="6313920">&amp;</span><span class="ident" id="6313921">n</span><span class="op" id="6313922">.</span><span class="ident" id="6313923">Bool</span><span class="op" id="6313927">,</span>&nbsp;<span class="ident" id="6313929">value</span><span class="op" id="6313934">)</span><br>
<span class="lineno"></span><span class="op" id="6313936">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="6313939">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6313988">func</span>&nbsp;<span class="op" id="6313993">(</span><span class="ident" id="6313994">n</span>&nbsp;<span class="ident" id="6313996">NullBool</span><span class="op" id="6314004">)</span>&nbsp;<span class="ident" id="6314006">Value</span><span class="op" id="6314011">(</span><span class="op" id="6314012">)</span>&nbsp;<span class="op" id="6314014">(</span><span class="ident" id="6314015">driver</span><span class="op" id="6314021">.</span><span class="ident" id="6314022">Value</span><span class="op" id="6314027">,</span>&nbsp;<span class="builtintype" id="6314029">error</span><span class="op" id="6314034">)</span>&nbsp;<span class="op" id="6314036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6314039">if</span>&nbsp;<span class="op" id="6314042">!</span><span class="ident" id="6314043">n</span><span class="op" id="6314044">.</span><span class="ident" id="6314045">Valid</span>&nbsp;<span class="op" id="6314051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6314055">return</span>&nbsp;<span class="builtintype" id="6314062">nil</span><span class="op" id="6314065">,</span>&nbsp;<span class="builtintype" id="6314067">nil</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6314072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6314075">return</span>&nbsp;<span class="ident" id="6314082">n</span><span class="op" id="6314083">.</span><span class="ident" id="6314084">Bool</span><span class="op" id="6314088">,</span>&nbsp;<span class="builtintype" id="6314090">nil</span><br>
<span class="lineno"></span><span class="op" id="6314094">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6314097">//&nbsp;Scanner&nbsp;is&nbsp;an&nbsp;interface&nbsp;used&nbsp;by&nbsp;Scan.</span><br>
<span class="lineno">175</span><span class="keyword" id="6314138">type</span>&nbsp;<span class="ident" id="6314143">Scanner</span>&nbsp;<span class="keyword" id="6314151">interface</span>&nbsp;<span class="op" id="6314161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6314164">//&nbsp;Scan&nbsp;assigns&nbsp;a&nbsp;value&nbsp;from&nbsp;a&nbsp;database&nbsp;driver.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6314213">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6314217">//&nbsp;The&nbsp;src&nbsp;value&nbsp;will&nbsp;be&nbsp;of&nbsp;one&nbsp;of&nbsp;the&nbsp;following&nbsp;restricted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6314278">//&nbsp;set&nbsp;of&nbsp;types:</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6314296">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6314300">//&nbsp;&nbsp;&nbsp;&nbsp;int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6314313">//&nbsp;&nbsp;&nbsp;&nbsp;float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6314328">//&nbsp;&nbsp;&nbsp;&nbsp;bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6314340">//&nbsp;&nbsp;&nbsp;&nbsp;[]byte</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6314354">//&nbsp;&nbsp;&nbsp;&nbsp;string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6314368">//&nbsp;&nbsp;&nbsp;&nbsp;time.Time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6314385">//&nbsp;&nbsp;&nbsp;&nbsp;nil&nbsp;-&nbsp;for&nbsp;NULL&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6314414">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6314418">//&nbsp;An&nbsp;error&nbsp;should&nbsp;be&nbsp;returned&nbsp;if&nbsp;the&nbsp;value&nbsp;can&nbsp;not&nbsp;be&nbsp;stored</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6314481">//&nbsp;without&nbsp;loss&nbsp;of&nbsp;information.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6314514">Scan</span><span class="op" id="6314518">(</span><span class="ident" id="6314519">src</span>&nbsp;<span class="keyword" id="6314523">interface</span><span class="op" id="6314532">{</span><span class="op" id="6314533">}</span><span class="op" id="6314534">)</span>&nbsp;<span class="builtintype" id="6314536">error</span><br>
<span class="lineno"></span><span class="op" id="6314542">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6314545">//&nbsp;ErrNoRows&nbsp;is&nbsp;returned&nbsp;by&nbsp;Scan&nbsp;when&nbsp;QueryRow&nbsp;doesn&#39;t&nbsp;return&nbsp;a</span><br>
<span class="lineno">195</span><span class="comment" id="6314609">//&nbsp;row.&nbsp;In&nbsp;such&nbsp;a&nbsp;case,&nbsp;QueryRow&nbsp;returns&nbsp;a&nbsp;placeholder&nbsp;*Row&nbsp;value&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="6314680">//&nbsp;defers&nbsp;this&nbsp;error&nbsp;until&nbsp;a&nbsp;Scan.</span><br>
<span class="lineno"></span><span class="keyword" id="6314715">var</span>&nbsp;<span class="ident" id="6314719">ErrNoRows</span>&nbsp;<span class="op" id="6314729">=</span>&nbsp;<span class="ident" id="6314731">errors</span><span class="op" id="6314737">.</span><span class="ident" id="6314738">New</span><span class="op" id="6314741">(</span><span class="string" id="6314742">&#34;sql:&nbsp;no&nbsp;rows&nbsp;in&nbsp;result&nbsp;set&#34;</span><span class="op" id="6314770">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6314773">//&nbsp;DB&nbsp;is&nbsp;a&nbsp;database&nbsp;handle&nbsp;representing&nbsp;a&nbsp;pool&nbsp;of&nbsp;zero&nbsp;or&nbsp;more</span><br>
<span class="lineno">200</span><span class="comment" id="6314836">//&nbsp;underlying&nbsp;connections.&nbsp;It&#39;s&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple</span><br>
<span class="lineno"></span><span class="comment" id="6314904">//&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="comment" id="6314919">//</span><br>
<span class="lineno"></span><span class="comment" id="6314922">//&nbsp;The&nbsp;sql&nbsp;package&nbsp;creates&nbsp;and&nbsp;frees&nbsp;connections&nbsp;automatically;&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="6314989">//&nbsp;also&nbsp;maintains&nbsp;a&nbsp;free&nbsp;pool&nbsp;of&nbsp;idle&nbsp;connections.&nbsp;If&nbsp;the&nbsp;database&nbsp;has</span><br>
<span class="lineno">205</span><span class="comment" id="6315060">//&nbsp;a&nbsp;concept&nbsp;of&nbsp;per-connection&nbsp;state,&nbsp;such&nbsp;state&nbsp;can&nbsp;only&nbsp;be&nbsp;reliably</span><br>
<span class="lineno"></span><span class="comment" id="6315130">//&nbsp;observed&nbsp;within&nbsp;a&nbsp;transaction.&nbsp;Once&nbsp;DB.Begin&nbsp;is&nbsp;called,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6315193">//&nbsp;returned&nbsp;Tx&nbsp;is&nbsp;bound&nbsp;to&nbsp;a&nbsp;single&nbsp;connection.&nbsp;Once&nbsp;Commit&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="6315256">//&nbsp;Rollback&nbsp;is&nbsp;called&nbsp;on&nbsp;the&nbsp;transaction,&nbsp;that&nbsp;transaction&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="6315317">//&nbsp;connection&nbsp;is&nbsp;returned&nbsp;to&nbsp;DB&#39;s&nbsp;idle&nbsp;connection&nbsp;pool.&nbsp;The&nbsp;pool&nbsp;size</span><br>
<span class="lineno">210</span><span class="comment" id="6315387">//&nbsp;can&nbsp;be&nbsp;controlled&nbsp;with&nbsp;SetMaxIdleConns.</span><br>
<span class="lineno"></span><span class="keyword" id="6315430">type</span>&nbsp;<span class="ident" id="6315435">DB</span>&nbsp;<span class="keyword" id="6315438">struct</span>&nbsp;<span class="op" id="6315445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6315448">driver</span>&nbsp;<span class="ident" id="6315455">driver</span><span class="op" id="6315461">.</span><span class="ident" id="6315462">Driver</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6315470">dsn</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6315477">string</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6315486">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6315499">sync</span><span class="op" id="6315503">.</span><span class="ident" id="6315504">Mutex</span>&nbsp;<span class="comment" id="6315510">//&nbsp;protects&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6315540">freeConn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6315553">[</span><span class="op" id="6315554">]</span><span class="op" id="6315555">*</span><span class="ident" id="6315556">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6315568">connRequests</span>&nbsp;<span class="op" id="6315581">[</span><span class="op" id="6315582">]</span><span class="keyword" id="6315583">chan</span>&nbsp;<span class="ident" id="6315588">connRequest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6315601">numOpen</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6315614">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6315619">pendingOpens</span>&nbsp;<span class="builtintype" id="6315632">int</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6315637">//&nbsp;Used&nbsp;to&nbsp;signal&nbsp;the&nbsp;need&nbsp;for&nbsp;new&nbsp;connections</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6315685">//&nbsp;a&nbsp;goroutine&nbsp;running&nbsp;connectionOpener()&nbsp;reads&nbsp;on&nbsp;this&nbsp;chan&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6315751">//&nbsp;maybeOpenNewConnections&nbsp;sends&nbsp;on&nbsp;the&nbsp;chan&nbsp;(one&nbsp;send&nbsp;per&nbsp;needed&nbsp;connection)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6315830">//&nbsp;It&nbsp;is&nbsp;closed&nbsp;during&nbsp;db.Close().&nbsp;The&nbsp;close&nbsp;tells&nbsp;the&nbsp;connectionOpener</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6315903">//&nbsp;goroutine&nbsp;to&nbsp;exit.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6315926">openerCh</span>&nbsp;<span class="keyword" id="6315935">chan</span>&nbsp;<span class="keyword" id="6315940">struct</span><span class="op" id="6315946">{</span><span class="op" id="6315947">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6315950">closed</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6315959">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6315965">dep</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6315974">map</span><span class="op" id="6315977">[</span><span class="ident" id="6315978">finalCloser</span><span class="op" id="6315989">]</span><span class="ident" id="6315990">depSet</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6315998">lastPut</span>&nbsp;&nbsp;<span class="keyword" id="6316007">map</span><span class="op" id="6316010">[</span><span class="op" id="6316011">*</span><span class="ident" id="6316012">driverConn</span><span class="op" id="6316022">]</span><span class="builtintype" id="6316023">string</span>&nbsp;<span class="comment" id="6316030">//&nbsp;stacktrace&nbsp;of&nbsp;last&nbsp;conn&#39;s&nbsp;put;&nbsp;debug&nbsp;only</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6316076">maxIdle</span>&nbsp;&nbsp;<span class="builtintype" id="6316085">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6316108">//&nbsp;zero&nbsp;means&nbsp;defaultMaxIdleConns;&nbsp;negative&nbsp;means&nbsp;0</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6316161">maxOpen</span>&nbsp;&nbsp;<span class="builtintype" id="6316170">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6316193">//&nbsp;&lt;=&nbsp;0&nbsp;means&nbsp;unlimited</span><br>
<span class="lineno"></span><span class="op" id="6316217">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6316220">//&nbsp;driverConn&nbsp;wraps&nbsp;a&nbsp;driver.Conn&nbsp;with&nbsp;a&nbsp;mutex,&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="6316271">//&nbsp;be&nbsp;held&nbsp;during&nbsp;all&nbsp;calls&nbsp;into&nbsp;the&nbsp;Conn.&nbsp;(including&nbsp;any&nbsp;calls&nbsp;onto</span><br>
<span class="lineno">235</span><span class="comment" id="6316340">//&nbsp;interfaces&nbsp;returned&nbsp;via&nbsp;that&nbsp;Conn,&nbsp;such&nbsp;as&nbsp;calls&nbsp;on&nbsp;Tx,&nbsp;Stmt,</span><br>
<span class="lineno"></span><span class="comment" id="6316405">//&nbsp;Result,&nbsp;Rows)</span><br>
<span class="lineno"></span><span class="keyword" id="6316422">type</span>&nbsp;<span class="ident" id="6316427">driverConn</span>&nbsp;<span class="keyword" id="6316438">struct</span>&nbsp;<span class="op" id="6316445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6316448">db</span>&nbsp;<span class="op" id="6316451">*</span><span class="ident" id="6316452">DB</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6316457">sync</span><span class="op" id="6316461">.</span><span class="ident" id="6316462">Mutex</span>&nbsp;&nbsp;<span class="comment" id="6316469">//&nbsp;guards&nbsp;following</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6316490">ci</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6316502">driver</span><span class="op" id="6316508">.</span><span class="ident" id="6316509">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6316515">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6316527">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6316533">finalClosed</span>&nbsp;<span class="builtintype" id="6316545">bool</span>&nbsp;<span class="comment" id="6316550">//&nbsp;ci.Close&nbsp;has&nbsp;been&nbsp;called</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6316579">openStmt</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6316591">map</span><span class="op" id="6316594">[</span><span class="ident" id="6316595">driver</span><span class="op" id="6316601">.</span><span class="ident" id="6316602">Stmt</span><span class="op" id="6316606">]</span><span class="builtintype" id="6316607">bool</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6316614">//&nbsp;guarded&nbsp;by&nbsp;db.mu</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6316635">inUse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6316646">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6316652">onPut</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6316663">[</span><span class="op" id="6316664">]</span><span class="keyword" id="6316665">func</span><span class="op" id="6316669">(</span><span class="op" id="6316670">)</span>&nbsp;<span class="comment" id="6316672">//&nbsp;code&nbsp;(with&nbsp;db.mu&nbsp;held)&nbsp;run&nbsp;when&nbsp;conn&nbsp;is&nbsp;next&nbsp;returned</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6316730">dbmuClosed</span>&nbsp;<span class="builtintype" id="6316741">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6316750">//&nbsp;same&nbsp;as&nbsp;closed,&nbsp;but&nbsp;guarded&nbsp;by&nbsp;db.mu,&nbsp;for&nbsp;connIfFree</span><br>
<span class="lineno">250</span><span class="op" id="6316806">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6316809">func</span>&nbsp;<span class="op" id="6316814">(</span><span class="ident" id="6316815">dc</span>&nbsp;<span class="op" id="6316818">*</span><span class="ident" id="6316819">driverConn</span><span class="op" id="6316829">)</span>&nbsp;<span class="ident" id="6316831">releaseConn</span><span class="op" id="6316842">(</span><span class="ident" id="6316843">err</span>&nbsp;<span class="builtintype" id="6316847">error</span><span class="op" id="6316852">)</span>&nbsp;<span class="op" id="6316854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6316857">dc</span><span class="op" id="6316859">.</span><span class="ident" id="6316860">db</span><span class="op" id="6316862">.</span><span class="ident" id="6316863">putConn</span><span class="op" id="6316870">(</span><span class="ident" id="6316871">dc</span><span class="op" id="6316873">,</span>&nbsp;<span class="ident" id="6316875">err</span><span class="op" id="6316878">)</span><br>
<span class="lineno"></span><span class="op" id="6316880">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="6316883">func</span>&nbsp;<span class="op" id="6316888">(</span><span class="ident" id="6316889">dc</span>&nbsp;<span class="op" id="6316892">*</span><span class="ident" id="6316893">driverConn</span><span class="op" id="6316903">)</span>&nbsp;<span class="ident" id="6316905">removeOpenStmt</span><span class="op" id="6316919">(</span><span class="ident" id="6316920">si</span>&nbsp;<span class="ident" id="6316923">driver</span><span class="op" id="6316929">.</span><span class="ident" id="6316930">Stmt</span><span class="op" id="6316934">)</span>&nbsp;<span class="op" id="6316936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6316939">dc</span><span class="op" id="6316941">.</span><span class="ident" id="6316942">Lock</span><span class="op" id="6316946">(</span><span class="op" id="6316947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6316950">defer</span>&nbsp;<span class="ident" id="6316956">dc</span><span class="op" id="6316958">.</span><span class="ident" id="6316959">Unlock</span><span class="op" id="6316965">(</span><span class="op" id="6316966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6316969">delete</span><span class="op" id="6316975">(</span><span class="ident" id="6316976">dc</span><span class="op" id="6316978">.</span><span class="ident" id="6316979">openStmt</span><span class="op" id="6316987">,</span>&nbsp;<span class="ident" id="6316989">si</span><span class="op" id="6316991">)</span><br>
<span class="lineno">260</span><span class="op" id="6316993">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6316996">func</span>&nbsp;<span class="op" id="6317001">(</span><span class="ident" id="6317002">dc</span>&nbsp;<span class="op" id="6317005">*</span><span class="ident" id="6317006">driverConn</span><span class="op" id="6317016">)</span>&nbsp;<span class="ident" id="6317018">prepareLocked</span><span class="op" id="6317031">(</span><span class="ident" id="6317032">query</span>&nbsp;<span class="builtintype" id="6317038">string</span><span class="op" id="6317044">)</span>&nbsp;<span class="op" id="6317046">(</span><span class="ident" id="6317047">driver</span><span class="op" id="6317053">.</span><span class="ident" id="6317054">Stmt</span><span class="op" id="6317058">,</span>&nbsp;<span class="builtintype" id="6317060">error</span><span class="op" id="6317065">)</span>&nbsp;<span class="op" id="6317067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6317070">si</span><span class="op" id="6317072">,</span>&nbsp;<span class="ident" id="6317074">err</span>&nbsp;<span class="op" id="6317078">:=</span>&nbsp;<span class="ident" id="6317081">dc</span><span class="op" id="6317083">.</span><span class="ident" id="6317084">ci</span><span class="op" id="6317086">.</span><span class="ident" id="6317087">Prepare</span><span class="op" id="6317094">(</span><span class="ident" id="6317095">query</span><span class="op" id="6317100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6317103">if</span>&nbsp;<span class="ident" id="6317106">err</span>&nbsp;<span class="op" id="6317110">==</span>&nbsp;<span class="builtintype" id="6317113">nil</span>&nbsp;<span class="op" id="6317117">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6317121">//&nbsp;Track&nbsp;each&nbsp;driverConn&#39;s&nbsp;open&nbsp;statements,&nbsp;so&nbsp;we&nbsp;can&nbsp;close&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6317188">//&nbsp;before&nbsp;closing&nbsp;the&nbsp;conn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6317218">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6317223">//&nbsp;TODO(bradfitz):&nbsp;let&nbsp;drivers&nbsp;opt&nbsp;out&nbsp;of&nbsp;caring&nbsp;about</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6317280">//&nbsp;stmt&nbsp;closes&nbsp;if&nbsp;the&nbsp;conn&nbsp;is&nbsp;about&nbsp;to&nbsp;close&nbsp;anyway?&nbsp;For&nbsp;now</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6317343">//&nbsp;do&nbsp;the&nbsp;safe&nbsp;thing,&nbsp;in&nbsp;case&nbsp;stmts&nbsp;need&nbsp;to&nbsp;be&nbsp;closed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6317400">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6317405">//&nbsp;TODO(bradfitz):&nbsp;after&nbsp;Go&nbsp;1.2,&nbsp;closing&nbsp;driver.Stmts</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6317461">//&nbsp;should&nbsp;be&nbsp;moved&nbsp;to&nbsp;driverStmt,&nbsp;using&nbsp;unique</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6317510">//&nbsp;*driverStmts&nbsp;everywhere&nbsp;(including&nbsp;from</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6317555">//&nbsp;*Stmt.connStmt,&nbsp;instead&nbsp;of&nbsp;returning&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6317599">//&nbsp;driver.Stmt),&nbsp;using&nbsp;driverStmt&nbsp;as&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6317648">//&nbsp;everywhere,&nbsp;and&nbsp;making&nbsp;it&nbsp;a&nbsp;finalCloser.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6317694">if</span>&nbsp;<span class="ident" id="6317697">dc</span><span class="op" id="6317699">.</span><span class="ident" id="6317700">openStmt</span>&nbsp;<span class="op" id="6317709">==</span>&nbsp;<span class="builtintype" id="6317712">nil</span>&nbsp;<span class="op" id="6317716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6317721">dc</span><span class="op" id="6317723">.</span><span class="ident" id="6317724">openStmt</span>&nbsp;<span class="op" id="6317733">=</span>&nbsp;<span class="builtinfunc" id="6317735">make</span><span class="op" id="6317739">(</span><span class="keyword" id="6317740">map</span><span class="op" id="6317743">[</span><span class="ident" id="6317744">driver</span><span class="op" id="6317750">.</span><span class="ident" id="6317751">Stmt</span><span class="op" id="6317755">]</span><span class="builtintype" id="6317756">bool</span><span class="op" id="6317760">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6317764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6317768">dc</span><span class="op" id="6317770">.</span><span class="ident" id="6317771">openStmt</span><span class="op" id="6317779">[</span><span class="ident" id="6317780">si</span><span class="op" id="6317782">]</span>&nbsp;<span class="op" id="6317784">=</span>&nbsp;<span class="builtintype" id="6317786">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6317792">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6317795">return</span>&nbsp;<span class="ident" id="6317802">si</span><span class="op" id="6317804">,</span>&nbsp;<span class="ident" id="6317806">err</span><br>
<span class="lineno"></span><span class="op" id="6317810">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="comment" id="6317813">//&nbsp;the&nbsp;dc.db&#39;s&nbsp;Mutex&nbsp;is&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword" id="6317843">func</span>&nbsp;<span class="op" id="6317848">(</span><span class="ident" id="6317849">dc</span>&nbsp;<span class="op" id="6317852">*</span><span class="ident" id="6317853">driverConn</span><span class="op" id="6317863">)</span>&nbsp;<span class="ident" id="6317865">closeDBLocked</span><span class="op" id="6317878">(</span><span class="op" id="6317879">)</span>&nbsp;<span class="keyword" id="6317881">func</span><span class="op" id="6317885">(</span><span class="op" id="6317886">)</span>&nbsp;<span class="builtintype" id="6317888">error</span>&nbsp;<span class="op" id="6317894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6317897">dc</span><span class="op" id="6317899">.</span><span class="ident" id="6317900">Lock</span><span class="op" id="6317904">(</span><span class="op" id="6317905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6317908">defer</span>&nbsp;<span class="ident" id="6317914">dc</span><span class="op" id="6317916">.</span><span class="ident" id="6317917">Unlock</span><span class="op" id="6317923">(</span><span class="op" id="6317924">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6317927">if</span>&nbsp;<span class="ident" id="6317930">dc</span><span class="op" id="6317932">.</span><span class="ident" id="6317933">closed</span>&nbsp;<span class="op" id="6317940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6317944">return</span>&nbsp;<span class="keyword" id="6317951">func</span><span class="op" id="6317955">(</span><span class="op" id="6317956">)</span>&nbsp;<span class="builtintype" id="6317958">error</span>&nbsp;<span class="op" id="6317964">{</span>&nbsp;<span class="keyword" id="6317966">return</span>&nbsp;<span class="ident" id="6317973">errors</span><span class="op" id="6317979">.</span><span class="ident" id="6317980">New</span><span class="op" id="6317983">(</span><span class="string" id="6317984">&#34;sql:&nbsp;duplicate&nbsp;driverConn&nbsp;close&#34;</span><span class="op" id="6318017">)</span>&nbsp;<span class="op" id="6318019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6318022">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6318025">dc</span><span class="op" id="6318027">.</span><span class="ident" id="6318028">closed</span>&nbsp;<span class="op" id="6318035">=</span>&nbsp;<span class="builtintype" id="6318037">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6318043">return</span>&nbsp;<span class="ident" id="6318050">dc</span><span class="op" id="6318052">.</span><span class="ident" id="6318053">db</span><span class="op" id="6318055">.</span><span class="ident" id="6318056">removeDepLocked</span><span class="op" id="6318071">(</span><span class="ident" id="6318072">dc</span><span class="op" id="6318074">,</span>&nbsp;<span class="ident" id="6318076">dc</span><span class="op" id="6318078">)</span><br>
<span class="lineno">295</span><span class="op" id="6318080">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6318083">func</span>&nbsp;<span class="op" id="6318088">(</span><span class="ident" id="6318089">dc</span>&nbsp;<span class="op" id="6318092">*</span><span class="ident" id="6318093">driverConn</span><span class="op" id="6318103">)</span>&nbsp;<span class="ident" id="6318105">Close</span><span class="op" id="6318110">(</span><span class="op" id="6318111">)</span>&nbsp;<span class="builtintype" id="6318113">error</span>&nbsp;<span class="op" id="6318119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6318122">dc</span><span class="op" id="6318124">.</span><span class="ident" id="6318125">Lock</span><span class="op" id="6318129">(</span><span class="op" id="6318130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6318133">if</span>&nbsp;<span class="ident" id="6318136">dc</span><span class="op" id="6318138">.</span><span class="ident" id="6318139">closed</span>&nbsp;<span class="op" id="6318146">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6318150">dc</span><span class="op" id="6318152">.</span><span class="ident" id="6318153">Unlock</span><span class="op" id="6318159">(</span><span class="op" id="6318160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6318164">return</span>&nbsp;<span class="ident" id="6318171">errors</span><span class="op" id="6318177">.</span><span class="ident" id="6318178">New</span><span class="op" id="6318181">(</span><span class="string" id="6318182">&#34;sql:&nbsp;duplicate&nbsp;driverConn&nbsp;close&#34;</span><span class="op" id="6318215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6318218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6318221">dc</span><span class="op" id="6318223">.</span><span class="ident" id="6318224">closed</span>&nbsp;<span class="op" id="6318231">=</span>&nbsp;<span class="builtintype" id="6318233">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6318239">dc</span><span class="op" id="6318241">.</span><span class="ident" id="6318242">Unlock</span><span class="op" id="6318248">(</span><span class="op" id="6318249">)</span>&nbsp;<span class="comment" id="6318251">//&nbsp;not&nbsp;defer;&nbsp;removeDep&nbsp;finalClose&nbsp;calls&nbsp;may&nbsp;need&nbsp;to&nbsp;lock</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6318311">//&nbsp;And&nbsp;now&nbsp;updates&nbsp;that&nbsp;require&nbsp;holding&nbsp;dc.mu.Lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6318364">dc</span><span class="op" id="6318366">.</span><span class="ident" id="6318367">db</span><span class="op" id="6318369">.</span><span class="ident" id="6318370">mu</span><span class="op" id="6318372">.</span><span class="ident" id="6318373">Lock</span><span class="op" id="6318377">(</span><span class="op" id="6318378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6318381">dc</span><span class="op" id="6318383">.</span><span class="ident" id="6318384">dbmuClosed</span>&nbsp;<span class="op" id="6318395">=</span>&nbsp;<span class="builtintype" id="6318397">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6318403">fn</span>&nbsp;<span class="op" id="6318406">:=</span>&nbsp;<span class="ident" id="6318409">dc</span><span class="op" id="6318411">.</span><span class="ident" id="6318412">db</span><span class="op" id="6318414">.</span><span class="ident" id="6318415">removeDepLocked</span><span class="op" id="6318430">(</span><span class="ident" id="6318431">dc</span><span class="op" id="6318433">,</span>&nbsp;<span class="ident" id="6318435">dc</span><span class="op" id="6318437">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6318440">dc</span><span class="op" id="6318442">.</span><span class="ident" id="6318443">db</span><span class="op" id="6318445">.</span><span class="ident" id="6318446">mu</span><span class="op" id="6318448">.</span><span class="ident" id="6318449">Unlock</span><span class="op" id="6318455">(</span><span class="op" id="6318456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6318459">return</span>&nbsp;<span class="ident" id="6318466">fn</span><span class="op" id="6318468">(</span><span class="op" id="6318469">)</span><br>
<span class="lineno"></span><span class="op" id="6318471">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6318474">func</span>&nbsp;<span class="op" id="6318479">(</span><span class="ident" id="6318480">dc</span>&nbsp;<span class="op" id="6318483">*</span><span class="ident" id="6318484">driverConn</span><span class="op" id="6318494">)</span>&nbsp;<span class="ident" id="6318496">finalClose</span><span class="op" id="6318506">(</span><span class="op" id="6318507">)</span>&nbsp;<span class="builtintype" id="6318509">error</span>&nbsp;<span class="op" id="6318515">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6318518">dc</span><span class="op" id="6318520">.</span><span class="ident" id="6318521">Lock</span><span class="op" id="6318525">(</span><span class="op" id="6318526">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6318530">for</span>&nbsp;<span class="ident" id="6318534">si</span>&nbsp;<span class="op" id="6318537">:=</span>&nbsp;<span class="keyword" id="6318540">range</span>&nbsp;<span class="ident" id="6318546">dc</span><span class="op" id="6318548">.</span><span class="ident" id="6318549">openStmt</span>&nbsp;<span class="op" id="6318558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6318562">si</span><span class="op" id="6318564">.</span><span class="ident" id="6318565">Close</span><span class="op" id="6318570">(</span><span class="op" id="6318571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6318574">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6318577">dc</span><span class="op" id="6318579">.</span><span class="ident" id="6318580">openStmt</span>&nbsp;<span class="op" id="6318589">=</span>&nbsp;<span class="builtintype" id="6318591">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6318597">err</span>&nbsp;<span class="op" id="6318601">:=</span>&nbsp;<span class="ident" id="6318604">dc</span><span class="op" id="6318606">.</span><span class="ident" id="6318607">ci</span><span class="op" id="6318609">.</span><span class="ident" id="6318610">Close</span><span class="op" id="6318615">(</span><span class="op" id="6318616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6318619">dc</span><span class="op" id="6318621">.</span><span class="ident" id="6318622">ci</span>&nbsp;<span class="op" id="6318625">=</span>&nbsp;<span class="builtintype" id="6318627">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6318632">dc</span><span class="op" id="6318634">.</span><span class="ident" id="6318635">finalClosed</span>&nbsp;<span class="op" id="6318647">=</span>&nbsp;<span class="builtintype" id="6318649">true</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6318655">dc</span><span class="op" id="6318657">.</span><span class="ident" id="6318658">Unlock</span><span class="op" id="6318664">(</span><span class="op" id="6318665">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6318669">dc</span><span class="op" id="6318671">.</span><span class="ident" id="6318672">db</span><span class="op" id="6318674">.</span><span class="ident" id="6318675">mu</span><span class="op" id="6318677">.</span><span class="ident" id="6318678">Lock</span><span class="op" id="6318682">(</span><span class="op" id="6318683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6318686">dc</span><span class="op" id="6318688">.</span><span class="ident" id="6318689">db</span><span class="op" id="6318691">.</span><span class="ident" id="6318692">numOpen</span><span class="op" id="6318699">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6318703">dc</span><span class="op" id="6318705">.</span><span class="ident" id="6318706">db</span><span class="op" id="6318708">.</span><span class="ident" id="6318709">maybeOpenNewConnections</span><span class="op" id="6318732">(</span><span class="op" id="6318733">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6318736">dc</span><span class="op" id="6318738">.</span><span class="ident" id="6318739">db</span><span class="op" id="6318741">.</span><span class="ident" id="6318742">mu</span><span class="op" id="6318744">.</span><span class="ident" id="6318745">Unlock</span><span class="op" id="6318751">(</span><span class="op" id="6318752">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6318756">return</span>&nbsp;<span class="ident" id="6318763">err</span><br>
<span class="lineno"></span><span class="op" id="6318767">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span><span class="comment" id="6318770">//&nbsp;driverStmt&nbsp;associates&nbsp;a&nbsp;driver.Stmt&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6318818">//&nbsp;*driverConn&nbsp;from&nbsp;which&nbsp;it&nbsp;came,&nbsp;so&nbsp;the&nbsp;driverConn&#39;s&nbsp;lock&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6318885">//&nbsp;held&nbsp;during&nbsp;calls.</span><br>
<span class="lineno"></span><span class="keyword" id="6318907">type</span>&nbsp;<span class="ident" id="6318912">driverStmt</span>&nbsp;<span class="keyword" id="6318923">struct</span>&nbsp;<span class="op" id="6318930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6318933">sync</span><span class="op" id="6318937">.</span><span class="ident" id="6318938">Locker</span>&nbsp;<span class="comment" id="6318945">//&nbsp;the&nbsp;*driverConn</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6318965">si</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6318977">driver</span><span class="op" id="6318983">.</span><span class="ident" id="6318984">Stmt</span><br>
<span class="lineno"></span><span class="op" id="6318989">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6318992">func</span>&nbsp;<span class="op" id="6318997">(</span><span class="ident" id="6318998">ds</span>&nbsp;<span class="op" id="6319001">*</span><span class="ident" id="6319002">driverStmt</span><span class="op" id="6319012">)</span>&nbsp;<span class="ident" id="6319014">Close</span><span class="op" id="6319019">(</span><span class="op" id="6319020">)</span>&nbsp;<span class="builtintype" id="6319022">error</span>&nbsp;<span class="op" id="6319028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6319031">ds</span><span class="op" id="6319033">.</span><span class="ident" id="6319034">Lock</span><span class="op" id="6319038">(</span><span class="op" id="6319039">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6319042">defer</span>&nbsp;<span class="ident" id="6319048">ds</span><span class="op" id="6319050">.</span><span class="ident" id="6319051">Unlock</span><span class="op" id="6319057">(</span><span class="op" id="6319058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6319061">return</span>&nbsp;<span class="ident" id="6319068">ds</span><span class="op" id="6319070">.</span><span class="ident" id="6319071">si</span><span class="op" id="6319073">.</span><span class="ident" id="6319074">Close</span><span class="op" id="6319079">(</span><span class="op" id="6319080">)</span><br>
<span class="lineno"></span><span class="op" id="6319082">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6319085">//&nbsp;depSet&nbsp;is&nbsp;a&nbsp;finalCloser&#39;s&nbsp;outstanding&nbsp;dependencies</span><br>
<span class="lineno">350</span><span class="keyword" id="6319139">type</span>&nbsp;<span class="ident" id="6319144">depSet</span>&nbsp;<span class="keyword" id="6319151">map</span><span class="op" id="6319154">[</span><span class="keyword" id="6319155">interface</span><span class="op" id="6319164">{</span><span class="op" id="6319165">}</span><span class="op" id="6319166">]</span><span class="builtintype" id="6319167">bool</span>&nbsp;<span class="comment" id="6319172">//&nbsp;set&nbsp;of&nbsp;true&nbsp;bools</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6319194">//&nbsp;The&nbsp;finalCloser&nbsp;interface&nbsp;is&nbsp;used&nbsp;by&nbsp;(*DB).addDep&nbsp;and&nbsp;related</span><br>
<span class="lineno"></span><span class="comment" id="6319259">//&nbsp;dependency&nbsp;reference&nbsp;counting.</span><br>
<span class="lineno"></span><span class="keyword" id="6319293">type</span>&nbsp;<span class="ident" id="6319298">finalCloser</span>&nbsp;<span class="keyword" id="6319310">interface</span>&nbsp;<span class="op" id="6319320">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6319323">//&nbsp;finalClose&nbsp;is&nbsp;called&nbsp;when&nbsp;the&nbsp;reference&nbsp;count&nbsp;of&nbsp;an&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6319386">//&nbsp;goes&nbsp;to&nbsp;zero.&nbsp;(*DB).mu&nbsp;is&nbsp;not&nbsp;held&nbsp;while&nbsp;calling&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6319443">finalClose</span><span class="op" id="6319453">(</span><span class="op" id="6319454">)</span>&nbsp;<span class="builtintype" id="6319456">error</span><br>
<span class="lineno"></span><span class="op" id="6319462">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span><span class="comment" id="6319465">//&nbsp;addDep&nbsp;notes&nbsp;that&nbsp;x&nbsp;now&nbsp;depends&nbsp;on&nbsp;dep,&nbsp;and&nbsp;x&#39;s&nbsp;finalClose&nbsp;won&#39;t&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6319536">//&nbsp;called&nbsp;until&nbsp;all&nbsp;of&nbsp;x&#39;s&nbsp;dependencies&nbsp;are&nbsp;removed&nbsp;with&nbsp;removeDep.</span><br>
<span class="lineno"></span><span class="keyword" id="6319604">func</span>&nbsp;<span class="op" id="6319609">(</span><span class="ident" id="6319610">db</span>&nbsp;<span class="op" id="6319613">*</span><span class="ident" id="6319614">DB</span><span class="op" id="6319616">)</span>&nbsp;<span class="ident" id="6319618">addDep</span><span class="op" id="6319624">(</span><span class="ident" id="6319625">x</span>&nbsp;<span class="ident" id="6319627">finalCloser</span><span class="op" id="6319638">,</span>&nbsp;<span class="ident" id="6319640">dep</span>&nbsp;<span class="keyword" id="6319644">interface</span><span class="op" id="6319653">{</span><span class="op" id="6319654">}</span><span class="op" id="6319655">)</span>&nbsp;<span class="op" id="6319657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6319660">//println(fmt.Sprintf(&#34;addDep(%T&nbsp;%p,&nbsp;%T&nbsp;%p)&#34;,&nbsp;x,&nbsp;x,&nbsp;dep,&nbsp;dep))</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6319724">db</span><span class="op" id="6319726">.</span><span class="ident" id="6319727">mu</span><span class="op" id="6319729">.</span><span class="ident" id="6319730">Lock</span><span class="op" id="6319734">(</span><span class="op" id="6319735">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6319738">defer</span>&nbsp;<span class="ident" id="6319744">db</span><span class="op" id="6319746">.</span><span class="ident" id="6319747">mu</span><span class="op" id="6319749">.</span><span class="ident" id="6319750">Unlock</span><span class="op" id="6319756">(</span><span class="op" id="6319757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6319760">db</span><span class="op" id="6319762">.</span><span class="ident" id="6319763">addDepLocked</span><span class="op" id="6319775">(</span><span class="ident" id="6319776">x</span><span class="op" id="6319777">,</span>&nbsp;<span class="ident" id="6319779">dep</span><span class="op" id="6319782">)</span><br>
<span class="lineno"></span><span class="op" id="6319784">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6319787">func</span>&nbsp;<span class="op" id="6319792">(</span><span class="ident" id="6319793">db</span>&nbsp;<span class="op" id="6319796">*</span><span class="ident" id="6319797">DB</span><span class="op" id="6319799">)</span>&nbsp;<span class="ident" id="6319801">addDepLocked</span><span class="op" id="6319813">(</span><span class="ident" id="6319814">x</span>&nbsp;<span class="ident" id="6319816">finalCloser</span><span class="op" id="6319827">,</span>&nbsp;<span class="ident" id="6319829">dep</span>&nbsp;<span class="keyword" id="6319833">interface</span><span class="op" id="6319842">{</span><span class="op" id="6319843">}</span><span class="op" id="6319844">)</span>&nbsp;<span class="op" id="6319846">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6319849">if</span>&nbsp;<span class="ident" id="6319852">db</span><span class="op" id="6319854">.</span><span class="ident" id="6319855">dep</span>&nbsp;<span class="op" id="6319859">==</span>&nbsp;<span class="builtintype" id="6319862">nil</span>&nbsp;<span class="op" id="6319866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6319870">db</span><span class="op" id="6319872">.</span><span class="ident" id="6319873">dep</span>&nbsp;<span class="op" id="6319877">=</span>&nbsp;<span class="builtinfunc" id="6319879">make</span><span class="op" id="6319883">(</span><span class="keyword" id="6319884">map</span><span class="op" id="6319887">[</span><span class="ident" id="6319888">finalCloser</span><span class="op" id="6319899">]</span><span class="ident" id="6319900">depSet</span><span class="op" id="6319906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6319909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6319912">xdep</span>&nbsp;<span class="op" id="6319917">:=</span>&nbsp;<span class="ident" id="6319920">db</span><span class="op" id="6319922">.</span><span class="ident" id="6319923">dep</span><span class="op" id="6319926">[</span><span class="ident" id="6319927">x</span><span class="op" id="6319928">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6319931">if</span>&nbsp;<span class="ident" id="6319934">xdep</span>&nbsp;<span class="op" id="6319939">==</span>&nbsp;<span class="builtintype" id="6319942">nil</span>&nbsp;<span class="op" id="6319946">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6319950">xdep</span>&nbsp;<span class="op" id="6319955">=</span>&nbsp;<span class="builtinfunc" id="6319957">make</span><span class="op" id="6319961">(</span><span class="ident" id="6319962">depSet</span><span class="op" id="6319968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6319972">db</span><span class="op" id="6319974">.</span><span class="ident" id="6319975">dep</span><span class="op" id="6319978">[</span><span class="ident" id="6319979">x</span><span class="op" id="6319980">]</span>&nbsp;<span class="op" id="6319982">=</span>&nbsp;<span class="ident" id="6319984">xdep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6319990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6319993">xdep</span><span class="op" id="6319997">[</span><span class="ident" id="6319998">dep</span><span class="op" id="6320001">]</span>&nbsp;<span class="op" id="6320003">=</span>&nbsp;<span class="builtintype" id="6320005">true</span><br>
<span class="lineno"></span><span class="op" id="6320010">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span><span class="comment" id="6320013">//&nbsp;removeDep&nbsp;notes&nbsp;that&nbsp;x&nbsp;no&nbsp;longer&nbsp;depends&nbsp;on&nbsp;dep.</span><br>
<span class="lineno"></span><span class="comment" id="6320065">//&nbsp;If&nbsp;x&nbsp;still&nbsp;has&nbsp;dependencies,&nbsp;nil&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="comment" id="6320114">//&nbsp;If&nbsp;x&nbsp;no&nbsp;longer&nbsp;has&nbsp;any&nbsp;dependencies,&nbsp;its&nbsp;finalClose&nbsp;method&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6320184">//&nbsp;called&nbsp;and&nbsp;its&nbsp;error&nbsp;value&nbsp;will&nbsp;be&nbsp;returned.</span><br>
<span class="lineno">385</span><span class="keyword" id="6320232">func</span>&nbsp;<span class="op" id="6320237">(</span><span class="ident" id="6320238">db</span>&nbsp;<span class="op" id="6320241">*</span><span class="ident" id="6320242">DB</span><span class="op" id="6320244">)</span>&nbsp;<span class="ident" id="6320246">removeDep</span><span class="op" id="6320255">(</span><span class="ident" id="6320256">x</span>&nbsp;<span class="ident" id="6320258">finalCloser</span><span class="op" id="6320269">,</span>&nbsp;<span class="ident" id="6320271">dep</span>&nbsp;<span class="keyword" id="6320275">interface</span><span class="op" id="6320284">{</span><span class="op" id="6320285">}</span><span class="op" id="6320286">)</span>&nbsp;<span class="builtintype" id="6320288">error</span>&nbsp;<span class="op" id="6320294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6320297">db</span><span class="op" id="6320299">.</span><span class="ident" id="6320300">mu</span><span class="op" id="6320302">.</span><span class="ident" id="6320303">Lock</span><span class="op" id="6320307">(</span><span class="op" id="6320308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6320311">fn</span>&nbsp;<span class="op" id="6320314">:=</span>&nbsp;<span class="ident" id="6320317">db</span><span class="op" id="6320319">.</span><span class="ident" id="6320320">removeDepLocked</span><span class="op" id="6320335">(</span><span class="ident" id="6320336">x</span><span class="op" id="6320337">,</span>&nbsp;<span class="ident" id="6320339">dep</span><span class="op" id="6320342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6320345">db</span><span class="op" id="6320347">.</span><span class="ident" id="6320348">mu</span><span class="op" id="6320350">.</span><span class="ident" id="6320351">Unlock</span><span class="op" id="6320357">(</span><span class="op" id="6320358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6320361">return</span>&nbsp;<span class="ident" id="6320368">fn</span><span class="op" id="6320370">(</span><span class="op" id="6320371">)</span><br>
<span class="lineno">390</span><span class="op" id="6320373">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6320376">func</span>&nbsp;<span class="op" id="6320381">(</span><span class="ident" id="6320382">db</span>&nbsp;<span class="op" id="6320385">*</span><span class="ident" id="6320386">DB</span><span class="op" id="6320388">)</span>&nbsp;<span class="ident" id="6320390">removeDepLocked</span><span class="op" id="6320405">(</span><span class="ident" id="6320406">x</span>&nbsp;<span class="ident" id="6320408">finalCloser</span><span class="op" id="6320419">,</span>&nbsp;<span class="ident" id="6320421">dep</span>&nbsp;<span class="keyword" id="6320425">interface</span><span class="op" id="6320434">{</span><span class="op" id="6320435">}</span><span class="op" id="6320436">)</span>&nbsp;<span class="keyword" id="6320438">func</span><span class="op" id="6320442">(</span><span class="op" id="6320443">)</span>&nbsp;<span class="builtintype" id="6320445">error</span>&nbsp;<span class="op" id="6320451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6320454">//println(fmt.Sprintf(&#34;removeDep(%T&nbsp;%p,&nbsp;%T&nbsp;%p)&#34;,&nbsp;x,&nbsp;x,&nbsp;dep,&nbsp;dep))</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6320522">xdep</span><span class="op" id="6320526">,</span>&nbsp;<span class="ident" id="6320528">ok</span>&nbsp;<span class="op" id="6320531">:=</span>&nbsp;<span class="ident" id="6320534">db</span><span class="op" id="6320536">.</span><span class="ident" id="6320537">dep</span><span class="op" id="6320540">[</span><span class="ident" id="6320541">x</span><span class="op" id="6320542">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6320545">if</span>&nbsp;<span class="op" id="6320548">!</span><span class="ident" id="6320549">ok</span>&nbsp;<span class="op" id="6320552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6320556">panic</span><span class="op" id="6320561">(</span><span class="ident" id="6320562">fmt</span><span class="op" id="6320565">.</span><span class="ident" id="6320566">Sprintf</span><span class="op" id="6320573">(</span><span class="string" id="6320574">&#34;unpaired&nbsp;removeDep:&nbsp;no&nbsp;deps&nbsp;for&nbsp;%T&#34;</span><span class="op" id="6320610">,</span>&nbsp;<span class="ident" id="6320612">x</span><span class="op" id="6320613">)</span><span class="op" id="6320614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6320617">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6320621">l0</span>&nbsp;<span class="op" id="6320624">:=</span>&nbsp;<span class="builtinfunc" id="6320627">len</span><span class="op" id="6320630">(</span><span class="ident" id="6320631">xdep</span><span class="op" id="6320635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6320638">delete</span><span class="op" id="6320644">(</span><span class="ident" id="6320645">xdep</span><span class="op" id="6320649">,</span>&nbsp;<span class="ident" id="6320651">dep</span><span class="op" id="6320654">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6320658">switch</span>&nbsp;<span class="builtinfunc" id="6320665">len</span><span class="op" id="6320668">(</span><span class="ident" id="6320669">xdep</span><span class="op" id="6320673">)</span>&nbsp;<span class="op" id="6320675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6320678">case</span>&nbsp;<span class="ident" id="6320683">l0</span><span class="op" id="6320685">:</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6320689">//&nbsp;Nothing&nbsp;removed.&nbsp;Shouldn&#39;t&nbsp;happen.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6320729">panic</span><span class="op" id="6320734">(</span><span class="ident" id="6320735">fmt</span><span class="op" id="6320738">.</span><span class="ident" id="6320739">Sprintf</span><span class="op" id="6320746">(</span><span class="string" id="6320747">&#34;unpaired&nbsp;removeDep:&nbsp;no&nbsp;%T&nbsp;dep&nbsp;on&nbsp;%T&#34;</span><span class="op" id="6320784">,</span>&nbsp;<span class="ident" id="6320786">dep</span><span class="op" id="6320789">,</span>&nbsp;<span class="ident" id="6320791">x</span><span class="op" id="6320792">)</span><span class="op" id="6320793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6320796">case</span>&nbsp;<span class="num" id="6320801">0</span><span class="op" id="6320802">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6320806">//&nbsp;No&nbsp;more&nbsp;dependencies.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6320833">delete</span><span class="op" id="6320839">(</span><span class="ident" id="6320840">db</span><span class="op" id="6320842">.</span><span class="ident" id="6320843">dep</span><span class="op" id="6320846">,</span>&nbsp;<span class="ident" id="6320848">x</span><span class="op" id="6320849">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6320853">return</span>&nbsp;<span class="ident" id="6320860">x</span><span class="op" id="6320861">.</span><span class="ident" id="6320862">finalClose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6320874">default</span><span class="op" id="6320881">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6320885">//&nbsp;Dependencies&nbsp;remain.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6320911">return</span>&nbsp;<span class="keyword" id="6320918">func</span><span class="op" id="6320922">(</span><span class="op" id="6320923">)</span>&nbsp;<span class="builtintype" id="6320925">error</span>&nbsp;<span class="op" id="6320931">{</span>&nbsp;<span class="keyword" id="6320933">return</span>&nbsp;<span class="builtintype" id="6320940">nil</span>&nbsp;<span class="op" id="6320944">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6320947">}</span><br>
<span class="lineno">415</span><span class="op" id="6320949">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6320952">//&nbsp;This&nbsp;is&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;connectionOpener&nbsp;request&nbsp;chan&nbsp;(dn.openerCh).</span><br>
<span class="lineno"></span><span class="comment" id="6321024">//&nbsp;This&nbsp;value&nbsp;should&nbsp;be&nbsp;larger&nbsp;than&nbsp;the&nbsp;maximum&nbsp;typical&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="6321086">//&nbsp;used&nbsp;for&nbsp;db.maxOpen.&nbsp;If&nbsp;maxOpen&nbsp;is&nbsp;significantly&nbsp;larger&nbsp;than</span><br>
<span class="lineno">420</span><span class="comment" id="6321150">//&nbsp;connectionRequestQueueSize&nbsp;then&nbsp;it&nbsp;is&nbsp;possible&nbsp;for&nbsp;ALL&nbsp;calls&nbsp;into&nbsp;the&nbsp;*DB</span><br>
<span class="lineno"></span><span class="comment" id="6321227">//&nbsp;to&nbsp;block&nbsp;until&nbsp;the&nbsp;connectionOpener&nbsp;can&nbsp;satisfy&nbsp;the&nbsp;backlog&nbsp;of&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="6321303">var</span>&nbsp;<span class="ident" id="6321307">connectionRequestQueueSize</span>&nbsp;<span class="op" id="6321334">=</span>&nbsp;<span class="num" id="6321336">1000000</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6321345">//&nbsp;Open&nbsp;opens&nbsp;a&nbsp;database&nbsp;specified&nbsp;by&nbsp;its&nbsp;database&nbsp;driver&nbsp;name&nbsp;and&nbsp;a</span><br>
<span class="lineno">425</span><span class="comment" id="6321414">//&nbsp;driver-specific&nbsp;data&nbsp;source&nbsp;name,&nbsp;usually&nbsp;consisting&nbsp;of&nbsp;at&nbsp;least&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="6321484">//&nbsp;database&nbsp;name&nbsp;and&nbsp;connection&nbsp;information.</span><br>
<span class="lineno"></span><span class="comment" id="6321529">//</span><br>
<span class="lineno"></span><span class="comment" id="6321532">//&nbsp;Most&nbsp;users&nbsp;will&nbsp;open&nbsp;a&nbsp;database&nbsp;via&nbsp;a&nbsp;driver-specific&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="6321600">//&nbsp;helper&nbsp;function&nbsp;that&nbsp;returns&nbsp;a&nbsp;*DB.&nbsp;No&nbsp;database&nbsp;drivers&nbsp;are&nbsp;included</span><br>
<span class="lineno">430</span><span class="comment" id="6321672">//&nbsp;in&nbsp;the&nbsp;Go&nbsp;standard&nbsp;library.&nbsp;See&nbsp;http://golang.org/s/sqldrivers&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="6321742">//&nbsp;a&nbsp;list&nbsp;of&nbsp;third-party&nbsp;drivers.</span><br>
<span class="lineno"></span><span class="comment" id="6321776">//</span><br>
<span class="lineno"></span><span class="comment" id="6321779">//&nbsp;Open&nbsp;may&nbsp;just&nbsp;validate&nbsp;its&nbsp;arguments&nbsp;without&nbsp;creating&nbsp;a&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="6321849">//&nbsp;to&nbsp;the&nbsp;database.&nbsp;To&nbsp;verify&nbsp;that&nbsp;the&nbsp;data&nbsp;source&nbsp;name&nbsp;is&nbsp;valid,&nbsp;call</span><br>
<span class="lineno">435</span><span class="comment" id="6321920">//&nbsp;Ping.</span><br>
<span class="lineno"></span><span class="comment" id="6321929">//</span><br>
<span class="lineno"></span><span class="comment" id="6321932">//&nbsp;The&nbsp;returned&nbsp;DB&nbsp;is&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="6322001">//&nbsp;and&nbsp;maintains&nbsp;its&nbsp;own&nbsp;pool&nbsp;of&nbsp;idle&nbsp;connections.&nbsp;Thus,&nbsp;the&nbsp;Open</span><br>
<span class="lineno"></span><span class="comment" id="6322067">//&nbsp;function&nbsp;should&nbsp;be&nbsp;called&nbsp;just&nbsp;once.&nbsp;It&nbsp;is&nbsp;rarely&nbsp;necessary&nbsp;to</span><br>
<span class="lineno">440</span><span class="comment" id="6322133">//&nbsp;close&nbsp;a&nbsp;DB.</span><br>
<span class="lineno"></span><span class="keyword" id="6322148">func</span>&nbsp;<span class="ident" id="6322153">Open</span><span class="op" id="6322157">(</span><span class="ident" id="6322158">driverName</span><span class="op" id="6322168">,</span>&nbsp;<span class="ident" id="6322170">dataSourceName</span>&nbsp;<span class="builtintype" id="6322185">string</span><span class="op" id="6322191">)</span>&nbsp;<span class="op" id="6322193">(</span><span class="op" id="6322194">*</span><span class="ident" id="6322195">DB</span><span class="op" id="6322197">,</span>&nbsp;<span class="builtintype" id="6322199">error</span><span class="op" id="6322204">)</span>&nbsp;<span class="op" id="6322206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6322209">driveri</span><span class="op" id="6322216">,</span>&nbsp;<span class="ident" id="6322218">ok</span>&nbsp;<span class="op" id="6322221">:=</span>&nbsp;<span class="ident" id="6322224">drivers</span><span class="op" id="6322231">[</span><span class="ident" id="6322232">driverName</span><span class="op" id="6322242">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6322245">if</span>&nbsp;<span class="op" id="6322248">!</span><span class="ident" id="6322249">ok</span>&nbsp;<span class="op" id="6322252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6322256">return</span>&nbsp;<span class="builtintype" id="6322263">nil</span><span class="op" id="6322266">,</span>&nbsp;<span class="ident" id="6322268">fmt</span><span class="op" id="6322271">.</span><span class="ident" id="6322272">Errorf</span><span class="op" id="6322278">(</span><span class="string" id="6322279">&#34;sql:&nbsp;unknown&nbsp;driver&nbsp;%q&nbsp;(forgotten&nbsp;import?)&#34;</span><span class="op" id="6322323">,</span>&nbsp;<span class="ident" id="6322325">driverName</span><span class="op" id="6322335">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6322338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6322341">db</span>&nbsp;<span class="op" id="6322344">:=</span>&nbsp;<span class="op" id="6322347">&amp;</span><span class="ident" id="6322348">DB</span><span class="op" id="6322350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6322354">driver</span><span class="op" id="6322360">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6322364">driveri</span><span class="op" id="6322371">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6322375">dsn</span><span class="op" id="6322378">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6322385">dataSourceName</span><span class="op" id="6322399">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6322403">openerCh</span><span class="op" id="6322411">:</span>&nbsp;<span class="builtinfunc" id="6322413">make</span><span class="op" id="6322417">(</span><span class="keyword" id="6322418">chan</span>&nbsp;<span class="keyword" id="6322423">struct</span><span class="op" id="6322429">{</span><span class="op" id="6322430">}</span><span class="op" id="6322431">,</span>&nbsp;<span class="ident" id="6322433">connectionRequestQueueSize</span><span class="op" id="6322459">)</span><span class="op" id="6322460">,</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6322464">lastPut</span><span class="op" id="6322471">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="6322474">make</span><span class="op" id="6322478">(</span><span class="keyword" id="6322479">map</span><span class="op" id="6322482">[</span><span class="op" id="6322483">*</span><span class="ident" id="6322484">driverConn</span><span class="op" id="6322494">]</span><span class="builtintype" id="6322495">string</span><span class="op" id="6322501">)</span><span class="op" id="6322502">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6322505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6322508">go</span>&nbsp;<span class="ident" id="6322511">db</span><span class="op" id="6322513">.</span><span class="ident" id="6322514">connectionOpener</span><span class="op" id="6322530">(</span><span class="op" id="6322531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6322534">return</span>&nbsp;<span class="ident" id="6322541">db</span><span class="op" id="6322543">,</span>&nbsp;<span class="builtintype" id="6322545">nil</span><br>
<span class="lineno"></span><span class="op" id="6322549">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span><span class="comment" id="6322552">//&nbsp;Ping&nbsp;verifies&nbsp;a&nbsp;connection&nbsp;to&nbsp;the&nbsp;database&nbsp;is&nbsp;still&nbsp;alive,</span><br>
<span class="lineno"></span><span class="comment" id="6322614">//&nbsp;establishing&nbsp;a&nbsp;connection&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="6322657">func</span>&nbsp;<span class="op" id="6322662">(</span><span class="ident" id="6322663">db</span>&nbsp;<span class="op" id="6322666">*</span><span class="ident" id="6322667">DB</span><span class="op" id="6322669">)</span>&nbsp;<span class="ident" id="6322671">Ping</span><span class="op" id="6322675">(</span><span class="op" id="6322676">)</span>&nbsp;<span class="builtintype" id="6322678">error</span>&nbsp;<span class="op" id="6322684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6322687">//&nbsp;TODO(bradfitz):&nbsp;give&nbsp;drivers&nbsp;an&nbsp;optional&nbsp;hook&nbsp;to&nbsp;implement</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6322750">//&nbsp;this&nbsp;in&nbsp;a&nbsp;more&nbsp;efficient&nbsp;or&nbsp;more&nbsp;reliable&nbsp;way,&nbsp;if&nbsp;they</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6322809">//&nbsp;have&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6322823">dc</span><span class="op" id="6322825">,</span>&nbsp;<span class="ident" id="6322827">err</span>&nbsp;<span class="op" id="6322831">:=</span>&nbsp;<span class="ident" id="6322834">db</span><span class="op" id="6322836">.</span><span class="ident" id="6322837">conn</span><span class="op" id="6322841">(</span><span class="op" id="6322842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6322845">if</span>&nbsp;<span class="ident" id="6322848">err</span>&nbsp;<span class="op" id="6322852">!=</span>&nbsp;<span class="builtintype" id="6322855">nil</span>&nbsp;<span class="op" id="6322859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6322863">return</span>&nbsp;<span class="ident" id="6322870">err</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6322875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6322878">db</span><span class="op" id="6322880">.</span><span class="ident" id="6322881">putConn</span><span class="op" id="6322888">(</span><span class="ident" id="6322889">dc</span><span class="op" id="6322891">,</span>&nbsp;<span class="builtintype" id="6322893">nil</span><span class="op" id="6322896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6322899">return</span>&nbsp;<span class="builtintype" id="6322906">nil</span><br>
<span class="lineno"></span><span class="op" id="6322910">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">470</span><span class="comment" id="6322913">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;database,&nbsp;releasing&nbsp;any&nbsp;open&nbsp;resources.</span><br>
<span class="lineno"></span><span class="comment" id="6322973">//</span><br>
<span class="lineno"></span><span class="comment" id="6322976">//&nbsp;It&nbsp;is&nbsp;rare&nbsp;to&nbsp;Close&nbsp;a&nbsp;DB,&nbsp;as&nbsp;the&nbsp;DB&nbsp;handle&nbsp;is&nbsp;meant&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6323037">//&nbsp;long-lived&nbsp;and&nbsp;shared&nbsp;between&nbsp;many&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="6323087">func</span>&nbsp;<span class="op" id="6323092">(</span><span class="ident" id="6323093">db</span>&nbsp;<span class="op" id="6323096">*</span><span class="ident" id="6323097">DB</span><span class="op" id="6323099">)</span>&nbsp;<span class="ident" id="6323101">Close</span><span class="op" id="6323106">(</span><span class="op" id="6323107">)</span>&nbsp;<span class="builtintype" id="6323109">error</span>&nbsp;<span class="op" id="6323115">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6323118">db</span><span class="op" id="6323120">.</span><span class="ident" id="6323121">mu</span><span class="op" id="6323123">.</span><span class="ident" id="6323124">Lock</span><span class="op" id="6323128">(</span><span class="op" id="6323129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6323132">if</span>&nbsp;<span class="ident" id="6323135">db</span><span class="op" id="6323137">.</span><span class="ident" id="6323138">closed</span>&nbsp;<span class="op" id="6323145">{</span>&nbsp;<span class="comment" id="6323147">//&nbsp;Make&nbsp;DB.Close&nbsp;idempotent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6323177">db</span><span class="op" id="6323179">.</span><span class="ident" id="6323180">mu</span><span class="op" id="6323182">.</span><span class="ident" id="6323183">Unlock</span><span class="op" id="6323189">(</span><span class="op" id="6323190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6323194">return</span>&nbsp;<span class="builtintype" id="6323201">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6323206">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6323209">close</span><span class="op" id="6323214">(</span><span class="ident" id="6323215">db</span><span class="op" id="6323217">.</span><span class="ident" id="6323218">openerCh</span><span class="op" id="6323226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6323229">var</span>&nbsp;<span class="ident" id="6323233">err</span>&nbsp;<span class="builtintype" id="6323237">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6323244">fns</span>&nbsp;<span class="op" id="6323248">:=</span>&nbsp;<span class="builtinfunc" id="6323251">make</span><span class="op" id="6323255">(</span><span class="op" id="6323256">[</span><span class="op" id="6323257">]</span><span class="keyword" id="6323258">func</span><span class="op" id="6323262">(</span><span class="op" id="6323263">)</span>&nbsp;<span class="builtintype" id="6323265">error</span><span class="op" id="6323270">,</span>&nbsp;<span class="num" id="6323272">0</span><span class="op" id="6323273">,</span>&nbsp;<span class="builtinfunc" id="6323275">len</span><span class="op" id="6323278">(</span><span class="ident" id="6323279">db</span><span class="op" id="6323281">.</span><span class="ident" id="6323282">freeConn</span><span class="op" id="6323290">)</span><span class="op" id="6323291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6323294">for</span>&nbsp;<span class="ident" id="6323298">_</span><span class="op" id="6323299">,</span>&nbsp;<span class="ident" id="6323301">dc</span>&nbsp;<span class="op" id="6323304">:=</span>&nbsp;<span class="keyword" id="6323307">range</span>&nbsp;<span class="ident" id="6323313">db</span><span class="op" id="6323315">.</span><span class="ident" id="6323316">freeConn</span>&nbsp;<span class="op" id="6323325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6323329">fns</span>&nbsp;<span class="op" id="6323333">=</span>&nbsp;<span class="builtinfunc" id="6323335">append</span><span class="op" id="6323341">(</span><span class="ident" id="6323342">fns</span><span class="op" id="6323345">,</span>&nbsp;<span class="ident" id="6323347">dc</span><span class="op" id="6323349">.</span><span class="ident" id="6323350">closeDBLocked</span><span class="op" id="6323363">(</span><span class="op" id="6323364">)</span><span class="op" id="6323365">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6323368">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6323371">db</span><span class="op" id="6323373">.</span><span class="ident" id="6323374">freeConn</span>&nbsp;<span class="op" id="6323383">=</span>&nbsp;<span class="builtintype" id="6323385">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6323390">db</span><span class="op" id="6323392">.</span><span class="ident" id="6323393">closed</span>&nbsp;<span class="op" id="6323400">=</span>&nbsp;<span class="builtintype" id="6323402">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6323408">for</span>&nbsp;<span class="ident" id="6323412">_</span><span class="op" id="6323413">,</span>&nbsp;<span class="ident" id="6323415">req</span>&nbsp;<span class="op" id="6323419">:=</span>&nbsp;<span class="keyword" id="6323422">range</span>&nbsp;<span class="ident" id="6323428">db</span><span class="op" id="6323430">.</span><span class="ident" id="6323431">connRequests</span>&nbsp;<span class="op" id="6323444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6323448">close</span><span class="op" id="6323453">(</span><span class="ident" id="6323454">req</span><span class="op" id="6323457">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6323460">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6323463">db</span><span class="op" id="6323465">.</span><span class="ident" id="6323466">mu</span><span class="op" id="6323468">.</span><span class="ident" id="6323469">Unlock</span><span class="op" id="6323475">(</span><span class="op" id="6323476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6323479">for</span>&nbsp;<span class="ident" id="6323483">_</span><span class="op" id="6323484">,</span>&nbsp;<span class="ident" id="6323486">fn</span>&nbsp;<span class="op" id="6323489">:=</span>&nbsp;<span class="keyword" id="6323492">range</span>&nbsp;<span class="ident" id="6323498">fns</span>&nbsp;<span class="op" id="6323502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6323506">err1</span>&nbsp;<span class="op" id="6323511">:=</span>&nbsp;<span class="ident" id="6323514">fn</span><span class="op" id="6323516">(</span><span class="op" id="6323517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6323521">if</span>&nbsp;<span class="ident" id="6323524">err1</span>&nbsp;<span class="op" id="6323529">!=</span>&nbsp;<span class="builtintype" id="6323532">nil</span>&nbsp;<span class="op" id="6323536">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6323541">err</span>&nbsp;<span class="op" id="6323545">=</span>&nbsp;<span class="ident" id="6323547">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6323554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6323557">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6323560">return</span>&nbsp;<span class="ident" id="6323567">err</span><br>
<span class="lineno"></span><span class="op" id="6323571">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="keyword" id="6323574">const</span>&nbsp;<span class="ident" id="6323580">defaultMaxIdleConns</span>&nbsp;<span class="op" id="6323600">=</span>&nbsp;<span class="num" id="6323602">2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6323605">func</span>&nbsp;<span class="op" id="6323610">(</span><span class="ident" id="6323611">db</span>&nbsp;<span class="op" id="6323614">*</span><span class="ident" id="6323615">DB</span><span class="op" id="6323617">)</span>&nbsp;<span class="ident" id="6323619">maxIdleConnsLocked</span><span class="op" id="6323637">(</span><span class="op" id="6323638">)</span>&nbsp;<span class="builtintype" id="6323640">int</span>&nbsp;<span class="op" id="6323644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6323647">n</span>&nbsp;<span class="op" id="6323649">:=</span>&nbsp;<span class="ident" id="6323652">db</span><span class="op" id="6323654">.</span><span class="ident" id="6323655">maxIdle</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6323664">switch</span>&nbsp;<span class="op" id="6323671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6323674">case</span>&nbsp;<span class="ident" id="6323679">n</span>&nbsp;<span class="op" id="6323681">==</span>&nbsp;<span class="num" id="6323684">0</span><span class="op" id="6323685">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6323689">//&nbsp;TODO(bradfitz):&nbsp;ask&nbsp;driver,&nbsp;if&nbsp;supported,&nbsp;for&nbsp;its&nbsp;default&nbsp;preference</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6323763">return</span>&nbsp;<span class="ident" id="6323770">defaultMaxIdleConns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6323791">case</span>&nbsp;<span class="ident" id="6323796">n</span>&nbsp;<span class="op" id="6323798">&lt;</span>&nbsp;<span class="num" id="6323800">0</span><span class="op" id="6323801">:</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6323805">return</span>&nbsp;<span class="num" id="6323812">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6323815">default</span><span class="op" id="6323822">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6323826">return</span>&nbsp;<span class="ident" id="6323833">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6323836">}</span><br>
<span class="lineno"></span><span class="op" id="6323838">}</span><br>
<span class="lineno">515</span><br>
<span class="lineno"></span><span class="comment" id="6323841">//&nbsp;SetMaxIdleConns&nbsp;sets&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;connections&nbsp;in&nbsp;the&nbsp;idle</span><br>
<span class="lineno"></span><span class="comment" id="6323911">//&nbsp;connection&nbsp;pool.</span><br>
<span class="lineno"></span><span class="comment" id="6323931">//</span><br>
<span class="lineno"></span><span class="comment" id="6323934">//&nbsp;If&nbsp;MaxOpenConns&nbsp;is&nbsp;greater&nbsp;than&nbsp;0&nbsp;but&nbsp;less&nbsp;than&nbsp;the&nbsp;new&nbsp;MaxIdleConns</span><br>
<span class="lineno">520</span><span class="comment" id="6324006">//&nbsp;then&nbsp;the&nbsp;new&nbsp;MaxIdleConns&nbsp;will&nbsp;be&nbsp;reduced&nbsp;to&nbsp;match&nbsp;the&nbsp;MaxOpenConns&nbsp;limit</span><br>
<span class="lineno"></span><span class="comment" id="6324083">//</span><br>
<span class="lineno"></span><span class="comment" id="6324086">//&nbsp;If&nbsp;n&nbsp;&lt;=&nbsp;0,&nbsp;no&nbsp;idle&nbsp;connections&nbsp;are&nbsp;retained.</span><br>
<span class="lineno"></span><span class="keyword" id="6324134">func</span>&nbsp;<span class="op" id="6324139">(</span><span class="ident" id="6324140">db</span>&nbsp;<span class="op" id="6324143">*</span><span class="ident" id="6324144">DB</span><span class="op" id="6324146">)</span>&nbsp;<span class="ident" id="6324148">SetMaxIdleConns</span><span class="op" id="6324163">(</span><span class="ident" id="6324164">n</span>&nbsp;<span class="builtintype" id="6324166">int</span><span class="op" id="6324169">)</span>&nbsp;<span class="op" id="6324171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324174">db</span><span class="op" id="6324176">.</span><span class="ident" id="6324177">mu</span><span class="op" id="6324179">.</span><span class="ident" id="6324180">Lock</span><span class="op" id="6324184">(</span><span class="op" id="6324185">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6324188">if</span>&nbsp;<span class="ident" id="6324191">n</span>&nbsp;<span class="op" id="6324193">&gt;</span>&nbsp;<span class="num" id="6324195">0</span>&nbsp;<span class="op" id="6324197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324201">db</span><span class="op" id="6324203">.</span><span class="ident" id="6324204">maxIdle</span>&nbsp;<span class="op" id="6324212">=</span>&nbsp;<span class="ident" id="6324214">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6324217">}</span>&nbsp;<span class="keyword" id="6324219">else</span>&nbsp;<span class="op" id="6324224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6324228">//&nbsp;No&nbsp;idle&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324254">db</span><span class="op" id="6324256">.</span><span class="ident" id="6324257">maxIdle</span>&nbsp;<span class="op" id="6324265">=</span>&nbsp;<span class="op" id="6324267">-</span><span class="num" id="6324268">1</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6324271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6324274">//&nbsp;Make&nbsp;sure&nbsp;maxIdle&nbsp;doesn&#39;t&nbsp;exceed&nbsp;maxOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6324319">if</span>&nbsp;<span class="ident" id="6324322">db</span><span class="op" id="6324324">.</span><span class="ident" id="6324325">maxOpen</span>&nbsp;<span class="op" id="6324333">&gt;</span>&nbsp;<span class="num" id="6324335">0</span>&nbsp;<span class="op" id="6324337">&amp;&amp;</span>&nbsp;<span class="ident" id="6324340">db</span><span class="op" id="6324342">.</span><span class="ident" id="6324343">maxIdleConnsLocked</span><span class="op" id="6324361">(</span><span class="op" id="6324362">)</span>&nbsp;<span class="op" id="6324364">&gt;</span>&nbsp;<span class="ident" id="6324366">db</span><span class="op" id="6324368">.</span><span class="ident" id="6324369">maxOpen</span>&nbsp;<span class="op" id="6324377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324381">db</span><span class="op" id="6324383">.</span><span class="ident" id="6324384">maxIdle</span>&nbsp;<span class="op" id="6324392">=</span>&nbsp;<span class="ident" id="6324394">db</span><span class="op" id="6324396">.</span><span class="ident" id="6324397">maxOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6324406">}</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6324409">var</span>&nbsp;<span class="ident" id="6324413">closing</span>&nbsp;<span class="op" id="6324421">[</span><span class="op" id="6324422">]</span><span class="op" id="6324423">*</span><span class="ident" id="6324424">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324436">idleCount</span>&nbsp;<span class="op" id="6324446">:=</span>&nbsp;<span class="builtinfunc" id="6324449">len</span><span class="op" id="6324452">(</span><span class="ident" id="6324453">db</span><span class="op" id="6324455">.</span><span class="ident" id="6324456">freeConn</span><span class="op" id="6324464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324467">maxIdle</span>&nbsp;<span class="op" id="6324475">:=</span>&nbsp;<span class="ident" id="6324478">db</span><span class="op" id="6324480">.</span><span class="ident" id="6324481">maxIdleConnsLocked</span><span class="op" id="6324499">(</span><span class="op" id="6324500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6324503">if</span>&nbsp;<span class="ident" id="6324506">idleCount</span>&nbsp;<span class="op" id="6324516">&gt;</span>&nbsp;<span class="ident" id="6324518">maxIdle</span>&nbsp;<span class="op" id="6324526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324530">closing</span>&nbsp;<span class="op" id="6324538">=</span>&nbsp;<span class="ident" id="6324540">db</span><span class="op" id="6324542">.</span><span class="ident" id="6324543">freeConn</span><span class="op" id="6324551">[</span><span class="ident" id="6324552">maxIdle</span><span class="op" id="6324559">:</span><span class="op" id="6324560">]</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324564">db</span><span class="op" id="6324566">.</span><span class="ident" id="6324567">freeConn</span>&nbsp;<span class="op" id="6324576">=</span>&nbsp;<span class="ident" id="6324578">db</span><span class="op" id="6324580">.</span><span class="ident" id="6324581">freeConn</span><span class="op" id="6324589">[</span><span class="op" id="6324590">:</span><span class="ident" id="6324591">maxIdle</span><span class="op" id="6324598">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6324601">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324604">db</span><span class="op" id="6324606">.</span><span class="ident" id="6324607">mu</span><span class="op" id="6324609">.</span><span class="ident" id="6324610">Unlock</span><span class="op" id="6324616">(</span><span class="op" id="6324617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6324620">for</span>&nbsp;<span class="ident" id="6324624">_</span><span class="op" id="6324625">,</span>&nbsp;<span class="ident" id="6324627">c</span>&nbsp;<span class="op" id="6324629">:=</span>&nbsp;<span class="keyword" id="6324632">range</span>&nbsp;<span class="ident" id="6324638">closing</span>&nbsp;<span class="op" id="6324646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324650">c</span><span class="op" id="6324651">.</span><span class="ident" id="6324652">Close</span><span class="op" id="6324657">(</span><span class="op" id="6324658">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6324661">}</span><br>
<span class="lineno"></span><span class="op" id="6324663">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6324666">//&nbsp;SetMaxOpenConns&nbsp;sets&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;open&nbsp;connections&nbsp;to&nbsp;the&nbsp;database.</span><br>
<span class="lineno"></span><span class="comment" id="6324746">//</span><br>
<span class="lineno">550</span><span class="comment" id="6324749">//&nbsp;If&nbsp;MaxIdleConns&nbsp;is&nbsp;greater&nbsp;than&nbsp;0&nbsp;and&nbsp;the&nbsp;new&nbsp;MaxOpenConns&nbsp;is&nbsp;less&nbsp;than</span><br>
<span class="lineno"></span><span class="comment" id="6324824">//&nbsp;MaxIdleConns,&nbsp;then&nbsp;MaxIdleConns&nbsp;will&nbsp;be&nbsp;reduced&nbsp;to&nbsp;match&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="6324892">//&nbsp;MaxOpenConns&nbsp;limit</span><br>
<span class="lineno"></span><span class="comment" id="6324914">//</span><br>
<span class="lineno"></span><span class="comment" id="6324917">//&nbsp;If&nbsp;n&nbsp;&lt;=&nbsp;0,&nbsp;then&nbsp;there&nbsp;is&nbsp;no&nbsp;limit&nbsp;on&nbsp;the&nbsp;number&nbsp;of&nbsp;open&nbsp;connections.</span><br>
<span class="lineno">555</span><span class="comment" id="6324989">//&nbsp;The&nbsp;default&nbsp;is&nbsp;0&nbsp;(unlimited).</span><br>
<span class="lineno"></span><span class="keyword" id="6325022">func</span>&nbsp;<span class="op" id="6325027">(</span><span class="ident" id="6325028">db</span>&nbsp;<span class="op" id="6325031">*</span><span class="ident" id="6325032">DB</span><span class="op" id="6325034">)</span>&nbsp;<span class="ident" id="6325036">SetMaxOpenConns</span><span class="op" id="6325051">(</span><span class="ident" id="6325052">n</span>&nbsp;<span class="builtintype" id="6325054">int</span><span class="op" id="6325057">)</span>&nbsp;<span class="op" id="6325059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325062">db</span><span class="op" id="6325064">.</span><span class="ident" id="6325065">mu</span><span class="op" id="6325067">.</span><span class="ident" id="6325068">Lock</span><span class="op" id="6325072">(</span><span class="op" id="6325073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325076">db</span><span class="op" id="6325078">.</span><span class="ident" id="6325079">maxOpen</span>&nbsp;<span class="op" id="6325087">=</span>&nbsp;<span class="ident" id="6325089">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6325092">if</span>&nbsp;<span class="ident" id="6325095">n</span>&nbsp;<span class="op" id="6325097">&lt;</span>&nbsp;<span class="num" id="6325099">0</span>&nbsp;<span class="op" id="6325101">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325105">db</span><span class="op" id="6325107">.</span><span class="ident" id="6325108">maxOpen</span>&nbsp;<span class="op" id="6325116">=</span>&nbsp;<span class="num" id="6325118">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6325121">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325124">syncMaxIdle</span>&nbsp;<span class="op" id="6325136">:=</span>&nbsp;<span class="ident" id="6325139">db</span><span class="op" id="6325141">.</span><span class="ident" id="6325142">maxOpen</span>&nbsp;<span class="op" id="6325150">&gt;</span>&nbsp;<span class="num" id="6325152">0</span>&nbsp;<span class="op" id="6325154">&amp;&amp;</span>&nbsp;<span class="ident" id="6325157">db</span><span class="op" id="6325159">.</span><span class="ident" id="6325160">maxIdleConnsLocked</span><span class="op" id="6325178">(</span><span class="op" id="6325179">)</span>&nbsp;<span class="op" id="6325181">&gt;</span>&nbsp;<span class="ident" id="6325183">db</span><span class="op" id="6325185">.</span><span class="ident" id="6325186">maxOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325195">db</span><span class="op" id="6325197">.</span><span class="ident" id="6325198">mu</span><span class="op" id="6325200">.</span><span class="ident" id="6325201">Unlock</span><span class="op" id="6325207">(</span><span class="op" id="6325208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6325211">if</span>&nbsp;<span class="ident" id="6325214">syncMaxIdle</span>&nbsp;<span class="op" id="6325226">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325230">db</span><span class="op" id="6325232">.</span><span class="ident" id="6325233">SetMaxIdleConns</span><span class="op" id="6325248">(</span><span class="ident" id="6325249">n</span><span class="op" id="6325250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6325253">}</span><br>
<span class="lineno"></span><span class="op" id="6325255">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6325258">//&nbsp;Assumes&nbsp;db.mu&nbsp;is&nbsp;locked.</span><br>
<span class="lineno">570</span><span class="comment" id="6325286">//&nbsp;If&nbsp;there&nbsp;are&nbsp;connRequests&nbsp;and&nbsp;the&nbsp;connection&nbsp;limit&nbsp;hasn&#39;t&nbsp;been&nbsp;reached,</span><br>
<span class="lineno"></span><span class="comment" id="6325361">//&nbsp;then&nbsp;tell&nbsp;the&nbsp;connectionOpener&nbsp;to&nbsp;open&nbsp;new&nbsp;connections.</span><br>
<span class="lineno"></span><span class="keyword" id="6325420">func</span>&nbsp;<span class="op" id="6325425">(</span><span class="ident" id="6325426">db</span>&nbsp;<span class="op" id="6325429">*</span><span class="ident" id="6325430">DB</span><span class="op" id="6325432">)</span>&nbsp;<span class="ident" id="6325434">maybeOpenNewConnections</span><span class="op" id="6325457">(</span><span class="op" id="6325458">)</span>&nbsp;<span class="op" id="6325460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325463">numRequests</span>&nbsp;<span class="op" id="6325475">:=</span>&nbsp;<span class="builtinfunc" id="6325478">len</span><span class="op" id="6325481">(</span><span class="ident" id="6325482">db</span><span class="op" id="6325484">.</span><span class="ident" id="6325485">connRequests</span><span class="op" id="6325497">)</span>&nbsp;<span class="op" id="6325499">-</span>&nbsp;<span class="ident" id="6325501">db</span><span class="op" id="6325503">.</span><span class="ident" id="6325504">pendingOpens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6325518">if</span>&nbsp;<span class="ident" id="6325521">db</span><span class="op" id="6325523">.</span><span class="ident" id="6325524">maxOpen</span>&nbsp;<span class="op" id="6325532">&gt;</span>&nbsp;<span class="num" id="6325534">0</span>&nbsp;<span class="op" id="6325536">{</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325540">numCanOpen</span>&nbsp;<span class="op" id="6325551">:=</span>&nbsp;<span class="ident" id="6325554">db</span><span class="op" id="6325556">.</span><span class="ident" id="6325557">maxOpen</span>&nbsp;<span class="op" id="6325565">-</span>&nbsp;<span class="op" id="6325567">(</span><span class="ident" id="6325568">db</span><span class="op" id="6325570">.</span><span class="ident" id="6325571">numOpen</span>&nbsp;<span class="op" id="6325579">+</span>&nbsp;<span class="ident" id="6325581">db</span><span class="op" id="6325583">.</span><span class="ident" id="6325584">pendingOpens</span><span class="op" id="6325596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6325600">if</span>&nbsp;<span class="ident" id="6325603">numRequests</span>&nbsp;<span class="op" id="6325615">&gt;</span>&nbsp;<span class="ident" id="6325617">numCanOpen</span>&nbsp;<span class="op" id="6325628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325633">numRequests</span>&nbsp;<span class="op" id="6325645">=</span>&nbsp;<span class="ident" id="6325647">numCanOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6325660">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6325663">}</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6325666">for</span>&nbsp;<span class="ident" id="6325670">numRequests</span>&nbsp;<span class="op" id="6325682">&gt;</span>&nbsp;<span class="num" id="6325684">0</span>&nbsp;<span class="op" id="6325686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325690">db</span><span class="op" id="6325692">.</span><span class="ident" id="6325693">pendingOpens</span><span class="op" id="6325705">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325710">numRequests</span><span class="op" id="6325721">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325726">db</span><span class="op" id="6325728">.</span><span class="ident" id="6325729">openerCh</span>&nbsp;<span class="op" id="6325738">&lt;-</span>&nbsp;<span class="keyword" id="6325741">struct</span><span class="op" id="6325747">{</span><span class="op" id="6325748">}</span><span class="op" id="6325749">{</span><span class="op" id="6325750">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6325753">}</span><br>
<span class="lineno">585</span><span class="op" id="6325755">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6325758">//&nbsp;Runs&nbsp;in&nbsp;a&nbsp;separate&nbsp;goroutine,&nbsp;opens&nbsp;new&nbsp;connections&nbsp;when&nbsp;requested.</span><br>
<span class="lineno"></span><span class="keyword" id="6325829">func</span>&nbsp;<span class="op" id="6325834">(</span><span class="ident" id="6325835">db</span>&nbsp;<span class="op" id="6325838">*</span><span class="ident" id="6325839">DB</span><span class="op" id="6325841">)</span>&nbsp;<span class="ident" id="6325843">connectionOpener</span><span class="op" id="6325859">(</span><span class="op" id="6325860">)</span>&nbsp;<span class="op" id="6325862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6325865">for</span>&nbsp;<span class="keyword" id="6325869">range</span>&nbsp;<span class="ident" id="6325875">db</span><span class="op" id="6325877">.</span><span class="ident" id="6325878">openerCh</span>&nbsp;<span class="op" id="6325887">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325891">db</span><span class="op" id="6325893">.</span><span class="ident" id="6325894">openNewConnection</span><span class="op" id="6325911">(</span><span class="op" id="6325912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6325915">}</span><br>
<span class="lineno"></span><span class="op" id="6325917">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6325920">//&nbsp;Open&nbsp;one&nbsp;new&nbsp;connection</span><br>
<span class="lineno">595</span><span class="keyword" id="6325947">func</span>&nbsp;<span class="op" id="6325952">(</span><span class="ident" id="6325953">db</span>&nbsp;<span class="op" id="6325956">*</span><span class="ident" id="6325957">DB</span><span class="op" id="6325959">)</span>&nbsp;<span class="ident" id="6325961">openNewConnection</span><span class="op" id="6325978">(</span><span class="op" id="6325979">)</span>&nbsp;<span class="op" id="6325981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325984">ci</span><span class="op" id="6325986">,</span>&nbsp;<span class="ident" id="6325988">err</span>&nbsp;<span class="op" id="6325992">:=</span>&nbsp;<span class="ident" id="6325995">db</span><span class="op" id="6325997">.</span><span class="ident" id="6325998">driver</span><span class="op" id="6326004">.</span><span class="ident" id="6326005">Open</span><span class="op" id="6326009">(</span><span class="ident" id="6326010">db</span><span class="op" id="6326012">.</span><span class="ident" id="6326013">dsn</span><span class="op" id="6326016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326019">db</span><span class="op" id="6326021">.</span><span class="ident" id="6326022">mu</span><span class="op" id="6326024">.</span><span class="ident" id="6326025">Lock</span><span class="op" id="6326029">(</span><span class="op" id="6326030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6326033">defer</span>&nbsp;<span class="ident" id="6326039">db</span><span class="op" id="6326041">.</span><span class="ident" id="6326042">mu</span><span class="op" id="6326044">.</span><span class="ident" id="6326045">Unlock</span><span class="op" id="6326051">(</span><span class="op" id="6326052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6326055">if</span>&nbsp;<span class="ident" id="6326058">db</span><span class="op" id="6326060">.</span><span class="ident" id="6326061">closed</span>&nbsp;<span class="op" id="6326068">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6326072">if</span>&nbsp;<span class="ident" id="6326075">err</span>&nbsp;<span class="op" id="6326079">==</span>&nbsp;<span class="builtintype" id="6326082">nil</span>&nbsp;<span class="op" id="6326086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326091">ci</span><span class="op" id="6326093">.</span><span class="ident" id="6326094">Close</span><span class="op" id="6326099">(</span><span class="op" id="6326100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6326104">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6326108">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6326116">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326119">db</span><span class="op" id="6326121">.</span><span class="ident" id="6326122">pendingOpens</span><span class="op" id="6326134">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6326138">if</span>&nbsp;<span class="ident" id="6326141">err</span>&nbsp;<span class="op" id="6326145">!=</span>&nbsp;<span class="builtintype" id="6326148">nil</span>&nbsp;<span class="op" id="6326152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326156">db</span><span class="op" id="6326158">.</span><span class="ident" id="6326159">putConnDBLocked</span><span class="op" id="6326174">(</span><span class="builtintype" id="6326175">nil</span><span class="op" id="6326178">,</span>&nbsp;<span class="ident" id="6326180">err</span><span class="op" id="6326183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6326187">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6326195">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326198">dc</span>&nbsp;<span class="op" id="6326201">:=</span>&nbsp;<span class="op" id="6326204">&amp;</span><span class="ident" id="6326205">driverConn</span><span class="op" id="6326215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326219">db</span><span class="op" id="6326221">:</span>&nbsp;<span class="ident" id="6326223">db</span><span class="op" id="6326225">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326229">ci</span><span class="op" id="6326231">:</span>&nbsp;<span class="ident" id="6326233">ci</span><span class="op" id="6326235">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6326238">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6326241">if</span>&nbsp;<span class="ident" id="6326244">db</span><span class="op" id="6326246">.</span><span class="ident" id="6326247">putConnDBLocked</span><span class="op" id="6326262">(</span><span class="ident" id="6326263">dc</span><span class="op" id="6326265">,</span>&nbsp;<span class="ident" id="6326267">err</span><span class="op" id="6326270">)</span>&nbsp;<span class="op" id="6326272">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326276">db</span><span class="op" id="6326278">.</span><span class="ident" id="6326279">addDepLocked</span><span class="op" id="6326291">(</span><span class="ident" id="6326292">dc</span><span class="op" id="6326294">,</span>&nbsp;<span class="ident" id="6326296">dc</span><span class="op" id="6326298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326302">db</span><span class="op" id="6326304">.</span><span class="ident" id="6326305">numOpen</span><span class="op" id="6326312">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6326316">}</span>&nbsp;<span class="keyword" id="6326318">else</span>&nbsp;<span class="op" id="6326323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326327">ci</span><span class="op" id="6326329">.</span><span class="ident" id="6326330">Close</span><span class="op" id="6326335">(</span><span class="op" id="6326336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6326339">}</span><br>
<span class="lineno">620</span><span class="op" id="6326341">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6326344">//&nbsp;connRequest&nbsp;represents&nbsp;one&nbsp;request&nbsp;for&nbsp;a&nbsp;new&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="6326403">//&nbsp;When&nbsp;there&nbsp;are&nbsp;no&nbsp;idle&nbsp;connections&nbsp;available,&nbsp;DB.conn&nbsp;will&nbsp;create</span><br>
<span class="lineno"></span><span class="comment" id="6326472">//&nbsp;a&nbsp;new&nbsp;connRequest&nbsp;and&nbsp;put&nbsp;it&nbsp;on&nbsp;the&nbsp;db.connRequests&nbsp;list.</span><br>
<span class="lineno">625</span><span class="keyword" id="6326533">type</span>&nbsp;<span class="ident" id="6326538">connRequest</span>&nbsp;<span class="keyword" id="6326550">struct</span>&nbsp;<span class="op" id="6326557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326560">conn</span>&nbsp;<span class="op" id="6326565">*</span><span class="ident" id="6326566">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326578">err</span>&nbsp;&nbsp;<span class="builtintype" id="6326583">error</span><br>
<span class="lineno"></span><span class="op" id="6326589">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span><span class="keyword" id="6326592">var</span>&nbsp;<span class="ident" id="6326596">errDBClosed</span>&nbsp;<span class="op" id="6326608">=</span>&nbsp;<span class="ident" id="6326610">errors</span><span class="op" id="6326616">.</span><span class="ident" id="6326617">New</span><span class="op" id="6326620">(</span><span class="string" id="6326621">&#34;sql:&nbsp;database&nbsp;is&nbsp;closed&#34;</span><span class="op" id="6326646">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6326649">//&nbsp;conn&nbsp;returns&nbsp;a&nbsp;newly-opened&nbsp;or&nbsp;cached&nbsp;*driverConn</span><br>
<span class="lineno"></span><span class="keyword" id="6326702">func</span>&nbsp;<span class="op" id="6326707">(</span><span class="ident" id="6326708">db</span>&nbsp;<span class="op" id="6326711">*</span><span class="ident" id="6326712">DB</span><span class="op" id="6326714">)</span>&nbsp;<span class="ident" id="6326716">conn</span><span class="op" id="6326720">(</span><span class="op" id="6326721">)</span>&nbsp;<span class="op" id="6326723">(</span><span class="op" id="6326724">*</span><span class="ident" id="6326725">driverConn</span><span class="op" id="6326735">,</span>&nbsp;<span class="builtintype" id="6326737">error</span><span class="op" id="6326742">)</span>&nbsp;<span class="op" id="6326744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326747">db</span><span class="op" id="6326749">.</span><span class="ident" id="6326750">mu</span><span class="op" id="6326752">.</span><span class="ident" id="6326753">Lock</span><span class="op" id="6326757">(</span><span class="op" id="6326758">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6326761">if</span>&nbsp;<span class="ident" id="6326764">db</span><span class="op" id="6326766">.</span><span class="ident" id="6326767">closed</span>&nbsp;<span class="op" id="6326774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326778">db</span><span class="op" id="6326780">.</span><span class="ident" id="6326781">mu</span><span class="op" id="6326783">.</span><span class="ident" id="6326784">Unlock</span><span class="op" id="6326790">(</span><span class="op" id="6326791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6326795">return</span>&nbsp;<span class="builtintype" id="6326802">nil</span><span class="op" id="6326805">,</span>&nbsp;<span class="ident" id="6326807">errDBClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6326820">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6326824">//&nbsp;If&nbsp;db.maxOpen&nbsp;&gt;&nbsp;0&nbsp;and&nbsp;the&nbsp;number&nbsp;of&nbsp;open&nbsp;connections&nbsp;is&nbsp;over&nbsp;the&nbsp;limit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6326899">//&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;free&nbsp;connection,&nbsp;make&nbsp;a&nbsp;request&nbsp;and&nbsp;wait.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6326962">if</span>&nbsp;<span class="ident" id="6326965">db</span><span class="op" id="6326967">.</span><span class="ident" id="6326968">maxOpen</span>&nbsp;<span class="op" id="6326976">&gt;</span>&nbsp;<span class="num" id="6326978">0</span>&nbsp;<span class="op" id="6326980">&amp;&amp;</span>&nbsp;<span class="ident" id="6326983">db</span><span class="op" id="6326985">.</span><span class="ident" id="6326986">numOpen</span>&nbsp;<span class="op" id="6326994">&gt;=</span>&nbsp;<span class="ident" id="6326997">db</span><span class="op" id="6326999">.</span><span class="ident" id="6327000">maxOpen</span>&nbsp;<span class="op" id="6327008">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="6327011">len</span><span class="op" id="6327014">(</span><span class="ident" id="6327015">db</span><span class="op" id="6327017">.</span><span class="ident" id="6327018">freeConn</span><span class="op" id="6327026">)</span>&nbsp;<span class="op" id="6327028">==</span>&nbsp;<span class="num" id="6327031">0</span>&nbsp;<span class="op" id="6327033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6327037">//&nbsp;Make&nbsp;the&nbsp;connRequest&nbsp;channel.&nbsp;It&#39;s&nbsp;buffered&nbsp;so&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6327098">//&nbsp;connectionOpener&nbsp;doesn&#39;t&nbsp;block&nbsp;while&nbsp;waiting&nbsp;for&nbsp;the&nbsp;req&nbsp;to&nbsp;be&nbsp;read.</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327172">req</span>&nbsp;<span class="op" id="6327176">:=</span>&nbsp;<span class="builtinfunc" id="6327179">make</span><span class="op" id="6327183">(</span><span class="keyword" id="6327184">chan</span>&nbsp;<span class="ident" id="6327189">connRequest</span><span class="op" id="6327200">,</span>&nbsp;<span class="num" id="6327202">1</span><span class="op" id="6327203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327207">db</span><span class="op" id="6327209">.</span><span class="ident" id="6327210">connRequests</span>&nbsp;<span class="op" id="6327223">=</span>&nbsp;<span class="builtinfunc" id="6327225">append</span><span class="op" id="6327231">(</span><span class="ident" id="6327232">db</span><span class="op" id="6327234">.</span><span class="ident" id="6327235">connRequests</span><span class="op" id="6327247">,</span>&nbsp;<span class="ident" id="6327249">req</span><span class="op" id="6327252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327256">db</span><span class="op" id="6327258">.</span><span class="ident" id="6327259">maybeOpenNewConnections</span><span class="op" id="6327282">(</span><span class="op" id="6327283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327287">db</span><span class="op" id="6327289">.</span><span class="ident" id="6327290">mu</span><span class="op" id="6327292">.</span><span class="ident" id="6327293">Unlock</span><span class="op" id="6327299">(</span><span class="op" id="6327300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327304">ret</span>&nbsp;<span class="op" id="6327308">:=</span>&nbsp;<span class="op" id="6327311">&lt;-</span><span class="ident" id="6327313">req</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6327319">return</span>&nbsp;<span class="ident" id="6327326">ret</span><span class="op" id="6327329">.</span><span class="ident" id="6327330">conn</span><span class="op" id="6327334">,</span>&nbsp;<span class="ident" id="6327336">ret</span><span class="op" id="6327339">.</span><span class="ident" id="6327340">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6327345">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6327349">if</span>&nbsp;<span class="ident" id="6327352">c</span>&nbsp;<span class="op" id="6327354">:=</span>&nbsp;<span class="builtinfunc" id="6327357">len</span><span class="op" id="6327360">(</span><span class="ident" id="6327361">db</span><span class="op" id="6327363">.</span><span class="ident" id="6327364">freeConn</span><span class="op" id="6327372">)</span><span class="op" id="6327373">;</span>&nbsp;<span class="ident" id="6327375">c</span>&nbsp;<span class="op" id="6327377">&gt;</span>&nbsp;<span class="num" id="6327379">0</span>&nbsp;<span class="op" id="6327381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327385">conn</span>&nbsp;<span class="op" id="6327390">:=</span>&nbsp;<span class="ident" id="6327393">db</span><span class="op" id="6327395">.</span><span class="ident" id="6327396">freeConn</span><span class="op" id="6327404">[</span><span class="num" id="6327405">0</span><span class="op" id="6327406">]</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6327410">copy</span><span class="op" id="6327414">(</span><span class="ident" id="6327415">db</span><span class="op" id="6327417">.</span><span class="ident" id="6327418">freeConn</span><span class="op" id="6327426">,</span>&nbsp;<span class="ident" id="6327428">db</span><span class="op" id="6327430">.</span><span class="ident" id="6327431">freeConn</span><span class="op" id="6327439">[</span><span class="num" id="6327440">1</span><span class="op" id="6327441">:</span><span class="op" id="6327442">]</span><span class="op" id="6327443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327447">db</span><span class="op" id="6327449">.</span><span class="ident" id="6327450">freeConn</span>&nbsp;<span class="op" id="6327459">=</span>&nbsp;<span class="ident" id="6327461">db</span><span class="op" id="6327463">.</span><span class="ident" id="6327464">freeConn</span><span class="op" id="6327472">[</span><span class="op" id="6327473">:</span><span class="ident" id="6327474">c</span><span class="op" id="6327475">-</span><span class="num" id="6327476">1</span><span class="op" id="6327477">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327481">conn</span><span class="op" id="6327485">.</span><span class="ident" id="6327486">inUse</span>&nbsp;<span class="op" id="6327492">=</span>&nbsp;<span class="builtintype" id="6327494">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327501">db</span><span class="op" id="6327503">.</span><span class="ident" id="6327504">mu</span><span class="op" id="6327506">.</span><span class="ident" id="6327507">Unlock</span><span class="op" id="6327513">(</span><span class="op" id="6327514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6327518">return</span>&nbsp;<span class="ident" id="6327525">conn</span><span class="op" id="6327529">,</span>&nbsp;<span class="builtintype" id="6327531">nil</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6327536">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327540">db</span><span class="op" id="6327542">.</span><span class="ident" id="6327543">numOpen</span><span class="op" id="6327550">++</span>&nbsp;<span class="comment" id="6327553">//&nbsp;optimistically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327572">db</span><span class="op" id="6327574">.</span><span class="ident" id="6327575">mu</span><span class="op" id="6327577">.</span><span class="ident" id="6327578">Unlock</span><span class="op" id="6327584">(</span><span class="op" id="6327585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327588">ci</span><span class="op" id="6327590">,</span>&nbsp;<span class="ident" id="6327592">err</span>&nbsp;<span class="op" id="6327596">:=</span>&nbsp;<span class="ident" id="6327599">db</span><span class="op" id="6327601">.</span><span class="ident" id="6327602">driver</span><span class="op" id="6327608">.</span><span class="ident" id="6327609">Open</span><span class="op" id="6327613">(</span><span class="ident" id="6327614">db</span><span class="op" id="6327616">.</span><span class="ident" id="6327617">dsn</span><span class="op" id="6327620">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6327623">if</span>&nbsp;<span class="ident" id="6327626">err</span>&nbsp;<span class="op" id="6327630">!=</span>&nbsp;<span class="builtintype" id="6327633">nil</span>&nbsp;<span class="op" id="6327637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327641">db</span><span class="op" id="6327643">.</span><span class="ident" id="6327644">mu</span><span class="op" id="6327646">.</span><span class="ident" id="6327647">Lock</span><span class="op" id="6327651">(</span><span class="op" id="6327652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327656">db</span><span class="op" id="6327658">.</span><span class="ident" id="6327659">numOpen</span><span class="op" id="6327666">--</span>&nbsp;<span class="comment" id="6327669">//&nbsp;correct&nbsp;for&nbsp;earlier&nbsp;optimism</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327703">db</span><span class="op" id="6327705">.</span><span class="ident" id="6327706">mu</span><span class="op" id="6327708">.</span><span class="ident" id="6327709">Unlock</span><span class="op" id="6327715">(</span><span class="op" id="6327716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6327720">return</span>&nbsp;<span class="builtintype" id="6327727">nil</span><span class="op" id="6327730">,</span>&nbsp;<span class="ident" id="6327732">err</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6327737">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327740">db</span><span class="op" id="6327742">.</span><span class="ident" id="6327743">mu</span><span class="op" id="6327745">.</span><span class="ident" id="6327746">Lock</span><span class="op" id="6327750">(</span><span class="op" id="6327751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327754">dc</span>&nbsp;<span class="op" id="6327757">:=</span>&nbsp;<span class="op" id="6327760">&amp;</span><span class="ident" id="6327761">driverConn</span><span class="op" id="6327771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327775">db</span><span class="op" id="6327777">:</span>&nbsp;<span class="ident" id="6327779">db</span><span class="op" id="6327781">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327785">ci</span><span class="op" id="6327787">:</span>&nbsp;<span class="ident" id="6327789">ci</span><span class="op" id="6327791">,</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6327794">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327797">db</span><span class="op" id="6327799">.</span><span class="ident" id="6327800">addDepLocked</span><span class="op" id="6327812">(</span><span class="ident" id="6327813">dc</span><span class="op" id="6327815">,</span>&nbsp;<span class="ident" id="6327817">dc</span><span class="op" id="6327819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327822">dc</span><span class="op" id="6327824">.</span><span class="ident" id="6327825">inUse</span>&nbsp;<span class="op" id="6327831">=</span>&nbsp;<span class="builtintype" id="6327833">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327839">db</span><span class="op" id="6327841">.</span><span class="ident" id="6327842">mu</span><span class="op" id="6327844">.</span><span class="ident" id="6327845">Unlock</span><span class="op" id="6327851">(</span><span class="op" id="6327852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6327855">return</span>&nbsp;<span class="ident" id="6327862">dc</span><span class="op" id="6327864">,</span>&nbsp;<span class="builtintype" id="6327866">nil</span><br>
<span class="lineno">680</span><span class="op" id="6327870">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6327873">var</span>&nbsp;<span class="op" id="6327877">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327880">errConnClosed</span>&nbsp;<span class="op" id="6327894">=</span>&nbsp;<span class="ident" id="6327896">errors</span><span class="op" id="6327902">.</span><span class="ident" id="6327903">New</span><span class="op" id="6327906">(</span><span class="string" id="6327907">&#34;database/sql:&nbsp;internal&nbsp;sentinel&nbsp;error:&nbsp;conn&nbsp;is&nbsp;closed&#34;</span><span class="op" id="6327962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327965">errConnBusy</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6327979">=</span>&nbsp;<span class="ident" id="6327981">errors</span><span class="op" id="6327987">.</span><span class="ident" id="6327988">New</span><span class="op" id="6327991">(</span><span class="string" id="6327992">&#34;database/sql:&nbsp;internal&nbsp;sentinel&nbsp;error:&nbsp;conn&nbsp;is&nbsp;busy&#34;</span><span class="op" id="6328045">)</span><br>
<span class="lineno">685</span><span class="op" id="6328047">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6328050">//&nbsp;connIfFree&nbsp;returns&nbsp;(wanted,&nbsp;nil)&nbsp;if&nbsp;wanted&nbsp;is&nbsp;still&nbsp;a&nbsp;valid&nbsp;conn&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="6328122">//&nbsp;isn&#39;t&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span><span class="comment" id="6328139">//</span><br>
<span class="lineno">690</span><span class="comment" id="6328142">//&nbsp;The&nbsp;error&nbsp;is&nbsp;errConnClosed&nbsp;if&nbsp;the&nbsp;connection&nbsp;if&nbsp;the&nbsp;requested&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="6328218">//&nbsp;is&nbsp;invalid&nbsp;because&nbsp;it&#39;s&nbsp;been&nbsp;closed.</span><br>
<span class="lineno"></span><span class="comment" id="6328258">//</span><br>
<span class="lineno"></span><span class="comment" id="6328261">//&nbsp;The&nbsp;error&nbsp;is&nbsp;errConnBusy&nbsp;if&nbsp;the&nbsp;connection&nbsp;is&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="6328318">func</span>&nbsp;<span class="op" id="6328323">(</span><span class="ident" id="6328324">db</span>&nbsp;<span class="op" id="6328327">*</span><span class="ident" id="6328328">DB</span><span class="op" id="6328330">)</span>&nbsp;<span class="ident" id="6328332">connIfFree</span><span class="op" id="6328342">(</span><span class="ident" id="6328343">wanted</span>&nbsp;<span class="op" id="6328350">*</span><span class="ident" id="6328351">driverConn</span><span class="op" id="6328361">)</span>&nbsp;<span class="op" id="6328363">(</span><span class="op" id="6328364">*</span><span class="ident" id="6328365">driverConn</span><span class="op" id="6328375">,</span>&nbsp;<span class="builtintype" id="6328377">error</span><span class="op" id="6328382">)</span>&nbsp;<span class="op" id="6328384">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6328387">db</span><span class="op" id="6328389">.</span><span class="ident" id="6328390">mu</span><span class="op" id="6328392">.</span><span class="ident" id="6328393">Lock</span><span class="op" id="6328397">(</span><span class="op" id="6328398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6328401">defer</span>&nbsp;<span class="ident" id="6328407">db</span><span class="op" id="6328409">.</span><span class="ident" id="6328410">mu</span><span class="op" id="6328412">.</span><span class="ident" id="6328413">Unlock</span><span class="op" id="6328419">(</span><span class="op" id="6328420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6328423">if</span>&nbsp;<span class="ident" id="6328426">wanted</span><span class="op" id="6328432">.</span><span class="ident" id="6328433">dbmuClosed</span>&nbsp;<span class="op" id="6328444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6328448">return</span>&nbsp;<span class="builtintype" id="6328455">nil</span><span class="op" id="6328458">,</span>&nbsp;<span class="ident" id="6328460">errConnClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6328475">}</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6328478">if</span>&nbsp;<span class="ident" id="6328481">wanted</span><span class="op" id="6328487">.</span><span class="ident" id="6328488">inUse</span>&nbsp;<span class="op" id="6328494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6328498">return</span>&nbsp;<span class="builtintype" id="6328505">nil</span><span class="op" id="6328508">,</span>&nbsp;<span class="ident" id="6328510">errConnBusy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6328523">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6328526">idx</span>&nbsp;<span class="op" id="6328530">:=</span>&nbsp;<span class="op" id="6328533">-</span><span class="num" id="6328534">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6328537">for</span>&nbsp;<span class="ident" id="6328541">ii</span><span class="op" id="6328543">,</span>&nbsp;<span class="ident" id="6328545">v</span>&nbsp;<span class="op" id="6328547">:=</span>&nbsp;<span class="keyword" id="6328550">range</span>&nbsp;<span class="ident" id="6328556">db</span><span class="op" id="6328558">.</span><span class="ident" id="6328559">freeConn</span>&nbsp;<span class="op" id="6328568">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6328572">if</span>&nbsp;<span class="ident" id="6328575">v</span>&nbsp;<span class="op" id="6328577">==</span>&nbsp;<span class="ident" id="6328580">wanted</span>&nbsp;<span class="op" id="6328587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6328592">idx</span>&nbsp;<span class="op" id="6328596">=</span>&nbsp;<span class="ident" id="6328598">ii</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6328604">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6328612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6328615">}</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6328618">if</span>&nbsp;<span class="ident" id="6328621">idx</span>&nbsp;<span class="op" id="6328625">&gt;=</span>&nbsp;<span class="num" id="6328628">0</span>&nbsp;<span class="op" id="6328630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6328634">db</span><span class="op" id="6328636">.</span><span class="ident" id="6328637">freeConn</span>&nbsp;<span class="op" id="6328646">=</span>&nbsp;<span class="builtinfunc" id="6328648">append</span><span class="op" id="6328654">(</span><span class="ident" id="6328655">db</span><span class="op" id="6328657">.</span><span class="ident" id="6328658">freeConn</span><span class="op" id="6328666">[</span><span class="op" id="6328667">:</span><span class="ident" id="6328668">idx</span><span class="op" id="6328671">]</span><span class="op" id="6328672">,</span>&nbsp;<span class="ident" id="6328674">db</span><span class="op" id="6328676">.</span><span class="ident" id="6328677">freeConn</span><span class="op" id="6328685">[</span><span class="ident" id="6328686">idx</span><span class="op" id="6328689">+</span><span class="num" id="6328690">1</span><span class="op" id="6328691">:</span><span class="op" id="6328692">]</span><span class="op" id="6328693">...</span><span class="op" id="6328696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6328700">wanted</span><span class="op" id="6328706">.</span><span class="ident" id="6328707">inUse</span>&nbsp;<span class="op" id="6328713">=</span>&nbsp;<span class="builtintype" id="6328715">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6328722">return</span>&nbsp;<span class="ident" id="6328729">wanted</span><span class="op" id="6328735">,</span>&nbsp;<span class="builtintype" id="6328737">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6328742">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6328745">//&nbsp;TODO(bradfitz):&nbsp;shouldn&#39;t&nbsp;get&nbsp;here.&nbsp;After&nbsp;Go&nbsp;1.1,&nbsp;change&nbsp;this&nbsp;to:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6328815">//&nbsp;panic(&#34;connIfFree&nbsp;call&nbsp;requested&nbsp;a&nbsp;non-closed,&nbsp;non-busy,&nbsp;non-free&nbsp;conn&#34;)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6328892">//&nbsp;Which&nbsp;passes&nbsp;all&nbsp;the&nbsp;tests,&nbsp;but&nbsp;I&#39;m&nbsp;too&nbsp;paranoid&nbsp;to&nbsp;include&nbsp;this</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6328961">//&nbsp;late&nbsp;in&nbsp;Go&nbsp;1.1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6328981">//&nbsp;Instead,&nbsp;treat&nbsp;it&nbsp;like&nbsp;a&nbsp;busy&nbsp;connection:</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6329027">return</span>&nbsp;<span class="builtintype" id="6329034">nil</span><span class="op" id="6329037">,</span>&nbsp;<span class="ident" id="6329039">errConnBusy</span><br>
<span class="lineno"></span><span class="op" id="6329051">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6329054">//&nbsp;putConnHook&nbsp;is&nbsp;a&nbsp;hook&nbsp;for&nbsp;testing.</span><br>
<span class="lineno"></span><span class="keyword" id="6329092">var</span>&nbsp;<span class="ident" id="6329096">putConnHook</span>&nbsp;<span class="keyword" id="6329108">func</span><span class="op" id="6329112">(</span><span class="op" id="6329113">*</span><span class="ident" id="6329114">DB</span><span class="op" id="6329116">,</span>&nbsp;<span class="op" id="6329118">*</span><span class="ident" id="6329119">driverConn</span><span class="op" id="6329129">)</span><br>
<span class="lineno">725</span><br>
<span class="lineno"></span><span class="comment" id="6329132">//&nbsp;noteUnusedDriverStatement&nbsp;notes&nbsp;that&nbsp;si&nbsp;is&nbsp;no&nbsp;longer&nbsp;used&nbsp;and&nbsp;should</span><br>
<span class="lineno"></span><span class="comment" id="6329204">//&nbsp;be&nbsp;closed&nbsp;whenever&nbsp;possible&nbsp;(when&nbsp;c&nbsp;is&nbsp;next&nbsp;not&nbsp;in&nbsp;use),&nbsp;unless&nbsp;c&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="6329276">//&nbsp;already&nbsp;closed.</span><br>
<span class="lineno"></span><span class="keyword" id="6329295">func</span>&nbsp;<span class="op" id="6329300">(</span><span class="ident" id="6329301">db</span>&nbsp;<span class="op" id="6329304">*</span><span class="ident" id="6329305">DB</span><span class="op" id="6329307">)</span>&nbsp;<span class="ident" id="6329309">noteUnusedDriverStatement</span><span class="op" id="6329334">(</span><span class="ident" id="6329335">c</span>&nbsp;<span class="op" id="6329337">*</span><span class="ident" id="6329338">driverConn</span><span class="op" id="6329348">,</span>&nbsp;<span class="ident" id="6329350">si</span>&nbsp;<span class="ident" id="6329353">driver</span><span class="op" id="6329359">.</span><span class="ident" id="6329360">Stmt</span><span class="op" id="6329364">)</span>&nbsp;<span class="op" id="6329366">{</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6329369">db</span><span class="op" id="6329371">.</span><span class="ident" id="6329372">mu</span><span class="op" id="6329374">.</span><span class="ident" id="6329375">Lock</span><span class="op" id="6329379">(</span><span class="op" id="6329380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6329383">defer</span>&nbsp;<span class="ident" id="6329389">db</span><span class="op" id="6329391">.</span><span class="ident" id="6329392">mu</span><span class="op" id="6329394">.</span><span class="ident" id="6329395">Unlock</span><span class="op" id="6329401">(</span><span class="op" id="6329402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6329405">if</span>&nbsp;<span class="ident" id="6329408">c</span><span class="op" id="6329409">.</span><span class="ident" id="6329410">inUse</span>&nbsp;<span class="op" id="6329416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6329420">c</span><span class="op" id="6329421">.</span><span class="ident" id="6329422">onPut</span>&nbsp;<span class="op" id="6329428">=</span>&nbsp;<span class="builtinfunc" id="6329430">append</span><span class="op" id="6329436">(</span><span class="ident" id="6329437">c</span><span class="op" id="6329438">.</span><span class="ident" id="6329439">onPut</span><span class="op" id="6329444">,</span>&nbsp;<span class="keyword" id="6329446">func</span><span class="op" id="6329450">(</span><span class="op" id="6329451">)</span>&nbsp;<span class="op" id="6329453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6329458">si</span><span class="op" id="6329460">.</span><span class="ident" id="6329461">Close</span><span class="op" id="6329466">(</span><span class="op" id="6329467">)</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6329471">}</span><span class="op" id="6329472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6329475">}</span>&nbsp;<span class="keyword" id="6329477">else</span>&nbsp;<span class="op" id="6329482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6329486">c</span><span class="op" id="6329487">.</span><span class="ident" id="6329488">Lock</span><span class="op" id="6329492">(</span><span class="op" id="6329493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6329497">defer</span>&nbsp;<span class="ident" id="6329503">c</span><span class="op" id="6329504">.</span><span class="ident" id="6329505">Unlock</span><span class="op" id="6329511">(</span><span class="op" id="6329512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6329516">if</span>&nbsp;<span class="op" id="6329519">!</span><span class="ident" id="6329520">c</span><span class="op" id="6329521">.</span><span class="ident" id="6329522">finalClosed</span>&nbsp;<span class="op" id="6329534">{</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6329539">si</span><span class="op" id="6329541">.</span><span class="ident" id="6329542">Close</span><span class="op" id="6329547">(</span><span class="op" id="6329548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6329552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6329555">}</span><br>
<span class="lineno"></span><span class="op" id="6329557">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">745</span><span class="comment" id="6329560">//&nbsp;debugGetPut&nbsp;determines&nbsp;whether&nbsp;getConn&nbsp;&amp;&nbsp;putConn&nbsp;calls&#39;&nbsp;stack&nbsp;traces</span><br>
<span class="lineno"></span><span class="comment" id="6329632">//&nbsp;are&nbsp;returned&nbsp;for&nbsp;more&nbsp;verbose&nbsp;crashes.</span><br>
<span class="lineno"></span><span class="keyword" id="6329674">const</span>&nbsp;<span class="ident" id="6329680">debugGetPut</span>&nbsp;<span class="op" id="6329692">=</span>&nbsp;<span class="builtintype" id="6329694">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6329701">//&nbsp;putConn&nbsp;adds&nbsp;a&nbsp;connection&nbsp;to&nbsp;the&nbsp;db&#39;s&nbsp;free&nbsp;pool.</span><br>
<span class="lineno">750</span><span class="comment" id="6329753">//&nbsp;err&nbsp;is&nbsp;optionally&nbsp;the&nbsp;last&nbsp;error&nbsp;that&nbsp;occurred&nbsp;on&nbsp;this&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="6329823">func</span>&nbsp;<span class="op" id="6329828">(</span><span class="ident" id="6329829">db</span>&nbsp;<span class="op" id="6329832">*</span><span class="ident" id="6329833">DB</span><span class="op" id="6329835">)</span>&nbsp;<span class="ident" id="6329837">putConn</span><span class="op" id="6329844">(</span><span class="ident" id="6329845">dc</span>&nbsp;<span class="op" id="6329848">*</span><span class="ident" id="6329849">driverConn</span><span class="op" id="6329859">,</span>&nbsp;<span class="ident" id="6329861">err</span>&nbsp;<span class="builtintype" id="6329865">error</span><span class="op" id="6329870">)</span>&nbsp;<span class="op" id="6329872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6329875">db</span><span class="op" id="6329877">.</span><span class="ident" id="6329878">mu</span><span class="op" id="6329880">.</span><span class="ident" id="6329881">Lock</span><span class="op" id="6329885">(</span><span class="op" id="6329886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6329889">if</span>&nbsp;<span class="op" id="6329892">!</span><span class="ident" id="6329893">dc</span><span class="op" id="6329895">.</span><span class="ident" id="6329896">inUse</span>&nbsp;<span class="op" id="6329902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6329906">if</span>&nbsp;<span class="ident" id="6329909">debugGetPut</span>&nbsp;<span class="op" id="6329921">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6329926">fmt</span><span class="op" id="6329929">.</span><span class="ident" id="6329930">Printf</span><span class="op" id="6329936">(</span><span class="string" id="6329937">&#34;putConn(%v)&nbsp;DUPLICATE&nbsp;was:&nbsp;%s\n\nPREVIOUS&nbsp;was:&nbsp;%s&#34;</span><span class="op" id="6329988">,</span>&nbsp;<span class="ident" id="6329990">dc</span><span class="op" id="6329992">,</span>&nbsp;<span class="ident" id="6329994">stack</span><span class="op" id="6329999">(</span><span class="op" id="6330000">)</span><span class="op" id="6330001">,</span>&nbsp;<span class="ident" id="6330003">db</span><span class="op" id="6330005">.</span><span class="ident" id="6330006">lastPut</span><span class="op" id="6330013">[</span><span class="ident" id="6330014">dc</span><span class="op" id="6330016">]</span><span class="op" id="6330017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6330021">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6330025">panic</span><span class="op" id="6330030">(</span><span class="string" id="6330031">&#34;sql:&nbsp;connection&nbsp;returned&nbsp;that&nbsp;was&nbsp;never&nbsp;out&#34;</span><span class="op" id="6330076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6330079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6330082">if</span>&nbsp;<span class="ident" id="6330085">debugGetPut</span>&nbsp;<span class="op" id="6330097">{</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6330101">db</span><span class="op" id="6330103">.</span><span class="ident" id="6330104">lastPut</span><span class="op" id="6330111">[</span><span class="ident" id="6330112">dc</span><span class="op" id="6330114">]</span>&nbsp;<span class="op" id="6330116">=</span>&nbsp;<span class="ident" id="6330118">stack</span><span class="op" id="6330123">(</span><span class="op" id="6330124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6330127">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6330130">dc</span><span class="op" id="6330132">.</span><span class="ident" id="6330133">inUse</span>&nbsp;<span class="op" id="6330139">=</span>&nbsp;<span class="builtintype" id="6330141">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6330149">for</span>&nbsp;<span class="ident" id="6330153">_</span><span class="op" id="6330154">,</span>&nbsp;<span class="ident" id="6330156">fn</span>&nbsp;<span class="op" id="6330159">:=</span>&nbsp;<span class="keyword" id="6330162">range</span>&nbsp;<span class="ident" id="6330168">dc</span><span class="op" id="6330170">.</span><span class="ident" id="6330171">onPut</span>&nbsp;<span class="op" id="6330177">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6330181">fn</span><span class="op" id="6330183">(</span><span class="op" id="6330184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6330187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6330190">dc</span><span class="op" id="6330192">.</span><span class="ident" id="6330193">onPut</span>&nbsp;<span class="op" id="6330199">=</span>&nbsp;<span class="builtintype" id="6330201">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6330207">if</span>&nbsp;<span class="ident" id="6330210">err</span>&nbsp;<span class="op" id="6330214">==</span>&nbsp;<span class="ident" id="6330217">driver</span><span class="op" id="6330223">.</span><span class="ident" id="6330224">ErrBadConn</span>&nbsp;<span class="op" id="6330235">{</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6330239">//&nbsp;Don&#39;t&nbsp;reuse&nbsp;bad&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6330273">//&nbsp;Since&nbsp;the&nbsp;conn&nbsp;is&nbsp;considered&nbsp;bad&nbsp;and&nbsp;is&nbsp;being&nbsp;discarded,&nbsp;treat&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6330344">//&nbsp;as&nbsp;closed.&nbsp;Don&#39;t&nbsp;decrement&nbsp;the&nbsp;open&nbsp;count&nbsp;here,&nbsp;finalClose&nbsp;will</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6330413">//&nbsp;take&nbsp;care&nbsp;of&nbsp;that.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6330437">db</span><span class="op" id="6330439">.</span><span class="ident" id="6330440">maybeOpenNewConnections</span><span class="op" id="6330463">(</span><span class="op" id="6330464">)</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6330468">db</span><span class="op" id="6330470">.</span><span class="ident" id="6330471">mu</span><span class="op" id="6330473">.</span><span class="ident" id="6330474">Unlock</span><span class="op" id="6330480">(</span><span class="op" id="6330481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6330485">dc</span><span class="op" id="6330487">.</span><span class="ident" id="6330488">Close</span><span class="op" id="6330493">(</span><span class="op" id="6330494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6330498">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6330506">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6330509">if</span>&nbsp;<span class="ident" id="6330512">putConnHook</span>&nbsp;<span class="op" id="6330524">!=</span>&nbsp;<span class="builtintype" id="6330527">nil</span>&nbsp;<span class="op" id="6330531">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6330535">putConnHook</span><span class="op" id="6330546">(</span><span class="ident" id="6330547">db</span><span class="op" id="6330549">,</span>&nbsp;<span class="ident" id="6330551">dc</span><span class="op" id="6330553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6330556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6330559">added</span>&nbsp;<span class="op" id="6330565">:=</span>&nbsp;<span class="ident" id="6330568">db</span><span class="op" id="6330570">.</span><span class="ident" id="6330571">putConnDBLocked</span><span class="op" id="6330586">(</span><span class="ident" id="6330587">dc</span><span class="op" id="6330589">,</span>&nbsp;<span class="builtintype" id="6330591">nil</span><span class="op" id="6330594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6330597">db</span><span class="op" id="6330599">.</span><span class="ident" id="6330600">mu</span><span class="op" id="6330602">.</span><span class="ident" id="6330603">Unlock</span><span class="op" id="6330609">(</span><span class="op" id="6330610">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6330614">if</span>&nbsp;<span class="op" id="6330617">!</span><span class="ident" id="6330618">added</span>&nbsp;<span class="op" id="6330624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6330628">dc</span><span class="op" id="6330630">.</span><span class="ident" id="6330631">Close</span><span class="op" id="6330636">(</span><span class="op" id="6330637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6330640">}</span><br>
<span class="lineno"></span><span class="op" id="6330642">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">790</span><span class="comment" id="6330645">//&nbsp;Satisfy&nbsp;a&nbsp;connRequest&nbsp;or&nbsp;put&nbsp;the&nbsp;driverConn&nbsp;in&nbsp;the&nbsp;idle&nbsp;pool&nbsp;and&nbsp;return&nbsp;true</span><br>
<span class="lineno"></span><span class="comment" id="6330725">//&nbsp;or&nbsp;return&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="6330745">//&nbsp;putConnDBLocked&nbsp;will&nbsp;satisfy&nbsp;a&nbsp;connRequest&nbsp;if&nbsp;there&nbsp;is&nbsp;one,&nbsp;or&nbsp;it&nbsp;will</span><br>
<span class="lineno"></span><span class="comment" id="6330819">//&nbsp;return&nbsp;the&nbsp;*driverConn&nbsp;to&nbsp;the&nbsp;freeConn&nbsp;list&nbsp;if&nbsp;err&nbsp;==&nbsp;nil&nbsp;and&nbsp;the&nbsp;idle</span><br>
<span class="lineno"></span><span class="comment" id="6330893">//&nbsp;connection&nbsp;limit&nbsp;will&nbsp;not&nbsp;be&nbsp;exceeded.</span><br>
<span class="lineno">795</span><span class="comment" id="6330935">//&nbsp;If&nbsp;err&nbsp;!=&nbsp;nil,&nbsp;the&nbsp;value&nbsp;of&nbsp;dc&nbsp;is&nbsp;ignored.</span><br>
<span class="lineno"></span><span class="comment" id="6330981">//&nbsp;If&nbsp;err&nbsp;==&nbsp;nil,&nbsp;then&nbsp;dc&nbsp;must&nbsp;not&nbsp;equal&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="6331027">//&nbsp;If&nbsp;a&nbsp;connRequest&nbsp;was&nbsp;fulfilled&nbsp;or&nbsp;the&nbsp;*driverConn&nbsp;was&nbsp;placed&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6331098">//&nbsp;freeConn&nbsp;list,&nbsp;then&nbsp;true&nbsp;is&nbsp;returned,&nbsp;otherwise&nbsp;false&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="6331168">func</span>&nbsp;<span class="op" id="6331173">(</span><span class="ident" id="6331174">db</span>&nbsp;<span class="op" id="6331177">*</span><span class="ident" id="6331178">DB</span><span class="op" id="6331180">)</span>&nbsp;<span class="ident" id="6331182">putConnDBLocked</span><span class="op" id="6331197">(</span><span class="ident" id="6331198">dc</span>&nbsp;<span class="op" id="6331201">*</span><span class="ident" id="6331202">driverConn</span><span class="op" id="6331212">,</span>&nbsp;<span class="ident" id="6331214">err</span>&nbsp;<span class="builtintype" id="6331218">error</span><span class="op" id="6331223">)</span>&nbsp;<span class="builtintype" id="6331225">bool</span>&nbsp;<span class="op" id="6331230">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6331233">if</span>&nbsp;<span class="ident" id="6331236">c</span>&nbsp;<span class="op" id="6331238">:=</span>&nbsp;<span class="builtinfunc" id="6331241">len</span><span class="op" id="6331244">(</span><span class="ident" id="6331245">db</span><span class="op" id="6331247">.</span><span class="ident" id="6331248">connRequests</span><span class="op" id="6331260">)</span><span class="op" id="6331261">;</span>&nbsp;<span class="ident" id="6331263">c</span>&nbsp;<span class="op" id="6331265">&gt;</span>&nbsp;<span class="num" id="6331267">0</span>&nbsp;<span class="op" id="6331269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6331273">req</span>&nbsp;<span class="op" id="6331277">:=</span>&nbsp;<span class="ident" id="6331280">db</span><span class="op" id="6331282">.</span><span class="ident" id="6331283">connRequests</span><span class="op" id="6331295">[</span><span class="num" id="6331296">0</span><span class="op" id="6331297">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6331301">//&nbsp;This&nbsp;copy&nbsp;is&nbsp;O(n)&nbsp;but&nbsp;in&nbsp;practice&nbsp;faster&nbsp;than&nbsp;a&nbsp;linked&nbsp;list.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6331367">//&nbsp;TODO:&nbsp;consider&nbsp;compacting&nbsp;it&nbsp;down&nbsp;less&nbsp;often&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6331421">//&nbsp;moving&nbsp;the&nbsp;base&nbsp;instead?</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6331451">copy</span><span class="op" id="6331455">(</span><span class="ident" id="6331456">db</span><span class="op" id="6331458">.</span><span class="ident" id="6331459">connRequests</span><span class="op" id="6331471">,</span>&nbsp;<span class="ident" id="6331473">db</span><span class="op" id="6331475">.</span><span class="ident" id="6331476">connRequests</span><span class="op" id="6331488">[</span><span class="num" id="6331489">1</span><span class="op" id="6331490">:</span><span class="op" id="6331491">]</span><span class="op" id="6331492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6331496">db</span><span class="op" id="6331498">.</span><span class="ident" id="6331499">connRequests</span>&nbsp;<span class="op" id="6331512">=</span>&nbsp;<span class="ident" id="6331514">db</span><span class="op" id="6331516">.</span><span class="ident" id="6331517">connRequests</span><span class="op" id="6331529">[</span><span class="op" id="6331530">:</span><span class="ident" id="6331531">c</span><span class="op" id="6331532">-</span><span class="num" id="6331533">1</span><span class="op" id="6331534">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6331538">if</span>&nbsp;<span class="ident" id="6331541">err</span>&nbsp;<span class="op" id="6331545">==</span>&nbsp;<span class="builtintype" id="6331548">nil</span>&nbsp;<span class="op" id="6331552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6331557">dc</span><span class="op" id="6331559">.</span><span class="ident" id="6331560">inUse</span>&nbsp;<span class="op" id="6331566">=</span>&nbsp;<span class="builtintype" id="6331568">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6331575">}</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6331579">req</span>&nbsp;<span class="op" id="6331583">&lt;-</span>&nbsp;<span class="ident" id="6331586">connRequest</span><span class="op" id="6331597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6331602">conn</span><span class="op" id="6331606">:</span>&nbsp;<span class="ident" id="6331608">dc</span><span class="op" id="6331610">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6331615">err</span><span class="op" id="6331618">:</span>&nbsp;&nbsp;<span class="ident" id="6331621">err</span><span class="op" id="6331624">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6331628">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6331632">return</span>&nbsp;<span class="builtintype" id="6331639">true</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6331645">}</span>&nbsp;<span class="keyword" id="6331647">else</span>&nbsp;<span class="keyword" id="6331652">if</span>&nbsp;<span class="ident" id="6331655">err</span>&nbsp;<span class="op" id="6331659">==</span>&nbsp;<span class="builtintype" id="6331662">nil</span>&nbsp;<span class="op" id="6331666">&amp;&amp;</span>&nbsp;<span class="op" id="6331669">!</span><span class="ident" id="6331670">db</span><span class="op" id="6331672">.</span><span class="ident" id="6331673">closed</span>&nbsp;<span class="op" id="6331680">&amp;&amp;</span>&nbsp;<span class="ident" id="6331683">db</span><span class="op" id="6331685">.</span><span class="ident" id="6331686">maxIdleConnsLocked</span><span class="op" id="6331704">(</span><span class="op" id="6331705">)</span>&nbsp;<span class="op" id="6331707">&gt;</span>&nbsp;<span class="builtinfunc" id="6331709">len</span><span class="op" id="6331712">(</span><span class="ident" id="6331713">db</span><span class="op" id="6331715">.</span><span class="ident" id="6331716">freeConn</span><span class="op" id="6331724">)</span>&nbsp;<span class="op" id="6331726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6331730">db</span><span class="op" id="6331732">.</span><span class="ident" id="6331733">freeConn</span>&nbsp;<span class="op" id="6331742">=</span>&nbsp;<span class="builtinfunc" id="6331744">append</span><span class="op" id="6331750">(</span><span class="ident" id="6331751">db</span><span class="op" id="6331753">.</span><span class="ident" id="6331754">freeConn</span><span class="op" id="6331762">,</span>&nbsp;<span class="ident" id="6331764">dc</span><span class="op" id="6331766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6331770">return</span>&nbsp;<span class="builtintype" id="6331777">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6331783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6331786">return</span>&nbsp;<span class="builtintype" id="6331793">false</span><br>
<span class="lineno">820</span><span class="op" id="6331799">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6331802">//&nbsp;maxBadConnRetries&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;maximum&nbsp;retries&nbsp;if&nbsp;the&nbsp;driver&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="6331878">//&nbsp;driver.ErrBadConn&nbsp;to&nbsp;signal&nbsp;a&nbsp;broken&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="6331930">const</span>&nbsp;<span class="ident" id="6331936">maxBadConnRetries</span>&nbsp;<span class="op" id="6331954">=</span>&nbsp;<span class="num" id="6331956">10</span><br>
<span class="lineno">825</span><br>
<span class="lineno"></span><span class="comment" id="6331960">//&nbsp;Prepare&nbsp;creates&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;for&nbsp;later&nbsp;queries&nbsp;or&nbsp;executions.</span><br>
<span class="lineno"></span><span class="comment" id="6332033">//&nbsp;Multiple&nbsp;queries&nbsp;or&nbsp;executions&nbsp;may&nbsp;be&nbsp;run&nbsp;concurrently&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6332100">//&nbsp;returned&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="6332123">func</span>&nbsp;<span class="op" id="6332128">(</span><span class="ident" id="6332129">db</span>&nbsp;<span class="op" id="6332132">*</span><span class="ident" id="6332133">DB</span><span class="op" id="6332135">)</span>&nbsp;<span class="ident" id="6332137">Prepare</span><span class="op" id="6332144">(</span><span class="ident" id="6332145">query</span>&nbsp;<span class="builtintype" id="6332151">string</span><span class="op" id="6332157">)</span>&nbsp;<span class="op" id="6332159">(</span><span class="op" id="6332160">*</span><span class="ident" id="6332161">Stmt</span><span class="op" id="6332165">,</span>&nbsp;<span class="builtintype" id="6332167">error</span><span class="op" id="6332172">)</span>&nbsp;<span class="op" id="6332174">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6332177">var</span>&nbsp;<span class="ident" id="6332181">stmt</span>&nbsp;<span class="op" id="6332186">*</span><span class="ident" id="6332187">Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6332193">var</span>&nbsp;<span class="ident" id="6332197">err</span>&nbsp;<span class="builtintype" id="6332201">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6332208">for</span>&nbsp;<span class="ident" id="6332212">i</span>&nbsp;<span class="op" id="6332214">:=</span>&nbsp;<span class="num" id="6332217">0</span><span class="op" id="6332218">;</span>&nbsp;<span class="ident" id="6332220">i</span>&nbsp;<span class="op" id="6332222">&lt;</span>&nbsp;<span class="ident" id="6332224">maxBadConnRetries</span><span class="op" id="6332241">;</span>&nbsp;<span class="ident" id="6332243">i</span><span class="op" id="6332244">++</span>&nbsp;<span class="op" id="6332247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332251">stmt</span><span class="op" id="6332255">,</span>&nbsp;<span class="ident" id="6332257">err</span>&nbsp;<span class="op" id="6332261">=</span>&nbsp;<span class="ident" id="6332263">db</span><span class="op" id="6332265">.</span><span class="ident" id="6332266">prepare</span><span class="op" id="6332273">(</span><span class="ident" id="6332274">query</span><span class="op" id="6332279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6332283">if</span>&nbsp;<span class="ident" id="6332286">err</span>&nbsp;<span class="op" id="6332290">!=</span>&nbsp;<span class="ident" id="6332293">driver</span><span class="op" id="6332299">.</span><span class="ident" id="6332300">ErrBadConn</span>&nbsp;<span class="op" id="6332311">{</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6332316">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6332324">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6332327">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6332330">return</span>&nbsp;<span class="ident" id="6332337">stmt</span><span class="op" id="6332341">,</span>&nbsp;<span class="ident" id="6332343">err</span><br>
<span class="lineno"></span><span class="op" id="6332347">}</span><br>
<span class="lineno">840</span><br>
<span class="lineno"></span><span class="keyword" id="6332350">func</span>&nbsp;<span class="op" id="6332355">(</span><span class="ident" id="6332356">db</span>&nbsp;<span class="op" id="6332359">*</span><span class="ident" id="6332360">DB</span><span class="op" id="6332362">)</span>&nbsp;<span class="ident" id="6332364">prepare</span><span class="op" id="6332371">(</span><span class="ident" id="6332372">query</span>&nbsp;<span class="builtintype" id="6332378">string</span><span class="op" id="6332384">)</span>&nbsp;<span class="op" id="6332386">(</span><span class="op" id="6332387">*</span><span class="ident" id="6332388">Stmt</span><span class="op" id="6332392">,</span>&nbsp;<span class="builtintype" id="6332394">error</span><span class="op" id="6332399">)</span>&nbsp;<span class="op" id="6332401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6332404">//&nbsp;TODO:&nbsp;check&nbsp;if&nbsp;db.driver&nbsp;supports&nbsp;an&nbsp;optional</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6332454">//&nbsp;driver.Preparer&nbsp;interface&nbsp;and&nbsp;call&nbsp;that&nbsp;instead,&nbsp;if&nbsp;so,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6332514">//&nbsp;otherwise&nbsp;we&nbsp;make&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;that&#39;s&nbsp;bound</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6332570">//&nbsp;to&nbsp;a&nbsp;connection,&nbsp;and&nbsp;to&nbsp;execute&nbsp;this&nbsp;prepared&nbsp;statement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6332630">//&nbsp;we&nbsp;either&nbsp;need&nbsp;to&nbsp;use&nbsp;this&nbsp;connection&nbsp;(if&nbsp;it&#39;s&nbsp;free),&nbsp;else</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6332693">//&nbsp;get&nbsp;a&nbsp;new&nbsp;connection&nbsp;+&nbsp;re-prepare&nbsp;+&nbsp;execute&nbsp;on&nbsp;that&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332754">dc</span><span class="op" id="6332756">,</span>&nbsp;<span class="ident" id="6332758">err</span>&nbsp;<span class="op" id="6332762">:=</span>&nbsp;<span class="ident" id="6332765">db</span><span class="op" id="6332767">.</span><span class="ident" id="6332768">conn</span><span class="op" id="6332772">(</span><span class="op" id="6332773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6332776">if</span>&nbsp;<span class="ident" id="6332779">err</span>&nbsp;<span class="op" id="6332783">!=</span>&nbsp;<span class="builtintype" id="6332786">nil</span>&nbsp;<span class="op" id="6332790">{</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6332794">return</span>&nbsp;<span class="builtintype" id="6332801">nil</span><span class="op" id="6332804">,</span>&nbsp;<span class="ident" id="6332806">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6332811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332814">dc</span><span class="op" id="6332816">.</span><span class="ident" id="6332817">Lock</span><span class="op" id="6332821">(</span><span class="op" id="6332822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332825">si</span><span class="op" id="6332827">,</span>&nbsp;<span class="ident" id="6332829">err</span>&nbsp;<span class="op" id="6332833">:=</span>&nbsp;<span class="ident" id="6332836">dc</span><span class="op" id="6332838">.</span><span class="ident" id="6332839">prepareLocked</span><span class="op" id="6332852">(</span><span class="ident" id="6332853">query</span><span class="op" id="6332858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332861">dc</span><span class="op" id="6332863">.</span><span class="ident" id="6332864">Unlock</span><span class="op" id="6332870">(</span><span class="op" id="6332871">)</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6332874">if</span>&nbsp;<span class="ident" id="6332877">err</span>&nbsp;<span class="op" id="6332881">!=</span>&nbsp;<span class="builtintype" id="6332884">nil</span>&nbsp;<span class="op" id="6332888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332892">db</span><span class="op" id="6332894">.</span><span class="ident" id="6332895">putConn</span><span class="op" id="6332902">(</span><span class="ident" id="6332903">dc</span><span class="op" id="6332905">,</span>&nbsp;<span class="ident" id="6332907">err</span><span class="op" id="6332910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6332914">return</span>&nbsp;<span class="builtintype" id="6332921">nil</span><span class="op" id="6332924">,</span>&nbsp;<span class="ident" id="6332926">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6332931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332934">stmt</span>&nbsp;<span class="op" id="6332939">:=</span>&nbsp;<span class="op" id="6332942">&amp;</span><span class="ident" id="6332943">Stmt</span><span class="op" id="6332947">{</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332951">db</span><span class="op" id="6332953">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332958">db</span><span class="op" id="6332960">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332964">query</span><span class="op" id="6332969">:</span>&nbsp;<span class="ident" id="6332971">query</span><span class="op" id="6332976">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332980">css</span><span class="op" id="6332983">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6332987">[</span><span class="op" id="6332988">]</span><span class="ident" id="6332989">connStmt</span><span class="op" id="6332997">{</span><span class="op" id="6332998">{</span><span class="ident" id="6332999">dc</span><span class="op" id="6333001">,</span>&nbsp;<span class="ident" id="6333003">si</span><span class="op" id="6333005">}</span><span class="op" id="6333006">}</span><span class="op" id="6333007">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6333010">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6333013">db</span><span class="op" id="6333015">.</span><span class="ident" id="6333016">addDep</span><span class="op" id="6333022">(</span><span class="ident" id="6333023">stmt</span><span class="op" id="6333027">,</span>&nbsp;<span class="ident" id="6333029">stmt</span><span class="op" id="6333033">)</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6333036">db</span><span class="op" id="6333038">.</span><span class="ident" id="6333039">putConn</span><span class="op" id="6333046">(</span><span class="ident" id="6333047">dc</span><span class="op" id="6333049">,</span>&nbsp;<span class="builtintype" id="6333051">nil</span><span class="op" id="6333054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6333057">return</span>&nbsp;<span class="ident" id="6333064">stmt</span><span class="op" id="6333068">,</span>&nbsp;<span class="builtintype" id="6333070">nil</span><br>
<span class="lineno"></span><span class="op" id="6333074">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6333077">//&nbsp;Exec&nbsp;executes&nbsp;a&nbsp;query&nbsp;without&nbsp;returning&nbsp;any&nbsp;rows.</span><br>
<span class="lineno">870</span><span class="comment" id="6333130">//&nbsp;The&nbsp;args&nbsp;are&nbsp;for&nbsp;any&nbsp;placeholder&nbsp;parameters&nbsp;in&nbsp;the&nbsp;query.</span><br>
<span class="lineno"></span><span class="keyword" id="6333191">func</span>&nbsp;<span class="op" id="6333196">(</span><span class="ident" id="6333197">db</span>&nbsp;<span class="op" id="6333200">*</span><span class="ident" id="6333201">DB</span><span class="op" id="6333203">)</span>&nbsp;<span class="ident" id="6333205">Exec</span><span class="op" id="6333209">(</span><span class="ident" id="6333210">query</span>&nbsp;<span class="builtintype" id="6333216">string</span><span class="op" id="6333222">,</span>&nbsp;<span class="ident" id="6333224">args</span>&nbsp;<span class="op" id="6333229">...</span><span class="keyword" id="6333232">interface</span><span class="op" id="6333241">{</span><span class="op" id="6333242">}</span><span class="op" id="6333243">)</span>&nbsp;<span class="op" id="6333245">(</span><span class="ident" id="6333246">Result</span><span class="op" id="6333252">,</span>&nbsp;<span class="builtintype" id="6333254">error</span><span class="op" id="6333259">)</span>&nbsp;<span class="op" id="6333261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6333264">var</span>&nbsp;<span class="ident" id="6333268">res</span>&nbsp;<span class="ident" id="6333272">Result</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6333280">var</span>&nbsp;<span class="ident" id="6333284">err</span>&nbsp;<span class="builtintype" id="6333288">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6333295">for</span>&nbsp;<span class="ident" id="6333299">i</span>&nbsp;<span class="op" id="6333301">:=</span>&nbsp;<span class="num" id="6333304">0</span><span class="op" id="6333305">;</span>&nbsp;<span class="ident" id="6333307">i</span>&nbsp;<span class="op" id="6333309">&lt;</span>&nbsp;<span class="ident" id="6333311">maxBadConnRetries</span><span class="op" id="6333328">;</span>&nbsp;<span class="ident" id="6333330">i</span><span class="op" id="6333331">++</span>&nbsp;<span class="op" id="6333334">{</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6333338">res</span><span class="op" id="6333341">,</span>&nbsp;<span class="ident" id="6333343">err</span>&nbsp;<span class="op" id="6333347">=</span>&nbsp;<span class="ident" id="6333349">db</span><span class="op" id="6333351">.</span><span class="ident" id="6333352">exec</span><span class="op" id="6333356">(</span><span class="ident" id="6333357">query</span><span class="op" id="6333362">,</span>&nbsp;<span class="ident" id="6333364">args</span><span class="op" id="6333368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6333372">if</span>&nbsp;<span class="ident" id="6333375">err</span>&nbsp;<span class="op" id="6333379">!=</span>&nbsp;<span class="ident" id="6333382">driver</span><span class="op" id="6333388">.</span><span class="ident" id="6333389">ErrBadConn</span>&nbsp;<span class="op" id="6333400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6333405">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6333413">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6333416">}</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6333419">return</span>&nbsp;<span class="ident" id="6333426">res</span><span class="op" id="6333429">,</span>&nbsp;<span class="ident" id="6333431">err</span><br>
<span class="lineno"></span><span class="op" id="6333435">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6333438">func</span>&nbsp;<span class="op" id="6333443">(</span><span class="ident" id="6333444">db</span>&nbsp;<span class="op" id="6333447">*</span><span class="ident" id="6333448">DB</span><span class="op" id="6333450">)</span>&nbsp;<span class="ident" id="6333452">exec</span><span class="op" id="6333456">(</span><span class="ident" id="6333457">query</span>&nbsp;<span class="builtintype" id="6333463">string</span><span class="op" id="6333469">,</span>&nbsp;<span class="ident" id="6333471">args</span>&nbsp;<span class="op" id="6333476">[</span><span class="op" id="6333477">]</span><span class="keyword" id="6333478">interface</span><span class="op" id="6333487">{</span><span class="op" id="6333488">}</span><span class="op" id="6333489">)</span>&nbsp;<span class="op" id="6333491">(</span><span class="ident" id="6333492">res</span>&nbsp;<span class="ident" id="6333496">Result</span><span class="op" id="6333502">,</span>&nbsp;<span class="ident" id="6333504">err</span>&nbsp;<span class="builtintype" id="6333508">error</span><span class="op" id="6333513">)</span>&nbsp;<span class="op" id="6333515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6333518">dc</span><span class="op" id="6333520">,</span>&nbsp;<span class="ident" id="6333522">err</span>&nbsp;<span class="op" id="6333526">:=</span>&nbsp;<span class="ident" id="6333529">db</span><span class="op" id="6333531">.</span><span class="ident" id="6333532">conn</span><span class="op" id="6333536">(</span><span class="op" id="6333537">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6333540">if</span>&nbsp;<span class="ident" id="6333543">err</span>&nbsp;<span class="op" id="6333547">!=</span>&nbsp;<span class="builtintype" id="6333550">nil</span>&nbsp;<span class="op" id="6333554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6333558">return</span>&nbsp;<span class="builtintype" id="6333565">nil</span><span class="op" id="6333568">,</span>&nbsp;<span class="ident" id="6333570">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6333575">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6333578">defer</span>&nbsp;<span class="keyword" id="6333584">func</span><span class="op" id="6333588">(</span><span class="op" id="6333589">)</span>&nbsp;<span class="op" id="6333591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6333595">db</span><span class="op" id="6333597">.</span><span class="ident" id="6333598">putConn</span><span class="op" id="6333605">(</span><span class="ident" id="6333606">dc</span><span class="op" id="6333608">,</span>&nbsp;<span class="ident" id="6333610">err</span><span class="op" id="6333613">)</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6333616">}</span><span class="op" id="6333617">(</span><span class="op" id="6333618">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6333622">if</span>&nbsp;<span class="ident" id="6333625">execer</span><span class="op" id="6333631">,</span>&nbsp;<span class="ident" id="6333633">ok</span>&nbsp;<span class="op" id="6333636">:=</span>&nbsp;<span class="ident" id="6333639">dc</span><span class="op" id="6333641">.</span><span class="ident" id="6333642">ci</span><span class="op" id="6333644">.</span><span class="op" id="6333645">(</span><span class="ident" id="6333646">driver</span><span class="op" id="6333652">.</span><span class="ident" id="6333653">Execer</span><span class="op" id="6333659">)</span><span class="op" id="6333660">;</span>&nbsp;<span class="ident" id="6333662">ok</span>&nbsp;<span class="op" id="6333665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6333669">dargs</span><span class="op" id="6333674">,</span>&nbsp;<span class="ident" id="6333676">err</span>&nbsp;<span class="op" id="6333680">:=</span>&nbsp;<span class="ident" id="6333683">driverArgs</span><span class="op" id="6333693">(</span><span class="builtintype" id="6333694">nil</span><span class="op" id="6333697">,</span>&nbsp;<span class="ident" id="6333699">args</span><span class="op" id="6333703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6333707">if</span>&nbsp;<span class="ident" id="6333710">err</span>&nbsp;<span class="op" id="6333714">!=</span>&nbsp;<span class="builtintype" id="6333717">nil</span>&nbsp;<span class="op" id="6333721">{</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6333726">return</span>&nbsp;<span class="builtintype" id="6333733">nil</span><span class="op" id="6333736">,</span>&nbsp;<span class="ident" id="6333738">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6333744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6333748">dc</span><span class="op" id="6333750">.</span><span class="ident" id="6333751">Lock</span><span class="op" id="6333755">(</span><span class="op" id="6333756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6333760">resi</span><span class="op" id="6333764">,</span>&nbsp;<span class="ident" id="6333766">err</span>&nbsp;<span class="op" id="6333770">:=</span>&nbsp;<span class="ident" id="6333773">execer</span><span class="op" id="6333779">.</span><span class="ident" id="6333780">Exec</span><span class="op" id="6333784">(</span><span class="ident" id="6333785">query</span><span class="op" id="6333790">,</span>&nbsp;<span class="ident" id="6333792">dargs</span><span class="op" id="6333797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6333801">dc</span><span class="op" id="6333803">.</span><span class="ident" id="6333804">Unlock</span><span class="op" id="6333810">(</span><span class="op" id="6333811">)</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6333815">if</span>&nbsp;<span class="ident" id="6333818">err</span>&nbsp;<span class="op" id="6333822">!=</span>&nbsp;<span class="ident" id="6333825">driver</span><span class="op" id="6333831">.</span><span class="ident" id="6333832">ErrSkip</span>&nbsp;<span class="op" id="6333840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6333845">if</span>&nbsp;<span class="ident" id="6333848">err</span>&nbsp;<span class="op" id="6333852">!=</span>&nbsp;<span class="builtintype" id="6333855">nil</span>&nbsp;<span class="op" id="6333859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6333865">return</span>&nbsp;<span class="builtintype" id="6333872">nil</span><span class="op" id="6333875">,</span>&nbsp;<span class="ident" id="6333877">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6333884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6333889">return</span>&nbsp;<span class="ident" id="6333896">driverResult</span><span class="op" id="6333908">{</span><span class="ident" id="6333909">dc</span><span class="op" id="6333911">,</span>&nbsp;<span class="ident" id="6333913">resi</span><span class="op" id="6333917">}</span><span class="op" id="6333918">,</span>&nbsp;<span class="builtintype" id="6333920">nil</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6333926">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6333929">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6333933">dc</span><span class="op" id="6333935">.</span><span class="ident" id="6333936">Lock</span><span class="op" id="6333940">(</span><span class="op" id="6333941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6333944">si</span><span class="op" id="6333946">,</span>&nbsp;<span class="ident" id="6333948">err</span>&nbsp;<span class="op" id="6333952">:=</span>&nbsp;<span class="ident" id="6333955">dc</span><span class="op" id="6333957">.</span><span class="ident" id="6333958">ci</span><span class="op" id="6333960">.</span><span class="ident" id="6333961">Prepare</span><span class="op" id="6333968">(</span><span class="ident" id="6333969">query</span><span class="op" id="6333974">)</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6333977">dc</span><span class="op" id="6333979">.</span><span class="ident" id="6333980">Unlock</span><span class="op" id="6333986">(</span><span class="op" id="6333987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6333990">if</span>&nbsp;<span class="ident" id="6333993">err</span>&nbsp;<span class="op" id="6333997">!=</span>&nbsp;<span class="builtintype" id="6334000">nil</span>&nbsp;<span class="op" id="6334004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6334008">return</span>&nbsp;<span class="builtintype" id="6334015">nil</span><span class="op" id="6334018">,</span>&nbsp;<span class="ident" id="6334020">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6334025">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6334028">defer</span>&nbsp;<span class="ident" id="6334034">withLock</span><span class="op" id="6334042">(</span><span class="ident" id="6334043">dc</span><span class="op" id="6334045">,</span>&nbsp;<span class="keyword" id="6334047">func</span><span class="op" id="6334051">(</span><span class="op" id="6334052">)</span>&nbsp;<span class="op" id="6334054">{</span>&nbsp;<span class="ident" id="6334056">si</span><span class="op" id="6334058">.</span><span class="ident" id="6334059">Close</span><span class="op" id="6334064">(</span><span class="op" id="6334065">)</span>&nbsp;<span class="op" id="6334067">}</span><span class="op" id="6334068">)</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6334071">return</span>&nbsp;<span class="ident" id="6334078">resultFromStatement</span><span class="op" id="6334097">(</span><span class="ident" id="6334098">driverStmt</span><span class="op" id="6334108">{</span><span class="ident" id="6334109">dc</span><span class="op" id="6334111">,</span>&nbsp;<span class="ident" id="6334113">si</span><span class="op" id="6334115">}</span><span class="op" id="6334116">,</span>&nbsp;<span class="ident" id="6334118">args</span><span class="op" id="6334122">...</span><span class="op" id="6334125">)</span><br>
<span class="lineno"></span><span class="op" id="6334127">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6334130">//&nbsp;Query&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;returns&nbsp;rows,&nbsp;typically&nbsp;a&nbsp;SELECT.</span><br>
<span class="lineno"></span><span class="comment" id="6334195">//&nbsp;The&nbsp;args&nbsp;are&nbsp;for&nbsp;any&nbsp;placeholder&nbsp;parameters&nbsp;in&nbsp;the&nbsp;query.</span><br>
<span class="lineno">920</span><span class="keyword" id="6334256">func</span>&nbsp;<span class="op" id="6334261">(</span><span class="ident" id="6334262">db</span>&nbsp;<span class="op" id="6334265">*</span><span class="ident" id="6334266">DB</span><span class="op" id="6334268">)</span>&nbsp;<span class="ident" id="6334270">Query</span><span class="op" id="6334275">(</span><span class="ident" id="6334276">query</span>&nbsp;<span class="builtintype" id="6334282">string</span><span class="op" id="6334288">,</span>&nbsp;<span class="ident" id="6334290">args</span>&nbsp;<span class="op" id="6334295">...</span><span class="keyword" id="6334298">interface</span><span class="op" id="6334307">{</span><span class="op" id="6334308">}</span><span class="op" id="6334309">)</span>&nbsp;<span class="op" id="6334311">(</span><span class="op" id="6334312">*</span><span class="ident" id="6334313">Rows</span><span class="op" id="6334317">,</span>&nbsp;<span class="builtintype" id="6334319">error</span><span class="op" id="6334324">)</span>&nbsp;<span class="op" id="6334326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6334329">var</span>&nbsp;<span class="ident" id="6334333">rows</span>&nbsp;<span class="op" id="6334338">*</span><span class="ident" id="6334339">Rows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6334345">var</span>&nbsp;<span class="ident" id="6334349">err</span>&nbsp;<span class="builtintype" id="6334353">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6334360">for</span>&nbsp;<span class="ident" id="6334364">i</span>&nbsp;<span class="op" id="6334366">:=</span>&nbsp;<span class="num" id="6334369">0</span><span class="op" id="6334370">;</span>&nbsp;<span class="ident" id="6334372">i</span>&nbsp;<span class="op" id="6334374">&lt;</span>&nbsp;<span class="ident" id="6334376">maxBadConnRetries</span><span class="op" id="6334393">;</span>&nbsp;<span class="ident" id="6334395">i</span><span class="op" id="6334396">++</span>&nbsp;<span class="op" id="6334399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6334403">rows</span><span class="op" id="6334407">,</span>&nbsp;<span class="ident" id="6334409">err</span>&nbsp;<span class="op" id="6334413">=</span>&nbsp;<span class="ident" id="6334415">db</span><span class="op" id="6334417">.</span><span class="ident" id="6334418">query</span><span class="op" id="6334423">(</span><span class="ident" id="6334424">query</span><span class="op" id="6334429">,</span>&nbsp;<span class="ident" id="6334431">args</span><span class="op" id="6334435">)</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6334439">if</span>&nbsp;<span class="ident" id="6334442">err</span>&nbsp;<span class="op" id="6334446">!=</span>&nbsp;<span class="ident" id="6334449">driver</span><span class="op" id="6334455">.</span><span class="ident" id="6334456">ErrBadConn</span>&nbsp;<span class="op" id="6334467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6334472">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6334480">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6334483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6334486">return</span>&nbsp;<span class="ident" id="6334493">rows</span><span class="op" id="6334497">,</span>&nbsp;<span class="ident" id="6334499">err</span><br>
<span class="lineno">930</span><span class="op" id="6334503">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6334506">func</span>&nbsp;<span class="op" id="6334511">(</span><span class="ident" id="6334512">db</span>&nbsp;<span class="op" id="6334515">*</span><span class="ident" id="6334516">DB</span><span class="op" id="6334518">)</span>&nbsp;<span class="ident" id="6334520">query</span><span class="op" id="6334525">(</span><span class="ident" id="6334526">query</span>&nbsp;<span class="builtintype" id="6334532">string</span><span class="op" id="6334538">,</span>&nbsp;<span class="ident" id="6334540">args</span>&nbsp;<span class="op" id="6334545">[</span><span class="op" id="6334546">]</span><span class="keyword" id="6334547">interface</span><span class="op" id="6334556">{</span><span class="op" id="6334557">}</span><span class="op" id="6334558">)</span>&nbsp;<span class="op" id="6334560">(</span><span class="op" id="6334561">*</span><span class="ident" id="6334562">Rows</span><span class="op" id="6334566">,</span>&nbsp;<span class="builtintype" id="6334568">error</span><span class="op" id="6334573">)</span>&nbsp;<span class="op" id="6334575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6334578">ci</span><span class="op" id="6334580">,</span>&nbsp;<span class="ident" id="6334582">err</span>&nbsp;<span class="op" id="6334586">:=</span>&nbsp;<span class="ident" id="6334589">db</span><span class="op" id="6334591">.</span><span class="ident" id="6334592">conn</span><span class="op" id="6334596">(</span><span class="op" id="6334597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6334600">if</span>&nbsp;<span class="ident" id="6334603">err</span>&nbsp;<span class="op" id="6334607">!=</span>&nbsp;<span class="builtintype" id="6334610">nil</span>&nbsp;<span class="op" id="6334614">{</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6334618">return</span>&nbsp;<span class="builtintype" id="6334625">nil</span><span class="op" id="6334628">,</span>&nbsp;<span class="ident" id="6334630">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6334635">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6334639">return</span>&nbsp;<span class="ident" id="6334646">db</span><span class="op" id="6334648">.</span><span class="ident" id="6334649">queryConn</span><span class="op" id="6334658">(</span><span class="ident" id="6334659">ci</span><span class="op" id="6334661">,</span>&nbsp;<span class="ident" id="6334663">ci</span><span class="op" id="6334665">.</span><span class="ident" id="6334666">releaseConn</span><span class="op" id="6334677">,</span>&nbsp;<span class="ident" id="6334679">query</span><span class="op" id="6334684">,</span>&nbsp;<span class="ident" id="6334686">args</span><span class="op" id="6334690">)</span><br>
<span class="lineno"></span><span class="op" id="6334692">}</span><br>
<span class="lineno">940</span><br>
<span class="lineno"></span><span class="comment" id="6334695">//&nbsp;queryConn&nbsp;executes&nbsp;a&nbsp;query&nbsp;on&nbsp;the&nbsp;given&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="6334750">//&nbsp;The&nbsp;connection&nbsp;gets&nbsp;released&nbsp;by&nbsp;the&nbsp;releaseConn&nbsp;function.</span><br>
<span class="lineno"></span><span class="keyword" id="6334811">func</span>&nbsp;<span class="op" id="6334816">(</span><span class="ident" id="6334817">db</span>&nbsp;<span class="op" id="6334820">*</span><span class="ident" id="6334821">DB</span><span class="op" id="6334823">)</span>&nbsp;<span class="ident" id="6334825">queryConn</span><span class="op" id="6334834">(</span><span class="ident" id="6334835">dc</span>&nbsp;<span class="op" id="6334838">*</span><span class="ident" id="6334839">driverConn</span><span class="op" id="6334849">,</span>&nbsp;<span class="ident" id="6334851">releaseConn</span>&nbsp;<span class="keyword" id="6334863">func</span><span class="op" id="6334867">(</span><span class="builtintype" id="6334868">error</span><span class="op" id="6334873">)</span><span class="op" id="6334874">,</span>&nbsp;<span class="ident" id="6334876">query</span>&nbsp;<span class="builtintype" id="6334882">string</span><span class="op" id="6334888">,</span>&nbsp;<span class="ident" id="6334890">args</span>&nbsp;<span class="op" id="6334895">[</span><span class="op" id="6334896">]</span><span class="keyword" id="6334897">interface</span><span class="op" id="6334906">{</span><span class="op" id="6334907">}</span><span class="op" id="6334908">)</span>&nbsp;<span class="op" id="6334910">(</span><span class="op" id="6334911">*</span><span class="ident" id="6334912">Rows</span><span class="op" id="6334916">,</span>&nbsp;<span class="builtintype" id="6334918">error</span><span class="op" id="6334923">)</span>&nbsp;<span class="op" id="6334925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6334928">if</span>&nbsp;<span class="ident" id="6334931">queryer</span><span class="op" id="6334938">,</span>&nbsp;<span class="ident" id="6334940">ok</span>&nbsp;<span class="op" id="6334943">:=</span>&nbsp;<span class="ident" id="6334946">dc</span><span class="op" id="6334948">.</span><span class="ident" id="6334949">ci</span><span class="op" id="6334951">.</span><span class="op" id="6334952">(</span><span class="ident" id="6334953">driver</span><span class="op" id="6334959">.</span><span class="ident" id="6334960">Queryer</span><span class="op" id="6334967">)</span><span class="op" id="6334968">;</span>&nbsp;<span class="ident" id="6334970">ok</span>&nbsp;<span class="op" id="6334973">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6334977">dargs</span><span class="op" id="6334982">,</span>&nbsp;<span class="ident" id="6334984">err</span>&nbsp;<span class="op" id="6334988">:=</span>&nbsp;<span class="ident" id="6334991">driverArgs</span><span class="op" id="6335001">(</span><span class="builtintype" id="6335002">nil</span><span class="op" id="6335005">,</span>&nbsp;<span class="ident" id="6335007">args</span><span class="op" id="6335011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6335015">if</span>&nbsp;<span class="ident" id="6335018">err</span>&nbsp;<span class="op" id="6335022">!=</span>&nbsp;<span class="builtintype" id="6335025">nil</span>&nbsp;<span class="op" id="6335029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335034">releaseConn</span><span class="op" id="6335045">(</span><span class="ident" id="6335046">err</span><span class="op" id="6335049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6335054">return</span>&nbsp;<span class="builtintype" id="6335061">nil</span><span class="op" id="6335064">,</span>&nbsp;<span class="ident" id="6335066">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6335072">}</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335076">dc</span><span class="op" id="6335078">.</span><span class="ident" id="6335079">Lock</span><span class="op" id="6335083">(</span><span class="op" id="6335084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335088">rowsi</span><span class="op" id="6335093">,</span>&nbsp;<span class="ident" id="6335095">err</span>&nbsp;<span class="op" id="6335099">:=</span>&nbsp;<span class="ident" id="6335102">queryer</span><span class="op" id="6335109">.</span><span class="ident" id="6335110">Query</span><span class="op" id="6335115">(</span><span class="ident" id="6335116">query</span><span class="op" id="6335121">,</span>&nbsp;<span class="ident" id="6335123">dargs</span><span class="op" id="6335128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335132">dc</span><span class="op" id="6335134">.</span><span class="ident" id="6335135">Unlock</span><span class="op" id="6335141">(</span><span class="op" id="6335142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6335146">if</span>&nbsp;<span class="ident" id="6335149">err</span>&nbsp;<span class="op" id="6335153">!=</span>&nbsp;<span class="ident" id="6335156">driver</span><span class="op" id="6335162">.</span><span class="ident" id="6335163">ErrSkip</span>&nbsp;<span class="op" id="6335171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6335176">if</span>&nbsp;<span class="ident" id="6335179">err</span>&nbsp;<span class="op" id="6335183">!=</span>&nbsp;<span class="builtintype" id="6335186">nil</span>&nbsp;<span class="op" id="6335190">{</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335196">releaseConn</span><span class="op" id="6335207">(</span><span class="ident" id="6335208">err</span><span class="op" id="6335211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6335217">return</span>&nbsp;<span class="builtintype" id="6335224">nil</span><span class="op" id="6335227">,</span>&nbsp;<span class="ident" id="6335229">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6335236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6335241">//&nbsp;Note:&nbsp;ownership&nbsp;of&nbsp;dc&nbsp;passes&nbsp;to&nbsp;the&nbsp;*Rows,&nbsp;to&nbsp;be&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6335302">//&nbsp;with&nbsp;releaseConn.</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335326">rows</span>&nbsp;<span class="op" id="6335331">:=</span>&nbsp;<span class="op" id="6335334">&amp;</span><span class="ident" id="6335335">Rows</span><span class="op" id="6335339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335345">dc</span><span class="op" id="6335347">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335358">dc</span><span class="op" id="6335360">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335366">releaseConn</span><span class="op" id="6335377">:</span>&nbsp;<span class="ident" id="6335379">releaseConn</span><span class="op" id="6335390">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335396">rowsi</span><span class="op" id="6335401">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335409">rowsi</span><span class="op" id="6335414">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6335419">}</span><br>
<span class="lineno">965</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6335424">return</span>&nbsp;<span class="ident" id="6335431">rows</span><span class="op" id="6335435">,</span>&nbsp;<span class="builtintype" id="6335437">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6335443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6335446">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335450">dc</span><span class="op" id="6335452">.</span><span class="ident" id="6335453">Lock</span><span class="op" id="6335457">(</span><span class="op" id="6335458">)</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335461">si</span><span class="op" id="6335463">,</span>&nbsp;<span class="ident" id="6335465">err</span>&nbsp;<span class="op" id="6335469">:=</span>&nbsp;<span class="ident" id="6335472">dc</span><span class="op" id="6335474">.</span><span class="ident" id="6335475">ci</span><span class="op" id="6335477">.</span><span class="ident" id="6335478">Prepare</span><span class="op" id="6335485">(</span><span class="ident" id="6335486">query</span><span class="op" id="6335491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335494">dc</span><span class="op" id="6335496">.</span><span class="ident" id="6335497">Unlock</span><span class="op" id="6335503">(</span><span class="op" id="6335504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6335507">if</span>&nbsp;<span class="ident" id="6335510">err</span>&nbsp;<span class="op" id="6335514">!=</span>&nbsp;<span class="builtintype" id="6335517">nil</span>&nbsp;<span class="op" id="6335521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335525">releaseConn</span><span class="op" id="6335536">(</span><span class="ident" id="6335537">err</span><span class="op" id="6335540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6335544">return</span>&nbsp;<span class="builtintype" id="6335551">nil</span><span class="op" id="6335554">,</span>&nbsp;<span class="ident" id="6335556">err</span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6335561">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335565">ds</span>&nbsp;<span class="op" id="6335568">:=</span>&nbsp;<span class="ident" id="6335571">driverStmt</span><span class="op" id="6335581">{</span><span class="ident" id="6335582">dc</span><span class="op" id="6335584">,</span>&nbsp;<span class="ident" id="6335586">si</span><span class="op" id="6335588">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335591">rowsi</span><span class="op" id="6335596">,</span>&nbsp;<span class="ident" id="6335598">err</span>&nbsp;<span class="op" id="6335602">:=</span>&nbsp;<span class="ident" id="6335605">rowsiFromStatement</span><span class="op" id="6335623">(</span><span class="ident" id="6335624">ds</span><span class="op" id="6335626">,</span>&nbsp;<span class="ident" id="6335628">args</span><span class="op" id="6335632">...</span><span class="op" id="6335635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6335638">if</span>&nbsp;<span class="ident" id="6335641">err</span>&nbsp;<span class="op" id="6335645">!=</span>&nbsp;<span class="builtintype" id="6335648">nil</span>&nbsp;<span class="op" id="6335652">{</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335656">dc</span><span class="op" id="6335658">.</span><span class="ident" id="6335659">Lock</span><span class="op" id="6335663">(</span><span class="op" id="6335664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335668">si</span><span class="op" id="6335670">.</span><span class="ident" id="6335671">Close</span><span class="op" id="6335676">(</span><span class="op" id="6335677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335681">dc</span><span class="op" id="6335683">.</span><span class="ident" id="6335684">Unlock</span><span class="op" id="6335690">(</span><span class="op" id="6335691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335695">releaseConn</span><span class="op" id="6335706">(</span><span class="ident" id="6335707">err</span><span class="op" id="6335710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6335714">return</span>&nbsp;<span class="builtintype" id="6335721">nil</span><span class="op" id="6335724">,</span>&nbsp;<span class="ident" id="6335726">err</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6335731">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6335735">//&nbsp;Note:&nbsp;ownership&nbsp;of&nbsp;ci&nbsp;passes&nbsp;to&nbsp;the&nbsp;*Rows,&nbsp;to&nbsp;be&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6335794">//&nbsp;with&nbsp;releaseConn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335816">rows</span>&nbsp;<span class="op" id="6335821">:=</span>&nbsp;<span class="op" id="6335824">&amp;</span><span class="ident" id="6335825">Rows</span><span class="op" id="6335829">{</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335833">dc</span><span class="op" id="6335835">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335846">dc</span><span class="op" id="6335848">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335852">releaseConn</span><span class="op" id="6335863">:</span>&nbsp;<span class="ident" id="6335865">releaseConn</span><span class="op" id="6335876">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335880">rowsi</span><span class="op" id="6335885">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335893">rowsi</span><span class="op" id="6335898">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335902">closeStmt</span><span class="op" id="6335911">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6335915">si</span><span class="op" id="6335917">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6335920">}</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6335923">return</span>&nbsp;<span class="ident" id="6335930">rows</span><span class="op" id="6335934">,</span>&nbsp;<span class="builtintype" id="6335936">nil</span><br>
<span class="lineno"></span><span class="op" id="6335940">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6335943">//&nbsp;QueryRow&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;is&nbsp;expected&nbsp;to&nbsp;return&nbsp;at&nbsp;most&nbsp;one&nbsp;row.</span><br>
<span class="lineno"></span><span class="comment" id="6336016">//&nbsp;QueryRow&nbsp;always&nbsp;return&nbsp;a&nbsp;non-nil&nbsp;value.&nbsp;Errors&nbsp;are&nbsp;deferred&nbsp;until</span><br>
<span class="lineno">1000</span><span class="comment" id="6336085">//&nbsp;Row&#39;s&nbsp;Scan&nbsp;method&nbsp;is&nbsp;called.</span><br>
<span class="lineno"></span><span class="keyword" id="6336117">func</span>&nbsp;<span class="op" id="6336122">(</span><span class="ident" id="6336123">db</span>&nbsp;<span class="op" id="6336126">*</span><span class="ident" id="6336127">DB</span><span class="op" id="6336129">)</span>&nbsp;<span class="ident" id="6336131">QueryRow</span><span class="op" id="6336139">(</span><span class="ident" id="6336140">query</span>&nbsp;<span class="builtintype" id="6336146">string</span><span class="op" id="6336152">,</span>&nbsp;<span class="ident" id="6336154">args</span>&nbsp;<span class="op" id="6336159">...</span><span class="keyword" id="6336162">interface</span><span class="op" id="6336171">{</span><span class="op" id="6336172">}</span><span class="op" id="6336173">)</span>&nbsp;<span class="op" id="6336175">*</span><span class="ident" id="6336176">Row</span>&nbsp;<span class="op" id="6336180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6336183">rows</span><span class="op" id="6336187">,</span>&nbsp;<span class="ident" id="6336189">err</span>&nbsp;<span class="op" id="6336193">:=</span>&nbsp;<span class="ident" id="6336196">db</span><span class="op" id="6336198">.</span><span class="ident" id="6336199">Query</span><span class="op" id="6336204">(</span><span class="ident" id="6336205">query</span><span class="op" id="6336210">,</span>&nbsp;<span class="ident" id="6336212">args</span><span class="op" id="6336216">...</span><span class="op" id="6336219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6336222">return</span>&nbsp;<span class="op" id="6336229">&amp;</span><span class="ident" id="6336230">Row</span><span class="op" id="6336233">{</span><span class="ident" id="6336234">rows</span><span class="op" id="6336238">:</span>&nbsp;<span class="ident" id="6336240">rows</span><span class="op" id="6336244">,</span>&nbsp;<span class="ident" id="6336246">err</span><span class="op" id="6336249">:</span>&nbsp;<span class="ident" id="6336251">err</span><span class="op" id="6336254">}</span><br>
<span class="lineno"></span><span class="op" id="6336256">}</span><br>
<span class="lineno">1005</span><br>
<span class="lineno"></span><span class="comment" id="6336259">//&nbsp;Begin&nbsp;starts&nbsp;a&nbsp;transaction.&nbsp;The&nbsp;isolation&nbsp;level&nbsp;is&nbsp;dependent&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="6336326">//&nbsp;the&nbsp;driver.</span><br>
<span class="lineno"></span><span class="keyword" id="6336341">func</span>&nbsp;<span class="op" id="6336346">(</span><span class="ident" id="6336347">db</span>&nbsp;<span class="op" id="6336350">*</span><span class="ident" id="6336351">DB</span><span class="op" id="6336353">)</span>&nbsp;<span class="ident" id="6336355">Begin</span><span class="op" id="6336360">(</span><span class="op" id="6336361">)</span>&nbsp;<span class="op" id="6336363">(</span><span class="op" id="6336364">*</span><span class="ident" id="6336365">Tx</span><span class="op" id="6336367">,</span>&nbsp;<span class="builtintype" id="6336369">error</span><span class="op" id="6336374">)</span>&nbsp;<span class="op" id="6336376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6336379">var</span>&nbsp;<span class="ident" id="6336383">tx</span>&nbsp;<span class="op" id="6336386">*</span><span class="ident" id="6336387">Tx</span><br>
<span class="lineno">1010</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6336391">var</span>&nbsp;<span class="ident" id="6336395">err</span>&nbsp;<span class="builtintype" id="6336399">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6336406">for</span>&nbsp;<span class="ident" id="6336410">i</span>&nbsp;<span class="op" id="6336412">:=</span>&nbsp;<span class="num" id="6336415">0</span><span class="op" id="6336416">;</span>&nbsp;<span class="ident" id="6336418">i</span>&nbsp;<span class="op" id="6336420">&lt;</span>&nbsp;<span class="ident" id="6336422">maxBadConnRetries</span><span class="op" id="6336439">;</span>&nbsp;<span class="ident" id="6336441">i</span><span class="op" id="6336442">++</span>&nbsp;<span class="op" id="6336445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6336449">tx</span><span class="op" id="6336451">,</span>&nbsp;<span class="ident" id="6336453">err</span>&nbsp;<span class="op" id="6336457">=</span>&nbsp;<span class="ident" id="6336459">db</span><span class="op" id="6336461">.</span><span class="ident" id="6336462">begin</span><span class="op" id="6336467">(</span><span class="op" id="6336468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6336472">if</span>&nbsp;<span class="ident" id="6336475">err</span>&nbsp;<span class="op" id="6336479">!=</span>&nbsp;<span class="ident" id="6336482">driver</span><span class="op" id="6336488">.</span><span class="ident" id="6336489">ErrBadConn</span>&nbsp;<span class="op" id="6336500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6336505">break</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6336513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6336516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6336519">return</span>&nbsp;<span class="ident" id="6336526">tx</span><span class="op" id="6336528">,</span>&nbsp;<span class="ident" id="6336530">err</span><br>
<span class="lineno"></span><span class="op" id="6336534">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1020</span><span class="keyword" id="6336537">func</span>&nbsp;<span class="op" id="6336542">(</span><span class="ident" id="6336543">db</span>&nbsp;<span class="op" id="6336546">*</span><span class="ident" id="6336547">DB</span><span class="op" id="6336549">)</span>&nbsp;<span class="ident" id="6336551">begin</span><span class="op" id="6336556">(</span><span class="op" id="6336557">)</span>&nbsp;<span class="op" id="6336559">(</span><span class="ident" id="6336560">tx</span>&nbsp;<span class="op" id="6336563">*</span><span class="ident" id="6336564">Tx</span><span class="op" id="6336566">,</span>&nbsp;<span class="ident" id="6336568">err</span>&nbsp;<span class="builtintype" id="6336572">error</span><span class="op" id="6336577">)</span>&nbsp;<span class="op" id="6336579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6336582">dc</span><span class="op" id="6336584">,</span>&nbsp;<span class="ident" id="6336586">err</span>&nbsp;<span class="op" id="6336590">:=</span>&nbsp;<span class="ident" id="6336593">db</span><span class="op" id="6336595">.</span><span class="ident" id="6336596">conn</span><span class="op" id="6336600">(</span><span class="op" id="6336601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6336604">if</span>&nbsp;<span class="ident" id="6336607">err</span>&nbsp;<span class="op" id="6336611">!=</span>&nbsp;<span class="builtintype" id="6336614">nil</span>&nbsp;<span class="op" id="6336618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6336622">return</span>&nbsp;<span class="builtintype" id="6336629">nil</span><span class="op" id="6336632">,</span>&nbsp;<span class="ident" id="6336634">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6336639">}</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6336642">dc</span><span class="op" id="6336644">.</span><span class="ident" id="6336645">Lock</span><span class="op" id="6336649">(</span><span class="op" id="6336650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6336653">txi</span><span class="op" id="6336656">,</span>&nbsp;<span class="ident" id="6336658">err</span>&nbsp;<span class="op" id="6336662">:=</span>&nbsp;<span class="ident" id="6336665">dc</span><span class="op" id="6336667">.</span><span class="ident" id="6336668">ci</span><span class="op" id="6336670">.</span><span class="ident" id="6336671">Begin</span><span class="op" id="6336676">(</span><span class="op" id="6336677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6336680">dc</span><span class="op" id="6336682">.</span><span class="ident" id="6336683">Unlock</span><span class="op" id="6336689">(</span><span class="op" id="6336690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6336693">if</span>&nbsp;<span class="ident" id="6336696">err</span>&nbsp;<span class="op" id="6336700">!=</span>&nbsp;<span class="builtintype" id="6336703">nil</span>&nbsp;<span class="op" id="6336707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6336711">db</span><span class="op" id="6336713">.</span><span class="ident" id="6336714">putConn</span><span class="op" id="6336721">(</span><span class="ident" id="6336722">dc</span><span class="op" id="6336724">,</span>&nbsp;<span class="ident" id="6336726">err</span><span class="op" id="6336729">)</span><br>
<span class="lineno">1030</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6336733">return</span>&nbsp;<span class="builtintype" id="6336740">nil</span><span class="op" id="6336743">,</span>&nbsp;<span class="ident" id="6336745">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6336750">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6336753">return</span>&nbsp;<span class="op" id="6336760">&amp;</span><span class="ident" id="6336761">Tx</span><span class="op" id="6336763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6336767">db</span><span class="op" id="6336769">:</span>&nbsp;&nbsp;<span class="ident" id="6336772">db</span><span class="op" id="6336774">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6336778">dc</span><span class="op" id="6336780">:</span>&nbsp;&nbsp;<span class="ident" id="6336783">dc</span><span class="op" id="6336785">,</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6336789">txi</span><span class="op" id="6336792">:</span>&nbsp;<span class="ident" id="6336794">txi</span><span class="op" id="6336797">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6336800">}</span><span class="op" id="6336801">,</span>&nbsp;<span class="builtintype" id="6336803">nil</span><br>
<span class="lineno"></span><span class="op" id="6336807">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6336810">//&nbsp;Driver&nbsp;returns&nbsp;the&nbsp;database&#39;s&nbsp;underlying&nbsp;driver.</span><br>
<span class="lineno">1040</span><span class="keyword" id="6336862">func</span>&nbsp;<span class="op" id="6336867">(</span><span class="ident" id="6336868">db</span>&nbsp;<span class="op" id="6336871">*</span><span class="ident" id="6336872">DB</span><span class="op" id="6336874">)</span>&nbsp;<span class="ident" id="6336876">Driver</span><span class="op" id="6336882">(</span><span class="op" id="6336883">)</span>&nbsp;<span class="ident" id="6336885">driver</span><span class="op" id="6336891">.</span><span class="ident" id="6336892">Driver</span>&nbsp;<span class="op" id="6336899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6336902">return</span>&nbsp;<span class="ident" id="6336909">db</span><span class="op" id="6336911">.</span><span class="ident" id="6336912">driver</span><br>
<span class="lineno"></span><span class="op" id="6336919">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6336922">//&nbsp;Tx&nbsp;is&nbsp;an&nbsp;in-progress&nbsp;database&nbsp;transaction.</span><br>
<span class="lineno">1045</span><span class="comment" id="6336968">//</span><br>
<span class="lineno"></span><span class="comment" id="6336971">//&nbsp;A&nbsp;transaction&nbsp;must&nbsp;end&nbsp;with&nbsp;a&nbsp;call&nbsp;to&nbsp;Commit&nbsp;or&nbsp;Rollback.</span><br>
<span class="lineno"></span><span class="comment" id="6337032">//</span><br>
<span class="lineno"></span><span class="comment" id="6337035">//&nbsp;After&nbsp;a&nbsp;call&nbsp;to&nbsp;Commit&nbsp;or&nbsp;Rollback,&nbsp;all&nbsp;operations&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6337096">//&nbsp;transaction&nbsp;fail&nbsp;with&nbsp;ErrTxDone.</span><br>
<span class="lineno">1050</span><span class="keyword" id="6337132">type</span>&nbsp;<span class="ident" id="6337137">Tx</span>&nbsp;<span class="keyword" id="6337140">struct</span>&nbsp;<span class="op" id="6337147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6337150">db</span>&nbsp;<span class="op" id="6337153">*</span><span class="ident" id="6337154">DB</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6337159">//&nbsp;dc&nbsp;is&nbsp;owned&nbsp;exclusively&nbsp;until&nbsp;Commit&nbsp;or&nbsp;Rollback,&nbsp;at&nbsp;which&nbsp;point</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6337228">//&nbsp;it&#39;s&nbsp;returned&nbsp;with&nbsp;putConn.</span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6337260">dc</span>&nbsp;&nbsp;<span class="op" id="6337264">*</span><span class="ident" id="6337265">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6337277">txi</span>&nbsp;<span class="ident" id="6337281">driver</span><span class="op" id="6337287">.</span><span class="ident" id="6337288">Tx</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6337293">//&nbsp;done&nbsp;transitions&nbsp;from&nbsp;false&nbsp;to&nbsp;true&nbsp;exactly&nbsp;once,&nbsp;on&nbsp;Commit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6337357">//&nbsp;or&nbsp;Rollback.&nbsp;once&nbsp;done,&nbsp;all&nbsp;operations&nbsp;fail&nbsp;with</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6337410">//&nbsp;ErrTxDone.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6337425">done</span>&nbsp;<span class="builtintype" id="6337430">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6337437">//&nbsp;All&nbsp;Stmts&nbsp;prepared&nbsp;for&nbsp;this&nbsp;transaction.&nbsp;&nbsp;These&nbsp;will&nbsp;be&nbsp;closed&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6337514">//&nbsp;transaction&nbsp;has&nbsp;been&nbsp;committed&nbsp;or&nbsp;rolled&nbsp;back.</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6337565">stmts</span>&nbsp;<span class="keyword" id="6337571">struct</span>&nbsp;<span class="op" id="6337578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6337582">sync</span><span class="op" id="6337586">.</span><span class="ident" id="6337587">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6337595">v</span>&nbsp;<span class="op" id="6337597">[</span><span class="op" id="6337598">]</span><span class="op" id="6337599">*</span><span class="ident" id="6337600">Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6337606">}</span><br>
<span class="lineno"></span><span class="op" id="6337608">}</span><br>
<span class="lineno">1070</span><br>
<span class="lineno"></span><span class="keyword" id="6337611">var</span>&nbsp;<span class="ident" id="6337615">ErrTxDone</span>&nbsp;<span class="op" id="6337625">=</span>&nbsp;<span class="ident" id="6337627">errors</span><span class="op" id="6337633">.</span><span class="ident" id="6337634">New</span><span class="op" id="6337637">(</span><span class="string" id="6337638">&#34;sql:&nbsp;Transaction&nbsp;has&nbsp;already&nbsp;been&nbsp;committed&nbsp;or&nbsp;rolled&nbsp;back&#34;</span><span class="op" id="6337698">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6337701">func</span>&nbsp;<span class="op" id="6337706">(</span><span class="ident" id="6337707">tx</span>&nbsp;<span class="op" id="6337710">*</span><span class="ident" id="6337711">Tx</span><span class="op" id="6337713">)</span>&nbsp;<span class="builtinfunc" id="6337715">close</span><span class="op" id="6337720">(</span><span class="op" id="6337721">)</span>&nbsp;<span class="op" id="6337723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6337726">if</span>&nbsp;<span class="ident" id="6337729">tx</span><span class="op" id="6337731">.</span><span class="ident" id="6337732">done</span>&nbsp;<span class="op" id="6337737">{</span><br>
<span class="lineno">1075</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6337741">panic</span><span class="op" id="6337746">(</span><span class="string" id="6337747">&#34;double&nbsp;close&#34;</span><span class="op" id="6337761">)</span>&nbsp;<span class="comment" id="6337763">//&nbsp;internal&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6337782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6337785">tx</span><span class="op" id="6337787">.</span><span class="ident" id="6337788">done</span>&nbsp;<span class="op" id="6337793">=</span>&nbsp;<span class="builtintype" id="6337795">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6337801">tx</span><span class="op" id="6337803">.</span><span class="ident" id="6337804">db</span><span class="op" id="6337806">.</span><span class="ident" id="6337807">putConn</span><span class="op" id="6337814">(</span><span class="ident" id="6337815">tx</span><span class="op" id="6337817">.</span><span class="ident" id="6337818">dc</span><span class="op" id="6337820">,</span>&nbsp;<span class="builtintype" id="6337822">nil</span><span class="op" id="6337825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6337828">tx</span><span class="op" id="6337830">.</span><span class="ident" id="6337831">dc</span>&nbsp;<span class="op" id="6337834">=</span>&nbsp;<span class="builtintype" id="6337836">nil</span><br>
<span class="lineno">1080</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6337841">tx</span><span class="op" id="6337843">.</span><span class="ident" id="6337844">txi</span>&nbsp;<span class="op" id="6337848">=</span>&nbsp;<span class="builtintype" id="6337850">nil</span><br>
<span class="lineno"></span><span class="op" id="6337854">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6337857">func</span>&nbsp;<span class="op" id="6337862">(</span><span class="ident" id="6337863">tx</span>&nbsp;<span class="op" id="6337866">*</span><span class="ident" id="6337867">Tx</span><span class="op" id="6337869">)</span>&nbsp;<span class="ident" id="6337871">grabConn</span><span class="op" id="6337879">(</span><span class="op" id="6337880">)</span>&nbsp;<span class="op" id="6337882">(</span><span class="op" id="6337883">*</span><span class="ident" id="6337884">driverConn</span><span class="op" id="6337894">,</span>&nbsp;<span class="builtintype" id="6337896">error</span><span class="op" id="6337901">)</span>&nbsp;<span class="op" id="6337903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6337906">if</span>&nbsp;<span class="ident" id="6337909">tx</span><span class="op" id="6337911">.</span><span class="ident" id="6337912">done</span>&nbsp;<span class="op" id="6337917">{</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6337921">return</span>&nbsp;<span class="builtintype" id="6337928">nil</span><span class="op" id="6337931">,</span>&nbsp;<span class="ident" id="6337933">ErrTxDone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6337944">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6337947">return</span>&nbsp;<span class="ident" id="6337954">tx</span><span class="op" id="6337956">.</span><span class="ident" id="6337957">dc</span><span class="op" id="6337959">,</span>&nbsp;<span class="builtintype" id="6337961">nil</span><br>
<span class="lineno"></span><span class="op" id="6337965">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1090</span><span class="comment" id="6337968">//&nbsp;Closes&nbsp;all&nbsp;Stmts&nbsp;prepared&nbsp;for&nbsp;this&nbsp;transaction.</span><br>
<span class="lineno"></span><span class="keyword" id="6338019">func</span>&nbsp;<span class="op" id="6338024">(</span><span class="ident" id="6338025">tx</span>&nbsp;<span class="op" id="6338028">*</span><span class="ident" id="6338029">Tx</span><span class="op" id="6338031">)</span>&nbsp;<span class="ident" id="6338033">closePrepared</span><span class="op" id="6338046">(</span><span class="op" id="6338047">)</span>&nbsp;<span class="op" id="6338049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6338052">tx</span><span class="op" id="6338054">.</span><span class="ident" id="6338055">stmts</span><span class="op" id="6338060">.</span><span class="ident" id="6338061">Lock</span><span class="op" id="6338065">(</span><span class="op" id="6338066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6338069">for</span>&nbsp;<span class="ident" id="6338073">_</span><span class="op" id="6338074">,</span>&nbsp;<span class="ident" id="6338076">stmt</span>&nbsp;<span class="op" id="6338081">:=</span>&nbsp;<span class="keyword" id="6338084">range</span>&nbsp;<span class="ident" id="6338090">tx</span><span class="op" id="6338092">.</span><span class="ident" id="6338093">stmts</span><span class="op" id="6338098">.</span><span class="ident" id="6338099">v</span>&nbsp;<span class="op" id="6338101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6338105">stmt</span><span class="op" id="6338109">.</span><span class="ident" id="6338110">Close</span><span class="op" id="6338115">(</span><span class="op" id="6338116">)</span><br>
<span class="lineno">1095</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6338119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6338122">tx</span><span class="op" id="6338124">.</span><span class="ident" id="6338125">stmts</span><span class="op" id="6338130">.</span><span class="ident" id="6338131">Unlock</span><span class="op" id="6338137">(</span><span class="op" id="6338138">)</span><br>
<span class="lineno"></span><span class="op" id="6338140">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6338143">//&nbsp;Commit&nbsp;commits&nbsp;the&nbsp;transaction.</span><br>
<span class="lineno">1100</span><span class="keyword" id="6338178">func</span>&nbsp;<span class="op" id="6338183">(</span><span class="ident" id="6338184">tx</span>&nbsp;<span class="op" id="6338187">*</span><span class="ident" id="6338188">Tx</span><span class="op" id="6338190">)</span>&nbsp;<span class="ident" id="6338192">Commit</span><span class="op" id="6338198">(</span><span class="op" id="6338199">)</span>&nbsp;<span class="builtintype" id="6338201">error</span>&nbsp;<span class="op" id="6338207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6338210">if</span>&nbsp;<span class="ident" id="6338213">tx</span><span class="op" id="6338215">.</span><span class="ident" id="6338216">done</span>&nbsp;<span class="op" id="6338221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6338225">return</span>&nbsp;<span class="ident" id="6338232">ErrTxDone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6338243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6338246">defer</span>&nbsp;<span class="ident" id="6338252">tx</span><span class="op" id="6338254">.</span><span class="builtinfunc" id="6338255">close</span><span class="op" id="6338260">(</span><span class="op" id="6338261">)</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6338264">tx</span><span class="op" id="6338266">.</span><span class="ident" id="6338267">dc</span><span class="op" id="6338269">.</span><span class="ident" id="6338270">Lock</span><span class="op" id="6338274">(</span><span class="op" id="6338275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6338278">err</span>&nbsp;<span class="op" id="6338282">:=</span>&nbsp;<span class="ident" id="6338285">tx</span><span class="op" id="6338287">.</span><span class="ident" id="6338288">txi</span><span class="op" id="6338291">.</span><span class="ident" id="6338292">Commit</span><span class="op" id="6338298">(</span><span class="op" id="6338299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6338302">tx</span><span class="op" id="6338304">.</span><span class="ident" id="6338305">dc</span><span class="op" id="6338307">.</span><span class="ident" id="6338308">Unlock</span><span class="op" id="6338314">(</span><span class="op" id="6338315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6338318">if</span>&nbsp;<span class="ident" id="6338321">err</span>&nbsp;<span class="op" id="6338325">!=</span>&nbsp;<span class="ident" id="6338328">driver</span><span class="op" id="6338334">.</span><span class="ident" id="6338335">ErrBadConn</span>&nbsp;<span class="op" id="6338346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6338350">tx</span><span class="op" id="6338352">.</span><span class="ident" id="6338353">closePrepared</span><span class="op" id="6338366">(</span><span class="op" id="6338367">)</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6338370">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6338373">return</span>&nbsp;<span class="ident" id="6338380">err</span><br>
<span class="lineno"></span><span class="op" id="6338384">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6338387">//&nbsp;Rollback&nbsp;aborts&nbsp;the&nbsp;transaction.</span><br>
<span class="lineno">1115</span><span class="keyword" id="6338423">func</span>&nbsp;<span class="op" id="6338428">(</span><span class="ident" id="6338429">tx</span>&nbsp;<span class="op" id="6338432">*</span><span class="ident" id="6338433">Tx</span><span class="op" id="6338435">)</span>&nbsp;<span class="ident" id="6338437">Rollback</span><span class="op" id="6338445">(</span><span class="op" id="6338446">)</span>&nbsp;<span class="builtintype" id="6338448">error</span>&nbsp;<span class="op" id="6338454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6338457">if</span>&nbsp;<span class="ident" id="6338460">tx</span><span class="op" id="6338462">.</span><span class="ident" id="6338463">done</span>&nbsp;<span class="op" id="6338468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6338472">return</span>&nbsp;<span class="ident" id="6338479">ErrTxDone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6338490">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6338493">defer</span>&nbsp;<span class="ident" id="6338499">tx</span><span class="op" id="6338501">.</span><span class="builtinfunc" id="6338502">close</span><span class="op" id="6338507">(</span><span class="op" id="6338508">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6338511">tx</span><span class="op" id="6338513">.</span><span class="ident" id="6338514">dc</span><span class="op" id="6338516">.</span><span class="ident" id="6338517">Lock</span><span class="op" id="6338521">(</span><span class="op" id="6338522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6338525">err</span>&nbsp;<span class="op" id="6338529">:=</span>&nbsp;<span class="ident" id="6338532">tx</span><span class="op" id="6338534">.</span><span class="ident" id="6338535">txi</span><span class="op" id="6338538">.</span><span class="ident" id="6338539">Rollback</span><span class="op" id="6338547">(</span><span class="op" id="6338548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6338551">tx</span><span class="op" id="6338553">.</span><span class="ident" id="6338554">dc</span><span class="op" id="6338556">.</span><span class="ident" id="6338557">Unlock</span><span class="op" id="6338563">(</span><span class="op" id="6338564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6338567">if</span>&nbsp;<span class="ident" id="6338570">err</span>&nbsp;<span class="op" id="6338574">!=</span>&nbsp;<span class="ident" id="6338577">driver</span><span class="op" id="6338583">.</span><span class="ident" id="6338584">ErrBadConn</span>&nbsp;<span class="op" id="6338595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6338599">tx</span><span class="op" id="6338601">.</span><span class="ident" id="6338602">closePrepared</span><span class="op" id="6338615">(</span><span class="op" id="6338616">)</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6338619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6338622">return</span>&nbsp;<span class="ident" id="6338629">err</span><br>
<span class="lineno"></span><span class="op" id="6338633">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6338636">//&nbsp;Prepare&nbsp;creates&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;for&nbsp;use&nbsp;within&nbsp;a&nbsp;transaction.</span><br>
<span class="lineno">1130</span><span class="comment" id="6338706">//</span><br>
<span class="lineno"></span><span class="comment" id="6338709">//&nbsp;The&nbsp;returned&nbsp;statement&nbsp;operates&nbsp;within&nbsp;the&nbsp;transaction&nbsp;and&nbsp;can&nbsp;no&nbsp;longer</span><br>
<span class="lineno"></span><span class="comment" id="6338785">//&nbsp;be&nbsp;used&nbsp;once&nbsp;the&nbsp;transaction&nbsp;has&nbsp;been&nbsp;committed&nbsp;or&nbsp;rolled&nbsp;back.</span><br>
<span class="lineno"></span><span class="comment" id="6338852">//</span><br>
<span class="lineno"></span><span class="comment" id="6338855">//&nbsp;To&nbsp;use&nbsp;an&nbsp;existing&nbsp;prepared&nbsp;statement&nbsp;on&nbsp;this&nbsp;transaction,&nbsp;see&nbsp;Tx.Stmt.</span><br>
<span class="lineno">1135</span><span class="keyword" id="6338930">func</span>&nbsp;<span class="op" id="6338935">(</span><span class="ident" id="6338936">tx</span>&nbsp;<span class="op" id="6338939">*</span><span class="ident" id="6338940">Tx</span><span class="op" id="6338942">)</span>&nbsp;<span class="ident" id="6338944">Prepare</span><span class="op" id="6338951">(</span><span class="ident" id="6338952">query</span>&nbsp;<span class="builtintype" id="6338958">string</span><span class="op" id="6338964">)</span>&nbsp;<span class="op" id="6338966">(</span><span class="op" id="6338967">*</span><span class="ident" id="6338968">Stmt</span><span class="op" id="6338972">,</span>&nbsp;<span class="builtintype" id="6338974">error</span><span class="op" id="6338979">)</span>&nbsp;<span class="op" id="6338981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6338984">//&nbsp;TODO(bradfitz):&nbsp;We&nbsp;could&nbsp;be&nbsp;more&nbsp;efficient&nbsp;here&nbsp;and&nbsp;either</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6339047">//&nbsp;provide&nbsp;a&nbsp;method&nbsp;to&nbsp;take&nbsp;an&nbsp;existing&nbsp;Stmt&nbsp;(created&nbsp;on</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6339105">//&nbsp;perhaps&nbsp;a&nbsp;different&nbsp;Conn),&nbsp;and&nbsp;re-create&nbsp;it&nbsp;on&nbsp;this&nbsp;Conn&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6339169">//&nbsp;necessary.&nbsp;Or,&nbsp;better:&nbsp;keep&nbsp;a&nbsp;map&nbsp;in&nbsp;DB&nbsp;of&nbsp;query&nbsp;string&nbsp;to</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6339232">//&nbsp;Stmts,&nbsp;and&nbsp;have&nbsp;Stmt.Execute&nbsp;do&nbsp;the&nbsp;right&nbsp;thing&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6339288">//&nbsp;re-prepare&nbsp;if&nbsp;the&nbsp;Conn&nbsp;in&nbsp;use&nbsp;doesn&#39;t&nbsp;have&nbsp;that&nbsp;prepared</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6339349">//&nbsp;statement.&nbsp;&nbsp;But&nbsp;we&#39;ll&nbsp;want&nbsp;to&nbsp;avoid&nbsp;caching&nbsp;the&nbsp;statement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6339411">//&nbsp;in&nbsp;the&nbsp;case&nbsp;where&nbsp;we&nbsp;only&nbsp;call&nbsp;conn.Prepare&nbsp;implicitly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6339470">//&nbsp;(such&nbsp;as&nbsp;in&nbsp;db.Exec&nbsp;or&nbsp;tx.Exec),&nbsp;but&nbsp;the&nbsp;caller&nbsp;package</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6339530">//&nbsp;can&#39;t&nbsp;be&nbsp;holding&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;returned&nbsp;statement.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6339590">//&nbsp;Perhaps&nbsp;just&nbsp;looking&nbsp;at&nbsp;the&nbsp;reference&nbsp;count&nbsp;(by&nbsp;noting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6339649">//&nbsp;Stmt.Close)&nbsp;would&nbsp;be&nbsp;enough.&nbsp;We&nbsp;might&nbsp;also&nbsp;want&nbsp;a&nbsp;finalizer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6339713">//&nbsp;on&nbsp;Stmt&nbsp;to&nbsp;drop&nbsp;the&nbsp;reference&nbsp;count.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6339754">dc</span><span class="op" id="6339756">,</span>&nbsp;<span class="ident" id="6339758">err</span>&nbsp;<span class="op" id="6339762">:=</span>&nbsp;<span class="ident" id="6339765">tx</span><span class="op" id="6339767">.</span><span class="ident" id="6339768">grabConn</span><span class="op" id="6339776">(</span><span class="op" id="6339777">)</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6339780">if</span>&nbsp;<span class="ident" id="6339783">err</span>&nbsp;<span class="op" id="6339787">!=</span>&nbsp;<span class="builtintype" id="6339790">nil</span>&nbsp;<span class="op" id="6339794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6339798">return</span>&nbsp;<span class="builtintype" id="6339805">nil</span><span class="op" id="6339808">,</span>&nbsp;<span class="ident" id="6339810">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6339815">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6339819">dc</span><span class="op" id="6339821">.</span><span class="ident" id="6339822">Lock</span><span class="op" id="6339826">(</span><span class="op" id="6339827">)</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6339830">si</span><span class="op" id="6339832">,</span>&nbsp;<span class="ident" id="6339834">err</span>&nbsp;<span class="op" id="6339838">:=</span>&nbsp;<span class="ident" id="6339841">dc</span><span class="op" id="6339843">.</span><span class="ident" id="6339844">ci</span><span class="op" id="6339846">.</span><span class="ident" id="6339847">Prepare</span><span class="op" id="6339854">(</span><span class="ident" id="6339855">query</span><span class="op" id="6339860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6339863">dc</span><span class="op" id="6339865">.</span><span class="ident" id="6339866">Unlock</span><span class="op" id="6339872">(</span><span class="op" id="6339873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6339876">if</span>&nbsp;<span class="ident" id="6339879">err</span>&nbsp;<span class="op" id="6339883">!=</span>&nbsp;<span class="builtintype" id="6339886">nil</span>&nbsp;<span class="op" id="6339890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6339894">return</span>&nbsp;<span class="builtintype" id="6339901">nil</span><span class="op" id="6339904">,</span>&nbsp;<span class="ident" id="6339906">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6339911">}</span><br>
<span class="lineno">1160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6339915">stmt</span>&nbsp;<span class="op" id="6339920">:=</span>&nbsp;<span class="op" id="6339923">&amp;</span><span class="ident" id="6339924">Stmt</span><span class="op" id="6339928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6339932">db</span><span class="op" id="6339934">:</span>&nbsp;<span class="ident" id="6339936">tx</span><span class="op" id="6339938">.</span><span class="ident" id="6339939">db</span><span class="op" id="6339941">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6339945">tx</span><span class="op" id="6339947">:</span>&nbsp;<span class="ident" id="6339949">tx</span><span class="op" id="6339951">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6339955">txsi</span><span class="op" id="6339959">:</span>&nbsp;<span class="op" id="6339961">&amp;</span><span class="ident" id="6339962">driverStmt</span><span class="op" id="6339972">{</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6339977">Locker</span><span class="op" id="6339983">:</span>&nbsp;<span class="ident" id="6339985">dc</span><span class="op" id="6339987">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6339992">si</span><span class="op" id="6339994">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6340000">si</span><span class="op" id="6340002">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6340006">}</span><span class="op" id="6340007">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6340011">query</span><span class="op" id="6340016">:</span>&nbsp;<span class="ident" id="6340018">query</span><span class="op" id="6340023">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6340026">}</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6340029">tx</span><span class="op" id="6340031">.</span><span class="ident" id="6340032">stmts</span><span class="op" id="6340037">.</span><span class="ident" id="6340038">Lock</span><span class="op" id="6340042">(</span><span class="op" id="6340043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6340046">tx</span><span class="op" id="6340048">.</span><span class="ident" id="6340049">stmts</span><span class="op" id="6340054">.</span><span class="ident" id="6340055">v</span>&nbsp;<span class="op" id="6340057">=</span>&nbsp;<span class="builtinfunc" id="6340059">append</span><span class="op" id="6340065">(</span><span class="ident" id="6340066">tx</span><span class="op" id="6340068">.</span><span class="ident" id="6340069">stmts</span><span class="op" id="6340074">.</span><span class="ident" id="6340075">v</span><span class="op" id="6340076">,</span>&nbsp;<span class="ident" id="6340078">stmt</span><span class="op" id="6340082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6340085">tx</span><span class="op" id="6340087">.</span><span class="ident" id="6340088">stmts</span><span class="op" id="6340093">.</span><span class="ident" id="6340094">Unlock</span><span class="op" id="6340100">(</span><span class="op" id="6340101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6340104">return</span>&nbsp;<span class="ident" id="6340111">stmt</span><span class="op" id="6340115">,</span>&nbsp;<span class="builtintype" id="6340117">nil</span><br>
<span class="lineno"></span><span class="op" id="6340121">}</span><br>
<span class="lineno">1175</span><br>
<span class="lineno"></span><span class="comment" id="6340124">//&nbsp;Stmt&nbsp;returns&nbsp;a&nbsp;transaction-specific&nbsp;prepared&nbsp;statement&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="6340187">//&nbsp;an&nbsp;existing&nbsp;statement.</span><br>
<span class="lineno"></span><span class="comment" id="6340213">//</span><br>
<span class="lineno"></span><span class="comment" id="6340216">//&nbsp;Example:</span><br>
<span class="lineno">1180</span><span class="comment" id="6340228">//&nbsp;&nbsp;updateMoney,&nbsp;err&nbsp;:=&nbsp;db.Prepare(&#34;UPDATE&nbsp;balance&nbsp;SET&nbsp;money=money+?&nbsp;WHERE&nbsp;id=?&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="6340310">//&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="6340318">//&nbsp;&nbsp;tx,&nbsp;err&nbsp;:=&nbsp;db.Begin()</span><br>
<span class="lineno"></span><span class="comment" id="6340344">//&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="6340352">//&nbsp;&nbsp;res,&nbsp;err&nbsp;:=&nbsp;tx.Stmt(updateMoney).Exec(123.45,&nbsp;98293203)</span><br>
<span class="lineno">1185</span><span class="keyword" id="6340412">func</span>&nbsp;<span class="op" id="6340417">(</span><span class="ident" id="6340418">tx</span>&nbsp;<span class="op" id="6340421">*</span><span class="ident" id="6340422">Tx</span><span class="op" id="6340424">)</span>&nbsp;<span class="ident" id="6340426">Stmt</span><span class="op" id="6340430">(</span><span class="ident" id="6340431">stmt</span>&nbsp;<span class="op" id="6340436">*</span><span class="ident" id="6340437">Stmt</span><span class="op" id="6340441">)</span>&nbsp;<span class="op" id="6340443">*</span><span class="ident" id="6340444">Stmt</span>&nbsp;<span class="op" id="6340449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6340452">//&nbsp;TODO(bradfitz):&nbsp;optimize&nbsp;this.&nbsp;Currently&nbsp;this&nbsp;re-prepares</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6340514">//&nbsp;each&nbsp;time.&nbsp;&nbsp;This&nbsp;is&nbsp;fine&nbsp;for&nbsp;now&nbsp;to&nbsp;illustrate&nbsp;the&nbsp;API&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6340577">//&nbsp;we&nbsp;should&nbsp;really&nbsp;cache&nbsp;already-prepared&nbsp;statements</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6340632">//&nbsp;per-Conn.&nbsp;See&nbsp;also&nbsp;the&nbsp;big&nbsp;comment&nbsp;in&nbsp;Tx.Prepare.</span><br>
<span class="lineno">1190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6340687">if</span>&nbsp;<span class="ident" id="6340690">tx</span><span class="op" id="6340692">.</span><span class="ident" id="6340693">db</span>&nbsp;<span class="op" id="6340696">!=</span>&nbsp;<span class="ident" id="6340699">stmt</span><span class="op" id="6340703">.</span><span class="ident" id="6340704">db</span>&nbsp;<span class="op" id="6340707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6340711">return</span>&nbsp;<span class="op" id="6340718">&amp;</span><span class="ident" id="6340719">Stmt</span><span class="op" id="6340723">{</span><span class="ident" id="6340724">stickyErr</span><span class="op" id="6340733">:</span>&nbsp;<span class="ident" id="6340735">errors</span><span class="op" id="6340741">.</span><span class="ident" id="6340742">New</span><span class="op" id="6340745">(</span><span class="string" id="6340746">&#34;sql:&nbsp;Tx.Stmt:&nbsp;statement&nbsp;from&nbsp;different&nbsp;database&nbsp;used&#34;</span><span class="op" id="6340800">)</span><span class="op" id="6340801">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6340804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6340807">dc</span><span class="op" id="6340809">,</span>&nbsp;<span class="ident" id="6340811">err</span>&nbsp;<span class="op" id="6340815">:=</span>&nbsp;<span class="ident" id="6340818">tx</span><span class="op" id="6340820">.</span><span class="ident" id="6340821">grabConn</span><span class="op" id="6340829">(</span><span class="op" id="6340830">)</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6340833">if</span>&nbsp;<span class="ident" id="6340836">err</span>&nbsp;<span class="op" id="6340840">!=</span>&nbsp;<span class="builtintype" id="6340843">nil</span>&nbsp;<span class="op" id="6340847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6340851">return</span>&nbsp;<span class="op" id="6340858">&amp;</span><span class="ident" id="6340859">Stmt</span><span class="op" id="6340863">{</span><span class="ident" id="6340864">stickyErr</span><span class="op" id="6340873">:</span>&nbsp;<span class="ident" id="6340875">err</span><span class="op" id="6340878">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6340881">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6340884">dc</span><span class="op" id="6340886">.</span><span class="ident" id="6340887">Lock</span><span class="op" id="6340891">(</span><span class="op" id="6340892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6340895">si</span><span class="op" id="6340897">,</span>&nbsp;<span class="ident" id="6340899">err</span>&nbsp;<span class="op" id="6340903">:=</span>&nbsp;<span class="ident" id="6340906">dc</span><span class="op" id="6340908">.</span><span class="ident" id="6340909">ci</span><span class="op" id="6340911">.</span><span class="ident" id="6340912">Prepare</span><span class="op" id="6340919">(</span><span class="ident" id="6340920">stmt</span><span class="op" id="6340924">.</span><span class="ident" id="6340925">query</span><span class="op" id="6340930">)</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6340933">dc</span><span class="op" id="6340935">.</span><span class="ident" id="6340936">Unlock</span><span class="op" id="6340942">(</span><span class="op" id="6340943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6340946">txs</span>&nbsp;<span class="op" id="6340950">:=</span>&nbsp;<span class="op" id="6340953">&amp;</span><span class="ident" id="6340954">Stmt</span><span class="op" id="6340958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6340962">db</span><span class="op" id="6340964">:</span>&nbsp;<span class="ident" id="6340966">tx</span><span class="op" id="6340968">.</span><span class="ident" id="6340969">db</span><span class="op" id="6340971">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6340975">tx</span><span class="op" id="6340977">:</span>&nbsp;<span class="ident" id="6340979">tx</span><span class="op" id="6340981">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6340985">txsi</span><span class="op" id="6340989">:</span>&nbsp;<span class="op" id="6340991">&amp;</span><span class="ident" id="6340992">driverStmt</span><span class="op" id="6341002">{</span><br>
<span class="lineno">1205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6341007">Locker</span><span class="op" id="6341013">:</span>&nbsp;<span class="ident" id="6341015">dc</span><span class="op" id="6341017">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6341022">si</span><span class="op" id="6341024">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6341030">si</span><span class="op" id="6341032">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6341036">}</span><span class="op" id="6341037">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6341041">query</span><span class="op" id="6341046">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6341052">stmt</span><span class="op" id="6341056">.</span><span class="ident" id="6341057">query</span><span class="op" id="6341062">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6341066">stickyErr</span><span class="op" id="6341075">:</span>&nbsp;<span class="ident" id="6341077">err</span><span class="op" id="6341080">,</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6341083">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6341086">tx</span><span class="op" id="6341088">.</span><span class="ident" id="6341089">stmts</span><span class="op" id="6341094">.</span><span class="ident" id="6341095">Lock</span><span class="op" id="6341099">(</span><span class="op" id="6341100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6341103">tx</span><span class="op" id="6341105">.</span><span class="ident" id="6341106">stmts</span><span class="op" id="6341111">.</span><span class="ident" id="6341112">v</span>&nbsp;<span class="op" id="6341114">=</span>&nbsp;<span class="builtinfunc" id="6341116">append</span><span class="op" id="6341122">(</span><span class="ident" id="6341123">tx</span><span class="op" id="6341125">.</span><span class="ident" id="6341126">stmts</span><span class="op" id="6341131">.</span><span class="ident" id="6341132">v</span><span class="op" id="6341133">,</span>&nbsp;<span class="ident" id="6341135">txs</span><span class="op" id="6341138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6341141">tx</span><span class="op" id="6341143">.</span><span class="ident" id="6341144">stmts</span><span class="op" id="6341149">.</span><span class="ident" id="6341150">Unlock</span><span class="op" id="6341156">(</span><span class="op" id="6341157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6341160">return</span>&nbsp;<span class="ident" id="6341167">txs</span><br>
<span class="lineno">1215</span><span class="op" id="6341171">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6341174">//&nbsp;Exec&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;doesn&#39;t&nbsp;return&nbsp;rows.</span><br>
<span class="lineno"></span><span class="comment" id="6341225">//&nbsp;For&nbsp;example:&nbsp;an&nbsp;INSERT&nbsp;and&nbsp;UPDATE.</span><br>
<span class="lineno"></span><span class="keyword" id="6341263">func</span>&nbsp;<span class="op" id="6341268">(</span><span class="ident" id="6341269">tx</span>&nbsp;<span class="op" id="6341272">*</span><span class="ident" id="6341273">Tx</span><span class="op" id="6341275">)</span>&nbsp;<span class="ident" id="6341277">Exec</span><span class="op" id="6341281">(</span><span class="ident" id="6341282">query</span>&nbsp;<span class="builtintype" id="6341288">string</span><span class="op" id="6341294">,</span>&nbsp;<span class="ident" id="6341296">args</span>&nbsp;<span class="op" id="6341301">...</span><span class="keyword" id="6341304">interface</span><span class="op" id="6341313">{</span><span class="op" id="6341314">}</span><span class="op" id="6341315">)</span>&nbsp;<span class="op" id="6341317">(</span><span class="ident" id="6341318">Result</span><span class="op" id="6341324">,</span>&nbsp;<span class="builtintype" id="6341326">error</span><span class="op" id="6341331">)</span>&nbsp;<span class="op" id="6341333">{</span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6341336">dc</span><span class="op" id="6341338">,</span>&nbsp;<span class="ident" id="6341340">err</span>&nbsp;<span class="op" id="6341344">:=</span>&nbsp;<span class="ident" id="6341347">tx</span><span class="op" id="6341349">.</span><span class="ident" id="6341350">grabConn</span><span class="op" id="6341358">(</span><span class="op" id="6341359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6341362">if</span>&nbsp;<span class="ident" id="6341365">err</span>&nbsp;<span class="op" id="6341369">!=</span>&nbsp;<span class="builtintype" id="6341372">nil</span>&nbsp;<span class="op" id="6341376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6341380">return</span>&nbsp;<span class="builtintype" id="6341387">nil</span><span class="op" id="6341390">,</span>&nbsp;<span class="ident" id="6341392">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6341397">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6341401">if</span>&nbsp;<span class="ident" id="6341404">execer</span><span class="op" id="6341410">,</span>&nbsp;<span class="ident" id="6341412">ok</span>&nbsp;<span class="op" id="6341415">:=</span>&nbsp;<span class="ident" id="6341418">dc</span><span class="op" id="6341420">.</span><span class="ident" id="6341421">ci</span><span class="op" id="6341423">.</span><span class="op" id="6341424">(</span><span class="ident" id="6341425">driver</span><span class="op" id="6341431">.</span><span class="ident" id="6341432">Execer</span><span class="op" id="6341438">)</span><span class="op" id="6341439">;</span>&nbsp;<span class="ident" id="6341441">ok</span>&nbsp;<span class="op" id="6341444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6341448">dargs</span><span class="op" id="6341453">,</span>&nbsp;<span class="ident" id="6341455">err</span>&nbsp;<span class="op" id="6341459">:=</span>&nbsp;<span class="ident" id="6341462">driverArgs</span><span class="op" id="6341472">(</span><span class="builtintype" id="6341473">nil</span><span class="op" id="6341476">,</span>&nbsp;<span class="ident" id="6341478">args</span><span class="op" id="6341482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6341486">if</span>&nbsp;<span class="ident" id="6341489">err</span>&nbsp;<span class="op" id="6341493">!=</span>&nbsp;<span class="builtintype" id="6341496">nil</span>&nbsp;<span class="op" id="6341500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6341505">return</span>&nbsp;<span class="builtintype" id="6341512">nil</span><span class="op" id="6341515">,</span>&nbsp;<span class="ident" id="6341517">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6341523">}</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6341527">dc</span><span class="op" id="6341529">.</span><span class="ident" id="6341530">Lock</span><span class="op" id="6341534">(</span><span class="op" id="6341535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6341539">resi</span><span class="op" id="6341543">,</span>&nbsp;<span class="ident" id="6341545">err</span>&nbsp;<span class="op" id="6341549">:=</span>&nbsp;<span class="ident" id="6341552">execer</span><span class="op" id="6341558">.</span><span class="ident" id="6341559">Exec</span><span class="op" id="6341563">(</span><span class="ident" id="6341564">query</span><span class="op" id="6341569">,</span>&nbsp;<span class="ident" id="6341571">dargs</span><span class="op" id="6341576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6341580">dc</span><span class="op" id="6341582">.</span><span class="ident" id="6341583">Unlock</span><span class="op" id="6341589">(</span><span class="op" id="6341590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6341594">if</span>&nbsp;<span class="ident" id="6341597">err</span>&nbsp;<span class="op" id="6341601">==</span>&nbsp;<span class="builtintype" id="6341604">nil</span>&nbsp;<span class="op" id="6341608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6341613">return</span>&nbsp;<span class="ident" id="6341620">driverResult</span><span class="op" id="6341632">{</span><span class="ident" id="6341633">dc</span><span class="op" id="6341635">,</span>&nbsp;<span class="ident" id="6341637">resi</span><span class="op" id="6341641">}</span><span class="op" id="6341642">,</span>&nbsp;<span class="builtintype" id="6341644">nil</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6341650">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6341654">if</span>&nbsp;<span class="ident" id="6341657">err</span>&nbsp;<span class="op" id="6341661">!=</span>&nbsp;<span class="ident" id="6341664">driver</span><span class="op" id="6341670">.</span><span class="ident" id="6341671">ErrSkip</span>&nbsp;<span class="op" id="6341679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6341684">return</span>&nbsp;<span class="builtintype" id="6341691">nil</span><span class="op" id="6341694">,</span>&nbsp;<span class="ident" id="6341696">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6341702">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6341705">}</span><br>
<span class="lineno">1240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6341709">dc</span><span class="op" id="6341711">.</span><span class="ident" id="6341712">Lock</span><span class="op" id="6341716">(</span><span class="op" id="6341717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6341720">si</span><span class="op" id="6341722">,</span>&nbsp;<span class="ident" id="6341724">err</span>&nbsp;<span class="op" id="6341728">:=</span>&nbsp;<span class="ident" id="6341731">dc</span><span class="op" id="6341733">.</span><span class="ident" id="6341734">ci</span><span class="op" id="6341736">.</span><span class="ident" id="6341737">Prepare</span><span class="op" id="6341744">(</span><span class="ident" id="6341745">query</span><span class="op" id="6341750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6341753">dc</span><span class="op" id="6341755">.</span><span class="ident" id="6341756">Unlock</span><span class="op" id="6341762">(</span><span class="op" id="6341763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6341766">if</span>&nbsp;<span class="ident" id="6341769">err</span>&nbsp;<span class="op" id="6341773">!=</span>&nbsp;<span class="builtintype" id="6341776">nil</span>&nbsp;<span class="op" id="6341780">{</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6341784">return</span>&nbsp;<span class="builtintype" id="6341791">nil</span><span class="op" id="6341794">,</span>&nbsp;<span class="ident" id="6341796">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6341801">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6341804">defer</span>&nbsp;<span class="ident" id="6341810">withLock</span><span class="op" id="6341818">(</span><span class="ident" id="6341819">dc</span><span class="op" id="6341821">,</span>&nbsp;<span class="keyword" id="6341823">func</span><span class="op" id="6341827">(</span><span class="op" id="6341828">)</span>&nbsp;<span class="op" id="6341830">{</span>&nbsp;<span class="ident" id="6341832">si</span><span class="op" id="6341834">.</span><span class="ident" id="6341835">Close</span><span class="op" id="6341840">(</span><span class="op" id="6341841">)</span>&nbsp;<span class="op" id="6341843">}</span><span class="op" id="6341844">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6341848">return</span>&nbsp;<span class="ident" id="6341855">resultFromStatement</span><span class="op" id="6341874">(</span><span class="ident" id="6341875">driverStmt</span><span class="op" id="6341885">{</span><span class="ident" id="6341886">dc</span><span class="op" id="6341888">,</span>&nbsp;<span class="ident" id="6341890">si</span><span class="op" id="6341892">}</span><span class="op" id="6341893">,</span>&nbsp;<span class="ident" id="6341895">args</span><span class="op" id="6341899">...</span><span class="op" id="6341902">)</span><br>
<span class="lineno">1250</span><span class="op" id="6341904">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6341907">//&nbsp;Query&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;returns&nbsp;rows,&nbsp;typically&nbsp;a&nbsp;SELECT.</span><br>
<span class="lineno"></span><span class="keyword" id="6341972">func</span>&nbsp;<span class="op" id="6341977">(</span><span class="ident" id="6341978">tx</span>&nbsp;<span class="op" id="6341981">*</span><span class="ident" id="6341982">Tx</span><span class="op" id="6341984">)</span>&nbsp;<span class="ident" id="6341986">Query</span><span class="op" id="6341991">(</span><span class="ident" id="6341992">query</span>&nbsp;<span class="builtintype" id="6341998">string</span><span class="op" id="6342004">,</span>&nbsp;<span class="ident" id="6342006">args</span>&nbsp;<span class="op" id="6342011">...</span><span class="keyword" id="6342014">interface</span><span class="op" id="6342023">{</span><span class="op" id="6342024">}</span><span class="op" id="6342025">)</span>&nbsp;<span class="op" id="6342027">(</span><span class="op" id="6342028">*</span><span class="ident" id="6342029">Rows</span><span class="op" id="6342033">,</span>&nbsp;<span class="builtintype" id="6342035">error</span><span class="op" id="6342040">)</span>&nbsp;<span class="op" id="6342042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342045">dc</span><span class="op" id="6342047">,</span>&nbsp;<span class="ident" id="6342049">err</span>&nbsp;<span class="op" id="6342053">:=</span>&nbsp;<span class="ident" id="6342056">tx</span><span class="op" id="6342058">.</span><span class="ident" id="6342059">grabConn</span><span class="op" id="6342067">(</span><span class="op" id="6342068">)</span><br>
<span class="lineno">1255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6342071">if</span>&nbsp;<span class="ident" id="6342074">err</span>&nbsp;<span class="op" id="6342078">!=</span>&nbsp;<span class="builtintype" id="6342081">nil</span>&nbsp;<span class="op" id="6342085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6342089">return</span>&nbsp;<span class="builtintype" id="6342096">nil</span><span class="op" id="6342099">,</span>&nbsp;<span class="ident" id="6342101">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6342106">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342109">releaseConn</span>&nbsp;<span class="op" id="6342121">:=</span>&nbsp;<span class="keyword" id="6342124">func</span><span class="op" id="6342128">(</span><span class="builtintype" id="6342129">error</span><span class="op" id="6342134">)</span>&nbsp;<span class="op" id="6342136">{</span><span class="op" id="6342137">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6342140">return</span>&nbsp;<span class="ident" id="6342147">tx</span><span class="op" id="6342149">.</span><span class="ident" id="6342150">db</span><span class="op" id="6342152">.</span><span class="ident" id="6342153">queryConn</span><span class="op" id="6342162">(</span><span class="ident" id="6342163">dc</span><span class="op" id="6342165">,</span>&nbsp;<span class="ident" id="6342167">releaseConn</span><span class="op" id="6342178">,</span>&nbsp;<span class="ident" id="6342180">query</span><span class="op" id="6342185">,</span>&nbsp;<span class="ident" id="6342187">args</span><span class="op" id="6342191">)</span><br>
<span class="lineno">1260</span><span class="op" id="6342193">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6342196">//&nbsp;QueryRow&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;is&nbsp;expected&nbsp;to&nbsp;return&nbsp;at&nbsp;most&nbsp;one&nbsp;row.</span><br>
<span class="lineno"></span><span class="comment" id="6342269">//&nbsp;QueryRow&nbsp;always&nbsp;return&nbsp;a&nbsp;non-nil&nbsp;value.&nbsp;Errors&nbsp;are&nbsp;deferred&nbsp;until</span><br>
<span class="lineno"></span><span class="comment" id="6342338">//&nbsp;Row&#39;s&nbsp;Scan&nbsp;method&nbsp;is&nbsp;called.</span><br>
<span class="lineno">1265</span><span class="keyword" id="6342370">func</span>&nbsp;<span class="op" id="6342375">(</span><span class="ident" id="6342376">tx</span>&nbsp;<span class="op" id="6342379">*</span><span class="ident" id="6342380">Tx</span><span class="op" id="6342382">)</span>&nbsp;<span class="ident" id="6342384">QueryRow</span><span class="op" id="6342392">(</span><span class="ident" id="6342393">query</span>&nbsp;<span class="builtintype" id="6342399">string</span><span class="op" id="6342405">,</span>&nbsp;<span class="ident" id="6342407">args</span>&nbsp;<span class="op" id="6342412">...</span><span class="keyword" id="6342415">interface</span><span class="op" id="6342424">{</span><span class="op" id="6342425">}</span><span class="op" id="6342426">)</span>&nbsp;<span class="op" id="6342428">*</span><span class="ident" id="6342429">Row</span>&nbsp;<span class="op" id="6342433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342436">rows</span><span class="op" id="6342440">,</span>&nbsp;<span class="ident" id="6342442">err</span>&nbsp;<span class="op" id="6342446">:=</span>&nbsp;<span class="ident" id="6342449">tx</span><span class="op" id="6342451">.</span><span class="ident" id="6342452">Query</span><span class="op" id="6342457">(</span><span class="ident" id="6342458">query</span><span class="op" id="6342463">,</span>&nbsp;<span class="ident" id="6342465">args</span><span class="op" id="6342469">...</span><span class="op" id="6342472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6342475">return</span>&nbsp;<span class="op" id="6342482">&amp;</span><span class="ident" id="6342483">Row</span><span class="op" id="6342486">{</span><span class="ident" id="6342487">rows</span><span class="op" id="6342491">:</span>&nbsp;<span class="ident" id="6342493">rows</span><span class="op" id="6342497">,</span>&nbsp;<span class="ident" id="6342499">err</span><span class="op" id="6342502">:</span>&nbsp;<span class="ident" id="6342504">err</span><span class="op" id="6342507">}</span><br>
<span class="lineno"></span><span class="op" id="6342509">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1270</span><span class="comment" id="6342512">//&nbsp;connStmt&nbsp;is&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;on&nbsp;a&nbsp;particular&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="6342576">type</span>&nbsp;<span class="ident" id="6342581">connStmt</span>&nbsp;<span class="keyword" id="6342590">struct</span>&nbsp;<span class="op" id="6342597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342600">dc</span>&nbsp;<span class="op" id="6342603">*</span><span class="ident" id="6342604">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342616">si</span>&nbsp;<span class="ident" id="6342619">driver</span><span class="op" id="6342625">.</span><span class="ident" id="6342626">Stmt</span><br>
<span class="lineno"></span><span class="op" id="6342631">}</span><br>
<span class="lineno">1275</span><br>
<span class="lineno"></span><span class="comment" id="6342634">//&nbsp;Stmt&nbsp;is&nbsp;a&nbsp;prepared&nbsp;statement.&nbsp;Stmt&nbsp;is&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="6342723">type</span>&nbsp;<span class="ident" id="6342728">Stmt</span>&nbsp;<span class="keyword" id="6342733">struct</span>&nbsp;<span class="op" id="6342740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6342743">//&nbsp;Immutable:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342758">db</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6342768">*</span><span class="ident" id="6342769">DB</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6342775">//&nbsp;where&nbsp;we&nbsp;came&nbsp;from</span><br>
<span class="lineno">1280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342798">query</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6342808">string</span>&nbsp;<span class="comment" id="6342815">//&nbsp;that&nbsp;created&nbsp;the&nbsp;Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342841">stickyErr</span>&nbsp;<span class="builtintype" id="6342851">error</span>&nbsp;&nbsp;<span class="comment" id="6342858">//&nbsp;if&nbsp;non-nil,&nbsp;this&nbsp;error&nbsp;is&nbsp;returned&nbsp;for&nbsp;all&nbsp;operations</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342917">closemu</span>&nbsp;<span class="ident" id="6342925">sync</span><span class="op" id="6342929">.</span><span class="ident" id="6342930">RWMutex</span>&nbsp;<span class="comment" id="6342938">//&nbsp;held&nbsp;exclusively&nbsp;during&nbsp;close,&nbsp;for&nbsp;read&nbsp;otherwise.</span><br>
<span class="lineno"></span><br>
<span class="lineno">1285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6342994">//&nbsp;If&nbsp;in&nbsp;a&nbsp;transaction,&nbsp;else&nbsp;both&nbsp;nil:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6343034">tx</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6343039">*</span><span class="ident" id="6343040">Tx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6343044">txsi</span>&nbsp;<span class="op" id="6343049">*</span><span class="ident" id="6343050">driverStmt</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6343063">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6343070">sync</span><span class="op" id="6343074">.</span><span class="ident" id="6343075">Mutex</span>&nbsp;<span class="comment" id="6343081">//&nbsp;protects&nbsp;the&nbsp;rest&nbsp;of&nbsp;the&nbsp;fields</span><br>
<span class="lineno">1290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6343117">closed</span>&nbsp;<span class="builtintype" id="6343124">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6343131">//&nbsp;css&nbsp;is&nbsp;a&nbsp;list&nbsp;of&nbsp;underlying&nbsp;driver&nbsp;statement&nbsp;interfaces</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6343191">//&nbsp;that&nbsp;are&nbsp;valid&nbsp;on&nbsp;particular&nbsp;connections.&nbsp;&nbsp;This&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6343251">//&nbsp;used&nbsp;if&nbsp;tx&nbsp;==&nbsp;nil&nbsp;and&nbsp;one&nbsp;is&nbsp;found&nbsp;that&nbsp;has&nbsp;idle</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6343304">//&nbsp;connections.&nbsp;&nbsp;If&nbsp;tx&nbsp;!=&nbsp;nil,&nbsp;txsi&nbsp;is&nbsp;always&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6343357">css</span>&nbsp;<span class="op" id="6343361">[</span><span class="op" id="6343362">]</span><span class="ident" id="6343363">connStmt</span><br>
<span class="lineno"></span><span class="op" id="6343372">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6343375">//&nbsp;Exec&nbsp;executes&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;with&nbsp;the&nbsp;given&nbsp;arguments&nbsp;and</span><br>
<span class="lineno">1300</span><span class="comment" id="6343442">//&nbsp;returns&nbsp;a&nbsp;Result&nbsp;summarizing&nbsp;the&nbsp;effect&nbsp;of&nbsp;the&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="6343503">func</span>&nbsp;<span class="op" id="6343508">(</span><span class="ident" id="6343509">s</span>&nbsp;<span class="op" id="6343511">*</span><span class="ident" id="6343512">Stmt</span><span class="op" id="6343516">)</span>&nbsp;<span class="ident" id="6343518">Exec</span><span class="op" id="6343522">(</span><span class="ident" id="6343523">args</span>&nbsp;<span class="op" id="6343528">...</span><span class="keyword" id="6343531">interface</span><span class="op" id="6343540">{</span><span class="op" id="6343541">}</span><span class="op" id="6343542">)</span>&nbsp;<span class="op" id="6343544">(</span><span class="ident" id="6343545">Result</span><span class="op" id="6343551">,</span>&nbsp;<span class="builtintype" id="6343553">error</span><span class="op" id="6343558">)</span>&nbsp;<span class="op" id="6343560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6343563">s</span><span class="op" id="6343564">.</span><span class="ident" id="6343565">closemu</span><span class="op" id="6343572">.</span><span class="ident" id="6343573">RLock</span><span class="op" id="6343578">(</span><span class="op" id="6343579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6343582">defer</span>&nbsp;<span class="ident" id="6343588">s</span><span class="op" id="6343589">.</span><span class="ident" id="6343590">closemu</span><span class="op" id="6343597">.</span><span class="ident" id="6343598">RUnlock</span><span class="op" id="6343605">(</span><span class="op" id="6343606">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6343610">var</span>&nbsp;<span class="ident" id="6343614">res</span>&nbsp;<span class="ident" id="6343618">Result</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6343626">for</span>&nbsp;<span class="ident" id="6343630">i</span>&nbsp;<span class="op" id="6343632">:=</span>&nbsp;<span class="num" id="6343635">0</span><span class="op" id="6343636">;</span>&nbsp;<span class="ident" id="6343638">i</span>&nbsp;<span class="op" id="6343640">&lt;</span>&nbsp;<span class="ident" id="6343642">maxBadConnRetries</span><span class="op" id="6343659">;</span>&nbsp;<span class="ident" id="6343661">i</span><span class="op" id="6343662">++</span>&nbsp;<span class="op" id="6343665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6343669">dc</span><span class="op" id="6343671">,</span>&nbsp;<span class="ident" id="6343673">releaseConn</span><span class="op" id="6343684">,</span>&nbsp;<span class="ident" id="6343686">si</span><span class="op" id="6343688">,</span>&nbsp;<span class="ident" id="6343690">err</span>&nbsp;<span class="op" id="6343694">:=</span>&nbsp;<span class="ident" id="6343697">s</span><span class="op" id="6343698">.</span><span class="ident" id="6343699">connStmt</span><span class="op" id="6343707">(</span><span class="op" id="6343708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6343712">if</span>&nbsp;<span class="ident" id="6343715">err</span>&nbsp;<span class="op" id="6343719">!=</span>&nbsp;<span class="builtintype" id="6343722">nil</span>&nbsp;<span class="op" id="6343726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6343731">if</span>&nbsp;<span class="ident" id="6343734">err</span>&nbsp;<span class="op" id="6343738">==</span>&nbsp;<span class="ident" id="6343741">driver</span><span class="op" id="6343747">.</span><span class="ident" id="6343748">ErrBadConn</span>&nbsp;<span class="op" id="6343759">{</span><br>
<span class="lineno">1310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6343765">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6343777">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6343782">return</span>&nbsp;<span class="builtintype" id="6343789">nil</span><span class="op" id="6343792">,</span>&nbsp;<span class="ident" id="6343794">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6343800">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6343805">res</span><span class="op" id="6343808">,</span>&nbsp;<span class="ident" id="6343810">err</span>&nbsp;<span class="op" id="6343814">=</span>&nbsp;<span class="ident" id="6343816">resultFromStatement</span><span class="op" id="6343835">(</span><span class="ident" id="6343836">driverStmt</span><span class="op" id="6343846">{</span><span class="ident" id="6343847">dc</span><span class="op" id="6343849">,</span>&nbsp;<span class="ident" id="6343851">si</span><span class="op" id="6343853">}</span><span class="op" id="6343854">,</span>&nbsp;<span class="ident" id="6343856">args</span><span class="op" id="6343860">...</span><span class="op" id="6343863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6343867">releaseConn</span><span class="op" id="6343878">(</span><span class="ident" id="6343879">err</span><span class="op" id="6343882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6343886">if</span>&nbsp;<span class="ident" id="6343889">err</span>&nbsp;<span class="op" id="6343893">!=</span>&nbsp;<span class="ident" id="6343896">driver</span><span class="op" id="6343902">.</span><span class="ident" id="6343903">ErrBadConn</span>&nbsp;<span class="op" id="6343914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6343919">return</span>&nbsp;<span class="ident" id="6343926">res</span><span class="op" id="6343929">,</span>&nbsp;<span class="ident" id="6343931">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6343937">}</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6343940">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6343943">return</span>&nbsp;<span class="builtintype" id="6343950">nil</span><span class="op" id="6343953">,</span>&nbsp;<span class="ident" id="6343955">driver</span><span class="op" id="6343961">.</span><span class="ident" id="6343962">ErrBadConn</span><br>
<span class="lineno"></span><span class="op" id="6343973">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6343976">func</span>&nbsp;<span class="ident" id="6343981">resultFromStatement</span><span class="op" id="6344000">(</span><span class="ident" id="6344001">ds</span>&nbsp;<span class="ident" id="6344004">driverStmt</span><span class="op" id="6344014">,</span>&nbsp;<span class="ident" id="6344016">args</span>&nbsp;<span class="op" id="6344021">...</span><span class="keyword" id="6344024">interface</span><span class="op" id="6344033">{</span><span class="op" id="6344034">}</span><span class="op" id="6344035">)</span>&nbsp;<span class="op" id="6344037">(</span><span class="ident" id="6344038">Result</span><span class="op" id="6344044">,</span>&nbsp;<span class="builtintype" id="6344046">error</span><span class="op" id="6344051">)</span>&nbsp;<span class="op" id="6344053">{</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344056">ds</span><span class="op" id="6344058">.</span><span class="ident" id="6344059">Lock</span><span class="op" id="6344063">(</span><span class="op" id="6344064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344067">want</span>&nbsp;<span class="op" id="6344072">:=</span>&nbsp;<span class="ident" id="6344075">ds</span><span class="op" id="6344077">.</span><span class="ident" id="6344078">si</span><span class="op" id="6344080">.</span><span class="ident" id="6344081">NumInput</span><span class="op" id="6344089">(</span><span class="op" id="6344090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344093">ds</span><span class="op" id="6344095">.</span><span class="ident" id="6344096">Unlock</span><span class="op" id="6344102">(</span><span class="op" id="6344103">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6344107">//&nbsp;-1&nbsp;means&nbsp;the&nbsp;driver&nbsp;doesn&#39;t&nbsp;know&nbsp;how&nbsp;to&nbsp;count&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6344171">//&nbsp;placeholders,&nbsp;so&nbsp;we&nbsp;won&#39;t&nbsp;sanity&nbsp;check&nbsp;input&nbsp;here&nbsp;and&nbsp;instead&nbsp;let&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6344245">//&nbsp;driver&nbsp;deal&nbsp;with&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6344274">if</span>&nbsp;<span class="ident" id="6344277">want</span>&nbsp;<span class="op" id="6344282">!=</span>&nbsp;<span class="op" id="6344285">-</span><span class="num" id="6344286">1</span>&nbsp;<span class="op" id="6344288">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="6344291">len</span><span class="op" id="6344294">(</span><span class="ident" id="6344295">args</span><span class="op" id="6344299">)</span>&nbsp;<span class="op" id="6344301">!=</span>&nbsp;<span class="ident" id="6344304">want</span>&nbsp;<span class="op" id="6344309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6344313">return</span>&nbsp;<span class="builtintype" id="6344320">nil</span><span class="op" id="6344323">,</span>&nbsp;<span class="ident" id="6344325">fmt</span><span class="op" id="6344328">.</span><span class="ident" id="6344329">Errorf</span><span class="op" id="6344335">(</span><span class="string" id="6344336">&#34;sql:&nbsp;expected&nbsp;%d&nbsp;arguments,&nbsp;got&nbsp;%d&#34;</span><span class="op" id="6344372">,</span>&nbsp;<span class="ident" id="6344374">want</span><span class="op" id="6344378">,</span>&nbsp;<span class="builtinfunc" id="6344380">len</span><span class="op" id="6344383">(</span><span class="ident" id="6344384">args</span><span class="op" id="6344388">)</span><span class="op" id="6344389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6344392">}</span><br>
<span class="lineno">1335</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344396">dargs</span><span class="op" id="6344401">,</span>&nbsp;<span class="ident" id="6344403">err</span>&nbsp;<span class="op" id="6344407">:=</span>&nbsp;<span class="ident" id="6344410">driverArgs</span><span class="op" id="6344420">(</span><span class="op" id="6344421">&amp;</span><span class="ident" id="6344422">ds</span><span class="op" id="6344424">,</span>&nbsp;<span class="ident" id="6344426">args</span><span class="op" id="6344430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6344433">if</span>&nbsp;<span class="ident" id="6344436">err</span>&nbsp;<span class="op" id="6344440">!=</span>&nbsp;<span class="builtintype" id="6344443">nil</span>&nbsp;<span class="op" id="6344447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6344451">return</span>&nbsp;<span class="builtintype" id="6344458">nil</span><span class="op" id="6344461">,</span>&nbsp;<span class="ident" id="6344463">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6344468">}</span><br>
<span class="lineno">1340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344472">ds</span><span class="op" id="6344474">.</span><span class="ident" id="6344475">Lock</span><span class="op" id="6344479">(</span><span class="op" id="6344480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344483">resi</span><span class="op" id="6344487">,</span>&nbsp;<span class="ident" id="6344489">err</span>&nbsp;<span class="op" id="6344493">:=</span>&nbsp;<span class="ident" id="6344496">ds</span><span class="op" id="6344498">.</span><span class="ident" id="6344499">si</span><span class="op" id="6344501">.</span><span class="ident" id="6344502">Exec</span><span class="op" id="6344506">(</span><span class="ident" id="6344507">dargs</span><span class="op" id="6344512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344515">ds</span><span class="op" id="6344517">.</span><span class="ident" id="6344518">Unlock</span><span class="op" id="6344524">(</span><span class="op" id="6344525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6344528">if</span>&nbsp;<span class="ident" id="6344531">err</span>&nbsp;<span class="op" id="6344535">!=</span>&nbsp;<span class="builtintype" id="6344538">nil</span>&nbsp;<span class="op" id="6344542">{</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6344546">return</span>&nbsp;<span class="builtintype" id="6344553">nil</span><span class="op" id="6344556">,</span>&nbsp;<span class="ident" id="6344558">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6344563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6344566">return</span>&nbsp;<span class="ident" id="6344573">driverResult</span><span class="op" id="6344585">{</span><span class="ident" id="6344586">ds</span><span class="op" id="6344588">.</span><span class="ident" id="6344589">Locker</span><span class="op" id="6344595">,</span>&nbsp;<span class="ident" id="6344597">resi</span><span class="op" id="6344601">}</span><span class="op" id="6344602">,</span>&nbsp;<span class="builtintype" id="6344604">nil</span><br>
<span class="lineno"></span><span class="op" id="6344608">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1350</span><span class="comment" id="6344611">//&nbsp;connStmt&nbsp;returns&nbsp;a&nbsp;free&nbsp;driver&nbsp;connection&nbsp;on&nbsp;which&nbsp;to&nbsp;execute&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6344680">//&nbsp;statement,&nbsp;a&nbsp;function&nbsp;to&nbsp;call&nbsp;to&nbsp;release&nbsp;the&nbsp;connection,&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="6344746">//&nbsp;statement&nbsp;bound&nbsp;to&nbsp;that&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="6344785">func</span>&nbsp;<span class="op" id="6344790">(</span><span class="ident" id="6344791">s</span>&nbsp;<span class="op" id="6344793">*</span><span class="ident" id="6344794">Stmt</span><span class="op" id="6344798">)</span>&nbsp;<span class="ident" id="6344800">connStmt</span><span class="op" id="6344808">(</span><span class="op" id="6344809">)</span>&nbsp;<span class="op" id="6344811">(</span><span class="ident" id="6344812">ci</span>&nbsp;<span class="op" id="6344815">*</span><span class="ident" id="6344816">driverConn</span><span class="op" id="6344826">,</span>&nbsp;<span class="ident" id="6344828">releaseConn</span>&nbsp;<span class="keyword" id="6344840">func</span><span class="op" id="6344844">(</span><span class="builtintype" id="6344845">error</span><span class="op" id="6344850">)</span><span class="op" id="6344851">,</span>&nbsp;<span class="ident" id="6344853">si</span>&nbsp;<span class="ident" id="6344856">driver</span><span class="op" id="6344862">.</span><span class="ident" id="6344863">Stmt</span><span class="op" id="6344867">,</span>&nbsp;<span class="ident" id="6344869">err</span>&nbsp;<span class="builtintype" id="6344873">error</span><span class="op" id="6344878">)</span>&nbsp;<span class="op" id="6344880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6344883">if</span>&nbsp;<span class="ident" id="6344886">err</span>&nbsp;<span class="op" id="6344890">=</span>&nbsp;<span class="ident" id="6344892">s</span><span class="op" id="6344893">.</span><span class="ident" id="6344894">stickyErr</span><span class="op" id="6344903">;</span>&nbsp;<span class="ident" id="6344905">err</span>&nbsp;<span class="op" id="6344909">!=</span>&nbsp;<span class="builtintype" id="6344912">nil</span>&nbsp;<span class="op" id="6344916">{</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6344920">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6344928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344931">s</span><span class="op" id="6344932">.</span><span class="ident" id="6344933">mu</span><span class="op" id="6344935">.</span><span class="ident" id="6344936">Lock</span><span class="op" id="6344940">(</span><span class="op" id="6344941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6344944">if</span>&nbsp;<span class="ident" id="6344947">s</span><span class="op" id="6344948">.</span><span class="ident" id="6344949">closed</span>&nbsp;<span class="op" id="6344956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344960">s</span><span class="op" id="6344961">.</span><span class="ident" id="6344962">mu</span><span class="op" id="6344964">.</span><span class="ident" id="6344965">Unlock</span><span class="op" id="6344971">(</span><span class="op" id="6344972">)</span><br>
<span class="lineno">1360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344976">err</span>&nbsp;<span class="op" id="6344980">=</span>&nbsp;<span class="ident" id="6344982">errors</span><span class="op" id="6344988">.</span><span class="ident" id="6344989">New</span><span class="op" id="6344992">(</span><span class="string" id="6344993">&#34;sql:&nbsp;statement&nbsp;is&nbsp;closed&#34;</span><span class="op" id="6345019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6345023">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6345031">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6345035">//&nbsp;In&nbsp;a&nbsp;transaction,&nbsp;we&nbsp;always&nbsp;use&nbsp;the&nbsp;connection&nbsp;that&nbsp;the</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6345095">//&nbsp;transaction&nbsp;was&nbsp;created&nbsp;on.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6345127">if</span>&nbsp;<span class="ident" id="6345130">s</span><span class="op" id="6345131">.</span><span class="ident" id="6345132">tx</span>&nbsp;<span class="op" id="6345135">!=</span>&nbsp;<span class="builtintype" id="6345138">nil</span>&nbsp;<span class="op" id="6345142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6345146">s</span><span class="op" id="6345147">.</span><span class="ident" id="6345148">mu</span><span class="op" id="6345150">.</span><span class="ident" id="6345151">Unlock</span><span class="op" id="6345157">(</span><span class="op" id="6345158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6345162">ci</span><span class="op" id="6345164">,</span>&nbsp;<span class="ident" id="6345166">err</span>&nbsp;<span class="op" id="6345170">=</span>&nbsp;<span class="ident" id="6345172">s</span><span class="op" id="6345173">.</span><span class="ident" id="6345174">tx</span><span class="op" id="6345176">.</span><span class="ident" id="6345177">grabConn</span><span class="op" id="6345185">(</span><span class="op" id="6345186">)</span>&nbsp;<span class="comment" id="6345188">//&nbsp;blocks,&nbsp;waiting&nbsp;for&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6345229">if</span>&nbsp;<span class="ident" id="6345232">err</span>&nbsp;<span class="op" id="6345236">!=</span>&nbsp;<span class="builtintype" id="6345239">nil</span>&nbsp;<span class="op" id="6345243">{</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6345248">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6345257">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6345261">releaseConn</span>&nbsp;<span class="op" id="6345273">=</span>&nbsp;<span class="keyword" id="6345275">func</span><span class="op" id="6345279">(</span><span class="builtintype" id="6345280">error</span><span class="op" id="6345285">)</span>&nbsp;<span class="op" id="6345287">{</span><span class="op" id="6345288">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6345292">return</span>&nbsp;<span class="ident" id="6345299">ci</span><span class="op" id="6345301">,</span>&nbsp;<span class="ident" id="6345303">releaseConn</span><span class="op" id="6345314">,</span>&nbsp;<span class="ident" id="6345316">s</span><span class="op" id="6345317">.</span><span class="ident" id="6345318">txsi</span><span class="op" id="6345322">.</span><span class="ident" id="6345323">si</span><span class="op" id="6345325">,</span>&nbsp;<span class="builtintype" id="6345327">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6345332">}</span><br>
<span class="lineno">1375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6345336">for</span>&nbsp;<span class="ident" id="6345340">i</span>&nbsp;<span class="op" id="6345342">:=</span>&nbsp;<span class="num" id="6345345">0</span><span class="op" id="6345346">;</span>&nbsp;<span class="ident" id="6345348">i</span>&nbsp;<span class="op" id="6345350">&lt;</span>&nbsp;<span class="builtinfunc" id="6345352">len</span><span class="op" id="6345355">(</span><span class="ident" id="6345356">s</span><span class="op" id="6345357">.</span><span class="ident" id="6345358">css</span><span class="op" id="6345361">)</span><span class="op" id="6345362">;</span>&nbsp;<span class="ident" id="6345364">i</span><span class="op" id="6345365">++</span>&nbsp;<span class="op" id="6345368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6345372">v</span>&nbsp;<span class="op" id="6345374">:=</span>&nbsp;<span class="ident" id="6345377">s</span><span class="op" id="6345378">.</span><span class="ident" id="6345379">css</span><span class="op" id="6345382">[</span><span class="ident" id="6345383">i</span><span class="op" id="6345384">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6345388">_</span><span class="op" id="6345389">,</span>&nbsp;<span class="ident" id="6345391">err</span>&nbsp;<span class="op" id="6345395">:=</span>&nbsp;<span class="ident" id="6345398">s</span><span class="op" id="6345399">.</span><span class="ident" id="6345400">db</span><span class="op" id="6345402">.</span><span class="ident" id="6345403">connIfFree</span><span class="op" id="6345413">(</span><span class="ident" id="6345414">v</span><span class="op" id="6345415">.</span><span class="ident" id="6345416">dc</span><span class="op" id="6345418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6345422">if</span>&nbsp;<span class="ident" id="6345425">err</span>&nbsp;<span class="op" id="6345429">==</span>&nbsp;<span class="builtintype" id="6345432">nil</span>&nbsp;<span class="op" id="6345436">{</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6345441">s</span><span class="op" id="6345442">.</span><span class="ident" id="6345443">mu</span><span class="op" id="6345445">.</span><span class="ident" id="6345446">Unlock</span><span class="op" id="6345452">(</span><span class="op" id="6345453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6345458">return</span>&nbsp;<span class="ident" id="6345465">v</span><span class="op" id="6345466">.</span><span class="ident" id="6345467">dc</span><span class="op" id="6345469">,</span>&nbsp;<span class="ident" id="6345471">v</span><span class="op" id="6345472">.</span><span class="ident" id="6345473">dc</span><span class="op" id="6345475">.</span><span class="ident" id="6345476">releaseConn</span><span class="op" id="6345487">,</span>&nbsp;<span class="ident" id="6345489">v</span><span class="op" id="6345490">.</span><span class="ident" id="6345491">si</span><span class="op" id="6345493">,</span>&nbsp;<span class="builtintype" id="6345495">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6345501">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6345505">if</span>&nbsp;<span class="ident" id="6345508">err</span>&nbsp;<span class="op" id="6345512">==</span>&nbsp;<span class="ident" id="6345515">errConnClosed</span>&nbsp;<span class="op" id="6345529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6345534">//&nbsp;Lazily&nbsp;remove&nbsp;dead&nbsp;conn&nbsp;from&nbsp;our&nbsp;freelist.</span><br>
<span class="lineno">1385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6345583">s</span><span class="op" id="6345584">.</span><span class="ident" id="6345585">css</span><span class="op" id="6345588">[</span><span class="ident" id="6345589">i</span><span class="op" id="6345590">]</span>&nbsp;<span class="op" id="6345592">=</span>&nbsp;<span class="ident" id="6345594">s</span><span class="op" id="6345595">.</span><span class="ident" id="6345596">css</span><span class="op" id="6345599">[</span><span class="builtinfunc" id="6345600">len</span><span class="op" id="6345603">(</span><span class="ident" id="6345604">s</span><span class="op" id="6345605">.</span><span class="ident" id="6345606">css</span><span class="op" id="6345609">)</span><span class="op" id="6345610">-</span><span class="num" id="6345611">1</span><span class="op" id="6345612">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6345617">s</span><span class="op" id="6345618">.</span><span class="ident" id="6345619">css</span>&nbsp;<span class="op" id="6345623">=</span>&nbsp;<span class="ident" id="6345625">s</span><span class="op" id="6345626">.</span><span class="ident" id="6345627">css</span><span class="op" id="6345630">[</span><span class="op" id="6345631">:</span><span class="builtinfunc" id="6345632">len</span><span class="op" id="6345635">(</span><span class="ident" id="6345636">s</span><span class="op" id="6345637">.</span><span class="ident" id="6345638">css</span><span class="op" id="6345641">)</span><span class="op" id="6345642">-</span><span class="num" id="6345643">1</span><span class="op" id="6345644">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6345649">i</span><span class="op" id="6345650">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6345655">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6345659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6345662">s</span><span class="op" id="6345663">.</span><span class="ident" id="6345664">mu</span><span class="op" id="6345666">.</span><span class="ident" id="6345667">Unlock</span><span class="op" id="6345673">(</span><span class="op" id="6345674">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6345678">//&nbsp;If&nbsp;all&nbsp;connections&nbsp;are&nbsp;busy,&nbsp;either&nbsp;wait&nbsp;for&nbsp;one&nbsp;to&nbsp;become&nbsp;available&nbsp;(if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6345755">//&nbsp;we&#39;ve&nbsp;already&nbsp;hit&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;open&nbsp;connections)&nbsp;or&nbsp;create&nbsp;a</span><br>
<span class="lineno">1395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6345829">//&nbsp;new&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6345842">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6345846">//&nbsp;TODO(bradfitz):&nbsp;or&nbsp;always&nbsp;wait&nbsp;for&nbsp;one?&nbsp;make&nbsp;configurable&nbsp;later?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6345915">dc</span><span class="op" id="6345917">,</span>&nbsp;<span class="ident" id="6345919">err</span>&nbsp;<span class="op" id="6345923">:=</span>&nbsp;<span class="ident" id="6345926">s</span><span class="op" id="6345927">.</span><span class="ident" id="6345928">db</span><span class="op" id="6345930">.</span><span class="ident" id="6345931">conn</span><span class="op" id="6345935">(</span><span class="op" id="6345936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6345939">if</span>&nbsp;<span class="ident" id="6345942">err</span>&nbsp;<span class="op" id="6345946">!=</span>&nbsp;<span class="builtintype" id="6345949">nil</span>&nbsp;<span class="op" id="6345953">{</span><br>
<span class="lineno">1400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6345957">return</span>&nbsp;<span class="builtintype" id="6345964">nil</span><span class="op" id="6345967">,</span>&nbsp;<span class="builtintype" id="6345969">nil</span><span class="op" id="6345972">,</span>&nbsp;<span class="builtintype" id="6345974">nil</span><span class="op" id="6345977">,</span>&nbsp;<span class="ident" id="6345979">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6345984">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6345988">//&nbsp;Do&nbsp;another&nbsp;pass&nbsp;over&nbsp;the&nbsp;list&nbsp;to&nbsp;see&nbsp;whether&nbsp;this&nbsp;statement&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6346056">//&nbsp;already&nbsp;been&nbsp;prepared&nbsp;on&nbsp;the&nbsp;connection&nbsp;assigned&nbsp;to&nbsp;us.</span><br>
<span class="lineno">1405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346116">s</span><span class="op" id="6346117">.</span><span class="ident" id="6346118">mu</span><span class="op" id="6346120">.</span><span class="ident" id="6346121">Lock</span><span class="op" id="6346125">(</span><span class="op" id="6346126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346129">for</span>&nbsp;<span class="ident" id="6346133">_</span><span class="op" id="6346134">,</span>&nbsp;<span class="ident" id="6346136">v</span>&nbsp;<span class="op" id="6346138">:=</span>&nbsp;<span class="keyword" id="6346141">range</span>&nbsp;<span class="ident" id="6346147">s</span><span class="op" id="6346148">.</span><span class="ident" id="6346149">css</span>&nbsp;<span class="op" id="6346153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346157">if</span>&nbsp;<span class="ident" id="6346160">v</span><span class="op" id="6346161">.</span><span class="ident" id="6346162">dc</span>&nbsp;<span class="op" id="6346165">==</span>&nbsp;<span class="ident" id="6346168">dc</span>&nbsp;<span class="op" id="6346171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346176">s</span><span class="op" id="6346177">.</span><span class="ident" id="6346178">mu</span><span class="op" id="6346180">.</span><span class="ident" id="6346181">Unlock</span><span class="op" id="6346187">(</span><span class="op" id="6346188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346193">return</span>&nbsp;<span class="ident" id="6346200">dc</span><span class="op" id="6346202">,</span>&nbsp;<span class="ident" id="6346204">dc</span><span class="op" id="6346206">.</span><span class="ident" id="6346207">releaseConn</span><span class="op" id="6346218">,</span>&nbsp;<span class="ident" id="6346220">v</span><span class="op" id="6346221">.</span><span class="ident" id="6346222">si</span><span class="op" id="6346224">,</span>&nbsp;<span class="builtintype" id="6346226">nil</span><br>
<span class="lineno">1410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6346232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6346235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346238">s</span><span class="op" id="6346239">.</span><span class="ident" id="6346240">mu</span><span class="op" id="6346242">.</span><span class="ident" id="6346243">Unlock</span><span class="op" id="6346249">(</span><span class="op" id="6346250">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6346254">//&nbsp;No&nbsp;luck;&nbsp;we&nbsp;need&nbsp;to&nbsp;prepare&nbsp;the&nbsp;statement&nbsp;on&nbsp;this&nbsp;connection</span><br>
<span class="lineno">1415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346319">dc</span><span class="op" id="6346321">.</span><span class="ident" id="6346322">Lock</span><span class="op" id="6346326">(</span><span class="op" id="6346327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346330">si</span><span class="op" id="6346332">,</span>&nbsp;<span class="ident" id="6346334">err</span>&nbsp;<span class="op" id="6346338">=</span>&nbsp;<span class="ident" id="6346340">dc</span><span class="op" id="6346342">.</span><span class="ident" id="6346343">prepareLocked</span><span class="op" id="6346356">(</span><span class="ident" id="6346357">s</span><span class="op" id="6346358">.</span><span class="ident" id="6346359">query</span><span class="op" id="6346364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346367">dc</span><span class="op" id="6346369">.</span><span class="ident" id="6346370">Unlock</span><span class="op" id="6346376">(</span><span class="op" id="6346377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346380">if</span>&nbsp;<span class="ident" id="6346383">err</span>&nbsp;<span class="op" id="6346387">!=</span>&nbsp;<span class="builtintype" id="6346390">nil</span>&nbsp;<span class="op" id="6346394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346398">s</span><span class="op" id="6346399">.</span><span class="ident" id="6346400">db</span><span class="op" id="6346402">.</span><span class="ident" id="6346403">putConn</span><span class="op" id="6346410">(</span><span class="ident" id="6346411">dc</span><span class="op" id="6346413">,</span>&nbsp;<span class="ident" id="6346415">err</span><span class="op" id="6346418">)</span><br>
<span class="lineno">1420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346422">return</span>&nbsp;<span class="builtintype" id="6346429">nil</span><span class="op" id="6346432">,</span>&nbsp;<span class="builtintype" id="6346434">nil</span><span class="op" id="6346437">,</span>&nbsp;<span class="builtintype" id="6346439">nil</span><span class="op" id="6346442">,</span>&nbsp;<span class="ident" id="6346444">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6346449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346452">s</span><span class="op" id="6346453">.</span><span class="ident" id="6346454">mu</span><span class="op" id="6346456">.</span><span class="ident" id="6346457">Lock</span><span class="op" id="6346461">(</span><span class="op" id="6346462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346465">cs</span>&nbsp;<span class="op" id="6346468">:=</span>&nbsp;<span class="ident" id="6346471">connStmt</span><span class="op" id="6346479">{</span><span class="ident" id="6346480">dc</span><span class="op" id="6346482">,</span>&nbsp;<span class="ident" id="6346484">si</span><span class="op" id="6346486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346489">s</span><span class="op" id="6346490">.</span><span class="ident" id="6346491">css</span>&nbsp;<span class="op" id="6346495">=</span>&nbsp;<span class="builtinfunc" id="6346497">append</span><span class="op" id="6346503">(</span><span class="ident" id="6346504">s</span><span class="op" id="6346505">.</span><span class="ident" id="6346506">css</span><span class="op" id="6346509">,</span>&nbsp;<span class="ident" id="6346511">cs</span><span class="op" id="6346513">)</span><br>
<span class="lineno">1425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346516">s</span><span class="op" id="6346517">.</span><span class="ident" id="6346518">mu</span><span class="op" id="6346520">.</span><span class="ident" id="6346521">Unlock</span><span class="op" id="6346527">(</span><span class="op" id="6346528">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346532">return</span>&nbsp;<span class="ident" id="6346539">dc</span><span class="op" id="6346541">,</span>&nbsp;<span class="ident" id="6346543">dc</span><span class="op" id="6346545">.</span><span class="ident" id="6346546">releaseConn</span><span class="op" id="6346557">,</span>&nbsp;<span class="ident" id="6346559">si</span><span class="op" id="6346561">,</span>&nbsp;<span class="builtintype" id="6346563">nil</span><br>
<span class="lineno"></span><span class="op" id="6346567">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1430</span><span class="comment" id="6346570">//&nbsp;Query&nbsp;executes&nbsp;a&nbsp;prepared&nbsp;query&nbsp;statement&nbsp;with&nbsp;the&nbsp;given&nbsp;arguments</span><br>
<span class="lineno"></span><span class="comment" id="6346640">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;query&nbsp;results&nbsp;as&nbsp;a&nbsp;*Rows.</span><br>
<span class="lineno"></span><span class="keyword" id="6346685">func</span>&nbsp;<span class="op" id="6346690">(</span><span class="ident" id="6346691">s</span>&nbsp;<span class="op" id="6346693">*</span><span class="ident" id="6346694">Stmt</span><span class="op" id="6346698">)</span>&nbsp;<span class="ident" id="6346700">Query</span><span class="op" id="6346705">(</span><span class="ident" id="6346706">args</span>&nbsp;<span class="op" id="6346711">...</span><span class="keyword" id="6346714">interface</span><span class="op" id="6346723">{</span><span class="op" id="6346724">}</span><span class="op" id="6346725">)</span>&nbsp;<span class="op" id="6346727">(</span><span class="op" id="6346728">*</span><span class="ident" id="6346729">Rows</span><span class="op" id="6346733">,</span>&nbsp;<span class="builtintype" id="6346735">error</span><span class="op" id="6346740">)</span>&nbsp;<span class="op" id="6346742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346745">s</span><span class="op" id="6346746">.</span><span class="ident" id="6346747">closemu</span><span class="op" id="6346754">.</span><span class="ident" id="6346755">RLock</span><span class="op" id="6346760">(</span><span class="op" id="6346761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346764">defer</span>&nbsp;<span class="ident" id="6346770">s</span><span class="op" id="6346771">.</span><span class="ident" id="6346772">closemu</span><span class="op" id="6346779">.</span><span class="ident" id="6346780">RUnlock</span><span class="op" id="6346787">(</span><span class="op" id="6346788">)</span><br>
<span class="lineno">1435</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346792">var</span>&nbsp;<span class="ident" id="6346796">rowsi</span>&nbsp;<span class="ident" id="6346802">driver</span><span class="op" id="6346808">.</span><span class="ident" id="6346809">Rows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346815">for</span>&nbsp;<span class="ident" id="6346819">i</span>&nbsp;<span class="op" id="6346821">:=</span>&nbsp;<span class="num" id="6346824">0</span><span class="op" id="6346825">;</span>&nbsp;<span class="ident" id="6346827">i</span>&nbsp;<span class="op" id="6346829">&lt;</span>&nbsp;<span class="ident" id="6346831">maxBadConnRetries</span><span class="op" id="6346848">;</span>&nbsp;<span class="ident" id="6346850">i</span><span class="op" id="6346851">++</span>&nbsp;<span class="op" id="6346854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346858">dc</span><span class="op" id="6346860">,</span>&nbsp;<span class="ident" id="6346862">releaseConn</span><span class="op" id="6346873">,</span>&nbsp;<span class="ident" id="6346875">si</span><span class="op" id="6346877">,</span>&nbsp;<span class="ident" id="6346879">err</span>&nbsp;<span class="op" id="6346883">:=</span>&nbsp;<span class="ident" id="6346886">s</span><span class="op" id="6346887">.</span><span class="ident" id="6346888">connStmt</span><span class="op" id="6346896">(</span><span class="op" id="6346897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346901">if</span>&nbsp;<span class="ident" id="6346904">err</span>&nbsp;<span class="op" id="6346908">!=</span>&nbsp;<span class="builtintype" id="6346911">nil</span>&nbsp;<span class="op" id="6346915">{</span><br>
<span class="lineno">1440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346920">if</span>&nbsp;<span class="ident" id="6346923">err</span>&nbsp;<span class="op" id="6346927">==</span>&nbsp;<span class="ident" id="6346930">driver</span><span class="op" id="6346936">.</span><span class="ident" id="6346937">ErrBadConn</span>&nbsp;<span class="op" id="6346948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346954">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6346966">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346971">return</span>&nbsp;<span class="builtintype" id="6346978">nil</span><span class="op" id="6346981">,</span>&nbsp;<span class="ident" id="6346983">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6346989">}</span><br>
<span class="lineno">1445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346994">rowsi</span><span class="op" id="6346999">,</span>&nbsp;<span class="ident" id="6347001">err</span>&nbsp;<span class="op" id="6347005">=</span>&nbsp;<span class="ident" id="6347007">rowsiFromStatement</span><span class="op" id="6347025">(</span><span class="ident" id="6347026">driverStmt</span><span class="op" id="6347036">{</span><span class="ident" id="6347037">dc</span><span class="op" id="6347039">,</span>&nbsp;<span class="ident" id="6347041">si</span><span class="op" id="6347043">}</span><span class="op" id="6347044">,</span>&nbsp;<span class="ident" id="6347046">args</span><span class="op" id="6347050">...</span><span class="op" id="6347053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6347057">if</span>&nbsp;<span class="ident" id="6347060">err</span>&nbsp;<span class="op" id="6347064">==</span>&nbsp;<span class="builtintype" id="6347067">nil</span>&nbsp;<span class="op" id="6347071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6347076">//&nbsp;Note:&nbsp;ownership&nbsp;of&nbsp;ci&nbsp;passes&nbsp;to&nbsp;the&nbsp;*Rows,&nbsp;to&nbsp;be&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6347137">//&nbsp;with&nbsp;releaseConn.</span><br>
<span class="lineno">1450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347161">rows</span>&nbsp;<span class="op" id="6347166">:=</span>&nbsp;<span class="op" id="6347169">&amp;</span><span class="ident" id="6347170">Rows</span><span class="op" id="6347174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347180">dc</span><span class="op" id="6347182">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347187">dc</span><span class="op" id="6347189">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347195">rowsi</span><span class="op" id="6347200">:</span>&nbsp;<span class="ident" id="6347202">rowsi</span><span class="op" id="6347207">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6347213">//&nbsp;releaseConn&nbsp;set&nbsp;below</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6347241">}</span><br>
<span class="lineno">1455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347246">s</span><span class="op" id="6347247">.</span><span class="ident" id="6347248">db</span><span class="op" id="6347250">.</span><span class="ident" id="6347251">addDep</span><span class="op" id="6347257">(</span><span class="ident" id="6347258">s</span><span class="op" id="6347259">,</span>&nbsp;<span class="ident" id="6347261">rows</span><span class="op" id="6347265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347270">rows</span><span class="op" id="6347274">.</span><span class="ident" id="6347275">releaseConn</span>&nbsp;<span class="op" id="6347287">=</span>&nbsp;<span class="keyword" id="6347289">func</span><span class="op" id="6347293">(</span><span class="ident" id="6347294">err</span>&nbsp;<span class="builtintype" id="6347298">error</span><span class="op" id="6347303">)</span>&nbsp;<span class="op" id="6347305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347311">releaseConn</span><span class="op" id="6347322">(</span><span class="ident" id="6347323">err</span><span class="op" id="6347326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347332">s</span><span class="op" id="6347333">.</span><span class="ident" id="6347334">db</span><span class="op" id="6347336">.</span><span class="ident" id="6347337">removeDep</span><span class="op" id="6347346">(</span><span class="ident" id="6347347">s</span><span class="op" id="6347348">,</span>&nbsp;<span class="ident" id="6347350">rows</span><span class="op" id="6347354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6347359">}</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6347364">return</span>&nbsp;<span class="ident" id="6347371">rows</span><span class="op" id="6347375">,</span>&nbsp;<span class="builtintype" id="6347377">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6347383">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347388">releaseConn</span><span class="op" id="6347399">(</span><span class="ident" id="6347400">err</span><span class="op" id="6347403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6347407">if</span>&nbsp;<span class="ident" id="6347410">err</span>&nbsp;<span class="op" id="6347414">!=</span>&nbsp;<span class="ident" id="6347417">driver</span><span class="op" id="6347423">.</span><span class="ident" id="6347424">ErrBadConn</span>&nbsp;<span class="op" id="6347435">{</span><br>
<span class="lineno">1465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6347440">return</span>&nbsp;<span class="builtintype" id="6347447">nil</span><span class="op" id="6347450">,</span>&nbsp;<span class="ident" id="6347452">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6347458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6347461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6347464">return</span>&nbsp;<span class="builtintype" id="6347471">nil</span><span class="op" id="6347474">,</span>&nbsp;<span class="ident" id="6347476">driver</span><span class="op" id="6347482">.</span><span class="ident" id="6347483">ErrBadConn</span><br>
<span class="lineno"></span><span class="op" id="6347494">}</span><br>
<span class="lineno">1470</span><br>
<span class="lineno"></span><span class="keyword" id="6347497">func</span>&nbsp;<span class="ident" id="6347502">rowsiFromStatement</span><span class="op" id="6347520">(</span><span class="ident" id="6347521">ds</span>&nbsp;<span class="ident" id="6347524">driverStmt</span><span class="op" id="6347534">,</span>&nbsp;<span class="ident" id="6347536">args</span>&nbsp;<span class="op" id="6347541">...</span><span class="keyword" id="6347544">interface</span><span class="op" id="6347553">{</span><span class="op" id="6347554">}</span><span class="op" id="6347555">)</span>&nbsp;<span class="op" id="6347557">(</span><span class="ident" id="6347558">driver</span><span class="op" id="6347564">.</span><span class="ident" id="6347565">Rows</span><span class="op" id="6347569">,</span>&nbsp;<span class="builtintype" id="6347571">error</span><span class="op" id="6347576">)</span>&nbsp;<span class="op" id="6347578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347581">ds</span><span class="op" id="6347583">.</span><span class="ident" id="6347584">Lock</span><span class="op" id="6347588">(</span><span class="op" id="6347589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347592">want</span>&nbsp;<span class="op" id="6347597">:=</span>&nbsp;<span class="ident" id="6347600">ds</span><span class="op" id="6347602">.</span><span class="ident" id="6347603">si</span><span class="op" id="6347605">.</span><span class="ident" id="6347606">NumInput</span><span class="op" id="6347614">(</span><span class="op" id="6347615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347618">ds</span><span class="op" id="6347620">.</span><span class="ident" id="6347621">Unlock</span><span class="op" id="6347627">(</span><span class="op" id="6347628">)</span><br>
<span class="lineno">1475</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6347632">//&nbsp;-1&nbsp;means&nbsp;the&nbsp;driver&nbsp;doesn&#39;t&nbsp;know&nbsp;how&nbsp;to&nbsp;count&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6347696">//&nbsp;placeholders,&nbsp;so&nbsp;we&nbsp;won&#39;t&nbsp;sanity&nbsp;check&nbsp;input&nbsp;here&nbsp;and&nbsp;instead&nbsp;let&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6347770">//&nbsp;driver&nbsp;deal&nbsp;with&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6347799">if</span>&nbsp;<span class="ident" id="6347802">want</span>&nbsp;<span class="op" id="6347807">!=</span>&nbsp;<span class="op" id="6347810">-</span><span class="num" id="6347811">1</span>&nbsp;<span class="op" id="6347813">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="6347816">len</span><span class="op" id="6347819">(</span><span class="ident" id="6347820">args</span><span class="op" id="6347824">)</span>&nbsp;<span class="op" id="6347826">!=</span>&nbsp;<span class="ident" id="6347829">want</span>&nbsp;<span class="op" id="6347834">{</span><br>
<span class="lineno">1480</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6347838">return</span>&nbsp;<span class="builtintype" id="6347845">nil</span><span class="op" id="6347848">,</span>&nbsp;<span class="ident" id="6347850">fmt</span><span class="op" id="6347853">.</span><span class="ident" id="6347854">Errorf</span><span class="op" id="6347860">(</span><span class="string" id="6347861">&#34;sql:&nbsp;statement&nbsp;expects&nbsp;%d&nbsp;inputs;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="6347903">,</span>&nbsp;<span class="ident" id="6347905">want</span><span class="op" id="6347909">,</span>&nbsp;<span class="builtinfunc" id="6347911">len</span><span class="op" id="6347914">(</span><span class="ident" id="6347915">args</span><span class="op" id="6347919">)</span><span class="op" id="6347920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6347923">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347927">dargs</span><span class="op" id="6347932">,</span>&nbsp;<span class="ident" id="6347934">err</span>&nbsp;<span class="op" id="6347938">:=</span>&nbsp;<span class="ident" id="6347941">driverArgs</span><span class="op" id="6347951">(</span><span class="op" id="6347952">&amp;</span><span class="ident" id="6347953">ds</span><span class="op" id="6347955">,</span>&nbsp;<span class="ident" id="6347957">args</span><span class="op" id="6347961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6347964">if</span>&nbsp;<span class="ident" id="6347967">err</span>&nbsp;<span class="op" id="6347971">!=</span>&nbsp;<span class="builtintype" id="6347974">nil</span>&nbsp;<span class="op" id="6347978">{</span><br>
<span class="lineno">1485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6347982">return</span>&nbsp;<span class="builtintype" id="6347989">nil</span><span class="op" id="6347992">,</span>&nbsp;<span class="ident" id="6347994">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6347999">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6348003">ds</span><span class="op" id="6348005">.</span><span class="ident" id="6348006">Lock</span><span class="op" id="6348010">(</span><span class="op" id="6348011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6348014">rowsi</span><span class="op" id="6348019">,</span>&nbsp;<span class="ident" id="6348021">err</span>&nbsp;<span class="op" id="6348025">:=</span>&nbsp;<span class="ident" id="6348028">ds</span><span class="op" id="6348030">.</span><span class="ident" id="6348031">si</span><span class="op" id="6348033">.</span><span class="ident" id="6348034">Query</span><span class="op" id="6348039">(</span><span class="ident" id="6348040">dargs</span><span class="op" id="6348045">)</span><br>
<span class="lineno">1490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6348048">ds</span><span class="op" id="6348050">.</span><span class="ident" id="6348051">Unlock</span><span class="op" id="6348057">(</span><span class="op" id="6348058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6348061">if</span>&nbsp;<span class="ident" id="6348064">err</span>&nbsp;<span class="op" id="6348068">!=</span>&nbsp;<span class="builtintype" id="6348071">nil</span>&nbsp;<span class="op" id="6348075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6348079">return</span>&nbsp;<span class="builtintype" id="6348086">nil</span><span class="op" id="6348089">,</span>&nbsp;<span class="ident" id="6348091">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6348096">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6348099">return</span>&nbsp;<span class="ident" id="6348106">rowsi</span><span class="op" id="6348111">,</span>&nbsp;<span class="builtintype" id="6348113">nil</span><br>
<span class="lineno">1495</span><span class="op" id="6348117">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6348120">//&nbsp;QueryRow&nbsp;executes&nbsp;a&nbsp;prepared&nbsp;query&nbsp;statement&nbsp;with&nbsp;the&nbsp;given&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="comment" id="6348194">//&nbsp;If&nbsp;an&nbsp;error&nbsp;occurs&nbsp;during&nbsp;the&nbsp;execution&nbsp;of&nbsp;the&nbsp;statement,&nbsp;that&nbsp;error&nbsp;will</span><br>
<span class="lineno"></span><span class="comment" id="6348271">//&nbsp;be&nbsp;returned&nbsp;by&nbsp;a&nbsp;call&nbsp;to&nbsp;Scan&nbsp;on&nbsp;the&nbsp;returned&nbsp;*Row,&nbsp;which&nbsp;is&nbsp;always&nbsp;non-nil.</span><br>
<span class="lineno">1500</span><span class="comment" id="6348351">//&nbsp;If&nbsp;the&nbsp;query&nbsp;selects&nbsp;no&nbsp;rows,&nbsp;the&nbsp;*Row&#39;s&nbsp;Scan&nbsp;will&nbsp;return&nbsp;ErrNoRows.</span><br>
<span class="lineno"></span><span class="comment" id="6348423">//&nbsp;Otherwise,&nbsp;the&nbsp;*Row&#39;s&nbsp;Scan&nbsp;scans&nbsp;the&nbsp;first&nbsp;selected&nbsp;row&nbsp;and&nbsp;discards</span><br>
<span class="lineno"></span><span class="comment" id="6348495">//&nbsp;the&nbsp;rest.</span><br>
<span class="lineno"></span><span class="comment" id="6348508">//</span><br>
<span class="lineno"></span><span class="comment" id="6348511">//&nbsp;Example&nbsp;usage:</span><br>
<span class="lineno">1505</span><span class="comment" id="6348529">//</span><br>
<span class="lineno"></span><span class="comment" id="6348532">//&nbsp;&nbsp;var&nbsp;name&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="6348552">//&nbsp;&nbsp;err&nbsp;:=&nbsp;nameByUseridStmt.QueryRow(id).Scan(&amp;name)</span><br>
<span class="lineno"></span><span class="keyword" id="6348605">func</span>&nbsp;<span class="op" id="6348610">(</span><span class="ident" id="6348611">s</span>&nbsp;<span class="op" id="6348613">*</span><span class="ident" id="6348614">Stmt</span><span class="op" id="6348618">)</span>&nbsp;<span class="ident" id="6348620">QueryRow</span><span class="op" id="6348628">(</span><span class="ident" id="6348629">args</span>&nbsp;<span class="op" id="6348634">...</span><span class="keyword" id="6348637">interface</span><span class="op" id="6348646">{</span><span class="op" id="6348647">}</span><span class="op" id="6348648">)</span>&nbsp;<span class="op" id="6348650">*</span><span class="ident" id="6348651">Row</span>&nbsp;<span class="op" id="6348655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6348658">rows</span><span class="op" id="6348662">,</span>&nbsp;<span class="ident" id="6348664">err</span>&nbsp;<span class="op" id="6348668">:=</span>&nbsp;<span class="ident" id="6348671">s</span><span class="op" id="6348672">.</span><span class="ident" id="6348673">Query</span><span class="op" id="6348678">(</span><span class="ident" id="6348679">args</span><span class="op" id="6348683">...</span><span class="op" id="6348686">)</span><br>
<span class="lineno">1510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6348689">if</span>&nbsp;<span class="ident" id="6348692">err</span>&nbsp;<span class="op" id="6348696">!=</span>&nbsp;<span class="builtintype" id="6348699">nil</span>&nbsp;<span class="op" id="6348703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6348707">return</span>&nbsp;<span class="op" id="6348714">&amp;</span><span class="ident" id="6348715">Row</span><span class="op" id="6348718">{</span><span class="ident" id="6348719">err</span><span class="op" id="6348722">:</span>&nbsp;<span class="ident" id="6348724">err</span><span class="op" id="6348727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6348730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6348733">return</span>&nbsp;<span class="op" id="6348740">&amp;</span><span class="ident" id="6348741">Row</span><span class="op" id="6348744">{</span><span class="ident" id="6348745">rows</span><span class="op" id="6348749">:</span>&nbsp;<span class="ident" id="6348751">rows</span><span class="op" id="6348755">}</span><br>
<span class="lineno"></span><span class="op" id="6348757">}</span><br>
<span class="lineno">1515</span><br>
<span class="lineno"></span><span class="comment" id="6348760">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="6348791">func</span>&nbsp;<span class="op" id="6348796">(</span><span class="ident" id="6348797">s</span>&nbsp;<span class="op" id="6348799">*</span><span class="ident" id="6348800">Stmt</span><span class="op" id="6348804">)</span>&nbsp;<span class="ident" id="6348806">Close</span><span class="op" id="6348811">(</span><span class="op" id="6348812">)</span>&nbsp;<span class="builtintype" id="6348814">error</span>&nbsp;<span class="op" id="6348820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6348823">s</span><span class="op" id="6348824">.</span><span class="ident" id="6348825">closemu</span><span class="op" id="6348832">.</span><span class="ident" id="6348833">Lock</span><span class="op" id="6348837">(</span><span class="op" id="6348838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6348841">defer</span>&nbsp;<span class="ident" id="6348847">s</span><span class="op" id="6348848">.</span><span class="ident" id="6348849">closemu</span><span class="op" id="6348856">.</span><span class="ident" id="6348857">Unlock</span><span class="op" id="6348863">(</span><span class="op" id="6348864">)</span><br>
<span class="lineno">1520</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6348868">if</span>&nbsp;<span class="ident" id="6348871">s</span><span class="op" id="6348872">.</span><span class="ident" id="6348873">stickyErr</span>&nbsp;<span class="op" id="6348883">!=</span>&nbsp;<span class="builtintype" id="6348886">nil</span>&nbsp;<span class="op" id="6348890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6348894">return</span>&nbsp;<span class="ident" id="6348901">s</span><span class="op" id="6348902">.</span><span class="ident" id="6348903">stickyErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6348914">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6348917">s</span><span class="op" id="6348918">.</span><span class="ident" id="6348919">mu</span><span class="op" id="6348921">.</span><span class="ident" id="6348922">Lock</span><span class="op" id="6348926">(</span><span class="op" id="6348927">)</span><br>
<span class="lineno">1525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6348930">if</span>&nbsp;<span class="ident" id="6348933">s</span><span class="op" id="6348934">.</span><span class="ident" id="6348935">closed</span>&nbsp;<span class="op" id="6348942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6348946">s</span><span class="op" id="6348947">.</span><span class="ident" id="6348948">mu</span><span class="op" id="6348950">.</span><span class="ident" id="6348951">Unlock</span><span class="op" id="6348957">(</span><span class="op" id="6348958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6348962">return</span>&nbsp;<span class="builtintype" id="6348969">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6348974">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6348977">s</span><span class="op" id="6348978">.</span><span class="ident" id="6348979">closed</span>&nbsp;<span class="op" id="6348986">=</span>&nbsp;<span class="builtintype" id="6348988">true</span><br>
<span class="lineno">1530</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6348995">if</span>&nbsp;<span class="ident" id="6348998">s</span><span class="op" id="6348999">.</span><span class="ident" id="6349000">tx</span>&nbsp;<span class="op" id="6349003">!=</span>&nbsp;<span class="builtintype" id="6349006">nil</span>&nbsp;<span class="op" id="6349010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349014">s</span><span class="op" id="6349015">.</span><span class="ident" id="6349016">txsi</span><span class="op" id="6349020">.</span><span class="ident" id="6349021">Close</span><span class="op" id="6349026">(</span><span class="op" id="6349027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349031">s</span><span class="op" id="6349032">.</span><span class="ident" id="6349033">mu</span><span class="op" id="6349035">.</span><span class="ident" id="6349036">Unlock</span><span class="op" id="6349042">(</span><span class="op" id="6349043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6349047">return</span>&nbsp;<span class="builtintype" id="6349054">nil</span><br>
<span class="lineno">1535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6349059">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349062">s</span><span class="op" id="6349063">.</span><span class="ident" id="6349064">mu</span><span class="op" id="6349066">.</span><span class="ident" id="6349067">Unlock</span><span class="op" id="6349073">(</span><span class="op" id="6349074">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6349078">return</span>&nbsp;<span class="ident" id="6349085">s</span><span class="op" id="6349086">.</span><span class="ident" id="6349087">db</span><span class="op" id="6349089">.</span><span class="ident" id="6349090">removeDep</span><span class="op" id="6349099">(</span><span class="ident" id="6349100">s</span><span class="op" id="6349101">,</span>&nbsp;<span class="ident" id="6349103">s</span><span class="op" id="6349104">)</span><br>
<span class="lineno"></span><span class="op" id="6349106">}</span><br>
<span class="lineno">1540</span><br>
<span class="lineno"></span><span class="keyword" id="6349109">func</span>&nbsp;<span class="op" id="6349114">(</span><span class="ident" id="6349115">s</span>&nbsp;<span class="op" id="6349117">*</span><span class="ident" id="6349118">Stmt</span><span class="op" id="6349122">)</span>&nbsp;<span class="ident" id="6349124">finalClose</span><span class="op" id="6349134">(</span><span class="op" id="6349135">)</span>&nbsp;<span class="builtintype" id="6349137">error</span>&nbsp;<span class="op" id="6349143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349146">s</span><span class="op" id="6349147">.</span><span class="ident" id="6349148">mu</span><span class="op" id="6349150">.</span><span class="ident" id="6349151">Lock</span><span class="op" id="6349155">(</span><span class="op" id="6349156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6349159">defer</span>&nbsp;<span class="ident" id="6349165">s</span><span class="op" id="6349166">.</span><span class="ident" id="6349167">mu</span><span class="op" id="6349169">.</span><span class="ident" id="6349170">Unlock</span><span class="op" id="6349176">(</span><span class="op" id="6349177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6349180">if</span>&nbsp;<span class="ident" id="6349183">s</span><span class="op" id="6349184">.</span><span class="ident" id="6349185">css</span>&nbsp;<span class="op" id="6349189">!=</span>&nbsp;<span class="builtintype" id="6349192">nil</span>&nbsp;<span class="op" id="6349196">{</span><br>
<span class="lineno">1545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6349200">for</span>&nbsp;<span class="ident" id="6349204">_</span><span class="op" id="6349205">,</span>&nbsp;<span class="ident" id="6349207">v</span>&nbsp;<span class="op" id="6349209">:=</span>&nbsp;<span class="keyword" id="6349212">range</span>&nbsp;<span class="ident" id="6349218">s</span><span class="op" id="6349219">.</span><span class="ident" id="6349220">css</span>&nbsp;<span class="op" id="6349224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349229">s</span><span class="op" id="6349230">.</span><span class="ident" id="6349231">db</span><span class="op" id="6349233">.</span><span class="ident" id="6349234">noteUnusedDriverStatement</span><span class="op" id="6349259">(</span><span class="ident" id="6349260">v</span><span class="op" id="6349261">.</span><span class="ident" id="6349262">dc</span><span class="op" id="6349264">,</span>&nbsp;<span class="ident" id="6349266">v</span><span class="op" id="6349267">.</span><span class="ident" id="6349268">si</span><span class="op" id="6349270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349275">v</span><span class="op" id="6349276">.</span><span class="ident" id="6349277">dc</span><span class="op" id="6349279">.</span><span class="ident" id="6349280">removeOpenStmt</span><span class="op" id="6349294">(</span><span class="ident" id="6349295">v</span><span class="op" id="6349296">.</span><span class="ident" id="6349297">si</span><span class="op" id="6349299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6349303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349307">s</span><span class="op" id="6349308">.</span><span class="ident" id="6349309">css</span>&nbsp;<span class="op" id="6349313">=</span>&nbsp;<span class="builtintype" id="6349315">nil</span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6349320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6349323">return</span>&nbsp;<span class="builtintype" id="6349330">nil</span><br>
<span class="lineno"></span><span class="op" id="6349334">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6349337">//&nbsp;Rows&nbsp;is&nbsp;the&nbsp;result&nbsp;of&nbsp;a&nbsp;query.&nbsp;Its&nbsp;cursor&nbsp;starts&nbsp;before&nbsp;the&nbsp;first&nbsp;row</span><br>
<span class="lineno">1555</span><span class="comment" id="6349410">//&nbsp;of&nbsp;the&nbsp;result&nbsp;set.&nbsp;Use&nbsp;Next&nbsp;to&nbsp;advance&nbsp;through&nbsp;the&nbsp;rows:</span><br>
<span class="lineno"></span><span class="comment" id="6349470">//</span><br>
<span class="lineno"></span><span class="comment" id="6349473">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rows,&nbsp;err&nbsp;:=&nbsp;db.Query(&#34;SELECT&nbsp;...&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="6349516">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="6349527">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defer&nbsp;rows.Close()</span><br>
<span class="lineno">1560</span><span class="comment" id="6349553">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;rows.Next()&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="6349578">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;id&nbsp;int</span><br>
<span class="lineno"></span><span class="comment" id="6349600">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;name&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="6349627">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;rows.Scan(&amp;id,&nbsp;&amp;name)</span><br>
<span class="lineno"></span><span class="comment" id="6349666">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br>
<span class="lineno">1565</span><span class="comment" id="6349681">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="6349690">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;rows.Err()&nbsp;//&nbsp;get&nbsp;any&nbsp;error&nbsp;encountered&nbsp;during&nbsp;iteration</span><br>
<span class="lineno"></span><span class="comment" id="6349760">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="keyword" id="6349771">type</span>&nbsp;<span class="ident" id="6349776">Rows</span>&nbsp;<span class="keyword" id="6349781">struct</span>&nbsp;<span class="op" id="6349788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349791">dc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6349803">*</span><span class="ident" id="6349804">driverConn</span>&nbsp;<span class="comment" id="6349815">//&nbsp;owned;&nbsp;must&nbsp;call&nbsp;releaseConn&nbsp;when&nbsp;closed&nbsp;to&nbsp;release</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349871">releaseConn</span>&nbsp;<span class="keyword" id="6349883">func</span><span class="op" id="6349887">(</span><span class="builtintype" id="6349888">error</span><span class="op" id="6349893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349896">rowsi</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349908">driver</span><span class="op" id="6349914">.</span><span class="ident" id="6349915">Rows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349922">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6349932">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349938">lastcols</span>&nbsp;&nbsp;<span class="op" id="6349948">[</span><span class="op" id="6349949">]</span><span class="ident" id="6349950">driver</span><span class="op" id="6349956">.</span><span class="ident" id="6349957">Value</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349964">lasterr</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6349974">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6349986">//&nbsp;non-nil&nbsp;only&nbsp;if&nbsp;closed&nbsp;is&nbsp;true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350021">closeStmt</span>&nbsp;<span class="ident" id="6350031">driver</span><span class="op" id="6350037">.</span><span class="ident" id="6350038">Stmt</span>&nbsp;<span class="comment" id="6350043">//&nbsp;if&nbsp;non-nil,&nbsp;statement&nbsp;to&nbsp;Close&nbsp;on&nbsp;close</span><br>
<span class="lineno"></span><span class="op" id="6350086">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6350089">//&nbsp;Next&nbsp;prepares&nbsp;the&nbsp;next&nbsp;result&nbsp;row&nbsp;for&nbsp;reading&nbsp;with&nbsp;the&nbsp;Scan&nbsp;method.&nbsp;&nbsp;It</span><br>
<span class="lineno">1580</span><span class="comment" id="6350164">//&nbsp;returns&nbsp;true&nbsp;on&nbsp;success,&nbsp;or&nbsp;false&nbsp;if&nbsp;there&nbsp;is&nbsp;no&nbsp;next&nbsp;result&nbsp;row&nbsp;or&nbsp;an&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="6350244">//&nbsp;happened&nbsp;while&nbsp;preparing&nbsp;it.&nbsp;&nbsp;Err&nbsp;should&nbsp;be&nbsp;consulted&nbsp;to&nbsp;distinguish&nbsp;between</span><br>
<span class="lineno"></span><span class="comment" id="6350324">//&nbsp;the&nbsp;two&nbsp;cases.</span><br>
<span class="lineno"></span><span class="comment" id="6350342">//</span><br>
<span class="lineno"></span><span class="comment" id="6350345">//&nbsp;Every&nbsp;call&nbsp;to&nbsp;Scan,&nbsp;even&nbsp;the&nbsp;first&nbsp;one,&nbsp;must&nbsp;be&nbsp;preceded&nbsp;by&nbsp;a&nbsp;call&nbsp;to&nbsp;Next.</span><br>
<span class="lineno">1585</span><span class="keyword" id="6350424">func</span>&nbsp;<span class="op" id="6350429">(</span><span class="ident" id="6350430">rs</span>&nbsp;<span class="op" id="6350433">*</span><span class="ident" id="6350434">Rows</span><span class="op" id="6350438">)</span>&nbsp;<span class="ident" id="6350440">Next</span><span class="op" id="6350444">(</span><span class="op" id="6350445">)</span>&nbsp;<span class="builtintype" id="6350447">bool</span>&nbsp;<span class="op" id="6350452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6350455">if</span>&nbsp;<span class="ident" id="6350458">rs</span><span class="op" id="6350460">.</span><span class="ident" id="6350461">closed</span>&nbsp;<span class="op" id="6350468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6350472">return</span>&nbsp;<span class="builtintype" id="6350479">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6350486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6350489">if</span>&nbsp;<span class="ident" id="6350492">rs</span><span class="op" id="6350494">.</span><span class="ident" id="6350495">lastcols</span>&nbsp;<span class="op" id="6350504">==</span>&nbsp;<span class="builtintype" id="6350507">nil</span>&nbsp;<span class="op" id="6350511">{</span><br>
<span class="lineno">1590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350515">rs</span><span class="op" id="6350517">.</span><span class="ident" id="6350518">lastcols</span>&nbsp;<span class="op" id="6350527">=</span>&nbsp;<span class="builtinfunc" id="6350529">make</span><span class="op" id="6350533">(</span><span class="op" id="6350534">[</span><span class="op" id="6350535">]</span><span class="ident" id="6350536">driver</span><span class="op" id="6350542">.</span><span class="ident" id="6350543">Value</span><span class="op" id="6350548">,</span>&nbsp;<span class="builtinfunc" id="6350550">len</span><span class="op" id="6350553">(</span><span class="ident" id="6350554">rs</span><span class="op" id="6350556">.</span><span class="ident" id="6350557">rowsi</span><span class="op" id="6350562">.</span><span class="ident" id="6350563">Columns</span><span class="op" id="6350570">(</span><span class="op" id="6350571">)</span><span class="op" id="6350572">)</span><span class="op" id="6350573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6350576">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350579">rs</span><span class="op" id="6350581">.</span><span class="ident" id="6350582">lasterr</span>&nbsp;<span class="op" id="6350590">=</span>&nbsp;<span class="ident" id="6350592">rs</span><span class="op" id="6350594">.</span><span class="ident" id="6350595">rowsi</span><span class="op" id="6350600">.</span><span class="ident" id="6350601">Next</span><span class="op" id="6350605">(</span><span class="ident" id="6350606">rs</span><span class="op" id="6350608">.</span><span class="ident" id="6350609">lastcols</span><span class="op" id="6350617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6350620">if</span>&nbsp;<span class="ident" id="6350623">rs</span><span class="op" id="6350625">.</span><span class="ident" id="6350626">lasterr</span>&nbsp;<span class="op" id="6350634">!=</span>&nbsp;<span class="builtintype" id="6350637">nil</span>&nbsp;<span class="op" id="6350641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350645">rs</span><span class="op" id="6350647">.</span><span class="ident" id="6350648">Close</span><span class="op" id="6350653">(</span><span class="op" id="6350654">)</span><br>
<span class="lineno">1595</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6350658">return</span>&nbsp;<span class="builtintype" id="6350665">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6350672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6350675">return</span>&nbsp;<span class="builtintype" id="6350682">true</span><br>
<span class="lineno"></span><span class="op" id="6350687">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1600</span><span class="comment" id="6350690">//&nbsp;Err&nbsp;returns&nbsp;the&nbsp;error,&nbsp;if&nbsp;any,&nbsp;that&nbsp;was&nbsp;encountered&nbsp;during&nbsp;iteration.</span><br>
<span class="lineno"></span><span class="comment" id="6350763">//&nbsp;Err&nbsp;may&nbsp;be&nbsp;called&nbsp;after&nbsp;an&nbsp;explicit&nbsp;or&nbsp;implicit&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="6350821">func</span>&nbsp;<span class="op" id="6350826">(</span><span class="ident" id="6350827">rs</span>&nbsp;<span class="op" id="6350830">*</span><span class="ident" id="6350831">Rows</span><span class="op" id="6350835">)</span>&nbsp;<span class="ident" id="6350837">Err</span><span class="op" id="6350840">(</span><span class="op" id="6350841">)</span>&nbsp;<span class="builtintype" id="6350843">error</span>&nbsp;<span class="op" id="6350849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6350852">if</span>&nbsp;<span class="ident" id="6350855">rs</span><span class="op" id="6350857">.</span><span class="ident" id="6350858">lasterr</span>&nbsp;<span class="op" id="6350866">==</span>&nbsp;<span class="ident" id="6350869">io</span><span class="op" id="6350871">.</span><span class="ident" id="6350872">EOF</span>&nbsp;<span class="op" id="6350876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6350880">return</span>&nbsp;<span class="builtintype" id="6350887">nil</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6350892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6350895">return</span>&nbsp;<span class="ident" id="6350902">rs</span><span class="op" id="6350904">.</span><span class="ident" id="6350905">lasterr</span><br>
<span class="lineno"></span><span class="op" id="6350913">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6350916">//&nbsp;Columns&nbsp;returns&nbsp;the&nbsp;column&nbsp;names.</span><br>
<span class="lineno">1610</span><span class="comment" id="6350953">//&nbsp;Columns&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;rows&nbsp;are&nbsp;closed,&nbsp;or&nbsp;if&nbsp;the&nbsp;rows</span><br>
<span class="lineno"></span><span class="comment" id="6351020">//&nbsp;are&nbsp;from&nbsp;QueryRow&nbsp;and&nbsp;there&nbsp;was&nbsp;a&nbsp;deferred&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="6351073">func</span>&nbsp;<span class="op" id="6351078">(</span><span class="ident" id="6351079">rs</span>&nbsp;<span class="op" id="6351082">*</span><span class="ident" id="6351083">Rows</span><span class="op" id="6351087">)</span>&nbsp;<span class="ident" id="6351089">Columns</span><span class="op" id="6351096">(</span><span class="op" id="6351097">)</span>&nbsp;<span class="op" id="6351099">(</span><span class="op" id="6351100">[</span><span class="op" id="6351101">]</span><span class="builtintype" id="6351102">string</span><span class="op" id="6351108">,</span>&nbsp;<span class="builtintype" id="6351110">error</span><span class="op" id="6351115">)</span>&nbsp;<span class="op" id="6351117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6351120">if</span>&nbsp;<span class="ident" id="6351123">rs</span><span class="op" id="6351125">.</span><span class="ident" id="6351126">closed</span>&nbsp;<span class="op" id="6351133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6351137">return</span>&nbsp;<span class="builtintype" id="6351144">nil</span><span class="op" id="6351147">,</span>&nbsp;<span class="ident" id="6351149">errors</span><span class="op" id="6351155">.</span><span class="ident" id="6351156">New</span><span class="op" id="6351159">(</span><span class="string" id="6351160">&#34;sql:&nbsp;Rows&nbsp;are&nbsp;closed&#34;</span><span class="op" id="6351182">)</span><br>
<span class="lineno">1615</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6351185">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6351188">if</span>&nbsp;<span class="ident" id="6351191">rs</span><span class="op" id="6351193">.</span><span class="ident" id="6351194">rowsi</span>&nbsp;<span class="op" id="6351200">==</span>&nbsp;<span class="builtintype" id="6351203">nil</span>&nbsp;<span class="op" id="6351207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6351211">return</span>&nbsp;<span class="builtintype" id="6351218">nil</span><span class="op" id="6351221">,</span>&nbsp;<span class="ident" id="6351223">errors</span><span class="op" id="6351229">.</span><span class="ident" id="6351230">New</span><span class="op" id="6351233">(</span><span class="string" id="6351234">&#34;sql:&nbsp;no&nbsp;Rows&nbsp;available&#34;</span><span class="op" id="6351258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6351261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6351264">return</span>&nbsp;<span class="ident" id="6351271">rs</span><span class="op" id="6351273">.</span><span class="ident" id="6351274">rowsi</span><span class="op" id="6351279">.</span><span class="ident" id="6351280">Columns</span><span class="op" id="6351287">(</span><span class="op" id="6351288">)</span><span class="op" id="6351289">,</span>&nbsp;<span class="builtintype" id="6351291">nil</span><br>
<span class="lineno">1620</span><span class="op" id="6351295">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6351298">//&nbsp;Scan&nbsp;copies&nbsp;the&nbsp;columns&nbsp;in&nbsp;the&nbsp;current&nbsp;row&nbsp;into&nbsp;the&nbsp;values&nbsp;pointed</span><br>
<span class="lineno"></span><span class="comment" id="6351368">//&nbsp;at&nbsp;by&nbsp;dest.</span><br>
<span class="lineno"></span><span class="comment" id="6351383">//</span><br>
<span class="lineno">1625</span><span class="comment" id="6351386">//&nbsp;If&nbsp;an&nbsp;argument&nbsp;has&nbsp;type&nbsp;*[]byte,&nbsp;Scan&nbsp;saves&nbsp;in&nbsp;that&nbsp;argument&nbsp;a&nbsp;copy</span><br>
<span class="lineno"></span><span class="comment" id="6351457">//&nbsp;of&nbsp;the&nbsp;corresponding&nbsp;data.&nbsp;The&nbsp;copy&nbsp;is&nbsp;owned&nbsp;by&nbsp;the&nbsp;caller&nbsp;and&nbsp;can</span><br>
<span class="lineno"></span><span class="comment" id="6351527">//&nbsp;be&nbsp;modified&nbsp;and&nbsp;held&nbsp;indefinitely.&nbsp;The&nbsp;copy&nbsp;can&nbsp;be&nbsp;avoided&nbsp;by&nbsp;using</span><br>
<span class="lineno"></span><span class="comment" id="6351598">//&nbsp;an&nbsp;argument&nbsp;of&nbsp;type&nbsp;*RawBytes&nbsp;instead;&nbsp;see&nbsp;the&nbsp;documentation&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="6351666">//&nbsp;RawBytes&nbsp;for&nbsp;restrictions&nbsp;on&nbsp;its&nbsp;use.</span><br>
<span class="lineno">1630</span><span class="comment" id="6351707">//</span><br>
<span class="lineno"></span><span class="comment" id="6351710">//&nbsp;If&nbsp;an&nbsp;argument&nbsp;has&nbsp;type&nbsp;*interface{},&nbsp;Scan&nbsp;copies&nbsp;the&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="6351773">//&nbsp;provided&nbsp;by&nbsp;the&nbsp;underlying&nbsp;driver&nbsp;without&nbsp;conversion.&nbsp;If&nbsp;the&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="6351843">//&nbsp;is&nbsp;of&nbsp;type&nbsp;[]byte,&nbsp;a&nbsp;copy&nbsp;is&nbsp;made&nbsp;and&nbsp;the&nbsp;caller&nbsp;owns&nbsp;the&nbsp;result.</span><br>
<span class="lineno"></span><span class="keyword" id="6351912">func</span>&nbsp;<span class="op" id="6351917">(</span><span class="ident" id="6351918">rs</span>&nbsp;<span class="op" id="6351921">*</span><span class="ident" id="6351922">Rows</span><span class="op" id="6351926">)</span>&nbsp;<span class="ident" id="6351928">Scan</span><span class="op" id="6351932">(</span><span class="ident" id="6351933">dest</span>&nbsp;<span class="op" id="6351938">...</span><span class="keyword" id="6351941">interface</span><span class="op" id="6351950">{</span><span class="op" id="6351951">}</span><span class="op" id="6351952">)</span>&nbsp;<span class="builtintype" id="6351954">error</span>&nbsp;<span class="op" id="6351960">{</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6351963">if</span>&nbsp;<span class="ident" id="6351966">rs</span><span class="op" id="6351968">.</span><span class="ident" id="6351969">closed</span>&nbsp;<span class="op" id="6351976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6351980">return</span>&nbsp;<span class="ident" id="6351987">errors</span><span class="op" id="6351993">.</span><span class="ident" id="6351994">New</span><span class="op" id="6351997">(</span><span class="string" id="6351998">&#34;sql:&nbsp;Rows&nbsp;are&nbsp;closed&#34;</span><span class="op" id="6352020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6352023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352026">if</span>&nbsp;<span class="ident" id="6352029">rs</span><span class="op" id="6352031">.</span><span class="ident" id="6352032">lastcols</span>&nbsp;<span class="op" id="6352041">==</span>&nbsp;<span class="builtintype" id="6352044">nil</span>&nbsp;<span class="op" id="6352048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352052">return</span>&nbsp;<span class="ident" id="6352059">errors</span><span class="op" id="6352065">.</span><span class="ident" id="6352066">New</span><span class="op" id="6352069">(</span><span class="string" id="6352070">&#34;sql:&nbsp;Scan&nbsp;called&nbsp;without&nbsp;calling&nbsp;Next&#34;</span><span class="op" id="6352109">)</span><br>
<span class="lineno">1640</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6352112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352115">if</span>&nbsp;<span class="builtinfunc" id="6352118">len</span><span class="op" id="6352121">(</span><span class="ident" id="6352122">dest</span><span class="op" id="6352126">)</span>&nbsp;<span class="op" id="6352128">!=</span>&nbsp;<span class="builtinfunc" id="6352131">len</span><span class="op" id="6352134">(</span><span class="ident" id="6352135">rs</span><span class="op" id="6352137">.</span><span class="ident" id="6352138">lastcols</span><span class="op" id="6352146">)</span>&nbsp;<span class="op" id="6352148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352152">return</span>&nbsp;<span class="ident" id="6352159">fmt</span><span class="op" id="6352162">.</span><span class="ident" id="6352163">Errorf</span><span class="op" id="6352169">(</span><span class="string" id="6352170">&#34;sql:&nbsp;expected&nbsp;%d&nbsp;destination&nbsp;arguments&nbsp;in&nbsp;Scan,&nbsp;not&nbsp;%d&#34;</span><span class="op" id="6352226">,</span>&nbsp;<span class="builtinfunc" id="6352228">len</span><span class="op" id="6352231">(</span><span class="ident" id="6352232">rs</span><span class="op" id="6352234">.</span><span class="ident" id="6352235">lastcols</span><span class="op" id="6352243">)</span><span class="op" id="6352244">,</span>&nbsp;<span class="builtinfunc" id="6352246">len</span><span class="op" id="6352249">(</span><span class="ident" id="6352250">dest</span><span class="op" id="6352254">)</span><span class="op" id="6352255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6352258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352261">for</span>&nbsp;<span class="ident" id="6352265">i</span><span class="op" id="6352266">,</span>&nbsp;<span class="ident" id="6352268">sv</span>&nbsp;<span class="op" id="6352271">:=</span>&nbsp;<span class="keyword" id="6352274">range</span>&nbsp;<span class="ident" id="6352280">rs</span><span class="op" id="6352282">.</span><span class="ident" id="6352283">lastcols</span>&nbsp;<span class="op" id="6352292">{</span><br>
<span class="lineno">1645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6352296">err</span>&nbsp;<span class="op" id="6352300">:=</span>&nbsp;<span class="ident" id="6352303">convertAssign</span><span class="op" id="6352316">(</span><span class="ident" id="6352317">dest</span><span class="op" id="6352321">[</span><span class="ident" id="6352322">i</span><span class="op" id="6352323">]</span><span class="op" id="6352324">,</span>&nbsp;<span class="ident" id="6352326">sv</span><span class="op" id="6352328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352332">if</span>&nbsp;<span class="ident" id="6352335">err</span>&nbsp;<span class="op" id="6352339">!=</span>&nbsp;<span class="builtintype" id="6352342">nil</span>&nbsp;<span class="op" id="6352346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352351">return</span>&nbsp;<span class="ident" id="6352358">fmt</span><span class="op" id="6352361">.</span><span class="ident" id="6352362">Errorf</span><span class="op" id="6352368">(</span><span class="string" id="6352369">&#34;sql:&nbsp;Scan&nbsp;error&nbsp;on&nbsp;column&nbsp;index&nbsp;%d:&nbsp;%v&#34;</span><span class="op" id="6352409">,</span>&nbsp;<span class="ident" id="6352411">i</span><span class="op" id="6352412">,</span>&nbsp;<span class="ident" id="6352414">err</span><span class="op" id="6352417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6352421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6352424">}</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352427">return</span>&nbsp;<span class="builtintype" id="6352434">nil</span><br>
<span class="lineno"></span><span class="op" id="6352438">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6352441">var</span>&nbsp;<span class="ident" id="6352445">rowsCloseHook</span>&nbsp;<span class="keyword" id="6352459">func</span><span class="op" id="6352463">(</span><span class="op" id="6352464">*</span><span class="ident" id="6352465">Rows</span><span class="op" id="6352469">,</span>&nbsp;<span class="op" id="6352471">*</span><span class="builtintype" id="6352472">error</span><span class="op" id="6352477">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1655</span><span class="comment" id="6352480">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;Rows,&nbsp;preventing&nbsp;further&nbsp;enumeration.&nbsp;If&nbsp;Next&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="6352554">//&nbsp;false,&nbsp;the&nbsp;Rows&nbsp;are&nbsp;closed&nbsp;automatically&nbsp;and&nbsp;it&nbsp;will&nbsp;suffice&nbsp;to&nbsp;check&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6352631">//&nbsp;result&nbsp;of&nbsp;Err.&nbsp;Close&nbsp;is&nbsp;idempotent&nbsp;and&nbsp;does&nbsp;not&nbsp;affect&nbsp;the&nbsp;result&nbsp;of&nbsp;Err.</span><br>
<span class="lineno"></span><span class="keyword" id="6352708">func</span>&nbsp;<span class="op" id="6352713">(</span><span class="ident" id="6352714">rs</span>&nbsp;<span class="op" id="6352717">*</span><span class="ident" id="6352718">Rows</span><span class="op" id="6352722">)</span>&nbsp;<span class="ident" id="6352724">Close</span><span class="op" id="6352729">(</span><span class="op" id="6352730">)</span>&nbsp;<span class="builtintype" id="6352732">error</span>&nbsp;<span class="op" id="6352738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352741">if</span>&nbsp;<span class="ident" id="6352744">rs</span><span class="op" id="6352746">.</span><span class="ident" id="6352747">closed</span>&nbsp;<span class="op" id="6352754">{</span><br>
<span class="lineno">1660</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352758">return</span>&nbsp;<span class="builtintype" id="6352765">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6352770">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6352773">rs</span><span class="op" id="6352775">.</span><span class="ident" id="6352776">closed</span>&nbsp;<span class="op" id="6352783">=</span>&nbsp;<span class="builtintype" id="6352785">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6352791">err</span>&nbsp;<span class="op" id="6352795">:=</span>&nbsp;<span class="ident" id="6352798">rs</span><span class="op" id="6352800">.</span><span class="ident" id="6352801">rowsi</span><span class="op" id="6352806">.</span><span class="ident" id="6352807">Close</span><span class="op" id="6352812">(</span><span class="op" id="6352813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352816">if</span>&nbsp;<span class="ident" id="6352819">fn</span>&nbsp;<span class="op" id="6352822">:=</span>&nbsp;<span class="ident" id="6352825">rowsCloseHook</span><span class="op" id="6352838">;</span>&nbsp;<span class="ident" id="6352840">fn</span>&nbsp;<span class="op" id="6352843">!=</span>&nbsp;<span class="builtintype" id="6352846">nil</span>&nbsp;<span class="op" id="6352850">{</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6352854">fn</span><span class="op" id="6352856">(</span><span class="ident" id="6352857">rs</span><span class="op" id="6352859">,</span>&nbsp;<span class="op" id="6352861">&amp;</span><span class="ident" id="6352862">err</span><span class="op" id="6352865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6352868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352871">if</span>&nbsp;<span class="ident" id="6352874">rs</span><span class="op" id="6352876">.</span><span class="ident" id="6352877">closeStmt</span>&nbsp;<span class="op" id="6352887">!=</span>&nbsp;<span class="builtintype" id="6352890">nil</span>&nbsp;<span class="op" id="6352894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6352898">rs</span><span class="op" id="6352900">.</span><span class="ident" id="6352901">closeStmt</span><span class="op" id="6352910">.</span><span class="ident" id="6352911">Close</span><span class="op" id="6352916">(</span><span class="op" id="6352917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6352920">}</span><br>
<span class="lineno">1670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6352923">rs</span><span class="op" id="6352925">.</span><span class="ident" id="6352926">releaseConn</span><span class="op" id="6352937">(</span><span class="ident" id="6352938">err</span><span class="op" id="6352941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352944">return</span>&nbsp;<span class="ident" id="6352951">err</span><br>
<span class="lineno"></span><span class="op" id="6352955">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6352958">//&nbsp;Row&nbsp;is&nbsp;the&nbsp;result&nbsp;of&nbsp;calling&nbsp;QueryRow&nbsp;to&nbsp;select&nbsp;a&nbsp;single&nbsp;row.</span><br>
<span class="lineno">1675</span><span class="keyword" id="6353023">type</span>&nbsp;<span class="ident" id="6353028">Row</span>&nbsp;<span class="keyword" id="6353032">struct</span>&nbsp;<span class="op" id="6353039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6353042">//&nbsp;One&nbsp;of&nbsp;these&nbsp;two&nbsp;will&nbsp;be&nbsp;non-nil:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353080">err</span>&nbsp;&nbsp;<span class="builtintype" id="6353085">error</span>&nbsp;<span class="comment" id="6353091">//&nbsp;deferred&nbsp;error&nbsp;for&nbsp;easy&nbsp;chaining</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353128">rows</span>&nbsp;<span class="op" id="6353133">*</span><span class="ident" id="6353134">Rows</span><br>
<span class="lineno"></span><span class="op" id="6353139">}</span><br>
<span class="lineno">1680</span><br>
<span class="lineno"></span><span class="comment" id="6353142">//&nbsp;Scan&nbsp;copies&nbsp;the&nbsp;columns&nbsp;from&nbsp;the&nbsp;matched&nbsp;row&nbsp;into&nbsp;the&nbsp;values</span><br>
<span class="lineno"></span><span class="comment" id="6353206">//&nbsp;pointed&nbsp;at&nbsp;by&nbsp;dest.&nbsp;&nbsp;If&nbsp;more&nbsp;than&nbsp;one&nbsp;row&nbsp;matches&nbsp;the&nbsp;query,</span><br>
<span class="lineno"></span><span class="comment" id="6353270">//&nbsp;Scan&nbsp;uses&nbsp;the&nbsp;first&nbsp;row&nbsp;and&nbsp;discards&nbsp;the&nbsp;rest.&nbsp;&nbsp;If&nbsp;no&nbsp;row&nbsp;matches</span><br>
<span class="lineno"></span><span class="comment" id="6353339">//&nbsp;the&nbsp;query,&nbsp;Scan&nbsp;returns&nbsp;ErrNoRows.</span><br>
<span class="lineno">1685</span><span class="keyword" id="6353377">func</span>&nbsp;<span class="op" id="6353382">(</span><span class="ident" id="6353383">r</span>&nbsp;<span class="op" id="6353385">*</span><span class="ident" id="6353386">Row</span><span class="op" id="6353389">)</span>&nbsp;<span class="ident" id="6353391">Scan</span><span class="op" id="6353395">(</span><span class="ident" id="6353396">dest</span>&nbsp;<span class="op" id="6353401">...</span><span class="keyword" id="6353404">interface</span><span class="op" id="6353413">{</span><span class="op" id="6353414">}</span><span class="op" id="6353415">)</span>&nbsp;<span class="builtintype" id="6353417">error</span>&nbsp;<span class="op" id="6353423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6353426">if</span>&nbsp;<span class="ident" id="6353429">r</span><span class="op" id="6353430">.</span><span class="ident" id="6353431">err</span>&nbsp;<span class="op" id="6353435">!=</span>&nbsp;<span class="builtintype" id="6353438">nil</span>&nbsp;<span class="op" id="6353442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6353446">return</span>&nbsp;<span class="ident" id="6353453">r</span><span class="op" id="6353454">.</span><span class="ident" id="6353455">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6353460">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1690</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6353464">//&nbsp;TODO(bradfitz):&nbsp;for&nbsp;now&nbsp;we&nbsp;need&nbsp;to&nbsp;defensively&nbsp;clone&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6353525">//&nbsp;[]byte&nbsp;that&nbsp;the&nbsp;driver&nbsp;returned&nbsp;(not&nbsp;permitting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6353577">//&nbsp;*RawBytes&nbsp;in&nbsp;Rows.Scan),&nbsp;since&nbsp;we&#39;re&nbsp;about&nbsp;to&nbsp;close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6353633">//&nbsp;the&nbsp;Rows&nbsp;in&nbsp;our&nbsp;defer,&nbsp;when&nbsp;we&nbsp;return&nbsp;from&nbsp;this&nbsp;function.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6353695">//&nbsp;the&nbsp;contract&nbsp;with&nbsp;the&nbsp;driver.Next(...)&nbsp;interface&nbsp;is&nbsp;that&nbsp;it</span><br>
<span class="lineno">1695</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6353759">//&nbsp;can&nbsp;return&nbsp;slices&nbsp;into&nbsp;read-only&nbsp;temporary&nbsp;memory&nbsp;that&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6353820">//&nbsp;only&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;Scan/Close.&nbsp;&nbsp;But&nbsp;the&nbsp;TODO&nbsp;is&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6353884">//&nbsp;for&nbsp;a&nbsp;lot&nbsp;of&nbsp;drivers,&nbsp;this&nbsp;copy&nbsp;will&nbsp;be&nbsp;unnecessary.&nbsp;&nbsp;We</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6353945">//&nbsp;should&nbsp;provide&nbsp;an&nbsp;optional&nbsp;interface&nbsp;for&nbsp;drivers&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6354001">//&nbsp;implement&nbsp;to&nbsp;say,&nbsp;&#34;don&#39;t&nbsp;worry,&nbsp;the&nbsp;[]bytes&nbsp;that&nbsp;I&nbsp;return</span><br>
<span class="lineno">1700</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6354063">//&nbsp;from&nbsp;Next&nbsp;will&nbsp;not&nbsp;be&nbsp;modified&nbsp;again.&#34;&nbsp;(for&nbsp;instance,&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6354124">//&nbsp;they&nbsp;were&nbsp;obtained&nbsp;from&nbsp;the&nbsp;network&nbsp;anyway)&nbsp;But&nbsp;for&nbsp;now&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6354187">//&nbsp;don&#39;t&nbsp;care.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6354203">defer</span>&nbsp;<span class="ident" id="6354209">r</span><span class="op" id="6354210">.</span><span class="ident" id="6354211">rows</span><span class="op" id="6354215">.</span><span class="ident" id="6354216">Close</span><span class="op" id="6354221">(</span><span class="op" id="6354222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6354225">for</span>&nbsp;<span class="ident" id="6354229">_</span><span class="op" id="6354230">,</span>&nbsp;<span class="ident" id="6354232">dp</span>&nbsp;<span class="op" id="6354235">:=</span>&nbsp;<span class="keyword" id="6354238">range</span>&nbsp;<span class="ident" id="6354244">dest</span>&nbsp;<span class="op" id="6354249">{</span><br>
<span class="lineno">1705</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6354253">if</span>&nbsp;<span class="ident" id="6354256">_</span><span class="op" id="6354257">,</span>&nbsp;<span class="ident" id="6354259">ok</span>&nbsp;<span class="op" id="6354262">:=</span>&nbsp;<span class="ident" id="6354265">dp</span><span class="op" id="6354267">.</span><span class="op" id="6354268">(</span><span class="op" id="6354269">*</span><span class="ident" id="6354270">RawBytes</span><span class="op" id="6354278">)</span><span class="op" id="6354279">;</span>&nbsp;<span class="ident" id="6354281">ok</span>&nbsp;<span class="op" id="6354284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6354289">return</span>&nbsp;<span class="ident" id="6354296">errors</span><span class="op" id="6354302">.</span><span class="ident" id="6354303">New</span><span class="op" id="6354306">(</span><span class="string" id="6354307">&#34;sql:&nbsp;RawBytes&nbsp;isn&#39;t&nbsp;allowed&nbsp;on&nbsp;Row.Scan&#34;</span><span class="op" id="6354348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6354352">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6354355">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6354359">if</span>&nbsp;<span class="op" id="6354362">!</span><span class="ident" id="6354363">r</span><span class="op" id="6354364">.</span><span class="ident" id="6354365">rows</span><span class="op" id="6354369">.</span><span class="ident" id="6354370">Next</span><span class="op" id="6354374">(</span><span class="op" id="6354375">)</span>&nbsp;<span class="op" id="6354377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6354381">if</span>&nbsp;<span class="ident" id="6354384">err</span>&nbsp;<span class="op" id="6354388">:=</span>&nbsp;<span class="ident" id="6354391">r</span><span class="op" id="6354392">.</span><span class="ident" id="6354393">rows</span><span class="op" id="6354397">.</span><span class="ident" id="6354398">Err</span><span class="op" id="6354401">(</span><span class="op" id="6354402">)</span><span class="op" id="6354403">;</span>&nbsp;<span class="ident" id="6354405">err</span>&nbsp;<span class="op" id="6354409">!=</span>&nbsp;<span class="builtintype" id="6354412">nil</span>&nbsp;<span class="op" id="6354416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6354421">return</span>&nbsp;<span class="ident" id="6354428">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6354434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6354438">return</span>&nbsp;<span class="ident" id="6354445">ErrNoRows</span><br>
<span class="lineno">1715</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6354456">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6354459">err</span>&nbsp;<span class="op" id="6354463">:=</span>&nbsp;<span class="ident" id="6354466">r</span><span class="op" id="6354467">.</span><span class="ident" id="6354468">rows</span><span class="op" id="6354472">.</span><span class="ident" id="6354473">Scan</span><span class="op" id="6354477">(</span><span class="ident" id="6354478">dest</span><span class="op" id="6354482">...</span><span class="op" id="6354485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6354488">if</span>&nbsp;<span class="ident" id="6354491">err</span>&nbsp;<span class="op" id="6354495">!=</span>&nbsp;<span class="builtintype" id="6354498">nil</span>&nbsp;<span class="op" id="6354502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6354506">return</span>&nbsp;<span class="ident" id="6354513">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6354518">}</span><br>
<span class="lineno">1720</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6354521">//&nbsp;Make&nbsp;sure&nbsp;the&nbsp;query&nbsp;can&nbsp;be&nbsp;processed&nbsp;to&nbsp;completion&nbsp;with&nbsp;no&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6354592">if</span>&nbsp;<span class="ident" id="6354595">err</span>&nbsp;<span class="op" id="6354599">:=</span>&nbsp;<span class="ident" id="6354602">r</span><span class="op" id="6354603">.</span><span class="ident" id="6354604">rows</span><span class="op" id="6354608">.</span><span class="ident" id="6354609">Close</span><span class="op" id="6354614">(</span><span class="op" id="6354615">)</span><span class="op" id="6354616">;</span>&nbsp;<span class="ident" id="6354618">err</span>&nbsp;<span class="op" id="6354622">!=</span>&nbsp;<span class="builtintype" id="6354625">nil</span>&nbsp;<span class="op" id="6354629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6354633">return</span>&nbsp;<span class="ident" id="6354640">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6354645">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6354649">return</span>&nbsp;<span class="builtintype" id="6354656">nil</span><br>
<span class="lineno"></span><span class="op" id="6354660">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6354663">//&nbsp;A&nbsp;Result&nbsp;summarizes&nbsp;an&nbsp;executed&nbsp;SQL&nbsp;command.</span><br>
<span class="lineno"></span><span class="keyword" id="6354711">type</span>&nbsp;<span class="ident" id="6354716">Result</span>&nbsp;<span class="keyword" id="6354723">interface</span>&nbsp;<span class="op" id="6354733">{</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6354736">//&nbsp;LastInsertId&nbsp;returns&nbsp;the&nbsp;integer&nbsp;generated&nbsp;by&nbsp;the&nbsp;database</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6354799">//&nbsp;in&nbsp;response&nbsp;to&nbsp;a&nbsp;command.&nbsp;Typically&nbsp;this&nbsp;will&nbsp;be&nbsp;from&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6354860">//&nbsp;&#34;auto&nbsp;increment&#34;&nbsp;column&nbsp;when&nbsp;inserting&nbsp;a&nbsp;new&nbsp;row.&nbsp;Not&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6354922">//&nbsp;databases&nbsp;support&nbsp;this&nbsp;feature,&nbsp;and&nbsp;the&nbsp;syntax&nbsp;of&nbsp;such</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6354981">//&nbsp;statements&nbsp;varies.</span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6355004">LastInsertId</span><span class="op" id="6355016">(</span><span class="op" id="6355017">)</span>&nbsp;<span class="op" id="6355019">(</span><span class="builtintype" id="6355020">int64</span><span class="op" id="6355025">,</span>&nbsp;<span class="builtintype" id="6355027">error</span><span class="op" id="6355032">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6355036">//&nbsp;RowsAffected&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;rows&nbsp;affected&nbsp;by&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6355095">//&nbsp;update,&nbsp;insert,&nbsp;or&nbsp;delete.&nbsp;Not&nbsp;every&nbsp;database&nbsp;or&nbsp;database</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6355157">//&nbsp;driver&nbsp;may&nbsp;support&nbsp;this.</span><br>
<span class="lineno">1740</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6355186">RowsAffected</span><span class="op" id="6355198">(</span><span class="op" id="6355199">)</span>&nbsp;<span class="op" id="6355201">(</span><span class="builtintype" id="6355202">int64</span><span class="op" id="6355207">,</span>&nbsp;<span class="builtintype" id="6355209">error</span><span class="op" id="6355214">)</span><br>
<span class="lineno"></span><span class="op" id="6355216">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6355219">type</span>&nbsp;<span class="ident" id="6355224">driverResult</span>&nbsp;<span class="keyword" id="6355237">struct</span>&nbsp;<span class="op" id="6355244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6355247">sync</span><span class="op" id="6355251">.</span><span class="ident" id="6355252">Locker</span>&nbsp;<span class="comment" id="6355259">//&nbsp;the&nbsp;*driverConn</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6355279">resi</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6355291">driver</span><span class="op" id="6355297">.</span><span class="ident" id="6355298">Result</span><br>
<span class="lineno"></span><span class="op" id="6355305">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6355308">func</span>&nbsp;<span class="op" id="6355313">(</span><span class="ident" id="6355314">dr</span>&nbsp;<span class="ident" id="6355317">driverResult</span><span class="op" id="6355329">)</span>&nbsp;<span class="ident" id="6355331">LastInsertId</span><span class="op" id="6355343">(</span><span class="op" id="6355344">)</span>&nbsp;<span class="op" id="6355346">(</span><span class="builtintype" id="6355347">int64</span><span class="op" id="6355352">,</span>&nbsp;<span class="builtintype" id="6355354">error</span><span class="op" id="6355359">)</span>&nbsp;<span class="op" id="6355361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6355364">dr</span><span class="op" id="6355366">.</span><span class="ident" id="6355367">Lock</span><span class="op" id="6355371">(</span><span class="op" id="6355372">)</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6355375">defer</span>&nbsp;<span class="ident" id="6355381">dr</span><span class="op" id="6355383">.</span><span class="ident" id="6355384">Unlock</span><span class="op" id="6355390">(</span><span class="op" id="6355391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6355394">return</span>&nbsp;<span class="ident" id="6355401">dr</span><span class="op" id="6355403">.</span><span class="ident" id="6355404">resi</span><span class="op" id="6355408">.</span><span class="ident" id="6355409">LastInsertId</span><span class="op" id="6355421">(</span><span class="op" id="6355422">)</span><br>
<span class="lineno"></span><span class="op" id="6355424">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6355427">func</span>&nbsp;<span class="op" id="6355432">(</span><span class="ident" id="6355433">dr</span>&nbsp;<span class="ident" id="6355436">driverResult</span><span class="op" id="6355448">)</span>&nbsp;<span class="ident" id="6355450">RowsAffected</span><span class="op" id="6355462">(</span><span class="op" id="6355463">)</span>&nbsp;<span class="op" id="6355465">(</span><span class="builtintype" id="6355466">int64</span><span class="op" id="6355471">,</span>&nbsp;<span class="builtintype" id="6355473">error</span><span class="op" id="6355478">)</span>&nbsp;<span class="op" id="6355480">{</span><br>
<span class="lineno">1755</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6355483">dr</span><span class="op" id="6355485">.</span><span class="ident" id="6355486">Lock</span><span class="op" id="6355490">(</span><span class="op" id="6355491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6355494">defer</span>&nbsp;<span class="ident" id="6355500">dr</span><span class="op" id="6355502">.</span><span class="ident" id="6355503">Unlock</span><span class="op" id="6355509">(</span><span class="op" id="6355510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6355513">return</span>&nbsp;<span class="ident" id="6355520">dr</span><span class="op" id="6355522">.</span><span class="ident" id="6355523">resi</span><span class="op" id="6355527">.</span><span class="ident" id="6355528">RowsAffected</span><span class="op" id="6355540">(</span><span class="op" id="6355541">)</span><br>
<span class="lineno"></span><span class="op" id="6355543">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1760</span><span class="keyword" id="6355546">func</span>&nbsp;<span class="ident" id="6355551">stack</span><span class="op" id="6355556">(</span><span class="op" id="6355557">)</span>&nbsp;<span class="builtintype" id="6355559">string</span>&nbsp;<span class="op" id="6355566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6355569">var</span>&nbsp;<span class="ident" id="6355573">buf</span>&nbsp;<span class="op" id="6355577">[</span><span class="num" id="6355578">2</span>&nbsp;<span class="op" id="6355580">&lt;&lt;</span>&nbsp;<span class="num" id="6355583">10</span><span class="op" id="6355585">]</span><span class="builtintype" id="6355586">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6355592">return</span>&nbsp;<span class="builtintype" id="6355599">string</span><span class="op" id="6355605">(</span><span class="ident" id="6355606">buf</span><span class="op" id="6355609">[</span><span class="op" id="6355610">:</span><span class="ident" id="6355611">runtime</span><span class="op" id="6355618">.</span><span class="ident" id="6355619">Stack</span><span class="op" id="6355624">(</span><span class="ident" id="6355625">buf</span><span class="op" id="6355628">[</span><span class="op" id="6355629">:</span><span class="op" id="6355630">]</span><span class="op" id="6355631">,</span>&nbsp;<span class="builtintype" id="6355633">false</span><span class="op" id="6355638">)</span><span class="op" id="6355639">]</span><span class="op" id="6355640">)</span><br>
<span class="lineno"></span><span class="op" id="6355642">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1765</span><span class="comment" id="6355645">//&nbsp;withLock&nbsp;runs&nbsp;while&nbsp;holding&nbsp;lk.</span><br>
<span class="lineno"></span><span class="keyword" id="6355680">func</span>&nbsp;<span class="ident" id="6355685">withLock</span><span class="op" id="6355693">(</span><span class="ident" id="6355694">lk</span>&nbsp;<span class="ident" id="6355697">sync</span><span class="op" id="6355701">.</span><span class="ident" id="6355702">Locker</span><span class="op" id="6355708">,</span>&nbsp;<span class="ident" id="6355710">fn</span>&nbsp;<span class="keyword" id="6355713">func</span><span class="op" id="6355717">(</span><span class="op" id="6355718">)</span><span class="op" id="6355719">)</span>&nbsp;<span class="op" id="6355721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6355724">lk</span><span class="op" id="6355726">.</span><span class="ident" id="6355727">Lock</span><span class="op" id="6355731">(</span><span class="op" id="6355732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6355735">fn</span><span class="op" id="6355737">(</span><span class="op" id="6355738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6355741">lk</span><span class="op" id="6355743">.</span><span class="ident" id="6355744">Unlock</span><span class="op" id="6355750">(</span><span class="op" id="6355751">)</span><br>
<span class="lineno">1770</span><span class="op" id="6355753">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
