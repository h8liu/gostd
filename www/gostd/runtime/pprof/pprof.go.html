<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime/pprof</h2>
<ul>
<li><a href="/gostd/runtime/pprof/mprof_test.go.html">mprof_test.go</a></li>
<li><a href="/gostd/runtime/pprof/pprof.go.html">pprof.go</a></li>
<li><a href="/gostd/runtime/pprof/pprof_test.go.html">pprof_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4617500">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4617556">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4617610">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4617661">//&nbsp;Package&nbsp;pprof&nbsp;writes&nbsp;runtime&nbsp;profiling&nbsp;data&nbsp;in&nbsp;the&nbsp;format&nbsp;expected</span><br>
<span class="lineno"></span><span class="comment" id="4617731">//&nbsp;by&nbsp;the&nbsp;pprof&nbsp;visualization&nbsp;tool.</span><br>
<span class="lineno"></span><span class="comment" id="4617767">//&nbsp;For&nbsp;more&nbsp;information&nbsp;about&nbsp;pprof,&nbsp;see</span><br>
<span class="lineno"></span><span class="comment" id="4617808">//&nbsp;http://code.google.com/p/google-perftools/.</span><br>
<span class="lineno"></span><span class="keyword" id="4617855">package</span>&nbsp;<span class="ident" id="4617863">pprof</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="4617870">import</span>&nbsp;<span class="op" id="4617877">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4617880">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4617889">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4617898">&#34;fmt&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4617905">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4617911">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4617922">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4617930">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4617941">&#34;sync&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4617949">&#34;text/tabwriter&#34;</span><br>
<span class="lineno"></span><span class="op" id="4617966">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4617969">//&nbsp;BUG(rsc):&nbsp;Profiles&nbsp;are&nbsp;incomplete&nbsp;and&nbsp;inaccurate&nbsp;on&nbsp;NetBSD&nbsp;and&nbsp;OS&nbsp;X.</span><br>
<span class="lineno"></span><span class="comment" id="4618041">//&nbsp;See&nbsp;http://golang.org/issue/6047&nbsp;for&nbsp;details.</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="comment" id="4618091">//&nbsp;A&nbsp;Profile&nbsp;is&nbsp;a&nbsp;collection&nbsp;of&nbsp;stack&nbsp;traces&nbsp;showing&nbsp;the&nbsp;call&nbsp;sequences</span><br>
<span class="lineno"></span><span class="comment" id="4618163">//&nbsp;that&nbsp;led&nbsp;to&nbsp;instances&nbsp;of&nbsp;a&nbsp;particular&nbsp;event,&nbsp;such&nbsp;as&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="comment" id="4618231">//&nbsp;Packages&nbsp;can&nbsp;create&nbsp;and&nbsp;maintain&nbsp;their&nbsp;own&nbsp;profiles;&nbsp;the&nbsp;most&nbsp;common</span><br>
<span class="lineno"></span><span class="comment" id="4618303">//&nbsp;use&nbsp;is&nbsp;for&nbsp;tracking&nbsp;resources&nbsp;that&nbsp;must&nbsp;be&nbsp;explicitly&nbsp;closed,&nbsp;such&nbsp;as&nbsp;files</span><br>
<span class="lineno">30</span><span class="comment" id="4618382">//&nbsp;or&nbsp;network&nbsp;connections.</span><br>
<span class="lineno"></span><span class="comment" id="4618409">//</span><br>
<span class="lineno"></span><span class="comment" id="4618412">//&nbsp;A&nbsp;Profile&#39;s&nbsp;methods&nbsp;can&nbsp;be&nbsp;called&nbsp;from&nbsp;multiple&nbsp;goroutines&nbsp;simultaneously.</span><br>
<span class="lineno"></span><span class="comment" id="4618490">//</span><br>
<span class="lineno"></span><span class="comment" id="4618493">//&nbsp;Each&nbsp;Profile&nbsp;has&nbsp;a&nbsp;unique&nbsp;name.&nbsp;&nbsp;A&nbsp;few&nbsp;profiles&nbsp;are&nbsp;predefined:</span><br>
<span class="lineno">35</span><span class="comment" id="4618560">//</span><br>
<span class="lineno"></span><span class="comment" id="4618563">//&nbsp;&nbsp;&nbsp;&nbspgoroutine&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;stack&nbsp;traces&nbsp;of&nbsp;all&nbsp;current&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="4618620">//&nbsp;&nbsp;&nbsp;&nbspheap&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;a&nbsp;sampling&nbsp;of&nbsp;all&nbsp;heap&nbsp;allocations</span><br>
<span class="lineno"></span><span class="comment" id="4618673">//&nbsp;&nbsp;&nbsp;&nbspthreadcreate&nbsp;-&nbsp;stack&nbsp;traces&nbsp;that&nbsp;led&nbsp;to&nbsp;the&nbsp;creation&nbsp;of&nbsp;new&nbsp;OS&nbsp;threads</span><br>
<span class="lineno"></span><span class="comment" id="4618747">//&nbsp;&nbsp;&nbsp;&nbspblock&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;stack&nbsp;traces&nbsp;that&nbsp;led&nbsp;to&nbsp;blocking&nbsp;on&nbsp;synchronization&nbsp;primitives</span><br>
<span class="lineno">40</span><span class="comment" id="4618829">//</span><br>
<span class="lineno"></span><span class="comment" id="4618832">//&nbsp;These&nbsp;predefined&nbsp;profiles&nbsp;maintain&nbsp;themselves&nbsp;and&nbsp;panic&nbsp;on&nbsp;an&nbsp;explicit</span><br>
<span class="lineno"></span><span class="comment" id="4618906">//&nbsp;Add&nbsp;or&nbsp;Remove&nbsp;method&nbsp;call.</span><br>
<span class="lineno"></span><span class="comment" id="4618936">//</span><br>
<span class="lineno"></span><span class="comment" id="4618939">//&nbsp;The&nbsp;CPU&nbsp;profile&nbsp;is&nbsp;not&nbsp;available&nbsp;as&nbsp;a&nbsp;Profile.&nbsp;&nbsp;It&nbsp;has&nbsp;a&nbsp;special&nbsp;API,</span><br>
<span class="lineno">45</span><span class="comment" id="4619012">//&nbsp;the&nbsp;StartCPUProfile&nbsp;and&nbsp;StopCPUProfile&nbsp;functions,&nbsp;because&nbsp;it&nbsp;streams</span><br>
<span class="lineno"></span><span class="comment" id="4619084">//&nbsp;output&nbsp;to&nbsp;a&nbsp;writer&nbsp;during&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="4619124">//</span><br>
<span class="lineno"></span><span class="keyword" id="4619127">type</span>&nbsp;<span class="ident" id="4619132">Profile</span>&nbsp;<span class="keyword" id="4619140">struct</span>&nbsp;<span class="op" id="4619147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4619150">name</span>&nbsp;&nbsp;<span class="builtintype" id="4619156">string</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4619164">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4619170">sync</span><span class="op" id="4619174">.</span><span class="ident" id="4619175">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4619182">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4619188">map</span><span class="op" id="4619191">[</span><span class="keyword" id="4619192">interface</span><span class="op" id="4619201">{</span><span class="op" id="4619202">}</span><span class="op" id="4619203">]</span><span class="op" id="4619204">[</span><span class="op" id="4619205">]</span><span class="builtintype" id="4619206">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4619215">count</span>&nbsp;<span class="keyword" id="4619221">func</span><span class="op" id="4619225">(</span><span class="op" id="4619226">)</span>&nbsp;<span class="builtintype" id="4619228">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4619233">write</span>&nbsp;<span class="keyword" id="4619239">func</span><span class="op" id="4619243">(</span><span class="ident" id="4619244">io</span><span class="op" id="4619246">.</span><span class="ident" id="4619247">Writer</span><span class="op" id="4619253">,</span>&nbsp;<span class="builtintype" id="4619255">int</span><span class="op" id="4619258">)</span>&nbsp;<span class="builtintype" id="4619260">error</span><br>
<span class="lineno"></span><span class="op" id="4619266">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="comment" id="4619269">//&nbsp;profiles&nbsp;records&nbsp;all&nbsp;registered&nbsp;profiles.</span><br>
<span class="lineno"></span><span class="keyword" id="4619314">var</span>&nbsp;<span class="ident" id="4619318">profiles</span>&nbsp;<span class="keyword" id="4619327">struct</span>&nbsp;<span class="op" id="4619334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4619337">mu</span>&nbsp;<span class="ident" id="4619340">sync</span><span class="op" id="4619344">.</span><span class="ident" id="4619345">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4619352">m</span>&nbsp;&nbsp;<span class="keyword" id="4619355">map</span><span class="op" id="4619358">[</span><span class="builtintype" id="4619359">string</span><span class="op" id="4619365">]</span><span class="op" id="4619366">*</span><span class="ident" id="4619367">Profile</span><br>
<span class="lineno">60</span><span class="op" id="4619375">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4619378">var</span>&nbsp;<span class="ident" id="4619382">goroutineProfile</span>&nbsp;<span class="op" id="4619399">=</span>&nbsp;<span class="op" id="4619401">&amp;</span><span class="ident" id="4619402">Profile</span><span class="op" id="4619409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4619412">name</span><span class="op" id="4619416">:</span>&nbsp;&nbsp;<span class="string" id="4619419">&#34;goroutine&#34;</span><span class="op" id="4619430">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4619433">count</span><span class="op" id="4619438">:</span>&nbsp;<span class="ident" id="4619440">countGoroutine</span><span class="op" id="4619454">,</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4619457">write</span><span class="op" id="4619462">:</span>&nbsp;<span class="ident" id="4619464">writeGoroutine</span><span class="op" id="4619478">,</span><br>
<span class="lineno"></span><span class="op" id="4619480">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4619483">var</span>&nbsp;<span class="ident" id="4619487">threadcreateProfile</span>&nbsp;<span class="op" id="4619507">=</span>&nbsp;<span class="op" id="4619509">&amp;</span><span class="ident" id="4619510">Profile</span><span class="op" id="4619517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4619520">name</span><span class="op" id="4619524">:</span>&nbsp;&nbsp;<span class="string" id="4619527">&#34;threadcreate&#34;</span><span class="op" id="4619541">,</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4619544">count</span><span class="op" id="4619549">:</span>&nbsp;<span class="ident" id="4619551">countThreadCreate</span><span class="op" id="4619568">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4619571">write</span><span class="op" id="4619576">:</span>&nbsp;<span class="ident" id="4619578">writeThreadCreate</span><span class="op" id="4619595">,</span><br>
<span class="lineno"></span><span class="op" id="4619597">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4619600">var</span>&nbsp;<span class="ident" id="4619604">heapProfile</span>&nbsp;<span class="op" id="4619616">=</span>&nbsp;<span class="op" id="4619618">&amp;</span><span class="ident" id="4619619">Profile</span><span class="op" id="4619626">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4619629">name</span><span class="op" id="4619633">:</span>&nbsp;&nbsp;<span class="string" id="4619636">&#34;heap&#34;</span><span class="op" id="4619642">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4619645">count</span><span class="op" id="4619650">:</span>&nbsp;<span class="ident" id="4619652">countHeap</span><span class="op" id="4619661">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4619664">write</span><span class="op" id="4619669">:</span>&nbsp;<span class="ident" id="4619671">writeHeap</span><span class="op" id="4619680">,</span><br>
<span class="lineno"></span><span class="op" id="4619682">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="keyword" id="4619685">var</span>&nbsp;<span class="ident" id="4619689">blockProfile</span>&nbsp;<span class="op" id="4619702">=</span>&nbsp;<span class="op" id="4619704">&amp;</span><span class="ident" id="4619705">Profile</span><span class="op" id="4619712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4619715">name</span><span class="op" id="4619719">:</span>&nbsp;&nbsp;<span class="string" id="4619722">&#34;block&#34;</span><span class="op" id="4619729">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4619732">count</span><span class="op" id="4619737">:</span>&nbsp;<span class="ident" id="4619739">countBlock</span><span class="op" id="4619749">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4619752">write</span><span class="op" id="4619757">:</span>&nbsp;<span class="ident" id="4619759">writeBlock</span><span class="op" id="4619769">,</span><br>
<span class="lineno"></span><span class="op" id="4619771">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="keyword" id="4619774">func</span>&nbsp;<span class="ident" id="4619779">lockProfiles</span><span class="op" id="4619791">(</span><span class="op" id="4619792">)</span>&nbsp;<span class="op" id="4619794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4619797">profiles</span><span class="op" id="4619805">.</span><span class="ident" id="4619806">mu</span><span class="op" id="4619808">.</span><span class="ident" id="4619809">Lock</span><span class="op" id="4619813">(</span><span class="op" id="4619814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4619817">if</span>&nbsp;<span class="ident" id="4619820">profiles</span><span class="op" id="4619828">.</span><span class="ident" id="4619829">m</span>&nbsp;<span class="op" id="4619831">==</span>&nbsp;<span class="ident" id="4619834">nil</span>&nbsp;<span class="op" id="4619838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4619842">//&nbsp;Initial&nbsp;built-in&nbsp;profiles.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4619874">profiles</span><span class="op" id="4619882">.</span><span class="ident" id="4619883">m</span>&nbsp;<span class="op" id="4619885">=</span>&nbsp;<span class="keyword" id="4619887">map</span><span class="op" id="4619890">[</span><span class="builtintype" id="4619891">string</span><span class="op" id="4619897">]</span><span class="op" id="4619898">*</span><span class="ident" id="4619899">Profile</span><span class="op" id="4619906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4619911">&#34;goroutine&#34;</span><span class="op" id="4619922">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4619927">goroutineProfile</span><span class="op" id="4619943">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4619948">&#34;threadcreate&#34;</span><span class="op" id="4619962">:</span>&nbsp;<span class="ident" id="4619964">threadcreateProfile</span><span class="op" id="4619983">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4619988">&#34;heap&#34;</span><span class="op" id="4619994">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4620004">heapProfile</span><span class="op" id="4620015">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4620020">&#34;block&#34;</span><span class="op" id="4620027">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4620036">blockProfile</span><span class="op" id="4620048">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4620052">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4620055">}</span><br>
<span class="lineno"></span><span class="op" id="4620057">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4620060">func</span>&nbsp;<span class="ident" id="4620065">unlockProfiles</span><span class="op" id="4620079">(</span><span class="op" id="4620080">)</span>&nbsp;<span class="op" id="4620082">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4620085">profiles</span><span class="op" id="4620093">.</span><span class="ident" id="4620094">mu</span><span class="op" id="4620096">.</span><span class="ident" id="4620097">Unlock</span><span class="op" id="4620103">(</span><span class="op" id="4620104">)</span><br>
<span class="lineno"></span><span class="op" id="4620106">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4620109">//&nbsp;NewProfile&nbsp;creates&nbsp;a&nbsp;new&nbsp;profile&nbsp;with&nbsp;the&nbsp;given&nbsp;name.</span><br>
<span class="lineno"></span><span class="comment" id="4620166">//&nbsp;If&nbsp;a&nbsp;profile&nbsp;with&nbsp;that&nbsp;name&nbsp;already&nbsp;exists,&nbsp;NewProfile&nbsp;panics.</span><br>
<span class="lineno">105</span><span class="comment" id="4620232">//&nbsp;The&nbsp;convention&nbsp;is&nbsp;to&nbsp;use&nbsp;a&nbsp;&#39;import/path.&#39;&nbsp;prefix&nbsp;to&nbsp;create</span><br>
<span class="lineno"></span><span class="comment" id="4620294">//&nbsp;separate&nbsp;name&nbsp;spaces&nbsp;for&nbsp;each&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="4620336">func</span>&nbsp;<span class="ident" id="4620341">NewProfile</span><span class="op" id="4620351">(</span><span class="ident" id="4620352">name</span>&nbsp;<span class="builtintype" id="4620357">string</span><span class="op" id="4620363">)</span>&nbsp;<span class="op" id="4620365">*</span><span class="ident" id="4620366">Profile</span>&nbsp;<span class="op" id="4620374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4620377">lockProfiles</span><span class="op" id="4620389">(</span><span class="op" id="4620390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4620393">defer</span>&nbsp;<span class="ident" id="4620399">unlockProfiles</span><span class="op" id="4620413">(</span><span class="op" id="4620414">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4620417">if</span>&nbsp;<span class="ident" id="4620420">name</span>&nbsp;<span class="op" id="4620425">==</span>&nbsp;<span class="string" id="4620428">&#34;&#34;</span>&nbsp;<span class="op" id="4620431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4620435">panic</span><span class="op" id="4620440">(</span><span class="string" id="4620441">&#34;pprof:&nbsp;NewProfile&nbsp;with&nbsp;empty&nbsp;name&#34;</span><span class="op" id="4620476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4620479">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4620482">if</span>&nbsp;<span class="ident" id="4620485">profiles</span><span class="op" id="4620493">.</span><span class="ident" id="4620494">m</span><span class="op" id="4620495">[</span><span class="ident" id="4620496">name</span><span class="op" id="4620500">]</span>&nbsp;<span class="op" id="4620502">!=</span>&nbsp;<span class="ident" id="4620505">nil</span>&nbsp;<span class="op" id="4620509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4620513">panic</span><span class="op" id="4620518">(</span><span class="string" id="4620519">&#34;pprof:&nbsp;NewProfile&nbsp;name&nbsp;already&nbsp;in&nbsp;use:&nbsp;&#34;</span>&nbsp;<span class="op" id="4620561">+</span>&nbsp;<span class="ident" id="4620563">name</span><span class="op" id="4620567">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4620570">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4620573">p</span>&nbsp;<span class="op" id="4620575">:=</span>&nbsp;<span class="op" id="4620578">&amp;</span><span class="ident" id="4620579">Profile</span><span class="op" id="4620586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4620590">name</span><span class="op" id="4620594">:</span>&nbsp;<span class="ident" id="4620596">name</span><span class="op" id="4620600">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4620604">m</span><span class="op" id="4620605">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4620610">map</span><span class="op" id="4620613">[</span><span class="keyword" id="4620614">interface</span><span class="op" id="4620623">{</span><span class="op" id="4620624">}</span><span class="op" id="4620625">]</span><span class="op" id="4620626">[</span><span class="op" id="4620627">]</span><span class="builtintype" id="4620628">uintptr</span><span class="op" id="4620635">{</span><span class="op" id="4620636">}</span><span class="op" id="4620637">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4620640">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4620643">profiles</span><span class="op" id="4620651">.</span><span class="ident" id="4620652">m</span><span class="op" id="4620653">[</span><span class="ident" id="4620654">name</span><span class="op" id="4620658">]</span>&nbsp;<span class="op" id="4620660">=</span>&nbsp;<span class="ident" id="4620662">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4620665">return</span>&nbsp;<span class="ident" id="4620672">p</span><br>
<span class="lineno"></span><span class="op" id="4620674">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4620677">//&nbsp;Lookup&nbsp;returns&nbsp;the&nbsp;profile&nbsp;with&nbsp;the&nbsp;given&nbsp;name,&nbsp;or&nbsp;nil&nbsp;if&nbsp;no&nbsp;such&nbsp;profile&nbsp;exists.</span><br>
<span class="lineno">125</span><span class="keyword" id="4620762">func</span>&nbsp;<span class="ident" id="4620767">Lookup</span><span class="op" id="4620773">(</span><span class="ident" id="4620774">name</span>&nbsp;<span class="builtintype" id="4620779">string</span><span class="op" id="4620785">)</span>&nbsp;<span class="op" id="4620787">*</span><span class="ident" id="4620788">Profile</span>&nbsp;<span class="op" id="4620796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4620799">lockProfiles</span><span class="op" id="4620811">(</span><span class="op" id="4620812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4620815">defer</span>&nbsp;<span class="ident" id="4620821">unlockProfiles</span><span class="op" id="4620835">(</span><span class="op" id="4620836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4620839">return</span>&nbsp;<span class="ident" id="4620846">profiles</span><span class="op" id="4620854">.</span><span class="ident" id="4620855">m</span><span class="op" id="4620856">[</span><span class="ident" id="4620857">name</span><span class="op" id="4620861">]</span><br>
<span class="lineno"></span><span class="op" id="4620863">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="comment" id="4620866">//&nbsp;Profiles&nbsp;returns&nbsp;a&nbsp;slice&nbsp;of&nbsp;all&nbsp;the&nbsp;known&nbsp;profiles,&nbsp;sorted&nbsp;by&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword" id="4620937">func</span>&nbsp;<span class="ident" id="4620942">Profiles</span><span class="op" id="4620950">(</span><span class="op" id="4620951">)</span>&nbsp;<span class="op" id="4620953">[</span><span class="op" id="4620954">]</span><span class="op" id="4620955">*</span><span class="ident" id="4620956">Profile</span>&nbsp;<span class="op" id="4620964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4620967">lockProfiles</span><span class="op" id="4620979">(</span><span class="op" id="4620980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4620983">defer</span>&nbsp;<span class="ident" id="4620989">unlockProfiles</span><span class="op" id="4621003">(</span><span class="op" id="4621004">)</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4621008">var</span>&nbsp;<span class="ident" id="4621012">all</span>&nbsp;<span class="op" id="4621016">[</span><span class="op" id="4621017">]</span><span class="op" id="4621018">*</span><span class="ident" id="4621019">Profile</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4621028">for</span>&nbsp;<span class="ident" id="4621032">_</span><span class="op" id="4621033">,</span>&nbsp;<span class="ident" id="4621035">p</span>&nbsp;<span class="op" id="4621037">:=</span>&nbsp;<span class="keyword" id="4621040">range</span>&nbsp;<span class="ident" id="4621046">profiles</span><span class="op" id="4621054">.</span><span class="ident" id="4621055">m</span>&nbsp;<span class="op" id="4621057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4621061">all</span>&nbsp;<span class="op" id="4621065">=</span>&nbsp;<span class="builtinfunc" id="4621067">append</span><span class="op" id="4621073">(</span><span class="ident" id="4621074">all</span><span class="op" id="4621077">,</span>&nbsp;<span class="ident" id="4621079">p</span><span class="op" id="4621080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4621083">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4621087">sort</span><span class="op" id="4621091">.</span><span class="ident" id="4621092">Sort</span><span class="op" id="4621096">(</span><span class="ident" id="4621097">byName</span><span class="op" id="4621103">(</span><span class="ident" id="4621104">all</span><span class="op" id="4621107">)</span><span class="op" id="4621108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4621111">return</span>&nbsp;<span class="ident" id="4621118">all</span><br>
<span class="lineno"></span><span class="op" id="4621122">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="4621125">type</span>&nbsp;<span class="ident" id="4621130">byName</span>&nbsp;<span class="op" id="4621137">[</span><span class="op" id="4621138">]</span><span class="op" id="4621139">*</span><span class="ident" id="4621140">Profile</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4621149">func</span>&nbsp;<span class="op" id="4621154">(</span><span class="ident" id="4621155">x</span>&nbsp;<span class="ident" id="4621157">byName</span><span class="op" id="4621163">)</span>&nbsp;<span class="ident" id="4621165">Len</span><span class="op" id="4621168">(</span><span class="op" id="4621169">)</span>&nbsp;<span class="builtintype" id="4621171">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4621185">{</span>&nbsp;<span class="keyword" id="4621187">return</span>&nbsp;<span class="builtinfunc" id="4621194">len</span><span class="op" id="4621197">(</span><span class="ident" id="4621198">x</span><span class="op" id="4621199">)</span>&nbsp;<span class="op" id="4621201">}</span><br>
<span class="lineno"></span><span class="keyword" id="4621203">func</span>&nbsp;<span class="op" id="4621208">(</span><span class="ident" id="4621209">x</span>&nbsp;<span class="ident" id="4621211">byName</span><span class="op" id="4621217">)</span>&nbsp;<span class="ident" id="4621219">Swap</span><span class="op" id="4621223">(</span><span class="ident" id="4621224">i</span><span class="op" id="4621225">,</span>&nbsp;<span class="ident" id="4621227">j</span>&nbsp;<span class="builtintype" id="4621229">int</span><span class="op" id="4621232">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4621239">{</span>&nbsp;<span class="ident" id="4621241">x</span><span class="op" id="4621242">[</span><span class="ident" id="4621243">i</span><span class="op" id="4621244">]</span><span class="op" id="4621245">,</span>&nbsp;<span class="ident" id="4621247">x</span><span class="op" id="4621248">[</span><span class="ident" id="4621249">j</span><span class="op" id="4621250">]</span>&nbsp;<span class="op" id="4621252">=</span>&nbsp;<span class="ident" id="4621254">x</span><span class="op" id="4621255">[</span><span class="ident" id="4621256">j</span><span class="op" id="4621257">]</span><span class="op" id="4621258">,</span>&nbsp;<span class="ident" id="4621260">x</span><span class="op" id="4621261">[</span><span class="ident" id="4621262">i</span><span class="op" id="4621263">]</span>&nbsp;<span class="op" id="4621265">}</span><br>
<span class="lineno"></span><span class="keyword" id="4621267">func</span>&nbsp;<span class="op" id="4621272">(</span><span class="ident" id="4621273">x</span>&nbsp;<span class="ident" id="4621275">byName</span><span class="op" id="4621281">)</span>&nbsp;<span class="ident" id="4621283">Less</span><span class="op" id="4621287">(</span><span class="ident" id="4621288">i</span><span class="op" id="4621289">,</span>&nbsp;<span class="ident" id="4621291">j</span>&nbsp;<span class="builtintype" id="4621293">int</span><span class="op" id="4621296">)</span>&nbsp;<span class="builtintype" id="4621298">bool</span>&nbsp;<span class="op" id="4621303">{</span>&nbsp;<span class="keyword" id="4621305">return</span>&nbsp;<span class="ident" id="4621312">x</span><span class="op" id="4621313">[</span><span class="ident" id="4621314">i</span><span class="op" id="4621315">]</span><span class="op" id="4621316">.</span><span class="ident" id="4621317">name</span>&nbsp;<span class="op" id="4621322">&lt;</span>&nbsp;<span class="ident" id="4621324">x</span><span class="op" id="4621325">[</span><span class="ident" id="4621326">j</span><span class="op" id="4621327">]</span><span class="op" id="4621328">.</span><span class="ident" id="4621329">name</span>&nbsp;<span class="op" id="4621334">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span><span class="comment" id="4621337">//&nbsp;Name&nbsp;returns&nbsp;this&nbsp;profile&#39;s&nbsp;name,&nbsp;which&nbsp;can&nbsp;be&nbsp;passed&nbsp;to&nbsp;Lookup&nbsp;to&nbsp;reobtain&nbsp;the&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="4621429">func</span>&nbsp;<span class="op" id="4621434">(</span><span class="ident" id="4621435">p</span>&nbsp;<span class="op" id="4621437">*</span><span class="ident" id="4621438">Profile</span><span class="op" id="4621445">)</span>&nbsp;<span class="ident" id="4621447">Name</span><span class="op" id="4621451">(</span><span class="op" id="4621452">)</span>&nbsp;<span class="builtintype" id="4621454">string</span>&nbsp;<span class="op" id="4621461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4621464">return</span>&nbsp;<span class="ident" id="4621471">p</span><span class="op" id="4621472">.</span><span class="ident" id="4621473">name</span><br>
<span class="lineno"></span><span class="op" id="4621478">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="4621481">//&nbsp;Count&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;execution&nbsp;stacks&nbsp;currently&nbsp;in&nbsp;the&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="4621555">func</span>&nbsp;<span class="op" id="4621560">(</span><span class="ident" id="4621561">p</span>&nbsp;<span class="op" id="4621563">*</span><span class="ident" id="4621564">Profile</span><span class="op" id="4621571">)</span>&nbsp;<span class="ident" id="4621573">Count</span><span class="op" id="4621578">(</span><span class="op" id="4621579">)</span>&nbsp;<span class="builtintype" id="4621581">int</span>&nbsp;<span class="op" id="4621585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4621588">p</span><span class="op" id="4621589">.</span><span class="ident" id="4621590">mu</span><span class="op" id="4621592">.</span><span class="ident" id="4621593">Lock</span><span class="op" id="4621597">(</span><span class="op" id="4621598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4621601">defer</span>&nbsp;<span class="ident" id="4621607">p</span><span class="op" id="4621608">.</span><span class="ident" id="4621609">mu</span><span class="op" id="4621611">.</span><span class="ident" id="4621612">Unlock</span><span class="op" id="4621618">(</span><span class="op" id="4621619">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4621622">if</span>&nbsp;<span class="ident" id="4621625">p</span><span class="op" id="4621626">.</span><span class="ident" id="4621627">count</span>&nbsp;<span class="op" id="4621633">!=</span>&nbsp;<span class="ident" id="4621636">nil</span>&nbsp;<span class="op" id="4621640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4621644">return</span>&nbsp;<span class="ident" id="4621651">p</span><span class="op" id="4621652">.</span><span class="ident" id="4621653">count</span><span class="op" id="4621658">(</span><span class="op" id="4621659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4621662">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4621665">return</span>&nbsp;<span class="builtinfunc" id="4621672">len</span><span class="op" id="4621675">(</span><span class="ident" id="4621676">p</span><span class="op" id="4621677">.</span><span class="ident" id="4621678">m</span><span class="op" id="4621679">)</span><br>
<span class="lineno"></span><span class="op" id="4621681">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="4621684">//&nbsp;Add&nbsp;adds&nbsp;the&nbsp;current&nbsp;execution&nbsp;stack&nbsp;to&nbsp;the&nbsp;profile,&nbsp;associated&nbsp;with&nbsp;value.</span><br>
<span class="lineno"></span><span class="comment" id="4621763">//&nbsp;Add&nbsp;stores&nbsp;value&nbsp;in&nbsp;an&nbsp;internal&nbsp;map,&nbsp;so&nbsp;value&nbsp;must&nbsp;be&nbsp;suitable&nbsp;for&nbsp;use&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="4621840">//&nbsp;a&nbsp;map&nbsp;key&nbsp;and&nbsp;will&nbsp;not&nbsp;be&nbsp;garbage&nbsp;collected&nbsp;until&nbsp;the&nbsp;corresponding</span><br>
<span class="lineno"></span><span class="comment" id="4621911">//&nbsp;call&nbsp;to&nbsp;Remove.&nbsp;&nbsp;Add&nbsp;panics&nbsp;if&nbsp;the&nbsp;profile&nbsp;already&nbsp;contains&nbsp;a&nbsp;stack&nbsp;for&nbsp;value.</span><br>
<span class="lineno">170</span><span class="comment" id="4621993">//</span><br>
<span class="lineno"></span><span class="comment" id="4621996">//&nbsp;The&nbsp;skip&nbsp;parameter&nbsp;has&nbsp;the&nbsp;same&nbsp;meaning&nbsp;as&nbsp;runtime.Caller&#39;s&nbsp;skip</span><br>
<span class="lineno"></span><span class="comment" id="4622064">//&nbsp;and&nbsp;controls&nbsp;where&nbsp;the&nbsp;stack&nbsp;trace&nbsp;begins.&nbsp;&nbsp;Passing&nbsp;skip=0&nbsp;begins&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4622137">//&nbsp;trace&nbsp;in&nbsp;the&nbsp;function&nbsp;calling&nbsp;Add.&nbsp;&nbsp;For&nbsp;example,&nbsp;given&nbsp;this</span><br>
<span class="lineno"></span><span class="comment" id="4622200">//&nbsp;execution&nbsp;stack:</span><br>
<span class="lineno">175</span><span class="comment" id="4622220">//</span><br>
<span class="lineno"></span><span class="comment" id="4622223">//&nbsp;&nbsp;&nbsp;&nbspAdd</span><br>
<span class="lineno"></span><span class="comment" id="4622230">//&nbsp;&nbsp;&nbsp;&nbspcalled&nbsp;from&nbsp;rpc.NewClient</span><br>
<span class="lineno"></span><span class="comment" id="4622259">//&nbsp;&nbsp;&nbsp;&nbspcalled&nbsp;from&nbsp;mypkg.Run</span><br>
<span class="lineno"></span><span class="comment" id="4622284">//&nbsp;&nbsp;&nbsp;&nbspcalled&nbsp;from&nbsp;main.main</span><br>
<span class="lineno">180</span><span class="comment" id="4622309">//</span><br>
<span class="lineno"></span><span class="comment" id="4622312">//&nbsp;Passing&nbsp;skip=0&nbsp;begins&nbsp;the&nbsp;stack&nbsp;trace&nbsp;at&nbsp;the&nbsp;call&nbsp;to&nbsp;Add&nbsp;inside&nbsp;rpc.NewClient.</span><br>
<span class="lineno"></span><span class="comment" id="4622394">//&nbsp;Passing&nbsp;skip=1&nbsp;begins&nbsp;the&nbsp;stack&nbsp;trace&nbsp;at&nbsp;the&nbsp;call&nbsp;to&nbsp;NewClient&nbsp;inside&nbsp;mypkg.Run.</span><br>
<span class="lineno"></span><span class="comment" id="4622478">//</span><br>
<span class="lineno"></span><span class="keyword" id="4622481">func</span>&nbsp;<span class="op" id="4622486">(</span><span class="ident" id="4622487">p</span>&nbsp;<span class="op" id="4622489">*</span><span class="ident" id="4622490">Profile</span><span class="op" id="4622497">)</span>&nbsp;<span class="ident" id="4622499">Add</span><span class="op" id="4622502">(</span><span class="ident" id="4622503">value</span>&nbsp;<span class="keyword" id="4622509">interface</span><span class="op" id="4622518">{</span><span class="op" id="4622519">}</span><span class="op" id="4622520">,</span>&nbsp;<span class="ident" id="4622522">skip</span>&nbsp;<span class="builtintype" id="4622527">int</span><span class="op" id="4622530">)</span>&nbsp;<span class="op" id="4622532">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4622535">if</span>&nbsp;<span class="ident" id="4622538">p</span><span class="op" id="4622539">.</span><span class="ident" id="4622540">name</span>&nbsp;<span class="op" id="4622545">==</span>&nbsp;<span class="string" id="4622548">&#34;&#34;</span>&nbsp;<span class="op" id="4622551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4622555">panic</span><span class="op" id="4622560">(</span><span class="string" id="4622561">&#34;pprof:&nbsp;use&nbsp;of&nbsp;uninitialized&nbsp;Profile&#34;</span><span class="op" id="4622598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4622601">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4622604">if</span>&nbsp;<span class="ident" id="4622607">p</span><span class="op" id="4622608">.</span><span class="ident" id="4622609">write</span>&nbsp;<span class="op" id="4622615">!=</span>&nbsp;<span class="ident" id="4622618">nil</span>&nbsp;<span class="op" id="4622622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4622626">panic</span><span class="op" id="4622631">(</span><span class="string" id="4622632">&#34;pprof:&nbsp;Add&nbsp;called&nbsp;on&nbsp;built-in&nbsp;Profile&nbsp;&#34;</span>&nbsp;<span class="op" id="4622673">+</span>&nbsp;<span class="ident" id="4622675">p</span><span class="op" id="4622676">.</span><span class="ident" id="4622677">name</span><span class="op" id="4622681">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4622684">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4622688">stk</span>&nbsp;<span class="op" id="4622692">:=</span>&nbsp;<span class="builtinfunc" id="4622695">make</span><span class="op" id="4622699">(</span><span class="op" id="4622700">[</span><span class="op" id="4622701">]</span><span class="builtintype" id="4622702">uintptr</span><span class="op" id="4622709">,</span>&nbsp;<span class="num" id="4622711">32</span><span class="op" id="4622713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4622716">n</span>&nbsp;<span class="op" id="4622718">:=</span>&nbsp;<span class="ident" id="4622721">runtime</span><span class="op" id="4622728">.</span><span class="ident" id="4622729">Callers</span><span class="op" id="4622736">(</span><span class="ident" id="4622737">skip</span><span class="op" id="4622741">+</span><span class="num" id="4622742">1</span><span class="op" id="4622743">,</span>&nbsp;<span class="ident" id="4622745">stk</span><span class="op" id="4622748">[</span><span class="op" id="4622749">:</span><span class="op" id="4622750">]</span><span class="op" id="4622751">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4622755">p</span><span class="op" id="4622756">.</span><span class="ident" id="4622757">mu</span><span class="op" id="4622759">.</span><span class="ident" id="4622760">Lock</span><span class="op" id="4622764">(</span><span class="op" id="4622765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4622768">defer</span>&nbsp;<span class="ident" id="4622774">p</span><span class="op" id="4622775">.</span><span class="ident" id="4622776">mu</span><span class="op" id="4622778">.</span><span class="ident" id="4622779">Unlock</span><span class="op" id="4622785">(</span><span class="op" id="4622786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4622789">if</span>&nbsp;<span class="ident" id="4622792">p</span><span class="op" id="4622793">.</span><span class="ident" id="4622794">m</span><span class="op" id="4622795">[</span><span class="ident" id="4622796">value</span><span class="op" id="4622801">]</span>&nbsp;<span class="op" id="4622803">!=</span>&nbsp;<span class="ident" id="4622806">nil</span>&nbsp;<span class="op" id="4622810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4622814">panic</span><span class="op" id="4622819">(</span><span class="string" id="4622820">&#34;pprof:&nbsp;Profile.Add&nbsp;of&nbsp;duplicate&nbsp;value&#34;</span><span class="op" id="4622859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4622862">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4622865">p</span><span class="op" id="4622866">.</span><span class="ident" id="4622867">m</span><span class="op" id="4622868">[</span><span class="ident" id="4622869">value</span><span class="op" id="4622874">]</span>&nbsp;<span class="op" id="4622876">=</span>&nbsp;<span class="ident" id="4622878">stk</span><span class="op" id="4622881">[</span><span class="op" id="4622882">:</span><span class="ident" id="4622883">n</span><span class="op" id="4622884">]</span><br>
<span class="lineno"></span><span class="op" id="4622886">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4622889">//&nbsp;Remove&nbsp;removes&nbsp;the&nbsp;execution&nbsp;stack&nbsp;associated&nbsp;with&nbsp;value&nbsp;from&nbsp;the&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="4622967">//&nbsp;It&nbsp;is&nbsp;a&nbsp;no-op&nbsp;if&nbsp;the&nbsp;value&nbsp;is&nbsp;not&nbsp;in&nbsp;the&nbsp;profile.</span><br>
<span class="lineno">205</span><span class="keyword" id="4623020">func</span>&nbsp;<span class="op" id="4623025">(</span><span class="ident" id="4623026">p</span>&nbsp;<span class="op" id="4623028">*</span><span class="ident" id="4623029">Profile</span><span class="op" id="4623036">)</span>&nbsp;<span class="ident" id="4623038">Remove</span><span class="op" id="4623044">(</span><span class="ident" id="4623045">value</span>&nbsp;<span class="keyword" id="4623051">interface</span><span class="op" id="4623060">{</span><span class="op" id="4623061">}</span><span class="op" id="4623062">)</span>&nbsp;<span class="op" id="4623064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4623067">p</span><span class="op" id="4623068">.</span><span class="ident" id="4623069">mu</span><span class="op" id="4623071">.</span><span class="ident" id="4623072">Lock</span><span class="op" id="4623076">(</span><span class="op" id="4623077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4623080">defer</span>&nbsp;<span class="ident" id="4623086">p</span><span class="op" id="4623087">.</span><span class="ident" id="4623088">mu</span><span class="op" id="4623090">.</span><span class="ident" id="4623091">Unlock</span><span class="op" id="4623097">(</span><span class="op" id="4623098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4623101">delete</span><span class="op" id="4623107">(</span><span class="ident" id="4623108">p</span><span class="op" id="4623109">.</span><span class="ident" id="4623110">m</span><span class="op" id="4623111">,</span>&nbsp;<span class="ident" id="4623113">value</span><span class="op" id="4623118">)</span><br>
<span class="lineno"></span><span class="op" id="4623120">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span><span class="comment" id="4623123">//&nbsp;WriteTo&nbsp;writes&nbsp;a&nbsp;pprof-formatted&nbsp;snapshot&nbsp;of&nbsp;the&nbsp;profile&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="comment" id="4623189">//&nbsp;If&nbsp;a&nbsp;write&nbsp;to&nbsp;w&nbsp;returns&nbsp;an&nbsp;error,&nbsp;WriteTo&nbsp;returns&nbsp;that&nbsp;error.</span><br>
<span class="lineno"></span><span class="comment" id="4623254">//&nbsp;Otherwise,&nbsp;WriteTo&nbsp;returns&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="4623289">//</span><br>
<span class="lineno">215</span><span class="comment" id="4623292">//&nbsp;The&nbsp;debug&nbsp;parameter&nbsp;enables&nbsp;additional&nbsp;output.</span><br>
<span class="lineno"></span><span class="comment" id="4623342">//&nbsp;Passing&nbsp;debug=0&nbsp;prints&nbsp;only&nbsp;the&nbsp;hexadecimal&nbsp;addresses&nbsp;that&nbsp;pprof&nbsp;needs.</span><br>
<span class="lineno"></span><span class="comment" id="4623417">//&nbsp;Passing&nbsp;debug=1&nbsp;adds&nbsp;comments&nbsp;translating&nbsp;addresses&nbsp;to&nbsp;function&nbsp;names</span><br>
<span class="lineno"></span><span class="comment" id="4623490">//&nbsp;and&nbsp;line&nbsp;numbers,&nbsp;so&nbsp;that&nbsp;a&nbsp;programmer&nbsp;can&nbsp;read&nbsp;the&nbsp;profile&nbsp;without&nbsp;tools.</span><br>
<span class="lineno"></span><span class="comment" id="4623568">//</span><br>
<span class="lineno">220</span><span class="comment" id="4623571">//&nbsp;The&nbsp;predefined&nbsp;profiles&nbsp;may&nbsp;assign&nbsp;meaning&nbsp;to&nbsp;other&nbsp;debug&nbsp;values;</span><br>
<span class="lineno"></span><span class="comment" id="4623640">//&nbsp;for&nbsp;example,&nbsp;when&nbsp;printing&nbsp;the&nbsp;&#34;goroutine&#34;&nbsp;profile,&nbsp;debug=2&nbsp;means&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4623712">//&nbsp;print&nbsp;the&nbsp;goroutine&nbsp;stacks&nbsp;in&nbsp;the&nbsp;same&nbsp;form&nbsp;that&nbsp;a&nbsp;Go&nbsp;program&nbsp;uses</span><br>
<span class="lineno"></span><span class="comment" id="4623782">//&nbsp;when&nbsp;dying&nbsp;due&nbsp;to&nbsp;an&nbsp;unrecovered&nbsp;panic.</span><br>
<span class="lineno"></span><span class="keyword" id="4623825">func</span>&nbsp;<span class="op" id="4623830">(</span><span class="ident" id="4623831">p</span>&nbsp;<span class="op" id="4623833">*</span><span class="ident" id="4623834">Profile</span><span class="op" id="4623841">)</span>&nbsp;<span class="ident" id="4623843">WriteTo</span><span class="op" id="4623850">(</span><span class="ident" id="4623851">w</span>&nbsp;<span class="ident" id="4623853">io</span><span class="op" id="4623855">.</span><span class="ident" id="4623856">Writer</span><span class="op" id="4623862">,</span>&nbsp;<span class="ident" id="4623864">debug</span>&nbsp;<span class="builtintype" id="4623870">int</span><span class="op" id="4623873">)</span>&nbsp;<span class="builtintype" id="4623875">error</span>&nbsp;<span class="op" id="4623881">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4623884">if</span>&nbsp;<span class="ident" id="4623887">p</span><span class="op" id="4623888">.</span><span class="ident" id="4623889">name</span>&nbsp;<span class="op" id="4623894">==</span>&nbsp;<span class="string" id="4623897">&#34;&#34;</span>&nbsp;<span class="op" id="4623900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4623904">panic</span><span class="op" id="4623909">(</span><span class="string" id="4623910">&#34;pprof:&nbsp;use&nbsp;of&nbsp;zero&nbsp;Profile&#34;</span><span class="op" id="4623938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4623941">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4623944">if</span>&nbsp;<span class="ident" id="4623947">p</span><span class="op" id="4623948">.</span><span class="ident" id="4623949">write</span>&nbsp;<span class="op" id="4623955">!=</span>&nbsp;<span class="ident" id="4623958">nil</span>&nbsp;<span class="op" id="4623962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4623966">return</span>&nbsp;<span class="ident" id="4623973">p</span><span class="op" id="4623974">.</span><span class="ident" id="4623975">write</span><span class="op" id="4623980">(</span><span class="ident" id="4623981">w</span><span class="op" id="4623982">,</span>&nbsp;<span class="ident" id="4623984">debug</span><span class="op" id="4623989">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4623992">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4623996">//&nbsp;Obtain&nbsp;consistent&nbsp;snapshot&nbsp;under&nbsp;lock;&nbsp;then&nbsp;process&nbsp;without&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4624066">var</span>&nbsp;<span class="ident" id="4624070">all</span>&nbsp;<span class="op" id="4624074">[</span><span class="op" id="4624075">]</span><span class="op" id="4624076">[</span><span class="op" id="4624077">]</span><span class="builtintype" id="4624078">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4624087">p</span><span class="op" id="4624088">.</span><span class="ident" id="4624089">mu</span><span class="op" id="4624091">.</span><span class="ident" id="4624092">Lock</span><span class="op" id="4624096">(</span><span class="op" id="4624097">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4624100">for</span>&nbsp;<span class="ident" id="4624104">_</span><span class="op" id="4624105">,</span>&nbsp;<span class="ident" id="4624107">stk</span>&nbsp;<span class="op" id="4624111">:=</span>&nbsp;<span class="keyword" id="4624114">range</span>&nbsp;<span class="ident" id="4624120">p</span><span class="op" id="4624121">.</span><span class="ident" id="4624122">m</span>&nbsp;<span class="op" id="4624124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4624128">all</span>&nbsp;<span class="op" id="4624132">=</span>&nbsp;<span class="builtinfunc" id="4624134">append</span><span class="op" id="4624140">(</span><span class="ident" id="4624141">all</span><span class="op" id="4624144">,</span>&nbsp;<span class="ident" id="4624146">stk</span><span class="op" id="4624149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4624152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4624155">p</span><span class="op" id="4624156">.</span><span class="ident" id="4624157">mu</span><span class="op" id="4624159">.</span><span class="ident" id="4624160">Unlock</span><span class="op" id="4624166">(</span><span class="op" id="4624167">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4624171">//&nbsp;Map&nbsp;order&nbsp;is&nbsp;non-deterministic;&nbsp;make&nbsp;output&nbsp;deterministic.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4624234">sort</span><span class="op" id="4624238">.</span><span class="ident" id="4624239">Sort</span><span class="op" id="4624243">(</span><span class="ident" id="4624244">stackProfile</span><span class="op" id="4624256">(</span><span class="ident" id="4624257">all</span><span class="op" id="4624260">)</span><span class="op" id="4624261">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4624265">return</span>&nbsp;<span class="ident" id="4624272">printCountProfile</span><span class="op" id="4624289">(</span><span class="ident" id="4624290">w</span><span class="op" id="4624291">,</span>&nbsp;<span class="ident" id="4624293">debug</span><span class="op" id="4624298">,</span>&nbsp;<span class="ident" id="4624300">p</span><span class="op" id="4624301">.</span><span class="ident" id="4624302">name</span><span class="op" id="4624306">,</span>&nbsp;<span class="ident" id="4624308">stackProfile</span><span class="op" id="4624320">(</span><span class="ident" id="4624321">all</span><span class="op" id="4624324">)</span><span class="op" id="4624325">)</span><br>
<span class="lineno"></span><span class="op" id="4624327">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span><span class="keyword" id="4624330">type</span>&nbsp;<span class="ident" id="4624335">stackProfile</span>&nbsp;<span class="op" id="4624348">[</span><span class="op" id="4624349">]</span><span class="op" id="4624350">[</span><span class="op" id="4624351">]</span><span class="builtintype" id="4624352">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4624361">func</span>&nbsp;<span class="op" id="4624366">(</span><span class="ident" id="4624367">x</span>&nbsp;<span class="ident" id="4624369">stackProfile</span><span class="op" id="4624381">)</span>&nbsp;<span class="ident" id="4624383">Len</span><span class="op" id="4624386">(</span><span class="op" id="4624387">)</span>&nbsp;<span class="builtintype" id="4624389">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4624406">{</span>&nbsp;<span class="keyword" id="4624408">return</span>&nbsp;<span class="builtinfunc" id="4624415">len</span><span class="op" id="4624418">(</span><span class="ident" id="4624419">x</span><span class="op" id="4624420">)</span>&nbsp;<span class="op" id="4624422">}</span><br>
<span class="lineno"></span><span class="keyword" id="4624424">func</span>&nbsp;<span class="op" id="4624429">(</span><span class="ident" id="4624430">x</span>&nbsp;<span class="ident" id="4624432">stackProfile</span><span class="op" id="4624444">)</span>&nbsp;<span class="ident" id="4624446">Stack</span><span class="op" id="4624451">(</span><span class="ident" id="4624452">i</span>&nbsp;<span class="builtintype" id="4624454">int</span><span class="op" id="4624457">)</span>&nbsp;<span class="op" id="4624459">[</span><span class="op" id="4624460">]</span><span class="builtintype" id="4624461">uintptr</span>&nbsp;<span class="op" id="4624469">{</span>&nbsp;<span class="keyword" id="4624471">return</span>&nbsp;<span class="ident" id="4624478">x</span><span class="op" id="4624479">[</span><span class="ident" id="4624480">i</span><span class="op" id="4624481">]</span>&nbsp;<span class="op" id="4624483">}</span><br>
<span class="lineno">250</span><span class="keyword" id="4624485">func</span>&nbsp;<span class="op" id="4624490">(</span><span class="ident" id="4624491">x</span>&nbsp;<span class="ident" id="4624493">stackProfile</span><span class="op" id="4624505">)</span>&nbsp;<span class="ident" id="4624507">Swap</span><span class="op" id="4624511">(</span><span class="ident" id="4624512">i</span><span class="op" id="4624513">,</span>&nbsp;<span class="ident" id="4624515">j</span>&nbsp;<span class="builtintype" id="4624517">int</span><span class="op" id="4624520">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4624530">{</span>&nbsp;<span class="ident" id="4624532">x</span><span class="op" id="4624533">[</span><span class="ident" id="4624534">i</span><span class="op" id="4624535">]</span><span class="op" id="4624536">,</span>&nbsp;<span class="ident" id="4624538">x</span><span class="op" id="4624539">[</span><span class="ident" id="4624540">j</span><span class="op" id="4624541">]</span>&nbsp;<span class="op" id="4624543">=</span>&nbsp;<span class="ident" id="4624545">x</span><span class="op" id="4624546">[</span><span class="ident" id="4624547">j</span><span class="op" id="4624548">]</span><span class="op" id="4624549">,</span>&nbsp;<span class="ident" id="4624551">x</span><span class="op" id="4624552">[</span><span class="ident" id="4624553">i</span><span class="op" id="4624554">]</span>&nbsp;<span class="op" id="4624556">}</span><br>
<span class="lineno"></span><span class="keyword" id="4624558">func</span>&nbsp;<span class="op" id="4624563">(</span><span class="ident" id="4624564">x</span>&nbsp;<span class="ident" id="4624566">stackProfile</span><span class="op" id="4624578">)</span>&nbsp;<span class="ident" id="4624580">Less</span><span class="op" id="4624584">(</span><span class="ident" id="4624585">i</span><span class="op" id="4624586">,</span>&nbsp;<span class="ident" id="4624588">j</span>&nbsp;<span class="builtintype" id="4624590">int</span><span class="op" id="4624593">)</span>&nbsp;<span class="builtintype" id="4624595">bool</span>&nbsp;<span class="op" id="4624600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4624603">t</span><span class="op" id="4624604">,</span>&nbsp;<span class="ident" id="4624606">u</span>&nbsp;<span class="op" id="4624608">:=</span>&nbsp;<span class="ident" id="4624611">x</span><span class="op" id="4624612">[</span><span class="ident" id="4624613">i</span><span class="op" id="4624614">]</span><span class="op" id="4624615">,</span>&nbsp;<span class="ident" id="4624617">x</span><span class="op" id="4624618">[</span><span class="ident" id="4624619">j</span><span class="op" id="4624620">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4624623">for</span>&nbsp;<span class="ident" id="4624627">k</span>&nbsp;<span class="op" id="4624629">:=</span>&nbsp;<span class="num" id="4624632">0</span><span class="op" id="4624633">;</span>&nbsp;<span class="ident" id="4624635">k</span>&nbsp;<span class="op" id="4624637">&lt;</span>&nbsp;<span class="builtinfunc" id="4624639">len</span><span class="op" id="4624642">(</span><span class="ident" id="4624643">t</span><span class="op" id="4624644">)</span>&nbsp;<span class="op" id="4624646">&amp;&amp;</span>&nbsp;<span class="ident" id="4624649">k</span>&nbsp;<span class="op" id="4624651">&lt;</span>&nbsp;<span class="builtinfunc" id="4624653">len</span><span class="op" id="4624656">(</span><span class="ident" id="4624657">u</span><span class="op" id="4624658">)</span><span class="op" id="4624659">;</span>&nbsp;<span class="ident" id="4624661">k</span><span class="op" id="4624662">++</span>&nbsp;<span class="op" id="4624665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4624669">if</span>&nbsp;<span class="ident" id="4624672">t</span><span class="op" id="4624673">[</span><span class="ident" id="4624674">k</span><span class="op" id="4624675">]</span>&nbsp;<span class="op" id="4624677">!=</span>&nbsp;<span class="ident" id="4624680">u</span><span class="op" id="4624681">[</span><span class="ident" id="4624682">k</span><span class="op" id="4624683">]</span>&nbsp;<span class="op" id="4624685">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4624690">return</span>&nbsp;<span class="ident" id="4624697">t</span><span class="op" id="4624698">[</span><span class="ident" id="4624699">k</span><span class="op" id="4624700">]</span>&nbsp;<span class="op" id="4624702">&lt;</span>&nbsp;<span class="ident" id="4624704">u</span><span class="op" id="4624705">[</span><span class="ident" id="4624706">k</span><span class="op" id="4624707">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4624711">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4624714">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4624717">return</span>&nbsp;<span class="builtinfunc" id="4624724">len</span><span class="op" id="4624727">(</span><span class="ident" id="4624728">t</span><span class="op" id="4624729">)</span>&nbsp;<span class="op" id="4624731">&lt;</span>&nbsp;<span class="builtinfunc" id="4624733">len</span><span class="op" id="4624736">(</span><span class="ident" id="4624737">u</span><span class="op" id="4624738">)</span><br>
<span class="lineno"></span><span class="op" id="4624740">}</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="4624743">//&nbsp;A&nbsp;countProfile&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;stack&nbsp;traces&nbsp;to&nbsp;be&nbsp;printed&nbsp;as&nbsp;counts</span><br>
<span class="lineno"></span><span class="comment" id="4624810">//&nbsp;grouped&nbsp;by&nbsp;stack&nbsp;trace.&nbsp;&nbsp;There&nbsp;are&nbsp;multiple&nbsp;implementations:</span><br>
<span class="lineno"></span><span class="comment" id="4624874">//&nbsp;all&nbsp;that&nbsp;matters&nbsp;is&nbsp;that&nbsp;we&nbsp;can&nbsp;find&nbsp;out&nbsp;how&nbsp;many&nbsp;traces&nbsp;there&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="4624944">//&nbsp;and&nbsp;obtain&nbsp;each&nbsp;trace&nbsp;in&nbsp;turn.</span><br>
<span class="lineno">265</span><span class="keyword" id="4624978">type</span>&nbsp;<span class="ident" id="4624983">countProfile</span>&nbsp;<span class="keyword" id="4624996">interface</span>&nbsp;<span class="op" id="4625006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4625009">Len</span><span class="op" id="4625012">(</span><span class="op" id="4625013">)</span>&nbsp;<span class="builtintype" id="4625015">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4625020">Stack</span><span class="op" id="4625025">(</span><span class="ident" id="4625026">i</span>&nbsp;<span class="builtintype" id="4625028">int</span><span class="op" id="4625031">)</span>&nbsp;<span class="op" id="4625033">[</span><span class="op" id="4625034">]</span><span class="builtintype" id="4625035">uintptr</span><br>
<span class="lineno"></span><span class="op" id="4625043">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="comment" id="4625046">//&nbsp;printCountProfile&nbsp;prints&nbsp;a&nbsp;countProfile&nbsp;at&nbsp;the&nbsp;specified&nbsp;debug&nbsp;level.</span><br>
<span class="lineno"></span><span class="keyword" id="4625119">func</span>&nbsp;<span class="ident" id="4625124">printCountProfile</span><span class="op" id="4625141">(</span><span class="ident" id="4625142">w</span>&nbsp;<span class="ident" id="4625144">io</span><span class="op" id="4625146">.</span><span class="ident" id="4625147">Writer</span><span class="op" id="4625153">,</span>&nbsp;<span class="ident" id="4625155">debug</span>&nbsp;<span class="builtintype" id="4625161">int</span><span class="op" id="4625164">,</span>&nbsp;<span class="ident" id="4625166">name</span>&nbsp;<span class="builtintype" id="4625171">string</span><span class="op" id="4625177">,</span>&nbsp;<span class="ident" id="4625179">p</span>&nbsp;<span class="ident" id="4625181">countProfile</span><span class="op" id="4625193">)</span>&nbsp;<span class="builtintype" id="4625195">error</span>&nbsp;<span class="op" id="4625201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4625204">b</span>&nbsp;<span class="op" id="4625206">:=</span>&nbsp;<span class="ident" id="4625209">bufio</span><span class="op" id="4625214">.</span><span class="ident" id="4625215">NewWriter</span><span class="op" id="4625224">(</span><span class="ident" id="4625225">w</span><span class="op" id="4625226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4625229">var</span>&nbsp;<span class="ident" id="4625233">tw</span>&nbsp;<span class="op" id="4625236">*</span><span class="ident" id="4625237">tabwriter</span><span class="op" id="4625246">.</span><span class="ident" id="4625247">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4625255">w</span>&nbsp;<span class="op" id="4625257">=</span>&nbsp;<span class="ident" id="4625259">b</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4625262">if</span>&nbsp;<span class="ident" id="4625265">debug</span>&nbsp;<span class="op" id="4625271">&gt;</span>&nbsp;<span class="num" id="4625273">0</span>&nbsp;<span class="op" id="4625275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4625279">tw</span>&nbsp;<span class="op" id="4625282">=</span>&nbsp;<span class="ident" id="4625284">tabwriter</span><span class="op" id="4625293">.</span><span class="ident" id="4625294">NewWriter</span><span class="op" id="4625303">(</span><span class="ident" id="4625304">w</span><span class="op" id="4625305">,</span>&nbsp;<span class="num" id="4625307">1</span><span class="op" id="4625308">,</span>&nbsp;<span class="num" id="4625310">8</span><span class="op" id="4625311">,</span>&nbsp;<span class="num" id="4625313">1</span><span class="op" id="4625314">,</span>&nbsp;<span class="string" id="4625316">&#39;\t&#39;</span><span class="op" id="4625320">,</span>&nbsp;<span class="num" id="4625322">0</span><span class="op" id="4625323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4625327">w</span>&nbsp;<span class="op" id="4625329">=</span>&nbsp;<span class="ident" id="4625331">tw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4625335">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4625339">fmt</span><span class="op" id="4625342">.</span><span class="ident" id="4625343">Fprintf</span><span class="op" id="4625350">(</span><span class="ident" id="4625351">w</span><span class="op" id="4625352">,</span>&nbsp;<span class="string" id="4625354">&#34;%s&nbsp;profile:&nbsp;total&nbsp;%d\n&#34;</span><span class="op" id="4625378">,</span>&nbsp;<span class="ident" id="4625380">name</span><span class="op" id="4625384">,</span>&nbsp;<span class="ident" id="4625386">p</span><span class="op" id="4625387">.</span><span class="ident" id="4625388">Len</span><span class="op" id="4625391">(</span><span class="op" id="4625392">)</span><span class="op" id="4625393">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4625397">//&nbsp;Build&nbsp;count&nbsp;of&nbsp;each&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4625428">var</span>&nbsp;<span class="ident" id="4625432">buf</span>&nbsp;<span class="ident" id="4625436">bytes</span><span class="op" id="4625441">.</span><span class="ident" id="4625442">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4625450">key</span>&nbsp;<span class="op" id="4625454">:=</span>&nbsp;<span class="keyword" id="4625457">func</span><span class="op" id="4625461">(</span><span class="ident" id="4625462">stk</span>&nbsp;<span class="op" id="4625466">[</span><span class="op" id="4625467">]</span><span class="builtintype" id="4625468">uintptr</span><span class="op" id="4625475">)</span>&nbsp;<span class="builtintype" id="4625477">string</span>&nbsp;<span class="op" id="4625484">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4625488">buf</span><span class="op" id="4625491">.</span><span class="ident" id="4625492">Reset</span><span class="op" id="4625497">(</span><span class="op" id="4625498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4625502">fmt</span><span class="op" id="4625505">.</span><span class="ident" id="4625506">Fprintf</span><span class="op" id="4625513">(</span><span class="op" id="4625514">&amp;</span><span class="ident" id="4625515">buf</span><span class="op" id="4625518">,</span>&nbsp;<span class="string" id="4625520">&#34;@&#34;</span><span class="op" id="4625523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4625527">for</span>&nbsp;<span class="ident" id="4625531">_</span><span class="op" id="4625532">,</span>&nbsp;<span class="ident" id="4625534">pc</span>&nbsp;<span class="op" id="4625537">:=</span>&nbsp;<span class="keyword" id="4625540">range</span>&nbsp;<span class="ident" id="4625546">stk</span>&nbsp;<span class="op" id="4625550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4625555">fmt</span><span class="op" id="4625558">.</span><span class="ident" id="4625559">Fprintf</span><span class="op" id="4625566">(</span><span class="op" id="4625567">&amp;</span><span class="ident" id="4625568">buf</span><span class="op" id="4625571">,</span>&nbsp;<span class="string" id="4625573">&#34;&nbsp;%#x&#34;</span><span class="op" id="4625579">,</span>&nbsp;<span class="ident" id="4625581">pc</span><span class="op" id="4625583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4625587">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4625591">return</span>&nbsp;<span class="ident" id="4625598">buf</span><span class="op" id="4625601">.</span><span class="ident" id="4625602">String</span><span class="op" id="4625608">(</span><span class="op" id="4625609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4625612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4625615">m</span>&nbsp;<span class="op" id="4625617">:=</span>&nbsp;<span class="keyword" id="4625620">map</span><span class="op" id="4625623">[</span><span class="builtintype" id="4625624">string</span><span class="op" id="4625630">]</span><span class="builtintype" id="4625631">int</span><span class="op" id="4625634">{</span><span class="op" id="4625635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4625638">n</span>&nbsp;<span class="op" id="4625640">:=</span>&nbsp;<span class="ident" id="4625643">p</span><span class="op" id="4625644">.</span><span class="ident" id="4625645">Len</span><span class="op" id="4625648">(</span><span class="op" id="4625649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4625652">for</span>&nbsp;<span class="ident" id="4625656">i</span>&nbsp;<span class="op" id="4625658">:=</span>&nbsp;<span class="num" id="4625661">0</span><span class="op" id="4625662">;</span>&nbsp;<span class="ident" id="4625664">i</span>&nbsp;<span class="op" id="4625666">&lt;</span>&nbsp;<span class="ident" id="4625668">n</span><span class="op" id="4625669">;</span>&nbsp;<span class="ident" id="4625671">i</span><span class="op" id="4625672">++</span>&nbsp;<span class="op" id="4625675">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4625679">m</span><span class="op" id="4625680">[</span><span class="ident" id="4625681">key</span><span class="op" id="4625684">(</span><span class="ident" id="4625685">p</span><span class="op" id="4625686">.</span><span class="ident" id="4625687">Stack</span><span class="op" id="4625692">(</span><span class="ident" id="4625693">i</span><span class="op" id="4625694">)</span><span class="op" id="4625695">)</span><span class="op" id="4625696">]</span><span class="op" id="4625697">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4625701">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4625705">//&nbsp;Print&nbsp;stacks,&nbsp;listing&nbsp;count&nbsp;on&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;a&nbsp;unique&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4625776">for</span>&nbsp;<span class="ident" id="4625780">i</span>&nbsp;<span class="op" id="4625782">:=</span>&nbsp;<span class="num" id="4625785">0</span><span class="op" id="4625786">;</span>&nbsp;<span class="ident" id="4625788">i</span>&nbsp;<span class="op" id="4625790">&lt;</span>&nbsp;<span class="ident" id="4625792">n</span><span class="op" id="4625793">;</span>&nbsp;<span class="ident" id="4625795">i</span><span class="op" id="4625796">++</span>&nbsp;<span class="op" id="4625799">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4625803">stk</span>&nbsp;<span class="op" id="4625807">:=</span>&nbsp;<span class="ident" id="4625810">p</span><span class="op" id="4625811">.</span><span class="ident" id="4625812">Stack</span><span class="op" id="4625817">(</span><span class="ident" id="4625818">i</span><span class="op" id="4625819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4625823">s</span>&nbsp;<span class="op" id="4625825">:=</span>&nbsp;<span class="ident" id="4625828">key</span><span class="op" id="4625831">(</span><span class="ident" id="4625832">stk</span><span class="op" id="4625835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4625839">if</span>&nbsp;<span class="ident" id="4625842">count</span>&nbsp;<span class="op" id="4625848">:=</span>&nbsp;<span class="ident" id="4625851">m</span><span class="op" id="4625852">[</span><span class="ident" id="4625853">s</span><span class="op" id="4625854">]</span><span class="op" id="4625855">;</span>&nbsp;<span class="ident" id="4625857">count</span>&nbsp;<span class="op" id="4625863">!=</span>&nbsp;<span class="num" id="4625866">0</span>&nbsp;<span class="op" id="4625868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4625873">fmt</span><span class="op" id="4625876">.</span><span class="ident" id="4625877">Fprintf</span><span class="op" id="4625884">(</span><span class="ident" id="4625885">w</span><span class="op" id="4625886">,</span>&nbsp;<span class="string" id="4625888">&#34;%d&nbsp;%s\n&#34;</span><span class="op" id="4625897">,</span>&nbsp;<span class="ident" id="4625899">count</span><span class="op" id="4625904">,</span>&nbsp;<span class="ident" id="4625906">s</span><span class="op" id="4625907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4625912">if</span>&nbsp;<span class="ident" id="4625915">debug</span>&nbsp;<span class="op" id="4625921">&gt;</span>&nbsp;<span class="num" id="4625923">0</span>&nbsp;<span class="op" id="4625925">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4625931">printStackRecord</span><span class="op" id="4625947">(</span><span class="ident" id="4625948">w</span><span class="op" id="4625949">,</span>&nbsp;<span class="ident" id="4625951">stk</span><span class="op" id="4625954">,</span>&nbsp;<span class="builtintype" id="4625956">false</span><span class="op" id="4625961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4625966">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4625971">delete</span><span class="op" id="4625977">(</span><span class="ident" id="4625978">m</span><span class="op" id="4625979">,</span>&nbsp;<span class="ident" id="4625981">s</span><span class="op" id="4625982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4625986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4625989">}</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4625993">if</span>&nbsp;<span class="ident" id="4625996">tw</span>&nbsp;<span class="op" id="4625999">!=</span>&nbsp;<span class="ident" id="4626002">nil</span>&nbsp;<span class="op" id="4626006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4626010">tw</span><span class="op" id="4626012">.</span><span class="ident" id="4626013">Flush</span><span class="op" id="4626018">(</span><span class="op" id="4626019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4626022">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4626025">return</span>&nbsp;<span class="ident" id="4626032">b</span><span class="op" id="4626033">.</span><span class="ident" id="4626034">Flush</span><span class="op" id="4626039">(</span><span class="op" id="4626040">)</span><br>
<span class="lineno">315</span><span class="op" id="4626042">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4626045">//&nbsp;printStackRecord&nbsp;prints&nbsp;the&nbsp;function&nbsp;+&nbsp;source&nbsp;line&nbsp;information</span><br>
<span class="lineno"></span><span class="comment" id="4626111">//&nbsp;for&nbsp;a&nbsp;single&nbsp;stack&nbsp;trace.</span><br>
<span class="lineno"></span><span class="keyword" id="4626140">func</span>&nbsp;<span class="ident" id="4626145">printStackRecord</span><span class="op" id="4626161">(</span><span class="ident" id="4626162">w</span>&nbsp;<span class="ident" id="4626164">io</span><span class="op" id="4626166">.</span><span class="ident" id="4626167">Writer</span><span class="op" id="4626173">,</span>&nbsp;<span class="ident" id="4626175">stk</span>&nbsp;<span class="op" id="4626179">[</span><span class="op" id="4626180">]</span><span class="builtintype" id="4626181">uintptr</span><span class="op" id="4626188">,</span>&nbsp;<span class="ident" id="4626190">allFrames</span>&nbsp;<span class="builtintype" id="4626200">bool</span><span class="op" id="4626204">)</span>&nbsp;<span class="op" id="4626206">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4626209">show</span>&nbsp;<span class="op" id="4626214">:=</span>&nbsp;<span class="ident" id="4626217">allFrames</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4626228">wasPanic</span>&nbsp;<span class="op" id="4626237">:=</span>&nbsp;<span class="builtintype" id="4626240">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4626247">for</span>&nbsp;<span class="ident" id="4626251">i</span><span class="op" id="4626252">,</span>&nbsp;<span class="ident" id="4626254">pc</span>&nbsp;<span class="op" id="4626257">:=</span>&nbsp;<span class="keyword" id="4626260">range</span>&nbsp;<span class="ident" id="4626266">stk</span>&nbsp;<span class="op" id="4626270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4626274">f</span>&nbsp;<span class="op" id="4626276">:=</span>&nbsp;<span class="ident" id="4626279">runtime</span><span class="op" id="4626286">.</span><span class="ident" id="4626287">FuncForPC</span><span class="op" id="4626296">(</span><span class="ident" id="4626297">pc</span><span class="op" id="4626299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4626303">if</span>&nbsp;<span class="ident" id="4626306">f</span>&nbsp;<span class="op" id="4626308">==</span>&nbsp;<span class="ident" id="4626311">nil</span>&nbsp;<span class="op" id="4626315">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4626320">show</span>&nbsp;<span class="op" id="4626325">=</span>&nbsp;<span class="builtintype" id="4626327">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4626335">fmt</span><span class="op" id="4626338">.</span><span class="ident" id="4626339">Fprintf</span><span class="op" id="4626346">(</span><span class="ident" id="4626347">w</span><span class="op" id="4626348">,</span>&nbsp;<span class="string" id="4626350">&#34;#\t%#x\n&#34;</span><span class="op" id="4626360">,</span>&nbsp;<span class="ident" id="4626362">pc</span><span class="op" id="4626364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4626369">wasPanic</span>&nbsp;<span class="op" id="4626378">=</span>&nbsp;<span class="builtintype" id="4626380">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4626388">}</span>&nbsp;<span class="keyword" id="4626390">else</span>&nbsp;<span class="op" id="4626395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4626400">tracepc</span>&nbsp;<span class="op" id="4626408">:=</span>&nbsp;<span class="ident" id="4626411">pc</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4626417">//&nbsp;Back&nbsp;up&nbsp;to&nbsp;call&nbsp;instruction.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4626452">if</span>&nbsp;<span class="ident" id="4626455">i</span>&nbsp;<span class="op" id="4626457">&gt;</span>&nbsp;<span class="num" id="4626459">0</span>&nbsp;<span class="op" id="4626461">&amp;&amp;</span>&nbsp;<span class="ident" id="4626464">pc</span>&nbsp;<span class="op" id="4626467">&gt;</span>&nbsp;<span class="ident" id="4626469">f</span><span class="op" id="4626470">.</span><span class="ident" id="4626471">Entry</span><span class="op" id="4626476">(</span><span class="op" id="4626477">)</span>&nbsp;<span class="op" id="4626479">&amp;&amp;</span>&nbsp;<span class="op" id="4626482">!</span><span class="ident" id="4626483">wasPanic</span>&nbsp;<span class="op" id="4626492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4626498">if</span>&nbsp;<span class="ident" id="4626501">runtime</span><span class="op" id="4626508">.</span><span class="ident" id="4626509">GOARCH</span>&nbsp;<span class="op" id="4626516">==</span>&nbsp;<span class="string" id="4626519">&#34;386&#34;</span>&nbsp;<span class="op" id="4626525">||</span>&nbsp;<span class="ident" id="4626528">runtime</span><span class="op" id="4626535">.</span><span class="ident" id="4626536">GOARCH</span>&nbsp;<span class="op" id="4626543">==</span>&nbsp;<span class="string" id="4626546">&#34;amd64&#34;</span>&nbsp;<span class="op" id="4626554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4626561">tracepc</span><span class="op" id="4626568">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4626575">}</span>&nbsp;<span class="keyword" id="4626577">else</span>&nbsp;<span class="op" id="4626582">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4626589">tracepc</span>&nbsp;<span class="op" id="4626597">-=</span>&nbsp;<span class="num" id="4626600">4</span>&nbsp;<span class="comment" id="4626602">//&nbsp;arm,&nbsp;etc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4626618">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4626623">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4626628">file</span><span class="op" id="4626632">,</span>&nbsp;<span class="ident" id="4626634">line</span>&nbsp;<span class="op" id="4626639">:=</span>&nbsp;<span class="ident" id="4626642">f</span><span class="op" id="4626643">.</span><span class="ident" id="4626644">FileLine</span><span class="op" id="4626652">(</span><span class="ident" id="4626653">tracepc</span><span class="op" id="4626660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4626665">name</span>&nbsp;<span class="op" id="4626670">:=</span>&nbsp;<span class="ident" id="4626673">f</span><span class="op" id="4626674">.</span><span class="ident" id="4626675">Name</span><span class="op" id="4626679">(</span><span class="op" id="4626680">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4626685">//&nbsp;Hide&nbsp;runtime.goexit&nbsp;and&nbsp;any&nbsp;runtime&nbsp;functions&nbsp;at&nbsp;the&nbsp;beginning.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4626755">//&nbsp;This&nbsp;is&nbsp;useful&nbsp;mainly&nbsp;for&nbsp;allocation&nbsp;traces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4626806">wasPanic</span>&nbsp;<span class="op" id="4626815">=</span>&nbsp;<span class="ident" id="4626817">name</span>&nbsp;<span class="op" id="4626822">==</span>&nbsp;<span class="string" id="4626825">&#34;runtime.panic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4626844">if</span>&nbsp;<span class="ident" id="4626847">name</span>&nbsp;<span class="op" id="4626852">==</span>&nbsp;<span class="string" id="4626855">&#34;runtime.goexit&#34;</span>&nbsp;<span class="op" id="4626872">||</span>&nbsp;<span class="op" id="4626875">!</span><span class="ident" id="4626876">show</span>&nbsp;<span class="op" id="4626881">&amp;&amp;</span>&nbsp;<span class="ident" id="4626884">strings</span><span class="op" id="4626891">.</span><span class="ident" id="4626892">HasPrefix</span><span class="op" id="4626901">(</span><span class="ident" id="4626902">name</span><span class="op" id="4626906">,</span>&nbsp;<span class="string" id="4626908">&#34;runtime.&#34;</span><span class="op" id="4626918">)</span>&nbsp;<span class="op" id="4626920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4626926">continue</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4626938">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4626943">show</span>&nbsp;<span class="op" id="4626948">=</span>&nbsp;<span class="builtintype" id="4626950">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4626958">fmt</span><span class="op" id="4626961">.</span><span class="ident" id="4626962">Fprintf</span><span class="op" id="4626969">(</span><span class="ident" id="4626970">w</span><span class="op" id="4626971">,</span>&nbsp;<span class="string" id="4626973">&#34;#\t%#x\t%s+%#x\t%s:%d\n&#34;</span><span class="op" id="4626998">,</span>&nbsp;<span class="ident" id="4627000">pc</span><span class="op" id="4627002">,</span>&nbsp;<span class="ident" id="4627004">name</span><span class="op" id="4627008">,</span>&nbsp;<span class="ident" id="4627010">pc</span><span class="op" id="4627012">-</span><span class="ident" id="4627013">f</span><span class="op" id="4627014">.</span><span class="ident" id="4627015">Entry</span><span class="op" id="4627020">(</span><span class="op" id="4627021">)</span><span class="op" id="4627022">,</span>&nbsp;<span class="ident" id="4627024">file</span><span class="op" id="4627028">,</span>&nbsp;<span class="ident" id="4627030">line</span><span class="op" id="4627034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4627038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4627041">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4627044">if</span>&nbsp;<span class="op" id="4627047">!</span><span class="ident" id="4627048">show</span>&nbsp;<span class="op" id="4627053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4627057">//&nbsp;We&nbsp;didn&#39;t&nbsp;print&nbsp;anything;&nbsp;do&nbsp;it&nbsp;again,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4627101">//&nbsp;and&nbsp;this&nbsp;time&nbsp;include&nbsp;runtime&nbsp;functions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4627147">printStackRecord</span><span class="op" id="4627163">(</span><span class="ident" id="4627164">w</span><span class="op" id="4627165">,</span>&nbsp;<span class="ident" id="4627167">stk</span><span class="op" id="4627170">,</span>&nbsp;<span class="builtintype" id="4627172">true</span><span class="op" id="4627176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4627180">return</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4627188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4627191">fmt</span><span class="op" id="4627194">.</span><span class="ident" id="4627195">Fprintf</span><span class="op" id="4627202">(</span><span class="ident" id="4627203">w</span><span class="op" id="4627204">,</span>&nbsp;<span class="string" id="4627206">&#34;\n&#34;</span><span class="op" id="4627210">)</span><br>
<span class="lineno"></span><span class="op" id="4627212">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4627215">//&nbsp;Interface&nbsp;to&nbsp;system&nbsp;profiles.</span><br>
<span class="lineno">360</span><br>
<span class="lineno"></span><span class="keyword" id="4627249">type</span>&nbsp;<span class="ident" id="4627254">byInUseBytes</span>&nbsp;<span class="op" id="4627267">[</span><span class="op" id="4627268">]</span><span class="ident" id="4627269">runtime</span><span class="op" id="4627276">.</span><span class="ident" id="4627277">MemProfileRecord</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4627295">func</span>&nbsp;<span class="op" id="4627300">(</span><span class="ident" id="4627301">x</span>&nbsp;<span class="ident" id="4627303">byInUseBytes</span><span class="op" id="4627315">)</span>&nbsp;<span class="ident" id="4627317">Len</span><span class="op" id="4627320">(</span><span class="op" id="4627321">)</span>&nbsp;<span class="builtintype" id="4627323">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4627337">{</span>&nbsp;<span class="keyword" id="4627339">return</span>&nbsp;<span class="builtinfunc" id="4627346">len</span><span class="op" id="4627349">(</span><span class="ident" id="4627350">x</span><span class="op" id="4627351">)</span>&nbsp;<span class="op" id="4627353">}</span><br>
<span class="lineno"></span><span class="keyword" id="4627355">func</span>&nbsp;<span class="op" id="4627360">(</span><span class="ident" id="4627361">x</span>&nbsp;<span class="ident" id="4627363">byInUseBytes</span><span class="op" id="4627375">)</span>&nbsp;<span class="ident" id="4627377">Swap</span><span class="op" id="4627381">(</span><span class="ident" id="4627382">i</span><span class="op" id="4627383">,</span>&nbsp;<span class="ident" id="4627385">j</span>&nbsp;<span class="builtintype" id="4627387">int</span><span class="op" id="4627390">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4627397">{</span>&nbsp;<span class="ident" id="4627399">x</span><span class="op" id="4627400">[</span><span class="ident" id="4627401">i</span><span class="op" id="4627402">]</span><span class="op" id="4627403">,</span>&nbsp;<span class="ident" id="4627405">x</span><span class="op" id="4627406">[</span><span class="ident" id="4627407">j</span><span class="op" id="4627408">]</span>&nbsp;<span class="op" id="4627410">=</span>&nbsp;<span class="ident" id="4627412">x</span><span class="op" id="4627413">[</span><span class="ident" id="4627414">j</span><span class="op" id="4627415">]</span><span class="op" id="4627416">,</span>&nbsp;<span class="ident" id="4627418">x</span><span class="op" id="4627419">[</span><span class="ident" id="4627420">i</span><span class="op" id="4627421">]</span>&nbsp;<span class="op" id="4627423">}</span><br>
<span class="lineno">365</span><span class="keyword" id="4627425">func</span>&nbsp;<span class="op" id="4627430">(</span><span class="ident" id="4627431">x</span>&nbsp;<span class="ident" id="4627433">byInUseBytes</span><span class="op" id="4627445">)</span>&nbsp;<span class="ident" id="4627447">Less</span><span class="op" id="4627451">(</span><span class="ident" id="4627452">i</span><span class="op" id="4627453">,</span>&nbsp;<span class="ident" id="4627455">j</span>&nbsp;<span class="builtintype" id="4627457">int</span><span class="op" id="4627460">)</span>&nbsp;<span class="builtintype" id="4627462">bool</span>&nbsp;<span class="op" id="4627467">{</span>&nbsp;<span class="keyword" id="4627469">return</span>&nbsp;<span class="ident" id="4627476">x</span><span class="op" id="4627477">[</span><span class="ident" id="4627478">i</span><span class="op" id="4627479">]</span><span class="op" id="4627480">.</span><span class="ident" id="4627481">InUseBytes</span><span class="op" id="4627491">(</span><span class="op" id="4627492">)</span>&nbsp;<span class="op" id="4627494">&gt;</span>&nbsp;<span class="ident" id="4627496">x</span><span class="op" id="4627497">[</span><span class="ident" id="4627498">j</span><span class="op" id="4627499">]</span><span class="op" id="4627500">.</span><span class="ident" id="4627501">InUseBytes</span><span class="op" id="4627511">(</span><span class="op" id="4627512">)</span>&nbsp;<span class="op" id="4627514">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4627517">//&nbsp;WriteHeapProfile&nbsp;is&nbsp;shorthand&nbsp;for&nbsp;Lookup(&#34;heap&#34;).WriteTo(w,&nbsp;0).</span><br>
<span class="lineno"></span><span class="comment" id="4627584">//&nbsp;It&nbsp;is&nbsp;preserved&nbsp;for&nbsp;backwards&nbsp;compatibility.</span><br>
<span class="lineno"></span><span class="keyword" id="4627632">func</span>&nbsp;<span class="ident" id="4627637">WriteHeapProfile</span><span class="op" id="4627653">(</span><span class="ident" id="4627654">w</span>&nbsp;<span class="ident" id="4627656">io</span><span class="op" id="4627658">.</span><span class="ident" id="4627659">Writer</span><span class="op" id="4627665">)</span>&nbsp;<span class="builtintype" id="4627667">error</span>&nbsp;<span class="op" id="4627673">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4627676">return</span>&nbsp;<span class="ident" id="4627683">writeHeap</span><span class="op" id="4627692">(</span><span class="ident" id="4627693">w</span><span class="op" id="4627694">,</span>&nbsp;<span class="num" id="4627696">0</span><span class="op" id="4627697">)</span><br>
<span class="lineno"></span><span class="op" id="4627699">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4627702">//&nbsp;countHeap&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;heap&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="4627766">func</span>&nbsp;<span class="ident" id="4627771">countHeap</span><span class="op" id="4627780">(</span><span class="op" id="4627781">)</span>&nbsp;<span class="builtintype" id="4627783">int</span>&nbsp;<span class="op" id="4627787">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4627790">n</span><span class="op" id="4627791">,</span>&nbsp;<span class="ident" id="4627793">_</span>&nbsp;<span class="op" id="4627795">:=</span>&nbsp;<span class="ident" id="4627798">runtime</span><span class="op" id="4627805">.</span><span class="ident" id="4627806">MemProfile</span><span class="op" id="4627816">(</span><span class="ident" id="4627817">nil</span><span class="op" id="4627820">,</span>&nbsp;<span class="builtintype" id="4627822">true</span><span class="op" id="4627826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4627829">return</span>&nbsp;<span class="ident" id="4627836">n</span><br>
<span class="lineno"></span><span class="op" id="4627838">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4627841">//&nbsp;writeHeap&nbsp;writes&nbsp;the&nbsp;current&nbsp;runtime&nbsp;heap&nbsp;profile&nbsp;to&nbsp;w.</span><br>
<span class="lineno">380</span><span class="keyword" id="4627900">func</span>&nbsp;<span class="ident" id="4627905">writeHeap</span><span class="op" id="4627914">(</span><span class="ident" id="4627915">w</span>&nbsp;<span class="ident" id="4627917">io</span><span class="op" id="4627919">.</span><span class="ident" id="4627920">Writer</span><span class="op" id="4627926">,</span>&nbsp;<span class="ident" id="4627928">debug</span>&nbsp;<span class="builtintype" id="4627934">int</span><span class="op" id="4627937">)</span>&nbsp;<span class="builtintype" id="4627939">error</span>&nbsp;<span class="op" id="4627945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4627948">//&nbsp;Find&nbsp;out&nbsp;how&nbsp;many&nbsp;records&nbsp;there&nbsp;are&nbsp;(MemProfile(nil,&nbsp;true)),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4628013">//&nbsp;allocate&nbsp;that&nbsp;many&nbsp;records,&nbsp;and&nbsp;get&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4628063">//&nbsp;There&#39;s&nbsp;a&nbsp;race—more&nbsp;records&nbsp;might&nbsp;be&nbsp;added&nbsp;between</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4628120">//&nbsp;the&nbsp;two&nbsp;calls—so&nbsp;allocate&nbsp;a&nbsp;few&nbsp;extra&nbsp;records&nbsp;for&nbsp;safety</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4628183">//&nbsp;and&nbsp;also&nbsp;try&nbsp;again&nbsp;if&nbsp;we&#39;re&nbsp;very&nbsp;unlucky.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4628229">//&nbsp;The&nbsp;loop&nbsp;should&nbsp;only&nbsp;execute&nbsp;one&nbsp;iteration&nbsp;in&nbsp;the&nbsp;common&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4628296">var</span>&nbsp;<span class="ident" id="4628300">p</span>&nbsp;<span class="op" id="4628302">[</span><span class="op" id="4628303">]</span><span class="ident" id="4628304">runtime</span><span class="op" id="4628311">.</span><span class="ident" id="4628312">MemProfileRecord</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4628330">n</span><span class="op" id="4628331">,</span>&nbsp;<span class="ident" id="4628333">ok</span>&nbsp;<span class="op" id="4628336">:=</span>&nbsp;<span class="ident" id="4628339">runtime</span><span class="op" id="4628346">.</span><span class="ident" id="4628347">MemProfile</span><span class="op" id="4628357">(</span><span class="ident" id="4628358">nil</span><span class="op" id="4628361">,</span>&nbsp;<span class="builtintype" id="4628363">true</span><span class="op" id="4628367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4628370">for</span>&nbsp;<span class="op" id="4628374">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4628378">//&nbsp;Allocate&nbsp;room&nbsp;for&nbsp;a&nbsp;slightly&nbsp;bigger&nbsp;profile,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4628428">//&nbsp;in&nbsp;case&nbsp;a&nbsp;few&nbsp;more&nbsp;entries&nbsp;have&nbsp;been&nbsp;added</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4628476">//&nbsp;since&nbsp;the&nbsp;call&nbsp;to&nbsp;MemProfile.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4628511">p</span>&nbsp;<span class="op" id="4628513">=</span>&nbsp;<span class="builtinfunc" id="4628515">make</span><span class="op" id="4628519">(</span><span class="op" id="4628520">[</span><span class="op" id="4628521">]</span><span class="ident" id="4628522">runtime</span><span class="op" id="4628529">.</span><span class="ident" id="4628530">MemProfileRecord</span><span class="op" id="4628546">,</span>&nbsp;<span class="ident" id="4628548">n</span><span class="op" id="4628549">+</span><span class="num" id="4628550">50</span><span class="op" id="4628552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4628556">n</span><span class="op" id="4628557">,</span>&nbsp;<span class="ident" id="4628559">ok</span>&nbsp;<span class="op" id="4628562">=</span>&nbsp;<span class="ident" id="4628564">runtime</span><span class="op" id="4628571">.</span><span class="ident" id="4628572">MemProfile</span><span class="op" id="4628582">(</span><span class="ident" id="4628583">p</span><span class="op" id="4628584">,</span>&nbsp;<span class="builtintype" id="4628586">true</span><span class="op" id="4628590">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4628594">if</span>&nbsp;<span class="ident" id="4628597">ok</span>&nbsp;<span class="op" id="4628600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4628605">p</span>&nbsp;<span class="op" id="4628607">=</span>&nbsp;<span class="ident" id="4628609">p</span><span class="op" id="4628610">[</span><span class="num" id="4628611">0</span><span class="op" id="4628612">:</span><span class="ident" id="4628613">n</span><span class="op" id="4628614">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4628619">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4628627">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4628631">//&nbsp;Profile&nbsp;grew;&nbsp;try&nbsp;again.</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4628660">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4628664">sort</span><span class="op" id="4628668">.</span><span class="ident" id="4628669">Sort</span><span class="op" id="4628673">(</span><span class="ident" id="4628674">byInUseBytes</span><span class="op" id="4628686">(</span><span class="ident" id="4628687">p</span><span class="op" id="4628688">)</span><span class="op" id="4628689">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4628693">b</span>&nbsp;<span class="op" id="4628695">:=</span>&nbsp;<span class="ident" id="4628698">bufio</span><span class="op" id="4628703">.</span><span class="ident" id="4628704">NewWriter</span><span class="op" id="4628713">(</span><span class="ident" id="4628714">w</span><span class="op" id="4628715">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4628718">var</span>&nbsp;<span class="ident" id="4628722">tw</span>&nbsp;<span class="op" id="4628725">*</span><span class="ident" id="4628726">tabwriter</span><span class="op" id="4628735">.</span><span class="ident" id="4628736">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4628744">w</span>&nbsp;<span class="op" id="4628746">=</span>&nbsp;<span class="ident" id="4628748">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4628751">if</span>&nbsp;<span class="ident" id="4628754">debug</span>&nbsp;<span class="op" id="4628760">&gt;</span>&nbsp;<span class="num" id="4628762">0</span>&nbsp;<span class="op" id="4628764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4628768">tw</span>&nbsp;<span class="op" id="4628771">=</span>&nbsp;<span class="ident" id="4628773">tabwriter</span><span class="op" id="4628782">.</span><span class="ident" id="4628783">NewWriter</span><span class="op" id="4628792">(</span><span class="ident" id="4628793">w</span><span class="op" id="4628794">,</span>&nbsp;<span class="num" id="4628796">1</span><span class="op" id="4628797">,</span>&nbsp;<span class="num" id="4628799">8</span><span class="op" id="4628800">,</span>&nbsp;<span class="num" id="4628802">1</span><span class="op" id="4628803">,</span>&nbsp;<span class="string" id="4628805">&#39;\t&#39;</span><span class="op" id="4628809">,</span>&nbsp;<span class="num" id="4628811">0</span><span class="op" id="4628812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4628816">w</span>&nbsp;<span class="op" id="4628818">=</span>&nbsp;<span class="ident" id="4628820">tw</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4628824">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4628828">var</span>&nbsp;<span class="ident" id="4628832">total</span>&nbsp;<span class="ident" id="4628838">runtime</span><span class="op" id="4628845">.</span><span class="ident" id="4628846">MemProfileRecord</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4628864">for</span>&nbsp;<span class="ident" id="4628868">i</span>&nbsp;<span class="op" id="4628870">:=</span>&nbsp;<span class="keyword" id="4628873">range</span>&nbsp;<span class="ident" id="4628879">p</span>&nbsp;<span class="op" id="4628881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4628885">r</span>&nbsp;<span class="op" id="4628887">:=</span>&nbsp;<span class="op" id="4628890">&amp;</span><span class="ident" id="4628891">p</span><span class="op" id="4628892">[</span><span class="ident" id="4628893">i</span><span class="op" id="4628894">]</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4628898">total</span><span class="op" id="4628903">.</span><span class="ident" id="4628904">AllocBytes</span>&nbsp;<span class="op" id="4628915">+=</span>&nbsp;<span class="ident" id="4628918">r</span><span class="op" id="4628919">.</span><span class="ident" id="4628920">AllocBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4628933">total</span><span class="op" id="4628938">.</span><span class="ident" id="4628939">AllocObjects</span>&nbsp;<span class="op" id="4628952">+=</span>&nbsp;<span class="ident" id="4628955">r</span><span class="op" id="4628956">.</span><span class="ident" id="4628957">AllocObjects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4628972">total</span><span class="op" id="4628977">.</span><span class="ident" id="4628978">FreeBytes</span>&nbsp;<span class="op" id="4628988">+=</span>&nbsp;<span class="ident" id="4628991">r</span><span class="op" id="4628992">.</span><span class="ident" id="4628993">FreeBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4629005">total</span><span class="op" id="4629010">.</span><span class="ident" id="4629011">FreeObjects</span>&nbsp;<span class="op" id="4629023">+=</span>&nbsp;<span class="ident" id="4629026">r</span><span class="op" id="4629027">.</span><span class="ident" id="4629028">FreeObjects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4629041">}</span><br>
<span class="lineno">420</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4629045">//&nbsp;Technically&nbsp;the&nbsp;rate&nbsp;is&nbsp;MemProfileRate&nbsp;not&nbsp;2*MemProfileRate,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4629110">//&nbsp;but&nbsp;early&nbsp;versions&nbsp;of&nbsp;the&nbsp;C++&nbsp;heap&nbsp;profiler&nbsp;reported&nbsp;2*MemProfileRate,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4629185">//&nbsp;so&nbsp;that&#39;s&nbsp;what&nbsp;pprof&nbsp;has&nbsp;come&nbsp;to&nbsp;expect.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4629230">fmt</span><span class="op" id="4629233">.</span><span class="ident" id="4629234">Fprintf</span><span class="op" id="4629241">(</span><span class="ident" id="4629242">w</span><span class="op" id="4629243">,</span>&nbsp;<span class="string" id="4629245">&#34;heap&nbsp;profile:&nbsp;%d:&nbsp;%d&nbsp;[%d:&nbsp;%d]&nbsp;@&nbsp;heap/%d\n&#34;</span><span class="op" id="4629288">,</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4629292">total</span><span class="op" id="4629297">.</span><span class="ident" id="4629298">InUseObjects</span><span class="op" id="4629310">(</span><span class="op" id="4629311">)</span><span class="op" id="4629312">,</span>&nbsp;<span class="ident" id="4629314">total</span><span class="op" id="4629319">.</span><span class="ident" id="4629320">InUseBytes</span><span class="op" id="4629330">(</span><span class="op" id="4629331">)</span><span class="op" id="4629332">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4629336">total</span><span class="op" id="4629341">.</span><span class="ident" id="4629342">AllocObjects</span><span class="op" id="4629354">,</span>&nbsp;<span class="ident" id="4629356">total</span><span class="op" id="4629361">.</span><span class="ident" id="4629362">AllocBytes</span><span class="op" id="4629372">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="4629376">2</span><span class="op" id="4629377">*</span><span class="ident" id="4629378">runtime</span><span class="op" id="4629385">.</span><span class="ident" id="4629386">MemProfileRate</span><span class="op" id="4629400">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4629404">for</span>&nbsp;<span class="ident" id="4629408">i</span>&nbsp;<span class="op" id="4629410">:=</span>&nbsp;<span class="keyword" id="4629413">range</span>&nbsp;<span class="ident" id="4629419">p</span>&nbsp;<span class="op" id="4629421">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4629425">r</span>&nbsp;<span class="op" id="4629427">:=</span>&nbsp;<span class="op" id="4629430">&amp;</span><span class="ident" id="4629431">p</span><span class="op" id="4629432">[</span><span class="ident" id="4629433">i</span><span class="op" id="4629434">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4629438">fmt</span><span class="op" id="4629441">.</span><span class="ident" id="4629442">Fprintf</span><span class="op" id="4629449">(</span><span class="ident" id="4629450">w</span><span class="op" id="4629451">,</span>&nbsp;<span class="string" id="4629453">&#34;%d:&nbsp;%d&nbsp;[%d:&nbsp;%d]&nbsp;@&#34;</span><span class="op" id="4629472">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4629477">r</span><span class="op" id="4629478">.</span><span class="ident" id="4629479">InUseObjects</span><span class="op" id="4629491">(</span><span class="op" id="4629492">)</span><span class="op" id="4629493">,</span>&nbsp;<span class="ident" id="4629495">r</span><span class="op" id="4629496">.</span><span class="ident" id="4629497">InUseBytes</span><span class="op" id="4629507">(</span><span class="op" id="4629508">)</span><span class="op" id="4629509">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4629514">r</span><span class="op" id="4629515">.</span><span class="ident" id="4629516">AllocObjects</span><span class="op" id="4629528">,</span>&nbsp;<span class="ident" id="4629530">r</span><span class="op" id="4629531">.</span><span class="ident" id="4629532">AllocBytes</span><span class="op" id="4629542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4629546">for</span>&nbsp;<span class="ident" id="4629550">_</span><span class="op" id="4629551">,</span>&nbsp;<span class="ident" id="4629553">pc</span>&nbsp;<span class="op" id="4629556">:=</span>&nbsp;<span class="keyword" id="4629559">range</span>&nbsp;<span class="ident" id="4629565">r</span><span class="op" id="4629566">.</span><span class="ident" id="4629567">Stack</span><span class="op" id="4629572">(</span><span class="op" id="4629573">)</span>&nbsp;<span class="op" id="4629575">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4629580">fmt</span><span class="op" id="4629583">.</span><span class="ident" id="4629584">Fprintf</span><span class="op" id="4629591">(</span><span class="ident" id="4629592">w</span><span class="op" id="4629593">,</span>&nbsp;<span class="string" id="4629595">&#34;&nbsp;%#x&#34;</span><span class="op" id="4629601">,</span>&nbsp;<span class="ident" id="4629603">pc</span><span class="op" id="4629605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4629609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4629613">fmt</span><span class="op" id="4629616">.</span><span class="ident" id="4629617">Fprintf</span><span class="op" id="4629624">(</span><span class="ident" id="4629625">w</span><span class="op" id="4629626">,</span>&nbsp;<span class="string" id="4629628">&#34;\n&#34;</span><span class="op" id="4629632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4629636">if</span>&nbsp;<span class="ident" id="4629639">debug</span>&nbsp;<span class="op" id="4629645">&gt;</span>&nbsp;<span class="num" id="4629647">0</span>&nbsp;<span class="op" id="4629649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4629654">printStackRecord</span><span class="op" id="4629670">(</span><span class="ident" id="4629671">w</span><span class="op" id="4629672">,</span>&nbsp;<span class="ident" id="4629674">r</span><span class="op" id="4629675">.</span><span class="ident" id="4629676">Stack</span><span class="op" id="4629681">(</span><span class="op" id="4629682">)</span><span class="op" id="4629683">,</span>&nbsp;<span class="builtintype" id="4629685">false</span><span class="op" id="4629690">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4629694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4629697">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4629701">//&nbsp;Print&nbsp;memstats&nbsp;information&nbsp;too.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4629737">//&nbsp;Pprof&nbsp;will&nbsp;ignore,&nbsp;but&nbsp;useful&nbsp;for&nbsp;people</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4629782">if</span>&nbsp;<span class="ident" id="4629785">debug</span>&nbsp;<span class="op" id="4629791">&gt;</span>&nbsp;<span class="num" id="4629793">0</span>&nbsp;<span class="op" id="4629795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4629799">s</span>&nbsp;<span class="op" id="4629801">:=</span>&nbsp;<span class="builtinfunc" id="4629804">new</span><span class="op" id="4629807">(</span><span class="ident" id="4629808">runtime</span><span class="op" id="4629815">.</span><span class="ident" id="4629816">MemStats</span><span class="op" id="4629824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4629828">runtime</span><span class="op" id="4629835">.</span><span class="ident" id="4629836">ReadMemStats</span><span class="op" id="4629848">(</span><span class="ident" id="4629849">s</span><span class="op" id="4629850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4629854">fmt</span><span class="op" id="4629857">.</span><span class="ident" id="4629858">Fprintf</span><span class="op" id="4629865">(</span><span class="ident" id="4629866">w</span><span class="op" id="4629867">,</span>&nbsp;<span class="string" id="4629869">&#34;\n#&nbsp;runtime.MemStats\n&#34;</span><span class="op" id="4629893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4629897">fmt</span><span class="op" id="4629900">.</span><span class="ident" id="4629901">Fprintf</span><span class="op" id="4629908">(</span><span class="ident" id="4629909">w</span><span class="op" id="4629910">,</span>&nbsp;<span class="string" id="4629912">&#34;#&nbsp;Alloc&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="4629928">,</span>&nbsp;<span class="ident" id="4629930">s</span><span class="op" id="4629931">.</span><span class="ident" id="4629932">Alloc</span><span class="op" id="4629937">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4629941">fmt</span><span class="op" id="4629944">.</span><span class="ident" id="4629945">Fprintf</span><span class="op" id="4629952">(</span><span class="ident" id="4629953">w</span><span class="op" id="4629954">,</span>&nbsp;<span class="string" id="4629956">&#34;#&nbsp;TotalAlloc&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="4629977">,</span>&nbsp;<span class="ident" id="4629979">s</span><span class="op" id="4629980">.</span><span class="ident" id="4629981">TotalAlloc</span><span class="op" id="4629991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4629995">fmt</span><span class="op" id="4629998">.</span><span class="ident" id="4629999">Fprintf</span><span class="op" id="4630006">(</span><span class="ident" id="4630007">w</span><span class="op" id="4630008">,</span>&nbsp;<span class="string" id="4630010">&#34;#&nbsp;Sys&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="4630024">,</span>&nbsp;<span class="ident" id="4630026">s</span><span class="op" id="4630027">.</span><span class="ident" id="4630028">Sys</span><span class="op" id="4630031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4630035">fmt</span><span class="op" id="4630038">.</span><span class="ident" id="4630039">Fprintf</span><span class="op" id="4630046">(</span><span class="ident" id="4630047">w</span><span class="op" id="4630048">,</span>&nbsp;<span class="string" id="4630050">&#34;#&nbsp;Lookups&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="4630068">,</span>&nbsp;<span class="ident" id="4630070">s</span><span class="op" id="4630071">.</span><span class="ident" id="4630072">Lookups</span><span class="op" id="4630079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4630083">fmt</span><span class="op" id="4630086">.</span><span class="ident" id="4630087">Fprintf</span><span class="op" id="4630094">(</span><span class="ident" id="4630095">w</span><span class="op" id="4630096">,</span>&nbsp;<span class="string" id="4630098">&#34;#&nbsp;Mallocs&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="4630116">,</span>&nbsp;<span class="ident" id="4630118">s</span><span class="op" id="4630119">.</span><span class="ident" id="4630120">Mallocs</span><span class="op" id="4630127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4630131">fmt</span><span class="op" id="4630134">.</span><span class="ident" id="4630135">Fprintf</span><span class="op" id="4630142">(</span><span class="ident" id="4630143">w</span><span class="op" id="4630144">,</span>&nbsp;<span class="string" id="4630146">&#34;#&nbsp;Frees&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="4630162">,</span>&nbsp;<span class="ident" id="4630164">s</span><span class="op" id="4630165">.</span><span class="ident" id="4630166">Frees</span><span class="op" id="4630171">)</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4630176">fmt</span><span class="op" id="4630179">.</span><span class="ident" id="4630180">Fprintf</span><span class="op" id="4630187">(</span><span class="ident" id="4630188">w</span><span class="op" id="4630189">,</span>&nbsp;<span class="string" id="4630191">&#34;#&nbsp;HeapAlloc&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="4630211">,</span>&nbsp;<span class="ident" id="4630213">s</span><span class="op" id="4630214">.</span><span class="ident" id="4630215">HeapAlloc</span><span class="op" id="4630224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4630228">fmt</span><span class="op" id="4630231">.</span><span class="ident" id="4630232">Fprintf</span><span class="op" id="4630239">(</span><span class="ident" id="4630240">w</span><span class="op" id="4630241">,</span>&nbsp;<span class="string" id="4630243">&#34;#&nbsp;HeapSys&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="4630261">,</span>&nbsp;<span class="ident" id="4630263">s</span><span class="op" id="4630264">.</span><span class="ident" id="4630265">HeapSys</span><span class="op" id="4630272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4630276">fmt</span><span class="op" id="4630279">.</span><span class="ident" id="4630280">Fprintf</span><span class="op" id="4630287">(</span><span class="ident" id="4630288">w</span><span class="op" id="4630289">,</span>&nbsp;<span class="string" id="4630291">&#34;#&nbsp;HeapIdle&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="4630310">,</span>&nbsp;<span class="ident" id="4630312">s</span><span class="op" id="4630313">.</span><span class="ident" id="4630314">HeapIdle</span><span class="op" id="4630322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4630326">fmt</span><span class="op" id="4630329">.</span><span class="ident" id="4630330">Fprintf</span><span class="op" id="4630337">(</span><span class="ident" id="4630338">w</span><span class="op" id="4630339">,</span>&nbsp;<span class="string" id="4630341">&#34;#&nbsp;HeapInuse&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="4630361">,</span>&nbsp;<span class="ident" id="4630363">s</span><span class="op" id="4630364">.</span><span class="ident" id="4630365">HeapInuse</span><span class="op" id="4630374">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4630378">fmt</span><span class="op" id="4630381">.</span><span class="ident" id="4630382">Fprintf</span><span class="op" id="4630389">(</span><span class="ident" id="4630390">w</span><span class="op" id="4630391">,</span>&nbsp;<span class="string" id="4630393">&#34;#&nbsp;HeapReleased&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="4630416">,</span>&nbsp;<span class="ident" id="4630418">s</span><span class="op" id="4630419">.</span><span class="ident" id="4630420">HeapReleased</span><span class="op" id="4630432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4630436">fmt</span><span class="op" id="4630439">.</span><span class="ident" id="4630440">Fprintf</span><span class="op" id="4630447">(</span><span class="ident" id="4630448">w</span><span class="op" id="4630449">,</span>&nbsp;<span class="string" id="4630451">&#34;#&nbsp;HeapObjects&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="4630473">,</span>&nbsp;<span class="ident" id="4630475">s</span><span class="op" id="4630476">.</span><span class="ident" id="4630477">HeapObjects</span><span class="op" id="4630488">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4630493">fmt</span><span class="op" id="4630496">.</span><span class="ident" id="4630497">Fprintf</span><span class="op" id="4630504">(</span><span class="ident" id="4630505">w</span><span class="op" id="4630506">,</span>&nbsp;<span class="string" id="4630508">&#34;#&nbsp;Stack&nbsp;=&nbsp;%d&nbsp;/&nbsp;%d\n&#34;</span><span class="op" id="4630529">,</span>&nbsp;<span class="ident" id="4630531">s</span><span class="op" id="4630532">.</span><span class="ident" id="4630533">StackInuse</span><span class="op" id="4630543">,</span>&nbsp;<span class="ident" id="4630545">s</span><span class="op" id="4630546">.</span><span class="ident" id="4630547">StackSys</span><span class="op" id="4630555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4630559">fmt</span><span class="op" id="4630562">.</span><span class="ident" id="4630563">Fprintf</span><span class="op" id="4630570">(</span><span class="ident" id="4630571">w</span><span class="op" id="4630572">,</span>&nbsp;<span class="string" id="4630574">&#34;#&nbsp;MSpan&nbsp;=&nbsp;%d&nbsp;/&nbsp;%d\n&#34;</span><span class="op" id="4630595">,</span>&nbsp;<span class="ident" id="4630597">s</span><span class="op" id="4630598">.</span><span class="ident" id="4630599">MSpanInuse</span><span class="op" id="4630609">,</span>&nbsp;<span class="ident" id="4630611">s</span><span class="op" id="4630612">.</span><span class="ident" id="4630613">MSpanSys</span><span class="op" id="4630621">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4630625">fmt</span><span class="op" id="4630628">.</span><span class="ident" id="4630629">Fprintf</span><span class="op" id="4630636">(</span><span class="ident" id="4630637">w</span><span class="op" id="4630638">,</span>&nbsp;<span class="string" id="4630640">&#34;#&nbsp;MCache&nbsp;=&nbsp;%d&nbsp;/&nbsp;%d\n&#34;</span><span class="op" id="4630662">,</span>&nbsp;<span class="ident" id="4630664">s</span><span class="op" id="4630665">.</span><span class="ident" id="4630666">MCacheInuse</span><span class="op" id="4630677">,</span>&nbsp;<span class="ident" id="4630679">s</span><span class="op" id="4630680">.</span><span class="ident" id="4630681">MCacheSys</span><span class="op" id="4630690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4630694">fmt</span><span class="op" id="4630697">.</span><span class="ident" id="4630698">Fprintf</span><span class="op" id="4630705">(</span><span class="ident" id="4630706">w</span><span class="op" id="4630707">,</span>&nbsp;<span class="string" id="4630709">&#34;#&nbsp;BuckHashSys&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="4630731">,</span>&nbsp;<span class="ident" id="4630733">s</span><span class="op" id="4630734">.</span><span class="ident" id="4630735">BuckHashSys</span><span class="op" id="4630746">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4630751">fmt</span><span class="op" id="4630754">.</span><span class="ident" id="4630755">Fprintf</span><span class="op" id="4630762">(</span><span class="ident" id="4630763">w</span><span class="op" id="4630764">,</span>&nbsp;<span class="string" id="4630766">&#34;#&nbsp;NextGC&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="4630783">,</span>&nbsp;<span class="ident" id="4630785">s</span><span class="op" id="4630786">.</span><span class="ident" id="4630787">NextGC</span><span class="op" id="4630793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4630797">fmt</span><span class="op" id="4630800">.</span><span class="ident" id="4630801">Fprintf</span><span class="op" id="4630808">(</span><span class="ident" id="4630809">w</span><span class="op" id="4630810">,</span>&nbsp;<span class="string" id="4630812">&#34;#&nbsp;PauseNs&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="4630830">,</span>&nbsp;<span class="ident" id="4630832">s</span><span class="op" id="4630833">.</span><span class="ident" id="4630834">PauseNs</span><span class="op" id="4630841">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4630845">fmt</span><span class="op" id="4630848">.</span><span class="ident" id="4630849">Fprintf</span><span class="op" id="4630856">(</span><span class="ident" id="4630857">w</span><span class="op" id="4630858">,</span>&nbsp;<span class="string" id="4630860">&#34;#&nbsp;NumGC&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="4630876">,</span>&nbsp;<span class="ident" id="4630878">s</span><span class="op" id="4630879">.</span><span class="ident" id="4630880">NumGC</span><span class="op" id="4630885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4630889">fmt</span><span class="op" id="4630892">.</span><span class="ident" id="4630893">Fprintf</span><span class="op" id="4630900">(</span><span class="ident" id="4630901">w</span><span class="op" id="4630902">,</span>&nbsp;<span class="string" id="4630904">&#34;#&nbsp;EnableGC&nbsp;=&nbsp;%v\n&#34;</span><span class="op" id="4630923">,</span>&nbsp;<span class="ident" id="4630925">s</span><span class="op" id="4630926">.</span><span class="ident" id="4630927">EnableGC</span><span class="op" id="4630935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4630939">fmt</span><span class="op" id="4630942">.</span><span class="ident" id="4630943">Fprintf</span><span class="op" id="4630950">(</span><span class="ident" id="4630951">w</span><span class="op" id="4630952">,</span>&nbsp;<span class="string" id="4630954">&#34;#&nbsp;DebugGC&nbsp;=&nbsp;%v\n&#34;</span><span class="op" id="4630972">,</span>&nbsp;<span class="ident" id="4630974">s</span><span class="op" id="4630975">.</span><span class="ident" id="4630976">DebugGC</span><span class="op" id="4630983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4630986">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4630990">if</span>&nbsp;<span class="ident" id="4630993">tw</span>&nbsp;<span class="op" id="4630996">!=</span>&nbsp;<span class="ident" id="4630999">nil</span>&nbsp;<span class="op" id="4631003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4631007">tw</span><span class="op" id="4631009">.</span><span class="ident" id="4631010">Flush</span><span class="op" id="4631015">(</span><span class="op" id="4631016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4631019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4631022">return</span>&nbsp;<span class="ident" id="4631029">b</span><span class="op" id="4631030">.</span><span class="ident" id="4631031">Flush</span><span class="op" id="4631036">(</span><span class="op" id="4631037">)</span><br>
<span class="lineno"></span><span class="op" id="4631039">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="4631042">//&nbsp;countThreadCreate&nbsp;returns&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;current&nbsp;ThreadCreateProfile.</span><br>
<span class="lineno"></span><span class="keyword" id="4631116">func</span>&nbsp;<span class="ident" id="4631121">countThreadCreate</span><span class="op" id="4631138">(</span><span class="op" id="4631139">)</span>&nbsp;<span class="builtintype" id="4631141">int</span>&nbsp;<span class="op" id="4631145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4631148">n</span><span class="op" id="4631149">,</span>&nbsp;<span class="ident" id="4631151">_</span>&nbsp;<span class="op" id="4631153">:=</span>&nbsp;<span class="ident" id="4631156">runtime</span><span class="op" id="4631163">.</span><span class="ident" id="4631164">ThreadCreateProfile</span><span class="op" id="4631183">(</span><span class="ident" id="4631184">nil</span><span class="op" id="4631187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4631190">return</span>&nbsp;<span class="ident" id="4631197">n</span><br>
<span class="lineno">485</span><span class="op" id="4631199">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4631202">//&nbsp;writeThreadCreate&nbsp;writes&nbsp;the&nbsp;current&nbsp;runtime&nbsp;ThreadCreateProfile&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="keyword" id="4631276">func</span>&nbsp;<span class="ident" id="4631281">writeThreadCreate</span><span class="op" id="4631298">(</span><span class="ident" id="4631299">w</span>&nbsp;<span class="ident" id="4631301">io</span><span class="op" id="4631303">.</span><span class="ident" id="4631304">Writer</span><span class="op" id="4631310">,</span>&nbsp;<span class="ident" id="4631312">debug</span>&nbsp;<span class="builtintype" id="4631318">int</span><span class="op" id="4631321">)</span>&nbsp;<span class="builtintype" id="4631323">error</span>&nbsp;<span class="op" id="4631329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4631332">return</span>&nbsp;<span class="ident" id="4631339">writeRuntimeProfile</span><span class="op" id="4631358">(</span><span class="ident" id="4631359">w</span><span class="op" id="4631360">,</span>&nbsp;<span class="ident" id="4631362">debug</span><span class="op" id="4631367">,</span>&nbsp;<span class="string" id="4631369">&#34;threadcreate&#34;</span><span class="op" id="4631383">,</span>&nbsp;<span class="ident" id="4631385">runtime</span><span class="op" id="4631392">.</span><span class="ident" id="4631393">ThreadCreateProfile</span><span class="op" id="4631412">)</span><br>
<span class="lineno">490</span><span class="op" id="4631414">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4631417">//&nbsp;countGoroutine&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="4631469">func</span>&nbsp;<span class="ident" id="4631474">countGoroutine</span><span class="op" id="4631488">(</span><span class="op" id="4631489">)</span>&nbsp;<span class="builtintype" id="4631491">int</span>&nbsp;<span class="op" id="4631495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4631498">return</span>&nbsp;<span class="ident" id="4631505">runtime</span><span class="op" id="4631512">.</span><span class="ident" id="4631513">NumGoroutine</span><span class="op" id="4631525">(</span><span class="op" id="4631526">)</span><br>
<span class="lineno">495</span><span class="op" id="4631528">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4631531">//&nbsp;writeGoroutine&nbsp;writes&nbsp;the&nbsp;current&nbsp;runtime&nbsp;GoroutineProfile&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="keyword" id="4631599">func</span>&nbsp;<span class="ident" id="4631604">writeGoroutine</span><span class="op" id="4631618">(</span><span class="ident" id="4631619">w</span>&nbsp;<span class="ident" id="4631621">io</span><span class="op" id="4631623">.</span><span class="ident" id="4631624">Writer</span><span class="op" id="4631630">,</span>&nbsp;<span class="ident" id="4631632">debug</span>&nbsp;<span class="builtintype" id="4631638">int</span><span class="op" id="4631641">)</span>&nbsp;<span class="builtintype" id="4631643">error</span>&nbsp;<span class="op" id="4631649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4631652">if</span>&nbsp;<span class="ident" id="4631655">debug</span>&nbsp;<span class="op" id="4631661">&gt;=</span>&nbsp;<span class="num" id="4631664">2</span>&nbsp;<span class="op" id="4631666">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4631670">return</span>&nbsp;<span class="ident" id="4631677">writeGoroutineStacks</span><span class="op" id="4631697">(</span><span class="ident" id="4631698">w</span><span class="op" id="4631699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4631702">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4631705">return</span>&nbsp;<span class="ident" id="4631712">writeRuntimeProfile</span><span class="op" id="4631731">(</span><span class="ident" id="4631732">w</span><span class="op" id="4631733">,</span>&nbsp;<span class="ident" id="4631735">debug</span><span class="op" id="4631740">,</span>&nbsp;<span class="string" id="4631742">&#34;goroutine&#34;</span><span class="op" id="4631753">,</span>&nbsp;<span class="ident" id="4631755">runtime</span><span class="op" id="4631762">.</span><span class="ident" id="4631763">GoroutineProfile</span><span class="op" id="4631779">)</span><br>
<span class="lineno"></span><span class="op" id="4631781">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span><span class="keyword" id="4631784">func</span>&nbsp;<span class="ident" id="4631789">writeGoroutineStacks</span><span class="op" id="4631809">(</span><span class="ident" id="4631810">w</span>&nbsp;<span class="ident" id="4631812">io</span><span class="op" id="4631814">.</span><span class="ident" id="4631815">Writer</span><span class="op" id="4631821">)</span>&nbsp;<span class="builtintype" id="4631823">error</span>&nbsp;<span class="op" id="4631829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4631832">//&nbsp;We&nbsp;don&#39;t&nbsp;know&nbsp;how&nbsp;big&nbsp;the&nbsp;buffer&nbsp;needs&nbsp;to&nbsp;be&nbsp;to&nbsp;collect</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4631892">//&nbsp;all&nbsp;the&nbsp;goroutines.&nbsp;&nbsp;Start&nbsp;with&nbsp;1&nbsp;MB&nbsp;and&nbsp;try&nbsp;a&nbsp;few&nbsp;times,&nbsp;doubling&nbsp;each&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4631974">//&nbsp;Give&nbsp;up&nbsp;and&nbsp;use&nbsp;a&nbsp;truncated&nbsp;trace&nbsp;if&nbsp;64&nbsp;MB&nbsp;is&nbsp;not&nbsp;enough.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4632036">buf</span>&nbsp;<span class="op" id="4632040">:=</span>&nbsp;<span class="builtinfunc" id="4632043">make</span><span class="op" id="4632047">(</span><span class="op" id="4632048">[</span><span class="op" id="4632049">]</span><span class="builtintype" id="4632050">byte</span><span class="op" id="4632054">,</span>&nbsp;<span class="num" id="4632056">1</span><span class="op" id="4632057">&lt;&lt;</span><span class="num" id="4632059">20</span><span class="op" id="4632061">)</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4632064">for</span>&nbsp;<span class="ident" id="4632068">i</span>&nbsp;<span class="op" id="4632070">:=</span>&nbsp;<span class="num" id="4632073">0</span><span class="op" id="4632074">;</span>&nbsp;<span class="op" id="4632076">;</span>&nbsp;<span class="ident" id="4632078">i</span><span class="op" id="4632079">++</span>&nbsp;<span class="op" id="4632082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4632086">n</span>&nbsp;<span class="op" id="4632088">:=</span>&nbsp;<span class="ident" id="4632091">runtime</span><span class="op" id="4632098">.</span><span class="ident" id="4632099">Stack</span><span class="op" id="4632104">(</span><span class="ident" id="4632105">buf</span><span class="op" id="4632108">,</span>&nbsp;<span class="builtintype" id="4632110">true</span><span class="op" id="4632114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4632118">if</span>&nbsp;<span class="ident" id="4632121">n</span>&nbsp;<span class="op" id="4632123">&lt;</span>&nbsp;<span class="builtinfunc" id="4632125">len</span><span class="op" id="4632128">(</span><span class="ident" id="4632129">buf</span><span class="op" id="4632132">)</span>&nbsp;<span class="op" id="4632134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4632139">buf</span>&nbsp;<span class="op" id="4632143">=</span>&nbsp;<span class="ident" id="4632145">buf</span><span class="op" id="4632148">[</span><span class="op" id="4632149">:</span><span class="ident" id="4632150">n</span><span class="op" id="4632151">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4632156">break</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4632164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4632168">if</span>&nbsp;<span class="builtinfunc" id="4632171">len</span><span class="op" id="4632174">(</span><span class="ident" id="4632175">buf</span><span class="op" id="4632178">)</span>&nbsp;<span class="op" id="4632180">&gt;=</span>&nbsp;<span class="num" id="4632183">64</span><span class="op" id="4632185">&lt;&lt;</span><span class="num" id="4632187">20</span>&nbsp;<span class="op" id="4632190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4632195">//&nbsp;Filled&nbsp;64&nbsp;MB&nbsp;-&nbsp;stop&nbsp;there.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4632228">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4632236">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4632240">buf</span>&nbsp;<span class="op" id="4632244">=</span>&nbsp;<span class="builtinfunc" id="4632246">make</span><span class="op" id="4632250">(</span><span class="op" id="4632251">[</span><span class="op" id="4632252">]</span><span class="builtintype" id="4632253">byte</span><span class="op" id="4632257">,</span>&nbsp;<span class="num" id="4632259">2</span><span class="op" id="4632260">*</span><span class="builtinfunc" id="4632261">len</span><span class="op" id="4632264">(</span><span class="ident" id="4632265">buf</span><span class="op" id="4632268">)</span><span class="op" id="4632269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4632272">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4632275">_</span><span class="op" id="4632276">,</span>&nbsp;<span class="ident" id="4632278">err</span>&nbsp;<span class="op" id="4632282">:=</span>&nbsp;<span class="ident" id="4632285">w</span><span class="op" id="4632286">.</span><span class="ident" id="4632287">Write</span><span class="op" id="4632292">(</span><span class="ident" id="4632293">buf</span><span class="op" id="4632296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4632299">return</span>&nbsp;<span class="ident" id="4632306">err</span><br>
<span class="lineno"></span><span class="op" id="4632310">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span><span class="keyword" id="4632313">func</span>&nbsp;<span class="ident" id="4632318">writeRuntimeProfile</span><span class="op" id="4632337">(</span><span class="ident" id="4632338">w</span>&nbsp;<span class="ident" id="4632340">io</span><span class="op" id="4632342">.</span><span class="ident" id="4632343">Writer</span><span class="op" id="4632349">,</span>&nbsp;<span class="ident" id="4632351">debug</span>&nbsp;<span class="builtintype" id="4632357">int</span><span class="op" id="4632360">,</span>&nbsp;<span class="ident" id="4632362">name</span>&nbsp;<span class="builtintype" id="4632367">string</span><span class="op" id="4632373">,</span>&nbsp;<span class="ident" id="4632375">fetch</span>&nbsp;<span class="keyword" id="4632381">func</span><span class="op" id="4632385">(</span><span class="op" id="4632386">[</span><span class="op" id="4632387">]</span><span class="ident" id="4632388">runtime</span><span class="op" id="4632395">.</span><span class="ident" id="4632396">StackRecord</span><span class="op" id="4632407">)</span>&nbsp;<span class="op" id="4632409">(</span><span class="builtintype" id="4632410">int</span><span class="op" id="4632413">,</span>&nbsp;<span class="builtintype" id="4632415">bool</span><span class="op" id="4632419">)</span><span class="op" id="4632420">)</span>&nbsp;<span class="builtintype" id="4632422">error</span>&nbsp;<span class="op" id="4632428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4632431">//&nbsp;Find&nbsp;out&nbsp;how&nbsp;many&nbsp;records&nbsp;there&nbsp;are&nbsp;(fetch(nil)),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4632485">//&nbsp;allocate&nbsp;that&nbsp;many&nbsp;records,&nbsp;and&nbsp;get&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4632535">//&nbsp;There&#39;s&nbsp;a&nbsp;race—more&nbsp;records&nbsp;might&nbsp;be&nbsp;added&nbsp;between</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4632592">//&nbsp;the&nbsp;two&nbsp;calls—so&nbsp;allocate&nbsp;a&nbsp;few&nbsp;extra&nbsp;records&nbsp;for&nbsp;safety</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4632655">//&nbsp;and&nbsp;also&nbsp;try&nbsp;again&nbsp;if&nbsp;we&#39;re&nbsp;very&nbsp;unlucky.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4632701">//&nbsp;The&nbsp;loop&nbsp;should&nbsp;only&nbsp;execute&nbsp;one&nbsp;iteration&nbsp;in&nbsp;the&nbsp;common&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4632768">var</span>&nbsp;<span class="ident" id="4632772">p</span>&nbsp;<span class="op" id="4632774">[</span><span class="op" id="4632775">]</span><span class="ident" id="4632776">runtime</span><span class="op" id="4632783">.</span><span class="ident" id="4632784">StackRecord</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4632797">n</span><span class="op" id="4632798">,</span>&nbsp;<span class="ident" id="4632800">ok</span>&nbsp;<span class="op" id="4632803">:=</span>&nbsp;<span class="ident" id="4632806">fetch</span><span class="op" id="4632811">(</span><span class="ident" id="4632812">nil</span><span class="op" id="4632815">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4632818">for</span>&nbsp;<span class="op" id="4632822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4632826">//&nbsp;Allocate&nbsp;room&nbsp;for&nbsp;a&nbsp;slightly&nbsp;bigger&nbsp;profile,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4632876">//&nbsp;in&nbsp;case&nbsp;a&nbsp;few&nbsp;more&nbsp;entries&nbsp;have&nbsp;been&nbsp;added</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4632924">//&nbsp;since&nbsp;the&nbsp;call&nbsp;to&nbsp;ThreadProfile.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4632962">p</span>&nbsp;<span class="op" id="4632964">=</span>&nbsp;<span class="builtinfunc" id="4632966">make</span><span class="op" id="4632970">(</span><span class="op" id="4632971">[</span><span class="op" id="4632972">]</span><span class="ident" id="4632973">runtime</span><span class="op" id="4632980">.</span><span class="ident" id="4632981">StackRecord</span><span class="op" id="4632992">,</span>&nbsp;<span class="ident" id="4632994">n</span><span class="op" id="4632995">+</span><span class="num" id="4632996">10</span><span class="op" id="4632998">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4633002">n</span><span class="op" id="4633003">,</span>&nbsp;<span class="ident" id="4633005">ok</span>&nbsp;<span class="op" id="4633008">=</span>&nbsp;<span class="ident" id="4633010">fetch</span><span class="op" id="4633015">(</span><span class="ident" id="4633016">p</span><span class="op" id="4633017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4633021">if</span>&nbsp;<span class="ident" id="4633024">ok</span>&nbsp;<span class="op" id="4633027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4633032">p</span>&nbsp;<span class="op" id="4633034">=</span>&nbsp;<span class="ident" id="4633036">p</span><span class="op" id="4633037">[</span><span class="num" id="4633038">0</span><span class="op" id="4633039">:</span><span class="ident" id="4633040">n</span><span class="op" id="4633041">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4633046">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4633054">}</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4633058">//&nbsp;Profile&nbsp;grew;&nbsp;try&nbsp;again.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4633087">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4633091">return</span>&nbsp;<span class="ident" id="4633098">printCountProfile</span><span class="op" id="4633115">(</span><span class="ident" id="4633116">w</span><span class="op" id="4633117">,</span>&nbsp;<span class="ident" id="4633119">debug</span><span class="op" id="4633124">,</span>&nbsp;<span class="ident" id="4633126">name</span><span class="op" id="4633130">,</span>&nbsp;<span class="ident" id="4633132">runtimeProfile</span><span class="op" id="4633146">(</span><span class="ident" id="4633147">p</span><span class="op" id="4633148">)</span><span class="op" id="4633149">)</span><br>
<span class="lineno"></span><span class="op" id="4633151">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="keyword" id="4633154">type</span>&nbsp;<span class="ident" id="4633159">runtimeProfile</span>&nbsp;<span class="op" id="4633174">[</span><span class="op" id="4633175">]</span><span class="ident" id="4633176">runtime</span><span class="op" id="4633183">.</span><span class="ident" id="4633184">StackRecord</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4633197">func</span>&nbsp;<span class="op" id="4633202">(</span><span class="ident" id="4633203">p</span>&nbsp;<span class="ident" id="4633205">runtimeProfile</span><span class="op" id="4633219">)</span>&nbsp;<span class="ident" id="4633221">Len</span><span class="op" id="4633224">(</span><span class="op" id="4633225">)</span>&nbsp;<span class="builtintype" id="4633227">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4633244">{</span>&nbsp;<span class="keyword" id="4633246">return</span>&nbsp;<span class="builtinfunc" id="4633253">len</span><span class="op" id="4633256">(</span><span class="ident" id="4633257">p</span><span class="op" id="4633258">)</span>&nbsp;<span class="op" id="4633260">}</span><br>
<span class="lineno"></span><span class="keyword" id="4633262">func</span>&nbsp;<span class="op" id="4633267">(</span><span class="ident" id="4633268">p</span>&nbsp;<span class="ident" id="4633270">runtimeProfile</span><span class="op" id="4633284">)</span>&nbsp;<span class="ident" id="4633286">Stack</span><span class="op" id="4633291">(</span><span class="ident" id="4633292">i</span>&nbsp;<span class="builtintype" id="4633294">int</span><span class="op" id="4633297">)</span>&nbsp;<span class="op" id="4633299">[</span><span class="op" id="4633300">]</span><span class="builtintype" id="4633301">uintptr</span>&nbsp;<span class="op" id="4633309">{</span>&nbsp;<span class="keyword" id="4633311">return</span>&nbsp;<span class="ident" id="4633318">p</span><span class="op" id="4633319">[</span><span class="ident" id="4633320">i</span><span class="op" id="4633321">]</span><span class="op" id="4633322">.</span><span class="ident" id="4633323">Stack</span><span class="op" id="4633328">(</span><span class="op" id="4633329">)</span>&nbsp;<span class="op" id="4633331">}</span><br>
<span class="lineno">555</span><br>
<span class="lineno"></span><span class="keyword" id="4633334">var</span>&nbsp;<span class="ident" id="4633338">cpu</span>&nbsp;<span class="keyword" id="4633342">struct</span>&nbsp;<span class="op" id="4633349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4633352">sync</span><span class="op" id="4633356">.</span><span class="ident" id="4633357">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4633364">profiling</span>&nbsp;<span class="builtintype" id="4633374">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4633380">done</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4633390">chan</span>&nbsp;<span class="builtintype" id="4633395">bool</span><br>
<span class="lineno">560</span><span class="op" id="4633400">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4633403">//&nbsp;StartCPUProfile&nbsp;enables&nbsp;CPU&nbsp;profiling&nbsp;for&nbsp;the&nbsp;current&nbsp;process.</span><br>
<span class="lineno"></span><span class="comment" id="4633469">//&nbsp;While&nbsp;profiling,&nbsp;the&nbsp;profile&nbsp;will&nbsp;be&nbsp;buffered&nbsp;and&nbsp;written&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="comment" id="4633536">//&nbsp;StartCPUProfile&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;profiling&nbsp;is&nbsp;already&nbsp;enabled.</span><br>
<span class="lineno">565</span><span class="keyword" id="4633605">func</span>&nbsp;<span class="ident" id="4633610">StartCPUProfile</span><span class="op" id="4633625">(</span><span class="ident" id="4633626">w</span>&nbsp;<span class="ident" id="4633628">io</span><span class="op" id="4633630">.</span><span class="ident" id="4633631">Writer</span><span class="op" id="4633637">)</span>&nbsp;<span class="builtintype" id="4633639">error</span>&nbsp;<span class="op" id="4633645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4633648">//&nbsp;The&nbsp;runtime&nbsp;routines&nbsp;allow&nbsp;a&nbsp;variable&nbsp;profiling&nbsp;rate,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4633706">//&nbsp;but&nbsp;in&nbsp;practice&nbsp;operating&nbsp;systems&nbsp;cannot&nbsp;trigger&nbsp;signals</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4633767">//&nbsp;at&nbsp;more&nbsp;than&nbsp;about&nbsp;500&nbsp;Hz,&nbsp;and&nbsp;our&nbsp;processing&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4633824">//&nbsp;signal&nbsp;is&nbsp;not&nbsp;cheap&nbsp;(mostly&nbsp;getting&nbsp;the&nbsp;stack&nbsp;trace).</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4633882">//&nbsp;100&nbsp;Hz&nbsp;is&nbsp;a&nbsp;reasonable&nbsp;choice:&nbsp;it&nbsp;is&nbsp;frequent&nbsp;enough&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4633942">//&nbsp;produce&nbsp;useful&nbsp;data,&nbsp;rare&nbsp;enough&nbsp;not&nbsp;to&nbsp;bog&nbsp;down&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4633999">//&nbsp;system,&nbsp;and&nbsp;a&nbsp;nice&nbsp;round&nbsp;number&nbsp;to&nbsp;make&nbsp;it&nbsp;easy&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4634054">//&nbsp;convert&nbsp;sample&nbsp;counts&nbsp;to&nbsp;seconds.&nbsp;&nbsp;Instead&nbsp;of&nbsp;requiring</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4634114">//&nbsp;each&nbsp;client&nbsp;to&nbsp;specify&nbsp;the&nbsp;frequency,&nbsp;we&nbsp;hard&nbsp;code&nbsp;it.</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4634173">const</span>&nbsp;<span class="ident" id="4634179">hz</span>&nbsp;<span class="op" id="4634182">=</span>&nbsp;<span class="num" id="4634184">100</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4634190">cpu</span><span class="op" id="4634193">.</span><span class="ident" id="4634194">Lock</span><span class="op" id="4634198">(</span><span class="op" id="4634199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4634202">defer</span>&nbsp;<span class="ident" id="4634208">cpu</span><span class="op" id="4634211">.</span><span class="ident" id="4634212">Unlock</span><span class="op" id="4634218">(</span><span class="op" id="4634219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4634222">if</span>&nbsp;<span class="ident" id="4634225">cpu</span><span class="op" id="4634228">.</span><span class="ident" id="4634229">done</span>&nbsp;<span class="op" id="4634234">==</span>&nbsp;<span class="ident" id="4634237">nil</span>&nbsp;<span class="op" id="4634241">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4634245">cpu</span><span class="op" id="4634248">.</span><span class="ident" id="4634249">done</span>&nbsp;<span class="op" id="4634254">=</span>&nbsp;<span class="builtinfunc" id="4634256">make</span><span class="op" id="4634260">(</span><span class="keyword" id="4634261">chan</span>&nbsp;<span class="builtintype" id="4634266">bool</span><span class="op" id="4634270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4634273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4634276">//&nbsp;Double-check.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4634294">if</span>&nbsp;<span class="ident" id="4634297">cpu</span><span class="op" id="4634300">.</span><span class="ident" id="4634301">profiling</span>&nbsp;<span class="op" id="4634311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4634315">return</span>&nbsp;<span class="ident" id="4634322">fmt</span><span class="op" id="4634325">.</span><span class="ident" id="4634326">Errorf</span><span class="op" id="4634332">(</span><span class="string" id="4634333">&#34;cpu&nbsp;profiling&nbsp;already&nbsp;in&nbsp;use&#34;</span><span class="op" id="4634363">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4634366">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4634369">cpu</span><span class="op" id="4634372">.</span><span class="ident" id="4634373">profiling</span>&nbsp;<span class="op" id="4634383">=</span>&nbsp;<span class="builtintype" id="4634385">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4634391">runtime</span><span class="op" id="4634398">.</span><span class="ident" id="4634399">SetCPUProfileRate</span><span class="op" id="4634416">(</span><span class="ident" id="4634417">hz</span><span class="op" id="4634419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4634422">go</span>&nbsp;<span class="ident" id="4634425">profileWriter</span><span class="op" id="4634438">(</span><span class="ident" id="4634439">w</span><span class="op" id="4634440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4634443">return</span>&nbsp;<span class="ident" id="4634450">nil</span><br>
<span class="lineno">590</span><span class="op" id="4634454">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4634457">func</span>&nbsp;<span class="ident" id="4634462">profileWriter</span><span class="op" id="4634475">(</span><span class="ident" id="4634476">w</span>&nbsp;<span class="ident" id="4634478">io</span><span class="op" id="4634480">.</span><span class="ident" id="4634481">Writer</span><span class="op" id="4634487">)</span>&nbsp;<span class="op" id="4634489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4634492">for</span>&nbsp;<span class="op" id="4634496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4634500">data</span>&nbsp;<span class="op" id="4634505">:=</span>&nbsp;<span class="ident" id="4634508">runtime</span><span class="op" id="4634515">.</span><span class="ident" id="4634516">CPUProfile</span><span class="op" id="4634526">(</span><span class="op" id="4634527">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4634531">if</span>&nbsp;<span class="ident" id="4634534">data</span>&nbsp;<span class="op" id="4634539">==</span>&nbsp;<span class="ident" id="4634542">nil</span>&nbsp;<span class="op" id="4634546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4634551">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4634559">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4634563">w</span><span class="op" id="4634564">.</span><span class="ident" id="4634565">Write</span><span class="op" id="4634570">(</span><span class="ident" id="4634571">data</span><span class="op" id="4634575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4634578">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4634581">cpu</span><span class="op" id="4634584">.</span><span class="ident" id="4634585">done</span>&nbsp;<span class="op" id="4634590">&lt;-</span>&nbsp;<span class="builtintype" id="4634593">true</span><br>
<span class="lineno"></span><span class="op" id="4634598">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4634601">//&nbsp;StopCPUProfile&nbsp;stops&nbsp;the&nbsp;current&nbsp;CPU&nbsp;profile,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span><span class="comment" id="4634658">//&nbsp;StopCPUProfile&nbsp;only&nbsp;returns&nbsp;after&nbsp;all&nbsp;the&nbsp;writes&nbsp;for&nbsp;the</span><br>
<span class="lineno">605</span><span class="comment" id="4634718">//&nbsp;profile&nbsp;have&nbsp;completed.</span><br>
<span class="lineno"></span><span class="keyword" id="4634745">func</span>&nbsp;<span class="ident" id="4634750">StopCPUProfile</span><span class="op" id="4634764">(</span><span class="op" id="4634765">)</span>&nbsp;<span class="op" id="4634767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4634770">cpu</span><span class="op" id="4634773">.</span><span class="ident" id="4634774">Lock</span><span class="op" id="4634778">(</span><span class="op" id="4634779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4634782">defer</span>&nbsp;<span class="ident" id="4634788">cpu</span><span class="op" id="4634791">.</span><span class="ident" id="4634792">Unlock</span><span class="op" id="4634798">(</span><span class="op" id="4634799">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4634803">if</span>&nbsp;<span class="op" id="4634806">!</span><span class="ident" id="4634807">cpu</span><span class="op" id="4634810">.</span><span class="ident" id="4634811">profiling</span>&nbsp;<span class="op" id="4634821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4634825">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4634833">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4634836">cpu</span><span class="op" id="4634839">.</span><span class="ident" id="4634840">profiling</span>&nbsp;<span class="op" id="4634850">=</span>&nbsp;<span class="builtintype" id="4634852">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4634859">runtime</span><span class="op" id="4634866">.</span><span class="ident" id="4634867">SetCPUProfileRate</span><span class="op" id="4634884">(</span><span class="num" id="4634885">0</span><span class="op" id="4634886">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4634889">&lt;-</span><span class="ident" id="4634891">cpu</span><span class="op" id="4634894">.</span><span class="ident" id="4634895">done</span><br>
<span class="lineno"></span><span class="op" id="4634900">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4634903">type</span>&nbsp;<span class="ident" id="4634908">byCycles</span>&nbsp;<span class="op" id="4634917">[</span><span class="op" id="4634918">]</span><span class="ident" id="4634919">runtime</span><span class="op" id="4634926">.</span><span class="ident" id="4634927">BlockProfileRecord</span><br>
<span class="lineno"></span><br>
<span class="lineno">620</span><span class="keyword" id="4634947">func</span>&nbsp;<span class="op" id="4634952">(</span><span class="ident" id="4634953">x</span>&nbsp;<span class="ident" id="4634955">byCycles</span><span class="op" id="4634963">)</span>&nbsp;<span class="ident" id="4634965">Len</span><span class="op" id="4634968">(</span><span class="op" id="4634969">)</span>&nbsp;<span class="builtintype" id="4634971">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4634985">{</span>&nbsp;<span class="keyword" id="4634987">return</span>&nbsp;<span class="builtinfunc" id="4634994">len</span><span class="op" id="4634997">(</span><span class="ident" id="4634998">x</span><span class="op" id="4634999">)</span>&nbsp;<span class="op" id="4635001">}</span><br>
<span class="lineno"></span><span class="keyword" id="4635003">func</span>&nbsp;<span class="op" id="4635008">(</span><span class="ident" id="4635009">x</span>&nbsp;<span class="ident" id="4635011">byCycles</span><span class="op" id="4635019">)</span>&nbsp;<span class="ident" id="4635021">Swap</span><span class="op" id="4635025">(</span><span class="ident" id="4635026">i</span><span class="op" id="4635027">,</span>&nbsp;<span class="ident" id="4635029">j</span>&nbsp;<span class="builtintype" id="4635031">int</span><span class="op" id="4635034">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4635041">{</span>&nbsp;<span class="ident" id="4635043">x</span><span class="op" id="4635044">[</span><span class="ident" id="4635045">i</span><span class="op" id="4635046">]</span><span class="op" id="4635047">,</span>&nbsp;<span class="ident" id="4635049">x</span><span class="op" id="4635050">[</span><span class="ident" id="4635051">j</span><span class="op" id="4635052">]</span>&nbsp;<span class="op" id="4635054">=</span>&nbsp;<span class="ident" id="4635056">x</span><span class="op" id="4635057">[</span><span class="ident" id="4635058">j</span><span class="op" id="4635059">]</span><span class="op" id="4635060">,</span>&nbsp;<span class="ident" id="4635062">x</span><span class="op" id="4635063">[</span><span class="ident" id="4635064">i</span><span class="op" id="4635065">]</span>&nbsp;<span class="op" id="4635067">}</span><br>
<span class="lineno"></span><span class="keyword" id="4635069">func</span>&nbsp;<span class="op" id="4635074">(</span><span class="ident" id="4635075">x</span>&nbsp;<span class="ident" id="4635077">byCycles</span><span class="op" id="4635085">)</span>&nbsp;<span class="ident" id="4635087">Less</span><span class="op" id="4635091">(</span><span class="ident" id="4635092">i</span><span class="op" id="4635093">,</span>&nbsp;<span class="ident" id="4635095">j</span>&nbsp;<span class="builtintype" id="4635097">int</span><span class="op" id="4635100">)</span>&nbsp;<span class="builtintype" id="4635102">bool</span>&nbsp;<span class="op" id="4635107">{</span>&nbsp;<span class="keyword" id="4635109">return</span>&nbsp;<span class="ident" id="4635116">x</span><span class="op" id="4635117">[</span><span class="ident" id="4635118">i</span><span class="op" id="4635119">]</span><span class="op" id="4635120">.</span><span class="ident" id="4635121">Cycles</span>&nbsp;<span class="op" id="4635128">&gt;</span>&nbsp;<span class="ident" id="4635130">x</span><span class="op" id="4635131">[</span><span class="ident" id="4635132">j</span><span class="op" id="4635133">]</span><span class="op" id="4635134">.</span><span class="ident" id="4635135">Cycles</span>&nbsp;<span class="op" id="4635142">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4635145">//&nbsp;countBlock&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;blocking&nbsp;profile.</span><br>
<span class="lineno">625</span><span class="keyword" id="4635214">func</span>&nbsp;<span class="ident" id="4635219">countBlock</span><span class="op" id="4635229">(</span><span class="op" id="4635230">)</span>&nbsp;<span class="builtintype" id="4635232">int</span>&nbsp;<span class="op" id="4635236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4635239">n</span><span class="op" id="4635240">,</span>&nbsp;<span class="ident" id="4635242">_</span>&nbsp;<span class="op" id="4635244">:=</span>&nbsp;<span class="ident" id="4635247">runtime</span><span class="op" id="4635254">.</span><span class="ident" id="4635255">BlockProfile</span><span class="op" id="4635267">(</span><span class="ident" id="4635268">nil</span><span class="op" id="4635271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4635274">return</span>&nbsp;<span class="ident" id="4635281">n</span><br>
<span class="lineno"></span><span class="op" id="4635283">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span><span class="comment" id="4635286">//&nbsp;writeBlock&nbsp;writes&nbsp;the&nbsp;current&nbsp;blocking&nbsp;profile&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="keyword" id="4635342">func</span>&nbsp;<span class="ident" id="4635347">writeBlock</span><span class="op" id="4635357">(</span><span class="ident" id="4635358">w</span>&nbsp;<span class="ident" id="4635360">io</span><span class="op" id="4635362">.</span><span class="ident" id="4635363">Writer</span><span class="op" id="4635369">,</span>&nbsp;<span class="ident" id="4635371">debug</span>&nbsp;<span class="builtintype" id="4635377">int</span><span class="op" id="4635380">)</span>&nbsp;<span class="builtintype" id="4635382">error</span>&nbsp;<span class="op" id="4635388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4635391">var</span>&nbsp;<span class="ident" id="4635395">p</span>&nbsp;<span class="op" id="4635397">[</span><span class="op" id="4635398">]</span><span class="ident" id="4635399">runtime</span><span class="op" id="4635406">.</span><span class="ident" id="4635407">BlockProfileRecord</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4635427">n</span><span class="op" id="4635428">,</span>&nbsp;<span class="ident" id="4635430">ok</span>&nbsp;<span class="op" id="4635433">:=</span>&nbsp;<span class="ident" id="4635436">runtime</span><span class="op" id="4635443">.</span><span class="ident" id="4635444">BlockProfile</span><span class="op" id="4635456">(</span><span class="ident" id="4635457">nil</span><span class="op" id="4635460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4635463">for</span>&nbsp;<span class="op" id="4635467">{</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4635471">p</span>&nbsp;<span class="op" id="4635473">=</span>&nbsp;<span class="builtinfunc" id="4635475">make</span><span class="op" id="4635479">(</span><span class="op" id="4635480">[</span><span class="op" id="4635481">]</span><span class="ident" id="4635482">runtime</span><span class="op" id="4635489">.</span><span class="ident" id="4635490">BlockProfileRecord</span><span class="op" id="4635508">,</span>&nbsp;<span class="ident" id="4635510">n</span><span class="op" id="4635511">+</span><span class="num" id="4635512">50</span><span class="op" id="4635514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4635518">n</span><span class="op" id="4635519">,</span>&nbsp;<span class="ident" id="4635521">ok</span>&nbsp;<span class="op" id="4635524">=</span>&nbsp;<span class="ident" id="4635526">runtime</span><span class="op" id="4635533">.</span><span class="ident" id="4635534">BlockProfile</span><span class="op" id="4635546">(</span><span class="ident" id="4635547">p</span><span class="op" id="4635548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4635552">if</span>&nbsp;<span class="ident" id="4635555">ok</span>&nbsp;<span class="op" id="4635558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4635563">p</span>&nbsp;<span class="op" id="4635565">=</span>&nbsp;<span class="ident" id="4635567">p</span><span class="op" id="4635568">[</span><span class="op" id="4635569">:</span><span class="ident" id="4635570">n</span><span class="op" id="4635571">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4635576">break</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4635584">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4635587">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4635591">sort</span><span class="op" id="4635595">.</span><span class="ident" id="4635596">Sort</span><span class="op" id="4635600">(</span><span class="ident" id="4635601">byCycles</span><span class="op" id="4635609">(</span><span class="ident" id="4635610">p</span><span class="op" id="4635611">)</span><span class="op" id="4635612">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4635616">b</span>&nbsp;<span class="op" id="4635618">:=</span>&nbsp;<span class="ident" id="4635621">bufio</span><span class="op" id="4635626">.</span><span class="ident" id="4635627">NewWriter</span><span class="op" id="4635636">(</span><span class="ident" id="4635637">w</span><span class="op" id="4635638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4635641">var</span>&nbsp;<span class="ident" id="4635645">tw</span>&nbsp;<span class="op" id="4635648">*</span><span class="ident" id="4635649">tabwriter</span><span class="op" id="4635658">.</span><span class="ident" id="4635659">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4635667">w</span>&nbsp;<span class="op" id="4635669">=</span>&nbsp;<span class="ident" id="4635671">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4635674">if</span>&nbsp;<span class="ident" id="4635677">debug</span>&nbsp;<span class="op" id="4635683">&gt;</span>&nbsp;<span class="num" id="4635685">0</span>&nbsp;<span class="op" id="4635687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4635691">tw</span>&nbsp;<span class="op" id="4635694">=</span>&nbsp;<span class="ident" id="4635696">tabwriter</span><span class="op" id="4635705">.</span><span class="ident" id="4635706">NewWriter</span><span class="op" id="4635715">(</span><span class="ident" id="4635716">w</span><span class="op" id="4635717">,</span>&nbsp;<span class="num" id="4635719">1</span><span class="op" id="4635720">,</span>&nbsp;<span class="num" id="4635722">8</span><span class="op" id="4635723">,</span>&nbsp;<span class="num" id="4635725">1</span><span class="op" id="4635726">,</span>&nbsp;<span class="string" id="4635728">&#39;\t&#39;</span><span class="op" id="4635732">,</span>&nbsp;<span class="num" id="4635734">0</span><span class="op" id="4635735">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4635739">w</span>&nbsp;<span class="op" id="4635741">=</span>&nbsp;<span class="ident" id="4635743">tw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4635747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4635751">fmt</span><span class="op" id="4635754">.</span><span class="ident" id="4635755">Fprintf</span><span class="op" id="4635762">(</span><span class="ident" id="4635763">w</span><span class="op" id="4635764">,</span>&nbsp;<span class="string" id="4635766">&#34;---&nbsp;contention:\n&#34;</span><span class="op" id="4635785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4635788">fmt</span><span class="op" id="4635791">.</span><span class="ident" id="4635792">Fprintf</span><span class="op" id="4635799">(</span><span class="ident" id="4635800">w</span><span class="op" id="4635801">,</span>&nbsp;<span class="string" id="4635803">&#34;cycles/second=%v\n&#34;</span><span class="op" id="4635823">,</span>&nbsp;<span class="ident" id="4635825">runtime_cyclesPerSecond</span><span class="op" id="4635848">(</span><span class="op" id="4635849">)</span><span class="op" id="4635850">)</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4635853">for</span>&nbsp;<span class="ident" id="4635857">i</span>&nbsp;<span class="op" id="4635859">:=</span>&nbsp;<span class="keyword" id="4635862">range</span>&nbsp;<span class="ident" id="4635868">p</span>&nbsp;<span class="op" id="4635870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4635874">r</span>&nbsp;<span class="op" id="4635876">:=</span>&nbsp;<span class="op" id="4635879">&amp;</span><span class="ident" id="4635880">p</span><span class="op" id="4635881">[</span><span class="ident" id="4635882">i</span><span class="op" id="4635883">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4635887">fmt</span><span class="op" id="4635890">.</span><span class="ident" id="4635891">Fprintf</span><span class="op" id="4635898">(</span><span class="ident" id="4635899">w</span><span class="op" id="4635900">,</span>&nbsp;<span class="string" id="4635902">&#34;%v&nbsp;%v&nbsp;@&#34;</span><span class="op" id="4635911">,</span>&nbsp;<span class="ident" id="4635913">r</span><span class="op" id="4635914">.</span><span class="ident" id="4635915">Cycles</span><span class="op" id="4635921">,</span>&nbsp;<span class="ident" id="4635923">r</span><span class="op" id="4635924">.</span><span class="ident" id="4635925">Count</span><span class="op" id="4635930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4635934">for</span>&nbsp;<span class="ident" id="4635938">_</span><span class="op" id="4635939">,</span>&nbsp;<span class="ident" id="4635941">pc</span>&nbsp;<span class="op" id="4635944">:=</span>&nbsp;<span class="keyword" id="4635947">range</span>&nbsp;<span class="ident" id="4635953">r</span><span class="op" id="4635954">.</span><span class="ident" id="4635955">Stack</span><span class="op" id="4635960">(</span><span class="op" id="4635961">)</span>&nbsp;<span class="op" id="4635963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4635968">fmt</span><span class="op" id="4635971">.</span><span class="ident" id="4635972">Fprintf</span><span class="op" id="4635979">(</span><span class="ident" id="4635980">w</span><span class="op" id="4635981">,</span>&nbsp;<span class="string" id="4635983">&#34;&nbsp;%#x&#34;</span><span class="op" id="4635989">,</span>&nbsp;<span class="ident" id="4635991">pc</span><span class="op" id="4635993">)</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4635997">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4636001">fmt</span><span class="op" id="4636004">.</span><span class="ident" id="4636005">Fprint</span><span class="op" id="4636011">(</span><span class="ident" id="4636012">w</span><span class="op" id="4636013">,</span>&nbsp;<span class="string" id="4636015">&#34;\n&#34;</span><span class="op" id="4636019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4636023">if</span>&nbsp;<span class="ident" id="4636026">debug</span>&nbsp;<span class="op" id="4636032">&gt;</span>&nbsp;<span class="num" id="4636034">0</span>&nbsp;<span class="op" id="4636036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4636041">printStackRecord</span><span class="op" id="4636057">(</span><span class="ident" id="4636058">w</span><span class="op" id="4636059">,</span>&nbsp;<span class="ident" id="4636061">r</span><span class="op" id="4636062">.</span><span class="ident" id="4636063">Stack</span><span class="op" id="4636068">(</span><span class="op" id="4636069">)</span><span class="op" id="4636070">,</span>&nbsp;<span class="builtintype" id="4636072">true</span><span class="op" id="4636076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4636080">}</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4636083">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4636087">if</span>&nbsp;<span class="ident" id="4636090">tw</span>&nbsp;<span class="op" id="4636093">!=</span>&nbsp;<span class="ident" id="4636096">nil</span>&nbsp;<span class="op" id="4636100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4636104">tw</span><span class="op" id="4636106">.</span><span class="ident" id="4636107">Flush</span><span class="op" id="4636112">(</span><span class="op" id="4636113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4636116">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4636119">return</span>&nbsp;<span class="ident" id="4636126">b</span><span class="op" id="4636127">.</span><span class="ident" id="4636128">Flush</span><span class="op" id="4636133">(</span><span class="op" id="4636134">)</span><br>
<span class="lineno"></span><span class="op" id="4636136">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4636139">func</span>&nbsp;<span class="ident" id="4636144">runtime_cyclesPerSecond</span><span class="op" id="4636167">(</span><span class="op" id="4636168">)</span>&nbsp;<span class="ident" id="4636170">int64</span>
</div>
</body>
</html>
