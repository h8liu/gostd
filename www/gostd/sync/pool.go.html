<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1780089">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1780144">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1780198">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1780249">package</span>&nbsp;<span class="ident" id="1780257">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1780263">import</span>&nbsp;<span class="op" id="1780270">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1780273">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1780284">&#34;sync/atomic&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1780299">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1780308">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1780311">//&nbsp;A&nbsp;Pool&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;temporary&nbsp;objects&nbsp;that&nbsp;may&nbsp;be&nbsp;individually&nbsp;saved&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1780386">//&nbsp;retrieved.</span><br>
<span class="lineno">15</span><span class="comment" id="1780400">//</span><br>
<span class="lineno"></span><span class="comment" id="1780403">//&nbsp;Any&nbsp;item&nbsp;stored&nbsp;in&nbsp;the&nbsp;Pool&nbsp;may&nbsp;be&nbsp;removed&nbsp;automatically&nbsp;at&nbsp;any&nbsp;time&nbsp;without</span><br>
<span class="lineno"></span><span class="comment" id="1780483">//&nbsp;notification.&nbsp;If&nbsp;the&nbsp;Pool&nbsp;holds&nbsp;the&nbsp;only&nbsp;reference&nbsp;when&nbsp;this&nbsp;happens,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1780560">//&nbsp;item&nbsp;might&nbsp;be&nbsp;deallocated.</span><br>
<span class="lineno"></span><span class="comment" id="1780590">//</span><br>
<span class="lineno">20</span><span class="comment" id="1780593">//&nbsp;A&nbsp;Pool&nbsp;is&nbsp;safe&nbsp;for&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines&nbsp;simultaneously.</span><br>
<span class="lineno"></span><span class="comment" id="1780658">//</span><br>
<span class="lineno"></span><span class="comment" id="1780661">//&nbsp;Pool&#39;s&nbsp;purpose&nbsp;is&nbsp;to&nbsp;cache&nbsp;allocated&nbsp;but&nbsp;unused&nbsp;items&nbsp;for&nbsp;later&nbsp;reuse,</span><br>
<span class="lineno"></span><span class="comment" id="1780735">//&nbsp;relieving&nbsp;pressure&nbsp;on&nbsp;the&nbsp;garbage&nbsp;collector.&nbsp;That&nbsp;is,&nbsp;it&nbsp;makes&nbsp;it&nbsp;easy&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1780812">//&nbsp;build&nbsp;efficient,&nbsp;thread-safe&nbsp;free&nbsp;lists.&nbsp;However,&nbsp;it&nbsp;is&nbsp;not&nbsp;suitable&nbsp;for&nbsp;all</span><br>
<span class="lineno">25</span><span class="comment" id="1780892">//&nbsp;free&nbsp;lists.</span><br>
<span class="lineno"></span><span class="comment" id="1780907">//</span><br>
<span class="lineno"></span><span class="comment" id="1780910">//&nbsp;An&nbsp;appropriate&nbsp;use&nbsp;of&nbsp;a&nbsp;Pool&nbsp;is&nbsp;to&nbsp;manage&nbsp;a&nbsp;group&nbsp;of&nbsp;temporary&nbsp;items</span><br>
<span class="lineno"></span><span class="comment" id="1780982">//&nbsp;silently&nbsp;shared&nbsp;among&nbsp;and&nbsp;potentially&nbsp;reused&nbsp;by&nbsp;concurrent&nbsp;independent</span><br>
<span class="lineno"></span><span class="comment" id="1781056">//&nbsp;clients&nbsp;of&nbsp;a&nbsp;package.&nbsp;Pool&nbsp;provides&nbsp;a&nbsp;way&nbsp;to&nbsp;amortize&nbsp;allocation&nbsp;overhead</span><br>
<span class="lineno">30</span><span class="comment" id="1781133">//&nbsp;across&nbsp;many&nbsp;clients.</span><br>
<span class="lineno"></span><span class="comment" id="1781157">//</span><br>
<span class="lineno"></span><span class="comment" id="1781160">//&nbsp;An&nbsp;example&nbsp;of&nbsp;good&nbsp;use&nbsp;of&nbsp;a&nbsp;Pool&nbsp;is&nbsp;in&nbsp;the&nbsp;fmt&nbsp;package,&nbsp;which&nbsp;maintains&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1781237">//&nbsp;dynamically-sized&nbsp;store&nbsp;of&nbsp;temporary&nbsp;output&nbsp;buffers.&nbsp;The&nbsp;store&nbsp;scales&nbsp;under</span><br>
<span class="lineno"></span><span class="comment" id="1781316">//&nbsp;load&nbsp;(when&nbsp;many&nbsp;goroutines&nbsp;are&nbsp;actively&nbsp;printing)&nbsp;and&nbsp;shrinks&nbsp;when</span><br>
<span class="lineno">35</span><span class="comment" id="1781386">//&nbsp;quiescent.</span><br>
<span class="lineno"></span><span class="comment" id="1781400">//</span><br>
<span class="lineno"></span><span class="comment" id="1781403">//&nbsp;On&nbsp;the&nbsp;other&nbsp;hand,&nbsp;a&nbsp;free&nbsp;list&nbsp;maintained&nbsp;as&nbsp;part&nbsp;of&nbsp;a&nbsp;short-lived&nbsp;object&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1781483">//&nbsp;not&nbsp;a&nbsp;suitable&nbsp;use&nbsp;for&nbsp;a&nbsp;Pool,&nbsp;since&nbsp;the&nbsp;overhead&nbsp;does&nbsp;not&nbsp;amortize&nbsp;well&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1781562">//&nbsp;that&nbsp;scenario.&nbsp;It&nbsp;is&nbsp;more&nbsp;efficient&nbsp;to&nbsp;have&nbsp;such&nbsp;objects&nbsp;implement&nbsp;their&nbsp;own</span><br>
<span class="lineno">40</span><span class="comment" id="1781642">//&nbsp;free&nbsp;list.</span><br>
<span class="lineno"></span><span class="comment" id="1781656">//</span><br>
<span class="lineno"></span><span class="keyword" id="1781659">type</span>&nbsp;<span class="ident" id="1781664">Pool</span>&nbsp;<span class="keyword" id="1781669">struct</span>&nbsp;<span class="op" id="1781676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1781679">local</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1781689">unsafe</span><span class="op" id="1781695">.</span><span class="ident" id="1781696">Pointer</span>&nbsp;<span class="comment" id="1781704">//&nbsp;local&nbsp;fixed-size&nbsp;per-P&nbsp;pool,&nbsp;actual&nbsp;type&nbsp;is&nbsp;[P]poolLocal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1781765">localSize</span>&nbsp;<span class="builtintype" id="1781775">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1781790">//&nbsp;size&nbsp;of&nbsp;the&nbsp;local&nbsp;array</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1781819">//&nbsp;New&nbsp;optionally&nbsp;specifies&nbsp;a&nbsp;function&nbsp;to&nbsp;generate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1781871">//&nbsp;a&nbsp;value&nbsp;when&nbsp;Get&nbsp;would&nbsp;otherwise&nbsp;return&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1781920">//&nbsp;It&nbsp;may&nbsp;not&nbsp;be&nbsp;changed&nbsp;concurrently&nbsp;with&nbsp;calls&nbsp;to&nbsp;Get.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1781978">New</span>&nbsp;<span class="keyword" id="1781982">func</span><span class="op" id="1781986">(</span><span class="op" id="1781987">)</span>&nbsp;<span class="keyword" id="1781989">interface</span><span class="op" id="1781998">{</span><span class="op" id="1781999">}</span><br>
<span class="lineno">50</span><span class="op" id="1782001">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1782004">//&nbsp;Local&nbsp;per-P&nbsp;Pool&nbsp;appendix.</span><br>
<span class="lineno"></span><span class="keyword" id="1782034">type</span>&nbsp;<span class="ident" id="1782039">poolLocal</span>&nbsp;<span class="keyword" id="1782049">struct</span>&nbsp;<span class="op" id="1782056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1782059">private</span>&nbsp;<span class="keyword" id="1782067">interface</span><span class="op" id="1782076">{</span><span class="op" id="1782077">}</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="1782081">//&nbsp;Can&nbsp;be&nbsp;used&nbsp;only&nbsp;by&nbsp;the&nbsp;respective&nbsp;P.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1782123">shared</span>&nbsp;&nbsp;<span class="op" id="1782131">[</span><span class="op" id="1782132">]</span><span class="keyword" id="1782133">interface</span><span class="op" id="1782142">{</span><span class="op" id="1782143">}</span>&nbsp;<span class="comment" id="1782145">//&nbsp;Can&nbsp;be&nbsp;used&nbsp;by&nbsp;any&nbsp;P.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1782171">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1782193">//&nbsp;Protects&nbsp;shared.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1782214">pad</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1782222">[</span><span class="num" id="1782223">128</span><span class="op" id="1782226">]</span><span class="builtintype" id="1782227">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1782236">//&nbsp;Prevents&nbsp;false&nbsp;sharing.</span><br>
<span class="lineno"></span><span class="op" id="1782263">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="1782266">//&nbsp;Put&nbsp;adds&nbsp;x&nbsp;to&nbsp;the&nbsp;pool.</span><br>
<span class="lineno"></span><span class="keyword" id="1782293">func</span>&nbsp;<span class="op" id="1782298">(</span><span class="ident" id="1782299">p</span>&nbsp;<span class="op" id="1782301">*</span><span class="ident" id="1782302">Pool</span><span class="op" id="1782306">)</span>&nbsp;<span class="ident" id="1782308">Put</span><span class="op" id="1782311">(</span><span class="ident" id="1782312">x</span>&nbsp;<span class="keyword" id="1782314">interface</span><span class="op" id="1782323">{</span><span class="op" id="1782324">}</span><span class="op" id="1782325">)</span>&nbsp;<span class="op" id="1782327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1782330">if</span>&nbsp;<span class="ident" id="1782333">raceenabled</span>&nbsp;<span class="op" id="1782345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1782349">//&nbsp;Under&nbsp;race&nbsp;detector&nbsp;the&nbsp;Pool&nbsp;degenerates&nbsp;into&nbsp;no-op.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1782407">//&nbsp;It&#39;s&nbsp;conforming,&nbsp;simple&nbsp;and&nbsp;does&nbsp;not&nbsp;introduce&nbsp;excessive</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1782469">//&nbsp;happens-before&nbsp;edges&nbsp;between&nbsp;unrelated&nbsp;goroutines.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1782525">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1782533">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1782536">if</span>&nbsp;<span class="ident" id="1782539">x</span>&nbsp;<span class="op" id="1782541">==</span>&nbsp;<span class="ident" id="1782544">nil</span>&nbsp;<span class="op" id="1782548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1782552">return</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1782560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1782563">l</span>&nbsp;<span class="op" id="1782565">:=</span>&nbsp;<span class="ident" id="1782568">p</span><span class="op" id="1782569">.</span><span class="ident" id="1782570">pin</span><span class="op" id="1782573">(</span><span class="op" id="1782574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1782577">if</span>&nbsp;<span class="ident" id="1782580">l</span><span class="op" id="1782581">.</span><span class="ident" id="1782582">private</span>&nbsp;<span class="op" id="1782590">==</span>&nbsp;<span class="ident" id="1782593">nil</span>&nbsp;<span class="op" id="1782597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1782601">l</span><span class="op" id="1782602">.</span><span class="ident" id="1782603">private</span>&nbsp;<span class="op" id="1782611">=</span>&nbsp;<span class="ident" id="1782613">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1782617">x</span>&nbsp;<span class="op" id="1782619">=</span>&nbsp;<span class="ident" id="1782621">nil</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1782626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1782629">runtime_procUnpin</span><span class="op" id="1782646">(</span><span class="op" id="1782647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1782650">if</span>&nbsp;<span class="ident" id="1782653">x</span>&nbsp;<span class="op" id="1782655">==</span>&nbsp;<span class="ident" id="1782658">nil</span>&nbsp;<span class="op" id="1782662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1782666">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1782674">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1782677">l</span><span class="op" id="1782678">.</span><span class="ident" id="1782679">Lock</span><span class="op" id="1782683">(</span><span class="op" id="1782684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1782687">l</span><span class="op" id="1782688">.</span><span class="ident" id="1782689">shared</span>&nbsp;<span class="op" id="1782696">=</span>&nbsp;<span class="builtinfunc" id="1782698">append</span><span class="op" id="1782704">(</span><span class="ident" id="1782705">l</span><span class="op" id="1782706">.</span><span class="ident" id="1782707">shared</span><span class="op" id="1782713">,</span>&nbsp;<span class="ident" id="1782715">x</span><span class="op" id="1782716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1782719">l</span><span class="op" id="1782720">.</span><span class="ident" id="1782721">Unlock</span><span class="op" id="1782727">(</span><span class="op" id="1782728">)</span><br>
<span class="lineno"></span><span class="op" id="1782730">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="comment" id="1782733">//&nbsp;Get&nbsp;selects&nbsp;an&nbsp;arbitrary&nbsp;item&nbsp;from&nbsp;the&nbsp;Pool,&nbsp;removes&nbsp;it&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1782801">//&nbsp;Pool,&nbsp;and&nbsp;returns&nbsp;it&nbsp;to&nbsp;the&nbsp;caller.</span><br>
<span class="lineno"></span><span class="comment" id="1782840">//&nbsp;Get&nbsp;may&nbsp;choose&nbsp;to&nbsp;ignore&nbsp;the&nbsp;pool&nbsp;and&nbsp;treat&nbsp;it&nbsp;as&nbsp;empty.</span><br>
<span class="lineno"></span><span class="comment" id="1782900">//&nbsp;Callers&nbsp;should&nbsp;not&nbsp;assume&nbsp;any&nbsp;relation&nbsp;between&nbsp;values&nbsp;passed&nbsp;to&nbsp;Put&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1782975">//&nbsp;the&nbsp;values&nbsp;returned&nbsp;by&nbsp;Get.</span><br>
<span class="lineno">90</span><span class="comment" id="1783006">//</span><br>
<span class="lineno"></span><span class="comment" id="1783009">//&nbsp;If&nbsp;Get&nbsp;would&nbsp;otherwise&nbsp;return&nbsp;nil&nbsp;and&nbsp;p.New&nbsp;is&nbsp;non-nil,&nbsp;Get&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="1783080">//&nbsp;the&nbsp;result&nbsp;of&nbsp;calling&nbsp;p.New.</span><br>
<span class="lineno"></span><span class="keyword" id="1783112">func</span>&nbsp;<span class="op" id="1783117">(</span><span class="ident" id="1783118">p</span>&nbsp;<span class="op" id="1783120">*</span><span class="ident" id="1783121">Pool</span><span class="op" id="1783125">)</span>&nbsp;<span class="ident" id="1783127">Get</span><span class="op" id="1783130">(</span><span class="op" id="1783131">)</span>&nbsp;<span class="keyword" id="1783133">interface</span><span class="op" id="1783142">{</span><span class="op" id="1783143">}</span>&nbsp;<span class="op" id="1783145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1783148">if</span>&nbsp;<span class="ident" id="1783151">raceenabled</span>&nbsp;<span class="op" id="1783163">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1783167">if</span>&nbsp;<span class="ident" id="1783170">p</span><span class="op" id="1783171">.</span><span class="ident" id="1783172">New</span>&nbsp;<span class="op" id="1783176">!=</span>&nbsp;<span class="ident" id="1783179">nil</span>&nbsp;<span class="op" id="1783183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1783188">return</span>&nbsp;<span class="ident" id="1783195">p</span><span class="op" id="1783196">.</span><span class="ident" id="1783197">New</span><span class="op" id="1783200">(</span><span class="op" id="1783201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1783205">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1783209">return</span>&nbsp;<span class="ident" id="1783216">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1783221">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1783224">l</span>&nbsp;<span class="op" id="1783226">:=</span>&nbsp;<span class="ident" id="1783229">p</span><span class="op" id="1783230">.</span><span class="ident" id="1783231">pin</span><span class="op" id="1783234">(</span><span class="op" id="1783235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1783238">x</span>&nbsp;<span class="op" id="1783240">:=</span>&nbsp;<span class="ident" id="1783243">l</span><span class="op" id="1783244">.</span><span class="ident" id="1783245">private</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1783254">l</span><span class="op" id="1783255">.</span><span class="ident" id="1783256">private</span>&nbsp;<span class="op" id="1783264">=</span>&nbsp;<span class="ident" id="1783266">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1783271">runtime_procUnpin</span><span class="op" id="1783288">(</span><span class="op" id="1783289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1783292">if</span>&nbsp;<span class="ident" id="1783295">x</span>&nbsp;<span class="op" id="1783297">!=</span>&nbsp;<span class="ident" id="1783300">nil</span>&nbsp;<span class="op" id="1783304">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1783308">return</span>&nbsp;<span class="ident" id="1783315">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1783318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1783321">l</span><span class="op" id="1783322">.</span><span class="ident" id="1783323">Lock</span><span class="op" id="1783327">(</span><span class="op" id="1783328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1783331">last</span>&nbsp;<span class="op" id="1783336">:=</span>&nbsp;<span class="builtinfunc" id="1783339">len</span><span class="op" id="1783342">(</span><span class="ident" id="1783343">l</span><span class="op" id="1783344">.</span><span class="ident" id="1783345">shared</span><span class="op" id="1783351">)</span>&nbsp;<span class="op" id="1783353">-</span>&nbsp;<span class="num" id="1783355">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1783358">if</span>&nbsp;<span class="ident" id="1783361">last</span>&nbsp;<span class="op" id="1783366">&gt;=</span>&nbsp;<span class="num" id="1783369">0</span>&nbsp;<span class="op" id="1783371">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1783375">x</span>&nbsp;<span class="op" id="1783377">=</span>&nbsp;<span class="ident" id="1783379">l</span><span class="op" id="1783380">.</span><span class="ident" id="1783381">shared</span><span class="op" id="1783387">[</span><span class="ident" id="1783388">last</span><span class="op" id="1783392">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1783396">l</span><span class="op" id="1783397">.</span><span class="ident" id="1783398">shared</span>&nbsp;<span class="op" id="1783405">=</span>&nbsp;<span class="ident" id="1783407">l</span><span class="op" id="1783408">.</span><span class="ident" id="1783409">shared</span><span class="op" id="1783415">[</span><span class="op" id="1783416">:</span><span class="ident" id="1783417">last</span><span class="op" id="1783421">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1783424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1783427">l</span><span class="op" id="1783428">.</span><span class="ident" id="1783429">Unlock</span><span class="op" id="1783435">(</span><span class="op" id="1783436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1783439">if</span>&nbsp;<span class="ident" id="1783442">x</span>&nbsp;<span class="op" id="1783444">!=</span>&nbsp;<span class="ident" id="1783447">nil</span>&nbsp;<span class="op" id="1783451">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1783455">return</span>&nbsp;<span class="ident" id="1783462">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1783465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1783468">return</span>&nbsp;<span class="ident" id="1783475">p</span><span class="op" id="1783476">.</span><span class="ident" id="1783477">getSlow</span><span class="op" id="1783484">(</span><span class="op" id="1783485">)</span><br>
<span class="lineno"></span><span class="op" id="1783487">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="keyword" id="1783490">func</span>&nbsp;<span class="op" id="1783495">(</span><span class="ident" id="1783496">p</span>&nbsp;<span class="op" id="1783498">*</span><span class="ident" id="1783499">Pool</span><span class="op" id="1783503">)</span>&nbsp;<span class="ident" id="1783505">getSlow</span><span class="op" id="1783512">(</span><span class="op" id="1783513">)</span>&nbsp;<span class="op" id="1783515">(</span><span class="ident" id="1783516">x</span>&nbsp;<span class="keyword" id="1783518">interface</span><span class="op" id="1783527">{</span><span class="op" id="1783528">}</span><span class="op" id="1783529">)</span>&nbsp;<span class="op" id="1783531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1783534">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;in&nbsp;pin&nbsp;regarding&nbsp;ordering&nbsp;of&nbsp;the&nbsp;loads.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1783594">size</span>&nbsp;<span class="op" id="1783599">:=</span>&nbsp;<span class="ident" id="1783602">atomic</span><span class="op" id="1783608">.</span><span class="ident" id="1783609">LoadUintptr</span><span class="op" id="1783620">(</span><span class="op" id="1783621">&amp;</span><span class="ident" id="1783622">p</span><span class="op" id="1783623">.</span><span class="ident" id="1783624">localSize</span><span class="op" id="1783633">)</span>&nbsp;<span class="comment" id="1783635">//&nbsp;load-acquire</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1783652">local</span>&nbsp;<span class="op" id="1783658">:=</span>&nbsp;<span class="ident" id="1783661">p</span><span class="op" id="1783662">.</span><span class="ident" id="1783663">local</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1783693">//&nbsp;load-consume</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1783710">//&nbsp;Try&nbsp;to&nbsp;steal&nbsp;one&nbsp;element&nbsp;from&nbsp;other&nbsp;procs.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1783757">pid</span>&nbsp;<span class="op" id="1783761">:=</span>&nbsp;<span class="ident" id="1783764">runtime_procPin</span><span class="op" id="1783779">(</span><span class="op" id="1783780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1783783">runtime_procUnpin</span><span class="op" id="1783800">(</span><span class="op" id="1783801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1783804">for</span>&nbsp;<span class="ident" id="1783808">i</span>&nbsp;<span class="op" id="1783810">:=</span>&nbsp;<span class="num" id="1783813">0</span><span class="op" id="1783814">;</span>&nbsp;<span class="ident" id="1783816">i</span>&nbsp;<span class="op" id="1783818">&lt;</span>&nbsp;<span class="builtintype" id="1783820">int</span><span class="op" id="1783823">(</span><span class="ident" id="1783824">size</span><span class="op" id="1783828">)</span><span class="op" id="1783829">;</span>&nbsp;<span class="ident" id="1783831">i</span><span class="op" id="1783832">++</span>&nbsp;<span class="op" id="1783835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1783839">l</span>&nbsp;<span class="op" id="1783841">:=</span>&nbsp;<span class="ident" id="1783844">indexLocal</span><span class="op" id="1783854">(</span><span class="ident" id="1783855">local</span><span class="op" id="1783860">,</span>&nbsp;<span class="op" id="1783862">(</span><span class="ident" id="1783863">pid</span><span class="op" id="1783866">+</span><span class="ident" id="1783867">i</span><span class="op" id="1783868">+</span><span class="num" id="1783869">1</span><span class="op" id="1783870">)</span><span class="op" id="1783871">%</span><span class="builtintype" id="1783872">int</span><span class="op" id="1783875">(</span><span class="ident" id="1783876">size</span><span class="op" id="1783880">)</span><span class="op" id="1783881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1783885">l</span><span class="op" id="1783886">.</span><span class="ident" id="1783887">Lock</span><span class="op" id="1783891">(</span><span class="op" id="1783892">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1783896">last</span>&nbsp;<span class="op" id="1783901">:=</span>&nbsp;<span class="builtinfunc" id="1783904">len</span><span class="op" id="1783907">(</span><span class="ident" id="1783908">l</span><span class="op" id="1783909">.</span><span class="ident" id="1783910">shared</span><span class="op" id="1783916">)</span>&nbsp;<span class="op" id="1783918">-</span>&nbsp;<span class="num" id="1783920">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1783924">if</span>&nbsp;<span class="ident" id="1783927">last</span>&nbsp;<span class="op" id="1783932">&gt;=</span>&nbsp;<span class="num" id="1783935">0</span>&nbsp;<span class="op" id="1783937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1783942">x</span>&nbsp;<span class="op" id="1783944">=</span>&nbsp;<span class="ident" id="1783946">l</span><span class="op" id="1783947">.</span><span class="ident" id="1783948">shared</span><span class="op" id="1783954">[</span><span class="ident" id="1783955">last</span><span class="op" id="1783959">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1783964">l</span><span class="op" id="1783965">.</span><span class="ident" id="1783966">shared</span>&nbsp;<span class="op" id="1783973">=</span>&nbsp;<span class="ident" id="1783975">l</span><span class="op" id="1783976">.</span><span class="ident" id="1783977">shared</span><span class="op" id="1783983">[</span><span class="op" id="1783984">:</span><span class="ident" id="1783985">last</span><span class="op" id="1783989">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1783994">l</span><span class="op" id="1783995">.</span><span class="ident" id="1783996">Unlock</span><span class="op" id="1784002">(</span><span class="op" id="1784003">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1784008">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1784016">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1784020">l</span><span class="op" id="1784021">.</span><span class="ident" id="1784022">Unlock</span><span class="op" id="1784028">(</span><span class="op" id="1784029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1784032">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1784036">if</span>&nbsp;<span class="ident" id="1784039">x</span>&nbsp;<span class="op" id="1784041">==</span>&nbsp;<span class="ident" id="1784044">nil</span>&nbsp;<span class="op" id="1784048">&amp;&amp;</span>&nbsp;<span class="ident" id="1784051">p</span><span class="op" id="1784052">.</span><span class="ident" id="1784053">New</span>&nbsp;<span class="op" id="1784057">!=</span>&nbsp;<span class="ident" id="1784060">nil</span>&nbsp;<span class="op" id="1784064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1784068">x</span>&nbsp;<span class="op" id="1784070">=</span>&nbsp;<span class="ident" id="1784072">p</span><span class="op" id="1784073">.</span><span class="ident" id="1784074">New</span><span class="op" id="1784077">(</span><span class="op" id="1784078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1784081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1784084">return</span>&nbsp;<span class="ident" id="1784091">x</span><br>
<span class="lineno"></span><span class="op" id="1784093">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span><span class="comment" id="1784096">//&nbsp;pin&nbsp;pins&nbsp;the&nbsp;current&nbsp;goroutine&nbsp;to&nbsp;P,&nbsp;disables&nbsp;preemption&nbsp;and&nbsp;returns&nbsp;poolLocal&nbsp;pool&nbsp;for&nbsp;the&nbsp;P.</span><br>
<span class="lineno"></span><span class="comment" id="1784194">//&nbsp;Caller&nbsp;must&nbsp;call&nbsp;runtime_procUnpin()&nbsp;when&nbsp;done&nbsp;with&nbsp;the&nbsp;pool.</span><br>
<span class="lineno"></span><span class="keyword" id="1784259">func</span>&nbsp;<span class="op" id="1784264">(</span><span class="ident" id="1784265">p</span>&nbsp;<span class="op" id="1784267">*</span><span class="ident" id="1784268">Pool</span><span class="op" id="1784272">)</span>&nbsp;<span class="ident" id="1784274">pin</span><span class="op" id="1784277">(</span><span class="op" id="1784278">)</span>&nbsp;<span class="op" id="1784280">*</span><span class="ident" id="1784281">poolLocal</span>&nbsp;<span class="op" id="1784291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1784294">pid</span>&nbsp;<span class="op" id="1784298">:=</span>&nbsp;<span class="ident" id="1784301">runtime_procPin</span><span class="op" id="1784316">(</span><span class="op" id="1784317">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1784320">//&nbsp;In&nbsp;pinSlow&nbsp;we&nbsp;store&nbsp;to&nbsp;localSize&nbsp;and&nbsp;then&nbsp;to&nbsp;local,&nbsp;here&nbsp;we&nbsp;load&nbsp;in&nbsp;opposite&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1784408">//&nbsp;Since&nbsp;we&#39;ve&nbsp;disabled&nbsp;preemption,&nbsp;GC&nbsp;can&nbsp;not&nbsp;happen&nbsp;in&nbsp;between.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1784475">//&nbsp;Thus&nbsp;here&nbsp;we&nbsp;must&nbsp;observe&nbsp;local&nbsp;at&nbsp;least&nbsp;as&nbsp;large&nbsp;localSize.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1784540">//&nbsp;We&nbsp;can&nbsp;observe&nbsp;a&nbsp;newer/larger&nbsp;local,&nbsp;it&nbsp;is&nbsp;fine&nbsp;(we&nbsp;must&nbsp;observe&nbsp;its&nbsp;zero-initialized-ness).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1784637">s</span>&nbsp;<span class="op" id="1784639">:=</span>&nbsp;<span class="ident" id="1784642">atomic</span><span class="op" id="1784648">.</span><span class="ident" id="1784649">LoadUintptr</span><span class="op" id="1784660">(</span><span class="op" id="1784661">&amp;</span><span class="ident" id="1784662">p</span><span class="op" id="1784663">.</span><span class="ident" id="1784664">localSize</span><span class="op" id="1784673">)</span>&nbsp;<span class="comment" id="1784675">//&nbsp;load-acquire</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1784692">l</span>&nbsp;<span class="op" id="1784694">:=</span>&nbsp;<span class="ident" id="1784697">p</span><span class="op" id="1784698">.</span><span class="ident" id="1784699">local</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1784730">//&nbsp;load-consume</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1784747">if</span>&nbsp;<span class="builtintype" id="1784750">uintptr</span><span class="op" id="1784757">(</span><span class="ident" id="1784758">pid</span><span class="op" id="1784761">)</span>&nbsp;<span class="op" id="1784763">&lt;</span>&nbsp;<span class="ident" id="1784765">s</span>&nbsp;<span class="op" id="1784767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1784771">return</span>&nbsp;<span class="ident" id="1784778">indexLocal</span><span class="op" id="1784788">(</span><span class="ident" id="1784789">l</span><span class="op" id="1784790">,</span>&nbsp;<span class="ident" id="1784792">pid</span><span class="op" id="1784795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1784798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1784801">return</span>&nbsp;<span class="ident" id="1784808">p</span><span class="op" id="1784809">.</span><span class="ident" id="1784810">pinSlow</span><span class="op" id="1784817">(</span><span class="op" id="1784818">)</span><br>
<span class="lineno">160</span><span class="op" id="1784820">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1784823">func</span>&nbsp;<span class="op" id="1784828">(</span><span class="ident" id="1784829">p</span>&nbsp;<span class="op" id="1784831">*</span><span class="ident" id="1784832">Pool</span><span class="op" id="1784836">)</span>&nbsp;<span class="ident" id="1784838">pinSlow</span><span class="op" id="1784845">(</span><span class="op" id="1784846">)</span>&nbsp;<span class="op" id="1784848">*</span><span class="ident" id="1784849">poolLocal</span>&nbsp;<span class="op" id="1784859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1784862">//&nbsp;Retry&nbsp;under&nbsp;the&nbsp;mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1784889">//&nbsp;Can&nbsp;not&nbsp;lock&nbsp;the&nbsp;mutex&nbsp;while&nbsp;pinned.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1784930">runtime_procUnpin</span><span class="op" id="1784947">(</span><span class="op" id="1784948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1784951">allPoolsMu</span><span class="op" id="1784961">.</span><span class="ident" id="1784962">Lock</span><span class="op" id="1784966">(</span><span class="op" id="1784967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1784970">defer</span>&nbsp;<span class="ident" id="1784976">allPoolsMu</span><span class="op" id="1784986">.</span><span class="ident" id="1784987">Unlock</span><span class="op" id="1784993">(</span><span class="op" id="1784994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1784997">pid</span>&nbsp;<span class="op" id="1785001">:=</span>&nbsp;<span class="ident" id="1785004">runtime_procPin</span><span class="op" id="1785019">(</span><span class="op" id="1785020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1785023">//&nbsp;poolCleanup&nbsp;won&#39;t&nbsp;be&nbsp;called&nbsp;while&nbsp;we&nbsp;are&nbsp;pinned.</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1785076">s</span>&nbsp;<span class="op" id="1785078">:=</span>&nbsp;<span class="ident" id="1785081">p</span><span class="op" id="1785082">.</span><span class="ident" id="1785083">localSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1785094">l</span>&nbsp;<span class="op" id="1785096">:=</span>&nbsp;<span class="ident" id="1785099">p</span><span class="op" id="1785100">.</span><span class="ident" id="1785101">local</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1785108">if</span>&nbsp;<span class="builtintype" id="1785111">uintptr</span><span class="op" id="1785118">(</span><span class="ident" id="1785119">pid</span><span class="op" id="1785122">)</span>&nbsp;<span class="op" id="1785124">&lt;</span>&nbsp;<span class="ident" id="1785126">s</span>&nbsp;<span class="op" id="1785128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1785132">return</span>&nbsp;<span class="ident" id="1785139">indexLocal</span><span class="op" id="1785149">(</span><span class="ident" id="1785150">l</span><span class="op" id="1785151">,</span>&nbsp;<span class="ident" id="1785153">pid</span><span class="op" id="1785156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1785159">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1785162">if</span>&nbsp;<span class="ident" id="1785165">p</span><span class="op" id="1785166">.</span><span class="ident" id="1785167">local</span>&nbsp;<span class="op" id="1785173">==</span>&nbsp;<span class="ident" id="1785176">nil</span>&nbsp;<span class="op" id="1785180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1785184">allPools</span>&nbsp;<span class="op" id="1785193">=</span>&nbsp;<span class="builtinfunc" id="1785195">append</span><span class="op" id="1785201">(</span><span class="ident" id="1785202">allPools</span><span class="op" id="1785210">,</span>&nbsp;<span class="ident" id="1785212">p</span><span class="op" id="1785213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1785216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1785219">//&nbsp;If&nbsp;GOMAXPROCS&nbsp;changes&nbsp;between&nbsp;GCs,&nbsp;we&nbsp;re-allocate&nbsp;the&nbsp;array&nbsp;and&nbsp;lose&nbsp;the&nbsp;old&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1785305">size</span>&nbsp;<span class="op" id="1785310">:=</span>&nbsp;<span class="ident" id="1785313">runtime</span><span class="op" id="1785320">.</span><span class="ident" id="1785321">GOMAXPROCS</span><span class="op" id="1785331">(</span><span class="num" id="1785332">0</span><span class="op" id="1785333">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1785336">local</span>&nbsp;<span class="op" id="1785342">:=</span>&nbsp;<span class="builtinfunc" id="1785345">make</span><span class="op" id="1785349">(</span><span class="op" id="1785350">[</span><span class="op" id="1785351">]</span><span class="ident" id="1785352">poolLocal</span><span class="op" id="1785361">,</span>&nbsp;<span class="ident" id="1785363">size</span><span class="op" id="1785367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1785370">atomic</span><span class="op" id="1785376">.</span><span class="ident" id="1785377">StorePointer</span><span class="op" id="1785389">(</span><span class="op" id="1785390">(</span><span class="op" id="1785391">*</span><span class="ident" id="1785392">unsafe</span><span class="op" id="1785398">.</span><span class="ident" id="1785399">Pointer</span><span class="op" id="1785406">)</span><span class="op" id="1785407">(</span><span class="op" id="1785408">&amp;</span><span class="ident" id="1785409">p</span><span class="op" id="1785410">.</span><span class="ident" id="1785411">local</span><span class="op" id="1785416">)</span><span class="op" id="1785417">,</span>&nbsp;<span class="ident" id="1785419">unsafe</span><span class="op" id="1785425">.</span><span class="ident" id="1785426">Pointer</span><span class="op" id="1785433">(</span><span class="op" id="1785434">&amp;</span><span class="ident" id="1785435">local</span><span class="op" id="1785440">[</span><span class="num" id="1785441">0</span><span class="op" id="1785442">]</span><span class="op" id="1785443">)</span><span class="op" id="1785444">)</span>&nbsp;<span class="comment" id="1785446">//&nbsp;store-release</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1785464">atomic</span><span class="op" id="1785470">.</span><span class="ident" id="1785471">StoreUintptr</span><span class="op" id="1785483">(</span><span class="op" id="1785484">&amp;</span><span class="ident" id="1785485">p</span><span class="op" id="1785486">.</span><span class="ident" id="1785487">localSize</span><span class="op" id="1785496">,</span>&nbsp;<span class="builtintype" id="1785498">uintptr</span><span class="op" id="1785505">(</span><span class="ident" id="1785506">size</span><span class="op" id="1785510">)</span><span class="op" id="1785511">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1785540">//&nbsp;store-release</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1785558">return</span>&nbsp;<span class="op" id="1785565">&amp;</span><span class="ident" id="1785566">local</span><span class="op" id="1785571">[</span><span class="ident" id="1785572">pid</span><span class="op" id="1785575">]</span><br>
<span class="lineno"></span><span class="op" id="1785577">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span><span class="keyword" id="1785580">func</span>&nbsp;<span class="ident" id="1785585">poolCleanup</span><span class="op" id="1785596">(</span><span class="op" id="1785597">)</span>&nbsp;<span class="op" id="1785599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1785602">//&nbsp;This&nbsp;function&nbsp;is&nbsp;called&nbsp;with&nbsp;the&nbsp;world&nbsp;stopped,&nbsp;at&nbsp;the&nbsp;beginning&nbsp;of&nbsp;a&nbsp;garbage&nbsp;collection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1785696">//&nbsp;It&nbsp;must&nbsp;not&nbsp;allocate&nbsp;and&nbsp;probably&nbsp;should&nbsp;not&nbsp;call&nbsp;any&nbsp;runtime&nbsp;functions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1785773">//&nbsp;Defensively&nbsp;zero&nbsp;out&nbsp;everything,&nbsp;2&nbsp;reasons:</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1785821">//&nbsp;1.&nbsp;To&nbsp;prevent&nbsp;false&nbsp;retention&nbsp;of&nbsp;whole&nbsp;Pools.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1785871">//&nbsp;2.&nbsp;If&nbsp;GC&nbsp;happens&nbsp;while&nbsp;a&nbsp;goroutine&nbsp;works&nbsp;with&nbsp;l.shared&nbsp;in&nbsp;Put/Get,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1785942">//&nbsp;&nbsp;&nbsp;&nbsp;it&nbsp;will&nbsp;retain&nbsp;whole&nbsp;Pool.&nbsp;So&nbsp;next&nbsp;cycle&nbsp;memory&nbsp;consumption&nbsp;would&nbsp;be&nbsp;doubled.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1786027">for</span>&nbsp;<span class="ident" id="1786031">i</span><span class="op" id="1786032">,</span>&nbsp;<span class="ident" id="1786034">p</span>&nbsp;<span class="op" id="1786036">:=</span>&nbsp;<span class="keyword" id="1786039">range</span>&nbsp;<span class="ident" id="1786045">allPools</span>&nbsp;<span class="op" id="1786054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1786058">allPools</span><span class="op" id="1786066">[</span><span class="ident" id="1786067">i</span><span class="op" id="1786068">]</span>&nbsp;<span class="op" id="1786070">=</span>&nbsp;<span class="ident" id="1786072">nil</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1786078">for</span>&nbsp;<span class="ident" id="1786082">i</span>&nbsp;<span class="op" id="1786084">:=</span>&nbsp;<span class="num" id="1786087">0</span><span class="op" id="1786088">;</span>&nbsp;<span class="ident" id="1786090">i</span>&nbsp;<span class="op" id="1786092">&lt;</span>&nbsp;<span class="builtintype" id="1786094">int</span><span class="op" id="1786097">(</span><span class="ident" id="1786098">p</span><span class="op" id="1786099">.</span><span class="ident" id="1786100">localSize</span><span class="op" id="1786109">)</span><span class="op" id="1786110">;</span>&nbsp;<span class="ident" id="1786112">i</span><span class="op" id="1786113">++</span>&nbsp;<span class="op" id="1786116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1786121">l</span>&nbsp;<span class="op" id="1786123">:=</span>&nbsp;<span class="ident" id="1786126">indexLocal</span><span class="op" id="1786136">(</span><span class="ident" id="1786137">p</span><span class="op" id="1786138">.</span><span class="ident" id="1786139">local</span><span class="op" id="1786144">,</span>&nbsp;<span class="ident" id="1786146">i</span><span class="op" id="1786147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1786152">l</span><span class="op" id="1786153">.</span><span class="ident" id="1786154">private</span>&nbsp;<span class="op" id="1786162">=</span>&nbsp;<span class="ident" id="1786164">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1786171">for</span>&nbsp;<span class="ident" id="1786175">j</span>&nbsp;<span class="op" id="1786177">:=</span>&nbsp;<span class="keyword" id="1786180">range</span>&nbsp;<span class="ident" id="1786186">l</span><span class="op" id="1786187">.</span><span class="ident" id="1786188">shared</span>&nbsp;<span class="op" id="1786195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1786201">l</span><span class="op" id="1786202">.</span><span class="ident" id="1786203">shared</span><span class="op" id="1786209">[</span><span class="ident" id="1786210">j</span><span class="op" id="1786211">]</span>&nbsp;<span class="op" id="1786213">=</span>&nbsp;<span class="ident" id="1786215">nil</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1786222">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1786227">l</span><span class="op" id="1786228">.</span><span class="ident" id="1786229">shared</span>&nbsp;<span class="op" id="1786236">=</span>&nbsp;<span class="ident" id="1786238">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1786244">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1786248">p</span><span class="op" id="1786249">.</span><span class="ident" id="1786250">local</span>&nbsp;<span class="op" id="1786256">=</span>&nbsp;<span class="ident" id="1786258">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1786264">p</span><span class="op" id="1786265">.</span><span class="ident" id="1786266">localSize</span>&nbsp;<span class="op" id="1786276">=</span>&nbsp;<span class="num" id="1786278">0</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1786281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1786284">allPools</span>&nbsp;<span class="op" id="1786293">=</span>&nbsp;<span class="op" id="1786295">[</span><span class="op" id="1786296">]</span><span class="op" id="1786297">*</span><span class="ident" id="1786298">Pool</span><span class="op" id="1786302">{</span><span class="op" id="1786303">}</span><br>
<span class="lineno"></span><span class="op" id="1786305">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1786308">var</span>&nbsp;<span class="op" id="1786312">(</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1786315">allPoolsMu</span>&nbsp;<span class="ident" id="1786326">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1786333">allPools</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1786344">[</span><span class="op" id="1786345">]</span><span class="op" id="1786346">*</span><span class="ident" id="1786347">Pool</span><br>
<span class="lineno"></span><span class="op" id="1786352">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1786355">func</span>&nbsp;<span class="ident" id="1786360">init</span><span class="op" id="1786364">(</span><span class="op" id="1786365">)</span>&nbsp;<span class="op" id="1786367">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1786370">runtime_registerPoolCleanup</span><span class="op" id="1786397">(</span><span class="ident" id="1786398">poolCleanup</span><span class="op" id="1786409">)</span><br>
<span class="lineno"></span><span class="op" id="1786411">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1786414">func</span>&nbsp;<span class="ident" id="1786419">indexLocal</span><span class="op" id="1786429">(</span><span class="ident" id="1786430">l</span>&nbsp;<span class="ident" id="1786432">unsafe</span><span class="op" id="1786438">.</span><span class="ident" id="1786439">Pointer</span><span class="op" id="1786446">,</span>&nbsp;<span class="ident" id="1786448">i</span>&nbsp;<span class="builtintype" id="1786450">int</span><span class="op" id="1786453">)</span>&nbsp;<span class="op" id="1786455">*</span><span class="ident" id="1786456">poolLocal</span>&nbsp;<span class="op" id="1786466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1786469">return</span>&nbsp;<span class="op" id="1786476">&amp;</span><span class="op" id="1786477">(</span><span class="op" id="1786478">*</span><span class="op" id="1786479">[</span><span class="num" id="1786480">1000000</span><span class="op" id="1786487">]</span><span class="ident" id="1786488">poolLocal</span><span class="op" id="1786497">)</span><span class="op" id="1786498">(</span><span class="ident" id="1786499">l</span><span class="op" id="1786500">)</span><span class="op" id="1786501">[</span><span class="ident" id="1786502">i</span><span class="op" id="1786503">]</span><br>
<span class="lineno">220</span><span class="op" id="1786505">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1786508">//&nbsp;Implemented&nbsp;in&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="keyword" id="1786535">func</span>&nbsp;<span class="ident" id="1786540">runtime_registerPoolCleanup</span><span class="op" id="1786567">(</span><span class="ident" id="1786568">cleanup</span>&nbsp;<span class="keyword" id="1786576">func</span><span class="op" id="1786580">(</span><span class="op" id="1786581">)</span><span class="op" id="1786582">)</span><br>
<span class="lineno"></span><span class="keyword" id="1786584">func</span>&nbsp;<span class="ident" id="1786589">runtime_procPin</span><span class="op" id="1786604">(</span><span class="op" id="1786605">)</span>&nbsp;<span class="builtintype" id="1786607">int</span><br>
<span class="lineno">225</span><span class="keyword" id="1786611">func</span>&nbsp;<span class="ident" id="1786616">runtime_procUnpin</span><span class="op" id="1786633">(</span><span class="op" id="1786634">)</span>
</div>
</body>
</html>
