<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/internal</h2>
<ul>
<li><a href="/gostd/net/http/internal/chunked.go.html">chunked.go</a></li>
<li><a href="/gostd/net/http/internal/chunked_test.go.html">chunked_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7369594">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7369649">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7369703">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7369754">package</span>&nbsp;<span class="ident" id="7369762">internal</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7369772">import</span>&nbsp;<span class="op" id="7369779">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7369782">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7369791">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7369800">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7369807">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7369813">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7369826">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7369837">&#34;testing&#34;</span><br>
<span class="lineno">15</span><span class="op" id="7369847">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7369850">func</span>&nbsp;<span class="ident" id="7369855">TestChunk</span><span class="op" id="7369864">(</span><span class="ident" id="7369865">t</span>&nbsp;<span class="op" id="7369867">*</span><span class="ident" id="7369868">testing</span><span class="op" id="7369875">.</span><span class="ident" id="7369876">T</span><span class="op" id="7369877">)</span>&nbsp;<span class="op" id="7369879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7369882">var</span>&nbsp;<span class="ident" id="7369886">b</span>&nbsp;<span class="ident" id="7369888">bytes</span><span class="op" id="7369893">.</span><span class="ident" id="7369894">Buffer</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7369903">w</span>&nbsp;<span class="op" id="7369905">:=</span>&nbsp;<span class="ident" id="7369908">NewChunkedWriter</span><span class="op" id="7369924">(</span><span class="op" id="7369925">&amp;</span><span class="ident" id="7369926">b</span><span class="op" id="7369927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7369930">const</span>&nbsp;<span class="ident" id="7369936">chunk1</span>&nbsp;<span class="op" id="7369943">=</span>&nbsp;<span class="string" id="7369945">&#34;hello,&nbsp;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7369956">const</span>&nbsp;<span class="ident" id="7369962">chunk2</span>&nbsp;<span class="op" id="7369969">=</span>&nbsp;<span class="string" id="7369971">&#34;world!&nbsp;0123456789abcdef&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7369998">w</span><span class="op" id="7369999">.</span><span class="ident" id="7370000">Write</span><span class="op" id="7370005">(</span><span class="op" id="7370006">[</span><span class="op" id="7370007">]</span><span class="builtintype" id="7370008">byte</span><span class="op" id="7370012">(</span><span class="ident" id="7370013">chunk1</span><span class="op" id="7370019">)</span><span class="op" id="7370020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7370023">w</span><span class="op" id="7370024">.</span><span class="ident" id="7370025">Write</span><span class="op" id="7370030">(</span><span class="op" id="7370031">[</span><span class="op" id="7370032">]</span><span class="builtintype" id="7370033">byte</span><span class="op" id="7370037">(</span><span class="ident" id="7370038">chunk2</span><span class="op" id="7370044">)</span><span class="op" id="7370045">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7370048">w</span><span class="op" id="7370049">.</span><span class="ident" id="7370050">Close</span><span class="op" id="7370055">(</span><span class="op" id="7370056">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7370060">if</span>&nbsp;<span class="ident" id="7370063">g</span><span class="op" id="7370064">,</span>&nbsp;<span class="ident" id="7370066">e</span>&nbsp;<span class="op" id="7370068">:=</span>&nbsp;<span class="ident" id="7370071">b</span><span class="op" id="7370072">.</span><span class="ident" id="7370073">String</span><span class="op" id="7370079">(</span><span class="op" id="7370080">)</span><span class="op" id="7370081">,</span>&nbsp;<span class="string" id="7370083">&#34;7\r\nhello,&nbsp;\r\n17\r\nworld!&nbsp;0123456789abcdef\r\n0\r\n&#34;</span><span class="op" id="7370139">;</span>&nbsp;<span class="ident" id="7370141">g</span>&nbsp;<span class="op" id="7370143">!=</span>&nbsp;<span class="ident" id="7370146">e</span>&nbsp;<span class="op" id="7370148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7370152">t</span><span class="op" id="7370153">.</span><span class="ident" id="7370154">Fatalf</span><span class="op" id="7370160">(</span><span class="string" id="7370161">&#34;chunk&nbsp;writer&nbsp;wrote&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7370193">,</span>&nbsp;<span class="ident" id="7370195">g</span><span class="op" id="7370196">,</span>&nbsp;<span class="ident" id="7370198">e</span><span class="op" id="7370199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7370202">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7370206">r</span>&nbsp;<span class="op" id="7370208">:=</span>&nbsp;<span class="ident" id="7370211">NewChunkedReader</span><span class="op" id="7370227">(</span><span class="op" id="7370228">&amp;</span><span class="ident" id="7370229">b</span><span class="op" id="7370230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7370233">data</span><span class="op" id="7370237">,</span>&nbsp;<span class="ident" id="7370239">err</span>&nbsp;<span class="op" id="7370243">:=</span>&nbsp;<span class="ident" id="7370246">ioutil</span><span class="op" id="7370252">.</span><span class="ident" id="7370253">ReadAll</span><span class="op" id="7370260">(</span><span class="ident" id="7370261">r</span><span class="op" id="7370262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7370265">if</span>&nbsp;<span class="ident" id="7370268">err</span>&nbsp;<span class="op" id="7370272">!=</span>&nbsp;<span class="ident" id="7370275">nil</span>&nbsp;<span class="op" id="7370279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7370283">t</span><span class="op" id="7370284">.</span><span class="ident" id="7370285">Logf</span><span class="op" id="7370289">(</span><span class="string" id="7370290">`data:&nbsp;&#34;%s&#34;`</span><span class="op" id="7370302">,</span>&nbsp;<span class="ident" id="7370304">data</span><span class="op" id="7370308">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7370312">t</span><span class="op" id="7370313">.</span><span class="ident" id="7370314">Fatalf</span><span class="op" id="7370320">(</span><span class="string" id="7370321">&#34;ReadAll&nbsp;from&nbsp;reader:&nbsp;%v&#34;</span><span class="op" id="7370346">,</span>&nbsp;<span class="ident" id="7370348">err</span><span class="op" id="7370351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7370354">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7370357">if</span>&nbsp;<span class="ident" id="7370360">g</span><span class="op" id="7370361">,</span>&nbsp;<span class="ident" id="7370363">e</span>&nbsp;<span class="op" id="7370365">:=</span>&nbsp;<span class="builtintype" id="7370368">string</span><span class="op" id="7370374">(</span><span class="ident" id="7370375">data</span><span class="op" id="7370379">)</span><span class="op" id="7370380">,</span>&nbsp;<span class="ident" id="7370382">chunk1</span><span class="op" id="7370388">+</span><span class="ident" id="7370389">chunk2</span><span class="op" id="7370395">;</span>&nbsp;<span class="ident" id="7370397">g</span>&nbsp;<span class="op" id="7370399">!=</span>&nbsp;<span class="ident" id="7370402">e</span>&nbsp;<span class="op" id="7370404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7370408">t</span><span class="op" id="7370409">.</span><span class="ident" id="7370410">Errorf</span><span class="op" id="7370416">(</span><span class="string" id="7370417">&#34;chunk&nbsp;reader&nbsp;read&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7370448">,</span>&nbsp;<span class="ident" id="7370450">g</span><span class="op" id="7370451">,</span>&nbsp;<span class="ident" id="7370453">e</span><span class="op" id="7370454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7370457">}</span><br>
<span class="lineno">40</span><span class="op" id="7370459">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7370462">func</span>&nbsp;<span class="ident" id="7370467">TestChunkReadMultiple</span><span class="op" id="7370488">(</span><span class="ident" id="7370489">t</span>&nbsp;<span class="op" id="7370491">*</span><span class="ident" id="7370492">testing</span><span class="op" id="7370499">.</span><span class="ident" id="7370500">T</span><span class="op" id="7370501">)</span>&nbsp;<span class="op" id="7370503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7370506">//&nbsp;Bunch&nbsp;of&nbsp;small&nbsp;chunks,&nbsp;all&nbsp;read&nbsp;together.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7370552">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7370556">var</span>&nbsp;<span class="ident" id="7370560">b</span>&nbsp;<span class="ident" id="7370562">bytes</span><span class="op" id="7370567">.</span><span class="ident" id="7370568">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7370577">w</span>&nbsp;<span class="op" id="7370579">:=</span>&nbsp;<span class="ident" id="7370582">NewChunkedWriter</span><span class="op" id="7370598">(</span><span class="op" id="7370599">&amp;</span><span class="ident" id="7370600">b</span><span class="op" id="7370601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7370605">w</span><span class="op" id="7370606">.</span><span class="ident" id="7370607">Write</span><span class="op" id="7370612">(</span><span class="op" id="7370613">[</span><span class="op" id="7370614">]</span><span class="builtintype" id="7370615">byte</span><span class="op" id="7370619">(</span><span class="string" id="7370620">&#34;foo&#34;</span><span class="op" id="7370625">)</span><span class="op" id="7370626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7370630">w</span><span class="op" id="7370631">.</span><span class="ident" id="7370632">Write</span><span class="op" id="7370637">(</span><span class="op" id="7370638">[</span><span class="op" id="7370639">]</span><span class="builtintype" id="7370640">byte</span><span class="op" id="7370644">(</span><span class="string" id="7370645">&#34;bar&#34;</span><span class="op" id="7370650">)</span><span class="op" id="7370651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7370655">w</span><span class="op" id="7370656">.</span><span class="ident" id="7370657">Close</span><span class="op" id="7370662">(</span><span class="op" id="7370663">)</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7370668">r</span>&nbsp;<span class="op" id="7370670">:=</span>&nbsp;<span class="ident" id="7370673">NewChunkedReader</span><span class="op" id="7370689">(</span><span class="op" id="7370690">&amp;</span><span class="ident" id="7370691">b</span><span class="op" id="7370692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7370696">buf</span>&nbsp;<span class="op" id="7370700">:=</span>&nbsp;<span class="builtinfunc" id="7370703">make</span><span class="op" id="7370707">(</span><span class="op" id="7370708">[</span><span class="op" id="7370709">]</span><span class="builtintype" id="7370710">byte</span><span class="op" id="7370714">,</span>&nbsp;<span class="num" id="7370716">10</span><span class="op" id="7370718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7370722">n</span><span class="op" id="7370723">,</span>&nbsp;<span class="ident" id="7370725">err</span>&nbsp;<span class="op" id="7370729">:=</span>&nbsp;<span class="ident" id="7370732">r</span><span class="op" id="7370733">.</span><span class="ident" id="7370734">Read</span><span class="op" id="7370738">(</span><span class="ident" id="7370739">buf</span><span class="op" id="7370742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7370746">if</span>&nbsp;<span class="ident" id="7370749">n</span>&nbsp;<span class="op" id="7370751">!=</span>&nbsp;<span class="num" id="7370754">6</span>&nbsp;<span class="op" id="7370756">||</span>&nbsp;<span class="ident" id="7370759">err</span>&nbsp;<span class="op" id="7370763">!=</span>&nbsp;<span class="ident" id="7370766">io</span><span class="op" id="7370768">.</span><span class="ident" id="7370769">EOF</span>&nbsp;<span class="op" id="7370773">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7370778">t</span><span class="op" id="7370779">.</span><span class="ident" id="7370780">Errorf</span><span class="op" id="7370786">(</span><span class="string" id="7370787">&#34;Read&nbsp;=&nbsp;%d,&nbsp;%v;&nbsp;want&nbsp;6,&nbsp;EOF&#34;</span><span class="op" id="7370815">,</span>&nbsp;<span class="ident" id="7370817">n</span><span class="op" id="7370818">,</span>&nbsp;<span class="ident" id="7370820">err</span><span class="op" id="7370823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7370827">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7370831">buf</span>&nbsp;<span class="op" id="7370835">=</span>&nbsp;<span class="ident" id="7370837">buf</span><span class="op" id="7370840">[</span><span class="op" id="7370841">:</span><span class="ident" id="7370842">n</span><span class="op" id="7370843">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7370847">if</span>&nbsp;<span class="builtintype" id="7370850">string</span><span class="op" id="7370856">(</span><span class="ident" id="7370857">buf</span><span class="op" id="7370860">)</span>&nbsp;<span class="op" id="7370862">!=</span>&nbsp;<span class="string" id="7370865">&#34;foobar&#34;</span>&nbsp;<span class="op" id="7370874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7370879">t</span><span class="op" id="7370880">.</span><span class="ident" id="7370881">Errorf</span><span class="op" id="7370887">(</span><span class="string" id="7370888">&#34;Read&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7370908">,</span>&nbsp;<span class="ident" id="7370910">buf</span><span class="op" id="7370913">,</span>&nbsp;<span class="string" id="7370915">&#34;foobar&#34;</span><span class="op" id="7370923">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7370927">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7370930">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7370934">//&nbsp;One&nbsp;big&nbsp;chunk&nbsp;followed&nbsp;by&nbsp;a&nbsp;little&nbsp;chunk,&nbsp;but&nbsp;the&nbsp;small&nbsp;bufio.Reader&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7371012">//&nbsp;should&nbsp;prevent&nbsp;the&nbsp;second&nbsp;chunk&nbsp;header&nbsp;from&nbsp;being&nbsp;read.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7371072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7371076">var</span>&nbsp;<span class="ident" id="7371080">b</span>&nbsp;<span class="ident" id="7371082">bytes</span><span class="op" id="7371087">.</span><span class="ident" id="7371088">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7371097">w</span>&nbsp;<span class="op" id="7371099">:=</span>&nbsp;<span class="ident" id="7371102">NewChunkedWriter</span><span class="op" id="7371118">(</span><span class="op" id="7371119">&amp;</span><span class="ident" id="7371120">b</span><span class="op" id="7371121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7371125">//&nbsp;fillBufChunk&nbsp;is&nbsp;11&nbsp;bytes&nbsp;+&nbsp;3&nbsp;bytes&nbsp;header&nbsp;+&nbsp;2&nbsp;bytes&nbsp;footer&nbsp;=&nbsp;16&nbsp;bytes,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7371201">//&nbsp;the&nbsp;same&nbsp;as&nbsp;the&nbsp;bufio&nbsp;ReaderSize&nbsp;below&nbsp;(the&nbsp;minimum),&nbsp;so&nbsp;even</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7371268">//&nbsp;though&nbsp;we&#39;re&nbsp;going&nbsp;to&nbsp;try&nbsp;to&nbsp;Read&nbsp;with&nbsp;a&nbsp;buffer&nbsp;larger&nbsp;enough&nbsp;to&nbsp;also</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7371343">//&nbsp;receive&nbsp;&#34;foo&#34;,&nbsp;the&nbsp;second&nbsp;chunk&nbsp;header&nbsp;won&#39;t&nbsp;be&nbsp;read&nbsp;yet.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7371406">const</span>&nbsp;<span class="ident" id="7371412">fillBufChunk</span>&nbsp;<span class="op" id="7371425">=</span>&nbsp;<span class="string" id="7371427">&#34;0123456789a&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7371443">const</span>&nbsp;<span class="ident" id="7371449">shortChunk</span>&nbsp;<span class="op" id="7371460">=</span>&nbsp;<span class="string" id="7371462">&#34;foo&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7371470">w</span><span class="op" id="7371471">.</span><span class="ident" id="7371472">Write</span><span class="op" id="7371477">(</span><span class="op" id="7371478">[</span><span class="op" id="7371479">]</span><span class="builtintype" id="7371480">byte</span><span class="op" id="7371484">(</span><span class="ident" id="7371485">fillBufChunk</span><span class="op" id="7371497">)</span><span class="op" id="7371498">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7371502">w</span><span class="op" id="7371503">.</span><span class="ident" id="7371504">Write</span><span class="op" id="7371509">(</span><span class="op" id="7371510">[</span><span class="op" id="7371511">]</span><span class="builtintype" id="7371512">byte</span><span class="op" id="7371516">(</span><span class="ident" id="7371517">shortChunk</span><span class="op" id="7371527">)</span><span class="op" id="7371528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7371532">w</span><span class="op" id="7371533">.</span><span class="ident" id="7371534">Close</span><span class="op" id="7371539">(</span><span class="op" id="7371540">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7371545">r</span>&nbsp;<span class="op" id="7371547">:=</span>&nbsp;<span class="ident" id="7371550">NewChunkedReader</span><span class="op" id="7371566">(</span><span class="ident" id="7371567">bufio</span><span class="op" id="7371572">.</span><span class="ident" id="7371573">NewReaderSize</span><span class="op" id="7371586">(</span><span class="op" id="7371587">&amp;</span><span class="ident" id="7371588">b</span><span class="op" id="7371589">,</span>&nbsp;<span class="num" id="7371591">16</span><span class="op" id="7371593">)</span><span class="op" id="7371594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7371598">buf</span>&nbsp;<span class="op" id="7371602">:=</span>&nbsp;<span class="builtinfunc" id="7371605">make</span><span class="op" id="7371609">(</span><span class="op" id="7371610">[</span><span class="op" id="7371611">]</span><span class="builtintype" id="7371612">byte</span><span class="op" id="7371616">,</span>&nbsp;<span class="builtinfunc" id="7371618">len</span><span class="op" id="7371621">(</span><span class="ident" id="7371622">fillBufChunk</span><span class="op" id="7371634">)</span><span class="op" id="7371635">+</span><span class="builtinfunc" id="7371636">len</span><span class="op" id="7371639">(</span><span class="ident" id="7371640">shortChunk</span><span class="op" id="7371650">)</span><span class="op" id="7371651">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7371655">n</span><span class="op" id="7371656">,</span>&nbsp;<span class="ident" id="7371658">err</span>&nbsp;<span class="op" id="7371662">:=</span>&nbsp;<span class="ident" id="7371665">r</span><span class="op" id="7371666">.</span><span class="ident" id="7371667">Read</span><span class="op" id="7371671">(</span><span class="ident" id="7371672">buf</span><span class="op" id="7371675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7371679">if</span>&nbsp;<span class="ident" id="7371682">n</span>&nbsp;<span class="op" id="7371684">!=</span>&nbsp;<span class="builtinfunc" id="7371687">len</span><span class="op" id="7371690">(</span><span class="ident" id="7371691">fillBufChunk</span><span class="op" id="7371703">)</span>&nbsp;<span class="op" id="7371705">||</span>&nbsp;<span class="ident" id="7371708">err</span>&nbsp;<span class="op" id="7371712">!=</span>&nbsp;<span class="ident" id="7371715">nil</span>&nbsp;<span class="op" id="7371719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7371724">t</span><span class="op" id="7371725">.</span><span class="ident" id="7371726">Errorf</span><span class="op" id="7371732">(</span><span class="string" id="7371733">&#34;Read&nbsp;=&nbsp;%d,&nbsp;%v;&nbsp;want&nbsp;%d,&nbsp;nil&#34;</span><span class="op" id="7371762">,</span>&nbsp;<span class="ident" id="7371764">n</span><span class="op" id="7371765">,</span>&nbsp;<span class="ident" id="7371767">err</span><span class="op" id="7371770">,</span>&nbsp;<span class="builtinfunc" id="7371772">len</span><span class="op" id="7371775">(</span><span class="ident" id="7371776">fillBufChunk</span><span class="op" id="7371788">)</span><span class="op" id="7371789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7371793">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7371797">buf</span>&nbsp;<span class="op" id="7371801">=</span>&nbsp;<span class="ident" id="7371803">buf</span><span class="op" id="7371806">[</span><span class="op" id="7371807">:</span><span class="ident" id="7371808">n</span><span class="op" id="7371809">]</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7371813">if</span>&nbsp;<span class="builtintype" id="7371816">string</span><span class="op" id="7371822">(</span><span class="ident" id="7371823">buf</span><span class="op" id="7371826">)</span>&nbsp;<span class="op" id="7371828">!=</span>&nbsp;<span class="ident" id="7371831">fillBufChunk</span>&nbsp;<span class="op" id="7371844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7371849">t</span><span class="op" id="7371850">.</span><span class="ident" id="7371851">Errorf</span><span class="op" id="7371857">(</span><span class="string" id="7371858">&#34;Read&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7371878">,</span>&nbsp;<span class="ident" id="7371880">buf</span><span class="op" id="7371883">,</span>&nbsp;<span class="ident" id="7371885">fillBufChunk</span><span class="op" id="7371897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7371901">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7371906">n</span><span class="op" id="7371907">,</span>&nbsp;<span class="ident" id="7371909">err</span>&nbsp;<span class="op" id="7371913">=</span>&nbsp;<span class="ident" id="7371915">r</span><span class="op" id="7371916">.</span><span class="ident" id="7371917">Read</span><span class="op" id="7371921">(</span><span class="ident" id="7371922">buf</span><span class="op" id="7371925">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7371929">if</span>&nbsp;<span class="ident" id="7371932">n</span>&nbsp;<span class="op" id="7371934">!=</span>&nbsp;<span class="builtinfunc" id="7371937">len</span><span class="op" id="7371940">(</span><span class="ident" id="7371941">shortChunk</span><span class="op" id="7371951">)</span>&nbsp;<span class="op" id="7371953">||</span>&nbsp;<span class="ident" id="7371956">err</span>&nbsp;<span class="op" id="7371960">!=</span>&nbsp;<span class="ident" id="7371963">io</span><span class="op" id="7371965">.</span><span class="ident" id="7371966">EOF</span>&nbsp;<span class="op" id="7371970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7371975">t</span><span class="op" id="7371976">.</span><span class="ident" id="7371977">Errorf</span><span class="op" id="7371983">(</span><span class="string" id="7371984">&#34;Read&nbsp;=&nbsp;%d,&nbsp;%v;&nbsp;want&nbsp;%d,&nbsp;EOF&#34;</span><span class="op" id="7372013">,</span>&nbsp;<span class="ident" id="7372015">n</span><span class="op" id="7372016">,</span>&nbsp;<span class="ident" id="7372018">err</span><span class="op" id="7372021">,</span>&nbsp;<span class="builtinfunc" id="7372023">len</span><span class="op" id="7372026">(</span><span class="ident" id="7372027">shortChunk</span><span class="op" id="7372037">)</span><span class="op" id="7372038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7372042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7372045">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7372049">//&nbsp;And&nbsp;test&nbsp;that&nbsp;we&nbsp;see&nbsp;an&nbsp;EOF&nbsp;chunk,&nbsp;even&nbsp;though&nbsp;our&nbsp;buffer&nbsp;is&nbsp;already&nbsp;full:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7372128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7372132">r</span>&nbsp;<span class="op" id="7372134">:=</span>&nbsp;<span class="ident" id="7372137">NewChunkedReader</span><span class="op" id="7372153">(</span><span class="ident" id="7372154">bufio</span><span class="op" id="7372159">.</span><span class="ident" id="7372160">NewReader</span><span class="op" id="7372169">(</span><span class="ident" id="7372170">strings</span><span class="op" id="7372177">.</span><span class="ident" id="7372178">NewReader</span><span class="op" id="7372187">(</span><span class="string" id="7372188">&#34;3\r\nfoo\r\n0\r\n&#34;</span><span class="op" id="7372207">)</span><span class="op" id="7372208">)</span><span class="op" id="7372209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7372213">buf</span>&nbsp;<span class="op" id="7372217">:=</span>&nbsp;<span class="builtinfunc" id="7372220">make</span><span class="op" id="7372224">(</span><span class="op" id="7372225">[</span><span class="op" id="7372226">]</span><span class="builtintype" id="7372227">byte</span><span class="op" id="7372231">,</span>&nbsp;<span class="num" id="7372233">3</span><span class="op" id="7372234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7372238">n</span><span class="op" id="7372239">,</span>&nbsp;<span class="ident" id="7372241">err</span>&nbsp;<span class="op" id="7372245">:=</span>&nbsp;<span class="ident" id="7372248">r</span><span class="op" id="7372249">.</span><span class="ident" id="7372250">Read</span><span class="op" id="7372254">(</span><span class="ident" id="7372255">buf</span><span class="op" id="7372258">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7372262">if</span>&nbsp;<span class="ident" id="7372265">n</span>&nbsp;<span class="op" id="7372267">!=</span>&nbsp;<span class="num" id="7372270">3</span>&nbsp;<span class="op" id="7372272">||</span>&nbsp;<span class="ident" id="7372275">err</span>&nbsp;<span class="op" id="7372279">!=</span>&nbsp;<span class="ident" id="7372282">io</span><span class="op" id="7372284">.</span><span class="ident" id="7372285">EOF</span>&nbsp;<span class="op" id="7372289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7372294">t</span><span class="op" id="7372295">.</span><span class="ident" id="7372296">Errorf</span><span class="op" id="7372302">(</span><span class="string" id="7372303">&#34;Read&nbsp;=&nbsp;%d,&nbsp;%v;&nbsp;want&nbsp;3,&nbsp;EOF&#34;</span><span class="op" id="7372331">,</span>&nbsp;<span class="ident" id="7372333">n</span><span class="op" id="7372334">,</span>&nbsp;<span class="ident" id="7372336">err</span><span class="op" id="7372339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7372343">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7372347">if</span>&nbsp;<span class="builtintype" id="7372350">string</span><span class="op" id="7372356">(</span><span class="ident" id="7372357">buf</span><span class="op" id="7372360">)</span>&nbsp;<span class="op" id="7372362">!=</span>&nbsp;<span class="string" id="7372365">&#34;foo&#34;</span>&nbsp;<span class="op" id="7372371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7372376">t</span><span class="op" id="7372377">.</span><span class="ident" id="7372378">Errorf</span><span class="op" id="7372384">(</span><span class="string" id="7372385">&#34;buf&nbsp;=&nbsp;%q;&nbsp;want&nbsp;foo&#34;</span><span class="op" id="7372405">,</span>&nbsp;<span class="ident" id="7372407">buf</span><span class="op" id="7372410">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7372414">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7372417">}</span><br>
<span class="lineno"></span><span class="op" id="7372419">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7372422">func</span>&nbsp;<span class="ident" id="7372427">TestChunkReaderAllocs</span><span class="op" id="7372448">(</span><span class="ident" id="7372449">t</span>&nbsp;<span class="op" id="7372451">*</span><span class="ident" id="7372452">testing</span><span class="op" id="7372459">.</span><span class="ident" id="7372460">T</span><span class="op" id="7372461">)</span>&nbsp;<span class="op" id="7372463">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7372466">if</span>&nbsp;<span class="ident" id="7372469">testing</span><span class="op" id="7372476">.</span><span class="ident" id="7372477">Short</span><span class="op" id="7372482">(</span><span class="op" id="7372483">)</span>&nbsp;<span class="op" id="7372485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7372489">t</span><span class="op" id="7372490">.</span><span class="ident" id="7372491">Skip</span><span class="op" id="7372495">(</span><span class="string" id="7372496">&#34;skipping&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="7372520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7372523">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7372526">var</span>&nbsp;<span class="ident" id="7372530">buf</span>&nbsp;<span class="ident" id="7372534">bytes</span><span class="op" id="7372539">.</span><span class="ident" id="7372540">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7372548">w</span>&nbsp;<span class="op" id="7372550">:=</span>&nbsp;<span class="ident" id="7372553">NewChunkedWriter</span><span class="op" id="7372569">(</span><span class="op" id="7372570">&amp;</span><span class="ident" id="7372571">buf</span><span class="op" id="7372574">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7372577">a</span><span class="op" id="7372578">,</span>&nbsp;<span class="ident" id="7372580">b</span><span class="op" id="7372581">,</span>&nbsp;<span class="ident" id="7372583">c</span>&nbsp;<span class="op" id="7372585">:=</span>&nbsp;<span class="op" id="7372588">[</span><span class="op" id="7372589">]</span><span class="builtintype" id="7372590">byte</span><span class="op" id="7372594">(</span><span class="string" id="7372595">&#34;aaaaaa&#34;</span><span class="op" id="7372603">)</span><span class="op" id="7372604">,</span>&nbsp;<span class="op" id="7372606">[</span><span class="op" id="7372607">]</span><span class="builtintype" id="7372608">byte</span><span class="op" id="7372612">(</span><span class="string" id="7372613">&#34;bbbbbbbbbbbb&#34;</span><span class="op" id="7372627">)</span><span class="op" id="7372628">,</span>&nbsp;<span class="op" id="7372630">[</span><span class="op" id="7372631">]</span><span class="builtintype" id="7372632">byte</span><span class="op" id="7372636">(</span><span class="string" id="7372637">&#34;cccccccccccccccccccccccc&#34;</span><span class="op" id="7372663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7372666">w</span><span class="op" id="7372667">.</span><span class="ident" id="7372668">Write</span><span class="op" id="7372673">(</span><span class="ident" id="7372674">a</span><span class="op" id="7372675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7372678">w</span><span class="op" id="7372679">.</span><span class="ident" id="7372680">Write</span><span class="op" id="7372685">(</span><span class="ident" id="7372686">b</span><span class="op" id="7372687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7372690">w</span><span class="op" id="7372691">.</span><span class="ident" id="7372692">Write</span><span class="op" id="7372697">(</span><span class="ident" id="7372698">c</span><span class="op" id="7372699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7372702">w</span><span class="op" id="7372703">.</span><span class="ident" id="7372704">Close</span><span class="op" id="7372709">(</span><span class="op" id="7372710">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7372714">readBuf</span>&nbsp;<span class="op" id="7372722">:=</span>&nbsp;<span class="builtinfunc" id="7372725">make</span><span class="op" id="7372729">(</span><span class="op" id="7372730">[</span><span class="op" id="7372731">]</span><span class="builtintype" id="7372732">byte</span><span class="op" id="7372736">,</span>&nbsp;<span class="builtinfunc" id="7372738">len</span><span class="op" id="7372741">(</span><span class="ident" id="7372742">a</span><span class="op" id="7372743">)</span><span class="op" id="7372744">+</span><span class="builtinfunc" id="7372745">len</span><span class="op" id="7372748">(</span><span class="ident" id="7372749">b</span><span class="op" id="7372750">)</span><span class="op" id="7372751">+</span><span class="builtinfunc" id="7372752">len</span><span class="op" id="7372755">(</span><span class="ident" id="7372756">c</span><span class="op" id="7372757">)</span><span class="op" id="7372758">+</span><span class="num" id="7372759">1</span><span class="op" id="7372760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7372763">byter</span>&nbsp;<span class="op" id="7372769">:=</span>&nbsp;<span class="ident" id="7372772">bytes</span><span class="op" id="7372777">.</span><span class="ident" id="7372778">NewReader</span><span class="op" id="7372787">(</span><span class="ident" id="7372788">buf</span><span class="op" id="7372791">.</span><span class="ident" id="7372792">Bytes</span><span class="op" id="7372797">(</span><span class="op" id="7372798">)</span><span class="op" id="7372799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7372802">bufr</span>&nbsp;<span class="op" id="7372807">:=</span>&nbsp;<span class="ident" id="7372810">bufio</span><span class="op" id="7372815">.</span><span class="ident" id="7372816">NewReader</span><span class="op" id="7372825">(</span><span class="ident" id="7372826">byter</span><span class="op" id="7372831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7372834">mallocs</span>&nbsp;<span class="op" id="7372842">:=</span>&nbsp;<span class="ident" id="7372845">testing</span><span class="op" id="7372852">.</span><span class="ident" id="7372853">AllocsPerRun</span><span class="op" id="7372865">(</span><span class="num" id="7372866">100</span><span class="op" id="7372869">,</span>&nbsp;<span class="keyword" id="7372871">func</span><span class="op" id="7372875">(</span><span class="op" id="7372876">)</span>&nbsp;<span class="op" id="7372878">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7372882">byter</span><span class="op" id="7372887">.</span><span class="ident" id="7372888">Seek</span><span class="op" id="7372892">(</span><span class="num" id="7372893">0</span><span class="op" id="7372894">,</span>&nbsp;<span class="num" id="7372896">0</span><span class="op" id="7372897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7372901">bufr</span><span class="op" id="7372905">.</span><span class="ident" id="7372906">Reset</span><span class="op" id="7372911">(</span><span class="ident" id="7372912">byter</span><span class="op" id="7372917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7372921">r</span>&nbsp;<span class="op" id="7372923">:=</span>&nbsp;<span class="ident" id="7372926">NewChunkedReader</span><span class="op" id="7372942">(</span><span class="ident" id="7372943">bufr</span><span class="op" id="7372947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7372951">n</span><span class="op" id="7372952">,</span>&nbsp;<span class="ident" id="7372954">err</span>&nbsp;<span class="op" id="7372958">:=</span>&nbsp;<span class="ident" id="7372961">io</span><span class="op" id="7372963">.</span><span class="ident" id="7372964">ReadFull</span><span class="op" id="7372972">(</span><span class="ident" id="7372973">r</span><span class="op" id="7372974">,</span>&nbsp;<span class="ident" id="7372976">readBuf</span><span class="op" id="7372983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7372987">if</span>&nbsp;<span class="ident" id="7372990">n</span>&nbsp;<span class="op" id="7372992">!=</span>&nbsp;<span class="builtinfunc" id="7372995">len</span><span class="op" id="7372998">(</span><span class="ident" id="7372999">readBuf</span><span class="op" id="7373006">)</span><span class="op" id="7373007">-</span><span class="num" id="7373008">1</span>&nbsp;<span class="op" id="7373010">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7373015">t</span><span class="op" id="7373016">.</span><span class="ident" id="7373017">Fatalf</span><span class="op" id="7373023">(</span><span class="string" id="7373024">&#34;read&nbsp;%d&nbsp;bytes;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7373048">,</span>&nbsp;<span class="ident" id="7373050">n</span><span class="op" id="7373051">,</span>&nbsp;<span class="builtinfunc" id="7373053">len</span><span class="op" id="7373056">(</span><span class="ident" id="7373057">readBuf</span><span class="op" id="7373064">)</span><span class="op" id="7373065">-</span><span class="num" id="7373066">1</span><span class="op" id="7373067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7373071">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7373075">if</span>&nbsp;<span class="ident" id="7373078">err</span>&nbsp;<span class="op" id="7373082">!=</span>&nbsp;<span class="ident" id="7373085">io</span><span class="op" id="7373087">.</span><span class="ident" id="7373088">ErrUnexpectedEOF</span>&nbsp;<span class="op" id="7373105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7373110">t</span><span class="op" id="7373111">.</span><span class="ident" id="7373112">Fatalf</span><span class="op" id="7373118">(</span><span class="string" id="7373119">&#34;read&nbsp;error&nbsp;=&nbsp;%v;&nbsp;want&nbsp;ErrUnexpectedEOF&#34;</span><span class="op" id="7373159">,</span>&nbsp;<span class="ident" id="7373161">err</span><span class="op" id="7373164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7373168">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7373171">}</span><span class="op" id="7373172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7373175">if</span>&nbsp;<span class="ident" id="7373178">mallocs</span>&nbsp;<span class="op" id="7373186">&gt;</span>&nbsp;<span class="num" id="7373188">1.5</span>&nbsp;<span class="op" id="7373192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7373196">t</span><span class="op" id="7373197">.</span><span class="ident" id="7373198">Errorf</span><span class="op" id="7373204">(</span><span class="string" id="7373205">&#34;mallocs&nbsp;=&nbsp;%v;&nbsp;want&nbsp;1&#34;</span><span class="op" id="7373227">,</span>&nbsp;<span class="ident" id="7373229">mallocs</span><span class="op" id="7373236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7373239">}</span><br>
<span class="lineno"></span><span class="op" id="7373241">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="keyword" id="7373244">func</span>&nbsp;<span class="ident" id="7373249">TestParseHexUint</span><span class="op" id="7373265">(</span><span class="ident" id="7373266">t</span>&nbsp;<span class="op" id="7373268">*</span><span class="ident" id="7373269">testing</span><span class="op" id="7373276">.</span><span class="ident" id="7373277">T</span><span class="op" id="7373278">)</span>&nbsp;<span class="op" id="7373280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7373283">for</span>&nbsp;<span class="ident" id="7373287">i</span>&nbsp;<span class="op" id="7373289">:=</span>&nbsp;<span class="ident" id="7373292">uint64</span><span class="op" id="7373298">(</span><span class="num" id="7373299">0</span><span class="op" id="7373300">)</span><span class="op" id="7373301">;</span>&nbsp;<span class="ident" id="7373303">i</span>&nbsp;<span class="op" id="7373305">&lt;=</span>&nbsp;<span class="num" id="7373308">1234</span><span class="op" id="7373312">;</span>&nbsp;<span class="ident" id="7373314">i</span><span class="op" id="7373315">++</span>&nbsp;<span class="op" id="7373318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7373322">line</span>&nbsp;<span class="op" id="7373327">:=</span>&nbsp;<span class="op" id="7373330">[</span><span class="op" id="7373331">]</span><span class="builtintype" id="7373332">byte</span><span class="op" id="7373336">(</span><span class="ident" id="7373337">fmt</span><span class="op" id="7373340">.</span><span class="ident" id="7373341">Sprintf</span><span class="op" id="7373348">(</span><span class="string" id="7373349">&#34;%x&#34;</span><span class="op" id="7373353">,</span>&nbsp;<span class="ident" id="7373355">i</span><span class="op" id="7373356">)</span><span class="op" id="7373357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7373361">got</span><span class="op" id="7373364">,</span>&nbsp;<span class="ident" id="7373366">err</span>&nbsp;<span class="op" id="7373370">:=</span>&nbsp;<span class="ident" id="7373373">parseHexUint</span><span class="op" id="7373385">(</span><span class="ident" id="7373386">line</span><span class="op" id="7373390">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7373394">if</span>&nbsp;<span class="ident" id="7373397">err</span>&nbsp;<span class="op" id="7373401">!=</span>&nbsp;<span class="ident" id="7373404">nil</span>&nbsp;<span class="op" id="7373408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7373413">t</span><span class="op" id="7373414">.</span><span class="ident" id="7373415">Fatalf</span><span class="op" id="7373421">(</span><span class="string" id="7373422">&#34;on&nbsp;%d:&nbsp;%v&#34;</span><span class="op" id="7373433">,</span>&nbsp;<span class="ident" id="7373435">i</span><span class="op" id="7373436">,</span>&nbsp;<span class="ident" id="7373438">err</span><span class="op" id="7373441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7373445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7373449">if</span>&nbsp;<span class="ident" id="7373452">got</span>&nbsp;<span class="op" id="7373456">!=</span>&nbsp;<span class="ident" id="7373459">i</span>&nbsp;<span class="op" id="7373461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7373466">t</span><span class="op" id="7373467">.</span><span class="ident" id="7373468">Errorf</span><span class="op" id="7373474">(</span><span class="string" id="7373475">&#34;for&nbsp;input&nbsp;%q&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7373503">,</span>&nbsp;<span class="ident" id="7373505">line</span><span class="op" id="7373509">,</span>&nbsp;<span class="ident" id="7373511">got</span><span class="op" id="7373514">,</span>&nbsp;<span class="ident" id="7373516">i</span><span class="op" id="7373517">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7373521">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7373524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7373527">_</span><span class="op" id="7373528">,</span>&nbsp;<span class="ident" id="7373530">err</span>&nbsp;<span class="op" id="7373534">:=</span>&nbsp;<span class="ident" id="7373537">parseHexUint</span><span class="op" id="7373549">(</span><span class="op" id="7373550">[</span><span class="op" id="7373551">]</span><span class="builtintype" id="7373552">byte</span><span class="op" id="7373556">(</span><span class="string" id="7373557">&#34;bogus&#34;</span><span class="op" id="7373564">)</span><span class="op" id="7373565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7373568">if</span>&nbsp;<span class="ident" id="7373571">err</span>&nbsp;<span class="op" id="7373575">==</span>&nbsp;<span class="ident" id="7373578">nil</span>&nbsp;<span class="op" id="7373582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7373586">t</span><span class="op" id="7373587">.</span><span class="ident" id="7373588">Error</span><span class="op" id="7373593">(</span><span class="string" id="7373594">&#34;expected&nbsp;error&nbsp;on&nbsp;bogus&nbsp;input&#34;</span><span class="op" id="7373625">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7373628">}</span><br>
<span class="lineno"></span><span class="op" id="7373630">}</span>
</div>
</body>
</html>
