<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="6291608">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6291663">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6291717">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6291768">//&nbsp;Package&nbsp;jpeg&nbsp;implements&nbsp;a&nbsp;JPEG&nbsp;image&nbsp;decoder&nbsp;and&nbsp;encoder.</span><br>
<span class="lineno"></span><span class="comment" id="6291829">//</span><br>
<span class="lineno"></span><span class="comment" id="6291832">//&nbsp;JPEG&nbsp;is&nbsp;defined&nbsp;in&nbsp;ITU-T&nbsp;T.81:&nbsp;http://www.w3.org/Graphics/JPEG/itu-t81.pdf.</span><br>
<span class="lineno"></span><span class="keyword" id="6291911">package</span>&nbsp;<span class="ident" id="6291919">jpeg</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="6291925">import</span>&nbsp;<span class="op" id="6291932">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6291935">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6291944">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6291959">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="6291964">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="6291967">//&nbsp;TODO(nigeltao):&nbsp;fix&nbsp;up&nbsp;the&nbsp;doc&nbsp;comment&nbsp;style&nbsp;so&nbsp;that&nbsp;sentences&nbsp;start&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="6292044">//&nbsp;the&nbsp;name&nbsp;of&nbsp;the&nbsp;type&nbsp;or&nbsp;function&nbsp;that&nbsp;they&nbsp;annotate.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6292101">//&nbsp;A&nbsp;FormatError&nbsp;reports&nbsp;that&nbsp;the&nbsp;input&nbsp;is&nbsp;not&nbsp;a&nbsp;valid&nbsp;JPEG.</span><br>
<span class="lineno">20</span><span class="keyword" id="6292162">type</span>&nbsp;<span class="ident" id="6292167">FormatError</span>&nbsp;<span class="builtintype" id="6292179">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6292187">func</span>&nbsp;<span class="op" id="6292192">(</span><span class="ident" id="6292193">e</span>&nbsp;<span class="ident" id="6292195">FormatError</span><span class="op" id="6292206">)</span>&nbsp;<span class="ident" id="6292208">Error</span><span class="op" id="6292213">(</span><span class="op" id="6292214">)</span>&nbsp;<span class="builtintype" id="6292216">string</span>&nbsp;<span class="op" id="6292223">{</span>&nbsp;<span class="keyword" id="6292225">return</span>&nbsp;<span class="string" id="6292232">&#34;invalid&nbsp;JPEG&nbsp;format:&nbsp;&#34;</span>&nbsp;<span class="op" id="6292256">+</span>&nbsp;<span class="builtintype" id="6292258">string</span><span class="op" id="6292264">(</span><span class="ident" id="6292265">e</span><span class="op" id="6292266">)</span>&nbsp;<span class="op" id="6292268">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6292271">//&nbsp;An&nbsp;UnsupportedError&nbsp;reports&nbsp;that&nbsp;the&nbsp;input&nbsp;uses&nbsp;a&nbsp;valid&nbsp;but&nbsp;unimplemented&nbsp;JPEG&nbsp;feature.</span><br>
<span class="lineno">25</span><span class="keyword" id="6292362">type</span>&nbsp;<span class="ident" id="6292367">UnsupportedError</span>&nbsp;<span class="builtintype" id="6292384">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6292392">func</span>&nbsp;<span class="op" id="6292397">(</span><span class="ident" id="6292398">e</span>&nbsp;<span class="ident" id="6292400">UnsupportedError</span><span class="op" id="6292416">)</span>&nbsp;<span class="ident" id="6292418">Error</span><span class="op" id="6292423">(</span><span class="op" id="6292424">)</span>&nbsp;<span class="builtintype" id="6292426">string</span>&nbsp;<span class="op" id="6292433">{</span>&nbsp;<span class="keyword" id="6292435">return</span>&nbsp;<span class="string" id="6292442">&#34;unsupported&nbsp;JPEG&nbsp;feature:&nbsp;&#34;</span>&nbsp;<span class="op" id="6292471">+</span>&nbsp;<span class="builtintype" id="6292473">string</span><span class="op" id="6292479">(</span><span class="ident" id="6292480">e</span><span class="op" id="6292481">)</span>&nbsp;<span class="op" id="6292483">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6292486">//&nbsp;Component&nbsp;specification,&nbsp;specified&nbsp;in&nbsp;section&nbsp;B.2.2.</span><br>
<span class="lineno">30</span><span class="keyword" id="6292542">type</span>&nbsp;<span class="ident" id="6292547">component</span>&nbsp;<span class="keyword" id="6292557">struct</span>&nbsp;<span class="op" id="6292564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6292567">h</span>&nbsp;&nbsp;<span class="builtintype" id="6292570">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="6292576">//&nbsp;Horizontal&nbsp;sampling&nbsp;factor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6292608">v</span>&nbsp;&nbsp;<span class="builtintype" id="6292611">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="6292617">//&nbsp;Vertical&nbsp;sampling&nbsp;factor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6292647">c</span>&nbsp;&nbsp;<span class="builtintype" id="6292650">uint8</span>&nbsp;<span class="comment" id="6292656">//&nbsp;Component&nbsp;identifier.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6292682">tq</span>&nbsp;<span class="builtintype" id="6292685">uint8</span>&nbsp;<span class="comment" id="6292691">//&nbsp;Quantization&nbsp;table&nbsp;destination&nbsp;selector.</span><br>
<span class="lineno">35</span><span class="op" id="6292735">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6292738">const</span>&nbsp;<span class="op" id="6292744">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6292747">dcTable</span>&nbsp;<span class="op" id="6292755">=</span>&nbsp;<span class="num" id="6292757">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6292760">acTable</span>&nbsp;<span class="op" id="6292768">=</span>&nbsp;<span class="num" id="6292770">1</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6292773">maxTc</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6292781">=</span>&nbsp;<span class="num" id="6292783">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6292786">maxTh</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6292794">=</span>&nbsp;<span class="num" id="6292796">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6292799">maxTq</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6292807">=</span>&nbsp;<span class="num" id="6292809">3</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6292813">//&nbsp;A&nbsp;grayscale&nbsp;JPEG&nbsp;image&nbsp;has&nbsp;only&nbsp;a&nbsp;Y&nbsp;component.</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6292864">nGrayComponent</span>&nbsp;<span class="op" id="6292879">=</span>&nbsp;<span class="num" id="6292881">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6292884">//&nbsp;A&nbsp;color&nbsp;JPEG&nbsp;image&nbsp;has&nbsp;Y,&nbsp;Cb&nbsp;and&nbsp;Cr&nbsp;components.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6292936">nColorComponent</span>&nbsp;<span class="op" id="6292952">=</span>&nbsp;<span class="num" id="6292954">3</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6292958">//&nbsp;We&nbsp;only&nbsp;support&nbsp;4:4:4,&nbsp;4:4:0,&nbsp;4:2:2&nbsp;and&nbsp;4:2:0&nbsp;downsampling,&nbsp;and&nbsp;therefore&nbsp;the</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6293040">//&nbsp;number&nbsp;of&nbsp;luma&nbsp;samples&nbsp;per&nbsp;chroma&nbsp;sample&nbsp;is&nbsp;at&nbsp;most&nbsp;2&nbsp;in&nbsp;the&nbsp;horizontal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6293116">//&nbsp;and&nbsp;2&nbsp;in&nbsp;the&nbsp;vertical&nbsp;direction.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6293153">maxH</span>&nbsp;<span class="op" id="6293158">=</span>&nbsp;<span class="num" id="6293160">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6293163">maxV</span>&nbsp;<span class="op" id="6293168">=</span>&nbsp;<span class="num" id="6293170">2</span><br>
<span class="lineno"></span><span class="op" id="6293172">)</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="6293175">const</span>&nbsp;<span class="op" id="6293181">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6293184">soiMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6293196">=</span>&nbsp;<span class="num" id="6293198">0xd8</span>&nbsp;<span class="comment" id="6293203">//&nbsp;Start&nbsp;Of&nbsp;Image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6293223">eoiMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6293235">=</span>&nbsp;<span class="num" id="6293237">0xd9</span>&nbsp;<span class="comment" id="6293242">//&nbsp;End&nbsp;Of&nbsp;Image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6293260">sof0Marker</span>&nbsp;&nbsp;<span class="op" id="6293272">=</span>&nbsp;<span class="num" id="6293274">0xc0</span>&nbsp;<span class="comment" id="6293279">//&nbsp;Start&nbsp;Of&nbsp;Frame&nbsp;(Baseline).</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6293310">sof2Marker</span>&nbsp;&nbsp;<span class="op" id="6293322">=</span>&nbsp;<span class="num" id="6293324">0xc2</span>&nbsp;<span class="comment" id="6293329">//&nbsp;Start&nbsp;Of&nbsp;Frame&nbsp;(Progressive).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6293363">dhtMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6293375">=</span>&nbsp;<span class="num" id="6293377">0xc4</span>&nbsp;<span class="comment" id="6293382">//&nbsp;Define&nbsp;Huffman&nbsp;Table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6293408">dqtMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6293420">=</span>&nbsp;<span class="num" id="6293422">0xdb</span>&nbsp;<span class="comment" id="6293427">//&nbsp;Define&nbsp;Quantization&nbsp;Table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6293458">sosMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6293470">=</span>&nbsp;<span class="num" id="6293472">0xda</span>&nbsp;<span class="comment" id="6293477">//&nbsp;Start&nbsp;Of&nbsp;Scan.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6293496">driMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6293508">=</span>&nbsp;<span class="num" id="6293510">0xdd</span>&nbsp;<span class="comment" id="6293515">//&nbsp;Define&nbsp;Restart&nbsp;Interval.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6293544">rst0Marker</span>&nbsp;&nbsp;<span class="op" id="6293556">=</span>&nbsp;<span class="num" id="6293558">0xd0</span>&nbsp;<span class="comment" id="6293563">//&nbsp;ReSTart&nbsp;(0).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6293580">rst7Marker</span>&nbsp;&nbsp;<span class="op" id="6293592">=</span>&nbsp;<span class="num" id="6293594">0xd7</span>&nbsp;<span class="comment" id="6293599">//&nbsp;ReSTart&nbsp;(7).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6293616">app0Marker</span>&nbsp;&nbsp;<span class="op" id="6293628">=</span>&nbsp;<span class="num" id="6293630">0xe0</span>&nbsp;<span class="comment" id="6293635">//&nbsp;APPlication&nbsp;specific&nbsp;(0).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6293665">app15Marker</span>&nbsp;<span class="op" id="6293677">=</span>&nbsp;<span class="num" id="6293679">0xef</span>&nbsp;<span class="comment" id="6293684">//&nbsp;APPlication&nbsp;specific&nbsp;(15).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6293715">comMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6293727">=</span>&nbsp;<span class="num" id="6293729">0xfe</span>&nbsp;<span class="comment" id="6293734">//&nbsp;COMment.</span><br>
<span class="lineno">70</span><span class="op" id="6293746">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6293749">//&nbsp;unzig&nbsp;maps&nbsp;from&nbsp;the&nbsp;zig-zag&nbsp;ordering&nbsp;to&nbsp;the&nbsp;natural&nbsp;ordering.&nbsp;For&nbsp;example,</span><br>
<span class="lineno"></span><span class="comment" id="6293827">//&nbsp;unzig[3]&nbsp;is&nbsp;the&nbsp;column&nbsp;and&nbsp;row&nbsp;of&nbsp;the&nbsp;fourth&nbsp;element&nbsp;in&nbsp;zig-zag&nbsp;order.&nbsp;The</span><br>
<span class="lineno"></span><span class="comment" id="6293905">//&nbsp;value&nbsp;is&nbsp;16,&nbsp;which&nbsp;means&nbsp;first&nbsp;column&nbsp;(16%8&nbsp;==&nbsp;0)&nbsp;and&nbsp;third&nbsp;row&nbsp;(16/8&nbsp;==&nbsp;2).</span><br>
<span class="lineno">75</span><span class="keyword" id="6293985">var</span>&nbsp;<span class="ident" id="6293989">unzig</span>&nbsp;<span class="op" id="6293995">=</span>&nbsp;<span class="op" id="6293997">[</span><span class="ident" id="6293998">blockSize</span><span class="op" id="6294007">]</span><span class="builtintype" id="6294008">int</span><span class="op" id="6294011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="6294014">0</span><span class="op" id="6294015">,</span>&nbsp;<span class="num" id="6294017">1</span><span class="op" id="6294018">,</span>&nbsp;<span class="num" id="6294020">8</span><span class="op" id="6294021">,</span>&nbsp;<span class="num" id="6294023">16</span><span class="op" id="6294025">,</span>&nbsp;<span class="num" id="6294027">9</span><span class="op" id="6294028">,</span>&nbsp;<span class="num" id="6294030">2</span><span class="op" id="6294031">,</span>&nbsp;<span class="num" id="6294033">3</span><span class="op" id="6294034">,</span>&nbsp;<span class="num" id="6294036">10</span><span class="op" id="6294038">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="6294041">17</span><span class="op" id="6294043">,</span>&nbsp;<span class="num" id="6294045">24</span><span class="op" id="6294047">,</span>&nbsp;<span class="num" id="6294049">32</span><span class="op" id="6294051">,</span>&nbsp;<span class="num" id="6294053">25</span><span class="op" id="6294055">,</span>&nbsp;<span class="num" id="6294057">18</span><span class="op" id="6294059">,</span>&nbsp;<span class="num" id="6294061">11</span><span class="op" id="6294063">,</span>&nbsp;<span class="num" id="6294065">4</span><span class="op" id="6294066">,</span>&nbsp;<span class="num" id="6294068">5</span><span class="op" id="6294069">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="6294072">12</span><span class="op" id="6294074">,</span>&nbsp;<span class="num" id="6294076">19</span><span class="op" id="6294078">,</span>&nbsp;<span class="num" id="6294080">26</span><span class="op" id="6294082">,</span>&nbsp;<span class="num" id="6294084">33</span><span class="op" id="6294086">,</span>&nbsp;<span class="num" id="6294088">40</span><span class="op" id="6294090">,</span>&nbsp;<span class="num" id="6294092">48</span><span class="op" id="6294094">,</span>&nbsp;<span class="num" id="6294096">41</span><span class="op" id="6294098">,</span>&nbsp;<span class="num" id="6294100">34</span><span class="op" id="6294102">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="6294105">27</span><span class="op" id="6294107">,</span>&nbsp;<span class="num" id="6294109">20</span><span class="op" id="6294111">,</span>&nbsp;<span class="num" id="6294113">13</span><span class="op" id="6294115">,</span>&nbsp;<span class="num" id="6294117">6</span><span class="op" id="6294118">,</span>&nbsp;<span class="num" id="6294120">7</span><span class="op" id="6294121">,</span>&nbsp;<span class="num" id="6294123">14</span><span class="op" id="6294125">,</span>&nbsp;<span class="num" id="6294127">21</span><span class="op" id="6294129">,</span>&nbsp;<span class="num" id="6294131">28</span><span class="op" id="6294133">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="6294136">35</span><span class="op" id="6294138">,</span>&nbsp;<span class="num" id="6294140">42</span><span class="op" id="6294142">,</span>&nbsp;<span class="num" id="6294144">49</span><span class="op" id="6294146">,</span>&nbsp;<span class="num" id="6294148">56</span><span class="op" id="6294150">,</span>&nbsp;<span class="num" id="6294152">57</span><span class="op" id="6294154">,</span>&nbsp;<span class="num" id="6294156">50</span><span class="op" id="6294158">,</span>&nbsp;<span class="num" id="6294160">43</span><span class="op" id="6294162">,</span>&nbsp;<span class="num" id="6294164">36</span><span class="op" id="6294166">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="6294169">29</span><span class="op" id="6294171">,</span>&nbsp;<span class="num" id="6294173">22</span><span class="op" id="6294175">,</span>&nbsp;<span class="num" id="6294177">15</span><span class="op" id="6294179">,</span>&nbsp;<span class="num" id="6294181">23</span><span class="op" id="6294183">,</span>&nbsp;<span class="num" id="6294185">30</span><span class="op" id="6294187">,</span>&nbsp;<span class="num" id="6294189">37</span><span class="op" id="6294191">,</span>&nbsp;<span class="num" id="6294193">44</span><span class="op" id="6294195">,</span>&nbsp;<span class="num" id="6294197">51</span><span class="op" id="6294199">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="6294202">58</span><span class="op" id="6294204">,</span>&nbsp;<span class="num" id="6294206">59</span><span class="op" id="6294208">,</span>&nbsp;<span class="num" id="6294210">52</span><span class="op" id="6294212">,</span>&nbsp;<span class="num" id="6294214">45</span><span class="op" id="6294216">,</span>&nbsp;<span class="num" id="6294218">38</span><span class="op" id="6294220">,</span>&nbsp;<span class="num" id="6294222">31</span><span class="op" id="6294224">,</span>&nbsp;<span class="num" id="6294226">39</span><span class="op" id="6294228">,</span>&nbsp;<span class="num" id="6294230">46</span><span class="op" id="6294232">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="6294235">53</span><span class="op" id="6294237">,</span>&nbsp;<span class="num" id="6294239">60</span><span class="op" id="6294241">,</span>&nbsp;<span class="num" id="6294243">61</span><span class="op" id="6294245">,</span>&nbsp;<span class="num" id="6294247">54</span><span class="op" id="6294249">,</span>&nbsp;<span class="num" id="6294251">47</span><span class="op" id="6294253">,</span>&nbsp;<span class="num" id="6294255">55</span><span class="op" id="6294257">,</span>&nbsp;<span class="num" id="6294259">62</span><span class="op" id="6294261">,</span>&nbsp;<span class="num" id="6294263">63</span><span class="op" id="6294265">,</span><br>
<span class="lineno"></span><span class="op" id="6294267">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="comment" id="6294270">//&nbsp;Reader&nbsp;is&nbsp;deprecated.</span><br>
<span class="lineno"></span><span class="keyword" id="6294295">type</span>&nbsp;<span class="ident" id="6294300">Reader</span>&nbsp;<span class="keyword" id="6294307">interface</span>&nbsp;<span class="op" id="6294317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6294320">io</span><span class="op" id="6294322">.</span><span class="ident" id="6294323">ByteReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6294335">io</span><span class="op" id="6294337">.</span><span class="ident" id="6294338">Reader</span><br>
<span class="lineno">90</span><span class="op" id="6294345">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6294348">//&nbsp;bits&nbsp;holds&nbsp;the&nbsp;unprocessed&nbsp;bits&nbsp;that&nbsp;have&nbsp;been&nbsp;taken&nbsp;from&nbsp;the&nbsp;byte-stream.</span><br>
<span class="lineno"></span><span class="comment" id="6294426">//&nbsp;The&nbsp;n&nbsp;least&nbsp;significant&nbsp;bits&nbsp;of&nbsp;a&nbsp;form&nbsp;the&nbsp;unread&nbsp;bits,&nbsp;to&nbsp;be&nbsp;read&nbsp;in&nbsp;MSB&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="6294506">//&nbsp;LSB&nbsp;order.</span><br>
<span class="lineno">95</span><span class="keyword" id="6294520">type</span>&nbsp;<span class="ident" id="6294525">bits</span>&nbsp;<span class="keyword" id="6294530">struct</span>&nbsp;<span class="op" id="6294537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6294540">a</span>&nbsp;<span class="builtintype" id="6294542">uint32</span>&nbsp;<span class="comment" id="6294549">//&nbsp;accumulator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6294566">m</span>&nbsp;<span class="builtintype" id="6294568">uint32</span>&nbsp;<span class="comment" id="6294575">//&nbsp;mask.&nbsp;m==1&lt;&lt;(n-1)&nbsp;when&nbsp;n&gt;0,&nbsp;with&nbsp;m==0&nbsp;when&nbsp;n==0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6294628">n</span>&nbsp;<span class="builtintype" id="6294630">int32</span>&nbsp;&nbsp;<span class="comment" id="6294637">//&nbsp;the&nbsp;number&nbsp;of&nbsp;unread&nbsp;bits&nbsp;in&nbsp;a.</span><br>
<span class="lineno"></span><span class="op" id="6294672">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="6294675">type</span>&nbsp;<span class="ident" id="6294680">decoder</span>&nbsp;<span class="keyword" id="6294688">struct</span>&nbsp;<span class="op" id="6294695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6294698">r</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6294703">io</span><span class="op" id="6294705">.</span><span class="ident" id="6294706">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6294714">bits</span>&nbsp;<span class="ident" id="6294719">bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6294725">//&nbsp;bytes&nbsp;is&nbsp;a&nbsp;byte&nbsp;buffer,&nbsp;similar&nbsp;to&nbsp;a&nbsp;bufio.Reader,&nbsp;except&nbsp;that&nbsp;it</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6294795">//&nbsp;has&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;unread&nbsp;more&nbsp;than&nbsp;1&nbsp;byte,&nbsp;due&nbsp;to&nbsp;byte&nbsp;stuffing.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6294864">//&nbsp;Byte&nbsp;stuffing&nbsp;is&nbsp;specified&nbsp;in&nbsp;section&nbsp;F.1.2.3.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6294915">bytes</span>&nbsp;<span class="keyword" id="6294921">struct</span>&nbsp;<span class="op" id="6294928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6294932">//&nbsp;buf[i:j]&nbsp;are&nbsp;the&nbsp;buffered&nbsp;bytes&nbsp;read&nbsp;from&nbsp;the&nbsp;underlying</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6294994">//&nbsp;io.Reader&nbsp;that&nbsp;haven&#39;t&nbsp;yet&nbsp;been&nbsp;passed&nbsp;further&nbsp;on.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6295050">buf</span>&nbsp;&nbsp;<span class="op" id="6295055">[</span><span class="num" id="6295056">4096</span><span class="op" id="6295060">]</span><span class="builtintype" id="6295061">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6295068">i</span><span class="op" id="6295069">,</span>&nbsp;<span class="ident" id="6295071">j</span>&nbsp;<span class="builtintype" id="6295073">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6295079">//&nbsp;nUnreadable&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;to&nbsp;back&nbsp;up&nbsp;i&nbsp;after</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6295138">//&nbsp;overshooting.&nbsp;It&nbsp;can&nbsp;be&nbsp;0,&nbsp;1&nbsp;or&nbsp;2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6295178">nUnreadable</span>&nbsp;<span class="builtintype" id="6295190">int</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6295195">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6295198">width</span><span class="op" id="6295203">,</span>&nbsp;<span class="ident" id="6295205">height</span>&nbsp;<span class="builtintype" id="6295212">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6295217">img1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6295231">*</span><span class="ident" id="6295232">image</span><span class="op" id="6295237">.</span><span class="ident" id="6295238">Gray</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6295244">img3</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6295258">*</span><span class="ident" id="6295259">image</span><span class="op" id="6295264">.</span><span class="ident" id="6295265">YCbCr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6295272">ri</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6295286">int</span>&nbsp;<span class="comment" id="6295290">//&nbsp;Restart&nbsp;Interval.</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6295312">nComp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6295326">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6295331">progressive</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6295345">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6295351">eobRun</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6295365">uint16</span>&nbsp;<span class="comment" id="6295372">//&nbsp;End-of-Band&nbsp;run,&nbsp;specified&nbsp;in&nbsp;section&nbsp;G.1.2.2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6295423">comp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6295437">[</span><span class="ident" id="6295438">nColorComponent</span><span class="op" id="6295453">]</span><span class="ident" id="6295454">component</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6295465">progCoeffs</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6295479">[</span><span class="ident" id="6295480">nColorComponent</span><span class="op" id="6295495">]</span><span class="op" id="6295496">[</span><span class="op" id="6295497">]</span><span class="ident" id="6295498">block</span>&nbsp;<span class="comment" id="6295504">//&nbsp;Saved&nbsp;state&nbsp;between&nbsp;progressive-mode&nbsp;scans.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6295552">huff</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6295566">[</span><span class="ident" id="6295567">maxTc</span>&nbsp;<span class="op" id="6295573">+</span>&nbsp;<span class="num" id="6295575">1</span><span class="op" id="6295576">]</span><span class="op" id="6295577">[</span><span class="ident" id="6295578">maxTh</span>&nbsp;<span class="op" id="6295584">+</span>&nbsp;<span class="num" id="6295586">1</span><span class="op" id="6295587">]</span><span class="ident" id="6295588">huffman</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6295597">quant</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6295611">[</span><span class="ident" id="6295612">maxTq</span>&nbsp;<span class="op" id="6295618">+</span>&nbsp;<span class="num" id="6295620">1</span><span class="op" id="6295621">]</span><span class="ident" id="6295622">block</span>&nbsp;<span class="comment" id="6295628">//&nbsp;Quantization&nbsp;tables,&nbsp;in&nbsp;zig-zag&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6295671">tmp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6295685">[</span><span class="ident" id="6295686">blockSize</span>&nbsp;<span class="op" id="6295696">+</span>&nbsp;<span class="num" id="6295698">1</span><span class="op" id="6295699">]</span><span class="builtintype" id="6295700">byte</span><br>
<span class="lineno"></span><span class="op" id="6295705">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="comment" id="6295708">//&nbsp;fill&nbsp;fills&nbsp;up&nbsp;the&nbsp;d.bytes.buf&nbsp;buffer&nbsp;from&nbsp;the&nbsp;underlying&nbsp;io.Reader.&nbsp;It</span><br>
<span class="lineno"></span><span class="comment" id="6295782">//&nbsp;should&nbsp;only&nbsp;be&nbsp;called&nbsp;when&nbsp;there&nbsp;are&nbsp;no&nbsp;unread&nbsp;bytes&nbsp;in&nbsp;d.bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="6295850">func</span>&nbsp;<span class="op" id="6295855">(</span><span class="ident" id="6295856">d</span>&nbsp;<span class="op" id="6295858">*</span><span class="ident" id="6295859">decoder</span><span class="op" id="6295866">)</span>&nbsp;<span class="ident" id="6295868">fill</span><span class="op" id="6295872">(</span><span class="op" id="6295873">)</span>&nbsp;<span class="builtintype" id="6295875">error</span>&nbsp;<span class="op" id="6295881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6295884">if</span>&nbsp;<span class="ident" id="6295887">d</span><span class="op" id="6295888">.</span><span class="ident" id="6295889">bytes</span><span class="op" id="6295894">.</span><span class="ident" id="6295895">i</span>&nbsp;<span class="op" id="6295897">!=</span>&nbsp;<span class="ident" id="6295900">d</span><span class="op" id="6295901">.</span><span class="ident" id="6295902">bytes</span><span class="op" id="6295907">.</span><span class="ident" id="6295908">j</span>&nbsp;<span class="op" id="6295910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6295914">panic</span><span class="op" id="6295919">(</span><span class="string" id="6295920">&#34;jpeg:&nbsp;fill&nbsp;called&nbsp;when&nbsp;unread&nbsp;bytes&nbsp;exist&#34;</span><span class="op" id="6295963">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6295966">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6295969">//&nbsp;Move&nbsp;the&nbsp;last&nbsp;2&nbsp;bytes&nbsp;to&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;buffer,&nbsp;in&nbsp;case&nbsp;we&nbsp;need</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6296039">//&nbsp;to&nbsp;call&nbsp;unreadByteStuffedByte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6296074">if</span>&nbsp;<span class="ident" id="6296077">d</span><span class="op" id="6296078">.</span><span class="ident" id="6296079">bytes</span><span class="op" id="6296084">.</span><span class="ident" id="6296085">j</span>&nbsp;<span class="op" id="6296087">&gt;</span>&nbsp;<span class="num" id="6296089">2</span>&nbsp;<span class="op" id="6296091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6296095">d</span><span class="op" id="6296096">.</span><span class="ident" id="6296097">bytes</span><span class="op" id="6296102">.</span><span class="ident" id="6296103">buf</span><span class="op" id="6296106">[</span><span class="num" id="6296107">0</span><span class="op" id="6296108">]</span>&nbsp;<span class="op" id="6296110">=</span>&nbsp;<span class="ident" id="6296112">d</span><span class="op" id="6296113">.</span><span class="ident" id="6296114">bytes</span><span class="op" id="6296119">.</span><span class="ident" id="6296120">buf</span><span class="op" id="6296123">[</span><span class="ident" id="6296124">d</span><span class="op" id="6296125">.</span><span class="ident" id="6296126">bytes</span><span class="op" id="6296131">.</span><span class="ident" id="6296132">j</span><span class="op" id="6296133">-</span><span class="num" id="6296134">2</span><span class="op" id="6296135">]</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6296139">d</span><span class="op" id="6296140">.</span><span class="ident" id="6296141">bytes</span><span class="op" id="6296146">.</span><span class="ident" id="6296147">buf</span><span class="op" id="6296150">[</span><span class="num" id="6296151">1</span><span class="op" id="6296152">]</span>&nbsp;<span class="op" id="6296154">=</span>&nbsp;<span class="ident" id="6296156">d</span><span class="op" id="6296157">.</span><span class="ident" id="6296158">bytes</span><span class="op" id="6296163">.</span><span class="ident" id="6296164">buf</span><span class="op" id="6296167">[</span><span class="ident" id="6296168">d</span><span class="op" id="6296169">.</span><span class="ident" id="6296170">bytes</span><span class="op" id="6296175">.</span><span class="ident" id="6296176">j</span><span class="op" id="6296177">-</span><span class="num" id="6296178">1</span><span class="op" id="6296179">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6296183">d</span><span class="op" id="6296184">.</span><span class="ident" id="6296185">bytes</span><span class="op" id="6296190">.</span><span class="ident" id="6296191">i</span><span class="op" id="6296192">,</span>&nbsp;<span class="ident" id="6296194">d</span><span class="op" id="6296195">.</span><span class="ident" id="6296196">bytes</span><span class="op" id="6296201">.</span><span class="ident" id="6296202">j</span>&nbsp;<span class="op" id="6296204">=</span>&nbsp;<span class="num" id="6296206">2</span><span class="op" id="6296207">,</span>&nbsp;<span class="num" id="6296209">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6296212">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6296215">//&nbsp;Fill&nbsp;in&nbsp;the&nbsp;rest&nbsp;of&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6296251">n</span><span class="op" id="6296252">,</span>&nbsp;<span class="ident" id="6296254">err</span>&nbsp;<span class="op" id="6296258">:=</span>&nbsp;<span class="ident" id="6296261">d</span><span class="op" id="6296262">.</span><span class="ident" id="6296263">r</span><span class="op" id="6296264">.</span><span class="ident" id="6296265">Read</span><span class="op" id="6296269">(</span><span class="ident" id="6296270">d</span><span class="op" id="6296271">.</span><span class="ident" id="6296272">bytes</span><span class="op" id="6296277">.</span><span class="ident" id="6296278">buf</span><span class="op" id="6296281">[</span><span class="ident" id="6296282">d</span><span class="op" id="6296283">.</span><span class="ident" id="6296284">bytes</span><span class="op" id="6296289">.</span><span class="ident" id="6296290">j</span><span class="op" id="6296291">:</span><span class="op" id="6296292">]</span><span class="op" id="6296293">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6296296">d</span><span class="op" id="6296297">.</span><span class="ident" id="6296298">bytes</span><span class="op" id="6296303">.</span><span class="ident" id="6296304">j</span>&nbsp;<span class="op" id="6296306">+=</span>&nbsp;<span class="ident" id="6296309">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6296312">if</span>&nbsp;<span class="ident" id="6296315">n</span>&nbsp;<span class="op" id="6296317">&gt;</span>&nbsp;<span class="num" id="6296319">0</span>&nbsp;<span class="op" id="6296321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6296325">err</span>&nbsp;<span class="op" id="6296329">=</span>&nbsp;<span class="ident" id="6296331">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6296336">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6296339">return</span>&nbsp;<span class="ident" id="6296346">err</span><br>
<span class="lineno">150</span><span class="op" id="6296350">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6296353">//&nbsp;unreadByteStuffedByte&nbsp;undoes&nbsp;the&nbsp;most&nbsp;recent&nbsp;readByteStuffedByte&nbsp;call,</span><br>
<span class="lineno"></span><span class="comment" id="6296427">//&nbsp;giving&nbsp;a&nbsp;byte&nbsp;of&nbsp;data&nbsp;back&nbsp;from&nbsp;d.bits&nbsp;to&nbsp;d.bytes.&nbsp;The&nbsp;Huffman&nbsp;look-up&nbsp;table</span><br>
<span class="lineno"></span><span class="comment" id="6296507">//&nbsp;requires&nbsp;at&nbsp;least&nbsp;8&nbsp;bits&nbsp;for&nbsp;look-up,&nbsp;which&nbsp;means&nbsp;that&nbsp;Huffman&nbsp;decoding&nbsp;can</span><br>
<span class="lineno">155</span><span class="comment" id="6296586">//&nbsp;sometimes&nbsp;overshoot&nbsp;and&nbsp;read&nbsp;one&nbsp;or&nbsp;two&nbsp;too&nbsp;many&nbsp;bytes.&nbsp;Two-byte&nbsp;overshoot</span><br>
<span class="lineno"></span><span class="comment" id="6296664">//&nbsp;can&nbsp;happen&nbsp;when&nbsp;expecting&nbsp;to&nbsp;read&nbsp;a&nbsp;0xff&nbsp;0x00&nbsp;byte-stuffed&nbsp;byte.</span><br>
<span class="lineno"></span><span class="keyword" id="6296732">func</span>&nbsp;<span class="op" id="6296737">(</span><span class="ident" id="6296738">d</span>&nbsp;<span class="op" id="6296740">*</span><span class="ident" id="6296741">decoder</span><span class="op" id="6296748">)</span>&nbsp;<span class="ident" id="6296750">unreadByteStuffedByte</span><span class="op" id="6296771">(</span><span class="op" id="6296772">)</span>&nbsp;<span class="op" id="6296774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6296777">if</span>&nbsp;<span class="ident" id="6296780">d</span><span class="op" id="6296781">.</span><span class="ident" id="6296782">bytes</span><span class="op" id="6296787">.</span><span class="ident" id="6296788">nUnreadable</span>&nbsp;<span class="op" id="6296800">==</span>&nbsp;<span class="num" id="6296803">0</span>&nbsp;<span class="op" id="6296805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6296809">panic</span><span class="op" id="6296814">(</span><span class="string" id="6296815">&#34;jpeg:&nbsp;unreadByteStuffedByte&nbsp;call&nbsp;cannot&nbsp;be&nbsp;fulfilled&#34;</span><span class="op" id="6296869">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6296872">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6296875">d</span><span class="op" id="6296876">.</span><span class="ident" id="6296877">bytes</span><span class="op" id="6296882">.</span><span class="ident" id="6296883">i</span>&nbsp;<span class="op" id="6296885">-=</span>&nbsp;<span class="ident" id="6296888">d</span><span class="op" id="6296889">.</span><span class="ident" id="6296890">bytes</span><span class="op" id="6296895">.</span><span class="ident" id="6296896">nUnreadable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6296909">d</span><span class="op" id="6296910">.</span><span class="ident" id="6296911">bytes</span><span class="op" id="6296916">.</span><span class="ident" id="6296917">nUnreadable</span>&nbsp;<span class="op" id="6296929">=</span>&nbsp;<span class="num" id="6296931">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6296934">if</span>&nbsp;<span class="ident" id="6296937">d</span><span class="op" id="6296938">.</span><span class="ident" id="6296939">bits</span><span class="op" id="6296943">.</span><span class="ident" id="6296944">n</span>&nbsp;<span class="op" id="6296946">&gt;=</span>&nbsp;<span class="num" id="6296949">8</span>&nbsp;<span class="op" id="6296951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6296955">d</span><span class="op" id="6296956">.</span><span class="ident" id="6296957">bits</span><span class="op" id="6296961">.</span><span class="ident" id="6296962">a</span>&nbsp;<span class="op" id="6296964">&gt;&gt;=</span>&nbsp;<span class="num" id="6296968">8</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6296972">d</span><span class="op" id="6296973">.</span><span class="ident" id="6296974">bits</span><span class="op" id="6296978">.</span><span class="ident" id="6296979">n</span>&nbsp;<span class="op" id="6296981">-=</span>&nbsp;<span class="num" id="6296984">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6296988">d</span><span class="op" id="6296989">.</span><span class="ident" id="6296990">bits</span><span class="op" id="6296994">.</span><span class="ident" id="6296995">m</span>&nbsp;<span class="op" id="6296997">&gt;&gt;=</span>&nbsp;<span class="num" id="6297001">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6297004">}</span><br>
<span class="lineno"></span><span class="op" id="6297006">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="comment" id="6297009">//&nbsp;readByte&nbsp;returns&nbsp;the&nbsp;next&nbsp;byte,&nbsp;whether&nbsp;buffered&nbsp;or&nbsp;not&nbsp;buffered.&nbsp;It&nbsp;does</span><br>
<span class="lineno"></span><span class="comment" id="6297086">//&nbsp;not&nbsp;care&nbsp;about&nbsp;byte&nbsp;stuffing.</span><br>
<span class="lineno"></span><span class="keyword" id="6297119">func</span>&nbsp;<span class="op" id="6297124">(</span><span class="ident" id="6297125">d</span>&nbsp;<span class="op" id="6297127">*</span><span class="ident" id="6297128">decoder</span><span class="op" id="6297135">)</span>&nbsp;<span class="ident" id="6297137">readByte</span><span class="op" id="6297145">(</span><span class="op" id="6297146">)</span>&nbsp;<span class="op" id="6297148">(</span><span class="ident" id="6297149">x</span>&nbsp;<span class="builtintype" id="6297151">byte</span><span class="op" id="6297155">,</span>&nbsp;<span class="ident" id="6297157">err</span>&nbsp;<span class="builtintype" id="6297161">error</span><span class="op" id="6297166">)</span>&nbsp;<span class="op" id="6297168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6297171">for</span>&nbsp;<span class="ident" id="6297175">d</span><span class="op" id="6297176">.</span><span class="ident" id="6297177">bytes</span><span class="op" id="6297182">.</span><span class="ident" id="6297183">i</span>&nbsp;<span class="op" id="6297185">==</span>&nbsp;<span class="ident" id="6297188">d</span><span class="op" id="6297189">.</span><span class="ident" id="6297190">bytes</span><span class="op" id="6297195">.</span><span class="ident" id="6297196">j</span>&nbsp;<span class="op" id="6297198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6297202">if</span>&nbsp;<span class="ident" id="6297205">err</span>&nbsp;<span class="op" id="6297209">=</span>&nbsp;<span class="ident" id="6297211">d</span><span class="op" id="6297212">.</span><span class="ident" id="6297213">fill</span><span class="op" id="6297217">(</span><span class="op" id="6297218">)</span><span class="op" id="6297219">;</span>&nbsp;<span class="ident" id="6297221">err</span>&nbsp;<span class="op" id="6297225">!=</span>&nbsp;<span class="ident" id="6297228">nil</span>&nbsp;<span class="op" id="6297232">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6297237">return</span>&nbsp;<span class="num" id="6297244">0</span><span class="op" id="6297245">,</span>&nbsp;<span class="ident" id="6297247">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6297253">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6297256">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6297259">x</span>&nbsp;<span class="op" id="6297261">=</span>&nbsp;<span class="ident" id="6297263">d</span><span class="op" id="6297264">.</span><span class="ident" id="6297265">bytes</span><span class="op" id="6297270">.</span><span class="ident" id="6297271">buf</span><span class="op" id="6297274">[</span><span class="ident" id="6297275">d</span><span class="op" id="6297276">.</span><span class="ident" id="6297277">bytes</span><span class="op" id="6297282">.</span><span class="ident" id="6297283">i</span><span class="op" id="6297284">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6297287">d</span><span class="op" id="6297288">.</span><span class="ident" id="6297289">bytes</span><span class="op" id="6297294">.</span><span class="ident" id="6297295">i</span><span class="op" id="6297296">++</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6297300">d</span><span class="op" id="6297301">.</span><span class="ident" id="6297302">bytes</span><span class="op" id="6297307">.</span><span class="ident" id="6297308">nUnreadable</span>&nbsp;<span class="op" id="6297320">=</span>&nbsp;<span class="num" id="6297322">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6297325">return</span>&nbsp;<span class="ident" id="6297332">x</span><span class="op" id="6297333">,</span>&nbsp;<span class="ident" id="6297335">nil</span><br>
<span class="lineno"></span><span class="op" id="6297339">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6297342">//&nbsp;errMissingFF00&nbsp;means&nbsp;that&nbsp;readByteStuffedByte&nbsp;encountered&nbsp;an&nbsp;0xff&nbsp;byte&nbsp;(a</span><br>
<span class="lineno">185</span><span class="comment" id="6297419">//&nbsp;marker&nbsp;byte)&nbsp;that&nbsp;wasn&#39;t&nbsp;the&nbsp;expected&nbsp;byte-stuffed&nbsp;sequence&nbsp;0xff,&nbsp;0x00.</span><br>
<span class="lineno"></span><span class="keyword" id="6297494">var</span>&nbsp;<span class="ident" id="6297498">errMissingFF00</span>&nbsp;<span class="op" id="6297513">=</span>&nbsp;<span class="ident" id="6297515">FormatError</span><span class="op" id="6297526">(</span><span class="string" id="6297527">&#34;missing&nbsp;0xff00&nbsp;sequence&#34;</span><span class="op" id="6297552">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6297555">//&nbsp;readByteStuffedByte&nbsp;is&nbsp;like&nbsp;readByte&nbsp;but&nbsp;is&nbsp;for&nbsp;byte-stuffed&nbsp;Huffman&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="6297633">func</span>&nbsp;<span class="op" id="6297638">(</span><span class="ident" id="6297639">d</span>&nbsp;<span class="op" id="6297641">*</span><span class="ident" id="6297642">decoder</span><span class="op" id="6297649">)</span>&nbsp;<span class="ident" id="6297651">readByteStuffedByte</span><span class="op" id="6297670">(</span><span class="op" id="6297671">)</span>&nbsp;<span class="op" id="6297673">(</span><span class="ident" id="6297674">x</span>&nbsp;<span class="builtintype" id="6297676">byte</span><span class="op" id="6297680">,</span>&nbsp;<span class="ident" id="6297682">err</span>&nbsp;<span class="builtintype" id="6297686">error</span><span class="op" id="6297691">)</span>&nbsp;<span class="op" id="6297693">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6297696">//&nbsp;Take&nbsp;the&nbsp;fast&nbsp;path&nbsp;if&nbsp;d.bytes.buf&nbsp;contains&nbsp;at&nbsp;least&nbsp;two&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6297763">if</span>&nbsp;<span class="ident" id="6297766">d</span><span class="op" id="6297767">.</span><span class="ident" id="6297768">bytes</span><span class="op" id="6297773">.</span><span class="ident" id="6297774">i</span><span class="op" id="6297775">+</span><span class="num" id="6297776">2</span>&nbsp;<span class="op" id="6297778">&lt;=</span>&nbsp;<span class="ident" id="6297781">d</span><span class="op" id="6297782">.</span><span class="ident" id="6297783">bytes</span><span class="op" id="6297788">.</span><span class="ident" id="6297789">j</span>&nbsp;<span class="op" id="6297791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6297795">x</span>&nbsp;<span class="op" id="6297797">=</span>&nbsp;<span class="ident" id="6297799">d</span><span class="op" id="6297800">.</span><span class="ident" id="6297801">bytes</span><span class="op" id="6297806">.</span><span class="ident" id="6297807">buf</span><span class="op" id="6297810">[</span><span class="ident" id="6297811">d</span><span class="op" id="6297812">.</span><span class="ident" id="6297813">bytes</span><span class="op" id="6297818">.</span><span class="ident" id="6297819">i</span><span class="op" id="6297820">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6297824">d</span><span class="op" id="6297825">.</span><span class="ident" id="6297826">bytes</span><span class="op" id="6297831">.</span><span class="ident" id="6297832">i</span><span class="op" id="6297833">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6297838">d</span><span class="op" id="6297839">.</span><span class="ident" id="6297840">bytes</span><span class="op" id="6297845">.</span><span class="ident" id="6297846">nUnreadable</span>&nbsp;<span class="op" id="6297858">=</span>&nbsp;<span class="num" id="6297860">1</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6297864">if</span>&nbsp;<span class="ident" id="6297867">x</span>&nbsp;<span class="op" id="6297869">!=</span>&nbsp;<span class="num" id="6297872">0xff</span>&nbsp;<span class="op" id="6297877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6297882">return</span>&nbsp;<span class="ident" id="6297889">x</span><span class="op" id="6297890">,</span>&nbsp;<span class="ident" id="6297892">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6297898">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6297902">if</span>&nbsp;<span class="ident" id="6297905">d</span><span class="op" id="6297906">.</span><span class="ident" id="6297907">bytes</span><span class="op" id="6297912">.</span><span class="ident" id="6297913">buf</span><span class="op" id="6297916">[</span><span class="ident" id="6297917">d</span><span class="op" id="6297918">.</span><span class="ident" id="6297919">bytes</span><span class="op" id="6297924">.</span><span class="ident" id="6297925">i</span><span class="op" id="6297926">]</span>&nbsp;<span class="op" id="6297928">!=</span>&nbsp;<span class="num" id="6297931">0x00</span>&nbsp;<span class="op" id="6297936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6297941">return</span>&nbsp;<span class="num" id="6297948">0</span><span class="op" id="6297949">,</span>&nbsp;<span class="ident" id="6297951">errMissingFF00</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6297968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6297972">d</span><span class="op" id="6297973">.</span><span class="ident" id="6297974">bytes</span><span class="op" id="6297979">.</span><span class="ident" id="6297980">i</span><span class="op" id="6297981">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6297986">d</span><span class="op" id="6297987">.</span><span class="ident" id="6297988">bytes</span><span class="op" id="6297993">.</span><span class="ident" id="6297994">nUnreadable</span>&nbsp;<span class="op" id="6298006">=</span>&nbsp;<span class="num" id="6298008">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6298012">return</span>&nbsp;<span class="num" id="6298019">0xff</span><span class="op" id="6298023">,</span>&nbsp;<span class="ident" id="6298025">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6298030">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6298034">x</span><span class="op" id="6298035">,</span>&nbsp;<span class="ident" id="6298037">err</span>&nbsp;<span class="op" id="6298041">=</span>&nbsp;<span class="ident" id="6298043">d</span><span class="op" id="6298044">.</span><span class="ident" id="6298045">readByte</span><span class="op" id="6298053">(</span><span class="op" id="6298054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6298057">if</span>&nbsp;<span class="ident" id="6298060">err</span>&nbsp;<span class="op" id="6298064">!=</span>&nbsp;<span class="ident" id="6298067">nil</span>&nbsp;<span class="op" id="6298071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6298075">return</span>&nbsp;<span class="num" id="6298082">0</span><span class="op" id="6298083">,</span>&nbsp;<span class="ident" id="6298085">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6298090">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6298093">if</span>&nbsp;<span class="ident" id="6298096">x</span>&nbsp;<span class="op" id="6298098">!=</span>&nbsp;<span class="num" id="6298101">0xff</span>&nbsp;<span class="op" id="6298106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6298110">d</span><span class="op" id="6298111">.</span><span class="ident" id="6298112">bytes</span><span class="op" id="6298117">.</span><span class="ident" id="6298118">nUnreadable</span>&nbsp;<span class="op" id="6298130">=</span>&nbsp;<span class="num" id="6298132">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6298136">return</span>&nbsp;<span class="ident" id="6298143">x</span><span class="op" id="6298144">,</span>&nbsp;<span class="ident" id="6298146">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6298151">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6298155">x</span><span class="op" id="6298156">,</span>&nbsp;<span class="ident" id="6298158">err</span>&nbsp;<span class="op" id="6298162">=</span>&nbsp;<span class="ident" id="6298164">d</span><span class="op" id="6298165">.</span><span class="ident" id="6298166">readByte</span><span class="op" id="6298174">(</span><span class="op" id="6298175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6298178">if</span>&nbsp;<span class="ident" id="6298181">err</span>&nbsp;<span class="op" id="6298185">!=</span>&nbsp;<span class="ident" id="6298188">nil</span>&nbsp;<span class="op" id="6298192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6298196">d</span><span class="op" id="6298197">.</span><span class="ident" id="6298198">bytes</span><span class="op" id="6298203">.</span><span class="ident" id="6298204">nUnreadable</span>&nbsp;<span class="op" id="6298216">=</span>&nbsp;<span class="num" id="6298218">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6298222">return</span>&nbsp;<span class="num" id="6298229">0</span><span class="op" id="6298230">,</span>&nbsp;<span class="ident" id="6298232">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6298237">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6298240">d</span><span class="op" id="6298241">.</span><span class="ident" id="6298242">bytes</span><span class="op" id="6298247">.</span><span class="ident" id="6298248">nUnreadable</span>&nbsp;<span class="op" id="6298260">=</span>&nbsp;<span class="num" id="6298262">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6298265">if</span>&nbsp;<span class="ident" id="6298268">x</span>&nbsp;<span class="op" id="6298270">!=</span>&nbsp;<span class="num" id="6298273">0x00</span>&nbsp;<span class="op" id="6298278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6298282">return</span>&nbsp;<span class="num" id="6298289">0</span><span class="op" id="6298290">,</span>&nbsp;<span class="ident" id="6298292">errMissingFF00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6298308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6298311">return</span>&nbsp;<span class="num" id="6298318">0xff</span><span class="op" id="6298322">,</span>&nbsp;<span class="ident" id="6298324">nil</span><br>
<span class="lineno">225</span><span class="op" id="6298328">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6298331">//&nbsp;readFull&nbsp;reads&nbsp;exactly&nbsp;len(p)&nbsp;bytes&nbsp;into&nbsp;p.&nbsp;It&nbsp;does&nbsp;not&nbsp;care&nbsp;about&nbsp;byte</span><br>
<span class="lineno"></span><span class="comment" id="6298406">//&nbsp;stuffing.</span><br>
<span class="lineno"></span><span class="keyword" id="6298419">func</span>&nbsp;<span class="op" id="6298424">(</span><span class="ident" id="6298425">d</span>&nbsp;<span class="op" id="6298427">*</span><span class="ident" id="6298428">decoder</span><span class="op" id="6298435">)</span>&nbsp;<span class="ident" id="6298437">readFull</span><span class="op" id="6298445">(</span><span class="ident" id="6298446">p</span>&nbsp;<span class="op" id="6298448">[</span><span class="op" id="6298449">]</span><span class="builtintype" id="6298450">byte</span><span class="op" id="6298454">)</span>&nbsp;<span class="builtintype" id="6298456">error</span>&nbsp;<span class="op" id="6298462">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6298465">//&nbsp;Unread&nbsp;the&nbsp;overshot&nbsp;bytes,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6298504">if</span>&nbsp;<span class="ident" id="6298507">d</span><span class="op" id="6298508">.</span><span class="ident" id="6298509">bytes</span><span class="op" id="6298514">.</span><span class="ident" id="6298515">nUnreadable</span>&nbsp;<span class="op" id="6298527">!=</span>&nbsp;<span class="num" id="6298530">0</span>&nbsp;<span class="op" id="6298532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6298536">if</span>&nbsp;<span class="ident" id="6298539">d</span><span class="op" id="6298540">.</span><span class="ident" id="6298541">bits</span><span class="op" id="6298545">.</span><span class="ident" id="6298546">n</span>&nbsp;<span class="op" id="6298548">&gt;=</span>&nbsp;<span class="num" id="6298551">8</span>&nbsp;<span class="op" id="6298553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6298558">d</span><span class="op" id="6298559">.</span><span class="ident" id="6298560">unreadByteStuffedByte</span><span class="op" id="6298581">(</span><span class="op" id="6298582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6298586">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6298590">d</span><span class="op" id="6298591">.</span><span class="ident" id="6298592">bytes</span><span class="op" id="6298597">.</span><span class="ident" id="6298598">nUnreadable</span>&nbsp;<span class="op" id="6298610">=</span>&nbsp;<span class="num" id="6298612">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6298615">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6298619">for</span>&nbsp;<span class="op" id="6298623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6298627">n</span>&nbsp;<span class="op" id="6298629">:=</span>&nbsp;<span class="builtinfunc" id="6298632">copy</span><span class="op" id="6298636">(</span><span class="ident" id="6298637">p</span><span class="op" id="6298638">,</span>&nbsp;<span class="ident" id="6298640">d</span><span class="op" id="6298641">.</span><span class="ident" id="6298642">bytes</span><span class="op" id="6298647">.</span><span class="ident" id="6298648">buf</span><span class="op" id="6298651">[</span><span class="ident" id="6298652">d</span><span class="op" id="6298653">.</span><span class="ident" id="6298654">bytes</span><span class="op" id="6298659">.</span><span class="ident" id="6298660">i</span><span class="op" id="6298661">:</span><span class="ident" id="6298662">d</span><span class="op" id="6298663">.</span><span class="ident" id="6298664">bytes</span><span class="op" id="6298669">.</span><span class="ident" id="6298670">j</span><span class="op" id="6298671">]</span><span class="op" id="6298672">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6298676">p</span>&nbsp;<span class="op" id="6298678">=</span>&nbsp;<span class="ident" id="6298680">p</span><span class="op" id="6298681">[</span><span class="ident" id="6298682">n</span><span class="op" id="6298683">:</span><span class="op" id="6298684">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6298688">d</span><span class="op" id="6298689">.</span><span class="ident" id="6298690">bytes</span><span class="op" id="6298695">.</span><span class="ident" id="6298696">i</span>&nbsp;<span class="op" id="6298698">+=</span>&nbsp;<span class="ident" id="6298701">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6298705">if</span>&nbsp;<span class="builtinfunc" id="6298708">len</span><span class="op" id="6298711">(</span><span class="ident" id="6298712">p</span><span class="op" id="6298713">)</span>&nbsp;<span class="op" id="6298715">==</span>&nbsp;<span class="num" id="6298718">0</span>&nbsp;<span class="op" id="6298720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6298725">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6298733">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6298737">if</span>&nbsp;<span class="ident" id="6298740">err</span>&nbsp;<span class="op" id="6298744">:=</span>&nbsp;<span class="ident" id="6298747">d</span><span class="op" id="6298748">.</span><span class="ident" id="6298749">fill</span><span class="op" id="6298753">(</span><span class="op" id="6298754">)</span><span class="op" id="6298755">;</span>&nbsp;<span class="ident" id="6298757">err</span>&nbsp;<span class="op" id="6298761">!=</span>&nbsp;<span class="ident" id="6298764">nil</span>&nbsp;<span class="op" id="6298768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6298773">if</span>&nbsp;<span class="ident" id="6298776">err</span>&nbsp;<span class="op" id="6298780">==</span>&nbsp;<span class="ident" id="6298783">io</span><span class="op" id="6298785">.</span><span class="ident" id="6298786">EOF</span>&nbsp;<span class="op" id="6298790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6298796">err</span>&nbsp;<span class="op" id="6298800">=</span>&nbsp;<span class="ident" id="6298802">io</span><span class="op" id="6298804">.</span><span class="ident" id="6298805">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6298825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6298830">return</span>&nbsp;<span class="ident" id="6298837">err</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6298843">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6298846">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6298849">return</span>&nbsp;<span class="ident" id="6298856">nil</span><br>
<span class="lineno"></span><span class="op" id="6298860">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="comment" id="6298863">//&nbsp;ignore&nbsp;ignores&nbsp;the&nbsp;next&nbsp;n&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="6298899">func</span>&nbsp;<span class="op" id="6298904">(</span><span class="ident" id="6298905">d</span>&nbsp;<span class="op" id="6298907">*</span><span class="ident" id="6298908">decoder</span><span class="op" id="6298915">)</span>&nbsp;<span class="ident" id="6298917">ignore</span><span class="op" id="6298923">(</span><span class="ident" id="6298924">n</span>&nbsp;<span class="builtintype" id="6298926">int</span><span class="op" id="6298929">)</span>&nbsp;<span class="builtintype" id="6298931">error</span>&nbsp;<span class="op" id="6298937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6298940">//&nbsp;Unread&nbsp;the&nbsp;overshot&nbsp;bytes,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6298979">if</span>&nbsp;<span class="ident" id="6298982">d</span><span class="op" id="6298983">.</span><span class="ident" id="6298984">bytes</span><span class="op" id="6298989">.</span><span class="ident" id="6298990">nUnreadable</span>&nbsp;<span class="op" id="6299002">!=</span>&nbsp;<span class="num" id="6299005">0</span>&nbsp;<span class="op" id="6299007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6299011">if</span>&nbsp;<span class="ident" id="6299014">d</span><span class="op" id="6299015">.</span><span class="ident" id="6299016">bits</span><span class="op" id="6299020">.</span><span class="ident" id="6299021">n</span>&nbsp;<span class="op" id="6299023">&gt;=</span>&nbsp;<span class="num" id="6299026">8</span>&nbsp;<span class="op" id="6299028">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6299033">d</span><span class="op" id="6299034">.</span><span class="ident" id="6299035">unreadByteStuffedByte</span><span class="op" id="6299056">(</span><span class="op" id="6299057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6299061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6299065">d</span><span class="op" id="6299066">.</span><span class="ident" id="6299067">bytes</span><span class="op" id="6299072">.</span><span class="ident" id="6299073">nUnreadable</span>&nbsp;<span class="op" id="6299085">=</span>&nbsp;<span class="num" id="6299087">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6299090">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6299094">for</span>&nbsp;<span class="op" id="6299098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6299102">m</span>&nbsp;<span class="op" id="6299104">:=</span>&nbsp;<span class="ident" id="6299107">d</span><span class="op" id="6299108">.</span><span class="ident" id="6299109">bytes</span><span class="op" id="6299114">.</span><span class="ident" id="6299115">j</span>&nbsp;<span class="op" id="6299117">-</span>&nbsp;<span class="ident" id="6299119">d</span><span class="op" id="6299120">.</span><span class="ident" id="6299121">bytes</span><span class="op" id="6299126">.</span><span class="ident" id="6299127">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6299131">if</span>&nbsp;<span class="ident" id="6299134">m</span>&nbsp;<span class="op" id="6299136">&gt;</span>&nbsp;<span class="ident" id="6299138">n</span>&nbsp;<span class="op" id="6299140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6299145">m</span>&nbsp;<span class="op" id="6299147">=</span>&nbsp;<span class="ident" id="6299149">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6299153">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6299157">d</span><span class="op" id="6299158">.</span><span class="ident" id="6299159">bytes</span><span class="op" id="6299164">.</span><span class="ident" id="6299165">i</span>&nbsp;<span class="op" id="6299167">+=</span>&nbsp;<span class="ident" id="6299170">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6299174">n</span>&nbsp;<span class="op" id="6299176">-=</span>&nbsp;<span class="ident" id="6299179">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6299183">if</span>&nbsp;<span class="ident" id="6299186">n</span>&nbsp;<span class="op" id="6299188">==</span>&nbsp;<span class="num" id="6299191">0</span>&nbsp;<span class="op" id="6299193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6299198">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6299206">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6299210">if</span>&nbsp;<span class="ident" id="6299213">err</span>&nbsp;<span class="op" id="6299217">:=</span>&nbsp;<span class="ident" id="6299220">d</span><span class="op" id="6299221">.</span><span class="ident" id="6299222">fill</span><span class="op" id="6299226">(</span><span class="op" id="6299227">)</span><span class="op" id="6299228">;</span>&nbsp;<span class="ident" id="6299230">err</span>&nbsp;<span class="op" id="6299234">!=</span>&nbsp;<span class="ident" id="6299237">nil</span>&nbsp;<span class="op" id="6299241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6299246">if</span>&nbsp;<span class="ident" id="6299249">err</span>&nbsp;<span class="op" id="6299253">==</span>&nbsp;<span class="ident" id="6299256">io</span><span class="op" id="6299258">.</span><span class="ident" id="6299259">EOF</span>&nbsp;<span class="op" id="6299263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6299269">err</span>&nbsp;<span class="op" id="6299273">=</span>&nbsp;<span class="ident" id="6299275">io</span><span class="op" id="6299277">.</span><span class="ident" id="6299278">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6299298">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6299303">return</span>&nbsp;<span class="ident" id="6299310">err</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6299316">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6299319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6299322">return</span>&nbsp;<span class="ident" id="6299329">nil</span><br>
<span class="lineno"></span><span class="op" id="6299333">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="comment" id="6299336">//&nbsp;Specified&nbsp;in&nbsp;section&nbsp;B.2.2.</span><br>
<span class="lineno"></span><span class="keyword" id="6299367">func</span>&nbsp;<span class="op" id="6299372">(</span><span class="ident" id="6299373">d</span>&nbsp;<span class="op" id="6299375">*</span><span class="ident" id="6299376">decoder</span><span class="op" id="6299383">)</span>&nbsp;<span class="ident" id="6299385">processSOF</span><span class="op" id="6299395">(</span><span class="ident" id="6299396">n</span>&nbsp;<span class="builtintype" id="6299398">int</span><span class="op" id="6299401">)</span>&nbsp;<span class="builtintype" id="6299403">error</span>&nbsp;<span class="op" id="6299409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6299412">switch</span>&nbsp;<span class="ident" id="6299419">n</span>&nbsp;<span class="op" id="6299421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6299424">case</span>&nbsp;<span class="num" id="6299429">6</span>&nbsp;<span class="op" id="6299431">+</span>&nbsp;<span class="num" id="6299433">3</span><span class="op" id="6299434">*</span><span class="ident" id="6299435">nGrayComponent</span><span class="op" id="6299449">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6299453">d</span><span class="op" id="6299454">.</span><span class="ident" id="6299455">nComp</span>&nbsp;<span class="op" id="6299461">=</span>&nbsp;<span class="ident" id="6299463">nGrayComponent</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6299479">case</span>&nbsp;<span class="num" id="6299484">6</span>&nbsp;<span class="op" id="6299486">+</span>&nbsp;<span class="num" id="6299488">3</span><span class="op" id="6299489">*</span><span class="ident" id="6299490">nColorComponent</span><span class="op" id="6299505">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6299509">d</span><span class="op" id="6299510">.</span><span class="ident" id="6299511">nComp</span>&nbsp;<span class="op" id="6299517">=</span>&nbsp;<span class="ident" id="6299519">nColorComponent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6299536">default</span><span class="op" id="6299543">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6299547">return</span>&nbsp;<span class="ident" id="6299554">UnsupportedError</span><span class="op" id="6299570">(</span><span class="string" id="6299571">&#34;SOF&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="6299593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6299596">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6299599">if</span>&nbsp;<span class="ident" id="6299602">err</span>&nbsp;<span class="op" id="6299606">:=</span>&nbsp;<span class="ident" id="6299609">d</span><span class="op" id="6299610">.</span><span class="ident" id="6299611">readFull</span><span class="op" id="6299619">(</span><span class="ident" id="6299620">d</span><span class="op" id="6299621">.</span><span class="ident" id="6299622">tmp</span><span class="op" id="6299625">[</span><span class="op" id="6299626">:</span><span class="ident" id="6299627">n</span><span class="op" id="6299628">]</span><span class="op" id="6299629">)</span><span class="op" id="6299630">;</span>&nbsp;<span class="ident" id="6299632">err</span>&nbsp;<span class="op" id="6299636">!=</span>&nbsp;<span class="ident" id="6299639">nil</span>&nbsp;<span class="op" id="6299643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6299647">return</span>&nbsp;<span class="ident" id="6299654">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6299659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6299662">//&nbsp;We&nbsp;only&nbsp;support&nbsp;8-bit&nbsp;precision.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6299699">if</span>&nbsp;<span class="ident" id="6299702">d</span><span class="op" id="6299703">.</span><span class="ident" id="6299704">tmp</span><span class="op" id="6299707">[</span><span class="num" id="6299708">0</span><span class="op" id="6299709">]</span>&nbsp;<span class="op" id="6299711">!=</span>&nbsp;<span class="num" id="6299714">8</span>&nbsp;<span class="op" id="6299716">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6299720">return</span>&nbsp;<span class="ident" id="6299727">UnsupportedError</span><span class="op" id="6299743">(</span><span class="string" id="6299744">&#34;precision&#34;</span><span class="op" id="6299755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6299758">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6299761">d</span><span class="op" id="6299762">.</span><span class="ident" id="6299763">height</span>&nbsp;<span class="op" id="6299770">=</span>&nbsp;<span class="builtintype" id="6299772">int</span><span class="op" id="6299775">(</span><span class="ident" id="6299776">d</span><span class="op" id="6299777">.</span><span class="ident" id="6299778">tmp</span><span class="op" id="6299781">[</span><span class="num" id="6299782">1</span><span class="op" id="6299783">]</span><span class="op" id="6299784">)</span><span class="op" id="6299785">&lt;&lt;</span><span class="num" id="6299787">8</span>&nbsp;<span class="op" id="6299789">+</span>&nbsp;<span class="builtintype" id="6299791">int</span><span class="op" id="6299794">(</span><span class="ident" id="6299795">d</span><span class="op" id="6299796">.</span><span class="ident" id="6299797">tmp</span><span class="op" id="6299800">[</span><span class="num" id="6299801">2</span><span class="op" id="6299802">]</span><span class="op" id="6299803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6299806">d</span><span class="op" id="6299807">.</span><span class="ident" id="6299808">width</span>&nbsp;<span class="op" id="6299814">=</span>&nbsp;<span class="builtintype" id="6299816">int</span><span class="op" id="6299819">(</span><span class="ident" id="6299820">d</span><span class="op" id="6299821">.</span><span class="ident" id="6299822">tmp</span><span class="op" id="6299825">[</span><span class="num" id="6299826">3</span><span class="op" id="6299827">]</span><span class="op" id="6299828">)</span><span class="op" id="6299829">&lt;&lt;</span><span class="num" id="6299831">8</span>&nbsp;<span class="op" id="6299833">+</span>&nbsp;<span class="builtintype" id="6299835">int</span><span class="op" id="6299838">(</span><span class="ident" id="6299839">d</span><span class="op" id="6299840">.</span><span class="ident" id="6299841">tmp</span><span class="op" id="6299844">[</span><span class="num" id="6299845">4</span><span class="op" id="6299846">]</span><span class="op" id="6299847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6299850">if</span>&nbsp;<span class="builtintype" id="6299853">int</span><span class="op" id="6299856">(</span><span class="ident" id="6299857">d</span><span class="op" id="6299858">.</span><span class="ident" id="6299859">tmp</span><span class="op" id="6299862">[</span><span class="num" id="6299863">5</span><span class="op" id="6299864">]</span><span class="op" id="6299865">)</span>&nbsp;<span class="op" id="6299867">!=</span>&nbsp;<span class="ident" id="6299870">d</span><span class="op" id="6299871">.</span><span class="ident" id="6299872">nComp</span>&nbsp;<span class="op" id="6299878">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6299882">return</span>&nbsp;<span class="ident" id="6299889">UnsupportedError</span><span class="op" id="6299905">(</span><span class="string" id="6299906">&#34;SOF&nbsp;has&nbsp;wrong&nbsp;number&nbsp;of&nbsp;image&nbsp;components&#34;</span><span class="op" id="6299948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6299951">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6299954">for</span>&nbsp;<span class="ident" id="6299958">i</span>&nbsp;<span class="op" id="6299960">:=</span>&nbsp;<span class="num" id="6299963">0</span><span class="op" id="6299964">;</span>&nbsp;<span class="ident" id="6299966">i</span>&nbsp;<span class="op" id="6299968">&lt;</span>&nbsp;<span class="ident" id="6299970">d</span><span class="op" id="6299971">.</span><span class="ident" id="6299972">nComp</span><span class="op" id="6299977">;</span>&nbsp;<span class="ident" id="6299979">i</span><span class="op" id="6299980">++</span>&nbsp;<span class="op" id="6299983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6299987">d</span><span class="op" id="6299988">.</span><span class="ident" id="6299989">comp</span><span class="op" id="6299993">[</span><span class="ident" id="6299994">i</span><span class="op" id="6299995">]</span><span class="op" id="6299996">.</span><span class="ident" id="6299997">c</span>&nbsp;<span class="op" id="6299999">=</span>&nbsp;<span class="ident" id="6300001">d</span><span class="op" id="6300002">.</span><span class="ident" id="6300003">tmp</span><span class="op" id="6300006">[</span><span class="num" id="6300007">6</span><span class="op" id="6300008">+</span><span class="num" id="6300009">3</span><span class="op" id="6300010">*</span><span class="ident" id="6300011">i</span><span class="op" id="6300012">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6300016">d</span><span class="op" id="6300017">.</span><span class="ident" id="6300018">comp</span><span class="op" id="6300022">[</span><span class="ident" id="6300023">i</span><span class="op" id="6300024">]</span><span class="op" id="6300025">.</span><span class="ident" id="6300026">tq</span>&nbsp;<span class="op" id="6300029">=</span>&nbsp;<span class="ident" id="6300031">d</span><span class="op" id="6300032">.</span><span class="ident" id="6300033">tmp</span><span class="op" id="6300036">[</span><span class="num" id="6300037">8</span><span class="op" id="6300038">+</span><span class="num" id="6300039">3</span><span class="op" id="6300040">*</span><span class="ident" id="6300041">i</span><span class="op" id="6300042">]</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6300046">if</span>&nbsp;<span class="ident" id="6300049">d</span><span class="op" id="6300050">.</span><span class="ident" id="6300051">nComp</span>&nbsp;<span class="op" id="6300057">==</span>&nbsp;<span class="ident" id="6300060">nGrayComponent</span>&nbsp;<span class="op" id="6300075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6300080">//&nbsp;If&nbsp;a&nbsp;JPEG&nbsp;image&nbsp;has&nbsp;only&nbsp;one&nbsp;component,&nbsp;section&nbsp;A.2&nbsp;says&nbsp;&#34;this&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6300154">//&nbsp;is&nbsp;non-interleaved&nbsp;by&nbsp;definition&#34;&nbsp;and&nbsp;section&nbsp;A.2.2&nbsp;says&nbsp;&#34;[in&nbsp;this</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6300227">//&nbsp;case...]&nbsp;the&nbsp;order&nbsp;of&nbsp;data&nbsp;units&nbsp;within&nbsp;a&nbsp;scan&nbsp;shall&nbsp;be&nbsp;left-to-right</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6300303">//&nbsp;and&nbsp;top-to-bottom...&nbsp;regardless&nbsp;of&nbsp;the&nbsp;values&nbsp;of&nbsp;H_1&nbsp;and&nbsp;V_1&#34;.&nbsp;Section</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6300380">//&nbsp;4.8.2&nbsp;also&nbsp;says&nbsp;&#34;[for&nbsp;non-interleaved&nbsp;data],&nbsp;the&nbsp;MCU&nbsp;is&nbsp;defined&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6300456">//&nbsp;one&nbsp;data&nbsp;unit&#34;.&nbsp;Similarly,&nbsp;section&nbsp;A.1.1&nbsp;explains&nbsp;that&nbsp;it&nbsp;is&nbsp;the&nbsp;ratio</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6300533">//&nbsp;of&nbsp;H_i&nbsp;to&nbsp;max_j(H_j)&nbsp;that&nbsp;matters,&nbsp;and&nbsp;similarly&nbsp;for&nbsp;V.&nbsp;For&nbsp;grayscale</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6300609">//&nbsp;images,&nbsp;H_1&nbsp;is&nbsp;the&nbsp;maximum&nbsp;H_j&nbsp;for&nbsp;all&nbsp;components&nbsp;j,&nbsp;so&nbsp;that&nbsp;ratio&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6300685">//&nbsp;always&nbsp;1.&nbsp;The&nbsp;component&#39;s&nbsp;(h,&nbsp;v)&nbsp;is&nbsp;effectively&nbsp;always&nbsp;(1,&nbsp;1):&nbsp;even&nbsp;if</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6300762">//&nbsp;the&nbsp;nominal&nbsp;(h,&nbsp;v)&nbsp;is&nbsp;(2,&nbsp;1),&nbsp;a&nbsp;20x5&nbsp;image&nbsp;is&nbsp;encoded&nbsp;in&nbsp;three&nbsp;8x8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6300835">//&nbsp;MCUs,&nbsp;not&nbsp;two&nbsp;16x8&nbsp;MCUs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6300866">d</span><span class="op" id="6300867">.</span><span class="ident" id="6300868">comp</span><span class="op" id="6300872">[</span><span class="ident" id="6300873">i</span><span class="op" id="6300874">]</span><span class="op" id="6300875">.</span><span class="ident" id="6300876">h</span>&nbsp;<span class="op" id="6300878">=</span>&nbsp;<span class="num" id="6300880">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6300885">d</span><span class="op" id="6300886">.</span><span class="ident" id="6300887">comp</span><span class="op" id="6300891">[</span><span class="ident" id="6300892">i</span><span class="op" id="6300893">]</span><span class="op" id="6300894">.</span><span class="ident" id="6300895">v</span>&nbsp;<span class="op" id="6300897">=</span>&nbsp;<span class="num" id="6300899">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6300904">continue</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6300915">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6300919">hv</span>&nbsp;<span class="op" id="6300922">:=</span>&nbsp;<span class="ident" id="6300925">d</span><span class="op" id="6300926">.</span><span class="ident" id="6300927">tmp</span><span class="op" id="6300930">[</span><span class="num" id="6300931">7</span><span class="op" id="6300932">+</span><span class="num" id="6300933">3</span><span class="op" id="6300934">*</span><span class="ident" id="6300935">i</span><span class="op" id="6300936">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6300940">d</span><span class="op" id="6300941">.</span><span class="ident" id="6300942">comp</span><span class="op" id="6300946">[</span><span class="ident" id="6300947">i</span><span class="op" id="6300948">]</span><span class="op" id="6300949">.</span><span class="ident" id="6300950">h</span>&nbsp;<span class="op" id="6300952">=</span>&nbsp;<span class="builtintype" id="6300954">int</span><span class="op" id="6300957">(</span><span class="ident" id="6300958">hv</span>&nbsp;<span class="op" id="6300961">&gt;&gt;</span>&nbsp;<span class="num" id="6300964">4</span><span class="op" id="6300965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6300969">d</span><span class="op" id="6300970">.</span><span class="ident" id="6300971">comp</span><span class="op" id="6300975">[</span><span class="ident" id="6300976">i</span><span class="op" id="6300977">]</span><span class="op" id="6300978">.</span><span class="ident" id="6300979">v</span>&nbsp;<span class="op" id="6300981">=</span>&nbsp;<span class="builtintype" id="6300983">int</span><span class="op" id="6300986">(</span><span class="ident" id="6300987">hv</span>&nbsp;<span class="op" id="6300990">&amp;</span>&nbsp;<span class="num" id="6300992">0x0f</span><span class="op" id="6300996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6301000">//&nbsp;For&nbsp;color&nbsp;images,&nbsp;we&nbsp;only&nbsp;support&nbsp;4:4:4,&nbsp;4:4:0,&nbsp;4:2:2&nbsp;or&nbsp;4:2:0&nbsp;chroma</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6301075">//&nbsp;downsampling&nbsp;ratios.&nbsp;This&nbsp;implies&nbsp;that&nbsp;the&nbsp;(h,&nbsp;v)&nbsp;values&nbsp;for&nbsp;the&nbsp;Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6301147">//&nbsp;component&nbsp;are&nbsp;either&nbsp;(1,&nbsp;1),&nbsp;(1,&nbsp;2),&nbsp;(2,&nbsp;1)&nbsp;or&nbsp;(2,&nbsp;2),&nbsp;and&nbsp;the&nbsp;(h,&nbsp;v)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6301222">//&nbsp;values&nbsp;for&nbsp;the&nbsp;Cr&nbsp;and&nbsp;Cb&nbsp;components&nbsp;must&nbsp;be&nbsp;(1,&nbsp;1).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6301279">if</span>&nbsp;<span class="ident" id="6301282">i</span>&nbsp;<span class="op" id="6301284">==</span>&nbsp;<span class="num" id="6301287">0</span>&nbsp;<span class="op" id="6301289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6301294">if</span>&nbsp;<span class="ident" id="6301297">hv</span>&nbsp;<span class="op" id="6301300">!=</span>&nbsp;<span class="num" id="6301303">0x11</span>&nbsp;<span class="op" id="6301308">&amp;&amp;</span>&nbsp;<span class="ident" id="6301311">hv</span>&nbsp;<span class="op" id="6301314">!=</span>&nbsp;<span class="num" id="6301317">0x21</span>&nbsp;<span class="op" id="6301322">&amp;&amp;</span>&nbsp;<span class="ident" id="6301325">hv</span>&nbsp;<span class="op" id="6301328">!=</span>&nbsp;<span class="num" id="6301331">0x22</span>&nbsp;<span class="op" id="6301336">&amp;&amp;</span>&nbsp;<span class="ident" id="6301339">hv</span>&nbsp;<span class="op" id="6301342">!=</span>&nbsp;<span class="num" id="6301345">0x12</span>&nbsp;<span class="op" id="6301350">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6301356">return</span>&nbsp;<span class="ident" id="6301363">UnsupportedError</span><span class="op" id="6301379">(</span><span class="string" id="6301380">&#34;luma/chroma&nbsp;downsample&nbsp;ratio&#34;</span><span class="op" id="6301410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6301415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6301419">}</span>&nbsp;<span class="keyword" id="6301421">else</span>&nbsp;<span class="keyword" id="6301426">if</span>&nbsp;<span class="ident" id="6301429">hv</span>&nbsp;<span class="op" id="6301432">!=</span>&nbsp;<span class="num" id="6301435">0x11</span>&nbsp;<span class="op" id="6301440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6301445">return</span>&nbsp;<span class="ident" id="6301452">UnsupportedError</span><span class="op" id="6301468">(</span><span class="string" id="6301469">&#34;luma/chroma&nbsp;downsample&nbsp;ratio&#34;</span><span class="op" id="6301499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6301503">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6301506">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6301509">return</span>&nbsp;<span class="ident" id="6301516">nil</span><br>
<span class="lineno"></span><span class="op" id="6301520">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6301523">//&nbsp;Specified&nbsp;in&nbsp;section&nbsp;B.2.4.1.</span><br>
<span class="lineno">345</span><span class="keyword" id="6301556">func</span>&nbsp;<span class="op" id="6301561">(</span><span class="ident" id="6301562">d</span>&nbsp;<span class="op" id="6301564">*</span><span class="ident" id="6301565">decoder</span><span class="op" id="6301572">)</span>&nbsp;<span class="ident" id="6301574">processDQT</span><span class="op" id="6301584">(</span><span class="ident" id="6301585">n</span>&nbsp;<span class="builtintype" id="6301587">int</span><span class="op" id="6301590">)</span>&nbsp;<span class="builtintype" id="6301592">error</span>&nbsp;<span class="op" id="6301598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6301601">const</span>&nbsp;<span class="ident" id="6301607">qtLength</span>&nbsp;<span class="op" id="6301616">=</span>&nbsp;<span class="num" id="6301618">1</span>&nbsp;<span class="op" id="6301620">+</span>&nbsp;<span class="ident" id="6301622">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6301633">for</span>&nbsp;<span class="op" id="6301637">;</span>&nbsp;<span class="ident" id="6301639">n</span>&nbsp;<span class="op" id="6301641">&gt;=</span>&nbsp;<span class="ident" id="6301644">qtLength</span><span class="op" id="6301652">;</span>&nbsp;<span class="ident" id="6301654">n</span>&nbsp;<span class="op" id="6301656">-=</span>&nbsp;<span class="ident" id="6301659">qtLength</span>&nbsp;<span class="op" id="6301668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6301672">if</span>&nbsp;<span class="ident" id="6301675">err</span>&nbsp;<span class="op" id="6301679">:=</span>&nbsp;<span class="ident" id="6301682">d</span><span class="op" id="6301683">.</span><span class="ident" id="6301684">readFull</span><span class="op" id="6301692">(</span><span class="ident" id="6301693">d</span><span class="op" id="6301694">.</span><span class="ident" id="6301695">tmp</span><span class="op" id="6301698">[</span><span class="op" id="6301699">:</span><span class="ident" id="6301700">qtLength</span><span class="op" id="6301708">]</span><span class="op" id="6301709">)</span><span class="op" id="6301710">;</span>&nbsp;<span class="ident" id="6301712">err</span>&nbsp;<span class="op" id="6301716">!=</span>&nbsp;<span class="ident" id="6301719">nil</span>&nbsp;<span class="op" id="6301723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6301728">return</span>&nbsp;<span class="ident" id="6301735">err</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6301741">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6301745">pq</span>&nbsp;<span class="op" id="6301748">:=</span>&nbsp;<span class="ident" id="6301751">d</span><span class="op" id="6301752">.</span><span class="ident" id="6301753">tmp</span><span class="op" id="6301756">[</span><span class="num" id="6301757">0</span><span class="op" id="6301758">]</span>&nbsp;<span class="op" id="6301760">&gt;&gt;</span>&nbsp;<span class="num" id="6301763">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6301767">if</span>&nbsp;<span class="ident" id="6301770">pq</span>&nbsp;<span class="op" id="6301773">!=</span>&nbsp;<span class="num" id="6301776">0</span>&nbsp;<span class="op" id="6301778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6301783">return</span>&nbsp;<span class="ident" id="6301790">UnsupportedError</span><span class="op" id="6301806">(</span><span class="string" id="6301807">&#34;bad&nbsp;Pq&nbsp;value&#34;</span><span class="op" id="6301821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6301825">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6301829">tq</span>&nbsp;<span class="op" id="6301832">:=</span>&nbsp;<span class="ident" id="6301835">d</span><span class="op" id="6301836">.</span><span class="ident" id="6301837">tmp</span><span class="op" id="6301840">[</span><span class="num" id="6301841">0</span><span class="op" id="6301842">]</span>&nbsp;<span class="op" id="6301844">&amp;</span>&nbsp;<span class="num" id="6301846">0x0f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6301853">if</span>&nbsp;<span class="ident" id="6301856">tq</span>&nbsp;<span class="op" id="6301859">&gt;</span>&nbsp;<span class="ident" id="6301861">maxTq</span>&nbsp;<span class="op" id="6301867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6301872">return</span>&nbsp;<span class="ident" id="6301879">FormatError</span><span class="op" id="6301890">(</span><span class="string" id="6301891">&#34;bad&nbsp;Tq&nbsp;value&#34;</span><span class="op" id="6301905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6301909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6301913">for</span>&nbsp;<span class="ident" id="6301917">i</span>&nbsp;<span class="op" id="6301919">:=</span>&nbsp;<span class="keyword" id="6301922">range</span>&nbsp;<span class="ident" id="6301928">d</span><span class="op" id="6301929">.</span><span class="ident" id="6301930">quant</span><span class="op" id="6301935">[</span><span class="ident" id="6301936">tq</span><span class="op" id="6301938">]</span>&nbsp;<span class="op" id="6301940">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6301945">d</span><span class="op" id="6301946">.</span><span class="ident" id="6301947">quant</span><span class="op" id="6301952">[</span><span class="ident" id="6301953">tq</span><span class="op" id="6301955">]</span><span class="op" id="6301956">[</span><span class="ident" id="6301957">i</span><span class="op" id="6301958">]</span>&nbsp;<span class="op" id="6301960">=</span>&nbsp;<span class="builtintype" id="6301962">int32</span><span class="op" id="6301967">(</span><span class="ident" id="6301968">d</span><span class="op" id="6301969">.</span><span class="ident" id="6301970">tmp</span><span class="op" id="6301973">[</span><span class="ident" id="6301974">i</span><span class="op" id="6301975">+</span><span class="num" id="6301976">1</span><span class="op" id="6301977">]</span><span class="op" id="6301978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6301982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6301985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6301988">if</span>&nbsp;<span class="ident" id="6301991">n</span>&nbsp;<span class="op" id="6301993">!=</span>&nbsp;<span class="num" id="6301996">0</span>&nbsp;<span class="op" id="6301998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6302002">return</span>&nbsp;<span class="ident" id="6302009">FormatError</span><span class="op" id="6302020">(</span><span class="string" id="6302021">&#34;DQT&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="6302043">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6302046">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6302049">return</span>&nbsp;<span class="ident" id="6302056">nil</span><br>
<span class="lineno"></span><span class="op" id="6302060">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6302063">//&nbsp;Specified&nbsp;in&nbsp;section&nbsp;B.2.4.4.</span><br>
<span class="lineno">370</span><span class="keyword" id="6302096">func</span>&nbsp;<span class="op" id="6302101">(</span><span class="ident" id="6302102">d</span>&nbsp;<span class="op" id="6302104">*</span><span class="ident" id="6302105">decoder</span><span class="op" id="6302112">)</span>&nbsp;<span class="ident" id="6302114">processDRI</span><span class="op" id="6302124">(</span><span class="ident" id="6302125">n</span>&nbsp;<span class="builtintype" id="6302127">int</span><span class="op" id="6302130">)</span>&nbsp;<span class="builtintype" id="6302132">error</span>&nbsp;<span class="op" id="6302138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6302141">if</span>&nbsp;<span class="ident" id="6302144">n</span>&nbsp;<span class="op" id="6302146">!=</span>&nbsp;<span class="num" id="6302149">2</span>&nbsp;<span class="op" id="6302151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6302155">return</span>&nbsp;<span class="ident" id="6302162">FormatError</span><span class="op" id="6302173">(</span><span class="string" id="6302174">&#34;DRI&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="6302196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6302199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6302202">if</span>&nbsp;<span class="ident" id="6302205">err</span>&nbsp;<span class="op" id="6302209">:=</span>&nbsp;<span class="ident" id="6302212">d</span><span class="op" id="6302213">.</span><span class="ident" id="6302214">readFull</span><span class="op" id="6302222">(</span><span class="ident" id="6302223">d</span><span class="op" id="6302224">.</span><span class="ident" id="6302225">tmp</span><span class="op" id="6302228">[</span><span class="op" id="6302229">:</span><span class="num" id="6302230">2</span><span class="op" id="6302231">]</span><span class="op" id="6302232">)</span><span class="op" id="6302233">;</span>&nbsp;<span class="ident" id="6302235">err</span>&nbsp;<span class="op" id="6302239">!=</span>&nbsp;<span class="ident" id="6302242">nil</span>&nbsp;<span class="op" id="6302246">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6302250">return</span>&nbsp;<span class="ident" id="6302257">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6302262">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6302265">d</span><span class="op" id="6302266">.</span><span class="ident" id="6302267">ri</span>&nbsp;<span class="op" id="6302270">=</span>&nbsp;<span class="builtintype" id="6302272">int</span><span class="op" id="6302275">(</span><span class="ident" id="6302276">d</span><span class="op" id="6302277">.</span><span class="ident" id="6302278">tmp</span><span class="op" id="6302281">[</span><span class="num" id="6302282">0</span><span class="op" id="6302283">]</span><span class="op" id="6302284">)</span><span class="op" id="6302285">&lt;&lt;</span><span class="num" id="6302287">8</span>&nbsp;<span class="op" id="6302289">+</span>&nbsp;<span class="builtintype" id="6302291">int</span><span class="op" id="6302294">(</span><span class="ident" id="6302295">d</span><span class="op" id="6302296">.</span><span class="ident" id="6302297">tmp</span><span class="op" id="6302300">[</span><span class="num" id="6302301">1</span><span class="op" id="6302302">]</span><span class="op" id="6302303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6302306">return</span>&nbsp;<span class="ident" id="6302313">nil</span><br>
<span class="lineno"></span><span class="op" id="6302317">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span><span class="comment" id="6302320">//&nbsp;decode&nbsp;reads&nbsp;a&nbsp;JPEG&nbsp;image&nbsp;from&nbsp;r&nbsp;and&nbsp;returns&nbsp;it&nbsp;as&nbsp;an&nbsp;image.Image.</span><br>
<span class="lineno"></span><span class="keyword" id="6302390">func</span>&nbsp;<span class="op" id="6302395">(</span><span class="ident" id="6302396">d</span>&nbsp;<span class="op" id="6302398">*</span><span class="ident" id="6302399">decoder</span><span class="op" id="6302406">)</span>&nbsp;<span class="ident" id="6302408">decode</span><span class="op" id="6302414">(</span><span class="ident" id="6302415">r</span>&nbsp;<span class="ident" id="6302417">io</span><span class="op" id="6302419">.</span><span class="ident" id="6302420">Reader</span><span class="op" id="6302426">,</span>&nbsp;<span class="ident" id="6302428">configOnly</span>&nbsp;<span class="builtintype" id="6302439">bool</span><span class="op" id="6302443">)</span>&nbsp;<span class="op" id="6302445">(</span><span class="ident" id="6302446">image</span><span class="op" id="6302451">.</span><span class="ident" id="6302452">Image</span><span class="op" id="6302457">,</span>&nbsp;<span class="builtintype" id="6302459">error</span><span class="op" id="6302464">)</span>&nbsp;<span class="op" id="6302466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6302469">d</span><span class="op" id="6302470">.</span><span class="ident" id="6302471">r</span>&nbsp;<span class="op" id="6302473">=</span>&nbsp;<span class="ident" id="6302475">r</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6302479">//&nbsp;Check&nbsp;for&nbsp;the&nbsp;Start&nbsp;Of&nbsp;Image&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6302520">if</span>&nbsp;<span class="ident" id="6302523">err</span>&nbsp;<span class="op" id="6302527">:=</span>&nbsp;<span class="ident" id="6302530">d</span><span class="op" id="6302531">.</span><span class="ident" id="6302532">readFull</span><span class="op" id="6302540">(</span><span class="ident" id="6302541">d</span><span class="op" id="6302542">.</span><span class="ident" id="6302543">tmp</span><span class="op" id="6302546">[</span><span class="op" id="6302547">:</span><span class="num" id="6302548">2</span><span class="op" id="6302549">]</span><span class="op" id="6302550">)</span><span class="op" id="6302551">;</span>&nbsp;<span class="ident" id="6302553">err</span>&nbsp;<span class="op" id="6302557">!=</span>&nbsp;<span class="ident" id="6302560">nil</span>&nbsp;<span class="op" id="6302564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6302568">return</span>&nbsp;<span class="ident" id="6302575">nil</span><span class="op" id="6302578">,</span>&nbsp;<span class="ident" id="6302580">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6302585">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6302588">if</span>&nbsp;<span class="ident" id="6302591">d</span><span class="op" id="6302592">.</span><span class="ident" id="6302593">tmp</span><span class="op" id="6302596">[</span><span class="num" id="6302597">0</span><span class="op" id="6302598">]</span>&nbsp;<span class="op" id="6302600">!=</span>&nbsp;<span class="num" id="6302603">0xff</span>&nbsp;<span class="op" id="6302608">||</span>&nbsp;<span class="ident" id="6302611">d</span><span class="op" id="6302612">.</span><span class="ident" id="6302613">tmp</span><span class="op" id="6302616">[</span><span class="num" id="6302617">1</span><span class="op" id="6302618">]</span>&nbsp;<span class="op" id="6302620">!=</span>&nbsp;<span class="ident" id="6302623">soiMarker</span>&nbsp;<span class="op" id="6302633">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6302637">return</span>&nbsp;<span class="ident" id="6302644">nil</span><span class="op" id="6302647">,</span>&nbsp;<span class="ident" id="6302649">FormatError</span><span class="op" id="6302660">(</span><span class="string" id="6302661">&#34;missing&nbsp;SOI&nbsp;marker&#34;</span><span class="op" id="6302681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6302684">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6302688">//&nbsp;Process&nbsp;the&nbsp;remaining&nbsp;segments&nbsp;until&nbsp;the&nbsp;End&nbsp;Of&nbsp;Image&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6302754">for</span>&nbsp;<span class="op" id="6302758">{</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6302762">err</span>&nbsp;<span class="op" id="6302766">:=</span>&nbsp;<span class="ident" id="6302769">d</span><span class="op" id="6302770">.</span><span class="ident" id="6302771">readFull</span><span class="op" id="6302779">(</span><span class="ident" id="6302780">d</span><span class="op" id="6302781">.</span><span class="ident" id="6302782">tmp</span><span class="op" id="6302785">[</span><span class="op" id="6302786">:</span><span class="num" id="6302787">2</span><span class="op" id="6302788">]</span><span class="op" id="6302789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6302793">if</span>&nbsp;<span class="ident" id="6302796">err</span>&nbsp;<span class="op" id="6302800">!=</span>&nbsp;<span class="ident" id="6302803">nil</span>&nbsp;<span class="op" id="6302807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6302812">return</span>&nbsp;<span class="ident" id="6302819">nil</span><span class="op" id="6302822">,</span>&nbsp;<span class="ident" id="6302824">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6302830">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6302834">for</span>&nbsp;<span class="ident" id="6302838">d</span><span class="op" id="6302839">.</span><span class="ident" id="6302840">tmp</span><span class="op" id="6302843">[</span><span class="num" id="6302844">0</span><span class="op" id="6302845">]</span>&nbsp;<span class="op" id="6302847">!=</span>&nbsp;<span class="num" id="6302850">0xff</span>&nbsp;<span class="op" id="6302855">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6302860">//&nbsp;Strictly&nbsp;speaking,&nbsp;this&nbsp;is&nbsp;a&nbsp;format&nbsp;error.&nbsp;However,&nbsp;libjpeg&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6302929">//&nbsp;liberal&nbsp;in&nbsp;what&nbsp;it&nbsp;accepts.&nbsp;As&nbsp;of&nbsp;version&nbsp;9,&nbsp;next_marker&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6302995">//&nbsp;jdmarker.c&nbsp;treats&nbsp;this&nbsp;as&nbsp;a&nbsp;warning&nbsp;(JWRN_EXTRANEOUS_DATA)&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6303064">//&nbsp;continues&nbsp;to&nbsp;decode&nbsp;the&nbsp;stream.&nbsp;Even&nbsp;before&nbsp;next_marker&nbsp;sees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6303131">//&nbsp;extraneous&nbsp;data,&nbsp;jpeg_fill_bit_buffer&nbsp;in&nbsp;jdhuff.c&nbsp;reads&nbsp;as&nbsp;many</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6303201">//&nbsp;bytes&nbsp;as&nbsp;it&nbsp;can,&nbsp;possibly&nbsp;past&nbsp;the&nbsp;end&nbsp;of&nbsp;a&nbsp;scan&#39;s&nbsp;data.&nbsp;It</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6303267">//&nbsp;effectively&nbsp;puts&nbsp;back&nbsp;any&nbsp;markers&nbsp;that&nbsp;it&nbsp;overscanned&nbsp;(e.g.&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6303336">//&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker),&nbsp;but&nbsp;it&nbsp;does&nbsp;not&nbsp;put&nbsp;back&nbsp;non-marker&nbsp;data,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6303408">//&nbsp;and&nbsp;thus&nbsp;it&nbsp;can&nbsp;silently&nbsp;ignore&nbsp;a&nbsp;small&nbsp;number&nbsp;of&nbsp;extraneous</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6303475">//&nbsp;non-marker&nbsp;bytes&nbsp;before&nbsp;next_marker&nbsp;has&nbsp;a&nbsp;chance&nbsp;to&nbsp;see&nbsp;them&nbsp;(and</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6303547">//&nbsp;print&nbsp;a&nbsp;warning).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6303571">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6303577">//&nbsp;We&nbsp;are&nbsp;therefore&nbsp;also&nbsp;liberal&nbsp;in&nbsp;what&nbsp;we&nbsp;accept.&nbsp;Extraneous&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6303648">//&nbsp;is&nbsp;silently&nbsp;ignored.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6303675">//</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6303681">//&nbsp;This&nbsp;is&nbsp;similar&nbsp;to,&nbsp;but&nbsp;not&nbsp;exactly&nbsp;the&nbsp;same&nbsp;as,&nbsp;the&nbsp;restart</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6303748">//&nbsp;mechanism&nbsp;within&nbsp;a&nbsp;scan&nbsp;(the&nbsp;RST[0-7]&nbsp;markers).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6303802">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6303808">//&nbsp;Note&nbsp;that&nbsp;extraneous&nbsp;0xff&nbsp;bytes&nbsp;in&nbsp;e.g.&nbsp;SOS&nbsp;data&nbsp;are&nbsp;escaped&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6303878">//&nbsp;&#34;\xff\x00&#34;,&nbsp;and&nbsp;so&nbsp;are&nbsp;detected&nbsp;a&nbsp;little&nbsp;further&nbsp;down&nbsp;below.</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6303945">d</span><span class="op" id="6303946">.</span><span class="ident" id="6303947">tmp</span><span class="op" id="6303950">[</span><span class="num" id="6303951">0</span><span class="op" id="6303952">]</span>&nbsp;<span class="op" id="6303954">=</span>&nbsp;<span class="ident" id="6303956">d</span><span class="op" id="6303957">.</span><span class="ident" id="6303958">tmp</span><span class="op" id="6303961">[</span><span class="num" id="6303962">1</span><span class="op" id="6303963">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6303968">d</span><span class="op" id="6303969">.</span><span class="ident" id="6303970">tmp</span><span class="op" id="6303973">[</span><span class="num" id="6303974">1</span><span class="op" id="6303975">]</span><span class="op" id="6303976">,</span>&nbsp;<span class="ident" id="6303978">err</span>&nbsp;<span class="op" id="6303982">=</span>&nbsp;<span class="ident" id="6303984">d</span><span class="op" id="6303985">.</span><span class="ident" id="6303986">readByte</span><span class="op" id="6303994">(</span><span class="op" id="6303995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6304000">if</span>&nbsp;<span class="ident" id="6304003">err</span>&nbsp;<span class="op" id="6304007">!=</span>&nbsp;<span class="ident" id="6304010">nil</span>&nbsp;<span class="op" id="6304014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6304020">return</span>&nbsp;<span class="ident" id="6304027">nil</span><span class="op" id="6304030">,</span>&nbsp;<span class="ident" id="6304032">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6304039">}</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6304043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6304047">marker</span>&nbsp;<span class="op" id="6304054">:=</span>&nbsp;<span class="ident" id="6304057">d</span><span class="op" id="6304058">.</span><span class="ident" id="6304059">tmp</span><span class="op" id="6304062">[</span><span class="num" id="6304063">1</span><span class="op" id="6304064">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6304068">if</span>&nbsp;<span class="ident" id="6304071">marker</span>&nbsp;<span class="op" id="6304078">==</span>&nbsp;<span class="num" id="6304081">0</span>&nbsp;<span class="op" id="6304083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6304088">//&nbsp;Treat&nbsp;&#34;\xff\x00&#34;&nbsp;as&nbsp;extraneous&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6304131">continue</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6304142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6304146">for</span>&nbsp;<span class="ident" id="6304150">marker</span>&nbsp;<span class="op" id="6304157">==</span>&nbsp;<span class="num" id="6304160">0xff</span>&nbsp;<span class="op" id="6304165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6304170">//&nbsp;Section&nbsp;B.1.1.2&nbsp;says,&nbsp;&#34;Any&nbsp;marker&nbsp;may&nbsp;optionally&nbsp;be&nbsp;preceded&nbsp;by&nbsp;any</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6304244">//&nbsp;number&nbsp;of&nbsp;fill&nbsp;bytes,&nbsp;which&nbsp;are&nbsp;bytes&nbsp;assigned&nbsp;code&nbsp;X&#39;FF&#39;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6304310">marker</span><span class="op" id="6304316">,</span>&nbsp;<span class="ident" id="6304318">err</span>&nbsp;<span class="op" id="6304322">=</span>&nbsp;<span class="ident" id="6304324">d</span><span class="op" id="6304325">.</span><span class="ident" id="6304326">readByte</span><span class="op" id="6304334">(</span><span class="op" id="6304335">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6304340">if</span>&nbsp;<span class="ident" id="6304343">err</span>&nbsp;<span class="op" id="6304347">!=</span>&nbsp;<span class="ident" id="6304350">nil</span>&nbsp;<span class="op" id="6304354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6304360">return</span>&nbsp;<span class="ident" id="6304367">nil</span><span class="op" id="6304370">,</span>&nbsp;<span class="ident" id="6304372">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6304379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6304383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6304387">if</span>&nbsp;<span class="ident" id="6304390">marker</span>&nbsp;<span class="op" id="6304397">==</span>&nbsp;<span class="ident" id="6304400">eoiMarker</span>&nbsp;<span class="op" id="6304410">{</span>&nbsp;<span class="comment" id="6304412">//&nbsp;End&nbsp;Of&nbsp;Image.</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6304432">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6304440">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6304444">if</span>&nbsp;<span class="ident" id="6304447">rst0Marker</span>&nbsp;<span class="op" id="6304458">&lt;=</span>&nbsp;<span class="ident" id="6304461">marker</span>&nbsp;<span class="op" id="6304468">&amp;&amp;</span>&nbsp;<span class="ident" id="6304471">marker</span>&nbsp;<span class="op" id="6304478">&lt;=</span>&nbsp;<span class="ident" id="6304481">rst7Marker</span>&nbsp;<span class="op" id="6304492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6304497">//&nbsp;Figures&nbsp;B.2&nbsp;and&nbsp;B.16&nbsp;of&nbsp;the&nbsp;specification&nbsp;suggest&nbsp;that&nbsp;restart&nbsp;markers&nbsp;should</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6304581">//&nbsp;only&nbsp;occur&nbsp;between&nbsp;Entropy&nbsp;Coded&nbsp;Segments&nbsp;and&nbsp;not&nbsp;after&nbsp;the&nbsp;final&nbsp;ECS.</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6304658">//&nbsp;However,&nbsp;some&nbsp;encoders&nbsp;may&nbsp;generate&nbsp;incorrect&nbsp;JPEGs&nbsp;with&nbsp;a&nbsp;final&nbsp;restart</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6304737">//&nbsp;marker.&nbsp;That&nbsp;restart&nbsp;marker&nbsp;will&nbsp;be&nbsp;seen&nbsp;here&nbsp;instead&nbsp;of&nbsp;inside&nbsp;the&nbsp;processSOS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6304822">//&nbsp;method,&nbsp;and&nbsp;is&nbsp;ignored&nbsp;as&nbsp;a&nbsp;harmless&nbsp;error.&nbsp;Restart&nbsp;markers&nbsp;have&nbsp;no&nbsp;extra&nbsp;data,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6304908">//&nbsp;so&nbsp;we&nbsp;check&nbsp;for&nbsp;this&nbsp;before&nbsp;we&nbsp;read&nbsp;the&nbsp;16-bit&nbsp;length&nbsp;of&nbsp;the&nbsp;segment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6304984">continue</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6304995">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6305000">//&nbsp;Read&nbsp;the&nbsp;16-bit&nbsp;length&nbsp;of&nbsp;the&nbsp;segment.&nbsp;The&nbsp;value&nbsp;includes&nbsp;the&nbsp;2&nbsp;bytes&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6305083">//&nbsp;length&nbsp;itself,&nbsp;so&nbsp;we&nbsp;subtract&nbsp;2&nbsp;to&nbsp;get&nbsp;the&nbsp;number&nbsp;of&nbsp;remaining&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6305158">if</span>&nbsp;<span class="ident" id="6305161">err</span>&nbsp;<span class="op" id="6305165">=</span>&nbsp;<span class="ident" id="6305167">d</span><span class="op" id="6305168">.</span><span class="ident" id="6305169">readFull</span><span class="op" id="6305177">(</span><span class="ident" id="6305178">d</span><span class="op" id="6305179">.</span><span class="ident" id="6305180">tmp</span><span class="op" id="6305183">[</span><span class="op" id="6305184">:</span><span class="num" id="6305185">2</span><span class="op" id="6305186">]</span><span class="op" id="6305187">)</span><span class="op" id="6305188">;</span>&nbsp;<span class="ident" id="6305190">err</span>&nbsp;<span class="op" id="6305194">!=</span>&nbsp;<span class="ident" id="6305197">nil</span>&nbsp;<span class="op" id="6305201">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6305206">return</span>&nbsp;<span class="ident" id="6305213">nil</span><span class="op" id="6305216">,</span>&nbsp;<span class="ident" id="6305218">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6305224">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6305228">n</span>&nbsp;<span class="op" id="6305230">:=</span>&nbsp;<span class="builtintype" id="6305233">int</span><span class="op" id="6305236">(</span><span class="ident" id="6305237">d</span><span class="op" id="6305238">.</span><span class="ident" id="6305239">tmp</span><span class="op" id="6305242">[</span><span class="num" id="6305243">0</span><span class="op" id="6305244">]</span><span class="op" id="6305245">)</span><span class="op" id="6305246">&lt;&lt;</span><span class="num" id="6305248">8</span>&nbsp;<span class="op" id="6305250">+</span>&nbsp;<span class="builtintype" id="6305252">int</span><span class="op" id="6305255">(</span><span class="ident" id="6305256">d</span><span class="op" id="6305257">.</span><span class="ident" id="6305258">tmp</span><span class="op" id="6305261">[</span><span class="num" id="6305262">1</span><span class="op" id="6305263">]</span><span class="op" id="6305264">)</span>&nbsp;<span class="op" id="6305266">-</span>&nbsp;<span class="num" id="6305268">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6305272">if</span>&nbsp;<span class="ident" id="6305275">n</span>&nbsp;<span class="op" id="6305277">&lt;</span>&nbsp;<span class="num" id="6305279">0</span>&nbsp;<span class="op" id="6305281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6305286">return</span>&nbsp;<span class="ident" id="6305293">nil</span><span class="op" id="6305296">,</span>&nbsp;<span class="ident" id="6305298">FormatError</span><span class="op" id="6305309">(</span><span class="string" id="6305310">&#34;short&nbsp;segment&nbsp;length&#34;</span><span class="op" id="6305332">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6305336">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6305341">switch</span>&nbsp;<span class="op" id="6305348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6305352">case</span>&nbsp;<span class="ident" id="6305357">marker</span>&nbsp;<span class="op" id="6305364">==</span>&nbsp;<span class="ident" id="6305367">sof0Marker</span>&nbsp;<span class="op" id="6305378">||</span>&nbsp;<span class="ident" id="6305381">marker</span>&nbsp;<span class="op" id="6305388">==</span>&nbsp;<span class="ident" id="6305391">sof2Marker</span><span class="op" id="6305401">:</span>&nbsp;<span class="comment" id="6305403">//&nbsp;Start&nbsp;Of&nbsp;Frame.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6305425">d</span><span class="op" id="6305426">.</span><span class="ident" id="6305427">progressive</span>&nbsp;<span class="op" id="6305439">=</span>&nbsp;<span class="ident" id="6305441">marker</span>&nbsp;<span class="op" id="6305448">==</span>&nbsp;<span class="ident" id="6305451">sof2Marker</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6305465">err</span>&nbsp;<span class="op" id="6305469">=</span>&nbsp;<span class="ident" id="6305471">d</span><span class="op" id="6305472">.</span><span class="ident" id="6305473">processSOF</span><span class="op" id="6305483">(</span><span class="ident" id="6305484">n</span><span class="op" id="6305485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6305490">if</span>&nbsp;<span class="ident" id="6305493">configOnly</span>&nbsp;<span class="op" id="6305504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6305510">return</span>&nbsp;<span class="ident" id="6305517">nil</span><span class="op" id="6305520">,</span>&nbsp;<span class="ident" id="6305522">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6305529">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6305533">case</span>&nbsp;<span class="ident" id="6305538">marker</span>&nbsp;<span class="op" id="6305545">==</span>&nbsp;<span class="ident" id="6305548">dhtMarker</span><span class="op" id="6305557">:</span>&nbsp;<span class="comment" id="6305559">//&nbsp;Define&nbsp;Huffman&nbsp;Table.</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6305587">err</span>&nbsp;<span class="op" id="6305591">=</span>&nbsp;<span class="ident" id="6305593">d</span><span class="op" id="6305594">.</span><span class="ident" id="6305595">processDHT</span><span class="op" id="6305605">(</span><span class="ident" id="6305606">n</span><span class="op" id="6305607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6305611">case</span>&nbsp;<span class="ident" id="6305616">marker</span>&nbsp;<span class="op" id="6305623">==</span>&nbsp;<span class="ident" id="6305626">dqtMarker</span><span class="op" id="6305635">:</span>&nbsp;<span class="comment" id="6305637">//&nbsp;Define&nbsp;Quantization&nbsp;Table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6305670">err</span>&nbsp;<span class="op" id="6305674">=</span>&nbsp;<span class="ident" id="6305676">d</span><span class="op" id="6305677">.</span><span class="ident" id="6305678">processDQT</span><span class="op" id="6305688">(</span><span class="ident" id="6305689">n</span><span class="op" id="6305690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6305694">case</span>&nbsp;<span class="ident" id="6305699">marker</span>&nbsp;<span class="op" id="6305706">==</span>&nbsp;<span class="ident" id="6305709">sosMarker</span><span class="op" id="6305718">:</span>&nbsp;<span class="comment" id="6305720">//&nbsp;Start&nbsp;Of&nbsp;Scan.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6305741">err</span>&nbsp;<span class="op" id="6305745">=</span>&nbsp;<span class="ident" id="6305747">d</span><span class="op" id="6305748">.</span><span class="ident" id="6305749">processSOS</span><span class="op" id="6305759">(</span><span class="ident" id="6305760">n</span><span class="op" id="6305761">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6305765">case</span>&nbsp;<span class="ident" id="6305770">marker</span>&nbsp;<span class="op" id="6305777">==</span>&nbsp;<span class="ident" id="6305780">driMarker</span><span class="op" id="6305789">:</span>&nbsp;<span class="comment" id="6305791">//&nbsp;Define&nbsp;Restart&nbsp;Interval.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6305822">err</span>&nbsp;<span class="op" id="6305826">=</span>&nbsp;<span class="ident" id="6305828">d</span><span class="op" id="6305829">.</span><span class="ident" id="6305830">processDRI</span><span class="op" id="6305840">(</span><span class="ident" id="6305841">n</span><span class="op" id="6305842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6305846">case</span>&nbsp;<span class="ident" id="6305851">app0Marker</span>&nbsp;<span class="op" id="6305862">&lt;=</span>&nbsp;<span class="ident" id="6305865">marker</span>&nbsp;<span class="op" id="6305872">&amp;&amp;</span>&nbsp;<span class="ident" id="6305875">marker</span>&nbsp;<span class="op" id="6305882">&lt;=</span>&nbsp;<span class="ident" id="6305885">app15Marker</span>&nbsp;<span class="op" id="6305897">||</span>&nbsp;<span class="ident" id="6305900">marker</span>&nbsp;<span class="op" id="6305907">==</span>&nbsp;<span class="ident" id="6305910">comMarker</span><span class="op" id="6305919">:</span>&nbsp;<span class="comment" id="6305921">//&nbsp;APPlication&nbsp;specific,&nbsp;or&nbsp;COMment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6305961">err</span>&nbsp;<span class="op" id="6305965">=</span>&nbsp;<span class="ident" id="6305967">d</span><span class="op" id="6305968">.</span><span class="ident" id="6305969">ignore</span><span class="op" id="6305975">(</span><span class="ident" id="6305976">n</span><span class="op" id="6305977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6305981">default</span><span class="op" id="6305988">:</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6305993">err</span>&nbsp;<span class="op" id="6305997">=</span>&nbsp;<span class="ident" id="6305999">UnsupportedError</span><span class="op" id="6306015">(</span><span class="string" id="6306016">&#34;unknown&nbsp;marker&#34;</span><span class="op" id="6306032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6306036">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6306040">if</span>&nbsp;<span class="ident" id="6306043">err</span>&nbsp;<span class="op" id="6306047">!=</span>&nbsp;<span class="ident" id="6306050">nil</span>&nbsp;<span class="op" id="6306054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6306059">return</span>&nbsp;<span class="ident" id="6306066">nil</span><span class="op" id="6306069">,</span>&nbsp;<span class="ident" id="6306071">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6306077">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6306080">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6306083">if</span>&nbsp;<span class="ident" id="6306086">d</span><span class="op" id="6306087">.</span><span class="ident" id="6306088">img1</span>&nbsp;<span class="op" id="6306093">!=</span>&nbsp;<span class="ident" id="6306096">nil</span>&nbsp;<span class="op" id="6306100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6306104">return</span>&nbsp;<span class="ident" id="6306111">d</span><span class="op" id="6306112">.</span><span class="ident" id="6306113">img1</span><span class="op" id="6306117">,</span>&nbsp;<span class="ident" id="6306119">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6306124">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6306127">if</span>&nbsp;<span class="ident" id="6306130">d</span><span class="op" id="6306131">.</span><span class="ident" id="6306132">img3</span>&nbsp;<span class="op" id="6306137">!=</span>&nbsp;<span class="ident" id="6306140">nil</span>&nbsp;<span class="op" id="6306144">{</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6306148">return</span>&nbsp;<span class="ident" id="6306155">d</span><span class="op" id="6306156">.</span><span class="ident" id="6306157">img3</span><span class="op" id="6306161">,</span>&nbsp;<span class="ident" id="6306163">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6306168">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6306171">return</span>&nbsp;<span class="ident" id="6306178">nil</span><span class="op" id="6306181">,</span>&nbsp;<span class="ident" id="6306183">FormatError</span><span class="op" id="6306194">(</span><span class="string" id="6306195">&#34;missing&nbsp;SOS&nbsp;marker&#34;</span><span class="op" id="6306215">)</span><br>
<span class="lineno"></span><span class="op" id="6306217">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="6306220">//&nbsp;Decode&nbsp;reads&nbsp;a&nbsp;JPEG&nbsp;image&nbsp;from&nbsp;r&nbsp;and&nbsp;returns&nbsp;it&nbsp;as&nbsp;an&nbsp;image.Image.</span><br>
<span class="lineno"></span><span class="keyword" id="6306290">func</span>&nbsp;<span class="ident" id="6306295">Decode</span><span class="op" id="6306301">(</span><span class="ident" id="6306302">r</span>&nbsp;<span class="ident" id="6306304">io</span><span class="op" id="6306306">.</span><span class="ident" id="6306307">Reader</span><span class="op" id="6306313">)</span>&nbsp;<span class="op" id="6306315">(</span><span class="ident" id="6306316">image</span><span class="op" id="6306321">.</span><span class="ident" id="6306322">Image</span><span class="op" id="6306327">,</span>&nbsp;<span class="builtintype" id="6306329">error</span><span class="op" id="6306334">)</span>&nbsp;<span class="op" id="6306336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6306339">var</span>&nbsp;<span class="ident" id="6306343">d</span>&nbsp;<span class="ident" id="6306345">decoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6306354">return</span>&nbsp;<span class="ident" id="6306361">d</span><span class="op" id="6306362">.</span><span class="ident" id="6306363">decode</span><span class="op" id="6306369">(</span><span class="ident" id="6306370">r</span><span class="op" id="6306371">,</span>&nbsp;<span class="ident" id="6306373">false</span><span class="op" id="6306378">)</span><br>
<span class="lineno"></span><span class="op" id="6306380">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="comment" id="6306383">//&nbsp;DecodeConfig&nbsp;returns&nbsp;the&nbsp;color&nbsp;model&nbsp;and&nbsp;dimensions&nbsp;of&nbsp;a&nbsp;JPEG&nbsp;image&nbsp;without</span><br>
<span class="lineno"></span><span class="comment" id="6306462">//&nbsp;decoding&nbsp;the&nbsp;entire&nbsp;image.</span><br>
<span class="lineno"></span><span class="keyword" id="6306492">func</span>&nbsp;<span class="ident" id="6306497">DecodeConfig</span><span class="op" id="6306509">(</span><span class="ident" id="6306510">r</span>&nbsp;<span class="ident" id="6306512">io</span><span class="op" id="6306514">.</span><span class="ident" id="6306515">Reader</span><span class="op" id="6306521">)</span>&nbsp;<span class="op" id="6306523">(</span><span class="ident" id="6306524">image</span><span class="op" id="6306529">.</span><span class="ident" id="6306530">Config</span><span class="op" id="6306536">,</span>&nbsp;<span class="builtintype" id="6306538">error</span><span class="op" id="6306543">)</span>&nbsp;<span class="op" id="6306545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6306548">var</span>&nbsp;<span class="ident" id="6306552">d</span>&nbsp;<span class="ident" id="6306554">decoder</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6306563">if</span>&nbsp;<span class="ident" id="6306566">_</span><span class="op" id="6306567">,</span>&nbsp;<span class="ident" id="6306569">err</span>&nbsp;<span class="op" id="6306573">:=</span>&nbsp;<span class="ident" id="6306576">d</span><span class="op" id="6306577">.</span><span class="ident" id="6306578">decode</span><span class="op" id="6306584">(</span><span class="ident" id="6306585">r</span><span class="op" id="6306586">,</span>&nbsp;<span class="ident" id="6306588">true</span><span class="op" id="6306592">)</span><span class="op" id="6306593">;</span>&nbsp;<span class="ident" id="6306595">err</span>&nbsp;<span class="op" id="6306599">!=</span>&nbsp;<span class="ident" id="6306602">nil</span>&nbsp;<span class="op" id="6306606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6306610">return</span>&nbsp;<span class="ident" id="6306617">image</span><span class="op" id="6306622">.</span><span class="ident" id="6306623">Config</span><span class="op" id="6306629">{</span><span class="op" id="6306630">}</span><span class="op" id="6306631">,</span>&nbsp;<span class="ident" id="6306633">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6306638">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6306641">switch</span>&nbsp;<span class="ident" id="6306648">d</span><span class="op" id="6306649">.</span><span class="ident" id="6306650">nComp</span>&nbsp;<span class="op" id="6306656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6306659">case</span>&nbsp;<span class="ident" id="6306664">nGrayComponent</span><span class="op" id="6306678">:</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6306682">return</span>&nbsp;<span class="ident" id="6306689">image</span><span class="op" id="6306694">.</span><span class="ident" id="6306695">Config</span><span class="op" id="6306701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6306706">ColorModel</span><span class="op" id="6306716">:</span>&nbsp;<span class="ident" id="6306718">color</span><span class="op" id="6306723">.</span><span class="ident" id="6306724">GrayModel</span><span class="op" id="6306733">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6306738">Width</span><span class="op" id="6306743">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6306750">d</span><span class="op" id="6306751">.</span><span class="ident" id="6306752">width</span><span class="op" id="6306757">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6306762">Height</span><span class="op" id="6306768">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6306774">d</span><span class="op" id="6306775">.</span><span class="ident" id="6306776">height</span><span class="op" id="6306782">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6306786">}</span><span class="op" id="6306787">,</span>&nbsp;<span class="ident" id="6306789">nil</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6306794">case</span>&nbsp;<span class="ident" id="6306799">nColorComponent</span><span class="op" id="6306814">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6306818">return</span>&nbsp;<span class="ident" id="6306825">image</span><span class="op" id="6306830">.</span><span class="ident" id="6306831">Config</span><span class="op" id="6306837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6306842">ColorModel</span><span class="op" id="6306852">:</span>&nbsp;<span class="ident" id="6306854">color</span><span class="op" id="6306859">.</span><span class="ident" id="6306860">YCbCrModel</span><span class="op" id="6306870">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6306875">Width</span><span class="op" id="6306880">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6306887">d</span><span class="op" id="6306888">.</span><span class="ident" id="6306889">width</span><span class="op" id="6306894">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6306899">Height</span><span class="op" id="6306905">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6306911">d</span><span class="op" id="6306912">.</span><span class="ident" id="6306913">height</span><span class="op" id="6306919">,</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6306923">}</span><span class="op" id="6306924">,</span>&nbsp;<span class="ident" id="6306926">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6306931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6306934">return</span>&nbsp;<span class="ident" id="6306941">image</span><span class="op" id="6306946">.</span><span class="ident" id="6306947">Config</span><span class="op" id="6306953">{</span><span class="op" id="6306954">}</span><span class="op" id="6306955">,</span>&nbsp;<span class="ident" id="6306957">FormatError</span><span class="op" id="6306968">(</span><span class="string" id="6306969">&#34;missing&nbsp;SOF&nbsp;marker&#34;</span><span class="op" id="6306989">)</span><br>
<span class="lineno"></span><span class="op" id="6306991">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">525</span><span class="keyword" id="6306994">func</span>&nbsp;<span class="ident" id="6306999">init</span><span class="op" id="6307003">(</span><span class="op" id="6307004">)</span>&nbsp;<span class="op" id="6307006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6307009">image</span><span class="op" id="6307014">.</span><span class="ident" id="6307015">RegisterFormat</span><span class="op" id="6307029">(</span><span class="string" id="6307030">&#34;jpeg&#34;</span><span class="op" id="6307036">,</span>&nbsp;<span class="string" id="6307038">&#34;\xff\xd8&#34;</span><span class="op" id="6307048">,</span>&nbsp;<span class="ident" id="6307050">Decode</span><span class="op" id="6307056">,</span>&nbsp;<span class="ident" id="6307058">DecodeConfig</span><span class="op" id="6307070">)</span><br>
<span class="lineno"></span><span class="op" id="6307072">}</span>
</div>
</body>
</html>
