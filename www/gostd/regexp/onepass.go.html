<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>regexp</h2>
<ul>
<li><a href="/gostd/regexp/all_test.go.html">all_test.go</a></li>
<li><a href="/gostd/regexp/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/regexp/exec.go.html">exec.go</a></li>
<li><a href="/gostd/regexp/exec2_test.go.html">exec2_test.go</a></li>
<li><a href="/gostd/regexp/exec_test.go.html">exec_test.go</a></li>
<li><a href="/gostd/regexp/find_test.go.html">find_test.go</a></li>
<li><a href="/gostd/regexp/onepass.go.html">onepass.go</a></li>
<li><a href="/gostd/regexp/onepass_test.go.html">onepass_test.go</a></li>
<li><a href="/gostd/regexp/regexp.go.html">regexp.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5495979">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5496035">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5496089">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5496140">package</span>&nbsp;<span class="ident" id="5496148">regexp</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5496156">import</span>&nbsp;<span class="op" id="5496163">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5496166">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5496175">&#34;regexp/syntax&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5496192">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5496200">&#34;unicode&#34;</span><br>
<span class="lineno"></span><span class="op" id="5496210">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5496213">//&nbsp;&#34;One-pass&#34;&nbsp;regexp&nbsp;execution.</span><br>
<span class="lineno">15</span><span class="comment" id="5496245">//&nbsp;Some&nbsp;regexps&nbsp;can&nbsp;be&nbsp;analyzed&nbsp;to&nbsp;determine&nbsp;that&nbsp;they&nbsp;never&nbsp;need</span><br>
<span class="lineno"></span><span class="comment" id="5496311">//&nbsp;backtracking:&nbsp;they&nbsp;are&nbsp;guaranteed&nbsp;to&nbsp;run&nbsp;in&nbsp;one&nbsp;pass&nbsp;over&nbsp;the&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="5496383">//&nbsp;without&nbsp;bothering&nbsp;to&nbsp;save&nbsp;all&nbsp;the&nbsp;usual&nbsp;NFA&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="5496437">//&nbsp;Detect&nbsp;those&nbsp;and&nbsp;execute&nbsp;them&nbsp;more&nbsp;quickly.</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="5496485">//&nbsp;A&nbsp;onePassProg&nbsp;is&nbsp;a&nbsp;compiled&nbsp;one-pass&nbsp;regular&nbsp;expression&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="5496553">//&nbsp;It&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;syntax.Prog&nbsp;except&nbsp;for&nbsp;the&nbsp;use&nbsp;of&nbsp;onePassInst.</span><br>
<span class="lineno"></span><span class="keyword" id="5496621">type</span>&nbsp;<span class="ident" id="5496626">onePassProg</span>&nbsp;<span class="keyword" id="5496638">struct</span>&nbsp;<span class="op" id="5496645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496648">Inst</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5496655">[</span><span class="op" id="5496656">]</span><span class="ident" id="5496657">onePassInst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496670">Start</span>&nbsp;&nbsp;<span class="builtintype" id="5496677">int</span>&nbsp;<span class="comment" id="5496681">//&nbsp;index&nbsp;of&nbsp;start&nbsp;instruction</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496712">NumCap</span>&nbsp;<span class="builtintype" id="5496719">int</span>&nbsp;<span class="comment" id="5496723">//&nbsp;number&nbsp;of&nbsp;InstCapture&nbsp;insts&nbsp;in&nbsp;re</span><br>
<span class="lineno"></span><span class="op" id="5496760">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5496763">//&nbsp;A&nbsp;onePassInst&nbsp;is&nbsp;a&nbsp;single&nbsp;instruction&nbsp;in&nbsp;a&nbsp;one-pass&nbsp;regular&nbsp;expression&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="5496846">//&nbsp;It&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;syntax.Inst&nbsp;except&nbsp;for&nbsp;the&nbsp;new&nbsp;&#39;Next&#39;&nbsp;field.</span><br>
<span class="lineno">30</span><span class="keyword" id="5496912">type</span>&nbsp;<span class="ident" id="5496917">onePassInst</span>&nbsp;<span class="keyword" id="5496929">struct</span>&nbsp;<span class="op" id="5496936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496939">syntax</span><span class="op" id="5496945">.</span><span class="ident" id="5496946">Inst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496952">Next</span>&nbsp;<span class="op" id="5496957">[</span><span class="op" id="5496958">]</span><span class="builtintype" id="5496959">uint32</span><br>
<span class="lineno"></span><span class="op" id="5496966">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="5496969">//&nbsp;OnePassPrefix&nbsp;returns&nbsp;a&nbsp;literal&nbsp;string&nbsp;that&nbsp;all&nbsp;matches&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5497036">//&nbsp;regexp&nbsp;must&nbsp;start&nbsp;with.&nbsp;&nbsp;Complete&nbsp;is&nbsp;true&nbsp;if&nbsp;the&nbsp;prefix</span><br>
<span class="lineno"></span><span class="comment" id="5497095">//&nbsp;is&nbsp;the&nbsp;entire&nbsp;match.&nbsp;Pc&nbsp;is&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;last&nbsp;rune&nbsp;instruction</span><br>
<span class="lineno"></span><span class="comment" id="5497164">//&nbsp;in&nbsp;the&nbsp;string.&nbsp;The&nbsp;OnePassPrefix&nbsp;skips&nbsp;over&nbsp;the&nbsp;mandatory</span><br>
<span class="lineno"></span><span class="comment" id="5497225">//&nbsp;EmptyBeginText</span><br>
<span class="lineno">40</span><span class="keyword" id="5497243">func</span>&nbsp;<span class="ident" id="5497248">onePassPrefix</span><span class="op" id="5497261">(</span><span class="ident" id="5497262">p</span>&nbsp;<span class="op" id="5497264">*</span><span class="ident" id="5497265">syntax</span><span class="op" id="5497271">.</span><span class="ident" id="5497272">Prog</span><span class="op" id="5497276">)</span>&nbsp;<span class="op" id="5497278">(</span><span class="ident" id="5497279">prefix</span>&nbsp;<span class="builtintype" id="5497286">string</span><span class="op" id="5497292">,</span>&nbsp;<span class="ident" id="5497294">complete</span>&nbsp;<span class="builtintype" id="5497303">bool</span><span class="op" id="5497307">,</span>&nbsp;<span class="ident" id="5497309">pc</span>&nbsp;<span class="builtintype" id="5497312">uint32</span><span class="op" id="5497318">)</span>&nbsp;<span class="op" id="5497320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5497323">i</span>&nbsp;<span class="op" id="5497325">:=</span>&nbsp;<span class="op" id="5497328">&amp;</span><span class="ident" id="5497329">p</span><span class="op" id="5497330">.</span><span class="ident" id="5497331">Inst</span><span class="op" id="5497335">[</span><span class="ident" id="5497336">p</span><span class="op" id="5497337">.</span><span class="ident" id="5497338">Start</span><span class="op" id="5497343">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5497346">if</span>&nbsp;<span class="ident" id="5497349">i</span><span class="op" id="5497350">.</span><span class="ident" id="5497351">Op</span>&nbsp;<span class="op" id="5497354">!=</span>&nbsp;<span class="ident" id="5497357">syntax</span><span class="op" id="5497363">.</span><span class="ident" id="5497364">InstEmptyWidth</span>&nbsp;<span class="op" id="5497379">||</span>&nbsp;<span class="op" id="5497382">(</span><span class="ident" id="5497383">syntax</span><span class="op" id="5497389">.</span><span class="ident" id="5497390">EmptyOp</span><span class="op" id="5497397">(</span><span class="ident" id="5497398">i</span><span class="op" id="5497399">.</span><span class="ident" id="5497400">Arg</span><span class="op" id="5497403">)</span><span class="op" id="5497404">)</span><span class="op" id="5497405">&amp;</span><span class="ident" id="5497406">syntax</span><span class="op" id="5497412">.</span><span class="ident" id="5497413">EmptyBeginText</span>&nbsp;<span class="op" id="5497428">==</span>&nbsp;<span class="num" id="5497431">0</span>&nbsp;<span class="op" id="5497433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5497437">return</span>&nbsp;<span class="string" id="5497444">&#34;&#34;</span><span class="op" id="5497446">,</span>&nbsp;<span class="ident" id="5497448">i</span><span class="op" id="5497449">.</span><span class="ident" id="5497450">Op</span>&nbsp;<span class="op" id="5497453">==</span>&nbsp;<span class="ident" id="5497456">syntax</span><span class="op" id="5497462">.</span><span class="ident" id="5497463">InstMatch</span><span class="op" id="5497472">,</span>&nbsp;<span class="builtintype" id="5497474">uint32</span><span class="op" id="5497480">(</span><span class="ident" id="5497481">p</span><span class="op" id="5497482">.</span><span class="ident" id="5497483">Start</span><span class="op" id="5497488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5497491">}</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5497494">pc</span>&nbsp;<span class="op" id="5497497">=</span>&nbsp;<span class="ident" id="5497499">i</span><span class="op" id="5497500">.</span><span class="ident" id="5497501">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5497506">i</span>&nbsp;<span class="op" id="5497508">=</span>&nbsp;<span class="op" id="5497510">&amp;</span><span class="ident" id="5497511">p</span><span class="op" id="5497512">.</span><span class="ident" id="5497513">Inst</span><span class="op" id="5497517">[</span><span class="ident" id="5497518">pc</span><span class="op" id="5497520">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5497523">for</span>&nbsp;<span class="ident" id="5497527">i</span><span class="op" id="5497528">.</span><span class="ident" id="5497529">Op</span>&nbsp;<span class="op" id="5497532">==</span>&nbsp;<span class="ident" id="5497535">syntax</span><span class="op" id="5497541">.</span><span class="ident" id="5497542">InstNop</span>&nbsp;<span class="op" id="5497550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5497554">pc</span>&nbsp;<span class="op" id="5497557">=</span>&nbsp;<span class="ident" id="5497559">i</span><span class="op" id="5497560">.</span><span class="ident" id="5497561">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5497567">i</span>&nbsp;<span class="op" id="5497569">=</span>&nbsp;<span class="op" id="5497571">&amp;</span><span class="ident" id="5497572">p</span><span class="op" id="5497573">.</span><span class="ident" id="5497574">Inst</span><span class="op" id="5497578">[</span><span class="ident" id="5497579">pc</span><span class="op" id="5497581">]</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5497584">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5497587">//&nbsp;Avoid&nbsp;allocation&nbsp;of&nbsp;buffer&nbsp;if&nbsp;prefix&nbsp;is&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5497638">if</span>&nbsp;<span class="ident" id="5497641">iop</span><span class="op" id="5497644">(</span><span class="ident" id="5497645">i</span><span class="op" id="5497646">)</span>&nbsp;<span class="op" id="5497648">!=</span>&nbsp;<span class="ident" id="5497651">syntax</span><span class="op" id="5497657">.</span><span class="ident" id="5497658">InstRune</span>&nbsp;<span class="op" id="5497667">||</span>&nbsp;<span class="builtinfunc" id="5497670">len</span><span class="op" id="5497673">(</span><span class="ident" id="5497674">i</span><span class="op" id="5497675">.</span><span class="ident" id="5497676">Rune</span><span class="op" id="5497680">)</span>&nbsp;<span class="op" id="5497682">!=</span>&nbsp;<span class="num" id="5497685">1</span>&nbsp;<span class="op" id="5497687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5497691">return</span>&nbsp;<span class="string" id="5497698">&#34;&#34;</span><span class="op" id="5497700">,</span>&nbsp;<span class="ident" id="5497702">i</span><span class="op" id="5497703">.</span><span class="ident" id="5497704">Op</span>&nbsp;<span class="op" id="5497707">==</span>&nbsp;<span class="ident" id="5497710">syntax</span><span class="op" id="5497716">.</span><span class="ident" id="5497717">InstMatch</span><span class="op" id="5497726">,</span>&nbsp;<span class="builtintype" id="5497728">uint32</span><span class="op" id="5497734">(</span><span class="ident" id="5497735">p</span><span class="op" id="5497736">.</span><span class="ident" id="5497737">Start</span><span class="op" id="5497742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5497745">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5497749">//&nbsp;Have&nbsp;prefix;&nbsp;gather&nbsp;characters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5497785">var</span>&nbsp;<span class="ident" id="5497789">buf</span>&nbsp;<span class="ident" id="5497793">bytes</span><span class="op" id="5497798">.</span><span class="ident" id="5497799">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5497807">for</span>&nbsp;<span class="ident" id="5497811">iop</span><span class="op" id="5497814">(</span><span class="ident" id="5497815">i</span><span class="op" id="5497816">)</span>&nbsp;<span class="op" id="5497818">==</span>&nbsp;<span class="ident" id="5497821">syntax</span><span class="op" id="5497827">.</span><span class="ident" id="5497828">InstRune</span>&nbsp;<span class="op" id="5497837">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5497840">len</span><span class="op" id="5497843">(</span><span class="ident" id="5497844">i</span><span class="op" id="5497845">.</span><span class="ident" id="5497846">Rune</span><span class="op" id="5497850">)</span>&nbsp;<span class="op" id="5497852">==</span>&nbsp;<span class="num" id="5497855">1</span>&nbsp;<span class="op" id="5497857">&amp;&amp;</span>&nbsp;<span class="ident" id="5497860">syntax</span><span class="op" id="5497866">.</span><span class="ident" id="5497867">Flags</span><span class="op" id="5497872">(</span><span class="ident" id="5497873">i</span><span class="op" id="5497874">.</span><span class="ident" id="5497875">Arg</span><span class="op" id="5497878">)</span><span class="op" id="5497879">&amp;</span><span class="ident" id="5497880">syntax</span><span class="op" id="5497886">.</span><span class="ident" id="5497887">FoldCase</span>&nbsp;<span class="op" id="5497896">==</span>&nbsp;<span class="num" id="5497899">0</span>&nbsp;<span class="op" id="5497901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5497905">buf</span><span class="op" id="5497908">.</span><span class="ident" id="5497909">WriteRune</span><span class="op" id="5497918">(</span><span class="ident" id="5497919">i</span><span class="op" id="5497920">.</span><span class="ident" id="5497921">Rune</span><span class="op" id="5497925">[</span><span class="num" id="5497926">0</span><span class="op" id="5497927">]</span><span class="op" id="5497928">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5497932">pc</span><span class="op" id="5497934">,</span>&nbsp;<span class="ident" id="5497936">i</span>&nbsp;<span class="op" id="5497938">=</span>&nbsp;<span class="ident" id="5497940">i</span><span class="op" id="5497941">.</span><span class="ident" id="5497942">Out</span><span class="op" id="5497945">,</span>&nbsp;<span class="op" id="5497947">&amp;</span><span class="ident" id="5497948">p</span><span class="op" id="5497949">.</span><span class="ident" id="5497950">Inst</span><span class="op" id="5497954">[</span><span class="ident" id="5497955">i</span><span class="op" id="5497956">.</span><span class="ident" id="5497957">Out</span><span class="op" id="5497960">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5497963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5497966">return</span>&nbsp;<span class="ident" id="5497973">buf</span><span class="op" id="5497976">.</span><span class="ident" id="5497977">String</span><span class="op" id="5497983">(</span><span class="op" id="5497984">)</span><span class="op" id="5497985">,</span>&nbsp;<span class="ident" id="5497987">i</span><span class="op" id="5497988">.</span><span class="ident" id="5497989">Op</span>&nbsp;<span class="op" id="5497992">==</span>&nbsp;<span class="ident" id="5497995">syntax</span><span class="op" id="5498001">.</span><span class="ident" id="5498002">InstEmptyWidth</span>&nbsp;<span class="op" id="5498017">&amp;&amp;</span>&nbsp;<span class="op" id="5498020">(</span><span class="ident" id="5498021">syntax</span><span class="op" id="5498027">.</span><span class="ident" id="5498028">EmptyOp</span><span class="op" id="5498035">(</span><span class="ident" id="5498036">i</span><span class="op" id="5498037">.</span><span class="ident" id="5498038">Arg</span><span class="op" id="5498041">)</span><span class="op" id="5498042">)</span><span class="op" id="5498043">&amp;</span><span class="ident" id="5498044">syntax</span><span class="op" id="5498050">.</span><span class="ident" id="5498051">EmptyBeginText</span>&nbsp;<span class="op" id="5498066">!=</span>&nbsp;<span class="num" id="5498069">0</span><span class="op" id="5498070">,</span>&nbsp;<span class="ident" id="5498072">pc</span><br>
<span class="lineno"></span><span class="op" id="5498075">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="5498078">//&nbsp;OnePassNext&nbsp;selects&nbsp;the&nbsp;next&nbsp;actionable&nbsp;state&nbsp;of&nbsp;the&nbsp;prog,&nbsp;based&nbsp;on&nbsp;the&nbsp;input&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="5498170">//&nbsp;It&nbsp;should&nbsp;only&nbsp;be&nbsp;called&nbsp;when&nbsp;i.Op&nbsp;==&nbsp;InstAlt&nbsp;or&nbsp;InstAltMatch,&nbsp;and&nbsp;from&nbsp;the&nbsp;one-pass&nbsp;machine.</span><br>
<span class="lineno"></span><span class="comment" id="5498267">//&nbsp;One&nbsp;of&nbsp;the&nbsp;alternates&nbsp;may&nbsp;ultimately&nbsp;lead&nbsp;without&nbsp;input&nbsp;to&nbsp;end&nbsp;of&nbsp;line.&nbsp;If&nbsp;the&nbsp;instruction</span><br>
<span class="lineno"></span><span class="comment" id="5498361">//&nbsp;is&nbsp;InstAltMatch&nbsp;the&nbsp;path&nbsp;to&nbsp;the&nbsp;InstMatch&nbsp;is&nbsp;in&nbsp;i.Out,&nbsp;the&nbsp;normal&nbsp;node&nbsp;in&nbsp;i.Next.</span><br>
<span class="lineno"></span><span class="keyword" id="5498446">func</span>&nbsp;<span class="ident" id="5498451">onePassNext</span><span class="op" id="5498462">(</span><span class="ident" id="5498463">i</span>&nbsp;<span class="op" id="5498465">*</span><span class="ident" id="5498466">onePassInst</span><span class="op" id="5498477">,</span>&nbsp;<span class="ident" id="5498479">r</span>&nbsp;<span class="builtintype" id="5498481">rune</span><span class="op" id="5498485">)</span>&nbsp;<span class="builtintype" id="5498487">uint32</span>&nbsp;<span class="op" id="5498494">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5498497">next</span>&nbsp;<span class="op" id="5498502">:=</span>&nbsp;<span class="ident" id="5498505">i</span><span class="op" id="5498506">.</span><span class="ident" id="5498507">MatchRunePos</span><span class="op" id="5498519">(</span><span class="ident" id="5498520">r</span><span class="op" id="5498521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5498524">if</span>&nbsp;<span class="ident" id="5498527">next</span>&nbsp;<span class="op" id="5498532">&gt;=</span>&nbsp;<span class="num" id="5498535">0</span>&nbsp;<span class="op" id="5498537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5498541">return</span>&nbsp;<span class="ident" id="5498548">i</span><span class="op" id="5498549">.</span><span class="ident" id="5498550">Next</span><span class="op" id="5498554">[</span><span class="ident" id="5498555">next</span><span class="op" id="5498559">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5498562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5498565">if</span>&nbsp;<span class="ident" id="5498568">i</span><span class="op" id="5498569">.</span><span class="ident" id="5498570">Op</span>&nbsp;<span class="op" id="5498573">==</span>&nbsp;<span class="ident" id="5498576">syntax</span><span class="op" id="5498582">.</span><span class="ident" id="5498583">InstAltMatch</span>&nbsp;<span class="op" id="5498596">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5498600">return</span>&nbsp;<span class="ident" id="5498607">i</span><span class="op" id="5498608">.</span><span class="ident" id="5498609">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5498614">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5498617">return</span>&nbsp;<span class="num" id="5498624">0</span><br>
<span class="lineno"></span><span class="op" id="5498626">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="keyword" id="5498629">func</span>&nbsp;<span class="ident" id="5498634">iop</span><span class="op" id="5498637">(</span><span class="ident" id="5498638">i</span>&nbsp;<span class="op" id="5498640">*</span><span class="ident" id="5498641">syntax</span><span class="op" id="5498647">.</span><span class="ident" id="5498648">Inst</span><span class="op" id="5498652">)</span>&nbsp;<span class="ident" id="5498654">syntax</span><span class="op" id="5498660">.</span><span class="ident" id="5498661">InstOp</span>&nbsp;<span class="op" id="5498668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5498671">op</span>&nbsp;<span class="op" id="5498674">:=</span>&nbsp;<span class="ident" id="5498677">i</span><span class="op" id="5498678">.</span><span class="ident" id="5498679">Op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5498683">switch</span>&nbsp;<span class="ident" id="5498690">op</span>&nbsp;<span class="op" id="5498693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5498696">case</span>&nbsp;<span class="ident" id="5498701">syntax</span><span class="op" id="5498707">.</span><span class="ident" id="5498708">InstRune1</span><span class="op" id="5498717">,</span>&nbsp;<span class="ident" id="5498719">syntax</span><span class="op" id="5498725">.</span><span class="ident" id="5498726">InstRuneAny</span><span class="op" id="5498737">,</span>&nbsp;<span class="ident" id="5498739">syntax</span><span class="op" id="5498745">.</span><span class="ident" id="5498746">InstRuneAnyNotNL</span><span class="op" id="5498762">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5498766">op</span>&nbsp;<span class="op" id="5498769">=</span>&nbsp;<span class="ident" id="5498771">syntax</span><span class="op" id="5498777">.</span><span class="ident" id="5498778">InstRune</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5498788">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5498791">return</span>&nbsp;<span class="ident" id="5498798">op</span><br>
<span class="lineno"></span><span class="op" id="5498801">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5498804">//&nbsp;Sparse&nbsp;Array&nbsp;implementation&nbsp;is&nbsp;used&nbsp;as&nbsp;a&nbsp;queueOnePass.</span><br>
<span class="lineno">90</span><span class="keyword" id="5498862">type</span>&nbsp;<span class="ident" id="5498867">queueOnePass</span>&nbsp;<span class="keyword" id="5498880">struct</span>&nbsp;<span class="op" id="5498887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5498890">sparse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5498906">[</span><span class="op" id="5498907">]</span><span class="builtintype" id="5498908">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5498916">dense</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5498932">[</span><span class="op" id="5498933">]</span><span class="builtintype" id="5498934">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5498942">size</span><span class="op" id="5498946">,</span>&nbsp;<span class="ident" id="5498948">nextIndex</span>&nbsp;<span class="builtintype" id="5498958">uint32</span><br>
<span class="lineno"></span><span class="op" id="5498965">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="keyword" id="5498968">func</span>&nbsp;<span class="op" id="5498973">(</span><span class="ident" id="5498974">q</span>&nbsp;<span class="op" id="5498976">*</span><span class="ident" id="5498977">queueOnePass</span><span class="op" id="5498989">)</span>&nbsp;<span class="ident" id="5498991">empty</span><span class="op" id="5498996">(</span><span class="op" id="5498997">)</span>&nbsp;<span class="builtintype" id="5498999">bool</span>&nbsp;<span class="op" id="5499004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5499007">return</span>&nbsp;<span class="ident" id="5499014">q</span><span class="op" id="5499015">.</span><span class="ident" id="5499016">nextIndex</span>&nbsp;<span class="op" id="5499026">&gt;=</span>&nbsp;<span class="ident" id="5499029">q</span><span class="op" id="5499030">.</span><span class="ident" id="5499031">size</span><br>
<span class="lineno"></span><span class="op" id="5499036">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="5499039">func</span>&nbsp;<span class="op" id="5499044">(</span><span class="ident" id="5499045">q</span>&nbsp;<span class="op" id="5499047">*</span><span class="ident" id="5499048">queueOnePass</span><span class="op" id="5499060">)</span>&nbsp;<span class="ident" id="5499062">next</span><span class="op" id="5499066">(</span><span class="op" id="5499067">)</span>&nbsp;<span class="op" id="5499069">(</span><span class="ident" id="5499070">n</span>&nbsp;<span class="builtintype" id="5499072">uint32</span><span class="op" id="5499078">)</span>&nbsp;<span class="op" id="5499080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5499083">n</span>&nbsp;<span class="op" id="5499085">=</span>&nbsp;<span class="ident" id="5499087">q</span><span class="op" id="5499088">.</span><span class="ident" id="5499089">dense</span><span class="op" id="5499094">[</span><span class="ident" id="5499095">q</span><span class="op" id="5499096">.</span><span class="ident" id="5499097">nextIndex</span><span class="op" id="5499106">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5499109">q</span><span class="op" id="5499110">.</span><span class="ident" id="5499111">nextIndex</span><span class="op" id="5499120">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5499124">return</span><br>
<span class="lineno"></span><span class="op" id="5499131">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="5499134">func</span>&nbsp;<span class="op" id="5499139">(</span><span class="ident" id="5499140">q</span>&nbsp;<span class="op" id="5499142">*</span><span class="ident" id="5499143">queueOnePass</span><span class="op" id="5499155">)</span>&nbsp;<span class="ident" id="5499157">clear</span><span class="op" id="5499162">(</span><span class="op" id="5499163">)</span>&nbsp;<span class="op" id="5499165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5499168">q</span><span class="op" id="5499169">.</span><span class="ident" id="5499170">size</span>&nbsp;<span class="op" id="5499175">=</span>&nbsp;<span class="num" id="5499177">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5499180">q</span><span class="op" id="5499181">.</span><span class="ident" id="5499182">nextIndex</span>&nbsp;<span class="op" id="5499192">=</span>&nbsp;<span class="num" id="5499194">0</span><br>
<span class="lineno"></span><span class="op" id="5499196">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="keyword" id="5499199">func</span>&nbsp;<span class="op" id="5499204">(</span><span class="ident" id="5499205">q</span>&nbsp;<span class="op" id="5499207">*</span><span class="ident" id="5499208">queueOnePass</span><span class="op" id="5499220">)</span>&nbsp;<span class="ident" id="5499222">reset</span><span class="op" id="5499227">(</span><span class="op" id="5499228">)</span>&nbsp;<span class="op" id="5499230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5499233">q</span><span class="op" id="5499234">.</span><span class="ident" id="5499235">nextIndex</span>&nbsp;<span class="op" id="5499245">=</span>&nbsp;<span class="num" id="5499247">0</span><br>
<span class="lineno"></span><span class="op" id="5499249">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="5499252">func</span>&nbsp;<span class="op" id="5499257">(</span><span class="ident" id="5499258">q</span>&nbsp;<span class="op" id="5499260">*</span><span class="ident" id="5499261">queueOnePass</span><span class="op" id="5499273">)</span>&nbsp;<span class="ident" id="5499275">contains</span><span class="op" id="5499283">(</span><span class="ident" id="5499284">u</span>&nbsp;<span class="builtintype" id="5499286">uint32</span><span class="op" id="5499292">)</span>&nbsp;<span class="builtintype" id="5499294">bool</span>&nbsp;<span class="op" id="5499299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5499302">if</span>&nbsp;<span class="ident" id="5499305">u</span>&nbsp;<span class="op" id="5499307">&gt;=</span>&nbsp;<span class="builtintype" id="5499310">uint32</span><span class="op" id="5499316">(</span><span class="builtinfunc" id="5499317">len</span><span class="op" id="5499320">(</span><span class="ident" id="5499321">q</span><span class="op" id="5499322">.</span><span class="ident" id="5499323">sparse</span><span class="op" id="5499329">)</span><span class="op" id="5499330">)</span>&nbsp;<span class="op" id="5499332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5499336">return</span>&nbsp;<span class="builtintype" id="5499343">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5499350">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5499353">return</span>&nbsp;<span class="ident" id="5499360">q</span><span class="op" id="5499361">.</span><span class="ident" id="5499362">sparse</span><span class="op" id="5499368">[</span><span class="ident" id="5499369">u</span><span class="op" id="5499370">]</span>&nbsp;<span class="op" id="5499372">&lt;</span>&nbsp;<span class="ident" id="5499374">q</span><span class="op" id="5499375">.</span><span class="ident" id="5499376">size</span>&nbsp;<span class="op" id="5499381">&amp;&amp;</span>&nbsp;<span class="ident" id="5499384">q</span><span class="op" id="5499385">.</span><span class="ident" id="5499386">dense</span><span class="op" id="5499391">[</span><span class="ident" id="5499392">q</span><span class="op" id="5499393">.</span><span class="ident" id="5499394">sparse</span><span class="op" id="5499400">[</span><span class="ident" id="5499401">u</span><span class="op" id="5499402">]</span><span class="op" id="5499403">]</span>&nbsp;<span class="op" id="5499405">==</span>&nbsp;<span class="ident" id="5499408">u</span><br>
<span class="lineno">120</span><span class="op" id="5499410">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5499413">func</span>&nbsp;<span class="op" id="5499418">(</span><span class="ident" id="5499419">q</span>&nbsp;<span class="op" id="5499421">*</span><span class="ident" id="5499422">queueOnePass</span><span class="op" id="5499434">)</span>&nbsp;<span class="ident" id="5499436">insert</span><span class="op" id="5499442">(</span><span class="ident" id="5499443">u</span>&nbsp;<span class="builtintype" id="5499445">uint32</span><span class="op" id="5499451">)</span>&nbsp;<span class="op" id="5499453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5499456">if</span>&nbsp;<span class="op" id="5499459">!</span><span class="ident" id="5499460">q</span><span class="op" id="5499461">.</span><span class="ident" id="5499462">contains</span><span class="op" id="5499470">(</span><span class="ident" id="5499471">u</span><span class="op" id="5499472">)</span>&nbsp;<span class="op" id="5499474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5499478">q</span><span class="op" id="5499479">.</span><span class="ident" id="5499480">insertNew</span><span class="op" id="5499489">(</span><span class="ident" id="5499490">u</span><span class="op" id="5499491">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5499494">}</span><br>
<span class="lineno"></span><span class="op" id="5499496">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5499499">func</span>&nbsp;<span class="op" id="5499504">(</span><span class="ident" id="5499505">q</span>&nbsp;<span class="op" id="5499507">*</span><span class="ident" id="5499508">queueOnePass</span><span class="op" id="5499520">)</span>&nbsp;<span class="ident" id="5499522">insertNew</span><span class="op" id="5499531">(</span><span class="ident" id="5499532">u</span>&nbsp;<span class="builtintype" id="5499534">uint32</span><span class="op" id="5499540">)</span>&nbsp;<span class="op" id="5499542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5499545">if</span>&nbsp;<span class="ident" id="5499548">u</span>&nbsp;<span class="op" id="5499550">&gt;=</span>&nbsp;<span class="builtintype" id="5499553">uint32</span><span class="op" id="5499559">(</span><span class="builtinfunc" id="5499560">len</span><span class="op" id="5499563">(</span><span class="ident" id="5499564">q</span><span class="op" id="5499565">.</span><span class="ident" id="5499566">sparse</span><span class="op" id="5499572">)</span><span class="op" id="5499573">)</span>&nbsp;<span class="op" id="5499575">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5499579">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5499587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5499590">q</span><span class="op" id="5499591">.</span><span class="ident" id="5499592">sparse</span><span class="op" id="5499598">[</span><span class="ident" id="5499599">u</span><span class="op" id="5499600">]</span>&nbsp;<span class="op" id="5499602">=</span>&nbsp;<span class="ident" id="5499604">q</span><span class="op" id="5499605">.</span><span class="ident" id="5499606">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5499612">q</span><span class="op" id="5499613">.</span><span class="ident" id="5499614">dense</span><span class="op" id="5499619">[</span><span class="ident" id="5499620">q</span><span class="op" id="5499621">.</span><span class="ident" id="5499622">size</span><span class="op" id="5499626">]</span>&nbsp;<span class="op" id="5499628">=</span>&nbsp;<span class="ident" id="5499630">u</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5499633">q</span><span class="op" id="5499634">.</span><span class="ident" id="5499635">size</span><span class="op" id="5499639">++</span><br>
<span class="lineno">135</span><span class="op" id="5499642">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5499645">func</span>&nbsp;<span class="ident" id="5499650">newQueue</span><span class="op" id="5499658">(</span><span class="ident" id="5499659">size</span>&nbsp;<span class="builtintype" id="5499664">int</span><span class="op" id="5499667">)</span>&nbsp;<span class="op" id="5499669">(</span><span class="ident" id="5499670">q</span>&nbsp;<span class="op" id="5499672">*</span><span class="ident" id="5499673">queueOnePass</span><span class="op" id="5499685">)</span>&nbsp;<span class="op" id="5499687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5499690">return</span>&nbsp;<span class="op" id="5499697">&amp;</span><span class="ident" id="5499698">queueOnePass</span><span class="op" id="5499710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5499714">sparse</span><span class="op" id="5499720">:</span>&nbsp;<span class="builtinfunc" id="5499722">make</span><span class="op" id="5499726">(</span><span class="op" id="5499727">[</span><span class="op" id="5499728">]</span><span class="builtintype" id="5499729">uint32</span><span class="op" id="5499735">,</span>&nbsp;<span class="ident" id="5499737">size</span><span class="op" id="5499741">)</span><span class="op" id="5499742">,</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5499746">dense</span><span class="op" id="5499751">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="5499754">make</span><span class="op" id="5499758">(</span><span class="op" id="5499759">[</span><span class="op" id="5499760">]</span><span class="builtintype" id="5499761">uint32</span><span class="op" id="5499767">,</span>&nbsp;<span class="ident" id="5499769">size</span><span class="op" id="5499773">)</span><span class="op" id="5499774">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5499777">}</span><br>
<span class="lineno"></span><span class="op" id="5499779">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5499782">//&nbsp;mergeRuneSets&nbsp;merges&nbsp;two&nbsp;non-intersecting&nbsp;runesets,&nbsp;and&nbsp;returns&nbsp;the&nbsp;merged&nbsp;result,</span><br>
<span class="lineno">145</span><span class="comment" id="5499868">//&nbsp;and&nbsp;a&nbsp;NextIp&nbsp;array.&nbsp;The&nbsp;idea&nbsp;is&nbsp;that&nbsp;if&nbsp;a&nbsp;rune&nbsp;matches&nbsp;the&nbsp;OnePassRunes&nbsp;at&nbsp;index</span><br>
<span class="lineno"></span><span class="comment" id="5499952">//&nbsp;i,&nbsp;NextIp[i/2]&nbsp;is&nbsp;the&nbsp;target.&nbsp;If&nbsp;the&nbsp;input&nbsp;sets&nbsp;intersect,&nbsp;an&nbsp;empty&nbsp;runeset&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5500037">//&nbsp;NextIp&nbsp;array&nbsp;with&nbsp;the&nbsp;single&nbsp;element&nbsp;mergeFailed&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="comment" id="5500102">//&nbsp;The&nbsp;code&nbsp;assumes&nbsp;that&nbsp;both&nbsp;inputs&nbsp;contain&nbsp;ordered&nbsp;and&nbsp;non-intersecting&nbsp;rune&nbsp;pairs.</span><br>
<span class="lineno"></span><span class="keyword" id="5500188">const</span>&nbsp;<span class="ident" id="5500194">mergeFailed</span>&nbsp;<span class="op" id="5500206">=</span>&nbsp;<span class="builtintype" id="5500208">uint32</span><span class="op" id="5500214">(</span><span class="num" id="5500215">0xffffffff</span><span class="op" id="5500225">)</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span><span class="keyword" id="5500228">var</span>&nbsp;<span class="op" id="5500232">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5500235">noRune</span>&nbsp;<span class="op" id="5500242">=</span>&nbsp;<span class="op" id="5500244">[</span><span class="op" id="5500245">]</span><span class="builtintype" id="5500246">rune</span><span class="op" id="5500250">{</span><span class="op" id="5500251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5500254">noNext</span>&nbsp;<span class="op" id="5500261">=</span>&nbsp;<span class="op" id="5500263">[</span><span class="op" id="5500264">]</span><span class="builtintype" id="5500265">uint32</span><span class="op" id="5500271">{</span><span class="ident" id="5500272">mergeFailed</span><span class="op" id="5500283">}</span><br>
<span class="lineno"></span><span class="op" id="5500285">)</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="keyword" id="5500288">func</span>&nbsp;<span class="ident" id="5500293">mergeRuneSets</span><span class="op" id="5500306">(</span><span class="ident" id="5500307">leftRunes</span><span class="op" id="5500316">,</span>&nbsp;<span class="ident" id="5500318">rightRunes</span>&nbsp;<span class="op" id="5500329">*</span><span class="op" id="5500330">[</span><span class="op" id="5500331">]</span><span class="builtintype" id="5500332">rune</span><span class="op" id="5500336">,</span>&nbsp;<span class="ident" id="5500338">leftPC</span><span class="op" id="5500344">,</span>&nbsp;<span class="ident" id="5500346">rightPC</span>&nbsp;<span class="builtintype" id="5500354">uint32</span><span class="op" id="5500360">)</span>&nbsp;<span class="op" id="5500362">(</span><span class="op" id="5500363">[</span><span class="op" id="5500364">]</span><span class="builtintype" id="5500365">rune</span><span class="op" id="5500369">,</span>&nbsp;<span class="op" id="5500371">[</span><span class="op" id="5500372">]</span><span class="builtintype" id="5500373">uint32</span><span class="op" id="5500379">)</span>&nbsp;<span class="op" id="5500381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5500384">leftLen</span>&nbsp;<span class="op" id="5500392">:=</span>&nbsp;<span class="builtinfunc" id="5500395">len</span><span class="op" id="5500398">(</span><span class="op" id="5500399">*</span><span class="ident" id="5500400">leftRunes</span><span class="op" id="5500409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5500412">rightLen</span>&nbsp;<span class="op" id="5500421">:=</span>&nbsp;<span class="builtinfunc" id="5500424">len</span><span class="op" id="5500427">(</span><span class="op" id="5500428">*</span><span class="ident" id="5500429">rightRunes</span><span class="op" id="5500439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5500442">if</span>&nbsp;<span class="ident" id="5500445">leftLen</span><span class="op" id="5500452">&amp;</span><span class="num" id="5500453">0x1</span>&nbsp;<span class="op" id="5500457">!=</span>&nbsp;<span class="num" id="5500460">0</span>&nbsp;<span class="op" id="5500462">||</span>&nbsp;<span class="ident" id="5500465">rightLen</span><span class="op" id="5500473">&amp;</span><span class="num" id="5500474">0x1</span>&nbsp;<span class="op" id="5500478">!=</span>&nbsp;<span class="num" id="5500481">0</span>&nbsp;<span class="op" id="5500483">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5500487">panic</span><span class="op" id="5500492">(</span><span class="string" id="5500493">&#34;mergeRuneSets&nbsp;odd&nbsp;length&nbsp;[]rune&#34;</span><span class="op" id="5500526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5500529">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5500532">var</span>&nbsp;<span class="op" id="5500536">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5500540">lx</span><span class="op" id="5500542">,</span>&nbsp;<span class="ident" id="5500544">rx</span>&nbsp;<span class="builtintype" id="5500547">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5500552">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5500555">merged</span>&nbsp;<span class="op" id="5500562">:=</span>&nbsp;<span class="builtinfunc" id="5500565">make</span><span class="op" id="5500569">(</span><span class="op" id="5500570">[</span><span class="op" id="5500571">]</span><span class="builtintype" id="5500572">rune</span><span class="op" id="5500576">,</span>&nbsp;<span class="num" id="5500578">0</span><span class="op" id="5500579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5500582">next</span>&nbsp;<span class="op" id="5500587">:=</span>&nbsp;<span class="builtinfunc" id="5500590">make</span><span class="op" id="5500594">(</span><span class="op" id="5500595">[</span><span class="op" id="5500596">]</span><span class="builtintype" id="5500597">uint32</span><span class="op" id="5500603">,</span>&nbsp;<span class="num" id="5500605">0</span><span class="op" id="5500606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5500609">ok</span>&nbsp;<span class="op" id="5500612">:=</span>&nbsp;<span class="builtintype" id="5500615">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5500621">defer</span>&nbsp;<span class="keyword" id="5500627">func</span><span class="op" id="5500631">(</span><span class="op" id="5500632">)</span>&nbsp;<span class="op" id="5500634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5500638">if</span>&nbsp;<span class="op" id="5500641">!</span><span class="ident" id="5500642">ok</span>&nbsp;<span class="op" id="5500645">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5500650">merged</span>&nbsp;<span class="op" id="5500657">=</span>&nbsp;<span class="ident" id="5500659">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5500666">next</span>&nbsp;<span class="op" id="5500671">=</span>&nbsp;<span class="ident" id="5500673">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5500679">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5500682">}</span><span class="op" id="5500683">(</span><span class="op" id="5500684">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5500688">ix</span>&nbsp;<span class="op" id="5500691">:=</span>&nbsp;<span class="op" id="5500694">-</span><span class="num" id="5500695">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5500698">extend</span>&nbsp;<span class="op" id="5500705">:=</span>&nbsp;<span class="keyword" id="5500708">func</span><span class="op" id="5500712">(</span><span class="ident" id="5500713">newLow</span>&nbsp;<span class="op" id="5500720">*</span><span class="builtintype" id="5500721">int</span><span class="op" id="5500724">,</span>&nbsp;<span class="ident" id="5500726">newArray</span>&nbsp;<span class="op" id="5500735">*</span><span class="op" id="5500736">[</span><span class="op" id="5500737">]</span><span class="builtintype" id="5500738">rune</span><span class="op" id="5500742">,</span>&nbsp;<span class="ident" id="5500744">pc</span>&nbsp;<span class="builtintype" id="5500747">uint32</span><span class="op" id="5500753">)</span>&nbsp;<span class="builtintype" id="5500755">bool</span>&nbsp;<span class="op" id="5500760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5500764">if</span>&nbsp;<span class="ident" id="5500767">ix</span>&nbsp;<span class="op" id="5500770">&gt;</span>&nbsp;<span class="num" id="5500772">0</span>&nbsp;<span class="op" id="5500774">&amp;&amp;</span>&nbsp;<span class="op" id="5500777">(</span><span class="op" id="5500778">*</span><span class="ident" id="5500779">newArray</span><span class="op" id="5500787">)</span><span class="op" id="5500788">[</span><span class="op" id="5500789">*</span><span class="ident" id="5500790">newLow</span><span class="op" id="5500796">]</span>&nbsp;<span class="op" id="5500798">&lt;=</span>&nbsp;<span class="ident" id="5500801">merged</span><span class="op" id="5500807">[</span><span class="ident" id="5500808">ix</span><span class="op" id="5500810">]</span>&nbsp;<span class="op" id="5500812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5500817">return</span>&nbsp;<span class="builtintype" id="5500824">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5500832">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5500836">merged</span>&nbsp;<span class="op" id="5500843">=</span>&nbsp;<span class="builtinfunc" id="5500845">append</span><span class="op" id="5500851">(</span><span class="ident" id="5500852">merged</span><span class="op" id="5500858">,</span>&nbsp;<span class="op" id="5500860">(</span><span class="op" id="5500861">*</span><span class="ident" id="5500862">newArray</span><span class="op" id="5500870">)</span><span class="op" id="5500871">[</span><span class="op" id="5500872">*</span><span class="ident" id="5500873">newLow</span><span class="op" id="5500879">]</span><span class="op" id="5500880">,</span>&nbsp;<span class="op" id="5500882">(</span><span class="op" id="5500883">*</span><span class="ident" id="5500884">newArray</span><span class="op" id="5500892">)</span><span class="op" id="5500893">[</span><span class="op" id="5500894">*</span><span class="ident" id="5500895">newLow</span><span class="op" id="5500901">+</span><span class="num" id="5500902">1</span><span class="op" id="5500903">]</span><span class="op" id="5500904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5500908">*</span><span class="ident" id="5500909">newLow</span>&nbsp;<span class="op" id="5500916">+=</span>&nbsp;<span class="num" id="5500919">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5500923">ix</span>&nbsp;<span class="op" id="5500926">+=</span>&nbsp;<span class="num" id="5500929">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5500933">next</span>&nbsp;<span class="op" id="5500938">=</span>&nbsp;<span class="builtinfunc" id="5500940">append</span><span class="op" id="5500946">(</span><span class="ident" id="5500947">next</span><span class="op" id="5500951">,</span>&nbsp;<span class="ident" id="5500953">pc</span><span class="op" id="5500955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5500959">return</span>&nbsp;<span class="builtintype" id="5500966">true</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5500972">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5500976">for</span>&nbsp;<span class="ident" id="5500980">lx</span>&nbsp;<span class="op" id="5500983">&lt;</span>&nbsp;<span class="ident" id="5500985">leftLen</span>&nbsp;<span class="op" id="5500993">||</span>&nbsp;<span class="ident" id="5500996">rx</span>&nbsp;<span class="op" id="5500999">&lt;</span>&nbsp;<span class="ident" id="5501001">rightLen</span>&nbsp;<span class="op" id="5501010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5501014">switch</span>&nbsp;<span class="op" id="5501021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5501025">case</span>&nbsp;<span class="ident" id="5501030">rx</span>&nbsp;<span class="op" id="5501033">&gt;=</span>&nbsp;<span class="ident" id="5501036">rightLen</span><span class="op" id="5501044">:</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5501049">ok</span>&nbsp;<span class="op" id="5501052">=</span>&nbsp;<span class="ident" id="5501054">extend</span><span class="op" id="5501060">(</span><span class="op" id="5501061">&amp;</span><span class="ident" id="5501062">lx</span><span class="op" id="5501064">,</span>&nbsp;<span class="ident" id="5501066">leftRunes</span><span class="op" id="5501075">,</span>&nbsp;<span class="ident" id="5501077">leftPC</span><span class="op" id="5501083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5501087">case</span>&nbsp;<span class="ident" id="5501092">lx</span>&nbsp;<span class="op" id="5501095">&gt;=</span>&nbsp;<span class="ident" id="5501098">leftLen</span><span class="op" id="5501105">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5501110">ok</span>&nbsp;<span class="op" id="5501113">=</span>&nbsp;<span class="ident" id="5501115">extend</span><span class="op" id="5501121">(</span><span class="op" id="5501122">&amp;</span><span class="ident" id="5501123">rx</span><span class="op" id="5501125">,</span>&nbsp;<span class="ident" id="5501127">rightRunes</span><span class="op" id="5501137">,</span>&nbsp;<span class="ident" id="5501139">rightPC</span><span class="op" id="5501146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5501150">case</span>&nbsp;<span class="op" id="5501155">(</span><span class="op" id="5501156">*</span><span class="ident" id="5501157">rightRunes</span><span class="op" id="5501167">)</span><span class="op" id="5501168">[</span><span class="ident" id="5501169">rx</span><span class="op" id="5501171">]</span>&nbsp;<span class="op" id="5501173">&lt;</span>&nbsp;<span class="op" id="5501175">(</span><span class="op" id="5501176">*</span><span class="ident" id="5501177">leftRunes</span><span class="op" id="5501186">)</span><span class="op" id="5501187">[</span><span class="ident" id="5501188">lx</span><span class="op" id="5501190">]</span><span class="op" id="5501191">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5501196">ok</span>&nbsp;<span class="op" id="5501199">=</span>&nbsp;<span class="ident" id="5501201">extend</span><span class="op" id="5501207">(</span><span class="op" id="5501208">&amp;</span><span class="ident" id="5501209">rx</span><span class="op" id="5501211">,</span>&nbsp;<span class="ident" id="5501213">rightRunes</span><span class="op" id="5501223">,</span>&nbsp;<span class="ident" id="5501225">rightPC</span><span class="op" id="5501232">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5501236">default</span><span class="op" id="5501243">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5501248">ok</span>&nbsp;<span class="op" id="5501251">=</span>&nbsp;<span class="ident" id="5501253">extend</span><span class="op" id="5501259">(</span><span class="op" id="5501260">&amp;</span><span class="ident" id="5501261">lx</span><span class="op" id="5501263">,</span>&nbsp;<span class="ident" id="5501265">leftRunes</span><span class="op" id="5501274">,</span>&nbsp;<span class="ident" id="5501276">leftPC</span><span class="op" id="5501282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5501286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5501290">if</span>&nbsp;<span class="op" id="5501293">!</span><span class="ident" id="5501294">ok</span>&nbsp;<span class="op" id="5501297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5501302">return</span>&nbsp;<span class="ident" id="5501309">noRune</span><span class="op" id="5501315">,</span>&nbsp;<span class="ident" id="5501317">noNext</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5501326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5501329">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5501332">return</span>&nbsp;<span class="ident" id="5501339">merged</span><span class="op" id="5501345">,</span>&nbsp;<span class="ident" id="5501347">next</span><br>
<span class="lineno"></span><span class="op" id="5501352">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span><span class="comment" id="5501355">//&nbsp;cleanupOnePass&nbsp;drops&nbsp;working&nbsp;memory,&nbsp;and&nbsp;restores&nbsp;certain&nbsp;shortcut&nbsp;instructions.</span><br>
<span class="lineno"></span><span class="keyword" id="5501439">func</span>&nbsp;<span class="ident" id="5501444">cleanupOnePass</span><span class="op" id="5501458">(</span><span class="ident" id="5501459">prog</span>&nbsp;<span class="op" id="5501464">*</span><span class="ident" id="5501465">onePassProg</span><span class="op" id="5501476">,</span>&nbsp;<span class="ident" id="5501478">original</span>&nbsp;<span class="op" id="5501487">*</span><span class="ident" id="5501488">syntax</span><span class="op" id="5501494">.</span><span class="ident" id="5501495">Prog</span><span class="op" id="5501499">)</span>&nbsp;<span class="op" id="5501501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5501504">for</span>&nbsp;<span class="ident" id="5501508">ix</span><span class="op" id="5501510">,</span>&nbsp;<span class="ident" id="5501512">instOriginal</span>&nbsp;<span class="op" id="5501525">:=</span>&nbsp;<span class="keyword" id="5501528">range</span>&nbsp;<span class="ident" id="5501534">original</span><span class="op" id="5501542">.</span><span class="ident" id="5501543">Inst</span>&nbsp;<span class="op" id="5501548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5501552">switch</span>&nbsp;<span class="ident" id="5501559">instOriginal</span><span class="op" id="5501571">.</span><span class="ident" id="5501572">Op</span>&nbsp;<span class="op" id="5501575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5501579">case</span>&nbsp;<span class="ident" id="5501584">syntax</span><span class="op" id="5501590">.</span><span class="ident" id="5501591">InstAlt</span><span class="op" id="5501598">,</span>&nbsp;<span class="ident" id="5501600">syntax</span><span class="op" id="5501606">.</span><span class="ident" id="5501607">InstAltMatch</span><span class="op" id="5501619">,</span>&nbsp;<span class="ident" id="5501621">syntax</span><span class="op" id="5501627">.</span><span class="ident" id="5501628">InstRune</span><span class="op" id="5501636">:</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5501640">case</span>&nbsp;<span class="ident" id="5501645">syntax</span><span class="op" id="5501651">.</span><span class="ident" id="5501652">InstCapture</span><span class="op" id="5501663">,</span>&nbsp;<span class="ident" id="5501665">syntax</span><span class="op" id="5501671">.</span><span class="ident" id="5501672">InstEmptyWidth</span><span class="op" id="5501686">,</span>&nbsp;<span class="ident" id="5501688">syntax</span><span class="op" id="5501694">.</span><span class="ident" id="5501695">InstNop</span><span class="op" id="5501702">,</span>&nbsp;<span class="ident" id="5501704">syntax</span><span class="op" id="5501710">.</span><span class="ident" id="5501711">InstMatch</span><span class="op" id="5501720">,</span>&nbsp;<span class="ident" id="5501722">syntax</span><span class="op" id="5501728">.</span><span class="ident" id="5501729">InstFail</span><span class="op" id="5501737">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5501742">prog</span><span class="op" id="5501746">.</span><span class="ident" id="5501747">Inst</span><span class="op" id="5501751">[</span><span class="ident" id="5501752">ix</span><span class="op" id="5501754">]</span><span class="op" id="5501755">.</span><span class="ident" id="5501756">Next</span>&nbsp;<span class="op" id="5501761">=</span>&nbsp;<span class="ident" id="5501763">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5501769">case</span>&nbsp;<span class="ident" id="5501774">syntax</span><span class="op" id="5501780">.</span><span class="ident" id="5501781">InstRune1</span><span class="op" id="5501790">,</span>&nbsp;<span class="ident" id="5501792">syntax</span><span class="op" id="5501798">.</span><span class="ident" id="5501799">InstRuneAny</span><span class="op" id="5501810">,</span>&nbsp;<span class="ident" id="5501812">syntax</span><span class="op" id="5501818">.</span><span class="ident" id="5501819">InstRuneAnyNotNL</span><span class="op" id="5501835">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5501840">prog</span><span class="op" id="5501844">.</span><span class="ident" id="5501845">Inst</span><span class="op" id="5501849">[</span><span class="ident" id="5501850">ix</span><span class="op" id="5501852">]</span><span class="op" id="5501853">.</span><span class="ident" id="5501854">Next</span>&nbsp;<span class="op" id="5501859">=</span>&nbsp;<span class="ident" id="5501861">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5501868">prog</span><span class="op" id="5501872">.</span><span class="ident" id="5501873">Inst</span><span class="op" id="5501877">[</span><span class="ident" id="5501878">ix</span><span class="op" id="5501880">]</span>&nbsp;<span class="op" id="5501882">=</span>&nbsp;<span class="ident" id="5501884">onePassInst</span><span class="op" id="5501895">{</span><span class="ident" id="5501896">Inst</span><span class="op" id="5501900">:</span>&nbsp;<span class="ident" id="5501902">instOriginal</span><span class="op" id="5501914">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5501918">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5501921">}</span><br>
<span class="lineno"></span><span class="op" id="5501923">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5501926">//&nbsp;onePassCopy&nbsp;creates&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;original&nbsp;Prog,&nbsp;as&nbsp;we&#39;ll&nbsp;be&nbsp;modifying&nbsp;it</span><br>
<span class="lineno">220</span><span class="keyword" id="5502003">func</span>&nbsp;<span class="ident" id="5502008">onePassCopy</span><span class="op" id="5502019">(</span><span class="ident" id="5502020">prog</span>&nbsp;<span class="op" id="5502025">*</span><span class="ident" id="5502026">syntax</span><span class="op" id="5502032">.</span><span class="ident" id="5502033">Prog</span><span class="op" id="5502037">)</span>&nbsp;<span class="op" id="5502039">*</span><span class="ident" id="5502040">onePassProg</span>&nbsp;<span class="op" id="5502052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5502055">p</span>&nbsp;<span class="op" id="5502057">:=</span>&nbsp;<span class="op" id="5502060">&amp;</span><span class="ident" id="5502061">onePassProg</span><span class="op" id="5502072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5502076">Start</span><span class="op" id="5502081">:</span>&nbsp;&nbsp;<span class="ident" id="5502084">prog</span><span class="op" id="5502088">.</span><span class="ident" id="5502089">Start</span><span class="op" id="5502094">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5502098">NumCap</span><span class="op" id="5502104">:</span>&nbsp;<span class="ident" id="5502106">prog</span><span class="op" id="5502110">.</span><span class="ident" id="5502111">NumCap</span><span class="op" id="5502117">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5502120">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5502123">for</span>&nbsp;<span class="ident" id="5502127">_</span><span class="op" id="5502128">,</span>&nbsp;<span class="ident" id="5502130">inst</span>&nbsp;<span class="op" id="5502135">:=</span>&nbsp;<span class="keyword" id="5502138">range</span>&nbsp;<span class="ident" id="5502144">prog</span><span class="op" id="5502148">.</span><span class="ident" id="5502149">Inst</span>&nbsp;<span class="op" id="5502154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5502158">p</span><span class="op" id="5502159">.</span><span class="ident" id="5502160">Inst</span>&nbsp;<span class="op" id="5502165">=</span>&nbsp;<span class="builtinfunc" id="5502167">append</span><span class="op" id="5502173">(</span><span class="ident" id="5502174">p</span><span class="op" id="5502175">.</span><span class="ident" id="5502176">Inst</span><span class="op" id="5502180">,</span>&nbsp;<span class="ident" id="5502182">onePassInst</span><span class="op" id="5502193">{</span><span class="ident" id="5502194">Inst</span><span class="op" id="5502198">:</span>&nbsp;<span class="ident" id="5502200">inst</span><span class="op" id="5502204">}</span><span class="op" id="5502205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5502208">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5502212">//&nbsp;rewrites&nbsp;one&nbsp;or&nbsp;more&nbsp;common&nbsp;Prog&nbsp;constructs&nbsp;that&nbsp;enable&nbsp;some&nbsp;otherwise</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5502287">//&nbsp;non-onepass&nbsp;Progs&nbsp;to&nbsp;be&nbsp;onepass.&nbsp;A:BD&nbsp;(for&nbsp;example)&nbsp;means&nbsp;an&nbsp;InstAlt&nbsp;at</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5502363">//&nbsp;ip&nbsp;A,&nbsp;that&nbsp;points&nbsp;to&nbsp;ips&nbsp;B&nbsp;&amp;&nbsp;C.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5502399">//&nbsp;A:BC&nbsp;+&nbsp;B:DA&nbsp;=&gt;&nbsp;A:BC&nbsp;+&nbsp;B:CD</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5502430">//&nbsp;A:BC&nbsp;+&nbsp;B:DC&nbsp;=&gt;&nbsp;A:DC&nbsp;+&nbsp;B:DC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5502461">for</span>&nbsp;<span class="ident" id="5502465">pc</span>&nbsp;<span class="op" id="5502468">:=</span>&nbsp;<span class="keyword" id="5502471">range</span>&nbsp;<span class="ident" id="5502477">p</span><span class="op" id="5502478">.</span><span class="ident" id="5502479">Inst</span>&nbsp;<span class="op" id="5502484">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5502488">switch</span>&nbsp;<span class="ident" id="5502495">p</span><span class="op" id="5502496">.</span><span class="ident" id="5502497">Inst</span><span class="op" id="5502501">[</span><span class="ident" id="5502502">pc</span><span class="op" id="5502504">]</span><span class="op" id="5502505">.</span><span class="ident" id="5502506">Op</span>&nbsp;<span class="op" id="5502509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5502513">default</span><span class="op" id="5502520">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5502525">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5502536">case</span>&nbsp;<span class="ident" id="5502541">syntax</span><span class="op" id="5502547">.</span><span class="ident" id="5502548">InstAlt</span><span class="op" id="5502555">,</span>&nbsp;<span class="ident" id="5502557">syntax</span><span class="op" id="5502563">.</span><span class="ident" id="5502564">InstAltMatch</span><span class="op" id="5502576">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5502581">//&nbsp;A:Bx&nbsp;+&nbsp;B:Ay</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5502599">p_A_Other</span>&nbsp;<span class="op" id="5502609">:=</span>&nbsp;<span class="op" id="5502612">&amp;</span><span class="ident" id="5502613">p</span><span class="op" id="5502614">.</span><span class="ident" id="5502615">Inst</span><span class="op" id="5502619">[</span><span class="ident" id="5502620">pc</span><span class="op" id="5502622">]</span><span class="op" id="5502623">.</span><span class="ident" id="5502624">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5502631">p_A_Alt</span>&nbsp;<span class="op" id="5502639">:=</span>&nbsp;<span class="op" id="5502642">&amp;</span><span class="ident" id="5502643">p</span><span class="op" id="5502644">.</span><span class="ident" id="5502645">Inst</span><span class="op" id="5502649">[</span><span class="ident" id="5502650">pc</span><span class="op" id="5502652">]</span><span class="op" id="5502653">.</span><span class="ident" id="5502654">Arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5502661">//&nbsp;make&nbsp;sure&nbsp;a&nbsp;target&nbsp;is&nbsp;another&nbsp;Alt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5502701">instAlt</span>&nbsp;<span class="op" id="5502709">:=</span>&nbsp;<span class="ident" id="5502712">p</span><span class="op" id="5502713">.</span><span class="ident" id="5502714">Inst</span><span class="op" id="5502718">[</span><span class="op" id="5502719">*</span><span class="ident" id="5502720">p_A_Alt</span><span class="op" id="5502727">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5502732">if</span>&nbsp;<span class="op" id="5502735">!</span><span class="op" id="5502736">(</span><span class="ident" id="5502737">instAlt</span><span class="op" id="5502744">.</span><span class="ident" id="5502745">Op</span>&nbsp;<span class="op" id="5502748">==</span>&nbsp;<span class="ident" id="5502751">syntax</span><span class="op" id="5502757">.</span><span class="ident" id="5502758">InstAlt</span>&nbsp;<span class="op" id="5502766">||</span>&nbsp;<span class="ident" id="5502769">instAlt</span><span class="op" id="5502776">.</span><span class="ident" id="5502777">Op</span>&nbsp;<span class="op" id="5502780">==</span>&nbsp;<span class="ident" id="5502783">syntax</span><span class="op" id="5502789">.</span><span class="ident" id="5502790">InstAltMatch</span><span class="op" id="5502802">)</span>&nbsp;<span class="op" id="5502804">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5502810">p_A_Alt</span><span class="op" id="5502817">,</span>&nbsp;<span class="ident" id="5502819">p_A_Other</span>&nbsp;<span class="op" id="5502829">=</span>&nbsp;<span class="ident" id="5502831">p_A_Other</span><span class="op" id="5502840">,</span>&nbsp;<span class="ident" id="5502842">p_A_Alt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5502854">instAlt</span>&nbsp;<span class="op" id="5502862">=</span>&nbsp;<span class="ident" id="5502864">p</span><span class="op" id="5502865">.</span><span class="ident" id="5502866">Inst</span><span class="op" id="5502870">[</span><span class="op" id="5502871">*</span><span class="ident" id="5502872">p_A_Alt</span><span class="op" id="5502879">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5502885">if</span>&nbsp;<span class="op" id="5502888">!</span><span class="op" id="5502889">(</span><span class="ident" id="5502890">instAlt</span><span class="op" id="5502897">.</span><span class="ident" id="5502898">Op</span>&nbsp;<span class="op" id="5502901">==</span>&nbsp;<span class="ident" id="5502904">syntax</span><span class="op" id="5502910">.</span><span class="ident" id="5502911">InstAlt</span>&nbsp;<span class="op" id="5502919">||</span>&nbsp;<span class="ident" id="5502922">instAlt</span><span class="op" id="5502929">.</span><span class="ident" id="5502930">Op</span>&nbsp;<span class="op" id="5502933">==</span>&nbsp;<span class="ident" id="5502936">syntax</span><span class="op" id="5502942">.</span><span class="ident" id="5502943">InstAltMatch</span><span class="op" id="5502955">)</span>&nbsp;<span class="op" id="5502957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5502964">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5502977">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5502982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5502987">instOther</span>&nbsp;<span class="op" id="5502997">:=</span>&nbsp;<span class="ident" id="5503000">p</span><span class="op" id="5503001">.</span><span class="ident" id="5503002">Inst</span><span class="op" id="5503006">[</span><span class="op" id="5503007">*</span><span class="ident" id="5503008">p_A_Other</span><span class="op" id="5503017">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5503022">//&nbsp;Analyzing&nbsp;both&nbsp;legs&nbsp;pointing&nbsp;to&nbsp;Alts&nbsp;is&nbsp;for&nbsp;another&nbsp;day</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5503084">if</span>&nbsp;<span class="ident" id="5503087">instOther</span><span class="op" id="5503096">.</span><span class="ident" id="5503097">Op</span>&nbsp;<span class="op" id="5503100">==</span>&nbsp;<span class="ident" id="5503103">syntax</span><span class="op" id="5503109">.</span><span class="ident" id="5503110">InstAlt</span>&nbsp;<span class="op" id="5503118">||</span>&nbsp;<span class="ident" id="5503121">instOther</span><span class="op" id="5503130">.</span><span class="ident" id="5503131">Op</span>&nbsp;<span class="op" id="5503134">==</span>&nbsp;<span class="ident" id="5503137">syntax</span><span class="op" id="5503143">.</span><span class="ident" id="5503144">InstAltMatch</span>&nbsp;<span class="op" id="5503157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5503163">//&nbsp;too&nbsp;complicated</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5503186">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5503198">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5503203">//&nbsp;simple&nbsp;empty&nbsp;transition&nbsp;loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5503238">//&nbsp;A:BC&nbsp;+&nbsp;B:DA&nbsp;=&gt;&nbsp;A:BC&nbsp;+&nbsp;B:DC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503271">p_B_Alt</span>&nbsp;<span class="op" id="5503279">:=</span>&nbsp;<span class="op" id="5503282">&amp;</span><span class="ident" id="5503283">p</span><span class="op" id="5503284">.</span><span class="ident" id="5503285">Inst</span><span class="op" id="5503289">[</span><span class="op" id="5503290">*</span><span class="ident" id="5503291">p_A_Alt</span><span class="op" id="5503298">]</span><span class="op" id="5503299">.</span><span class="ident" id="5503300">Out</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503307">p_B_Other</span>&nbsp;<span class="op" id="5503317">:=</span>&nbsp;<span class="op" id="5503320">&amp;</span><span class="ident" id="5503321">p</span><span class="op" id="5503322">.</span><span class="ident" id="5503323">Inst</span><span class="op" id="5503327">[</span><span class="op" id="5503328">*</span><span class="ident" id="5503329">p_A_Alt</span><span class="op" id="5503336">]</span><span class="op" id="5503337">.</span><span class="ident" id="5503338">Arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503345">patch</span>&nbsp;<span class="op" id="5503351">:=</span>&nbsp;<span class="builtintype" id="5503354">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5503363">if</span>&nbsp;<span class="ident" id="5503366">instAlt</span><span class="op" id="5503373">.</span><span class="ident" id="5503374">Out</span>&nbsp;<span class="op" id="5503378">==</span>&nbsp;<span class="builtintype" id="5503381">uint32</span><span class="op" id="5503387">(</span><span class="ident" id="5503388">pc</span><span class="op" id="5503390">)</span>&nbsp;<span class="op" id="5503392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503398">patch</span>&nbsp;<span class="op" id="5503404">=</span>&nbsp;<span class="builtintype" id="5503406">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5503414">}</span>&nbsp;<span class="keyword" id="5503416">else</span>&nbsp;<span class="keyword" id="5503421">if</span>&nbsp;<span class="ident" id="5503424">instAlt</span><span class="op" id="5503431">.</span><span class="ident" id="5503432">Arg</span>&nbsp;<span class="op" id="5503436">==</span>&nbsp;<span class="builtintype" id="5503439">uint32</span><span class="op" id="5503445">(</span><span class="ident" id="5503446">pc</span><span class="op" id="5503448">)</span>&nbsp;<span class="op" id="5503450">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503456">patch</span>&nbsp;<span class="op" id="5503462">=</span>&nbsp;<span class="builtintype" id="5503464">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503473">p_B_Alt</span><span class="op" id="5503480">,</span>&nbsp;<span class="ident" id="5503482">p_B_Other</span>&nbsp;<span class="op" id="5503492">=</span>&nbsp;<span class="ident" id="5503494">p_B_Other</span><span class="op" id="5503503">,</span>&nbsp;<span class="ident" id="5503505">p_B_Alt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5503516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5503521">if</span>&nbsp;<span class="ident" id="5503524">patch</span>&nbsp;<span class="op" id="5503530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5503536">*</span><span class="ident" id="5503537">p_B_Alt</span>&nbsp;<span class="op" id="5503545">=</span>&nbsp;<span class="op" id="5503547">*</span><span class="ident" id="5503548">p_A_Other</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5503561">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5503567">//&nbsp;empty&nbsp;transition&nbsp;to&nbsp;common&nbsp;target</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5503607">//&nbsp;A:BC&nbsp;+&nbsp;B:DC&nbsp;=&gt;&nbsp;A:DC&nbsp;+&nbsp;B:DC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5503640">if</span>&nbsp;<span class="op" id="5503643">*</span><span class="ident" id="5503644">p_A_Other</span>&nbsp;<span class="op" id="5503654">==</span>&nbsp;<span class="op" id="5503657">*</span><span class="ident" id="5503658">p_B_Alt</span>&nbsp;<span class="op" id="5503666">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5503672">*</span><span class="ident" id="5503673">p_A_Alt</span>&nbsp;<span class="op" id="5503681">=</span>&nbsp;<span class="op" id="5503683">*</span><span class="ident" id="5503684">p_B_Other</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5503697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5503701">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5503704">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5503707">return</span>&nbsp;<span class="ident" id="5503714">p</span><br>
<span class="lineno">280</span><span class="op" id="5503716">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5503719">//&nbsp;runeSlice&nbsp;exists&nbsp;to&nbsp;permit&nbsp;sorting&nbsp;the&nbsp;case-folded&nbsp;rune&nbsp;sets.</span><br>
<span class="lineno"></span><span class="keyword" id="5503784">type</span>&nbsp;<span class="ident" id="5503789">runeSlice</span>&nbsp;<span class="op" id="5503799">[</span><span class="op" id="5503800">]</span><span class="builtintype" id="5503801">rune</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="5503807">func</span>&nbsp;<span class="op" id="5503812">(</span><span class="ident" id="5503813">p</span>&nbsp;<span class="ident" id="5503815">runeSlice</span><span class="op" id="5503824">)</span>&nbsp;<span class="ident" id="5503826">Len</span><span class="op" id="5503829">(</span><span class="op" id="5503830">)</span>&nbsp;<span class="builtintype" id="5503832">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5503846">{</span>&nbsp;<span class="keyword" id="5503848">return</span>&nbsp;<span class="builtinfunc" id="5503855">len</span><span class="op" id="5503858">(</span><span class="ident" id="5503859">p</span><span class="op" id="5503860">)</span>&nbsp;<span class="op" id="5503862">}</span><br>
<span class="lineno"></span><span class="keyword" id="5503864">func</span>&nbsp;<span class="op" id="5503869">(</span><span class="ident" id="5503870">p</span>&nbsp;<span class="ident" id="5503872">runeSlice</span><span class="op" id="5503881">)</span>&nbsp;<span class="ident" id="5503883">Less</span><span class="op" id="5503887">(</span><span class="ident" id="5503888">i</span><span class="op" id="5503889">,</span>&nbsp;<span class="ident" id="5503891">j</span>&nbsp;<span class="builtintype" id="5503893">int</span><span class="op" id="5503896">)</span>&nbsp;<span class="builtintype" id="5503898">bool</span>&nbsp;<span class="op" id="5503903">{</span>&nbsp;<span class="keyword" id="5503905">return</span>&nbsp;<span class="ident" id="5503912">p</span><span class="op" id="5503913">[</span><span class="ident" id="5503914">i</span><span class="op" id="5503915">]</span>&nbsp;<span class="op" id="5503917">&lt;</span>&nbsp;<span class="ident" id="5503919">p</span><span class="op" id="5503920">[</span><span class="ident" id="5503921">j</span><span class="op" id="5503922">]</span>&nbsp;<span class="op" id="5503924">}</span><br>
<span class="lineno"></span><span class="keyword" id="5503926">func</span>&nbsp;<span class="op" id="5503931">(</span><span class="ident" id="5503932">p</span>&nbsp;<span class="ident" id="5503934">runeSlice</span><span class="op" id="5503943">)</span>&nbsp;<span class="ident" id="5503945">Swap</span><span class="op" id="5503949">(</span><span class="ident" id="5503950">i</span><span class="op" id="5503951">,</span>&nbsp;<span class="ident" id="5503953">j</span>&nbsp;<span class="builtintype" id="5503955">int</span><span class="op" id="5503958">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5503965">{</span>&nbsp;<span class="ident" id="5503967">p</span><span class="op" id="5503968">[</span><span class="ident" id="5503969">i</span><span class="op" id="5503970">]</span><span class="op" id="5503971">,</span>&nbsp;<span class="ident" id="5503973">p</span><span class="op" id="5503974">[</span><span class="ident" id="5503975">j</span><span class="op" id="5503976">]</span>&nbsp;<span class="op" id="5503978">=</span>&nbsp;<span class="ident" id="5503980">p</span><span class="op" id="5503981">[</span><span class="ident" id="5503982">j</span><span class="op" id="5503983">]</span><span class="op" id="5503984">,</span>&nbsp;<span class="ident" id="5503986">p</span><span class="op" id="5503987">[</span><span class="ident" id="5503988">i</span><span class="op" id="5503989">]</span>&nbsp;<span class="op" id="5503991">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5503994">//&nbsp;Sort&nbsp;is&nbsp;a&nbsp;convenience&nbsp;method.</span><br>
<span class="lineno">290</span><span class="keyword" id="5504027">func</span>&nbsp;<span class="op" id="5504032">(</span><span class="ident" id="5504033">p</span>&nbsp;<span class="ident" id="5504035">runeSlice</span><span class="op" id="5504044">)</span>&nbsp;<span class="ident" id="5504046">Sort</span><span class="op" id="5504050">(</span><span class="op" id="5504051">)</span>&nbsp;<span class="op" id="5504053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504056">sort</span><span class="op" id="5504060">.</span><span class="ident" id="5504061">Sort</span><span class="op" id="5504065">(</span><span class="ident" id="5504066">p</span><span class="op" id="5504067">)</span><br>
<span class="lineno"></span><span class="op" id="5504069">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5504072">var</span>&nbsp;<span class="ident" id="5504076">anyRuneNotNL</span>&nbsp;<span class="op" id="5504089">=</span>&nbsp;<span class="op" id="5504091">[</span><span class="op" id="5504092">]</span><span class="builtintype" id="5504093">rune</span><span class="op" id="5504097">{</span><span class="num" id="5504098">0</span><span class="op" id="5504099">,</span>&nbsp;<span class="string" id="5504101">&#39;\n&#39;</span>&nbsp;<span class="op" id="5504106">-</span>&nbsp;<span class="num" id="5504108">1</span><span class="op" id="5504109">,</span>&nbsp;<span class="string" id="5504111">&#39;\n&#39;</span>&nbsp;<span class="op" id="5504116">+</span>&nbsp;<span class="num" id="5504118">1</span><span class="op" id="5504119">,</span>&nbsp;<span class="ident" id="5504121">unicode</span><span class="op" id="5504128">.</span><span class="ident" id="5504129">MaxRune</span><span class="op" id="5504136">}</span><br>
<span class="lineno">295</span><span class="keyword" id="5504138">var</span>&nbsp;<span class="ident" id="5504142">anyRune</span>&nbsp;<span class="op" id="5504150">=</span>&nbsp;<span class="op" id="5504152">[</span><span class="op" id="5504153">]</span><span class="builtintype" id="5504154">rune</span><span class="op" id="5504158">{</span><span class="num" id="5504159">0</span><span class="op" id="5504160">,</span>&nbsp;<span class="ident" id="5504162">unicode</span><span class="op" id="5504169">.</span><span class="ident" id="5504170">MaxRune</span><span class="op" id="5504177">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5504180">//&nbsp;makeOnePass&nbsp;creates&nbsp;a&nbsp;onepass&nbsp;Prog,&nbsp;if&nbsp;possible.&nbsp;It&nbsp;is&nbsp;possible&nbsp;if&nbsp;at&nbsp;any&nbsp;alt,</span><br>
<span class="lineno"></span><span class="comment" id="5504262">//&nbsp;the&nbsp;match&nbsp;engine&nbsp;can&nbsp;always&nbsp;tell&nbsp;which&nbsp;branch&nbsp;to&nbsp;take.&nbsp;The&nbsp;routine&nbsp;may&nbsp;modify</span><br>
<span class="lineno"></span><span class="comment" id="5504343">//&nbsp;p&nbsp;if&nbsp;it&nbsp;is&nbsp;turned&nbsp;into&nbsp;a&nbsp;onepass&nbsp;Prog.&nbsp;If&nbsp;it&nbsp;isn&#39;t&nbsp;possible&nbsp;for&nbsp;this&nbsp;to&nbsp;be&nbsp;a</span><br>
<span class="lineno">300</span><span class="comment" id="5504423">//&nbsp;onepass&nbsp;Prog,&nbsp;the&nbsp;Prog&nbsp;notOnePass&nbsp;is&nbsp;returned.&nbsp;makeOnePass&nbsp;is&nbsp;recursive</span><br>
<span class="lineno"></span><span class="comment" id="5504498">//&nbsp;to&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;Prog.</span><br>
<span class="lineno"></span><span class="keyword" id="5504526">func</span>&nbsp;<span class="ident" id="5504531">makeOnePass</span><span class="op" id="5504542">(</span><span class="ident" id="5504543">p</span>&nbsp;<span class="op" id="5504545">*</span><span class="ident" id="5504546">onePassProg</span><span class="op" id="5504557">)</span>&nbsp;<span class="op" id="5504559">*</span><span class="ident" id="5504560">onePassProg</span>&nbsp;<span class="op" id="5504572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5504575">//&nbsp;If&nbsp;the&nbsp;machine&nbsp;is&nbsp;very&nbsp;long,&nbsp;it&#39;s&nbsp;not&nbsp;worth&nbsp;the&nbsp;time&nbsp;to&nbsp;check&nbsp;if&nbsp;we&nbsp;can&nbsp;use&nbsp;one&nbsp;pass.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5504665">if</span>&nbsp;<span class="builtinfunc" id="5504668">len</span><span class="op" id="5504671">(</span><span class="ident" id="5504672">p</span><span class="op" id="5504673">.</span><span class="ident" id="5504674">Inst</span><span class="op" id="5504678">)</span>&nbsp;<span class="op" id="5504680">&gt;=</span>&nbsp;<span class="num" id="5504683">1000</span>&nbsp;<span class="op" id="5504688">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5504692">return</span>&nbsp;<span class="ident" id="5504699">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5504711">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5504715">var</span>&nbsp;<span class="op" id="5504719">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504723">instQueue</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5504736">=</span>&nbsp;<span class="ident" id="5504738">newQueue</span><span class="op" id="5504746">(</span><span class="builtinfunc" id="5504747">len</span><span class="op" id="5504750">(</span><span class="ident" id="5504751">p</span><span class="op" id="5504752">.</span><span class="ident" id="5504753">Inst</span><span class="op" id="5504757">)</span><span class="op" id="5504758">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504762">visitQueue</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5504775">=</span>&nbsp;<span class="ident" id="5504777">newQueue</span><span class="op" id="5504785">(</span><span class="builtinfunc" id="5504786">len</span><span class="op" id="5504789">(</span><span class="ident" id="5504790">p</span><span class="op" id="5504791">.</span><span class="ident" id="5504792">Inst</span><span class="op" id="5504796">)</span><span class="op" id="5504797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504801">build</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5504814">func</span><span class="op" id="5504818">(</span><span class="builtintype" id="5504819">uint32</span><span class="op" id="5504825">,</span>&nbsp;<span class="op" id="5504827">*</span><span class="ident" id="5504828">queueOnePass</span><span class="op" id="5504840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504844">check</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5504857">func</span><span class="op" id="5504861">(</span><span class="builtintype" id="5504862">uint32</span><span class="op" id="5504868">,</span>&nbsp;<span class="keyword" id="5504870">map</span><span class="op" id="5504873">[</span><span class="builtintype" id="5504874">uint32</span><span class="op" id="5504880">]</span><span class="builtintype" id="5504881">bool</span><span class="op" id="5504885">)</span>&nbsp;<span class="builtintype" id="5504887">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504894">onePassRunes</span>&nbsp;<span class="op" id="5504907">=</span>&nbsp;<span class="builtinfunc" id="5504909">make</span><span class="op" id="5504913">(</span><span class="op" id="5504914">[</span><span class="op" id="5504915">]</span><span class="op" id="5504916">[</span><span class="op" id="5504917">]</span><span class="builtintype" id="5504918">rune</span><span class="op" id="5504922">,</span>&nbsp;<span class="builtinfunc" id="5504924">len</span><span class="op" id="5504927">(</span><span class="ident" id="5504928">p</span><span class="op" id="5504929">.</span><span class="ident" id="5504930">Inst</span><span class="op" id="5504934">)</span><span class="op" id="5504935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5504938">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504941">build</span>&nbsp;<span class="op" id="5504947">=</span>&nbsp;<span class="keyword" id="5504949">func</span><span class="op" id="5504953">(</span><span class="ident" id="5504954">pc</span>&nbsp;<span class="builtintype" id="5504957">uint32</span><span class="op" id="5504963">,</span>&nbsp;<span class="ident" id="5504965">q</span>&nbsp;<span class="op" id="5504967">*</span><span class="ident" id="5504968">queueOnePass</span><span class="op" id="5504980">)</span>&nbsp;<span class="op" id="5504982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5504986">if</span>&nbsp;<span class="ident" id="5504989">q</span><span class="op" id="5504990">.</span><span class="ident" id="5504991">contains</span><span class="op" id="5504999">(</span><span class="ident" id="5505000">pc</span><span class="op" id="5505002">)</span>&nbsp;<span class="op" id="5505004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5505009">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5505018">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505022">inst</span>&nbsp;<span class="op" id="5505027">:=</span>&nbsp;<span class="ident" id="5505030">p</span><span class="op" id="5505031">.</span><span class="ident" id="5505032">Inst</span><span class="op" id="5505036">[</span><span class="ident" id="5505037">pc</span><span class="op" id="5505039">]</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5505043">switch</span>&nbsp;<span class="ident" id="5505050">inst</span><span class="op" id="5505054">.</span><span class="ident" id="5505055">Op</span>&nbsp;<span class="op" id="5505058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5505062">case</span>&nbsp;<span class="ident" id="5505067">syntax</span><span class="op" id="5505073">.</span><span class="ident" id="5505074">InstAlt</span><span class="op" id="5505081">,</span>&nbsp;<span class="ident" id="5505083">syntax</span><span class="op" id="5505089">.</span><span class="ident" id="5505090">InstAltMatch</span><span class="op" id="5505102">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505107">q</span><span class="op" id="5505108">.</span><span class="ident" id="5505109">insert</span><span class="op" id="5505115">(</span><span class="ident" id="5505116">inst</span><span class="op" id="5505120">.</span><span class="ident" id="5505121">Out</span><span class="op" id="5505124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505129">build</span><span class="op" id="5505134">(</span><span class="ident" id="5505135">inst</span><span class="op" id="5505139">.</span><span class="ident" id="5505140">Out</span><span class="op" id="5505143">,</span>&nbsp;<span class="ident" id="5505145">q</span><span class="op" id="5505146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505151">q</span><span class="op" id="5505152">.</span><span class="ident" id="5505153">insert</span><span class="op" id="5505159">(</span><span class="ident" id="5505160">inst</span><span class="op" id="5505164">.</span><span class="ident" id="5505165">Arg</span><span class="op" id="5505168">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5505172">case</span>&nbsp;<span class="ident" id="5505177">syntax</span><span class="op" id="5505183">.</span><span class="ident" id="5505184">InstMatch</span><span class="op" id="5505193">,</span>&nbsp;<span class="ident" id="5505195">syntax</span><span class="op" id="5505201">.</span><span class="ident" id="5505202">InstFail</span><span class="op" id="5505210">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5505214">default</span><span class="op" id="5505221">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505226">q</span><span class="op" id="5505227">.</span><span class="ident" id="5505228">insert</span><span class="op" id="5505234">(</span><span class="ident" id="5505235">inst</span><span class="op" id="5505239">.</span><span class="ident" id="5505240">Out</span><span class="op" id="5505243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5505247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5505250">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5505254">//&nbsp;check&nbsp;that&nbsp;paths&nbsp;from&nbsp;Alt&nbsp;instructions&nbsp;are&nbsp;unambiguous,&nbsp;and&nbsp;rebuild&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5505334">//&nbsp;program&nbsp;as&nbsp;a&nbsp;onepass&nbsp;program</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505367">check</span>&nbsp;<span class="op" id="5505373">=</span>&nbsp;<span class="keyword" id="5505375">func</span><span class="op" id="5505379">(</span><span class="ident" id="5505380">pc</span>&nbsp;<span class="builtintype" id="5505383">uint32</span><span class="op" id="5505389">,</span>&nbsp;<span class="ident" id="5505391">m</span>&nbsp;<span class="keyword" id="5505393">map</span><span class="op" id="5505396">[</span><span class="builtintype" id="5505397">uint32</span><span class="op" id="5505403">]</span><span class="builtintype" id="5505404">bool</span><span class="op" id="5505408">)</span>&nbsp;<span class="op" id="5505410">(</span><span class="ident" id="5505411">ok</span>&nbsp;<span class="builtintype" id="5505414">bool</span><span class="op" id="5505418">)</span>&nbsp;<span class="op" id="5505420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505424">ok</span>&nbsp;<span class="op" id="5505427">=</span>&nbsp;<span class="builtintype" id="5505429">true</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505436">inst</span>&nbsp;<span class="op" id="5505441">:=</span>&nbsp;<span class="op" id="5505444">&amp;</span><span class="ident" id="5505445">p</span><span class="op" id="5505446">.</span><span class="ident" id="5505447">Inst</span><span class="op" id="5505451">[</span><span class="ident" id="5505452">pc</span><span class="op" id="5505454">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5505458">if</span>&nbsp;<span class="ident" id="5505461">visitQueue</span><span class="op" id="5505471">.</span><span class="ident" id="5505472">contains</span><span class="op" id="5505480">(</span><span class="ident" id="5505481">pc</span><span class="op" id="5505483">)</span>&nbsp;<span class="op" id="5505485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5505490">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5505499">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505503">visitQueue</span><span class="op" id="5505513">.</span><span class="ident" id="5505514">insert</span><span class="op" id="5505520">(</span><span class="ident" id="5505521">pc</span><span class="op" id="5505523">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5505527">switch</span>&nbsp;<span class="ident" id="5505534">inst</span><span class="op" id="5505538">.</span><span class="ident" id="5505539">Op</span>&nbsp;<span class="op" id="5505542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5505546">case</span>&nbsp;<span class="ident" id="5505551">syntax</span><span class="op" id="5505557">.</span><span class="ident" id="5505558">InstAlt</span><span class="op" id="5505565">,</span>&nbsp;<span class="ident" id="5505567">syntax</span><span class="op" id="5505573">.</span><span class="ident" id="5505574">InstAltMatch</span><span class="op" id="5505586">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505591">ok</span>&nbsp;<span class="op" id="5505594">=</span>&nbsp;<span class="ident" id="5505596">check</span><span class="op" id="5505601">(</span><span class="ident" id="5505602">inst</span><span class="op" id="5505606">.</span><span class="ident" id="5505607">Out</span><span class="op" id="5505610">,</span>&nbsp;<span class="ident" id="5505612">m</span><span class="op" id="5505613">)</span>&nbsp;<span class="op" id="5505615">&amp;&amp;</span>&nbsp;<span class="ident" id="5505618">check</span><span class="op" id="5505623">(</span><span class="ident" id="5505624">inst</span><span class="op" id="5505628">.</span><span class="ident" id="5505629">Arg</span><span class="op" id="5505632">,</span>&nbsp;<span class="ident" id="5505634">m</span><span class="op" id="5505635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5505640">//&nbsp;check&nbsp;no-input&nbsp;paths&nbsp;to&nbsp;InstMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505680">matchOut</span>&nbsp;<span class="op" id="5505689">:=</span>&nbsp;<span class="ident" id="5505692">m</span><span class="op" id="5505693">[</span><span class="ident" id="5505694">inst</span><span class="op" id="5505698">.</span><span class="ident" id="5505699">Out</span><span class="op" id="5505702">]</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505707">matchArg</span>&nbsp;<span class="op" id="5505716">:=</span>&nbsp;<span class="ident" id="5505719">m</span><span class="op" id="5505720">[</span><span class="ident" id="5505721">inst</span><span class="op" id="5505725">.</span><span class="ident" id="5505726">Arg</span><span class="op" id="5505729">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5505734">if</span>&nbsp;<span class="ident" id="5505737">matchOut</span>&nbsp;<span class="op" id="5505746">&amp;&amp;</span>&nbsp;<span class="ident" id="5505749">matchArg</span>&nbsp;<span class="op" id="5505758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505764">ok</span>&nbsp;<span class="op" id="5505767">=</span>&nbsp;<span class="builtintype" id="5505769">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5505779">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5505788">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5505793">//&nbsp;Match&nbsp;on&nbsp;empty&nbsp;goes&nbsp;in&nbsp;inst.Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5505831">if</span>&nbsp;<span class="ident" id="5505834">matchArg</span>&nbsp;<span class="op" id="5505843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505849">inst</span><span class="op" id="5505853">.</span><span class="ident" id="5505854">Out</span><span class="op" id="5505857">,</span>&nbsp;<span class="ident" id="5505859">inst</span><span class="op" id="5505863">.</span><span class="ident" id="5505864">Arg</span>&nbsp;<span class="op" id="5505868">=</span>&nbsp;<span class="ident" id="5505870">inst</span><span class="op" id="5505874">.</span><span class="ident" id="5505875">Arg</span><span class="op" id="5505878">,</span>&nbsp;<span class="ident" id="5505880">inst</span><span class="op" id="5505884">.</span><span class="ident" id="5505885">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505893">matchOut</span><span class="op" id="5505901">,</span>&nbsp;<span class="ident" id="5505903">matchArg</span>&nbsp;<span class="op" id="5505912">=</span>&nbsp;<span class="ident" id="5505914">matchArg</span><span class="op" id="5505922">,</span>&nbsp;<span class="ident" id="5505924">matchOut</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5505936">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5505941">if</span>&nbsp;<span class="ident" id="5505944">matchOut</span>&nbsp;<span class="op" id="5505953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505959">m</span><span class="op" id="5505960">[</span><span class="ident" id="5505961">pc</span><span class="op" id="5505963">]</span>&nbsp;<span class="op" id="5505965">=</span>&nbsp;<span class="builtintype" id="5505967">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505976">inst</span><span class="op" id="5505980">.</span><span class="ident" id="5505981">Op</span>&nbsp;<span class="op" id="5505984">=</span>&nbsp;<span class="ident" id="5505986">syntax</span><span class="op" id="5505992">.</span><span class="ident" id="5505993">InstAltMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5506009">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5506015">//&nbsp;build&nbsp;a&nbsp;dispatch&nbsp;operator&nbsp;from&nbsp;the&nbsp;two&nbsp;legs&nbsp;of&nbsp;the&nbsp;alt.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506077">onePassRunes</span><span class="op" id="5506089">[</span><span class="ident" id="5506090">pc</span><span class="op" id="5506092">]</span><span class="op" id="5506093">,</span>&nbsp;<span class="ident" id="5506095">inst</span><span class="op" id="5506099">.</span><span class="ident" id="5506100">Next</span>&nbsp;<span class="op" id="5506105">=</span>&nbsp;<span class="ident" id="5506107">mergeRuneSets</span><span class="op" id="5506120">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5506126">&amp;</span><span class="ident" id="5506127">onePassRunes</span><span class="op" id="5506139">[</span><span class="ident" id="5506140">inst</span><span class="op" id="5506144">.</span><span class="ident" id="5506145">Out</span><span class="op" id="5506148">]</span><span class="op" id="5506149">,</span>&nbsp;<span class="op" id="5506151">&amp;</span><span class="ident" id="5506152">onePassRunes</span><span class="op" id="5506164">[</span><span class="ident" id="5506165">inst</span><span class="op" id="5506169">.</span><span class="ident" id="5506170">Arg</span><span class="op" id="5506173">]</span><span class="op" id="5506174">,</span>&nbsp;<span class="ident" id="5506176">inst</span><span class="op" id="5506180">.</span><span class="ident" id="5506181">Out</span><span class="op" id="5506184">,</span>&nbsp;<span class="ident" id="5506186">inst</span><span class="op" id="5506190">.</span><span class="ident" id="5506191">Arg</span><span class="op" id="5506194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5506199">if</span>&nbsp;<span class="builtinfunc" id="5506202">len</span><span class="op" id="5506205">(</span><span class="ident" id="5506206">inst</span><span class="op" id="5506210">.</span><span class="ident" id="5506211">Next</span><span class="op" id="5506215">)</span>&nbsp;<span class="op" id="5506217">&gt;</span>&nbsp;<span class="num" id="5506219">0</span>&nbsp;<span class="op" id="5506221">&amp;&amp;</span>&nbsp;<span class="ident" id="5506224">inst</span><span class="op" id="5506228">.</span><span class="ident" id="5506229">Next</span><span class="op" id="5506233">[</span><span class="num" id="5506234">0</span><span class="op" id="5506235">]</span>&nbsp;<span class="op" id="5506237">==</span>&nbsp;<span class="ident" id="5506240">mergeFailed</span>&nbsp;<span class="op" id="5506252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506258">ok</span>&nbsp;<span class="op" id="5506261">=</span>&nbsp;<span class="builtintype" id="5506263">false</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5506273">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5506282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5506286">case</span>&nbsp;<span class="ident" id="5506291">syntax</span><span class="op" id="5506297">.</span><span class="ident" id="5506298">InstCapture</span><span class="op" id="5506309">,</span>&nbsp;<span class="ident" id="5506311">syntax</span><span class="op" id="5506317">.</span><span class="ident" id="5506318">InstNop</span><span class="op" id="5506325">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506330">ok</span>&nbsp;<span class="op" id="5506333">=</span>&nbsp;<span class="ident" id="5506335">check</span><span class="op" id="5506340">(</span><span class="ident" id="5506341">inst</span><span class="op" id="5506345">.</span><span class="ident" id="5506346">Out</span><span class="op" id="5506349">,</span>&nbsp;<span class="ident" id="5506351">m</span><span class="op" id="5506352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506357">m</span><span class="op" id="5506358">[</span><span class="ident" id="5506359">pc</span><span class="op" id="5506361">]</span>&nbsp;<span class="op" id="5506363">=</span>&nbsp;<span class="ident" id="5506365">m</span><span class="op" id="5506366">[</span><span class="ident" id="5506367">inst</span><span class="op" id="5506371">.</span><span class="ident" id="5506372">Out</span><span class="op" id="5506375">]</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5506380">//&nbsp;pass&nbsp;matching&nbsp;runes&nbsp;back&nbsp;through&nbsp;these&nbsp;no-ops.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506433">onePassRunes</span><span class="op" id="5506445">[</span><span class="ident" id="5506446">pc</span><span class="op" id="5506448">]</span>&nbsp;<span class="op" id="5506450">=</span>&nbsp;<span class="builtinfunc" id="5506452">append</span><span class="op" id="5506458">(</span><span class="op" id="5506459">[</span><span class="op" id="5506460">]</span><span class="builtintype" id="5506461">rune</span><span class="op" id="5506465">{</span><span class="op" id="5506466">}</span><span class="op" id="5506467">,</span>&nbsp;<span class="ident" id="5506469">onePassRunes</span><span class="op" id="5506481">[</span><span class="ident" id="5506482">inst</span><span class="op" id="5506486">.</span><span class="ident" id="5506487">Out</span><span class="op" id="5506490">]</span><span class="op" id="5506491">...</span><span class="op" id="5506494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506499">inst</span><span class="op" id="5506503">.</span><span class="ident" id="5506504">Next</span>&nbsp;<span class="op" id="5506509">=</span>&nbsp;<span class="op" id="5506511">[</span><span class="op" id="5506512">]</span><span class="builtintype" id="5506513">uint32</span><span class="op" id="5506519">{</span><span class="op" id="5506520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5506525">for</span>&nbsp;<span class="ident" id="5506529">i</span>&nbsp;<span class="op" id="5506531">:=</span>&nbsp;<span class="builtinfunc" id="5506534">len</span><span class="op" id="5506537">(</span><span class="ident" id="5506538">onePassRunes</span><span class="op" id="5506550">[</span><span class="ident" id="5506551">pc</span><span class="op" id="5506553">]</span><span class="op" id="5506554">)</span>&nbsp;<span class="op" id="5506556">/</span>&nbsp;<span class="num" id="5506558">2</span><span class="op" id="5506559">;</span>&nbsp;<span class="ident" id="5506561">i</span>&nbsp;<span class="op" id="5506563">&gt;=</span>&nbsp;<span class="num" id="5506566">0</span><span class="op" id="5506567">;</span>&nbsp;<span class="ident" id="5506569">i</span><span class="op" id="5506570">--</span>&nbsp;<span class="op" id="5506573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506579">inst</span><span class="op" id="5506583">.</span><span class="ident" id="5506584">Next</span>&nbsp;<span class="op" id="5506589">=</span>&nbsp;<span class="builtinfunc" id="5506591">append</span><span class="op" id="5506597">(</span><span class="ident" id="5506598">inst</span><span class="op" id="5506602">.</span><span class="ident" id="5506603">Next</span><span class="op" id="5506607">,</span>&nbsp;<span class="ident" id="5506609">inst</span><span class="op" id="5506613">.</span><span class="ident" id="5506614">Out</span><span class="op" id="5506617">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5506622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5506626">case</span>&nbsp;<span class="ident" id="5506631">syntax</span><span class="op" id="5506637">.</span><span class="ident" id="5506638">InstEmptyWidth</span><span class="op" id="5506652">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506657">ok</span>&nbsp;<span class="op" id="5506660">=</span>&nbsp;<span class="ident" id="5506662">check</span><span class="op" id="5506667">(</span><span class="ident" id="5506668">inst</span><span class="op" id="5506672">.</span><span class="ident" id="5506673">Out</span><span class="op" id="5506676">,</span>&nbsp;<span class="ident" id="5506678">m</span><span class="op" id="5506679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506684">m</span><span class="op" id="5506685">[</span><span class="ident" id="5506686">pc</span><span class="op" id="5506688">]</span>&nbsp;<span class="op" id="5506690">=</span>&nbsp;<span class="ident" id="5506692">m</span><span class="op" id="5506693">[</span><span class="ident" id="5506694">inst</span><span class="op" id="5506698">.</span><span class="ident" id="5506699">Out</span><span class="op" id="5506702">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506707">onePassRunes</span><span class="op" id="5506719">[</span><span class="ident" id="5506720">pc</span><span class="op" id="5506722">]</span>&nbsp;<span class="op" id="5506724">=</span>&nbsp;<span class="builtinfunc" id="5506726">append</span><span class="op" id="5506732">(</span><span class="op" id="5506733">[</span><span class="op" id="5506734">]</span><span class="builtintype" id="5506735">rune</span><span class="op" id="5506739">{</span><span class="op" id="5506740">}</span><span class="op" id="5506741">,</span>&nbsp;<span class="ident" id="5506743">onePassRunes</span><span class="op" id="5506755">[</span><span class="ident" id="5506756">inst</span><span class="op" id="5506760">.</span><span class="ident" id="5506761">Out</span><span class="op" id="5506764">]</span><span class="op" id="5506765">...</span><span class="op" id="5506768">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506773">inst</span><span class="op" id="5506777">.</span><span class="ident" id="5506778">Next</span>&nbsp;<span class="op" id="5506783">=</span>&nbsp;<span class="op" id="5506785">[</span><span class="op" id="5506786">]</span><span class="builtintype" id="5506787">uint32</span><span class="op" id="5506793">{</span><span class="op" id="5506794">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5506799">for</span>&nbsp;<span class="ident" id="5506803">i</span>&nbsp;<span class="op" id="5506805">:=</span>&nbsp;<span class="builtinfunc" id="5506808">len</span><span class="op" id="5506811">(</span><span class="ident" id="5506812">onePassRunes</span><span class="op" id="5506824">[</span><span class="ident" id="5506825">pc</span><span class="op" id="5506827">]</span><span class="op" id="5506828">)</span>&nbsp;<span class="op" id="5506830">/</span>&nbsp;<span class="num" id="5506832">2</span><span class="op" id="5506833">;</span>&nbsp;<span class="ident" id="5506835">i</span>&nbsp;<span class="op" id="5506837">&gt;=</span>&nbsp;<span class="num" id="5506840">0</span><span class="op" id="5506841">;</span>&nbsp;<span class="ident" id="5506843">i</span><span class="op" id="5506844">--</span>&nbsp;<span class="op" id="5506847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506853">inst</span><span class="op" id="5506857">.</span><span class="ident" id="5506858">Next</span>&nbsp;<span class="op" id="5506863">=</span>&nbsp;<span class="builtinfunc" id="5506865">append</span><span class="op" id="5506871">(</span><span class="ident" id="5506872">inst</span><span class="op" id="5506876">.</span><span class="ident" id="5506877">Next</span><span class="op" id="5506881">,</span>&nbsp;<span class="ident" id="5506883">inst</span><span class="op" id="5506887">.</span><span class="ident" id="5506888">Out</span><span class="op" id="5506891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5506896">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5506900">case</span>&nbsp;<span class="ident" id="5506905">syntax</span><span class="op" id="5506911">.</span><span class="ident" id="5506912">InstMatch</span><span class="op" id="5506921">,</span>&nbsp;<span class="ident" id="5506923">syntax</span><span class="op" id="5506929">.</span><span class="ident" id="5506930">InstFail</span><span class="op" id="5506938">:</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506943">m</span><span class="op" id="5506944">[</span><span class="ident" id="5506945">pc</span><span class="op" id="5506947">]</span>&nbsp;<span class="op" id="5506949">=</span>&nbsp;<span class="ident" id="5506951">inst</span><span class="op" id="5506955">.</span><span class="ident" id="5506956">Op</span>&nbsp;<span class="op" id="5506959">==</span>&nbsp;<span class="ident" id="5506962">syntax</span><span class="op" id="5506968">.</span><span class="ident" id="5506969">InstMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5506982">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5506990">case</span>&nbsp;<span class="ident" id="5506995">syntax</span><span class="op" id="5507001">.</span><span class="ident" id="5507002">InstRune</span><span class="op" id="5507010">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507015">ok</span>&nbsp;<span class="op" id="5507018">=</span>&nbsp;<span class="ident" id="5507020">check</span><span class="op" id="5507025">(</span><span class="ident" id="5507026">inst</span><span class="op" id="5507030">.</span><span class="ident" id="5507031">Out</span><span class="op" id="5507034">,</span>&nbsp;<span class="ident" id="5507036">m</span><span class="op" id="5507037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507042">m</span><span class="op" id="5507043">[</span><span class="ident" id="5507044">pc</span><span class="op" id="5507046">]</span>&nbsp;<span class="op" id="5507048">=</span>&nbsp;<span class="builtintype" id="5507050">false</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507059">if</span>&nbsp;<span class="builtinfunc" id="5507062">len</span><span class="op" id="5507065">(</span><span class="ident" id="5507066">inst</span><span class="op" id="5507070">.</span><span class="ident" id="5507071">Next</span><span class="op" id="5507075">)</span>&nbsp;<span class="op" id="5507077">&gt;</span>&nbsp;<span class="num" id="5507079">0</span>&nbsp;<span class="op" id="5507081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507087">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5507096">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507101">if</span>&nbsp;<span class="builtinfunc" id="5507104">len</span><span class="op" id="5507107">(</span><span class="ident" id="5507108">inst</span><span class="op" id="5507112">.</span><span class="ident" id="5507113">Rune</span><span class="op" id="5507117">)</span>&nbsp;<span class="op" id="5507119">==</span>&nbsp;<span class="num" id="5507122">0</span>&nbsp;<span class="op" id="5507124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507130">onePassRunes</span><span class="op" id="5507142">[</span><span class="ident" id="5507143">pc</span><span class="op" id="5507145">]</span>&nbsp;<span class="op" id="5507147">=</span>&nbsp;<span class="op" id="5507149">[</span><span class="op" id="5507150">]</span><span class="builtintype" id="5507151">rune</span><span class="op" id="5507155">{</span><span class="op" id="5507156">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507162">inst</span><span class="op" id="5507166">.</span><span class="ident" id="5507167">Next</span>&nbsp;<span class="op" id="5507172">=</span>&nbsp;<span class="op" id="5507174">[</span><span class="op" id="5507175">]</span><span class="builtintype" id="5507176">uint32</span><span class="op" id="5507182">{</span><span class="ident" id="5507183">inst</span><span class="op" id="5507187">.</span><span class="ident" id="5507188">Out</span><span class="op" id="5507191">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507197">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5507206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507211">runes</span>&nbsp;<span class="op" id="5507217">:=</span>&nbsp;<span class="builtinfunc" id="5507220">make</span><span class="op" id="5507224">(</span><span class="op" id="5507225">[</span><span class="op" id="5507226">]</span><span class="builtintype" id="5507227">rune</span><span class="op" id="5507231">,</span>&nbsp;<span class="num" id="5507233">0</span><span class="op" id="5507234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507239">if</span>&nbsp;<span class="builtinfunc" id="5507242">len</span><span class="op" id="5507245">(</span><span class="ident" id="5507246">inst</span><span class="op" id="5507250">.</span><span class="ident" id="5507251">Rune</span><span class="op" id="5507255">)</span>&nbsp;<span class="op" id="5507257">==</span>&nbsp;<span class="num" id="5507260">1</span>&nbsp;<span class="op" id="5507262">&amp;&amp;</span>&nbsp;<span class="ident" id="5507265">syntax</span><span class="op" id="5507271">.</span><span class="ident" id="5507272">Flags</span><span class="op" id="5507277">(</span><span class="ident" id="5507278">inst</span><span class="op" id="5507282">.</span><span class="ident" id="5507283">Arg</span><span class="op" id="5507286">)</span><span class="op" id="5507287">&amp;</span><span class="ident" id="5507288">syntax</span><span class="op" id="5507294">.</span><span class="ident" id="5507295">FoldCase</span>&nbsp;<span class="op" id="5507304">!=</span>&nbsp;<span class="num" id="5507307">0</span>&nbsp;<span class="op" id="5507309">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507315">r0</span>&nbsp;<span class="op" id="5507318">:=</span>&nbsp;<span class="ident" id="5507321">inst</span><span class="op" id="5507325">.</span><span class="ident" id="5507326">Rune</span><span class="op" id="5507330">[</span><span class="num" id="5507331">0</span><span class="op" id="5507332">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507338">runes</span>&nbsp;<span class="op" id="5507344">=</span>&nbsp;<span class="builtinfunc" id="5507346">append</span><span class="op" id="5507352">(</span><span class="ident" id="5507353">runes</span><span class="op" id="5507358">,</span>&nbsp;<span class="ident" id="5507360">r0</span><span class="op" id="5507362">,</span>&nbsp;<span class="ident" id="5507364">r0</span><span class="op" id="5507366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507372">for</span>&nbsp;<span class="ident" id="5507376">r1</span>&nbsp;<span class="op" id="5507379">:=</span>&nbsp;<span class="ident" id="5507382">unicode</span><span class="op" id="5507389">.</span><span class="ident" id="5507390">SimpleFold</span><span class="op" id="5507400">(</span><span class="ident" id="5507401">r0</span><span class="op" id="5507403">)</span><span class="op" id="5507404">;</span>&nbsp;<span class="ident" id="5507406">r1</span>&nbsp;<span class="op" id="5507409">!=</span>&nbsp;<span class="ident" id="5507412">r0</span><span class="op" id="5507414">;</span>&nbsp;<span class="ident" id="5507416">r1</span>&nbsp;<span class="op" id="5507419">=</span>&nbsp;<span class="ident" id="5507421">unicode</span><span class="op" id="5507428">.</span><span class="ident" id="5507429">SimpleFold</span><span class="op" id="5507439">(</span><span class="ident" id="5507440">r1</span><span class="op" id="5507442">)</span>&nbsp;<span class="op" id="5507444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507451">runes</span>&nbsp;<span class="op" id="5507457">=</span>&nbsp;<span class="builtinfunc" id="5507459">append</span><span class="op" id="5507465">(</span><span class="ident" id="5507466">runes</span><span class="op" id="5507471">,</span>&nbsp;<span class="ident" id="5507473">r1</span><span class="op" id="5507475">,</span>&nbsp;<span class="ident" id="5507477">r1</span><span class="op" id="5507479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5507485">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507491">sort</span><span class="op" id="5507495">.</span><span class="ident" id="5507496">Sort</span><span class="op" id="5507500">(</span><span class="ident" id="5507501">runeSlice</span><span class="op" id="5507510">(</span><span class="ident" id="5507511">runes</span><span class="op" id="5507516">)</span><span class="op" id="5507517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5507522">}</span>&nbsp;<span class="keyword" id="5507524">else</span>&nbsp;<span class="op" id="5507529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507535">runes</span>&nbsp;<span class="op" id="5507541">=</span>&nbsp;<span class="builtinfunc" id="5507543">append</span><span class="op" id="5507549">(</span><span class="ident" id="5507550">runes</span><span class="op" id="5507555">,</span>&nbsp;<span class="ident" id="5507557">inst</span><span class="op" id="5507561">.</span><span class="ident" id="5507562">Rune</span><span class="op" id="5507566">...</span><span class="op" id="5507569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5507574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507579">onePassRunes</span><span class="op" id="5507591">[</span><span class="ident" id="5507592">pc</span><span class="op" id="5507594">]</span>&nbsp;<span class="op" id="5507596">=</span>&nbsp;<span class="ident" id="5507598">runes</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507607">inst</span><span class="op" id="5507611">.</span><span class="ident" id="5507612">Next</span>&nbsp;<span class="op" id="5507617">=</span>&nbsp;<span class="op" id="5507619">[</span><span class="op" id="5507620">]</span><span class="builtintype" id="5507621">uint32</span><span class="op" id="5507627">{</span><span class="op" id="5507628">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507633">for</span>&nbsp;<span class="ident" id="5507637">i</span>&nbsp;<span class="op" id="5507639">:=</span>&nbsp;<span class="builtinfunc" id="5507642">len</span><span class="op" id="5507645">(</span><span class="ident" id="5507646">onePassRunes</span><span class="op" id="5507658">[</span><span class="ident" id="5507659">pc</span><span class="op" id="5507661">]</span><span class="op" id="5507662">)</span>&nbsp;<span class="op" id="5507664">/</span>&nbsp;<span class="num" id="5507666">2</span><span class="op" id="5507667">;</span>&nbsp;<span class="ident" id="5507669">i</span>&nbsp;<span class="op" id="5507671">&gt;=</span>&nbsp;<span class="num" id="5507674">0</span><span class="op" id="5507675">;</span>&nbsp;<span class="ident" id="5507677">i</span><span class="op" id="5507678">--</span>&nbsp;<span class="op" id="5507681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507687">inst</span><span class="op" id="5507691">.</span><span class="ident" id="5507692">Next</span>&nbsp;<span class="op" id="5507697">=</span>&nbsp;<span class="builtinfunc" id="5507699">append</span><span class="op" id="5507705">(</span><span class="ident" id="5507706">inst</span><span class="op" id="5507710">.</span><span class="ident" id="5507711">Next</span><span class="op" id="5507715">,</span>&nbsp;<span class="ident" id="5507717">inst</span><span class="op" id="5507721">.</span><span class="ident" id="5507722">Out</span><span class="op" id="5507725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5507730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507735">inst</span><span class="op" id="5507739">.</span><span class="ident" id="5507740">Op</span>&nbsp;<span class="op" id="5507743">=</span>&nbsp;<span class="ident" id="5507745">syntax</span><span class="op" id="5507751">.</span><span class="ident" id="5507752">InstRune</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507763">case</span>&nbsp;<span class="ident" id="5507768">syntax</span><span class="op" id="5507774">.</span><span class="ident" id="5507775">InstRune1</span><span class="op" id="5507784">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507789">ok</span>&nbsp;<span class="op" id="5507792">=</span>&nbsp;<span class="ident" id="5507794">check</span><span class="op" id="5507799">(</span><span class="ident" id="5507800">inst</span><span class="op" id="5507804">.</span><span class="ident" id="5507805">Out</span><span class="op" id="5507808">,</span>&nbsp;<span class="ident" id="5507810">m</span><span class="op" id="5507811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507816">m</span><span class="op" id="5507817">[</span><span class="ident" id="5507818">pc</span><span class="op" id="5507820">]</span>&nbsp;<span class="op" id="5507822">=</span>&nbsp;<span class="builtintype" id="5507824">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507833">if</span>&nbsp;<span class="builtinfunc" id="5507836">len</span><span class="op" id="5507839">(</span><span class="ident" id="5507840">inst</span><span class="op" id="5507844">.</span><span class="ident" id="5507845">Next</span><span class="op" id="5507849">)</span>&nbsp;<span class="op" id="5507851">&gt;</span>&nbsp;<span class="num" id="5507853">0</span>&nbsp;<span class="op" id="5507855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507861">break</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5507870">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507875">runes</span>&nbsp;<span class="op" id="5507881">:=</span>&nbsp;<span class="op" id="5507884">[</span><span class="op" id="5507885">]</span><span class="builtintype" id="5507886">rune</span><span class="op" id="5507890">{</span><span class="op" id="5507891">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5507896">//&nbsp;expand&nbsp;case-folded&nbsp;runes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507927">if</span>&nbsp;<span class="ident" id="5507930">syntax</span><span class="op" id="5507936">.</span><span class="ident" id="5507937">Flags</span><span class="op" id="5507942">(</span><span class="ident" id="5507943">inst</span><span class="op" id="5507947">.</span><span class="ident" id="5507948">Arg</span><span class="op" id="5507951">)</span><span class="op" id="5507952">&amp;</span><span class="ident" id="5507953">syntax</span><span class="op" id="5507959">.</span><span class="ident" id="5507960">FoldCase</span>&nbsp;<span class="op" id="5507969">!=</span>&nbsp;<span class="num" id="5507972">0</span>&nbsp;<span class="op" id="5507974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507980">r0</span>&nbsp;<span class="op" id="5507983">:=</span>&nbsp;<span class="ident" id="5507986">inst</span><span class="op" id="5507990">.</span><span class="ident" id="5507991">Rune</span><span class="op" id="5507995">[</span><span class="num" id="5507996">0</span><span class="op" id="5507997">]</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5508003">runes</span>&nbsp;<span class="op" id="5508009">=</span>&nbsp;<span class="builtinfunc" id="5508011">append</span><span class="op" id="5508017">(</span><span class="ident" id="5508018">runes</span><span class="op" id="5508023">,</span>&nbsp;<span class="ident" id="5508025">r0</span><span class="op" id="5508027">,</span>&nbsp;<span class="ident" id="5508029">r0</span><span class="op" id="5508031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5508037">for</span>&nbsp;<span class="ident" id="5508041">r1</span>&nbsp;<span class="op" id="5508044">:=</span>&nbsp;<span class="ident" id="5508047">unicode</span><span class="op" id="5508054">.</span><span class="ident" id="5508055">SimpleFold</span><span class="op" id="5508065">(</span><span class="ident" id="5508066">r0</span><span class="op" id="5508068">)</span><span class="op" id="5508069">;</span>&nbsp;<span class="ident" id="5508071">r1</span>&nbsp;<span class="op" id="5508074">!=</span>&nbsp;<span class="ident" id="5508077">r0</span><span class="op" id="5508079">;</span>&nbsp;<span class="ident" id="5508081">r1</span>&nbsp;<span class="op" id="5508084">=</span>&nbsp;<span class="ident" id="5508086">unicode</span><span class="op" id="5508093">.</span><span class="ident" id="5508094">SimpleFold</span><span class="op" id="5508104">(</span><span class="ident" id="5508105">r1</span><span class="op" id="5508107">)</span>&nbsp;<span class="op" id="5508109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5508116">runes</span>&nbsp;<span class="op" id="5508122">=</span>&nbsp;<span class="builtinfunc" id="5508124">append</span><span class="op" id="5508130">(</span><span class="ident" id="5508131">runes</span><span class="op" id="5508136">,</span>&nbsp;<span class="ident" id="5508138">r1</span><span class="op" id="5508140">,</span>&nbsp;<span class="ident" id="5508142">r1</span><span class="op" id="5508144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5508150">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5508156">sort</span><span class="op" id="5508160">.</span><span class="ident" id="5508161">Sort</span><span class="op" id="5508165">(</span><span class="ident" id="5508166">runeSlice</span><span class="op" id="5508175">(</span><span class="ident" id="5508176">runes</span><span class="op" id="5508181">)</span><span class="op" id="5508182">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5508187">}</span>&nbsp;<span class="keyword" id="5508189">else</span>&nbsp;<span class="op" id="5508194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5508200">runes</span>&nbsp;<span class="op" id="5508206">=</span>&nbsp;<span class="builtinfunc" id="5508208">append</span><span class="op" id="5508214">(</span><span class="ident" id="5508215">runes</span><span class="op" id="5508220">,</span>&nbsp;<span class="ident" id="5508222">inst</span><span class="op" id="5508226">.</span><span class="ident" id="5508227">Rune</span><span class="op" id="5508231">[</span><span class="num" id="5508232">0</span><span class="op" id="5508233">]</span><span class="op" id="5508234">,</span>&nbsp;<span class="ident" id="5508236">inst</span><span class="op" id="5508240">.</span><span class="ident" id="5508241">Rune</span><span class="op" id="5508245">[</span><span class="num" id="5508246">0</span><span class="op" id="5508247">]</span><span class="op" id="5508248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5508253">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5508258">onePassRunes</span><span class="op" id="5508270">[</span><span class="ident" id="5508271">pc</span><span class="op" id="5508273">]</span>&nbsp;<span class="op" id="5508275">=</span>&nbsp;<span class="ident" id="5508277">runes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5508286">inst</span><span class="op" id="5508290">.</span><span class="ident" id="5508291">Next</span>&nbsp;<span class="op" id="5508296">=</span>&nbsp;<span class="op" id="5508298">[</span><span class="op" id="5508299">]</span><span class="builtintype" id="5508300">uint32</span><span class="op" id="5508306">{</span><span class="op" id="5508307">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5508312">for</span>&nbsp;<span class="ident" id="5508316">i</span>&nbsp;<span class="op" id="5508318">:=</span>&nbsp;<span class="builtinfunc" id="5508321">len</span><span class="op" id="5508324">(</span><span class="ident" id="5508325">onePassRunes</span><span class="op" id="5508337">[</span><span class="ident" id="5508338">pc</span><span class="op" id="5508340">]</span><span class="op" id="5508341">)</span>&nbsp;<span class="op" id="5508343">/</span>&nbsp;<span class="num" id="5508345">2</span><span class="op" id="5508346">;</span>&nbsp;<span class="ident" id="5508348">i</span>&nbsp;<span class="op" id="5508350">&gt;=</span>&nbsp;<span class="num" id="5508353">0</span><span class="op" id="5508354">;</span>&nbsp;<span class="ident" id="5508356">i</span><span class="op" id="5508357">--</span>&nbsp;<span class="op" id="5508360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5508366">inst</span><span class="op" id="5508370">.</span><span class="ident" id="5508371">Next</span>&nbsp;<span class="op" id="5508376">=</span>&nbsp;<span class="builtinfunc" id="5508378">append</span><span class="op" id="5508384">(</span><span class="ident" id="5508385">inst</span><span class="op" id="5508389">.</span><span class="ident" id="5508390">Next</span><span class="op" id="5508394">,</span>&nbsp;<span class="ident" id="5508396">inst</span><span class="op" id="5508400">.</span><span class="ident" id="5508401">Out</span><span class="op" id="5508404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5508409">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5508414">inst</span><span class="op" id="5508418">.</span><span class="ident" id="5508419">Op</span>&nbsp;<span class="op" id="5508422">=</span>&nbsp;<span class="ident" id="5508424">syntax</span><span class="op" id="5508430">.</span><span class="ident" id="5508431">InstRune</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5508442">case</span>&nbsp;<span class="ident" id="5508447">syntax</span><span class="op" id="5508453">.</span><span class="ident" id="5508454">InstRuneAny</span><span class="op" id="5508465">:</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5508470">ok</span>&nbsp;<span class="op" id="5508473">=</span>&nbsp;<span class="ident" id="5508475">check</span><span class="op" id="5508480">(</span><span class="ident" id="5508481">inst</span><span class="op" id="5508485">.</span><span class="ident" id="5508486">Out</span><span class="op" id="5508489">,</span>&nbsp;<span class="ident" id="5508491">m</span><span class="op" id="5508492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5508497">m</span><span class="op" id="5508498">[</span><span class="ident" id="5508499">pc</span><span class="op" id="5508501">]</span>&nbsp;<span class="op" id="5508503">=</span>&nbsp;<span class="builtintype" id="5508505">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5508514">if</span>&nbsp;<span class="builtinfunc" id="5508517">len</span><span class="op" id="5508520">(</span><span class="ident" id="5508521">inst</span><span class="op" id="5508525">.</span><span class="ident" id="5508526">Next</span><span class="op" id="5508530">)</span>&nbsp;<span class="op" id="5508532">&gt;</span>&nbsp;<span class="num" id="5508534">0</span>&nbsp;<span class="op" id="5508536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5508542">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5508551">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5508556">onePassRunes</span><span class="op" id="5508568">[</span><span class="ident" id="5508569">pc</span><span class="op" id="5508571">]</span>&nbsp;<span class="op" id="5508573">=</span>&nbsp;<span class="builtinfunc" id="5508575">append</span><span class="op" id="5508581">(</span><span class="op" id="5508582">[</span><span class="op" id="5508583">]</span><span class="builtintype" id="5508584">rune</span><span class="op" id="5508588">{</span><span class="op" id="5508589">}</span><span class="op" id="5508590">,</span>&nbsp;<span class="ident" id="5508592">anyRune</span><span class="op" id="5508599">...</span><span class="op" id="5508602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5508607">inst</span><span class="op" id="5508611">.</span><span class="ident" id="5508612">Next</span>&nbsp;<span class="op" id="5508617">=</span>&nbsp;<span class="op" id="5508619">[</span><span class="op" id="5508620">]</span><span class="builtintype" id="5508621">uint32</span><span class="op" id="5508627">{</span><span class="ident" id="5508628">inst</span><span class="op" id="5508632">.</span><span class="ident" id="5508633">Out</span><span class="op" id="5508636">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5508640">case</span>&nbsp;<span class="ident" id="5508645">syntax</span><span class="op" id="5508651">.</span><span class="ident" id="5508652">InstRuneAnyNotNL</span><span class="op" id="5508668">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5508673">ok</span>&nbsp;<span class="op" id="5508676">=</span>&nbsp;<span class="ident" id="5508678">check</span><span class="op" id="5508683">(</span><span class="ident" id="5508684">inst</span><span class="op" id="5508688">.</span><span class="ident" id="5508689">Out</span><span class="op" id="5508692">,</span>&nbsp;<span class="ident" id="5508694">m</span><span class="op" id="5508695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5508700">m</span><span class="op" id="5508701">[</span><span class="ident" id="5508702">pc</span><span class="op" id="5508704">]</span>&nbsp;<span class="op" id="5508706">=</span>&nbsp;<span class="builtintype" id="5508708">false</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5508717">if</span>&nbsp;<span class="builtinfunc" id="5508720">len</span><span class="op" id="5508723">(</span><span class="ident" id="5508724">inst</span><span class="op" id="5508728">.</span><span class="ident" id="5508729">Next</span><span class="op" id="5508733">)</span>&nbsp;<span class="op" id="5508735">&gt;</span>&nbsp;<span class="num" id="5508737">0</span>&nbsp;<span class="op" id="5508739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5508745">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5508754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5508759">onePassRunes</span><span class="op" id="5508771">[</span><span class="ident" id="5508772">pc</span><span class="op" id="5508774">]</span>&nbsp;<span class="op" id="5508776">=</span>&nbsp;<span class="builtinfunc" id="5508778">append</span><span class="op" id="5508784">(</span><span class="op" id="5508785">[</span><span class="op" id="5508786">]</span><span class="builtintype" id="5508787">rune</span><span class="op" id="5508791">{</span><span class="op" id="5508792">}</span><span class="op" id="5508793">,</span>&nbsp;<span class="ident" id="5508795">anyRuneNotNL</span><span class="op" id="5508807">...</span><span class="op" id="5508810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5508815">inst</span><span class="op" id="5508819">.</span><span class="ident" id="5508820">Next</span>&nbsp;<span class="op" id="5508825">=</span>&nbsp;<span class="op" id="5508827">[</span><span class="op" id="5508828">]</span><span class="builtintype" id="5508829">uint32</span><span class="op" id="5508835">{</span><span class="op" id="5508836">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5508841">for</span>&nbsp;<span class="ident" id="5508845">i</span>&nbsp;<span class="op" id="5508847">:=</span>&nbsp;<span class="builtinfunc" id="5508850">len</span><span class="op" id="5508853">(</span><span class="ident" id="5508854">onePassRunes</span><span class="op" id="5508866">[</span><span class="ident" id="5508867">pc</span><span class="op" id="5508869">]</span><span class="op" id="5508870">)</span>&nbsp;<span class="op" id="5508872">/</span>&nbsp;<span class="num" id="5508874">2</span><span class="op" id="5508875">;</span>&nbsp;<span class="ident" id="5508877">i</span>&nbsp;<span class="op" id="5508879">&gt;=</span>&nbsp;<span class="num" id="5508882">0</span><span class="op" id="5508883">;</span>&nbsp;<span class="ident" id="5508885">i</span><span class="op" id="5508886">--</span>&nbsp;<span class="op" id="5508889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5508895">inst</span><span class="op" id="5508899">.</span><span class="ident" id="5508900">Next</span>&nbsp;<span class="op" id="5508905">=</span>&nbsp;<span class="builtinfunc" id="5508907">append</span><span class="op" id="5508913">(</span><span class="ident" id="5508914">inst</span><span class="op" id="5508918">.</span><span class="ident" id="5508919">Next</span><span class="op" id="5508923">,</span>&nbsp;<span class="ident" id="5508925">inst</span><span class="op" id="5508929">.</span><span class="ident" id="5508930">Out</span><span class="op" id="5508933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5508938">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5508942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5508946">return</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5508954">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5508958">instQueue</span><span class="op" id="5508967">.</span><span class="ident" id="5508968">clear</span><span class="op" id="5508973">(</span><span class="op" id="5508974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5508977">instQueue</span><span class="op" id="5508986">.</span><span class="ident" id="5508987">insert</span><span class="op" id="5508993">(</span><span class="builtintype" id="5508994">uint32</span><span class="op" id="5509000">(</span><span class="ident" id="5509001">p</span><span class="op" id="5509002">.</span><span class="ident" id="5509003">Start</span><span class="op" id="5509008">)</span><span class="op" id="5509009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5509012">m</span>&nbsp;<span class="op" id="5509014">:=</span>&nbsp;<span class="builtinfunc" id="5509017">make</span><span class="op" id="5509021">(</span><span class="keyword" id="5509022">map</span><span class="op" id="5509025">[</span><span class="builtintype" id="5509026">uint32</span><span class="op" id="5509032">]</span><span class="builtintype" id="5509033">bool</span><span class="op" id="5509037">,</span>&nbsp;<span class="builtinfunc" id="5509039">len</span><span class="op" id="5509042">(</span><span class="ident" id="5509043">p</span><span class="op" id="5509044">.</span><span class="ident" id="5509045">Inst</span><span class="op" id="5509049">)</span><span class="op" id="5509050">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509053">for</span>&nbsp;<span class="op" id="5509057">!</span><span class="ident" id="5509058">instQueue</span><span class="op" id="5509067">.</span><span class="ident" id="5509068">empty</span><span class="op" id="5509073">(</span><span class="op" id="5509074">)</span>&nbsp;<span class="op" id="5509076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5509080">pc</span>&nbsp;<span class="op" id="5509083">:=</span>&nbsp;<span class="ident" id="5509086">instQueue</span><span class="op" id="5509095">.</span><span class="ident" id="5509096">next</span><span class="op" id="5509100">(</span><span class="op" id="5509101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5509105">inst</span>&nbsp;<span class="op" id="5509110">:=</span>&nbsp;<span class="ident" id="5509113">p</span><span class="op" id="5509114">.</span><span class="ident" id="5509115">Inst</span><span class="op" id="5509119">[</span><span class="ident" id="5509120">pc</span><span class="op" id="5509122">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5509126">visitQueue</span><span class="op" id="5509136">.</span><span class="ident" id="5509137">clear</span><span class="op" id="5509142">(</span><span class="op" id="5509143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509147">if</span>&nbsp;<span class="op" id="5509150">!</span><span class="ident" id="5509151">check</span><span class="op" id="5509156">(</span><span class="builtintype" id="5509157">uint32</span><span class="op" id="5509163">(</span><span class="ident" id="5509164">pc</span><span class="op" id="5509166">)</span><span class="op" id="5509167">,</span>&nbsp;<span class="ident" id="5509169">m</span><span class="op" id="5509170">)</span>&nbsp;<span class="op" id="5509172">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5509177">p</span>&nbsp;<span class="op" id="5509179">=</span>&nbsp;<span class="ident" id="5509181">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509195">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5509203">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509207">switch</span>&nbsp;<span class="ident" id="5509214">inst</span><span class="op" id="5509218">.</span><span class="ident" id="5509219">Op</span>&nbsp;<span class="op" id="5509222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509226">case</span>&nbsp;<span class="ident" id="5509231">syntax</span><span class="op" id="5509237">.</span><span class="ident" id="5509238">InstAlt</span><span class="op" id="5509245">,</span>&nbsp;<span class="ident" id="5509247">syntax</span><span class="op" id="5509253">.</span><span class="ident" id="5509254">InstAltMatch</span><span class="op" id="5509266">:</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5509271">instQueue</span><span class="op" id="5509280">.</span><span class="ident" id="5509281">insert</span><span class="op" id="5509287">(</span><span class="ident" id="5509288">inst</span><span class="op" id="5509292">.</span><span class="ident" id="5509293">Out</span><span class="op" id="5509296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5509301">instQueue</span><span class="op" id="5509310">.</span><span class="ident" id="5509311">insert</span><span class="op" id="5509317">(</span><span class="ident" id="5509318">inst</span><span class="op" id="5509322">.</span><span class="ident" id="5509323">Arg</span><span class="op" id="5509326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509330">case</span>&nbsp;<span class="ident" id="5509335">syntax</span><span class="op" id="5509341">.</span><span class="ident" id="5509342">InstCapture</span><span class="op" id="5509353">,</span>&nbsp;<span class="ident" id="5509355">syntax</span><span class="op" id="5509361">.</span><span class="ident" id="5509362">InstEmptyWidth</span><span class="op" id="5509376">,</span>&nbsp;<span class="ident" id="5509378">syntax</span><span class="op" id="5509384">.</span><span class="ident" id="5509385">InstNop</span><span class="op" id="5509392">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5509397">instQueue</span><span class="op" id="5509406">.</span><span class="ident" id="5509407">insert</span><span class="op" id="5509413">(</span><span class="ident" id="5509414">inst</span><span class="op" id="5509418">.</span><span class="ident" id="5509419">Out</span><span class="op" id="5509422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509426">case</span>&nbsp;<span class="ident" id="5509431">syntax</span><span class="op" id="5509437">.</span><span class="ident" id="5509438">InstMatch</span><span class="op" id="5509447">:</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509451">case</span>&nbsp;<span class="ident" id="5509456">syntax</span><span class="op" id="5509462">.</span><span class="ident" id="5509463">InstFail</span><span class="op" id="5509471">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509475">case</span>&nbsp;<span class="ident" id="5509480">syntax</span><span class="op" id="5509486">.</span><span class="ident" id="5509487">InstRune</span><span class="op" id="5509495">,</span>&nbsp;<span class="ident" id="5509497">syntax</span><span class="op" id="5509503">.</span><span class="ident" id="5509504">InstRune1</span><span class="op" id="5509513">,</span>&nbsp;<span class="ident" id="5509515">syntax</span><span class="op" id="5509521">.</span><span class="ident" id="5509522">InstRuneAny</span><span class="op" id="5509533">,</span>&nbsp;<span class="ident" id="5509535">syntax</span><span class="op" id="5509541">.</span><span class="ident" id="5509542">InstRuneAnyNotNL</span><span class="op" id="5509558">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509562">default</span><span class="op" id="5509569">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5509573">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5509576">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509579">if</span>&nbsp;<span class="ident" id="5509582">p</span>&nbsp;<span class="op" id="5509584">!=</span>&nbsp;<span class="ident" id="5509587">notOnePass</span>&nbsp;<span class="op" id="5509598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509602">for</span>&nbsp;<span class="ident" id="5509606">i</span>&nbsp;<span class="op" id="5509608">:=</span>&nbsp;<span class="keyword" id="5509611">range</span>&nbsp;<span class="ident" id="5509617">p</span><span class="op" id="5509618">.</span><span class="ident" id="5509619">Inst</span>&nbsp;<span class="op" id="5509624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5509629">p</span><span class="op" id="5509630">.</span><span class="ident" id="5509631">Inst</span><span class="op" id="5509635">[</span><span class="ident" id="5509636">i</span><span class="op" id="5509637">]</span><span class="op" id="5509638">.</span><span class="ident" id="5509639">Rune</span>&nbsp;<span class="op" id="5509644">=</span>&nbsp;<span class="ident" id="5509646">onePassRunes</span><span class="op" id="5509658">[</span><span class="ident" id="5509659">i</span><span class="op" id="5509660">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5509664">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5509667">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509670">return</span>&nbsp;<span class="ident" id="5509677">p</span><br>
<span class="lineno"></span><span class="op" id="5509679">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5509682">//&nbsp;walk&nbsp;visits&nbsp;each&nbsp;Inst&nbsp;in&nbsp;the&nbsp;prog&nbsp;once,&nbsp;and&nbsp;applies&nbsp;the&nbsp;argument</span><br>
<span class="lineno"></span><span class="comment" id="5509750">//&nbsp;function(ip,&nbsp;next),&nbsp;in&nbsp;pre-order.</span><br>
<span class="lineno">495</span><span class="keyword" id="5509787">func</span>&nbsp;<span class="ident" id="5509792">walk</span><span class="op" id="5509796">(</span><span class="ident" id="5509797">prog</span>&nbsp;<span class="op" id="5509802">*</span><span class="ident" id="5509803">syntax</span><span class="op" id="5509809">.</span><span class="ident" id="5509810">Prog</span><span class="op" id="5509814">,</span>&nbsp;<span class="ident" id="5509816">funcs</span>&nbsp;<span class="op" id="5509822">...</span><span class="keyword" id="5509825">func</span><span class="op" id="5509829">(</span><span class="ident" id="5509830">ip</span><span class="op" id="5509832">,</span>&nbsp;<span class="ident" id="5509834">next</span>&nbsp;<span class="builtintype" id="5509839">uint32</span><span class="op" id="5509845">)</span><span class="op" id="5509846">)</span>&nbsp;<span class="op" id="5509848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509851">var</span>&nbsp;<span class="ident" id="5509855">walk1</span>&nbsp;<span class="keyword" id="5509861">func</span><span class="op" id="5509865">(</span><span class="builtintype" id="5509866">uint32</span><span class="op" id="5509872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5509875">progQueue</span>&nbsp;<span class="op" id="5509885">:=</span>&nbsp;<span class="ident" id="5509888">newQueue</span><span class="op" id="5509896">(</span><span class="builtinfunc" id="5509897">len</span><span class="op" id="5509900">(</span><span class="ident" id="5509901">prog</span><span class="op" id="5509905">.</span><span class="ident" id="5509906">Inst</span><span class="op" id="5509910">)</span><span class="op" id="5509911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5509914">walk1</span>&nbsp;<span class="op" id="5509920">=</span>&nbsp;<span class="keyword" id="5509922">func</span><span class="op" id="5509926">(</span><span class="ident" id="5509927">ip</span>&nbsp;<span class="builtintype" id="5509930">uint32</span><span class="op" id="5509936">)</span>&nbsp;<span class="op" id="5509938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509942">if</span>&nbsp;<span class="ident" id="5509945">progQueue</span><span class="op" id="5509954">.</span><span class="ident" id="5509955">contains</span><span class="op" id="5509963">(</span><span class="ident" id="5509964">ip</span><span class="op" id="5509966">)</span>&nbsp;<span class="op" id="5509968">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509973">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5509982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5509986">progQueue</span><span class="op" id="5509995">.</span><span class="ident" id="5509996">insert</span><span class="op" id="5510002">(</span><span class="ident" id="5510003">ip</span><span class="op" id="5510005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510009">inst</span>&nbsp;<span class="op" id="5510014">:=</span>&nbsp;<span class="ident" id="5510017">prog</span><span class="op" id="5510021">.</span><span class="ident" id="5510022">Inst</span><span class="op" id="5510026">[</span><span class="ident" id="5510027">ip</span><span class="op" id="5510029">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5510033">switch</span>&nbsp;<span class="ident" id="5510040">inst</span><span class="op" id="5510044">.</span><span class="ident" id="5510045">Op</span>&nbsp;<span class="op" id="5510048">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5510052">case</span>&nbsp;<span class="ident" id="5510057">syntax</span><span class="op" id="5510063">.</span><span class="ident" id="5510064">InstAlt</span><span class="op" id="5510071">,</span>&nbsp;<span class="ident" id="5510073">syntax</span><span class="op" id="5510079">.</span><span class="ident" id="5510080">InstAltMatch</span><span class="op" id="5510092">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5510097">for</span>&nbsp;<span class="ident" id="5510101">_</span><span class="op" id="5510102">,</span>&nbsp;<span class="ident" id="5510104">f</span>&nbsp;<span class="op" id="5510106">:=</span>&nbsp;<span class="keyword" id="5510109">range</span>&nbsp;<span class="ident" id="5510115">funcs</span>&nbsp;<span class="op" id="5510121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510127">f</span><span class="op" id="5510128">(</span><span class="ident" id="5510129">ip</span><span class="op" id="5510131">,</span>&nbsp;<span class="ident" id="5510133">inst</span><span class="op" id="5510137">.</span><span class="ident" id="5510138">Out</span><span class="op" id="5510141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510147">f</span><span class="op" id="5510148">(</span><span class="ident" id="5510149">ip</span><span class="op" id="5510151">,</span>&nbsp;<span class="ident" id="5510153">inst</span><span class="op" id="5510157">.</span><span class="ident" id="5510158">Arg</span><span class="op" id="5510161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5510166">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510171">walk1</span><span class="op" id="5510176">(</span><span class="ident" id="5510177">inst</span><span class="op" id="5510181">.</span><span class="ident" id="5510182">Out</span><span class="op" id="5510185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510190">walk1</span><span class="op" id="5510195">(</span><span class="ident" id="5510196">inst</span><span class="op" id="5510200">.</span><span class="ident" id="5510201">Arg</span><span class="op" id="5510204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5510208">default</span><span class="op" id="5510215">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5510220">for</span>&nbsp;<span class="ident" id="5510224">_</span><span class="op" id="5510225">,</span>&nbsp;<span class="ident" id="5510227">f</span>&nbsp;<span class="op" id="5510229">:=</span>&nbsp;<span class="keyword" id="5510232">range</span>&nbsp;<span class="ident" id="5510238">funcs</span>&nbsp;<span class="op" id="5510244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510250">f</span><span class="op" id="5510251">(</span><span class="ident" id="5510252">ip</span><span class="op" id="5510254">,</span>&nbsp;<span class="ident" id="5510256">inst</span><span class="op" id="5510260">.</span><span class="ident" id="5510261">Out</span><span class="op" id="5510264">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5510269">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510274">walk1</span><span class="op" id="5510279">(</span><span class="ident" id="5510280">inst</span><span class="op" id="5510284">.</span><span class="ident" id="5510285">Out</span><span class="op" id="5510288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5510292">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5510295">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510298">walk1</span><span class="op" id="5510303">(</span><span class="builtintype" id="5510304">uint32</span><span class="op" id="5510310">(</span><span class="ident" id="5510311">prog</span><span class="op" id="5510315">.</span><span class="ident" id="5510316">Start</span><span class="op" id="5510321">)</span><span class="op" id="5510322">)</span><br>
<span class="lineno">520</span><span class="op" id="5510324">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5510327">//&nbsp;find&nbsp;returns&nbsp;the&nbsp;Insts&nbsp;that&nbsp;match&nbsp;the&nbsp;argument&nbsp;predicate&nbsp;function</span><br>
<span class="lineno"></span><span class="keyword" id="5510396">func</span>&nbsp;<span class="ident" id="5510401">find</span><span class="op" id="5510405">(</span><span class="ident" id="5510406">prog</span>&nbsp;<span class="op" id="5510411">*</span><span class="ident" id="5510412">syntax</span><span class="op" id="5510418">.</span><span class="ident" id="5510419">Prog</span><span class="op" id="5510423">,</span>&nbsp;<span class="ident" id="5510425">f</span>&nbsp;<span class="keyword" id="5510427">func</span><span class="op" id="5510431">(</span><span class="op" id="5510432">*</span><span class="ident" id="5510433">syntax</span><span class="op" id="5510439">.</span><span class="ident" id="5510440">Prog</span><span class="op" id="5510444">,</span>&nbsp;<span class="builtintype" id="5510446">int</span><span class="op" id="5510449">)</span>&nbsp;<span class="builtintype" id="5510451">bool</span><span class="op" id="5510455">)</span>&nbsp;<span class="op" id="5510457">(</span><span class="ident" id="5510458">matches</span>&nbsp;<span class="op" id="5510466">[</span><span class="op" id="5510467">]</span><span class="builtintype" id="5510468">uint32</span><span class="op" id="5510474">)</span>&nbsp;<span class="op" id="5510476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510479">matches</span>&nbsp;<span class="op" id="5510487">=</span>&nbsp;<span class="op" id="5510489">[</span><span class="op" id="5510490">]</span><span class="builtintype" id="5510491">uint32</span><span class="op" id="5510497">{</span><span class="op" id="5510498">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5510502">for</span>&nbsp;<span class="ident" id="5510506">ip</span>&nbsp;<span class="op" id="5510509">:=</span>&nbsp;<span class="keyword" id="5510512">range</span>&nbsp;<span class="ident" id="5510518">prog</span><span class="op" id="5510522">.</span><span class="ident" id="5510523">Inst</span>&nbsp;<span class="op" id="5510528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5510532">if</span>&nbsp;<span class="ident" id="5510535">f</span><span class="op" id="5510536">(</span><span class="ident" id="5510537">prog</span><span class="op" id="5510541">,</span>&nbsp;<span class="ident" id="5510543">ip</span><span class="op" id="5510545">)</span>&nbsp;<span class="op" id="5510547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510552">matches</span>&nbsp;<span class="op" id="5510560">=</span>&nbsp;<span class="builtinfunc" id="5510562">append</span><span class="op" id="5510568">(</span><span class="ident" id="5510569">matches</span><span class="op" id="5510576">,</span>&nbsp;<span class="builtintype" id="5510578">uint32</span><span class="op" id="5510584">(</span><span class="ident" id="5510585">ip</span><span class="op" id="5510587">)</span><span class="op" id="5510588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5510592">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5510595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5510598">return</span><br>
<span class="lineno"></span><span class="op" id="5510605">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5510608">var</span>&nbsp;<span class="ident" id="5510612">notOnePass</span>&nbsp;<span class="op" id="5510623">*</span><span class="ident" id="5510624">onePassProg</span>&nbsp;<span class="op" id="5510636">=</span>&nbsp;<span class="ident" id="5510638">nil</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span><span class="comment" id="5510643">//&nbsp;compileOnePass&nbsp;returns&nbsp;a&nbsp;new&nbsp;*syntax.Prog&nbsp;suitable&nbsp;for&nbsp;onePass&nbsp;execution&nbsp;if&nbsp;the&nbsp;original&nbsp;Prog</span><br>
<span class="lineno"></span><span class="comment" id="5510740">//&nbsp;can&nbsp;be&nbsp;recharacterized&nbsp;as&nbsp;a&nbsp;one-pass&nbsp;regexp&nbsp;program,&nbsp;or&nbsp;syntax.notOnePass&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5510824">//&nbsp;Prog&nbsp;cannot&nbsp;be&nbsp;converted.&nbsp;For&nbsp;a&nbsp;one&nbsp;pass&nbsp;prog,&nbsp;the&nbsp;fundamental&nbsp;condition&nbsp;that&nbsp;must</span><br>
<span class="lineno"></span><span class="comment" id="5510910">//&nbsp;be&nbsp;true&nbsp;is:&nbsp;at&nbsp;any&nbsp;InstAlt,&nbsp;there&nbsp;must&nbsp;be&nbsp;no&nbsp;ambiguity&nbsp;about&nbsp;what&nbsp;branch&nbsp;to&nbsp;&nbsp;take.</span><br>
<span class="lineno">540</span><span class="keyword" id="5510996">func</span>&nbsp;<span class="ident" id="5511001">compileOnePass</span><span class="op" id="5511015">(</span><span class="ident" id="5511016">prog</span>&nbsp;<span class="op" id="5511021">*</span><span class="ident" id="5511022">syntax</span><span class="op" id="5511028">.</span><span class="ident" id="5511029">Prog</span><span class="op" id="5511033">)</span>&nbsp;<span class="op" id="5511035">(</span><span class="ident" id="5511036">p</span>&nbsp;<span class="op" id="5511038">*</span><span class="ident" id="5511039">onePassProg</span><span class="op" id="5511050">)</span>&nbsp;<span class="op" id="5511052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5511055">if</span>&nbsp;<span class="ident" id="5511058">prog</span><span class="op" id="5511062">.</span><span class="ident" id="5511063">Start</span>&nbsp;<span class="op" id="5511069">==</span>&nbsp;<span class="num" id="5511072">0</span>&nbsp;<span class="op" id="5511074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5511078">return</span>&nbsp;<span class="ident" id="5511085">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5511097">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5511100">//&nbsp;onepass&nbsp;regexp&nbsp;is&nbsp;anchored</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5511131">if</span>&nbsp;<span class="ident" id="5511134">prog</span><span class="op" id="5511138">.</span><span class="ident" id="5511139">Inst</span><span class="op" id="5511143">[</span><span class="ident" id="5511144">prog</span><span class="op" id="5511148">.</span><span class="ident" id="5511149">Start</span><span class="op" id="5511154">]</span><span class="op" id="5511155">.</span><span class="ident" id="5511156">Op</span>&nbsp;<span class="op" id="5511159">!=</span>&nbsp;<span class="ident" id="5511162">syntax</span><span class="op" id="5511168">.</span><span class="ident" id="5511169">InstEmptyWidth</span>&nbsp;<span class="op" id="5511184">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5511189">syntax</span><span class="op" id="5511195">.</span><span class="ident" id="5511196">EmptyOp</span><span class="op" id="5511203">(</span><span class="ident" id="5511204">prog</span><span class="op" id="5511208">.</span><span class="ident" id="5511209">Inst</span><span class="op" id="5511213">[</span><span class="ident" id="5511214">prog</span><span class="op" id="5511218">.</span><span class="ident" id="5511219">Start</span><span class="op" id="5511224">]</span><span class="op" id="5511225">.</span><span class="ident" id="5511226">Arg</span><span class="op" id="5511229">)</span><span class="op" id="5511230">&amp;</span><span class="ident" id="5511231">syntax</span><span class="op" id="5511237">.</span><span class="ident" id="5511238">EmptyBeginText</span>&nbsp;<span class="op" id="5511253">!=</span>&nbsp;<span class="ident" id="5511256">syntax</span><span class="op" id="5511262">.</span><span class="ident" id="5511263">EmptyBeginText</span>&nbsp;<span class="op" id="5511278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5511282">return</span>&nbsp;<span class="ident" id="5511289">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5511301">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5511304">//&nbsp;every&nbsp;instruction&nbsp;leading&nbsp;to&nbsp;InstMatch&nbsp;must&nbsp;be&nbsp;EmptyEndText</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5511368">for</span>&nbsp;<span class="ident" id="5511372">_</span><span class="op" id="5511373">,</span>&nbsp;<span class="ident" id="5511375">inst</span>&nbsp;<span class="op" id="5511380">:=</span>&nbsp;<span class="keyword" id="5511383">range</span>&nbsp;<span class="ident" id="5511389">prog</span><span class="op" id="5511393">.</span><span class="ident" id="5511394">Inst</span>&nbsp;<span class="op" id="5511399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5511403">opOut</span>&nbsp;<span class="op" id="5511409">:=</span>&nbsp;<span class="ident" id="5511412">prog</span><span class="op" id="5511416">.</span><span class="ident" id="5511417">Inst</span><span class="op" id="5511421">[</span><span class="ident" id="5511422">inst</span><span class="op" id="5511426">.</span><span class="ident" id="5511427">Out</span><span class="op" id="5511430">]</span><span class="op" id="5511431">.</span><span class="ident" id="5511432">Op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5511437">switch</span>&nbsp;<span class="ident" id="5511444">inst</span><span class="op" id="5511448">.</span><span class="ident" id="5511449">Op</span>&nbsp;<span class="op" id="5511452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5511456">default</span><span class="op" id="5511463">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5511468">if</span>&nbsp;<span class="ident" id="5511471">opOut</span>&nbsp;<span class="op" id="5511477">==</span>&nbsp;<span class="ident" id="5511480">syntax</span><span class="op" id="5511486">.</span><span class="ident" id="5511487">InstMatch</span>&nbsp;<span class="op" id="5511497">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5511503">return</span>&nbsp;<span class="ident" id="5511510">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5511524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5511528">case</span>&nbsp;<span class="ident" id="5511533">syntax</span><span class="op" id="5511539">.</span><span class="ident" id="5511540">InstAlt</span><span class="op" id="5511547">,</span>&nbsp;<span class="ident" id="5511549">syntax</span><span class="op" id="5511555">.</span><span class="ident" id="5511556">InstAltMatch</span><span class="op" id="5511568">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5511573">if</span>&nbsp;<span class="ident" id="5511576">opOut</span>&nbsp;<span class="op" id="5511582">==</span>&nbsp;<span class="ident" id="5511585">syntax</span><span class="op" id="5511591">.</span><span class="ident" id="5511592">InstMatch</span>&nbsp;<span class="op" id="5511602">||</span>&nbsp;<span class="ident" id="5511605">prog</span><span class="op" id="5511609">.</span><span class="ident" id="5511610">Inst</span><span class="op" id="5511614">[</span><span class="ident" id="5511615">inst</span><span class="op" id="5511619">.</span><span class="ident" id="5511620">Arg</span><span class="op" id="5511623">]</span><span class="op" id="5511624">.</span><span class="ident" id="5511625">Op</span>&nbsp;<span class="op" id="5511628">==</span>&nbsp;<span class="ident" id="5511631">syntax</span><span class="op" id="5511637">.</span><span class="ident" id="5511638">InstMatch</span>&nbsp;<span class="op" id="5511648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5511654">return</span>&nbsp;<span class="ident" id="5511661">notOnePass</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5511675">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5511679">case</span>&nbsp;<span class="ident" id="5511684">syntax</span><span class="op" id="5511690">.</span><span class="ident" id="5511691">InstEmptyWidth</span><span class="op" id="5511705">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5511710">if</span>&nbsp;<span class="ident" id="5511713">opOut</span>&nbsp;<span class="op" id="5511719">==</span>&nbsp;<span class="ident" id="5511722">syntax</span><span class="op" id="5511728">.</span><span class="ident" id="5511729">InstMatch</span>&nbsp;<span class="op" id="5511739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5511745">if</span>&nbsp;<span class="ident" id="5511748">syntax</span><span class="op" id="5511754">.</span><span class="ident" id="5511755">EmptyOp</span><span class="op" id="5511762">(</span><span class="ident" id="5511763">inst</span><span class="op" id="5511767">.</span><span class="ident" id="5511768">Arg</span><span class="op" id="5511771">)</span><span class="op" id="5511772">&amp;</span><span class="ident" id="5511773">syntax</span><span class="op" id="5511779">.</span><span class="ident" id="5511780">EmptyEndText</span>&nbsp;<span class="op" id="5511793">==</span>&nbsp;<span class="ident" id="5511796">syntax</span><span class="op" id="5511802">.</span><span class="ident" id="5511803">EmptyEndText</span>&nbsp;<span class="op" id="5511816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5511823">continue</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5511836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5511842">return</span>&nbsp;<span class="ident" id="5511849">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5511863">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5511867">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5511870">}</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5511873">//&nbsp;Creates&nbsp;a&nbsp;slightly&nbsp;optimized&nbsp;copy&nbsp;of&nbsp;the&nbsp;original&nbsp;Prog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5511932">//&nbsp;that&nbsp;cleans&nbsp;up&nbsp;some&nbsp;Prog&nbsp;idioms&nbsp;that&nbsp;block&nbsp;valid&nbsp;onepass&nbsp;programs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5512002">p</span>&nbsp;<span class="op" id="5512004">=</span>&nbsp;<span class="ident" id="5512006">onePassCopy</span><span class="op" id="5512017">(</span><span class="ident" id="5512018">prog</span><span class="op" id="5512022">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5512026">//&nbsp;checkAmbiguity&nbsp;on&nbsp;InstAlts,&nbsp;build&nbsp;onepass&nbsp;Prog&nbsp;if&nbsp;possible</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5512089">p</span>&nbsp;<span class="op" id="5512091">=</span>&nbsp;<span class="ident" id="5512093">makeOnePass</span><span class="op" id="5512104">(</span><span class="ident" id="5512105">p</span><span class="op" id="5512106">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5512110">if</span>&nbsp;<span class="ident" id="5512113">p</span>&nbsp;<span class="op" id="5512115">!=</span>&nbsp;<span class="ident" id="5512118">notOnePass</span>&nbsp;<span class="op" id="5512129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5512133">cleanupOnePass</span><span class="op" id="5512147">(</span><span class="ident" id="5512148">p</span><span class="op" id="5512149">,</span>&nbsp;<span class="ident" id="5512151">prog</span><span class="op" id="5512155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5512158">}</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5512161">return</span>&nbsp;<span class="ident" id="5512168">p</span><br>
<span class="lineno"></span><span class="op" id="5512170">}</span>
</div>
</body>
</html>
