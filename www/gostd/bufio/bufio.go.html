<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>bufio</h2>
<ul>
<li><a href="/gostd/bufio/bufio.go.html">bufio.go</a></li>
<li><a href="/gostd/bufio/bufio_test.go.html">bufio_test.go</a></li>
<li><a href="/gostd/bufio/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/bufio/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/bufio/scan.go.html">scan.go</a></li>
<li><a href="/gostd/bufio/scan_test.go.html">scan_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3079384">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3079439">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3079493">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3079544">//&nbsp;Package&nbsp;bufio&nbsp;implements&nbsp;buffered&nbsp;I/O.&nbsp;&nbsp;It&nbsp;wraps&nbsp;an&nbsp;io.Reader&nbsp;or&nbsp;io.Writer</span><br>
<span class="lineno"></span><span class="comment" id="3079622">//&nbsp;object,&nbsp;creating&nbsp;another&nbsp;object&nbsp;(Reader&nbsp;or&nbsp;Writer)&nbsp;that&nbsp;also&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="3079697">//&nbsp;the&nbsp;interface&nbsp;but&nbsp;provides&nbsp;buffering&nbsp;and&nbsp;some&nbsp;help&nbsp;for&nbsp;textual&nbsp;I/O.</span><br>
<span class="lineno"></span><span class="keyword" id="3079768">package</span>&nbsp;<span class="ident" id="3079776">bufio</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="3079783">import</span>&nbsp;<span class="op" id="3079790">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3079793">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3079802">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3079812">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3079818">&#34;unicode/utf8&#34;</span><br>
<span class="lineno">15</span><span class="op" id="3079833">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3079836">const</span>&nbsp;<span class="op" id="3079842">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3079845">defaultBufSize</span>&nbsp;<span class="op" id="3079860">=</span>&nbsp;<span class="num" id="3079862">4096</span><br>
<span class="lineno"></span><span class="op" id="3079867">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="3079870">var</span>&nbsp;<span class="op" id="3079874">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3079877">ErrInvalidUnreadByte</span>&nbsp;<span class="op" id="3079898">=</span>&nbsp;<span class="ident" id="3079900">errors</span><span class="op" id="3079906">.</span><span class="ident" id="3079907">New</span><span class="op" id="3079910">(</span><span class="string" id="3079911">&#34;bufio:&nbsp;invalid&nbsp;use&nbsp;of&nbsp;UnreadByte&#34;</span><span class="op" id="3079945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3079948">ErrInvalidUnreadRune</span>&nbsp;<span class="op" id="3079969">=</span>&nbsp;<span class="ident" id="3079971">errors</span><span class="op" id="3079977">.</span><span class="ident" id="3079978">New</span><span class="op" id="3079981">(</span><span class="string" id="3079982">&#34;bufio:&nbsp;invalid&nbsp;use&nbsp;of&nbsp;UnreadRune&#34;</span><span class="op" id="3080016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3080019">ErrBufferFull</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3080040">=</span>&nbsp;<span class="ident" id="3080042">errors</span><span class="op" id="3080048">.</span><span class="ident" id="3080049">New</span><span class="op" id="3080052">(</span><span class="string" id="3080053">&#34;bufio:&nbsp;buffer&nbsp;full&#34;</span><span class="op" id="3080073">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3080076">ErrNegativeCount</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3080097">=</span>&nbsp;<span class="ident" id="3080099">errors</span><span class="op" id="3080105">.</span><span class="ident" id="3080106">New</span><span class="op" id="3080109">(</span><span class="string" id="3080110">&#34;bufio:&nbsp;negative&nbsp;count&#34;</span><span class="op" id="3080133">)</span><br>
<span class="lineno"></span><span class="op" id="3080135">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3080138">//&nbsp;Buffered&nbsp;input.</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="comment" id="3080158">//&nbsp;Reader&nbsp;implements&nbsp;buffering&nbsp;for&nbsp;an&nbsp;io.Reader&nbsp;object.</span><br>
<span class="lineno"></span><span class="keyword" id="3080214">type</span>&nbsp;<span class="ident" id="3080219">Reader</span>&nbsp;<span class="keyword" id="3080226">struct</span>&nbsp;<span class="op" id="3080233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3080236">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3080249">[</span><span class="op" id="3080250">]</span><span class="builtintype" id="3080251">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3080257">rd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3080270">io</span><span class="op" id="3080272">.</span><span class="ident" id="3080273">Reader</span>&nbsp;<span class="comment" id="3080280">//&nbsp;reader&nbsp;provided&nbsp;by&nbsp;the&nbsp;client</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3080314">r</span><span class="op" id="3080315">,</span>&nbsp;<span class="ident" id="3080317">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3080327">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3080337">//&nbsp;buf&nbsp;read&nbsp;and&nbsp;write&nbsp;positions</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3080370">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3080383">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3080390">lastByte</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3080403">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3080408">lastRuneSize</span>&nbsp;<span class="builtintype" id="3080421">int</span><br>
<span class="lineno"></span><span class="op" id="3080425">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="3080428">const</span>&nbsp;<span class="ident" id="3080434">minReadBufferSize</span>&nbsp;<span class="op" id="3080452">=</span>&nbsp;<span class="num" id="3080454">16</span><br>
<span class="lineno"></span><span class="keyword" id="3080457">const</span>&nbsp;<span class="ident" id="3080463">maxConsecutiveEmptyReads</span>&nbsp;<span class="op" id="3080488">=</span>&nbsp;<span class="num" id="3080490">100</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3080495">//&nbsp;NewReaderSize&nbsp;returns&nbsp;a&nbsp;new&nbsp;Reader&nbsp;whose&nbsp;buffer&nbsp;has&nbsp;at&nbsp;least&nbsp;the&nbsp;specified</span><br>
<span class="lineno"></span><span class="comment" id="3080573">//&nbsp;size.&nbsp;If&nbsp;the&nbsp;argument&nbsp;io.Reader&nbsp;is&nbsp;already&nbsp;a&nbsp;Reader&nbsp;with&nbsp;large&nbsp;enough</span><br>
<span class="lineno">45</span><span class="comment" id="3080646">//&nbsp;size,&nbsp;it&nbsp;returns&nbsp;the&nbsp;underlying&nbsp;Reader.</span><br>
<span class="lineno"></span><span class="keyword" id="3080689">func</span>&nbsp;<span class="ident" id="3080694">NewReaderSize</span><span class="op" id="3080707">(</span><span class="ident" id="3080708">rd</span>&nbsp;<span class="ident" id="3080711">io</span><span class="op" id="3080713">.</span><span class="ident" id="3080714">Reader</span><span class="op" id="3080720">,</span>&nbsp;<span class="ident" id="3080722">size</span>&nbsp;<span class="builtintype" id="3080727">int</span><span class="op" id="3080730">)</span>&nbsp;<span class="op" id="3080732">*</span><span class="ident" id="3080733">Reader</span>&nbsp;<span class="op" id="3080740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3080743">//&nbsp;Is&nbsp;it&nbsp;already&nbsp;a&nbsp;Reader?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3080771">b</span><span class="op" id="3080772">,</span>&nbsp;<span class="ident" id="3080774">ok</span>&nbsp;<span class="op" id="3080777">:=</span>&nbsp;<span class="ident" id="3080780">rd</span><span class="op" id="3080782">.</span><span class="op" id="3080783">(</span><span class="op" id="3080784">*</span><span class="ident" id="3080785">Reader</span><span class="op" id="3080791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3080794">if</span>&nbsp;<span class="ident" id="3080797">ok</span>&nbsp;<span class="op" id="3080800">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3080803">len</span><span class="op" id="3080806">(</span><span class="ident" id="3080807">b</span><span class="op" id="3080808">.</span><span class="ident" id="3080809">buf</span><span class="op" id="3080812">)</span>&nbsp;<span class="op" id="3080814">&gt;=</span>&nbsp;<span class="ident" id="3080817">size</span>&nbsp;<span class="op" id="3080822">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3080826">return</span>&nbsp;<span class="ident" id="3080833">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3080836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3080839">if</span>&nbsp;<span class="ident" id="3080842">size</span>&nbsp;<span class="op" id="3080847">&lt;</span>&nbsp;<span class="ident" id="3080849">minReadBufferSize</span>&nbsp;<span class="op" id="3080867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3080871">size</span>&nbsp;<span class="op" id="3080876">=</span>&nbsp;<span class="ident" id="3080878">minReadBufferSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3080897">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3080900">r</span>&nbsp;<span class="op" id="3080902">:=</span>&nbsp;<span class="builtinfunc" id="3080905">new</span><span class="op" id="3080908">(</span><span class="ident" id="3080909">Reader</span><span class="op" id="3080915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3080918">r</span><span class="op" id="3080919">.</span><span class="ident" id="3080920">reset</span><span class="op" id="3080925">(</span><span class="builtinfunc" id="3080926">make</span><span class="op" id="3080930">(</span><span class="op" id="3080931">[</span><span class="op" id="3080932">]</span><span class="builtintype" id="3080933">byte</span><span class="op" id="3080937">,</span>&nbsp;<span class="ident" id="3080939">size</span><span class="op" id="3080943">)</span><span class="op" id="3080944">,</span>&nbsp;<span class="ident" id="3080946">rd</span><span class="op" id="3080948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3080951">return</span>&nbsp;<span class="ident" id="3080958">r</span><br>
<span class="lineno"></span><span class="op" id="3080960">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="3080963">//&nbsp;NewReader&nbsp;returns&nbsp;a&nbsp;new&nbsp;Reader&nbsp;whose&nbsp;buffer&nbsp;has&nbsp;the&nbsp;default&nbsp;size.</span><br>
<span class="lineno"></span><span class="keyword" id="3081032">func</span>&nbsp;<span class="ident" id="3081037">NewReader</span><span class="op" id="3081046">(</span><span class="ident" id="3081047">rd</span>&nbsp;<span class="ident" id="3081050">io</span><span class="op" id="3081052">.</span><span class="ident" id="3081053">Reader</span><span class="op" id="3081059">)</span>&nbsp;<span class="op" id="3081061">*</span><span class="ident" id="3081062">Reader</span>&nbsp;<span class="op" id="3081069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3081072">return</span>&nbsp;<span class="ident" id="3081079">NewReaderSize</span><span class="op" id="3081092">(</span><span class="ident" id="3081093">rd</span><span class="op" id="3081095">,</span>&nbsp;<span class="ident" id="3081097">defaultBufSize</span><span class="op" id="3081111">)</span><br>
<span class="lineno"></span><span class="op" id="3081113">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="3081116">//&nbsp;Reset&nbsp;discards&nbsp;any&nbsp;buffered&nbsp;data,&nbsp;resets&nbsp;all&nbsp;state,&nbsp;and&nbsp;switches</span><br>
<span class="lineno"></span><span class="comment" id="3081184">//&nbsp;the&nbsp;buffered&nbsp;reader&nbsp;to&nbsp;read&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="3081223">func</span>&nbsp;<span class="op" id="3081228">(</span><span class="ident" id="3081229">b</span>&nbsp;<span class="op" id="3081231">*</span><span class="ident" id="3081232">Reader</span><span class="op" id="3081238">)</span>&nbsp;<span class="ident" id="3081240">Reset</span><span class="op" id="3081245">(</span><span class="ident" id="3081246">r</span>&nbsp;<span class="ident" id="3081248">io</span><span class="op" id="3081250">.</span><span class="ident" id="3081251">Reader</span><span class="op" id="3081257">)</span>&nbsp;<span class="op" id="3081259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3081262">b</span><span class="op" id="3081263">.</span><span class="ident" id="3081264">reset</span><span class="op" id="3081269">(</span><span class="ident" id="3081270">b</span><span class="op" id="3081271">.</span><span class="ident" id="3081272">buf</span><span class="op" id="3081275">,</span>&nbsp;<span class="ident" id="3081277">r</span><span class="op" id="3081278">)</span><br>
<span class="lineno"></span><span class="op" id="3081280">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="3081283">func</span>&nbsp;<span class="op" id="3081288">(</span><span class="ident" id="3081289">b</span>&nbsp;<span class="op" id="3081291">*</span><span class="ident" id="3081292">Reader</span><span class="op" id="3081298">)</span>&nbsp;<span class="ident" id="3081300">reset</span><span class="op" id="3081305">(</span><span class="ident" id="3081306">buf</span>&nbsp;<span class="op" id="3081310">[</span><span class="op" id="3081311">]</span><span class="builtintype" id="3081312">byte</span><span class="op" id="3081316">,</span>&nbsp;<span class="ident" id="3081318">r</span>&nbsp;<span class="ident" id="3081320">io</span><span class="op" id="3081322">.</span><span class="ident" id="3081323">Reader</span><span class="op" id="3081329">)</span>&nbsp;<span class="op" id="3081331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3081334">*</span><span class="ident" id="3081335">b</span>&nbsp;<span class="op" id="3081337">=</span>&nbsp;<span class="ident" id="3081339">Reader</span><span class="op" id="3081345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3081349">buf</span><span class="op" id="3081352">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3081363">buf</span><span class="op" id="3081366">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3081370">rd</span><span class="op" id="3081372">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3081384">r</span><span class="op" id="3081385">,</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3081389">lastByte</span><span class="op" id="3081397">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3081403">-</span><span class="num" id="3081404">1</span><span class="op" id="3081405">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3081409">lastRuneSize</span><span class="op" id="3081421">:</span>&nbsp;<span class="op" id="3081423">-</span><span class="num" id="3081424">1</span><span class="op" id="3081425">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3081428">}</span><br>
<span class="lineno"></span><span class="op" id="3081430">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="keyword" id="3081433">var</span>&nbsp;<span class="ident" id="3081437">errNegativeRead</span>&nbsp;<span class="op" id="3081453">=</span>&nbsp;<span class="ident" id="3081455">errors</span><span class="op" id="3081461">.</span><span class="ident" id="3081462">New</span><span class="op" id="3081465">(</span><span class="string" id="3081466">&#34;bufio:&nbsp;reader&nbsp;returned&nbsp;negative&nbsp;count&nbsp;from&nbsp;Read&#34;</span><span class="op" id="3081515">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3081518">//&nbsp;fill&nbsp;reads&nbsp;a&nbsp;new&nbsp;chunk&nbsp;into&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="3081561">func</span>&nbsp;<span class="op" id="3081566">(</span><span class="ident" id="3081567">b</span>&nbsp;<span class="op" id="3081569">*</span><span class="ident" id="3081570">Reader</span><span class="op" id="3081576">)</span>&nbsp;<span class="ident" id="3081578">fill</span><span class="op" id="3081582">(</span><span class="op" id="3081583">)</span>&nbsp;<span class="op" id="3081585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3081588">//&nbsp;Slide&nbsp;existing&nbsp;data&nbsp;to&nbsp;beginning.</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3081626">if</span>&nbsp;<span class="ident" id="3081629">b</span><span class="op" id="3081630">.</span><span class="ident" id="3081631">r</span>&nbsp;<span class="op" id="3081633">&gt;</span>&nbsp;<span class="num" id="3081635">0</span>&nbsp;<span class="op" id="3081637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3081641">copy</span><span class="op" id="3081645">(</span><span class="ident" id="3081646">b</span><span class="op" id="3081647">.</span><span class="ident" id="3081648">buf</span><span class="op" id="3081651">,</span>&nbsp;<span class="ident" id="3081653">b</span><span class="op" id="3081654">.</span><span class="ident" id="3081655">buf</span><span class="op" id="3081658">[</span><span class="ident" id="3081659">b</span><span class="op" id="3081660">.</span><span class="ident" id="3081661">r</span><span class="op" id="3081662">:</span><span class="ident" id="3081663">b</span><span class="op" id="3081664">.</span><span class="ident" id="3081665">w</span><span class="op" id="3081666">]</span><span class="op" id="3081667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3081671">b</span><span class="op" id="3081672">.</span><span class="ident" id="3081673">w</span>&nbsp;<span class="op" id="3081675">-=</span>&nbsp;<span class="ident" id="3081678">b</span><span class="op" id="3081679">.</span><span class="ident" id="3081680">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3081684">b</span><span class="op" id="3081685">.</span><span class="ident" id="3081686">r</span>&nbsp;<span class="op" id="3081688">=</span>&nbsp;<span class="num" id="3081690">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3081693">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3081697">if</span>&nbsp;<span class="ident" id="3081700">b</span><span class="op" id="3081701">.</span><span class="ident" id="3081702">w</span>&nbsp;<span class="op" id="3081704">&gt;=</span>&nbsp;<span class="builtinfunc" id="3081707">len</span><span class="op" id="3081710">(</span><span class="ident" id="3081711">b</span><span class="op" id="3081712">.</span><span class="ident" id="3081713">buf</span><span class="op" id="3081716">)</span>&nbsp;<span class="op" id="3081718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3081722">panic</span><span class="op" id="3081727">(</span><span class="string" id="3081728">&#34;bufio:&nbsp;tried&nbsp;to&nbsp;fill&nbsp;full&nbsp;buffer&#34;</span><span class="op" id="3081762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3081765">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3081769">//&nbsp;Read&nbsp;new&nbsp;data:&nbsp;try&nbsp;a&nbsp;limited&nbsp;number&nbsp;of&nbsp;times.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3081819">for</span>&nbsp;<span class="ident" id="3081823">i</span>&nbsp;<span class="op" id="3081825">:=</span>&nbsp;<span class="ident" id="3081828">maxConsecutiveEmptyReads</span><span class="op" id="3081852">;</span>&nbsp;<span class="ident" id="3081854">i</span>&nbsp;<span class="op" id="3081856">&gt;</span>&nbsp;<span class="num" id="3081858">0</span><span class="op" id="3081859">;</span>&nbsp;<span class="ident" id="3081861">i</span><span class="op" id="3081862">--</span>&nbsp;<span class="op" id="3081865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3081869">n</span><span class="op" id="3081870">,</span>&nbsp;<span class="ident" id="3081872">err</span>&nbsp;<span class="op" id="3081876">:=</span>&nbsp;<span class="ident" id="3081879">b</span><span class="op" id="3081880">.</span><span class="ident" id="3081881">rd</span><span class="op" id="3081883">.</span><span class="ident" id="3081884">Read</span><span class="op" id="3081888">(</span><span class="ident" id="3081889">b</span><span class="op" id="3081890">.</span><span class="ident" id="3081891">buf</span><span class="op" id="3081894">[</span><span class="ident" id="3081895">b</span><span class="op" id="3081896">.</span><span class="ident" id="3081897">w</span><span class="op" id="3081898">:</span><span class="op" id="3081899">]</span><span class="op" id="3081900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3081904">if</span>&nbsp;<span class="ident" id="3081907">n</span>&nbsp;<span class="op" id="3081909">&lt;</span>&nbsp;<span class="num" id="3081911">0</span>&nbsp;<span class="op" id="3081913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3081918">panic</span><span class="op" id="3081923">(</span><span class="ident" id="3081924">errNegativeRead</span><span class="op" id="3081939">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3081943">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3081947">b</span><span class="op" id="3081948">.</span><span class="ident" id="3081949">w</span>&nbsp;<span class="op" id="3081951">+=</span>&nbsp;<span class="ident" id="3081954">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3081958">if</span>&nbsp;<span class="ident" id="3081961">err</span>&nbsp;<span class="op" id="3081965">!=</span>&nbsp;<span class="ident" id="3081968">nil</span>&nbsp;<span class="op" id="3081972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3081977">b</span><span class="op" id="3081978">.</span><span class="ident" id="3081979">err</span>&nbsp;<span class="op" id="3081983">=</span>&nbsp;<span class="ident" id="3081985">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3081992">return</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3082001">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3082005">if</span>&nbsp;<span class="ident" id="3082008">n</span>&nbsp;<span class="op" id="3082010">&gt;</span>&nbsp;<span class="num" id="3082012">0</span>&nbsp;<span class="op" id="3082014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3082019">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3082028">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3082031">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3082034">b</span><span class="op" id="3082035">.</span><span class="ident" id="3082036">err</span>&nbsp;<span class="op" id="3082040">=</span>&nbsp;<span class="ident" id="3082042">io</span><span class="op" id="3082044">.</span><span class="ident" id="3082045">ErrNoProgress</span><br>
<span class="lineno"></span><span class="op" id="3082059">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3082062">func</span>&nbsp;<span class="op" id="3082067">(</span><span class="ident" id="3082068">b</span>&nbsp;<span class="op" id="3082070">*</span><span class="ident" id="3082071">Reader</span><span class="op" id="3082077">)</span>&nbsp;<span class="ident" id="3082079">readErr</span><span class="op" id="3082086">(</span><span class="op" id="3082087">)</span>&nbsp;<span class="builtintype" id="3082089">error</span>&nbsp;<span class="op" id="3082095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3082098">err</span>&nbsp;<span class="op" id="3082102">:=</span>&nbsp;<span class="ident" id="3082105">b</span><span class="op" id="3082106">.</span><span class="ident" id="3082107">err</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3082112">b</span><span class="op" id="3082113">.</span><span class="ident" id="3082114">err</span>&nbsp;<span class="op" id="3082118">=</span>&nbsp;<span class="ident" id="3082120">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3082125">return</span>&nbsp;<span class="ident" id="3082132">err</span><br>
<span class="lineno"></span><span class="op" id="3082136">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3082139">//&nbsp;Peek&nbsp;returns&nbsp;the&nbsp;next&nbsp;n&nbsp;bytes&nbsp;without&nbsp;advancing&nbsp;the&nbsp;reader.&nbsp;The&nbsp;bytes&nbsp;stop</span><br>
<span class="lineno">120</span><span class="comment" id="3082217">//&nbsp;being&nbsp;valid&nbsp;at&nbsp;the&nbsp;next&nbsp;read&nbsp;call.&nbsp;If&nbsp;Peek&nbsp;returns&nbsp;fewer&nbsp;than&nbsp;n&nbsp;bytes,&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="3082294">//&nbsp;also&nbsp;returns&nbsp;an&nbsp;error&nbsp;explaining&nbsp;why&nbsp;the&nbsp;read&nbsp;is&nbsp;short.&nbsp;The&nbsp;error&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3082366">//&nbsp;ErrBufferFull&nbsp;if&nbsp;n&nbsp;is&nbsp;larger&nbsp;than&nbsp;b&#39;s&nbsp;buffer&nbsp;size.</span><br>
<span class="lineno"></span><span class="keyword" id="3082420">func</span>&nbsp;<span class="op" id="3082425">(</span><span class="ident" id="3082426">b</span>&nbsp;<span class="op" id="3082428">*</span><span class="ident" id="3082429">Reader</span><span class="op" id="3082435">)</span>&nbsp;<span class="ident" id="3082437">Peek</span><span class="op" id="3082441">(</span><span class="ident" id="3082442">n</span>&nbsp;<span class="builtintype" id="3082444">int</span><span class="op" id="3082447">)</span>&nbsp;<span class="op" id="3082449">(</span><span class="op" id="3082450">[</span><span class="op" id="3082451">]</span><span class="builtintype" id="3082452">byte</span><span class="op" id="3082456">,</span>&nbsp;<span class="builtintype" id="3082458">error</span><span class="op" id="3082463">)</span>&nbsp;<span class="op" id="3082465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3082468">if</span>&nbsp;<span class="ident" id="3082471">n</span>&nbsp;<span class="op" id="3082473">&lt;</span>&nbsp;<span class="num" id="3082475">0</span>&nbsp;<span class="op" id="3082477">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3082481">return</span>&nbsp;<span class="ident" id="3082488">nil</span><span class="op" id="3082491">,</span>&nbsp;<span class="ident" id="3082493">ErrNegativeCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3082511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3082514">if</span>&nbsp;<span class="ident" id="3082517">n</span>&nbsp;<span class="op" id="3082519">&gt;</span>&nbsp;<span class="builtinfunc" id="3082521">len</span><span class="op" id="3082524">(</span><span class="ident" id="3082525">b</span><span class="op" id="3082526">.</span><span class="ident" id="3082527">buf</span><span class="op" id="3082530">)</span>&nbsp;<span class="op" id="3082532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3082536">return</span>&nbsp;<span class="ident" id="3082543">nil</span><span class="op" id="3082546">,</span>&nbsp;<span class="ident" id="3082548">ErrBufferFull</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3082563">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3082566">//&nbsp;0&nbsp;&lt;=&nbsp;n&nbsp;&lt;=&nbsp;len(b.buf)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3082591">for</span>&nbsp;<span class="ident" id="3082595">b</span><span class="op" id="3082596">.</span><span class="ident" id="3082597">w</span><span class="op" id="3082598">-</span><span class="ident" id="3082599">b</span><span class="op" id="3082600">.</span><span class="ident" id="3082601">r</span>&nbsp;<span class="op" id="3082603">&lt;</span>&nbsp;<span class="ident" id="3082605">n</span>&nbsp;<span class="op" id="3082607">&amp;&amp;</span>&nbsp;<span class="ident" id="3082610">b</span><span class="op" id="3082611">.</span><span class="ident" id="3082612">err</span>&nbsp;<span class="op" id="3082616">==</span>&nbsp;<span class="ident" id="3082619">nil</span>&nbsp;<span class="op" id="3082623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3082627">b</span><span class="op" id="3082628">.</span><span class="ident" id="3082629">fill</span><span class="op" id="3082633">(</span><span class="op" id="3082634">)</span>&nbsp;<span class="comment" id="3082636">//&nbsp;b.w-b.r&nbsp;&lt;&nbsp;len(b.buf)&nbsp;=&gt;&nbsp;buffer&nbsp;is&nbsp;not&nbsp;full</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3082683">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3082687">var</span>&nbsp;<span class="ident" id="3082691">err</span>&nbsp;<span class="builtintype" id="3082695">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3082702">if</span>&nbsp;<span class="ident" id="3082705">avail</span>&nbsp;<span class="op" id="3082711">:=</span>&nbsp;<span class="ident" id="3082714">b</span><span class="op" id="3082715">.</span><span class="ident" id="3082716">w</span>&nbsp;<span class="op" id="3082718">-</span>&nbsp;<span class="ident" id="3082720">b</span><span class="op" id="3082721">.</span><span class="ident" id="3082722">r</span><span class="op" id="3082723">;</span>&nbsp;<span class="ident" id="3082725">avail</span>&nbsp;<span class="op" id="3082731">&lt;</span>&nbsp;<span class="ident" id="3082733">n</span>&nbsp;<span class="op" id="3082735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3082739">//&nbsp;not&nbsp;enough&nbsp;data&nbsp;in&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3082770">n</span>&nbsp;<span class="op" id="3082772">=</span>&nbsp;<span class="ident" id="3082774">avail</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3082782">err</span>&nbsp;<span class="op" id="3082786">=</span>&nbsp;<span class="ident" id="3082788">b</span><span class="op" id="3082789">.</span><span class="ident" id="3082790">readErr</span><span class="op" id="3082797">(</span><span class="op" id="3082798">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3082802">if</span>&nbsp;<span class="ident" id="3082805">err</span>&nbsp;<span class="op" id="3082809">==</span>&nbsp;<span class="ident" id="3082812">nil</span>&nbsp;<span class="op" id="3082816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3082821">err</span>&nbsp;<span class="op" id="3082825">=</span>&nbsp;<span class="ident" id="3082827">ErrBufferFull</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3082843">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3082846">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3082849">return</span>&nbsp;<span class="ident" id="3082856">b</span><span class="op" id="3082857">.</span><span class="ident" id="3082858">buf</span><span class="op" id="3082861">[</span><span class="ident" id="3082862">b</span><span class="op" id="3082863">.</span><span class="ident" id="3082864">r</span>&nbsp;<span class="op" id="3082866">:</span>&nbsp;<span class="ident" id="3082868">b</span><span class="op" id="3082869">.</span><span class="ident" id="3082870">r</span><span class="op" id="3082871">+</span><span class="ident" id="3082872">n</span><span class="op" id="3082873">]</span><span class="op" id="3082874">,</span>&nbsp;<span class="ident" id="3082876">err</span><br>
<span class="lineno">145</span><span class="op" id="3082880">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3082883">//&nbsp;Read&nbsp;reads&nbsp;data&nbsp;into&nbsp;p.</span><br>
<span class="lineno"></span><span class="comment" id="3082910">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;read&nbsp;into&nbsp;p.</span><br>
<span class="lineno"></span><span class="comment" id="3082957">//&nbsp;It&nbsp;calls&nbsp;Read&nbsp;at&nbsp;most&nbsp;once&nbsp;on&nbsp;the&nbsp;underlying&nbsp;Reader,</span><br>
<span class="lineno">150</span><span class="comment" id="3083013">//&nbsp;hence&nbsp;n&nbsp;may&nbsp;be&nbsp;less&nbsp;than&nbsp;len(p).</span><br>
<span class="lineno"></span><span class="comment" id="3083049">//&nbsp;At&nbsp;EOF,&nbsp;the&nbsp;count&nbsp;will&nbsp;be&nbsp;zero&nbsp;and&nbsp;err&nbsp;will&nbsp;be&nbsp;io.EOF.</span><br>
<span class="lineno"></span><span class="keyword" id="3083107">func</span>&nbsp;<span class="op" id="3083112">(</span><span class="ident" id="3083113">b</span>&nbsp;<span class="op" id="3083115">*</span><span class="ident" id="3083116">Reader</span><span class="op" id="3083122">)</span>&nbsp;<span class="ident" id="3083124">Read</span><span class="op" id="3083128">(</span><span class="ident" id="3083129">p</span>&nbsp;<span class="op" id="3083131">[</span><span class="op" id="3083132">]</span><span class="builtintype" id="3083133">byte</span><span class="op" id="3083137">)</span>&nbsp;<span class="op" id="3083139">(</span><span class="ident" id="3083140">n</span>&nbsp;<span class="builtintype" id="3083142">int</span><span class="op" id="3083145">,</span>&nbsp;<span class="ident" id="3083147">err</span>&nbsp;<span class="builtintype" id="3083151">error</span><span class="op" id="3083156">)</span>&nbsp;<span class="op" id="3083158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3083161">n</span>&nbsp;<span class="op" id="3083163">=</span>&nbsp;<span class="builtinfunc" id="3083165">len</span><span class="op" id="3083168">(</span><span class="ident" id="3083169">p</span><span class="op" id="3083170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3083173">if</span>&nbsp;<span class="ident" id="3083176">n</span>&nbsp;<span class="op" id="3083178">==</span>&nbsp;<span class="num" id="3083181">0</span>&nbsp;<span class="op" id="3083183">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3083187">return</span>&nbsp;<span class="num" id="3083194">0</span><span class="op" id="3083195">,</span>&nbsp;<span class="ident" id="3083197">b</span><span class="op" id="3083198">.</span><span class="ident" id="3083199">readErr</span><span class="op" id="3083206">(</span><span class="op" id="3083207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3083210">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3083213">if</span>&nbsp;<span class="ident" id="3083216">b</span><span class="op" id="3083217">.</span><span class="ident" id="3083218">r</span>&nbsp;<span class="op" id="3083220">==</span>&nbsp;<span class="ident" id="3083223">b</span><span class="op" id="3083224">.</span><span class="ident" id="3083225">w</span>&nbsp;<span class="op" id="3083227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3083231">if</span>&nbsp;<span class="ident" id="3083234">b</span><span class="op" id="3083235">.</span><span class="ident" id="3083236">err</span>&nbsp;<span class="op" id="3083240">!=</span>&nbsp;<span class="ident" id="3083243">nil</span>&nbsp;<span class="op" id="3083247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3083252">return</span>&nbsp;<span class="num" id="3083259">0</span><span class="op" id="3083260">,</span>&nbsp;<span class="ident" id="3083262">b</span><span class="op" id="3083263">.</span><span class="ident" id="3083264">readErr</span><span class="op" id="3083271">(</span><span class="op" id="3083272">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3083276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3083280">if</span>&nbsp;<span class="builtinfunc" id="3083283">len</span><span class="op" id="3083286">(</span><span class="ident" id="3083287">p</span><span class="op" id="3083288">)</span>&nbsp;<span class="op" id="3083290">&gt;=</span>&nbsp;<span class="builtinfunc" id="3083293">len</span><span class="op" id="3083296">(</span><span class="ident" id="3083297">b</span><span class="op" id="3083298">.</span><span class="ident" id="3083299">buf</span><span class="op" id="3083302">)</span>&nbsp;<span class="op" id="3083304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3083309">//&nbsp;Large&nbsp;read,&nbsp;empty&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3083341">//&nbsp;Read&nbsp;directly&nbsp;into&nbsp;p&nbsp;to&nbsp;avoid&nbsp;copy.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3083383">n</span><span class="op" id="3083384">,</span>&nbsp;<span class="ident" id="3083386">b</span><span class="op" id="3083387">.</span><span class="ident" id="3083388">err</span>&nbsp;<span class="op" id="3083392">=</span>&nbsp;<span class="ident" id="3083394">b</span><span class="op" id="3083395">.</span><span class="ident" id="3083396">rd</span><span class="op" id="3083398">.</span><span class="ident" id="3083399">Read</span><span class="op" id="3083403">(</span><span class="ident" id="3083404">p</span><span class="op" id="3083405">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3083410">if</span>&nbsp;<span class="ident" id="3083413">n</span>&nbsp;<span class="op" id="3083415">&lt;</span>&nbsp;<span class="num" id="3083417">0</span>&nbsp;<span class="op" id="3083419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3083425">panic</span><span class="op" id="3083430">(</span><span class="ident" id="3083431">errNegativeRead</span><span class="op" id="3083446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3083451">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3083456">if</span>&nbsp;<span class="ident" id="3083459">n</span>&nbsp;<span class="op" id="3083461">&gt;</span>&nbsp;<span class="num" id="3083463">0</span>&nbsp;<span class="op" id="3083465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3083471">b</span><span class="op" id="3083472">.</span><span class="ident" id="3083473">lastByte</span>&nbsp;<span class="op" id="3083482">=</span>&nbsp;<span class="builtintype" id="3083484">int</span><span class="op" id="3083487">(</span><span class="ident" id="3083488">p</span><span class="op" id="3083489">[</span><span class="ident" id="3083490">n</span><span class="op" id="3083491">-</span><span class="num" id="3083492">1</span><span class="op" id="3083493">]</span><span class="op" id="3083494">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3083500">b</span><span class="op" id="3083501">.</span><span class="ident" id="3083502">lastRuneSize</span>&nbsp;<span class="op" id="3083515">=</span>&nbsp;<span class="op" id="3083517">-</span><span class="num" id="3083518">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3083523">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3083528">return</span>&nbsp;<span class="ident" id="3083535">n</span><span class="op" id="3083536">,</span>&nbsp;<span class="ident" id="3083538">b</span><span class="op" id="3083539">.</span><span class="ident" id="3083540">readErr</span><span class="op" id="3083547">(</span><span class="op" id="3083548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3083552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3083556">b</span><span class="op" id="3083557">.</span><span class="ident" id="3083558">fill</span><span class="op" id="3083562">(</span><span class="op" id="3083563">)</span>&nbsp;<span class="comment" id="3083565">//&nbsp;buffer&nbsp;is&nbsp;empty</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3083586">if</span>&nbsp;<span class="ident" id="3083589">b</span><span class="op" id="3083590">.</span><span class="ident" id="3083591">r</span>&nbsp;<span class="op" id="3083593">==</span>&nbsp;<span class="ident" id="3083596">b</span><span class="op" id="3083597">.</span><span class="ident" id="3083598">w</span>&nbsp;<span class="op" id="3083600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3083605">return</span>&nbsp;<span class="num" id="3083612">0</span><span class="op" id="3083613">,</span>&nbsp;<span class="ident" id="3083615">b</span><span class="op" id="3083616">.</span><span class="ident" id="3083617">readErr</span><span class="op" id="3083624">(</span><span class="op" id="3083625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3083629">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3083632">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3083636">//&nbsp;copy&nbsp;as&nbsp;much&nbsp;as&nbsp;we&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3083663">n</span>&nbsp;<span class="op" id="3083665">=</span>&nbsp;<span class="builtinfunc" id="3083667">copy</span><span class="op" id="3083671">(</span><span class="ident" id="3083672">p</span><span class="op" id="3083673">,</span>&nbsp;<span class="ident" id="3083675">b</span><span class="op" id="3083676">.</span><span class="ident" id="3083677">buf</span><span class="op" id="3083680">[</span><span class="ident" id="3083681">b</span><span class="op" id="3083682">.</span><span class="ident" id="3083683">r</span><span class="op" id="3083684">:</span><span class="ident" id="3083685">b</span><span class="op" id="3083686">.</span><span class="ident" id="3083687">w</span><span class="op" id="3083688">]</span><span class="op" id="3083689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3083692">b</span><span class="op" id="3083693">.</span><span class="ident" id="3083694">r</span>&nbsp;<span class="op" id="3083696">+=</span>&nbsp;<span class="ident" id="3083699">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3083702">b</span><span class="op" id="3083703">.</span><span class="ident" id="3083704">lastByte</span>&nbsp;<span class="op" id="3083713">=</span>&nbsp;<span class="builtintype" id="3083715">int</span><span class="op" id="3083718">(</span><span class="ident" id="3083719">b</span><span class="op" id="3083720">.</span><span class="ident" id="3083721">buf</span><span class="op" id="3083724">[</span><span class="ident" id="3083725">b</span><span class="op" id="3083726">.</span><span class="ident" id="3083727">r</span><span class="op" id="3083728">-</span><span class="num" id="3083729">1</span><span class="op" id="3083730">]</span><span class="op" id="3083731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3083734">b</span><span class="op" id="3083735">.</span><span class="ident" id="3083736">lastRuneSize</span>&nbsp;<span class="op" id="3083749">=</span>&nbsp;<span class="op" id="3083751">-</span><span class="num" id="3083752">1</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3083755">return</span>&nbsp;<span class="ident" id="3083762">n</span><span class="op" id="3083763">,</span>&nbsp;<span class="ident" id="3083765">nil</span><br>
<span class="lineno"></span><span class="op" id="3083769">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3083772">//&nbsp;ReadByte&nbsp;reads&nbsp;and&nbsp;returns&nbsp;a&nbsp;single&nbsp;byte.</span><br>
<span class="lineno"></span><span class="comment" id="3083817">//&nbsp;If&nbsp;no&nbsp;byte&nbsp;is&nbsp;available,&nbsp;returns&nbsp;an&nbsp;error.</span><br>
<span class="lineno">190</span><span class="keyword" id="3083863">func</span>&nbsp;<span class="op" id="3083868">(</span><span class="ident" id="3083869">b</span>&nbsp;<span class="op" id="3083871">*</span><span class="ident" id="3083872">Reader</span><span class="op" id="3083878">)</span>&nbsp;<span class="ident" id="3083880">ReadByte</span><span class="op" id="3083888">(</span><span class="op" id="3083889">)</span>&nbsp;<span class="op" id="3083891">(</span><span class="ident" id="3083892">c</span>&nbsp;<span class="builtintype" id="3083894">byte</span><span class="op" id="3083898">,</span>&nbsp;<span class="ident" id="3083900">err</span>&nbsp;<span class="builtintype" id="3083904">error</span><span class="op" id="3083909">)</span>&nbsp;<span class="op" id="3083911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3083914">b</span><span class="op" id="3083915">.</span><span class="ident" id="3083916">lastRuneSize</span>&nbsp;<span class="op" id="3083929">=</span>&nbsp;<span class="op" id="3083931">-</span><span class="num" id="3083932">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3083935">for</span>&nbsp;<span class="ident" id="3083939">b</span><span class="op" id="3083940">.</span><span class="ident" id="3083941">r</span>&nbsp;<span class="op" id="3083943">==</span>&nbsp;<span class="ident" id="3083946">b</span><span class="op" id="3083947">.</span><span class="ident" id="3083948">w</span>&nbsp;<span class="op" id="3083950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3083954">if</span>&nbsp;<span class="ident" id="3083957">b</span><span class="op" id="3083958">.</span><span class="ident" id="3083959">err</span>&nbsp;<span class="op" id="3083963">!=</span>&nbsp;<span class="ident" id="3083966">nil</span>&nbsp;<span class="op" id="3083970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3083975">return</span>&nbsp;<span class="num" id="3083982">0</span><span class="op" id="3083983">,</span>&nbsp;<span class="ident" id="3083985">b</span><span class="op" id="3083986">.</span><span class="ident" id="3083987">readErr</span><span class="op" id="3083994">(</span><span class="op" id="3083995">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3083999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3084003">b</span><span class="op" id="3084004">.</span><span class="ident" id="3084005">fill</span><span class="op" id="3084009">(</span><span class="op" id="3084010">)</span>&nbsp;<span class="comment" id="3084012">//&nbsp;buffer&nbsp;is&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3084032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3084035">c</span>&nbsp;<span class="op" id="3084037">=</span>&nbsp;<span class="ident" id="3084039">b</span><span class="op" id="3084040">.</span><span class="ident" id="3084041">buf</span><span class="op" id="3084044">[</span><span class="ident" id="3084045">b</span><span class="op" id="3084046">.</span><span class="ident" id="3084047">r</span><span class="op" id="3084048">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3084051">b</span><span class="op" id="3084052">.</span><span class="ident" id="3084053">r</span><span class="op" id="3084054">++</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3084058">b</span><span class="op" id="3084059">.</span><span class="ident" id="3084060">lastByte</span>&nbsp;<span class="op" id="3084069">=</span>&nbsp;<span class="builtintype" id="3084071">int</span><span class="op" id="3084074">(</span><span class="ident" id="3084075">c</span><span class="op" id="3084076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3084079">return</span>&nbsp;<span class="ident" id="3084086">c</span><span class="op" id="3084087">,</span>&nbsp;<span class="ident" id="3084089">nil</span><br>
<span class="lineno"></span><span class="op" id="3084093">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3084096">//&nbsp;UnreadByte&nbsp;unreads&nbsp;the&nbsp;last&nbsp;byte.&nbsp;&nbsp;Only&nbsp;the&nbsp;most&nbsp;recently&nbsp;read&nbsp;byte&nbsp;can&nbsp;be&nbsp;unread.</span><br>
<span class="lineno">205</span><span class="keyword" id="3084182">func</span>&nbsp;<span class="op" id="3084187">(</span><span class="ident" id="3084188">b</span>&nbsp;<span class="op" id="3084190">*</span><span class="ident" id="3084191">Reader</span><span class="op" id="3084197">)</span>&nbsp;<span class="ident" id="3084199">UnreadByte</span><span class="op" id="3084209">(</span><span class="op" id="3084210">)</span>&nbsp;<span class="builtintype" id="3084212">error</span>&nbsp;<span class="op" id="3084218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3084221">if</span>&nbsp;<span class="ident" id="3084224">b</span><span class="op" id="3084225">.</span><span class="ident" id="3084226">lastByte</span>&nbsp;<span class="op" id="3084235">&lt;</span>&nbsp;<span class="num" id="3084237">0</span>&nbsp;<span class="op" id="3084239">||</span>&nbsp;<span class="ident" id="3084242">b</span><span class="op" id="3084243">.</span><span class="ident" id="3084244">r</span>&nbsp;<span class="op" id="3084246">==</span>&nbsp;<span class="num" id="3084249">0</span>&nbsp;<span class="op" id="3084251">&amp;&amp;</span>&nbsp;<span class="ident" id="3084254">b</span><span class="op" id="3084255">.</span><span class="ident" id="3084256">w</span>&nbsp;<span class="op" id="3084258">&gt;</span>&nbsp;<span class="num" id="3084260">0</span>&nbsp;<span class="op" id="3084262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3084266">return</span>&nbsp;<span class="ident" id="3084273">ErrInvalidUnreadByte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3084295">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3084298">//&nbsp;b.r&nbsp;&gt;&nbsp;0&nbsp;||&nbsp;b.w&nbsp;==&nbsp;0</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3084322">if</span>&nbsp;<span class="ident" id="3084325">b</span><span class="op" id="3084326">.</span><span class="ident" id="3084327">r</span>&nbsp;<span class="op" id="3084329">&gt;</span>&nbsp;<span class="num" id="3084331">0</span>&nbsp;<span class="op" id="3084333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3084337">b</span><span class="op" id="3084338">.</span><span class="ident" id="3084339">r</span><span class="op" id="3084340">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3084344">}</span>&nbsp;<span class="keyword" id="3084346">else</span>&nbsp;<span class="op" id="3084351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3084355">//&nbsp;b.r&nbsp;==&nbsp;0&nbsp;&amp;&amp;&nbsp;b.w&nbsp;==&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3084381">b</span><span class="op" id="3084382">.</span><span class="ident" id="3084383">w</span>&nbsp;<span class="op" id="3084385">=</span>&nbsp;<span class="num" id="3084387">1</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3084390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3084393">b</span><span class="op" id="3084394">.</span><span class="ident" id="3084395">buf</span><span class="op" id="3084398">[</span><span class="ident" id="3084399">b</span><span class="op" id="3084400">.</span><span class="ident" id="3084401">r</span><span class="op" id="3084402">]</span>&nbsp;<span class="op" id="3084404">=</span>&nbsp;<span class="builtintype" id="3084406">byte</span><span class="op" id="3084410">(</span><span class="ident" id="3084411">b</span><span class="op" id="3084412">.</span><span class="ident" id="3084413">lastByte</span><span class="op" id="3084421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3084424">b</span><span class="op" id="3084425">.</span><span class="ident" id="3084426">lastByte</span>&nbsp;<span class="op" id="3084435">=</span>&nbsp;<span class="op" id="3084437">-</span><span class="num" id="3084438">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3084441">b</span><span class="op" id="3084442">.</span><span class="ident" id="3084443">lastRuneSize</span>&nbsp;<span class="op" id="3084456">=</span>&nbsp;<span class="op" id="3084458">-</span><span class="num" id="3084459">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3084462">return</span>&nbsp;<span class="ident" id="3084469">nil</span><br>
<span class="lineno">220</span><span class="op" id="3084473">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3084476">//&nbsp;ReadRune&nbsp;reads&nbsp;a&nbsp;single&nbsp;UTF-8&nbsp;encoded&nbsp;Unicode&nbsp;character&nbsp;and&nbsp;returns&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3084551">//&nbsp;rune&nbsp;and&nbsp;its&nbsp;size&nbsp;in&nbsp;bytes.&nbsp;If&nbsp;the&nbsp;encoded&nbsp;rune&nbsp;is&nbsp;invalid,&nbsp;it&nbsp;consumes&nbsp;one&nbsp;byte</span><br>
<span class="lineno"></span><span class="comment" id="3084635">//&nbsp;and&nbsp;returns&nbsp;unicode.ReplacementChar&nbsp;(U+FFFD)&nbsp;with&nbsp;a&nbsp;size&nbsp;of&nbsp;1.</span><br>
<span class="lineno">225</span><span class="keyword" id="3084701">func</span>&nbsp;<span class="op" id="3084706">(</span><span class="ident" id="3084707">b</span>&nbsp;<span class="op" id="3084709">*</span><span class="ident" id="3084710">Reader</span><span class="op" id="3084716">)</span>&nbsp;<span class="ident" id="3084718">ReadRune</span><span class="op" id="3084726">(</span><span class="op" id="3084727">)</span>&nbsp;<span class="op" id="3084729">(</span><span class="ident" id="3084730">r</span>&nbsp;<span class="builtintype" id="3084732">rune</span><span class="op" id="3084736">,</span>&nbsp;<span class="ident" id="3084738">size</span>&nbsp;<span class="builtintype" id="3084743">int</span><span class="op" id="3084746">,</span>&nbsp;<span class="ident" id="3084748">err</span>&nbsp;<span class="builtintype" id="3084752">error</span><span class="op" id="3084757">)</span>&nbsp;<span class="op" id="3084759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3084762">for</span>&nbsp;<span class="ident" id="3084766">b</span><span class="op" id="3084767">.</span><span class="ident" id="3084768">r</span><span class="op" id="3084769">+</span><span class="ident" id="3084770">utf8</span><span class="op" id="3084774">.</span><span class="ident" id="3084775">UTFMax</span>&nbsp;<span class="op" id="3084782">&gt;</span>&nbsp;<span class="ident" id="3084784">b</span><span class="op" id="3084785">.</span><span class="ident" id="3084786">w</span>&nbsp;<span class="op" id="3084788">&amp;&amp;</span>&nbsp;<span class="op" id="3084791">!</span><span class="ident" id="3084792">utf8</span><span class="op" id="3084796">.</span><span class="ident" id="3084797">FullRune</span><span class="op" id="3084805">(</span><span class="ident" id="3084806">b</span><span class="op" id="3084807">.</span><span class="ident" id="3084808">buf</span><span class="op" id="3084811">[</span><span class="ident" id="3084812">b</span><span class="op" id="3084813">.</span><span class="ident" id="3084814">r</span><span class="op" id="3084815">:</span><span class="ident" id="3084816">b</span><span class="op" id="3084817">.</span><span class="ident" id="3084818">w</span><span class="op" id="3084819">]</span><span class="op" id="3084820">)</span>&nbsp;<span class="op" id="3084822">&amp;&amp;</span>&nbsp;<span class="ident" id="3084825">b</span><span class="op" id="3084826">.</span><span class="ident" id="3084827">err</span>&nbsp;<span class="op" id="3084831">==</span>&nbsp;<span class="ident" id="3084834">nil</span>&nbsp;<span class="op" id="3084838">&amp;&amp;</span>&nbsp;<span class="ident" id="3084841">b</span><span class="op" id="3084842">.</span><span class="ident" id="3084843">w</span><span class="op" id="3084844">-</span><span class="ident" id="3084845">b</span><span class="op" id="3084846">.</span><span class="ident" id="3084847">r</span>&nbsp;<span class="op" id="3084849">&lt;</span>&nbsp;<span class="builtinfunc" id="3084851">len</span><span class="op" id="3084854">(</span><span class="ident" id="3084855">b</span><span class="op" id="3084856">.</span><span class="ident" id="3084857">buf</span><span class="op" id="3084860">)</span>&nbsp;<span class="op" id="3084862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3084866">b</span><span class="op" id="3084867">.</span><span class="ident" id="3084868">fill</span><span class="op" id="3084872">(</span><span class="op" id="3084873">)</span>&nbsp;<span class="comment" id="3084875">//&nbsp;b.w-b.r&nbsp;&lt;&nbsp;len(buf)&nbsp;=&gt;&nbsp;buffer&nbsp;is&nbsp;not&nbsp;full</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3084920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3084923">b</span><span class="op" id="3084924">.</span><span class="ident" id="3084925">lastRuneSize</span>&nbsp;<span class="op" id="3084938">=</span>&nbsp;<span class="op" id="3084940">-</span><span class="num" id="3084941">1</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3084944">if</span>&nbsp;<span class="ident" id="3084947">b</span><span class="op" id="3084948">.</span><span class="ident" id="3084949">r</span>&nbsp;<span class="op" id="3084951">==</span>&nbsp;<span class="ident" id="3084954">b</span><span class="op" id="3084955">.</span><span class="ident" id="3084956">w</span>&nbsp;<span class="op" id="3084958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3084962">return</span>&nbsp;<span class="num" id="3084969">0</span><span class="op" id="3084970">,</span>&nbsp;<span class="num" id="3084972">0</span><span class="op" id="3084973">,</span>&nbsp;<span class="ident" id="3084975">b</span><span class="op" id="3084976">.</span><span class="ident" id="3084977">readErr</span><span class="op" id="3084984">(</span><span class="op" id="3084985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3084988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3084991">r</span><span class="op" id="3084992">,</span>&nbsp;<span class="ident" id="3084994">size</span>&nbsp;<span class="op" id="3084999">=</span>&nbsp;<span class="builtintype" id="3085001">rune</span><span class="op" id="3085005">(</span><span class="ident" id="3085006">b</span><span class="op" id="3085007">.</span><span class="ident" id="3085008">buf</span><span class="op" id="3085011">[</span><span class="ident" id="3085012">b</span><span class="op" id="3085013">.</span><span class="ident" id="3085014">r</span><span class="op" id="3085015">]</span><span class="op" id="3085016">)</span><span class="op" id="3085017">,</span>&nbsp;<span class="num" id="3085019">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3085022">if</span>&nbsp;<span class="ident" id="3085025">r</span>&nbsp;<span class="op" id="3085027">&gt;=</span>&nbsp;<span class="num" id="3085030">0x80</span>&nbsp;<span class="op" id="3085035">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3085039">r</span><span class="op" id="3085040">,</span>&nbsp;<span class="ident" id="3085042">size</span>&nbsp;<span class="op" id="3085047">=</span>&nbsp;<span class="ident" id="3085049">utf8</span><span class="op" id="3085053">.</span><span class="ident" id="3085054">DecodeRune</span><span class="op" id="3085064">(</span><span class="ident" id="3085065">b</span><span class="op" id="3085066">.</span><span class="ident" id="3085067">buf</span><span class="op" id="3085070">[</span><span class="ident" id="3085071">b</span><span class="op" id="3085072">.</span><span class="ident" id="3085073">r</span><span class="op" id="3085074">:</span><span class="ident" id="3085075">b</span><span class="op" id="3085076">.</span><span class="ident" id="3085077">w</span><span class="op" id="3085078">]</span><span class="op" id="3085079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3085082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3085085">b</span><span class="op" id="3085086">.</span><span class="ident" id="3085087">r</span>&nbsp;<span class="op" id="3085089">+=</span>&nbsp;<span class="ident" id="3085092">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3085098">b</span><span class="op" id="3085099">.</span><span class="ident" id="3085100">lastByte</span>&nbsp;<span class="op" id="3085109">=</span>&nbsp;<span class="builtintype" id="3085111">int</span><span class="op" id="3085114">(</span><span class="ident" id="3085115">b</span><span class="op" id="3085116">.</span><span class="ident" id="3085117">buf</span><span class="op" id="3085120">[</span><span class="ident" id="3085121">b</span><span class="op" id="3085122">.</span><span class="ident" id="3085123">r</span><span class="op" id="3085124">-</span><span class="num" id="3085125">1</span><span class="op" id="3085126">]</span><span class="op" id="3085127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3085130">b</span><span class="op" id="3085131">.</span><span class="ident" id="3085132">lastRuneSize</span>&nbsp;<span class="op" id="3085145">=</span>&nbsp;<span class="ident" id="3085147">size</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3085153">return</span>&nbsp;<span class="ident" id="3085160">r</span><span class="op" id="3085161">,</span>&nbsp;<span class="ident" id="3085163">size</span><span class="op" id="3085167">,</span>&nbsp;<span class="ident" id="3085169">nil</span><br>
<span class="lineno"></span><span class="op" id="3085173">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3085176">//&nbsp;UnreadRune&nbsp;unreads&nbsp;the&nbsp;last&nbsp;rune.&nbsp;&nbsp;If&nbsp;the&nbsp;most&nbsp;recent&nbsp;read&nbsp;operation&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="3085251">//&nbsp;the&nbsp;buffer&nbsp;was&nbsp;not&nbsp;a&nbsp;ReadRune,&nbsp;UnreadRune&nbsp;returns&nbsp;an&nbsp;error.&nbsp;&nbsp;(In&nbsp;this</span><br>
<span class="lineno">245</span><span class="comment" id="3085324">//&nbsp;regard&nbsp;it&nbsp;is&nbsp;stricter&nbsp;than&nbsp;UnreadByte,&nbsp;which&nbsp;will&nbsp;unread&nbsp;the&nbsp;last&nbsp;byte</span><br>
<span class="lineno"></span><span class="comment" id="3085398">//&nbsp;from&nbsp;any&nbsp;read&nbsp;operation.)</span><br>
<span class="lineno"></span><span class="keyword" id="3085427">func</span>&nbsp;<span class="op" id="3085432">(</span><span class="ident" id="3085433">b</span>&nbsp;<span class="op" id="3085435">*</span><span class="ident" id="3085436">Reader</span><span class="op" id="3085442">)</span>&nbsp;<span class="ident" id="3085444">UnreadRune</span><span class="op" id="3085454">(</span><span class="op" id="3085455">)</span>&nbsp;<span class="builtintype" id="3085457">error</span>&nbsp;<span class="op" id="3085463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3085466">if</span>&nbsp;<span class="ident" id="3085469">b</span><span class="op" id="3085470">.</span><span class="ident" id="3085471">lastRuneSize</span>&nbsp;<span class="op" id="3085484">&lt;</span>&nbsp;<span class="num" id="3085486">0</span>&nbsp;<span class="op" id="3085488">||</span>&nbsp;<span class="ident" id="3085491">b</span><span class="op" id="3085492">.</span><span class="ident" id="3085493">r</span>&nbsp;<span class="op" id="3085495">&lt;</span>&nbsp;<span class="ident" id="3085497">b</span><span class="op" id="3085498">.</span><span class="ident" id="3085499">lastRuneSize</span>&nbsp;<span class="op" id="3085512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3085516">return</span>&nbsp;<span class="ident" id="3085523">ErrInvalidUnreadRune</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3085545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3085548">b</span><span class="op" id="3085549">.</span><span class="ident" id="3085550">r</span>&nbsp;<span class="op" id="3085552">-=</span>&nbsp;<span class="ident" id="3085555">b</span><span class="op" id="3085556">.</span><span class="ident" id="3085557">lastRuneSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3085571">b</span><span class="op" id="3085572">.</span><span class="ident" id="3085573">lastByte</span>&nbsp;<span class="op" id="3085582">=</span>&nbsp;<span class="op" id="3085584">-</span><span class="num" id="3085585">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3085588">b</span><span class="op" id="3085589">.</span><span class="ident" id="3085590">lastRuneSize</span>&nbsp;<span class="op" id="3085603">=</span>&nbsp;<span class="op" id="3085605">-</span><span class="num" id="3085606">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3085609">return</span>&nbsp;<span class="ident" id="3085616">nil</span><br>
<span class="lineno">255</span><span class="op" id="3085620">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3085623">//&nbsp;Buffered&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;that&nbsp;can&nbsp;be&nbsp;read&nbsp;from&nbsp;the&nbsp;current&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="3085705">func</span>&nbsp;<span class="op" id="3085710">(</span><span class="ident" id="3085711">b</span>&nbsp;<span class="op" id="3085713">*</span><span class="ident" id="3085714">Reader</span><span class="op" id="3085720">)</span>&nbsp;<span class="ident" id="3085722">Buffered</span><span class="op" id="3085730">(</span><span class="op" id="3085731">)</span>&nbsp;<span class="builtintype" id="3085733">int</span>&nbsp;<span class="op" id="3085737">{</span>&nbsp;<span class="keyword" id="3085739">return</span>&nbsp;<span class="ident" id="3085746">b</span><span class="op" id="3085747">.</span><span class="ident" id="3085748">w</span>&nbsp;<span class="op" id="3085750">-</span>&nbsp;<span class="ident" id="3085752">b</span><span class="op" id="3085753">.</span><span class="ident" id="3085754">r</span>&nbsp;<span class="op" id="3085756">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span><span class="comment" id="3085759">//&nbsp;ReadSlice&nbsp;reads&nbsp;until&nbsp;the&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;delim&nbsp;in&nbsp;the&nbsp;input,</span><br>
<span class="lineno"></span><span class="comment" id="3085828">//&nbsp;returning&nbsp;a&nbsp;slice&nbsp;pointing&nbsp;at&nbsp;the&nbsp;bytes&nbsp;in&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="comment" id="3085886">//&nbsp;The&nbsp;bytes&nbsp;stop&nbsp;being&nbsp;valid&nbsp;at&nbsp;the&nbsp;next&nbsp;read.</span><br>
<span class="lineno"></span><span class="comment" id="3085934">//&nbsp;If&nbsp;ReadSlice&nbsp;encounters&nbsp;an&nbsp;error&nbsp;before&nbsp;finding&nbsp;a&nbsp;delimiter,</span><br>
<span class="lineno"></span><span class="comment" id="3085998">//&nbsp;it&nbsp;returns&nbsp;all&nbsp;the&nbsp;data&nbsp;in&nbsp;the&nbsp;buffer&nbsp;and&nbsp;the&nbsp;error&nbsp;itself&nbsp;(often&nbsp;io.EOF).</span><br>
<span class="lineno">265</span><span class="comment" id="3086076">//&nbsp;ReadSlice&nbsp;fails&nbsp;with&nbsp;error&nbsp;ErrBufferFull&nbsp;if&nbsp;the&nbsp;buffer&nbsp;fills&nbsp;without&nbsp;a&nbsp;delim.</span><br>
<span class="lineno"></span><span class="comment" id="3086157">//&nbsp;Because&nbsp;the&nbsp;data&nbsp;returned&nbsp;from&nbsp;ReadSlice&nbsp;will&nbsp;be&nbsp;overwritten</span><br>
<span class="lineno"></span><span class="comment" id="3086221">//&nbsp;by&nbsp;the&nbsp;next&nbsp;I/O&nbsp;operation,&nbsp;most&nbsp;clients&nbsp;should&nbsp;use</span><br>
<span class="lineno"></span><span class="comment" id="3086275">//&nbsp;ReadBytes&nbsp;or&nbsp;ReadString&nbsp;instead.</span><br>
<span class="lineno"></span><span class="comment" id="3086311">//&nbsp;ReadSlice&nbsp;returns&nbsp;err&nbsp;!=&nbsp;nil&nbsp;if&nbsp;and&nbsp;only&nbsp;if&nbsp;line&nbsp;does&nbsp;not&nbsp;end&nbsp;in&nbsp;delim.</span><br>
<span class="lineno">270</span><span class="keyword" id="3086386">func</span>&nbsp;<span class="op" id="3086391">(</span><span class="ident" id="3086392">b</span>&nbsp;<span class="op" id="3086394">*</span><span class="ident" id="3086395">Reader</span><span class="op" id="3086401">)</span>&nbsp;<span class="ident" id="3086403">ReadSlice</span><span class="op" id="3086412">(</span><span class="ident" id="3086413">delim</span>&nbsp;<span class="builtintype" id="3086419">byte</span><span class="op" id="3086423">)</span>&nbsp;<span class="op" id="3086425">(</span><span class="ident" id="3086426">line</span>&nbsp;<span class="op" id="3086431">[</span><span class="op" id="3086432">]</span><span class="builtintype" id="3086433">byte</span><span class="op" id="3086437">,</span>&nbsp;<span class="ident" id="3086439">err</span>&nbsp;<span class="builtintype" id="3086443">error</span><span class="op" id="3086448">)</span>&nbsp;<span class="op" id="3086450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3086453">for</span>&nbsp;<span class="op" id="3086457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3086461">//&nbsp;Search&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3086481">if</span>&nbsp;<span class="ident" id="3086484">i</span>&nbsp;<span class="op" id="3086486">:=</span>&nbsp;<span class="ident" id="3086489">bytes</span><span class="op" id="3086494">.</span><span class="ident" id="3086495">IndexByte</span><span class="op" id="3086504">(</span><span class="ident" id="3086505">b</span><span class="op" id="3086506">.</span><span class="ident" id="3086507">buf</span><span class="op" id="3086510">[</span><span class="ident" id="3086511">b</span><span class="op" id="3086512">.</span><span class="ident" id="3086513">r</span><span class="op" id="3086514">:</span><span class="ident" id="3086515">b</span><span class="op" id="3086516">.</span><span class="ident" id="3086517">w</span><span class="op" id="3086518">]</span><span class="op" id="3086519">,</span>&nbsp;<span class="ident" id="3086521">delim</span><span class="op" id="3086526">)</span><span class="op" id="3086527">;</span>&nbsp;<span class="ident" id="3086529">i</span>&nbsp;<span class="op" id="3086531">&gt;=</span>&nbsp;<span class="num" id="3086534">0</span>&nbsp;<span class="op" id="3086536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3086541">line</span>&nbsp;<span class="op" id="3086546">=</span>&nbsp;<span class="ident" id="3086548">b</span><span class="op" id="3086549">.</span><span class="ident" id="3086550">buf</span><span class="op" id="3086553">[</span><span class="ident" id="3086554">b</span><span class="op" id="3086555">.</span><span class="ident" id="3086556">r</span>&nbsp;<span class="op" id="3086558">:</span>&nbsp;<span class="ident" id="3086560">b</span><span class="op" id="3086561">.</span><span class="ident" id="3086562">r</span><span class="op" id="3086563">+</span><span class="ident" id="3086564">i</span><span class="op" id="3086565">+</span><span class="num" id="3086566">1</span><span class="op" id="3086567">]</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3086572">b</span><span class="op" id="3086573">.</span><span class="ident" id="3086574">r</span>&nbsp;<span class="op" id="3086576">+=</span>&nbsp;<span class="ident" id="3086579">i</span>&nbsp;<span class="op" id="3086581">+</span>&nbsp;<span class="num" id="3086583">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3086588">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3086596">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3086601">//&nbsp;Pending&nbsp;error?</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3086621">if</span>&nbsp;<span class="ident" id="3086624">b</span><span class="op" id="3086625">.</span><span class="ident" id="3086626">err</span>&nbsp;<span class="op" id="3086630">!=</span>&nbsp;<span class="ident" id="3086633">nil</span>&nbsp;<span class="op" id="3086637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3086642">line</span>&nbsp;<span class="op" id="3086647">=</span>&nbsp;<span class="ident" id="3086649">b</span><span class="op" id="3086650">.</span><span class="ident" id="3086651">buf</span><span class="op" id="3086654">[</span><span class="ident" id="3086655">b</span><span class="op" id="3086656">.</span><span class="ident" id="3086657">r</span><span class="op" id="3086658">:</span><span class="ident" id="3086659">b</span><span class="op" id="3086660">.</span><span class="ident" id="3086661">w</span><span class="op" id="3086662">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3086667">b</span><span class="op" id="3086668">.</span><span class="ident" id="3086669">r</span>&nbsp;<span class="op" id="3086671">=</span>&nbsp;<span class="ident" id="3086673">b</span><span class="op" id="3086674">.</span><span class="ident" id="3086675">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3086680">err</span>&nbsp;<span class="op" id="3086684">=</span>&nbsp;<span class="ident" id="3086686">b</span><span class="op" id="3086687">.</span><span class="ident" id="3086688">readErr</span><span class="op" id="3086695">(</span><span class="op" id="3086696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3086701">break</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3086709">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3086714">//&nbsp;Buffer&nbsp;full?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3086732">if</span>&nbsp;<span class="ident" id="3086735">b</span><span class="op" id="3086736">.</span><span class="ident" id="3086737">Buffered</span><span class="op" id="3086745">(</span><span class="op" id="3086746">)</span>&nbsp;<span class="op" id="3086748">&gt;=</span>&nbsp;<span class="builtinfunc" id="3086751">len</span><span class="op" id="3086754">(</span><span class="ident" id="3086755">b</span><span class="op" id="3086756">.</span><span class="ident" id="3086757">buf</span><span class="op" id="3086760">)</span>&nbsp;<span class="op" id="3086762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3086767">b</span><span class="op" id="3086768">.</span><span class="ident" id="3086769">r</span>&nbsp;<span class="op" id="3086771">=</span>&nbsp;<span class="ident" id="3086773">b</span><span class="op" id="3086774">.</span><span class="ident" id="3086775">w</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3086780">line</span>&nbsp;<span class="op" id="3086785">=</span>&nbsp;<span class="ident" id="3086787">b</span><span class="op" id="3086788">.</span><span class="ident" id="3086789">buf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3086796">err</span>&nbsp;<span class="op" id="3086800">=</span>&nbsp;<span class="ident" id="3086802">ErrBufferFull</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3086819">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3086827">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3086832">b</span><span class="op" id="3086833">.</span><span class="ident" id="3086834">fill</span><span class="op" id="3086838">(</span><span class="op" id="3086839">)</span>&nbsp;<span class="comment" id="3086841">//&nbsp;buffer&nbsp;is&nbsp;not&nbsp;full</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3086864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3086868">//&nbsp;Handle&nbsp;last&nbsp;byte,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3086898">if</span>&nbsp;<span class="ident" id="3086901">i</span>&nbsp;<span class="op" id="3086903">:=</span>&nbsp;<span class="builtinfunc" id="3086906">len</span><span class="op" id="3086909">(</span><span class="ident" id="3086910">line</span><span class="op" id="3086914">)</span>&nbsp;<span class="op" id="3086916">-</span>&nbsp;<span class="num" id="3086918">1</span><span class="op" id="3086919">;</span>&nbsp;<span class="ident" id="3086921">i</span>&nbsp;<span class="op" id="3086923">&gt;=</span>&nbsp;<span class="num" id="3086926">0</span>&nbsp;<span class="op" id="3086928">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3086932">b</span><span class="op" id="3086933">.</span><span class="ident" id="3086934">lastByte</span>&nbsp;<span class="op" id="3086943">=</span>&nbsp;<span class="builtintype" id="3086945">int</span><span class="op" id="3086948">(</span><span class="ident" id="3086949">line</span><span class="op" id="3086953">[</span><span class="ident" id="3086954">i</span><span class="op" id="3086955">]</span><span class="op" id="3086956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3086960">b</span><span class="op" id="3086961">.</span><span class="ident" id="3086962">lastRuneSize</span>&nbsp;<span class="op" id="3086975">=</span>&nbsp;<span class="op" id="3086977">-</span><span class="num" id="3086978">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3086981">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3086985">return</span><br>
<span class="lineno">305</span><span class="op" id="3086992">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3086995">//&nbsp;ReadLine&nbsp;is&nbsp;a&nbsp;low-level&nbsp;line-reading&nbsp;primitive.&nbsp;Most&nbsp;callers&nbsp;should&nbsp;use</span><br>
<span class="lineno"></span><span class="comment" id="3087070">//&nbsp;ReadBytes(&#39;\n&#39;)&nbsp;or&nbsp;ReadString(&#39;\n&#39;)&nbsp;instead&nbsp;or&nbsp;use&nbsp;a&nbsp;Scanner.</span><br>
<span class="lineno"></span><span class="comment" id="3087135">//</span><br>
<span class="lineno">310</span><span class="comment" id="3087138">//&nbsp;ReadLine&nbsp;tries&nbsp;to&nbsp;return&nbsp;a&nbsp;single&nbsp;line,&nbsp;not&nbsp;including&nbsp;the&nbsp;end-of-line&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="3087218">//&nbsp;If&nbsp;the&nbsp;line&nbsp;was&nbsp;too&nbsp;long&nbsp;for&nbsp;the&nbsp;buffer&nbsp;then&nbsp;isPrefix&nbsp;is&nbsp;set&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3087290">//&nbsp;beginning&nbsp;of&nbsp;the&nbsp;line&nbsp;is&nbsp;returned.&nbsp;The&nbsp;rest&nbsp;of&nbsp;the&nbsp;line&nbsp;will&nbsp;be&nbsp;returned</span><br>
<span class="lineno"></span><span class="comment" id="3087366">//&nbsp;from&nbsp;future&nbsp;calls.&nbsp;isPrefix&nbsp;will&nbsp;be&nbsp;false&nbsp;when&nbsp;returning&nbsp;the&nbsp;last&nbsp;fragment</span><br>
<span class="lineno"></span><span class="comment" id="3087444">//&nbsp;of&nbsp;the&nbsp;line.&nbsp;The&nbsp;returned&nbsp;buffer&nbsp;is&nbsp;only&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;call&nbsp;to</span><br>
<span class="lineno">315</span><span class="comment" id="3087517">//&nbsp;ReadLine.&nbsp;ReadLine&nbsp;either&nbsp;returns&nbsp;a&nbsp;non-nil&nbsp;line&nbsp;or&nbsp;it&nbsp;returns&nbsp;an&nbsp;error,</span><br>
<span class="lineno"></span><span class="comment" id="3087593">//&nbsp;never&nbsp;both.</span><br>
<span class="lineno"></span><span class="comment" id="3087608">//</span><br>
<span class="lineno"></span><span class="comment" id="3087611">//&nbsp;The&nbsp;text&nbsp;returned&nbsp;from&nbsp;ReadLine&nbsp;does&nbsp;not&nbsp;include&nbsp;the&nbsp;line&nbsp;end&nbsp;(&#34;\r\n&#34;&nbsp;or&nbsp;&#34;\n&#34;).</span><br>
<span class="lineno"></span><span class="comment" id="3087694">//&nbsp;No&nbsp;indication&nbsp;or&nbsp;error&nbsp;is&nbsp;given&nbsp;if&nbsp;the&nbsp;input&nbsp;ends&nbsp;without&nbsp;a&nbsp;final&nbsp;line&nbsp;end.</span><br>
<span class="lineno">320</span><span class="comment" id="3087773">//&nbsp;Calling&nbsp;UnreadByte&nbsp;after&nbsp;ReadLine&nbsp;will&nbsp;always&nbsp;unread&nbsp;the&nbsp;last&nbsp;byte&nbsp;read</span><br>
<span class="lineno"></span><span class="comment" id="3087848">//&nbsp;(possibly&nbsp;a&nbsp;character&nbsp;belonging&nbsp;to&nbsp;the&nbsp;line&nbsp;end)&nbsp;even&nbsp;if&nbsp;that&nbsp;byte&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="3087925">//&nbsp;part&nbsp;of&nbsp;the&nbsp;line&nbsp;returned&nbsp;by&nbsp;ReadLine.</span><br>
<span class="lineno"></span><span class="keyword" id="3087967">func</span>&nbsp;<span class="op" id="3087972">(</span><span class="ident" id="3087973">b</span>&nbsp;<span class="op" id="3087975">*</span><span class="ident" id="3087976">Reader</span><span class="op" id="3087982">)</span>&nbsp;<span class="ident" id="3087984">ReadLine</span><span class="op" id="3087992">(</span><span class="op" id="3087993">)</span>&nbsp;<span class="op" id="3087995">(</span><span class="ident" id="3087996">line</span>&nbsp;<span class="op" id="3088001">[</span><span class="op" id="3088002">]</span><span class="builtintype" id="3088003">byte</span><span class="op" id="3088007">,</span>&nbsp;<span class="ident" id="3088009">isPrefix</span>&nbsp;<span class="builtintype" id="3088018">bool</span><span class="op" id="3088022">,</span>&nbsp;<span class="ident" id="3088024">err</span>&nbsp;<span class="builtintype" id="3088028">error</span><span class="op" id="3088033">)</span>&nbsp;<span class="op" id="3088035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3088038">line</span><span class="op" id="3088042">,</span>&nbsp;<span class="ident" id="3088044">err</span>&nbsp;<span class="op" id="3088048">=</span>&nbsp;<span class="ident" id="3088050">b</span><span class="op" id="3088051">.</span><span class="ident" id="3088052">ReadSlice</span><span class="op" id="3088061">(</span><span class="string" id="3088062">&#39;\n&#39;</span><span class="op" id="3088066">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3088069">if</span>&nbsp;<span class="ident" id="3088072">err</span>&nbsp;<span class="op" id="3088076">==</span>&nbsp;<span class="ident" id="3088079">ErrBufferFull</span>&nbsp;<span class="op" id="3088093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3088097">//&nbsp;Handle&nbsp;the&nbsp;case&nbsp;where&nbsp;&#34;\r\n&#34;&nbsp;straddles&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3088153">if</span>&nbsp;<span class="builtinfunc" id="3088156">len</span><span class="op" id="3088159">(</span><span class="ident" id="3088160">line</span><span class="op" id="3088164">)</span>&nbsp;<span class="op" id="3088166">&gt;</span>&nbsp;<span class="num" id="3088168">0</span>&nbsp;<span class="op" id="3088170">&amp;&amp;</span>&nbsp;<span class="ident" id="3088173">line</span><span class="op" id="3088177">[</span><span class="builtinfunc" id="3088178">len</span><span class="op" id="3088181">(</span><span class="ident" id="3088182">line</span><span class="op" id="3088186">)</span><span class="op" id="3088187">-</span><span class="num" id="3088188">1</span><span class="op" id="3088189">]</span>&nbsp;<span class="op" id="3088191">==</span>&nbsp;<span class="string" id="3088194">&#39;\r&#39;</span>&nbsp;<span class="op" id="3088199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3088204">//&nbsp;Put&nbsp;the&nbsp;&#39;\r&#39;&nbsp;back&nbsp;on&nbsp;buf&nbsp;and&nbsp;drop&nbsp;it&nbsp;from&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3088258">//&nbsp;Let&nbsp;the&nbsp;next&nbsp;call&nbsp;to&nbsp;ReadLine&nbsp;check&nbsp;for&nbsp;&#34;\r\n&#34;.</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3088312">if</span>&nbsp;<span class="ident" id="3088315">b</span><span class="op" id="3088316">.</span><span class="ident" id="3088317">r</span>&nbsp;<span class="op" id="3088319">==</span>&nbsp;<span class="num" id="3088322">0</span>&nbsp;<span class="op" id="3088324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3088330">//&nbsp;should&nbsp;be&nbsp;unreachable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3088359">panic</span><span class="op" id="3088364">(</span><span class="string" id="3088365">&#34;bufio:&nbsp;tried&nbsp;to&nbsp;rewind&nbsp;past&nbsp;start&nbsp;of&nbsp;buffer&#34;</span><span class="op" id="3088410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3088415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3088420">b</span><span class="op" id="3088421">.</span><span class="ident" id="3088422">r</span><span class="op" id="3088423">--</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3088429">line</span>&nbsp;<span class="op" id="3088434">=</span>&nbsp;<span class="ident" id="3088436">line</span><span class="op" id="3088440">[</span><span class="op" id="3088441">:</span><span class="builtinfunc" id="3088442">len</span><span class="op" id="3088445">(</span><span class="ident" id="3088446">line</span><span class="op" id="3088450">)</span><span class="op" id="3088451">-</span><span class="num" id="3088452">1</span><span class="op" id="3088453">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3088457">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3088461">return</span>&nbsp;<span class="ident" id="3088468">line</span><span class="op" id="3088472">,</span>&nbsp;<span class="builtintype" id="3088474">true</span><span class="op" id="3088478">,</span>&nbsp;<span class="ident" id="3088480">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3088485">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3088489">if</span>&nbsp;<span class="builtinfunc" id="3088492">len</span><span class="op" id="3088495">(</span><span class="ident" id="3088496">line</span><span class="op" id="3088500">)</span>&nbsp;<span class="op" id="3088502">==</span>&nbsp;<span class="num" id="3088505">0</span>&nbsp;<span class="op" id="3088507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3088511">if</span>&nbsp;<span class="ident" id="3088514">err</span>&nbsp;<span class="op" id="3088518">!=</span>&nbsp;<span class="ident" id="3088521">nil</span>&nbsp;<span class="op" id="3088525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3088530">line</span>&nbsp;<span class="op" id="3088535">=</span>&nbsp;<span class="ident" id="3088537">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3088543">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3088547">return</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3088555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3088558">err</span>&nbsp;<span class="op" id="3088562">=</span>&nbsp;<span class="ident" id="3088564">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3088570">if</span>&nbsp;<span class="ident" id="3088573">line</span><span class="op" id="3088577">[</span><span class="builtinfunc" id="3088578">len</span><span class="op" id="3088581">(</span><span class="ident" id="3088582">line</span><span class="op" id="3088586">)</span><span class="op" id="3088587">-</span><span class="num" id="3088588">1</span><span class="op" id="3088589">]</span>&nbsp;<span class="op" id="3088591">==</span>&nbsp;<span class="string" id="3088594">&#39;\n&#39;</span>&nbsp;<span class="op" id="3088599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3088603">drop</span>&nbsp;<span class="op" id="3088608">:=</span>&nbsp;<span class="num" id="3088611">1</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3088615">if</span>&nbsp;<span class="builtinfunc" id="3088618">len</span><span class="op" id="3088621">(</span><span class="ident" id="3088622">line</span><span class="op" id="3088626">)</span>&nbsp;<span class="op" id="3088628">&gt;</span>&nbsp;<span class="num" id="3088630">1</span>&nbsp;<span class="op" id="3088632">&amp;&amp;</span>&nbsp;<span class="ident" id="3088635">line</span><span class="op" id="3088639">[</span><span class="builtinfunc" id="3088640">len</span><span class="op" id="3088643">(</span><span class="ident" id="3088644">line</span><span class="op" id="3088648">)</span><span class="op" id="3088649">-</span><span class="num" id="3088650">2</span><span class="op" id="3088651">]</span>&nbsp;<span class="op" id="3088653">==</span>&nbsp;<span class="string" id="3088656">&#39;\r&#39;</span>&nbsp;<span class="op" id="3088661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3088666">drop</span>&nbsp;<span class="op" id="3088671">=</span>&nbsp;<span class="num" id="3088673">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3088677">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3088681">line</span>&nbsp;<span class="op" id="3088686">=</span>&nbsp;<span class="ident" id="3088688">line</span><span class="op" id="3088692">[</span><span class="op" id="3088693">:</span><span class="builtinfunc" id="3088694">len</span><span class="op" id="3088697">(</span><span class="ident" id="3088698">line</span><span class="op" id="3088702">)</span><span class="op" id="3088703">-</span><span class="ident" id="3088704">drop</span><span class="op" id="3088708">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3088711">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3088714">return</span><br>
<span class="lineno"></span><span class="op" id="3088721">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3088724">//&nbsp;ReadBytes&nbsp;reads&nbsp;until&nbsp;the&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;delim&nbsp;in&nbsp;the&nbsp;input,</span><br>
<span class="lineno"></span><span class="comment" id="3088793">//&nbsp;returning&nbsp;a&nbsp;slice&nbsp;containing&nbsp;the&nbsp;data&nbsp;up&nbsp;to&nbsp;and&nbsp;including&nbsp;the&nbsp;delimiter.</span><br>
<span class="lineno">360</span><span class="comment" id="3088869">//&nbsp;If&nbsp;ReadBytes&nbsp;encounters&nbsp;an&nbsp;error&nbsp;before&nbsp;finding&nbsp;a&nbsp;delimiter,</span><br>
<span class="lineno"></span><span class="comment" id="3088933">//&nbsp;it&nbsp;returns&nbsp;the&nbsp;data&nbsp;read&nbsp;before&nbsp;the&nbsp;error&nbsp;and&nbsp;the&nbsp;error&nbsp;itself&nbsp;(often&nbsp;io.EOF).</span><br>
<span class="lineno"></span><span class="comment" id="3089015">//&nbsp;ReadBytes&nbsp;returns&nbsp;err&nbsp;!=&nbsp;nil&nbsp;if&nbsp;and&nbsp;only&nbsp;if&nbsp;the&nbsp;returned&nbsp;data&nbsp;does&nbsp;not&nbsp;end&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="3089096">//&nbsp;delim.</span><br>
<span class="lineno"></span><span class="comment" id="3089106">//&nbsp;For&nbsp;simple&nbsp;uses,&nbsp;a&nbsp;Scanner&nbsp;may&nbsp;be&nbsp;more&nbsp;convenient.</span><br>
<span class="lineno">365</span><span class="keyword" id="3089160">func</span>&nbsp;<span class="op" id="3089165">(</span><span class="ident" id="3089166">b</span>&nbsp;<span class="op" id="3089168">*</span><span class="ident" id="3089169">Reader</span><span class="op" id="3089175">)</span>&nbsp;<span class="ident" id="3089177">ReadBytes</span><span class="op" id="3089186">(</span><span class="ident" id="3089187">delim</span>&nbsp;<span class="builtintype" id="3089193">byte</span><span class="op" id="3089197">)</span>&nbsp;<span class="op" id="3089199">(</span><span class="ident" id="3089200">line</span>&nbsp;<span class="op" id="3089205">[</span><span class="op" id="3089206">]</span><span class="builtintype" id="3089207">byte</span><span class="op" id="3089211">,</span>&nbsp;<span class="ident" id="3089213">err</span>&nbsp;<span class="builtintype" id="3089217">error</span><span class="op" id="3089222">)</span>&nbsp;<span class="op" id="3089224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3089227">//&nbsp;Use&nbsp;ReadSlice&nbsp;to&nbsp;look&nbsp;for&nbsp;array,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3089264">//&nbsp;accumulating&nbsp;full&nbsp;buffers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3089295">var</span>&nbsp;<span class="ident" id="3089299">frag</span>&nbsp;<span class="op" id="3089304">[</span><span class="op" id="3089305">]</span><span class="builtintype" id="3089306">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3089312">var</span>&nbsp;<span class="ident" id="3089316">full</span>&nbsp;<span class="op" id="3089321">[</span><span class="op" id="3089322">]</span><span class="op" id="3089323">[</span><span class="op" id="3089324">]</span><span class="builtintype" id="3089325">byte</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3089331">err</span>&nbsp;<span class="op" id="3089335">=</span>&nbsp;<span class="ident" id="3089337">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3089343">for</span>&nbsp;<span class="op" id="3089347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3089351">var</span>&nbsp;<span class="ident" id="3089355">e</span>&nbsp;<span class="builtintype" id="3089357">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3089365">frag</span><span class="op" id="3089369">,</span>&nbsp;<span class="ident" id="3089371">e</span>&nbsp;<span class="op" id="3089373">=</span>&nbsp;<span class="ident" id="3089375">b</span><span class="op" id="3089376">.</span><span class="ident" id="3089377">ReadSlice</span><span class="op" id="3089386">(</span><span class="ident" id="3089387">delim</span><span class="op" id="3089392">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3089396">if</span>&nbsp;<span class="ident" id="3089399">e</span>&nbsp;<span class="op" id="3089401">==</span>&nbsp;<span class="ident" id="3089404">nil</span>&nbsp;<span class="op" id="3089408">{</span>&nbsp;<span class="comment" id="3089410">//&nbsp;got&nbsp;final&nbsp;fragment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3089435">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3089443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3089447">if</span>&nbsp;<span class="ident" id="3089450">e</span>&nbsp;<span class="op" id="3089452">!=</span>&nbsp;<span class="ident" id="3089455">ErrBufferFull</span>&nbsp;<span class="op" id="3089469">{</span>&nbsp;<span class="comment" id="3089471">//&nbsp;unexpected&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3089494">err</span>&nbsp;<span class="op" id="3089498">=</span>&nbsp;<span class="ident" id="3089500">e</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3089505">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3089513">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3089518">//&nbsp;Make&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3089550">buf</span>&nbsp;<span class="op" id="3089554">:=</span>&nbsp;<span class="builtinfunc" id="3089557">make</span><span class="op" id="3089561">(</span><span class="op" id="3089562">[</span><span class="op" id="3089563">]</span><span class="builtintype" id="3089564">byte</span><span class="op" id="3089568">,</span>&nbsp;<span class="builtinfunc" id="3089570">len</span><span class="op" id="3089573">(</span><span class="ident" id="3089574">frag</span><span class="op" id="3089578">)</span><span class="op" id="3089579">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3089583">copy</span><span class="op" id="3089587">(</span><span class="ident" id="3089588">buf</span><span class="op" id="3089591">,</span>&nbsp;<span class="ident" id="3089593">frag</span><span class="op" id="3089597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3089601">full</span>&nbsp;<span class="op" id="3089606">=</span>&nbsp;<span class="builtinfunc" id="3089608">append</span><span class="op" id="3089614">(</span><span class="ident" id="3089615">full</span><span class="op" id="3089619">,</span>&nbsp;<span class="ident" id="3089621">buf</span><span class="op" id="3089624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3089627">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3089631">//&nbsp;Allocate&nbsp;new&nbsp;buffer&nbsp;to&nbsp;hold&nbsp;the&nbsp;full&nbsp;pieces&nbsp;and&nbsp;the&nbsp;fragment.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3089697">n</span>&nbsp;<span class="op" id="3089699">:=</span>&nbsp;<span class="num" id="3089702">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3089705">for</span>&nbsp;<span class="ident" id="3089709">i</span>&nbsp;<span class="op" id="3089711">:=</span>&nbsp;<span class="keyword" id="3089714">range</span>&nbsp;<span class="ident" id="3089720">full</span>&nbsp;<span class="op" id="3089725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3089729">n</span>&nbsp;<span class="op" id="3089731">+=</span>&nbsp;<span class="builtinfunc" id="3089734">len</span><span class="op" id="3089737">(</span><span class="ident" id="3089738">full</span><span class="op" id="3089742">[</span><span class="ident" id="3089743">i</span><span class="op" id="3089744">]</span><span class="op" id="3089745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3089748">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3089751">n</span>&nbsp;<span class="op" id="3089753">+=</span>&nbsp;<span class="builtinfunc" id="3089756">len</span><span class="op" id="3089759">(</span><span class="ident" id="3089760">frag</span><span class="op" id="3089764">)</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3089768">//&nbsp;Copy&nbsp;full&nbsp;pieces&nbsp;and&nbsp;fragment&nbsp;in.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3089806">buf</span>&nbsp;<span class="op" id="3089810">:=</span>&nbsp;<span class="builtinfunc" id="3089813">make</span><span class="op" id="3089817">(</span><span class="op" id="3089818">[</span><span class="op" id="3089819">]</span><span class="builtintype" id="3089820">byte</span><span class="op" id="3089824">,</span>&nbsp;<span class="ident" id="3089826">n</span><span class="op" id="3089827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3089830">n</span>&nbsp;<span class="op" id="3089832">=</span>&nbsp;<span class="num" id="3089834">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3089837">for</span>&nbsp;<span class="ident" id="3089841">i</span>&nbsp;<span class="op" id="3089843">:=</span>&nbsp;<span class="keyword" id="3089846">range</span>&nbsp;<span class="ident" id="3089852">full</span>&nbsp;<span class="op" id="3089857">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3089861">n</span>&nbsp;<span class="op" id="3089863">+=</span>&nbsp;<span class="builtinfunc" id="3089866">copy</span><span class="op" id="3089870">(</span><span class="ident" id="3089871">buf</span><span class="op" id="3089874">[</span><span class="ident" id="3089875">n</span><span class="op" id="3089876">:</span><span class="op" id="3089877">]</span><span class="op" id="3089878">,</span>&nbsp;<span class="ident" id="3089880">full</span><span class="op" id="3089884">[</span><span class="ident" id="3089885">i</span><span class="op" id="3089886">]</span><span class="op" id="3089887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3089890">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3089893">copy</span><span class="op" id="3089897">(</span><span class="ident" id="3089898">buf</span><span class="op" id="3089901">[</span><span class="ident" id="3089902">n</span><span class="op" id="3089903">:</span><span class="op" id="3089904">]</span><span class="op" id="3089905">,</span>&nbsp;<span class="ident" id="3089907">frag</span><span class="op" id="3089911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3089914">return</span>&nbsp;<span class="ident" id="3089921">buf</span><span class="op" id="3089924">,</span>&nbsp;<span class="ident" id="3089926">err</span><br>
<span class="lineno"></span><span class="op" id="3089930">}</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span><span class="comment" id="3089933">//&nbsp;ReadString&nbsp;reads&nbsp;until&nbsp;the&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;delim&nbsp;in&nbsp;the&nbsp;input,</span><br>
<span class="lineno"></span><span class="comment" id="3090003">//&nbsp;returning&nbsp;a&nbsp;string&nbsp;containing&nbsp;the&nbsp;data&nbsp;up&nbsp;to&nbsp;and&nbsp;including&nbsp;the&nbsp;delimiter.</span><br>
<span class="lineno"></span><span class="comment" id="3090080">//&nbsp;If&nbsp;ReadString&nbsp;encounters&nbsp;an&nbsp;error&nbsp;before&nbsp;finding&nbsp;a&nbsp;delimiter,</span><br>
<span class="lineno"></span><span class="comment" id="3090145">//&nbsp;it&nbsp;returns&nbsp;the&nbsp;data&nbsp;read&nbsp;before&nbsp;the&nbsp;error&nbsp;and&nbsp;the&nbsp;error&nbsp;itself&nbsp;(often&nbsp;io.EOF).</span><br>
<span class="lineno">410</span><span class="comment" id="3090227">//&nbsp;ReadString&nbsp;returns&nbsp;err&nbsp;!=&nbsp;nil&nbsp;if&nbsp;and&nbsp;only&nbsp;if&nbsp;the&nbsp;returned&nbsp;data&nbsp;does&nbsp;not&nbsp;end&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="3090309">//&nbsp;delim.</span><br>
<span class="lineno"></span><span class="comment" id="3090319">//&nbsp;For&nbsp;simple&nbsp;uses,&nbsp;a&nbsp;Scanner&nbsp;may&nbsp;be&nbsp;more&nbsp;convenient.</span><br>
<span class="lineno"></span><span class="keyword" id="3090373">func</span>&nbsp;<span class="op" id="3090378">(</span><span class="ident" id="3090379">b</span>&nbsp;<span class="op" id="3090381">*</span><span class="ident" id="3090382">Reader</span><span class="op" id="3090388">)</span>&nbsp;<span class="ident" id="3090390">ReadString</span><span class="op" id="3090400">(</span><span class="ident" id="3090401">delim</span>&nbsp;<span class="builtintype" id="3090407">byte</span><span class="op" id="3090411">)</span>&nbsp;<span class="op" id="3090413">(</span><span class="ident" id="3090414">line</span>&nbsp;<span class="builtintype" id="3090419">string</span><span class="op" id="3090425">,</span>&nbsp;<span class="ident" id="3090427">err</span>&nbsp;<span class="builtintype" id="3090431">error</span><span class="op" id="3090436">)</span>&nbsp;<span class="op" id="3090438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3090441">bytes</span><span class="op" id="3090446">,</span>&nbsp;<span class="ident" id="3090448">err</span>&nbsp;<span class="op" id="3090452">:=</span>&nbsp;<span class="ident" id="3090455">b</span><span class="op" id="3090456">.</span><span class="ident" id="3090457">ReadBytes</span><span class="op" id="3090466">(</span><span class="ident" id="3090467">delim</span><span class="op" id="3090472">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3090475">line</span>&nbsp;<span class="op" id="3090480">=</span>&nbsp;<span class="builtintype" id="3090482">string</span><span class="op" id="3090488">(</span><span class="ident" id="3090489">bytes</span><span class="op" id="3090494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3090497">return</span>&nbsp;<span class="ident" id="3090504">line</span><span class="op" id="3090508">,</span>&nbsp;<span class="ident" id="3090510">err</span><br>
<span class="lineno"></span><span class="op" id="3090514">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3090517">//&nbsp;WriteTo&nbsp;implements&nbsp;io.WriterTo.</span><br>
<span class="lineno">420</span><span class="keyword" id="3090552">func</span>&nbsp;<span class="op" id="3090557">(</span><span class="ident" id="3090558">b</span>&nbsp;<span class="op" id="3090560">*</span><span class="ident" id="3090561">Reader</span><span class="op" id="3090567">)</span>&nbsp;<span class="ident" id="3090569">WriteTo</span><span class="op" id="3090576">(</span><span class="ident" id="3090577">w</span>&nbsp;<span class="ident" id="3090579">io</span><span class="op" id="3090581">.</span><span class="ident" id="3090582">Writer</span><span class="op" id="3090588">)</span>&nbsp;<span class="op" id="3090590">(</span><span class="ident" id="3090591">n</span>&nbsp;<span class="ident" id="3090593">int64</span><span class="op" id="3090598">,</span>&nbsp;<span class="ident" id="3090600">err</span>&nbsp;<span class="builtintype" id="3090604">error</span><span class="op" id="3090609">)</span>&nbsp;<span class="op" id="3090611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3090614">n</span><span class="op" id="3090615">,</span>&nbsp;<span class="ident" id="3090617">err</span>&nbsp;<span class="op" id="3090621">=</span>&nbsp;<span class="ident" id="3090623">b</span><span class="op" id="3090624">.</span><span class="ident" id="3090625">writeBuf</span><span class="op" id="3090633">(</span><span class="ident" id="3090634">w</span><span class="op" id="3090635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3090638">if</span>&nbsp;<span class="ident" id="3090641">err</span>&nbsp;<span class="op" id="3090645">!=</span>&nbsp;<span class="ident" id="3090648">nil</span>&nbsp;<span class="op" id="3090652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3090656">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3090664">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3090668">if</span>&nbsp;<span class="ident" id="3090671">r</span><span class="op" id="3090672">,</span>&nbsp;<span class="ident" id="3090674">ok</span>&nbsp;<span class="op" id="3090677">:=</span>&nbsp;<span class="ident" id="3090680">b</span><span class="op" id="3090681">.</span><span class="ident" id="3090682">rd</span><span class="op" id="3090684">.</span><span class="op" id="3090685">(</span><span class="ident" id="3090686">io</span><span class="op" id="3090688">.</span><span class="ident" id="3090689">WriterTo</span><span class="op" id="3090697">)</span><span class="op" id="3090698">;</span>&nbsp;<span class="ident" id="3090700">ok</span>&nbsp;<span class="op" id="3090703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3090707">m</span><span class="op" id="3090708">,</span>&nbsp;<span class="ident" id="3090710">err</span>&nbsp;<span class="op" id="3090714">:=</span>&nbsp;<span class="ident" id="3090717">r</span><span class="op" id="3090718">.</span><span class="ident" id="3090719">WriteTo</span><span class="op" id="3090726">(</span><span class="ident" id="3090727">w</span><span class="op" id="3090728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3090732">n</span>&nbsp;<span class="op" id="3090734">+=</span>&nbsp;<span class="ident" id="3090737">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3090741">return</span>&nbsp;<span class="ident" id="3090748">n</span><span class="op" id="3090749">,</span>&nbsp;<span class="ident" id="3090751">err</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3090756">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3090760">if</span>&nbsp;<span class="ident" id="3090763">w</span><span class="op" id="3090764">,</span>&nbsp;<span class="ident" id="3090766">ok</span>&nbsp;<span class="op" id="3090769">:=</span>&nbsp;<span class="ident" id="3090772">w</span><span class="op" id="3090773">.</span><span class="op" id="3090774">(</span><span class="ident" id="3090775">io</span><span class="op" id="3090777">.</span><span class="ident" id="3090778">ReaderFrom</span><span class="op" id="3090788">)</span><span class="op" id="3090789">;</span>&nbsp;<span class="ident" id="3090791">ok</span>&nbsp;<span class="op" id="3090794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3090798">m</span><span class="op" id="3090799">,</span>&nbsp;<span class="ident" id="3090801">err</span>&nbsp;<span class="op" id="3090805">:=</span>&nbsp;<span class="ident" id="3090808">w</span><span class="op" id="3090809">.</span><span class="ident" id="3090810">ReadFrom</span><span class="op" id="3090818">(</span><span class="ident" id="3090819">b</span><span class="op" id="3090820">.</span><span class="ident" id="3090821">rd</span><span class="op" id="3090823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3090827">n</span>&nbsp;<span class="op" id="3090829">+=</span>&nbsp;<span class="ident" id="3090832">m</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3090836">return</span>&nbsp;<span class="ident" id="3090843">n</span><span class="op" id="3090844">,</span>&nbsp;<span class="ident" id="3090846">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3090851">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3090855">if</span>&nbsp;<span class="ident" id="3090858">b</span><span class="op" id="3090859">.</span><span class="ident" id="3090860">w</span><span class="op" id="3090861">-</span><span class="ident" id="3090862">b</span><span class="op" id="3090863">.</span><span class="ident" id="3090864">r</span>&nbsp;<span class="op" id="3090866">&lt;</span>&nbsp;<span class="builtinfunc" id="3090868">len</span><span class="op" id="3090871">(</span><span class="ident" id="3090872">b</span><span class="op" id="3090873">.</span><span class="ident" id="3090874">buf</span><span class="op" id="3090877">)</span>&nbsp;<span class="op" id="3090879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3090883">b</span><span class="op" id="3090884">.</span><span class="ident" id="3090885">fill</span><span class="op" id="3090889">(</span><span class="op" id="3090890">)</span>&nbsp;<span class="comment" id="3090892">//&nbsp;buffer&nbsp;not&nbsp;full</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3090912">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3090916">for</span>&nbsp;<span class="ident" id="3090920">b</span><span class="op" id="3090921">.</span><span class="ident" id="3090922">r</span>&nbsp;<span class="op" id="3090924">&lt;</span>&nbsp;<span class="ident" id="3090926">b</span><span class="op" id="3090927">.</span><span class="ident" id="3090928">w</span>&nbsp;<span class="op" id="3090930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3090934">//&nbsp;b.r&nbsp;&lt;&nbsp;b.w&nbsp;=&gt;&nbsp;buffer&nbsp;is&nbsp;not&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3090972">m</span><span class="op" id="3090973">,</span>&nbsp;<span class="ident" id="3090975">err</span>&nbsp;<span class="op" id="3090979">:=</span>&nbsp;<span class="ident" id="3090982">b</span><span class="op" id="3090983">.</span><span class="ident" id="3090984">writeBuf</span><span class="op" id="3090992">(</span><span class="ident" id="3090993">w</span><span class="op" id="3090994">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3090998">n</span>&nbsp;<span class="op" id="3091000">+=</span>&nbsp;<span class="ident" id="3091003">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3091007">if</span>&nbsp;<span class="ident" id="3091010">err</span>&nbsp;<span class="op" id="3091014">!=</span>&nbsp;<span class="ident" id="3091017">nil</span>&nbsp;<span class="op" id="3091021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3091026">return</span>&nbsp;<span class="ident" id="3091033">n</span><span class="op" id="3091034">,</span>&nbsp;<span class="ident" id="3091036">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3091042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3091046">b</span><span class="op" id="3091047">.</span><span class="ident" id="3091048">fill</span><span class="op" id="3091052">(</span><span class="op" id="3091053">)</span>&nbsp;<span class="comment" id="3091055">//&nbsp;buffer&nbsp;is&nbsp;empty</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3091075">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3091079">if</span>&nbsp;<span class="ident" id="3091082">b</span><span class="op" id="3091083">.</span><span class="ident" id="3091084">err</span>&nbsp;<span class="op" id="3091088">==</span>&nbsp;<span class="ident" id="3091091">io</span><span class="op" id="3091093">.</span><span class="ident" id="3091094">EOF</span>&nbsp;<span class="op" id="3091098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3091102">b</span><span class="op" id="3091103">.</span><span class="ident" id="3091104">err</span>&nbsp;<span class="op" id="3091108">=</span>&nbsp;<span class="ident" id="3091110">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3091115">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3091119">return</span>&nbsp;<span class="ident" id="3091126">n</span><span class="op" id="3091127">,</span>&nbsp;<span class="ident" id="3091129">b</span><span class="op" id="3091130">.</span><span class="ident" id="3091131">readErr</span><span class="op" id="3091138">(</span><span class="op" id="3091139">)</span><br>
<span class="lineno"></span><span class="op" id="3091141">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3091144">var</span>&nbsp;<span class="ident" id="3091148">errNegativeWrite</span>&nbsp;<span class="op" id="3091165">=</span>&nbsp;<span class="ident" id="3091167">errors</span><span class="op" id="3091173">.</span><span class="ident" id="3091174">New</span><span class="op" id="3091177">(</span><span class="string" id="3091178">&#34;bufio:&nbsp;writer&nbsp;returned&nbsp;negative&nbsp;count&nbsp;from&nbsp;Write&#34;</span><span class="op" id="3091228">)</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span><span class="comment" id="3091231">//&nbsp;writeBuf&nbsp;writes&nbsp;the&nbsp;Reader&#39;s&nbsp;buffer&nbsp;to&nbsp;the&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="3091285">func</span>&nbsp;<span class="op" id="3091290">(</span><span class="ident" id="3091291">b</span>&nbsp;<span class="op" id="3091293">*</span><span class="ident" id="3091294">Reader</span><span class="op" id="3091300">)</span>&nbsp;<span class="ident" id="3091302">writeBuf</span><span class="op" id="3091310">(</span><span class="ident" id="3091311">w</span>&nbsp;<span class="ident" id="3091313">io</span><span class="op" id="3091315">.</span><span class="ident" id="3091316">Writer</span><span class="op" id="3091322">)</span>&nbsp;<span class="op" id="3091324">(</span><span class="ident" id="3091325">int64</span><span class="op" id="3091330">,</span>&nbsp;<span class="builtintype" id="3091332">error</span><span class="op" id="3091337">)</span>&nbsp;<span class="op" id="3091339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3091342">n</span><span class="op" id="3091343">,</span>&nbsp;<span class="ident" id="3091345">err</span>&nbsp;<span class="op" id="3091349">:=</span>&nbsp;<span class="ident" id="3091352">w</span><span class="op" id="3091353">.</span><span class="ident" id="3091354">Write</span><span class="op" id="3091359">(</span><span class="ident" id="3091360">b</span><span class="op" id="3091361">.</span><span class="ident" id="3091362">buf</span><span class="op" id="3091365">[</span><span class="ident" id="3091366">b</span><span class="op" id="3091367">.</span><span class="ident" id="3091368">r</span><span class="op" id="3091369">:</span><span class="ident" id="3091370">b</span><span class="op" id="3091371">.</span><span class="ident" id="3091372">w</span><span class="op" id="3091373">]</span><span class="op" id="3091374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3091377">if</span>&nbsp;<span class="ident" id="3091380">n</span>&nbsp;<span class="op" id="3091382">&lt;</span>&nbsp;<span class="num" id="3091384">0</span>&nbsp;<span class="op" id="3091386">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3091390">panic</span><span class="op" id="3091395">(</span><span class="ident" id="3091396">errNegativeWrite</span><span class="op" id="3091412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3091415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3091418">b</span><span class="op" id="3091419">.</span><span class="ident" id="3091420">r</span>&nbsp;<span class="op" id="3091422">+=</span>&nbsp;<span class="ident" id="3091425">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3091428">return</span>&nbsp;<span class="ident" id="3091435">int64</span><span class="op" id="3091440">(</span><span class="ident" id="3091441">n</span><span class="op" id="3091442">)</span><span class="op" id="3091443">,</span>&nbsp;<span class="ident" id="3091445">err</span><br>
<span class="lineno"></span><span class="op" id="3091449">}</span><br>
<span class="lineno">470</span><br>
<span class="lineno"></span><span class="comment" id="3091452">//&nbsp;buffered&nbsp;output</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3091472">//&nbsp;Writer&nbsp;implements&nbsp;buffering&nbsp;for&nbsp;an&nbsp;io.Writer&nbsp;object.</span><br>
<span class="lineno"></span><span class="comment" id="3091528">//&nbsp;If&nbsp;an&nbsp;error&nbsp;occurs&nbsp;writing&nbsp;to&nbsp;a&nbsp;Writer,&nbsp;no&nbsp;more&nbsp;data&nbsp;will&nbsp;be</span><br>
<span class="lineno">475</span><span class="comment" id="3091592">//&nbsp;accepted&nbsp;and&nbsp;all&nbsp;subsequent&nbsp;writes&nbsp;will&nbsp;return&nbsp;the&nbsp;error.</span><br>
<span class="lineno"></span><span class="comment" id="3091653">//&nbsp;After&nbsp;all&nbsp;data&nbsp;has&nbsp;been&nbsp;written,&nbsp;the&nbsp;client&nbsp;should&nbsp;call&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3091716">//&nbsp;Flush&nbsp;method&nbsp;to&nbsp;guarantee&nbsp;all&nbsp;data&nbsp;has&nbsp;been&nbsp;forwarded&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3091776">//&nbsp;the&nbsp;underlying&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="3091805">type</span>&nbsp;<span class="ident" id="3091810">Writer</span>&nbsp;<span class="keyword" id="3091817">struct</span>&nbsp;<span class="op" id="3091824">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3091827">err</span>&nbsp;<span class="builtintype" id="3091831">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3091838">buf</span>&nbsp;<span class="op" id="3091842">[</span><span class="op" id="3091843">]</span><span class="builtintype" id="3091844">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3091850">n</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3091854">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3091859">wr</span>&nbsp;&nbsp;<span class="ident" id="3091863">io</span><span class="op" id="3091865">.</span><span class="ident" id="3091866">Writer</span><br>
<span class="lineno"></span><span class="op" id="3091873">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="comment" id="3091876">//&nbsp;NewWriterSize&nbsp;returns&nbsp;a&nbsp;new&nbsp;Writer&nbsp;whose&nbsp;buffer&nbsp;has&nbsp;at&nbsp;least&nbsp;the&nbsp;specified</span><br>
<span class="lineno"></span><span class="comment" id="3091954">//&nbsp;size.&nbsp;If&nbsp;the&nbsp;argument&nbsp;io.Writer&nbsp;is&nbsp;already&nbsp;a&nbsp;Writer&nbsp;with&nbsp;large&nbsp;enough</span><br>
<span class="lineno"></span><span class="comment" id="3092027">//&nbsp;size,&nbsp;it&nbsp;returns&nbsp;the&nbsp;underlying&nbsp;Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="3092070">func</span>&nbsp;<span class="ident" id="3092075">NewWriterSize</span><span class="op" id="3092088">(</span><span class="ident" id="3092089">w</span>&nbsp;<span class="ident" id="3092091">io</span><span class="op" id="3092093">.</span><span class="ident" id="3092094">Writer</span><span class="op" id="3092100">,</span>&nbsp;<span class="ident" id="3092102">size</span>&nbsp;<span class="builtintype" id="3092107">int</span><span class="op" id="3092110">)</span>&nbsp;<span class="op" id="3092112">*</span><span class="ident" id="3092113">Writer</span>&nbsp;<span class="op" id="3092120">{</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3092123">//&nbsp;Is&nbsp;it&nbsp;already&nbsp;a&nbsp;Writer?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3092151">b</span><span class="op" id="3092152">,</span>&nbsp;<span class="ident" id="3092154">ok</span>&nbsp;<span class="op" id="3092157">:=</span>&nbsp;<span class="ident" id="3092160">w</span><span class="op" id="3092161">.</span><span class="op" id="3092162">(</span><span class="op" id="3092163">*</span><span class="ident" id="3092164">Writer</span><span class="op" id="3092170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3092173">if</span>&nbsp;<span class="ident" id="3092176">ok</span>&nbsp;<span class="op" id="3092179">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3092182">len</span><span class="op" id="3092185">(</span><span class="ident" id="3092186">b</span><span class="op" id="3092187">.</span><span class="ident" id="3092188">buf</span><span class="op" id="3092191">)</span>&nbsp;<span class="op" id="3092193">&gt;=</span>&nbsp;<span class="ident" id="3092196">size</span>&nbsp;<span class="op" id="3092201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3092205">return</span>&nbsp;<span class="ident" id="3092212">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3092215">}</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3092218">if</span>&nbsp;<span class="ident" id="3092221">size</span>&nbsp;<span class="op" id="3092226">&lt;=</span>&nbsp;<span class="num" id="3092229">0</span>&nbsp;<span class="op" id="3092231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3092235">size</span>&nbsp;<span class="op" id="3092240">=</span>&nbsp;<span class="ident" id="3092242">defaultBufSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3092258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3092261">return</span>&nbsp;<span class="op" id="3092268">&amp;</span><span class="ident" id="3092269">Writer</span><span class="op" id="3092275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3092279">buf</span><span class="op" id="3092282">:</span>&nbsp;<span class="builtinfunc" id="3092284">make</span><span class="op" id="3092288">(</span><span class="op" id="3092289">[</span><span class="op" id="3092290">]</span><span class="builtintype" id="3092291">byte</span><span class="op" id="3092295">,</span>&nbsp;<span class="ident" id="3092297">size</span><span class="op" id="3092301">)</span><span class="op" id="3092302">,</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3092306">wr</span><span class="op" id="3092308">:</span>&nbsp;&nbsp;<span class="ident" id="3092311">w</span><span class="op" id="3092312">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3092315">}</span><br>
<span class="lineno"></span><span class="op" id="3092317">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3092320">//&nbsp;NewWriter&nbsp;returns&nbsp;a&nbsp;new&nbsp;Writer&nbsp;whose&nbsp;buffer&nbsp;has&nbsp;the&nbsp;default&nbsp;size.</span><br>
<span class="lineno">505</span><span class="keyword" id="3092389">func</span>&nbsp;<span class="ident" id="3092394">NewWriter</span><span class="op" id="3092403">(</span><span class="ident" id="3092404">w</span>&nbsp;<span class="ident" id="3092406">io</span><span class="op" id="3092408">.</span><span class="ident" id="3092409">Writer</span><span class="op" id="3092415">)</span>&nbsp;<span class="op" id="3092417">*</span><span class="ident" id="3092418">Writer</span>&nbsp;<span class="op" id="3092425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3092428">return</span>&nbsp;<span class="ident" id="3092435">NewWriterSize</span><span class="op" id="3092448">(</span><span class="ident" id="3092449">w</span><span class="op" id="3092450">,</span>&nbsp;<span class="ident" id="3092452">defaultBufSize</span><span class="op" id="3092466">)</span><br>
<span class="lineno"></span><span class="op" id="3092468">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3092471">//&nbsp;Reset&nbsp;discards&nbsp;any&nbsp;unflushed&nbsp;buffered&nbsp;data,&nbsp;clears&nbsp;any&nbsp;error,&nbsp;and</span><br>
<span class="lineno">510</span><span class="comment" id="3092540">//&nbsp;resets&nbsp;b&nbsp;to&nbsp;write&nbsp;its&nbsp;output&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="keyword" id="3092578">func</span>&nbsp;<span class="op" id="3092583">(</span><span class="ident" id="3092584">b</span>&nbsp;<span class="op" id="3092586">*</span><span class="ident" id="3092587">Writer</span><span class="op" id="3092593">)</span>&nbsp;<span class="ident" id="3092595">Reset</span><span class="op" id="3092600">(</span><span class="ident" id="3092601">w</span>&nbsp;<span class="ident" id="3092603">io</span><span class="op" id="3092605">.</span><span class="ident" id="3092606">Writer</span><span class="op" id="3092612">)</span>&nbsp;<span class="op" id="3092614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3092617">b</span><span class="op" id="3092618">.</span><span class="ident" id="3092619">err</span>&nbsp;<span class="op" id="3092623">=</span>&nbsp;<span class="ident" id="3092625">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3092630">b</span><span class="op" id="3092631">.</span><span class="ident" id="3092632">n</span>&nbsp;<span class="op" id="3092634">=</span>&nbsp;<span class="num" id="3092636">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3092639">b</span><span class="op" id="3092640">.</span><span class="ident" id="3092641">wr</span>&nbsp;<span class="op" id="3092644">=</span>&nbsp;<span class="ident" id="3092646">w</span><br>
<span class="lineno">515</span><span class="op" id="3092648">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3092651">//&nbsp;Flush&nbsp;writes&nbsp;any&nbsp;buffered&nbsp;data&nbsp;to&nbsp;the&nbsp;underlying&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="3092714">func</span>&nbsp;<span class="op" id="3092719">(</span><span class="ident" id="3092720">b</span>&nbsp;<span class="op" id="3092722">*</span><span class="ident" id="3092723">Writer</span><span class="op" id="3092729">)</span>&nbsp;<span class="ident" id="3092731">Flush</span><span class="op" id="3092736">(</span><span class="op" id="3092737">)</span>&nbsp;<span class="builtintype" id="3092739">error</span>&nbsp;<span class="op" id="3092745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3092748">err</span>&nbsp;<span class="op" id="3092752">:=</span>&nbsp;<span class="ident" id="3092755">b</span><span class="op" id="3092756">.</span><span class="ident" id="3092757">flush</span><span class="op" id="3092762">(</span><span class="op" id="3092763">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3092766">return</span>&nbsp;<span class="ident" id="3092773">err</span><br>
<span class="lineno"></span><span class="op" id="3092777">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3092780">func</span>&nbsp;<span class="op" id="3092785">(</span><span class="ident" id="3092786">b</span>&nbsp;<span class="op" id="3092788">*</span><span class="ident" id="3092789">Writer</span><span class="op" id="3092795">)</span>&nbsp;<span class="ident" id="3092797">flush</span><span class="op" id="3092802">(</span><span class="op" id="3092803">)</span>&nbsp;<span class="builtintype" id="3092805">error</span>&nbsp;<span class="op" id="3092811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3092814">if</span>&nbsp;<span class="ident" id="3092817">b</span><span class="op" id="3092818">.</span><span class="ident" id="3092819">err</span>&nbsp;<span class="op" id="3092823">!=</span>&nbsp;<span class="ident" id="3092826">nil</span>&nbsp;<span class="op" id="3092830">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3092834">return</span>&nbsp;<span class="ident" id="3092841">b</span><span class="op" id="3092842">.</span><span class="ident" id="3092843">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3092848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3092851">if</span>&nbsp;<span class="ident" id="3092854">b</span><span class="op" id="3092855">.</span><span class="ident" id="3092856">n</span>&nbsp;<span class="op" id="3092858">==</span>&nbsp;<span class="num" id="3092861">0</span>&nbsp;<span class="op" id="3092863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3092867">return</span>&nbsp;<span class="ident" id="3092874">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3092879">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3092882">n</span><span class="op" id="3092883">,</span>&nbsp;<span class="ident" id="3092885">err</span>&nbsp;<span class="op" id="3092889">:=</span>&nbsp;<span class="ident" id="3092892">b</span><span class="op" id="3092893">.</span><span class="ident" id="3092894">wr</span><span class="op" id="3092896">.</span><span class="ident" id="3092897">Write</span><span class="op" id="3092902">(</span><span class="ident" id="3092903">b</span><span class="op" id="3092904">.</span><span class="ident" id="3092905">buf</span><span class="op" id="3092908">[</span><span class="num" id="3092909">0</span><span class="op" id="3092910">:</span><span class="ident" id="3092911">b</span><span class="op" id="3092912">.</span><span class="ident" id="3092913">n</span><span class="op" id="3092914">]</span><span class="op" id="3092915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3092918">if</span>&nbsp;<span class="ident" id="3092921">n</span>&nbsp;<span class="op" id="3092923">&lt;</span>&nbsp;<span class="ident" id="3092925">b</span><span class="op" id="3092926">.</span><span class="ident" id="3092927">n</span>&nbsp;<span class="op" id="3092929">&amp;&amp;</span>&nbsp;<span class="ident" id="3092932">err</span>&nbsp;<span class="op" id="3092936">==</span>&nbsp;<span class="ident" id="3092939">nil</span>&nbsp;<span class="op" id="3092943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3092947">err</span>&nbsp;<span class="op" id="3092951">=</span>&nbsp;<span class="ident" id="3092953">io</span><span class="op" id="3092955">.</span><span class="ident" id="3092956">ErrShortWrite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3092971">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3092974">if</span>&nbsp;<span class="ident" id="3092977">err</span>&nbsp;<span class="op" id="3092981">!=</span>&nbsp;<span class="ident" id="3092984">nil</span>&nbsp;<span class="op" id="3092988">{</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3092992">if</span>&nbsp;<span class="ident" id="3092995">n</span>&nbsp;<span class="op" id="3092997">&gt;</span>&nbsp;<span class="num" id="3092999">0</span>&nbsp;<span class="op" id="3093001">&amp;&amp;</span>&nbsp;<span class="ident" id="3093004">n</span>&nbsp;<span class="op" id="3093006">&lt;</span>&nbsp;<span class="ident" id="3093008">b</span><span class="op" id="3093009">.</span><span class="ident" id="3093010">n</span>&nbsp;<span class="op" id="3093012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3093017">copy</span><span class="op" id="3093021">(</span><span class="ident" id="3093022">b</span><span class="op" id="3093023">.</span><span class="ident" id="3093024">buf</span><span class="op" id="3093027">[</span><span class="num" id="3093028">0</span><span class="op" id="3093029">:</span><span class="ident" id="3093030">b</span><span class="op" id="3093031">.</span><span class="ident" id="3093032">n</span><span class="op" id="3093033">-</span><span class="ident" id="3093034">n</span><span class="op" id="3093035">]</span><span class="op" id="3093036">,</span>&nbsp;<span class="ident" id="3093038">b</span><span class="op" id="3093039">.</span><span class="ident" id="3093040">buf</span><span class="op" id="3093043">[</span><span class="ident" id="3093044">n</span><span class="op" id="3093045">:</span><span class="ident" id="3093046">b</span><span class="op" id="3093047">.</span><span class="ident" id="3093048">n</span><span class="op" id="3093049">]</span><span class="op" id="3093050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3093054">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3093058">b</span><span class="op" id="3093059">.</span><span class="ident" id="3093060">n</span>&nbsp;<span class="op" id="3093062">-=</span>&nbsp;<span class="ident" id="3093065">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3093069">b</span><span class="op" id="3093070">.</span><span class="ident" id="3093071">err</span>&nbsp;<span class="op" id="3093075">=</span>&nbsp;<span class="ident" id="3093077">err</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3093083">return</span>&nbsp;<span class="ident" id="3093090">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3093095">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3093098">b</span><span class="op" id="3093099">.</span><span class="ident" id="3093100">n</span>&nbsp;<span class="op" id="3093102">=</span>&nbsp;<span class="num" id="3093104">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3093107">return</span>&nbsp;<span class="ident" id="3093114">nil</span><br>
<span class="lineno"></span><span class="op" id="3093118">}</span><br>
<span class="lineno">545</span><br>
<span class="lineno"></span><span class="comment" id="3093121">//&nbsp;Available&nbsp;returns&nbsp;how&nbsp;many&nbsp;bytes&nbsp;are&nbsp;unused&nbsp;in&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="3093183">func</span>&nbsp;<span class="op" id="3093188">(</span><span class="ident" id="3093189">b</span>&nbsp;<span class="op" id="3093191">*</span><span class="ident" id="3093192">Writer</span><span class="op" id="3093198">)</span>&nbsp;<span class="ident" id="3093200">Available</span><span class="op" id="3093209">(</span><span class="op" id="3093210">)</span>&nbsp;<span class="builtintype" id="3093212">int</span>&nbsp;<span class="op" id="3093216">{</span>&nbsp;<span class="keyword" id="3093218">return</span>&nbsp;<span class="builtinfunc" id="3093225">len</span><span class="op" id="3093228">(</span><span class="ident" id="3093229">b</span><span class="op" id="3093230">.</span><span class="ident" id="3093231">buf</span><span class="op" id="3093234">)</span>&nbsp;<span class="op" id="3093236">-</span>&nbsp;<span class="ident" id="3093238">b</span><span class="op" id="3093239">.</span><span class="ident" id="3093240">n</span>&nbsp;<span class="op" id="3093242">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3093245">//&nbsp;Buffered&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;that&nbsp;have&nbsp;been&nbsp;written&nbsp;into&nbsp;the&nbsp;current&nbsp;buffer.</span><br>
<span class="lineno">550</span><span class="keyword" id="3093333">func</span>&nbsp;<span class="op" id="3093338">(</span><span class="ident" id="3093339">b</span>&nbsp;<span class="op" id="3093341">*</span><span class="ident" id="3093342">Writer</span><span class="op" id="3093348">)</span>&nbsp;<span class="ident" id="3093350">Buffered</span><span class="op" id="3093358">(</span><span class="op" id="3093359">)</span>&nbsp;<span class="builtintype" id="3093361">int</span>&nbsp;<span class="op" id="3093365">{</span>&nbsp;<span class="keyword" id="3093367">return</span>&nbsp;<span class="ident" id="3093374">b</span><span class="op" id="3093375">.</span><span class="ident" id="3093376">n</span>&nbsp;<span class="op" id="3093378">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3093381">//&nbsp;Write&nbsp;writes&nbsp;the&nbsp;contents&nbsp;of&nbsp;p&nbsp;into&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="comment" id="3093432">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written.</span><br>
<span class="lineno"></span><span class="comment" id="3093475">//&nbsp;If&nbsp;nn&nbsp;&lt;&nbsp;len(p),&nbsp;it&nbsp;also&nbsp;returns&nbsp;an&nbsp;error&nbsp;explaining</span><br>
<span class="lineno">555</span><span class="comment" id="3093530">//&nbsp;why&nbsp;the&nbsp;write&nbsp;is&nbsp;short.</span><br>
<span class="lineno"></span><span class="keyword" id="3093557">func</span>&nbsp;<span class="op" id="3093562">(</span><span class="ident" id="3093563">b</span>&nbsp;<span class="op" id="3093565">*</span><span class="ident" id="3093566">Writer</span><span class="op" id="3093572">)</span>&nbsp;<span class="ident" id="3093574">Write</span><span class="op" id="3093579">(</span><span class="ident" id="3093580">p</span>&nbsp;<span class="op" id="3093582">[</span><span class="op" id="3093583">]</span><span class="builtintype" id="3093584">byte</span><span class="op" id="3093588">)</span>&nbsp;<span class="op" id="3093590">(</span><span class="ident" id="3093591">nn</span>&nbsp;<span class="builtintype" id="3093594">int</span><span class="op" id="3093597">,</span>&nbsp;<span class="ident" id="3093599">err</span>&nbsp;<span class="builtintype" id="3093603">error</span><span class="op" id="3093608">)</span>&nbsp;<span class="op" id="3093610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3093613">for</span>&nbsp;<span class="builtinfunc" id="3093617">len</span><span class="op" id="3093620">(</span><span class="ident" id="3093621">p</span><span class="op" id="3093622">)</span>&nbsp;<span class="op" id="3093624">&gt;</span>&nbsp;<span class="ident" id="3093626">b</span><span class="op" id="3093627">.</span><span class="ident" id="3093628">Available</span><span class="op" id="3093637">(</span><span class="op" id="3093638">)</span>&nbsp;<span class="op" id="3093640">&amp;&amp;</span>&nbsp;<span class="ident" id="3093643">b</span><span class="op" id="3093644">.</span><span class="ident" id="3093645">err</span>&nbsp;<span class="op" id="3093649">==</span>&nbsp;<span class="ident" id="3093652">nil</span>&nbsp;<span class="op" id="3093656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3093660">var</span>&nbsp;<span class="ident" id="3093664">n</span>&nbsp;<span class="builtintype" id="3093666">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3093672">if</span>&nbsp;<span class="ident" id="3093675">b</span><span class="op" id="3093676">.</span><span class="ident" id="3093677">Buffered</span><span class="op" id="3093685">(</span><span class="op" id="3093686">)</span>&nbsp;<span class="op" id="3093688">==</span>&nbsp;<span class="num" id="3093691">0</span>&nbsp;<span class="op" id="3093693">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3093698">//&nbsp;Large&nbsp;write,&nbsp;empty&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3093731">//&nbsp;Write&nbsp;directly&nbsp;from&nbsp;p&nbsp;to&nbsp;avoid&nbsp;copy.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3093774">n</span><span class="op" id="3093775">,</span>&nbsp;<span class="ident" id="3093777">b</span><span class="op" id="3093778">.</span><span class="ident" id="3093779">err</span>&nbsp;<span class="op" id="3093783">=</span>&nbsp;<span class="ident" id="3093785">b</span><span class="op" id="3093786">.</span><span class="ident" id="3093787">wr</span><span class="op" id="3093789">.</span><span class="ident" id="3093790">Write</span><span class="op" id="3093795">(</span><span class="ident" id="3093796">p</span><span class="op" id="3093797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3093801">}</span>&nbsp;<span class="keyword" id="3093803">else</span>&nbsp;<span class="op" id="3093808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3093813">n</span>&nbsp;<span class="op" id="3093815">=</span>&nbsp;<span class="builtinfunc" id="3093817">copy</span><span class="op" id="3093821">(</span><span class="ident" id="3093822">b</span><span class="op" id="3093823">.</span><span class="ident" id="3093824">buf</span><span class="op" id="3093827">[</span><span class="ident" id="3093828">b</span><span class="op" id="3093829">.</span><span class="ident" id="3093830">n</span><span class="op" id="3093831">:</span><span class="op" id="3093832">]</span><span class="op" id="3093833">,</span>&nbsp;<span class="ident" id="3093835">p</span><span class="op" id="3093836">)</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3093841">b</span><span class="op" id="3093842">.</span><span class="ident" id="3093843">n</span>&nbsp;<span class="op" id="3093845">+=</span>&nbsp;<span class="ident" id="3093848">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3093853">b</span><span class="op" id="3093854">.</span><span class="ident" id="3093855">flush</span><span class="op" id="3093860">(</span><span class="op" id="3093861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3093865">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3093869">nn</span>&nbsp;<span class="op" id="3093872">+=</span>&nbsp;<span class="ident" id="3093875">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3093879">p</span>&nbsp;<span class="op" id="3093881">=</span>&nbsp;<span class="ident" id="3093883">p</span><span class="op" id="3093884">[</span><span class="ident" id="3093885">n</span><span class="op" id="3093886">:</span><span class="op" id="3093887">]</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3093890">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3093893">if</span>&nbsp;<span class="ident" id="3093896">b</span><span class="op" id="3093897">.</span><span class="ident" id="3093898">err</span>&nbsp;<span class="op" id="3093902">!=</span>&nbsp;<span class="ident" id="3093905">nil</span>&nbsp;<span class="op" id="3093909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3093913">return</span>&nbsp;<span class="ident" id="3093920">nn</span><span class="op" id="3093922">,</span>&nbsp;<span class="ident" id="3093924">b</span><span class="op" id="3093925">.</span><span class="ident" id="3093926">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3093931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3093934">n</span>&nbsp;<span class="op" id="3093936">:=</span>&nbsp;<span class="builtinfunc" id="3093939">copy</span><span class="op" id="3093943">(</span><span class="ident" id="3093944">b</span><span class="op" id="3093945">.</span><span class="ident" id="3093946">buf</span><span class="op" id="3093949">[</span><span class="ident" id="3093950">b</span><span class="op" id="3093951">.</span><span class="ident" id="3093952">n</span><span class="op" id="3093953">:</span><span class="op" id="3093954">]</span><span class="op" id="3093955">,</span>&nbsp;<span class="ident" id="3093957">p</span><span class="op" id="3093958">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3093961">b</span><span class="op" id="3093962">.</span><span class="ident" id="3093963">n</span>&nbsp;<span class="op" id="3093965">+=</span>&nbsp;<span class="ident" id="3093968">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3093971">nn</span>&nbsp;<span class="op" id="3093974">+=</span>&nbsp;<span class="ident" id="3093977">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3093980">return</span>&nbsp;<span class="ident" id="3093987">nn</span><span class="op" id="3093989">,</span>&nbsp;<span class="ident" id="3093991">nil</span><br>
<span class="lineno"></span><span class="op" id="3093995">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">580</span><span class="comment" id="3093998">//&nbsp;WriteByte&nbsp;writes&nbsp;a&nbsp;single&nbsp;byte.</span><br>
<span class="lineno"></span><span class="keyword" id="3094033">func</span>&nbsp;<span class="op" id="3094038">(</span><span class="ident" id="3094039">b</span>&nbsp;<span class="op" id="3094041">*</span><span class="ident" id="3094042">Writer</span><span class="op" id="3094048">)</span>&nbsp;<span class="ident" id="3094050">WriteByte</span><span class="op" id="3094059">(</span><span class="ident" id="3094060">c</span>&nbsp;<span class="builtintype" id="3094062">byte</span><span class="op" id="3094066">)</span>&nbsp;<span class="builtintype" id="3094068">error</span>&nbsp;<span class="op" id="3094074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3094077">if</span>&nbsp;<span class="ident" id="3094080">b</span><span class="op" id="3094081">.</span><span class="ident" id="3094082">err</span>&nbsp;<span class="op" id="3094086">!=</span>&nbsp;<span class="ident" id="3094089">nil</span>&nbsp;<span class="op" id="3094093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3094097">return</span>&nbsp;<span class="ident" id="3094104">b</span><span class="op" id="3094105">.</span><span class="ident" id="3094106">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3094111">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3094114">if</span>&nbsp;<span class="ident" id="3094117">b</span><span class="op" id="3094118">.</span><span class="ident" id="3094119">Available</span><span class="op" id="3094128">(</span><span class="op" id="3094129">)</span>&nbsp;<span class="op" id="3094131">&lt;=</span>&nbsp;<span class="num" id="3094134">0</span>&nbsp;<span class="op" id="3094136">&amp;&amp;</span>&nbsp;<span class="ident" id="3094139">b</span><span class="op" id="3094140">.</span><span class="ident" id="3094141">flush</span><span class="op" id="3094146">(</span><span class="op" id="3094147">)</span>&nbsp;<span class="op" id="3094149">!=</span>&nbsp;<span class="ident" id="3094152">nil</span>&nbsp;<span class="op" id="3094156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3094160">return</span>&nbsp;<span class="ident" id="3094167">b</span><span class="op" id="3094168">.</span><span class="ident" id="3094169">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3094174">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3094177">b</span><span class="op" id="3094178">.</span><span class="ident" id="3094179">buf</span><span class="op" id="3094182">[</span><span class="ident" id="3094183">b</span><span class="op" id="3094184">.</span><span class="ident" id="3094185">n</span><span class="op" id="3094186">]</span>&nbsp;<span class="op" id="3094188">=</span>&nbsp;<span class="ident" id="3094190">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3094193">b</span><span class="op" id="3094194">.</span><span class="ident" id="3094195">n</span><span class="op" id="3094196">++</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3094200">return</span>&nbsp;<span class="ident" id="3094207">nil</span><br>
<span class="lineno"></span><span class="op" id="3094211">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3094214">//&nbsp;WriteRune&nbsp;writes&nbsp;a&nbsp;single&nbsp;Unicode&nbsp;code&nbsp;point,&nbsp;returning</span><br>
<span class="lineno"></span><span class="comment" id="3094273">//&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written&nbsp;and&nbsp;any&nbsp;error.</span><br>
<span class="lineno">595</span><span class="keyword" id="3094319">func</span>&nbsp;<span class="op" id="3094324">(</span><span class="ident" id="3094325">b</span>&nbsp;<span class="op" id="3094327">*</span><span class="ident" id="3094328">Writer</span><span class="op" id="3094334">)</span>&nbsp;<span class="ident" id="3094336">WriteRune</span><span class="op" id="3094345">(</span><span class="ident" id="3094346">r</span>&nbsp;<span class="builtintype" id="3094348">rune</span><span class="op" id="3094352">)</span>&nbsp;<span class="op" id="3094354">(</span><span class="ident" id="3094355">size</span>&nbsp;<span class="builtintype" id="3094360">int</span><span class="op" id="3094363">,</span>&nbsp;<span class="ident" id="3094365">err</span>&nbsp;<span class="builtintype" id="3094369">error</span><span class="op" id="3094374">)</span>&nbsp;<span class="op" id="3094376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3094379">if</span>&nbsp;<span class="ident" id="3094382">r</span>&nbsp;<span class="op" id="3094384">&lt;</span>&nbsp;<span class="ident" id="3094386">utf8</span><span class="op" id="3094390">.</span><span class="ident" id="3094391">RuneSelf</span>&nbsp;<span class="op" id="3094400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3094404">err</span>&nbsp;<span class="op" id="3094408">=</span>&nbsp;<span class="ident" id="3094410">b</span><span class="op" id="3094411">.</span><span class="ident" id="3094412">WriteByte</span><span class="op" id="3094421">(</span><span class="builtintype" id="3094422">byte</span><span class="op" id="3094426">(</span><span class="ident" id="3094427">r</span><span class="op" id="3094428">)</span><span class="op" id="3094429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3094433">if</span>&nbsp;<span class="ident" id="3094436">err</span>&nbsp;<span class="op" id="3094440">!=</span>&nbsp;<span class="ident" id="3094443">nil</span>&nbsp;<span class="op" id="3094447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3094452">return</span>&nbsp;<span class="num" id="3094459">0</span><span class="op" id="3094460">,</span>&nbsp;<span class="ident" id="3094462">err</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3094468">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3094472">return</span>&nbsp;<span class="num" id="3094479">1</span><span class="op" id="3094480">,</span>&nbsp;<span class="ident" id="3094482">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3094487">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3094490">if</span>&nbsp;<span class="ident" id="3094493">b</span><span class="op" id="3094494">.</span><span class="ident" id="3094495">err</span>&nbsp;<span class="op" id="3094499">!=</span>&nbsp;<span class="ident" id="3094502">nil</span>&nbsp;<span class="op" id="3094506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3094510">return</span>&nbsp;<span class="num" id="3094517">0</span><span class="op" id="3094518">,</span>&nbsp;<span class="ident" id="3094520">b</span><span class="op" id="3094521">.</span><span class="ident" id="3094522">err</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3094527">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3094530">n</span>&nbsp;<span class="op" id="3094532">:=</span>&nbsp;<span class="ident" id="3094535">b</span><span class="op" id="3094536">.</span><span class="ident" id="3094537">Available</span><span class="op" id="3094546">(</span><span class="op" id="3094547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3094550">if</span>&nbsp;<span class="ident" id="3094553">n</span>&nbsp;<span class="op" id="3094555">&lt;</span>&nbsp;<span class="ident" id="3094557">utf8</span><span class="op" id="3094561">.</span><span class="ident" id="3094562">UTFMax</span>&nbsp;<span class="op" id="3094569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3094573">if</span>&nbsp;<span class="ident" id="3094576">b</span><span class="op" id="3094577">.</span><span class="ident" id="3094578">flush</span><span class="op" id="3094583">(</span><span class="op" id="3094584">)</span><span class="op" id="3094585">;</span>&nbsp;<span class="ident" id="3094587">b</span><span class="op" id="3094588">.</span><span class="ident" id="3094589">err</span>&nbsp;<span class="op" id="3094593">!=</span>&nbsp;<span class="ident" id="3094596">nil</span>&nbsp;<span class="op" id="3094600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3094605">return</span>&nbsp;<span class="num" id="3094612">0</span><span class="op" id="3094613">,</span>&nbsp;<span class="ident" id="3094615">b</span><span class="op" id="3094616">.</span><span class="ident" id="3094617">err</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3094623">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3094627">n</span>&nbsp;<span class="op" id="3094629">=</span>&nbsp;<span class="ident" id="3094631">b</span><span class="op" id="3094632">.</span><span class="ident" id="3094633">Available</span><span class="op" id="3094642">(</span><span class="op" id="3094643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3094647">if</span>&nbsp;<span class="ident" id="3094650">n</span>&nbsp;<span class="op" id="3094652">&lt;</span>&nbsp;<span class="ident" id="3094654">utf8</span><span class="op" id="3094658">.</span><span class="ident" id="3094659">UTFMax</span>&nbsp;<span class="op" id="3094666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3094671">//&nbsp;Can&nbsp;only&nbsp;happen&nbsp;if&nbsp;buffer&nbsp;is&nbsp;silly&nbsp;small.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3094719">return</span>&nbsp;<span class="ident" id="3094726">b</span><span class="op" id="3094727">.</span><span class="ident" id="3094728">WriteString</span><span class="op" id="3094739">(</span><span class="builtintype" id="3094740">string</span><span class="op" id="3094746">(</span><span class="ident" id="3094747">r</span><span class="op" id="3094748">)</span><span class="op" id="3094749">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3094753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3094756">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3094759">size</span>&nbsp;<span class="op" id="3094764">=</span>&nbsp;<span class="ident" id="3094766">utf8</span><span class="op" id="3094770">.</span><span class="ident" id="3094771">EncodeRune</span><span class="op" id="3094781">(</span><span class="ident" id="3094782">b</span><span class="op" id="3094783">.</span><span class="ident" id="3094784">buf</span><span class="op" id="3094787">[</span><span class="ident" id="3094788">b</span><span class="op" id="3094789">.</span><span class="ident" id="3094790">n</span><span class="op" id="3094791">:</span><span class="op" id="3094792">]</span><span class="op" id="3094793">,</span>&nbsp;<span class="ident" id="3094795">r</span><span class="op" id="3094796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3094799">b</span><span class="op" id="3094800">.</span><span class="ident" id="3094801">n</span>&nbsp;<span class="op" id="3094803">+=</span>&nbsp;<span class="ident" id="3094806">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3094812">return</span>&nbsp;<span class="ident" id="3094819">size</span><span class="op" id="3094823">,</span>&nbsp;<span class="ident" id="3094825">nil</span><br>
<span class="lineno">620</span><span class="op" id="3094829">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3094832">//&nbsp;WriteString&nbsp;writes&nbsp;a&nbsp;string.</span><br>
<span class="lineno"></span><span class="comment" id="3094864">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written.</span><br>
<span class="lineno"></span><span class="comment" id="3094907">//&nbsp;If&nbsp;the&nbsp;count&nbsp;is&nbsp;less&nbsp;than&nbsp;len(s),&nbsp;it&nbsp;also&nbsp;returns&nbsp;an&nbsp;error&nbsp;explaining</span><br>
<span class="lineno">625</span><span class="comment" id="3094980">//&nbsp;why&nbsp;the&nbsp;write&nbsp;is&nbsp;short.</span><br>
<span class="lineno"></span><span class="keyword" id="3095007">func</span>&nbsp;<span class="op" id="3095012">(</span><span class="ident" id="3095013">b</span>&nbsp;<span class="op" id="3095015">*</span><span class="ident" id="3095016">Writer</span><span class="op" id="3095022">)</span>&nbsp;<span class="ident" id="3095024">WriteString</span><span class="op" id="3095035">(</span><span class="ident" id="3095036">s</span>&nbsp;<span class="builtintype" id="3095038">string</span><span class="op" id="3095044">)</span>&nbsp;<span class="op" id="3095046">(</span><span class="builtintype" id="3095047">int</span><span class="op" id="3095050">,</span>&nbsp;<span class="builtintype" id="3095052">error</span><span class="op" id="3095057">)</span>&nbsp;<span class="op" id="3095059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3095062">nn</span>&nbsp;<span class="op" id="3095065">:=</span>&nbsp;<span class="num" id="3095068">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3095071">for</span>&nbsp;<span class="builtinfunc" id="3095075">len</span><span class="op" id="3095078">(</span><span class="ident" id="3095079">s</span><span class="op" id="3095080">)</span>&nbsp;<span class="op" id="3095082">&gt;</span>&nbsp;<span class="ident" id="3095084">b</span><span class="op" id="3095085">.</span><span class="ident" id="3095086">Available</span><span class="op" id="3095095">(</span><span class="op" id="3095096">)</span>&nbsp;<span class="op" id="3095098">&amp;&amp;</span>&nbsp;<span class="ident" id="3095101">b</span><span class="op" id="3095102">.</span><span class="ident" id="3095103">err</span>&nbsp;<span class="op" id="3095107">==</span>&nbsp;<span class="ident" id="3095110">nil</span>&nbsp;<span class="op" id="3095114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3095118">n</span>&nbsp;<span class="op" id="3095120">:=</span>&nbsp;<span class="builtinfunc" id="3095123">copy</span><span class="op" id="3095127">(</span><span class="ident" id="3095128">b</span><span class="op" id="3095129">.</span><span class="ident" id="3095130">buf</span><span class="op" id="3095133">[</span><span class="ident" id="3095134">b</span><span class="op" id="3095135">.</span><span class="ident" id="3095136">n</span><span class="op" id="3095137">:</span><span class="op" id="3095138">]</span><span class="op" id="3095139">,</span>&nbsp;<span class="ident" id="3095141">s</span><span class="op" id="3095142">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3095146">b</span><span class="op" id="3095147">.</span><span class="ident" id="3095148">n</span>&nbsp;<span class="op" id="3095150">+=</span>&nbsp;<span class="ident" id="3095153">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3095157">nn</span>&nbsp;<span class="op" id="3095160">+=</span>&nbsp;<span class="ident" id="3095163">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3095167">s</span>&nbsp;<span class="op" id="3095169">=</span>&nbsp;<span class="ident" id="3095171">s</span><span class="op" id="3095172">[</span><span class="ident" id="3095173">n</span><span class="op" id="3095174">:</span><span class="op" id="3095175">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3095179">b</span><span class="op" id="3095180">.</span><span class="ident" id="3095181">flush</span><span class="op" id="3095186">(</span><span class="op" id="3095187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3095190">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3095193">if</span>&nbsp;<span class="ident" id="3095196">b</span><span class="op" id="3095197">.</span><span class="ident" id="3095198">err</span>&nbsp;<span class="op" id="3095202">!=</span>&nbsp;<span class="ident" id="3095205">nil</span>&nbsp;<span class="op" id="3095209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3095213">return</span>&nbsp;<span class="ident" id="3095220">nn</span><span class="op" id="3095222">,</span>&nbsp;<span class="ident" id="3095224">b</span><span class="op" id="3095225">.</span><span class="ident" id="3095226">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3095231">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3095234">n</span>&nbsp;<span class="op" id="3095236">:=</span>&nbsp;<span class="builtinfunc" id="3095239">copy</span><span class="op" id="3095243">(</span><span class="ident" id="3095244">b</span><span class="op" id="3095245">.</span><span class="ident" id="3095246">buf</span><span class="op" id="3095249">[</span><span class="ident" id="3095250">b</span><span class="op" id="3095251">.</span><span class="ident" id="3095252">n</span><span class="op" id="3095253">:</span><span class="op" id="3095254">]</span><span class="op" id="3095255">,</span>&nbsp;<span class="ident" id="3095257">s</span><span class="op" id="3095258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3095261">b</span><span class="op" id="3095262">.</span><span class="ident" id="3095263">n</span>&nbsp;<span class="op" id="3095265">+=</span>&nbsp;<span class="ident" id="3095268">n</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3095271">nn</span>&nbsp;<span class="op" id="3095274">+=</span>&nbsp;<span class="ident" id="3095277">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3095280">return</span>&nbsp;<span class="ident" id="3095287">nn</span><span class="op" id="3095289">,</span>&nbsp;<span class="ident" id="3095291">nil</span><br>
<span class="lineno"></span><span class="op" id="3095295">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3095298">//&nbsp;ReadFrom&nbsp;implements&nbsp;io.ReaderFrom.</span><br>
<span class="lineno">645</span><span class="keyword" id="3095336">func</span>&nbsp;<span class="op" id="3095341">(</span><span class="ident" id="3095342">b</span>&nbsp;<span class="op" id="3095344">*</span><span class="ident" id="3095345">Writer</span><span class="op" id="3095351">)</span>&nbsp;<span class="ident" id="3095353">ReadFrom</span><span class="op" id="3095361">(</span><span class="ident" id="3095362">r</span>&nbsp;<span class="ident" id="3095364">io</span><span class="op" id="3095366">.</span><span class="ident" id="3095367">Reader</span><span class="op" id="3095373">)</span>&nbsp;<span class="op" id="3095375">(</span><span class="ident" id="3095376">n</span>&nbsp;<span class="ident" id="3095378">int64</span><span class="op" id="3095383">,</span>&nbsp;<span class="ident" id="3095385">err</span>&nbsp;<span class="builtintype" id="3095389">error</span><span class="op" id="3095394">)</span>&nbsp;<span class="op" id="3095396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3095399">if</span>&nbsp;<span class="ident" id="3095402">b</span><span class="op" id="3095403">.</span><span class="ident" id="3095404">Buffered</span><span class="op" id="3095412">(</span><span class="op" id="3095413">)</span>&nbsp;<span class="op" id="3095415">==</span>&nbsp;<span class="num" id="3095418">0</span>&nbsp;<span class="op" id="3095420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3095424">if</span>&nbsp;<span class="ident" id="3095427">w</span><span class="op" id="3095428">,</span>&nbsp;<span class="ident" id="3095430">ok</span>&nbsp;<span class="op" id="3095433">:=</span>&nbsp;<span class="ident" id="3095436">b</span><span class="op" id="3095437">.</span><span class="ident" id="3095438">wr</span><span class="op" id="3095440">.</span><span class="op" id="3095441">(</span><span class="ident" id="3095442">io</span><span class="op" id="3095444">.</span><span class="ident" id="3095445">ReaderFrom</span><span class="op" id="3095455">)</span><span class="op" id="3095456">;</span>&nbsp;<span class="ident" id="3095458">ok</span>&nbsp;<span class="op" id="3095461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3095466">return</span>&nbsp;<span class="ident" id="3095473">w</span><span class="op" id="3095474">.</span><span class="ident" id="3095475">ReadFrom</span><span class="op" id="3095483">(</span><span class="ident" id="3095484">r</span><span class="op" id="3095485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3095489">}</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3095492">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3095495">var</span>&nbsp;<span class="ident" id="3095499">m</span>&nbsp;<span class="builtintype" id="3095501">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3095506">for</span>&nbsp;<span class="op" id="3095510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3095514">if</span>&nbsp;<span class="ident" id="3095517">b</span><span class="op" id="3095518">.</span><span class="ident" id="3095519">Available</span><span class="op" id="3095528">(</span><span class="op" id="3095529">)</span>&nbsp;<span class="op" id="3095531">==</span>&nbsp;<span class="num" id="3095534">0</span>&nbsp;<span class="op" id="3095536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3095541">if</span>&nbsp;<span class="ident" id="3095544">err1</span>&nbsp;<span class="op" id="3095549">:=</span>&nbsp;<span class="ident" id="3095552">b</span><span class="op" id="3095553">.</span><span class="ident" id="3095554">flush</span><span class="op" id="3095559">(</span><span class="op" id="3095560">)</span><span class="op" id="3095561">;</span>&nbsp;<span class="ident" id="3095563">err1</span>&nbsp;<span class="op" id="3095568">!=</span>&nbsp;<span class="ident" id="3095571">nil</span>&nbsp;<span class="op" id="3095575">{</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3095581">return</span>&nbsp;<span class="ident" id="3095588">n</span><span class="op" id="3095589">,</span>&nbsp;<span class="ident" id="3095591">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3095599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3095603">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3095607">nr</span>&nbsp;<span class="op" id="3095610">:=</span>&nbsp;<span class="num" id="3095613">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3095617">for</span>&nbsp;<span class="ident" id="3095621">nr</span>&nbsp;<span class="op" id="3095624">&lt;</span>&nbsp;<span class="ident" id="3095626">maxConsecutiveEmptyReads</span>&nbsp;<span class="op" id="3095651">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3095656">m</span><span class="op" id="3095657">,</span>&nbsp;<span class="ident" id="3095659">err</span>&nbsp;<span class="op" id="3095663">=</span>&nbsp;<span class="ident" id="3095665">r</span><span class="op" id="3095666">.</span><span class="ident" id="3095667">Read</span><span class="op" id="3095671">(</span><span class="ident" id="3095672">b</span><span class="op" id="3095673">.</span><span class="ident" id="3095674">buf</span><span class="op" id="3095677">[</span><span class="ident" id="3095678">b</span><span class="op" id="3095679">.</span><span class="ident" id="3095680">n</span><span class="op" id="3095681">:</span><span class="op" id="3095682">]</span><span class="op" id="3095683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3095688">if</span>&nbsp;<span class="ident" id="3095691">m</span>&nbsp;<span class="op" id="3095693">!=</span>&nbsp;<span class="num" id="3095696">0</span>&nbsp;<span class="op" id="3095698">||</span>&nbsp;<span class="ident" id="3095701">err</span>&nbsp;<span class="op" id="3095705">!=</span>&nbsp;<span class="ident" id="3095708">nil</span>&nbsp;<span class="op" id="3095712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3095718">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3095727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3095732">nr</span><span class="op" id="3095734">++</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3095739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3095743">if</span>&nbsp;<span class="ident" id="3095746">nr</span>&nbsp;<span class="op" id="3095749">==</span>&nbsp;<span class="ident" id="3095752">maxConsecutiveEmptyReads</span>&nbsp;<span class="op" id="3095777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3095782">return</span>&nbsp;<span class="ident" id="3095789">n</span><span class="op" id="3095790">,</span>&nbsp;<span class="ident" id="3095792">io</span><span class="op" id="3095794">.</span><span class="ident" id="3095795">ErrNoProgress</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3095811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3095815">b</span><span class="op" id="3095816">.</span><span class="ident" id="3095817">n</span>&nbsp;<span class="op" id="3095819">+=</span>&nbsp;<span class="ident" id="3095822">m</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3095826">n</span>&nbsp;<span class="op" id="3095828">+=</span>&nbsp;<span class="ident" id="3095831">int64</span><span class="op" id="3095836">(</span><span class="ident" id="3095837">m</span><span class="op" id="3095838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3095842">if</span>&nbsp;<span class="ident" id="3095845">err</span>&nbsp;<span class="op" id="3095849">!=</span>&nbsp;<span class="ident" id="3095852">nil</span>&nbsp;<span class="op" id="3095856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3095861">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3095869">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3095872">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3095875">if</span>&nbsp;<span class="ident" id="3095878">err</span>&nbsp;<span class="op" id="3095882">==</span>&nbsp;<span class="ident" id="3095885">io</span><span class="op" id="3095887">.</span><span class="ident" id="3095888">EOF</span>&nbsp;<span class="op" id="3095892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3095896">//&nbsp;If&nbsp;we&nbsp;filled&nbsp;the&nbsp;buffer&nbsp;exactly,&nbsp;flush&nbsp;pre-emptively.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3095955">if</span>&nbsp;<span class="ident" id="3095958">b</span><span class="op" id="3095959">.</span><span class="ident" id="3095960">Available</span><span class="op" id="3095969">(</span><span class="op" id="3095970">)</span>&nbsp;<span class="op" id="3095972">==</span>&nbsp;<span class="num" id="3095975">0</span>&nbsp;<span class="op" id="3095977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3095982">err</span>&nbsp;<span class="op" id="3095986">=</span>&nbsp;<span class="ident" id="3095988">b</span><span class="op" id="3095989">.</span><span class="ident" id="3095990">flush</span><span class="op" id="3095995">(</span><span class="op" id="3095996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3096000">}</span>&nbsp;<span class="keyword" id="3096002">else</span>&nbsp;<span class="op" id="3096007">{</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3096012">err</span>&nbsp;<span class="op" id="3096016">=</span>&nbsp;<span class="ident" id="3096018">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3096024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3096027">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3096030">return</span>&nbsp;<span class="ident" id="3096037">n</span><span class="op" id="3096038">,</span>&nbsp;<span class="ident" id="3096040">err</span><br>
<span class="lineno"></span><span class="op" id="3096044">}</span><br>
<span class="lineno">685</span><br>
<span class="lineno"></span><span class="comment" id="3096047">//&nbsp;buffered&nbsp;input&nbsp;and&nbsp;output</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3096077">//&nbsp;ReadWriter&nbsp;stores&nbsp;pointers&nbsp;to&nbsp;a&nbsp;Reader&nbsp;and&nbsp;a&nbsp;Writer.</span><br>
<span class="lineno"></span><span class="comment" id="3096133">//&nbsp;It&nbsp;implements&nbsp;io.ReadWriter.</span><br>
<span class="lineno">690</span><span class="keyword" id="3096165">type</span>&nbsp;<span class="ident" id="3096170">ReadWriter</span>&nbsp;<span class="keyword" id="3096181">struct</span>&nbsp;<span class="op" id="3096188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3096191">*</span><span class="ident" id="3096192">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3096200">*</span><span class="ident" id="3096201">Writer</span><br>
<span class="lineno"></span><span class="op" id="3096208">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">695</span><span class="comment" id="3096211">//&nbsp;NewReadWriter&nbsp;allocates&nbsp;a&nbsp;new&nbsp;ReadWriter&nbsp;that&nbsp;dispatches&nbsp;to&nbsp;r&nbsp;and&nbsp;w.</span><br>
<span class="lineno"></span><span class="keyword" id="3096283">func</span>&nbsp;<span class="ident" id="3096288">NewReadWriter</span><span class="op" id="3096301">(</span><span class="ident" id="3096302">r</span>&nbsp;<span class="op" id="3096304">*</span><span class="ident" id="3096305">Reader</span><span class="op" id="3096311">,</span>&nbsp;<span class="ident" id="3096313">w</span>&nbsp;<span class="op" id="3096315">*</span><span class="ident" id="3096316">Writer</span><span class="op" id="3096322">)</span>&nbsp;<span class="op" id="3096324">*</span><span class="ident" id="3096325">ReadWriter</span>&nbsp;<span class="op" id="3096336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3096339">return</span>&nbsp;<span class="op" id="3096346">&amp;</span><span class="ident" id="3096347">ReadWriter</span><span class="op" id="3096357">{</span><span class="ident" id="3096358">r</span><span class="op" id="3096359">,</span>&nbsp;<span class="ident" id="3096361">w</span><span class="op" id="3096362">}</span><br>
<span class="lineno"></span><span class="op" id="3096364">}</span>
</div>
</body>
</html>
