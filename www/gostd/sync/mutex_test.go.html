<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1126773">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1126828">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1126882">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1126933">//&nbsp;GOMAXPROCS=10&nbsp;go&nbsp;test</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1126959">package</span>&nbsp;<span class="ident" id="1126967">sync_test</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1126978">import</span>&nbsp;<span class="op" id="1126985">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1126988">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1126999">.</span>&nbsp;<span class="string" id="1127001">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1127009">&#34;testing&#34;</span><br>
<span class="lineno"></span><span class="op" id="1127019">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="1127022">func</span>&nbsp;<span class="ident" id="1127027">HammerSemaphore</span><span class="op" id="1127042">(</span><span class="ident" id="1127043">s</span>&nbsp;<span class="op" id="1127045">*</span><span class="builtintype" id="1127046">uint32</span><span class="op" id="1127052">,</span>&nbsp;<span class="ident" id="1127054">loops</span>&nbsp;<span class="builtintype" id="1127060">int</span><span class="op" id="1127063">,</span>&nbsp;<span class="ident" id="1127065">cdone</span>&nbsp;<span class="keyword" id="1127071">chan</span>&nbsp;<span class="builtintype" id="1127076">bool</span><span class="op" id="1127080">)</span>&nbsp;<span class="op" id="1127082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1127085">for</span>&nbsp;<span class="ident" id="1127089">i</span>&nbsp;<span class="op" id="1127091">:=</span>&nbsp;<span class="num" id="1127094">0</span><span class="op" id="1127095">;</span>&nbsp;<span class="ident" id="1127097">i</span>&nbsp;<span class="op" id="1127099">&lt;</span>&nbsp;<span class="ident" id="1127101">loops</span><span class="op" id="1127106">;</span>&nbsp;<span class="ident" id="1127108">i</span><span class="op" id="1127109">++</span>&nbsp;<span class="op" id="1127112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1127116">Runtime_Semacquire</span><span class="op" id="1127134">(</span><span class="ident" id="1127135">s</span><span class="op" id="1127136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1127140">Runtime_Semrelease</span><span class="op" id="1127158">(</span><span class="ident" id="1127159">s</span><span class="op" id="1127160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1127163">}</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1127166">cdone</span>&nbsp;<span class="op" id="1127172">&lt;-</span>&nbsp;<span class="builtintype" id="1127175">true</span><br>
<span class="lineno"></span><span class="op" id="1127180">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1127183">func</span>&nbsp;<span class="ident" id="1127188">TestSemaphore</span><span class="op" id="1127201">(</span><span class="ident" id="1127202">t</span>&nbsp;<span class="op" id="1127204">*</span><span class="ident" id="1127205">testing</span><span class="op" id="1127212">.</span><span class="ident" id="1127213">T</span><span class="op" id="1127214">)</span>&nbsp;<span class="op" id="1127216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1127219">s</span>&nbsp;<span class="op" id="1127221">:=</span>&nbsp;<span class="builtinfunc" id="1127224">new</span><span class="op" id="1127227">(</span><span class="builtintype" id="1127228">uint32</span><span class="op" id="1127234">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1127237">*</span><span class="ident" id="1127238">s</span>&nbsp;<span class="op" id="1127240">=</span>&nbsp;<span class="num" id="1127242">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1127245">c</span>&nbsp;<span class="op" id="1127247">:=</span>&nbsp;<span class="builtinfunc" id="1127250">make</span><span class="op" id="1127254">(</span><span class="keyword" id="1127255">chan</span>&nbsp;<span class="builtintype" id="1127260">bool</span><span class="op" id="1127264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1127267">for</span>&nbsp;<span class="ident" id="1127271">i</span>&nbsp;<span class="op" id="1127273">:=</span>&nbsp;<span class="num" id="1127276">0</span><span class="op" id="1127277">;</span>&nbsp;<span class="ident" id="1127279">i</span>&nbsp;<span class="op" id="1127281">&lt;</span>&nbsp;<span class="num" id="1127283">10</span><span class="op" id="1127285">;</span>&nbsp;<span class="ident" id="1127287">i</span><span class="op" id="1127288">++</span>&nbsp;<span class="op" id="1127291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1127295">go</span>&nbsp;<span class="ident" id="1127298">HammerSemaphore</span><span class="op" id="1127313">(</span><span class="ident" id="1127314">s</span><span class="op" id="1127315">,</span>&nbsp;<span class="num" id="1127317">1000</span><span class="op" id="1127321">,</span>&nbsp;<span class="ident" id="1127323">c</span><span class="op" id="1127324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1127327">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1127330">for</span>&nbsp;<span class="ident" id="1127334">i</span>&nbsp;<span class="op" id="1127336">:=</span>&nbsp;<span class="num" id="1127339">0</span><span class="op" id="1127340">;</span>&nbsp;<span class="ident" id="1127342">i</span>&nbsp;<span class="op" id="1127344">&lt;</span>&nbsp;<span class="num" id="1127346">10</span><span class="op" id="1127348">;</span>&nbsp;<span class="ident" id="1127350">i</span><span class="op" id="1127351">++</span>&nbsp;<span class="op" id="1127354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1127358">&lt;-</span><span class="ident" id="1127360">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1127363">}</span><br>
<span class="lineno"></span><span class="op" id="1127365">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="1127368">func</span>&nbsp;<span class="ident" id="1127373">BenchmarkUncontendedSemaphore</span><span class="op" id="1127402">(</span><span class="ident" id="1127403">b</span>&nbsp;<span class="op" id="1127405">*</span><span class="ident" id="1127406">testing</span><span class="op" id="1127413">.</span><span class="ident" id="1127414">B</span><span class="op" id="1127415">)</span>&nbsp;<span class="op" id="1127417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1127420">s</span>&nbsp;<span class="op" id="1127422">:=</span>&nbsp;<span class="builtinfunc" id="1127425">new</span><span class="op" id="1127428">(</span><span class="builtintype" id="1127429">uint32</span><span class="op" id="1127435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1127438">*</span><span class="ident" id="1127439">s</span>&nbsp;<span class="op" id="1127441">=</span>&nbsp;<span class="num" id="1127443">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1127446">HammerSemaphore</span><span class="op" id="1127461">(</span><span class="ident" id="1127462">s</span><span class="op" id="1127463">,</span>&nbsp;<span class="ident" id="1127465">b</span><span class="op" id="1127466">.</span><span class="ident" id="1127467">N</span><span class="op" id="1127468">,</span>&nbsp;<span class="builtinfunc" id="1127470">make</span><span class="op" id="1127474">(</span><span class="keyword" id="1127475">chan</span>&nbsp;<span class="builtintype" id="1127480">bool</span><span class="op" id="1127484">,</span>&nbsp;<span class="num" id="1127486">2</span><span class="op" id="1127487">)</span><span class="op" id="1127488">)</span><br>
<span class="lineno"></span><span class="op" id="1127490">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="keyword" id="1127493">func</span>&nbsp;<span class="ident" id="1127498">BenchmarkContendedSemaphore</span><span class="op" id="1127525">(</span><span class="ident" id="1127526">b</span>&nbsp;<span class="op" id="1127528">*</span><span class="ident" id="1127529">testing</span><span class="op" id="1127536">.</span><span class="ident" id="1127537">B</span><span class="op" id="1127538">)</span>&nbsp;<span class="op" id="1127540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1127543">b</span><span class="op" id="1127544">.</span><span class="ident" id="1127545">StopTimer</span><span class="op" id="1127554">(</span><span class="op" id="1127555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1127558">s</span>&nbsp;<span class="op" id="1127560">:=</span>&nbsp;<span class="builtinfunc" id="1127563">new</span><span class="op" id="1127566">(</span><span class="builtintype" id="1127567">uint32</span><span class="op" id="1127573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1127576">*</span><span class="ident" id="1127577">s</span>&nbsp;<span class="op" id="1127579">=</span>&nbsp;<span class="num" id="1127581">1</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1127584">c</span>&nbsp;<span class="op" id="1127586">:=</span>&nbsp;<span class="builtinfunc" id="1127589">make</span><span class="op" id="1127593">(</span><span class="keyword" id="1127594">chan</span>&nbsp;<span class="builtintype" id="1127599">bool</span><span class="op" id="1127603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1127606">defer</span>&nbsp;<span class="ident" id="1127612">runtime</span><span class="op" id="1127619">.</span><span class="ident" id="1127620">GOMAXPROCS</span><span class="op" id="1127630">(</span><span class="ident" id="1127631">runtime</span><span class="op" id="1127638">.</span><span class="ident" id="1127639">GOMAXPROCS</span><span class="op" id="1127649">(</span><span class="num" id="1127650">2</span><span class="op" id="1127651">)</span><span class="op" id="1127652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1127655">b</span><span class="op" id="1127656">.</span><span class="ident" id="1127657">StartTimer</span><span class="op" id="1127667">(</span><span class="op" id="1127668">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1127672">go</span>&nbsp;<span class="ident" id="1127675">HammerSemaphore</span><span class="op" id="1127690">(</span><span class="ident" id="1127691">s</span><span class="op" id="1127692">,</span>&nbsp;<span class="ident" id="1127694">b</span><span class="op" id="1127695">.</span><span class="ident" id="1127696">N</span><span class="op" id="1127697">/</span><span class="num" id="1127698">2</span><span class="op" id="1127699">,</span>&nbsp;<span class="ident" id="1127701">c</span><span class="op" id="1127702">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1127705">go</span>&nbsp;<span class="ident" id="1127708">HammerSemaphore</span><span class="op" id="1127723">(</span><span class="ident" id="1127724">s</span><span class="op" id="1127725">,</span>&nbsp;<span class="ident" id="1127727">b</span><span class="op" id="1127728">.</span><span class="ident" id="1127729">N</span><span class="op" id="1127730">/</span><span class="num" id="1127731">2</span><span class="op" id="1127732">,</span>&nbsp;<span class="ident" id="1127734">c</span><span class="op" id="1127735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1127738">&lt;-</span><span class="ident" id="1127740">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1127743">&lt;-</span><span class="ident" id="1127745">c</span><br>
<span class="lineno"></span><span class="op" id="1127747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="1127750">func</span>&nbsp;<span class="ident" id="1127755">HammerMutex</span><span class="op" id="1127766">(</span><span class="ident" id="1127767">m</span>&nbsp;<span class="op" id="1127769">*</span><span class="ident" id="1127770">Mutex</span><span class="op" id="1127775">,</span>&nbsp;<span class="ident" id="1127777">loops</span>&nbsp;<span class="builtintype" id="1127783">int</span><span class="op" id="1127786">,</span>&nbsp;<span class="ident" id="1127788">cdone</span>&nbsp;<span class="keyword" id="1127794">chan</span>&nbsp;<span class="builtintype" id="1127799">bool</span><span class="op" id="1127803">)</span>&nbsp;<span class="op" id="1127805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1127808">for</span>&nbsp;<span class="ident" id="1127812">i</span>&nbsp;<span class="op" id="1127814">:=</span>&nbsp;<span class="num" id="1127817">0</span><span class="op" id="1127818">;</span>&nbsp;<span class="ident" id="1127820">i</span>&nbsp;<span class="op" id="1127822">&lt;</span>&nbsp;<span class="ident" id="1127824">loops</span><span class="op" id="1127829">;</span>&nbsp;<span class="ident" id="1127831">i</span><span class="op" id="1127832">++</span>&nbsp;<span class="op" id="1127835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1127839">m</span><span class="op" id="1127840">.</span><span class="ident" id="1127841">Lock</span><span class="op" id="1127845">(</span><span class="op" id="1127846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1127850">m</span><span class="op" id="1127851">.</span><span class="ident" id="1127852">Unlock</span><span class="op" id="1127858">(</span><span class="op" id="1127859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1127862">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1127865">cdone</span>&nbsp;<span class="op" id="1127871">&lt;-</span>&nbsp;<span class="builtintype" id="1127874">true</span><br>
<span class="lineno"></span><span class="op" id="1127879">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1127882">func</span>&nbsp;<span class="ident" id="1127887">TestMutex</span><span class="op" id="1127896">(</span><span class="ident" id="1127897">t</span>&nbsp;<span class="op" id="1127899">*</span><span class="ident" id="1127900">testing</span><span class="op" id="1127907">.</span><span class="ident" id="1127908">T</span><span class="op" id="1127909">)</span>&nbsp;<span class="op" id="1127911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1127914">m</span>&nbsp;<span class="op" id="1127916">:=</span>&nbsp;<span class="builtinfunc" id="1127919">new</span><span class="op" id="1127922">(</span><span class="ident" id="1127923">Mutex</span><span class="op" id="1127928">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1127931">c</span>&nbsp;<span class="op" id="1127933">:=</span>&nbsp;<span class="builtinfunc" id="1127936">make</span><span class="op" id="1127940">(</span><span class="keyword" id="1127941">chan</span>&nbsp;<span class="builtintype" id="1127946">bool</span><span class="op" id="1127950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1127953">for</span>&nbsp;<span class="ident" id="1127957">i</span>&nbsp;<span class="op" id="1127959">:=</span>&nbsp;<span class="num" id="1127962">0</span><span class="op" id="1127963">;</span>&nbsp;<span class="ident" id="1127965">i</span>&nbsp;<span class="op" id="1127967">&lt;</span>&nbsp;<span class="num" id="1127969">10</span><span class="op" id="1127971">;</span>&nbsp;<span class="ident" id="1127973">i</span><span class="op" id="1127974">++</span>&nbsp;<span class="op" id="1127977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1127981">go</span>&nbsp;<span class="ident" id="1127984">HammerMutex</span><span class="op" id="1127995">(</span><span class="ident" id="1127996">m</span><span class="op" id="1127997">,</span>&nbsp;<span class="num" id="1127999">1000</span><span class="op" id="1128003">,</span>&nbsp;<span class="ident" id="1128005">c</span><span class="op" id="1128006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1128009">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1128012">for</span>&nbsp;<span class="ident" id="1128016">i</span>&nbsp;<span class="op" id="1128018">:=</span>&nbsp;<span class="num" id="1128021">0</span><span class="op" id="1128022">;</span>&nbsp;<span class="ident" id="1128024">i</span>&nbsp;<span class="op" id="1128026">&lt;</span>&nbsp;<span class="num" id="1128028">10</span><span class="op" id="1128030">;</span>&nbsp;<span class="ident" id="1128032">i</span><span class="op" id="1128033">++</span>&nbsp;<span class="op" id="1128036">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1128040">&lt;-</span><span class="ident" id="1128042">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1128045">}</span><br>
<span class="lineno"></span><span class="op" id="1128047">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1128050">func</span>&nbsp;<span class="ident" id="1128055">TestMutexPanic</span><span class="op" id="1128069">(</span><span class="ident" id="1128070">t</span>&nbsp;<span class="op" id="1128072">*</span><span class="ident" id="1128073">testing</span><span class="op" id="1128080">.</span><span class="ident" id="1128081">T</span><span class="op" id="1128082">)</span>&nbsp;<span class="op" id="1128084">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1128087">defer</span>&nbsp;<span class="keyword" id="1128093">func</span><span class="op" id="1128097">(</span><span class="op" id="1128098">)</span>&nbsp;<span class="op" id="1128100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1128104">if</span>&nbsp;<span class="builtinfunc" id="1128107">recover</span><span class="op" id="1128114">(</span><span class="op" id="1128115">)</span>&nbsp;<span class="op" id="1128117">==</span>&nbsp;<span class="ident" id="1128120">nil</span>&nbsp;<span class="op" id="1128124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1128129">t</span><span class="op" id="1128130">.</span><span class="ident" id="1128131">Fatalf</span><span class="op" id="1128137">(</span><span class="string" id="1128138">&#34;unlock&nbsp;of&nbsp;unlocked&nbsp;mutex&nbsp;did&nbsp;not&nbsp;panic&#34;</span><span class="op" id="1128178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1128182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1128185">}</span><span class="op" id="1128186">(</span><span class="op" id="1128187">)</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1128191">var</span>&nbsp;<span class="ident" id="1128195">mu</span>&nbsp;<span class="ident" id="1128198">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1128205">mu</span><span class="op" id="1128207">.</span><span class="ident" id="1128208">Lock</span><span class="op" id="1128212">(</span><span class="op" id="1128213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1128216">mu</span><span class="op" id="1128218">.</span><span class="ident" id="1128219">Unlock</span><span class="op" id="1128225">(</span><span class="op" id="1128226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1128229">mu</span><span class="op" id="1128231">.</span><span class="ident" id="1128232">Unlock</span><span class="op" id="1128238">(</span><span class="op" id="1128239">)</span><br>
<span class="lineno">85</span><span class="op" id="1128241">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1128244">func</span>&nbsp;<span class="ident" id="1128249">BenchmarkMutexUncontended</span><span class="op" id="1128274">(</span><span class="ident" id="1128275">b</span>&nbsp;<span class="op" id="1128277">*</span><span class="ident" id="1128278">testing</span><span class="op" id="1128285">.</span><span class="ident" id="1128286">B</span><span class="op" id="1128287">)</span>&nbsp;<span class="op" id="1128289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1128292">type</span>&nbsp;<span class="ident" id="1128297">PaddedMutex</span>&nbsp;<span class="keyword" id="1128309">struct</span>&nbsp;<span class="op" id="1128316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1128320">Mutex</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1128328">pad</span>&nbsp;<span class="op" id="1128332">[</span><span class="num" id="1128333">128</span><span class="op" id="1128336">]</span><span class="builtintype" id="1128337">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1128344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1128347">b</span><span class="op" id="1128348">.</span><span class="ident" id="1128349">RunParallel</span><span class="op" id="1128360">(</span><span class="keyword" id="1128361">func</span><span class="op" id="1128365">(</span><span class="ident" id="1128366">pb</span>&nbsp;<span class="op" id="1128369">*</span><span class="ident" id="1128370">testing</span><span class="op" id="1128377">.</span><span class="ident" id="1128378">PB</span><span class="op" id="1128380">)</span>&nbsp;<span class="op" id="1128382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1128386">var</span>&nbsp;<span class="ident" id="1128390">mu</span>&nbsp;<span class="ident" id="1128393">PaddedMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1128407">for</span>&nbsp;<span class="ident" id="1128411">pb</span><span class="op" id="1128413">.</span><span class="ident" id="1128414">Next</span><span class="op" id="1128418">(</span><span class="op" id="1128419">)</span>&nbsp;<span class="op" id="1128421">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1128426">mu</span><span class="op" id="1128428">.</span><span class="ident" id="1128429">Lock</span><span class="op" id="1128433">(</span><span class="op" id="1128434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1128439">mu</span><span class="op" id="1128441">.</span><span class="ident" id="1128442">Unlock</span><span class="op" id="1128448">(</span><span class="op" id="1128449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1128453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1128456">}</span><span class="op" id="1128457">)</span><br>
<span class="lineno"></span><span class="op" id="1128459">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="1128462">func</span>&nbsp;<span class="ident" id="1128467">benchmarkMutex</span><span class="op" id="1128481">(</span><span class="ident" id="1128482">b</span>&nbsp;<span class="op" id="1128484">*</span><span class="ident" id="1128485">testing</span><span class="op" id="1128492">.</span><span class="ident" id="1128493">B</span><span class="op" id="1128494">,</span>&nbsp;<span class="ident" id="1128496">slack</span><span class="op" id="1128501">,</span>&nbsp;<span class="ident" id="1128503">work</span>&nbsp;<span class="builtintype" id="1128508">bool</span><span class="op" id="1128512">)</span>&nbsp;<span class="op" id="1128514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1128517">var</span>&nbsp;<span class="ident" id="1128521">mu</span>&nbsp;<span class="ident" id="1128524">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1128531">if</span>&nbsp;<span class="ident" id="1128534">slack</span>&nbsp;<span class="op" id="1128540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1128544">b</span><span class="op" id="1128545">.</span><span class="ident" id="1128546">SetParallelism</span><span class="op" id="1128560">(</span><span class="num" id="1128561">10</span><span class="op" id="1128563">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1128566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1128569">b</span><span class="op" id="1128570">.</span><span class="ident" id="1128571">RunParallel</span><span class="op" id="1128582">(</span><span class="keyword" id="1128583">func</span><span class="op" id="1128587">(</span><span class="ident" id="1128588">pb</span>&nbsp;<span class="op" id="1128591">*</span><span class="ident" id="1128592">testing</span><span class="op" id="1128599">.</span><span class="ident" id="1128600">PB</span><span class="op" id="1128602">)</span>&nbsp;<span class="op" id="1128604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1128608">foo</span>&nbsp;<span class="op" id="1128612">:=</span>&nbsp;<span class="num" id="1128615">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1128619">for</span>&nbsp;<span class="ident" id="1128623">pb</span><span class="op" id="1128625">.</span><span class="ident" id="1128626">Next</span><span class="op" id="1128630">(</span><span class="op" id="1128631">)</span>&nbsp;<span class="op" id="1128633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1128638">mu</span><span class="op" id="1128640">.</span><span class="ident" id="1128641">Lock</span><span class="op" id="1128645">(</span><span class="op" id="1128646">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1128651">mu</span><span class="op" id="1128653">.</span><span class="ident" id="1128654">Unlock</span><span class="op" id="1128660">(</span><span class="op" id="1128661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1128666">if</span>&nbsp;<span class="ident" id="1128669">work</span>&nbsp;<span class="op" id="1128674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1128680">for</span>&nbsp;<span class="ident" id="1128684">i</span>&nbsp;<span class="op" id="1128686">:=</span>&nbsp;<span class="num" id="1128689">0</span><span class="op" id="1128690">;</span>&nbsp;<span class="ident" id="1128692">i</span>&nbsp;<span class="op" id="1128694">&lt;</span>&nbsp;<span class="num" id="1128696">100</span><span class="op" id="1128699">;</span>&nbsp;<span class="ident" id="1128701">i</span><span class="op" id="1128702">++</span>&nbsp;<span class="op" id="1128705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1128712">foo</span>&nbsp;<span class="op" id="1128716">*=</span>&nbsp;<span class="num" id="1128719">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1128726">foo</span>&nbsp;<span class="op" id="1128730">/=</span>&nbsp;<span class="num" id="1128733">2</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1128739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1128744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1128748">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1128752">_</span>&nbsp;<span class="op" id="1128754">=</span>&nbsp;<span class="ident" id="1128756">foo</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1128761">}</span><span class="op" id="1128762">)</span><br>
<span class="lineno">120</span><span class="op" id="1128764">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1128767">func</span>&nbsp;<span class="ident" id="1128772">BenchmarkMutex</span><span class="op" id="1128786">(</span><span class="ident" id="1128787">b</span>&nbsp;<span class="op" id="1128789">*</span><span class="ident" id="1128790">testing</span><span class="op" id="1128797">.</span><span class="ident" id="1128798">B</span><span class="op" id="1128799">)</span>&nbsp;<span class="op" id="1128801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1128804">benchmarkMutex</span><span class="op" id="1128818">(</span><span class="ident" id="1128819">b</span><span class="op" id="1128820">,</span>&nbsp;<span class="builtintype" id="1128822">false</span><span class="op" id="1128827">,</span>&nbsp;<span class="builtintype" id="1128829">false</span><span class="op" id="1128834">)</span><br>
<span class="lineno"></span><span class="op" id="1128836">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="1128839">func</span>&nbsp;<span class="ident" id="1128844">BenchmarkMutexSlack</span><span class="op" id="1128863">(</span><span class="ident" id="1128864">b</span>&nbsp;<span class="op" id="1128866">*</span><span class="ident" id="1128867">testing</span><span class="op" id="1128874">.</span><span class="ident" id="1128875">B</span><span class="op" id="1128876">)</span>&nbsp;<span class="op" id="1128878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1128881">benchmarkMutex</span><span class="op" id="1128895">(</span><span class="ident" id="1128896">b</span><span class="op" id="1128897">,</span>&nbsp;<span class="builtintype" id="1128899">true</span><span class="op" id="1128903">,</span>&nbsp;<span class="builtintype" id="1128905">false</span><span class="op" id="1128910">)</span><br>
<span class="lineno"></span><span class="op" id="1128912">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="1128915">func</span>&nbsp;<span class="ident" id="1128920">BenchmarkMutexWork</span><span class="op" id="1128938">(</span><span class="ident" id="1128939">b</span>&nbsp;<span class="op" id="1128941">*</span><span class="ident" id="1128942">testing</span><span class="op" id="1128949">.</span><span class="ident" id="1128950">B</span><span class="op" id="1128951">)</span>&nbsp;<span class="op" id="1128953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1128956">benchmarkMutex</span><span class="op" id="1128970">(</span><span class="ident" id="1128971">b</span><span class="op" id="1128972">,</span>&nbsp;<span class="builtintype" id="1128974">false</span><span class="op" id="1128979">,</span>&nbsp;<span class="builtintype" id="1128981">true</span><span class="op" id="1128985">)</span><br>
<span class="lineno"></span><span class="op" id="1128987">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1128990">func</span>&nbsp;<span class="ident" id="1128995">BenchmarkMutexWorkSlack</span><span class="op" id="1129018">(</span><span class="ident" id="1129019">b</span>&nbsp;<span class="op" id="1129021">*</span><span class="ident" id="1129022">testing</span><span class="op" id="1129029">.</span><span class="ident" id="1129030">B</span><span class="op" id="1129031">)</span>&nbsp;<span class="op" id="1129033">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1129036">benchmarkMutex</span><span class="op" id="1129050">(</span><span class="ident" id="1129051">b</span><span class="op" id="1129052">,</span>&nbsp;<span class="builtintype" id="1129054">true</span><span class="op" id="1129058">,</span>&nbsp;<span class="builtintype" id="1129060">true</span><span class="op" id="1129064">)</span><br>
<span class="lineno"></span><span class="op" id="1129066">}</span>
</div>
</body>
</html>
