<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="keyword" id="4857419">package</span>&nbsp;<span class="ident" id="4857427">arch8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4857434">//&nbsp;Inst&nbsp;is&nbsp;an&nbsp;interface&nbsp;for&nbsp;executing&nbsp;one&nbsp;single&nbsp;instruction</span><br>
<span class="lineno"></span><span class="keyword" id="4857495">type</span>&nbsp;<span class="ident" id="4857500">inst</span>&nbsp;<span class="keyword" id="4857505">interface</span>&nbsp;<span class="op" id="4857515">{</span><br>
<span class="lineno">5</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4857518">I</span><span class="op" id="4857519">(</span><span class="ident" id="4857520">cpu</span>&nbsp;<span class="op" id="4857524">*</span><span class="ident" id="4857525">cpu</span><span class="op" id="4857528">,</span>&nbsp;<span class="ident" id="4857530">in</span>&nbsp;<span class="builtintype" id="4857533">uint32</span><span class="op" id="4857539">)</span>&nbsp;<span class="op" id="4857541">*</span><span class="ident" id="4857542">Excep</span><br>
<span class="lineno"></span><span class="op" id="4857548">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4857551">//&nbsp;CPU&nbsp;defines&nbsp;the&nbsp;structure&nbsp;of&nbsp;a&nbsp;processing&nbsp;unit.</span><br>
<span class="lineno"></span><span class="keyword" id="4857602">type</span>&nbsp;<span class="ident" id="4857607">cpu</span>&nbsp;<span class="keyword" id="4857611">struct</span>&nbsp;<span class="op" id="4857618">{</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4857621">regs</span>&nbsp;<span class="op" id="4857626">[</span><span class="op" id="4857627">]</span><span class="builtintype" id="4857628">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4857636">ring</span>&nbsp;<span class="builtintype" id="4857641">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4857648">phyMem</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4857658">*</span><span class="ident" id="4857659">phyMemory</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4857670">virtMem</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4857680">*</span><span class="ident" id="4857681">virtMemory</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4857693">interrupt</span>&nbsp;<span class="op" id="4857703">*</span><span class="ident" id="4857704">interrupt</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4857716">inst</span>&nbsp;&nbsp;<span class="ident" id="4857722">inst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4857728">index</span>&nbsp;<span class="builtintype" id="4857734">byte</span><br>
<span class="lineno"></span><span class="op" id="4857739">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="4857742">//&nbsp;InitPC&nbsp;points&nbsp;the&nbsp;default&nbsp;starting&nbsp;value&nbsp;of&nbsp;the&nbsp;program&nbsp;counter.</span><br>
<span class="lineno"></span><span class="keyword" id="4857810">const</span>&nbsp;<span class="ident" id="4857816">InitPC</span>&nbsp;<span class="op" id="4857823">=</span>&nbsp;<span class="num" id="4857825">0x8000</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4857833">//&nbsp;NewCPU&nbsp;creates&nbsp;a&nbsp;CPU&nbsp;with&nbsp;memroy&nbsp;and&nbsp;instruction&nbsp;binding</span><br>
<span class="lineno">25</span><span class="keyword" id="4857893">func</span>&nbsp;<span class="ident" id="4857898">newCPU</span><span class="op" id="4857904">(</span><span class="ident" id="4857905">mem</span>&nbsp;<span class="op" id="4857909">*</span><span class="ident" id="4857910">phyMemory</span><span class="op" id="4857919">,</span>&nbsp;<span class="ident" id="4857921">i</span>&nbsp;<span class="ident" id="4857923">inst</span><span class="op" id="4857927">,</span>&nbsp;<span class="ident" id="4857929">index</span>&nbsp;<span class="builtintype" id="4857935">byte</span><span class="op" id="4857939">)</span>&nbsp;<span class="op" id="4857941">*</span><span class="ident" id="4857942">cpu</span>&nbsp;<span class="op" id="4857946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4857949">if</span>&nbsp;<span class="ident" id="4857952">index</span>&nbsp;<span class="op" id="4857958">&gt;=</span>&nbsp;<span class="num" id="4857961">32</span>&nbsp;<span class="op" id="4857964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4857968">panic</span><span class="op" id="4857973">(</span><span class="string" id="4857974">&#34;too&nbsp;many&nbsp;cores&#34;</span><span class="op" id="4857990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4857993">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4857997">ret</span>&nbsp;<span class="op" id="4858001">:=</span>&nbsp;<span class="builtinfunc" id="4858004">new</span><span class="op" id="4858007">(</span><span class="ident" id="4858008">cpu</span><span class="op" id="4858011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858014">ret</span><span class="op" id="4858017">.</span><span class="ident" id="4858018">regs</span>&nbsp;<span class="op" id="4858023">=</span>&nbsp;<span class="ident" id="4858025">makeRegs</span><span class="op" id="4858033">(</span><span class="op" id="4858034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858037">ret</span><span class="op" id="4858040">.</span><span class="ident" id="4858041">phyMem</span>&nbsp;<span class="op" id="4858048">=</span>&nbsp;<span class="ident" id="4858050">mem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858055">ret</span><span class="op" id="4858058">.</span><span class="ident" id="4858059">virtMem</span>&nbsp;<span class="op" id="4858067">=</span>&nbsp;<span class="ident" id="4858069">newVirtMemory</span><span class="op" id="4858082">(</span><span class="ident" id="4858083">ret</span><span class="op" id="4858086">.</span><span class="ident" id="4858087">phyMem</span><span class="op" id="4858093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858096">ret</span><span class="op" id="4858099">.</span><span class="ident" id="4858100">index</span>&nbsp;<span class="op" id="4858106">=</span>&nbsp;<span class="ident" id="4858108">index</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858116">intPage</span>&nbsp;<span class="op" id="4858124">:=</span>&nbsp;<span class="ident" id="4858127">ret</span><span class="op" id="4858130">.</span><span class="ident" id="4858131">phyMem</span><span class="op" id="4858137">.</span><span class="ident" id="4858138">Page</span><span class="op" id="4858142">(</span><span class="ident" id="4858143">pageInterrupt</span><span class="op" id="4858156">)</span>&nbsp;<span class="comment" id="4858158">//&nbsp;page&nbsp;1&nbsp;is&nbsp;the&nbsp;interrupt&nbsp;page</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4858191">if</span>&nbsp;<span class="ident" id="4858194">intPage</span>&nbsp;<span class="op" id="4858202">==</span>&nbsp;<span class="ident" id="4858205">nil</span>&nbsp;<span class="op" id="4858209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4858213">panic</span><span class="op" id="4858218">(</span><span class="string" id="4858219">&#34;memory&nbsp;too&nbsp;small&#34;</span><span class="op" id="4858237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4858240">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858243">ret</span><span class="op" id="4858246">.</span><span class="ident" id="4858247">interrupt</span>&nbsp;<span class="op" id="4858257">=</span>&nbsp;<span class="ident" id="4858259">newInterrupt</span><span class="op" id="4858271">(</span><span class="ident" id="4858272">intPage</span><span class="op" id="4858279">,</span>&nbsp;<span class="ident" id="4858281">index</span><span class="op" id="4858286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858289">ret</span><span class="op" id="4858292">.</span><span class="ident" id="4858293">inst</span>&nbsp;<span class="op" id="4858298">=</span>&nbsp;<span class="ident" id="4858300">i</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858304">ret</span><span class="op" id="4858307">.</span><span class="ident" id="4858308">regs</span><span class="op" id="4858312">[</span><span class="ident" id="4858313">PC</span><span class="op" id="4858315">]</span>&nbsp;<span class="op" id="4858317">=</span>&nbsp;<span class="ident" id="4858319">InitPC</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4858328">return</span>&nbsp;<span class="ident" id="4858335">ret</span><br>
<span class="lineno"></span><span class="op" id="4858339">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4858342">//&nbsp;UserMode&nbsp;returns&nbsp;trun&nbsp;when&nbsp;the&nbsp;CPU&nbsp;is&nbsp;in&nbsp;user&nbsp;mode.</span><br>
<span class="lineno"></span><span class="keyword" id="4858397">func</span>&nbsp;<span class="op" id="4858402">(</span><span class="ident" id="4858403">c</span>&nbsp;<span class="op" id="4858405">*</span><span class="ident" id="4858406">cpu</span><span class="op" id="4858409">)</span>&nbsp;<span class="ident" id="4858411">UserMode</span><span class="op" id="4858419">(</span><span class="op" id="4858420">)</span>&nbsp;<span class="builtintype" id="4858422">bool</span>&nbsp;<span class="op" id="4858427">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4858430">return</span>&nbsp;<span class="ident" id="4858437">c</span><span class="op" id="4858438">.</span><span class="ident" id="4858439">ring</span>&nbsp;<span class="op" id="4858444">&gt;</span>&nbsp;<span class="num" id="4858446">0</span><br>
<span class="lineno"></span><span class="op" id="4858448">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4858451">//&nbsp;Reset&nbsp;resets&nbsp;the&nbsp;CPU&#39;s&nbsp;internal&nbsp;states,&nbsp;i.e.,&nbsp;registers,</span><br>
<span class="lineno"></span><span class="comment" id="4858511">//&nbsp;the&nbsp;page&nbsp;table,&nbsp;and&nbsp;disables&nbsp;interrupt</span><br>
<span class="lineno">55</span><span class="keyword" id="4858553">func</span>&nbsp;<span class="op" id="4858558">(</span><span class="ident" id="4858559">c</span>&nbsp;<span class="op" id="4858561">*</span><span class="ident" id="4858562">cpu</span><span class="op" id="4858565">)</span>&nbsp;<span class="ident" id="4858567">Reset</span><span class="op" id="4858572">(</span><span class="op" id="4858573">)</span>&nbsp;<span class="op" id="4858575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4858578">for</span>&nbsp;<span class="ident" id="4858582">i</span>&nbsp;<span class="op" id="4858584">:=</span>&nbsp;<span class="num" id="4858587">0</span><span class="op" id="4858588">;</span>&nbsp;<span class="ident" id="4858590">i</span>&nbsp;<span class="op" id="4858592">&lt;</span>&nbsp;<span class="ident" id="4858594">Nreg</span><span class="op" id="4858598">;</span>&nbsp;<span class="ident" id="4858600">i</span><span class="op" id="4858601">++</span>&nbsp;<span class="op" id="4858604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858608">c</span><span class="op" id="4858609">.</span><span class="ident" id="4858610">regs</span><span class="op" id="4858614">[</span><span class="ident" id="4858615">i</span><span class="op" id="4858616">]</span>&nbsp;<span class="op" id="4858618">=</span>&nbsp;<span class="num" id="4858620">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4858623">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858626">c</span><span class="op" id="4858627">.</span><span class="ident" id="4858628">regs</span><span class="op" id="4858632">[</span><span class="ident" id="4858633">PC</span><span class="op" id="4858635">]</span>&nbsp;<span class="op" id="4858637">=</span>&nbsp;<span class="ident" id="4858639">InitPC</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858647">c</span><span class="op" id="4858648">.</span><span class="ident" id="4858649">virtMem</span><span class="op" id="4858656">.</span><span class="ident" id="4858657">SetTable</span><span class="op" id="4858665">(</span><span class="num" id="4858666">0</span><span class="op" id="4858667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858670">c</span><span class="op" id="4858671">.</span><span class="ident" id="4858672">ring</span>&nbsp;<span class="op" id="4858677">=</span>&nbsp;<span class="num" id="4858679">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858682">c</span><span class="op" id="4858683">.</span><span class="ident" id="4858684">interrupt</span><span class="op" id="4858693">.</span><span class="ident" id="4858694">Disable</span><span class="op" id="4858701">(</span><span class="op" id="4858702">)</span><br>
<span class="lineno"></span><span class="op" id="4858704">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="keyword" id="4858707">func</span>&nbsp;<span class="op" id="4858712">(</span><span class="ident" id="4858713">c</span>&nbsp;<span class="op" id="4858715">*</span><span class="ident" id="4858716">cpu</span><span class="op" id="4858719">)</span>&nbsp;<span class="ident" id="4858721">tick</span><span class="op" id="4858725">(</span><span class="op" id="4858726">)</span>&nbsp;<span class="op" id="4858728">*</span><span class="ident" id="4858729">Excep</span>&nbsp;<span class="op" id="4858735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858738">pc</span>&nbsp;<span class="op" id="4858741">:=</span>&nbsp;<span class="ident" id="4858744">c</span><span class="op" id="4858745">.</span><span class="ident" id="4858746">regs</span><span class="op" id="4858750">[</span><span class="ident" id="4858751">PC</span><span class="op" id="4858753">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858756">inst</span><span class="op" id="4858760">,</span>&nbsp;<span class="ident" id="4858762">e</span>&nbsp;<span class="op" id="4858764">:=</span>&nbsp;<span class="ident" id="4858767">c</span><span class="op" id="4858768">.</span><span class="ident" id="4858769">readWord</span><span class="op" id="4858777">(</span><span class="ident" id="4858778">pc</span><span class="op" id="4858780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4858783">if</span>&nbsp;<span class="ident" id="4858786">e</span>&nbsp;<span class="op" id="4858788">!=</span>&nbsp;<span class="ident" id="4858791">nil</span>&nbsp;<span class="op" id="4858795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4858799">return</span>&nbsp;<span class="ident" id="4858806">e</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4858809">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858813">c</span><span class="op" id="4858814">.</span><span class="ident" id="4858815">regs</span><span class="op" id="4858819">[</span><span class="ident" id="4858820">PC</span><span class="op" id="4858822">]</span>&nbsp;<span class="op" id="4858824">=</span>&nbsp;<span class="ident" id="4858826">pc</span>&nbsp;<span class="op" id="4858829">+</span>&nbsp;<span class="num" id="4858831">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4858834">if</span>&nbsp;<span class="ident" id="4858837">c</span><span class="op" id="4858838">.</span><span class="ident" id="4858839">inst</span>&nbsp;<span class="op" id="4858844">!=</span>&nbsp;<span class="ident" id="4858847">nil</span>&nbsp;<span class="op" id="4858851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858855">e</span>&nbsp;<span class="op" id="4858857">=</span>&nbsp;<span class="ident" id="4858859">c</span><span class="op" id="4858860">.</span><span class="ident" id="4858861">inst</span><span class="op" id="4858865">.</span><span class="ident" id="4858866">I</span><span class="op" id="4858867">(</span><span class="ident" id="4858868">c</span><span class="op" id="4858869">,</span>&nbsp;<span class="ident" id="4858871">inst</span><span class="op" id="4858875">)</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4858880">if</span>&nbsp;<span class="ident" id="4858883">e</span>&nbsp;<span class="op" id="4858885">!=</span>&nbsp;<span class="ident" id="4858888">nil</span>&nbsp;<span class="op" id="4858892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858897">c</span><span class="op" id="4858898">.</span><span class="ident" id="4858899">regs</span><span class="op" id="4858903">[</span><span class="ident" id="4858904">PC</span><span class="op" id="4858906">]</span>&nbsp;<span class="op" id="4858908">=</span>&nbsp;<span class="ident" id="4858910">pc</span>&nbsp;<span class="comment" id="4858913">//&nbsp;restore&nbsp;saved&nbsp;original&nbsp;PC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4858945">return</span>&nbsp;<span class="ident" id="4858952">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4858956">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4858959">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4858963">return</span>&nbsp;<span class="ident" id="4858970">nil</span><br>
<span class="lineno"></span><span class="op" id="4858974">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="keyword" id="4858977">const</span>&nbsp;<span class="op" id="4858983">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858986">intFrameSP</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4858999">=</span>&nbsp;<span class="num" id="4859001">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4859004">intFrameRET</span>&nbsp;&nbsp;<span class="op" id="4859017">=</span>&nbsp;<span class="num" id="4859019">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4859022">intFrameArg</span>&nbsp;&nbsp;<span class="op" id="4859035">=</span>&nbsp;<span class="num" id="4859037">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4859040">intFrameCode</span>&nbsp;<span class="op" id="4859053">=</span>&nbsp;<span class="num" id="4859055">12</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4859059">intFrameRing</span>&nbsp;<span class="op" id="4859072">=</span>&nbsp;<span class="num" id="4859074">13</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4859079">intFrameSize</span>&nbsp;<span class="op" id="4859092">=</span>&nbsp;<span class="num" id="4859094">16</span><br>
<span class="lineno"></span><span class="op" id="4859097">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="4859100">//&nbsp;Interrupt&nbsp;issues&nbsp;an&nbsp;interrupt&nbsp;to&nbsp;the&nbsp;core</span><br>
<span class="lineno"></span><span class="keyword" id="4859145">func</span>&nbsp;<span class="op" id="4859150">(</span><span class="ident" id="4859151">c</span>&nbsp;<span class="op" id="4859153">*</span><span class="ident" id="4859154">cpu</span><span class="op" id="4859157">)</span>&nbsp;<span class="ident" id="4859159">Interrupt</span><span class="op" id="4859168">(</span><span class="ident" id="4859169">code</span>&nbsp;<span class="builtintype" id="4859174">byte</span><span class="op" id="4859178">)</span>&nbsp;<span class="op" id="4859180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4859183">c</span><span class="op" id="4859184">.</span><span class="ident" id="4859185">interrupt</span><span class="op" id="4859194">.</span><span class="ident" id="4859195">Issue</span><span class="op" id="4859200">(</span><span class="ident" id="4859201">code</span><span class="op" id="4859205">)</span><br>
<span class="lineno"></span><span class="op" id="4859207">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="4859210">func</span>&nbsp;<span class="op" id="4859215">(</span><span class="ident" id="4859216">c</span>&nbsp;<span class="op" id="4859218">*</span><span class="ident" id="4859219">cpu</span><span class="op" id="4859222">)</span>&nbsp;<span class="ident" id="4859224">readWord</span><span class="op" id="4859232">(</span><span class="ident" id="4859233">addr</span>&nbsp;<span class="builtintype" id="4859238">uint32</span><span class="op" id="4859244">)</span>&nbsp;<span class="op" id="4859246">(</span><span class="builtintype" id="4859247">uint32</span><span class="op" id="4859253">,</span>&nbsp;<span class="op" id="4859255">*</span><span class="ident" id="4859256">Excep</span><span class="op" id="4859261">)</span>&nbsp;<span class="op" id="4859263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4859266">return</span>&nbsp;<span class="ident" id="4859273">c</span><span class="op" id="4859274">.</span><span class="ident" id="4859275">virtMem</span><span class="op" id="4859282">.</span><span class="ident" id="4859283">ReadWord</span><span class="op" id="4859291">(</span><span class="ident" id="4859292">addr</span><span class="op" id="4859296">,</span>&nbsp;<span class="ident" id="4859298">c</span><span class="op" id="4859299">.</span><span class="ident" id="4859300">ring</span><span class="op" id="4859304">)</span><br>
<span class="lineno"></span><span class="op" id="4859306">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4859309">func</span>&nbsp;<span class="op" id="4859314">(</span><span class="ident" id="4859315">c</span>&nbsp;<span class="op" id="4859317">*</span><span class="ident" id="4859318">cpu</span><span class="op" id="4859321">)</span>&nbsp;<span class="ident" id="4859323">readByte</span><span class="op" id="4859331">(</span><span class="ident" id="4859332">addr</span>&nbsp;<span class="builtintype" id="4859337">uint32</span><span class="op" id="4859343">)</span>&nbsp;<span class="op" id="4859345">(</span><span class="builtintype" id="4859346">uint8</span><span class="op" id="4859351">,</span>&nbsp;<span class="op" id="4859353">*</span><span class="ident" id="4859354">Excep</span><span class="op" id="4859359">)</span>&nbsp;<span class="op" id="4859361">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4859364">return</span>&nbsp;<span class="ident" id="4859371">c</span><span class="op" id="4859372">.</span><span class="ident" id="4859373">virtMem</span><span class="op" id="4859380">.</span><span class="ident" id="4859381">ReadByte</span><span class="op" id="4859389">(</span><span class="ident" id="4859390">addr</span><span class="op" id="4859394">,</span>&nbsp;<span class="ident" id="4859396">c</span><span class="op" id="4859397">.</span><span class="ident" id="4859398">ring</span><span class="op" id="4859402">)</span><br>
<span class="lineno"></span><span class="op" id="4859404">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4859407">func</span>&nbsp;<span class="op" id="4859412">(</span><span class="ident" id="4859413">c</span>&nbsp;<span class="op" id="4859415">*</span><span class="ident" id="4859416">cpu</span><span class="op" id="4859419">)</span>&nbsp;<span class="ident" id="4859421">writeWord</span><span class="op" id="4859430">(</span><span class="ident" id="4859431">addr</span>&nbsp;<span class="builtintype" id="4859436">uint32</span><span class="op" id="4859442">,</span>&nbsp;<span class="ident" id="4859444">v</span>&nbsp;<span class="builtintype" id="4859446">uint32</span><span class="op" id="4859452">)</span>&nbsp;<span class="op" id="4859454">*</span><span class="ident" id="4859455">Excep</span>&nbsp;<span class="op" id="4859461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4859464">return</span>&nbsp;<span class="ident" id="4859471">c</span><span class="op" id="4859472">.</span><span class="ident" id="4859473">virtMem</span><span class="op" id="4859480">.</span><span class="ident" id="4859481">WriteWord</span><span class="op" id="4859490">(</span><span class="ident" id="4859491">addr</span><span class="op" id="4859495">,</span>&nbsp;<span class="ident" id="4859497">c</span><span class="op" id="4859498">.</span><span class="ident" id="4859499">ring</span><span class="op" id="4859503">,</span>&nbsp;<span class="ident" id="4859505">v</span><span class="op" id="4859506">)</span><br>
<span class="lineno">110</span><span class="op" id="4859508">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4859511">func</span>&nbsp;<span class="op" id="4859516">(</span><span class="ident" id="4859517">c</span>&nbsp;<span class="op" id="4859519">*</span><span class="ident" id="4859520">cpu</span><span class="op" id="4859523">)</span>&nbsp;<span class="ident" id="4859525">writeByte</span><span class="op" id="4859534">(</span><span class="ident" id="4859535">addr</span>&nbsp;<span class="builtintype" id="4859540">uint32</span><span class="op" id="4859546">,</span>&nbsp;<span class="ident" id="4859548">v</span>&nbsp;<span class="builtintype" id="4859550">uint8</span><span class="op" id="4859555">)</span>&nbsp;<span class="op" id="4859557">*</span><span class="ident" id="4859558">Excep</span>&nbsp;<span class="op" id="4859564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4859567">return</span>&nbsp;<span class="ident" id="4859574">c</span><span class="op" id="4859575">.</span><span class="ident" id="4859576">virtMem</span><span class="op" id="4859583">.</span><span class="ident" id="4859584">WriteByte</span><span class="op" id="4859593">(</span><span class="ident" id="4859594">addr</span><span class="op" id="4859598">,</span>&nbsp;<span class="ident" id="4859600">c</span><span class="op" id="4859601">.</span><span class="ident" id="4859602">ring</span><span class="op" id="4859606">,</span>&nbsp;<span class="ident" id="4859608">v</span><span class="op" id="4859609">)</span><br>
<span class="lineno"></span><span class="op" id="4859611">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="comment" id="4859614">//&nbsp;Ienter&nbsp;enters&nbsp;a&nbsp;interrupt&nbsp;routine.</span><br>
<span class="lineno"></span><span class="keyword" id="4859652">func</span>&nbsp;<span class="op" id="4859657">(</span><span class="ident" id="4859658">c</span>&nbsp;<span class="op" id="4859660">*</span><span class="ident" id="4859661">cpu</span><span class="op" id="4859664">)</span>&nbsp;<span class="ident" id="4859666">Ienter</span><span class="op" id="4859672">(</span><span class="ident" id="4859673">code</span>&nbsp;<span class="builtintype" id="4859678">byte</span><span class="op" id="4859682">,</span>&nbsp;<span class="ident" id="4859684">arg</span>&nbsp;<span class="builtintype" id="4859688">uint32</span><span class="op" id="4859694">)</span>&nbsp;<span class="op" id="4859696">*</span><span class="ident" id="4859697">Excep</span>&nbsp;<span class="op" id="4859703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4859706">ksp</span>&nbsp;<span class="op" id="4859710">:=</span>&nbsp;<span class="ident" id="4859713">c</span><span class="op" id="4859714">.</span><span class="ident" id="4859715">interrupt</span><span class="op" id="4859724">.</span><span class="ident" id="4859725">kernelSP</span><span class="op" id="4859733">(</span><span class="op" id="4859734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4859737">base</span>&nbsp;<span class="op" id="4859742">:=</span>&nbsp;<span class="ident" id="4859745">ksp</span>&nbsp;<span class="op" id="4859749">-</span>&nbsp;<span class="ident" id="4859751">intFrameSize</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4859766">writeWord</span>&nbsp;<span class="op" id="4859776">:=</span>&nbsp;<span class="keyword" id="4859779">func</span><span class="op" id="4859783">(</span><span class="ident" id="4859784">off</span>&nbsp;<span class="builtintype" id="4859788">uint32</span><span class="op" id="4859794">,</span>&nbsp;<span class="ident" id="4859796">v</span>&nbsp;<span class="builtintype" id="4859798">uint32</span><span class="op" id="4859804">)</span>&nbsp;<span class="op" id="4859806">*</span><span class="ident" id="4859807">Excep</span>&nbsp;<span class="op" id="4859813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4859817">return</span>&nbsp;<span class="ident" id="4859824">c</span><span class="op" id="4859825">.</span><span class="ident" id="4859826">virtMem</span><span class="op" id="4859833">.</span><span class="ident" id="4859834">WriteWord</span><span class="op" id="4859843">(</span><span class="ident" id="4859844">base</span><span class="op" id="4859848">+</span><span class="ident" id="4859849">off</span><span class="op" id="4859852">,</span>&nbsp;<span class="num" id="4859854">0</span><span class="op" id="4859855">,</span>&nbsp;<span class="ident" id="4859857">v</span><span class="op" id="4859858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4859861">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4859864">writeByte</span>&nbsp;<span class="op" id="4859874">:=</span>&nbsp;<span class="keyword" id="4859877">func</span><span class="op" id="4859881">(</span><span class="ident" id="4859882">off</span>&nbsp;<span class="builtintype" id="4859886">uint32</span><span class="op" id="4859892">,</span>&nbsp;<span class="ident" id="4859894">b</span>&nbsp;<span class="builtintype" id="4859896">uint8</span><span class="op" id="4859901">)</span>&nbsp;<span class="op" id="4859903">*</span><span class="ident" id="4859904">Excep</span>&nbsp;<span class="op" id="4859910">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4859914">return</span>&nbsp;<span class="ident" id="4859921">c</span><span class="op" id="4859922">.</span><span class="ident" id="4859923">virtMem</span><span class="op" id="4859930">.</span><span class="ident" id="4859931">WriteByte</span><span class="op" id="4859940">(</span><span class="ident" id="4859941">base</span><span class="op" id="4859945">+</span><span class="ident" id="4859946">off</span><span class="op" id="4859949">,</span>&nbsp;<span class="num" id="4859951">0</span><span class="op" id="4859952">,</span>&nbsp;<span class="ident" id="4859954">b</span><span class="op" id="4859955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4859958">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4859961">if</span>&nbsp;<span class="ident" id="4859964">e</span>&nbsp;<span class="op" id="4859966">:=</span>&nbsp;<span class="ident" id="4859969">writeWord</span><span class="op" id="4859978">(</span><span class="ident" id="4859979">intFrameSP</span><span class="op" id="4859989">,</span>&nbsp;<span class="ident" id="4859991">c</span><span class="op" id="4859992">.</span><span class="ident" id="4859993">regs</span><span class="op" id="4859997">[</span><span class="ident" id="4859998">SP</span><span class="op" id="4860000">]</span><span class="op" id="4860001">)</span><span class="op" id="4860002">;</span>&nbsp;<span class="ident" id="4860004">e</span>&nbsp;<span class="op" id="4860006">!=</span>&nbsp;<span class="ident" id="4860009">nil</span>&nbsp;<span class="op" id="4860013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4860017">return</span>&nbsp;<span class="ident" id="4860024">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4860027">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4860030">if</span>&nbsp;<span class="ident" id="4860033">e</span>&nbsp;<span class="op" id="4860035">:=</span>&nbsp;<span class="ident" id="4860038">writeWord</span><span class="op" id="4860047">(</span><span class="ident" id="4860048">intFrameRET</span><span class="op" id="4860059">,</span>&nbsp;<span class="ident" id="4860061">c</span><span class="op" id="4860062">.</span><span class="ident" id="4860063">regs</span><span class="op" id="4860067">[</span><span class="ident" id="4860068">RET</span><span class="op" id="4860071">]</span><span class="op" id="4860072">)</span><span class="op" id="4860073">;</span>&nbsp;<span class="ident" id="4860075">e</span>&nbsp;<span class="op" id="4860077">!=</span>&nbsp;<span class="ident" id="4860080">nil</span>&nbsp;<span class="op" id="4860084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4860088">return</span>&nbsp;<span class="ident" id="4860095">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4860098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4860101">if</span>&nbsp;<span class="ident" id="4860104">e</span>&nbsp;<span class="op" id="4860106">:=</span>&nbsp;<span class="ident" id="4860109">writeWord</span><span class="op" id="4860118">(</span><span class="ident" id="4860119">intFrameArg</span><span class="op" id="4860130">,</span>&nbsp;<span class="ident" id="4860132">arg</span><span class="op" id="4860135">)</span><span class="op" id="4860136">;</span>&nbsp;<span class="ident" id="4860138">e</span>&nbsp;<span class="op" id="4860140">!=</span>&nbsp;<span class="ident" id="4860143">nil</span>&nbsp;<span class="op" id="4860147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4860151">return</span>&nbsp;<span class="ident" id="4860158">e</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4860161">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4860164">if</span>&nbsp;<span class="ident" id="4860167">e</span>&nbsp;<span class="op" id="4860169">:=</span>&nbsp;<span class="ident" id="4860172">writeByte</span><span class="op" id="4860181">(</span><span class="ident" id="4860182">intFrameCode</span><span class="op" id="4860194">,</span>&nbsp;<span class="ident" id="4860196">code</span><span class="op" id="4860200">)</span><span class="op" id="4860201">;</span>&nbsp;<span class="ident" id="4860203">e</span>&nbsp;<span class="op" id="4860205">!=</span>&nbsp;<span class="ident" id="4860208">nil</span>&nbsp;<span class="op" id="4860212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4860216">return</span>&nbsp;<span class="ident" id="4860223">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4860226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4860229">if</span>&nbsp;<span class="ident" id="4860232">e</span>&nbsp;<span class="op" id="4860234">:=</span>&nbsp;<span class="ident" id="4860237">writeByte</span><span class="op" id="4860246">(</span><span class="ident" id="4860247">intFrameRing</span><span class="op" id="4860259">,</span>&nbsp;<span class="ident" id="4860261">c</span><span class="op" id="4860262">.</span><span class="ident" id="4860263">ring</span><span class="op" id="4860267">)</span><span class="op" id="4860268">;</span>&nbsp;<span class="ident" id="4860270">e</span>&nbsp;<span class="op" id="4860272">!=</span>&nbsp;<span class="ident" id="4860275">nil</span>&nbsp;<span class="op" id="4860279">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4860283">return</span>&nbsp;<span class="ident" id="4860290">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4860293">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4860297">c</span><span class="op" id="4860298">.</span><span class="ident" id="4860299">interrupt</span><span class="op" id="4860308">.</span><span class="ident" id="4860309">Disable</span><span class="op" id="4860316">(</span><span class="op" id="4860317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4860320">c</span><span class="op" id="4860321">.</span><span class="ident" id="4860322">regs</span><span class="op" id="4860326">[</span><span class="ident" id="4860327">SP</span><span class="op" id="4860329">]</span>&nbsp;<span class="op" id="4860331">=</span>&nbsp;<span class="ident" id="4860333">ksp</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4860338">c</span><span class="op" id="4860339">.</span><span class="ident" id="4860340">regs</span><span class="op" id="4860344">[</span><span class="ident" id="4860345">RET</span><span class="op" id="4860348">]</span>&nbsp;<span class="op" id="4860350">=</span>&nbsp;<span class="ident" id="4860352">c</span><span class="op" id="4860353">.</span><span class="ident" id="4860354">regs</span><span class="op" id="4860358">[</span><span class="ident" id="4860359">PC</span><span class="op" id="4860361">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4860364">c</span><span class="op" id="4860365">.</span><span class="ident" id="4860366">regs</span><span class="op" id="4860370">[</span><span class="ident" id="4860371">PC</span><span class="op" id="4860373">]</span>&nbsp;<span class="op" id="4860375">=</span>&nbsp;<span class="ident" id="4860377">c</span><span class="op" id="4860378">.</span><span class="ident" id="4860379">interrupt</span><span class="op" id="4860388">.</span><span class="ident" id="4860389">handlerPC</span><span class="op" id="4860398">(</span><span class="op" id="4860399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4860402">c</span><span class="op" id="4860403">.</span><span class="ident" id="4860404">ring</span>&nbsp;<span class="op" id="4860409">=</span>&nbsp;<span class="num" id="4860411">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4860415">return</span>&nbsp;<span class="ident" id="4860422">nil</span><br>
<span class="lineno">150</span><span class="op" id="4860426">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4860429">//&nbsp;Syscall&nbsp;jumps&nbsp;to&nbsp;the&nbsp;system&nbsp;call&nbsp;handler&nbsp;and&nbsp;switches&nbsp;to&nbsp;ring&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="4860497">func</span>&nbsp;<span class="op" id="4860502">(</span><span class="ident" id="4860503">c</span>&nbsp;<span class="op" id="4860505">*</span><span class="ident" id="4860506">cpu</span><span class="op" id="4860509">)</span>&nbsp;<span class="ident" id="4860511">Syscall</span><span class="op" id="4860518">(</span><span class="op" id="4860519">)</span>&nbsp;<span class="op" id="4860521">*</span><span class="ident" id="4860522">Excep</span>&nbsp;<span class="op" id="4860528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4860531">c</span><span class="op" id="4860532">.</span><span class="ident" id="4860533">regs</span><span class="op" id="4860537">[</span><span class="ident" id="4860538">PC</span><span class="op" id="4860540">]</span>&nbsp;<span class="op" id="4860542">=</span>&nbsp;<span class="ident" id="4860544">c</span><span class="op" id="4860545">.</span><span class="ident" id="4860546">interrupt</span><span class="op" id="4860555">.</span><span class="ident" id="4860556">syscallPC</span><span class="op" id="4860565">(</span><span class="op" id="4860566">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4860569">c</span><span class="op" id="4860570">.</span><span class="ident" id="4860571">ring</span>&nbsp;<span class="op" id="4860576">=</span>&nbsp;<span class="num" id="4860578">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4860581">return</span>&nbsp;<span class="ident" id="4860588">nil</span><br>
<span class="lineno"></span><span class="op" id="4860592">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4860595">//&nbsp;Iret&nbsp;restores&nbsp;from&nbsp;an&nbsp;interrupt.</span><br>
<span class="lineno">160</span><span class="comment" id="4860631">//&nbsp;It&nbsp;restores&nbsp;the&nbsp;SP,&nbsp;RET,&nbsp;PC&nbsp;registers,&nbsp;restores&nbsp;the&nbsp;ring&nbsp;level,</span><br>
<span class="lineno"></span><span class="comment" id="4860698">//&nbsp;clears&nbsp;the&nbsp;served&nbsp;interrupt&nbsp;bit&nbsp;and&nbsp;enables&nbsp;interrupt&nbsp;again.</span><br>
<span class="lineno"></span><span class="keyword" id="4860762">func</span>&nbsp;<span class="op" id="4860767">(</span><span class="ident" id="4860768">c</span>&nbsp;<span class="op" id="4860770">*</span><span class="ident" id="4860771">cpu</span><span class="op" id="4860774">)</span>&nbsp;<span class="ident" id="4860776">Iret</span><span class="op" id="4860780">(</span><span class="op" id="4860781">)</span>&nbsp;<span class="op" id="4860783">*</span><span class="ident" id="4860784">Excep</span>&nbsp;<span class="op" id="4860790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4860793">if</span>&nbsp;<span class="ident" id="4860796">c</span><span class="op" id="4860797">.</span><span class="ident" id="4860798">ring</span>&nbsp;<span class="op" id="4860803">!=</span>&nbsp;<span class="num" id="4860806">0</span>&nbsp;<span class="op" id="4860808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4860812">panic</span><span class="op" id="4860817">(</span><span class="string" id="4860818">&#34;iret&nbsp;in&nbsp;userland&#34;</span><span class="op" id="4860836">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4860839">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4860843">ksp</span>&nbsp;<span class="op" id="4860847">:=</span>&nbsp;<span class="ident" id="4860850">c</span><span class="op" id="4860851">.</span><span class="ident" id="4860852">interrupt</span><span class="op" id="4860861">.</span><span class="ident" id="4860862">kernelSP</span><span class="op" id="4860870">(</span><span class="op" id="4860871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4860874">base</span>&nbsp;<span class="op" id="4860879">:=</span>&nbsp;<span class="ident" id="4860882">ksp</span>&nbsp;<span class="op" id="4860886">-</span>&nbsp;<span class="ident" id="4860888">intFrameSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4860902">sp</span><span class="op" id="4860904">,</span>&nbsp;<span class="ident" id="4860906">e</span>&nbsp;<span class="op" id="4860908">:=</span>&nbsp;<span class="ident" id="4860911">c</span><span class="op" id="4860912">.</span><span class="ident" id="4860913">readWord</span><span class="op" id="4860921">(</span><span class="ident" id="4860922">base</span>&nbsp;<span class="op" id="4860927">+</span>&nbsp;<span class="ident" id="4860929">intFrameSP</span><span class="op" id="4860939">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4860942">if</span>&nbsp;<span class="ident" id="4860945">e</span>&nbsp;<span class="op" id="4860947">!=</span>&nbsp;<span class="ident" id="4860950">nil</span>&nbsp;<span class="op" id="4860954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4860958">return</span>&nbsp;<span class="ident" id="4860965">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4860968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4860971">ret</span><span class="op" id="4860974">,</span>&nbsp;<span class="ident" id="4860976">e</span>&nbsp;<span class="op" id="4860978">:=</span>&nbsp;<span class="ident" id="4860981">c</span><span class="op" id="4860982">.</span><span class="ident" id="4860983">readWord</span><span class="op" id="4860991">(</span><span class="ident" id="4860992">base</span>&nbsp;<span class="op" id="4860997">+</span>&nbsp;<span class="ident" id="4860999">intFrameRET</span><span class="op" id="4861010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4861013">if</span>&nbsp;<span class="ident" id="4861016">e</span>&nbsp;<span class="op" id="4861018">!=</span>&nbsp;<span class="ident" id="4861021">nil</span>&nbsp;<span class="op" id="4861025">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4861029">return</span>&nbsp;<span class="ident" id="4861036">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4861039">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4861042">code</span><span class="op" id="4861046">,</span>&nbsp;<span class="ident" id="4861048">e</span>&nbsp;<span class="op" id="4861050">:=</span>&nbsp;<span class="ident" id="4861053">c</span><span class="op" id="4861054">.</span><span class="ident" id="4861055">readByte</span><span class="op" id="4861063">(</span><span class="ident" id="4861064">base</span>&nbsp;<span class="op" id="4861069">+</span>&nbsp;<span class="ident" id="4861071">intFrameCode</span><span class="op" id="4861083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4861086">if</span>&nbsp;<span class="ident" id="4861089">e</span>&nbsp;<span class="op" id="4861091">!=</span>&nbsp;<span class="ident" id="4861094">nil</span>&nbsp;<span class="op" id="4861098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4861102">return</span>&nbsp;<span class="ident" id="4861109">e</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4861112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4861115">ring</span><span class="op" id="4861119">,</span>&nbsp;<span class="ident" id="4861121">e</span>&nbsp;<span class="op" id="4861123">:=</span>&nbsp;<span class="ident" id="4861126">c</span><span class="op" id="4861127">.</span><span class="ident" id="4861128">readByte</span><span class="op" id="4861136">(</span><span class="ident" id="4861137">base</span>&nbsp;<span class="op" id="4861142">+</span>&nbsp;<span class="ident" id="4861144">intFrameRing</span><span class="op" id="4861156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4861159">if</span>&nbsp;<span class="ident" id="4861162">e</span>&nbsp;<span class="op" id="4861164">!=</span>&nbsp;<span class="ident" id="4861167">nil</span>&nbsp;<span class="op" id="4861171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4861175">return</span>&nbsp;<span class="ident" id="4861182">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4861185">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4861189">c</span><span class="op" id="4861190">.</span><span class="ident" id="4861191">regs</span><span class="op" id="4861195">[</span><span class="ident" id="4861196">PC</span><span class="op" id="4861198">]</span>&nbsp;<span class="op" id="4861200">=</span>&nbsp;<span class="ident" id="4861202">c</span><span class="op" id="4861203">.</span><span class="ident" id="4861204">regs</span><span class="op" id="4861208">[</span><span class="ident" id="4861209">RET</span><span class="op" id="4861212">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4861215">c</span><span class="op" id="4861216">.</span><span class="ident" id="4861217">regs</span><span class="op" id="4861221">[</span><span class="ident" id="4861222">RET</span><span class="op" id="4861225">]</span>&nbsp;<span class="op" id="4861227">=</span>&nbsp;<span class="ident" id="4861229">ret</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4861234">c</span><span class="op" id="4861235">.</span><span class="ident" id="4861236">regs</span><span class="op" id="4861240">[</span><span class="ident" id="4861241">SP</span><span class="op" id="4861243">]</span>&nbsp;<span class="op" id="4861245">=</span>&nbsp;<span class="ident" id="4861247">sp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4861251">c</span><span class="op" id="4861252">.</span><span class="ident" id="4861253">ring</span>&nbsp;<span class="op" id="4861258">=</span>&nbsp;<span class="ident" id="4861260">ring</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4861266">c</span><span class="op" id="4861267">.</span><span class="ident" id="4861268">interrupt</span><span class="op" id="4861277">.</span><span class="ident" id="4861278">Clear</span><span class="op" id="4861283">(</span><span class="ident" id="4861284">code</span><span class="op" id="4861288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4861291">c</span><span class="op" id="4861292">.</span><span class="ident" id="4861293">interrupt</span><span class="op" id="4861302">.</span><span class="ident" id="4861303">Enable</span><span class="op" id="4861309">(</span><span class="op" id="4861310">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4861314">return</span>&nbsp;<span class="ident" id="4861321">nil</span><br>
<span class="lineno"></span><span class="op" id="4861325">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="comment" id="4861328">//&nbsp;Tick&nbsp;executes&nbsp;one&nbsp;instruction,&nbsp;and&nbsp;increases&nbsp;the&nbsp;program&nbsp;counter</span><br>
<span class="lineno"></span><span class="comment" id="4861396">//&nbsp;by&nbsp;4&nbsp;by&nbsp;default.&nbsp;If&nbsp;an&nbsp;exception&nbsp;is&nbsp;met,&nbsp;it&nbsp;will&nbsp;handle&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="4861459">func</span>&nbsp;<span class="op" id="4861464">(</span><span class="ident" id="4861465">c</span>&nbsp;<span class="op" id="4861467">*</span><span class="ident" id="4861468">cpu</span><span class="op" id="4861471">)</span>&nbsp;<span class="ident" id="4861473">Tick</span><span class="op" id="4861477">(</span><span class="op" id="4861478">)</span>&nbsp;<span class="op" id="4861480">*</span><span class="ident" id="4861481">Excep</span>&nbsp;<span class="op" id="4861487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4861490">poll</span><span class="op" id="4861494">,</span>&nbsp;<span class="ident" id="4861496">code</span>&nbsp;<span class="op" id="4861501">:=</span>&nbsp;<span class="ident" id="4861504">c</span><span class="op" id="4861505">.</span><span class="ident" id="4861506">interrupt</span><span class="op" id="4861515">.</span><span class="ident" id="4861516">Poll</span><span class="op" id="4861520">(</span><span class="op" id="4861521">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4861524">if</span>&nbsp;<span class="ident" id="4861527">poll</span>&nbsp;<span class="op" id="4861532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4861536">return</span>&nbsp;<span class="ident" id="4861543">c</span><span class="op" id="4861544">.</span><span class="ident" id="4861545">Ienter</span><span class="op" id="4861551">(</span><span class="ident" id="4861552">code</span><span class="op" id="4861556">,</span>&nbsp;<span class="num" id="4861558">0</span><span class="op" id="4861559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4861562">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4861566">//&nbsp;no&nbsp;interrupt&nbsp;to&nbsp;dispatch,&nbsp;let&#39;s&nbsp;proceed</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4861610">e</span>&nbsp;<span class="op" id="4861612">:=</span>&nbsp;<span class="ident" id="4861615">c</span><span class="op" id="4861616">.</span><span class="ident" id="4861617">tick</span><span class="op" id="4861621">(</span><span class="op" id="4861622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4861625">if</span>&nbsp;<span class="ident" id="4861628">e</span>&nbsp;<span class="op" id="4861630">!=</span>&nbsp;<span class="ident" id="4861633">nil</span>&nbsp;<span class="op" id="4861637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4861641">//&nbsp;proceed&nbsp;attempt&nbsp;failed,&nbsp;handle&nbsp;the&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4861687">c</span><span class="op" id="4861688">.</span><span class="ident" id="4861689">interrupt</span><span class="op" id="4861698">.</span><span class="ident" id="4861699">Issue</span><span class="op" id="4861704">(</span><span class="ident" id="4861705">e</span><span class="op" id="4861706">.</span><span class="ident" id="4861707">Code</span><span class="op" id="4861711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4861715">poll</span><span class="op" id="4861719">,</span>&nbsp;<span class="ident" id="4861721">code</span>&nbsp;<span class="op" id="4861726">:=</span>&nbsp;<span class="ident" id="4861729">c</span><span class="op" id="4861730">.</span><span class="ident" id="4861731">interrupt</span><span class="op" id="4861740">.</span><span class="ident" id="4861741">Poll</span><span class="op" id="4861745">(</span><span class="op" id="4861746">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4861750">if</span>&nbsp;<span class="ident" id="4861753">poll</span>&nbsp;<span class="op" id="4861758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4861763">if</span>&nbsp;<span class="ident" id="4861766">code</span>&nbsp;<span class="op" id="4861771">!=</span>&nbsp;<span class="ident" id="4861774">e</span><span class="op" id="4861775">.</span><span class="ident" id="4861776">Code</span>&nbsp;<span class="op" id="4861781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4861787">panic</span><span class="op" id="4861792">(</span><span class="string" id="4861793">&#34;interrupt&nbsp;code&nbsp;is&nbsp;different&#34;</span><span class="op" id="4861822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4861827">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4861832">return</span>&nbsp;<span class="ident" id="4861839">c</span><span class="op" id="4861840">.</span><span class="ident" id="4861841">Ienter</span><span class="op" id="4861847">(</span><span class="ident" id="4861848">code</span><span class="op" id="4861852">,</span>&nbsp;<span class="ident" id="4861854">e</span><span class="op" id="4861855">.</span><span class="ident" id="4861856">Arg</span><span class="op" id="4861859">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4861863">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4861866">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4861870">return</span>&nbsp;<span class="ident" id="4861877">e</span><br>
<span class="lineno"></span><span class="op" id="4861879">}</span>
</div>
</body>
</html>
