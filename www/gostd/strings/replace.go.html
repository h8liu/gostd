<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>strings</h2>
<ul>
<li><a href="/gostd/strings/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/strings/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/strings/reader.go.html">reader.go</a></li>
<li><a href="/gostd/strings/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/strings/replace.go.html" class="current">replace.go</a></li>
<li><a href="/gostd/strings/replace_test.go.html">replace_test.go</a></li>
<li><a href="/gostd/strings/search.go.html">search.go</a></li>
<li><a href="/gostd/strings/search_test.go.html">search_test.go</a></li>
<li><a href="/gostd/strings/strings.go.html">strings.go</a></li>
<li><a href="/gostd/strings/strings_decl.go.html">strings_decl.go</a></li>
<li><a href="/gostd/strings/strings_test.go.html">strings_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1346127">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1346182">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1346236">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1346287">package</span>&nbsp;<span class="ident" id="1346295">strings</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1346304">import</span>&nbsp;<span class="string" id="1346311">&#34;io&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1346317">//&nbsp;Replacer&nbsp;replaces&nbsp;a&nbsp;list&nbsp;of&nbsp;strings&nbsp;with&nbsp;replacements.</span><br>
<span class="lineno">10</span><span class="comment" id="1346375">//&nbsp;It&nbsp;is&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="1346432">type</span>&nbsp;<span class="ident" id="1346437">Replacer</span>&nbsp;<span class="keyword" id="1346446">struct</span>&nbsp;<span class="op" id="1346453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1346456">r</span>&nbsp;<span class="ident" id="1346458">replacer</span><br>
<span class="lineno"></span><span class="op" id="1346467">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="1346470">//&nbsp;replacer&nbsp;is&nbsp;the&nbsp;interface&nbsp;that&nbsp;a&nbsp;replacement&nbsp;algorithm&nbsp;needs&nbsp;to&nbsp;implement.</span><br>
<span class="lineno"></span><span class="keyword" id="1346548">type</span>&nbsp;<span class="ident" id="1346553">replacer</span>&nbsp;<span class="keyword" id="1346562">interface</span>&nbsp;<span class="op" id="1346572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1346575">Replace</span><span class="op" id="1346582">(</span><span class="ident" id="1346583">s</span>&nbsp;<span class="builtintype" id="1346585">string</span><span class="op" id="1346591">)</span>&nbsp;<span class="builtintype" id="1346593">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1346601">WriteString</span><span class="op" id="1346612">(</span><span class="ident" id="1346613">w</span>&nbsp;<span class="ident" id="1346615">io</span><span class="op" id="1346617">.</span><span class="ident" id="1346618">Writer</span><span class="op" id="1346624">,</span>&nbsp;<span class="ident" id="1346626">s</span>&nbsp;<span class="builtintype" id="1346628">string</span><span class="op" id="1346634">)</span>&nbsp;<span class="op" id="1346636">(</span><span class="ident" id="1346637">n</span>&nbsp;<span class="builtintype" id="1346639">int</span><span class="op" id="1346642">,</span>&nbsp;<span class="ident" id="1346644">err</span>&nbsp;<span class="builtintype" id="1346648">error</span><span class="op" id="1346653">)</span><br>
<span class="lineno"></span><span class="op" id="1346655">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="1346658">//&nbsp;NewReplacer&nbsp;returns&nbsp;a&nbsp;new&nbsp;Replacer&nbsp;from&nbsp;a&nbsp;list&nbsp;of&nbsp;old,&nbsp;new&nbsp;string&nbsp;pairs.</span><br>
<span class="lineno"></span><span class="comment" id="1346734">//&nbsp;Replacements&nbsp;are&nbsp;performed&nbsp;in&nbsp;order,&nbsp;without&nbsp;overlapping&nbsp;matches.</span><br>
<span class="lineno"></span><span class="keyword" id="1346803">func</span>&nbsp;<span class="ident" id="1346808">NewReplacer</span><span class="op" id="1346819">(</span><span class="ident" id="1346820">oldnew</span>&nbsp;<span class="op" id="1346827">...</span><span class="builtintype" id="1346830">string</span><span class="op" id="1346836">)</span>&nbsp;<span class="op" id="1346838">*</span><span class="ident" id="1346839">Replacer</span>&nbsp;<span class="op" id="1346848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1346851">if</span>&nbsp;<span class="builtinfunc" id="1346854">len</span><span class="op" id="1346857">(</span><span class="ident" id="1346858">oldnew</span><span class="op" id="1346864">)</span><span class="op" id="1346865">%</span><span class="num" id="1346866">2</span>&nbsp;<span class="op" id="1346868">==</span>&nbsp;<span class="num" id="1346871">1</span>&nbsp;<span class="op" id="1346873">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1346877">panic</span><span class="op" id="1346882">(</span><span class="string" id="1346883">&#34;strings.NewReplacer:&nbsp;odd&nbsp;argument&nbsp;count&#34;</span><span class="op" id="1346924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1346927">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1346931">if</span>&nbsp;<span class="builtinfunc" id="1346934">len</span><span class="op" id="1346937">(</span><span class="ident" id="1346938">oldnew</span><span class="op" id="1346944">)</span>&nbsp;<span class="op" id="1346946">==</span>&nbsp;<span class="num" id="1346949">2</span>&nbsp;<span class="op" id="1346951">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="1346954">len</span><span class="op" id="1346957">(</span><span class="ident" id="1346958">oldnew</span><span class="op" id="1346964">[</span><span class="num" id="1346965">0</span><span class="op" id="1346966">]</span><span class="op" id="1346967">)</span>&nbsp;<span class="op" id="1346969">&gt;</span>&nbsp;<span class="num" id="1346971">1</span>&nbsp;<span class="op" id="1346973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1346977">return</span>&nbsp;<span class="op" id="1346984">&amp;</span><span class="ident" id="1346985">Replacer</span><span class="op" id="1346993">{</span><span class="ident" id="1346994">r</span><span class="op" id="1346995">:</span>&nbsp;<span class="ident" id="1346997">makeSingleStringReplacer</span><span class="op" id="1347021">(</span><span class="ident" id="1347022">oldnew</span><span class="op" id="1347028">[</span><span class="num" id="1347029">0</span><span class="op" id="1347030">]</span><span class="op" id="1347031">,</span>&nbsp;<span class="ident" id="1347033">oldnew</span><span class="op" id="1347039">[</span><span class="num" id="1347040">1</span><span class="op" id="1347041">]</span><span class="op" id="1347042">)</span><span class="op" id="1347043">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1347046">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1347050">allNewBytes</span>&nbsp;<span class="op" id="1347062">:=</span>&nbsp;<span class="builtintype" id="1347065">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1347071">for</span>&nbsp;<span class="ident" id="1347075">i</span>&nbsp;<span class="op" id="1347077">:=</span>&nbsp;<span class="num" id="1347080">0</span><span class="op" id="1347081">;</span>&nbsp;<span class="ident" id="1347083">i</span>&nbsp;<span class="op" id="1347085">&lt;</span>&nbsp;<span class="builtinfunc" id="1347087">len</span><span class="op" id="1347090">(</span><span class="ident" id="1347091">oldnew</span><span class="op" id="1347097">)</span><span class="op" id="1347098">;</span>&nbsp;<span class="ident" id="1347100">i</span>&nbsp;<span class="op" id="1347102">+=</span>&nbsp;<span class="num" id="1347105">2</span>&nbsp;<span class="op" id="1347107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1347111">if</span>&nbsp;<span class="builtinfunc" id="1347114">len</span><span class="op" id="1347117">(</span><span class="ident" id="1347118">oldnew</span><span class="op" id="1347124">[</span><span class="ident" id="1347125">i</span><span class="op" id="1347126">]</span><span class="op" id="1347127">)</span>&nbsp;<span class="op" id="1347129">!=</span>&nbsp;<span class="num" id="1347132">1</span>&nbsp;<span class="op" id="1347134">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1347139">return</span>&nbsp;<span class="op" id="1347146">&amp;</span><span class="ident" id="1347147">Replacer</span><span class="op" id="1347155">{</span><span class="ident" id="1347156">r</span><span class="op" id="1347157">:</span>&nbsp;<span class="ident" id="1347159">makeGenericReplacer</span><span class="op" id="1347178">(</span><span class="ident" id="1347179">oldnew</span><span class="op" id="1347185">)</span><span class="op" id="1347186">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1347190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1347194">if</span>&nbsp;<span class="builtinfunc" id="1347197">len</span><span class="op" id="1347200">(</span><span class="ident" id="1347201">oldnew</span><span class="op" id="1347207">[</span><span class="ident" id="1347208">i</span><span class="op" id="1347209">+</span><span class="num" id="1347210">1</span><span class="op" id="1347211">]</span><span class="op" id="1347212">)</span>&nbsp;<span class="op" id="1347214">!=</span>&nbsp;<span class="num" id="1347217">1</span>&nbsp;<span class="op" id="1347219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1347224">allNewBytes</span>&nbsp;<span class="op" id="1347236">=</span>&nbsp;<span class="builtintype" id="1347238">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1347246">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1347249">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1347253">if</span>&nbsp;<span class="ident" id="1347256">allNewBytes</span>&nbsp;<span class="op" id="1347268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1347272">r</span>&nbsp;<span class="op" id="1347274">:=</span>&nbsp;<span class="ident" id="1347277">byteReplacer</span><span class="op" id="1347289">{</span><span class="op" id="1347290">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1347294">for</span>&nbsp;<span class="ident" id="1347298">i</span>&nbsp;<span class="op" id="1347300">:=</span>&nbsp;<span class="keyword" id="1347303">range</span>&nbsp;<span class="ident" id="1347309">r</span>&nbsp;<span class="op" id="1347311">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1347316">r</span><span class="op" id="1347317">[</span><span class="ident" id="1347318">i</span><span class="op" id="1347319">]</span>&nbsp;<span class="op" id="1347321">=</span>&nbsp;<span class="builtintype" id="1347323">byte</span><span class="op" id="1347327">(</span><span class="ident" id="1347328">i</span><span class="op" id="1347329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1347333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1347337">//&nbsp;The&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;old-&gt;new&nbsp;map&nbsp;takes&nbsp;precedence</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1347396">//&nbsp;over&nbsp;the&nbsp;others&nbsp;with&nbsp;the&nbsp;same&nbsp;old&nbsp;string.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1347443">for</span>&nbsp;<span class="ident" id="1347447">i</span>&nbsp;<span class="op" id="1347449">:=</span>&nbsp;<span class="builtinfunc" id="1347452">len</span><span class="op" id="1347455">(</span><span class="ident" id="1347456">oldnew</span><span class="op" id="1347462">)</span>&nbsp;<span class="op" id="1347464">-</span>&nbsp;<span class="num" id="1347466">2</span><span class="op" id="1347467">;</span>&nbsp;<span class="ident" id="1347469">i</span>&nbsp;<span class="op" id="1347471">&gt;=</span>&nbsp;<span class="num" id="1347474">0</span><span class="op" id="1347475">;</span>&nbsp;<span class="ident" id="1347477">i</span>&nbsp;<span class="op" id="1347479">-=</span>&nbsp;<span class="num" id="1347482">2</span>&nbsp;<span class="op" id="1347484">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1347489">o</span>&nbsp;<span class="op" id="1347491">:=</span>&nbsp;<span class="ident" id="1347494">oldnew</span><span class="op" id="1347500">[</span><span class="ident" id="1347501">i</span><span class="op" id="1347502">]</span><span class="op" id="1347503">[</span><span class="num" id="1347504">0</span><span class="op" id="1347505">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1347510">n</span>&nbsp;<span class="op" id="1347512">:=</span>&nbsp;<span class="ident" id="1347515">oldnew</span><span class="op" id="1347521">[</span><span class="ident" id="1347522">i</span><span class="op" id="1347523">+</span><span class="num" id="1347524">1</span><span class="op" id="1347525">]</span><span class="op" id="1347526">[</span><span class="num" id="1347527">0</span><span class="op" id="1347528">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1347533">r</span><span class="op" id="1347534">[</span><span class="ident" id="1347535">o</span><span class="op" id="1347536">]</span>&nbsp;<span class="op" id="1347538">=</span>&nbsp;<span class="ident" id="1347540">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1347544">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1347548">return</span>&nbsp;<span class="op" id="1347555">&amp;</span><span class="ident" id="1347556">Replacer</span><span class="op" id="1347564">{</span><span class="ident" id="1347565">r</span><span class="op" id="1347566">:</span>&nbsp;<span class="op" id="1347568">&amp;</span><span class="ident" id="1347569">r</span><span class="op" id="1347570">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1347573">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1347577">r</span>&nbsp;<span class="op" id="1347579">:=</span>&nbsp;<span class="ident" id="1347582">byteStringReplacer</span><span class="op" id="1347600">{</span><span class="op" id="1347601">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1347604">//&nbsp;The&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;old-&gt;new&nbsp;map&nbsp;takes&nbsp;precedence</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1347662">//&nbsp;over&nbsp;the&nbsp;others&nbsp;with&nbsp;the&nbsp;same&nbsp;old&nbsp;string.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1347708">for</span>&nbsp;<span class="ident" id="1347712">i</span>&nbsp;<span class="op" id="1347714">:=</span>&nbsp;<span class="builtinfunc" id="1347717">len</span><span class="op" id="1347720">(</span><span class="ident" id="1347721">oldnew</span><span class="op" id="1347727">)</span>&nbsp;<span class="op" id="1347729">-</span>&nbsp;<span class="num" id="1347731">2</span><span class="op" id="1347732">;</span>&nbsp;<span class="ident" id="1347734">i</span>&nbsp;<span class="op" id="1347736">&gt;=</span>&nbsp;<span class="num" id="1347739">0</span><span class="op" id="1347740">;</span>&nbsp;<span class="ident" id="1347742">i</span>&nbsp;<span class="op" id="1347744">-=</span>&nbsp;<span class="num" id="1347747">2</span>&nbsp;<span class="op" id="1347749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1347753">o</span>&nbsp;<span class="op" id="1347755">:=</span>&nbsp;<span class="ident" id="1347758">oldnew</span><span class="op" id="1347764">[</span><span class="ident" id="1347765">i</span><span class="op" id="1347766">]</span><span class="op" id="1347767">[</span><span class="num" id="1347768">0</span><span class="op" id="1347769">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1347773">n</span>&nbsp;<span class="op" id="1347775">:=</span>&nbsp;<span class="ident" id="1347778">oldnew</span><span class="op" id="1347784">[</span><span class="ident" id="1347785">i</span><span class="op" id="1347786">+</span><span class="num" id="1347787">1</span><span class="op" id="1347788">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1347792">r</span><span class="op" id="1347793">[</span><span class="ident" id="1347794">o</span><span class="op" id="1347795">]</span>&nbsp;<span class="op" id="1347797">=</span>&nbsp;<span class="op" id="1347799">[</span><span class="op" id="1347800">]</span><span class="builtintype" id="1347801">byte</span><span class="op" id="1347805">(</span><span class="ident" id="1347806">n</span><span class="op" id="1347807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1347810">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1347813">return</span>&nbsp;<span class="op" id="1347820">&amp;</span><span class="ident" id="1347821">Replacer</span><span class="op" id="1347829">{</span><span class="ident" id="1347830">r</span><span class="op" id="1347831">:</span>&nbsp;<span class="op" id="1347833">&amp;</span><span class="ident" id="1347834">r</span><span class="op" id="1347835">}</span><br>
<span class="lineno"></span><span class="op" id="1347837">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1347840">//&nbsp;Replace&nbsp;returns&nbsp;a&nbsp;copy&nbsp;of&nbsp;s&nbsp;with&nbsp;all&nbsp;replacements&nbsp;performed.</span><br>
<span class="lineno"></span><span class="keyword" id="1347904">func</span>&nbsp;<span class="op" id="1347909">(</span><span class="ident" id="1347910">r</span>&nbsp;<span class="op" id="1347912">*</span><span class="ident" id="1347913">Replacer</span><span class="op" id="1347921">)</span>&nbsp;<span class="ident" id="1347923">Replace</span><span class="op" id="1347930">(</span><span class="ident" id="1347931">s</span>&nbsp;<span class="builtintype" id="1347933">string</span><span class="op" id="1347939">)</span>&nbsp;<span class="builtintype" id="1347941">string</span>&nbsp;<span class="op" id="1347948">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1347951">return</span>&nbsp;<span class="ident" id="1347958">r</span><span class="op" id="1347959">.</span><span class="ident" id="1347960">r</span><span class="op" id="1347961">.</span><span class="ident" id="1347962">Replace</span><span class="op" id="1347969">(</span><span class="ident" id="1347970">s</span><span class="op" id="1347971">)</span><br>
<span class="lineno"></span><span class="op" id="1347973">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1347976">//&nbsp;WriteString&nbsp;writes&nbsp;s&nbsp;to&nbsp;w&nbsp;with&nbsp;all&nbsp;replacements&nbsp;performed.</span><br>
<span class="lineno"></span><span class="keyword" id="1348038">func</span>&nbsp;<span class="op" id="1348043">(</span><span class="ident" id="1348044">r</span>&nbsp;<span class="op" id="1348046">*</span><span class="ident" id="1348047">Replacer</span><span class="op" id="1348055">)</span>&nbsp;<span class="ident" id="1348057">WriteString</span><span class="op" id="1348068">(</span><span class="ident" id="1348069">w</span>&nbsp;<span class="ident" id="1348071">io</span><span class="op" id="1348073">.</span><span class="ident" id="1348074">Writer</span><span class="op" id="1348080">,</span>&nbsp;<span class="ident" id="1348082">s</span>&nbsp;<span class="builtintype" id="1348084">string</span><span class="op" id="1348090">)</span>&nbsp;<span class="op" id="1348092">(</span><span class="ident" id="1348093">n</span>&nbsp;<span class="builtintype" id="1348095">int</span><span class="op" id="1348098">,</span>&nbsp;<span class="ident" id="1348100">err</span>&nbsp;<span class="builtintype" id="1348104">error</span><span class="op" id="1348109">)</span>&nbsp;<span class="op" id="1348111">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1348114">return</span>&nbsp;<span class="ident" id="1348121">r</span><span class="op" id="1348122">.</span><span class="ident" id="1348123">r</span><span class="op" id="1348124">.</span><span class="ident" id="1348125">WriteString</span><span class="op" id="1348136">(</span><span class="ident" id="1348137">w</span><span class="op" id="1348138">,</span>&nbsp;<span class="ident" id="1348140">s</span><span class="op" id="1348141">)</span><br>
<span class="lineno"></span><span class="op" id="1348143">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1348146">//&nbsp;trieNode&nbsp;is&nbsp;a&nbsp;node&nbsp;in&nbsp;a&nbsp;lookup&nbsp;trie&nbsp;for&nbsp;prioritized&nbsp;key/value&nbsp;pairs.&nbsp;Keys</span><br>
<span class="lineno"></span><span class="comment" id="1348223">//&nbsp;and&nbsp;values&nbsp;may&nbsp;be&nbsp;empty.&nbsp;For&nbsp;example,&nbsp;the&nbsp;trie&nbsp;containing&nbsp;keys&nbsp;&#34;ax&#34;,&nbsp;&#34;ay&#34;,</span><br>
<span class="lineno">80</span><span class="comment" id="1348301">//&nbsp;&#34;bcbc&#34;,&nbsp;&#34;x&#34;&nbsp;and&nbsp;&#34;xy&#34;&nbsp;could&nbsp;have&nbsp;eight&nbsp;nodes:</span><br>
<span class="lineno"></span><span class="comment" id="1348349">//</span><br>
<span class="lineno"></span><span class="comment" id="1348352">//&nbsp;&nbsp;n0&nbsp;&nbsp;-</span><br>
<span class="lineno"></span><span class="comment" id="1348362">//&nbsp;&nbsp;n1&nbsp;&nbsp;a-</span><br>
<span class="lineno"></span><span class="comment" id="1348373">//&nbsp;&nbsp;n2&nbsp;&nbsp;.x+</span><br>
<span class="lineno">85</span><span class="comment" id="1348385">//&nbsp;&nbsp;n3&nbsp;&nbsp;.y+</span><br>
<span class="lineno"></span><span class="comment" id="1348397">//&nbsp;&nbsp;n4&nbsp;&nbsp;b-</span><br>
<span class="lineno"></span><span class="comment" id="1348408">//&nbsp;&nbsp;n5&nbsp;&nbsp;.cbc+</span><br>
<span class="lineno"></span><span class="comment" id="1348422">//&nbsp;&nbsp;n6&nbsp;&nbsp;x+</span><br>
<span class="lineno"></span><span class="comment" id="1348433">//&nbsp;&nbsp;n7&nbsp;&nbsp;.y+</span><br>
<span class="lineno">90</span><span class="comment" id="1348445">//</span><br>
<span class="lineno"></span><span class="comment" id="1348448">//&nbsp;n0&nbsp;is&nbsp;the&nbsp;root&nbsp;node,&nbsp;and&nbsp;its&nbsp;children&nbsp;are&nbsp;n1,&nbsp;n4&nbsp;and&nbsp;n6;&nbsp;n1&#39;s&nbsp;children&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="1348526">//&nbsp;n2&nbsp;and&nbsp;n3;&nbsp;n4&#39;s&nbsp;child&nbsp;is&nbsp;n5;&nbsp;n6&#39;s&nbsp;child&nbsp;is&nbsp;n7.&nbsp;Nodes&nbsp;n0,&nbsp;n1&nbsp;and&nbsp;n4&nbsp;(marked</span><br>
<span class="lineno"></span><span class="comment" id="1348604">//&nbsp;with&nbsp;a&nbsp;trailing&nbsp;&#34;-&#34;)&nbsp;are&nbsp;partial&nbsp;keys,&nbsp;and&nbsp;nodes&nbsp;n2,&nbsp;n3,&nbsp;n5,&nbsp;n6&nbsp;and&nbsp;n7</span><br>
<span class="lineno"></span><span class="comment" id="1348678">//&nbsp;(marked&nbsp;with&nbsp;a&nbsp;trailing&nbsp;&#34;+&#34;)&nbsp;are&nbsp;complete&nbsp;keys.</span><br>
<span class="lineno">95</span><span class="keyword" id="1348729">type</span>&nbsp;<span class="ident" id="1348734">trieNode</span>&nbsp;<span class="keyword" id="1348743">struct</span>&nbsp;<span class="op" id="1348750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1348753">//&nbsp;value&nbsp;is&nbsp;the&nbsp;value&nbsp;of&nbsp;the&nbsp;trie&nbsp;node&#39;s&nbsp;key/value&nbsp;pair.&nbsp;It&nbsp;is&nbsp;empty&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1348826">//&nbsp;this&nbsp;node&nbsp;is&nbsp;not&nbsp;a&nbsp;complete&nbsp;key.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1348863">value</span>&nbsp;<span class="builtintype" id="1348869">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1348877">//&nbsp;priority&nbsp;is&nbsp;the&nbsp;priority&nbsp;(higher&nbsp;is&nbsp;more&nbsp;important)&nbsp;of&nbsp;the&nbsp;trie&nbsp;node&#39;s</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1348952">//&nbsp;key/value&nbsp;pair;&nbsp;keys&nbsp;are&nbsp;not&nbsp;necessarily&nbsp;matched&nbsp;shortest-&nbsp;or&nbsp;longest-</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1349027">//&nbsp;first.&nbsp;Priority&nbsp;is&nbsp;positive&nbsp;if&nbsp;this&nbsp;node&nbsp;is&nbsp;a&nbsp;complete&nbsp;key,&nbsp;and&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1349100">//&nbsp;otherwise.&nbsp;In&nbsp;the&nbsp;example&nbsp;above,&nbsp;positive/zero&nbsp;priorities&nbsp;are&nbsp;marked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1349173">//&nbsp;with&nbsp;a&nbsp;trailing&nbsp;&#34;+&#34;&nbsp;or&nbsp;&#34;-&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1349205">priority</span>&nbsp;<span class="builtintype" id="1349214">int</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1349220">//&nbsp;A&nbsp;trie&nbsp;node&nbsp;may&nbsp;have&nbsp;zero,&nbsp;one&nbsp;or&nbsp;more&nbsp;child&nbsp;nodes:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1349276">//&nbsp;&nbsp;*&nbsp;if&nbsp;the&nbsp;remaining&nbsp;fields&nbsp;are&nbsp;zero,&nbsp;there&nbsp;are&nbsp;no&nbsp;children.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1349340">//&nbsp;&nbsp;*&nbsp;if&nbsp;prefix&nbsp;and&nbsp;next&nbsp;are&nbsp;non-zero,&nbsp;there&nbsp;is&nbsp;one&nbsp;child&nbsp;in&nbsp;next.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1349408">//&nbsp;&nbsp;*&nbsp;if&nbsp;table&nbsp;is&nbsp;non-zero,&nbsp;it&nbsp;defines&nbsp;all&nbsp;the&nbsp;children.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1349466">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1349470">//&nbsp;Prefixes&nbsp;are&nbsp;preferred&nbsp;over&nbsp;tables&nbsp;when&nbsp;there&nbsp;is&nbsp;one&nbsp;child,&nbsp;but&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1349542">//&nbsp;root&nbsp;node&nbsp;always&nbsp;uses&nbsp;a&nbsp;table&nbsp;for&nbsp;lookup&nbsp;efficiency.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1349600">//&nbsp;prefix&nbsp;is&nbsp;the&nbsp;difference&nbsp;in&nbsp;keys&nbsp;between&nbsp;this&nbsp;trie&nbsp;node&nbsp;and&nbsp;the&nbsp;next.</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1349674">//&nbsp;In&nbsp;the&nbsp;example&nbsp;above,&nbsp;node&nbsp;n4&nbsp;has&nbsp;prefix&nbsp;&#34;cbc&#34;&nbsp;and&nbsp;n4&#39;s&nbsp;next&nbsp;node&nbsp;is&nbsp;n5.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1349751">//&nbsp;Node&nbsp;n5&nbsp;has&nbsp;no&nbsp;children&nbsp;and&nbsp;so&nbsp;has&nbsp;zero&nbsp;prefix,&nbsp;next&nbsp;and&nbsp;table&nbsp;fields.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1349826">prefix</span>&nbsp;<span class="builtintype" id="1349833">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1349841">next</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1349848">*</span><span class="ident" id="1349849">trieNode</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1349860">//&nbsp;table&nbsp;is&nbsp;a&nbsp;lookup&nbsp;table&nbsp;indexed&nbsp;by&nbsp;the&nbsp;next&nbsp;byte&nbsp;in&nbsp;the&nbsp;key,&nbsp;after</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1349931">//&nbsp;remapping&nbsp;that&nbsp;byte&nbsp;through&nbsp;genericReplacer.mapping&nbsp;to&nbsp;create&nbsp;a&nbsp;dense</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1350005">//&nbsp;index.&nbsp;In&nbsp;the&nbsp;example&nbsp;above,&nbsp;the&nbsp;keys&nbsp;only&nbsp;use&nbsp;&#39;a&#39;,&nbsp;&#39;b&#39;,&nbsp;&#39;c&#39;,&nbsp;&#39;x&#39;&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1350079">//&nbsp;&#39;y&#39;,&nbsp;which&nbsp;remap&nbsp;to&nbsp;0,&nbsp;1,&nbsp;2,&nbsp;3&nbsp;and&nbsp;4.&nbsp;All&nbsp;other&nbsp;bytes&nbsp;remap&nbsp;to&nbsp;5,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1350153">//&nbsp;genericReplacer.tableSize&nbsp;will&nbsp;be&nbsp;5.&nbsp;Node&nbsp;n0&#39;s&nbsp;table&nbsp;will&nbsp;be</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1350218">//&nbsp;[]*trieNode{&nbsp;0:n1,&nbsp;1:n4,&nbsp;3:n6&nbsp;},&nbsp;where&nbsp;the&nbsp;0,&nbsp;1&nbsp;and&nbsp;3&nbsp;are&nbsp;the&nbsp;remapped</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1350293">//&nbsp;&#39;a&#39;,&nbsp;&#39;b&#39;&nbsp;and&nbsp;&#39;x&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1350315">table</span>&nbsp;<span class="op" id="1350321">[</span><span class="op" id="1350322">]</span><span class="op" id="1350323">*</span><span class="ident" id="1350324">trieNode</span><br>
<span class="lineno"></span><span class="op" id="1350333">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="1350336">func</span>&nbsp;<span class="op" id="1350341">(</span><span class="ident" id="1350342">t</span>&nbsp;<span class="op" id="1350344">*</span><span class="ident" id="1350345">trieNode</span><span class="op" id="1350353">)</span>&nbsp;<span class="ident" id="1350355">add</span><span class="op" id="1350358">(</span><span class="ident" id="1350359">key</span><span class="op" id="1350362">,</span>&nbsp;<span class="ident" id="1350364">val</span>&nbsp;<span class="builtintype" id="1350368">string</span><span class="op" id="1350374">,</span>&nbsp;<span class="ident" id="1350376">priority</span>&nbsp;<span class="builtintype" id="1350385">int</span><span class="op" id="1350388">,</span>&nbsp;<span class="ident" id="1350390">r</span>&nbsp;<span class="op" id="1350392">*</span><span class="ident" id="1350393">genericReplacer</span><span class="op" id="1350408">)</span>&nbsp;<span class="op" id="1350410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1350413">if</span>&nbsp;<span class="ident" id="1350416">key</span>&nbsp;<span class="op" id="1350420">==</span>&nbsp;<span class="string" id="1350423">&#34;&#34;</span>&nbsp;<span class="op" id="1350426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1350430">if</span>&nbsp;<span class="ident" id="1350433">t</span><span class="op" id="1350434">.</span><span class="ident" id="1350435">priority</span>&nbsp;<span class="op" id="1350444">==</span>&nbsp;<span class="num" id="1350447">0</span>&nbsp;<span class="op" id="1350449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1350454">t</span><span class="op" id="1350455">.</span><span class="ident" id="1350456">value</span>&nbsp;<span class="op" id="1350462">=</span>&nbsp;<span class="ident" id="1350464">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1350471">t</span><span class="op" id="1350472">.</span><span class="ident" id="1350473">priority</span>&nbsp;<span class="op" id="1350482">=</span>&nbsp;<span class="ident" id="1350484">priority</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1350495">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1350499">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1350507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1350511">if</span>&nbsp;<span class="ident" id="1350514">t</span><span class="op" id="1350515">.</span><span class="ident" id="1350516">prefix</span>&nbsp;<span class="op" id="1350523">!=</span>&nbsp;<span class="string" id="1350526">&#34;&#34;</span>&nbsp;<span class="op" id="1350529">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1350533">//&nbsp;Need&nbsp;to&nbsp;split&nbsp;the&nbsp;prefix&nbsp;among&nbsp;multiple&nbsp;nodes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1350585">var</span>&nbsp;<span class="ident" id="1350589">n</span>&nbsp;<span class="builtintype" id="1350591">int</span>&nbsp;<span class="comment" id="1350595">//&nbsp;length&nbsp;of&nbsp;the&nbsp;longest&nbsp;common&nbsp;prefix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1350636">for</span>&nbsp;<span class="op" id="1350640">;</span>&nbsp;<span class="ident" id="1350642">n</span>&nbsp;<span class="op" id="1350644">&lt;</span>&nbsp;<span class="builtinfunc" id="1350646">len</span><span class="op" id="1350649">(</span><span class="ident" id="1350650">t</span><span class="op" id="1350651">.</span><span class="ident" id="1350652">prefix</span><span class="op" id="1350658">)</span>&nbsp;<span class="op" id="1350660">&amp;&amp;</span>&nbsp;<span class="ident" id="1350663">n</span>&nbsp;<span class="op" id="1350665">&lt;</span>&nbsp;<span class="builtinfunc" id="1350667">len</span><span class="op" id="1350670">(</span><span class="ident" id="1350671">key</span><span class="op" id="1350674">)</span><span class="op" id="1350675">;</span>&nbsp;<span class="ident" id="1350677">n</span><span class="op" id="1350678">++</span>&nbsp;<span class="op" id="1350681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1350686">if</span>&nbsp;<span class="ident" id="1350689">t</span><span class="op" id="1350690">.</span><span class="ident" id="1350691">prefix</span><span class="op" id="1350697">[</span><span class="ident" id="1350698">n</span><span class="op" id="1350699">]</span>&nbsp;<span class="op" id="1350701">!=</span>&nbsp;<span class="ident" id="1350704">key</span><span class="op" id="1350707">[</span><span class="ident" id="1350708">n</span><span class="op" id="1350709">]</span>&nbsp;<span class="op" id="1350711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1350717">break</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1350726">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1350730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1350734">if</span>&nbsp;<span class="ident" id="1350737">n</span>&nbsp;<span class="op" id="1350739">==</span>&nbsp;<span class="builtinfunc" id="1350742">len</span><span class="op" id="1350745">(</span><span class="ident" id="1350746">t</span><span class="op" id="1350747">.</span><span class="ident" id="1350748">prefix</span><span class="op" id="1350754">)</span>&nbsp;<span class="op" id="1350756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1350761">t</span><span class="op" id="1350762">.</span><span class="ident" id="1350763">next</span><span class="op" id="1350767">.</span><span class="ident" id="1350768">add</span><span class="op" id="1350771">(</span><span class="ident" id="1350772">key</span><span class="op" id="1350775">[</span><span class="ident" id="1350776">n</span><span class="op" id="1350777">:</span><span class="op" id="1350778">]</span><span class="op" id="1350779">,</span>&nbsp;<span class="ident" id="1350781">val</span><span class="op" id="1350784">,</span>&nbsp;<span class="ident" id="1350786">priority</span><span class="op" id="1350794">,</span>&nbsp;<span class="ident" id="1350796">r</span><span class="op" id="1350797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1350801">}</span>&nbsp;<span class="keyword" id="1350803">else</span>&nbsp;<span class="keyword" id="1350808">if</span>&nbsp;<span class="ident" id="1350811">n</span>&nbsp;<span class="op" id="1350813">==</span>&nbsp;<span class="num" id="1350816">0</span>&nbsp;<span class="op" id="1350818">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1350823">//&nbsp;First&nbsp;byte&nbsp;differs,&nbsp;start&nbsp;a&nbsp;new&nbsp;lookup&nbsp;table&nbsp;here.&nbsp;Looking&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1350891">//&nbsp;what&nbsp;is&nbsp;currently&nbsp;t.prefix[0]&nbsp;will&nbsp;lead&nbsp;to&nbsp;prefixNode,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1350956">//&nbsp;looking&nbsp;up&nbsp;key[0]&nbsp;will&nbsp;lead&nbsp;to&nbsp;keyNode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1351002">var</span>&nbsp;<span class="ident" id="1351006">prefixNode</span>&nbsp;<span class="op" id="1351017">*</span><span class="ident" id="1351018">trieNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1351030">if</span>&nbsp;<span class="builtinfunc" id="1351033">len</span><span class="op" id="1351036">(</span><span class="ident" id="1351037">t</span><span class="op" id="1351038">.</span><span class="ident" id="1351039">prefix</span><span class="op" id="1351045">)</span>&nbsp;<span class="op" id="1351047">==</span>&nbsp;<span class="num" id="1351050">1</span>&nbsp;<span class="op" id="1351052">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1351058">prefixNode</span>&nbsp;<span class="op" id="1351069">=</span>&nbsp;<span class="ident" id="1351071">t</span><span class="op" id="1351072">.</span><span class="ident" id="1351073">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1351081">}</span>&nbsp;<span class="keyword" id="1351083">else</span>&nbsp;<span class="op" id="1351088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1351094">prefixNode</span>&nbsp;<span class="op" id="1351105">=</span>&nbsp;<span class="op" id="1351107">&amp;</span><span class="ident" id="1351108">trieNode</span><span class="op" id="1351116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1351123">prefix</span><span class="op" id="1351129">:</span>&nbsp;<span class="ident" id="1351131">t</span><span class="op" id="1351132">.</span><span class="ident" id="1351133">prefix</span><span class="op" id="1351139">[</span><span class="num" id="1351140">1</span><span class="op" id="1351141">:</span><span class="op" id="1351142">]</span><span class="op" id="1351143">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1351150">next</span><span class="op" id="1351154">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="1351158">t</span><span class="op" id="1351159">.</span><span class="ident" id="1351160">next</span><span class="op" id="1351164">,</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1351170">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1351175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1351180">keyNode</span>&nbsp;<span class="op" id="1351188">:=</span>&nbsp;<span class="builtinfunc" id="1351191">new</span><span class="op" id="1351194">(</span><span class="ident" id="1351195">trieNode</span><span class="op" id="1351203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1351208">t</span><span class="op" id="1351209">.</span><span class="ident" id="1351210">table</span>&nbsp;<span class="op" id="1351216">=</span>&nbsp;<span class="builtinfunc" id="1351218">make</span><span class="op" id="1351222">(</span><span class="op" id="1351223">[</span><span class="op" id="1351224">]</span><span class="op" id="1351225">*</span><span class="ident" id="1351226">trieNode</span><span class="op" id="1351234">,</span>&nbsp;<span class="ident" id="1351236">r</span><span class="op" id="1351237">.</span><span class="ident" id="1351238">tableSize</span><span class="op" id="1351247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1351252">t</span><span class="op" id="1351253">.</span><span class="ident" id="1351254">table</span><span class="op" id="1351259">[</span><span class="ident" id="1351260">r</span><span class="op" id="1351261">.</span><span class="ident" id="1351262">mapping</span><span class="op" id="1351269">[</span><span class="ident" id="1351270">t</span><span class="op" id="1351271">.</span><span class="ident" id="1351272">prefix</span><span class="op" id="1351278">[</span><span class="num" id="1351279">0</span><span class="op" id="1351280">]</span><span class="op" id="1351281">]</span><span class="op" id="1351282">]</span>&nbsp;<span class="op" id="1351284">=</span>&nbsp;<span class="ident" id="1351286">prefixNode</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1351300">t</span><span class="op" id="1351301">.</span><span class="ident" id="1351302">table</span><span class="op" id="1351307">[</span><span class="ident" id="1351308">r</span><span class="op" id="1351309">.</span><span class="ident" id="1351310">mapping</span><span class="op" id="1351317">[</span><span class="ident" id="1351318">key</span><span class="op" id="1351321">[</span><span class="num" id="1351322">0</span><span class="op" id="1351323">]</span><span class="op" id="1351324">]</span><span class="op" id="1351325">]</span>&nbsp;<span class="op" id="1351327">=</span>&nbsp;<span class="ident" id="1351329">keyNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1351340">t</span><span class="op" id="1351341">.</span><span class="ident" id="1351342">prefix</span>&nbsp;<span class="op" id="1351349">=</span>&nbsp;<span class="string" id="1351351">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1351357">t</span><span class="op" id="1351358">.</span><span class="ident" id="1351359">next</span>&nbsp;<span class="op" id="1351364">=</span>&nbsp;<span class="builtintype" id="1351366">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1351373">keyNode</span><span class="op" id="1351380">.</span><span class="ident" id="1351381">add</span><span class="op" id="1351384">(</span><span class="ident" id="1351385">key</span><span class="op" id="1351388">[</span><span class="num" id="1351389">1</span><span class="op" id="1351390">:</span><span class="op" id="1351391">]</span><span class="op" id="1351392">,</span>&nbsp;<span class="ident" id="1351394">val</span><span class="op" id="1351397">,</span>&nbsp;<span class="ident" id="1351399">priority</span><span class="op" id="1351407">,</span>&nbsp;<span class="ident" id="1351409">r</span><span class="op" id="1351410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1351414">}</span>&nbsp;<span class="keyword" id="1351416">else</span>&nbsp;<span class="op" id="1351421">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1351426">//&nbsp;Insert&nbsp;new&nbsp;node&nbsp;after&nbsp;the&nbsp;common&nbsp;section&nbsp;of&nbsp;the&nbsp;prefix.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1351488">next</span>&nbsp;<span class="op" id="1351493">:=</span>&nbsp;<span class="op" id="1351496">&amp;</span><span class="ident" id="1351497">trieNode</span><span class="op" id="1351505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1351511">prefix</span><span class="op" id="1351517">:</span>&nbsp;<span class="ident" id="1351519">t</span><span class="op" id="1351520">.</span><span class="ident" id="1351521">prefix</span><span class="op" id="1351527">[</span><span class="ident" id="1351528">n</span><span class="op" id="1351529">:</span><span class="op" id="1351530">]</span><span class="op" id="1351531">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1351537">next</span><span class="op" id="1351541">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="1351545">t</span><span class="op" id="1351546">.</span><span class="ident" id="1351547">next</span><span class="op" id="1351551">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1351556">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1351561">t</span><span class="op" id="1351562">.</span><span class="ident" id="1351563">prefix</span>&nbsp;<span class="op" id="1351570">=</span>&nbsp;<span class="ident" id="1351572">t</span><span class="op" id="1351573">.</span><span class="ident" id="1351574">prefix</span><span class="op" id="1351580">[</span><span class="op" id="1351581">:</span><span class="ident" id="1351582">n</span><span class="op" id="1351583">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1351588">t</span><span class="op" id="1351589">.</span><span class="ident" id="1351590">next</span>&nbsp;<span class="op" id="1351595">=</span>&nbsp;<span class="ident" id="1351597">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1351605">next</span><span class="op" id="1351609">.</span><span class="ident" id="1351610">add</span><span class="op" id="1351613">(</span><span class="ident" id="1351614">key</span><span class="op" id="1351617">[</span><span class="ident" id="1351618">n</span><span class="op" id="1351619">:</span><span class="op" id="1351620">]</span><span class="op" id="1351621">,</span>&nbsp;<span class="ident" id="1351623">val</span><span class="op" id="1351626">,</span>&nbsp;<span class="ident" id="1351628">priority</span><span class="op" id="1351636">,</span>&nbsp;<span class="ident" id="1351638">r</span><span class="op" id="1351639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1351643">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1351646">}</span>&nbsp;<span class="keyword" id="1351648">else</span>&nbsp;<span class="keyword" id="1351653">if</span>&nbsp;<span class="ident" id="1351656">t</span><span class="op" id="1351657">.</span><span class="ident" id="1351658">table</span>&nbsp;<span class="op" id="1351664">!=</span>&nbsp;<span class="builtintype" id="1351667">nil</span>&nbsp;<span class="op" id="1351671">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1351675">//&nbsp;Insert&nbsp;into&nbsp;existing&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1351708">m</span>&nbsp;<span class="op" id="1351710">:=</span>&nbsp;<span class="ident" id="1351713">r</span><span class="op" id="1351714">.</span><span class="ident" id="1351715">mapping</span><span class="op" id="1351722">[</span><span class="ident" id="1351723">key</span><span class="op" id="1351726">[</span><span class="num" id="1351727">0</span><span class="op" id="1351728">]</span><span class="op" id="1351729">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1351733">if</span>&nbsp;<span class="ident" id="1351736">t</span><span class="op" id="1351737">.</span><span class="ident" id="1351738">table</span><span class="op" id="1351743">[</span><span class="ident" id="1351744">m</span><span class="op" id="1351745">]</span>&nbsp;<span class="op" id="1351747">==</span>&nbsp;<span class="builtintype" id="1351750">nil</span>&nbsp;<span class="op" id="1351754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1351759">t</span><span class="op" id="1351760">.</span><span class="ident" id="1351761">table</span><span class="op" id="1351766">[</span><span class="ident" id="1351767">m</span><span class="op" id="1351768">]</span>&nbsp;<span class="op" id="1351770">=</span>&nbsp;<span class="builtinfunc" id="1351772">new</span><span class="op" id="1351775">(</span><span class="ident" id="1351776">trieNode</span><span class="op" id="1351784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1351788">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1351792">t</span><span class="op" id="1351793">.</span><span class="ident" id="1351794">table</span><span class="op" id="1351799">[</span><span class="ident" id="1351800">m</span><span class="op" id="1351801">]</span><span class="op" id="1351802">.</span><span class="ident" id="1351803">add</span><span class="op" id="1351806">(</span><span class="ident" id="1351807">key</span><span class="op" id="1351810">[</span><span class="num" id="1351811">1</span><span class="op" id="1351812">:</span><span class="op" id="1351813">]</span><span class="op" id="1351814">,</span>&nbsp;<span class="ident" id="1351816">val</span><span class="op" id="1351819">,</span>&nbsp;<span class="ident" id="1351821">priority</span><span class="op" id="1351829">,</span>&nbsp;<span class="ident" id="1351831">r</span><span class="op" id="1351832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1351835">}</span>&nbsp;<span class="keyword" id="1351837">else</span>&nbsp;<span class="op" id="1351842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1351846">t</span><span class="op" id="1351847">.</span><span class="ident" id="1351848">prefix</span>&nbsp;<span class="op" id="1351855">=</span>&nbsp;<span class="ident" id="1351857">key</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1351863">t</span><span class="op" id="1351864">.</span><span class="ident" id="1351865">next</span>&nbsp;<span class="op" id="1351870">=</span>&nbsp;<span class="builtinfunc" id="1351872">new</span><span class="op" id="1351875">(</span><span class="ident" id="1351876">trieNode</span><span class="op" id="1351884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1351888">t</span><span class="op" id="1351889">.</span><span class="ident" id="1351890">next</span><span class="op" id="1351894">.</span><span class="ident" id="1351895">add</span><span class="op" id="1351898">(</span><span class="string" id="1351899">&#34;&#34;</span><span class="op" id="1351901">,</span>&nbsp;<span class="ident" id="1351903">val</span><span class="op" id="1351906">,</span>&nbsp;<span class="ident" id="1351908">priority</span><span class="op" id="1351916">,</span>&nbsp;<span class="ident" id="1351918">r</span><span class="op" id="1351919">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1351922">}</span><br>
<span class="lineno"></span><span class="op" id="1351924">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1351927">func</span>&nbsp;<span class="op" id="1351932">(</span><span class="ident" id="1351933">r</span>&nbsp;<span class="op" id="1351935">*</span><span class="ident" id="1351936">genericReplacer</span><span class="op" id="1351951">)</span>&nbsp;<span class="ident" id="1351953">lookup</span><span class="op" id="1351959">(</span><span class="ident" id="1351960">s</span>&nbsp;<span class="builtintype" id="1351962">string</span><span class="op" id="1351968">,</span>&nbsp;<span class="ident" id="1351970">ignoreRoot</span>&nbsp;<span class="builtintype" id="1351981">bool</span><span class="op" id="1351985">)</span>&nbsp;<span class="op" id="1351987">(</span><span class="ident" id="1351988">val</span>&nbsp;<span class="builtintype" id="1351992">string</span><span class="op" id="1351998">,</span>&nbsp;<span class="ident" id="1352000">keylen</span>&nbsp;<span class="builtintype" id="1352007">int</span><span class="op" id="1352010">,</span>&nbsp;<span class="ident" id="1352012">found</span>&nbsp;<span class="builtintype" id="1352018">bool</span><span class="op" id="1352022">)</span>&nbsp;<span class="op" id="1352024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1352027">//&nbsp;Iterate&nbsp;down&nbsp;the&nbsp;trie&nbsp;to&nbsp;the&nbsp;end,&nbsp;and&nbsp;grab&nbsp;the&nbsp;value&nbsp;and&nbsp;keylen&nbsp;with</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1352100">//&nbsp;the&nbsp;highest&nbsp;priority.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1352126">bestPriority</span>&nbsp;<span class="op" id="1352139">:=</span>&nbsp;<span class="num" id="1352142">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1352145">node</span>&nbsp;<span class="op" id="1352150">:=</span>&nbsp;<span class="op" id="1352153">&amp;</span><span class="ident" id="1352154">r</span><span class="op" id="1352155">.</span><span class="ident" id="1352156">root</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1352162">n</span>&nbsp;<span class="op" id="1352164">:=</span>&nbsp;<span class="num" id="1352167">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1352170">for</span>&nbsp;<span class="ident" id="1352174">node</span>&nbsp;<span class="op" id="1352179">!=</span>&nbsp;<span class="builtintype" id="1352182">nil</span>&nbsp;<span class="op" id="1352186">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1352190">if</span>&nbsp;<span class="ident" id="1352193">node</span><span class="op" id="1352197">.</span><span class="ident" id="1352198">priority</span>&nbsp;<span class="op" id="1352207">&gt;</span>&nbsp;<span class="ident" id="1352209">bestPriority</span>&nbsp;<span class="op" id="1352222">&amp;&amp;</span>&nbsp;<span class="op" id="1352225">!</span><span class="op" id="1352226">(</span><span class="ident" id="1352227">ignoreRoot</span>&nbsp;<span class="op" id="1352238">&amp;&amp;</span>&nbsp;<span class="ident" id="1352241">node</span>&nbsp;<span class="op" id="1352246">==</span>&nbsp;<span class="op" id="1352249">&amp;</span><span class="ident" id="1352250">r</span><span class="op" id="1352251">.</span><span class="ident" id="1352252">root</span><span class="op" id="1352256">)</span>&nbsp;<span class="op" id="1352258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1352263">bestPriority</span>&nbsp;<span class="op" id="1352276">=</span>&nbsp;<span class="ident" id="1352278">node</span><span class="op" id="1352282">.</span><span class="ident" id="1352283">priority</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1352295">val</span>&nbsp;<span class="op" id="1352299">=</span>&nbsp;<span class="ident" id="1352301">node</span><span class="op" id="1352305">.</span><span class="ident" id="1352306">value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1352315">keylen</span>&nbsp;<span class="op" id="1352322">=</span>&nbsp;<span class="ident" id="1352324">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1352329">found</span>&nbsp;<span class="op" id="1352335">=</span>&nbsp;<span class="builtintype" id="1352337">true</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1352344">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1352349">if</span>&nbsp;<span class="ident" id="1352352">s</span>&nbsp;<span class="op" id="1352354">==</span>&nbsp;<span class="string" id="1352357">&#34;&#34;</span>&nbsp;<span class="op" id="1352360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1352365">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1352373">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1352377">if</span>&nbsp;<span class="ident" id="1352380">node</span><span class="op" id="1352384">.</span><span class="ident" id="1352385">table</span>&nbsp;<span class="op" id="1352391">!=</span>&nbsp;<span class="builtintype" id="1352394">nil</span>&nbsp;<span class="op" id="1352398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1352403">index</span>&nbsp;<span class="op" id="1352409">:=</span>&nbsp;<span class="ident" id="1352412">r</span><span class="op" id="1352413">.</span><span class="ident" id="1352414">mapping</span><span class="op" id="1352421">[</span><span class="ident" id="1352422">s</span><span class="op" id="1352423">[</span><span class="num" id="1352424">0</span><span class="op" id="1352425">]</span><span class="op" id="1352426">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1352431">if</span>&nbsp;<span class="builtintype" id="1352434">int</span><span class="op" id="1352437">(</span><span class="ident" id="1352438">index</span><span class="op" id="1352443">)</span>&nbsp;<span class="op" id="1352445">==</span>&nbsp;<span class="ident" id="1352448">r</span><span class="op" id="1352449">.</span><span class="ident" id="1352450">tableSize</span>&nbsp;<span class="op" id="1352460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1352466">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1352475">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1352480">node</span>&nbsp;<span class="op" id="1352485">=</span>&nbsp;<span class="ident" id="1352487">node</span><span class="op" id="1352491">.</span><span class="ident" id="1352492">table</span><span class="op" id="1352497">[</span><span class="ident" id="1352498">index</span><span class="op" id="1352503">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1352508">s</span>&nbsp;<span class="op" id="1352510">=</span>&nbsp;<span class="ident" id="1352512">s</span><span class="op" id="1352513">[</span><span class="num" id="1352514">1</span><span class="op" id="1352515">:</span><span class="op" id="1352516">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1352521">n</span><span class="op" id="1352522">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1352527">}</span>&nbsp;<span class="keyword" id="1352529">else</span>&nbsp;<span class="keyword" id="1352534">if</span>&nbsp;<span class="ident" id="1352537">node</span><span class="op" id="1352541">.</span><span class="ident" id="1352542">prefix</span>&nbsp;<span class="op" id="1352549">!=</span>&nbsp;<span class="string" id="1352552">&#34;&#34;</span>&nbsp;<span class="op" id="1352555">&amp;&amp;</span>&nbsp;<span class="ident" id="1352558">HasPrefix</span><span class="op" id="1352567">(</span><span class="ident" id="1352568">s</span><span class="op" id="1352569">,</span>&nbsp;<span class="ident" id="1352571">node</span><span class="op" id="1352575">.</span><span class="ident" id="1352576">prefix</span><span class="op" id="1352582">)</span>&nbsp;<span class="op" id="1352584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1352589">n</span>&nbsp;<span class="op" id="1352591">+=</span>&nbsp;<span class="builtinfunc" id="1352594">len</span><span class="op" id="1352597">(</span><span class="ident" id="1352598">node</span><span class="op" id="1352602">.</span><span class="ident" id="1352603">prefix</span><span class="op" id="1352609">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1352614">s</span>&nbsp;<span class="op" id="1352616">=</span>&nbsp;<span class="ident" id="1352618">s</span><span class="op" id="1352619">[</span><span class="builtinfunc" id="1352620">len</span><span class="op" id="1352623">(</span><span class="ident" id="1352624">node</span><span class="op" id="1352628">.</span><span class="ident" id="1352629">prefix</span><span class="op" id="1352635">)</span><span class="op" id="1352636">:</span><span class="op" id="1352637">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1352642">node</span>&nbsp;<span class="op" id="1352647">=</span>&nbsp;<span class="ident" id="1352649">node</span><span class="op" id="1352653">.</span><span class="ident" id="1352654">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1352661">}</span>&nbsp;<span class="keyword" id="1352663">else</span>&nbsp;<span class="op" id="1352668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1352673">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1352681">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1352684">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1352687">return</span><br>
<span class="lineno"></span><span class="op" id="1352694">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1352697">//&nbsp;genericReplacer&nbsp;is&nbsp;the&nbsp;fully&nbsp;generic&nbsp;algorithm.</span><br>
<span class="lineno">230</span><span class="comment" id="1352748">//&nbsp;It&#39;s&nbsp;used&nbsp;as&nbsp;a&nbsp;fallback&nbsp;when&nbsp;nothing&nbsp;faster&nbsp;can&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="1352808">type</span>&nbsp;<span class="ident" id="1352813">genericReplacer</span>&nbsp;<span class="keyword" id="1352829">struct</span>&nbsp;<span class="op" id="1352836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1352839">root</span>&nbsp;<span class="ident" id="1352844">trieNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1352854">//&nbsp;tableSize&nbsp;is&nbsp;the&nbsp;size&nbsp;of&nbsp;a&nbsp;trie&nbsp;node&#39;s&nbsp;lookup&nbsp;table.&nbsp;It&nbsp;is&nbsp;the&nbsp;number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1352928">//&nbsp;of&nbsp;unique&nbsp;key&nbsp;bytes.</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1352953">tableSize</span>&nbsp;<span class="builtintype" id="1352963">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1352968">//&nbsp;mapping&nbsp;maps&nbsp;from&nbsp;key&nbsp;bytes&nbsp;to&nbsp;a&nbsp;dense&nbsp;index&nbsp;for&nbsp;trieNode.table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1353037">mapping</span>&nbsp;<span class="op" id="1353045">[</span><span class="num" id="1353046">256</span><span class="op" id="1353049">]</span><span class="builtintype" id="1353050">byte</span><br>
<span class="lineno"></span><span class="op" id="1353055">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span><span class="keyword" id="1353058">func</span>&nbsp;<span class="ident" id="1353063">makeGenericReplacer</span><span class="op" id="1353082">(</span><span class="ident" id="1353083">oldnew</span>&nbsp;<span class="op" id="1353090">[</span><span class="op" id="1353091">]</span><span class="builtintype" id="1353092">string</span><span class="op" id="1353098">)</span>&nbsp;<span class="op" id="1353100">*</span><span class="ident" id="1353101">genericReplacer</span>&nbsp;<span class="op" id="1353117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1353120">r</span>&nbsp;<span class="op" id="1353122">:=</span>&nbsp;<span class="builtinfunc" id="1353125">new</span><span class="op" id="1353128">(</span><span class="ident" id="1353129">genericReplacer</span><span class="op" id="1353144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1353147">//&nbsp;Find&nbsp;each&nbsp;byte&nbsp;used,&nbsp;then&nbsp;assign&nbsp;them&nbsp;each&nbsp;an&nbsp;index.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1353204">for</span>&nbsp;<span class="ident" id="1353208">i</span>&nbsp;<span class="op" id="1353210">:=</span>&nbsp;<span class="num" id="1353213">0</span><span class="op" id="1353214">;</span>&nbsp;<span class="ident" id="1353216">i</span>&nbsp;<span class="op" id="1353218">&lt;</span>&nbsp;<span class="builtinfunc" id="1353220">len</span><span class="op" id="1353223">(</span><span class="ident" id="1353224">oldnew</span><span class="op" id="1353230">)</span><span class="op" id="1353231">;</span>&nbsp;<span class="ident" id="1353233">i</span>&nbsp;<span class="op" id="1353235">+=</span>&nbsp;<span class="num" id="1353238">2</span>&nbsp;<span class="op" id="1353240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1353244">key</span>&nbsp;<span class="op" id="1353248">:=</span>&nbsp;<span class="ident" id="1353251">oldnew</span><span class="op" id="1353257">[</span><span class="ident" id="1353258">i</span><span class="op" id="1353259">]</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1353263">for</span>&nbsp;<span class="ident" id="1353267">j</span>&nbsp;<span class="op" id="1353269">:=</span>&nbsp;<span class="num" id="1353272">0</span><span class="op" id="1353273">;</span>&nbsp;<span class="ident" id="1353275">j</span>&nbsp;<span class="op" id="1353277">&lt;</span>&nbsp;<span class="builtinfunc" id="1353279">len</span><span class="op" id="1353282">(</span><span class="ident" id="1353283">key</span><span class="op" id="1353286">)</span><span class="op" id="1353287">;</span>&nbsp;<span class="ident" id="1353289">j</span><span class="op" id="1353290">++</span>&nbsp;<span class="op" id="1353293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1353298">r</span><span class="op" id="1353299">.</span><span class="ident" id="1353300">mapping</span><span class="op" id="1353307">[</span><span class="ident" id="1353308">key</span><span class="op" id="1353311">[</span><span class="ident" id="1353312">j</span><span class="op" id="1353313">]</span><span class="op" id="1353314">]</span>&nbsp;<span class="op" id="1353316">=</span>&nbsp;<span class="num" id="1353318">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1353322">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1353325">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1353329">for</span>&nbsp;<span class="ident" id="1353333">_</span><span class="op" id="1353334">,</span>&nbsp;<span class="ident" id="1353336">b</span>&nbsp;<span class="op" id="1353338">:=</span>&nbsp;<span class="keyword" id="1353341">range</span>&nbsp;<span class="ident" id="1353347">r</span><span class="op" id="1353348">.</span><span class="ident" id="1353349">mapping</span>&nbsp;<span class="op" id="1353357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1353361">r</span><span class="op" id="1353362">.</span><span class="ident" id="1353363">tableSize</span>&nbsp;<span class="op" id="1353373">+=</span>&nbsp;<span class="builtintype" id="1353376">int</span><span class="op" id="1353379">(</span><span class="ident" id="1353380">b</span><span class="op" id="1353381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1353384">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1353388">var</span>&nbsp;<span class="ident" id="1353392">index</span>&nbsp;<span class="builtintype" id="1353398">byte</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1353404">for</span>&nbsp;<span class="ident" id="1353408">i</span><span class="op" id="1353409">,</span>&nbsp;<span class="ident" id="1353411">b</span>&nbsp;<span class="op" id="1353413">:=</span>&nbsp;<span class="keyword" id="1353416">range</span>&nbsp;<span class="ident" id="1353422">r</span><span class="op" id="1353423">.</span><span class="ident" id="1353424">mapping</span>&nbsp;<span class="op" id="1353432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1353436">if</span>&nbsp;<span class="ident" id="1353439">b</span>&nbsp;<span class="op" id="1353441">==</span>&nbsp;<span class="num" id="1353444">0</span>&nbsp;<span class="op" id="1353446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1353451">r</span><span class="op" id="1353452">.</span><span class="ident" id="1353453">mapping</span><span class="op" id="1353460">[</span><span class="ident" id="1353461">i</span><span class="op" id="1353462">]</span>&nbsp;<span class="op" id="1353464">=</span>&nbsp;<span class="builtintype" id="1353466">byte</span><span class="op" id="1353470">(</span><span class="ident" id="1353471">r</span><span class="op" id="1353472">.</span><span class="ident" id="1353473">tableSize</span><span class="op" id="1353482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1353486">}</span>&nbsp;<span class="keyword" id="1353488">else</span>&nbsp;<span class="op" id="1353493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1353498">r</span><span class="op" id="1353499">.</span><span class="ident" id="1353500">mapping</span><span class="op" id="1353507">[</span><span class="ident" id="1353508">i</span><span class="op" id="1353509">]</span>&nbsp;<span class="op" id="1353511">=</span>&nbsp;<span class="ident" id="1353513">index</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1353522">index</span><span class="op" id="1353527">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1353532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1353535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1353538">//&nbsp;Ensure&nbsp;root&nbsp;node&nbsp;uses&nbsp;a&nbsp;lookup&nbsp;table&nbsp;(for&nbsp;performance).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1353598">r</span><span class="op" id="1353599">.</span><span class="ident" id="1353600">root</span><span class="op" id="1353604">.</span><span class="ident" id="1353605">table</span>&nbsp;<span class="op" id="1353611">=</span>&nbsp;<span class="builtinfunc" id="1353613">make</span><span class="op" id="1353617">(</span><span class="op" id="1353618">[</span><span class="op" id="1353619">]</span><span class="op" id="1353620">*</span><span class="ident" id="1353621">trieNode</span><span class="op" id="1353629">,</span>&nbsp;<span class="ident" id="1353631">r</span><span class="op" id="1353632">.</span><span class="ident" id="1353633">tableSize</span><span class="op" id="1353642">)</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1353646">for</span>&nbsp;<span class="ident" id="1353650">i</span>&nbsp;<span class="op" id="1353652">:=</span>&nbsp;<span class="num" id="1353655">0</span><span class="op" id="1353656">;</span>&nbsp;<span class="ident" id="1353658">i</span>&nbsp;<span class="op" id="1353660">&lt;</span>&nbsp;<span class="builtinfunc" id="1353662">len</span><span class="op" id="1353665">(</span><span class="ident" id="1353666">oldnew</span><span class="op" id="1353672">)</span><span class="op" id="1353673">;</span>&nbsp;<span class="ident" id="1353675">i</span>&nbsp;<span class="op" id="1353677">+=</span>&nbsp;<span class="num" id="1353680">2</span>&nbsp;<span class="op" id="1353682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1353686">r</span><span class="op" id="1353687">.</span><span class="ident" id="1353688">root</span><span class="op" id="1353692">.</span><span class="ident" id="1353693">add</span><span class="op" id="1353696">(</span><span class="ident" id="1353697">oldnew</span><span class="op" id="1353703">[</span><span class="ident" id="1353704">i</span><span class="op" id="1353705">]</span><span class="op" id="1353706">,</span>&nbsp;<span class="ident" id="1353708">oldnew</span><span class="op" id="1353714">[</span><span class="ident" id="1353715">i</span><span class="op" id="1353716">+</span><span class="num" id="1353717">1</span><span class="op" id="1353718">]</span><span class="op" id="1353719">,</span>&nbsp;<span class="builtinfunc" id="1353721">len</span><span class="op" id="1353724">(</span><span class="ident" id="1353725">oldnew</span><span class="op" id="1353731">)</span><span class="op" id="1353732">-</span><span class="ident" id="1353733">i</span><span class="op" id="1353734">,</span>&nbsp;<span class="ident" id="1353736">r</span><span class="op" id="1353737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1353740">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1353743">return</span>&nbsp;<span class="ident" id="1353750">r</span><br>
<span class="lineno">270</span><span class="op" id="1353752">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1353755">type</span>&nbsp;<span class="ident" id="1353760">appendSliceWriter</span>&nbsp;<span class="op" id="1353778">[</span><span class="op" id="1353779">]</span><span class="builtintype" id="1353780">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1353786">//&nbsp;Write&nbsp;writes&nbsp;to&nbsp;the&nbsp;buffer&nbsp;to&nbsp;satisfy&nbsp;io.Writer.</span><br>
<span class="lineno">275</span><span class="keyword" id="1353838">func</span>&nbsp;<span class="op" id="1353843">(</span><span class="ident" id="1353844">w</span>&nbsp;<span class="op" id="1353846">*</span><span class="ident" id="1353847">appendSliceWriter</span><span class="op" id="1353864">)</span>&nbsp;<span class="ident" id="1353866">Write</span><span class="op" id="1353871">(</span><span class="ident" id="1353872">p</span>&nbsp;<span class="op" id="1353874">[</span><span class="op" id="1353875">]</span><span class="builtintype" id="1353876">byte</span><span class="op" id="1353880">)</span>&nbsp;<span class="op" id="1353882">(</span><span class="builtintype" id="1353883">int</span><span class="op" id="1353886">,</span>&nbsp;<span class="builtintype" id="1353888">error</span><span class="op" id="1353893">)</span>&nbsp;<span class="op" id="1353895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1353898">*</span><span class="ident" id="1353899">w</span>&nbsp;<span class="op" id="1353901">=</span>&nbsp;<span class="builtinfunc" id="1353903">append</span><span class="op" id="1353909">(</span><span class="op" id="1353910">*</span><span class="ident" id="1353911">w</span><span class="op" id="1353912">,</span>&nbsp;<span class="ident" id="1353914">p</span><span class="op" id="1353915">...</span><span class="op" id="1353918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1353921">return</span>&nbsp;<span class="builtinfunc" id="1353928">len</span><span class="op" id="1353931">(</span><span class="ident" id="1353932">p</span><span class="op" id="1353933">)</span><span class="op" id="1353934">,</span>&nbsp;<span class="builtintype" id="1353936">nil</span><br>
<span class="lineno"></span><span class="op" id="1353940">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="comment" id="1353943">//&nbsp;WriteString&nbsp;writes&nbsp;to&nbsp;the&nbsp;buffer&nbsp;without&nbsp;string-&gt;[]byte-&gt;string&nbsp;allocations.</span><br>
<span class="lineno"></span><span class="keyword" id="1354023">func</span>&nbsp;<span class="op" id="1354028">(</span><span class="ident" id="1354029">w</span>&nbsp;<span class="op" id="1354031">*</span><span class="ident" id="1354032">appendSliceWriter</span><span class="op" id="1354049">)</span>&nbsp;<span class="ident" id="1354051">WriteString</span><span class="op" id="1354062">(</span><span class="ident" id="1354063">s</span>&nbsp;<span class="builtintype" id="1354065">string</span><span class="op" id="1354071">)</span>&nbsp;<span class="op" id="1354073">(</span><span class="builtintype" id="1354074">int</span><span class="op" id="1354077">,</span>&nbsp;<span class="builtintype" id="1354079">error</span><span class="op" id="1354084">)</span>&nbsp;<span class="op" id="1354086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1354089">*</span><span class="ident" id="1354090">w</span>&nbsp;<span class="op" id="1354092">=</span>&nbsp;<span class="builtinfunc" id="1354094">append</span><span class="op" id="1354100">(</span><span class="op" id="1354101">*</span><span class="ident" id="1354102">w</span><span class="op" id="1354103">,</span>&nbsp;<span class="ident" id="1354105">s</span><span class="op" id="1354106">...</span><span class="op" id="1354109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1354112">return</span>&nbsp;<span class="builtinfunc" id="1354119">len</span><span class="op" id="1354122">(</span><span class="ident" id="1354123">s</span><span class="op" id="1354124">)</span><span class="op" id="1354125">,</span>&nbsp;<span class="builtintype" id="1354127">nil</span><br>
<span class="lineno"></span><span class="op" id="1354131">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="keyword" id="1354134">type</span>&nbsp;<span class="ident" id="1354139">stringWriterIface</span>&nbsp;<span class="keyword" id="1354157">interface</span>&nbsp;<span class="op" id="1354167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1354170">WriteString</span><span class="op" id="1354181">(</span><span class="builtintype" id="1354182">string</span><span class="op" id="1354188">)</span>&nbsp;<span class="op" id="1354190">(</span><span class="builtintype" id="1354191">int</span><span class="op" id="1354194">,</span>&nbsp;<span class="builtintype" id="1354196">error</span><span class="op" id="1354201">)</span><br>
<span class="lineno"></span><span class="op" id="1354203">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span><span class="keyword" id="1354206">type</span>&nbsp;<span class="ident" id="1354211">stringWriter</span>&nbsp;<span class="keyword" id="1354224">struct</span>&nbsp;<span class="op" id="1354231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1354234">w</span>&nbsp;<span class="ident" id="1354236">io</span><span class="op" id="1354238">.</span><span class="ident" id="1354239">Writer</span><br>
<span class="lineno"></span><span class="op" id="1354246">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1354249">func</span>&nbsp;<span class="op" id="1354254">(</span><span class="ident" id="1354255">w</span>&nbsp;<span class="ident" id="1354257">stringWriter</span><span class="op" id="1354269">)</span>&nbsp;<span class="ident" id="1354271">WriteString</span><span class="op" id="1354282">(</span><span class="ident" id="1354283">s</span>&nbsp;<span class="builtintype" id="1354285">string</span><span class="op" id="1354291">)</span>&nbsp;<span class="op" id="1354293">(</span><span class="builtintype" id="1354294">int</span><span class="op" id="1354297">,</span>&nbsp;<span class="builtintype" id="1354299">error</span><span class="op" id="1354304">)</span>&nbsp;<span class="op" id="1354306">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1354309">return</span>&nbsp;<span class="ident" id="1354316">w</span><span class="op" id="1354317">.</span><span class="ident" id="1354318">w</span><span class="op" id="1354319">.</span><span class="ident" id="1354320">Write</span><span class="op" id="1354325">(</span><span class="op" id="1354326">[</span><span class="op" id="1354327">]</span><span class="builtintype" id="1354328">byte</span><span class="op" id="1354332">(</span><span class="ident" id="1354333">s</span><span class="op" id="1354334">)</span><span class="op" id="1354335">)</span><br>
<span class="lineno"></span><span class="op" id="1354337">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1354340">func</span>&nbsp;<span class="ident" id="1354345">getStringWriter</span><span class="op" id="1354360">(</span><span class="ident" id="1354361">w</span>&nbsp;<span class="ident" id="1354363">io</span><span class="op" id="1354365">.</span><span class="ident" id="1354366">Writer</span><span class="op" id="1354372">)</span>&nbsp;<span class="ident" id="1354374">stringWriterIface</span>&nbsp;<span class="op" id="1354392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1354395">sw</span><span class="op" id="1354397">,</span>&nbsp;<span class="ident" id="1354399">ok</span>&nbsp;<span class="op" id="1354402">:=</span>&nbsp;<span class="ident" id="1354405">w</span><span class="op" id="1354406">.</span><span class="op" id="1354407">(</span><span class="ident" id="1354408">stringWriterIface</span><span class="op" id="1354425">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1354428">if</span>&nbsp;<span class="op" id="1354431">!</span><span class="ident" id="1354432">ok</span>&nbsp;<span class="op" id="1354435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1354439">sw</span>&nbsp;<span class="op" id="1354442">=</span>&nbsp;<span class="ident" id="1354444">stringWriter</span><span class="op" id="1354456">{</span><span class="ident" id="1354457">w</span><span class="op" id="1354458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1354461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1354464">return</span>&nbsp;<span class="ident" id="1354471">sw</span><br>
<span class="lineno"></span><span class="op" id="1354474">}</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span><span class="keyword" id="1354477">func</span>&nbsp;<span class="op" id="1354482">(</span><span class="ident" id="1354483">r</span>&nbsp;<span class="op" id="1354485">*</span><span class="ident" id="1354486">genericReplacer</span><span class="op" id="1354501">)</span>&nbsp;<span class="ident" id="1354503">Replace</span><span class="op" id="1354510">(</span><span class="ident" id="1354511">s</span>&nbsp;<span class="builtintype" id="1354513">string</span><span class="op" id="1354519">)</span>&nbsp;<span class="builtintype" id="1354521">string</span>&nbsp;<span class="op" id="1354528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1354531">buf</span>&nbsp;<span class="op" id="1354535">:=</span>&nbsp;<span class="builtinfunc" id="1354538">make</span><span class="op" id="1354542">(</span><span class="ident" id="1354543">appendSliceWriter</span><span class="op" id="1354560">,</span>&nbsp;<span class="num" id="1354562">0</span><span class="op" id="1354563">,</span>&nbsp;<span class="builtinfunc" id="1354565">len</span><span class="op" id="1354568">(</span><span class="ident" id="1354569">s</span><span class="op" id="1354570">)</span><span class="op" id="1354571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1354574">r</span><span class="op" id="1354575">.</span><span class="ident" id="1354576">WriteString</span><span class="op" id="1354587">(</span><span class="op" id="1354588">&amp;</span><span class="ident" id="1354589">buf</span><span class="op" id="1354592">,</span>&nbsp;<span class="ident" id="1354594">s</span><span class="op" id="1354595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1354598">return</span>&nbsp;<span class="builtintype" id="1354605">string</span><span class="op" id="1354611">(</span><span class="ident" id="1354612">buf</span><span class="op" id="1354615">)</span><br>
<span class="lineno">310</span><span class="op" id="1354617">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1354620">func</span>&nbsp;<span class="op" id="1354625">(</span><span class="ident" id="1354626">r</span>&nbsp;<span class="op" id="1354628">*</span><span class="ident" id="1354629">genericReplacer</span><span class="op" id="1354644">)</span>&nbsp;<span class="ident" id="1354646">WriteString</span><span class="op" id="1354657">(</span><span class="ident" id="1354658">w</span>&nbsp;<span class="ident" id="1354660">io</span><span class="op" id="1354662">.</span><span class="ident" id="1354663">Writer</span><span class="op" id="1354669">,</span>&nbsp;<span class="ident" id="1354671">s</span>&nbsp;<span class="builtintype" id="1354673">string</span><span class="op" id="1354679">)</span>&nbsp;<span class="op" id="1354681">(</span><span class="ident" id="1354682">n</span>&nbsp;<span class="builtintype" id="1354684">int</span><span class="op" id="1354687">,</span>&nbsp;<span class="ident" id="1354689">err</span>&nbsp;<span class="builtintype" id="1354693">error</span><span class="op" id="1354698">)</span>&nbsp;<span class="op" id="1354700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1354703">sw</span>&nbsp;<span class="op" id="1354706">:=</span>&nbsp;<span class="ident" id="1354709">getStringWriter</span><span class="op" id="1354724">(</span><span class="ident" id="1354725">w</span><span class="op" id="1354726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1354729">var</span>&nbsp;<span class="ident" id="1354733">last</span><span class="op" id="1354737">,</span>&nbsp;<span class="ident" id="1354739">wn</span>&nbsp;<span class="builtintype" id="1354742">int</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1354747">var</span>&nbsp;<span class="ident" id="1354751">prevMatchEmpty</span>&nbsp;<span class="builtintype" id="1354766">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1354772">for</span>&nbsp;<span class="ident" id="1354776">i</span>&nbsp;<span class="op" id="1354778">:=</span>&nbsp;<span class="num" id="1354781">0</span><span class="op" id="1354782">;</span>&nbsp;<span class="ident" id="1354784">i</span>&nbsp;<span class="op" id="1354786">&lt;=</span>&nbsp;<span class="builtinfunc" id="1354789">len</span><span class="op" id="1354792">(</span><span class="ident" id="1354793">s</span><span class="op" id="1354794">)</span><span class="op" id="1354795">;</span>&nbsp;<span class="op" id="1354797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1354801">//&nbsp;Fast&nbsp;path:&nbsp;s[i]&nbsp;is&nbsp;not&nbsp;a&nbsp;prefix&nbsp;of&nbsp;any&nbsp;pattern.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1354854">if</span>&nbsp;<span class="ident" id="1354857">i</span>&nbsp;<span class="op" id="1354859">!=</span>&nbsp;<span class="builtinfunc" id="1354862">len</span><span class="op" id="1354865">(</span><span class="ident" id="1354866">s</span><span class="op" id="1354867">)</span>&nbsp;<span class="op" id="1354869">&amp;&amp;</span>&nbsp;<span class="ident" id="1354872">r</span><span class="op" id="1354873">.</span><span class="ident" id="1354874">root</span><span class="op" id="1354878">.</span><span class="ident" id="1354879">priority</span>&nbsp;<span class="op" id="1354888">==</span>&nbsp;<span class="num" id="1354891">0</span>&nbsp;<span class="op" id="1354893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1354898">index</span>&nbsp;<span class="op" id="1354904">:=</span>&nbsp;<span class="builtintype" id="1354907">int</span><span class="op" id="1354910">(</span><span class="ident" id="1354911">r</span><span class="op" id="1354912">.</span><span class="ident" id="1354913">mapping</span><span class="op" id="1354920">[</span><span class="ident" id="1354921">s</span><span class="op" id="1354922">[</span><span class="ident" id="1354923">i</span><span class="op" id="1354924">]</span><span class="op" id="1354925">]</span><span class="op" id="1354926">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1354931">if</span>&nbsp;<span class="ident" id="1354934">index</span>&nbsp;<span class="op" id="1354940">==</span>&nbsp;<span class="ident" id="1354943">r</span><span class="op" id="1354944">.</span><span class="ident" id="1354945">tableSize</span>&nbsp;<span class="op" id="1354955">||</span>&nbsp;<span class="ident" id="1354958">r</span><span class="op" id="1354959">.</span><span class="ident" id="1354960">root</span><span class="op" id="1354964">.</span><span class="ident" id="1354965">table</span><span class="op" id="1354970">[</span><span class="ident" id="1354971">index</span><span class="op" id="1354976">]</span>&nbsp;<span class="op" id="1354978">==</span>&nbsp;<span class="builtintype" id="1354981">nil</span>&nbsp;<span class="op" id="1354985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1354991">i</span><span class="op" id="1354992">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1354999">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1355011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1355015">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1355020">//&nbsp;Ignore&nbsp;the&nbsp;empty&nbsp;match&nbsp;iff&nbsp;the&nbsp;previous&nbsp;loop&nbsp;found&nbsp;the&nbsp;empty&nbsp;match.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1355093">val</span><span class="op" id="1355096">,</span>&nbsp;<span class="ident" id="1355098">keylen</span><span class="op" id="1355104">,</span>&nbsp;<span class="ident" id="1355106">match</span>&nbsp;<span class="op" id="1355112">:=</span>&nbsp;<span class="ident" id="1355115">r</span><span class="op" id="1355116">.</span><span class="ident" id="1355117">lookup</span><span class="op" id="1355123">(</span><span class="ident" id="1355124">s</span><span class="op" id="1355125">[</span><span class="ident" id="1355126">i</span><span class="op" id="1355127">:</span><span class="op" id="1355128">]</span><span class="op" id="1355129">,</span>&nbsp;<span class="ident" id="1355131">prevMatchEmpty</span><span class="op" id="1355145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1355149">prevMatchEmpty</span>&nbsp;<span class="op" id="1355164">=</span>&nbsp;<span class="ident" id="1355166">match</span>&nbsp;<span class="op" id="1355172">&amp;&amp;</span>&nbsp;<span class="ident" id="1355175">keylen</span>&nbsp;<span class="op" id="1355182">==</span>&nbsp;<span class="num" id="1355185">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1355189">if</span>&nbsp;<span class="ident" id="1355192">match</span>&nbsp;<span class="op" id="1355198">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1355203">wn</span><span class="op" id="1355205">,</span>&nbsp;<span class="ident" id="1355207">err</span>&nbsp;<span class="op" id="1355211">=</span>&nbsp;<span class="ident" id="1355213">sw</span><span class="op" id="1355215">.</span><span class="ident" id="1355216">WriteString</span><span class="op" id="1355227">(</span><span class="ident" id="1355228">s</span><span class="op" id="1355229">[</span><span class="ident" id="1355230">last</span><span class="op" id="1355234">:</span><span class="ident" id="1355235">i</span><span class="op" id="1355236">]</span><span class="op" id="1355237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1355242">n</span>&nbsp;<span class="op" id="1355244">+=</span>&nbsp;<span class="ident" id="1355247">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1355253">if</span>&nbsp;<span class="ident" id="1355256">err</span>&nbsp;<span class="op" id="1355260">!=</span>&nbsp;<span class="builtintype" id="1355263">nil</span>&nbsp;<span class="op" id="1355267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1355273">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1355283">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1355288">wn</span><span class="op" id="1355290">,</span>&nbsp;<span class="ident" id="1355292">err</span>&nbsp;<span class="op" id="1355296">=</span>&nbsp;<span class="ident" id="1355298">sw</span><span class="op" id="1355300">.</span><span class="ident" id="1355301">WriteString</span><span class="op" id="1355312">(</span><span class="ident" id="1355313">val</span><span class="op" id="1355316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1355321">n</span>&nbsp;<span class="op" id="1355323">+=</span>&nbsp;<span class="ident" id="1355326">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1355332">if</span>&nbsp;<span class="ident" id="1355335">err</span>&nbsp;<span class="op" id="1355339">!=</span>&nbsp;<span class="builtintype" id="1355342">nil</span>&nbsp;<span class="op" id="1355346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1355352">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1355362">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1355367">i</span>&nbsp;<span class="op" id="1355369">+=</span>&nbsp;<span class="ident" id="1355372">keylen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1355382">last</span>&nbsp;<span class="op" id="1355387">=</span>&nbsp;<span class="ident" id="1355389">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1355394">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1355405">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1355409">i</span><span class="op" id="1355410">++</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1355414">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1355417">if</span>&nbsp;<span class="ident" id="1355420">last</span>&nbsp;<span class="op" id="1355425">!=</span>&nbsp;<span class="builtinfunc" id="1355428">len</span><span class="op" id="1355431">(</span><span class="ident" id="1355432">s</span><span class="op" id="1355433">)</span>&nbsp;<span class="op" id="1355435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1355439">wn</span><span class="op" id="1355441">,</span>&nbsp;<span class="ident" id="1355443">err</span>&nbsp;<span class="op" id="1355447">=</span>&nbsp;<span class="ident" id="1355449">sw</span><span class="op" id="1355451">.</span><span class="ident" id="1355452">WriteString</span><span class="op" id="1355463">(</span><span class="ident" id="1355464">s</span><span class="op" id="1355465">[</span><span class="ident" id="1355466">last</span><span class="op" id="1355470">:</span><span class="op" id="1355471">]</span><span class="op" id="1355472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1355476">n</span>&nbsp;<span class="op" id="1355478">+=</span>&nbsp;<span class="ident" id="1355481">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1355485">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1355488">return</span><br>
<span class="lineno"></span><span class="op" id="1355495">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1355498">//&nbsp;singleStringReplacer&nbsp;is&nbsp;the&nbsp;implementation&nbsp;that&#39;s&nbsp;used&nbsp;when&nbsp;there&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="1355575">//&nbsp;one&nbsp;string&nbsp;to&nbsp;replace&nbsp;(and&nbsp;that&nbsp;string&nbsp;has&nbsp;more&nbsp;than&nbsp;one&nbsp;byte).</span><br>
<span class="lineno">355</span><span class="keyword" id="1355642">type</span>&nbsp;<span class="ident" id="1355647">singleStringReplacer</span>&nbsp;<span class="keyword" id="1355668">struct</span>&nbsp;<span class="op" id="1355675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1355678">finder</span>&nbsp;<span class="op" id="1355685">*</span><span class="ident" id="1355686">stringFinder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1355700">//&nbsp;value&nbsp;is&nbsp;the&nbsp;new&nbsp;string&nbsp;that&nbsp;replaces&nbsp;that&nbsp;pattern&nbsp;when&nbsp;it&#39;s&nbsp;found.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1355772">value</span>&nbsp;<span class="builtintype" id="1355778">string</span><br>
<span class="lineno"></span><span class="op" id="1355785">}</span><br>
<span class="lineno">360</span><br>
<span class="lineno"></span><span class="keyword" id="1355788">func</span>&nbsp;<span class="ident" id="1355793">makeSingleStringReplacer</span><span class="op" id="1355817">(</span><span class="ident" id="1355818">pattern</span>&nbsp;<span class="builtintype" id="1355826">string</span><span class="op" id="1355832">,</span>&nbsp;<span class="ident" id="1355834">value</span>&nbsp;<span class="builtintype" id="1355840">string</span><span class="op" id="1355846">)</span>&nbsp;<span class="op" id="1355848">*</span><span class="ident" id="1355849">singleStringReplacer</span>&nbsp;<span class="op" id="1355870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1355873">return</span>&nbsp;<span class="op" id="1355880">&amp;</span><span class="ident" id="1355881">singleStringReplacer</span><span class="op" id="1355901">{</span><span class="ident" id="1355902">finder</span><span class="op" id="1355908">:</span>&nbsp;<span class="ident" id="1355910">makeStringFinder</span><span class="op" id="1355926">(</span><span class="ident" id="1355927">pattern</span><span class="op" id="1355934">)</span><span class="op" id="1355935">,</span>&nbsp;<span class="ident" id="1355937">value</span><span class="op" id="1355942">:</span>&nbsp;<span class="ident" id="1355944">value</span><span class="op" id="1355949">}</span><br>
<span class="lineno"></span><span class="op" id="1355951">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="keyword" id="1355954">func</span>&nbsp;<span class="op" id="1355959">(</span><span class="ident" id="1355960">r</span>&nbsp;<span class="op" id="1355962">*</span><span class="ident" id="1355963">singleStringReplacer</span><span class="op" id="1355983">)</span>&nbsp;<span class="ident" id="1355985">Replace</span><span class="op" id="1355992">(</span><span class="ident" id="1355993">s</span>&nbsp;<span class="builtintype" id="1355995">string</span><span class="op" id="1356001">)</span>&nbsp;<span class="builtintype" id="1356003">string</span>&nbsp;<span class="op" id="1356010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1356013">var</span>&nbsp;<span class="ident" id="1356017">buf</span>&nbsp;<span class="op" id="1356021">[</span><span class="op" id="1356022">]</span><span class="builtintype" id="1356023">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1356029">i</span><span class="op" id="1356030">,</span>&nbsp;<span class="ident" id="1356032">matched</span>&nbsp;<span class="op" id="1356040">:=</span>&nbsp;<span class="num" id="1356043">0</span><span class="op" id="1356044">,</span>&nbsp;<span class="builtintype" id="1356046">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1356053">for</span>&nbsp;<span class="op" id="1356057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1356061">match</span>&nbsp;<span class="op" id="1356067">:=</span>&nbsp;<span class="ident" id="1356070">r</span><span class="op" id="1356071">.</span><span class="ident" id="1356072">finder</span><span class="op" id="1356078">.</span><span class="ident" id="1356079">next</span><span class="op" id="1356083">(</span><span class="ident" id="1356084">s</span><span class="op" id="1356085">[</span><span class="ident" id="1356086">i</span><span class="op" id="1356087">:</span><span class="op" id="1356088">]</span><span class="op" id="1356089">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1356093">if</span>&nbsp;<span class="ident" id="1356096">match</span>&nbsp;<span class="op" id="1356102">==</span>&nbsp;<span class="op" id="1356105">-</span><span class="num" id="1356106">1</span>&nbsp;<span class="op" id="1356108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1356113">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1356121">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1356125">matched</span>&nbsp;<span class="op" id="1356133">=</span>&nbsp;<span class="builtintype" id="1356135">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1356142">buf</span>&nbsp;<span class="op" id="1356146">=</span>&nbsp;<span class="builtinfunc" id="1356148">append</span><span class="op" id="1356154">(</span><span class="ident" id="1356155">buf</span><span class="op" id="1356158">,</span>&nbsp;<span class="ident" id="1356160">s</span><span class="op" id="1356161">[</span><span class="ident" id="1356162">i</span><span class="op" id="1356163">:</span><span class="ident" id="1356164">i</span><span class="op" id="1356165">+</span><span class="ident" id="1356166">match</span><span class="op" id="1356171">]</span><span class="op" id="1356172">...</span><span class="op" id="1356175">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1356179">buf</span>&nbsp;<span class="op" id="1356183">=</span>&nbsp;<span class="builtinfunc" id="1356185">append</span><span class="op" id="1356191">(</span><span class="ident" id="1356192">buf</span><span class="op" id="1356195">,</span>&nbsp;<span class="ident" id="1356197">r</span><span class="op" id="1356198">.</span><span class="ident" id="1356199">value</span><span class="op" id="1356204">...</span><span class="op" id="1356207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1356211">i</span>&nbsp;<span class="op" id="1356213">+=</span>&nbsp;<span class="ident" id="1356216">match</span>&nbsp;<span class="op" id="1356222">+</span>&nbsp;<span class="builtinfunc" id="1356224">len</span><span class="op" id="1356227">(</span><span class="ident" id="1356228">r</span><span class="op" id="1356229">.</span><span class="ident" id="1356230">finder</span><span class="op" id="1356236">.</span><span class="ident" id="1356237">pattern</span><span class="op" id="1356244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1356247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1356250">if</span>&nbsp;<span class="op" id="1356253">!</span><span class="ident" id="1356254">matched</span>&nbsp;<span class="op" id="1356262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1356266">return</span>&nbsp;<span class="ident" id="1356273">s</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1356276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1356279">buf</span>&nbsp;<span class="op" id="1356283">=</span>&nbsp;<span class="builtinfunc" id="1356285">append</span><span class="op" id="1356291">(</span><span class="ident" id="1356292">buf</span><span class="op" id="1356295">,</span>&nbsp;<span class="ident" id="1356297">s</span><span class="op" id="1356298">[</span><span class="ident" id="1356299">i</span><span class="op" id="1356300">:</span><span class="op" id="1356301">]</span><span class="op" id="1356302">...</span><span class="op" id="1356305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1356308">return</span>&nbsp;<span class="builtintype" id="1356315">string</span><span class="op" id="1356321">(</span><span class="ident" id="1356322">buf</span><span class="op" id="1356325">)</span><br>
<span class="lineno"></span><span class="op" id="1356327">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span><span class="keyword" id="1356330">func</span>&nbsp;<span class="op" id="1356335">(</span><span class="ident" id="1356336">r</span>&nbsp;<span class="op" id="1356338">*</span><span class="ident" id="1356339">singleStringReplacer</span><span class="op" id="1356359">)</span>&nbsp;<span class="ident" id="1356361">WriteString</span><span class="op" id="1356372">(</span><span class="ident" id="1356373">w</span>&nbsp;<span class="ident" id="1356375">io</span><span class="op" id="1356377">.</span><span class="ident" id="1356378">Writer</span><span class="op" id="1356384">,</span>&nbsp;<span class="ident" id="1356386">s</span>&nbsp;<span class="builtintype" id="1356388">string</span><span class="op" id="1356394">)</span>&nbsp;<span class="op" id="1356396">(</span><span class="ident" id="1356397">n</span>&nbsp;<span class="builtintype" id="1356399">int</span><span class="op" id="1356402">,</span>&nbsp;<span class="ident" id="1356404">err</span>&nbsp;<span class="builtintype" id="1356408">error</span><span class="op" id="1356413">)</span>&nbsp;<span class="op" id="1356415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1356418">sw</span>&nbsp;<span class="op" id="1356421">:=</span>&nbsp;<span class="ident" id="1356424">getStringWriter</span><span class="op" id="1356439">(</span><span class="ident" id="1356440">w</span><span class="op" id="1356441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1356444">var</span>&nbsp;<span class="ident" id="1356448">i</span><span class="op" id="1356449">,</span>&nbsp;<span class="ident" id="1356451">wn</span>&nbsp;<span class="builtintype" id="1356454">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1356459">for</span>&nbsp;<span class="op" id="1356463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1356467">match</span>&nbsp;<span class="op" id="1356473">:=</span>&nbsp;<span class="ident" id="1356476">r</span><span class="op" id="1356477">.</span><span class="ident" id="1356478">finder</span><span class="op" id="1356484">.</span><span class="ident" id="1356485">next</span><span class="op" id="1356489">(</span><span class="ident" id="1356490">s</span><span class="op" id="1356491">[</span><span class="ident" id="1356492">i</span><span class="op" id="1356493">:</span><span class="op" id="1356494">]</span><span class="op" id="1356495">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1356499">if</span>&nbsp;<span class="ident" id="1356502">match</span>&nbsp;<span class="op" id="1356508">==</span>&nbsp;<span class="op" id="1356511">-</span><span class="num" id="1356512">1</span>&nbsp;<span class="op" id="1356514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1356519">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1356527">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1356531">wn</span><span class="op" id="1356533">,</span>&nbsp;<span class="ident" id="1356535">err</span>&nbsp;<span class="op" id="1356539">=</span>&nbsp;<span class="ident" id="1356541">sw</span><span class="op" id="1356543">.</span><span class="ident" id="1356544">WriteString</span><span class="op" id="1356555">(</span><span class="ident" id="1356556">s</span><span class="op" id="1356557">[</span><span class="ident" id="1356558">i</span>&nbsp;<span class="op" id="1356560">:</span>&nbsp;<span class="ident" id="1356562">i</span><span class="op" id="1356563">+</span><span class="ident" id="1356564">match</span><span class="op" id="1356569">]</span><span class="op" id="1356570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1356574">n</span>&nbsp;<span class="op" id="1356576">+=</span>&nbsp;<span class="ident" id="1356579">wn</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1356584">if</span>&nbsp;<span class="ident" id="1356587">err</span>&nbsp;<span class="op" id="1356591">!=</span>&nbsp;<span class="builtintype" id="1356594">nil</span>&nbsp;<span class="op" id="1356598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1356603">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1356612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1356616">wn</span><span class="op" id="1356618">,</span>&nbsp;<span class="ident" id="1356620">err</span>&nbsp;<span class="op" id="1356624">=</span>&nbsp;<span class="ident" id="1356626">sw</span><span class="op" id="1356628">.</span><span class="ident" id="1356629">WriteString</span><span class="op" id="1356640">(</span><span class="ident" id="1356641">r</span><span class="op" id="1356642">.</span><span class="ident" id="1356643">value</span><span class="op" id="1356648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1356652">n</span>&nbsp;<span class="op" id="1356654">+=</span>&nbsp;<span class="ident" id="1356657">wn</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1356662">if</span>&nbsp;<span class="ident" id="1356665">err</span>&nbsp;<span class="op" id="1356669">!=</span>&nbsp;<span class="builtintype" id="1356672">nil</span>&nbsp;<span class="op" id="1356676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1356681">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1356690">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1356694">i</span>&nbsp;<span class="op" id="1356696">+=</span>&nbsp;<span class="ident" id="1356699">match</span>&nbsp;<span class="op" id="1356705">+</span>&nbsp;<span class="builtinfunc" id="1356707">len</span><span class="op" id="1356710">(</span><span class="ident" id="1356711">r</span><span class="op" id="1356712">.</span><span class="ident" id="1356713">finder</span><span class="op" id="1356719">.</span><span class="ident" id="1356720">pattern</span><span class="op" id="1356727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1356730">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1356733">wn</span><span class="op" id="1356735">,</span>&nbsp;<span class="ident" id="1356737">err</span>&nbsp;<span class="op" id="1356741">=</span>&nbsp;<span class="ident" id="1356743">sw</span><span class="op" id="1356745">.</span><span class="ident" id="1356746">WriteString</span><span class="op" id="1356757">(</span><span class="ident" id="1356758">s</span><span class="op" id="1356759">[</span><span class="ident" id="1356760">i</span><span class="op" id="1356761">:</span><span class="op" id="1356762">]</span><span class="op" id="1356763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1356766">n</span>&nbsp;<span class="op" id="1356768">+=</span>&nbsp;<span class="ident" id="1356771">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1356775">return</span><br>
<span class="lineno"></span><span class="op" id="1356782">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="comment" id="1356785">//&nbsp;byteReplacer&nbsp;is&nbsp;the&nbsp;implementation&nbsp;that&#39;s&nbsp;used&nbsp;when&nbsp;all&nbsp;the&nbsp;&#34;old&#34;</span><br>
<span class="lineno"></span><span class="comment" id="1356854">//&nbsp;and&nbsp;&#34;new&#34;&nbsp;values&nbsp;are&nbsp;single&nbsp;ASCII&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="1356898">//&nbsp;The&nbsp;array&nbsp;contains&nbsp;replacement&nbsp;bytes&nbsp;indexed&nbsp;by&nbsp;old&nbsp;byte.</span><br>
<span class="lineno"></span><span class="keyword" id="1356959">type</span>&nbsp;<span class="ident" id="1356964">byteReplacer</span>&nbsp;<span class="op" id="1356977">[</span><span class="num" id="1356978">256</span><span class="op" id="1356981">]</span><span class="builtintype" id="1356982">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="keyword" id="1356988">func</span>&nbsp;<span class="op" id="1356993">(</span><span class="ident" id="1356994">r</span>&nbsp;<span class="op" id="1356996">*</span><span class="ident" id="1356997">byteReplacer</span><span class="op" id="1357009">)</span>&nbsp;<span class="ident" id="1357011">Replace</span><span class="op" id="1357018">(</span><span class="ident" id="1357019">s</span>&nbsp;<span class="builtintype" id="1357021">string</span><span class="op" id="1357027">)</span>&nbsp;<span class="builtintype" id="1357029">string</span>&nbsp;<span class="op" id="1357036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1357039">var</span>&nbsp;<span class="ident" id="1357043">buf</span>&nbsp;<span class="op" id="1357047">[</span><span class="op" id="1357048">]</span><span class="builtintype" id="1357049">byte</span>&nbsp;<span class="comment" id="1357054">//&nbsp;lazily&nbsp;allocated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1357075">for</span>&nbsp;<span class="ident" id="1357079">i</span>&nbsp;<span class="op" id="1357081">:=</span>&nbsp;<span class="num" id="1357084">0</span><span class="op" id="1357085">;</span>&nbsp;<span class="ident" id="1357087">i</span>&nbsp;<span class="op" id="1357089">&lt;</span>&nbsp;<span class="builtinfunc" id="1357091">len</span><span class="op" id="1357094">(</span><span class="ident" id="1357095">s</span><span class="op" id="1357096">)</span><span class="op" id="1357097">;</span>&nbsp;<span class="ident" id="1357099">i</span><span class="op" id="1357100">++</span>&nbsp;<span class="op" id="1357103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1357107">b</span>&nbsp;<span class="op" id="1357109">:=</span>&nbsp;<span class="ident" id="1357112">s</span><span class="op" id="1357113">[</span><span class="ident" id="1357114">i</span><span class="op" id="1357115">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1357119">if</span>&nbsp;<span class="ident" id="1357122">r</span><span class="op" id="1357123">[</span><span class="ident" id="1357124">b</span><span class="op" id="1357125">]</span>&nbsp;<span class="op" id="1357127">!=</span>&nbsp;<span class="ident" id="1357130">b</span>&nbsp;<span class="op" id="1357132">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1357137">if</span>&nbsp;<span class="ident" id="1357140">buf</span>&nbsp;<span class="op" id="1357144">==</span>&nbsp;<span class="builtintype" id="1357147">nil</span>&nbsp;<span class="op" id="1357151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1357157">buf</span>&nbsp;<span class="op" id="1357161">=</span>&nbsp;<span class="op" id="1357163">[</span><span class="op" id="1357164">]</span><span class="builtintype" id="1357165">byte</span><span class="op" id="1357169">(</span><span class="ident" id="1357170">s</span><span class="op" id="1357171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1357176">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1357181">buf</span><span class="op" id="1357184">[</span><span class="ident" id="1357185">i</span><span class="op" id="1357186">]</span>&nbsp;<span class="op" id="1357188">=</span>&nbsp;<span class="ident" id="1357190">r</span><span class="op" id="1357191">[</span><span class="ident" id="1357192">b</span><span class="op" id="1357193">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1357197">}</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1357200">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1357203">if</span>&nbsp;<span class="ident" id="1357206">buf</span>&nbsp;<span class="op" id="1357210">==</span>&nbsp;<span class="builtintype" id="1357213">nil</span>&nbsp;<span class="op" id="1357217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1357221">return</span>&nbsp;<span class="ident" id="1357228">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1357231">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1357234">return</span>&nbsp;<span class="builtintype" id="1357241">string</span><span class="op" id="1357247">(</span><span class="ident" id="1357248">buf</span><span class="op" id="1357251">)</span><br>
<span class="lineno">430</span><span class="op" id="1357253">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1357256">func</span>&nbsp;<span class="op" id="1357261">(</span><span class="ident" id="1357262">r</span>&nbsp;<span class="op" id="1357264">*</span><span class="ident" id="1357265">byteReplacer</span><span class="op" id="1357277">)</span>&nbsp;<span class="ident" id="1357279">WriteString</span><span class="op" id="1357290">(</span><span class="ident" id="1357291">w</span>&nbsp;<span class="ident" id="1357293">io</span><span class="op" id="1357295">.</span><span class="ident" id="1357296">Writer</span><span class="op" id="1357302">,</span>&nbsp;<span class="ident" id="1357304">s</span>&nbsp;<span class="builtintype" id="1357306">string</span><span class="op" id="1357312">)</span>&nbsp;<span class="op" id="1357314">(</span><span class="ident" id="1357315">n</span>&nbsp;<span class="builtintype" id="1357317">int</span><span class="op" id="1357320">,</span>&nbsp;<span class="ident" id="1357322">err</span>&nbsp;<span class="builtintype" id="1357326">error</span><span class="op" id="1357331">)</span>&nbsp;<span class="op" id="1357333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1357336">//&nbsp;TODO(bradfitz):&nbsp;use&nbsp;io.WriteString&nbsp;with&nbsp;slices&nbsp;of&nbsp;s,&nbsp;avoiding&nbsp;allocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1357414">bufsize</span>&nbsp;<span class="op" id="1357422">:=</span>&nbsp;<span class="num" id="1357425">32</span>&nbsp;<span class="op" id="1357428">&lt;&lt;</span>&nbsp;<span class="num" id="1357431">10</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1357435">if</span>&nbsp;<span class="builtinfunc" id="1357438">len</span><span class="op" id="1357441">(</span><span class="ident" id="1357442">s</span><span class="op" id="1357443">)</span>&nbsp;<span class="op" id="1357445">&lt;</span>&nbsp;<span class="ident" id="1357447">bufsize</span>&nbsp;<span class="op" id="1357455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1357459">bufsize</span>&nbsp;<span class="op" id="1357467">=</span>&nbsp;<span class="builtinfunc" id="1357469">len</span><span class="op" id="1357472">(</span><span class="ident" id="1357473">s</span><span class="op" id="1357474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1357477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1357480">buf</span>&nbsp;<span class="op" id="1357484">:=</span>&nbsp;<span class="builtinfunc" id="1357487">make</span><span class="op" id="1357491">(</span><span class="op" id="1357492">[</span><span class="op" id="1357493">]</span><span class="builtintype" id="1357494">byte</span><span class="op" id="1357498">,</span>&nbsp;<span class="ident" id="1357500">bufsize</span><span class="op" id="1357507">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1357511">for</span>&nbsp;<span class="builtinfunc" id="1357515">len</span><span class="op" id="1357518">(</span><span class="ident" id="1357519">s</span><span class="op" id="1357520">)</span>&nbsp;<span class="op" id="1357522">&gt;</span>&nbsp;<span class="num" id="1357524">0</span>&nbsp;<span class="op" id="1357526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1357530">ncopy</span>&nbsp;<span class="op" id="1357536">:=</span>&nbsp;<span class="builtinfunc" id="1357539">copy</span><span class="op" id="1357543">(</span><span class="ident" id="1357544">buf</span><span class="op" id="1357547">,</span>&nbsp;<span class="ident" id="1357549">s</span><span class="op" id="1357550">[</span><span class="op" id="1357551">:</span><span class="op" id="1357552">]</span><span class="op" id="1357553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1357557">s</span>&nbsp;<span class="op" id="1357559">=</span>&nbsp;<span class="ident" id="1357561">s</span><span class="op" id="1357562">[</span><span class="ident" id="1357563">ncopy</span><span class="op" id="1357568">:</span><span class="op" id="1357569">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1357573">for</span>&nbsp;<span class="ident" id="1357577">i</span><span class="op" id="1357578">,</span>&nbsp;<span class="ident" id="1357580">b</span>&nbsp;<span class="op" id="1357582">:=</span>&nbsp;<span class="keyword" id="1357585">range</span>&nbsp;<span class="ident" id="1357591">buf</span><span class="op" id="1357594">[</span><span class="op" id="1357595">:</span><span class="ident" id="1357596">ncopy</span><span class="op" id="1357601">]</span>&nbsp;<span class="op" id="1357603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1357608">buf</span><span class="op" id="1357611">[</span><span class="ident" id="1357612">i</span><span class="op" id="1357613">]</span>&nbsp;<span class="op" id="1357615">=</span>&nbsp;<span class="ident" id="1357617">r</span><span class="op" id="1357618">[</span><span class="ident" id="1357619">b</span><span class="op" id="1357620">]</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1357624">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1357628">wn</span><span class="op" id="1357630">,</span>&nbsp;<span class="ident" id="1357632">err</span>&nbsp;<span class="op" id="1357636">:=</span>&nbsp;<span class="ident" id="1357639">w</span><span class="op" id="1357640">.</span><span class="ident" id="1357641">Write</span><span class="op" id="1357646">(</span><span class="ident" id="1357647">buf</span><span class="op" id="1357650">[</span><span class="op" id="1357651">:</span><span class="ident" id="1357652">ncopy</span><span class="op" id="1357657">]</span><span class="op" id="1357658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1357662">n</span>&nbsp;<span class="op" id="1357664">+=</span>&nbsp;<span class="ident" id="1357667">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1357672">if</span>&nbsp;<span class="ident" id="1357675">err</span>&nbsp;<span class="op" id="1357679">!=</span>&nbsp;<span class="builtintype" id="1357682">nil</span>&nbsp;<span class="op" id="1357686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1357691">return</span>&nbsp;<span class="ident" id="1357698">n</span><span class="op" id="1357699">,</span>&nbsp;<span class="ident" id="1357701">err</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1357707">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1357710">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1357713">return</span>&nbsp;<span class="ident" id="1357720">n</span><span class="op" id="1357721">,</span>&nbsp;<span class="builtintype" id="1357723">nil</span><br>
<span class="lineno"></span><span class="op" id="1357727">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span><span class="comment" id="1357730">//&nbsp;byteStringReplacer&nbsp;is&nbsp;the&nbsp;implementation&nbsp;that&#39;s&nbsp;used&nbsp;when&nbsp;all&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1357799">//&nbsp;&#34;old&#34;&nbsp;values&nbsp;are&nbsp;single&nbsp;ASCII&nbsp;bytes&nbsp;but&nbsp;the&nbsp;&#34;new&#34;&nbsp;values&nbsp;vary&nbsp;in&nbsp;size.</span><br>
<span class="lineno"></span><span class="comment" id="1357873">//&nbsp;The&nbsp;array&nbsp;contains&nbsp;replacement&nbsp;byte&nbsp;slices&nbsp;indexed&nbsp;by&nbsp;old&nbsp;byte.</span><br>
<span class="lineno"></span><span class="comment" id="1357940">//&nbsp;A&nbsp;nil&nbsp;[]byte&nbsp;means&nbsp;that&nbsp;the&nbsp;old&nbsp;byte&nbsp;should&nbsp;not&nbsp;be&nbsp;replaced.</span><br>
<span class="lineno"></span><span class="keyword" id="1358004">type</span>&nbsp;<span class="ident" id="1358009">byteStringReplacer</span>&nbsp;<span class="op" id="1358028">[</span><span class="num" id="1358029">256</span><span class="op" id="1358032">]</span><span class="op" id="1358033">[</span><span class="op" id="1358034">]</span><span class="builtintype" id="1358035">byte</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span><span class="keyword" id="1358041">func</span>&nbsp;<span class="op" id="1358046">(</span><span class="ident" id="1358047">r</span>&nbsp;<span class="op" id="1358049">*</span><span class="ident" id="1358050">byteStringReplacer</span><span class="op" id="1358068">)</span>&nbsp;<span class="ident" id="1358070">Replace</span><span class="op" id="1358077">(</span><span class="ident" id="1358078">s</span>&nbsp;<span class="builtintype" id="1358080">string</span><span class="op" id="1358086">)</span>&nbsp;<span class="builtintype" id="1358088">string</span>&nbsp;<span class="op" id="1358095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1358098">newSize</span>&nbsp;<span class="op" id="1358106">:=</span>&nbsp;<span class="builtinfunc" id="1358109">len</span><span class="op" id="1358112">(</span><span class="ident" id="1358113">s</span><span class="op" id="1358114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1358117">anyChanges</span>&nbsp;<span class="op" id="1358128">:=</span>&nbsp;<span class="builtintype" id="1358131">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1358138">for</span>&nbsp;<span class="ident" id="1358142">i</span>&nbsp;<span class="op" id="1358144">:=</span>&nbsp;<span class="num" id="1358147">0</span><span class="op" id="1358148">;</span>&nbsp;<span class="ident" id="1358150">i</span>&nbsp;<span class="op" id="1358152">&lt;</span>&nbsp;<span class="builtinfunc" id="1358154">len</span><span class="op" id="1358157">(</span><span class="ident" id="1358158">s</span><span class="op" id="1358159">)</span><span class="op" id="1358160">;</span>&nbsp;<span class="ident" id="1358162">i</span><span class="op" id="1358163">++</span>&nbsp;<span class="op" id="1358166">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1358170">b</span>&nbsp;<span class="op" id="1358172">:=</span>&nbsp;<span class="ident" id="1358175">s</span><span class="op" id="1358176">[</span><span class="ident" id="1358177">i</span><span class="op" id="1358178">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1358182">if</span>&nbsp;<span class="ident" id="1358185">r</span><span class="op" id="1358186">[</span><span class="ident" id="1358187">b</span><span class="op" id="1358188">]</span>&nbsp;<span class="op" id="1358190">!=</span>&nbsp;<span class="builtintype" id="1358193">nil</span>&nbsp;<span class="op" id="1358197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1358202">anyChanges</span>&nbsp;<span class="op" id="1358213">=</span>&nbsp;<span class="builtintype" id="1358215">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1358223">//&nbsp;The&nbsp;-1&nbsp;is&nbsp;because&nbsp;we&nbsp;are&nbsp;replacing&nbsp;1&nbsp;byte&nbsp;with&nbsp;len(r[b])&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1358293">newSize</span>&nbsp;<span class="op" id="1358301">+=</span>&nbsp;<span class="builtinfunc" id="1358304">len</span><span class="op" id="1358307">(</span><span class="ident" id="1358308">r</span><span class="op" id="1358309">[</span><span class="ident" id="1358310">b</span><span class="op" id="1358311">]</span><span class="op" id="1358312">)</span>&nbsp;<span class="op" id="1358314">-</span>&nbsp;<span class="num" id="1358316">1</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1358320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1358323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1358326">if</span>&nbsp;<span class="op" id="1358329">!</span><span class="ident" id="1358330">anyChanges</span>&nbsp;<span class="op" id="1358341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1358345">return</span>&nbsp;<span class="ident" id="1358352">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1358355">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1358358">buf</span>&nbsp;<span class="op" id="1358362">:=</span>&nbsp;<span class="builtinfunc" id="1358365">make</span><span class="op" id="1358369">(</span><span class="op" id="1358370">[</span><span class="op" id="1358371">]</span><span class="builtintype" id="1358372">byte</span><span class="op" id="1358376">,</span>&nbsp;<span class="ident" id="1358378">newSize</span><span class="op" id="1358385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1358388">bi</span>&nbsp;<span class="op" id="1358391">:=</span>&nbsp;<span class="ident" id="1358394">buf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1358399">for</span>&nbsp;<span class="ident" id="1358403">i</span>&nbsp;<span class="op" id="1358405">:=</span>&nbsp;<span class="num" id="1358408">0</span><span class="op" id="1358409">;</span>&nbsp;<span class="ident" id="1358411">i</span>&nbsp;<span class="op" id="1358413">&lt;</span>&nbsp;<span class="builtinfunc" id="1358415">len</span><span class="op" id="1358418">(</span><span class="ident" id="1358419">s</span><span class="op" id="1358420">)</span><span class="op" id="1358421">;</span>&nbsp;<span class="ident" id="1358423">i</span><span class="op" id="1358424">++</span>&nbsp;<span class="op" id="1358427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1358431">b</span>&nbsp;<span class="op" id="1358433">:=</span>&nbsp;<span class="ident" id="1358436">s</span><span class="op" id="1358437">[</span><span class="ident" id="1358438">i</span><span class="op" id="1358439">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1358443">if</span>&nbsp;<span class="ident" id="1358446">r</span><span class="op" id="1358447">[</span><span class="ident" id="1358448">b</span><span class="op" id="1358449">]</span>&nbsp;<span class="op" id="1358451">!=</span>&nbsp;<span class="builtintype" id="1358454">nil</span>&nbsp;<span class="op" id="1358458">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1358463">n</span>&nbsp;<span class="op" id="1358465">:=</span>&nbsp;<span class="builtinfunc" id="1358468">copy</span><span class="op" id="1358472">(</span><span class="ident" id="1358473">bi</span><span class="op" id="1358475">,</span>&nbsp;<span class="ident" id="1358477">r</span><span class="op" id="1358478">[</span><span class="ident" id="1358479">b</span><span class="op" id="1358480">]</span><span class="op" id="1358481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1358486">bi</span>&nbsp;<span class="op" id="1358489">=</span>&nbsp;<span class="ident" id="1358491">bi</span><span class="op" id="1358493">[</span><span class="ident" id="1358494">n</span><span class="op" id="1358495">:</span><span class="op" id="1358496">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1358500">}</span>&nbsp;<span class="keyword" id="1358502">else</span>&nbsp;<span class="op" id="1358507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1358512">bi</span><span class="op" id="1358514">[</span><span class="num" id="1358515">0</span><span class="op" id="1358516">]</span>&nbsp;<span class="op" id="1358518">=</span>&nbsp;<span class="ident" id="1358520">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1358525">bi</span>&nbsp;<span class="op" id="1358528">=</span>&nbsp;<span class="ident" id="1358530">bi</span><span class="op" id="1358532">[</span><span class="num" id="1358533">1</span><span class="op" id="1358534">:</span><span class="op" id="1358535">]</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1358539">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1358542">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1358545">return</span>&nbsp;<span class="builtintype" id="1358552">string</span><span class="op" id="1358558">(</span><span class="ident" id="1358559">buf</span><span class="op" id="1358562">)</span><br>
<span class="lineno"></span><span class="op" id="1358564">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">490</span><span class="keyword" id="1358567">func</span>&nbsp;<span class="op" id="1358572">(</span><span class="ident" id="1358573">r</span>&nbsp;<span class="op" id="1358575">*</span><span class="ident" id="1358576">byteStringReplacer</span><span class="op" id="1358594">)</span>&nbsp;<span class="ident" id="1358596">WriteString</span><span class="op" id="1358607">(</span><span class="ident" id="1358608">w</span>&nbsp;<span class="ident" id="1358610">io</span><span class="op" id="1358612">.</span><span class="ident" id="1358613">Writer</span><span class="op" id="1358619">,</span>&nbsp;<span class="ident" id="1358621">s</span>&nbsp;<span class="builtintype" id="1358623">string</span><span class="op" id="1358629">)</span>&nbsp;<span class="op" id="1358631">(</span><span class="ident" id="1358632">n</span>&nbsp;<span class="builtintype" id="1358634">int</span><span class="op" id="1358637">,</span>&nbsp;<span class="ident" id="1358639">err</span>&nbsp;<span class="builtintype" id="1358643">error</span><span class="op" id="1358648">)</span>&nbsp;<span class="op" id="1358650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1358653">sw</span>&nbsp;<span class="op" id="1358656">:=</span>&nbsp;<span class="ident" id="1358659">getStringWriter</span><span class="op" id="1358674">(</span><span class="ident" id="1358675">w</span><span class="op" id="1358676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1358679">last</span>&nbsp;<span class="op" id="1358684">:=</span>&nbsp;<span class="num" id="1358687">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1358690">for</span>&nbsp;<span class="ident" id="1358694">i</span>&nbsp;<span class="op" id="1358696">:=</span>&nbsp;<span class="num" id="1358699">0</span><span class="op" id="1358700">;</span>&nbsp;<span class="ident" id="1358702">i</span>&nbsp;<span class="op" id="1358704">&lt;</span>&nbsp;<span class="builtinfunc" id="1358706">len</span><span class="op" id="1358709">(</span><span class="ident" id="1358710">s</span><span class="op" id="1358711">)</span><span class="op" id="1358712">;</span>&nbsp;<span class="ident" id="1358714">i</span><span class="op" id="1358715">++</span>&nbsp;<span class="op" id="1358718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1358722">b</span>&nbsp;<span class="op" id="1358724">:=</span>&nbsp;<span class="ident" id="1358727">s</span><span class="op" id="1358728">[</span><span class="ident" id="1358729">i</span><span class="op" id="1358730">]</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1358734">if</span>&nbsp;<span class="ident" id="1358737">r</span><span class="op" id="1358738">[</span><span class="ident" id="1358739">b</span><span class="op" id="1358740">]</span>&nbsp;<span class="op" id="1358742">==</span>&nbsp;<span class="builtintype" id="1358745">nil</span>&nbsp;<span class="op" id="1358749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1358754">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1358765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1358769">if</span>&nbsp;<span class="ident" id="1358772">last</span>&nbsp;<span class="op" id="1358777">!=</span>&nbsp;<span class="ident" id="1358780">i</span>&nbsp;<span class="op" id="1358782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1358787">nw</span><span class="op" id="1358789">,</span>&nbsp;<span class="ident" id="1358791">err</span>&nbsp;<span class="op" id="1358795">:=</span>&nbsp;<span class="ident" id="1358798">sw</span><span class="op" id="1358800">.</span><span class="ident" id="1358801">WriteString</span><span class="op" id="1358812">(</span><span class="ident" id="1358813">s</span><span class="op" id="1358814">[</span><span class="ident" id="1358815">last</span><span class="op" id="1358819">:</span><span class="ident" id="1358820">i</span><span class="op" id="1358821">]</span><span class="op" id="1358822">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1358827">n</span>&nbsp;<span class="op" id="1358829">+=</span>&nbsp;<span class="ident" id="1358832">nw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1358838">if</span>&nbsp;<span class="ident" id="1358841">err</span>&nbsp;<span class="op" id="1358845">!=</span>&nbsp;<span class="builtintype" id="1358848">nil</span>&nbsp;<span class="op" id="1358852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1358858">return</span>&nbsp;<span class="ident" id="1358865">n</span><span class="op" id="1358866">,</span>&nbsp;<span class="ident" id="1358868">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1358875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1358879">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1358883">last</span>&nbsp;<span class="op" id="1358888">=</span>&nbsp;<span class="ident" id="1358890">i</span>&nbsp;<span class="op" id="1358892">+</span>&nbsp;<span class="num" id="1358894">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1358898">nw</span><span class="op" id="1358900">,</span>&nbsp;<span class="ident" id="1358902">err</span>&nbsp;<span class="op" id="1358906">:=</span>&nbsp;<span class="ident" id="1358909">w</span><span class="op" id="1358910">.</span><span class="ident" id="1358911">Write</span><span class="op" id="1358916">(</span><span class="ident" id="1358917">r</span><span class="op" id="1358918">[</span><span class="ident" id="1358919">b</span><span class="op" id="1358920">]</span><span class="op" id="1358921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1358925">n</span>&nbsp;<span class="op" id="1358927">+=</span>&nbsp;<span class="ident" id="1358930">nw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1358935">if</span>&nbsp;<span class="ident" id="1358938">err</span>&nbsp;<span class="op" id="1358942">!=</span>&nbsp;<span class="builtintype" id="1358945">nil</span>&nbsp;<span class="op" id="1358949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1358954">return</span>&nbsp;<span class="ident" id="1358961">n</span><span class="op" id="1358962">,</span>&nbsp;<span class="ident" id="1358964">err</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1358970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1358973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1358976">if</span>&nbsp;<span class="ident" id="1358979">last</span>&nbsp;<span class="op" id="1358984">!=</span>&nbsp;<span class="builtinfunc" id="1358987">len</span><span class="op" id="1358990">(</span><span class="ident" id="1358991">s</span><span class="op" id="1358992">)</span>&nbsp;<span class="op" id="1358994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1358998">var</span>&nbsp;<span class="ident" id="1359002">nw</span>&nbsp;<span class="builtintype" id="1359005">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1359011">nw</span><span class="op" id="1359013">,</span>&nbsp;<span class="ident" id="1359015">err</span>&nbsp;<span class="op" id="1359019">=</span>&nbsp;<span class="ident" id="1359021">sw</span><span class="op" id="1359023">.</span><span class="ident" id="1359024">WriteString</span><span class="op" id="1359035">(</span><span class="ident" id="1359036">s</span><span class="op" id="1359037">[</span><span class="ident" id="1359038">last</span><span class="op" id="1359042">:</span><span class="op" id="1359043">]</span><span class="op" id="1359044">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1359048">n</span>&nbsp;<span class="op" id="1359050">+=</span>&nbsp;<span class="ident" id="1359053">nw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1359057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1359060">return</span><br>
<span class="lineno"></span><span class="op" id="1359067">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
