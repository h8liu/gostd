<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="7549051">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7549106">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7549160">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7549211">package</span>&nbsp;<span class="ident" id="7549219">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7549224">import</span>&nbsp;<span class="op" id="7549231">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7549234">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7549241">&#34;io&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7549247">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7549260">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7549271">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7549282">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7549289">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="7549292">func</span>&nbsp;<span class="ident" id="7549297">isTimeout</span><span class="op" id="7549306">(</span><span class="ident" id="7549307">err</span>&nbsp;<span class="builtintype" id="7549311">error</span><span class="op" id="7549316">)</span>&nbsp;<span class="builtintype" id="7549318">bool</span>&nbsp;<span class="op" id="7549323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7549326">e</span><span class="op" id="7549327">,</span>&nbsp;<span class="ident" id="7549329">ok</span>&nbsp;<span class="op" id="7549332">:=</span>&nbsp;<span class="ident" id="7549335">err</span><span class="op" id="7549338">.</span><span class="op" id="7549339">(</span><span class="ident" id="7549340">Error</span><span class="op" id="7549345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7549348">return</span>&nbsp;<span class="ident" id="7549355">ok</span>&nbsp;<span class="op" id="7549358">&amp;&amp;</span>&nbsp;<span class="ident" id="7549361">e</span><span class="op" id="7549362">.</span><span class="ident" id="7549363">Timeout</span><span class="op" id="7549370">(</span><span class="op" id="7549371">)</span><br>
<span class="lineno"></span><span class="op" id="7549373">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="7549376">type</span>&nbsp;<span class="ident" id="7549381">copyRes</span>&nbsp;<span class="keyword" id="7549389">struct</span>&nbsp;<span class="op" id="7549396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7549399">n</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="7549403">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7549410">err</span>&nbsp;<span class="builtintype" id="7549414">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7549421">d</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="7549425">time</span><span class="op" id="7549429">.</span><span class="ident" id="7549430">Duration</span><br>
<span class="lineno">25</span><span class="op" id="7549439">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7549442">func</span>&nbsp;<span class="ident" id="7549447">TestAcceptTimeout</span><span class="op" id="7549464">(</span><span class="ident" id="7549465">t</span>&nbsp;<span class="op" id="7549467">*</span><span class="ident" id="7549468">testing</span><span class="op" id="7549475">.</span><span class="ident" id="7549476">T</span><span class="op" id="7549477">)</span>&nbsp;<span class="op" id="7549479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7549482">switch</span>&nbsp;<span class="ident" id="7549489">runtime</span><span class="op" id="7549496">.</span><span class="ident" id="7549497">GOOS</span>&nbsp;<span class="op" id="7549502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7549505">case</span>&nbsp;<span class="string" id="7549510">&#34;plan9&#34;</span><span class="op" id="7549517">:</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7549521">t</span><span class="op" id="7549522">.</span><span class="ident" id="7549523">Skipf</span><span class="op" id="7549528">(</span><span class="string" id="7549529">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="7549550">,</span>&nbsp;<span class="ident" id="7549552">runtime</span><span class="op" id="7549559">.</span><span class="ident" id="7549560">GOOS</span><span class="op" id="7549564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7549567">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7549571">ln</span>&nbsp;<span class="op" id="7549574">:=</span>&nbsp;<span class="ident" id="7549577">newLocalListener</span><span class="op" id="7549593">(</span><span class="ident" id="7549594">t</span><span class="op" id="7549595">)</span><span class="op" id="7549596">.</span><span class="op" id="7549597">(</span><span class="op" id="7549598">*</span><span class="ident" id="7549599">TCPListener</span><span class="op" id="7549610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7549613">defer</span>&nbsp;<span class="ident" id="7549619">ln</span><span class="op" id="7549621">.</span><span class="ident" id="7549622">Close</span><span class="op" id="7549627">(</span><span class="op" id="7549628">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7549631">ln</span><span class="op" id="7549633">.</span><span class="ident" id="7549634">SetDeadline</span><span class="op" id="7549645">(</span><span class="ident" id="7549646">time</span><span class="op" id="7549650">.</span><span class="ident" id="7549651">Now</span><span class="op" id="7549654">(</span><span class="op" id="7549655">)</span><span class="op" id="7549656">.</span><span class="ident" id="7549657">Add</span><span class="op" id="7549660">(</span><span class="op" id="7549661">-</span><span class="num" id="7549662">1</span>&nbsp;<span class="op" id="7549664">*</span>&nbsp;<span class="ident" id="7549666">time</span><span class="op" id="7549670">.</span><span class="ident" id="7549671">Second</span><span class="op" id="7549677">)</span><span class="op" id="7549678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7549681">if</span>&nbsp;<span class="ident" id="7549684">_</span><span class="op" id="7549685">,</span>&nbsp;<span class="ident" id="7549687">err</span>&nbsp;<span class="op" id="7549691">:=</span>&nbsp;<span class="ident" id="7549694">ln</span><span class="op" id="7549696">.</span><span class="ident" id="7549697">Accept</span><span class="op" id="7549703">(</span><span class="op" id="7549704">)</span><span class="op" id="7549705">;</span>&nbsp;<span class="op" id="7549707">!</span><span class="ident" id="7549708">isTimeout</span><span class="op" id="7549717">(</span><span class="ident" id="7549718">err</span><span class="op" id="7549721">)</span>&nbsp;<span class="op" id="7549723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7549727">t</span><span class="op" id="7549728">.</span><span class="ident" id="7549729">Fatalf</span><span class="op" id="7549735">(</span><span class="string" id="7549736">&#34;Accept:&nbsp;expected&nbsp;err&nbsp;%v,&nbsp;got&nbsp;%v&#34;</span><span class="op" id="7549769">,</span>&nbsp;<span class="ident" id="7549771">errTimeout</span><span class="op" id="7549781">,</span>&nbsp;<span class="ident" id="7549783">err</span><span class="op" id="7549786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7549789">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7549792">if</span>&nbsp;<span class="ident" id="7549795">_</span><span class="op" id="7549796">,</span>&nbsp;<span class="ident" id="7549798">err</span>&nbsp;<span class="op" id="7549802">:=</span>&nbsp;<span class="ident" id="7549805">ln</span><span class="op" id="7549807">.</span><span class="ident" id="7549808">Accept</span><span class="op" id="7549814">(</span><span class="op" id="7549815">)</span><span class="op" id="7549816">;</span>&nbsp;<span class="op" id="7549818">!</span><span class="ident" id="7549819">isTimeout</span><span class="op" id="7549828">(</span><span class="ident" id="7549829">err</span><span class="op" id="7549832">)</span>&nbsp;<span class="op" id="7549834">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7549838">t</span><span class="op" id="7549839">.</span><span class="ident" id="7549840">Fatalf</span><span class="op" id="7549846">(</span><span class="string" id="7549847">&#34;Accept:&nbsp;expected&nbsp;err&nbsp;%v,&nbsp;got&nbsp;%v&#34;</span><span class="op" id="7549880">,</span>&nbsp;<span class="ident" id="7549882">errTimeout</span><span class="op" id="7549892">,</span>&nbsp;<span class="ident" id="7549894">err</span><span class="op" id="7549897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7549900">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7549903">ln</span><span class="op" id="7549905">.</span><span class="ident" id="7549906">SetDeadline</span><span class="op" id="7549917">(</span><span class="ident" id="7549918">time</span><span class="op" id="7549922">.</span><span class="ident" id="7549923">Now</span><span class="op" id="7549926">(</span><span class="op" id="7549927">)</span><span class="op" id="7549928">.</span><span class="ident" id="7549929">Add</span><span class="op" id="7549932">(</span><span class="num" id="7549933">100</span>&nbsp;<span class="op" id="7549937">*</span>&nbsp;<span class="ident" id="7549939">time</span><span class="op" id="7549943">.</span><span class="ident" id="7549944">Millisecond</span><span class="op" id="7549955">)</span><span class="op" id="7549956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7549959">if</span>&nbsp;<span class="ident" id="7549962">_</span><span class="op" id="7549963">,</span>&nbsp;<span class="ident" id="7549965">err</span>&nbsp;<span class="op" id="7549969">:=</span>&nbsp;<span class="ident" id="7549972">ln</span><span class="op" id="7549974">.</span><span class="ident" id="7549975">Accept</span><span class="op" id="7549981">(</span><span class="op" id="7549982">)</span><span class="op" id="7549983">;</span>&nbsp;<span class="op" id="7549985">!</span><span class="ident" id="7549986">isTimeout</span><span class="op" id="7549995">(</span><span class="ident" id="7549996">err</span><span class="op" id="7549999">)</span>&nbsp;<span class="op" id="7550001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7550005">t</span><span class="op" id="7550006">.</span><span class="ident" id="7550007">Fatalf</span><span class="op" id="7550013">(</span><span class="string" id="7550014">&#34;Accept:&nbsp;expected&nbsp;err&nbsp;%v,&nbsp;got&nbsp;%v&#34;</span><span class="op" id="7550047">,</span>&nbsp;<span class="ident" id="7550049">errTimeout</span><span class="op" id="7550059">,</span>&nbsp;<span class="ident" id="7550061">err</span><span class="op" id="7550064">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7550067">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7550070">if</span>&nbsp;<span class="ident" id="7550073">_</span><span class="op" id="7550074">,</span>&nbsp;<span class="ident" id="7550076">err</span>&nbsp;<span class="op" id="7550080">:=</span>&nbsp;<span class="ident" id="7550083">ln</span><span class="op" id="7550085">.</span><span class="ident" id="7550086">Accept</span><span class="op" id="7550092">(</span><span class="op" id="7550093">)</span><span class="op" id="7550094">;</span>&nbsp;<span class="op" id="7550096">!</span><span class="ident" id="7550097">isTimeout</span><span class="op" id="7550106">(</span><span class="ident" id="7550107">err</span><span class="op" id="7550110">)</span>&nbsp;<span class="op" id="7550112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7550116">t</span><span class="op" id="7550117">.</span><span class="ident" id="7550118">Fatalf</span><span class="op" id="7550124">(</span><span class="string" id="7550125">&#34;Accept:&nbsp;expected&nbsp;err&nbsp;%v,&nbsp;got&nbsp;%v&#34;</span><span class="op" id="7550158">,</span>&nbsp;<span class="ident" id="7550160">errTimeout</span><span class="op" id="7550170">,</span>&nbsp;<span class="ident" id="7550172">err</span><span class="op" id="7550175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7550178">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7550181">ln</span><span class="op" id="7550183">.</span><span class="ident" id="7550184">SetDeadline</span><span class="op" id="7550195">(</span><span class="ident" id="7550196">noDeadline</span><span class="op" id="7550206">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7550209">errc</span>&nbsp;<span class="op" id="7550214">:=</span>&nbsp;<span class="builtinfunc" id="7550217">make</span><span class="op" id="7550221">(</span><span class="keyword" id="7550222">chan</span>&nbsp;<span class="builtintype" id="7550227">error</span><span class="op" id="7550232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7550235">go</span>&nbsp;<span class="keyword" id="7550238">func</span><span class="op" id="7550242">(</span><span class="op" id="7550243">)</span>&nbsp;<span class="op" id="7550245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7550249">_</span><span class="op" id="7550250">,</span>&nbsp;<span class="ident" id="7550252">err</span>&nbsp;<span class="op" id="7550256">:=</span>&nbsp;<span class="ident" id="7550259">ln</span><span class="op" id="7550261">.</span><span class="ident" id="7550262">Accept</span><span class="op" id="7550268">(</span><span class="op" id="7550269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7550273">errc</span>&nbsp;<span class="op" id="7550278">&lt;-</span>&nbsp;<span class="ident" id="7550281">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7550286">}</span><span class="op" id="7550287">(</span><span class="op" id="7550288">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7550291">time</span><span class="op" id="7550295">.</span><span class="ident" id="7550296">Sleep</span><span class="op" id="7550301">(</span><span class="num" id="7550302">100</span>&nbsp;<span class="op" id="7550306">*</span>&nbsp;<span class="ident" id="7550308">time</span><span class="op" id="7550312">.</span><span class="ident" id="7550313">Millisecond</span><span class="op" id="7550324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7550327">select</span>&nbsp;<span class="op" id="7550334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7550337">case</span>&nbsp;<span class="ident" id="7550342">err</span>&nbsp;<span class="op" id="7550346">:=</span>&nbsp;<span class="op" id="7550349">&lt;-</span><span class="ident" id="7550351">errc</span><span class="op" id="7550355">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7550359">t</span><span class="op" id="7550360">.</span><span class="ident" id="7550361">Fatalf</span><span class="op" id="7550367">(</span><span class="string" id="7550368">&#34;Expected&nbsp;Accept()&nbsp;to&nbsp;not&nbsp;return,&nbsp;but&nbsp;it&nbsp;returned&nbsp;with&nbsp;%v\n&#34;</span><span class="op" id="7550428">,</span>&nbsp;<span class="ident" id="7550430">err</span><span class="op" id="7550433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7550436">default</span><span class="op" id="7550443">:</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7550446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7550449">ln</span><span class="op" id="7550451">.</span><span class="ident" id="7550452">Close</span><span class="op" id="7550457">(</span><span class="op" id="7550458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7550461">switch</span>&nbsp;<span class="ident" id="7550468">nerr</span>&nbsp;<span class="op" id="7550473">:=</span>&nbsp;<span class="op" id="7550476">&lt;-</span><span class="ident" id="7550478">errc</span><span class="op" id="7550482">;</span>&nbsp;<span class="ident" id="7550484">err</span>&nbsp;<span class="op" id="7550488">:=</span>&nbsp;<span class="ident" id="7550491">nerr</span><span class="op" id="7550495">.</span><span class="op" id="7550496">(</span><span class="keyword" id="7550497">type</span><span class="op" id="7550501">)</span>&nbsp;<span class="op" id="7550503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7550506">case</span>&nbsp;<span class="op" id="7550511">*</span><span class="ident" id="7550512">OpError</span><span class="op" id="7550519">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7550523">if</span>&nbsp;<span class="ident" id="7550526">err</span><span class="op" id="7550529">.</span><span class="ident" id="7550530">Err</span>&nbsp;<span class="op" id="7550534">!=</span>&nbsp;<span class="ident" id="7550537">errClosing</span>&nbsp;<span class="op" id="7550548">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7550553">t</span><span class="op" id="7550554">.</span><span class="ident" id="7550555">Fatalf</span><span class="op" id="7550561">(</span><span class="string" id="7550562">&#34;Accept:&nbsp;expected&nbsp;err&nbsp;%v,&nbsp;got&nbsp;%v&#34;</span><span class="op" id="7550595">,</span>&nbsp;<span class="ident" id="7550597">errClosing</span><span class="op" id="7550607">,</span>&nbsp;<span class="ident" id="7550609">err</span><span class="op" id="7550612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7550616">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7550619">default</span><span class="op" id="7550626">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7550630">if</span>&nbsp;<span class="ident" id="7550633">err</span>&nbsp;<span class="op" id="7550637">!=</span>&nbsp;<span class="ident" id="7550640">errClosing</span>&nbsp;<span class="op" id="7550651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7550656">t</span><span class="op" id="7550657">.</span><span class="ident" id="7550658">Fatalf</span><span class="op" id="7550664">(</span><span class="string" id="7550665">&#34;Accept:&nbsp;expected&nbsp;err&nbsp;%v,&nbsp;got&nbsp;%v&#34;</span><span class="op" id="7550698">,</span>&nbsp;<span class="ident" id="7550700">errClosing</span><span class="op" id="7550710">,</span>&nbsp;<span class="ident" id="7550712">err</span><span class="op" id="7550715">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7550719">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7550722">}</span><br>
<span class="lineno"></span><span class="op" id="7550724">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7550727">func</span>&nbsp;<span class="ident" id="7550732">TestReadTimeout</span><span class="op" id="7550747">(</span><span class="ident" id="7550748">t</span>&nbsp;<span class="op" id="7550750">*</span><span class="ident" id="7550751">testing</span><span class="op" id="7550758">.</span><span class="ident" id="7550759">T</span><span class="op" id="7550760">)</span>&nbsp;<span class="op" id="7550762">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7550765">switch</span>&nbsp;<span class="ident" id="7550772">runtime</span><span class="op" id="7550779">.</span><span class="ident" id="7550780">GOOS</span>&nbsp;<span class="op" id="7550785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7550788">case</span>&nbsp;<span class="string" id="7550793">&#34;plan9&#34;</span><span class="op" id="7550800">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7550804">t</span><span class="op" id="7550805">.</span><span class="ident" id="7550806">Skipf</span><span class="op" id="7550811">(</span><span class="string" id="7550812">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="7550833">,</span>&nbsp;<span class="ident" id="7550835">runtime</span><span class="op" id="7550842">.</span><span class="ident" id="7550843">GOOS</span><span class="op" id="7550847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7550850">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7550854">ln</span>&nbsp;<span class="op" id="7550857">:=</span>&nbsp;<span class="ident" id="7550860">newLocalListener</span><span class="op" id="7550876">(</span><span class="ident" id="7550877">t</span><span class="op" id="7550878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7550881">defer</span>&nbsp;<span class="ident" id="7550887">ln</span><span class="op" id="7550889">.</span><span class="ident" id="7550890">Close</span><span class="op" id="7550895">(</span><span class="op" id="7550896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7550899">c</span><span class="op" id="7550900">,</span>&nbsp;<span class="ident" id="7550902">err</span>&nbsp;<span class="op" id="7550906">:=</span>&nbsp;<span class="ident" id="7550909">DialTCP</span><span class="op" id="7550916">(</span><span class="string" id="7550917">&#34;tcp&#34;</span><span class="op" id="7550922">,</span>&nbsp;<span class="ident" id="7550924">nil</span><span class="op" id="7550927">,</span>&nbsp;<span class="ident" id="7550929">ln</span><span class="op" id="7550931">.</span><span class="ident" id="7550932">Addr</span><span class="op" id="7550936">(</span><span class="op" id="7550937">)</span><span class="op" id="7550938">.</span><span class="op" id="7550939">(</span><span class="op" id="7550940">*</span><span class="ident" id="7550941">TCPAddr</span><span class="op" id="7550948">)</span><span class="op" id="7550949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7550952">if</span>&nbsp;<span class="ident" id="7550955">err</span>&nbsp;<span class="op" id="7550959">!=</span>&nbsp;<span class="ident" id="7550962">nil</span>&nbsp;<span class="op" id="7550966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7550970">t</span><span class="op" id="7550971">.</span><span class="ident" id="7550972">Fatalf</span><span class="op" id="7550978">(</span><span class="string" id="7550979">&#34;Connect:&nbsp;%v&#34;</span><span class="op" id="7550992">,</span>&nbsp;<span class="ident" id="7550994">err</span><span class="op" id="7550997">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7551000">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7551003">defer</span>&nbsp;<span class="ident" id="7551009">c</span><span class="op" id="7551010">.</span><span class="ident" id="7551011">Close</span><span class="op" id="7551016">(</span><span class="op" id="7551017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7551020">c</span><span class="op" id="7551021">.</span><span class="ident" id="7551022">SetDeadline</span><span class="op" id="7551033">(</span><span class="ident" id="7551034">time</span><span class="op" id="7551038">.</span><span class="ident" id="7551039">Now</span><span class="op" id="7551042">(</span><span class="op" id="7551043">)</span><span class="op" id="7551044">.</span><span class="ident" id="7551045">Add</span><span class="op" id="7551048">(</span><span class="ident" id="7551049">time</span><span class="op" id="7551053">.</span><span class="ident" id="7551054">Hour</span><span class="op" id="7551058">)</span><span class="op" id="7551059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7551062">c</span><span class="op" id="7551063">.</span><span class="ident" id="7551064">SetReadDeadline</span><span class="op" id="7551079">(</span><span class="ident" id="7551080">time</span><span class="op" id="7551084">.</span><span class="ident" id="7551085">Now</span><span class="op" id="7551088">(</span><span class="op" id="7551089">)</span><span class="op" id="7551090">.</span><span class="ident" id="7551091">Add</span><span class="op" id="7551094">(</span><span class="op" id="7551095">-</span><span class="num" id="7551096">1</span>&nbsp;<span class="op" id="7551098">*</span>&nbsp;<span class="ident" id="7551100">time</span><span class="op" id="7551104">.</span><span class="ident" id="7551105">Second</span><span class="op" id="7551111">)</span><span class="op" id="7551112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7551115">buf</span>&nbsp;<span class="op" id="7551119">:=</span>&nbsp;<span class="builtinfunc" id="7551122">make</span><span class="op" id="7551126">(</span><span class="op" id="7551127">[</span><span class="op" id="7551128">]</span><span class="builtintype" id="7551129">byte</span><span class="op" id="7551133">,</span>&nbsp;<span class="num" id="7551135">1</span><span class="op" id="7551136">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7551139">if</span>&nbsp;<span class="ident" id="7551142">_</span><span class="op" id="7551143">,</span>&nbsp;<span class="ident" id="7551145">err</span>&nbsp;<span class="op" id="7551149">=</span>&nbsp;<span class="ident" id="7551151">c</span><span class="op" id="7551152">.</span><span class="ident" id="7551153">Read</span><span class="op" id="7551157">(</span><span class="ident" id="7551158">buf</span><span class="op" id="7551161">)</span><span class="op" id="7551162">;</span>&nbsp;<span class="op" id="7551164">!</span><span class="ident" id="7551165">isTimeout</span><span class="op" id="7551174">(</span><span class="ident" id="7551175">err</span><span class="op" id="7551178">)</span>&nbsp;<span class="op" id="7551180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7551184">t</span><span class="op" id="7551185">.</span><span class="ident" id="7551186">Fatalf</span><span class="op" id="7551192">(</span><span class="string" id="7551193">&#34;Read:&nbsp;expected&nbsp;err&nbsp;%v,&nbsp;got&nbsp;%v&#34;</span><span class="op" id="7551224">,</span>&nbsp;<span class="ident" id="7551226">errTimeout</span><span class="op" id="7551236">,</span>&nbsp;<span class="ident" id="7551238">err</span><span class="op" id="7551241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7551244">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7551247">if</span>&nbsp;<span class="ident" id="7551250">_</span><span class="op" id="7551251">,</span>&nbsp;<span class="ident" id="7551253">err</span>&nbsp;<span class="op" id="7551257">=</span>&nbsp;<span class="ident" id="7551259">c</span><span class="op" id="7551260">.</span><span class="ident" id="7551261">Read</span><span class="op" id="7551265">(</span><span class="ident" id="7551266">buf</span><span class="op" id="7551269">)</span><span class="op" id="7551270">;</span>&nbsp;<span class="op" id="7551272">!</span><span class="ident" id="7551273">isTimeout</span><span class="op" id="7551282">(</span><span class="ident" id="7551283">err</span><span class="op" id="7551286">)</span>&nbsp;<span class="op" id="7551288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7551292">t</span><span class="op" id="7551293">.</span><span class="ident" id="7551294">Fatalf</span><span class="op" id="7551300">(</span><span class="string" id="7551301">&#34;Read:&nbsp;expected&nbsp;err&nbsp;%v,&nbsp;got&nbsp;%v&#34;</span><span class="op" id="7551332">,</span>&nbsp;<span class="ident" id="7551334">errTimeout</span><span class="op" id="7551344">,</span>&nbsp;<span class="ident" id="7551346">err</span><span class="op" id="7551349">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7551352">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7551355">c</span><span class="op" id="7551356">.</span><span class="ident" id="7551357">SetDeadline</span><span class="op" id="7551368">(</span><span class="ident" id="7551369">time</span><span class="op" id="7551373">.</span><span class="ident" id="7551374">Now</span><span class="op" id="7551377">(</span><span class="op" id="7551378">)</span><span class="op" id="7551379">.</span><span class="ident" id="7551380">Add</span><span class="op" id="7551383">(</span><span class="num" id="7551384">100</span>&nbsp;<span class="op" id="7551388">*</span>&nbsp;<span class="ident" id="7551390">time</span><span class="op" id="7551394">.</span><span class="ident" id="7551395">Millisecond</span><span class="op" id="7551406">)</span><span class="op" id="7551407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7551410">if</span>&nbsp;<span class="ident" id="7551413">_</span><span class="op" id="7551414">,</span>&nbsp;<span class="ident" id="7551416">err</span>&nbsp;<span class="op" id="7551420">=</span>&nbsp;<span class="ident" id="7551422">c</span><span class="op" id="7551423">.</span><span class="ident" id="7551424">Read</span><span class="op" id="7551428">(</span><span class="ident" id="7551429">buf</span><span class="op" id="7551432">)</span><span class="op" id="7551433">;</span>&nbsp;<span class="op" id="7551435">!</span><span class="ident" id="7551436">isTimeout</span><span class="op" id="7551445">(</span><span class="ident" id="7551446">err</span><span class="op" id="7551449">)</span>&nbsp;<span class="op" id="7551451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7551455">t</span><span class="op" id="7551456">.</span><span class="ident" id="7551457">Fatalf</span><span class="op" id="7551463">(</span><span class="string" id="7551464">&#34;Read:&nbsp;expected&nbsp;err&nbsp;%v,&nbsp;got&nbsp;%v&#34;</span><span class="op" id="7551495">,</span>&nbsp;<span class="ident" id="7551497">errTimeout</span><span class="op" id="7551507">,</span>&nbsp;<span class="ident" id="7551509">err</span><span class="op" id="7551512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7551515">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7551518">if</span>&nbsp;<span class="ident" id="7551521">_</span><span class="op" id="7551522">,</span>&nbsp;<span class="ident" id="7551524">err</span>&nbsp;<span class="op" id="7551528">=</span>&nbsp;<span class="ident" id="7551530">c</span><span class="op" id="7551531">.</span><span class="ident" id="7551532">Read</span><span class="op" id="7551536">(</span><span class="ident" id="7551537">buf</span><span class="op" id="7551540">)</span><span class="op" id="7551541">;</span>&nbsp;<span class="op" id="7551543">!</span><span class="ident" id="7551544">isTimeout</span><span class="op" id="7551553">(</span><span class="ident" id="7551554">err</span><span class="op" id="7551557">)</span>&nbsp;<span class="op" id="7551559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7551563">t</span><span class="op" id="7551564">.</span><span class="ident" id="7551565">Fatalf</span><span class="op" id="7551571">(</span><span class="string" id="7551572">&#34;Read:&nbsp;expected&nbsp;err&nbsp;%v,&nbsp;got&nbsp;%v&#34;</span><span class="op" id="7551603">,</span>&nbsp;<span class="ident" id="7551605">errTimeout</span><span class="op" id="7551615">,</span>&nbsp;<span class="ident" id="7551617">err</span><span class="op" id="7551620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7551623">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7551626">c</span><span class="op" id="7551627">.</span><span class="ident" id="7551628">SetReadDeadline</span><span class="op" id="7551643">(</span><span class="ident" id="7551644">noDeadline</span><span class="op" id="7551654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7551657">c</span><span class="op" id="7551658">.</span><span class="ident" id="7551659">SetWriteDeadline</span><span class="op" id="7551675">(</span><span class="ident" id="7551676">time</span><span class="op" id="7551680">.</span><span class="ident" id="7551681">Now</span><span class="op" id="7551684">(</span><span class="op" id="7551685">)</span><span class="op" id="7551686">.</span><span class="ident" id="7551687">Add</span><span class="op" id="7551690">(</span><span class="op" id="7551691">-</span><span class="num" id="7551692">1</span>&nbsp;<span class="op" id="7551694">*</span>&nbsp;<span class="ident" id="7551696">time</span><span class="op" id="7551700">.</span><span class="ident" id="7551701">Second</span><span class="op" id="7551707">)</span><span class="op" id="7551708">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7551711">errc</span>&nbsp;<span class="op" id="7551716">:=</span>&nbsp;<span class="builtinfunc" id="7551719">make</span><span class="op" id="7551723">(</span><span class="keyword" id="7551724">chan</span>&nbsp;<span class="builtintype" id="7551729">error</span><span class="op" id="7551734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7551737">go</span>&nbsp;<span class="keyword" id="7551740">func</span><span class="op" id="7551744">(</span><span class="op" id="7551745">)</span>&nbsp;<span class="op" id="7551747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7551751">_</span><span class="op" id="7551752">,</span>&nbsp;<span class="ident" id="7551754">err</span>&nbsp;<span class="op" id="7551758">:=</span>&nbsp;<span class="ident" id="7551761">c</span><span class="op" id="7551762">.</span><span class="ident" id="7551763">Read</span><span class="op" id="7551767">(</span><span class="ident" id="7551768">buf</span><span class="op" id="7551771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7551775">errc</span>&nbsp;<span class="op" id="7551780">&lt;-</span>&nbsp;<span class="ident" id="7551783">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7551788">}</span><span class="op" id="7551789">(</span><span class="op" id="7551790">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7551793">time</span><span class="op" id="7551797">.</span><span class="ident" id="7551798">Sleep</span><span class="op" id="7551803">(</span><span class="num" id="7551804">100</span>&nbsp;<span class="op" id="7551808">*</span>&nbsp;<span class="ident" id="7551810">time</span><span class="op" id="7551814">.</span><span class="ident" id="7551815">Millisecond</span><span class="op" id="7551826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7551829">select</span>&nbsp;<span class="op" id="7551836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7551839">case</span>&nbsp;<span class="ident" id="7551844">err</span>&nbsp;<span class="op" id="7551848">:=</span>&nbsp;<span class="op" id="7551851">&lt;-</span><span class="ident" id="7551853">errc</span><span class="op" id="7551857">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7551861">t</span><span class="op" id="7551862">.</span><span class="ident" id="7551863">Fatalf</span><span class="op" id="7551869">(</span><span class="string" id="7551870">&#34;Expected&nbsp;Read()&nbsp;to&nbsp;not&nbsp;return,&nbsp;but&nbsp;it&nbsp;returned&nbsp;with&nbsp;%v\n&#34;</span><span class="op" id="7551928">,</span>&nbsp;<span class="ident" id="7551930">err</span><span class="op" id="7551933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7551936">default</span><span class="op" id="7551943">:</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7551946">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7551949">c</span><span class="op" id="7551950">.</span><span class="ident" id="7551951">Close</span><span class="op" id="7551956">(</span><span class="op" id="7551957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7551960">switch</span>&nbsp;<span class="ident" id="7551967">nerr</span>&nbsp;<span class="op" id="7551972">:=</span>&nbsp;<span class="op" id="7551975">&lt;-</span><span class="ident" id="7551977">errc</span><span class="op" id="7551981">;</span>&nbsp;<span class="ident" id="7551983">err</span>&nbsp;<span class="op" id="7551987">:=</span>&nbsp;<span class="ident" id="7551990">nerr</span><span class="op" id="7551994">.</span><span class="op" id="7551995">(</span><span class="keyword" id="7551996">type</span><span class="op" id="7552000">)</span>&nbsp;<span class="op" id="7552002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7552005">case</span>&nbsp;<span class="op" id="7552010">*</span><span class="ident" id="7552011">OpError</span><span class="op" id="7552018">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7552022">if</span>&nbsp;<span class="ident" id="7552025">err</span><span class="op" id="7552028">.</span><span class="ident" id="7552029">Err</span>&nbsp;<span class="op" id="7552033">!=</span>&nbsp;<span class="ident" id="7552036">errClosing</span>&nbsp;<span class="op" id="7552047">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7552052">t</span><span class="op" id="7552053">.</span><span class="ident" id="7552054">Fatalf</span><span class="op" id="7552060">(</span><span class="string" id="7552061">&#34;Read:&nbsp;expected&nbsp;err&nbsp;%v,&nbsp;got&nbsp;%v&#34;</span><span class="op" id="7552092">,</span>&nbsp;<span class="ident" id="7552094">errClosing</span><span class="op" id="7552104">,</span>&nbsp;<span class="ident" id="7552106">err</span><span class="op" id="7552109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7552113">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7552116">default</span><span class="op" id="7552123">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7552127">if</span>&nbsp;<span class="ident" id="7552130">err</span>&nbsp;<span class="op" id="7552134">==</span>&nbsp;<span class="ident" id="7552137">io</span><span class="op" id="7552139">.</span><span class="ident" id="7552140">EOF</span>&nbsp;<span class="op" id="7552144">&amp;&amp;</span>&nbsp;<span class="ident" id="7552147">runtime</span><span class="op" id="7552154">.</span><span class="ident" id="7552155">GOOS</span>&nbsp;<span class="op" id="7552160">==</span>&nbsp;<span class="string" id="7552163">&#34;nacl&#34;</span>&nbsp;<span class="op" id="7552170">{</span>&nbsp;<span class="comment" id="7552172">//&nbsp;close&nbsp;enough;&nbsp;golang.org/issue/8044</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7552214">break</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7552222">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7552226">if</span>&nbsp;<span class="ident" id="7552229">err</span>&nbsp;<span class="op" id="7552233">!=</span>&nbsp;<span class="ident" id="7552236">errClosing</span>&nbsp;<span class="op" id="7552247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7552252">t</span><span class="op" id="7552253">.</span><span class="ident" id="7552254">Fatalf</span><span class="op" id="7552260">(</span><span class="string" id="7552261">&#34;Read:&nbsp;expected&nbsp;err&nbsp;%v,&nbsp;got&nbsp;%v&#34;</span><span class="op" id="7552292">,</span>&nbsp;<span class="ident" id="7552294">errClosing</span><span class="op" id="7552304">,</span>&nbsp;<span class="ident" id="7552306">err</span><span class="op" id="7552309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7552313">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7552316">}</span><br>
<span class="lineno">130</span><span class="op" id="7552318">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7552321">func</span>&nbsp;<span class="ident" id="7552326">TestWriteTimeout</span><span class="op" id="7552342">(</span><span class="ident" id="7552343">t</span>&nbsp;<span class="op" id="7552345">*</span><span class="ident" id="7552346">testing</span><span class="op" id="7552353">.</span><span class="ident" id="7552354">T</span><span class="op" id="7552355">)</span>&nbsp;<span class="op" id="7552357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7552360">switch</span>&nbsp;<span class="ident" id="7552367">runtime</span><span class="op" id="7552374">.</span><span class="ident" id="7552375">GOOS</span>&nbsp;<span class="op" id="7552380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7552383">case</span>&nbsp;<span class="string" id="7552388">&#34;plan9&#34;</span><span class="op" id="7552395">:</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7552399">t</span><span class="op" id="7552400">.</span><span class="ident" id="7552401">Skipf</span><span class="op" id="7552406">(</span><span class="string" id="7552407">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="7552428">,</span>&nbsp;<span class="ident" id="7552430">runtime</span><span class="op" id="7552437">.</span><span class="ident" id="7552438">GOOS</span><span class="op" id="7552442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7552445">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7552449">ln</span>&nbsp;<span class="op" id="7552452">:=</span>&nbsp;<span class="ident" id="7552455">newLocalListener</span><span class="op" id="7552471">(</span><span class="ident" id="7552472">t</span><span class="op" id="7552473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7552476">defer</span>&nbsp;<span class="ident" id="7552482">ln</span><span class="op" id="7552484">.</span><span class="ident" id="7552485">Close</span><span class="op" id="7552490">(</span><span class="op" id="7552491">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7552494">c</span><span class="op" id="7552495">,</span>&nbsp;<span class="ident" id="7552497">err</span>&nbsp;<span class="op" id="7552501">:=</span>&nbsp;<span class="ident" id="7552504">DialTCP</span><span class="op" id="7552511">(</span><span class="string" id="7552512">&#34;tcp&#34;</span><span class="op" id="7552517">,</span>&nbsp;<span class="ident" id="7552519">nil</span><span class="op" id="7552522">,</span>&nbsp;<span class="ident" id="7552524">ln</span><span class="op" id="7552526">.</span><span class="ident" id="7552527">Addr</span><span class="op" id="7552531">(</span><span class="op" id="7552532">)</span><span class="op" id="7552533">.</span><span class="op" id="7552534">(</span><span class="op" id="7552535">*</span><span class="ident" id="7552536">TCPAddr</span><span class="op" id="7552543">)</span><span class="op" id="7552544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7552547">if</span>&nbsp;<span class="ident" id="7552550">err</span>&nbsp;<span class="op" id="7552554">!=</span>&nbsp;<span class="ident" id="7552557">nil</span>&nbsp;<span class="op" id="7552561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7552565">t</span><span class="op" id="7552566">.</span><span class="ident" id="7552567">Fatalf</span><span class="op" id="7552573">(</span><span class="string" id="7552574">&#34;Connect:&nbsp;%v&#34;</span><span class="op" id="7552587">,</span>&nbsp;<span class="ident" id="7552589">err</span><span class="op" id="7552592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7552595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7552598">defer</span>&nbsp;<span class="ident" id="7552604">c</span><span class="op" id="7552605">.</span><span class="ident" id="7552606">Close</span><span class="op" id="7552611">(</span><span class="op" id="7552612">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7552615">c</span><span class="op" id="7552616">.</span><span class="ident" id="7552617">SetDeadline</span><span class="op" id="7552628">(</span><span class="ident" id="7552629">time</span><span class="op" id="7552633">.</span><span class="ident" id="7552634">Now</span><span class="op" id="7552637">(</span><span class="op" id="7552638">)</span><span class="op" id="7552639">.</span><span class="ident" id="7552640">Add</span><span class="op" id="7552643">(</span><span class="ident" id="7552644">time</span><span class="op" id="7552648">.</span><span class="ident" id="7552649">Hour</span><span class="op" id="7552653">)</span><span class="op" id="7552654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7552657">c</span><span class="op" id="7552658">.</span><span class="ident" id="7552659">SetWriteDeadline</span><span class="op" id="7552675">(</span><span class="ident" id="7552676">time</span><span class="op" id="7552680">.</span><span class="ident" id="7552681">Now</span><span class="op" id="7552684">(</span><span class="op" id="7552685">)</span><span class="op" id="7552686">.</span><span class="ident" id="7552687">Add</span><span class="op" id="7552690">(</span><span class="op" id="7552691">-</span><span class="num" id="7552692">1</span>&nbsp;<span class="op" id="7552694">*</span>&nbsp;<span class="ident" id="7552696">time</span><span class="op" id="7552700">.</span><span class="ident" id="7552701">Second</span><span class="op" id="7552707">)</span><span class="op" id="7552708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7552711">buf</span>&nbsp;<span class="op" id="7552715">:=</span>&nbsp;<span class="builtinfunc" id="7552718">make</span><span class="op" id="7552722">(</span><span class="op" id="7552723">[</span><span class="op" id="7552724">]</span><span class="builtintype" id="7552725">byte</span><span class="op" id="7552729">,</span>&nbsp;<span class="num" id="7552731">4096</span><span class="op" id="7552735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7552738">writeUntilTimeout</span>&nbsp;<span class="op" id="7552756">:=</span>&nbsp;<span class="keyword" id="7552759">func</span><span class="op" id="7552763">(</span><span class="op" id="7552764">)</span>&nbsp;<span class="op" id="7552766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7552770">for</span>&nbsp;<span class="op" id="7552774">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7552779">_</span><span class="op" id="7552780">,</span>&nbsp;<span class="ident" id="7552782">err</span>&nbsp;<span class="op" id="7552786">:=</span>&nbsp;<span class="ident" id="7552789">c</span><span class="op" id="7552790">.</span><span class="ident" id="7552791">Write</span><span class="op" id="7552796">(</span><span class="ident" id="7552797">buf</span><span class="op" id="7552800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7552805">if</span>&nbsp;<span class="ident" id="7552808">err</span>&nbsp;<span class="op" id="7552812">!=</span>&nbsp;<span class="ident" id="7552815">nil</span>&nbsp;<span class="op" id="7552819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7552825">if</span>&nbsp;<span class="ident" id="7552828">isTimeout</span><span class="op" id="7552837">(</span><span class="ident" id="7552838">err</span><span class="op" id="7552841">)</span>&nbsp;<span class="op" id="7552843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7552850">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7552861">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7552867">t</span><span class="op" id="7552868">.</span><span class="ident" id="7552869">Fatalf</span><span class="op" id="7552875">(</span><span class="string" id="7552876">&#34;Write:&nbsp;expected&nbsp;err&nbsp;%v,&nbsp;got&nbsp;%v&#34;</span><span class="op" id="7552908">,</span>&nbsp;<span class="ident" id="7552910">errTimeout</span><span class="op" id="7552920">,</span>&nbsp;<span class="ident" id="7552922">err</span><span class="op" id="7552925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7552930">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7552934">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7552937">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7552940">writeUntilTimeout</span><span class="op" id="7552957">(</span><span class="op" id="7552958">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7552961">c</span><span class="op" id="7552962">.</span><span class="ident" id="7552963">SetDeadline</span><span class="op" id="7552974">(</span><span class="ident" id="7552975">time</span><span class="op" id="7552979">.</span><span class="ident" id="7552980">Now</span><span class="op" id="7552983">(</span><span class="op" id="7552984">)</span><span class="op" id="7552985">.</span><span class="ident" id="7552986">Add</span><span class="op" id="7552989">(</span><span class="num" id="7552990">10</span>&nbsp;<span class="op" id="7552993">*</span>&nbsp;<span class="ident" id="7552995">time</span><span class="op" id="7552999">.</span><span class="ident" id="7553000">Millisecond</span><span class="op" id="7553011">)</span><span class="op" id="7553012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7553015">writeUntilTimeout</span><span class="op" id="7553032">(</span><span class="op" id="7553033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7553036">writeUntilTimeout</span><span class="op" id="7553053">(</span><span class="op" id="7553054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7553057">c</span><span class="op" id="7553058">.</span><span class="ident" id="7553059">SetWriteDeadline</span><span class="op" id="7553075">(</span><span class="ident" id="7553076">noDeadline</span><span class="op" id="7553086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7553089">c</span><span class="op" id="7553090">.</span><span class="ident" id="7553091">SetReadDeadline</span><span class="op" id="7553106">(</span><span class="ident" id="7553107">time</span><span class="op" id="7553111">.</span><span class="ident" id="7553112">Now</span><span class="op" id="7553115">(</span><span class="op" id="7553116">)</span><span class="op" id="7553117">.</span><span class="ident" id="7553118">Add</span><span class="op" id="7553121">(</span><span class="op" id="7553122">-</span><span class="num" id="7553123">1</span>&nbsp;<span class="op" id="7553125">*</span>&nbsp;<span class="ident" id="7553127">time</span><span class="op" id="7553131">.</span><span class="ident" id="7553132">Second</span><span class="op" id="7553138">)</span><span class="op" id="7553139">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7553142">errc</span>&nbsp;<span class="op" id="7553147">:=</span>&nbsp;<span class="builtinfunc" id="7553150">make</span><span class="op" id="7553154">(</span><span class="keyword" id="7553155">chan</span>&nbsp;<span class="builtintype" id="7553160">error</span><span class="op" id="7553165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7553168">go</span>&nbsp;<span class="keyword" id="7553171">func</span><span class="op" id="7553175">(</span><span class="op" id="7553176">)</span>&nbsp;<span class="op" id="7553178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7553182">for</span>&nbsp;<span class="op" id="7553186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7553191">_</span><span class="op" id="7553192">,</span>&nbsp;<span class="ident" id="7553194">err</span>&nbsp;<span class="op" id="7553198">:=</span>&nbsp;<span class="ident" id="7553201">c</span><span class="op" id="7553202">.</span><span class="ident" id="7553203">Write</span><span class="op" id="7553208">(</span><span class="ident" id="7553209">buf</span><span class="op" id="7553212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7553217">if</span>&nbsp;<span class="ident" id="7553220">err</span>&nbsp;<span class="op" id="7553224">!=</span>&nbsp;<span class="ident" id="7553227">nil</span>&nbsp;<span class="op" id="7553231">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7553237">errc</span>&nbsp;<span class="op" id="7553242">&lt;-</span>&nbsp;<span class="ident" id="7553245">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7553252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7553256">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7553259">}</span><span class="op" id="7553260">(</span><span class="op" id="7553261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7553264">time</span><span class="op" id="7553268">.</span><span class="ident" id="7553269">Sleep</span><span class="op" id="7553274">(</span><span class="num" id="7553275">100</span>&nbsp;<span class="op" id="7553279">*</span>&nbsp;<span class="ident" id="7553281">time</span><span class="op" id="7553285">.</span><span class="ident" id="7553286">Millisecond</span><span class="op" id="7553297">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7553300">select</span>&nbsp;<span class="op" id="7553307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7553310">case</span>&nbsp;<span class="ident" id="7553315">err</span>&nbsp;<span class="op" id="7553319">:=</span>&nbsp;<span class="op" id="7553322">&lt;-</span><span class="ident" id="7553324">errc</span><span class="op" id="7553328">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7553332">t</span><span class="op" id="7553333">.</span><span class="ident" id="7553334">Fatalf</span><span class="op" id="7553340">(</span><span class="string" id="7553341">&#34;Expected&nbsp;Write()&nbsp;to&nbsp;not&nbsp;return,&nbsp;but&nbsp;it&nbsp;returned&nbsp;with&nbsp;%v\n&#34;</span><span class="op" id="7553400">,</span>&nbsp;<span class="ident" id="7553402">err</span><span class="op" id="7553405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7553408">default</span><span class="op" id="7553415">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7553418">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7553421">c</span><span class="op" id="7553422">.</span><span class="ident" id="7553423">Close</span><span class="op" id="7553428">(</span><span class="op" id="7553429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7553432">switch</span>&nbsp;<span class="ident" id="7553439">nerr</span>&nbsp;<span class="op" id="7553444">:=</span>&nbsp;<span class="op" id="7553447">&lt;-</span><span class="ident" id="7553449">errc</span><span class="op" id="7553453">;</span>&nbsp;<span class="ident" id="7553455">err</span>&nbsp;<span class="op" id="7553459">:=</span>&nbsp;<span class="ident" id="7553462">nerr</span><span class="op" id="7553466">.</span><span class="op" id="7553467">(</span><span class="keyword" id="7553468">type</span><span class="op" id="7553472">)</span>&nbsp;<span class="op" id="7553474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7553477">case</span>&nbsp;<span class="op" id="7553482">*</span><span class="ident" id="7553483">OpError</span><span class="op" id="7553490">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7553494">if</span>&nbsp;<span class="ident" id="7553497">err</span><span class="op" id="7553500">.</span><span class="ident" id="7553501">Err</span>&nbsp;<span class="op" id="7553505">!=</span>&nbsp;<span class="ident" id="7553508">errClosing</span>&nbsp;<span class="op" id="7553519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7553524">t</span><span class="op" id="7553525">.</span><span class="ident" id="7553526">Fatalf</span><span class="op" id="7553532">(</span><span class="string" id="7553533">&#34;Write:&nbsp;expected&nbsp;err&nbsp;%v,&nbsp;got&nbsp;%v&#34;</span><span class="op" id="7553565">,</span>&nbsp;<span class="ident" id="7553567">errClosing</span><span class="op" id="7553577">,</span>&nbsp;<span class="ident" id="7553579">err</span><span class="op" id="7553582">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7553586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7553589">default</span><span class="op" id="7553596">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7553600">if</span>&nbsp;<span class="ident" id="7553603">err</span>&nbsp;<span class="op" id="7553607">!=</span>&nbsp;<span class="ident" id="7553610">errClosing</span>&nbsp;<span class="op" id="7553621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7553626">t</span><span class="op" id="7553627">.</span><span class="ident" id="7553628">Fatalf</span><span class="op" id="7553634">(</span><span class="string" id="7553635">&#34;Write:&nbsp;expected&nbsp;err&nbsp;%v,&nbsp;got&nbsp;%v&#34;</span><span class="op" id="7553667">,</span>&nbsp;<span class="ident" id="7553669">errClosing</span><span class="op" id="7553679">,</span>&nbsp;<span class="ident" id="7553681">err</span><span class="op" id="7553684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7553688">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7553691">}</span><br>
<span class="lineno"></span><span class="op" id="7553693">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7553696">func</span>&nbsp;<span class="ident" id="7553701">testTimeout</span><span class="op" id="7553712">(</span><span class="ident" id="7553713">t</span>&nbsp;<span class="op" id="7553715">*</span><span class="ident" id="7553716">testing</span><span class="op" id="7553723">.</span><span class="ident" id="7553724">T</span><span class="op" id="7553725">,</span>&nbsp;<span class="ident" id="7553727">net</span><span class="op" id="7553730">,</span>&nbsp;<span class="ident" id="7553732">addr</span>&nbsp;<span class="builtintype" id="7553737">string</span><span class="op" id="7553743">,</span>&nbsp;<span class="ident" id="7553745">readFrom</span>&nbsp;<span class="builtintype" id="7553754">bool</span><span class="op" id="7553758">)</span>&nbsp;<span class="op" id="7553760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7553763">c</span><span class="op" id="7553764">,</span>&nbsp;<span class="ident" id="7553766">err</span>&nbsp;<span class="op" id="7553770">:=</span>&nbsp;<span class="ident" id="7553773">Dial</span><span class="op" id="7553777">(</span><span class="ident" id="7553778">net</span><span class="op" id="7553781">,</span>&nbsp;<span class="ident" id="7553783">addr</span><span class="op" id="7553787">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7553790">if</span>&nbsp;<span class="ident" id="7553793">err</span>&nbsp;<span class="op" id="7553797">!=</span>&nbsp;<span class="ident" id="7553800">nil</span>&nbsp;<span class="op" id="7553804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7553808">t</span><span class="op" id="7553809">.</span><span class="ident" id="7553810">Errorf</span><span class="op" id="7553816">(</span><span class="string" id="7553817">&#34;Dial(%q,&nbsp;%q)&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7553842">,</span>&nbsp;<span class="ident" id="7553844">net</span><span class="op" id="7553847">,</span>&nbsp;<span class="ident" id="7553849">addr</span><span class="op" id="7553853">,</span>&nbsp;<span class="ident" id="7553855">err</span><span class="op" id="7553858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7553862">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7553870">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7553873">defer</span>&nbsp;<span class="ident" id="7553879">c</span><span class="op" id="7553880">.</span><span class="ident" id="7553881">Close</span><span class="op" id="7553886">(</span><span class="op" id="7553887">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7553890">what</span>&nbsp;<span class="op" id="7553895">:=</span>&nbsp;<span class="string" id="7553898">&#34;Read&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7553906">if</span>&nbsp;<span class="ident" id="7553909">readFrom</span>&nbsp;<span class="op" id="7553918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7553922">what</span>&nbsp;<span class="op" id="7553927">=</span>&nbsp;<span class="string" id="7553929">&#34;ReadFrom&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7553941">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7553945">errc</span>&nbsp;<span class="op" id="7553950">:=</span>&nbsp;<span class="builtinfunc" id="7553953">make</span><span class="op" id="7553957">(</span><span class="keyword" id="7553958">chan</span>&nbsp;<span class="builtintype" id="7553963">error</span><span class="op" id="7553968">,</span>&nbsp;<span class="num" id="7553970">1</span><span class="op" id="7553971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7553974">go</span>&nbsp;<span class="keyword" id="7553977">func</span><span class="op" id="7553981">(</span><span class="op" id="7553982">)</span>&nbsp;<span class="op" id="7553984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7553988">t0</span>&nbsp;<span class="op" id="7553991">:=</span>&nbsp;<span class="ident" id="7553994">time</span><span class="op" id="7553998">.</span><span class="ident" id="7553999">Now</span><span class="op" id="7554002">(</span><span class="op" id="7554003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7554007">c</span><span class="op" id="7554008">.</span><span class="ident" id="7554009">SetReadDeadline</span><span class="op" id="7554024">(</span><span class="ident" id="7554025">time</span><span class="op" id="7554029">.</span><span class="ident" id="7554030">Now</span><span class="op" id="7554033">(</span><span class="op" id="7554034">)</span><span class="op" id="7554035">.</span><span class="ident" id="7554036">Add</span><span class="op" id="7554039">(</span><span class="num" id="7554040">100</span>&nbsp;<span class="op" id="7554044">*</span>&nbsp;<span class="ident" id="7554046">time</span><span class="op" id="7554050">.</span><span class="ident" id="7554051">Millisecond</span><span class="op" id="7554062">)</span><span class="op" id="7554063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7554067">var</span>&nbsp;<span class="ident" id="7554071">b</span>&nbsp;<span class="op" id="7554073">[</span><span class="num" id="7554074">100</span><span class="op" id="7554077">]</span><span class="builtintype" id="7554078">byte</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7554085">var</span>&nbsp;<span class="ident" id="7554089">n</span>&nbsp;<span class="builtintype" id="7554091">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7554097">var</span>&nbsp;<span class="ident" id="7554101">err</span>&nbsp;<span class="builtintype" id="7554105">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7554113">if</span>&nbsp;<span class="ident" id="7554116">readFrom</span>&nbsp;<span class="op" id="7554125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7554130">n</span><span class="op" id="7554131">,</span>&nbsp;<span class="ident" id="7554133">_</span><span class="op" id="7554134">,</span>&nbsp;<span class="ident" id="7554136">err</span>&nbsp;<span class="op" id="7554140">=</span>&nbsp;<span class="ident" id="7554142">c</span><span class="op" id="7554143">.</span><span class="op" id="7554144">(</span><span class="ident" id="7554145">PacketConn</span><span class="op" id="7554155">)</span><span class="op" id="7554156">.</span><span class="ident" id="7554157">ReadFrom</span><span class="op" id="7554165">(</span><span class="ident" id="7554166">b</span><span class="op" id="7554167">[</span><span class="num" id="7554168">0</span><span class="op" id="7554169">:</span><span class="op" id="7554170">]</span><span class="op" id="7554171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7554175">}</span>&nbsp;<span class="keyword" id="7554177">else</span>&nbsp;<span class="op" id="7554182">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7554187">n</span><span class="op" id="7554188">,</span>&nbsp;<span class="ident" id="7554190">err</span>&nbsp;<span class="op" id="7554194">=</span>&nbsp;<span class="ident" id="7554196">c</span><span class="op" id="7554197">.</span><span class="ident" id="7554198">Read</span><span class="op" id="7554202">(</span><span class="ident" id="7554203">b</span><span class="op" id="7554204">[</span><span class="num" id="7554205">0</span><span class="op" id="7554206">:</span><span class="op" id="7554207">]</span><span class="op" id="7554208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7554212">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7554216">t1</span>&nbsp;<span class="op" id="7554219">:=</span>&nbsp;<span class="ident" id="7554222">time</span><span class="op" id="7554226">.</span><span class="ident" id="7554227">Now</span><span class="op" id="7554230">(</span><span class="op" id="7554231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7554235">if</span>&nbsp;<span class="ident" id="7554238">n</span>&nbsp;<span class="op" id="7554240">!=</span>&nbsp;<span class="num" id="7554243">0</span>&nbsp;<span class="op" id="7554245">||</span>&nbsp;<span class="ident" id="7554248">err</span>&nbsp;<span class="op" id="7554252">==</span>&nbsp;<span class="ident" id="7554255">nil</span>&nbsp;<span class="op" id="7554259">||</span>&nbsp;<span class="op" id="7554262">!</span><span class="ident" id="7554263">err</span><span class="op" id="7554266">.</span><span class="op" id="7554267">(</span><span class="ident" id="7554268">Error</span><span class="op" id="7554273">)</span><span class="op" id="7554274">.</span><span class="ident" id="7554275">Timeout</span><span class="op" id="7554282">(</span><span class="op" id="7554283">)</span>&nbsp;<span class="op" id="7554285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7554290">errc</span>&nbsp;<span class="op" id="7554295">&lt;-</span>&nbsp;<span class="ident" id="7554298">fmt</span><span class="op" id="7554301">.</span><span class="ident" id="7554302">Errorf</span><span class="op" id="7554308">(</span><span class="string" id="7554309">&#34;%s(%q,&nbsp;%q)&nbsp;did&nbsp;not&nbsp;return&nbsp;0,&nbsp;timeout:&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="7554355">,</span>&nbsp;<span class="ident" id="7554357">what</span><span class="op" id="7554361">,</span>&nbsp;<span class="ident" id="7554363">net</span><span class="op" id="7554366">,</span>&nbsp;<span class="ident" id="7554368">addr</span><span class="op" id="7554372">,</span>&nbsp;<span class="ident" id="7554374">n</span><span class="op" id="7554375">,</span>&nbsp;<span class="ident" id="7554377">err</span><span class="op" id="7554380">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7554385">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7554394">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7554398">if</span>&nbsp;<span class="ident" id="7554401">dt</span>&nbsp;<span class="op" id="7554404">:=</span>&nbsp;<span class="ident" id="7554407">t1</span><span class="op" id="7554409">.</span><span class="ident" id="7554410">Sub</span><span class="op" id="7554413">(</span><span class="ident" id="7554414">t0</span><span class="op" id="7554416">)</span><span class="op" id="7554417">;</span>&nbsp;<span class="ident" id="7554419">dt</span>&nbsp;<span class="op" id="7554422">&lt;</span>&nbsp;<span class="num" id="7554424">50</span><span class="op" id="7554426">*</span><span class="ident" id="7554427">time</span><span class="op" id="7554431">.</span><span class="ident" id="7554432">Millisecond</span>&nbsp;<span class="op" id="7554444">||</span>&nbsp;<span class="op" id="7554447">!</span><span class="ident" id="7554448">testing</span><span class="op" id="7554455">.</span><span class="ident" id="7554456">Short</span><span class="op" id="7554461">(</span><span class="op" id="7554462">)</span>&nbsp;<span class="op" id="7554464">&amp;&amp;</span>&nbsp;<span class="ident" id="7554467">dt</span>&nbsp;<span class="op" id="7554470">&gt;</span>&nbsp;<span class="num" id="7554472">250</span><span class="op" id="7554475">*</span><span class="ident" id="7554476">time</span><span class="op" id="7554480">.</span><span class="ident" id="7554481">Millisecond</span>&nbsp;<span class="op" id="7554493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7554498">errc</span>&nbsp;<span class="op" id="7554503">&lt;-</span>&nbsp;<span class="ident" id="7554506">fmt</span><span class="op" id="7554509">.</span><span class="ident" id="7554510">Errorf</span><span class="op" id="7554516">(</span><span class="string" id="7554517">&#34;%s(%q,&nbsp;%q)&nbsp;took&nbsp;%s,&nbsp;expected&nbsp;0.1s&#34;</span><span class="op" id="7554552">,</span>&nbsp;<span class="ident" id="7554554">what</span><span class="op" id="7554558">,</span>&nbsp;<span class="ident" id="7554560">net</span><span class="op" id="7554563">,</span>&nbsp;<span class="ident" id="7554565">addr</span><span class="op" id="7554569">,</span>&nbsp;<span class="ident" id="7554571">dt</span><span class="op" id="7554573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7554578">return</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7554587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7554591">errc</span>&nbsp;<span class="op" id="7554596">&lt;-</span>&nbsp;<span class="ident" id="7554599">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7554604">}</span><span class="op" id="7554605">(</span><span class="op" id="7554606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7554609">select</span>&nbsp;<span class="op" id="7554616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7554619">case</span>&nbsp;<span class="ident" id="7554624">err</span>&nbsp;<span class="op" id="7554628">:=</span>&nbsp;<span class="op" id="7554631">&lt;-</span><span class="ident" id="7554633">errc</span><span class="op" id="7554637">:</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7554641">if</span>&nbsp;<span class="ident" id="7554644">err</span>&nbsp;<span class="op" id="7554648">!=</span>&nbsp;<span class="ident" id="7554651">nil</span>&nbsp;<span class="op" id="7554655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7554660">t</span><span class="op" id="7554661">.</span><span class="ident" id="7554662">Error</span><span class="op" id="7554667">(</span><span class="ident" id="7554668">err</span><span class="op" id="7554671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7554675">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7554678">case</span>&nbsp;<span class="op" id="7554683">&lt;-</span><span class="ident" id="7554685">time</span><span class="op" id="7554689">.</span><span class="ident" id="7554690">After</span><span class="op" id="7554695">(</span><span class="num" id="7554696">1</span>&nbsp;<span class="op" id="7554698">*</span>&nbsp;<span class="ident" id="7554700">time</span><span class="op" id="7554704">.</span><span class="ident" id="7554705">Second</span><span class="op" id="7554711">)</span><span class="op" id="7554712">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7554716">t</span><span class="op" id="7554717">.</span><span class="ident" id="7554718">Errorf</span><span class="op" id="7554724">(</span><span class="string" id="7554725">&#34;%s(%q,&nbsp;%q)&nbsp;took&nbsp;over&nbsp;1&nbsp;second,&nbsp;expected&nbsp;0.1s&#34;</span><span class="op" id="7554771">,</span>&nbsp;<span class="ident" id="7554773">what</span><span class="op" id="7554777">,</span>&nbsp;<span class="ident" id="7554779">net</span><span class="op" id="7554782">,</span>&nbsp;<span class="ident" id="7554784">addr</span><span class="op" id="7554788">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7554791">}</span><br>
<span class="lineno"></span><span class="op" id="7554793">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7554796">func</span>&nbsp;<span class="ident" id="7554801">TestTimeoutUDP</span><span class="op" id="7554815">(</span><span class="ident" id="7554816">t</span>&nbsp;<span class="op" id="7554818">*</span><span class="ident" id="7554819">testing</span><span class="op" id="7554826">.</span><span class="ident" id="7554827">T</span><span class="op" id="7554828">)</span>&nbsp;<span class="op" id="7554830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7554833">switch</span>&nbsp;<span class="ident" id="7554840">runtime</span><span class="op" id="7554847">.</span><span class="ident" id="7554848">GOOS</span>&nbsp;<span class="op" id="7554853">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7554856">case</span>&nbsp;<span class="string" id="7554861">&#34;plan9&#34;</span><span class="op" id="7554868">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7554872">t</span><span class="op" id="7554873">.</span><span class="ident" id="7554874">Skipf</span><span class="op" id="7554879">(</span><span class="string" id="7554880">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="7554901">,</span>&nbsp;<span class="ident" id="7554903">runtime</span><span class="op" id="7554910">.</span><span class="ident" id="7554911">GOOS</span><span class="op" id="7554915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7554918">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7554922">//&nbsp;set&nbsp;up&nbsp;a&nbsp;listener&nbsp;that&nbsp;won&#39;t&nbsp;talk&nbsp;back</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7554965">listening</span>&nbsp;<span class="op" id="7554975">:=</span>&nbsp;<span class="builtinfunc" id="7554978">make</span><span class="op" id="7554982">(</span><span class="keyword" id="7554983">chan</span>&nbsp;<span class="builtintype" id="7554988">string</span><span class="op" id="7554994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7554997">done</span>&nbsp;<span class="op" id="7555002">:=</span>&nbsp;<span class="builtinfunc" id="7555005">make</span><span class="op" id="7555009">(</span><span class="keyword" id="7555010">chan</span>&nbsp;<span class="builtintype" id="7555015">int</span><span class="op" id="7555018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7555021">go</span>&nbsp;<span class="ident" id="7555024">runDatagramPacketConnServer</span><span class="op" id="7555051">(</span><span class="ident" id="7555052">t</span><span class="op" id="7555053">,</span>&nbsp;<span class="string" id="7555055">&#34;udp&#34;</span><span class="op" id="7555060">,</span>&nbsp;<span class="string" id="7555062">&#34;127.0.0.1:0&#34;</span><span class="op" id="7555075">,</span>&nbsp;<span class="ident" id="7555077">listening</span><span class="op" id="7555086">,</span>&nbsp;<span class="ident" id="7555088">done</span><span class="op" id="7555092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7555095">addr</span>&nbsp;<span class="op" id="7555100">:=</span>&nbsp;<span class="op" id="7555103">&lt;-</span><span class="ident" id="7555105">listening</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7555117">testTimeout</span><span class="op" id="7555128">(</span><span class="ident" id="7555129">t</span><span class="op" id="7555130">,</span>&nbsp;<span class="string" id="7555132">&#34;udp&#34;</span><span class="op" id="7555137">,</span>&nbsp;<span class="ident" id="7555139">addr</span><span class="op" id="7555143">,</span>&nbsp;<span class="ident" id="7555145">false</span><span class="op" id="7555150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7555153">testTimeout</span><span class="op" id="7555164">(</span><span class="ident" id="7555165">t</span><span class="op" id="7555166">,</span>&nbsp;<span class="string" id="7555168">&#34;udp&#34;</span><span class="op" id="7555173">,</span>&nbsp;<span class="ident" id="7555175">addr</span><span class="op" id="7555179">,</span>&nbsp;<span class="ident" id="7555181">true</span><span class="op" id="7555185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7555188">&lt;-</span><span class="ident" id="7555190">done</span><br>
<span class="lineno"></span><span class="op" id="7555195">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="keyword" id="7555198">func</span>&nbsp;<span class="ident" id="7555203">TestTimeoutTCP</span><span class="op" id="7555217">(</span><span class="ident" id="7555218">t</span>&nbsp;<span class="op" id="7555220">*</span><span class="ident" id="7555221">testing</span><span class="op" id="7555228">.</span><span class="ident" id="7555229">T</span><span class="op" id="7555230">)</span>&nbsp;<span class="op" id="7555232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7555235">switch</span>&nbsp;<span class="ident" id="7555242">runtime</span><span class="op" id="7555249">.</span><span class="ident" id="7555250">GOOS</span>&nbsp;<span class="op" id="7555255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7555258">case</span>&nbsp;<span class="string" id="7555263">&#34;plan9&#34;</span><span class="op" id="7555270">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7555274">t</span><span class="op" id="7555275">.</span><span class="ident" id="7555276">Skipf</span><span class="op" id="7555281">(</span><span class="string" id="7555282">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="7555303">,</span>&nbsp;<span class="ident" id="7555305">runtime</span><span class="op" id="7555312">.</span><span class="ident" id="7555313">GOOS</span><span class="op" id="7555317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7555320">}</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7555324">//&nbsp;set&nbsp;up&nbsp;a&nbsp;listener&nbsp;that&nbsp;won&#39;t&nbsp;talk&nbsp;back</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7555367">listening</span>&nbsp;<span class="op" id="7555377">:=</span>&nbsp;<span class="builtinfunc" id="7555380">make</span><span class="op" id="7555384">(</span><span class="keyword" id="7555385">chan</span>&nbsp;<span class="builtintype" id="7555390">string</span><span class="op" id="7555396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7555399">done</span>&nbsp;<span class="op" id="7555404">:=</span>&nbsp;<span class="builtinfunc" id="7555407">make</span><span class="op" id="7555411">(</span><span class="keyword" id="7555412">chan</span>&nbsp;<span class="builtintype" id="7555417">int</span><span class="op" id="7555420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7555423">go</span>&nbsp;<span class="ident" id="7555426">runStreamConnServer</span><span class="op" id="7555445">(</span><span class="ident" id="7555446">t</span><span class="op" id="7555447">,</span>&nbsp;<span class="string" id="7555449">&#34;tcp&#34;</span><span class="op" id="7555454">,</span>&nbsp;<span class="string" id="7555456">&#34;127.0.0.1:0&#34;</span><span class="op" id="7555469">,</span>&nbsp;<span class="ident" id="7555471">listening</span><span class="op" id="7555480">,</span>&nbsp;<span class="ident" id="7555482">done</span><span class="op" id="7555486">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7555489">addr</span>&nbsp;<span class="op" id="7555494">:=</span>&nbsp;<span class="op" id="7555497">&lt;-</span><span class="ident" id="7555499">listening</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7555511">testTimeout</span><span class="op" id="7555522">(</span><span class="ident" id="7555523">t</span><span class="op" id="7555524">,</span>&nbsp;<span class="string" id="7555526">&#34;tcp&#34;</span><span class="op" id="7555531">,</span>&nbsp;<span class="ident" id="7555533">addr</span><span class="op" id="7555537">,</span>&nbsp;<span class="ident" id="7555539">false</span><span class="op" id="7555544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7555547">&lt;-</span><span class="ident" id="7555549">done</span><br>
<span class="lineno"></span><span class="op" id="7555554">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="keyword" id="7555557">func</span>&nbsp;<span class="ident" id="7555562">TestDeadlineReset</span><span class="op" id="7555579">(</span><span class="ident" id="7555580">t</span>&nbsp;<span class="op" id="7555582">*</span><span class="ident" id="7555583">testing</span><span class="op" id="7555590">.</span><span class="ident" id="7555591">T</span><span class="op" id="7555592">)</span>&nbsp;<span class="op" id="7555594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7555597">switch</span>&nbsp;<span class="ident" id="7555604">runtime</span><span class="op" id="7555611">.</span><span class="ident" id="7555612">GOOS</span>&nbsp;<span class="op" id="7555617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7555620">case</span>&nbsp;<span class="string" id="7555625">&#34;plan9&#34;</span><span class="op" id="7555632">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7555636">t</span><span class="op" id="7555637">.</span><span class="ident" id="7555638">Skipf</span><span class="op" id="7555643">(</span><span class="string" id="7555644">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="7555665">,</span>&nbsp;<span class="ident" id="7555667">runtime</span><span class="op" id="7555674">.</span><span class="ident" id="7555675">GOOS</span><span class="op" id="7555679">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7555682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7555685">ln</span><span class="op" id="7555687">,</span>&nbsp;<span class="ident" id="7555689">err</span>&nbsp;<span class="op" id="7555693">:=</span>&nbsp;<span class="ident" id="7555696">Listen</span><span class="op" id="7555702">(</span><span class="string" id="7555703">&#34;tcp&#34;</span><span class="op" id="7555708">,</span>&nbsp;<span class="string" id="7555710">&#34;127.0.0.1:0&#34;</span><span class="op" id="7555723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7555726">if</span>&nbsp;<span class="ident" id="7555729">err</span>&nbsp;<span class="op" id="7555733">!=</span>&nbsp;<span class="ident" id="7555736">nil</span>&nbsp;<span class="op" id="7555740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7555744">t</span><span class="op" id="7555745">.</span><span class="ident" id="7555746">Fatal</span><span class="op" id="7555751">(</span><span class="ident" id="7555752">err</span><span class="op" id="7555755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7555758">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7555761">defer</span>&nbsp;<span class="ident" id="7555767">ln</span><span class="op" id="7555769">.</span><span class="ident" id="7555770">Close</span><span class="op" id="7555775">(</span><span class="op" id="7555776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7555779">tl</span>&nbsp;<span class="op" id="7555782">:=</span>&nbsp;<span class="ident" id="7555785">ln</span><span class="op" id="7555787">.</span><span class="op" id="7555788">(</span><span class="op" id="7555789">*</span><span class="ident" id="7555790">TCPListener</span><span class="op" id="7555801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7555804">tl</span><span class="op" id="7555806">.</span><span class="ident" id="7555807">SetDeadline</span><span class="op" id="7555818">(</span><span class="ident" id="7555819">time</span><span class="op" id="7555823">.</span><span class="ident" id="7555824">Now</span><span class="op" id="7555827">(</span><span class="op" id="7555828">)</span><span class="op" id="7555829">.</span><span class="ident" id="7555830">Add</span><span class="op" id="7555833">(</span><span class="num" id="7555834">1</span>&nbsp;<span class="op" id="7555836">*</span>&nbsp;<span class="ident" id="7555838">time</span><span class="op" id="7555842">.</span><span class="ident" id="7555843">Minute</span><span class="op" id="7555849">)</span><span class="op" id="7555850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7555853">tl</span><span class="op" id="7555855">.</span><span class="ident" id="7555856">SetDeadline</span><span class="op" id="7555867">(</span><span class="ident" id="7555868">noDeadline</span><span class="op" id="7555878">)</span>&nbsp;<span class="comment" id="7555880">//&nbsp;reset&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7555893">errc</span>&nbsp;<span class="op" id="7555898">:=</span>&nbsp;<span class="builtinfunc" id="7555901">make</span><span class="op" id="7555905">(</span><span class="keyword" id="7555906">chan</span>&nbsp;<span class="builtintype" id="7555911">error</span><span class="op" id="7555916">,</span>&nbsp;<span class="num" id="7555918">1</span><span class="op" id="7555919">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7555922">go</span>&nbsp;<span class="keyword" id="7555925">func</span><span class="op" id="7555929">(</span><span class="op" id="7555930">)</span>&nbsp;<span class="op" id="7555932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7555936">_</span><span class="op" id="7555937">,</span>&nbsp;<span class="ident" id="7555939">err</span>&nbsp;<span class="op" id="7555943">:=</span>&nbsp;<span class="ident" id="7555946">ln</span><span class="op" id="7555948">.</span><span class="ident" id="7555949">Accept</span><span class="op" id="7555955">(</span><span class="op" id="7555956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7555960">errc</span>&nbsp;<span class="op" id="7555965">&lt;-</span>&nbsp;<span class="ident" id="7555968">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7555973">}</span><span class="op" id="7555974">(</span><span class="op" id="7555975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7555978">select</span>&nbsp;<span class="op" id="7555985">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7555988">case</span>&nbsp;<span class="op" id="7555993">&lt;-</span><span class="ident" id="7555995">time</span><span class="op" id="7555999">.</span><span class="ident" id="7556000">After</span><span class="op" id="7556005">(</span><span class="num" id="7556006">50</span>&nbsp;<span class="op" id="7556009">*</span>&nbsp;<span class="ident" id="7556011">time</span><span class="op" id="7556015">.</span><span class="ident" id="7556016">Millisecond</span><span class="op" id="7556027">)</span><span class="op" id="7556028">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7556032">//&nbsp;Pass.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7556042">case</span>&nbsp;<span class="ident" id="7556047">err</span>&nbsp;<span class="op" id="7556051">:=</span>&nbsp;<span class="op" id="7556054">&lt;-</span><span class="ident" id="7556056">errc</span><span class="op" id="7556060">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7556064">//&nbsp;Accept&nbsp;should&nbsp;never&nbsp;return;&nbsp;we&nbsp;never</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7556106">//&nbsp;connected&nbsp;to&nbsp;it.</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7556128">t</span><span class="op" id="7556129">.</span><span class="ident" id="7556130">Errorf</span><span class="op" id="7556136">(</span><span class="string" id="7556137">&#34;unexpected&nbsp;return&nbsp;from&nbsp;Accept;&nbsp;err=%v&#34;</span><span class="op" id="7556176">,</span>&nbsp;<span class="ident" id="7556178">err</span><span class="op" id="7556181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7556184">}</span><br>
<span class="lineno"></span><span class="op" id="7556186">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7556189">func</span>&nbsp;<span class="ident" id="7556194">TestTimeoutAccept</span><span class="op" id="7556211">(</span><span class="ident" id="7556212">t</span>&nbsp;<span class="op" id="7556214">*</span><span class="ident" id="7556215">testing</span><span class="op" id="7556222">.</span><span class="ident" id="7556223">T</span><span class="op" id="7556224">)</span>&nbsp;<span class="op" id="7556226">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7556229">switch</span>&nbsp;<span class="ident" id="7556236">runtime</span><span class="op" id="7556243">.</span><span class="ident" id="7556244">GOOS</span>&nbsp;<span class="op" id="7556249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7556252">case</span>&nbsp;<span class="string" id="7556257">&#34;plan9&#34;</span><span class="op" id="7556264">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7556268">t</span><span class="op" id="7556269">.</span><span class="ident" id="7556270">Skipf</span><span class="op" id="7556275">(</span><span class="string" id="7556276">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="7556297">,</span>&nbsp;<span class="ident" id="7556299">runtime</span><span class="op" id="7556306">.</span><span class="ident" id="7556307">GOOS</span><span class="op" id="7556311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7556314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7556317">ln</span><span class="op" id="7556319">,</span>&nbsp;<span class="ident" id="7556321">err</span>&nbsp;<span class="op" id="7556325">:=</span>&nbsp;<span class="ident" id="7556328">Listen</span><span class="op" id="7556334">(</span><span class="string" id="7556335">&#34;tcp&#34;</span><span class="op" id="7556340">,</span>&nbsp;<span class="string" id="7556342">&#34;127.0.0.1:0&#34;</span><span class="op" id="7556355">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7556358">if</span>&nbsp;<span class="ident" id="7556361">err</span>&nbsp;<span class="op" id="7556365">!=</span>&nbsp;<span class="ident" id="7556368">nil</span>&nbsp;<span class="op" id="7556372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7556376">t</span><span class="op" id="7556377">.</span><span class="ident" id="7556378">Fatal</span><span class="op" id="7556383">(</span><span class="ident" id="7556384">err</span><span class="op" id="7556387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7556390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7556393">defer</span>&nbsp;<span class="ident" id="7556399">ln</span><span class="op" id="7556401">.</span><span class="ident" id="7556402">Close</span><span class="op" id="7556407">(</span><span class="op" id="7556408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7556411">tl</span>&nbsp;<span class="op" id="7556414">:=</span>&nbsp;<span class="ident" id="7556417">ln</span><span class="op" id="7556419">.</span><span class="op" id="7556420">(</span><span class="op" id="7556421">*</span><span class="ident" id="7556422">TCPListener</span><span class="op" id="7556433">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7556436">tl</span><span class="op" id="7556438">.</span><span class="ident" id="7556439">SetDeadline</span><span class="op" id="7556450">(</span><span class="ident" id="7556451">time</span><span class="op" id="7556455">.</span><span class="ident" id="7556456">Now</span><span class="op" id="7556459">(</span><span class="op" id="7556460">)</span><span class="op" id="7556461">.</span><span class="ident" id="7556462">Add</span><span class="op" id="7556465">(</span><span class="num" id="7556466">100</span>&nbsp;<span class="op" id="7556470">*</span>&nbsp;<span class="ident" id="7556472">time</span><span class="op" id="7556476">.</span><span class="ident" id="7556477">Millisecond</span><span class="op" id="7556488">)</span><span class="op" id="7556489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7556492">errc</span>&nbsp;<span class="op" id="7556497">:=</span>&nbsp;<span class="builtinfunc" id="7556500">make</span><span class="op" id="7556504">(</span><span class="keyword" id="7556505">chan</span>&nbsp;<span class="builtintype" id="7556510">error</span><span class="op" id="7556515">,</span>&nbsp;<span class="num" id="7556517">1</span><span class="op" id="7556518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7556521">go</span>&nbsp;<span class="keyword" id="7556524">func</span><span class="op" id="7556528">(</span><span class="op" id="7556529">)</span>&nbsp;<span class="op" id="7556531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7556535">_</span><span class="op" id="7556536">,</span>&nbsp;<span class="ident" id="7556538">err</span>&nbsp;<span class="op" id="7556542">:=</span>&nbsp;<span class="ident" id="7556545">ln</span><span class="op" id="7556547">.</span><span class="ident" id="7556548">Accept</span><span class="op" id="7556554">(</span><span class="op" id="7556555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7556559">errc</span>&nbsp;<span class="op" id="7556564">&lt;-</span>&nbsp;<span class="ident" id="7556567">err</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7556572">}</span><span class="op" id="7556573">(</span><span class="op" id="7556574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7556577">select</span>&nbsp;<span class="op" id="7556584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7556587">case</span>&nbsp;<span class="op" id="7556592">&lt;-</span><span class="ident" id="7556594">time</span><span class="op" id="7556598">.</span><span class="ident" id="7556599">After</span><span class="op" id="7556604">(</span><span class="num" id="7556605">1</span>&nbsp;<span class="op" id="7556607">*</span>&nbsp;<span class="ident" id="7556609">time</span><span class="op" id="7556613">.</span><span class="ident" id="7556614">Second</span><span class="op" id="7556620">)</span><span class="op" id="7556621">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7556625">//&nbsp;Accept&nbsp;shouldn&#39;t&nbsp;block&nbsp;indefinitely</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7556666">t</span><span class="op" id="7556667">.</span><span class="ident" id="7556668">Errorf</span><span class="op" id="7556674">(</span><span class="string" id="7556675">&#34;Accept&nbsp;didn&#39;t&nbsp;return&nbsp;in&nbsp;an&nbsp;expected&nbsp;time&#34;</span><span class="op" id="7556717">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7556720">case</span>&nbsp;<span class="op" id="7556725">&lt;-</span><span class="ident" id="7556727">errc</span><span class="op" id="7556731">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7556735">//&nbsp;Pass.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7556745">}</span><br>
<span class="lineno"></span><span class="op" id="7556747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span><span class="keyword" id="7556750">func</span>&nbsp;<span class="ident" id="7556755">TestReadWriteDeadline</span><span class="op" id="7556776">(</span><span class="ident" id="7556777">t</span>&nbsp;<span class="op" id="7556779">*</span><span class="ident" id="7556780">testing</span><span class="op" id="7556787">.</span><span class="ident" id="7556788">T</span><span class="op" id="7556789">)</span>&nbsp;<span class="op" id="7556791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7556794">switch</span>&nbsp;<span class="ident" id="7556801">runtime</span><span class="op" id="7556808">.</span><span class="ident" id="7556809">GOOS</span>&nbsp;<span class="op" id="7556814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7556817">case</span>&nbsp;<span class="string" id="7556822">&#34;plan9&#34;</span><span class="op" id="7556829">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7556833">t</span><span class="op" id="7556834">.</span><span class="ident" id="7556835">Skipf</span><span class="op" id="7556840">(</span><span class="string" id="7556841">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="7556862">,</span>&nbsp;<span class="ident" id="7556864">runtime</span><span class="op" id="7556871">.</span><span class="ident" id="7556872">GOOS</span><span class="op" id="7556876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7556879">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7556883">const</span>&nbsp;<span class="op" id="7556889">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7556893">readTimeout</span>&nbsp;&nbsp;<span class="op" id="7556906">=</span>&nbsp;<span class="num" id="7556908">50</span>&nbsp;<span class="op" id="7556911">*</span>&nbsp;<span class="ident" id="7556913">time</span><span class="op" id="7556917">.</span><span class="ident" id="7556918">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7556932">writeTimeout</span>&nbsp;<span class="op" id="7556945">=</span>&nbsp;<span class="num" id="7556947">250</span>&nbsp;<span class="op" id="7556951">*</span>&nbsp;<span class="ident" id="7556953">time</span><span class="op" id="7556957">.</span><span class="ident" id="7556958">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7556971">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7556974">checkTimeout</span>&nbsp;<span class="op" id="7556987">:=</span>&nbsp;<span class="keyword" id="7556990">func</span><span class="op" id="7556994">(</span><span class="ident" id="7556995">command</span>&nbsp;<span class="builtintype" id="7557003">string</span><span class="op" id="7557009">,</span>&nbsp;<span class="ident" id="7557011">start</span>&nbsp;<span class="ident" id="7557017">time</span><span class="op" id="7557021">.</span><span class="ident" id="7557022">Time</span><span class="op" id="7557026">,</span>&nbsp;<span class="ident" id="7557028">should</span>&nbsp;<span class="ident" id="7557035">time</span><span class="op" id="7557039">.</span><span class="ident" id="7557040">Duration</span><span class="op" id="7557048">)</span>&nbsp;<span class="op" id="7557050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7557054">is</span>&nbsp;<span class="op" id="7557057">:=</span>&nbsp;<span class="ident" id="7557060">time</span><span class="op" id="7557064">.</span><span class="ident" id="7557065">Now</span><span class="op" id="7557068">(</span><span class="op" id="7557069">)</span><span class="op" id="7557070">.</span><span class="ident" id="7557071">Sub</span><span class="op" id="7557074">(</span><span class="ident" id="7557075">start</span><span class="op" id="7557080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7557084">d</span>&nbsp;<span class="op" id="7557086">:=</span>&nbsp;<span class="ident" id="7557089">is</span>&nbsp;<span class="op" id="7557092">-</span>&nbsp;<span class="ident" id="7557094">should</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7557103">if</span>&nbsp;<span class="ident" id="7557106">d</span>&nbsp;<span class="op" id="7557108">&lt;</span>&nbsp;<span class="op" id="7557110">-</span><span class="num" id="7557111">30</span><span class="op" id="7557113">*</span><span class="ident" id="7557114">time</span><span class="op" id="7557118">.</span><span class="ident" id="7557119">Millisecond</span>&nbsp;<span class="op" id="7557131">||</span>&nbsp;<span class="op" id="7557134">!</span><span class="ident" id="7557135">testing</span><span class="op" id="7557142">.</span><span class="ident" id="7557143">Short</span><span class="op" id="7557148">(</span><span class="op" id="7557149">)</span>&nbsp;<span class="op" id="7557151">&amp;&amp;</span>&nbsp;<span class="num" id="7557154">150</span><span class="op" id="7557157">*</span><span class="ident" id="7557158">time</span><span class="op" id="7557162">.</span><span class="ident" id="7557163">Millisecond</span>&nbsp;<span class="op" id="7557175">&lt;</span>&nbsp;<span class="ident" id="7557177">d</span>&nbsp;<span class="op" id="7557179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7557184">t</span><span class="op" id="7557185">.</span><span class="ident" id="7557186">Errorf</span><span class="op" id="7557192">(</span><span class="string" id="7557193">&#34;%s&nbsp;timeout&nbsp;test&nbsp;failed:&nbsp;is=%v&nbsp;should=%v\n&#34;</span><span class="op" id="7557236">,</span>&nbsp;<span class="ident" id="7557238">command</span><span class="op" id="7557245">,</span>&nbsp;<span class="ident" id="7557247">is</span><span class="op" id="7557249">,</span>&nbsp;<span class="ident" id="7557251">should</span><span class="op" id="7557257">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7557261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7557264">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7557268">ln</span><span class="op" id="7557270">,</span>&nbsp;<span class="ident" id="7557272">err</span>&nbsp;<span class="op" id="7557276">:=</span>&nbsp;<span class="ident" id="7557279">Listen</span><span class="op" id="7557285">(</span><span class="string" id="7557286">&#34;tcp&#34;</span><span class="op" id="7557291">,</span>&nbsp;<span class="string" id="7557293">&#34;127.0.0.1:0&#34;</span><span class="op" id="7557306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7557309">if</span>&nbsp;<span class="ident" id="7557312">err</span>&nbsp;<span class="op" id="7557316">!=</span>&nbsp;<span class="ident" id="7557319">nil</span>&nbsp;<span class="op" id="7557323">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7557327">t</span><span class="op" id="7557328">.</span><span class="ident" id="7557329">Fatalf</span><span class="op" id="7557335">(</span><span class="string" id="7557336">&#34;ListenTCP&nbsp;on&nbsp;:0:&nbsp;%v&#34;</span><span class="op" id="7557357">,</span>&nbsp;<span class="ident" id="7557359">err</span><span class="op" id="7557362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7557365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7557368">defer</span>&nbsp;<span class="ident" id="7557374">ln</span><span class="op" id="7557376">.</span><span class="ident" id="7557377">Close</span><span class="op" id="7557382">(</span><span class="op" id="7557383">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7557387">lnquit</span>&nbsp;<span class="op" id="7557394">:=</span>&nbsp;<span class="builtinfunc" id="7557397">make</span><span class="op" id="7557401">(</span><span class="keyword" id="7557402">chan</span>&nbsp;<span class="builtintype" id="7557407">bool</span><span class="op" id="7557411">)</span><br>
<span class="lineno">350</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7557415">go</span>&nbsp;<span class="keyword" id="7557418">func</span><span class="op" id="7557422">(</span><span class="op" id="7557423">)</span>&nbsp;<span class="op" id="7557425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7557429">c</span><span class="op" id="7557430">,</span>&nbsp;<span class="ident" id="7557432">err</span>&nbsp;<span class="op" id="7557436">:=</span>&nbsp;<span class="ident" id="7557439">ln</span><span class="op" id="7557441">.</span><span class="ident" id="7557442">Accept</span><span class="op" id="7557448">(</span><span class="op" id="7557449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7557453">if</span>&nbsp;<span class="ident" id="7557456">err</span>&nbsp;<span class="op" id="7557460">!=</span>&nbsp;<span class="ident" id="7557463">nil</span>&nbsp;<span class="op" id="7557467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7557472">t</span><span class="op" id="7557473">.</span><span class="ident" id="7557474">Errorf</span><span class="op" id="7557480">(</span><span class="string" id="7557481">&#34;Accept:&nbsp;%v&#34;</span><span class="op" id="7557493">,</span>&nbsp;<span class="ident" id="7557495">err</span><span class="op" id="7557498">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7557503">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7557512">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7557516">defer</span>&nbsp;<span class="ident" id="7557522">c</span><span class="op" id="7557523">.</span><span class="ident" id="7557524">Close</span><span class="op" id="7557529">(</span><span class="op" id="7557530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7557534">lnquit</span>&nbsp;<span class="op" id="7557541">&lt;-</span>&nbsp;<span class="ident" id="7557544">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7557550">}</span><span class="op" id="7557551">(</span><span class="op" id="7557552">)</span><br>
<span class="lineno">360</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7557556">c</span><span class="op" id="7557557">,</span>&nbsp;<span class="ident" id="7557559">err</span>&nbsp;<span class="op" id="7557563">:=</span>&nbsp;<span class="ident" id="7557566">Dial</span><span class="op" id="7557570">(</span><span class="string" id="7557571">&#34;tcp&#34;</span><span class="op" id="7557576">,</span>&nbsp;<span class="ident" id="7557578">ln</span><span class="op" id="7557580">.</span><span class="ident" id="7557581">Addr</span><span class="op" id="7557585">(</span><span class="op" id="7557586">)</span><span class="op" id="7557587">.</span><span class="ident" id="7557588">String</span><span class="op" id="7557594">(</span><span class="op" id="7557595">)</span><span class="op" id="7557596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7557599">if</span>&nbsp;<span class="ident" id="7557602">err</span>&nbsp;<span class="op" id="7557606">!=</span>&nbsp;<span class="ident" id="7557609">nil</span>&nbsp;<span class="op" id="7557613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7557617">t</span><span class="op" id="7557618">.</span><span class="ident" id="7557619">Fatalf</span><span class="op" id="7557625">(</span><span class="string" id="7557626">&#34;Dial:&nbsp;%v&#34;</span><span class="op" id="7557636">,</span>&nbsp;<span class="ident" id="7557638">err</span><span class="op" id="7557641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7557644">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7557647">defer</span>&nbsp;<span class="ident" id="7557653">c</span><span class="op" id="7557654">.</span><span class="ident" id="7557655">Close</span><span class="op" id="7557660">(</span><span class="op" id="7557661">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7557665">start</span>&nbsp;<span class="op" id="7557671">:=</span>&nbsp;<span class="ident" id="7557674">time</span><span class="op" id="7557678">.</span><span class="ident" id="7557679">Now</span><span class="op" id="7557682">(</span><span class="op" id="7557683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7557686">err</span>&nbsp;<span class="op" id="7557690">=</span>&nbsp;<span class="ident" id="7557692">c</span><span class="op" id="7557693">.</span><span class="ident" id="7557694">SetReadDeadline</span><span class="op" id="7557709">(</span><span class="ident" id="7557710">start</span><span class="op" id="7557715">.</span><span class="ident" id="7557716">Add</span><span class="op" id="7557719">(</span><span class="ident" id="7557720">readTimeout</span><span class="op" id="7557731">)</span><span class="op" id="7557732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7557735">if</span>&nbsp;<span class="ident" id="7557738">err</span>&nbsp;<span class="op" id="7557742">!=</span>&nbsp;<span class="ident" id="7557745">nil</span>&nbsp;<span class="op" id="7557749">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7557753">t</span><span class="op" id="7557754">.</span><span class="ident" id="7557755">Fatalf</span><span class="op" id="7557761">(</span><span class="string" id="7557762">&#34;SetReadDeadline:&nbsp;%v&#34;</span><span class="op" id="7557783">,</span>&nbsp;<span class="ident" id="7557785">err</span><span class="op" id="7557788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7557791">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7557794">err</span>&nbsp;<span class="op" id="7557798">=</span>&nbsp;<span class="ident" id="7557800">c</span><span class="op" id="7557801">.</span><span class="ident" id="7557802">SetWriteDeadline</span><span class="op" id="7557818">(</span><span class="ident" id="7557819">start</span><span class="op" id="7557824">.</span><span class="ident" id="7557825">Add</span><span class="op" id="7557828">(</span><span class="ident" id="7557829">writeTimeout</span><span class="op" id="7557841">)</span><span class="op" id="7557842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7557845">if</span>&nbsp;<span class="ident" id="7557848">err</span>&nbsp;<span class="op" id="7557852">!=</span>&nbsp;<span class="ident" id="7557855">nil</span>&nbsp;<span class="op" id="7557859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7557863">t</span><span class="op" id="7557864">.</span><span class="ident" id="7557865">Fatalf</span><span class="op" id="7557871">(</span><span class="string" id="7557872">&#34;SetWriteDeadline:&nbsp;%v&#34;</span><span class="op" id="7557894">,</span>&nbsp;<span class="ident" id="7557896">err</span><span class="op" id="7557899">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7557902">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7557906">quit</span>&nbsp;<span class="op" id="7557911">:=</span>&nbsp;<span class="builtinfunc" id="7557914">make</span><span class="op" id="7557918">(</span><span class="keyword" id="7557919">chan</span>&nbsp;<span class="builtintype" id="7557924">bool</span><span class="op" id="7557928">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7557932">go</span>&nbsp;<span class="keyword" id="7557935">func</span><span class="op" id="7557939">(</span><span class="op" id="7557940">)</span>&nbsp;<span class="op" id="7557942">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7557946">var</span>&nbsp;<span class="ident" id="7557950">buf</span>&nbsp;<span class="op" id="7557954">[</span><span class="num" id="7557955">10</span><span class="op" id="7557957">]</span><span class="builtintype" id="7557958">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7557965">_</span><span class="op" id="7557966">,</span>&nbsp;<span class="ident" id="7557968">err</span>&nbsp;<span class="op" id="7557972">:=</span>&nbsp;<span class="ident" id="7557975">c</span><span class="op" id="7557976">.</span><span class="ident" id="7557977">Read</span><span class="op" id="7557981">(</span><span class="ident" id="7557982">buf</span><span class="op" id="7557985">[</span><span class="op" id="7557986">:</span><span class="op" id="7557987">]</span><span class="op" id="7557988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7557992">if</span>&nbsp;<span class="ident" id="7557995">err</span>&nbsp;<span class="op" id="7557999">==</span>&nbsp;<span class="ident" id="7558002">nil</span>&nbsp;<span class="op" id="7558006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7558011">t</span><span class="op" id="7558012">.</span><span class="ident" id="7558013">Errorf</span><span class="op" id="7558019">(</span><span class="string" id="7558020">&#34;Read&nbsp;should&nbsp;not&nbsp;succeed&#34;</span><span class="op" id="7558045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7558049">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7558053">checkTimeout</span><span class="op" id="7558065">(</span><span class="string" id="7558066">&#34;Read&#34;</span><span class="op" id="7558072">,</span>&nbsp;<span class="ident" id="7558074">start</span><span class="op" id="7558079">,</span>&nbsp;<span class="ident" id="7558081">readTimeout</span><span class="op" id="7558092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7558096">quit</span>&nbsp;<span class="op" id="7558101">&lt;-</span>&nbsp;<span class="ident" id="7558104">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7558110">}</span><span class="op" id="7558111">(</span><span class="op" id="7558112">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7558116">go</span>&nbsp;<span class="keyword" id="7558119">func</span><span class="op" id="7558123">(</span><span class="op" id="7558124">)</span>&nbsp;<span class="op" id="7558126">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7558130">var</span>&nbsp;<span class="ident" id="7558134">buf</span>&nbsp;<span class="op" id="7558138">[</span><span class="num" id="7558139">10000</span><span class="op" id="7558144">]</span><span class="builtintype" id="7558145">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7558152">for</span>&nbsp;<span class="op" id="7558156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7558161">_</span><span class="op" id="7558162">,</span>&nbsp;<span class="ident" id="7558164">err</span>&nbsp;<span class="op" id="7558168">:=</span>&nbsp;<span class="ident" id="7558171">c</span><span class="op" id="7558172">.</span><span class="ident" id="7558173">Write</span><span class="op" id="7558178">(</span><span class="ident" id="7558179">buf</span><span class="op" id="7558182">[</span><span class="op" id="7558183">:</span><span class="op" id="7558184">]</span><span class="op" id="7558185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7558190">if</span>&nbsp;<span class="ident" id="7558193">err</span>&nbsp;<span class="op" id="7558197">!=</span>&nbsp;<span class="ident" id="7558200">nil</span>&nbsp;<span class="op" id="7558204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7558210">break</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7558219">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7558223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7558227">checkTimeout</span><span class="op" id="7558239">(</span><span class="string" id="7558240">&#34;Write&#34;</span><span class="op" id="7558247">,</span>&nbsp;<span class="ident" id="7558249">start</span><span class="op" id="7558254">,</span>&nbsp;<span class="ident" id="7558256">writeTimeout</span><span class="op" id="7558268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7558272">quit</span>&nbsp;<span class="op" id="7558277">&lt;-</span>&nbsp;<span class="ident" id="7558280">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7558286">}</span><span class="op" id="7558287">(</span><span class="op" id="7558288">)</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7558292">&lt;-</span><span class="ident" id="7558294">quit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7558300">&lt;-</span><span class="ident" id="7558302">quit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7558308">&lt;-</span><span class="ident" id="7558310">lnquit</span><br>
<span class="lineno"></span><span class="op" id="7558317">}</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span><span class="keyword" id="7558320">type</span>&nbsp;<span class="ident" id="7558325">neverEnding</span>&nbsp;<span class="builtintype" id="7558337">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7558343">func</span>&nbsp;<span class="op" id="7558348">(</span><span class="ident" id="7558349">b</span>&nbsp;<span class="ident" id="7558351">neverEnding</span><span class="op" id="7558362">)</span>&nbsp;<span class="ident" id="7558364">Read</span><span class="op" id="7558368">(</span><span class="ident" id="7558369">p</span>&nbsp;<span class="op" id="7558371">[</span><span class="op" id="7558372">]</span><span class="builtintype" id="7558373">byte</span><span class="op" id="7558377">)</span>&nbsp;<span class="op" id="7558379">(</span><span class="ident" id="7558380">n</span>&nbsp;<span class="builtintype" id="7558382">int</span><span class="op" id="7558385">,</span>&nbsp;<span class="ident" id="7558387">err</span>&nbsp;<span class="builtintype" id="7558391">error</span><span class="op" id="7558396">)</span>&nbsp;<span class="op" id="7558398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7558401">for</span>&nbsp;<span class="ident" id="7558405">i</span>&nbsp;<span class="op" id="7558407">:=</span>&nbsp;<span class="keyword" id="7558410">range</span>&nbsp;<span class="ident" id="7558416">p</span>&nbsp;<span class="op" id="7558418">{</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7558422">p</span><span class="op" id="7558423">[</span><span class="ident" id="7558424">i</span><span class="op" id="7558425">]</span>&nbsp;<span class="op" id="7558427">=</span>&nbsp;<span class="builtintype" id="7558429">byte</span><span class="op" id="7558433">(</span><span class="ident" id="7558434">b</span><span class="op" id="7558435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7558438">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7558441">return</span>&nbsp;<span class="builtinfunc" id="7558448">len</span><span class="op" id="7558451">(</span><span class="ident" id="7558452">p</span><span class="op" id="7558453">)</span><span class="op" id="7558454">,</span>&nbsp;<span class="ident" id="7558456">nil</span><br>
<span class="lineno"></span><span class="op" id="7558460">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="keyword" id="7558463">func</span>&nbsp;<span class="ident" id="7558468">TestVariousDeadlines1Proc</span><span class="op" id="7558493">(</span><span class="ident" id="7558494">t</span>&nbsp;<span class="op" id="7558496">*</span><span class="ident" id="7558497">testing</span><span class="op" id="7558504">.</span><span class="ident" id="7558505">T</span><span class="op" id="7558506">)</span>&nbsp;<span class="op" id="7558508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7558511">testVariousDeadlines</span><span class="op" id="7558531">(</span><span class="ident" id="7558532">t</span><span class="op" id="7558533">,</span>&nbsp;<span class="num" id="7558535">1</span><span class="op" id="7558536">)</span><br>
<span class="lineno"></span><span class="op" id="7558538">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7558541">func</span>&nbsp;<span class="ident" id="7558546">TestVariousDeadlines4Proc</span><span class="op" id="7558571">(</span><span class="ident" id="7558572">t</span>&nbsp;<span class="op" id="7558574">*</span><span class="ident" id="7558575">testing</span><span class="op" id="7558582">.</span><span class="ident" id="7558583">T</span><span class="op" id="7558584">)</span>&nbsp;<span class="op" id="7558586">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7558589">testVariousDeadlines</span><span class="op" id="7558609">(</span><span class="ident" id="7558610">t</span><span class="op" id="7558611">,</span>&nbsp;<span class="num" id="7558613">4</span><span class="op" id="7558614">)</span><br>
<span class="lineno"></span><span class="op" id="7558616">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7558619">func</span>&nbsp;<span class="ident" id="7558624">testVariousDeadlines</span><span class="op" id="7558644">(</span><span class="ident" id="7558645">t</span>&nbsp;<span class="op" id="7558647">*</span><span class="ident" id="7558648">testing</span><span class="op" id="7558655">.</span><span class="ident" id="7558656">T</span><span class="op" id="7558657">,</span>&nbsp;<span class="ident" id="7558659">maxProcs</span>&nbsp;<span class="builtintype" id="7558668">int</span><span class="op" id="7558671">)</span>&nbsp;<span class="op" id="7558673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7558676">switch</span>&nbsp;<span class="ident" id="7558683">runtime</span><span class="op" id="7558690">.</span><span class="ident" id="7558691">GOOS</span>&nbsp;<span class="op" id="7558696">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7558699">case</span>&nbsp;<span class="string" id="7558704">&#34;plan9&#34;</span><span class="op" id="7558711">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7558715">t</span><span class="op" id="7558716">.</span><span class="ident" id="7558717">Skipf</span><span class="op" id="7558722">(</span><span class="string" id="7558723">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="7558744">,</span>&nbsp;<span class="ident" id="7558746">runtime</span><span class="op" id="7558753">.</span><span class="ident" id="7558754">GOOS</span><span class="op" id="7558758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7558761">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7558765">defer</span>&nbsp;<span class="ident" id="7558771">runtime</span><span class="op" id="7558778">.</span><span class="ident" id="7558779">GOMAXPROCS</span><span class="op" id="7558789">(</span><span class="ident" id="7558790">runtime</span><span class="op" id="7558797">.</span><span class="ident" id="7558798">GOMAXPROCS</span><span class="op" id="7558808">(</span><span class="ident" id="7558809">maxProcs</span><span class="op" id="7558817">)</span><span class="op" id="7558818">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7558821">ln</span>&nbsp;<span class="op" id="7558824">:=</span>&nbsp;<span class="ident" id="7558827">newLocalListener</span><span class="op" id="7558843">(</span><span class="ident" id="7558844">t</span><span class="op" id="7558845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7558848">defer</span>&nbsp;<span class="ident" id="7558854">ln</span><span class="op" id="7558856">.</span><span class="ident" id="7558857">Close</span><span class="op" id="7558862">(</span><span class="op" id="7558863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7558866">acceptc</span>&nbsp;<span class="op" id="7558874">:=</span>&nbsp;<span class="builtinfunc" id="7558877">make</span><span class="op" id="7558881">(</span><span class="keyword" id="7558882">chan</span>&nbsp;<span class="builtintype" id="7558887">error</span><span class="op" id="7558892">,</span>&nbsp;<span class="num" id="7558894">1</span><span class="op" id="7558895">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7558899">//&nbsp;The&nbsp;server,&nbsp;with&nbsp;no&nbsp;timeouts&nbsp;of&nbsp;its&nbsp;own,&nbsp;sending&nbsp;bytes&nbsp;to&nbsp;clients</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7558969">//&nbsp;as&nbsp;fast&nbsp;as&nbsp;it&nbsp;can.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7558992">servec</span>&nbsp;<span class="op" id="7558999">:=</span>&nbsp;<span class="builtinfunc" id="7559002">make</span><span class="op" id="7559006">(</span><span class="keyword" id="7559007">chan</span>&nbsp;<span class="ident" id="7559012">copyRes</span><span class="op" id="7559019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7559022">go</span>&nbsp;<span class="keyword" id="7559025">func</span><span class="op" id="7559029">(</span><span class="op" id="7559030">)</span>&nbsp;<span class="op" id="7559032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7559036">for</span>&nbsp;<span class="op" id="7559040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7559045">c</span><span class="op" id="7559046">,</span>&nbsp;<span class="ident" id="7559048">err</span>&nbsp;<span class="op" id="7559052">:=</span>&nbsp;<span class="ident" id="7559055">ln</span><span class="op" id="7559057">.</span><span class="ident" id="7559058">Accept</span><span class="op" id="7559064">(</span><span class="op" id="7559065">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7559070">if</span>&nbsp;<span class="ident" id="7559073">err</span>&nbsp;<span class="op" id="7559077">!=</span>&nbsp;<span class="ident" id="7559080">nil</span>&nbsp;<span class="op" id="7559084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7559090">acceptc</span>&nbsp;<span class="op" id="7559098">&lt;-</span>&nbsp;<span class="ident" id="7559101">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7559109">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7559119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7559124">go</span>&nbsp;<span class="keyword" id="7559127">func</span><span class="op" id="7559131">(</span><span class="op" id="7559132">)</span>&nbsp;<span class="op" id="7559134">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7559140">t0</span>&nbsp;<span class="op" id="7559143">:=</span>&nbsp;<span class="ident" id="7559146">time</span><span class="op" id="7559150">.</span><span class="ident" id="7559151">Now</span><span class="op" id="7559154">(</span><span class="op" id="7559155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7559161">n</span><span class="op" id="7559162">,</span>&nbsp;<span class="ident" id="7559164">err</span>&nbsp;<span class="op" id="7559168">:=</span>&nbsp;<span class="ident" id="7559171">io</span><span class="op" id="7559173">.</span><span class="ident" id="7559174">Copy</span><span class="op" id="7559178">(</span><span class="ident" id="7559179">c</span><span class="op" id="7559180">,</span>&nbsp;<span class="ident" id="7559182">neverEnding</span><span class="op" id="7559193">(</span><span class="string" id="7559194">&#39;a&#39;</span><span class="op" id="7559197">)</span><span class="op" id="7559198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7559204">d</span>&nbsp;<span class="op" id="7559206">:=</span>&nbsp;<span class="ident" id="7559209">time</span><span class="op" id="7559213">.</span><span class="ident" id="7559214">Since</span><span class="op" id="7559219">(</span><span class="ident" id="7559220">t0</span><span class="op" id="7559222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7559228">c</span><span class="op" id="7559229">.</span><span class="ident" id="7559230">Close</span><span class="op" id="7559235">(</span><span class="op" id="7559236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7559242">servec</span>&nbsp;<span class="op" id="7559249">&lt;-</span>&nbsp;<span class="ident" id="7559252">copyRes</span><span class="op" id="7559259">{</span><span class="ident" id="7559260">n</span><span class="op" id="7559261">,</span>&nbsp;<span class="ident" id="7559263">err</span><span class="op" id="7559266">,</span>&nbsp;<span class="ident" id="7559268">d</span><span class="op" id="7559269">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7559274">}</span><span class="op" id="7559275">(</span><span class="op" id="7559276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7559280">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7559283">}</span><span class="op" id="7559284">(</span><span class="op" id="7559285">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7559289">for</span>&nbsp;<span class="ident" id="7559293">_</span><span class="op" id="7559294">,</span>&nbsp;<span class="ident" id="7559296">timeout</span>&nbsp;<span class="op" id="7559304">:=</span>&nbsp;<span class="keyword" id="7559307">range</span>&nbsp;<span class="op" id="7559313">[</span><span class="op" id="7559314">]</span><span class="ident" id="7559315">time</span><span class="op" id="7559319">.</span><span class="ident" id="7559320">Duration</span><span class="op" id="7559328">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="7559332">1</span>&nbsp;<span class="op" id="7559334">*</span>&nbsp;<span class="ident" id="7559336">time</span><span class="op" id="7559340">.</span><span class="ident" id="7559341">Nanosecond</span><span class="op" id="7559351">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="7559355">2</span>&nbsp;<span class="op" id="7559357">*</span>&nbsp;<span class="ident" id="7559359">time</span><span class="op" id="7559363">.</span><span class="ident" id="7559364">Nanosecond</span><span class="op" id="7559374">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="7559378">5</span>&nbsp;<span class="op" id="7559380">*</span>&nbsp;<span class="ident" id="7559382">time</span><span class="op" id="7559386">.</span><span class="ident" id="7559387">Nanosecond</span><span class="op" id="7559397">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="7559401">50</span>&nbsp;<span class="op" id="7559404">*</span>&nbsp;<span class="ident" id="7559406">time</span><span class="op" id="7559410">.</span><span class="ident" id="7559411">Nanosecond</span><span class="op" id="7559421">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="7559425">100</span>&nbsp;<span class="op" id="7559429">*</span>&nbsp;<span class="ident" id="7559431">time</span><span class="op" id="7559435">.</span><span class="ident" id="7559436">Nanosecond</span><span class="op" id="7559446">,</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="7559450">200</span>&nbsp;<span class="op" id="7559454">*</span>&nbsp;<span class="ident" id="7559456">time</span><span class="op" id="7559460">.</span><span class="ident" id="7559461">Nanosecond</span><span class="op" id="7559471">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="7559475">500</span>&nbsp;<span class="op" id="7559479">*</span>&nbsp;<span class="ident" id="7559481">time</span><span class="op" id="7559485">.</span><span class="ident" id="7559486">Nanosecond</span><span class="op" id="7559496">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="7559500">750</span>&nbsp;<span class="op" id="7559504">*</span>&nbsp;<span class="ident" id="7559506">time</span><span class="op" id="7559510">.</span><span class="ident" id="7559511">Nanosecond</span><span class="op" id="7559521">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="7559525">1</span>&nbsp;<span class="op" id="7559527">*</span>&nbsp;<span class="ident" id="7559529">time</span><span class="op" id="7559533">.</span><span class="ident" id="7559534">Microsecond</span><span class="op" id="7559545">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="7559549">5</span>&nbsp;<span class="op" id="7559551">*</span>&nbsp;<span class="ident" id="7559553">time</span><span class="op" id="7559557">.</span><span class="ident" id="7559558">Microsecond</span><span class="op" id="7559569">,</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="7559573">25</span>&nbsp;<span class="op" id="7559576">*</span>&nbsp;<span class="ident" id="7559578">time</span><span class="op" id="7559582">.</span><span class="ident" id="7559583">Microsecond</span><span class="op" id="7559594">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="7559598">250</span>&nbsp;<span class="op" id="7559602">*</span>&nbsp;<span class="ident" id="7559604">time</span><span class="op" id="7559608">.</span><span class="ident" id="7559609">Microsecond</span><span class="op" id="7559620">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="7559624">500</span>&nbsp;<span class="op" id="7559628">*</span>&nbsp;<span class="ident" id="7559630">time</span><span class="op" id="7559634">.</span><span class="ident" id="7559635">Microsecond</span><span class="op" id="7559646">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="7559650">1</span>&nbsp;<span class="op" id="7559652">*</span>&nbsp;<span class="ident" id="7559654">time</span><span class="op" id="7559658">.</span><span class="ident" id="7559659">Millisecond</span><span class="op" id="7559670">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="7559674">5</span>&nbsp;<span class="op" id="7559676">*</span>&nbsp;<span class="ident" id="7559678">time</span><span class="op" id="7559682">.</span><span class="ident" id="7559683">Millisecond</span><span class="op" id="7559694">,</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="7559698">100</span>&nbsp;<span class="op" id="7559702">*</span>&nbsp;<span class="ident" id="7559704">time</span><span class="op" id="7559708">.</span><span class="ident" id="7559709">Millisecond</span><span class="op" id="7559720">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="7559724">250</span>&nbsp;<span class="op" id="7559728">*</span>&nbsp;<span class="ident" id="7559730">time</span><span class="op" id="7559734">.</span><span class="ident" id="7559735">Millisecond</span><span class="op" id="7559746">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="7559750">500</span>&nbsp;<span class="op" id="7559754">*</span>&nbsp;<span class="ident" id="7559756">time</span><span class="op" id="7559760">.</span><span class="ident" id="7559761">Millisecond</span><span class="op" id="7559772">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="7559776">1</span>&nbsp;<span class="op" id="7559778">*</span>&nbsp;<span class="ident" id="7559780">time</span><span class="op" id="7559784">.</span><span class="ident" id="7559785">Second</span><span class="op" id="7559791">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7559794">}</span>&nbsp;<span class="op" id="7559796">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7559800">numRuns</span>&nbsp;<span class="op" id="7559808">:=</span>&nbsp;<span class="num" id="7559811">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7559815">if</span>&nbsp;<span class="ident" id="7559818">testing</span><span class="op" id="7559825">.</span><span class="ident" id="7559826">Short</span><span class="op" id="7559831">(</span><span class="op" id="7559832">)</span>&nbsp;<span class="op" id="7559834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7559839">numRuns</span>&nbsp;<span class="op" id="7559847">=</span>&nbsp;<span class="num" id="7559849">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7559854">if</span>&nbsp;<span class="ident" id="7559857">timeout</span>&nbsp;<span class="op" id="7559865">&gt;</span>&nbsp;<span class="num" id="7559867">500</span><span class="op" id="7559870">*</span><span class="ident" id="7559871">time</span><span class="op" id="7559875">.</span><span class="ident" id="7559876">Microsecond</span>&nbsp;<span class="op" id="7559888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7559894">continue</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7559906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7559910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7559914">for</span>&nbsp;<span class="ident" id="7559918">run</span>&nbsp;<span class="op" id="7559922">:=</span>&nbsp;<span class="num" id="7559925">0</span><span class="op" id="7559926">;</span>&nbsp;<span class="ident" id="7559928">run</span>&nbsp;<span class="op" id="7559932">&lt;</span>&nbsp;<span class="ident" id="7559934">numRuns</span><span class="op" id="7559941">;</span>&nbsp;<span class="ident" id="7559943">run</span><span class="op" id="7559946">++</span>&nbsp;<span class="op" id="7559949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7559954">name</span>&nbsp;<span class="op" id="7559959">:=</span>&nbsp;<span class="ident" id="7559962">fmt</span><span class="op" id="7559965">.</span><span class="ident" id="7559966">Sprintf</span><span class="op" id="7559973">(</span><span class="string" id="7559974">&#34;%v&nbsp;run&nbsp;%d/%d&#34;</span><span class="op" id="7559988">,</span>&nbsp;<span class="ident" id="7559990">timeout</span><span class="op" id="7559997">,</span>&nbsp;<span class="ident" id="7559999">run</span><span class="op" id="7560002">+</span><span class="num" id="7560003">1</span><span class="op" id="7560004">,</span>&nbsp;<span class="ident" id="7560006">numRuns</span><span class="op" id="7560013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7560018">t</span><span class="op" id="7560019">.</span><span class="ident" id="7560020">Log</span><span class="op" id="7560023">(</span><span class="ident" id="7560024">name</span><span class="op" id="7560028">)</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7560034">c</span><span class="op" id="7560035">,</span>&nbsp;<span class="ident" id="7560037">err</span>&nbsp;<span class="op" id="7560041">:=</span>&nbsp;<span class="ident" id="7560044">Dial</span><span class="op" id="7560048">(</span><span class="string" id="7560049">&#34;tcp&#34;</span><span class="op" id="7560054">,</span>&nbsp;<span class="ident" id="7560056">ln</span><span class="op" id="7560058">.</span><span class="ident" id="7560059">Addr</span><span class="op" id="7560063">(</span><span class="op" id="7560064">)</span><span class="op" id="7560065">.</span><span class="ident" id="7560066">String</span><span class="op" id="7560072">(</span><span class="op" id="7560073">)</span><span class="op" id="7560074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7560079">if</span>&nbsp;<span class="ident" id="7560082">err</span>&nbsp;<span class="op" id="7560086">!=</span>&nbsp;<span class="ident" id="7560089">nil</span>&nbsp;<span class="op" id="7560093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7560099">t</span><span class="op" id="7560100">.</span><span class="ident" id="7560101">Fatalf</span><span class="op" id="7560107">(</span><span class="string" id="7560108">&#34;Dial:&nbsp;%v&#34;</span><span class="op" id="7560118">,</span>&nbsp;<span class="ident" id="7560120">err</span><span class="op" id="7560123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7560128">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7560133">clientc</span>&nbsp;<span class="op" id="7560141">:=</span>&nbsp;<span class="builtinfunc" id="7560144">make</span><span class="op" id="7560148">(</span><span class="keyword" id="7560149">chan</span>&nbsp;<span class="ident" id="7560154">copyRes</span><span class="op" id="7560161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7560166">go</span>&nbsp;<span class="keyword" id="7560169">func</span><span class="op" id="7560173">(</span><span class="op" id="7560174">)</span>&nbsp;<span class="op" id="7560176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7560182">t0</span>&nbsp;<span class="op" id="7560185">:=</span>&nbsp;<span class="ident" id="7560188">time</span><span class="op" id="7560192">.</span><span class="ident" id="7560193">Now</span><span class="op" id="7560196">(</span><span class="op" id="7560197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7560203">c</span><span class="op" id="7560204">.</span><span class="ident" id="7560205">SetDeadline</span><span class="op" id="7560216">(</span><span class="ident" id="7560217">t0</span><span class="op" id="7560219">.</span><span class="ident" id="7560220">Add</span><span class="op" id="7560223">(</span><span class="ident" id="7560224">timeout</span><span class="op" id="7560231">)</span><span class="op" id="7560232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7560238">n</span><span class="op" id="7560239">,</span>&nbsp;<span class="ident" id="7560241">err</span>&nbsp;<span class="op" id="7560245">:=</span>&nbsp;<span class="ident" id="7560248">io</span><span class="op" id="7560250">.</span><span class="ident" id="7560251">Copy</span><span class="op" id="7560255">(</span><span class="ident" id="7560256">ioutil</span><span class="op" id="7560262">.</span><span class="ident" id="7560263">Discard</span><span class="op" id="7560270">,</span>&nbsp;<span class="ident" id="7560272">c</span><span class="op" id="7560273">)</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7560279">d</span>&nbsp;<span class="op" id="7560281">:=</span>&nbsp;<span class="ident" id="7560284">time</span><span class="op" id="7560288">.</span><span class="ident" id="7560289">Since</span><span class="op" id="7560294">(</span><span class="ident" id="7560295">t0</span><span class="op" id="7560297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7560303">c</span><span class="op" id="7560304">.</span><span class="ident" id="7560305">Close</span><span class="op" id="7560310">(</span><span class="op" id="7560311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7560317">clientc</span>&nbsp;<span class="op" id="7560325">&lt;-</span>&nbsp;<span class="ident" id="7560328">copyRes</span><span class="op" id="7560335">{</span><span class="ident" id="7560336">n</span><span class="op" id="7560337">,</span>&nbsp;<span class="ident" id="7560339">err</span><span class="op" id="7560342">,</span>&nbsp;<span class="ident" id="7560344">d</span><span class="op" id="7560345">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7560350">}</span><span class="op" id="7560351">(</span><span class="op" id="7560352">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7560358">tooLong</span>&nbsp;<span class="op" id="7560366">:=</span>&nbsp;<span class="num" id="7560369">5</span>&nbsp;<span class="op" id="7560371">*</span>&nbsp;<span class="ident" id="7560373">time</span><span class="op" id="7560377">.</span><span class="ident" id="7560378">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7560388">select</span>&nbsp;<span class="op" id="7560395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7560400">case</span>&nbsp;<span class="ident" id="7560405">res</span>&nbsp;<span class="op" id="7560409">:=</span>&nbsp;<span class="op" id="7560412">&lt;-</span><span class="ident" id="7560414">clientc</span><span class="op" id="7560421">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7560427">if</span>&nbsp;<span class="ident" id="7560430">isTimeout</span><span class="op" id="7560439">(</span><span class="ident" id="7560440">res</span><span class="op" id="7560443">.</span><span class="ident" id="7560444">err</span><span class="op" id="7560447">)</span>&nbsp;<span class="op" id="7560449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7560456">t</span><span class="op" id="7560457">.</span><span class="ident" id="7560458">Logf</span><span class="op" id="7560462">(</span><span class="string" id="7560463">&#34;for&nbsp;%v,&nbsp;good&nbsp;client&nbsp;timeout&nbsp;after&nbsp;%v,&nbsp;reading&nbsp;%d&nbsp;bytes&#34;</span><span class="op" id="7560519">,</span>&nbsp;<span class="ident" id="7560521">name</span><span class="op" id="7560525">,</span>&nbsp;<span class="ident" id="7560527">res</span><span class="op" id="7560530">.</span><span class="ident" id="7560531">d</span><span class="op" id="7560532">,</span>&nbsp;<span class="ident" id="7560534">res</span><span class="op" id="7560537">.</span><span class="ident" id="7560538">n</span><span class="op" id="7560539">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7560545">}</span>&nbsp;<span class="keyword" id="7560547">else</span>&nbsp;<span class="op" id="7560552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7560559">t</span><span class="op" id="7560560">.</span><span class="ident" id="7560561">Fatalf</span><span class="op" id="7560567">(</span><span class="string" id="7560568">&#34;for&nbsp;%v:&nbsp;client&nbsp;Copy&nbsp;=&nbsp;%d,&nbsp;%v&nbsp;(want&nbsp;timeout)&#34;</span><span class="op" id="7560613">,</span>&nbsp;<span class="ident" id="7560615">name</span><span class="op" id="7560619">,</span>&nbsp;<span class="ident" id="7560621">res</span><span class="op" id="7560624">.</span><span class="ident" id="7560625">n</span><span class="op" id="7560626">,</span>&nbsp;<span class="ident" id="7560628">res</span><span class="op" id="7560631">.</span><span class="ident" id="7560632">err</span><span class="op" id="7560635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7560641">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7560646">case</span>&nbsp;<span class="op" id="7560651">&lt;-</span><span class="ident" id="7560653">time</span><span class="op" id="7560657">.</span><span class="ident" id="7560658">After</span><span class="op" id="7560663">(</span><span class="ident" id="7560664">tooLong</span><span class="op" id="7560671">)</span><span class="op" id="7560672">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7560678">t</span><span class="op" id="7560679">.</span><span class="ident" id="7560680">Fatalf</span><span class="op" id="7560686">(</span><span class="string" id="7560687">&#34;for&nbsp;%v:&nbsp;timeout&nbsp;(%v)&nbsp;waiting&nbsp;for&nbsp;client&nbsp;to&nbsp;timeout&nbsp;(%v)&nbsp;reading&#34;</span><span class="op" id="7560752">,</span>&nbsp;<span class="ident" id="7560754">name</span><span class="op" id="7560758">,</span>&nbsp;<span class="ident" id="7560760">tooLong</span><span class="op" id="7560767">,</span>&nbsp;<span class="ident" id="7560769">timeout</span><span class="op" id="7560776">)</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7560781">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7560787">select</span>&nbsp;<span class="op" id="7560794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7560799">case</span>&nbsp;<span class="ident" id="7560804">res</span>&nbsp;<span class="op" id="7560808">:=</span>&nbsp;<span class="op" id="7560811">&lt;-</span><span class="ident" id="7560813">servec</span><span class="op" id="7560819">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7560825">t</span><span class="op" id="7560826">.</span><span class="ident" id="7560827">Logf</span><span class="op" id="7560831">(</span><span class="string" id="7560832">&#34;for&nbsp;%v:&nbsp;server&nbsp;in&nbsp;%v&nbsp;wrote&nbsp;%d,&nbsp;%v&#34;</span><span class="op" id="7560867">,</span>&nbsp;<span class="ident" id="7560869">name</span><span class="op" id="7560873">,</span>&nbsp;<span class="ident" id="7560875">res</span><span class="op" id="7560878">.</span><span class="ident" id="7560879">d</span><span class="op" id="7560880">,</span>&nbsp;<span class="ident" id="7560882">res</span><span class="op" id="7560885">.</span><span class="ident" id="7560886">n</span><span class="op" id="7560887">,</span>&nbsp;<span class="ident" id="7560889">res</span><span class="op" id="7560892">.</span><span class="ident" id="7560893">err</span><span class="op" id="7560896">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7560901">case</span>&nbsp;<span class="ident" id="7560906">err</span>&nbsp;<span class="op" id="7560910">:=</span>&nbsp;<span class="op" id="7560913">&lt;-</span><span class="ident" id="7560915">acceptc</span><span class="op" id="7560922">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7560928">t</span><span class="op" id="7560929">.</span><span class="ident" id="7560930">Fatalf</span><span class="op" id="7560936">(</span><span class="string" id="7560937">&#34;for&nbsp;%v:&nbsp;server&nbsp;Accept&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7560965">,</span>&nbsp;<span class="ident" id="7560967">name</span><span class="op" id="7560971">,</span>&nbsp;<span class="ident" id="7560973">err</span><span class="op" id="7560976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7560981">case</span>&nbsp;<span class="op" id="7560986">&lt;-</span><span class="ident" id="7560988">time</span><span class="op" id="7560992">.</span><span class="ident" id="7560993">After</span><span class="op" id="7560998">(</span><span class="ident" id="7560999">tooLong</span><span class="op" id="7561006">)</span><span class="op" id="7561007">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7561013">t</span><span class="op" id="7561014">.</span><span class="ident" id="7561015">Fatalf</span><span class="op" id="7561021">(</span><span class="string" id="7561022">&#34;for&nbsp;%v,&nbsp;timeout&nbsp;waiting&nbsp;for&nbsp;server&nbsp;to&nbsp;finish&nbsp;writing&#34;</span><span class="op" id="7561076">,</span>&nbsp;<span class="ident" id="7561078">name</span><span class="op" id="7561082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7561087">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7561091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7561094">}</span><br>
<span class="lineno"></span><span class="op" id="7561096">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7561099">//&nbsp;TestReadDeadlineDataAvailable&nbsp;tests&nbsp;that&nbsp;read&nbsp;deadlines&nbsp;work,&nbsp;even</span><br>
<span class="lineno">525</span><span class="comment" id="7561169">//&nbsp;if&nbsp;there&#39;s&nbsp;data&nbsp;ready&nbsp;to&nbsp;be&nbsp;read.</span><br>
<span class="lineno"></span><span class="keyword" id="7561206">func</span>&nbsp;<span class="ident" id="7561211">TestReadDeadlineDataAvailable</span><span class="op" id="7561240">(</span><span class="ident" id="7561241">t</span>&nbsp;<span class="op" id="7561243">*</span><span class="ident" id="7561244">testing</span><span class="op" id="7561251">.</span><span class="ident" id="7561252">T</span><span class="op" id="7561253">)</span>&nbsp;<span class="op" id="7561255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7561258">switch</span>&nbsp;<span class="ident" id="7561265">runtime</span><span class="op" id="7561272">.</span><span class="ident" id="7561273">GOOS</span>&nbsp;<span class="op" id="7561278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7561281">case</span>&nbsp;<span class="string" id="7561286">&#34;plan9&#34;</span><span class="op" id="7561293">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7561297">t</span><span class="op" id="7561298">.</span><span class="ident" id="7561299">Skipf</span><span class="op" id="7561304">(</span><span class="string" id="7561305">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="7561326">,</span>&nbsp;<span class="ident" id="7561328">runtime</span><span class="op" id="7561335">.</span><span class="ident" id="7561336">GOOS</span><span class="op" id="7561340">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7561343">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7561347">ln</span>&nbsp;<span class="op" id="7561350">:=</span>&nbsp;<span class="ident" id="7561353">newLocalListener</span><span class="op" id="7561369">(</span><span class="ident" id="7561370">t</span><span class="op" id="7561371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7561374">defer</span>&nbsp;<span class="ident" id="7561380">ln</span><span class="op" id="7561382">.</span><span class="ident" id="7561383">Close</span><span class="op" id="7561388">(</span><span class="op" id="7561389">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7561393">servec</span>&nbsp;<span class="op" id="7561400">:=</span>&nbsp;<span class="builtinfunc" id="7561403">make</span><span class="op" id="7561407">(</span><span class="keyword" id="7561408">chan</span>&nbsp;<span class="ident" id="7561413">copyRes</span><span class="op" id="7561420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7561423">const</span>&nbsp;<span class="ident" id="7561429">msg</span>&nbsp;<span class="op" id="7561433">=</span>&nbsp;<span class="string" id="7561435">&#34;data&nbsp;client&nbsp;shouldn&#39;t&nbsp;read,&nbsp;even&nbsp;though&nbsp;it&#39;ll&nbsp;be&nbsp;waiting&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7561495">go</span>&nbsp;<span class="keyword" id="7561498">func</span><span class="op" id="7561502">(</span><span class="op" id="7561503">)</span>&nbsp;<span class="op" id="7561505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7561509">c</span><span class="op" id="7561510">,</span>&nbsp;<span class="ident" id="7561512">err</span>&nbsp;<span class="op" id="7561516">:=</span>&nbsp;<span class="ident" id="7561519">ln</span><span class="op" id="7561521">.</span><span class="ident" id="7561522">Accept</span><span class="op" id="7561528">(</span><span class="op" id="7561529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7561533">if</span>&nbsp;<span class="ident" id="7561536">err</span>&nbsp;<span class="op" id="7561540">!=</span>&nbsp;<span class="ident" id="7561543">nil</span>&nbsp;<span class="op" id="7561547">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7561552">t</span><span class="op" id="7561553">.</span><span class="ident" id="7561554">Errorf</span><span class="op" id="7561560">(</span><span class="string" id="7561561">&#34;Accept:&nbsp;%v&#34;</span><span class="op" id="7561573">,</span>&nbsp;<span class="ident" id="7561575">err</span><span class="op" id="7561578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7561583">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7561592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7561596">defer</span>&nbsp;<span class="ident" id="7561602">c</span><span class="op" id="7561603">.</span><span class="ident" id="7561604">Close</span><span class="op" id="7561609">(</span><span class="op" id="7561610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7561614">n</span><span class="op" id="7561615">,</span>&nbsp;<span class="ident" id="7561617">err</span>&nbsp;<span class="op" id="7561621">:=</span>&nbsp;<span class="ident" id="7561624">c</span><span class="op" id="7561625">.</span><span class="ident" id="7561626">Write</span><span class="op" id="7561631">(</span><span class="op" id="7561632">[</span><span class="op" id="7561633">]</span><span class="builtintype" id="7561634">byte</span><span class="op" id="7561638">(</span><span class="ident" id="7561639">msg</span><span class="op" id="7561642">)</span><span class="op" id="7561643">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7561647">servec</span>&nbsp;<span class="op" id="7561654">&lt;-</span>&nbsp;<span class="ident" id="7561657">copyRes</span><span class="op" id="7561664">{</span><span class="ident" id="7561665">n</span><span class="op" id="7561666">:</span>&nbsp;<span class="ident" id="7561668">int64</span><span class="op" id="7561673">(</span><span class="ident" id="7561674">n</span><span class="op" id="7561675">)</span><span class="op" id="7561676">,</span>&nbsp;<span class="ident" id="7561678">err</span><span class="op" id="7561681">:</span>&nbsp;<span class="ident" id="7561683">err</span><span class="op" id="7561686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7561689">}</span><span class="op" id="7561690">(</span><span class="op" id="7561691">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7561695">c</span><span class="op" id="7561696">,</span>&nbsp;<span class="ident" id="7561698">err</span>&nbsp;<span class="op" id="7561702">:=</span>&nbsp;<span class="ident" id="7561705">Dial</span><span class="op" id="7561709">(</span><span class="string" id="7561710">&#34;tcp&#34;</span><span class="op" id="7561715">,</span>&nbsp;<span class="ident" id="7561717">ln</span><span class="op" id="7561719">.</span><span class="ident" id="7561720">Addr</span><span class="op" id="7561724">(</span><span class="op" id="7561725">)</span><span class="op" id="7561726">.</span><span class="ident" id="7561727">String</span><span class="op" id="7561733">(</span><span class="op" id="7561734">)</span><span class="op" id="7561735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7561738">if</span>&nbsp;<span class="ident" id="7561741">err</span>&nbsp;<span class="op" id="7561745">!=</span>&nbsp;<span class="ident" id="7561748">nil</span>&nbsp;<span class="op" id="7561752">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7561756">t</span><span class="op" id="7561757">.</span><span class="ident" id="7561758">Fatalf</span><span class="op" id="7561764">(</span><span class="string" id="7561765">&#34;Dial:&nbsp;%v&#34;</span><span class="op" id="7561775">,</span>&nbsp;<span class="ident" id="7561777">err</span><span class="op" id="7561780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7561783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7561786">defer</span>&nbsp;<span class="ident" id="7561792">c</span><span class="op" id="7561793">.</span><span class="ident" id="7561794">Close</span><span class="op" id="7561799">(</span><span class="op" id="7561800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7561803">if</span>&nbsp;<span class="ident" id="7561806">res</span>&nbsp;<span class="op" id="7561810">:=</span>&nbsp;<span class="op" id="7561813">&lt;-</span><span class="ident" id="7561815">servec</span><span class="op" id="7561821">;</span>&nbsp;<span class="ident" id="7561823">res</span><span class="op" id="7561826">.</span><span class="ident" id="7561827">err</span>&nbsp;<span class="op" id="7561831">!=</span>&nbsp;<span class="ident" id="7561834">nil</span>&nbsp;<span class="op" id="7561838">||</span>&nbsp;<span class="ident" id="7561841">res</span><span class="op" id="7561844">.</span><span class="ident" id="7561845">n</span>&nbsp;<span class="op" id="7561847">!=</span>&nbsp;<span class="ident" id="7561850">int64</span><span class="op" id="7561855">(</span><span class="builtinfunc" id="7561856">len</span><span class="op" id="7561859">(</span><span class="ident" id="7561860">msg</span><span class="op" id="7561863">)</span><span class="op" id="7561864">)</span>&nbsp;<span class="op" id="7561866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7561870">t</span><span class="op" id="7561871">.</span><span class="ident" id="7561872">Fatalf</span><span class="op" id="7561878">(</span><span class="string" id="7561879">&#34;unexpected&nbsp;server&nbsp;Write:&nbsp;n=%d,&nbsp;err=%v;&nbsp;want&nbsp;n=%d,&nbsp;err=nil&#34;</span><span class="op" id="7561938">,</span>&nbsp;<span class="ident" id="7561940">res</span><span class="op" id="7561943">.</span><span class="ident" id="7561944">n</span><span class="op" id="7561945">,</span>&nbsp;<span class="ident" id="7561947">res</span><span class="op" id="7561950">.</span><span class="ident" id="7561951">err</span><span class="op" id="7561954">,</span>&nbsp;<span class="builtinfunc" id="7561956">len</span><span class="op" id="7561959">(</span><span class="ident" id="7561960">msg</span><span class="op" id="7561963">)</span><span class="op" id="7561964">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7561967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7561970">c</span><span class="op" id="7561971">.</span><span class="ident" id="7561972">SetReadDeadline</span><span class="op" id="7561987">(</span><span class="ident" id="7561988">time</span><span class="op" id="7561992">.</span><span class="ident" id="7561993">Now</span><span class="op" id="7561996">(</span><span class="op" id="7561997">)</span><span class="op" id="7561998">.</span><span class="ident" id="7561999">Add</span><span class="op" id="7562002">(</span><span class="op" id="7562003">-</span><span class="num" id="7562004">5</span>&nbsp;<span class="op" id="7562006">*</span>&nbsp;<span class="ident" id="7562008">time</span><span class="op" id="7562012">.</span><span class="ident" id="7562013">Second</span><span class="op" id="7562019">)</span><span class="op" id="7562020">)</span>&nbsp;<span class="comment" id="7562022">//&nbsp;in&nbsp;the&nbsp;psat.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7562039">buf</span>&nbsp;<span class="op" id="7562043">:=</span>&nbsp;<span class="builtinfunc" id="7562046">make</span><span class="op" id="7562050">(</span><span class="op" id="7562051">[</span><span class="op" id="7562052">]</span><span class="builtintype" id="7562053">byte</span><span class="op" id="7562057">,</span>&nbsp;<span class="builtinfunc" id="7562059">len</span><span class="op" id="7562062">(</span><span class="ident" id="7562063">msg</span><span class="op" id="7562066">)</span><span class="op" id="7562067">/</span><span class="num" id="7562068">2</span><span class="op" id="7562069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7562072">n</span><span class="op" id="7562073">,</span>&nbsp;<span class="ident" id="7562075">err</span>&nbsp;<span class="op" id="7562079">:=</span>&nbsp;<span class="ident" id="7562082">c</span><span class="op" id="7562083">.</span><span class="ident" id="7562084">Read</span><span class="op" id="7562088">(</span><span class="ident" id="7562089">buf</span><span class="op" id="7562092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7562095">if</span>&nbsp;<span class="ident" id="7562098">n</span>&nbsp;<span class="op" id="7562100">&gt;</span>&nbsp;<span class="num" id="7562102">0</span>&nbsp;<span class="op" id="7562104">||</span>&nbsp;<span class="op" id="7562107">!</span><span class="ident" id="7562108">isTimeout</span><span class="op" id="7562117">(</span><span class="ident" id="7562118">err</span><span class="op" id="7562121">)</span>&nbsp;<span class="op" id="7562123">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7562127">t</span><span class="op" id="7562128">.</span><span class="ident" id="7562129">Fatalf</span><span class="op" id="7562135">(</span><span class="string" id="7562136">&#34;client&nbsp;read&nbsp;=&nbsp;%d&nbsp;(%q)&nbsp;err=%v;&nbsp;want&nbsp;0,&nbsp;timeout&#34;</span><span class="op" id="7562183">,</span>&nbsp;<span class="ident" id="7562185">n</span><span class="op" id="7562186">,</span>&nbsp;<span class="ident" id="7562188">buf</span><span class="op" id="7562191">[</span><span class="op" id="7562192">:</span><span class="ident" id="7562193">n</span><span class="op" id="7562194">]</span><span class="op" id="7562195">,</span>&nbsp;<span class="ident" id="7562197">err</span><span class="op" id="7562200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7562203">}</span><br>
<span class="lineno"></span><span class="op" id="7562205">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7562208">//&nbsp;TestWriteDeadlineBufferAvailable&nbsp;tests&nbsp;that&nbsp;write&nbsp;deadlines&nbsp;work,&nbsp;even</span><br>
<span class="lineno">565</span><span class="comment" id="7562282">//&nbsp;if&nbsp;there&#39;s&nbsp;buffer&nbsp;space&nbsp;available&nbsp;to&nbsp;write.</span><br>
<span class="lineno"></span><span class="keyword" id="7562329">func</span>&nbsp;<span class="ident" id="7562334">TestWriteDeadlineBufferAvailable</span><span class="op" id="7562366">(</span><span class="ident" id="7562367">t</span>&nbsp;<span class="op" id="7562369">*</span><span class="ident" id="7562370">testing</span><span class="op" id="7562377">.</span><span class="ident" id="7562378">T</span><span class="op" id="7562379">)</span>&nbsp;<span class="op" id="7562381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7562384">switch</span>&nbsp;<span class="ident" id="7562391">runtime</span><span class="op" id="7562398">.</span><span class="ident" id="7562399">GOOS</span>&nbsp;<span class="op" id="7562404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7562407">case</span>&nbsp;<span class="string" id="7562412">&#34;plan9&#34;</span><span class="op" id="7562419">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7562423">t</span><span class="op" id="7562424">.</span><span class="ident" id="7562425">Skipf</span><span class="op" id="7562430">(</span><span class="string" id="7562431">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="7562452">,</span>&nbsp;<span class="ident" id="7562454">runtime</span><span class="op" id="7562461">.</span><span class="ident" id="7562462">GOOS</span><span class="op" id="7562466">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7562469">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7562473">ln</span>&nbsp;<span class="op" id="7562476">:=</span>&nbsp;<span class="ident" id="7562479">newLocalListener</span><span class="op" id="7562495">(</span><span class="ident" id="7562496">t</span><span class="op" id="7562497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7562500">defer</span>&nbsp;<span class="ident" id="7562506">ln</span><span class="op" id="7562508">.</span><span class="ident" id="7562509">Close</span><span class="op" id="7562514">(</span><span class="op" id="7562515">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7562519">servec</span>&nbsp;<span class="op" id="7562526">:=</span>&nbsp;<span class="builtinfunc" id="7562529">make</span><span class="op" id="7562533">(</span><span class="keyword" id="7562534">chan</span>&nbsp;<span class="ident" id="7562539">copyRes</span><span class="op" id="7562546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7562549">go</span>&nbsp;<span class="keyword" id="7562552">func</span><span class="op" id="7562556">(</span><span class="op" id="7562557">)</span>&nbsp;<span class="op" id="7562559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7562563">c</span><span class="op" id="7562564">,</span>&nbsp;<span class="ident" id="7562566">err</span>&nbsp;<span class="op" id="7562570">:=</span>&nbsp;<span class="ident" id="7562573">ln</span><span class="op" id="7562575">.</span><span class="ident" id="7562576">Accept</span><span class="op" id="7562582">(</span><span class="op" id="7562583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7562587">if</span>&nbsp;<span class="ident" id="7562590">err</span>&nbsp;<span class="op" id="7562594">!=</span>&nbsp;<span class="ident" id="7562597">nil</span>&nbsp;<span class="op" id="7562601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7562606">t</span><span class="op" id="7562607">.</span><span class="ident" id="7562608">Errorf</span><span class="op" id="7562614">(</span><span class="string" id="7562615">&#34;Accept:&nbsp;%v&#34;</span><span class="op" id="7562627">,</span>&nbsp;<span class="ident" id="7562629">err</span><span class="op" id="7562632">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7562637">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7562646">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7562650">defer</span>&nbsp;<span class="ident" id="7562656">c</span><span class="op" id="7562657">.</span><span class="ident" id="7562658">Close</span><span class="op" id="7562663">(</span><span class="op" id="7562664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7562668">c</span><span class="op" id="7562669">.</span><span class="ident" id="7562670">SetWriteDeadline</span><span class="op" id="7562686">(</span><span class="ident" id="7562687">time</span><span class="op" id="7562691">.</span><span class="ident" id="7562692">Now</span><span class="op" id="7562695">(</span><span class="op" id="7562696">)</span><span class="op" id="7562697">.</span><span class="ident" id="7562698">Add</span><span class="op" id="7562701">(</span><span class="op" id="7562702">-</span><span class="num" id="7562703">5</span>&nbsp;<span class="op" id="7562705">*</span>&nbsp;<span class="ident" id="7562707">time</span><span class="op" id="7562711">.</span><span class="ident" id="7562712">Second</span><span class="op" id="7562718">)</span><span class="op" id="7562719">)</span>&nbsp;<span class="comment" id="7562721">//&nbsp;in&nbsp;the&nbsp;past</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7562738">n</span><span class="op" id="7562739">,</span>&nbsp;<span class="ident" id="7562741">err</span>&nbsp;<span class="op" id="7562745">:=</span>&nbsp;<span class="ident" id="7562748">c</span><span class="op" id="7562749">.</span><span class="ident" id="7562750">Write</span><span class="op" id="7562755">(</span><span class="op" id="7562756">[</span><span class="op" id="7562757">]</span><span class="builtintype" id="7562758">byte</span><span class="op" id="7562762">{</span><span class="string" id="7562763">&#39;x&#39;</span><span class="op" id="7562766">}</span><span class="op" id="7562767">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7562771">servec</span>&nbsp;<span class="op" id="7562778">&lt;-</span>&nbsp;<span class="ident" id="7562781">copyRes</span><span class="op" id="7562788">{</span><span class="ident" id="7562789">n</span><span class="op" id="7562790">:</span>&nbsp;<span class="ident" id="7562792">int64</span><span class="op" id="7562797">(</span><span class="ident" id="7562798">n</span><span class="op" id="7562799">)</span><span class="op" id="7562800">,</span>&nbsp;<span class="ident" id="7562802">err</span><span class="op" id="7562805">:</span>&nbsp;<span class="ident" id="7562807">err</span><span class="op" id="7562810">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7562813">}</span><span class="op" id="7562814">(</span><span class="op" id="7562815">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7562819">c</span><span class="op" id="7562820">,</span>&nbsp;<span class="ident" id="7562822">err</span>&nbsp;<span class="op" id="7562826">:=</span>&nbsp;<span class="ident" id="7562829">Dial</span><span class="op" id="7562833">(</span><span class="string" id="7562834">&#34;tcp&#34;</span><span class="op" id="7562839">,</span>&nbsp;<span class="ident" id="7562841">ln</span><span class="op" id="7562843">.</span><span class="ident" id="7562844">Addr</span><span class="op" id="7562848">(</span><span class="op" id="7562849">)</span><span class="op" id="7562850">.</span><span class="ident" id="7562851">String</span><span class="op" id="7562857">(</span><span class="op" id="7562858">)</span><span class="op" id="7562859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7562862">if</span>&nbsp;<span class="ident" id="7562865">err</span>&nbsp;<span class="op" id="7562869">!=</span>&nbsp;<span class="ident" id="7562872">nil</span>&nbsp;<span class="op" id="7562876">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7562880">t</span><span class="op" id="7562881">.</span><span class="ident" id="7562882">Fatalf</span><span class="op" id="7562888">(</span><span class="string" id="7562889">&#34;Dial:&nbsp;%v&#34;</span><span class="op" id="7562899">,</span>&nbsp;<span class="ident" id="7562901">err</span><span class="op" id="7562904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7562907">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7562910">defer</span>&nbsp;<span class="ident" id="7562916">c</span><span class="op" id="7562917">.</span><span class="ident" id="7562918">Close</span><span class="op" id="7562923">(</span><span class="op" id="7562924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7562927">res</span>&nbsp;<span class="op" id="7562931">:=</span>&nbsp;<span class="op" id="7562934">&lt;-</span><span class="ident" id="7562936">servec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7562944">if</span>&nbsp;<span class="ident" id="7562947">res</span><span class="op" id="7562950">.</span><span class="ident" id="7562951">n</span>&nbsp;<span class="op" id="7562953">!=</span>&nbsp;<span class="num" id="7562956">0</span>&nbsp;<span class="op" id="7562958">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7562962">t</span><span class="op" id="7562963">.</span><span class="ident" id="7562964">Errorf</span><span class="op" id="7562970">(</span><span class="string" id="7562971">&#34;Write&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="7562991">,</span>&nbsp;<span class="ident" id="7562993">res</span><span class="op" id="7562996">.</span><span class="ident" id="7562997">n</span><span class="op" id="7562998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7563001">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7563004">if</span>&nbsp;<span class="op" id="7563007">!</span><span class="ident" id="7563008">isTimeout</span><span class="op" id="7563017">(</span><span class="ident" id="7563018">res</span><span class="op" id="7563021">.</span><span class="ident" id="7563022">err</span><span class="op" id="7563025">)</span>&nbsp;<span class="op" id="7563027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7563031">t</span><span class="op" id="7563032">.</span><span class="ident" id="7563033">Errorf</span><span class="op" id="7563039">(</span><span class="string" id="7563040">&#34;Write&nbsp;error&nbsp;=&nbsp;%v;&nbsp;want&nbsp;timeout&#34;</span><span class="op" id="7563072">,</span>&nbsp;<span class="ident" id="7563074">res</span><span class="op" id="7563077">.</span><span class="ident" id="7563078">err</span><span class="op" id="7563081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7563084">}</span><br>
<span class="lineno">600</span><span class="op" id="7563086">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7563089">//&nbsp;TestAcceptDeadlineConnectionAvailable&nbsp;tests&nbsp;that&nbsp;accept&nbsp;deadlines&nbsp;work,&nbsp;even</span><br>
<span class="lineno"></span><span class="comment" id="7563169">//&nbsp;if&nbsp;there&#39;s&nbsp;incoming&nbsp;connections&nbsp;available.</span><br>
<span class="lineno"></span><span class="keyword" id="7563215">func</span>&nbsp;<span class="ident" id="7563220">TestAcceptDeadlineConnectionAvailable</span><span class="op" id="7563257">(</span><span class="ident" id="7563258">t</span>&nbsp;<span class="op" id="7563260">*</span><span class="ident" id="7563261">testing</span><span class="op" id="7563268">.</span><span class="ident" id="7563269">T</span><span class="op" id="7563270">)</span>&nbsp;<span class="op" id="7563272">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7563275">switch</span>&nbsp;<span class="ident" id="7563282">runtime</span><span class="op" id="7563289">.</span><span class="ident" id="7563290">GOOS</span>&nbsp;<span class="op" id="7563295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7563298">case</span>&nbsp;<span class="string" id="7563303">&#34;plan9&#34;</span><span class="op" id="7563310">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7563314">t</span><span class="op" id="7563315">.</span><span class="ident" id="7563316">Skipf</span><span class="op" id="7563321">(</span><span class="string" id="7563322">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="7563343">,</span>&nbsp;<span class="ident" id="7563345">runtime</span><span class="op" id="7563352">.</span><span class="ident" id="7563353">GOOS</span><span class="op" id="7563357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7563360">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7563364">ln</span>&nbsp;<span class="op" id="7563367">:=</span>&nbsp;<span class="ident" id="7563370">newLocalListener</span><span class="op" id="7563386">(</span><span class="ident" id="7563387">t</span><span class="op" id="7563388">)</span><span class="op" id="7563389">.</span><span class="op" id="7563390">(</span><span class="op" id="7563391">*</span><span class="ident" id="7563392">TCPListener</span><span class="op" id="7563403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7563406">defer</span>&nbsp;<span class="ident" id="7563412">ln</span><span class="op" id="7563414">.</span><span class="ident" id="7563415">Close</span><span class="op" id="7563420">(</span><span class="op" id="7563421">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7563425">go</span>&nbsp;<span class="keyword" id="7563428">func</span><span class="op" id="7563432">(</span><span class="op" id="7563433">)</span>&nbsp;<span class="op" id="7563435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7563439">c</span><span class="op" id="7563440">,</span>&nbsp;<span class="ident" id="7563442">err</span>&nbsp;<span class="op" id="7563446">:=</span>&nbsp;<span class="ident" id="7563449">Dial</span><span class="op" id="7563453">(</span><span class="string" id="7563454">&#34;tcp&#34;</span><span class="op" id="7563459">,</span>&nbsp;<span class="ident" id="7563461">ln</span><span class="op" id="7563463">.</span><span class="ident" id="7563464">Addr</span><span class="op" id="7563468">(</span><span class="op" id="7563469">)</span><span class="op" id="7563470">.</span><span class="ident" id="7563471">String</span><span class="op" id="7563477">(</span><span class="op" id="7563478">)</span><span class="op" id="7563479">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7563483">if</span>&nbsp;<span class="ident" id="7563486">err</span>&nbsp;<span class="op" id="7563490">!=</span>&nbsp;<span class="ident" id="7563493">nil</span>&nbsp;<span class="op" id="7563497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7563502">t</span><span class="op" id="7563503">.</span><span class="ident" id="7563504">Errorf</span><span class="op" id="7563510">(</span><span class="string" id="7563511">&#34;Dial:&nbsp;%v&#34;</span><span class="op" id="7563521">,</span>&nbsp;<span class="ident" id="7563523">err</span><span class="op" id="7563526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7563531">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7563540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7563544">defer</span>&nbsp;<span class="ident" id="7563550">c</span><span class="op" id="7563551">.</span><span class="ident" id="7563552">Close</span><span class="op" id="7563557">(</span><span class="op" id="7563558">)</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7563562">var</span>&nbsp;<span class="ident" id="7563566">buf</span>&nbsp;<span class="op" id="7563570">[</span><span class="num" id="7563571">1</span><span class="op" id="7563572">]</span><span class="builtintype" id="7563573">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7563580">c</span><span class="op" id="7563581">.</span><span class="ident" id="7563582">Read</span><span class="op" id="7563586">(</span><span class="ident" id="7563587">buf</span><span class="op" id="7563590">[</span><span class="op" id="7563591">:</span><span class="op" id="7563592">]</span><span class="op" id="7563593">)</span>&nbsp;<span class="comment" id="7563595">//&nbsp;block&nbsp;until&nbsp;the&nbsp;connection&nbsp;or&nbsp;listener&nbsp;is&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7563648">}</span><span class="op" id="7563649">(</span><span class="op" id="7563650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7563653">time</span><span class="op" id="7563657">.</span><span class="ident" id="7563658">Sleep</span><span class="op" id="7563663">(</span><span class="num" id="7563664">10</span>&nbsp;<span class="op" id="7563667">*</span>&nbsp;<span class="ident" id="7563669">time</span><span class="op" id="7563673">.</span><span class="ident" id="7563674">Millisecond</span><span class="op" id="7563685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7563688">ln</span><span class="op" id="7563690">.</span><span class="ident" id="7563691">SetDeadline</span><span class="op" id="7563702">(</span><span class="ident" id="7563703">time</span><span class="op" id="7563707">.</span><span class="ident" id="7563708">Now</span><span class="op" id="7563711">(</span><span class="op" id="7563712">)</span><span class="op" id="7563713">.</span><span class="ident" id="7563714">Add</span><span class="op" id="7563717">(</span><span class="op" id="7563718">-</span><span class="num" id="7563719">5</span>&nbsp;<span class="op" id="7563721">*</span>&nbsp;<span class="ident" id="7563723">time</span><span class="op" id="7563727">.</span><span class="ident" id="7563728">Second</span><span class="op" id="7563734">)</span><span class="op" id="7563735">)</span>&nbsp;<span class="comment" id="7563737">//&nbsp;in&nbsp;the&nbsp;past</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7563753">c</span><span class="op" id="7563754">,</span>&nbsp;<span class="ident" id="7563756">err</span>&nbsp;<span class="op" id="7563760">:=</span>&nbsp;<span class="ident" id="7563763">ln</span><span class="op" id="7563765">.</span><span class="ident" id="7563766">Accept</span><span class="op" id="7563772">(</span><span class="op" id="7563773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7563776">if</span>&nbsp;<span class="ident" id="7563779">err</span>&nbsp;<span class="op" id="7563783">==</span>&nbsp;<span class="ident" id="7563786">nil</span>&nbsp;<span class="op" id="7563790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7563794">defer</span>&nbsp;<span class="ident" id="7563800">c</span><span class="op" id="7563801">.</span><span class="ident" id="7563802">Close</span><span class="op" id="7563807">(</span><span class="op" id="7563808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7563811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7563814">if</span>&nbsp;<span class="op" id="7563817">!</span><span class="ident" id="7563818">isTimeout</span><span class="op" id="7563827">(</span><span class="ident" id="7563828">err</span><span class="op" id="7563831">)</span>&nbsp;<span class="op" id="7563833">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7563837">t</span><span class="op" id="7563838">.</span><span class="ident" id="7563839">Fatalf</span><span class="op" id="7563845">(</span><span class="string" id="7563846">&#34;Accept:&nbsp;got&nbsp;%v;&nbsp;want&nbsp;timeout&#34;</span><span class="op" id="7563876">,</span>&nbsp;<span class="ident" id="7563878">err</span><span class="op" id="7563881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7563884">}</span><br>
<span class="lineno"></span><span class="op" id="7563886">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7563889">//&nbsp;TestConnectDeadlineInThePast&nbsp;tests&nbsp;that&nbsp;connect&nbsp;deadlines&nbsp;work,&nbsp;even</span><br>
<span class="lineno">635</span><span class="comment" id="7563961">//&nbsp;if&nbsp;the&nbsp;connection&nbsp;can&nbsp;be&nbsp;established&nbsp;w/o&nbsp;blocking.</span><br>
<span class="lineno"></span><span class="keyword" id="7564015">func</span>&nbsp;<span class="ident" id="7564020">TestConnectDeadlineInThePast</span><span class="op" id="7564048">(</span><span class="ident" id="7564049">t</span>&nbsp;<span class="op" id="7564051">*</span><span class="ident" id="7564052">testing</span><span class="op" id="7564059">.</span><span class="ident" id="7564060">T</span><span class="op" id="7564061">)</span>&nbsp;<span class="op" id="7564063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7564066">switch</span>&nbsp;<span class="ident" id="7564073">runtime</span><span class="op" id="7564080">.</span><span class="ident" id="7564081">GOOS</span>&nbsp;<span class="op" id="7564086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7564089">case</span>&nbsp;<span class="string" id="7564094">&#34;plan9&#34;</span><span class="op" id="7564101">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7564105">t</span><span class="op" id="7564106">.</span><span class="ident" id="7564107">Skipf</span><span class="op" id="7564112">(</span><span class="string" id="7564113">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="7564134">,</span>&nbsp;<span class="ident" id="7564136">runtime</span><span class="op" id="7564143">.</span><span class="ident" id="7564144">GOOS</span><span class="op" id="7564148">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7564151">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7564155">ln</span>&nbsp;<span class="op" id="7564158">:=</span>&nbsp;<span class="ident" id="7564161">newLocalListener</span><span class="op" id="7564177">(</span><span class="ident" id="7564178">t</span><span class="op" id="7564179">)</span><span class="op" id="7564180">.</span><span class="op" id="7564181">(</span><span class="op" id="7564182">*</span><span class="ident" id="7564183">TCPListener</span><span class="op" id="7564194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7564197">defer</span>&nbsp;<span class="ident" id="7564203">ln</span><span class="op" id="7564205">.</span><span class="ident" id="7564206">Close</span><span class="op" id="7564211">(</span><span class="op" id="7564212">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7564216">go</span>&nbsp;<span class="keyword" id="7564219">func</span><span class="op" id="7564223">(</span><span class="op" id="7564224">)</span>&nbsp;<span class="op" id="7564226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7564230">c</span><span class="op" id="7564231">,</span>&nbsp;<span class="ident" id="7564233">err</span>&nbsp;<span class="op" id="7564237">:=</span>&nbsp;<span class="ident" id="7564240">ln</span><span class="op" id="7564242">.</span><span class="ident" id="7564243">Accept</span><span class="op" id="7564249">(</span><span class="op" id="7564250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7564254">if</span>&nbsp;<span class="ident" id="7564257">err</span>&nbsp;<span class="op" id="7564261">==</span>&nbsp;<span class="ident" id="7564264">nil</span>&nbsp;<span class="op" id="7564268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7564273">defer</span>&nbsp;<span class="ident" id="7564279">c</span><span class="op" id="7564280">.</span><span class="ident" id="7564281">Close</span><span class="op" id="7564286">(</span><span class="op" id="7564287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7564291">}</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7564294">}</span><span class="op" id="7564295">(</span><span class="op" id="7564296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7564299">time</span><span class="op" id="7564303">.</span><span class="ident" id="7564304">Sleep</span><span class="op" id="7564309">(</span><span class="num" id="7564310">10</span>&nbsp;<span class="op" id="7564313">*</span>&nbsp;<span class="ident" id="7564315">time</span><span class="op" id="7564319">.</span><span class="ident" id="7564320">Millisecond</span><span class="op" id="7564331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7564334">c</span><span class="op" id="7564335">,</span>&nbsp;<span class="ident" id="7564337">err</span>&nbsp;<span class="op" id="7564341">:=</span>&nbsp;<span class="ident" id="7564344">DialTimeout</span><span class="op" id="7564355">(</span><span class="string" id="7564356">&#34;tcp&#34;</span><span class="op" id="7564361">,</span>&nbsp;<span class="ident" id="7564363">ln</span><span class="op" id="7564365">.</span><span class="ident" id="7564366">Addr</span><span class="op" id="7564370">(</span><span class="op" id="7564371">)</span><span class="op" id="7564372">.</span><span class="ident" id="7564373">String</span><span class="op" id="7564379">(</span><span class="op" id="7564380">)</span><span class="op" id="7564381">,</span>&nbsp;<span class="op" id="7564383">-</span><span class="num" id="7564384">5</span><span class="op" id="7564385">*</span><span class="ident" id="7564386">time</span><span class="op" id="7564390">.</span><span class="ident" id="7564391">Second</span><span class="op" id="7564397">)</span>&nbsp;<span class="comment" id="7564399">//&nbsp;in&nbsp;the&nbsp;past</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7564415">if</span>&nbsp;<span class="ident" id="7564418">err</span>&nbsp;<span class="op" id="7564422">==</span>&nbsp;<span class="ident" id="7564425">nil</span>&nbsp;<span class="op" id="7564429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7564433">defer</span>&nbsp;<span class="ident" id="7564439">c</span><span class="op" id="7564440">.</span><span class="ident" id="7564441">Close</span><span class="op" id="7564446">(</span><span class="op" id="7564447">)</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7564450">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7564453">if</span>&nbsp;<span class="op" id="7564456">!</span><span class="ident" id="7564457">isTimeout</span><span class="op" id="7564466">(</span><span class="ident" id="7564467">err</span><span class="op" id="7564470">)</span>&nbsp;<span class="op" id="7564472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7564476">t</span><span class="op" id="7564477">.</span><span class="ident" id="7564478">Fatalf</span><span class="op" id="7564484">(</span><span class="string" id="7564485">&#34;DialTimeout:&nbsp;got&nbsp;%v;&nbsp;want&nbsp;timeout&#34;</span><span class="op" id="7564520">,</span>&nbsp;<span class="ident" id="7564522">err</span><span class="op" id="7564525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7564528">}</span><br>
<span class="lineno"></span><span class="op" id="7564530">}</span><br>
<span class="lineno">660</span><br>
<span class="lineno"></span><span class="comment" id="7564533">//&nbsp;TestProlongTimeout&nbsp;tests&nbsp;concurrent&nbsp;deadline&nbsp;modification.</span><br>
<span class="lineno"></span><span class="comment" id="7564595">//&nbsp;Known&nbsp;to&nbsp;cause&nbsp;data&nbsp;races&nbsp;in&nbsp;the&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="7564637">func</span>&nbsp;<span class="ident" id="7564642">TestProlongTimeout</span><span class="op" id="7564660">(</span><span class="ident" id="7564661">t</span>&nbsp;<span class="op" id="7564663">*</span><span class="ident" id="7564664">testing</span><span class="op" id="7564671">.</span><span class="ident" id="7564672">T</span><span class="op" id="7564673">)</span>&nbsp;<span class="op" id="7564675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7564678">switch</span>&nbsp;<span class="ident" id="7564685">runtime</span><span class="op" id="7564692">.</span><span class="ident" id="7564693">GOOS</span>&nbsp;<span class="op" id="7564698">{</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7564701">case</span>&nbsp;<span class="string" id="7564706">&#34;plan9&#34;</span><span class="op" id="7564713">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7564717">t</span><span class="op" id="7564718">.</span><span class="ident" id="7564719">Skipf</span><span class="op" id="7564724">(</span><span class="string" id="7564725">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="7564746">,</span>&nbsp;<span class="ident" id="7564748">runtime</span><span class="op" id="7564755">.</span><span class="ident" id="7564756">GOOS</span><span class="op" id="7564760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7564763">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7564767">ln</span>&nbsp;<span class="op" id="7564770">:=</span>&nbsp;<span class="ident" id="7564773">newLocalListener</span><span class="op" id="7564789">(</span><span class="ident" id="7564790">t</span><span class="op" id="7564791">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7564794">defer</span>&nbsp;<span class="ident" id="7564800">ln</span><span class="op" id="7564802">.</span><span class="ident" id="7564803">Close</span><span class="op" id="7564808">(</span><span class="op" id="7564809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7564812">connected</span>&nbsp;<span class="op" id="7564822">:=</span>&nbsp;<span class="builtinfunc" id="7564825">make</span><span class="op" id="7564829">(</span><span class="keyword" id="7564830">chan</span>&nbsp;<span class="builtintype" id="7564835">bool</span><span class="op" id="7564839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7564842">go</span>&nbsp;<span class="keyword" id="7564845">func</span><span class="op" id="7564849">(</span><span class="op" id="7564850">)</span>&nbsp;<span class="op" id="7564852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7564856">s</span><span class="op" id="7564857">,</span>&nbsp;<span class="ident" id="7564859">err</span>&nbsp;<span class="op" id="7564863">:=</span>&nbsp;<span class="ident" id="7564866">ln</span><span class="op" id="7564868">.</span><span class="ident" id="7564869">Accept</span><span class="op" id="7564875">(</span><span class="op" id="7564876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7564880">connected</span>&nbsp;<span class="op" id="7564890">&lt;-</span>&nbsp;<span class="ident" id="7564893">true</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7564900">if</span>&nbsp;<span class="ident" id="7564903">err</span>&nbsp;<span class="op" id="7564907">!=</span>&nbsp;<span class="ident" id="7564910">nil</span>&nbsp;<span class="op" id="7564914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7564919">t</span><span class="op" id="7564920">.</span><span class="ident" id="7564921">Errorf</span><span class="op" id="7564927">(</span><span class="string" id="7564928">&#34;ln.Accept:&nbsp;%v&#34;</span><span class="op" id="7564943">,</span>&nbsp;<span class="ident" id="7564945">err</span><span class="op" id="7564948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7564953">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7564962">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7564966">defer</span>&nbsp;<span class="ident" id="7564972">s</span><span class="op" id="7564973">.</span><span class="ident" id="7564974">Close</span><span class="op" id="7564979">(</span><span class="op" id="7564980">)</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7564984">s</span><span class="op" id="7564985">.</span><span class="ident" id="7564986">SetDeadline</span><span class="op" id="7564997">(</span><span class="ident" id="7564998">time</span><span class="op" id="7565002">.</span><span class="ident" id="7565003">Now</span><span class="op" id="7565006">(</span><span class="op" id="7565007">)</span><span class="op" id="7565008">.</span><span class="ident" id="7565009">Add</span><span class="op" id="7565012">(</span><span class="ident" id="7565013">time</span><span class="op" id="7565017">.</span><span class="ident" id="7565018">Hour</span><span class="op" id="7565022">)</span><span class="op" id="7565023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7565027">go</span>&nbsp;<span class="keyword" id="7565030">func</span><span class="op" id="7565034">(</span><span class="op" id="7565035">)</span>&nbsp;<span class="op" id="7565037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7565042">var</span>&nbsp;<span class="ident" id="7565046">buf</span>&nbsp;<span class="op" id="7565050">[</span><span class="num" id="7565051">4096</span><span class="op" id="7565055">]</span><span class="builtintype" id="7565056">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7565064">for</span>&nbsp;<span class="op" id="7565068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7565074">_</span><span class="op" id="7565075">,</span>&nbsp;<span class="ident" id="7565077">err</span>&nbsp;<span class="op" id="7565081">:=</span>&nbsp;<span class="ident" id="7565084">s</span><span class="op" id="7565085">.</span><span class="ident" id="7565086">Write</span><span class="op" id="7565091">(</span><span class="ident" id="7565092">buf</span><span class="op" id="7565095">[</span><span class="op" id="7565096">:</span><span class="op" id="7565097">]</span><span class="op" id="7565098">)</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7565104">if</span>&nbsp;<span class="ident" id="7565107">err</span>&nbsp;<span class="op" id="7565111">!=</span>&nbsp;<span class="ident" id="7565114">nil</span>&nbsp;<span class="op" id="7565118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7565125">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7565135">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7565141">s</span><span class="op" id="7565142">.</span><span class="ident" id="7565143">SetDeadline</span><span class="op" id="7565154">(</span><span class="ident" id="7565155">time</span><span class="op" id="7565159">.</span><span class="ident" id="7565160">Now</span><span class="op" id="7565163">(</span><span class="op" id="7565164">)</span><span class="op" id="7565165">.</span><span class="ident" id="7565166">Add</span><span class="op" id="7565169">(</span><span class="ident" id="7565170">time</span><span class="op" id="7565174">.</span><span class="ident" id="7565175">Hour</span><span class="op" id="7565179">)</span><span class="op" id="7565180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7565185">}</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7565189">}</span><span class="op" id="7565190">(</span><span class="op" id="7565191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7565195">buf</span>&nbsp;<span class="op" id="7565199">:=</span>&nbsp;<span class="builtinfunc" id="7565202">make</span><span class="op" id="7565206">(</span><span class="op" id="7565207">[</span><span class="op" id="7565208">]</span><span class="builtintype" id="7565209">byte</span><span class="op" id="7565213">,</span>&nbsp;<span class="num" id="7565215">1</span><span class="op" id="7565216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7565220">for</span>&nbsp;<span class="op" id="7565224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7565229">_</span><span class="op" id="7565230">,</span>&nbsp;<span class="ident" id="7565232">err</span>&nbsp;<span class="op" id="7565236">:=</span>&nbsp;<span class="ident" id="7565239">s</span><span class="op" id="7565240">.</span><span class="ident" id="7565241">Read</span><span class="op" id="7565245">(</span><span class="ident" id="7565246">buf</span><span class="op" id="7565249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7565254">if</span>&nbsp;<span class="ident" id="7565257">err</span>&nbsp;<span class="op" id="7565261">!=</span>&nbsp;<span class="ident" id="7565264">nil</span>&nbsp;<span class="op" id="7565268">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7565274">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7565283">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7565288">s</span><span class="op" id="7565289">.</span><span class="ident" id="7565290">SetDeadline</span><span class="op" id="7565301">(</span><span class="ident" id="7565302">time</span><span class="op" id="7565306">.</span><span class="ident" id="7565307">Now</span><span class="op" id="7565310">(</span><span class="op" id="7565311">)</span><span class="op" id="7565312">.</span><span class="ident" id="7565313">Add</span><span class="op" id="7565316">(</span><span class="ident" id="7565317">time</span><span class="op" id="7565321">.</span><span class="ident" id="7565322">Hour</span><span class="op" id="7565326">)</span><span class="op" id="7565327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7565331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7565334">}</span><span class="op" id="7565335">(</span><span class="op" id="7565336">)</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7565339">c</span><span class="op" id="7565340">,</span>&nbsp;<span class="ident" id="7565342">err</span>&nbsp;<span class="op" id="7565346">:=</span>&nbsp;<span class="ident" id="7565349">Dial</span><span class="op" id="7565353">(</span><span class="string" id="7565354">&#34;tcp&#34;</span><span class="op" id="7565359">,</span>&nbsp;<span class="ident" id="7565361">ln</span><span class="op" id="7565363">.</span><span class="ident" id="7565364">Addr</span><span class="op" id="7565368">(</span><span class="op" id="7565369">)</span><span class="op" id="7565370">.</span><span class="ident" id="7565371">String</span><span class="op" id="7565377">(</span><span class="op" id="7565378">)</span><span class="op" id="7565379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7565382">if</span>&nbsp;<span class="ident" id="7565385">err</span>&nbsp;<span class="op" id="7565389">!=</span>&nbsp;<span class="ident" id="7565392">nil</span>&nbsp;<span class="op" id="7565396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7565400">t</span><span class="op" id="7565401">.</span><span class="ident" id="7565402">Fatalf</span><span class="op" id="7565408">(</span><span class="string" id="7565409">&#34;DialTCP:&nbsp;%v&#34;</span><span class="op" id="7565422">,</span>&nbsp;<span class="ident" id="7565424">err</span><span class="op" id="7565427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7565430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7565433">defer</span>&nbsp;<span class="ident" id="7565439">c</span><span class="op" id="7565440">.</span><span class="ident" id="7565441">Close</span><span class="op" id="7565446">(</span><span class="op" id="7565447">)</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7565450">&lt;-</span><span class="ident" id="7565452">connected</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7565463">for</span>&nbsp;<span class="ident" id="7565467">i</span>&nbsp;<span class="op" id="7565469">:=</span>&nbsp;<span class="num" id="7565472">0</span><span class="op" id="7565473">;</span>&nbsp;<span class="ident" id="7565475">i</span>&nbsp;<span class="op" id="7565477">&lt;</span>&nbsp;<span class="num" id="7565479">1024</span><span class="op" id="7565483">;</span>&nbsp;<span class="ident" id="7565485">i</span><span class="op" id="7565486">++</span>&nbsp;<span class="op" id="7565489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7565493">var</span>&nbsp;<span class="ident" id="7565497">buf</span>&nbsp;<span class="op" id="7565501">[</span><span class="num" id="7565502">1</span><span class="op" id="7565503">]</span><span class="builtintype" id="7565504">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7565511">c</span><span class="op" id="7565512">.</span><span class="ident" id="7565513">Write</span><span class="op" id="7565518">(</span><span class="ident" id="7565519">buf</span><span class="op" id="7565522">[</span><span class="op" id="7565523">:</span><span class="op" id="7565524">]</span><span class="op" id="7565525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7565528">}</span><br>
<span class="lineno">710</span><span class="op" id="7565530">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7565533">func</span>&nbsp;<span class="ident" id="7565538">TestDeadlineRace</span><span class="op" id="7565554">(</span><span class="ident" id="7565555">t</span>&nbsp;<span class="op" id="7565557">*</span><span class="ident" id="7565558">testing</span><span class="op" id="7565565">.</span><span class="ident" id="7565566">T</span><span class="op" id="7565567">)</span>&nbsp;<span class="op" id="7565569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7565572">switch</span>&nbsp;<span class="ident" id="7565579">runtime</span><span class="op" id="7565586">.</span><span class="ident" id="7565587">GOOS</span>&nbsp;<span class="op" id="7565592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7565595">case</span>&nbsp;<span class="string" id="7565600">&#34;nacl&#34;</span><span class="op" id="7565606">,</span>&nbsp;<span class="string" id="7565608">&#34;plan9&#34;</span><span class="op" id="7565615">:</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7565619">t</span><span class="op" id="7565620">.</span><span class="ident" id="7565621">Skipf</span><span class="op" id="7565626">(</span><span class="string" id="7565627">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="7565648">,</span>&nbsp;<span class="ident" id="7565650">runtime</span><span class="op" id="7565657">.</span><span class="ident" id="7565658">GOOS</span><span class="op" id="7565662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7565665">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7565669">N</span>&nbsp;<span class="op" id="7565671">:=</span>&nbsp;<span class="num" id="7565674">1000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7565680">if</span>&nbsp;<span class="ident" id="7565683">testing</span><span class="op" id="7565690">.</span><span class="ident" id="7565691">Short</span><span class="op" id="7565696">(</span><span class="op" id="7565697">)</span>&nbsp;<span class="op" id="7565699">{</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7565703">N</span>&nbsp;<span class="op" id="7565705">=</span>&nbsp;<span class="num" id="7565707">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7565711">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7565714">defer</span>&nbsp;<span class="ident" id="7565720">runtime</span><span class="op" id="7565727">.</span><span class="ident" id="7565728">GOMAXPROCS</span><span class="op" id="7565738">(</span><span class="ident" id="7565739">runtime</span><span class="op" id="7565746">.</span><span class="ident" id="7565747">GOMAXPROCS</span><span class="op" id="7565757">(</span><span class="num" id="7565758">4</span><span class="op" id="7565759">)</span><span class="op" id="7565760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7565763">ln</span>&nbsp;<span class="op" id="7565766">:=</span>&nbsp;<span class="ident" id="7565769">newLocalListener</span><span class="op" id="7565785">(</span><span class="ident" id="7565786">t</span><span class="op" id="7565787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7565790">defer</span>&nbsp;<span class="ident" id="7565796">ln</span><span class="op" id="7565798">.</span><span class="ident" id="7565799">Close</span><span class="op" id="7565804">(</span><span class="op" id="7565805">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7565808">c</span><span class="op" id="7565809">,</span>&nbsp;<span class="ident" id="7565811">err</span>&nbsp;<span class="op" id="7565815">:=</span>&nbsp;<span class="ident" id="7565818">Dial</span><span class="op" id="7565822">(</span><span class="string" id="7565823">&#34;tcp&#34;</span><span class="op" id="7565828">,</span>&nbsp;<span class="ident" id="7565830">ln</span><span class="op" id="7565832">.</span><span class="ident" id="7565833">Addr</span><span class="op" id="7565837">(</span><span class="op" id="7565838">)</span><span class="op" id="7565839">.</span><span class="ident" id="7565840">String</span><span class="op" id="7565846">(</span><span class="op" id="7565847">)</span><span class="op" id="7565848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7565851">if</span>&nbsp;<span class="ident" id="7565854">err</span>&nbsp;<span class="op" id="7565858">!=</span>&nbsp;<span class="ident" id="7565861">nil</span>&nbsp;<span class="op" id="7565865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7565869">t</span><span class="op" id="7565870">.</span><span class="ident" id="7565871">Fatalf</span><span class="op" id="7565877">(</span><span class="string" id="7565878">&#34;Dial:&nbsp;%v&#34;</span><span class="op" id="7565888">,</span>&nbsp;<span class="ident" id="7565890">err</span><span class="op" id="7565893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7565896">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7565899">defer</span>&nbsp;<span class="ident" id="7565905">c</span><span class="op" id="7565906">.</span><span class="ident" id="7565907">Close</span><span class="op" id="7565912">(</span><span class="op" id="7565913">)</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7565916">done</span>&nbsp;<span class="op" id="7565921">:=</span>&nbsp;<span class="builtinfunc" id="7565924">make</span><span class="op" id="7565928">(</span><span class="keyword" id="7565929">chan</span>&nbsp;<span class="builtintype" id="7565934">bool</span><span class="op" id="7565938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7565941">go</span>&nbsp;<span class="keyword" id="7565944">func</span><span class="op" id="7565948">(</span><span class="op" id="7565949">)</span>&nbsp;<span class="op" id="7565951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7565955">t</span>&nbsp;<span class="op" id="7565957">:=</span>&nbsp;<span class="ident" id="7565960">time</span><span class="op" id="7565964">.</span><span class="ident" id="7565965">NewTicker</span><span class="op" id="7565974">(</span><span class="num" id="7565975">2</span>&nbsp;<span class="op" id="7565977">*</span>&nbsp;<span class="ident" id="7565979">time</span><span class="op" id="7565983">.</span><span class="ident" id="7565984">Microsecond</span><span class="op" id="7565995">)</span><span class="op" id="7565996">.</span><span class="ident" id="7565997">C</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7566001">for</span>&nbsp;<span class="ident" id="7566005">i</span>&nbsp;<span class="op" id="7566007">:=</span>&nbsp;<span class="num" id="7566010">0</span><span class="op" id="7566011">;</span>&nbsp;<span class="ident" id="7566013">i</span>&nbsp;<span class="op" id="7566015">&lt;</span>&nbsp;<span class="ident" id="7566017">N</span><span class="op" id="7566018">;</span>&nbsp;<span class="ident" id="7566020">i</span><span class="op" id="7566021">++</span>&nbsp;<span class="op" id="7566024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7566029">if</span>&nbsp;<span class="ident" id="7566032">err</span>&nbsp;<span class="op" id="7566036">:=</span>&nbsp;<span class="ident" id="7566039">c</span><span class="op" id="7566040">.</span><span class="ident" id="7566041">SetDeadline</span><span class="op" id="7566052">(</span><span class="ident" id="7566053">time</span><span class="op" id="7566057">.</span><span class="ident" id="7566058">Now</span><span class="op" id="7566061">(</span><span class="op" id="7566062">)</span><span class="op" id="7566063">.</span><span class="ident" id="7566064">Add</span><span class="op" id="7566067">(</span><span class="num" id="7566068">2</span>&nbsp;<span class="op" id="7566070">*</span>&nbsp;<span class="ident" id="7566072">time</span><span class="op" id="7566076">.</span><span class="ident" id="7566077">Microsecond</span><span class="op" id="7566088">)</span><span class="op" id="7566089">)</span><span class="op" id="7566090">;</span>&nbsp;<span class="ident" id="7566092">err</span>&nbsp;<span class="op" id="7566096">!=</span>&nbsp;<span class="ident" id="7566099">nil</span>&nbsp;<span class="op" id="7566103">{</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7566109">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7566118">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7566123">&lt;-</span><span class="ident" id="7566125">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7566129">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7566133">done</span>&nbsp;<span class="op" id="7566138">&lt;-</span>&nbsp;<span class="ident" id="7566141">true</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7566147">}</span><span class="op" id="7566148">(</span><span class="op" id="7566149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7566152">var</span>&nbsp;<span class="ident" id="7566156">buf</span>&nbsp;<span class="op" id="7566160">[</span><span class="num" id="7566161">1</span><span class="op" id="7566162">]</span><span class="builtintype" id="7566163">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7566169">for</span>&nbsp;<span class="ident" id="7566173">i</span>&nbsp;<span class="op" id="7566175">:=</span>&nbsp;<span class="num" id="7566178">0</span><span class="op" id="7566179">;</span>&nbsp;<span class="ident" id="7566181">i</span>&nbsp;<span class="op" id="7566183">&lt;</span>&nbsp;<span class="ident" id="7566185">N</span><span class="op" id="7566186">;</span>&nbsp;<span class="ident" id="7566188">i</span><span class="op" id="7566189">++</span>&nbsp;<span class="op" id="7566192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7566196">c</span><span class="op" id="7566197">.</span><span class="ident" id="7566198">Read</span><span class="op" id="7566202">(</span><span class="ident" id="7566203">buf</span><span class="op" id="7566206">[</span><span class="op" id="7566207">:</span><span class="op" id="7566208">]</span><span class="op" id="7566209">)</span>&nbsp;<span class="comment" id="7566211">//&nbsp;ignore&nbsp;possible&nbsp;timeout&nbsp;errors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7566246">}</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7566249">c</span><span class="op" id="7566250">.</span><span class="ident" id="7566251">Close</span><span class="op" id="7566256">(</span><span class="op" id="7566257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7566260">&lt;-</span><span class="ident" id="7566262">done</span><br>
<span class="lineno"></span><span class="op" id="7566267">}</span>
</div>
</body>
</html>
