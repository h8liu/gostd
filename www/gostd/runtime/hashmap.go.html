<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html" class="current">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1480496">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1480551">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1480605">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1480656">package</span>&nbsp;<span class="ident" id="1480664">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1480673">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;implementation&nbsp;of&nbsp;Go&#39;s&nbsp;map&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="1480732">//</span><br>
<span class="lineno"></span><span class="comment" id="1480735">//&nbsp;A&nbsp;map&nbsp;is&nbsp;just&nbsp;a&nbsp;hash&nbsp;table.&nbsp;&nbsp;The&nbsp;data&nbsp;is&nbsp;arranged</span><br>
<span class="lineno">10</span><span class="comment" id="1480788">//&nbsp;into&nbsp;an&nbsp;array&nbsp;of&nbsp;buckets.&nbsp;&nbsp;Each&nbsp;bucket&nbsp;contains&nbsp;up&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1480845">//&nbsp;8&nbsp;key/value&nbsp;pairs.&nbsp;&nbsp;The&nbsp;low-order&nbsp;bits&nbsp;of&nbsp;the&nbsp;hash&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="1480903">//&nbsp;used&nbsp;to&nbsp;select&nbsp;a&nbsp;bucket.&nbsp;&nbsp;Each&nbsp;bucket&nbsp;contains&nbsp;a&nbsp;few</span><br>
<span class="lineno"></span><span class="comment" id="1480959">//&nbsp;high-order&nbsp;bits&nbsp;of&nbsp;each&nbsp;hash&nbsp;to&nbsp;distinguish&nbsp;the&nbsp;entries</span><br>
<span class="lineno"></span><span class="comment" id="1481018">//&nbsp;within&nbsp;a&nbsp;single&nbsp;bucket.</span><br>
<span class="lineno">15</span><span class="comment" id="1481045">//</span><br>
<span class="lineno"></span><span class="comment" id="1481048">//&nbsp;If&nbsp;more&nbsp;than&nbsp;8&nbsp;keys&nbsp;hash&nbsp;to&nbsp;a&nbsp;bucket,&nbsp;we&nbsp;chain&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="1481101">//&nbsp;extra&nbsp;buckets.</span><br>
<span class="lineno"></span><span class="comment" id="1481119">//</span><br>
<span class="lineno"></span><span class="comment" id="1481122">//&nbsp;When&nbsp;the&nbsp;hashtable&nbsp;grows,&nbsp;we&nbsp;allocate&nbsp;a&nbsp;new&nbsp;array</span><br>
<span class="lineno">20</span><span class="comment" id="1481175">//&nbsp;of&nbsp;buckets&nbsp;twice&nbsp;as&nbsp;big.&nbsp;&nbsp;Buckets&nbsp;are&nbsp;incrementally</span><br>
<span class="lineno"></span><span class="comment" id="1481230">//&nbsp;copied&nbsp;from&nbsp;the&nbsp;old&nbsp;bucket&nbsp;array&nbsp;to&nbsp;the&nbsp;new&nbsp;bucket&nbsp;array.</span><br>
<span class="lineno"></span><span class="comment" id="1481291">//</span><br>
<span class="lineno"></span><span class="comment" id="1481294">//&nbsp;Map&nbsp;iterators&nbsp;walk&nbsp;through&nbsp;the&nbsp;array&nbsp;of&nbsp;buckets&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1481349">//&nbsp;return&nbsp;the&nbsp;keys&nbsp;in&nbsp;walk&nbsp;order&nbsp;(bucket&nbsp;#,&nbsp;then&nbsp;overflow</span><br>
<span class="lineno">25</span><span class="comment" id="1481407">//&nbsp;chain&nbsp;order,&nbsp;then&nbsp;bucket&nbsp;index).&nbsp;&nbsp;To&nbsp;maintain&nbsp;iteration</span><br>
<span class="lineno"></span><span class="comment" id="1481466">//&nbsp;semantics,&nbsp;we&nbsp;never&nbsp;move&nbsp;keys&nbsp;within&nbsp;their&nbsp;bucket&nbsp;(if</span><br>
<span class="lineno"></span><span class="comment" id="1481523">//&nbsp;we&nbsp;did,&nbsp;keys&nbsp;might&nbsp;be&nbsp;returned&nbsp;0&nbsp;or&nbsp;2&nbsp;times).&nbsp;&nbsp;When</span><br>
<span class="lineno"></span><span class="comment" id="1481578">//&nbsp;growing&nbsp;the&nbsp;table,&nbsp;iterators&nbsp;remain&nbsp;iterating&nbsp;through&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1481639">//&nbsp;old&nbsp;table&nbsp;and&nbsp;must&nbsp;check&nbsp;the&nbsp;new&nbsp;table&nbsp;if&nbsp;the&nbsp;bucket</span><br>
<span class="lineno">30</span><span class="comment" id="1481695">//&nbsp;they&nbsp;are&nbsp;iterating&nbsp;through&nbsp;has&nbsp;been&nbsp;moved&nbsp;(&#34;evacuated&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="1481754">//&nbsp;to&nbsp;the&nbsp;new&nbsp;table.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1481776">//&nbsp;Picking&nbsp;loadFactor:&nbsp;too&nbsp;large&nbsp;and&nbsp;we&nbsp;have&nbsp;lots&nbsp;of&nbsp;overflow</span><br>
<span class="lineno"></span><span class="comment" id="1481838">//&nbsp;buckets,&nbsp;too&nbsp;small&nbsp;and&nbsp;we&nbsp;waste&nbsp;a&nbsp;lot&nbsp;of&nbsp;space.&nbsp;&nbsp;I&nbsp;wrote</span><br>
<span class="lineno">35</span><span class="comment" id="1481898">//&nbsp;a&nbsp;simple&nbsp;program&nbsp;to&nbsp;check&nbsp;some&nbsp;stats&nbsp;for&nbsp;different&nbsp;loads:</span><br>
<span class="lineno"></span><span class="comment" id="1481959">//&nbsp;(64-bit,&nbsp;8&nbsp;byte&nbsp;keys&nbsp;and&nbsp;values)</span><br>
<span class="lineno"></span><span class="comment" id="1481995">//&nbsp;&nbsp;loadFactor&nbsp;&nbsp;&nbsp;&nbsp;%overflow&nbsp;&nbsp;bytes/entry&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hitprobe&nbsp;&nbsp;&nbsp;&nbsp;missprobe</span><br>
<span class="lineno"></span><span class="comment" id="1482062">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2.13&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20.77&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.00</span><br>
<span class="lineno"></span><span class="comment" id="1482129">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.05&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;17.30&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.25&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.50</span><br>
<span class="lineno">40</span><span class="comment" id="1482196">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.85&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;14.77&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.00</span><br>
<span class="lineno"></span><span class="comment" id="1482263">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10.55&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;12.94&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.75&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.50</span><br>
<span class="lineno"></span><span class="comment" id="1482330">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;15.27&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;11.67&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.00</span><br>
<span class="lineno"></span><span class="comment" id="1482397">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20.90&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10.79&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.25&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.50</span><br>
<span class="lineno"></span><span class="comment" id="1482464">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;27.14&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10.15&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.00</span><br>
<span class="lineno">45</span><span class="comment" id="1482531">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;34.03&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;9.73&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.75&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.50</span><br>
<span class="lineno"></span><span class="comment" id="1482598">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;8.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;41.10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;9.40&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;8.00</span><br>
<span class="lineno"></span><span class="comment" id="1482665">//</span><br>
<span class="lineno"></span><span class="comment" id="1482668">//&nbsp;%overflow&nbsp;&nbsp;&nbsp;=&nbsp;percentage&nbsp;of&nbsp;buckets&nbsp;which&nbsp;have&nbsp;an&nbsp;overflow&nbsp;bucket</span><br>
<span class="lineno"></span><span class="comment" id="1482737">//&nbsp;bytes/entry&nbsp;=&nbsp;overhead&nbsp;bytes&nbsp;used&nbsp;per&nbsp;key/value&nbsp;pair</span><br>
<span class="lineno">50</span><span class="comment" id="1482793">//&nbsp;hitprobe&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;#&nbsp;of&nbsp;entries&nbsp;to&nbsp;check&nbsp;when&nbsp;looking&nbsp;up&nbsp;a&nbsp;present&nbsp;key</span><br>
<span class="lineno"></span><span class="comment" id="1482862">//&nbsp;missprobe&nbsp;&nbsp;&nbsp;=&nbsp;#&nbsp;of&nbsp;entries&nbsp;to&nbsp;check&nbsp;when&nbsp;looking&nbsp;up&nbsp;an&nbsp;absent&nbsp;key</span><br>
<span class="lineno"></span><span class="comment" id="1482931">//</span><br>
<span class="lineno"></span><span class="comment" id="1482934">//&nbsp;Keep&nbsp;in&nbsp;mind&nbsp;this&nbsp;data&nbsp;is&nbsp;for&nbsp;maximally&nbsp;loaded&nbsp;tables,&nbsp;i.e.&nbsp;just</span><br>
<span class="lineno"></span><span class="comment" id="1483002">//&nbsp;before&nbsp;the&nbsp;table&nbsp;grows.&nbsp;&nbsp;Typical&nbsp;tables&nbsp;will&nbsp;be&nbsp;somewhat&nbsp;less&nbsp;loaded.</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="1483076">import</span>&nbsp;<span class="op" id="1483083">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1483086">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1483095">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="1483098">const</span>&nbsp;<span class="op" id="1483104">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1483107">//&nbsp;Maximum&nbsp;number&nbsp;of&nbsp;key/value&nbsp;pairs&nbsp;a&nbsp;bucket&nbsp;can&nbsp;hold.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1483164">bucketCntBits</span>&nbsp;<span class="op" id="1483178">=</span>&nbsp;<span class="num" id="1483180">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1483183">bucketCnt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1483197">=</span>&nbsp;<span class="num" id="1483199">1</span>&nbsp;<span class="op" id="1483201">&lt;&lt;</span>&nbsp;<span class="ident" id="1483204">bucketCntBits</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1483220">//&nbsp;Maximum&nbsp;average&nbsp;load&nbsp;of&nbsp;a&nbsp;bucket&nbsp;that&nbsp;triggers&nbsp;growth.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1483279">loadFactor</span>&nbsp;<span class="op" id="1483290">=</span>&nbsp;<span class="num" id="1483292">6.5</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1483298">//&nbsp;Maximum&nbsp;key&nbsp;or&nbsp;value&nbsp;size&nbsp;to&nbsp;keep&nbsp;inline&nbsp;(instead&nbsp;of&nbsp;mallocing&nbsp;per&nbsp;element).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1483379">//&nbsp;Must&nbsp;fit&nbsp;in&nbsp;a&nbsp;uint8.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1483404">//&nbsp;Fast&nbsp;versions&nbsp;cannot&nbsp;handle&nbsp;big&nbsp;values&nbsp;-&nbsp;the&nbsp;cutoff&nbsp;size&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1483469">//&nbsp;fast&nbsp;versions&nbsp;in&nbsp;../../cmd/gc/walk.c&nbsp;must&nbsp;be&nbsp;at&nbsp;most&nbsp;this&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1483538">maxKeySize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1483551">=</span>&nbsp;<span class="num" id="1483553">128</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1483558">maxValueSize</span>&nbsp;<span class="op" id="1483571">=</span>&nbsp;<span class="num" id="1483573">128</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1483579">//&nbsp;data&nbsp;offset&nbsp;should&nbsp;be&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;bmap&nbsp;struct,&nbsp;but&nbsp;needs&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1483650">//&nbsp;aligned&nbsp;correctly.&nbsp;&nbsp;For&nbsp;amd64p32&nbsp;this&nbsp;means&nbsp;64-bit&nbsp;alignment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1483715">//&nbsp;even&nbsp;though&nbsp;pointers&nbsp;are&nbsp;32&nbsp;bit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1483752">dataOffset</span>&nbsp;<span class="op" id="1483763">=</span>&nbsp;<span class="ident" id="1483765">unsafe</span><span class="op" id="1483771">.</span><span class="ident" id="1483772">Offsetof</span><span class="op" id="1483780">(</span><span class="keyword" id="1483781">struct</span>&nbsp;<span class="op" id="1483788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1483792">b</span>&nbsp;<span class="ident" id="1483794">bmap</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1483801">v</span>&nbsp;<span class="ident" id="1483803">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1483810">}</span><span class="op" id="1483811">{</span><span class="op" id="1483812">}</span><span class="op" id="1483813">.</span><span class="ident" id="1483814">v</span><span class="op" id="1483815">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1483819">//&nbsp;Possible&nbsp;tophash&nbsp;values.&nbsp;&nbsp;We&nbsp;reserve&nbsp;a&nbsp;few&nbsp;possibilities&nbsp;for&nbsp;special&nbsp;marks.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1483899">//&nbsp;Each&nbsp;bucket&nbsp;(including&nbsp;its&nbsp;overflow&nbsp;buckets,&nbsp;if&nbsp;any)&nbsp;will&nbsp;have&nbsp;either&nbsp;all&nbsp;or&nbsp;none&nbsp;of&nbsp;its</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1483992">//&nbsp;entries&nbsp;in&nbsp;the&nbsp;evacuated*&nbsp;states&nbsp;(except&nbsp;during&nbsp;the&nbsp;evacuate()&nbsp;method,&nbsp;which&nbsp;only&nbsp;happens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1484086">//&nbsp;during&nbsp;map&nbsp;writes&nbsp;and&nbsp;thus&nbsp;no&nbsp;one&nbsp;else&nbsp;can&nbsp;observe&nbsp;the&nbsp;map&nbsp;during&nbsp;that&nbsp;time).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1484168">empty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1484183">=</span>&nbsp;<span class="num" id="1484185">0</span>&nbsp;<span class="comment" id="1484187">//&nbsp;cell&nbsp;is&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1484205">evacuatedEmpty</span>&nbsp;<span class="op" id="1484220">=</span>&nbsp;<span class="num" id="1484222">1</span>&nbsp;<span class="comment" id="1484224">//&nbsp;cell&nbsp;is&nbsp;empty,&nbsp;bucket&nbsp;is&nbsp;evacuated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1484264">evacuatedX</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1484279">=</span>&nbsp;<span class="num" id="1484281">2</span>&nbsp;<span class="comment" id="1484283">//&nbsp;key/value&nbsp;is&nbsp;valid.&nbsp;&nbsp;Entry&nbsp;has&nbsp;been&nbsp;evacuated&nbsp;to&nbsp;first&nbsp;half&nbsp;of&nbsp;larger&nbsp;table.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1484364">evacuatedY</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1484379">=</span>&nbsp;<span class="num" id="1484381">3</span>&nbsp;<span class="comment" id="1484383">//&nbsp;same&nbsp;as&nbsp;above,&nbsp;but&nbsp;evacuated&nbsp;to&nbsp;second&nbsp;half&nbsp;of&nbsp;larger&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1484448">minTopHash</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1484463">=</span>&nbsp;<span class="num" id="1484465">4</span>&nbsp;<span class="comment" id="1484467">//&nbsp;minimum&nbsp;tophash&nbsp;for&nbsp;a&nbsp;normal&nbsp;filled&nbsp;cell.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1484514">//&nbsp;flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1484524">iterator</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1484536">=</span>&nbsp;<span class="num" id="1484538">1</span>&nbsp;<span class="comment" id="1484540">//&nbsp;there&nbsp;may&nbsp;be&nbsp;an&nbsp;iterator&nbsp;using&nbsp;buckets</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1484583">oldIterator</span>&nbsp;<span class="op" id="1484595">=</span>&nbsp;<span class="num" id="1484597">2</span>&nbsp;<span class="comment" id="1484599">//&nbsp;there&nbsp;may&nbsp;be&nbsp;an&nbsp;iterator&nbsp;using&nbsp;oldbuckets</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1484646">//&nbsp;sentinel&nbsp;bucket&nbsp;ID&nbsp;for&nbsp;iterator&nbsp;checks</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1484689">noCheck</span>&nbsp;<span class="op" id="1484697">=</span>&nbsp;<span class="num" id="1484699">1</span><span class="op" id="1484700">&lt;&lt;</span><span class="op" id="1484702">(</span><span class="num" id="1484703">8</span><span class="op" id="1484704">*</span><span class="ident" id="1484705">ptrSize</span><span class="op" id="1484712">)</span>&nbsp;<span class="op" id="1484714">-</span>&nbsp;<span class="num" id="1484716">1</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1484720">//&nbsp;trigger&nbsp;a&nbsp;garbage&nbsp;collection&nbsp;at&nbsp;every&nbsp;alloc&nbsp;called&nbsp;from&nbsp;this&nbsp;code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1484790">checkgc</span>&nbsp;<span class="op" id="1484798">=</span>&nbsp;<span class="builtintype" id="1484800">false</span><br>
<span class="lineno"></span><span class="op" id="1484806">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1484809">//&nbsp;A&nbsp;header&nbsp;for&nbsp;a&nbsp;Go&nbsp;map.</span><br>
<span class="lineno">105</span><span class="keyword" id="1484835">type</span>&nbsp;<span class="ident" id="1484840">hmap</span>&nbsp;<span class="keyword" id="1484845">struct</span>&nbsp;<span class="op" id="1484852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1484855">//&nbsp;Note:&nbsp;the&nbsp;format&nbsp;of&nbsp;the&nbsp;Hmap&nbsp;is&nbsp;encoded&nbsp;in&nbsp;../../cmd/gc/reflect.c&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1484929">//&nbsp;../reflect/type.go.&nbsp;&nbsp;Don&#39;t&nbsp;change&nbsp;this&nbsp;structure&nbsp;without&nbsp;also&nbsp;changing&nbsp;that&nbsp;code!</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1485015">count</span>&nbsp;<span class="builtintype" id="1485021">int</span>&nbsp;<span class="comment" id="1485025">//&nbsp;#&nbsp;live&nbsp;cells&nbsp;==&nbsp;size&nbsp;of&nbsp;map.&nbsp;&nbsp;Must&nbsp;be&nbsp;first&nbsp;(used&nbsp;by&nbsp;len()&nbsp;builtin)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1485097">flags</span>&nbsp;<span class="builtintype" id="1485103">uint32</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1485111">hash0</span>&nbsp;<span class="builtintype" id="1485117">uint32</span>&nbsp;<span class="comment" id="1485124">//&nbsp;hash&nbsp;seed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1485138">B</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1485144">uint8</span>&nbsp;&nbsp;<span class="comment" id="1485151">//&nbsp;log_2&nbsp;of&nbsp;#&nbsp;of&nbsp;buckets&nbsp;(can&nbsp;hold&nbsp;up&nbsp;to&nbsp;loadFactor&nbsp;*&nbsp;2^B&nbsp;items)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1485218">buckets</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1485229">unsafe</span><span class="op" id="1485235">.</span><span class="ident" id="1485236">Pointer</span>&nbsp;<span class="comment" id="1485244">//&nbsp;array&nbsp;of&nbsp;2^B&nbsp;Buckets.&nbsp;may&nbsp;be&nbsp;nil&nbsp;if&nbsp;count==0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1485294">oldbuckets</span>&nbsp;<span class="ident" id="1485305">unsafe</span><span class="op" id="1485311">.</span><span class="ident" id="1485312">Pointer</span>&nbsp;<span class="comment" id="1485320">//&nbsp;previous&nbsp;bucket&nbsp;array&nbsp;of&nbsp;half&nbsp;the&nbsp;size,&nbsp;non-nil&nbsp;only&nbsp;when&nbsp;growing</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1485390">nevacuate</span>&nbsp;&nbsp;<span class="builtintype" id="1485401">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1485416">//&nbsp;progress&nbsp;counter&nbsp;for&nbsp;evacuation&nbsp;(buckets&nbsp;less&nbsp;than&nbsp;this&nbsp;have&nbsp;been&nbsp;evacuated)</span><br>
<span class="lineno"></span><span class="op" id="1485496">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1485499">//&nbsp;A&nbsp;bucket&nbsp;for&nbsp;a&nbsp;Go&nbsp;map.</span><br>
<span class="lineno"></span><span class="keyword" id="1485525">type</span>&nbsp;<span class="ident" id="1485530">bmap</span>&nbsp;<span class="keyword" id="1485535">struct</span>&nbsp;<span class="op" id="1485542">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1485545">tophash</span>&nbsp;&nbsp;<span class="op" id="1485554">[</span><span class="ident" id="1485555">bucketCnt</span><span class="op" id="1485564">]</span><span class="builtintype" id="1485565">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1485572">overflow</span>&nbsp;<span class="op" id="1485581">*</span><span class="ident" id="1485582">bmap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1485588">//&nbsp;Followed&nbsp;by&nbsp;bucketCnt&nbsp;keys&nbsp;and&nbsp;then&nbsp;bucketCnt&nbsp;values.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1485646">//&nbsp;NOTE:&nbsp;packing&nbsp;all&nbsp;the&nbsp;keys&nbsp;together&nbsp;and&nbsp;then&nbsp;all&nbsp;the&nbsp;values&nbsp;together&nbsp;makes&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1485729">//&nbsp;code&nbsp;a&nbsp;bit&nbsp;more&nbsp;complicated&nbsp;than&nbsp;alternating&nbsp;key/value/key/value/...&nbsp;but&nbsp;it&nbsp;allows</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1485816">//&nbsp;us&nbsp;to&nbsp;eliminate&nbsp;padding&nbsp;which&nbsp;would&nbsp;be&nbsp;needed&nbsp;for,&nbsp;e.g.,&nbsp;map[int64]int8.</span><br>
<span class="lineno"></span><span class="op" id="1485892">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1485895">//&nbsp;A&nbsp;hash&nbsp;iteration&nbsp;structure.</span><br>
<span class="lineno"></span><span class="comment" id="1485926">//&nbsp;If&nbsp;you&nbsp;modify&nbsp;hiter,&nbsp;also&nbsp;change&nbsp;cmd/gc/reflect.c&nbsp;to&nbsp;indicate</span><br>
<span class="lineno">130</span><span class="comment" id="1485991">//&nbsp;the&nbsp;layout&nbsp;of&nbsp;this&nbsp;structure.</span><br>
<span class="lineno"></span><span class="keyword" id="1486024">type</span>&nbsp;<span class="ident" id="1486029">hiter</span>&nbsp;<span class="keyword" id="1486035">struct</span>&nbsp;<span class="op" id="1486042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1486045">key</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1486057">unsafe</span><span class="op" id="1486063">.</span><span class="ident" id="1486064">Pointer</span>&nbsp;<span class="comment" id="1486072">//&nbsp;Must&nbsp;be&nbsp;in&nbsp;first&nbsp;position.&nbsp;&nbsp;Write&nbsp;nil&nbsp;to&nbsp;indicate&nbsp;iteration&nbsp;end&nbsp;(see&nbsp;cmd/gc/range.c).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1486162">value</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1486174">unsafe</span><span class="op" id="1486180">.</span><span class="ident" id="1486181">Pointer</span>&nbsp;<span class="comment" id="1486189">//&nbsp;Must&nbsp;be&nbsp;in&nbsp;second&nbsp;position&nbsp;(see&nbsp;cmd/gc/range.c).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1486242">t</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1486254">*</span><span class="ident" id="1486255">maptype</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1486264">h</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1486276">*</span><span class="ident" id="1486277">hmap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1486283">buckets</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1486295">unsafe</span><span class="op" id="1486301">.</span><span class="ident" id="1486302">Pointer</span>&nbsp;<span class="comment" id="1486310">//&nbsp;bucket&nbsp;ptr&nbsp;at&nbsp;hash_iter&nbsp;initialization&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1486358">bptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1486370">*</span><span class="ident" id="1486371">bmap</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1486385">//&nbsp;current&nbsp;bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1486404">startBucket</span>&nbsp;<span class="builtintype" id="1486416">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1486431">//&nbsp;bucket&nbsp;iteration&nbsp;started&nbsp;at</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1486463">offset</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1486475">uint8</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1486490">//&nbsp;intra-bucket&nbsp;offset&nbsp;to&nbsp;start&nbsp;from&nbsp;during&nbsp;iteration&nbsp;(should&nbsp;be&nbsp;big&nbsp;enough&nbsp;to&nbsp;hold&nbsp;bucketCnt-1)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1486588">wrapped</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1486600">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1486615">//&nbsp;already&nbsp;wrapped&nbsp;around&nbsp;from&nbsp;end&nbsp;of&nbsp;bucket&nbsp;array&nbsp;to&nbsp;beginning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1486680">B</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1486692">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1486699">i</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1486711">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1486718">bucket</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1486730">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1486739">checkBucket</span>&nbsp;<span class="builtintype" id="1486751">uintptr</span><br>
<span class="lineno">145</span><span class="op" id="1486759">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1486762">func</span>&nbsp;<span class="ident" id="1486767">evacuated</span><span class="op" id="1486776">(</span><span class="ident" id="1486777">b</span>&nbsp;<span class="op" id="1486779">*</span><span class="ident" id="1486780">bmap</span><span class="op" id="1486784">)</span>&nbsp;<span class="builtintype" id="1486786">bool</span>&nbsp;<span class="op" id="1486791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1486794">h</span>&nbsp;<span class="op" id="1486796">:=</span>&nbsp;<span class="ident" id="1486799">b</span><span class="op" id="1486800">.</span><span class="ident" id="1486801">tophash</span><span class="op" id="1486808">[</span><span class="num" id="1486809">0</span><span class="op" id="1486810">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1486813">return</span>&nbsp;<span class="ident" id="1486820">h</span>&nbsp;<span class="op" id="1486822">&gt;</span>&nbsp;<span class="ident" id="1486824">empty</span>&nbsp;<span class="op" id="1486830">&amp;&amp;</span>&nbsp;<span class="ident" id="1486833">h</span>&nbsp;<span class="op" id="1486835">&lt;</span>&nbsp;<span class="ident" id="1486837">minTopHash</span><br>
<span class="lineno">150</span><span class="op" id="1486848">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1486851">func</span>&nbsp;<span class="ident" id="1486856">makemap</span><span class="op" id="1486863">(</span><span class="ident" id="1486864">t</span>&nbsp;<span class="op" id="1486866">*</span><span class="ident" id="1486867">maptype</span><span class="op" id="1486874">,</span>&nbsp;<span class="ident" id="1486876">hint</span>&nbsp;<span class="ident" id="1486881">int64</span><span class="op" id="1486886">)</span>&nbsp;<span class="op" id="1486888">*</span><span class="ident" id="1486889">hmap</span>&nbsp;<span class="op" id="1486894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1486897">if</span>&nbsp;<span class="ident" id="1486900">sz</span>&nbsp;<span class="op" id="1486903">:=</span>&nbsp;<span class="ident" id="1486906">unsafe</span><span class="op" id="1486912">.</span><span class="ident" id="1486913">Sizeof</span><span class="op" id="1486919">(</span><span class="ident" id="1486920">hmap</span><span class="op" id="1486924">{</span><span class="op" id="1486925">}</span><span class="op" id="1486926">)</span><span class="op" id="1486927">;</span>&nbsp;<span class="ident" id="1486929">sz</span>&nbsp;<span class="op" id="1486932">&gt;</span>&nbsp;<span class="num" id="1486934">48</span>&nbsp;<span class="op" id="1486937">||</span>&nbsp;<span class="ident" id="1486940">sz</span>&nbsp;<span class="op" id="1486943">!=</span>&nbsp;<span class="builtintype" id="1486946">uintptr</span><span class="op" id="1486953">(</span><span class="ident" id="1486954">t</span><span class="op" id="1486955">.</span><span class="ident" id="1486956">hmap</span><span class="op" id="1486960">.</span><span class="ident" id="1486961">size</span><span class="op" id="1486965">)</span>&nbsp;<span class="op" id="1486967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1486971">gothrow</span><span class="op" id="1486978">(</span><span class="string" id="1486979">&#34;bad&nbsp;hmap&nbsp;size&#34;</span><span class="op" id="1486994">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1486997">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1487001">if</span>&nbsp;<span class="ident" id="1487004">hint</span>&nbsp;<span class="op" id="1487009">&lt;</span>&nbsp;<span class="num" id="1487011">0</span>&nbsp;<span class="op" id="1487013">||</span>&nbsp;<span class="ident" id="1487016">int64</span><span class="op" id="1487021">(</span><span class="builtintype" id="1487022">int32</span><span class="op" id="1487027">(</span><span class="ident" id="1487028">hint</span><span class="op" id="1487032">)</span><span class="op" id="1487033">)</span>&nbsp;<span class="op" id="1487035">!=</span>&nbsp;<span class="ident" id="1487038">hint</span>&nbsp;<span class="op" id="1487043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1487047">panic</span><span class="op" id="1487052">(</span><span class="string" id="1487053">&#34;makemap:&nbsp;size&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1487081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1487085">//&nbsp;TODO:&nbsp;make&nbsp;hint&nbsp;an&nbsp;int,&nbsp;then&nbsp;none&nbsp;of&nbsp;this&nbsp;nonsense</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1487140">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1487144">if</span>&nbsp;<span class="op" id="1487147">!</span><span class="ident" id="1487148">ismapkey</span><span class="op" id="1487156">(</span><span class="ident" id="1487157">t</span><span class="op" id="1487158">.</span><span class="ident" id="1487159">key</span><span class="op" id="1487162">)</span>&nbsp;<span class="op" id="1487164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1487168">gothrow</span><span class="op" id="1487175">(</span><span class="string" id="1487176">&#34;runtime.makemap:&nbsp;unsupported&nbsp;map&nbsp;key&nbsp;type&#34;</span><span class="op" id="1487219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1487222">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1487226">//&nbsp;check&nbsp;compiler&#39;s&nbsp;and&nbsp;reflect&#39;s&nbsp;math</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1487266">if</span>&nbsp;<span class="ident" id="1487269">t</span><span class="op" id="1487270">.</span><span class="ident" id="1487271">key</span><span class="op" id="1487274">.</span><span class="ident" id="1487275">size</span>&nbsp;<span class="op" id="1487280">&gt;</span>&nbsp;<span class="ident" id="1487282">maxKeySize</span>&nbsp;<span class="op" id="1487293">&amp;&amp;</span>&nbsp;<span class="op" id="1487296">(</span><span class="op" id="1487297">!</span><span class="ident" id="1487298">t</span><span class="op" id="1487299">.</span><span class="ident" id="1487300">indirectkey</span>&nbsp;<span class="op" id="1487312">||</span>&nbsp;<span class="ident" id="1487315">t</span><span class="op" id="1487316">.</span><span class="ident" id="1487317">keysize</span>&nbsp;<span class="op" id="1487325">!=</span>&nbsp;<span class="builtintype" id="1487328">uint8</span><span class="op" id="1487333">(</span><span class="ident" id="1487334">ptrSize</span><span class="op" id="1487341">)</span><span class="op" id="1487342">)</span>&nbsp;<span class="op" id="1487344">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1487349">t</span><span class="op" id="1487350">.</span><span class="ident" id="1487351">key</span><span class="op" id="1487354">.</span><span class="ident" id="1487355">size</span>&nbsp;<span class="op" id="1487360">&lt;=</span>&nbsp;<span class="ident" id="1487363">maxKeySize</span>&nbsp;<span class="op" id="1487374">&amp;&amp;</span>&nbsp;<span class="op" id="1487377">(</span><span class="ident" id="1487378">t</span><span class="op" id="1487379">.</span><span class="ident" id="1487380">indirectkey</span>&nbsp;<span class="op" id="1487392">||</span>&nbsp;<span class="ident" id="1487395">t</span><span class="op" id="1487396">.</span><span class="ident" id="1487397">keysize</span>&nbsp;<span class="op" id="1487405">!=</span>&nbsp;<span class="builtintype" id="1487408">uint8</span><span class="op" id="1487413">(</span><span class="ident" id="1487414">t</span><span class="op" id="1487415">.</span><span class="ident" id="1487416">key</span><span class="op" id="1487419">.</span><span class="ident" id="1487420">size</span><span class="op" id="1487424">)</span><span class="op" id="1487425">)</span>&nbsp;<span class="op" id="1487427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1487431">gothrow</span><span class="op" id="1487438">(</span><span class="string" id="1487439">&#34;key&nbsp;size&nbsp;wrong&#34;</span><span class="op" id="1487455">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1487458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1487461">if</span>&nbsp;<span class="ident" id="1487464">t</span><span class="op" id="1487465">.</span><span class="ident" id="1487466">elem</span><span class="op" id="1487470">.</span><span class="ident" id="1487471">size</span>&nbsp;<span class="op" id="1487476">&gt;</span>&nbsp;<span class="ident" id="1487478">maxValueSize</span>&nbsp;<span class="op" id="1487491">&amp;&amp;</span>&nbsp;<span class="op" id="1487494">(</span><span class="op" id="1487495">!</span><span class="ident" id="1487496">t</span><span class="op" id="1487497">.</span><span class="ident" id="1487498">indirectvalue</span>&nbsp;<span class="op" id="1487512">||</span>&nbsp;<span class="ident" id="1487515">t</span><span class="op" id="1487516">.</span><span class="ident" id="1487517">valuesize</span>&nbsp;<span class="op" id="1487527">!=</span>&nbsp;<span class="builtintype" id="1487530">uint8</span><span class="op" id="1487535">(</span><span class="ident" id="1487536">ptrSize</span><span class="op" id="1487543">)</span><span class="op" id="1487544">)</span>&nbsp;<span class="op" id="1487546">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1487551">t</span><span class="op" id="1487552">.</span><span class="ident" id="1487553">elem</span><span class="op" id="1487557">.</span><span class="ident" id="1487558">size</span>&nbsp;<span class="op" id="1487563">&lt;=</span>&nbsp;<span class="ident" id="1487566">maxValueSize</span>&nbsp;<span class="op" id="1487579">&amp;&amp;</span>&nbsp;<span class="op" id="1487582">(</span><span class="ident" id="1487583">t</span><span class="op" id="1487584">.</span><span class="ident" id="1487585">indirectvalue</span>&nbsp;<span class="op" id="1487599">||</span>&nbsp;<span class="ident" id="1487602">t</span><span class="op" id="1487603">.</span><span class="ident" id="1487604">valuesize</span>&nbsp;<span class="op" id="1487614">!=</span>&nbsp;<span class="builtintype" id="1487617">uint8</span><span class="op" id="1487622">(</span><span class="ident" id="1487623">t</span><span class="op" id="1487624">.</span><span class="ident" id="1487625">elem</span><span class="op" id="1487629">.</span><span class="ident" id="1487630">size</span><span class="op" id="1487634">)</span><span class="op" id="1487635">)</span>&nbsp;<span class="op" id="1487637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1487641">gothrow</span><span class="op" id="1487648">(</span><span class="string" id="1487649">&#34;value&nbsp;size&nbsp;wrong&#34;</span><span class="op" id="1487667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1487670">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1487674">//&nbsp;invariants&nbsp;we&nbsp;depend&nbsp;on.&nbsp;&nbsp;We&nbsp;should&nbsp;probably&nbsp;check&nbsp;these&nbsp;at&nbsp;compile&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1487751">//&nbsp;somewhere,&nbsp;but&nbsp;for&nbsp;now&nbsp;we&#39;ll&nbsp;do&nbsp;it&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1487796">if</span>&nbsp;<span class="ident" id="1487799">t</span><span class="op" id="1487800">.</span><span class="ident" id="1487801">key</span><span class="op" id="1487804">.</span><span class="ident" id="1487805">align</span>&nbsp;<span class="op" id="1487811">&gt;</span>&nbsp;<span class="ident" id="1487813">bucketCnt</span>&nbsp;<span class="op" id="1487823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1487827">gothrow</span><span class="op" id="1487834">(</span><span class="string" id="1487835">&#34;key&nbsp;align&nbsp;too&nbsp;big&#34;</span><span class="op" id="1487854">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1487857">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1487860">if</span>&nbsp;<span class="ident" id="1487863">t</span><span class="op" id="1487864">.</span><span class="ident" id="1487865">elem</span><span class="op" id="1487869">.</span><span class="ident" id="1487870">align</span>&nbsp;<span class="op" id="1487876">&gt;</span>&nbsp;<span class="ident" id="1487878">bucketCnt</span>&nbsp;<span class="op" id="1487888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1487892">gothrow</span><span class="op" id="1487899">(</span><span class="string" id="1487900">&#34;value&nbsp;align&nbsp;too&nbsp;big&#34;</span><span class="op" id="1487921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1487924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1487927">if</span>&nbsp;<span class="builtintype" id="1487930">uintptr</span><span class="op" id="1487937">(</span><span class="ident" id="1487938">t</span><span class="op" id="1487939">.</span><span class="ident" id="1487940">key</span><span class="op" id="1487943">.</span><span class="ident" id="1487944">size</span><span class="op" id="1487948">)</span><span class="op" id="1487949">%</span><span class="builtintype" id="1487950">uintptr</span><span class="op" id="1487957">(</span><span class="ident" id="1487958">t</span><span class="op" id="1487959">.</span><span class="ident" id="1487960">key</span><span class="op" id="1487963">.</span><span class="ident" id="1487964">align</span><span class="op" id="1487969">)</span>&nbsp;<span class="op" id="1487971">!=</span>&nbsp;<span class="num" id="1487974">0</span>&nbsp;<span class="op" id="1487976">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1487980">gothrow</span><span class="op" id="1487987">(</span><span class="string" id="1487988">&#34;key&nbsp;size&nbsp;not&nbsp;a&nbsp;multiple&nbsp;of&nbsp;key&nbsp;align&#34;</span><span class="op" id="1488026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1488029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1488032">if</span>&nbsp;<span class="builtintype" id="1488035">uintptr</span><span class="op" id="1488042">(</span><span class="ident" id="1488043">t</span><span class="op" id="1488044">.</span><span class="ident" id="1488045">elem</span><span class="op" id="1488049">.</span><span class="ident" id="1488050">size</span><span class="op" id="1488054">)</span><span class="op" id="1488055">%</span><span class="builtintype" id="1488056">uintptr</span><span class="op" id="1488063">(</span><span class="ident" id="1488064">t</span><span class="op" id="1488065">.</span><span class="ident" id="1488066">elem</span><span class="op" id="1488070">.</span><span class="ident" id="1488071">align</span><span class="op" id="1488076">)</span>&nbsp;<span class="op" id="1488078">!=</span>&nbsp;<span class="num" id="1488081">0</span>&nbsp;<span class="op" id="1488083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1488087">gothrow</span><span class="op" id="1488094">(</span><span class="string" id="1488095">&#34;value&nbsp;size&nbsp;not&nbsp;a&nbsp;multiple&nbsp;of&nbsp;value&nbsp;align&#34;</span><span class="op" id="1488137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1488140">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1488143">if</span>&nbsp;<span class="ident" id="1488146">bucketCnt</span>&nbsp;<span class="op" id="1488156">&lt;</span>&nbsp;<span class="num" id="1488158">8</span>&nbsp;<span class="op" id="1488160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1488164">gothrow</span><span class="op" id="1488171">(</span><span class="string" id="1488172">&#34;bucketsize&nbsp;too&nbsp;small&nbsp;for&nbsp;proper&nbsp;alignment&#34;</span><span class="op" id="1488215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1488218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1488221">if</span>&nbsp;<span class="ident" id="1488224">dataOffset</span><span class="op" id="1488234">%</span><span class="builtintype" id="1488235">uintptr</span><span class="op" id="1488242">(</span><span class="ident" id="1488243">t</span><span class="op" id="1488244">.</span><span class="ident" id="1488245">key</span><span class="op" id="1488248">.</span><span class="ident" id="1488249">align</span><span class="op" id="1488254">)</span>&nbsp;<span class="op" id="1488256">!=</span>&nbsp;<span class="num" id="1488259">0</span>&nbsp;<span class="op" id="1488261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1488265">gothrow</span><span class="op" id="1488272">(</span><span class="string" id="1488273">&#34;need&nbsp;padding&nbsp;in&nbsp;bucket&nbsp;(key)&#34;</span><span class="op" id="1488303">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1488306">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1488309">if</span>&nbsp;<span class="ident" id="1488312">dataOffset</span><span class="op" id="1488322">%</span><span class="builtintype" id="1488323">uintptr</span><span class="op" id="1488330">(</span><span class="ident" id="1488331">t</span><span class="op" id="1488332">.</span><span class="ident" id="1488333">elem</span><span class="op" id="1488337">.</span><span class="ident" id="1488338">align</span><span class="op" id="1488343">)</span>&nbsp;<span class="op" id="1488345">!=</span>&nbsp;<span class="num" id="1488348">0</span>&nbsp;<span class="op" id="1488350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1488354">gothrow</span><span class="op" id="1488361">(</span><span class="string" id="1488362">&#34;need&nbsp;padding&nbsp;in&nbsp;bucket&nbsp;(value)&#34;</span><span class="op" id="1488394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1488397">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1488401">//&nbsp;find&nbsp;size&nbsp;parameter&nbsp;which&nbsp;will&nbsp;hold&nbsp;the&nbsp;requested&nbsp;#&nbsp;of&nbsp;elements</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1488469">B</span>&nbsp;<span class="op" id="1488471">:=</span>&nbsp;<span class="builtintype" id="1488474">uint8</span><span class="op" id="1488479">(</span><span class="num" id="1488480">0</span><span class="op" id="1488481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1488484">for</span>&nbsp;<span class="op" id="1488488">;</span>&nbsp;<span class="ident" id="1488490">hint</span>&nbsp;<span class="op" id="1488495">&gt;</span>&nbsp;<span class="ident" id="1488497">bucketCnt</span>&nbsp;<span class="op" id="1488507">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1488510">float32</span><span class="op" id="1488517">(</span><span class="ident" id="1488518">hint</span><span class="op" id="1488522">)</span>&nbsp;<span class="op" id="1488524">&gt;</span>&nbsp;<span class="ident" id="1488526">loadFactor</span><span class="op" id="1488536">*</span><span class="builtintype" id="1488537">float32</span><span class="op" id="1488544">(</span><span class="builtintype" id="1488545">uintptr</span><span class="op" id="1488552">(</span><span class="num" id="1488553">1</span><span class="op" id="1488554">)</span><span class="op" id="1488555">&lt;&lt;</span><span class="ident" id="1488557">B</span><span class="op" id="1488558">)</span><span class="op" id="1488559">;</span>&nbsp;<span class="ident" id="1488561">B</span><span class="op" id="1488562">++</span>&nbsp;<span class="op" id="1488565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1488568">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1488572">//&nbsp;allocate&nbsp;initial&nbsp;hash&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1488604">//&nbsp;if&nbsp;B&nbsp;==&nbsp;0,&nbsp;the&nbsp;buckets&nbsp;field&nbsp;is&nbsp;allocated&nbsp;lazily&nbsp;later&nbsp;(in&nbsp;mapassign)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1488678">//&nbsp;If&nbsp;hint&nbsp;is&nbsp;large&nbsp;zeroing&nbsp;this&nbsp;memory&nbsp;could&nbsp;take&nbsp;a&nbsp;while.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1488739">var</span>&nbsp;<span class="ident" id="1488743">buckets</span>&nbsp;<span class="ident" id="1488751">unsafe</span><span class="op" id="1488757">.</span><span class="ident" id="1488758">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1488767">if</span>&nbsp;<span class="ident" id="1488770">B</span>&nbsp;<span class="op" id="1488772">!=</span>&nbsp;<span class="num" id="1488775">0</span>&nbsp;<span class="op" id="1488777">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1488781">if</span>&nbsp;<span class="ident" id="1488784">checkgc</span>&nbsp;<span class="op" id="1488792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1488797">memstats</span><span class="op" id="1488805">.</span><span class="ident" id="1488806">next_gc</span>&nbsp;<span class="op" id="1488814">=</span>&nbsp;<span class="ident" id="1488816">memstats</span><span class="op" id="1488824">.</span><span class="ident" id="1488825">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1488838">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1488842">buckets</span>&nbsp;<span class="op" id="1488850">=</span>&nbsp;<span class="ident" id="1488852">newarray</span><span class="op" id="1488860">(</span><span class="ident" id="1488861">t</span><span class="op" id="1488862">.</span><span class="ident" id="1488863">bucket</span><span class="op" id="1488869">,</span>&nbsp;<span class="builtintype" id="1488871">uintptr</span><span class="op" id="1488878">(</span><span class="num" id="1488879">1</span><span class="op" id="1488880">)</span><span class="op" id="1488881">&lt;&lt;</span><span class="ident" id="1488883">B</span><span class="op" id="1488884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1488887">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1488891">//&nbsp;initialize&nbsp;Hmap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1488911">if</span>&nbsp;<span class="ident" id="1488914">checkgc</span>&nbsp;<span class="op" id="1488922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1488926">memstats</span><span class="op" id="1488934">.</span><span class="ident" id="1488935">next_gc</span>&nbsp;<span class="op" id="1488943">=</span>&nbsp;<span class="ident" id="1488945">memstats</span><span class="op" id="1488953">.</span><span class="ident" id="1488954">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1488966">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1488969">h</span>&nbsp;<span class="op" id="1488971">:=</span>&nbsp;<span class="op" id="1488974">(</span><span class="op" id="1488975">*</span><span class="ident" id="1488976">hmap</span><span class="op" id="1488980">)</span><span class="op" id="1488981">(</span><span class="ident" id="1488982">newobject</span><span class="op" id="1488991">(</span><span class="ident" id="1488992">t</span><span class="op" id="1488993">.</span><span class="ident" id="1488994">hmap</span><span class="op" id="1488998">)</span><span class="op" id="1488999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1489002">h</span><span class="op" id="1489003">.</span><span class="ident" id="1489004">count</span>&nbsp;<span class="op" id="1489010">=</span>&nbsp;<span class="num" id="1489012">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1489015">h</span><span class="op" id="1489016">.</span><span class="ident" id="1489017">B</span>&nbsp;<span class="op" id="1489019">=</span>&nbsp;<span class="ident" id="1489021">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1489024">h</span><span class="op" id="1489025">.</span><span class="ident" id="1489026">flags</span>&nbsp;<span class="op" id="1489032">=</span>&nbsp;<span class="num" id="1489034">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1489037">h</span><span class="op" id="1489038">.</span><span class="ident" id="1489039">hash0</span>&nbsp;<span class="op" id="1489045">=</span>&nbsp;<span class="ident" id="1489047">fastrand1</span><span class="op" id="1489056">(</span><span class="op" id="1489057">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1489060">h</span><span class="op" id="1489061">.</span><span class="ident" id="1489062">buckets</span>&nbsp;<span class="op" id="1489070">=</span>&nbsp;<span class="ident" id="1489072">buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1489081">h</span><span class="op" id="1489082">.</span><span class="ident" id="1489083">oldbuckets</span>&nbsp;<span class="op" id="1489094">=</span>&nbsp;<span class="ident" id="1489096">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1489101">h</span><span class="op" id="1489102">.</span><span class="ident" id="1489103">nevacuate</span>&nbsp;<span class="op" id="1489113">=</span>&nbsp;<span class="num" id="1489115">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1489119">return</span>&nbsp;<span class="ident" id="1489126">h</span><br>
<span class="lineno">230</span><span class="op" id="1489128">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1489131">//&nbsp;mapaccess1&nbsp;returns&nbsp;a&nbsp;pointer&nbsp;to&nbsp;h[key].&nbsp;&nbsp;Never&nbsp;returns&nbsp;nil,&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1489202">//&nbsp;it&nbsp;will&nbsp;return&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;zero&nbsp;object&nbsp;for&nbsp;the&nbsp;value&nbsp;type&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="1489273">//&nbsp;the&nbsp;key&nbsp;is&nbsp;not&nbsp;in&nbsp;the&nbsp;map.</span><br>
<span class="lineno">235</span><span class="comment" id="1489303">//&nbsp;NOTE:&nbsp;The&nbsp;returned&nbsp;pointer&nbsp;may&nbsp;keep&nbsp;the&nbsp;whole&nbsp;map&nbsp;live,&nbsp;so&nbsp;don&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="1489371">//&nbsp;hold&nbsp;onto&nbsp;it&nbsp;for&nbsp;very&nbsp;long.</span><br>
<span class="lineno"></span><span class="keyword" id="1489402">func</span>&nbsp;<span class="ident" id="1489407">mapaccess1</span><span class="op" id="1489417">(</span><span class="ident" id="1489418">t</span>&nbsp;<span class="op" id="1489420">*</span><span class="ident" id="1489421">maptype</span><span class="op" id="1489428">,</span>&nbsp;<span class="ident" id="1489430">h</span>&nbsp;<span class="op" id="1489432">*</span><span class="ident" id="1489433">hmap</span><span class="op" id="1489437">,</span>&nbsp;<span class="ident" id="1489439">key</span>&nbsp;<span class="ident" id="1489443">unsafe</span><span class="op" id="1489449">.</span><span class="ident" id="1489450">Pointer</span><span class="op" id="1489457">)</span>&nbsp;<span class="ident" id="1489459">unsafe</span><span class="op" id="1489465">.</span><span class="ident" id="1489466">Pointer</span>&nbsp;<span class="op" id="1489474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1489477">if</span>&nbsp;<span class="ident" id="1489480">raceenabled</span>&nbsp;<span class="op" id="1489492">&amp;&amp;</span>&nbsp;<span class="ident" id="1489495">h</span>&nbsp;<span class="op" id="1489497">!=</span>&nbsp;<span class="ident" id="1489500">nil</span>&nbsp;<span class="op" id="1489504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1489508">callerpc</span>&nbsp;<span class="op" id="1489517">:=</span>&nbsp;<span class="ident" id="1489520">getcallerpc</span><span class="op" id="1489531">(</span><span class="ident" id="1489532">unsafe</span><span class="op" id="1489538">.</span><span class="ident" id="1489539">Pointer</span><span class="op" id="1489546">(</span><span class="op" id="1489547">&amp;</span><span class="ident" id="1489548">t</span><span class="op" id="1489549">)</span><span class="op" id="1489550">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1489554">pc</span>&nbsp;<span class="op" id="1489557">:=</span>&nbsp;<span class="ident" id="1489560">funcPC</span><span class="op" id="1489566">(</span><span class="ident" id="1489567">mapaccess1</span><span class="op" id="1489577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1489581">racereadpc</span><span class="op" id="1489591">(</span><span class="ident" id="1489592">unsafe</span><span class="op" id="1489598">.</span><span class="ident" id="1489599">Pointer</span><span class="op" id="1489606">(</span><span class="ident" id="1489607">h</span><span class="op" id="1489608">)</span><span class="op" id="1489609">,</span>&nbsp;<span class="ident" id="1489611">callerpc</span><span class="op" id="1489619">,</span>&nbsp;<span class="ident" id="1489621">pc</span><span class="op" id="1489623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1489627">raceReadObjectPC</span><span class="op" id="1489643">(</span><span class="ident" id="1489644">t</span><span class="op" id="1489645">.</span><span class="ident" id="1489646">key</span><span class="op" id="1489649">,</span>&nbsp;<span class="ident" id="1489651">key</span><span class="op" id="1489654">,</span>&nbsp;<span class="ident" id="1489656">callerpc</span><span class="op" id="1489664">,</span>&nbsp;<span class="ident" id="1489666">pc</span><span class="op" id="1489668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1489671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1489674">if</span>&nbsp;<span class="ident" id="1489677">h</span>&nbsp;<span class="op" id="1489679">==</span>&nbsp;<span class="ident" id="1489682">nil</span>&nbsp;<span class="op" id="1489686">||</span>&nbsp;<span class="ident" id="1489689">h</span><span class="op" id="1489690">.</span><span class="ident" id="1489691">count</span>&nbsp;<span class="op" id="1489697">==</span>&nbsp;<span class="num" id="1489700">0</span>&nbsp;<span class="op" id="1489702">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1489706">return</span>&nbsp;<span class="ident" id="1489713">unsafe</span><span class="op" id="1489719">.</span><span class="ident" id="1489720">Pointer</span><span class="op" id="1489727">(</span><span class="ident" id="1489728">t</span><span class="op" id="1489729">.</span><span class="ident" id="1489730">elem</span><span class="op" id="1489734">.</span><span class="ident" id="1489735">zero</span><span class="op" id="1489739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1489742">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1489745">alg</span>&nbsp;<span class="op" id="1489749">:=</span>&nbsp;<span class="ident" id="1489752">goalg</span><span class="op" id="1489757">(</span><span class="ident" id="1489758">t</span><span class="op" id="1489759">.</span><span class="ident" id="1489760">key</span><span class="op" id="1489763">.</span><span class="ident" id="1489764">alg</span><span class="op" id="1489767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1489770">hash</span>&nbsp;<span class="op" id="1489775">:=</span>&nbsp;<span class="ident" id="1489778">alg</span><span class="op" id="1489781">.</span><span class="ident" id="1489782">hash</span><span class="op" id="1489786">(</span><span class="ident" id="1489787">key</span><span class="op" id="1489790">,</span>&nbsp;<span class="builtintype" id="1489792">uintptr</span><span class="op" id="1489799">(</span><span class="ident" id="1489800">t</span><span class="op" id="1489801">.</span><span class="ident" id="1489802">key</span><span class="op" id="1489805">.</span><span class="ident" id="1489806">size</span><span class="op" id="1489810">)</span><span class="op" id="1489811">,</span>&nbsp;<span class="builtintype" id="1489813">uintptr</span><span class="op" id="1489820">(</span><span class="ident" id="1489821">h</span><span class="op" id="1489822">.</span><span class="ident" id="1489823">hash0</span><span class="op" id="1489828">)</span><span class="op" id="1489829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1489832">m</span>&nbsp;<span class="op" id="1489834">:=</span>&nbsp;<span class="builtintype" id="1489837">uintptr</span><span class="op" id="1489844">(</span><span class="num" id="1489845">1</span><span class="op" id="1489846">)</span><span class="op" id="1489847">&lt;&lt;</span><span class="ident" id="1489849">h</span><span class="op" id="1489850">.</span><span class="ident" id="1489851">B</span>&nbsp;<span class="op" id="1489853">-</span>&nbsp;<span class="num" id="1489855">1</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1489858">b</span>&nbsp;<span class="op" id="1489860">:=</span>&nbsp;<span class="op" id="1489863">(</span><span class="op" id="1489864">*</span><span class="ident" id="1489865">bmap</span><span class="op" id="1489869">)</span><span class="op" id="1489870">(</span><span class="ident" id="1489871">add</span><span class="op" id="1489874">(</span><span class="ident" id="1489875">h</span><span class="op" id="1489876">.</span><span class="ident" id="1489877">buckets</span><span class="op" id="1489884">,</span>&nbsp;<span class="op" id="1489886">(</span><span class="ident" id="1489887">hash</span><span class="op" id="1489891">&amp;</span><span class="ident" id="1489892">m</span><span class="op" id="1489893">)</span><span class="op" id="1489894">*</span><span class="builtintype" id="1489895">uintptr</span><span class="op" id="1489902">(</span><span class="ident" id="1489903">t</span><span class="op" id="1489904">.</span><span class="ident" id="1489905">bucketsize</span><span class="op" id="1489915">)</span><span class="op" id="1489916">)</span><span class="op" id="1489917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1489920">if</span>&nbsp;<span class="ident" id="1489923">c</span>&nbsp;<span class="op" id="1489925">:=</span>&nbsp;<span class="ident" id="1489928">h</span><span class="op" id="1489929">.</span><span class="ident" id="1489930">oldbuckets</span><span class="op" id="1489940">;</span>&nbsp;<span class="ident" id="1489942">c</span>&nbsp;<span class="op" id="1489944">!=</span>&nbsp;<span class="ident" id="1489947">nil</span>&nbsp;<span class="op" id="1489951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1489955">oldb</span>&nbsp;<span class="op" id="1489960">:=</span>&nbsp;<span class="op" id="1489963">(</span><span class="op" id="1489964">*</span><span class="ident" id="1489965">bmap</span><span class="op" id="1489969">)</span><span class="op" id="1489970">(</span><span class="ident" id="1489971">add</span><span class="op" id="1489974">(</span><span class="ident" id="1489975">c</span><span class="op" id="1489976">,</span>&nbsp;<span class="op" id="1489978">(</span><span class="ident" id="1489979">hash</span><span class="op" id="1489983">&amp;</span><span class="op" id="1489984">(</span><span class="ident" id="1489985">m</span><span class="op" id="1489986">&gt;&gt;</span><span class="num" id="1489988">1</span><span class="op" id="1489989">)</span><span class="op" id="1489990">)</span><span class="op" id="1489991">*</span><span class="builtintype" id="1489992">uintptr</span><span class="op" id="1489999">(</span><span class="ident" id="1490000">t</span><span class="op" id="1490001">.</span><span class="ident" id="1490002">bucketsize</span><span class="op" id="1490012">)</span><span class="op" id="1490013">)</span><span class="op" id="1490014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1490018">if</span>&nbsp;<span class="op" id="1490021">!</span><span class="ident" id="1490022">evacuated</span><span class="op" id="1490031">(</span><span class="ident" id="1490032">oldb</span><span class="op" id="1490036">)</span>&nbsp;<span class="op" id="1490038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1490043">b</span>&nbsp;<span class="op" id="1490045">=</span>&nbsp;<span class="ident" id="1490047">oldb</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1490054">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1490057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1490060">top</span>&nbsp;<span class="op" id="1490064">:=</span>&nbsp;<span class="builtintype" id="1490067">uint8</span><span class="op" id="1490072">(</span><span class="ident" id="1490073">hash</span>&nbsp;<span class="op" id="1490078">&gt;&gt;</span>&nbsp;<span class="op" id="1490081">(</span><span class="ident" id="1490082">ptrSize</span><span class="op" id="1490089">*</span><span class="num" id="1490090">8</span>&nbsp;<span class="op" id="1490092">-</span>&nbsp;<span class="num" id="1490094">8</span><span class="op" id="1490095">)</span><span class="op" id="1490096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1490099">if</span>&nbsp;<span class="ident" id="1490102">top</span>&nbsp;<span class="op" id="1490106">&lt;</span>&nbsp;<span class="ident" id="1490108">minTopHash</span>&nbsp;<span class="op" id="1490119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1490123">top</span>&nbsp;<span class="op" id="1490127">+=</span>&nbsp;<span class="ident" id="1490130">minTopHash</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1490142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1490145">for</span>&nbsp;<span class="op" id="1490149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1490153">for</span>&nbsp;<span class="ident" id="1490157">i</span>&nbsp;<span class="op" id="1490159">:=</span>&nbsp;<span class="builtintype" id="1490162">uintptr</span><span class="op" id="1490169">(</span><span class="num" id="1490170">0</span><span class="op" id="1490171">)</span><span class="op" id="1490172">;</span>&nbsp;<span class="ident" id="1490174">i</span>&nbsp;<span class="op" id="1490176">&lt;</span>&nbsp;<span class="ident" id="1490178">bucketCnt</span><span class="op" id="1490187">;</span>&nbsp;<span class="ident" id="1490189">i</span><span class="op" id="1490190">++</span>&nbsp;<span class="op" id="1490193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1490198">if</span>&nbsp;<span class="ident" id="1490201">b</span><span class="op" id="1490202">.</span><span class="ident" id="1490203">tophash</span><span class="op" id="1490210">[</span><span class="ident" id="1490211">i</span><span class="op" id="1490212">]</span>&nbsp;<span class="op" id="1490214">!=</span>&nbsp;<span class="ident" id="1490217">top</span>&nbsp;<span class="op" id="1490221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1490227">continue</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1490239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1490244">k</span>&nbsp;<span class="op" id="1490246">:=</span>&nbsp;<span class="ident" id="1490249">add</span><span class="op" id="1490252">(</span><span class="ident" id="1490253">unsafe</span><span class="op" id="1490259">.</span><span class="ident" id="1490260">Pointer</span><span class="op" id="1490267">(</span><span class="ident" id="1490268">b</span><span class="op" id="1490269">)</span><span class="op" id="1490270">,</span>&nbsp;<span class="ident" id="1490272">dataOffset</span><span class="op" id="1490282">+</span><span class="ident" id="1490283">i</span><span class="op" id="1490284">*</span><span class="builtintype" id="1490285">uintptr</span><span class="op" id="1490292">(</span><span class="ident" id="1490293">t</span><span class="op" id="1490294">.</span><span class="ident" id="1490295">keysize</span><span class="op" id="1490302">)</span><span class="op" id="1490303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1490308">if</span>&nbsp;<span class="ident" id="1490311">t</span><span class="op" id="1490312">.</span><span class="ident" id="1490313">indirectkey</span>&nbsp;<span class="op" id="1490325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1490331">k</span>&nbsp;<span class="op" id="1490333">=</span>&nbsp;<span class="op" id="1490335">*</span><span class="op" id="1490336">(</span><span class="op" id="1490337">(</span><span class="op" id="1490338">*</span><span class="ident" id="1490339">unsafe</span><span class="op" id="1490345">.</span><span class="ident" id="1490346">Pointer</span><span class="op" id="1490353">)</span><span class="op" id="1490354">(</span><span class="ident" id="1490355">k</span><span class="op" id="1490356">)</span><span class="op" id="1490357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1490362">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1490367">if</span>&nbsp;<span class="ident" id="1490370">alg</span><span class="op" id="1490373">.</span><span class="ident" id="1490374">equal</span><span class="op" id="1490379">(</span><span class="ident" id="1490380">key</span><span class="op" id="1490383">,</span>&nbsp;<span class="ident" id="1490385">k</span><span class="op" id="1490386">,</span>&nbsp;<span class="builtintype" id="1490388">uintptr</span><span class="op" id="1490395">(</span><span class="ident" id="1490396">t</span><span class="op" id="1490397">.</span><span class="ident" id="1490398">key</span><span class="op" id="1490401">.</span><span class="ident" id="1490402">size</span><span class="op" id="1490406">)</span><span class="op" id="1490407">)</span>&nbsp;<span class="op" id="1490409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1490415">v</span>&nbsp;<span class="op" id="1490417">:=</span>&nbsp;<span class="ident" id="1490420">add</span><span class="op" id="1490423">(</span><span class="ident" id="1490424">unsafe</span><span class="op" id="1490430">.</span><span class="ident" id="1490431">Pointer</span><span class="op" id="1490438">(</span><span class="ident" id="1490439">b</span><span class="op" id="1490440">)</span><span class="op" id="1490441">,</span>&nbsp;<span class="ident" id="1490443">dataOffset</span><span class="op" id="1490453">+</span><span class="ident" id="1490454">bucketCnt</span><span class="op" id="1490463">*</span><span class="builtintype" id="1490464">uintptr</span><span class="op" id="1490471">(</span><span class="ident" id="1490472">t</span><span class="op" id="1490473">.</span><span class="ident" id="1490474">keysize</span><span class="op" id="1490481">)</span><span class="op" id="1490482">+</span><span class="ident" id="1490483">i</span><span class="op" id="1490484">*</span><span class="builtintype" id="1490485">uintptr</span><span class="op" id="1490492">(</span><span class="ident" id="1490493">t</span><span class="op" id="1490494">.</span><span class="ident" id="1490495">valuesize</span><span class="op" id="1490504">)</span><span class="op" id="1490505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1490511">if</span>&nbsp;<span class="ident" id="1490514">t</span><span class="op" id="1490515">.</span><span class="ident" id="1490516">indirectvalue</span>&nbsp;<span class="op" id="1490530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1490537">v</span>&nbsp;<span class="op" id="1490539">=</span>&nbsp;<span class="op" id="1490541">*</span><span class="op" id="1490542">(</span><span class="op" id="1490543">(</span><span class="op" id="1490544">*</span><span class="ident" id="1490545">unsafe</span><span class="op" id="1490551">.</span><span class="ident" id="1490552">Pointer</span><span class="op" id="1490559">)</span><span class="op" id="1490560">(</span><span class="ident" id="1490561">v</span><span class="op" id="1490562">)</span><span class="op" id="1490563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1490569">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1490575">return</span>&nbsp;<span class="ident" id="1490582">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1490587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1490591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1490595">b</span>&nbsp;<span class="op" id="1490597">=</span>&nbsp;<span class="ident" id="1490599">b</span><span class="op" id="1490600">.</span><span class="ident" id="1490601">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1490612">if</span>&nbsp;<span class="ident" id="1490615">b</span>&nbsp;<span class="op" id="1490617">==</span>&nbsp;<span class="ident" id="1490620">nil</span>&nbsp;<span class="op" id="1490624">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1490629">return</span>&nbsp;<span class="ident" id="1490636">unsafe</span><span class="op" id="1490642">.</span><span class="ident" id="1490643">Pointer</span><span class="op" id="1490650">(</span><span class="ident" id="1490651">t</span><span class="op" id="1490652">.</span><span class="ident" id="1490653">elem</span><span class="op" id="1490657">.</span><span class="ident" id="1490658">zero</span><span class="op" id="1490662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1490666">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1490669">}</span><br>
<span class="lineno"></span><span class="op" id="1490671">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="1490674">func</span>&nbsp;<span class="ident" id="1490679">mapaccess2</span><span class="op" id="1490689">(</span><span class="ident" id="1490690">t</span>&nbsp;<span class="op" id="1490692">*</span><span class="ident" id="1490693">maptype</span><span class="op" id="1490700">,</span>&nbsp;<span class="ident" id="1490702">h</span>&nbsp;<span class="op" id="1490704">*</span><span class="ident" id="1490705">hmap</span><span class="op" id="1490709">,</span>&nbsp;<span class="ident" id="1490711">key</span>&nbsp;<span class="ident" id="1490715">unsafe</span><span class="op" id="1490721">.</span><span class="ident" id="1490722">Pointer</span><span class="op" id="1490729">)</span>&nbsp;<span class="op" id="1490731">(</span><span class="ident" id="1490732">unsafe</span><span class="op" id="1490738">.</span><span class="ident" id="1490739">Pointer</span><span class="op" id="1490746">,</span>&nbsp;<span class="builtintype" id="1490748">bool</span><span class="op" id="1490752">)</span>&nbsp;<span class="op" id="1490754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1490757">if</span>&nbsp;<span class="ident" id="1490760">raceenabled</span>&nbsp;<span class="op" id="1490772">&amp;&amp;</span>&nbsp;<span class="ident" id="1490775">h</span>&nbsp;<span class="op" id="1490777">!=</span>&nbsp;<span class="ident" id="1490780">nil</span>&nbsp;<span class="op" id="1490784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1490788">callerpc</span>&nbsp;<span class="op" id="1490797">:=</span>&nbsp;<span class="ident" id="1490800">getcallerpc</span><span class="op" id="1490811">(</span><span class="ident" id="1490812">unsafe</span><span class="op" id="1490818">.</span><span class="ident" id="1490819">Pointer</span><span class="op" id="1490826">(</span><span class="op" id="1490827">&amp;</span><span class="ident" id="1490828">t</span><span class="op" id="1490829">)</span><span class="op" id="1490830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1490834">pc</span>&nbsp;<span class="op" id="1490837">:=</span>&nbsp;<span class="ident" id="1490840">funcPC</span><span class="op" id="1490846">(</span><span class="ident" id="1490847">mapaccess2</span><span class="op" id="1490857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1490861">racereadpc</span><span class="op" id="1490871">(</span><span class="ident" id="1490872">unsafe</span><span class="op" id="1490878">.</span><span class="ident" id="1490879">Pointer</span><span class="op" id="1490886">(</span><span class="ident" id="1490887">h</span><span class="op" id="1490888">)</span><span class="op" id="1490889">,</span>&nbsp;<span class="ident" id="1490891">callerpc</span><span class="op" id="1490899">,</span>&nbsp;<span class="ident" id="1490901">pc</span><span class="op" id="1490903">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1490907">raceReadObjectPC</span><span class="op" id="1490923">(</span><span class="ident" id="1490924">t</span><span class="op" id="1490925">.</span><span class="ident" id="1490926">key</span><span class="op" id="1490929">,</span>&nbsp;<span class="ident" id="1490931">key</span><span class="op" id="1490934">,</span>&nbsp;<span class="ident" id="1490936">callerpc</span><span class="op" id="1490944">,</span>&nbsp;<span class="ident" id="1490946">pc</span><span class="op" id="1490948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1490951">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1490954">if</span>&nbsp;<span class="ident" id="1490957">h</span>&nbsp;<span class="op" id="1490959">==</span>&nbsp;<span class="ident" id="1490962">nil</span>&nbsp;<span class="op" id="1490966">||</span>&nbsp;<span class="ident" id="1490969">h</span><span class="op" id="1490970">.</span><span class="ident" id="1490971">count</span>&nbsp;<span class="op" id="1490977">==</span>&nbsp;<span class="num" id="1490980">0</span>&nbsp;<span class="op" id="1490982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1490986">return</span>&nbsp;<span class="ident" id="1490993">unsafe</span><span class="op" id="1490999">.</span><span class="ident" id="1491000">Pointer</span><span class="op" id="1491007">(</span><span class="ident" id="1491008">t</span><span class="op" id="1491009">.</span><span class="ident" id="1491010">elem</span><span class="op" id="1491014">.</span><span class="ident" id="1491015">zero</span><span class="op" id="1491019">)</span><span class="op" id="1491020">,</span>&nbsp;<span class="builtintype" id="1491022">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1491029">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1491032">alg</span>&nbsp;<span class="op" id="1491036">:=</span>&nbsp;<span class="ident" id="1491039">goalg</span><span class="op" id="1491044">(</span><span class="ident" id="1491045">t</span><span class="op" id="1491046">.</span><span class="ident" id="1491047">key</span><span class="op" id="1491050">.</span><span class="ident" id="1491051">alg</span><span class="op" id="1491054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1491057">hash</span>&nbsp;<span class="op" id="1491062">:=</span>&nbsp;<span class="ident" id="1491065">alg</span><span class="op" id="1491068">.</span><span class="ident" id="1491069">hash</span><span class="op" id="1491073">(</span><span class="ident" id="1491074">key</span><span class="op" id="1491077">,</span>&nbsp;<span class="builtintype" id="1491079">uintptr</span><span class="op" id="1491086">(</span><span class="ident" id="1491087">t</span><span class="op" id="1491088">.</span><span class="ident" id="1491089">key</span><span class="op" id="1491092">.</span><span class="ident" id="1491093">size</span><span class="op" id="1491097">)</span><span class="op" id="1491098">,</span>&nbsp;<span class="builtintype" id="1491100">uintptr</span><span class="op" id="1491107">(</span><span class="ident" id="1491108">h</span><span class="op" id="1491109">.</span><span class="ident" id="1491110">hash0</span><span class="op" id="1491115">)</span><span class="op" id="1491116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1491119">m</span>&nbsp;<span class="op" id="1491121">:=</span>&nbsp;<span class="builtintype" id="1491124">uintptr</span><span class="op" id="1491131">(</span><span class="num" id="1491132">1</span><span class="op" id="1491133">)</span><span class="op" id="1491134">&lt;&lt;</span><span class="ident" id="1491136">h</span><span class="op" id="1491137">.</span><span class="ident" id="1491138">B</span>&nbsp;<span class="op" id="1491140">-</span>&nbsp;<span class="num" id="1491142">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1491145">b</span>&nbsp;<span class="op" id="1491147">:=</span>&nbsp;<span class="op" id="1491150">(</span><span class="op" id="1491151">*</span><span class="ident" id="1491152">bmap</span><span class="op" id="1491156">)</span><span class="op" id="1491157">(</span><span class="ident" id="1491158">unsafe</span><span class="op" id="1491164">.</span><span class="ident" id="1491165">Pointer</span><span class="op" id="1491172">(</span><span class="builtintype" id="1491173">uintptr</span><span class="op" id="1491180">(</span><span class="ident" id="1491181">h</span><span class="op" id="1491182">.</span><span class="ident" id="1491183">buckets</span><span class="op" id="1491190">)</span>&nbsp;<span class="op" id="1491192">+</span>&nbsp;<span class="op" id="1491194">(</span><span class="ident" id="1491195">hash</span><span class="op" id="1491199">&amp;</span><span class="ident" id="1491200">m</span><span class="op" id="1491201">)</span><span class="op" id="1491202">*</span><span class="builtintype" id="1491203">uintptr</span><span class="op" id="1491210">(</span><span class="ident" id="1491211">t</span><span class="op" id="1491212">.</span><span class="ident" id="1491213">bucketsize</span><span class="op" id="1491223">)</span><span class="op" id="1491224">)</span><span class="op" id="1491225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1491228">if</span>&nbsp;<span class="ident" id="1491231">c</span>&nbsp;<span class="op" id="1491233">:=</span>&nbsp;<span class="ident" id="1491236">h</span><span class="op" id="1491237">.</span><span class="ident" id="1491238">oldbuckets</span><span class="op" id="1491248">;</span>&nbsp;<span class="ident" id="1491250">c</span>&nbsp;<span class="op" id="1491252">!=</span>&nbsp;<span class="ident" id="1491255">nil</span>&nbsp;<span class="op" id="1491259">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1491263">oldb</span>&nbsp;<span class="op" id="1491268">:=</span>&nbsp;<span class="op" id="1491271">(</span><span class="op" id="1491272">*</span><span class="ident" id="1491273">bmap</span><span class="op" id="1491277">)</span><span class="op" id="1491278">(</span><span class="ident" id="1491279">unsafe</span><span class="op" id="1491285">.</span><span class="ident" id="1491286">Pointer</span><span class="op" id="1491293">(</span><span class="builtintype" id="1491294">uintptr</span><span class="op" id="1491301">(</span><span class="ident" id="1491302">c</span><span class="op" id="1491303">)</span>&nbsp;<span class="op" id="1491305">+</span>&nbsp;<span class="op" id="1491307">(</span><span class="ident" id="1491308">hash</span><span class="op" id="1491312">&amp;</span><span class="op" id="1491313">(</span><span class="ident" id="1491314">m</span><span class="op" id="1491315">&gt;&gt;</span><span class="num" id="1491317">1</span><span class="op" id="1491318">)</span><span class="op" id="1491319">)</span><span class="op" id="1491320">*</span><span class="builtintype" id="1491321">uintptr</span><span class="op" id="1491328">(</span><span class="ident" id="1491329">t</span><span class="op" id="1491330">.</span><span class="ident" id="1491331">bucketsize</span><span class="op" id="1491341">)</span><span class="op" id="1491342">)</span><span class="op" id="1491343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1491347">if</span>&nbsp;<span class="op" id="1491350">!</span><span class="ident" id="1491351">evacuated</span><span class="op" id="1491360">(</span><span class="ident" id="1491361">oldb</span><span class="op" id="1491365">)</span>&nbsp;<span class="op" id="1491367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1491372">b</span>&nbsp;<span class="op" id="1491374">=</span>&nbsp;<span class="ident" id="1491376">oldb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1491383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1491386">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1491389">top</span>&nbsp;<span class="op" id="1491393">:=</span>&nbsp;<span class="builtintype" id="1491396">uint8</span><span class="op" id="1491401">(</span><span class="ident" id="1491402">hash</span>&nbsp;<span class="op" id="1491407">&gt;&gt;</span>&nbsp;<span class="op" id="1491410">(</span><span class="ident" id="1491411">ptrSize</span><span class="op" id="1491418">*</span><span class="num" id="1491419">8</span>&nbsp;<span class="op" id="1491421">-</span>&nbsp;<span class="num" id="1491423">8</span><span class="op" id="1491424">)</span><span class="op" id="1491425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1491428">if</span>&nbsp;<span class="ident" id="1491431">top</span>&nbsp;<span class="op" id="1491435">&lt;</span>&nbsp;<span class="ident" id="1491437">minTopHash</span>&nbsp;<span class="op" id="1491448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1491452">top</span>&nbsp;<span class="op" id="1491456">+=</span>&nbsp;<span class="ident" id="1491459">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1491471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1491474">for</span>&nbsp;<span class="op" id="1491478">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1491482">for</span>&nbsp;<span class="ident" id="1491486">i</span>&nbsp;<span class="op" id="1491488">:=</span>&nbsp;<span class="builtintype" id="1491491">uintptr</span><span class="op" id="1491498">(</span><span class="num" id="1491499">0</span><span class="op" id="1491500">)</span><span class="op" id="1491501">;</span>&nbsp;<span class="ident" id="1491503">i</span>&nbsp;<span class="op" id="1491505">&lt;</span>&nbsp;<span class="ident" id="1491507">bucketCnt</span><span class="op" id="1491516">;</span>&nbsp;<span class="ident" id="1491518">i</span><span class="op" id="1491519">++</span>&nbsp;<span class="op" id="1491522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1491527">if</span>&nbsp;<span class="ident" id="1491530">b</span><span class="op" id="1491531">.</span><span class="ident" id="1491532">tophash</span><span class="op" id="1491539">[</span><span class="ident" id="1491540">i</span><span class="op" id="1491541">]</span>&nbsp;<span class="op" id="1491543">!=</span>&nbsp;<span class="ident" id="1491546">top</span>&nbsp;<span class="op" id="1491550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1491556">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1491568">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1491573">k</span>&nbsp;<span class="op" id="1491575">:=</span>&nbsp;<span class="ident" id="1491578">add</span><span class="op" id="1491581">(</span><span class="ident" id="1491582">unsafe</span><span class="op" id="1491588">.</span><span class="ident" id="1491589">Pointer</span><span class="op" id="1491596">(</span><span class="ident" id="1491597">b</span><span class="op" id="1491598">)</span><span class="op" id="1491599">,</span>&nbsp;<span class="ident" id="1491601">dataOffset</span><span class="op" id="1491611">+</span><span class="ident" id="1491612">i</span><span class="op" id="1491613">*</span><span class="builtintype" id="1491614">uintptr</span><span class="op" id="1491621">(</span><span class="ident" id="1491622">t</span><span class="op" id="1491623">.</span><span class="ident" id="1491624">keysize</span><span class="op" id="1491631">)</span><span class="op" id="1491632">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1491637">if</span>&nbsp;<span class="ident" id="1491640">t</span><span class="op" id="1491641">.</span><span class="ident" id="1491642">indirectkey</span>&nbsp;<span class="op" id="1491654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1491660">k</span>&nbsp;<span class="op" id="1491662">=</span>&nbsp;<span class="op" id="1491664">*</span><span class="op" id="1491665">(</span><span class="op" id="1491666">(</span><span class="op" id="1491667">*</span><span class="ident" id="1491668">unsafe</span><span class="op" id="1491674">.</span><span class="ident" id="1491675">Pointer</span><span class="op" id="1491682">)</span><span class="op" id="1491683">(</span><span class="ident" id="1491684">k</span><span class="op" id="1491685">)</span><span class="op" id="1491686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1491691">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1491696">if</span>&nbsp;<span class="ident" id="1491699">alg</span><span class="op" id="1491702">.</span><span class="ident" id="1491703">equal</span><span class="op" id="1491708">(</span><span class="ident" id="1491709">key</span><span class="op" id="1491712">,</span>&nbsp;<span class="ident" id="1491714">k</span><span class="op" id="1491715">,</span>&nbsp;<span class="builtintype" id="1491717">uintptr</span><span class="op" id="1491724">(</span><span class="ident" id="1491725">t</span><span class="op" id="1491726">.</span><span class="ident" id="1491727">key</span><span class="op" id="1491730">.</span><span class="ident" id="1491731">size</span><span class="op" id="1491735">)</span><span class="op" id="1491736">)</span>&nbsp;<span class="op" id="1491738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1491744">v</span>&nbsp;<span class="op" id="1491746">:=</span>&nbsp;<span class="ident" id="1491749">add</span><span class="op" id="1491752">(</span><span class="ident" id="1491753">unsafe</span><span class="op" id="1491759">.</span><span class="ident" id="1491760">Pointer</span><span class="op" id="1491767">(</span><span class="ident" id="1491768">b</span><span class="op" id="1491769">)</span><span class="op" id="1491770">,</span>&nbsp;<span class="ident" id="1491772">dataOffset</span><span class="op" id="1491782">+</span><span class="ident" id="1491783">bucketCnt</span><span class="op" id="1491792">*</span><span class="builtintype" id="1491793">uintptr</span><span class="op" id="1491800">(</span><span class="ident" id="1491801">t</span><span class="op" id="1491802">.</span><span class="ident" id="1491803">keysize</span><span class="op" id="1491810">)</span><span class="op" id="1491811">+</span><span class="ident" id="1491812">i</span><span class="op" id="1491813">*</span><span class="builtintype" id="1491814">uintptr</span><span class="op" id="1491821">(</span><span class="ident" id="1491822">t</span><span class="op" id="1491823">.</span><span class="ident" id="1491824">valuesize</span><span class="op" id="1491833">)</span><span class="op" id="1491834">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1491840">if</span>&nbsp;<span class="ident" id="1491843">t</span><span class="op" id="1491844">.</span><span class="ident" id="1491845">indirectvalue</span>&nbsp;<span class="op" id="1491859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1491866">v</span>&nbsp;<span class="op" id="1491868">=</span>&nbsp;<span class="op" id="1491870">*</span><span class="op" id="1491871">(</span><span class="op" id="1491872">(</span><span class="op" id="1491873">*</span><span class="ident" id="1491874">unsafe</span><span class="op" id="1491880">.</span><span class="ident" id="1491881">Pointer</span><span class="op" id="1491888">)</span><span class="op" id="1491889">(</span><span class="ident" id="1491890">v</span><span class="op" id="1491891">)</span><span class="op" id="1491892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1491898">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1491904">return</span>&nbsp;<span class="ident" id="1491911">v</span><span class="op" id="1491912">,</span>&nbsp;<span class="builtintype" id="1491914">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1491922">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1491926">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1491930">b</span>&nbsp;<span class="op" id="1491932">=</span>&nbsp;<span class="ident" id="1491934">b</span><span class="op" id="1491935">.</span><span class="ident" id="1491936">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1491947">if</span>&nbsp;<span class="ident" id="1491950">b</span>&nbsp;<span class="op" id="1491952">==</span>&nbsp;<span class="ident" id="1491955">nil</span>&nbsp;<span class="op" id="1491959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1491964">return</span>&nbsp;<span class="ident" id="1491971">unsafe</span><span class="op" id="1491977">.</span><span class="ident" id="1491978">Pointer</span><span class="op" id="1491985">(</span><span class="ident" id="1491986">t</span><span class="op" id="1491987">.</span><span class="ident" id="1491988">elem</span><span class="op" id="1491992">.</span><span class="ident" id="1491993">zero</span><span class="op" id="1491997">)</span><span class="op" id="1491998">,</span>&nbsp;<span class="builtintype" id="1492000">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1492008">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1492011">}</span><br>
<span class="lineno"></span><span class="op" id="1492013">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1492016">//&nbsp;returns&nbsp;both&nbsp;key&nbsp;and&nbsp;value.&nbsp;&nbsp;Used&nbsp;by&nbsp;map&nbsp;iterator</span><br>
<span class="lineno"></span><span class="keyword" id="1492069">func</span>&nbsp;<span class="ident" id="1492074">mapaccessK</span><span class="op" id="1492084">(</span><span class="ident" id="1492085">t</span>&nbsp;<span class="op" id="1492087">*</span><span class="ident" id="1492088">maptype</span><span class="op" id="1492095">,</span>&nbsp;<span class="ident" id="1492097">h</span>&nbsp;<span class="op" id="1492099">*</span><span class="ident" id="1492100">hmap</span><span class="op" id="1492104">,</span>&nbsp;<span class="ident" id="1492106">key</span>&nbsp;<span class="ident" id="1492110">unsafe</span><span class="op" id="1492116">.</span><span class="ident" id="1492117">Pointer</span><span class="op" id="1492124">)</span>&nbsp;<span class="op" id="1492126">(</span><span class="ident" id="1492127">unsafe</span><span class="op" id="1492133">.</span><span class="ident" id="1492134">Pointer</span><span class="op" id="1492141">,</span>&nbsp;<span class="ident" id="1492143">unsafe</span><span class="op" id="1492149">.</span><span class="ident" id="1492150">Pointer</span><span class="op" id="1492157">)</span>&nbsp;<span class="op" id="1492159">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1492162">if</span>&nbsp;<span class="ident" id="1492165">h</span>&nbsp;<span class="op" id="1492167">==</span>&nbsp;<span class="ident" id="1492170">nil</span>&nbsp;<span class="op" id="1492174">||</span>&nbsp;<span class="ident" id="1492177">h</span><span class="op" id="1492178">.</span><span class="ident" id="1492179">count</span>&nbsp;<span class="op" id="1492185">==</span>&nbsp;<span class="num" id="1492188">0</span>&nbsp;<span class="op" id="1492190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1492194">return</span>&nbsp;<span class="ident" id="1492201">nil</span><span class="op" id="1492204">,</span>&nbsp;<span class="ident" id="1492206">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1492211">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1492214">alg</span>&nbsp;<span class="op" id="1492218">:=</span>&nbsp;<span class="ident" id="1492221">goalg</span><span class="op" id="1492226">(</span><span class="ident" id="1492227">t</span><span class="op" id="1492228">.</span><span class="ident" id="1492229">key</span><span class="op" id="1492232">.</span><span class="ident" id="1492233">alg</span><span class="op" id="1492236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1492239">hash</span>&nbsp;<span class="op" id="1492244">:=</span>&nbsp;<span class="ident" id="1492247">alg</span><span class="op" id="1492250">.</span><span class="ident" id="1492251">hash</span><span class="op" id="1492255">(</span><span class="ident" id="1492256">key</span><span class="op" id="1492259">,</span>&nbsp;<span class="builtintype" id="1492261">uintptr</span><span class="op" id="1492268">(</span><span class="ident" id="1492269">t</span><span class="op" id="1492270">.</span><span class="ident" id="1492271">key</span><span class="op" id="1492274">.</span><span class="ident" id="1492275">size</span><span class="op" id="1492279">)</span><span class="op" id="1492280">,</span>&nbsp;<span class="builtintype" id="1492282">uintptr</span><span class="op" id="1492289">(</span><span class="ident" id="1492290">h</span><span class="op" id="1492291">.</span><span class="ident" id="1492292">hash0</span><span class="op" id="1492297">)</span><span class="op" id="1492298">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1492301">m</span>&nbsp;<span class="op" id="1492303">:=</span>&nbsp;<span class="builtintype" id="1492306">uintptr</span><span class="op" id="1492313">(</span><span class="num" id="1492314">1</span><span class="op" id="1492315">)</span><span class="op" id="1492316">&lt;&lt;</span><span class="ident" id="1492318">h</span><span class="op" id="1492319">.</span><span class="ident" id="1492320">B</span>&nbsp;<span class="op" id="1492322">-</span>&nbsp;<span class="num" id="1492324">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1492327">b</span>&nbsp;<span class="op" id="1492329">:=</span>&nbsp;<span class="op" id="1492332">(</span><span class="op" id="1492333">*</span><span class="ident" id="1492334">bmap</span><span class="op" id="1492338">)</span><span class="op" id="1492339">(</span><span class="ident" id="1492340">unsafe</span><span class="op" id="1492346">.</span><span class="ident" id="1492347">Pointer</span><span class="op" id="1492354">(</span><span class="builtintype" id="1492355">uintptr</span><span class="op" id="1492362">(</span><span class="ident" id="1492363">h</span><span class="op" id="1492364">.</span><span class="ident" id="1492365">buckets</span><span class="op" id="1492372">)</span>&nbsp;<span class="op" id="1492374">+</span>&nbsp;<span class="op" id="1492376">(</span><span class="ident" id="1492377">hash</span><span class="op" id="1492381">&amp;</span><span class="ident" id="1492382">m</span><span class="op" id="1492383">)</span><span class="op" id="1492384">*</span><span class="builtintype" id="1492385">uintptr</span><span class="op" id="1492392">(</span><span class="ident" id="1492393">t</span><span class="op" id="1492394">.</span><span class="ident" id="1492395">bucketsize</span><span class="op" id="1492405">)</span><span class="op" id="1492406">)</span><span class="op" id="1492407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1492410">if</span>&nbsp;<span class="ident" id="1492413">c</span>&nbsp;<span class="op" id="1492415">:=</span>&nbsp;<span class="ident" id="1492418">h</span><span class="op" id="1492419">.</span><span class="ident" id="1492420">oldbuckets</span><span class="op" id="1492430">;</span>&nbsp;<span class="ident" id="1492432">c</span>&nbsp;<span class="op" id="1492434">!=</span>&nbsp;<span class="ident" id="1492437">nil</span>&nbsp;<span class="op" id="1492441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1492445">oldb</span>&nbsp;<span class="op" id="1492450">:=</span>&nbsp;<span class="op" id="1492453">(</span><span class="op" id="1492454">*</span><span class="ident" id="1492455">bmap</span><span class="op" id="1492459">)</span><span class="op" id="1492460">(</span><span class="ident" id="1492461">unsafe</span><span class="op" id="1492467">.</span><span class="ident" id="1492468">Pointer</span><span class="op" id="1492475">(</span><span class="builtintype" id="1492476">uintptr</span><span class="op" id="1492483">(</span><span class="ident" id="1492484">c</span><span class="op" id="1492485">)</span>&nbsp;<span class="op" id="1492487">+</span>&nbsp;<span class="op" id="1492489">(</span><span class="ident" id="1492490">hash</span><span class="op" id="1492494">&amp;</span><span class="op" id="1492495">(</span><span class="ident" id="1492496">m</span><span class="op" id="1492497">&gt;&gt;</span><span class="num" id="1492499">1</span><span class="op" id="1492500">)</span><span class="op" id="1492501">)</span><span class="op" id="1492502">*</span><span class="builtintype" id="1492503">uintptr</span><span class="op" id="1492510">(</span><span class="ident" id="1492511">t</span><span class="op" id="1492512">.</span><span class="ident" id="1492513">bucketsize</span><span class="op" id="1492523">)</span><span class="op" id="1492524">)</span><span class="op" id="1492525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1492529">if</span>&nbsp;<span class="op" id="1492532">!</span><span class="ident" id="1492533">evacuated</span><span class="op" id="1492542">(</span><span class="ident" id="1492543">oldb</span><span class="op" id="1492547">)</span>&nbsp;<span class="op" id="1492549">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1492554">b</span>&nbsp;<span class="op" id="1492556">=</span>&nbsp;<span class="ident" id="1492558">oldb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1492565">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1492568">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1492571">top</span>&nbsp;<span class="op" id="1492575">:=</span>&nbsp;<span class="builtintype" id="1492578">uint8</span><span class="op" id="1492583">(</span><span class="ident" id="1492584">hash</span>&nbsp;<span class="op" id="1492589">&gt;&gt;</span>&nbsp;<span class="op" id="1492592">(</span><span class="ident" id="1492593">ptrSize</span><span class="op" id="1492600">*</span><span class="num" id="1492601">8</span>&nbsp;<span class="op" id="1492603">-</span>&nbsp;<span class="num" id="1492605">8</span><span class="op" id="1492606">)</span><span class="op" id="1492607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1492610">if</span>&nbsp;<span class="ident" id="1492613">top</span>&nbsp;<span class="op" id="1492617">&lt;</span>&nbsp;<span class="ident" id="1492619">minTopHash</span>&nbsp;<span class="op" id="1492630">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1492634">top</span>&nbsp;<span class="op" id="1492638">+=</span>&nbsp;<span class="ident" id="1492641">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1492653">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1492656">for</span>&nbsp;<span class="op" id="1492660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1492664">for</span>&nbsp;<span class="ident" id="1492668">i</span>&nbsp;<span class="op" id="1492670">:=</span>&nbsp;<span class="builtintype" id="1492673">uintptr</span><span class="op" id="1492680">(</span><span class="num" id="1492681">0</span><span class="op" id="1492682">)</span><span class="op" id="1492683">;</span>&nbsp;<span class="ident" id="1492685">i</span>&nbsp;<span class="op" id="1492687">&lt;</span>&nbsp;<span class="ident" id="1492689">bucketCnt</span><span class="op" id="1492698">;</span>&nbsp;<span class="ident" id="1492700">i</span><span class="op" id="1492701">++</span>&nbsp;<span class="op" id="1492704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1492709">if</span>&nbsp;<span class="ident" id="1492712">b</span><span class="op" id="1492713">.</span><span class="ident" id="1492714">tophash</span><span class="op" id="1492721">[</span><span class="ident" id="1492722">i</span><span class="op" id="1492723">]</span>&nbsp;<span class="op" id="1492725">!=</span>&nbsp;<span class="ident" id="1492728">top</span>&nbsp;<span class="op" id="1492732">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1492738">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1492750">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1492755">k</span>&nbsp;<span class="op" id="1492757">:=</span>&nbsp;<span class="ident" id="1492760">add</span><span class="op" id="1492763">(</span><span class="ident" id="1492764">unsafe</span><span class="op" id="1492770">.</span><span class="ident" id="1492771">Pointer</span><span class="op" id="1492778">(</span><span class="ident" id="1492779">b</span><span class="op" id="1492780">)</span><span class="op" id="1492781">,</span>&nbsp;<span class="ident" id="1492783">dataOffset</span><span class="op" id="1492793">+</span><span class="ident" id="1492794">i</span><span class="op" id="1492795">*</span><span class="builtintype" id="1492796">uintptr</span><span class="op" id="1492803">(</span><span class="ident" id="1492804">t</span><span class="op" id="1492805">.</span><span class="ident" id="1492806">keysize</span><span class="op" id="1492813">)</span><span class="op" id="1492814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1492819">if</span>&nbsp;<span class="ident" id="1492822">t</span><span class="op" id="1492823">.</span><span class="ident" id="1492824">indirectkey</span>&nbsp;<span class="op" id="1492836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1492842">k</span>&nbsp;<span class="op" id="1492844">=</span>&nbsp;<span class="op" id="1492846">*</span><span class="op" id="1492847">(</span><span class="op" id="1492848">(</span><span class="op" id="1492849">*</span><span class="ident" id="1492850">unsafe</span><span class="op" id="1492856">.</span><span class="ident" id="1492857">Pointer</span><span class="op" id="1492864">)</span><span class="op" id="1492865">(</span><span class="ident" id="1492866">k</span><span class="op" id="1492867">)</span><span class="op" id="1492868">)</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1492873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1492878">if</span>&nbsp;<span class="ident" id="1492881">alg</span><span class="op" id="1492884">.</span><span class="ident" id="1492885">equal</span><span class="op" id="1492890">(</span><span class="ident" id="1492891">key</span><span class="op" id="1492894">,</span>&nbsp;<span class="ident" id="1492896">k</span><span class="op" id="1492897">,</span>&nbsp;<span class="builtintype" id="1492899">uintptr</span><span class="op" id="1492906">(</span><span class="ident" id="1492907">t</span><span class="op" id="1492908">.</span><span class="ident" id="1492909">key</span><span class="op" id="1492912">.</span><span class="ident" id="1492913">size</span><span class="op" id="1492917">)</span><span class="op" id="1492918">)</span>&nbsp;<span class="op" id="1492920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1492926">v</span>&nbsp;<span class="op" id="1492928">:=</span>&nbsp;<span class="ident" id="1492931">add</span><span class="op" id="1492934">(</span><span class="ident" id="1492935">unsafe</span><span class="op" id="1492941">.</span><span class="ident" id="1492942">Pointer</span><span class="op" id="1492949">(</span><span class="ident" id="1492950">b</span><span class="op" id="1492951">)</span><span class="op" id="1492952">,</span>&nbsp;<span class="ident" id="1492954">dataOffset</span><span class="op" id="1492964">+</span><span class="ident" id="1492965">bucketCnt</span><span class="op" id="1492974">*</span><span class="builtintype" id="1492975">uintptr</span><span class="op" id="1492982">(</span><span class="ident" id="1492983">t</span><span class="op" id="1492984">.</span><span class="ident" id="1492985">keysize</span><span class="op" id="1492992">)</span><span class="op" id="1492993">+</span><span class="ident" id="1492994">i</span><span class="op" id="1492995">*</span><span class="builtintype" id="1492996">uintptr</span><span class="op" id="1493003">(</span><span class="ident" id="1493004">t</span><span class="op" id="1493005">.</span><span class="ident" id="1493006">valuesize</span><span class="op" id="1493015">)</span><span class="op" id="1493016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1493022">if</span>&nbsp;<span class="ident" id="1493025">t</span><span class="op" id="1493026">.</span><span class="ident" id="1493027">indirectvalue</span>&nbsp;<span class="op" id="1493041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1493048">v</span>&nbsp;<span class="op" id="1493050">=</span>&nbsp;<span class="op" id="1493052">*</span><span class="op" id="1493053">(</span><span class="op" id="1493054">(</span><span class="op" id="1493055">*</span><span class="ident" id="1493056">unsafe</span><span class="op" id="1493062">.</span><span class="ident" id="1493063">Pointer</span><span class="op" id="1493070">)</span><span class="op" id="1493071">(</span><span class="ident" id="1493072">v</span><span class="op" id="1493073">)</span><span class="op" id="1493074">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1493080">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1493086">return</span>&nbsp;<span class="ident" id="1493093">k</span><span class="op" id="1493094">,</span>&nbsp;<span class="ident" id="1493096">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1493101">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1493105">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1493109">b</span>&nbsp;<span class="op" id="1493111">=</span>&nbsp;<span class="ident" id="1493113">b</span><span class="op" id="1493114">.</span><span class="ident" id="1493115">overflow</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1493126">if</span>&nbsp;<span class="ident" id="1493129">b</span>&nbsp;<span class="op" id="1493131">==</span>&nbsp;<span class="ident" id="1493134">nil</span>&nbsp;<span class="op" id="1493138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1493143">return</span>&nbsp;<span class="ident" id="1493150">nil</span><span class="op" id="1493153">,</span>&nbsp;<span class="ident" id="1493155">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1493161">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1493164">}</span><br>
<span class="lineno"></span><span class="op" id="1493166">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span><span class="keyword" id="1493169">func</span>&nbsp;<span class="ident" id="1493174">mapassign1</span><span class="op" id="1493184">(</span><span class="ident" id="1493185">t</span>&nbsp;<span class="op" id="1493187">*</span><span class="ident" id="1493188">maptype</span><span class="op" id="1493195">,</span>&nbsp;<span class="ident" id="1493197">h</span>&nbsp;<span class="op" id="1493199">*</span><span class="ident" id="1493200">hmap</span><span class="op" id="1493204">,</span>&nbsp;<span class="ident" id="1493206">key</span>&nbsp;<span class="ident" id="1493210">unsafe</span><span class="op" id="1493216">.</span><span class="ident" id="1493217">Pointer</span><span class="op" id="1493224">,</span>&nbsp;<span class="ident" id="1493226">val</span>&nbsp;<span class="ident" id="1493230">unsafe</span><span class="op" id="1493236">.</span><span class="ident" id="1493237">Pointer</span><span class="op" id="1493244">)</span>&nbsp;<span class="op" id="1493246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1493249">if</span>&nbsp;<span class="ident" id="1493252">h</span>&nbsp;<span class="op" id="1493254">==</span>&nbsp;<span class="ident" id="1493257">nil</span>&nbsp;<span class="op" id="1493261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1493265">panic</span><span class="op" id="1493270">(</span><span class="string" id="1493271">&#34;assignment&nbsp;to&nbsp;entry&nbsp;in&nbsp;nil&nbsp;map&#34;</span><span class="op" id="1493303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1493306">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1493309">if</span>&nbsp;<span class="ident" id="1493312">raceenabled</span>&nbsp;<span class="op" id="1493324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1493328">callerpc</span>&nbsp;<span class="op" id="1493337">:=</span>&nbsp;<span class="ident" id="1493340">getcallerpc</span><span class="op" id="1493351">(</span><span class="ident" id="1493352">unsafe</span><span class="op" id="1493358">.</span><span class="ident" id="1493359">Pointer</span><span class="op" id="1493366">(</span><span class="op" id="1493367">&amp;</span><span class="ident" id="1493368">t</span><span class="op" id="1493369">)</span><span class="op" id="1493370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1493374">pc</span>&nbsp;<span class="op" id="1493377">:=</span>&nbsp;<span class="ident" id="1493380">funcPC</span><span class="op" id="1493386">(</span><span class="ident" id="1493387">mapassign1</span><span class="op" id="1493397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1493401">racewritepc</span><span class="op" id="1493412">(</span><span class="ident" id="1493413">unsafe</span><span class="op" id="1493419">.</span><span class="ident" id="1493420">Pointer</span><span class="op" id="1493427">(</span><span class="ident" id="1493428">h</span><span class="op" id="1493429">)</span><span class="op" id="1493430">,</span>&nbsp;<span class="ident" id="1493432">callerpc</span><span class="op" id="1493440">,</span>&nbsp;<span class="ident" id="1493442">pc</span><span class="op" id="1493444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1493448">raceReadObjectPC</span><span class="op" id="1493464">(</span><span class="ident" id="1493465">t</span><span class="op" id="1493466">.</span><span class="ident" id="1493467">key</span><span class="op" id="1493470">,</span>&nbsp;<span class="ident" id="1493472">key</span><span class="op" id="1493475">,</span>&nbsp;<span class="ident" id="1493477">callerpc</span><span class="op" id="1493485">,</span>&nbsp;<span class="ident" id="1493487">pc</span><span class="op" id="1493489">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1493493">raceReadObjectPC</span><span class="op" id="1493509">(</span><span class="ident" id="1493510">t</span><span class="op" id="1493511">.</span><span class="ident" id="1493512">elem</span><span class="op" id="1493516">,</span>&nbsp;<span class="ident" id="1493518">val</span><span class="op" id="1493521">,</span>&nbsp;<span class="ident" id="1493523">callerpc</span><span class="op" id="1493531">,</span>&nbsp;<span class="ident" id="1493533">pc</span><span class="op" id="1493535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1493538">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1493542">alg</span>&nbsp;<span class="op" id="1493546">:=</span>&nbsp;<span class="ident" id="1493549">goalg</span><span class="op" id="1493554">(</span><span class="ident" id="1493555">t</span><span class="op" id="1493556">.</span><span class="ident" id="1493557">key</span><span class="op" id="1493560">.</span><span class="ident" id="1493561">alg</span><span class="op" id="1493564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1493567">hash</span>&nbsp;<span class="op" id="1493572">:=</span>&nbsp;<span class="ident" id="1493575">alg</span><span class="op" id="1493578">.</span><span class="ident" id="1493579">hash</span><span class="op" id="1493583">(</span><span class="ident" id="1493584">key</span><span class="op" id="1493587">,</span>&nbsp;<span class="builtintype" id="1493589">uintptr</span><span class="op" id="1493596">(</span><span class="ident" id="1493597">t</span><span class="op" id="1493598">.</span><span class="ident" id="1493599">key</span><span class="op" id="1493602">.</span><span class="ident" id="1493603">size</span><span class="op" id="1493607">)</span><span class="op" id="1493608">,</span>&nbsp;<span class="builtintype" id="1493610">uintptr</span><span class="op" id="1493617">(</span><span class="ident" id="1493618">h</span><span class="op" id="1493619">.</span><span class="ident" id="1493620">hash0</span><span class="op" id="1493625">)</span><span class="op" id="1493626">)</span><br>
<span class="lineno">390</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1493630">if</span>&nbsp;<span class="ident" id="1493633">h</span><span class="op" id="1493634">.</span><span class="ident" id="1493635">buckets</span>&nbsp;<span class="op" id="1493643">==</span>&nbsp;<span class="ident" id="1493646">nil</span>&nbsp;<span class="op" id="1493650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1493654">if</span>&nbsp;<span class="ident" id="1493657">checkgc</span>&nbsp;<span class="op" id="1493665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1493670">memstats</span><span class="op" id="1493678">.</span><span class="ident" id="1493679">next_gc</span>&nbsp;<span class="op" id="1493687">=</span>&nbsp;<span class="ident" id="1493689">memstats</span><span class="op" id="1493697">.</span><span class="ident" id="1493698">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1493711">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1493715">h</span><span class="op" id="1493716">.</span><span class="ident" id="1493717">buckets</span>&nbsp;<span class="op" id="1493725">=</span>&nbsp;<span class="ident" id="1493727">newarray</span><span class="op" id="1493735">(</span><span class="ident" id="1493736">t</span><span class="op" id="1493737">.</span><span class="ident" id="1493738">bucket</span><span class="op" id="1493744">,</span>&nbsp;<span class="num" id="1493746">1</span><span class="op" id="1493747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1493750">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1493753">again</span><span class="op" id="1493758">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1493761">bucket</span>&nbsp;<span class="op" id="1493768">:=</span>&nbsp;<span class="ident" id="1493771">hash</span>&nbsp;<span class="op" id="1493776">&amp;</span>&nbsp;<span class="op" id="1493778">(</span><span class="builtintype" id="1493779">uintptr</span><span class="op" id="1493786">(</span><span class="num" id="1493787">1</span><span class="op" id="1493788">)</span><span class="op" id="1493789">&lt;&lt;</span><span class="ident" id="1493791">h</span><span class="op" id="1493792">.</span><span class="ident" id="1493793">B</span>&nbsp;<span class="op" id="1493795">-</span>&nbsp;<span class="num" id="1493797">1</span><span class="op" id="1493798">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1493801">if</span>&nbsp;<span class="ident" id="1493804">h</span><span class="op" id="1493805">.</span><span class="ident" id="1493806">oldbuckets</span>&nbsp;<span class="op" id="1493817">!=</span>&nbsp;<span class="ident" id="1493820">nil</span>&nbsp;<span class="op" id="1493824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1493828">growWork</span><span class="op" id="1493836">(</span><span class="ident" id="1493837">t</span><span class="op" id="1493838">,</span>&nbsp;<span class="ident" id="1493840">h</span><span class="op" id="1493841">,</span>&nbsp;<span class="ident" id="1493843">bucket</span><span class="op" id="1493849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1493852">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1493855">b</span>&nbsp;<span class="op" id="1493857">:=</span>&nbsp;<span class="op" id="1493860">(</span><span class="op" id="1493861">*</span><span class="ident" id="1493862">bmap</span><span class="op" id="1493866">)</span><span class="op" id="1493867">(</span><span class="ident" id="1493868">unsafe</span><span class="op" id="1493874">.</span><span class="ident" id="1493875">Pointer</span><span class="op" id="1493882">(</span><span class="builtintype" id="1493883">uintptr</span><span class="op" id="1493890">(</span><span class="ident" id="1493891">h</span><span class="op" id="1493892">.</span><span class="ident" id="1493893">buckets</span><span class="op" id="1493900">)</span>&nbsp;<span class="op" id="1493902">+</span>&nbsp;<span class="ident" id="1493904">bucket</span><span class="op" id="1493910">*</span><span class="builtintype" id="1493911">uintptr</span><span class="op" id="1493918">(</span><span class="ident" id="1493919">t</span><span class="op" id="1493920">.</span><span class="ident" id="1493921">bucketsize</span><span class="op" id="1493931">)</span><span class="op" id="1493932">)</span><span class="op" id="1493933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1493936">top</span>&nbsp;<span class="op" id="1493940">:=</span>&nbsp;<span class="builtintype" id="1493943">uint8</span><span class="op" id="1493948">(</span><span class="ident" id="1493949">hash</span>&nbsp;<span class="op" id="1493954">&gt;&gt;</span>&nbsp;<span class="op" id="1493957">(</span><span class="ident" id="1493958">ptrSize</span><span class="op" id="1493965">*</span><span class="num" id="1493966">8</span>&nbsp;<span class="op" id="1493968">-</span>&nbsp;<span class="num" id="1493970">8</span><span class="op" id="1493971">)</span><span class="op" id="1493972">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1493975">if</span>&nbsp;<span class="ident" id="1493978">top</span>&nbsp;<span class="op" id="1493982">&lt;</span>&nbsp;<span class="ident" id="1493984">minTopHash</span>&nbsp;<span class="op" id="1493995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1493999">top</span>&nbsp;<span class="op" id="1494003">+=</span>&nbsp;<span class="ident" id="1494006">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1494018">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1494022">var</span>&nbsp;<span class="ident" id="1494026">inserti</span>&nbsp;<span class="op" id="1494034">*</span><span class="builtintype" id="1494035">uint8</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1494042">var</span>&nbsp;<span class="ident" id="1494046">insertk</span>&nbsp;<span class="ident" id="1494054">unsafe</span><span class="op" id="1494060">.</span><span class="ident" id="1494061">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1494070">var</span>&nbsp;<span class="ident" id="1494074">insertv</span>&nbsp;<span class="ident" id="1494082">unsafe</span><span class="op" id="1494088">.</span><span class="ident" id="1494089">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1494098">for</span>&nbsp;<span class="op" id="1494102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1494106">for</span>&nbsp;<span class="ident" id="1494110">i</span>&nbsp;<span class="op" id="1494112">:=</span>&nbsp;<span class="builtintype" id="1494115">uintptr</span><span class="op" id="1494122">(</span><span class="num" id="1494123">0</span><span class="op" id="1494124">)</span><span class="op" id="1494125">;</span>&nbsp;<span class="ident" id="1494127">i</span>&nbsp;<span class="op" id="1494129">&lt;</span>&nbsp;<span class="ident" id="1494131">bucketCnt</span><span class="op" id="1494140">;</span>&nbsp;<span class="ident" id="1494142">i</span><span class="op" id="1494143">++</span>&nbsp;<span class="op" id="1494146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1494151">if</span>&nbsp;<span class="ident" id="1494154">b</span><span class="op" id="1494155">.</span><span class="ident" id="1494156">tophash</span><span class="op" id="1494163">[</span><span class="ident" id="1494164">i</span><span class="op" id="1494165">]</span>&nbsp;<span class="op" id="1494167">!=</span>&nbsp;<span class="ident" id="1494170">top</span>&nbsp;<span class="op" id="1494174">{</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1494180">if</span>&nbsp;<span class="ident" id="1494183">b</span><span class="op" id="1494184">.</span><span class="ident" id="1494185">tophash</span><span class="op" id="1494192">[</span><span class="ident" id="1494193">i</span><span class="op" id="1494194">]</span>&nbsp;<span class="op" id="1494196">==</span>&nbsp;<span class="ident" id="1494199">empty</span>&nbsp;<span class="op" id="1494205">&amp;&amp;</span>&nbsp;<span class="ident" id="1494208">inserti</span>&nbsp;<span class="op" id="1494216">==</span>&nbsp;<span class="ident" id="1494219">nil</span>&nbsp;<span class="op" id="1494223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1494230">inserti</span>&nbsp;<span class="op" id="1494238">=</span>&nbsp;<span class="op" id="1494240">&amp;</span><span class="ident" id="1494241">b</span><span class="op" id="1494242">.</span><span class="ident" id="1494243">tophash</span><span class="op" id="1494250">[</span><span class="ident" id="1494251">i</span><span class="op" id="1494252">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1494259">insertk</span>&nbsp;<span class="op" id="1494267">=</span>&nbsp;<span class="ident" id="1494269">add</span><span class="op" id="1494272">(</span><span class="ident" id="1494273">unsafe</span><span class="op" id="1494279">.</span><span class="ident" id="1494280">Pointer</span><span class="op" id="1494287">(</span><span class="ident" id="1494288">b</span><span class="op" id="1494289">)</span><span class="op" id="1494290">,</span>&nbsp;<span class="ident" id="1494292">dataOffset</span><span class="op" id="1494302">+</span><span class="ident" id="1494303">i</span><span class="op" id="1494304">*</span><span class="builtintype" id="1494305">uintptr</span><span class="op" id="1494312">(</span><span class="ident" id="1494313">t</span><span class="op" id="1494314">.</span><span class="ident" id="1494315">keysize</span><span class="op" id="1494322">)</span><span class="op" id="1494323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1494330">insertv</span>&nbsp;<span class="op" id="1494338">=</span>&nbsp;<span class="ident" id="1494340">add</span><span class="op" id="1494343">(</span><span class="ident" id="1494344">unsafe</span><span class="op" id="1494350">.</span><span class="ident" id="1494351">Pointer</span><span class="op" id="1494358">(</span><span class="ident" id="1494359">b</span><span class="op" id="1494360">)</span><span class="op" id="1494361">,</span>&nbsp;<span class="ident" id="1494363">dataOffset</span><span class="op" id="1494373">+</span><span class="ident" id="1494374">bucketCnt</span><span class="op" id="1494383">*</span><span class="builtintype" id="1494384">uintptr</span><span class="op" id="1494391">(</span><span class="ident" id="1494392">t</span><span class="op" id="1494393">.</span><span class="ident" id="1494394">keysize</span><span class="op" id="1494401">)</span><span class="op" id="1494402">+</span><span class="ident" id="1494403">i</span><span class="op" id="1494404">*</span><span class="builtintype" id="1494405">uintptr</span><span class="op" id="1494412">(</span><span class="ident" id="1494413">t</span><span class="op" id="1494414">.</span><span class="ident" id="1494415">valuesize</span><span class="op" id="1494424">)</span><span class="op" id="1494425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1494431">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1494437">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1494449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1494454">k</span>&nbsp;<span class="op" id="1494456">:=</span>&nbsp;<span class="ident" id="1494459">add</span><span class="op" id="1494462">(</span><span class="ident" id="1494463">unsafe</span><span class="op" id="1494469">.</span><span class="ident" id="1494470">Pointer</span><span class="op" id="1494477">(</span><span class="ident" id="1494478">b</span><span class="op" id="1494479">)</span><span class="op" id="1494480">,</span>&nbsp;<span class="ident" id="1494482">dataOffset</span><span class="op" id="1494492">+</span><span class="ident" id="1494493">i</span><span class="op" id="1494494">*</span><span class="builtintype" id="1494495">uintptr</span><span class="op" id="1494502">(</span><span class="ident" id="1494503">t</span><span class="op" id="1494504">.</span><span class="ident" id="1494505">keysize</span><span class="op" id="1494512">)</span><span class="op" id="1494513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1494518">k2</span>&nbsp;<span class="op" id="1494521">:=</span>&nbsp;<span class="ident" id="1494524">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1494529">if</span>&nbsp;<span class="ident" id="1494532">t</span><span class="op" id="1494533">.</span><span class="ident" id="1494534">indirectkey</span>&nbsp;<span class="op" id="1494546">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1494552">k2</span>&nbsp;<span class="op" id="1494555">=</span>&nbsp;<span class="op" id="1494557">*</span><span class="op" id="1494558">(</span><span class="op" id="1494559">(</span><span class="op" id="1494560">*</span><span class="ident" id="1494561">unsafe</span><span class="op" id="1494567">.</span><span class="ident" id="1494568">Pointer</span><span class="op" id="1494575">)</span><span class="op" id="1494576">(</span><span class="ident" id="1494577">k2</span><span class="op" id="1494579">)</span><span class="op" id="1494580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1494585">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1494590">if</span>&nbsp;<span class="op" id="1494593">!</span><span class="ident" id="1494594">alg</span><span class="op" id="1494597">.</span><span class="ident" id="1494598">equal</span><span class="op" id="1494603">(</span><span class="ident" id="1494604">key</span><span class="op" id="1494607">,</span>&nbsp;<span class="ident" id="1494609">k2</span><span class="op" id="1494611">,</span>&nbsp;<span class="builtintype" id="1494613">uintptr</span><span class="op" id="1494620">(</span><span class="ident" id="1494621">t</span><span class="op" id="1494622">.</span><span class="ident" id="1494623">key</span><span class="op" id="1494626">.</span><span class="ident" id="1494627">size</span><span class="op" id="1494631">)</span><span class="op" id="1494632">)</span>&nbsp;<span class="op" id="1494634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1494640">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1494652">}</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1494657">//&nbsp;already&nbsp;have&nbsp;a&nbsp;mapping&nbsp;for&nbsp;key.&nbsp;&nbsp;Update&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1494707">memmove</span><span class="op" id="1494714">(</span><span class="ident" id="1494715">k2</span><span class="op" id="1494717">,</span>&nbsp;<span class="ident" id="1494719">key</span><span class="op" id="1494722">,</span>&nbsp;<span class="builtintype" id="1494724">uintptr</span><span class="op" id="1494731">(</span><span class="ident" id="1494732">t</span><span class="op" id="1494733">.</span><span class="ident" id="1494734">key</span><span class="op" id="1494737">.</span><span class="ident" id="1494738">size</span><span class="op" id="1494742">)</span><span class="op" id="1494743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1494748">v</span>&nbsp;<span class="op" id="1494750">:=</span>&nbsp;<span class="ident" id="1494753">add</span><span class="op" id="1494756">(</span><span class="ident" id="1494757">unsafe</span><span class="op" id="1494763">.</span><span class="ident" id="1494764">Pointer</span><span class="op" id="1494771">(</span><span class="ident" id="1494772">b</span><span class="op" id="1494773">)</span><span class="op" id="1494774">,</span>&nbsp;<span class="ident" id="1494776">dataOffset</span><span class="op" id="1494786">+</span><span class="ident" id="1494787">bucketCnt</span><span class="op" id="1494796">*</span><span class="builtintype" id="1494797">uintptr</span><span class="op" id="1494804">(</span><span class="ident" id="1494805">t</span><span class="op" id="1494806">.</span><span class="ident" id="1494807">keysize</span><span class="op" id="1494814">)</span><span class="op" id="1494815">+</span><span class="ident" id="1494816">i</span><span class="op" id="1494817">*</span><span class="builtintype" id="1494818">uintptr</span><span class="op" id="1494825">(</span><span class="ident" id="1494826">t</span><span class="op" id="1494827">.</span><span class="ident" id="1494828">valuesize</span><span class="op" id="1494837">)</span><span class="op" id="1494838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1494843">v2</span>&nbsp;<span class="op" id="1494846">:=</span>&nbsp;<span class="ident" id="1494849">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1494854">if</span>&nbsp;<span class="ident" id="1494857">t</span><span class="op" id="1494858">.</span><span class="ident" id="1494859">indirectvalue</span>&nbsp;<span class="op" id="1494873">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1494879">v2</span>&nbsp;<span class="op" id="1494882">=</span>&nbsp;<span class="op" id="1494884">*</span><span class="op" id="1494885">(</span><span class="op" id="1494886">(</span><span class="op" id="1494887">*</span><span class="ident" id="1494888">unsafe</span><span class="op" id="1494894">.</span><span class="ident" id="1494895">Pointer</span><span class="op" id="1494902">)</span><span class="op" id="1494903">(</span><span class="ident" id="1494904">v2</span><span class="op" id="1494906">)</span><span class="op" id="1494907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1494912">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1494917">memmove</span><span class="op" id="1494924">(</span><span class="ident" id="1494925">v2</span><span class="op" id="1494927">,</span>&nbsp;<span class="ident" id="1494929">val</span><span class="op" id="1494932">,</span>&nbsp;<span class="builtintype" id="1494934">uintptr</span><span class="op" id="1494941">(</span><span class="ident" id="1494942">t</span><span class="op" id="1494943">.</span><span class="ident" id="1494944">elem</span><span class="op" id="1494948">.</span><span class="ident" id="1494949">size</span><span class="op" id="1494953">)</span><span class="op" id="1494954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1494959">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1494968">}</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1494972">if</span>&nbsp;<span class="ident" id="1494975">b</span><span class="op" id="1494976">.</span><span class="ident" id="1494977">overflow</span>&nbsp;<span class="op" id="1494986">==</span>&nbsp;<span class="ident" id="1494989">nil</span>&nbsp;<span class="op" id="1494993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1494998">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1495006">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1495010">b</span>&nbsp;<span class="op" id="1495012">=</span>&nbsp;<span class="ident" id="1495014">b</span><span class="op" id="1495015">.</span><span class="ident" id="1495016">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1495026">}</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1495030">//&nbsp;did&nbsp;not&nbsp;find&nbsp;mapping&nbsp;for&nbsp;key.&nbsp;&nbsp;Allocate&nbsp;new&nbsp;cell&nbsp;&amp;&nbsp;add&nbsp;entry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1495096">if</span>&nbsp;<span class="builtintype" id="1495099">float32</span><span class="op" id="1495106">(</span><span class="ident" id="1495107">h</span><span class="op" id="1495108">.</span><span class="ident" id="1495109">count</span><span class="op" id="1495114">)</span>&nbsp;<span class="op" id="1495116">&gt;=</span>&nbsp;<span class="ident" id="1495119">loadFactor</span><span class="op" id="1495129">*</span><span class="builtintype" id="1495130">float32</span><span class="op" id="1495137">(</span><span class="op" id="1495138">(</span><span class="builtintype" id="1495139">uintptr</span><span class="op" id="1495146">(</span><span class="num" id="1495147">1</span><span class="op" id="1495148">)</span><span class="op" id="1495149">&lt;&lt;</span><span class="ident" id="1495151">h</span><span class="op" id="1495152">.</span><span class="ident" id="1495153">B</span><span class="op" id="1495154">)</span><span class="op" id="1495155">)</span>&nbsp;<span class="op" id="1495157">&amp;&amp;</span>&nbsp;<span class="ident" id="1495160">h</span><span class="op" id="1495161">.</span><span class="ident" id="1495162">count</span>&nbsp;<span class="op" id="1495168">&gt;=</span>&nbsp;<span class="ident" id="1495171">bucketCnt</span>&nbsp;<span class="op" id="1495181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1495185">hashGrow</span><span class="op" id="1495193">(</span><span class="ident" id="1495194">t</span><span class="op" id="1495195">,</span>&nbsp;<span class="ident" id="1495197">h</span><span class="op" id="1495198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1495202">goto</span>&nbsp;<span class="ident" id="1495207">again</span>&nbsp;<span class="comment" id="1495213">//&nbsp;Growing&nbsp;the&nbsp;table&nbsp;invalidates&nbsp;everything,&nbsp;so&nbsp;try&nbsp;again</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1495272">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1495276">if</span>&nbsp;<span class="ident" id="1495279">inserti</span>&nbsp;<span class="op" id="1495287">==</span>&nbsp;<span class="ident" id="1495290">nil</span>&nbsp;<span class="op" id="1495294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1495298">//&nbsp;all&nbsp;current&nbsp;buckets&nbsp;are&nbsp;full,&nbsp;allocate&nbsp;a&nbsp;new&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1495353">if</span>&nbsp;<span class="ident" id="1495356">checkgc</span>&nbsp;<span class="op" id="1495364">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1495369">memstats</span><span class="op" id="1495377">.</span><span class="ident" id="1495378">next_gc</span>&nbsp;<span class="op" id="1495386">=</span>&nbsp;<span class="ident" id="1495388">memstats</span><span class="op" id="1495396">.</span><span class="ident" id="1495397">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1495410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1495414">newb</span>&nbsp;<span class="op" id="1495419">:=</span>&nbsp;<span class="op" id="1495422">(</span><span class="op" id="1495423">*</span><span class="ident" id="1495424">bmap</span><span class="op" id="1495428">)</span><span class="op" id="1495429">(</span><span class="ident" id="1495430">newobject</span><span class="op" id="1495439">(</span><span class="ident" id="1495440">t</span><span class="op" id="1495441">.</span><span class="ident" id="1495442">bucket</span><span class="op" id="1495448">)</span><span class="op" id="1495449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1495453">b</span><span class="op" id="1495454">.</span><span class="ident" id="1495455">overflow</span>&nbsp;<span class="op" id="1495464">=</span>&nbsp;<span class="ident" id="1495466">newb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1495473">inserti</span>&nbsp;<span class="op" id="1495481">=</span>&nbsp;<span class="op" id="1495483">&amp;</span><span class="ident" id="1495484">newb</span><span class="op" id="1495488">.</span><span class="ident" id="1495489">tophash</span><span class="op" id="1495496">[</span><span class="num" id="1495497">0</span><span class="op" id="1495498">]</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1495502">insertk</span>&nbsp;<span class="op" id="1495510">=</span>&nbsp;<span class="ident" id="1495512">add</span><span class="op" id="1495515">(</span><span class="ident" id="1495516">unsafe</span><span class="op" id="1495522">.</span><span class="ident" id="1495523">Pointer</span><span class="op" id="1495530">(</span><span class="ident" id="1495531">newb</span><span class="op" id="1495535">)</span><span class="op" id="1495536">,</span>&nbsp;<span class="ident" id="1495538">dataOffset</span><span class="op" id="1495548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1495552">insertv</span>&nbsp;<span class="op" id="1495560">=</span>&nbsp;<span class="ident" id="1495562">add</span><span class="op" id="1495565">(</span><span class="ident" id="1495566">insertk</span><span class="op" id="1495573">,</span>&nbsp;<span class="ident" id="1495575">bucketCnt</span><span class="op" id="1495584">*</span><span class="builtintype" id="1495585">uintptr</span><span class="op" id="1495592">(</span><span class="ident" id="1495593">t</span><span class="op" id="1495594">.</span><span class="ident" id="1495595">keysize</span><span class="op" id="1495602">)</span><span class="op" id="1495603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1495606">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1495610">//&nbsp;store&nbsp;new&nbsp;key/value&nbsp;at&nbsp;insert&nbsp;position</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1495653">if</span>&nbsp;<span class="ident" id="1495656">t</span><span class="op" id="1495657">.</span><span class="ident" id="1495658">indirectkey</span>&nbsp;<span class="op" id="1495670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1495674">if</span>&nbsp;<span class="ident" id="1495677">checkgc</span>&nbsp;<span class="op" id="1495685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1495690">memstats</span><span class="op" id="1495698">.</span><span class="ident" id="1495699">next_gc</span>&nbsp;<span class="op" id="1495707">=</span>&nbsp;<span class="ident" id="1495709">memstats</span><span class="op" id="1495717">.</span><span class="ident" id="1495718">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1495731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1495735">kmem</span>&nbsp;<span class="op" id="1495740">:=</span>&nbsp;<span class="ident" id="1495743">newobject</span><span class="op" id="1495752">(</span><span class="ident" id="1495753">t</span><span class="op" id="1495754">.</span><span class="ident" id="1495755">key</span><span class="op" id="1495758">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1495762">*</span><span class="op" id="1495763">(</span><span class="op" id="1495764">*</span><span class="ident" id="1495765">unsafe</span><span class="op" id="1495771">.</span><span class="ident" id="1495772">Pointer</span><span class="op" id="1495779">)</span><span class="op" id="1495780">(</span><span class="ident" id="1495781">insertk</span><span class="op" id="1495788">)</span>&nbsp;<span class="op" id="1495790">=</span>&nbsp;<span class="ident" id="1495792">kmem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1495799">insertk</span>&nbsp;<span class="op" id="1495807">=</span>&nbsp;<span class="ident" id="1495809">kmem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1495815">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1495818">if</span>&nbsp;<span class="ident" id="1495821">t</span><span class="op" id="1495822">.</span><span class="ident" id="1495823">indirectvalue</span>&nbsp;<span class="op" id="1495837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1495841">if</span>&nbsp;<span class="ident" id="1495844">checkgc</span>&nbsp;<span class="op" id="1495852">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1495857">memstats</span><span class="op" id="1495865">.</span><span class="ident" id="1495866">next_gc</span>&nbsp;<span class="op" id="1495874">=</span>&nbsp;<span class="ident" id="1495876">memstats</span><span class="op" id="1495884">.</span><span class="ident" id="1495885">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1495898">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1495902">vmem</span>&nbsp;<span class="op" id="1495907">:=</span>&nbsp;<span class="ident" id="1495910">newobject</span><span class="op" id="1495919">(</span><span class="ident" id="1495920">t</span><span class="op" id="1495921">.</span><span class="ident" id="1495922">elem</span><span class="op" id="1495926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1495930">*</span><span class="op" id="1495931">(</span><span class="op" id="1495932">*</span><span class="ident" id="1495933">unsafe</span><span class="op" id="1495939">.</span><span class="ident" id="1495940">Pointer</span><span class="op" id="1495947">)</span><span class="op" id="1495948">(</span><span class="ident" id="1495949">insertv</span><span class="op" id="1495956">)</span>&nbsp;<span class="op" id="1495958">=</span>&nbsp;<span class="ident" id="1495960">vmem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1495967">insertv</span>&nbsp;<span class="op" id="1495975">=</span>&nbsp;<span class="ident" id="1495977">vmem</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1495983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1495986">memmove</span><span class="op" id="1495993">(</span><span class="ident" id="1495994">insertk</span><span class="op" id="1496001">,</span>&nbsp;<span class="ident" id="1496003">key</span><span class="op" id="1496006">,</span>&nbsp;<span class="builtintype" id="1496008">uintptr</span><span class="op" id="1496015">(</span><span class="ident" id="1496016">t</span><span class="op" id="1496017">.</span><span class="ident" id="1496018">key</span><span class="op" id="1496021">.</span><span class="ident" id="1496022">size</span><span class="op" id="1496026">)</span><span class="op" id="1496027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1496030">memmove</span><span class="op" id="1496037">(</span><span class="ident" id="1496038">insertv</span><span class="op" id="1496045">,</span>&nbsp;<span class="ident" id="1496047">val</span><span class="op" id="1496050">,</span>&nbsp;<span class="builtintype" id="1496052">uintptr</span><span class="op" id="1496059">(</span><span class="ident" id="1496060">t</span><span class="op" id="1496061">.</span><span class="ident" id="1496062">elem</span><span class="op" id="1496066">.</span><span class="ident" id="1496067">size</span><span class="op" id="1496071">)</span><span class="op" id="1496072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1496075">*</span><span class="ident" id="1496076">inserti</span>&nbsp;<span class="op" id="1496084">=</span>&nbsp;<span class="ident" id="1496086">top</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1496091">h</span><span class="op" id="1496092">.</span><span class="ident" id="1496093">count</span><span class="op" id="1496098">++</span><br>
<span class="lineno">485</span><span class="op" id="1496101">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1496104">func</span>&nbsp;<span class="ident" id="1496109">mapdelete</span><span class="op" id="1496118">(</span><span class="ident" id="1496119">t</span>&nbsp;<span class="op" id="1496121">*</span><span class="ident" id="1496122">maptype</span><span class="op" id="1496129">,</span>&nbsp;<span class="ident" id="1496131">h</span>&nbsp;<span class="op" id="1496133">*</span><span class="ident" id="1496134">hmap</span><span class="op" id="1496138">,</span>&nbsp;<span class="ident" id="1496140">key</span>&nbsp;<span class="ident" id="1496144">unsafe</span><span class="op" id="1496150">.</span><span class="ident" id="1496151">Pointer</span><span class="op" id="1496158">)</span>&nbsp;<span class="op" id="1496160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1496163">if</span>&nbsp;<span class="ident" id="1496166">raceenabled</span>&nbsp;<span class="op" id="1496178">&amp;&amp;</span>&nbsp;<span class="ident" id="1496181">h</span>&nbsp;<span class="op" id="1496183">!=</span>&nbsp;<span class="ident" id="1496186">nil</span>&nbsp;<span class="op" id="1496190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1496194">callerpc</span>&nbsp;<span class="op" id="1496203">:=</span>&nbsp;<span class="ident" id="1496206">getcallerpc</span><span class="op" id="1496217">(</span><span class="ident" id="1496218">unsafe</span><span class="op" id="1496224">.</span><span class="ident" id="1496225">Pointer</span><span class="op" id="1496232">(</span><span class="op" id="1496233">&amp;</span><span class="ident" id="1496234">t</span><span class="op" id="1496235">)</span><span class="op" id="1496236">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1496240">pc</span>&nbsp;<span class="op" id="1496243">:=</span>&nbsp;<span class="ident" id="1496246">funcPC</span><span class="op" id="1496252">(</span><span class="ident" id="1496253">mapdelete</span><span class="op" id="1496262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1496266">racewritepc</span><span class="op" id="1496277">(</span><span class="ident" id="1496278">unsafe</span><span class="op" id="1496284">.</span><span class="ident" id="1496285">Pointer</span><span class="op" id="1496292">(</span><span class="ident" id="1496293">h</span><span class="op" id="1496294">)</span><span class="op" id="1496295">,</span>&nbsp;<span class="ident" id="1496297">callerpc</span><span class="op" id="1496305">,</span>&nbsp;<span class="ident" id="1496307">pc</span><span class="op" id="1496309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1496313">raceReadObjectPC</span><span class="op" id="1496329">(</span><span class="ident" id="1496330">t</span><span class="op" id="1496331">.</span><span class="ident" id="1496332">key</span><span class="op" id="1496335">,</span>&nbsp;<span class="ident" id="1496337">key</span><span class="op" id="1496340">,</span>&nbsp;<span class="ident" id="1496342">callerpc</span><span class="op" id="1496350">,</span>&nbsp;<span class="ident" id="1496352">pc</span><span class="op" id="1496354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1496357">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1496360">if</span>&nbsp;<span class="ident" id="1496363">h</span>&nbsp;<span class="op" id="1496365">==</span>&nbsp;<span class="ident" id="1496368">nil</span>&nbsp;<span class="op" id="1496372">||</span>&nbsp;<span class="ident" id="1496375">h</span><span class="op" id="1496376">.</span><span class="ident" id="1496377">count</span>&nbsp;<span class="op" id="1496383">==</span>&nbsp;<span class="num" id="1496386">0</span>&nbsp;<span class="op" id="1496388">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1496392">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1496400">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1496403">alg</span>&nbsp;<span class="op" id="1496407">:=</span>&nbsp;<span class="ident" id="1496410">goalg</span><span class="op" id="1496415">(</span><span class="ident" id="1496416">t</span><span class="op" id="1496417">.</span><span class="ident" id="1496418">key</span><span class="op" id="1496421">.</span><span class="ident" id="1496422">alg</span><span class="op" id="1496425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1496428">hash</span>&nbsp;<span class="op" id="1496433">:=</span>&nbsp;<span class="ident" id="1496436">alg</span><span class="op" id="1496439">.</span><span class="ident" id="1496440">hash</span><span class="op" id="1496444">(</span><span class="ident" id="1496445">key</span><span class="op" id="1496448">,</span>&nbsp;<span class="builtintype" id="1496450">uintptr</span><span class="op" id="1496457">(</span><span class="ident" id="1496458">t</span><span class="op" id="1496459">.</span><span class="ident" id="1496460">key</span><span class="op" id="1496463">.</span><span class="ident" id="1496464">size</span><span class="op" id="1496468">)</span><span class="op" id="1496469">,</span>&nbsp;<span class="builtintype" id="1496471">uintptr</span><span class="op" id="1496478">(</span><span class="ident" id="1496479">h</span><span class="op" id="1496480">.</span><span class="ident" id="1496481">hash0</span><span class="op" id="1496486">)</span><span class="op" id="1496487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1496490">bucket</span>&nbsp;<span class="op" id="1496497">:=</span>&nbsp;<span class="ident" id="1496500">hash</span>&nbsp;<span class="op" id="1496505">&amp;</span>&nbsp;<span class="op" id="1496507">(</span><span class="builtintype" id="1496508">uintptr</span><span class="op" id="1496515">(</span><span class="num" id="1496516">1</span><span class="op" id="1496517">)</span><span class="op" id="1496518">&lt;&lt;</span><span class="ident" id="1496520">h</span><span class="op" id="1496521">.</span><span class="ident" id="1496522">B</span>&nbsp;<span class="op" id="1496524">-</span>&nbsp;<span class="num" id="1496526">1</span><span class="op" id="1496527">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1496530">if</span>&nbsp;<span class="ident" id="1496533">h</span><span class="op" id="1496534">.</span><span class="ident" id="1496535">oldbuckets</span>&nbsp;<span class="op" id="1496546">!=</span>&nbsp;<span class="ident" id="1496549">nil</span>&nbsp;<span class="op" id="1496553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1496557">growWork</span><span class="op" id="1496565">(</span><span class="ident" id="1496566">t</span><span class="op" id="1496567">,</span>&nbsp;<span class="ident" id="1496569">h</span><span class="op" id="1496570">,</span>&nbsp;<span class="ident" id="1496572">bucket</span><span class="op" id="1496578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1496581">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1496584">b</span>&nbsp;<span class="op" id="1496586">:=</span>&nbsp;<span class="op" id="1496589">(</span><span class="op" id="1496590">*</span><span class="ident" id="1496591">bmap</span><span class="op" id="1496595">)</span><span class="op" id="1496596">(</span><span class="ident" id="1496597">unsafe</span><span class="op" id="1496603">.</span><span class="ident" id="1496604">Pointer</span><span class="op" id="1496611">(</span><span class="builtintype" id="1496612">uintptr</span><span class="op" id="1496619">(</span><span class="ident" id="1496620">h</span><span class="op" id="1496621">.</span><span class="ident" id="1496622">buckets</span><span class="op" id="1496629">)</span>&nbsp;<span class="op" id="1496631">+</span>&nbsp;<span class="ident" id="1496633">bucket</span><span class="op" id="1496639">*</span><span class="builtintype" id="1496640">uintptr</span><span class="op" id="1496647">(</span><span class="ident" id="1496648">t</span><span class="op" id="1496649">.</span><span class="ident" id="1496650">bucketsize</span><span class="op" id="1496660">)</span><span class="op" id="1496661">)</span><span class="op" id="1496662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1496665">top</span>&nbsp;<span class="op" id="1496669">:=</span>&nbsp;<span class="builtintype" id="1496672">uint8</span><span class="op" id="1496677">(</span><span class="ident" id="1496678">hash</span>&nbsp;<span class="op" id="1496683">&gt;&gt;</span>&nbsp;<span class="op" id="1496686">(</span><span class="ident" id="1496687">ptrSize</span><span class="op" id="1496694">*</span><span class="num" id="1496695">8</span>&nbsp;<span class="op" id="1496697">-</span>&nbsp;<span class="num" id="1496699">8</span><span class="op" id="1496700">)</span><span class="op" id="1496701">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1496704">if</span>&nbsp;<span class="ident" id="1496707">top</span>&nbsp;<span class="op" id="1496711">&lt;</span>&nbsp;<span class="ident" id="1496713">minTopHash</span>&nbsp;<span class="op" id="1496724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1496728">top</span>&nbsp;<span class="op" id="1496732">+=</span>&nbsp;<span class="ident" id="1496735">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1496747">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1496750">for</span>&nbsp;<span class="op" id="1496754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1496758">for</span>&nbsp;<span class="ident" id="1496762">i</span>&nbsp;<span class="op" id="1496764">:=</span>&nbsp;<span class="builtintype" id="1496767">uintptr</span><span class="op" id="1496774">(</span><span class="num" id="1496775">0</span><span class="op" id="1496776">)</span><span class="op" id="1496777">;</span>&nbsp;<span class="ident" id="1496779">i</span>&nbsp;<span class="op" id="1496781">&lt;</span>&nbsp;<span class="ident" id="1496783">bucketCnt</span><span class="op" id="1496792">;</span>&nbsp;<span class="ident" id="1496794">i</span><span class="op" id="1496795">++</span>&nbsp;<span class="op" id="1496798">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1496803">if</span>&nbsp;<span class="ident" id="1496806">b</span><span class="op" id="1496807">.</span><span class="ident" id="1496808">tophash</span><span class="op" id="1496815">[</span><span class="ident" id="1496816">i</span><span class="op" id="1496817">]</span>&nbsp;<span class="op" id="1496819">!=</span>&nbsp;<span class="ident" id="1496822">top</span>&nbsp;<span class="op" id="1496826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1496832">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1496844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1496849">k</span>&nbsp;<span class="op" id="1496851">:=</span>&nbsp;<span class="ident" id="1496854">add</span><span class="op" id="1496857">(</span><span class="ident" id="1496858">unsafe</span><span class="op" id="1496864">.</span><span class="ident" id="1496865">Pointer</span><span class="op" id="1496872">(</span><span class="ident" id="1496873">b</span><span class="op" id="1496874">)</span><span class="op" id="1496875">,</span>&nbsp;<span class="ident" id="1496877">dataOffset</span><span class="op" id="1496887">+</span><span class="ident" id="1496888">i</span><span class="op" id="1496889">*</span><span class="builtintype" id="1496890">uintptr</span><span class="op" id="1496897">(</span><span class="ident" id="1496898">t</span><span class="op" id="1496899">.</span><span class="ident" id="1496900">keysize</span><span class="op" id="1496907">)</span><span class="op" id="1496908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1496913">k2</span>&nbsp;<span class="op" id="1496916">:=</span>&nbsp;<span class="ident" id="1496919">k</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1496924">if</span>&nbsp;<span class="ident" id="1496927">t</span><span class="op" id="1496928">.</span><span class="ident" id="1496929">indirectkey</span>&nbsp;<span class="op" id="1496941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1496947">k2</span>&nbsp;<span class="op" id="1496950">=</span>&nbsp;<span class="op" id="1496952">*</span><span class="op" id="1496953">(</span><span class="op" id="1496954">(</span><span class="op" id="1496955">*</span><span class="ident" id="1496956">unsafe</span><span class="op" id="1496962">.</span><span class="ident" id="1496963">Pointer</span><span class="op" id="1496970">)</span><span class="op" id="1496971">(</span><span class="ident" id="1496972">k2</span><span class="op" id="1496974">)</span><span class="op" id="1496975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1496980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1496985">if</span>&nbsp;<span class="op" id="1496988">!</span><span class="ident" id="1496989">alg</span><span class="op" id="1496992">.</span><span class="ident" id="1496993">equal</span><span class="op" id="1496998">(</span><span class="ident" id="1496999">key</span><span class="op" id="1497002">,</span>&nbsp;<span class="ident" id="1497004">k2</span><span class="op" id="1497006">,</span>&nbsp;<span class="builtintype" id="1497008">uintptr</span><span class="op" id="1497015">(</span><span class="ident" id="1497016">t</span><span class="op" id="1497017">.</span><span class="ident" id="1497018">key</span><span class="op" id="1497021">.</span><span class="ident" id="1497022">size</span><span class="op" id="1497026">)</span><span class="op" id="1497027">)</span>&nbsp;<span class="op" id="1497029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1497035">continue</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1497047">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497052">memclr</span><span class="op" id="1497058">(</span><span class="ident" id="1497059">k</span><span class="op" id="1497060">,</span>&nbsp;<span class="builtintype" id="1497062">uintptr</span><span class="op" id="1497069">(</span><span class="ident" id="1497070">t</span><span class="op" id="1497071">.</span><span class="ident" id="1497072">keysize</span><span class="op" id="1497079">)</span><span class="op" id="1497080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497085">v</span>&nbsp;<span class="op" id="1497087">:=</span>&nbsp;<span class="ident" id="1497090">unsafe</span><span class="op" id="1497096">.</span><span class="ident" id="1497097">Pointer</span><span class="op" id="1497104">(</span><span class="builtintype" id="1497105">uintptr</span><span class="op" id="1497112">(</span><span class="ident" id="1497113">unsafe</span><span class="op" id="1497119">.</span><span class="ident" id="1497120">Pointer</span><span class="op" id="1497127">(</span><span class="ident" id="1497128">b</span><span class="op" id="1497129">)</span><span class="op" id="1497130">)</span>&nbsp;<span class="op" id="1497132">+</span>&nbsp;<span class="ident" id="1497134">dataOffset</span>&nbsp;<span class="op" id="1497145">+</span>&nbsp;<span class="ident" id="1497147">bucketCnt</span><span class="op" id="1497156">*</span><span class="builtintype" id="1497157">uintptr</span><span class="op" id="1497164">(</span><span class="ident" id="1497165">t</span><span class="op" id="1497166">.</span><span class="ident" id="1497167">keysize</span><span class="op" id="1497174">)</span>&nbsp;<span class="op" id="1497176">+</span>&nbsp;<span class="ident" id="1497178">i</span><span class="op" id="1497179">*</span><span class="builtintype" id="1497180">uintptr</span><span class="op" id="1497187">(</span><span class="ident" id="1497188">t</span><span class="op" id="1497189">.</span><span class="ident" id="1497190">valuesize</span><span class="op" id="1497199">)</span><span class="op" id="1497200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497205">memclr</span><span class="op" id="1497211">(</span><span class="ident" id="1497212">v</span><span class="op" id="1497213">,</span>&nbsp;<span class="builtintype" id="1497215">uintptr</span><span class="op" id="1497222">(</span><span class="ident" id="1497223">t</span><span class="op" id="1497224">.</span><span class="ident" id="1497225">valuesize</span><span class="op" id="1497234">)</span><span class="op" id="1497235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497240">b</span><span class="op" id="1497241">.</span><span class="ident" id="1497242">tophash</span><span class="op" id="1497249">[</span><span class="ident" id="1497250">i</span><span class="op" id="1497251">]</span>&nbsp;<span class="op" id="1497253">=</span>&nbsp;<span class="ident" id="1497255">empty</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497264">h</span><span class="op" id="1497265">.</span><span class="ident" id="1497266">count</span><span class="op" id="1497271">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1497277">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1497286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497290">b</span>&nbsp;<span class="op" id="1497292">=</span>&nbsp;<span class="ident" id="1497294">b</span><span class="op" id="1497295">.</span><span class="ident" id="1497296">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1497307">if</span>&nbsp;<span class="ident" id="1497310">b</span>&nbsp;<span class="op" id="1497312">==</span>&nbsp;<span class="ident" id="1497315">nil</span>&nbsp;<span class="op" id="1497319">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1497324">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1497333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1497336">}</span><br>
<span class="lineno"></span><span class="op" id="1497338">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="1497341">func</span>&nbsp;<span class="ident" id="1497346">mapiterinit</span><span class="op" id="1497357">(</span><span class="ident" id="1497358">t</span>&nbsp;<span class="op" id="1497360">*</span><span class="ident" id="1497361">maptype</span><span class="op" id="1497368">,</span>&nbsp;<span class="ident" id="1497370">h</span>&nbsp;<span class="op" id="1497372">*</span><span class="ident" id="1497373">hmap</span><span class="op" id="1497377">,</span>&nbsp;<span class="ident" id="1497379">it</span>&nbsp;<span class="op" id="1497382">*</span><span class="ident" id="1497383">hiter</span><span class="op" id="1497388">)</span>&nbsp;<span class="op" id="1497390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1497393">//&nbsp;Clear&nbsp;pointer&nbsp;fields&nbsp;so&nbsp;garbage&nbsp;collector&nbsp;does&nbsp;not&nbsp;complain.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497458">it</span><span class="op" id="1497460">.</span><span class="ident" id="1497461">key</span>&nbsp;<span class="op" id="1497465">=</span>&nbsp;<span class="ident" id="1497467">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497472">it</span><span class="op" id="1497474">.</span><span class="ident" id="1497475">value</span>&nbsp;<span class="op" id="1497481">=</span>&nbsp;<span class="ident" id="1497483">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497488">it</span><span class="op" id="1497490">.</span><span class="ident" id="1497491">t</span>&nbsp;<span class="op" id="1497493">=</span>&nbsp;<span class="ident" id="1497495">nil</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497500">it</span><span class="op" id="1497502">.</span><span class="ident" id="1497503">h</span>&nbsp;<span class="op" id="1497505">=</span>&nbsp;<span class="ident" id="1497507">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497512">it</span><span class="op" id="1497514">.</span><span class="ident" id="1497515">buckets</span>&nbsp;<span class="op" id="1497523">=</span>&nbsp;<span class="ident" id="1497525">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497530">it</span><span class="op" id="1497532">.</span><span class="ident" id="1497533">bptr</span>&nbsp;<span class="op" id="1497538">=</span>&nbsp;<span class="ident" id="1497540">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1497546">if</span>&nbsp;<span class="ident" id="1497549">raceenabled</span>&nbsp;<span class="op" id="1497561">&amp;&amp;</span>&nbsp;<span class="ident" id="1497564">h</span>&nbsp;<span class="op" id="1497566">!=</span>&nbsp;<span class="ident" id="1497569">nil</span>&nbsp;<span class="op" id="1497573">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497577">callerpc</span>&nbsp;<span class="op" id="1497586">:=</span>&nbsp;<span class="ident" id="1497589">getcallerpc</span><span class="op" id="1497600">(</span><span class="ident" id="1497601">unsafe</span><span class="op" id="1497607">.</span><span class="ident" id="1497608">Pointer</span><span class="op" id="1497615">(</span><span class="op" id="1497616">&amp;</span><span class="ident" id="1497617">t</span><span class="op" id="1497618">)</span><span class="op" id="1497619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497623">racereadpc</span><span class="op" id="1497633">(</span><span class="ident" id="1497634">unsafe</span><span class="op" id="1497640">.</span><span class="ident" id="1497641">Pointer</span><span class="op" id="1497648">(</span><span class="ident" id="1497649">h</span><span class="op" id="1497650">)</span><span class="op" id="1497651">,</span>&nbsp;<span class="ident" id="1497653">callerpc</span><span class="op" id="1497661">,</span>&nbsp;<span class="ident" id="1497663">funcPC</span><span class="op" id="1497669">(</span><span class="ident" id="1497670">mapiterinit</span><span class="op" id="1497681">)</span><span class="op" id="1497682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1497685">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1497689">if</span>&nbsp;<span class="ident" id="1497692">h</span>&nbsp;<span class="op" id="1497694">==</span>&nbsp;<span class="ident" id="1497697">nil</span>&nbsp;<span class="op" id="1497701">||</span>&nbsp;<span class="ident" id="1497704">h</span><span class="op" id="1497705">.</span><span class="ident" id="1497706">count</span>&nbsp;<span class="op" id="1497712">==</span>&nbsp;<span class="num" id="1497715">0</span>&nbsp;<span class="op" id="1497717">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497721">it</span><span class="op" id="1497723">.</span><span class="ident" id="1497724">key</span>&nbsp;<span class="op" id="1497728">=</span>&nbsp;<span class="ident" id="1497730">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497736">it</span><span class="op" id="1497738">.</span><span class="ident" id="1497739">value</span>&nbsp;<span class="op" id="1497745">=</span>&nbsp;<span class="ident" id="1497747">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1497753">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1497761">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1497765">if</span>&nbsp;<span class="ident" id="1497768">unsafe</span><span class="op" id="1497774">.</span><span class="ident" id="1497775">Sizeof</span><span class="op" id="1497781">(</span><span class="ident" id="1497782">hiter</span><span class="op" id="1497787">{</span><span class="op" id="1497788">}</span><span class="op" id="1497789">)</span><span class="op" id="1497790">/</span><span class="ident" id="1497791">ptrSize</span>&nbsp;<span class="op" id="1497799">!=</span>&nbsp;<span class="num" id="1497802">10</span>&nbsp;<span class="op" id="1497805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497809">gothrow</span><span class="op" id="1497816">(</span><span class="string" id="1497817">&#34;hash_iter&nbsp;size&nbsp;incorrect&#34;</span><span class="op" id="1497843">)</span>&nbsp;<span class="comment" id="1497845">//&nbsp;see&nbsp;../../cmd/gc/reflect.c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1497876">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497879">it</span><span class="op" id="1497881">.</span><span class="ident" id="1497882">t</span>&nbsp;<span class="op" id="1497884">=</span>&nbsp;<span class="ident" id="1497886">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497889">it</span><span class="op" id="1497891">.</span><span class="ident" id="1497892">h</span>&nbsp;<span class="op" id="1497894">=</span>&nbsp;<span class="ident" id="1497896">h</span><br>
<span class="lineno">560</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1497900">//&nbsp;grab&nbsp;snapshot&nbsp;of&nbsp;bucket&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497934">it</span><span class="op" id="1497936">.</span><span class="ident" id="1497937">B</span>&nbsp;<span class="op" id="1497939">=</span>&nbsp;<span class="ident" id="1497941">h</span><span class="op" id="1497942">.</span><span class="ident" id="1497943">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497946">it</span><span class="op" id="1497948">.</span><span class="ident" id="1497949">buckets</span>&nbsp;<span class="op" id="1497957">=</span>&nbsp;<span class="ident" id="1497959">h</span><span class="op" id="1497960">.</span><span class="ident" id="1497961">buckets</span><br>
<span class="lineno"></span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1497971">//&nbsp;decide&nbsp;where&nbsp;to&nbsp;start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497997">r</span>&nbsp;<span class="op" id="1497999">:=</span>&nbsp;<span class="builtintype" id="1498002">uintptr</span><span class="op" id="1498009">(</span><span class="ident" id="1498010">fastrand1</span><span class="op" id="1498019">(</span><span class="op" id="1498020">)</span><span class="op" id="1498021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1498024">if</span>&nbsp;<span class="ident" id="1498027">h</span><span class="op" id="1498028">.</span><span class="ident" id="1498029">B</span>&nbsp;<span class="op" id="1498031">&gt;</span>&nbsp;<span class="num" id="1498033">31</span><span class="op" id="1498035">-</span><span class="ident" id="1498036">bucketCntBits</span>&nbsp;<span class="op" id="1498050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1498054">r</span>&nbsp;<span class="op" id="1498056">+=</span>&nbsp;<span class="builtintype" id="1498059">uintptr</span><span class="op" id="1498066">(</span><span class="ident" id="1498067">fastrand1</span><span class="op" id="1498076">(</span><span class="op" id="1498077">)</span><span class="op" id="1498078">)</span>&nbsp;<span class="op" id="1498080">&lt;&lt;</span>&nbsp;<span class="num" id="1498083">31</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1498087">}</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1498090">it</span><span class="op" id="1498092">.</span><span class="ident" id="1498093">startBucket</span>&nbsp;<span class="op" id="1498105">=</span>&nbsp;<span class="ident" id="1498107">r</span>&nbsp;<span class="op" id="1498109">&amp;</span>&nbsp;<span class="op" id="1498111">(</span><span class="builtintype" id="1498112">uintptr</span><span class="op" id="1498119">(</span><span class="num" id="1498120">1</span><span class="op" id="1498121">)</span><span class="op" id="1498122">&lt;&lt;</span><span class="ident" id="1498124">h</span><span class="op" id="1498125">.</span><span class="ident" id="1498126">B</span>&nbsp;<span class="op" id="1498128">-</span>&nbsp;<span class="num" id="1498130">1</span><span class="op" id="1498131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1498134">it</span><span class="op" id="1498136">.</span><span class="ident" id="1498137">offset</span>&nbsp;<span class="op" id="1498144">=</span>&nbsp;<span class="builtintype" id="1498146">uint8</span><span class="op" id="1498151">(</span><span class="ident" id="1498152">r</span>&nbsp;<span class="op" id="1498154">&gt;&gt;</span>&nbsp;<span class="ident" id="1498157">h</span><span class="op" id="1498158">.</span><span class="ident" id="1498159">B</span>&nbsp;<span class="op" id="1498161">&amp;</span>&nbsp;<span class="op" id="1498163">(</span><span class="ident" id="1498164">bucketCnt</span>&nbsp;<span class="op" id="1498174">-</span>&nbsp;<span class="num" id="1498176">1</span><span class="op" id="1498177">)</span><span class="op" id="1498178">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1498182">//&nbsp;iterator&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1498201">it</span><span class="op" id="1498203">.</span><span class="ident" id="1498204">bucket</span>&nbsp;<span class="op" id="1498211">=</span>&nbsp;<span class="ident" id="1498213">it</span><span class="op" id="1498215">.</span><span class="ident" id="1498216">startBucket</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1498229">it</span><span class="op" id="1498231">.</span><span class="ident" id="1498232">wrapped</span>&nbsp;<span class="op" id="1498240">=</span>&nbsp;<span class="builtintype" id="1498242">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1498249">it</span><span class="op" id="1498251">.</span><span class="ident" id="1498252">bptr</span>&nbsp;<span class="op" id="1498257">=</span>&nbsp;<span class="ident" id="1498259">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1498265">//&nbsp;Remember&nbsp;we&nbsp;have&nbsp;an&nbsp;iterator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1498299">//&nbsp;Can&nbsp;run&nbsp;concurrently&nbsp;with&nbsp;another&nbsp;hash_iter_init().</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1498355">for</span>&nbsp;<span class="op" id="1498359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1498363">old</span>&nbsp;<span class="op" id="1498367">:=</span>&nbsp;<span class="ident" id="1498370">h</span><span class="op" id="1498371">.</span><span class="ident" id="1498372">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1498380">if</span>&nbsp;<span class="ident" id="1498383">old</span>&nbsp;<span class="op" id="1498387">==</span>&nbsp;<span class="ident" id="1498390">old</span><span class="op" id="1498393">|</span><span class="ident" id="1498394">iterator</span><span class="op" id="1498402">|</span><span class="ident" id="1498403">oldIterator</span>&nbsp;<span class="op" id="1498415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1498420">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1498428">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1498432">if</span>&nbsp;<span class="ident" id="1498435">cas</span><span class="op" id="1498438">(</span><span class="op" id="1498439">&amp;</span><span class="ident" id="1498440">h</span><span class="op" id="1498441">.</span><span class="ident" id="1498442">flags</span><span class="op" id="1498447">,</span>&nbsp;<span class="ident" id="1498449">old</span><span class="op" id="1498452">,</span>&nbsp;<span class="ident" id="1498454">old</span><span class="op" id="1498457">|</span><span class="ident" id="1498458">iterator</span><span class="op" id="1498466">|</span><span class="ident" id="1498467">oldIterator</span><span class="op" id="1498478">)</span>&nbsp;<span class="op" id="1498480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1498485">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1498493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1498496">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1498500">mapiternext</span><span class="op" id="1498511">(</span><span class="ident" id="1498512">it</span><span class="op" id="1498514">)</span><br>
<span class="lineno"></span><span class="op" id="1498516">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1498519">func</span>&nbsp;<span class="ident" id="1498524">mapiternext</span><span class="op" id="1498535">(</span><span class="ident" id="1498536">it</span>&nbsp;<span class="op" id="1498539">*</span><span class="ident" id="1498540">hiter</span><span class="op" id="1498545">)</span>&nbsp;<span class="op" id="1498547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1498550">h</span>&nbsp;<span class="op" id="1498552">:=</span>&nbsp;<span class="ident" id="1498555">it</span><span class="op" id="1498557">.</span><span class="ident" id="1498558">h</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1498561">if</span>&nbsp;<span class="ident" id="1498564">raceenabled</span>&nbsp;<span class="op" id="1498576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1498580">callerpc</span>&nbsp;<span class="op" id="1498589">:=</span>&nbsp;<span class="ident" id="1498592">getcallerpc</span><span class="op" id="1498603">(</span><span class="ident" id="1498604">unsafe</span><span class="op" id="1498610">.</span><span class="ident" id="1498611">Pointer</span><span class="op" id="1498618">(</span><span class="op" id="1498619">&amp;</span><span class="ident" id="1498620">it</span><span class="op" id="1498622">)</span><span class="op" id="1498623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1498627">racereadpc</span><span class="op" id="1498637">(</span><span class="ident" id="1498638">unsafe</span><span class="op" id="1498644">.</span><span class="ident" id="1498645">Pointer</span><span class="op" id="1498652">(</span><span class="ident" id="1498653">h</span><span class="op" id="1498654">)</span><span class="op" id="1498655">,</span>&nbsp;<span class="ident" id="1498657">callerpc</span><span class="op" id="1498665">,</span>&nbsp;<span class="ident" id="1498667">funcPC</span><span class="op" id="1498673">(</span><span class="ident" id="1498674">mapiternext</span><span class="op" id="1498685">)</span><span class="op" id="1498686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1498689">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1498692">t</span>&nbsp;<span class="op" id="1498694">:=</span>&nbsp;<span class="ident" id="1498697">it</span><span class="op" id="1498699">.</span><span class="ident" id="1498700">t</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1498703">bucket</span>&nbsp;<span class="op" id="1498710">:=</span>&nbsp;<span class="ident" id="1498713">it</span><span class="op" id="1498715">.</span><span class="ident" id="1498716">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1498724">b</span>&nbsp;<span class="op" id="1498726">:=</span>&nbsp;<span class="ident" id="1498729">it</span><span class="op" id="1498731">.</span><span class="ident" id="1498732">bptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1498738">i</span>&nbsp;<span class="op" id="1498740">:=</span>&nbsp;<span class="ident" id="1498743">it</span><span class="op" id="1498745">.</span><span class="ident" id="1498746">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1498749">checkBucket</span>&nbsp;<span class="op" id="1498761">:=</span>&nbsp;<span class="ident" id="1498764">it</span><span class="op" id="1498766">.</span><span class="ident" id="1498767">checkBucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1498780">alg</span>&nbsp;<span class="op" id="1498784">:=</span>&nbsp;<span class="ident" id="1498787">goalg</span><span class="op" id="1498792">(</span><span class="ident" id="1498793">t</span><span class="op" id="1498794">.</span><span class="ident" id="1498795">key</span><span class="op" id="1498798">.</span><span class="ident" id="1498799">alg</span><span class="op" id="1498802">)</span><br>
<span class="lineno">605</span><br>
<span class="lineno"></span><span class="ident" id="1498805">next</span><span class="op" id="1498809">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1498812">if</span>&nbsp;<span class="ident" id="1498815">b</span>&nbsp;<span class="op" id="1498817">==</span>&nbsp;<span class="ident" id="1498820">nil</span>&nbsp;<span class="op" id="1498824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1498828">if</span>&nbsp;<span class="ident" id="1498831">bucket</span>&nbsp;<span class="op" id="1498838">==</span>&nbsp;<span class="ident" id="1498841">it</span><span class="op" id="1498843">.</span><span class="ident" id="1498844">startBucket</span>&nbsp;<span class="op" id="1498856">&amp;&amp;</span>&nbsp;<span class="ident" id="1498859">it</span><span class="op" id="1498861">.</span><span class="ident" id="1498862">wrapped</span>&nbsp;<span class="op" id="1498870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1498875">//&nbsp;end&nbsp;of&nbsp;iteration</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1498898">it</span><span class="op" id="1498900">.</span><span class="ident" id="1498901">key</span>&nbsp;<span class="op" id="1498905">=</span>&nbsp;<span class="ident" id="1498907">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1498914">it</span><span class="op" id="1498916">.</span><span class="ident" id="1498917">value</span>&nbsp;<span class="op" id="1498923">=</span>&nbsp;<span class="ident" id="1498925">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1498932">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1498941">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1498945">if</span>&nbsp;<span class="ident" id="1498948">h</span><span class="op" id="1498949">.</span><span class="ident" id="1498950">oldbuckets</span>&nbsp;<span class="op" id="1498961">!=</span>&nbsp;<span class="ident" id="1498964">nil</span>&nbsp;<span class="op" id="1498968">&amp;&amp;</span>&nbsp;<span class="ident" id="1498971">it</span><span class="op" id="1498973">.</span><span class="ident" id="1498974">B</span>&nbsp;<span class="op" id="1498976">==</span>&nbsp;<span class="ident" id="1498979">h</span><span class="op" id="1498980">.</span><span class="ident" id="1498981">B</span>&nbsp;<span class="op" id="1498983">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1498988">//&nbsp;Iterator&nbsp;was&nbsp;started&nbsp;in&nbsp;the&nbsp;middle&nbsp;of&nbsp;a&nbsp;grow,&nbsp;and&nbsp;the&nbsp;grow&nbsp;isn&#39;t&nbsp;done&nbsp;yet.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1499069">//&nbsp;If&nbsp;the&nbsp;bucket&nbsp;we&#39;re&nbsp;looking&nbsp;at&nbsp;hasn&#39;t&nbsp;been&nbsp;filled&nbsp;in&nbsp;yet&nbsp;(i.e.&nbsp;the&nbsp;old</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1499146">//&nbsp;bucket&nbsp;hasn&#39;t&nbsp;been&nbsp;evacuated)&nbsp;then&nbsp;we&nbsp;need&nbsp;to&nbsp;iterate&nbsp;through&nbsp;the&nbsp;old</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1499222">//&nbsp;bucket&nbsp;and&nbsp;only&nbsp;return&nbsp;the&nbsp;ones&nbsp;that&nbsp;will&nbsp;be&nbsp;migrated&nbsp;to&nbsp;this&nbsp;bucket.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499298">oldbucket</span>&nbsp;<span class="op" id="1499308">:=</span>&nbsp;<span class="ident" id="1499311">bucket</span>&nbsp;<span class="op" id="1499318">&amp;</span>&nbsp;<span class="op" id="1499320">(</span><span class="builtintype" id="1499321">uintptr</span><span class="op" id="1499328">(</span><span class="num" id="1499329">1</span><span class="op" id="1499330">)</span><span class="op" id="1499331">&lt;&lt;</span><span class="op" id="1499333">(</span><span class="ident" id="1499334">it</span><span class="op" id="1499336">.</span><span class="ident" id="1499337">B</span><span class="op" id="1499338">-</span><span class="num" id="1499339">1</span><span class="op" id="1499340">)</span>&nbsp;<span class="op" id="1499342">-</span>&nbsp;<span class="num" id="1499344">1</span><span class="op" id="1499345">)</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499350">b</span>&nbsp;<span class="op" id="1499352">=</span>&nbsp;<span class="op" id="1499354">(</span><span class="op" id="1499355">*</span><span class="ident" id="1499356">bmap</span><span class="op" id="1499360">)</span><span class="op" id="1499361">(</span><span class="ident" id="1499362">add</span><span class="op" id="1499365">(</span><span class="ident" id="1499366">h</span><span class="op" id="1499367">.</span><span class="ident" id="1499368">oldbuckets</span><span class="op" id="1499378">,</span>&nbsp;<span class="ident" id="1499380">oldbucket</span><span class="op" id="1499389">*</span><span class="builtintype" id="1499390">uintptr</span><span class="op" id="1499397">(</span><span class="ident" id="1499398">t</span><span class="op" id="1499399">.</span><span class="ident" id="1499400">bucketsize</span><span class="op" id="1499410">)</span><span class="op" id="1499411">)</span><span class="op" id="1499412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1499417">if</span>&nbsp;<span class="op" id="1499420">!</span><span class="ident" id="1499421">evacuated</span><span class="op" id="1499430">(</span><span class="ident" id="1499431">b</span><span class="op" id="1499432">)</span>&nbsp;<span class="op" id="1499434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499440">checkBucket</span>&nbsp;<span class="op" id="1499452">=</span>&nbsp;<span class="ident" id="1499454">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1499464">}</span>&nbsp;<span class="keyword" id="1499466">else</span>&nbsp;<span class="op" id="1499471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499477">b</span>&nbsp;<span class="op" id="1499479">=</span>&nbsp;<span class="op" id="1499481">(</span><span class="op" id="1499482">*</span><span class="ident" id="1499483">bmap</span><span class="op" id="1499487">)</span><span class="op" id="1499488">(</span><span class="ident" id="1499489">add</span><span class="op" id="1499492">(</span><span class="ident" id="1499493">it</span><span class="op" id="1499495">.</span><span class="ident" id="1499496">buckets</span><span class="op" id="1499503">,</span>&nbsp;<span class="ident" id="1499505">bucket</span><span class="op" id="1499511">*</span><span class="builtintype" id="1499512">uintptr</span><span class="op" id="1499519">(</span><span class="ident" id="1499520">t</span><span class="op" id="1499521">.</span><span class="ident" id="1499522">bucketsize</span><span class="op" id="1499532">)</span><span class="op" id="1499533">)</span><span class="op" id="1499534">)</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499540">checkBucket</span>&nbsp;<span class="op" id="1499552">=</span>&nbsp;<span class="ident" id="1499554">noCheck</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1499565">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1499569">}</span>&nbsp;<span class="keyword" id="1499571">else</span>&nbsp;<span class="op" id="1499576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499581">b</span>&nbsp;<span class="op" id="1499583">=</span>&nbsp;<span class="op" id="1499585">(</span><span class="op" id="1499586">*</span><span class="ident" id="1499587">bmap</span><span class="op" id="1499591">)</span><span class="op" id="1499592">(</span><span class="ident" id="1499593">add</span><span class="op" id="1499596">(</span><span class="ident" id="1499597">it</span><span class="op" id="1499599">.</span><span class="ident" id="1499600">buckets</span><span class="op" id="1499607">,</span>&nbsp;<span class="ident" id="1499609">bucket</span><span class="op" id="1499615">*</span><span class="builtintype" id="1499616">uintptr</span><span class="op" id="1499623">(</span><span class="ident" id="1499624">t</span><span class="op" id="1499625">.</span><span class="ident" id="1499626">bucketsize</span><span class="op" id="1499636">)</span><span class="op" id="1499637">)</span><span class="op" id="1499638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499643">checkBucket</span>&nbsp;<span class="op" id="1499655">=</span>&nbsp;<span class="ident" id="1499657">noCheck</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1499667">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499671">bucket</span><span class="op" id="1499677">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1499682">if</span>&nbsp;<span class="ident" id="1499685">bucket</span>&nbsp;<span class="op" id="1499692">==</span>&nbsp;<span class="builtintype" id="1499695">uintptr</span><span class="op" id="1499702">(</span><span class="num" id="1499703">1</span><span class="op" id="1499704">)</span><span class="op" id="1499705">&lt;&lt;</span><span class="ident" id="1499707">it</span><span class="op" id="1499709">.</span><span class="ident" id="1499710">B</span>&nbsp;<span class="op" id="1499712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499717">bucket</span>&nbsp;<span class="op" id="1499724">=</span>&nbsp;<span class="num" id="1499726">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499731">it</span><span class="op" id="1499733">.</span><span class="ident" id="1499734">wrapped</span>&nbsp;<span class="op" id="1499742">=</span>&nbsp;<span class="builtintype" id="1499744">true</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1499751">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499755">i</span>&nbsp;<span class="op" id="1499757">=</span>&nbsp;<span class="num" id="1499759">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1499762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1499765">for</span>&nbsp;<span class="op" id="1499769">;</span>&nbsp;<span class="ident" id="1499771">i</span>&nbsp;<span class="op" id="1499773">&lt;</span>&nbsp;<span class="ident" id="1499775">bucketCnt</span><span class="op" id="1499784">;</span>&nbsp;<span class="ident" id="1499786">i</span><span class="op" id="1499787">++</span>&nbsp;<span class="op" id="1499790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499794">offi</span>&nbsp;<span class="op" id="1499799">:=</span>&nbsp;<span class="op" id="1499802">(</span><span class="ident" id="1499803">i</span>&nbsp;<span class="op" id="1499805">+</span>&nbsp;<span class="ident" id="1499807">it</span><span class="op" id="1499809">.</span><span class="ident" id="1499810">offset</span><span class="op" id="1499816">)</span>&nbsp;<span class="op" id="1499818">&amp;</span>&nbsp;<span class="op" id="1499820">(</span><span class="ident" id="1499821">bucketCnt</span>&nbsp;<span class="op" id="1499831">-</span>&nbsp;<span class="num" id="1499833">1</span><span class="op" id="1499834">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499838">k</span>&nbsp;<span class="op" id="1499840">:=</span>&nbsp;<span class="ident" id="1499843">add</span><span class="op" id="1499846">(</span><span class="ident" id="1499847">unsafe</span><span class="op" id="1499853">.</span><span class="ident" id="1499854">Pointer</span><span class="op" id="1499861">(</span><span class="ident" id="1499862">b</span><span class="op" id="1499863">)</span><span class="op" id="1499864">,</span>&nbsp;<span class="ident" id="1499866">dataOffset</span><span class="op" id="1499876">+</span><span class="builtintype" id="1499877">uintptr</span><span class="op" id="1499884">(</span><span class="ident" id="1499885">offi</span><span class="op" id="1499889">)</span><span class="op" id="1499890">*</span><span class="builtintype" id="1499891">uintptr</span><span class="op" id="1499898">(</span><span class="ident" id="1499899">t</span><span class="op" id="1499900">.</span><span class="ident" id="1499901">keysize</span><span class="op" id="1499908">)</span><span class="op" id="1499909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499913">v</span>&nbsp;<span class="op" id="1499915">:=</span>&nbsp;<span class="ident" id="1499918">add</span><span class="op" id="1499921">(</span><span class="ident" id="1499922">unsafe</span><span class="op" id="1499928">.</span><span class="ident" id="1499929">Pointer</span><span class="op" id="1499936">(</span><span class="ident" id="1499937">b</span><span class="op" id="1499938">)</span><span class="op" id="1499939">,</span>&nbsp;<span class="ident" id="1499941">dataOffset</span><span class="op" id="1499951">+</span><span class="ident" id="1499952">bucketCnt</span><span class="op" id="1499961">*</span><span class="builtintype" id="1499962">uintptr</span><span class="op" id="1499969">(</span><span class="ident" id="1499970">t</span><span class="op" id="1499971">.</span><span class="ident" id="1499972">keysize</span><span class="op" id="1499979">)</span><span class="op" id="1499980">+</span><span class="builtintype" id="1499981">uintptr</span><span class="op" id="1499988">(</span><span class="ident" id="1499989">offi</span><span class="op" id="1499993">)</span><span class="op" id="1499994">*</span><span class="builtintype" id="1499995">uintptr</span><span class="op" id="1500002">(</span><span class="ident" id="1500003">t</span><span class="op" id="1500004">.</span><span class="ident" id="1500005">valuesize</span><span class="op" id="1500014">)</span><span class="op" id="1500015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1500019">if</span>&nbsp;<span class="ident" id="1500022">b</span><span class="op" id="1500023">.</span><span class="ident" id="1500024">tophash</span><span class="op" id="1500031">[</span><span class="ident" id="1500032">offi</span><span class="op" id="1500036">]</span>&nbsp;<span class="op" id="1500038">!=</span>&nbsp;<span class="ident" id="1500041">empty</span>&nbsp;<span class="op" id="1500047">&amp;&amp;</span>&nbsp;<span class="ident" id="1500050">b</span><span class="op" id="1500051">.</span><span class="ident" id="1500052">tophash</span><span class="op" id="1500059">[</span><span class="ident" id="1500060">offi</span><span class="op" id="1500064">]</span>&nbsp;<span class="op" id="1500066">!=</span>&nbsp;<span class="ident" id="1500069">evacuatedEmpty</span>&nbsp;<span class="op" id="1500084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1500089">if</span>&nbsp;<span class="ident" id="1500092">checkBucket</span>&nbsp;<span class="op" id="1500104">!=</span>&nbsp;<span class="ident" id="1500107">noCheck</span>&nbsp;<span class="op" id="1500115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1500121">//&nbsp;Special&nbsp;case:&nbsp;iterator&nbsp;was&nbsp;started&nbsp;during&nbsp;a&nbsp;grow&nbsp;and&nbsp;the</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1500185">//&nbsp;grow&nbsp;is&nbsp;not&nbsp;done&nbsp;yet.&nbsp;&nbsp;We&#39;re&nbsp;working&nbsp;on&nbsp;a&nbsp;bucket&nbsp;whose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1500247">//&nbsp;oldbucket&nbsp;has&nbsp;not&nbsp;been&nbsp;evacuated&nbsp;yet.&nbsp;&nbsp;Or&nbsp;at&nbsp;least,&nbsp;it&nbsp;wasn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1500316">//&nbsp;evacuated&nbsp;when&nbsp;we&nbsp;started&nbsp;the&nbsp;bucket.&nbsp;&nbsp;So&nbsp;we&#39;re&nbsp;iterating</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1500381">//&nbsp;through&nbsp;the&nbsp;oldbucket,&nbsp;skipping&nbsp;any&nbsp;keys&nbsp;that&nbsp;will&nbsp;go</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1500442">//&nbsp;to&nbsp;the&nbsp;other&nbsp;new&nbsp;bucket&nbsp;(each&nbsp;oldbucket&nbsp;expands&nbsp;to&nbsp;two</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1500504">//&nbsp;buckets&nbsp;during&nbsp;a&nbsp;grow).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1500535">k2</span>&nbsp;<span class="op" id="1500538">:=</span>&nbsp;<span class="ident" id="1500541">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1500547">if</span>&nbsp;<span class="ident" id="1500550">t</span><span class="op" id="1500551">.</span><span class="ident" id="1500552">indirectkey</span>&nbsp;<span class="op" id="1500564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1500571">k2</span>&nbsp;<span class="op" id="1500574">=</span>&nbsp;<span class="op" id="1500576">*</span><span class="op" id="1500577">(</span><span class="op" id="1500578">(</span><span class="op" id="1500579">*</span><span class="ident" id="1500580">unsafe</span><span class="op" id="1500586">.</span><span class="ident" id="1500587">Pointer</span><span class="op" id="1500594">)</span><span class="op" id="1500595">(</span><span class="ident" id="1500596">k2</span><span class="op" id="1500598">)</span><span class="op" id="1500599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1500605">}</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1500611">if</span>&nbsp;<span class="ident" id="1500614">alg</span><span class="op" id="1500617">.</span><span class="ident" id="1500618">equal</span><span class="op" id="1500623">(</span><span class="ident" id="1500624">k2</span><span class="op" id="1500626">,</span>&nbsp;<span class="ident" id="1500628">k2</span><span class="op" id="1500630">,</span>&nbsp;<span class="builtintype" id="1500632">uintptr</span><span class="op" id="1500639">(</span><span class="ident" id="1500640">t</span><span class="op" id="1500641">.</span><span class="ident" id="1500642">key</span><span class="op" id="1500645">.</span><span class="ident" id="1500646">size</span><span class="op" id="1500650">)</span><span class="op" id="1500651">)</span>&nbsp;<span class="op" id="1500653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1500660">//&nbsp;If&nbsp;the&nbsp;item&nbsp;in&nbsp;the&nbsp;oldbucket&nbsp;is&nbsp;not&nbsp;destined&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1500717">//&nbsp;the&nbsp;current&nbsp;new&nbsp;bucket&nbsp;in&nbsp;the&nbsp;iteration,&nbsp;skip&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1500775">hash</span>&nbsp;<span class="op" id="1500780">:=</span>&nbsp;<span class="ident" id="1500783">alg</span><span class="op" id="1500786">.</span><span class="ident" id="1500787">hash</span><span class="op" id="1500791">(</span><span class="ident" id="1500792">k2</span><span class="op" id="1500794">,</span>&nbsp;<span class="builtintype" id="1500796">uintptr</span><span class="op" id="1500803">(</span><span class="ident" id="1500804">t</span><span class="op" id="1500805">.</span><span class="ident" id="1500806">key</span><span class="op" id="1500809">.</span><span class="ident" id="1500810">size</span><span class="op" id="1500814">)</span><span class="op" id="1500815">,</span>&nbsp;<span class="builtintype" id="1500817">uintptr</span><span class="op" id="1500824">(</span><span class="ident" id="1500825">h</span><span class="op" id="1500826">.</span><span class="ident" id="1500827">hash0</span><span class="op" id="1500832">)</span><span class="op" id="1500833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1500840">if</span>&nbsp;<span class="ident" id="1500843">hash</span><span class="op" id="1500847">&amp;</span><span class="op" id="1500848">(</span><span class="builtintype" id="1500849">uintptr</span><span class="op" id="1500856">(</span><span class="num" id="1500857">1</span><span class="op" id="1500858">)</span><span class="op" id="1500859">&lt;&lt;</span><span class="ident" id="1500861">it</span><span class="op" id="1500863">.</span><span class="ident" id="1500864">B</span><span class="op" id="1500865">-</span><span class="num" id="1500866">1</span><span class="op" id="1500867">)</span>&nbsp;<span class="op" id="1500869">!=</span>&nbsp;<span class="ident" id="1500872">checkBucket</span>&nbsp;<span class="op" id="1500884">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1500892">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1500906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1500912">}</span>&nbsp;<span class="keyword" id="1500914">else</span>&nbsp;<span class="op" id="1500919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1500926">//&nbsp;Hash&nbsp;isn&#39;t&nbsp;repeatable&nbsp;if&nbsp;k&nbsp;!=&nbsp;k&nbsp;(NaNs).&nbsp;&nbsp;We&nbsp;need&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1500985">//&nbsp;repeatable&nbsp;and&nbsp;randomish&nbsp;choice&nbsp;of&nbsp;which&nbsp;direction</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1501044">//&nbsp;to&nbsp;send&nbsp;NaNs&nbsp;during&nbsp;evacuation.&nbsp;&nbsp;We&#39;ll&nbsp;use&nbsp;the&nbsp;low</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1501103">//&nbsp;bit&nbsp;of&nbsp;tophash&nbsp;to&nbsp;decide&nbsp;which&nbsp;way&nbsp;NaNs&nbsp;go.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1501155">//&nbsp;NOTE:&nbsp;this&nbsp;case&nbsp;is&nbsp;why&nbsp;we&nbsp;need&nbsp;two&nbsp;evacuate&nbsp;tophash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1501215">//&nbsp;values,&nbsp;evacuatedX&nbsp;and&nbsp;evacuatedY,&nbsp;that&nbsp;differ&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1501273">//&nbsp;their&nbsp;low&nbsp;bit.</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1501296">if</span>&nbsp;<span class="ident" id="1501299">checkBucket</span><span class="op" id="1501310">&gt;&gt;</span><span class="op" id="1501312">(</span><span class="ident" id="1501313">it</span><span class="op" id="1501315">.</span><span class="ident" id="1501316">B</span><span class="op" id="1501317">-</span><span class="num" id="1501318">1</span><span class="op" id="1501319">)</span>&nbsp;<span class="op" id="1501321">!=</span>&nbsp;<span class="builtintype" id="1501324">uintptr</span><span class="op" id="1501331">(</span><span class="ident" id="1501332">b</span><span class="op" id="1501333">.</span><span class="ident" id="1501334">tophash</span><span class="op" id="1501341">[</span><span class="ident" id="1501342">offi</span><span class="op" id="1501346">]</span><span class="op" id="1501347">&amp;</span><span class="num" id="1501348">1</span><span class="op" id="1501349">)</span>&nbsp;<span class="op" id="1501351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1501359">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1501373">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1501379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1501384">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1501389">if</span>&nbsp;<span class="ident" id="1501392">b</span><span class="op" id="1501393">.</span><span class="ident" id="1501394">tophash</span><span class="op" id="1501401">[</span><span class="ident" id="1501402">offi</span><span class="op" id="1501406">]</span>&nbsp;<span class="op" id="1501408">!=</span>&nbsp;<span class="ident" id="1501411">evacuatedX</span>&nbsp;<span class="op" id="1501422">&amp;&amp;</span>&nbsp;<span class="ident" id="1501425">b</span><span class="op" id="1501426">.</span><span class="ident" id="1501427">tophash</span><span class="op" id="1501434">[</span><span class="ident" id="1501435">offi</span><span class="op" id="1501439">]</span>&nbsp;<span class="op" id="1501441">!=</span>&nbsp;<span class="ident" id="1501444">evacuatedY</span>&nbsp;<span class="op" id="1501455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1501461">//&nbsp;this&nbsp;is&nbsp;the&nbsp;golden&nbsp;data,&nbsp;we&nbsp;can&nbsp;return&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1501511">if</span>&nbsp;<span class="ident" id="1501514">t</span><span class="op" id="1501515">.</span><span class="ident" id="1501516">indirectkey</span>&nbsp;<span class="op" id="1501528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501535">k</span>&nbsp;<span class="op" id="1501537">=</span>&nbsp;<span class="op" id="1501539">*</span><span class="op" id="1501540">(</span><span class="op" id="1501541">(</span><span class="op" id="1501542">*</span><span class="ident" id="1501543">unsafe</span><span class="op" id="1501549">.</span><span class="ident" id="1501550">Pointer</span><span class="op" id="1501557">)</span><span class="op" id="1501558">(</span><span class="ident" id="1501559">k</span><span class="op" id="1501560">)</span><span class="op" id="1501561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1501567">}</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501573">it</span><span class="op" id="1501575">.</span><span class="ident" id="1501576">key</span>&nbsp;<span class="op" id="1501580">=</span>&nbsp;<span class="ident" id="1501582">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1501588">if</span>&nbsp;<span class="ident" id="1501591">t</span><span class="op" id="1501592">.</span><span class="ident" id="1501593">indirectvalue</span>&nbsp;<span class="op" id="1501607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501614">v</span>&nbsp;<span class="op" id="1501616">=</span>&nbsp;<span class="op" id="1501618">*</span><span class="op" id="1501619">(</span><span class="op" id="1501620">(</span><span class="op" id="1501621">*</span><span class="ident" id="1501622">unsafe</span><span class="op" id="1501628">.</span><span class="ident" id="1501629">Pointer</span><span class="op" id="1501636">)</span><span class="op" id="1501637">(</span><span class="ident" id="1501638">v</span><span class="op" id="1501639">)</span><span class="op" id="1501640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1501646">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501652">it</span><span class="op" id="1501654">.</span><span class="ident" id="1501655">value</span>&nbsp;<span class="op" id="1501661">=</span>&nbsp;<span class="ident" id="1501663">v</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1501668">}</span>&nbsp;<span class="keyword" id="1501670">else</span>&nbsp;<span class="op" id="1501675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1501681">//&nbsp;The&nbsp;hash&nbsp;table&nbsp;has&nbsp;grown&nbsp;since&nbsp;the&nbsp;iterator&nbsp;was&nbsp;started.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1501745">//&nbsp;The&nbsp;golden&nbsp;data&nbsp;for&nbsp;this&nbsp;key&nbsp;is&nbsp;now&nbsp;somewhere&nbsp;else.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501804">k2</span>&nbsp;<span class="op" id="1501807">:=</span>&nbsp;<span class="ident" id="1501810">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1501816">if</span>&nbsp;<span class="ident" id="1501819">t</span><span class="op" id="1501820">.</span><span class="ident" id="1501821">indirectkey</span>&nbsp;<span class="op" id="1501833">{</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501840">k2</span>&nbsp;<span class="op" id="1501843">=</span>&nbsp;<span class="op" id="1501845">*</span><span class="op" id="1501846">(</span><span class="op" id="1501847">(</span><span class="op" id="1501848">*</span><span class="ident" id="1501849">unsafe</span><span class="op" id="1501855">.</span><span class="ident" id="1501856">Pointer</span><span class="op" id="1501863">)</span><span class="op" id="1501864">(</span><span class="ident" id="1501865">k2</span><span class="op" id="1501867">)</span><span class="op" id="1501868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1501874">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1501880">if</span>&nbsp;<span class="ident" id="1501883">alg</span><span class="op" id="1501886">.</span><span class="ident" id="1501887">equal</span><span class="op" id="1501892">(</span><span class="ident" id="1501893">k2</span><span class="op" id="1501895">,</span>&nbsp;<span class="ident" id="1501897">k2</span><span class="op" id="1501899">,</span>&nbsp;<span class="builtintype" id="1501901">uintptr</span><span class="op" id="1501908">(</span><span class="ident" id="1501909">t</span><span class="op" id="1501910">.</span><span class="ident" id="1501911">key</span><span class="op" id="1501914">.</span><span class="ident" id="1501915">size</span><span class="op" id="1501919">)</span><span class="op" id="1501920">)</span>&nbsp;<span class="op" id="1501922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1501929">//&nbsp;Check&nbsp;the&nbsp;current&nbsp;hash&nbsp;table&nbsp;for&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1501980">//&nbsp;This&nbsp;code&nbsp;handles&nbsp;the&nbsp;case&nbsp;where&nbsp;the&nbsp;key</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1502029">//&nbsp;has&nbsp;been&nbsp;deleted,&nbsp;updated,&nbsp;or&nbsp;deleted&nbsp;and&nbsp;reinserted.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1502091">//&nbsp;NOTE:&nbsp;we&nbsp;need&nbsp;to&nbsp;regrab&nbsp;the&nbsp;key&nbsp;as&nbsp;it&nbsp;has&nbsp;potentially&nbsp;been</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1502158">//&nbsp;updated&nbsp;to&nbsp;an&nbsp;equal()&nbsp;but&nbsp;not&nbsp;identical&nbsp;key&nbsp;(e.g.&nbsp;+0.0&nbsp;vs&nbsp;-0.0).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502231">rk</span><span class="op" id="1502233">,</span>&nbsp;<span class="ident" id="1502235">rv</span>&nbsp;<span class="op" id="1502238">:=</span>&nbsp;<span class="ident" id="1502241">mapaccessK</span><span class="op" id="1502251">(</span><span class="ident" id="1502252">t</span><span class="op" id="1502253">,</span>&nbsp;<span class="ident" id="1502255">h</span><span class="op" id="1502256">,</span>&nbsp;<span class="ident" id="1502258">k2</span><span class="op" id="1502260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1502267">if</span>&nbsp;<span class="ident" id="1502270">rk</span>&nbsp;<span class="op" id="1502273">==</span>&nbsp;<span class="ident" id="1502276">nil</span>&nbsp;<span class="op" id="1502280">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1502288">continue</span>&nbsp;<span class="comment" id="1502297">//&nbsp;key&nbsp;has&nbsp;been&nbsp;deleted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1502326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502333">it</span><span class="op" id="1502335">.</span><span class="ident" id="1502336">key</span>&nbsp;<span class="op" id="1502340">=</span>&nbsp;<span class="ident" id="1502342">rk</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502350">it</span><span class="op" id="1502352">.</span><span class="ident" id="1502353">value</span>&nbsp;<span class="op" id="1502359">=</span>&nbsp;<span class="ident" id="1502361">rv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1502368">}</span>&nbsp;<span class="keyword" id="1502370">else</span>&nbsp;<span class="op" id="1502375">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1502382">//&nbsp;if&nbsp;key!=key&nbsp;then&nbsp;the&nbsp;entry&nbsp;can&#39;t&nbsp;be&nbsp;deleted&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1502437">//&nbsp;updated,&nbsp;so&nbsp;we&nbsp;can&nbsp;just&nbsp;return&nbsp;it.&nbsp;&nbsp;That&#39;s&nbsp;lucky&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1502498">//&nbsp;us&nbsp;because&nbsp;when&nbsp;key!=key&nbsp;we&nbsp;can&#39;t&nbsp;look&nbsp;it&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1502551">//&nbsp;successfully&nbsp;in&nbsp;the&nbsp;current&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502594">it</span><span class="op" id="1502596">.</span><span class="ident" id="1502597">key</span>&nbsp;<span class="op" id="1502601">=</span>&nbsp;<span class="ident" id="1502603">k2</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1502611">if</span>&nbsp;<span class="ident" id="1502614">t</span><span class="op" id="1502615">.</span><span class="ident" id="1502616">indirectvalue</span>&nbsp;<span class="op" id="1502630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502638">v</span>&nbsp;<span class="op" id="1502640">=</span>&nbsp;<span class="op" id="1502642">*</span><span class="op" id="1502643">(</span><span class="op" id="1502644">(</span><span class="op" id="1502645">*</span><span class="ident" id="1502646">unsafe</span><span class="op" id="1502652">.</span><span class="ident" id="1502653">Pointer</span><span class="op" id="1502660">)</span><span class="op" id="1502661">(</span><span class="ident" id="1502662">v</span><span class="op" id="1502663">)</span><span class="op" id="1502664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1502671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502678">it</span><span class="op" id="1502680">.</span><span class="ident" id="1502681">value</span>&nbsp;<span class="op" id="1502687">=</span>&nbsp;<span class="ident" id="1502689">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1502695">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1502700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502705">it</span><span class="op" id="1502707">.</span><span class="ident" id="1502708">bucket</span>&nbsp;<span class="op" id="1502715">=</span>&nbsp;<span class="ident" id="1502717">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502727">it</span><span class="op" id="1502729">.</span><span class="ident" id="1502730">bptr</span>&nbsp;<span class="op" id="1502735">=</span>&nbsp;<span class="ident" id="1502737">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502742">it</span><span class="op" id="1502744">.</span><span class="ident" id="1502745">i</span>&nbsp;<span class="op" id="1502747">=</span>&nbsp;<span class="ident" id="1502749">i</span>&nbsp;<span class="op" id="1502751">+</span>&nbsp;<span class="num" id="1502753">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502758">it</span><span class="op" id="1502760">.</span><span class="ident" id="1502761">checkBucket</span>&nbsp;<span class="op" id="1502773">=</span>&nbsp;<span class="ident" id="1502775">checkBucket</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1502790">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1502799">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1502802">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502805">b</span>&nbsp;<span class="op" id="1502807">=</span>&nbsp;<span class="ident" id="1502809">b</span><span class="op" id="1502810">.</span><span class="ident" id="1502811">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502821">i</span>&nbsp;<span class="op" id="1502823">=</span>&nbsp;<span class="num" id="1502825">0</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1502828">goto</span>&nbsp;<span class="ident" id="1502833">next</span><br>
<span class="lineno"></span><span class="op" id="1502838">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1502841">func</span>&nbsp;<span class="ident" id="1502846">hashGrow</span><span class="op" id="1502854">(</span><span class="ident" id="1502855">t</span>&nbsp;<span class="op" id="1502857">*</span><span class="ident" id="1502858">maptype</span><span class="op" id="1502865">,</span>&nbsp;<span class="ident" id="1502867">h</span>&nbsp;<span class="op" id="1502869">*</span><span class="ident" id="1502870">hmap</span><span class="op" id="1502874">)</span>&nbsp;<span class="op" id="1502876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1502879">if</span>&nbsp;<span class="ident" id="1502882">h</span><span class="op" id="1502883">.</span><span class="ident" id="1502884">oldbuckets</span>&nbsp;<span class="op" id="1502895">!=</span>&nbsp;<span class="ident" id="1502898">nil</span>&nbsp;<span class="op" id="1502902">{</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502906">gothrow</span><span class="op" id="1502913">(</span><span class="string" id="1502914">&#34;evacuation&nbsp;not&nbsp;done&nbsp;in&nbsp;time&#34;</span><span class="op" id="1502943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1502946">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502949">oldbuckets</span>&nbsp;<span class="op" id="1502960">:=</span>&nbsp;<span class="ident" id="1502963">h</span><span class="op" id="1502964">.</span><span class="ident" id="1502965">buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1502974">if</span>&nbsp;<span class="ident" id="1502977">checkgc</span>&nbsp;<span class="op" id="1502985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502989">memstats</span><span class="op" id="1502997">.</span><span class="ident" id="1502998">next_gc</span>&nbsp;<span class="op" id="1503006">=</span>&nbsp;<span class="ident" id="1503008">memstats</span><span class="op" id="1503016">.</span><span class="ident" id="1503017">heap_alloc</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1503029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1503032">newbuckets</span>&nbsp;<span class="op" id="1503043">:=</span>&nbsp;<span class="ident" id="1503046">newarray</span><span class="op" id="1503054">(</span><span class="ident" id="1503055">t</span><span class="op" id="1503056">.</span><span class="ident" id="1503057">bucket</span><span class="op" id="1503063">,</span>&nbsp;<span class="builtintype" id="1503065">uintptr</span><span class="op" id="1503072">(</span><span class="num" id="1503073">1</span><span class="op" id="1503074">)</span><span class="op" id="1503075">&lt;&lt;</span><span class="op" id="1503077">(</span><span class="ident" id="1503078">h</span><span class="op" id="1503079">.</span><span class="ident" id="1503080">B</span><span class="op" id="1503081">+</span><span class="num" id="1503082">1</span><span class="op" id="1503083">)</span><span class="op" id="1503084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1503087">flags</span>&nbsp;<span class="op" id="1503093">:=</span>&nbsp;<span class="ident" id="1503096">h</span><span class="op" id="1503097">.</span><span class="ident" id="1503098">flags</span>&nbsp;<span class="op" id="1503104">&amp;^</span>&nbsp;<span class="op" id="1503107">(</span><span class="ident" id="1503108">iterator</span>&nbsp;<span class="op" id="1503117">|</span>&nbsp;<span class="ident" id="1503119">oldIterator</span><span class="op" id="1503130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1503133">if</span>&nbsp;<span class="ident" id="1503136">h</span><span class="op" id="1503137">.</span><span class="ident" id="1503138">flags</span><span class="op" id="1503143">&amp;</span><span class="ident" id="1503144">iterator</span>&nbsp;<span class="op" id="1503153">!=</span>&nbsp;<span class="num" id="1503156">0</span>&nbsp;<span class="op" id="1503158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1503162">flags</span>&nbsp;<span class="op" id="1503168">|=</span>&nbsp;<span class="ident" id="1503171">oldIterator</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1503184">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1503187">//&nbsp;commit&nbsp;the&nbsp;grow&nbsp;(atomic&nbsp;wrt&nbsp;gc)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1503223">h</span><span class="op" id="1503224">.</span><span class="ident" id="1503225">B</span><span class="op" id="1503226">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1503230">h</span><span class="op" id="1503231">.</span><span class="ident" id="1503232">flags</span>&nbsp;<span class="op" id="1503238">=</span>&nbsp;<span class="ident" id="1503240">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1503247">h</span><span class="op" id="1503248">.</span><span class="ident" id="1503249">oldbuckets</span>&nbsp;<span class="op" id="1503260">=</span>&nbsp;<span class="ident" id="1503262">oldbuckets</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1503274">h</span><span class="op" id="1503275">.</span><span class="ident" id="1503276">buckets</span>&nbsp;<span class="op" id="1503284">=</span>&nbsp;<span class="ident" id="1503286">newbuckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1503298">h</span><span class="op" id="1503299">.</span><span class="ident" id="1503300">nevacuate</span>&nbsp;<span class="op" id="1503310">=</span>&nbsp;<span class="num" id="1503312">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1503316">//&nbsp;the&nbsp;actual&nbsp;copying&nbsp;of&nbsp;the&nbsp;hash&nbsp;table&nbsp;data&nbsp;is&nbsp;done&nbsp;incrementally</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1503384">//&nbsp;by&nbsp;growWork()&nbsp;and&nbsp;evacuate().</span><br>
<span class="lineno">750</span><span class="op" id="1503417">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1503420">func</span>&nbsp;<span class="ident" id="1503425">growWork</span><span class="op" id="1503433">(</span><span class="ident" id="1503434">t</span>&nbsp;<span class="op" id="1503436">*</span><span class="ident" id="1503437">maptype</span><span class="op" id="1503444">,</span>&nbsp;<span class="ident" id="1503446">h</span>&nbsp;<span class="op" id="1503448">*</span><span class="ident" id="1503449">hmap</span><span class="op" id="1503453">,</span>&nbsp;<span class="ident" id="1503455">bucket</span>&nbsp;<span class="builtintype" id="1503462">uintptr</span><span class="op" id="1503469">)</span>&nbsp;<span class="op" id="1503471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1503474">noldbuckets</span>&nbsp;<span class="op" id="1503486">:=</span>&nbsp;<span class="builtintype" id="1503489">uintptr</span><span class="op" id="1503496">(</span><span class="num" id="1503497">1</span><span class="op" id="1503498">)</span>&nbsp;<span class="op" id="1503500">&lt;&lt;</span>&nbsp;<span class="op" id="1503503">(</span><span class="ident" id="1503504">h</span><span class="op" id="1503505">.</span><span class="ident" id="1503506">B</span>&nbsp;<span class="op" id="1503508">-</span>&nbsp;<span class="num" id="1503510">1</span><span class="op" id="1503511">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1503515">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;evacuate&nbsp;the&nbsp;oldbucket&nbsp;corresponding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1503569">//&nbsp;to&nbsp;the&nbsp;bucket&nbsp;we&#39;re&nbsp;about&nbsp;to&nbsp;use</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1503606">evacuate</span><span class="op" id="1503614">(</span><span class="ident" id="1503615">t</span><span class="op" id="1503616">,</span>&nbsp;<span class="ident" id="1503618">h</span><span class="op" id="1503619">,</span>&nbsp;<span class="ident" id="1503621">bucket</span><span class="op" id="1503627">&amp;</span><span class="op" id="1503628">(</span><span class="ident" id="1503629">noldbuckets</span><span class="op" id="1503640">-</span><span class="num" id="1503641">1</span><span class="op" id="1503642">)</span><span class="op" id="1503643">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1503647">//&nbsp;evacuate&nbsp;one&nbsp;more&nbsp;oldbucket&nbsp;to&nbsp;make&nbsp;progress&nbsp;on&nbsp;growing</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1503707">if</span>&nbsp;<span class="ident" id="1503710">h</span><span class="op" id="1503711">.</span><span class="ident" id="1503712">oldbuckets</span>&nbsp;<span class="op" id="1503723">!=</span>&nbsp;<span class="ident" id="1503726">nil</span>&nbsp;<span class="op" id="1503730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1503734">evacuate</span><span class="op" id="1503742">(</span><span class="ident" id="1503743">t</span><span class="op" id="1503744">,</span>&nbsp;<span class="ident" id="1503746">h</span><span class="op" id="1503747">,</span>&nbsp;<span class="ident" id="1503749">h</span><span class="op" id="1503750">.</span><span class="ident" id="1503751">nevacuate</span><span class="op" id="1503760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1503763">}</span><br>
<span class="lineno"></span><span class="op" id="1503765">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">765</span><span class="keyword" id="1503768">func</span>&nbsp;<span class="ident" id="1503773">evacuate</span><span class="op" id="1503781">(</span><span class="ident" id="1503782">t</span>&nbsp;<span class="op" id="1503784">*</span><span class="ident" id="1503785">maptype</span><span class="op" id="1503792">,</span>&nbsp;<span class="ident" id="1503794">h</span>&nbsp;<span class="op" id="1503796">*</span><span class="ident" id="1503797">hmap</span><span class="op" id="1503801">,</span>&nbsp;<span class="ident" id="1503803">oldbucket</span>&nbsp;<span class="builtintype" id="1503813">uintptr</span><span class="op" id="1503820">)</span>&nbsp;<span class="op" id="1503822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1503825">b</span>&nbsp;<span class="op" id="1503827">:=</span>&nbsp;<span class="op" id="1503830">(</span><span class="op" id="1503831">*</span><span class="ident" id="1503832">bmap</span><span class="op" id="1503836">)</span><span class="op" id="1503837">(</span><span class="ident" id="1503838">add</span><span class="op" id="1503841">(</span><span class="ident" id="1503842">h</span><span class="op" id="1503843">.</span><span class="ident" id="1503844">oldbuckets</span><span class="op" id="1503854">,</span>&nbsp;<span class="ident" id="1503856">oldbucket</span><span class="op" id="1503865">*</span><span class="builtintype" id="1503866">uintptr</span><span class="op" id="1503873">(</span><span class="ident" id="1503874">t</span><span class="op" id="1503875">.</span><span class="ident" id="1503876">bucketsize</span><span class="op" id="1503886">)</span><span class="op" id="1503887">)</span><span class="op" id="1503888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1503891">newbit</span>&nbsp;<span class="op" id="1503898">:=</span>&nbsp;<span class="builtintype" id="1503901">uintptr</span><span class="op" id="1503908">(</span><span class="num" id="1503909">1</span><span class="op" id="1503910">)</span>&nbsp;<span class="op" id="1503912">&lt;&lt;</span>&nbsp;<span class="op" id="1503915">(</span><span class="ident" id="1503916">h</span><span class="op" id="1503917">.</span><span class="ident" id="1503918">B</span>&nbsp;<span class="op" id="1503920">-</span>&nbsp;<span class="num" id="1503922">1</span><span class="op" id="1503923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1503926">alg</span>&nbsp;<span class="op" id="1503930">:=</span>&nbsp;<span class="ident" id="1503933">goalg</span><span class="op" id="1503938">(</span><span class="ident" id="1503939">t</span><span class="op" id="1503940">.</span><span class="ident" id="1503941">key</span><span class="op" id="1503944">.</span><span class="ident" id="1503945">alg</span><span class="op" id="1503948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1503951">if</span>&nbsp;<span class="op" id="1503954">!</span><span class="ident" id="1503955">evacuated</span><span class="op" id="1503964">(</span><span class="ident" id="1503965">b</span><span class="op" id="1503966">)</span>&nbsp;<span class="op" id="1503968">{</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1503972">//&nbsp;TODO:&nbsp;reuse&nbsp;overflow&nbsp;buckets&nbsp;instead&nbsp;of&nbsp;using&nbsp;new&nbsp;ones,&nbsp;if&nbsp;there</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1504042">//&nbsp;is&nbsp;no&nbsp;iterator&nbsp;using&nbsp;the&nbsp;old&nbsp;buckets.&nbsp;&nbsp;(If&nbsp;!oldIterator.)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504106">x</span>&nbsp;<span class="op" id="1504108">:=</span>&nbsp;<span class="op" id="1504111">(</span><span class="op" id="1504112">*</span><span class="ident" id="1504113">bmap</span><span class="op" id="1504117">)</span><span class="op" id="1504118">(</span><span class="ident" id="1504119">add</span><span class="op" id="1504122">(</span><span class="ident" id="1504123">h</span><span class="op" id="1504124">.</span><span class="ident" id="1504125">buckets</span><span class="op" id="1504132">,</span>&nbsp;<span class="ident" id="1504134">oldbucket</span><span class="op" id="1504143">*</span><span class="builtintype" id="1504144">uintptr</span><span class="op" id="1504151">(</span><span class="ident" id="1504152">t</span><span class="op" id="1504153">.</span><span class="ident" id="1504154">bucketsize</span><span class="op" id="1504164">)</span><span class="op" id="1504165">)</span><span class="op" id="1504166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504170">y</span>&nbsp;<span class="op" id="1504172">:=</span>&nbsp;<span class="op" id="1504175">(</span><span class="op" id="1504176">*</span><span class="ident" id="1504177">bmap</span><span class="op" id="1504181">)</span><span class="op" id="1504182">(</span><span class="ident" id="1504183">add</span><span class="op" id="1504186">(</span><span class="ident" id="1504187">h</span><span class="op" id="1504188">.</span><span class="ident" id="1504189">buckets</span><span class="op" id="1504196">,</span>&nbsp;<span class="op" id="1504198">(</span><span class="ident" id="1504199">oldbucket</span><span class="op" id="1504208">+</span><span class="ident" id="1504209">newbit</span><span class="op" id="1504215">)</span><span class="op" id="1504216">*</span><span class="builtintype" id="1504217">uintptr</span><span class="op" id="1504224">(</span><span class="ident" id="1504225">t</span><span class="op" id="1504226">.</span><span class="ident" id="1504227">bucketsize</span><span class="op" id="1504237">)</span><span class="op" id="1504238">)</span><span class="op" id="1504239">)</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504243">xi</span>&nbsp;<span class="op" id="1504246">:=</span>&nbsp;<span class="num" id="1504249">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504253">yi</span>&nbsp;<span class="op" id="1504256">:=</span>&nbsp;<span class="num" id="1504259">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504263">xk</span>&nbsp;<span class="op" id="1504266">:=</span>&nbsp;<span class="ident" id="1504269">add</span><span class="op" id="1504272">(</span><span class="ident" id="1504273">unsafe</span><span class="op" id="1504279">.</span><span class="ident" id="1504280">Pointer</span><span class="op" id="1504287">(</span><span class="ident" id="1504288">x</span><span class="op" id="1504289">)</span><span class="op" id="1504290">,</span>&nbsp;<span class="ident" id="1504292">dataOffset</span><span class="op" id="1504302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504306">yk</span>&nbsp;<span class="op" id="1504309">:=</span>&nbsp;<span class="ident" id="1504312">add</span><span class="op" id="1504315">(</span><span class="ident" id="1504316">unsafe</span><span class="op" id="1504322">.</span><span class="ident" id="1504323">Pointer</span><span class="op" id="1504330">(</span><span class="ident" id="1504331">y</span><span class="op" id="1504332">)</span><span class="op" id="1504333">,</span>&nbsp;<span class="ident" id="1504335">dataOffset</span><span class="op" id="1504345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504349">xv</span>&nbsp;<span class="op" id="1504352">:=</span>&nbsp;<span class="ident" id="1504355">add</span><span class="op" id="1504358">(</span><span class="ident" id="1504359">xk</span><span class="op" id="1504361">,</span>&nbsp;<span class="ident" id="1504363">bucketCnt</span><span class="op" id="1504372">*</span><span class="builtintype" id="1504373">uintptr</span><span class="op" id="1504380">(</span><span class="ident" id="1504381">t</span><span class="op" id="1504382">.</span><span class="ident" id="1504383">keysize</span><span class="op" id="1504390">)</span><span class="op" id="1504391">)</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504395">yv</span>&nbsp;<span class="op" id="1504398">:=</span>&nbsp;<span class="ident" id="1504401">add</span><span class="op" id="1504404">(</span><span class="ident" id="1504405">yk</span><span class="op" id="1504407">,</span>&nbsp;<span class="ident" id="1504409">bucketCnt</span><span class="op" id="1504418">*</span><span class="builtintype" id="1504419">uintptr</span><span class="op" id="1504426">(</span><span class="ident" id="1504427">t</span><span class="op" id="1504428">.</span><span class="ident" id="1504429">keysize</span><span class="op" id="1504436">)</span><span class="op" id="1504437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1504441">for</span>&nbsp;<span class="op" id="1504445">;</span>&nbsp;<span class="ident" id="1504447">b</span>&nbsp;<span class="op" id="1504449">!=</span>&nbsp;<span class="ident" id="1504452">nil</span><span class="op" id="1504455">;</span>&nbsp;<span class="ident" id="1504457">b</span>&nbsp;<span class="op" id="1504459">=</span>&nbsp;<span class="ident" id="1504461">b</span><span class="op" id="1504462">.</span><span class="ident" id="1504463">overflow</span>&nbsp;<span class="op" id="1504472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504477">k</span>&nbsp;<span class="op" id="1504479">:=</span>&nbsp;<span class="ident" id="1504482">add</span><span class="op" id="1504485">(</span><span class="ident" id="1504486">unsafe</span><span class="op" id="1504492">.</span><span class="ident" id="1504493">Pointer</span><span class="op" id="1504500">(</span><span class="ident" id="1504501">b</span><span class="op" id="1504502">)</span><span class="op" id="1504503">,</span>&nbsp;<span class="ident" id="1504505">dataOffset</span><span class="op" id="1504515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504520">v</span>&nbsp;<span class="op" id="1504522">:=</span>&nbsp;<span class="ident" id="1504525">add</span><span class="op" id="1504528">(</span><span class="ident" id="1504529">k</span><span class="op" id="1504530">,</span>&nbsp;<span class="ident" id="1504532">bucketCnt</span><span class="op" id="1504541">*</span><span class="builtintype" id="1504542">uintptr</span><span class="op" id="1504549">(</span><span class="ident" id="1504550">t</span><span class="op" id="1504551">.</span><span class="ident" id="1504552">keysize</span><span class="op" id="1504559">)</span><span class="op" id="1504560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1504565">for</span>&nbsp;<span class="ident" id="1504569">i</span>&nbsp;<span class="op" id="1504571">:=</span>&nbsp;<span class="num" id="1504574">0</span><span class="op" id="1504575">;</span>&nbsp;<span class="ident" id="1504577">i</span>&nbsp;<span class="op" id="1504579">&lt;</span>&nbsp;<span class="ident" id="1504581">bucketCnt</span><span class="op" id="1504590">;</span>&nbsp;<span class="ident" id="1504592">i</span><span class="op" id="1504593">,</span>&nbsp;<span class="ident" id="1504595">k</span><span class="op" id="1504596">,</span>&nbsp;<span class="ident" id="1504598">v</span>&nbsp;<span class="op" id="1504600">=</span>&nbsp;<span class="ident" id="1504602">i</span><span class="op" id="1504603">+</span><span class="num" id="1504604">1</span><span class="op" id="1504605">,</span>&nbsp;<span class="ident" id="1504607">add</span><span class="op" id="1504610">(</span><span class="ident" id="1504611">k</span><span class="op" id="1504612">,</span>&nbsp;<span class="builtintype" id="1504614">uintptr</span><span class="op" id="1504621">(</span><span class="ident" id="1504622">t</span><span class="op" id="1504623">.</span><span class="ident" id="1504624">keysize</span><span class="op" id="1504631">)</span><span class="op" id="1504632">)</span><span class="op" id="1504633">,</span>&nbsp;<span class="ident" id="1504635">add</span><span class="op" id="1504638">(</span><span class="ident" id="1504639">v</span><span class="op" id="1504640">,</span>&nbsp;<span class="builtintype" id="1504642">uintptr</span><span class="op" id="1504649">(</span><span class="ident" id="1504650">t</span><span class="op" id="1504651">.</span><span class="ident" id="1504652">valuesize</span><span class="op" id="1504661">)</span><span class="op" id="1504662">)</span>&nbsp;<span class="op" id="1504664">{</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504670">top</span>&nbsp;<span class="op" id="1504674">:=</span>&nbsp;<span class="ident" id="1504677">b</span><span class="op" id="1504678">.</span><span class="ident" id="1504679">tophash</span><span class="op" id="1504686">[</span><span class="ident" id="1504687">i</span><span class="op" id="1504688">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1504694">if</span>&nbsp;<span class="ident" id="1504697">top</span>&nbsp;<span class="op" id="1504701">==</span>&nbsp;<span class="ident" id="1504704">empty</span>&nbsp;<span class="op" id="1504710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504717">b</span><span class="op" id="1504718">.</span><span class="ident" id="1504719">tophash</span><span class="op" id="1504726">[</span><span class="ident" id="1504727">i</span><span class="op" id="1504728">]</span>&nbsp;<span class="op" id="1504730">=</span>&nbsp;<span class="ident" id="1504732">evacuatedEmpty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1504752">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1504765">}</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1504771">if</span>&nbsp;<span class="ident" id="1504774">top</span>&nbsp;<span class="op" id="1504778">&lt;</span>&nbsp;<span class="ident" id="1504780">minTopHash</span>&nbsp;<span class="op" id="1504791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504798">gothrow</span><span class="op" id="1504805">(</span><span class="string" id="1504806">&#34;bad&nbsp;map&nbsp;state&#34;</span><span class="op" id="1504821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1504827">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504833">k2</span>&nbsp;<span class="op" id="1504836">:=</span>&nbsp;<span class="ident" id="1504839">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1504845">if</span>&nbsp;<span class="ident" id="1504848">t</span><span class="op" id="1504849">.</span><span class="ident" id="1504850">indirectkey</span>&nbsp;<span class="op" id="1504862">{</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504869">k2</span>&nbsp;<span class="op" id="1504872">=</span>&nbsp;<span class="op" id="1504874">*</span><span class="op" id="1504875">(</span><span class="op" id="1504876">(</span><span class="op" id="1504877">*</span><span class="ident" id="1504878">unsafe</span><span class="op" id="1504884">.</span><span class="ident" id="1504885">Pointer</span><span class="op" id="1504892">)</span><span class="op" id="1504893">(</span><span class="ident" id="1504894">k2</span><span class="op" id="1504896">)</span><span class="op" id="1504897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1504903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1504909">//&nbsp;Compute&nbsp;hash&nbsp;to&nbsp;make&nbsp;our&nbsp;evacuation&nbsp;decision&nbsp;(whether&nbsp;we&nbsp;need</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1504978">//&nbsp;to&nbsp;send&nbsp;this&nbsp;key/value&nbsp;to&nbsp;bucket&nbsp;x&nbsp;or&nbsp;bucket&nbsp;y).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505034">hash</span>&nbsp;<span class="op" id="1505039">:=</span>&nbsp;<span class="ident" id="1505042">alg</span><span class="op" id="1505045">.</span><span class="ident" id="1505046">hash</span><span class="op" id="1505050">(</span><span class="ident" id="1505051">k2</span><span class="op" id="1505053">,</span>&nbsp;<span class="builtintype" id="1505055">uintptr</span><span class="op" id="1505062">(</span><span class="ident" id="1505063">t</span><span class="op" id="1505064">.</span><span class="ident" id="1505065">key</span><span class="op" id="1505068">.</span><span class="ident" id="1505069">size</span><span class="op" id="1505073">)</span><span class="op" id="1505074">,</span>&nbsp;<span class="builtintype" id="1505076">uintptr</span><span class="op" id="1505083">(</span><span class="ident" id="1505084">h</span><span class="op" id="1505085">.</span><span class="ident" id="1505086">hash0</span><span class="op" id="1505091">)</span><span class="op" id="1505092">)</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1505098">if</span>&nbsp;<span class="ident" id="1505101">h</span><span class="op" id="1505102">.</span><span class="ident" id="1505103">flags</span><span class="op" id="1505108">&amp;</span><span class="ident" id="1505109">iterator</span>&nbsp;<span class="op" id="1505118">!=</span>&nbsp;<span class="num" id="1505121">0</span>&nbsp;<span class="op" id="1505123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1505130">if</span>&nbsp;<span class="op" id="1505133">!</span><span class="ident" id="1505134">alg</span><span class="op" id="1505137">.</span><span class="ident" id="1505138">equal</span><span class="op" id="1505143">(</span><span class="ident" id="1505144">k2</span><span class="op" id="1505146">,</span>&nbsp;<span class="ident" id="1505148">k2</span><span class="op" id="1505150">,</span>&nbsp;<span class="builtintype" id="1505152">uintptr</span><span class="op" id="1505159">(</span><span class="ident" id="1505160">t</span><span class="op" id="1505161">.</span><span class="ident" id="1505162">key</span><span class="op" id="1505165">.</span><span class="ident" id="1505166">size</span><span class="op" id="1505170">)</span><span class="op" id="1505171">)</span>&nbsp;<span class="op" id="1505173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1505181">//&nbsp;If&nbsp;key&nbsp;!=&nbsp;key&nbsp;(NaNs),&nbsp;then&nbsp;the&nbsp;hash&nbsp;could&nbsp;be&nbsp;(and&nbsp;probably</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1505249">//&nbsp;will&nbsp;be)&nbsp;entirely&nbsp;different&nbsp;from&nbsp;the&nbsp;old&nbsp;hash.&nbsp;&nbsp;Moreover,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1505316">//&nbsp;it&nbsp;isn&#39;t&nbsp;reproducible.&nbsp;&nbsp;Reproducibility&nbsp;is&nbsp;required&nbsp;in&nbsp;the</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1505384">//&nbsp;presence&nbsp;of&nbsp;iterators,&nbsp;as&nbsp;our&nbsp;evacuation&nbsp;decision&nbsp;must</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1505448">//&nbsp;match&nbsp;whatever&nbsp;decision&nbsp;the&nbsp;iterator&nbsp;made.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1505500">//&nbsp;Fortunately,&nbsp;we&nbsp;have&nbsp;the&nbsp;freedom&nbsp;to&nbsp;send&nbsp;these&nbsp;keys&nbsp;either</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1505568">//&nbsp;way.&nbsp;&nbsp;Also,&nbsp;tophash&nbsp;is&nbsp;meaningless&nbsp;for&nbsp;these&nbsp;kinds&nbsp;of&nbsp;keys.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1505637">//&nbsp;We&nbsp;let&nbsp;the&nbsp;low&nbsp;bit&nbsp;of&nbsp;tophash&nbsp;drive&nbsp;the&nbsp;evacuation&nbsp;decision.</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1505707">//&nbsp;We&nbsp;recompute&nbsp;a&nbsp;new&nbsp;random&nbsp;tophash&nbsp;for&nbsp;the&nbsp;next&nbsp;level&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1505772">//&nbsp;these&nbsp;keys&nbsp;will&nbsp;get&nbsp;evenly&nbsp;distributed&nbsp;across&nbsp;all&nbsp;buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1505839">//&nbsp;after&nbsp;multiple&nbsp;grows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1505870">if</span>&nbsp;<span class="op" id="1505873">(</span><span class="ident" id="1505874">top</span>&nbsp;<span class="op" id="1505878">&amp;</span>&nbsp;<span class="num" id="1505880">1</span><span class="op" id="1505881">)</span>&nbsp;<span class="op" id="1505883">!=</span>&nbsp;<span class="num" id="1505886">0</span>&nbsp;<span class="op" id="1505888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505897">hash</span>&nbsp;<span class="op" id="1505902">|=</span>&nbsp;<span class="ident" id="1505905">newbit</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1505918">}</span>&nbsp;<span class="keyword" id="1505920">else</span>&nbsp;<span class="op" id="1505925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505934">hash</span>&nbsp;<span class="op" id="1505939">&amp;^=</span>&nbsp;<span class="ident" id="1505943">newbit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1505956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505964">top</span>&nbsp;<span class="op" id="1505968">=</span>&nbsp;<span class="builtintype" id="1505970">uint8</span><span class="op" id="1505975">(</span><span class="ident" id="1505976">hash</span>&nbsp;<span class="op" id="1505981">&gt;&gt;</span>&nbsp;<span class="op" id="1505984">(</span><span class="ident" id="1505985">ptrSize</span><span class="op" id="1505992">*</span><span class="num" id="1505993">8</span>&nbsp;<span class="op" id="1505995">-</span>&nbsp;<span class="num" id="1505997">8</span><span class="op" id="1505998">)</span><span class="op" id="1505999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1506007">if</span>&nbsp;<span class="ident" id="1506010">top</span>&nbsp;<span class="op" id="1506014">&lt;</span>&nbsp;<span class="ident" id="1506016">minTopHash</span>&nbsp;<span class="op" id="1506027">{</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506036">top</span>&nbsp;<span class="op" id="1506040">+=</span>&nbsp;<span class="ident" id="1506043">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1506060">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1506067">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1506073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1506079">if</span>&nbsp;<span class="op" id="1506082">(</span><span class="ident" id="1506083">hash</span>&nbsp;<span class="op" id="1506088">&amp;</span>&nbsp;<span class="ident" id="1506090">newbit</span><span class="op" id="1506096">)</span>&nbsp;<span class="op" id="1506098">==</span>&nbsp;<span class="num" id="1506101">0</span>&nbsp;<span class="op" id="1506103">{</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506110">b</span><span class="op" id="1506111">.</span><span class="ident" id="1506112">tophash</span><span class="op" id="1506119">[</span><span class="ident" id="1506120">i</span><span class="op" id="1506121">]</span>&nbsp;<span class="op" id="1506123">=</span>&nbsp;<span class="ident" id="1506125">evacuatedX</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1506141">if</span>&nbsp;<span class="ident" id="1506144">xi</span>&nbsp;<span class="op" id="1506147">==</span>&nbsp;<span class="ident" id="1506150">bucketCnt</span>&nbsp;<span class="op" id="1506160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1506168">if</span>&nbsp;<span class="ident" id="1506171">checkgc</span>&nbsp;<span class="op" id="1506179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506188">memstats</span><span class="op" id="1506196">.</span><span class="ident" id="1506197">next_gc</span>&nbsp;<span class="op" id="1506205">=</span>&nbsp;<span class="ident" id="1506207">memstats</span><span class="op" id="1506215">.</span><span class="ident" id="1506216">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1506233">}</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506241">newx</span>&nbsp;<span class="op" id="1506246">:=</span>&nbsp;<span class="op" id="1506249">(</span><span class="op" id="1506250">*</span><span class="ident" id="1506251">bmap</span><span class="op" id="1506255">)</span><span class="op" id="1506256">(</span><span class="ident" id="1506257">newobject</span><span class="op" id="1506266">(</span><span class="ident" id="1506267">t</span><span class="op" id="1506268">.</span><span class="ident" id="1506269">bucket</span><span class="op" id="1506275">)</span><span class="op" id="1506276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506284">x</span><span class="op" id="1506285">.</span><span class="ident" id="1506286">overflow</span>&nbsp;<span class="op" id="1506295">=</span>&nbsp;<span class="ident" id="1506297">newx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506308">x</span>&nbsp;<span class="op" id="1506310">=</span>&nbsp;<span class="ident" id="1506312">newx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506323">xi</span>&nbsp;<span class="op" id="1506326">=</span>&nbsp;<span class="num" id="1506328">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506336">xk</span>&nbsp;<span class="op" id="1506339">=</span>&nbsp;<span class="ident" id="1506341">add</span><span class="op" id="1506344">(</span><span class="ident" id="1506345">unsafe</span><span class="op" id="1506351">.</span><span class="ident" id="1506352">Pointer</span><span class="op" id="1506359">(</span><span class="ident" id="1506360">x</span><span class="op" id="1506361">)</span><span class="op" id="1506362">,</span>&nbsp;<span class="ident" id="1506364">dataOffset</span><span class="op" id="1506374">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506382">xv</span>&nbsp;<span class="op" id="1506385">=</span>&nbsp;<span class="ident" id="1506387">add</span><span class="op" id="1506390">(</span><span class="ident" id="1506391">xk</span><span class="op" id="1506393">,</span>&nbsp;<span class="ident" id="1506395">bucketCnt</span><span class="op" id="1506404">*</span><span class="builtintype" id="1506405">uintptr</span><span class="op" id="1506412">(</span><span class="ident" id="1506413">t</span><span class="op" id="1506414">.</span><span class="ident" id="1506415">keysize</span><span class="op" id="1506422">)</span><span class="op" id="1506423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1506430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506437">x</span><span class="op" id="1506438">.</span><span class="ident" id="1506439">tophash</span><span class="op" id="1506446">[</span><span class="ident" id="1506447">xi</span><span class="op" id="1506449">]</span>&nbsp;<span class="op" id="1506451">=</span>&nbsp;<span class="ident" id="1506453">top</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1506462">if</span>&nbsp;<span class="ident" id="1506465">t</span><span class="op" id="1506466">.</span><span class="ident" id="1506467">indirectkey</span>&nbsp;<span class="op" id="1506479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1506487">*</span><span class="op" id="1506488">(</span><span class="op" id="1506489">*</span><span class="ident" id="1506490">unsafe</span><span class="op" id="1506496">.</span><span class="ident" id="1506497">Pointer</span><span class="op" id="1506504">)</span><span class="op" id="1506505">(</span><span class="ident" id="1506506">xk</span><span class="op" id="1506508">)</span>&nbsp;<span class="op" id="1506510">=</span>&nbsp;<span class="ident" id="1506512">k2</span>&nbsp;<span class="comment" id="1506515">//&nbsp;copy&nbsp;pointer</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1506536">}</span>&nbsp;<span class="keyword" id="1506538">else</span>&nbsp;<span class="op" id="1506543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506551">memmove</span><span class="op" id="1506558">(</span><span class="ident" id="1506559">xk</span><span class="op" id="1506561">,</span>&nbsp;<span class="ident" id="1506563">k</span><span class="op" id="1506564">,</span>&nbsp;<span class="builtintype" id="1506566">uintptr</span><span class="op" id="1506573">(</span><span class="ident" id="1506574">t</span><span class="op" id="1506575">.</span><span class="ident" id="1506576">key</span><span class="op" id="1506579">.</span><span class="ident" id="1506580">size</span><span class="op" id="1506584">)</span><span class="op" id="1506585">)</span>&nbsp;<span class="comment" id="1506587">//&nbsp;copy&nbsp;value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1506606">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1506613">if</span>&nbsp;<span class="ident" id="1506616">t</span><span class="op" id="1506617">.</span><span class="ident" id="1506618">indirectvalue</span>&nbsp;<span class="op" id="1506632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1506640">*</span><span class="op" id="1506641">(</span><span class="op" id="1506642">*</span><span class="ident" id="1506643">unsafe</span><span class="op" id="1506649">.</span><span class="ident" id="1506650">Pointer</span><span class="op" id="1506657">)</span><span class="op" id="1506658">(</span><span class="ident" id="1506659">xv</span><span class="op" id="1506661">)</span>&nbsp;<span class="op" id="1506663">=</span>&nbsp;<span class="op" id="1506665">*</span><span class="op" id="1506666">(</span><span class="op" id="1506667">*</span><span class="ident" id="1506668">unsafe</span><span class="op" id="1506674">.</span><span class="ident" id="1506675">Pointer</span><span class="op" id="1506682">)</span><span class="op" id="1506683">(</span><span class="ident" id="1506684">v</span><span class="op" id="1506685">)</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1506692">}</span>&nbsp;<span class="keyword" id="1506694">else</span>&nbsp;<span class="op" id="1506699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506707">memmove</span><span class="op" id="1506714">(</span><span class="ident" id="1506715">xv</span><span class="op" id="1506717">,</span>&nbsp;<span class="ident" id="1506719">v</span><span class="op" id="1506720">,</span>&nbsp;<span class="builtintype" id="1506722">uintptr</span><span class="op" id="1506729">(</span><span class="ident" id="1506730">t</span><span class="op" id="1506731">.</span><span class="ident" id="1506732">elem</span><span class="op" id="1506736">.</span><span class="ident" id="1506737">size</span><span class="op" id="1506741">)</span><span class="op" id="1506742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1506749">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506756">xi</span><span class="op" id="1506758">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506766">xk</span>&nbsp;<span class="op" id="1506769">=</span>&nbsp;<span class="ident" id="1506771">add</span><span class="op" id="1506774">(</span><span class="ident" id="1506775">xk</span><span class="op" id="1506777">,</span>&nbsp;<span class="builtintype" id="1506779">uintptr</span><span class="op" id="1506786">(</span><span class="ident" id="1506787">t</span><span class="op" id="1506788">.</span><span class="ident" id="1506789">keysize</span><span class="op" id="1506796">)</span><span class="op" id="1506797">)</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506804">xv</span>&nbsp;<span class="op" id="1506807">=</span>&nbsp;<span class="ident" id="1506809">add</span><span class="op" id="1506812">(</span><span class="ident" id="1506813">xv</span><span class="op" id="1506815">,</span>&nbsp;<span class="builtintype" id="1506817">uintptr</span><span class="op" id="1506824">(</span><span class="ident" id="1506825">t</span><span class="op" id="1506826">.</span><span class="ident" id="1506827">valuesize</span><span class="op" id="1506836">)</span><span class="op" id="1506837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1506843">}</span>&nbsp;<span class="keyword" id="1506845">else</span>&nbsp;<span class="op" id="1506850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506857">b</span><span class="op" id="1506858">.</span><span class="ident" id="1506859">tophash</span><span class="op" id="1506866">[</span><span class="ident" id="1506867">i</span><span class="op" id="1506868">]</span>&nbsp;<span class="op" id="1506870">=</span>&nbsp;<span class="ident" id="1506872">evacuatedY</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1506888">if</span>&nbsp;<span class="ident" id="1506891">yi</span>&nbsp;<span class="op" id="1506894">==</span>&nbsp;<span class="ident" id="1506897">bucketCnt</span>&nbsp;<span class="op" id="1506907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1506915">if</span>&nbsp;<span class="ident" id="1506918">checkgc</span>&nbsp;<span class="op" id="1506926">{</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506935">memstats</span><span class="op" id="1506943">.</span><span class="ident" id="1506944">next_gc</span>&nbsp;<span class="op" id="1506952">=</span>&nbsp;<span class="ident" id="1506954">memstats</span><span class="op" id="1506962">.</span><span class="ident" id="1506963">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1506980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506988">newy</span>&nbsp;<span class="op" id="1506993">:=</span>&nbsp;<span class="op" id="1506996">(</span><span class="op" id="1506997">*</span><span class="ident" id="1506998">bmap</span><span class="op" id="1507002">)</span><span class="op" id="1507003">(</span><span class="ident" id="1507004">newobject</span><span class="op" id="1507013">(</span><span class="ident" id="1507014">t</span><span class="op" id="1507015">.</span><span class="ident" id="1507016">bucket</span><span class="op" id="1507022">)</span><span class="op" id="1507023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507031">y</span><span class="op" id="1507032">.</span><span class="ident" id="1507033">overflow</span>&nbsp;<span class="op" id="1507042">=</span>&nbsp;<span class="ident" id="1507044">newy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507055">y</span>&nbsp;<span class="op" id="1507057">=</span>&nbsp;<span class="ident" id="1507059">newy</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507070">yi</span>&nbsp;<span class="op" id="1507073">=</span>&nbsp;<span class="num" id="1507075">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507083">yk</span>&nbsp;<span class="op" id="1507086">=</span>&nbsp;<span class="ident" id="1507088">add</span><span class="op" id="1507091">(</span><span class="ident" id="1507092">unsafe</span><span class="op" id="1507098">.</span><span class="ident" id="1507099">Pointer</span><span class="op" id="1507106">(</span><span class="ident" id="1507107">y</span><span class="op" id="1507108">)</span><span class="op" id="1507109">,</span>&nbsp;<span class="ident" id="1507111">dataOffset</span><span class="op" id="1507121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507129">yv</span>&nbsp;<span class="op" id="1507132">=</span>&nbsp;<span class="ident" id="1507134">add</span><span class="op" id="1507137">(</span><span class="ident" id="1507138">yk</span><span class="op" id="1507140">,</span>&nbsp;<span class="ident" id="1507142">bucketCnt</span><span class="op" id="1507151">*</span><span class="builtintype" id="1507152">uintptr</span><span class="op" id="1507159">(</span><span class="ident" id="1507160">t</span><span class="op" id="1507161">.</span><span class="ident" id="1507162">keysize</span><span class="op" id="1507169">)</span><span class="op" id="1507170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1507177">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507184">y</span><span class="op" id="1507185">.</span><span class="ident" id="1507186">tophash</span><span class="op" id="1507193">[</span><span class="ident" id="1507194">yi</span><span class="op" id="1507196">]</span>&nbsp;<span class="op" id="1507198">=</span>&nbsp;<span class="ident" id="1507200">top</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1507209">if</span>&nbsp;<span class="ident" id="1507212">t</span><span class="op" id="1507213">.</span><span class="ident" id="1507214">indirectkey</span>&nbsp;<span class="op" id="1507226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1507234">*</span><span class="op" id="1507235">(</span><span class="op" id="1507236">*</span><span class="ident" id="1507237">unsafe</span><span class="op" id="1507243">.</span><span class="ident" id="1507244">Pointer</span><span class="op" id="1507251">)</span><span class="op" id="1507252">(</span><span class="ident" id="1507253">yk</span><span class="op" id="1507255">)</span>&nbsp;<span class="op" id="1507257">=</span>&nbsp;<span class="ident" id="1507259">k2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1507267">}</span>&nbsp;<span class="keyword" id="1507269">else</span>&nbsp;<span class="op" id="1507274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507282">memmove</span><span class="op" id="1507289">(</span><span class="ident" id="1507290">yk</span><span class="op" id="1507292">,</span>&nbsp;<span class="ident" id="1507294">k</span><span class="op" id="1507295">,</span>&nbsp;<span class="builtintype" id="1507297">uintptr</span><span class="op" id="1507304">(</span><span class="ident" id="1507305">t</span><span class="op" id="1507306">.</span><span class="ident" id="1507307">key</span><span class="op" id="1507310">.</span><span class="ident" id="1507311">size</span><span class="op" id="1507315">)</span><span class="op" id="1507316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1507323">}</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1507330">if</span>&nbsp;<span class="ident" id="1507333">t</span><span class="op" id="1507334">.</span><span class="ident" id="1507335">indirectvalue</span>&nbsp;<span class="op" id="1507349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1507357">*</span><span class="op" id="1507358">(</span><span class="op" id="1507359">*</span><span class="ident" id="1507360">unsafe</span><span class="op" id="1507366">.</span><span class="ident" id="1507367">Pointer</span><span class="op" id="1507374">)</span><span class="op" id="1507375">(</span><span class="ident" id="1507376">yv</span><span class="op" id="1507378">)</span>&nbsp;<span class="op" id="1507380">=</span>&nbsp;<span class="op" id="1507382">*</span><span class="op" id="1507383">(</span><span class="op" id="1507384">*</span><span class="ident" id="1507385">unsafe</span><span class="op" id="1507391">.</span><span class="ident" id="1507392">Pointer</span><span class="op" id="1507399">)</span><span class="op" id="1507400">(</span><span class="ident" id="1507401">v</span><span class="op" id="1507402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1507409">}</span>&nbsp;<span class="keyword" id="1507411">else</span>&nbsp;<span class="op" id="1507416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507424">memmove</span><span class="op" id="1507431">(</span><span class="ident" id="1507432">yv</span><span class="op" id="1507434">,</span>&nbsp;<span class="ident" id="1507436">v</span><span class="op" id="1507437">,</span>&nbsp;<span class="builtintype" id="1507439">uintptr</span><span class="op" id="1507446">(</span><span class="ident" id="1507447">t</span><span class="op" id="1507448">.</span><span class="ident" id="1507449">elem</span><span class="op" id="1507453">.</span><span class="ident" id="1507454">size</span><span class="op" id="1507458">)</span><span class="op" id="1507459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1507466">}</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507473">yi</span><span class="op" id="1507475">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507483">yk</span>&nbsp;<span class="op" id="1507486">=</span>&nbsp;<span class="ident" id="1507488">add</span><span class="op" id="1507491">(</span><span class="ident" id="1507492">yk</span><span class="op" id="1507494">,</span>&nbsp;<span class="builtintype" id="1507496">uintptr</span><span class="op" id="1507503">(</span><span class="ident" id="1507504">t</span><span class="op" id="1507505">.</span><span class="ident" id="1507506">keysize</span><span class="op" id="1507513">)</span><span class="op" id="1507514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507521">yv</span>&nbsp;<span class="op" id="1507524">=</span>&nbsp;<span class="ident" id="1507526">add</span><span class="op" id="1507529">(</span><span class="ident" id="1507530">yv</span><span class="op" id="1507532">,</span>&nbsp;<span class="builtintype" id="1507534">uintptr</span><span class="op" id="1507541">(</span><span class="ident" id="1507542">t</span><span class="op" id="1507543">.</span><span class="ident" id="1507544">valuesize</span><span class="op" id="1507553">)</span><span class="op" id="1507554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1507560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1507565">}</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1507569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1507573">//&nbsp;Unlink&nbsp;the&nbsp;overflow&nbsp;buckets&nbsp;&amp;&nbsp;clear&nbsp;key/value&nbsp;to&nbsp;help&nbsp;GC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1507636">if</span>&nbsp;<span class="ident" id="1507639">h</span><span class="op" id="1507640">.</span><span class="ident" id="1507641">flags</span><span class="op" id="1507646">&amp;</span><span class="ident" id="1507647">oldIterator</span>&nbsp;<span class="op" id="1507659">==</span>&nbsp;<span class="num" id="1507662">0</span>&nbsp;<span class="op" id="1507664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507669">b</span>&nbsp;<span class="op" id="1507671">=</span>&nbsp;<span class="op" id="1507673">(</span><span class="op" id="1507674">*</span><span class="ident" id="1507675">bmap</span><span class="op" id="1507679">)</span><span class="op" id="1507680">(</span><span class="ident" id="1507681">add</span><span class="op" id="1507684">(</span><span class="ident" id="1507685">h</span><span class="op" id="1507686">.</span><span class="ident" id="1507687">oldbuckets</span><span class="op" id="1507697">,</span>&nbsp;<span class="ident" id="1507699">oldbucket</span><span class="op" id="1507708">*</span><span class="builtintype" id="1507709">uintptr</span><span class="op" id="1507716">(</span><span class="ident" id="1507717">t</span><span class="op" id="1507718">.</span><span class="ident" id="1507719">bucketsize</span><span class="op" id="1507729">)</span><span class="op" id="1507730">)</span><span class="op" id="1507731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507736">b</span><span class="op" id="1507737">.</span><span class="ident" id="1507738">overflow</span>&nbsp;<span class="op" id="1507747">=</span>&nbsp;<span class="ident" id="1507749">nil</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507756">memclr</span><span class="op" id="1507762">(</span><span class="ident" id="1507763">add</span><span class="op" id="1507766">(</span><span class="ident" id="1507767">unsafe</span><span class="op" id="1507773">.</span><span class="ident" id="1507774">Pointer</span><span class="op" id="1507781">(</span><span class="ident" id="1507782">b</span><span class="op" id="1507783">)</span><span class="op" id="1507784">,</span>&nbsp;<span class="ident" id="1507786">dataOffset</span><span class="op" id="1507796">)</span><span class="op" id="1507797">,</span>&nbsp;<span class="builtintype" id="1507799">uintptr</span><span class="op" id="1507806">(</span><span class="ident" id="1507807">t</span><span class="op" id="1507808">.</span><span class="ident" id="1507809">bucketsize</span><span class="op" id="1507819">)</span><span class="op" id="1507820">-</span><span class="ident" id="1507821">dataOffset</span><span class="op" id="1507831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1507835">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1507838">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1507842">//&nbsp;Advance&nbsp;evacuation&nbsp;mark</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1507870">if</span>&nbsp;<span class="ident" id="1507873">oldbucket</span>&nbsp;<span class="op" id="1507883">==</span>&nbsp;<span class="ident" id="1507886">h</span><span class="op" id="1507887">.</span><span class="ident" id="1507888">nevacuate</span>&nbsp;<span class="op" id="1507898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507902">h</span><span class="op" id="1507903">.</span><span class="ident" id="1507904">nevacuate</span>&nbsp;<span class="op" id="1507914">=</span>&nbsp;<span class="ident" id="1507916">oldbucket</span>&nbsp;<span class="op" id="1507926">+</span>&nbsp;<span class="num" id="1507928">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1507932">if</span>&nbsp;<span class="ident" id="1507935">oldbucket</span><span class="op" id="1507944">+</span><span class="num" id="1507945">1</span>&nbsp;<span class="op" id="1507947">==</span>&nbsp;<span class="ident" id="1507950">newbit</span>&nbsp;<span class="op" id="1507957">{</span>&nbsp;<span class="comment" id="1507959">//&nbsp;newbit&nbsp;==&nbsp;#&nbsp;of&nbsp;oldbuckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1507991">//&nbsp;Growing&nbsp;is&nbsp;all&nbsp;done.&nbsp;&nbsp;Free&nbsp;old&nbsp;main&nbsp;bucket&nbsp;array.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508047">h</span><span class="op" id="1508048">.</span><span class="ident" id="1508049">oldbuckets</span>&nbsp;<span class="op" id="1508060">=</span>&nbsp;<span class="ident" id="1508062">nil</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1508068">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1508071">}</span><br>
<span class="lineno"></span><span class="op" id="1508073">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1508076">func</span>&nbsp;<span class="ident" id="1508081">ismapkey</span><span class="op" id="1508089">(</span><span class="ident" id="1508090">t</span>&nbsp;<span class="op" id="1508092">*</span><span class="ident" id="1508093">_type</span><span class="op" id="1508098">)</span>&nbsp;<span class="builtintype" id="1508100">bool</span>&nbsp;<span class="op" id="1508105">{</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1508108">return</span>&nbsp;<span class="ident" id="1508115">goalg</span><span class="op" id="1508120">(</span><span class="ident" id="1508121">t</span><span class="op" id="1508122">.</span><span class="ident" id="1508123">alg</span><span class="op" id="1508126">)</span><span class="op" id="1508127">.</span><span class="ident" id="1508128">hash</span>&nbsp;<span class="op" id="1508133">!=</span>&nbsp;<span class="ident" id="1508136">nil</span><br>
<span class="lineno"></span><span class="op" id="1508140">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1508143">//&nbsp;Reflect&nbsp;stubs.&nbsp;&nbsp;Called&nbsp;from&nbsp;../reflect/asm_*.s</span><br>
<span class="lineno"></span><br>
<span class="lineno">905</span><span class="keyword" id="1508194">func</span>&nbsp;<span class="ident" id="1508199">reflect_makemap</span><span class="op" id="1508214">(</span><span class="ident" id="1508215">t</span>&nbsp;<span class="op" id="1508217">*</span><span class="ident" id="1508218">maptype</span><span class="op" id="1508225">)</span>&nbsp;<span class="op" id="1508227">*</span><span class="ident" id="1508228">hmap</span>&nbsp;<span class="op" id="1508233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1508236">return</span>&nbsp;<span class="ident" id="1508243">makemap</span><span class="op" id="1508250">(</span><span class="ident" id="1508251">t</span><span class="op" id="1508252">,</span>&nbsp;<span class="num" id="1508254">0</span><span class="op" id="1508255">)</span><br>
<span class="lineno"></span><span class="op" id="1508257">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1508260">func</span>&nbsp;<span class="ident" id="1508265">reflect_mapaccess</span><span class="op" id="1508282">(</span><span class="ident" id="1508283">t</span>&nbsp;<span class="op" id="1508285">*</span><span class="ident" id="1508286">maptype</span><span class="op" id="1508293">,</span>&nbsp;<span class="ident" id="1508295">h</span>&nbsp;<span class="op" id="1508297">*</span><span class="ident" id="1508298">hmap</span><span class="op" id="1508302">,</span>&nbsp;<span class="ident" id="1508304">key</span>&nbsp;<span class="ident" id="1508308">unsafe</span><span class="op" id="1508314">.</span><span class="ident" id="1508315">Pointer</span><span class="op" id="1508322">)</span>&nbsp;<span class="ident" id="1508324">unsafe</span><span class="op" id="1508330">.</span><span class="ident" id="1508331">Pointer</span>&nbsp;<span class="op" id="1508339">{</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508342">val</span><span class="op" id="1508345">,</span>&nbsp;<span class="ident" id="1508347">ok</span>&nbsp;<span class="op" id="1508350">:=</span>&nbsp;<span class="ident" id="1508353">mapaccess2</span><span class="op" id="1508363">(</span><span class="ident" id="1508364">t</span><span class="op" id="1508365">,</span>&nbsp;<span class="ident" id="1508367">h</span><span class="op" id="1508368">,</span>&nbsp;<span class="ident" id="1508370">key</span><span class="op" id="1508373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1508376">if</span>&nbsp;<span class="op" id="1508379">!</span><span class="ident" id="1508380">ok</span>&nbsp;<span class="op" id="1508383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1508387">//&nbsp;reflect&nbsp;wants&nbsp;nil&nbsp;for&nbsp;a&nbsp;missing&nbsp;element</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508432">val</span>&nbsp;<span class="op" id="1508436">=</span>&nbsp;<span class="ident" id="1508438">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1508443">}</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1508446">return</span>&nbsp;<span class="ident" id="1508453">val</span><br>
<span class="lineno"></span><span class="op" id="1508457">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1508460">func</span>&nbsp;<span class="ident" id="1508465">reflect_mapassign</span><span class="op" id="1508482">(</span><span class="ident" id="1508483">t</span>&nbsp;<span class="op" id="1508485">*</span><span class="ident" id="1508486">maptype</span><span class="op" id="1508493">,</span>&nbsp;<span class="ident" id="1508495">h</span>&nbsp;<span class="op" id="1508497">*</span><span class="ident" id="1508498">hmap</span><span class="op" id="1508502">,</span>&nbsp;<span class="ident" id="1508504">key</span>&nbsp;<span class="ident" id="1508508">unsafe</span><span class="op" id="1508514">.</span><span class="ident" id="1508515">Pointer</span><span class="op" id="1508522">,</span>&nbsp;<span class="ident" id="1508524">val</span>&nbsp;<span class="ident" id="1508528">unsafe</span><span class="op" id="1508534">.</span><span class="ident" id="1508535">Pointer</span><span class="op" id="1508542">)</span>&nbsp;<span class="op" id="1508544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508547">mapassign1</span><span class="op" id="1508557">(</span><span class="ident" id="1508558">t</span><span class="op" id="1508559">,</span>&nbsp;<span class="ident" id="1508561">h</span><span class="op" id="1508562">,</span>&nbsp;<span class="ident" id="1508564">key</span><span class="op" id="1508567">,</span>&nbsp;<span class="ident" id="1508569">val</span><span class="op" id="1508572">)</span><br>
<span class="lineno">920</span><span class="op" id="1508574">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1508577">func</span>&nbsp;<span class="ident" id="1508582">reflect_mapdelete</span><span class="op" id="1508599">(</span><span class="ident" id="1508600">t</span>&nbsp;<span class="op" id="1508602">*</span><span class="ident" id="1508603">maptype</span><span class="op" id="1508610">,</span>&nbsp;<span class="ident" id="1508612">h</span>&nbsp;<span class="op" id="1508614">*</span><span class="ident" id="1508615">hmap</span><span class="op" id="1508619">,</span>&nbsp;<span class="ident" id="1508621">key</span>&nbsp;<span class="ident" id="1508625">unsafe</span><span class="op" id="1508631">.</span><span class="ident" id="1508632">Pointer</span><span class="op" id="1508639">)</span>&nbsp;<span class="op" id="1508641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508644">mapdelete</span><span class="op" id="1508653">(</span><span class="ident" id="1508654">t</span><span class="op" id="1508655">,</span>&nbsp;<span class="ident" id="1508657">h</span><span class="op" id="1508658">,</span>&nbsp;<span class="ident" id="1508660">key</span><span class="op" id="1508663">)</span><br>
<span class="lineno"></span><span class="op" id="1508665">}</span><br>
<span class="lineno">925</span><br>
<span class="lineno"></span><span class="keyword" id="1508668">func</span>&nbsp;<span class="ident" id="1508673">reflect_mapiterinit</span><span class="op" id="1508692">(</span><span class="ident" id="1508693">t</span>&nbsp;<span class="op" id="1508695">*</span><span class="ident" id="1508696">maptype</span><span class="op" id="1508703">,</span>&nbsp;<span class="ident" id="1508705">h</span>&nbsp;<span class="op" id="1508707">*</span><span class="ident" id="1508708">hmap</span><span class="op" id="1508712">)</span>&nbsp;<span class="op" id="1508714">*</span><span class="ident" id="1508715">hiter</span>&nbsp;<span class="op" id="1508721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508724">it</span>&nbsp;<span class="op" id="1508727">:=</span>&nbsp;<span class="builtinfunc" id="1508730">new</span><span class="op" id="1508733">(</span><span class="ident" id="1508734">hiter</span><span class="op" id="1508739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508742">mapiterinit</span><span class="op" id="1508753">(</span><span class="ident" id="1508754">t</span><span class="op" id="1508755">,</span>&nbsp;<span class="ident" id="1508757">h</span><span class="op" id="1508758">,</span>&nbsp;<span class="ident" id="1508760">it</span><span class="op" id="1508762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1508765">return</span>&nbsp;<span class="ident" id="1508772">it</span><br>
<span class="lineno">930</span><span class="op" id="1508775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1508778">func</span>&nbsp;<span class="ident" id="1508783">reflect_mapiternext</span><span class="op" id="1508802">(</span><span class="ident" id="1508803">it</span>&nbsp;<span class="op" id="1508806">*</span><span class="ident" id="1508807">hiter</span><span class="op" id="1508812">)</span>&nbsp;<span class="op" id="1508814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508817">mapiternext</span><span class="op" id="1508828">(</span><span class="ident" id="1508829">it</span><span class="op" id="1508831">)</span><br>
<span class="lineno"></span><span class="op" id="1508833">}</span><br>
<span class="lineno">935</span><br>
<span class="lineno"></span><span class="keyword" id="1508836">func</span>&nbsp;<span class="ident" id="1508841">reflect_mapiterkey</span><span class="op" id="1508859">(</span><span class="ident" id="1508860">it</span>&nbsp;<span class="op" id="1508863">*</span><span class="ident" id="1508864">hiter</span><span class="op" id="1508869">)</span>&nbsp;<span class="ident" id="1508871">unsafe</span><span class="op" id="1508877">.</span><span class="ident" id="1508878">Pointer</span>&nbsp;<span class="op" id="1508886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1508889">return</span>&nbsp;<span class="ident" id="1508896">it</span><span class="op" id="1508898">.</span><span class="ident" id="1508899">key</span><br>
<span class="lineno"></span><span class="op" id="1508903">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">940</span><span class="keyword" id="1508906">func</span>&nbsp;<span class="ident" id="1508911">reflect_maplen</span><span class="op" id="1508925">(</span><span class="ident" id="1508926">h</span>&nbsp;<span class="op" id="1508928">*</span><span class="ident" id="1508929">hmap</span><span class="op" id="1508933">)</span>&nbsp;<span class="builtintype" id="1508935">int</span>&nbsp;<span class="op" id="1508939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1508942">if</span>&nbsp;<span class="ident" id="1508945">h</span>&nbsp;<span class="op" id="1508947">==</span>&nbsp;<span class="ident" id="1508950">nil</span>&nbsp;<span class="op" id="1508954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1508958">return</span>&nbsp;<span class="num" id="1508965">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1508968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1508971">if</span>&nbsp;<span class="ident" id="1508974">raceenabled</span>&nbsp;<span class="op" id="1508986">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508990">callerpc</span>&nbsp;<span class="op" id="1508999">:=</span>&nbsp;<span class="ident" id="1509002">getcallerpc</span><span class="op" id="1509013">(</span><span class="ident" id="1509014">unsafe</span><span class="op" id="1509020">.</span><span class="ident" id="1509021">Pointer</span><span class="op" id="1509028">(</span><span class="op" id="1509029">&amp;</span><span class="ident" id="1509030">h</span><span class="op" id="1509031">)</span><span class="op" id="1509032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509036">racereadpc</span><span class="op" id="1509046">(</span><span class="ident" id="1509047">unsafe</span><span class="op" id="1509053">.</span><span class="ident" id="1509054">Pointer</span><span class="op" id="1509061">(</span><span class="ident" id="1509062">h</span><span class="op" id="1509063">)</span><span class="op" id="1509064">,</span>&nbsp;<span class="ident" id="1509066">callerpc</span><span class="op" id="1509074">,</span>&nbsp;<span class="ident" id="1509076">funcPC</span><span class="op" id="1509082">(</span><span class="ident" id="1509083">reflect_maplen</span><span class="op" id="1509097">)</span><span class="op" id="1509098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1509101">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1509104">return</span>&nbsp;<span class="ident" id="1509111">h</span><span class="op" id="1509112">.</span><span class="ident" id="1509113">count</span><br>
<span class="lineno"></span><span class="op" id="1509119">}</span><br>
<span class="lineno">950</span><br>
<span class="lineno"></span><span class="keyword" id="1509122">func</span>&nbsp;<span class="ident" id="1509127">reflect_ismapkey</span><span class="op" id="1509143">(</span><span class="ident" id="1509144">t</span>&nbsp;<span class="op" id="1509146">*</span><span class="ident" id="1509147">_type</span><span class="op" id="1509152">)</span>&nbsp;<span class="builtintype" id="1509154">bool</span>&nbsp;<span class="op" id="1509159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1509162">return</span>&nbsp;<span class="ident" id="1509169">ismapkey</span><span class="op" id="1509177">(</span><span class="ident" id="1509178">t</span><span class="op" id="1509179">)</span><br>
<span class="lineno"></span><span class="op" id="1509181">}</span>
</div>
</body>
</html>
