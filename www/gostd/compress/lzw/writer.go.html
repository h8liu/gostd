<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="5345935">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5345990">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5346044">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5346095">package</span>&nbsp;<span class="ident" id="5346103">lzw</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5346108">import</span>&nbsp;<span class="op" id="5346115">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5346118">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5346127">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5346137">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5346144">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="5346149">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5346152">//&nbsp;A&nbsp;writer&nbsp;is&nbsp;a&nbsp;buffered,&nbsp;flushable&nbsp;writer.</span><br>
<span class="lineno">15</span><span class="keyword" id="5346197">type</span>&nbsp;<span class="ident" id="5346202">writer</span>&nbsp;<span class="keyword" id="5346209">interface</span>&nbsp;<span class="op" id="5346219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5346222">io</span><span class="op" id="5346224">.</span><span class="ident" id="5346225">ByteWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5346237">Flush</span><span class="op" id="5346242">(</span><span class="op" id="5346243">)</span>&nbsp;<span class="builtintype" id="5346245">error</span><br>
<span class="lineno"></span><span class="op" id="5346251">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="5346254">//&nbsp;An&nbsp;errWriteCloser&nbsp;is&nbsp;an&nbsp;io.WriteCloser&nbsp;that&nbsp;always&nbsp;returns&nbsp;a&nbsp;given&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="5346331">type</span>&nbsp;<span class="ident" id="5346336">errWriteCloser</span>&nbsp;<span class="keyword" id="5346351">struct</span>&nbsp;<span class="op" id="5346358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5346361">err</span>&nbsp;<span class="builtintype" id="5346365">error</span><br>
<span class="lineno"></span><span class="op" id="5346371">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="5346374">func</span>&nbsp;<span class="op" id="5346379">(</span><span class="ident" id="5346380">e</span>&nbsp;<span class="op" id="5346382">*</span><span class="ident" id="5346383">errWriteCloser</span><span class="op" id="5346397">)</span>&nbsp;<span class="ident" id="5346399">Write</span><span class="op" id="5346404">(</span><span class="op" id="5346405">[</span><span class="op" id="5346406">]</span><span class="builtintype" id="5346407">byte</span><span class="op" id="5346411">)</span>&nbsp;<span class="op" id="5346413">(</span><span class="builtintype" id="5346414">int</span><span class="op" id="5346417">,</span>&nbsp;<span class="builtintype" id="5346419">error</span><span class="op" id="5346424">)</span>&nbsp;<span class="op" id="5346426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5346429">return</span>&nbsp;<span class="num" id="5346436">0</span><span class="op" id="5346437">,</span>&nbsp;<span class="ident" id="5346439">e</span><span class="op" id="5346440">.</span><span class="ident" id="5346441">err</span><br>
<span class="lineno"></span><span class="op" id="5346445">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5346448">func</span>&nbsp;<span class="op" id="5346453">(</span><span class="ident" id="5346454">e</span>&nbsp;<span class="op" id="5346456">*</span><span class="ident" id="5346457">errWriteCloser</span><span class="op" id="5346471">)</span>&nbsp;<span class="ident" id="5346473">Close</span><span class="op" id="5346478">(</span><span class="op" id="5346479">)</span>&nbsp;<span class="builtintype" id="5346481">error</span>&nbsp;<span class="op" id="5346487">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5346490">return</span>&nbsp;<span class="ident" id="5346497">e</span><span class="op" id="5346498">.</span><span class="ident" id="5346499">err</span><br>
<span class="lineno"></span><span class="op" id="5346503">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5346506">const</span>&nbsp;<span class="op" id="5346512">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5346515">//&nbsp;A&nbsp;code&nbsp;is&nbsp;a&nbsp;12&nbsp;bit&nbsp;value,&nbsp;stored&nbsp;as&nbsp;a&nbsp;uint32&nbsp;when&nbsp;encoding&nbsp;to&nbsp;avoid</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5346587">//&nbsp;type&nbsp;conversions&nbsp;when&nbsp;shifting&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5346628">maxCode</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5346640">=</span>&nbsp;<span class="num" id="5346642">1</span><span class="op" id="5346643">&lt;&lt;</span><span class="num" id="5346645">12</span>&nbsp;<span class="op" id="5346648">-</span>&nbsp;<span class="num" id="5346650">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5346653">invalidCode</span>&nbsp;<span class="op" id="5346665">=</span>&nbsp;<span class="num" id="5346667">1</span><span class="op" id="5346668">&lt;&lt;</span><span class="num" id="5346670">32</span>&nbsp;<span class="op" id="5346673">-</span>&nbsp;<span class="num" id="5346675">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5346678">//&nbsp;There&nbsp;are&nbsp;1&lt;&lt;12&nbsp;possible&nbsp;codes,&nbsp;which&nbsp;is&nbsp;an&nbsp;upper&nbsp;bound&nbsp;on&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5346755">//&nbsp;valid&nbsp;hash&nbsp;table&nbsp;entries&nbsp;at&nbsp;any&nbsp;given&nbsp;point&nbsp;in&nbsp;time.&nbsp;tableSize&nbsp;is&nbsp;4x&nbsp;that.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5346834">tableSize</span>&nbsp;<span class="op" id="5346844">=</span>&nbsp;<span class="num" id="5346846">4</span>&nbsp;<span class="op" id="5346848">*</span>&nbsp;<span class="num" id="5346850">1</span>&nbsp;<span class="op" id="5346852">&lt;&lt;</span>&nbsp;<span class="num" id="5346855">12</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5346859">tableMask</span>&nbsp;<span class="op" id="5346869">=</span>&nbsp;<span class="ident" id="5346871">tableSize</span>&nbsp;<span class="op" id="5346881">-</span>&nbsp;<span class="num" id="5346883">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5346886">//&nbsp;A&nbsp;hash&nbsp;table&nbsp;entry&nbsp;is&nbsp;a&nbsp;uint32.&nbsp;Zero&nbsp;is&nbsp;an&nbsp;invalid&nbsp;entry&nbsp;since&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5346957">//&nbsp;lower&nbsp;12&nbsp;bits&nbsp;of&nbsp;a&nbsp;valid&nbsp;entry&nbsp;must&nbsp;be&nbsp;a&nbsp;non-literal&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5347020">invalidEntry</span>&nbsp;<span class="op" id="5347033">=</span>&nbsp;<span class="num" id="5347035">0</span><br>
<span class="lineno">45</span><span class="op" id="5347037">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5347040">//&nbsp;encoder&nbsp;is&nbsp;LZW&nbsp;compressor.</span><br>
<span class="lineno"></span><span class="keyword" id="5347070">type</span>&nbsp;<span class="ident" id="5347075">encoder</span>&nbsp;<span class="keyword" id="5347083">struct</span>&nbsp;<span class="op" id="5347090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5347093">//&nbsp;w&nbsp;is&nbsp;the&nbsp;writer&nbsp;that&nbsp;compressed&nbsp;bytes&nbsp;are&nbsp;written&nbsp;to.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5347151">w</span>&nbsp;<span class="ident" id="5347153">writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5347161">//&nbsp;order,&nbsp;write,&nbsp;bits,&nbsp;nBits&nbsp;and&nbsp;width&nbsp;are&nbsp;the&nbsp;state&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5347219">//&nbsp;converting&nbsp;a&nbsp;code&nbsp;stream&nbsp;into&nbsp;a&nbsp;byte&nbsp;stream.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5347268">order</span>&nbsp;<span class="ident" id="5347274">Order</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5347281">write</span>&nbsp;<span class="keyword" id="5347287">func</span><span class="op" id="5347291">(</span><span class="op" id="5347292">*</span><span class="ident" id="5347293">encoder</span><span class="op" id="5347300">,</span>&nbsp;<span class="builtintype" id="5347302">uint32</span><span class="op" id="5347308">)</span>&nbsp;<span class="builtintype" id="5347310">error</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5347317">bits</span>&nbsp;&nbsp;<span class="builtintype" id="5347323">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5347331">nBits</span>&nbsp;<span class="builtintype" id="5347337">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5347343">width</span>&nbsp;<span class="builtintype" id="5347349">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5347355">//&nbsp;litWidth&nbsp;is&nbsp;the&nbsp;width&nbsp;in&nbsp;bits&nbsp;of&nbsp;literal&nbsp;codes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5347407">litWidth</span>&nbsp;<span class="builtintype" id="5347416">uint</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5347422">//&nbsp;hi&nbsp;is&nbsp;the&nbsp;code&nbsp;implied&nbsp;by&nbsp;the&nbsp;next&nbsp;code&nbsp;emission.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5347476">//&nbsp;overflow&nbsp;is&nbsp;the&nbsp;code&nbsp;at&nbsp;which&nbsp;hi&nbsp;overflows&nbsp;the&nbsp;code&nbsp;width.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5347539">hi</span><span class="op" id="5347541">,</span>&nbsp;<span class="ident" id="5347543">overflow</span>&nbsp;<span class="builtintype" id="5347552">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5347560">//&nbsp;savedCode&nbsp;is&nbsp;the&nbsp;accumulated&nbsp;code&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;most&nbsp;recent&nbsp;Write</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5347634">//&nbsp;call.&nbsp;It&nbsp;is&nbsp;equal&nbsp;to&nbsp;invalidCode&nbsp;if&nbsp;there&nbsp;was&nbsp;no&nbsp;such&nbsp;call.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5347698">savedCode</span>&nbsp;<span class="builtintype" id="5347708">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5347716">//&nbsp;err&nbsp;is&nbsp;the&nbsp;first&nbsp;error&nbsp;encountered&nbsp;during&nbsp;writing.&nbsp;Closing&nbsp;the&nbsp;encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5347791">//&nbsp;will&nbsp;make&nbsp;any&nbsp;future&nbsp;Write&nbsp;calls&nbsp;return&nbsp;errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5347845">err</span>&nbsp;<span class="builtintype" id="5347849">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5347856">//&nbsp;table&nbsp;is&nbsp;the&nbsp;hash&nbsp;table&nbsp;from&nbsp;20-bit&nbsp;keys&nbsp;to&nbsp;12-bit&nbsp;values.&nbsp;Each&nbsp;table</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5347930">//&nbsp;entry&nbsp;contains&nbsp;key&lt;&lt;12|val&nbsp;and&nbsp;collisions&nbsp;resolve&nbsp;by&nbsp;linear&nbsp;probing.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5348003">//&nbsp;The&nbsp;keys&nbsp;consist&nbsp;of&nbsp;a&nbsp;12-bit&nbsp;code&nbsp;prefix&nbsp;and&nbsp;an&nbsp;8-bit&nbsp;byte&nbsp;suffix.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5348074">//&nbsp;The&nbsp;values&nbsp;are&nbsp;a&nbsp;12-bit&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5348108">table</span>&nbsp;<span class="op" id="5348114">[</span><span class="ident" id="5348115">tableSize</span><span class="op" id="5348124">]</span><span class="builtintype" id="5348125">uint32</span><br>
<span class="lineno"></span><span class="op" id="5348132">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="comment" id="5348135">//&nbsp;writeLSB&nbsp;writes&nbsp;the&nbsp;code&nbsp;c&nbsp;for&nbsp;&#34;Least&nbsp;Significant&nbsp;Bits&nbsp;first&#34;&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="5348206">func</span>&nbsp;<span class="op" id="5348211">(</span><span class="ident" id="5348212">e</span>&nbsp;<span class="op" id="5348214">*</span><span class="ident" id="5348215">encoder</span><span class="op" id="5348222">)</span>&nbsp;<span class="ident" id="5348224">writeLSB</span><span class="op" id="5348232">(</span><span class="ident" id="5348233">c</span>&nbsp;<span class="builtintype" id="5348235">uint32</span><span class="op" id="5348241">)</span>&nbsp;<span class="builtintype" id="5348243">error</span>&nbsp;<span class="op" id="5348249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5348252">e</span><span class="op" id="5348253">.</span><span class="ident" id="5348254">bits</span>&nbsp;<span class="op" id="5348259">|=</span>&nbsp;<span class="ident" id="5348262">c</span>&nbsp;<span class="op" id="5348264">&lt;&lt;</span>&nbsp;<span class="ident" id="5348267">e</span><span class="op" id="5348268">.</span><span class="ident" id="5348269">nBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5348276">e</span><span class="op" id="5348277">.</span><span class="ident" id="5348278">nBits</span>&nbsp;<span class="op" id="5348284">+=</span>&nbsp;<span class="ident" id="5348287">e</span><span class="op" id="5348288">.</span><span class="ident" id="5348289">width</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5348296">for</span>&nbsp;<span class="ident" id="5348300">e</span><span class="op" id="5348301">.</span><span class="ident" id="5348302">nBits</span>&nbsp;<span class="op" id="5348308">&gt;=</span>&nbsp;<span class="num" id="5348311">8</span>&nbsp;<span class="op" id="5348313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5348317">if</span>&nbsp;<span class="ident" id="5348320">err</span>&nbsp;<span class="op" id="5348324">:=</span>&nbsp;<span class="ident" id="5348327">e</span><span class="op" id="5348328">.</span><span class="ident" id="5348329">w</span><span class="op" id="5348330">.</span><span class="ident" id="5348331">WriteByte</span><span class="op" id="5348340">(</span><span class="builtintype" id="5348341">uint8</span><span class="op" id="5348346">(</span><span class="ident" id="5348347">e</span><span class="op" id="5348348">.</span><span class="ident" id="5348349">bits</span><span class="op" id="5348353">)</span><span class="op" id="5348354">)</span><span class="op" id="5348355">;</span>&nbsp;<span class="ident" id="5348357">err</span>&nbsp;<span class="op" id="5348361">!=</span>&nbsp;<span class="ident" id="5348364">nil</span>&nbsp;<span class="op" id="5348368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5348373">return</span>&nbsp;<span class="ident" id="5348380">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5348386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5348390">e</span><span class="op" id="5348391">.</span><span class="ident" id="5348392">bits</span>&nbsp;<span class="op" id="5348397">&gt;&gt;=</span>&nbsp;<span class="num" id="5348401">8</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5348405">e</span><span class="op" id="5348406">.</span><span class="ident" id="5348407">nBits</span>&nbsp;<span class="op" id="5348413">-=</span>&nbsp;<span class="num" id="5348416">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5348419">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5348422">return</span>&nbsp;<span class="ident" id="5348429">nil</span><br>
<span class="lineno"></span><span class="op" id="5348433">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="5348436">//&nbsp;writeMSB&nbsp;writes&nbsp;the&nbsp;code&nbsp;c&nbsp;for&nbsp;&#34;Most&nbsp;Significant&nbsp;Bits&nbsp;first&#34;&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="5348506">func</span>&nbsp;<span class="op" id="5348511">(</span><span class="ident" id="5348512">e</span>&nbsp;<span class="op" id="5348514">*</span><span class="ident" id="5348515">encoder</span><span class="op" id="5348522">)</span>&nbsp;<span class="ident" id="5348524">writeMSB</span><span class="op" id="5348532">(</span><span class="ident" id="5348533">c</span>&nbsp;<span class="builtintype" id="5348535">uint32</span><span class="op" id="5348541">)</span>&nbsp;<span class="builtintype" id="5348543">error</span>&nbsp;<span class="op" id="5348549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5348552">e</span><span class="op" id="5348553">.</span><span class="ident" id="5348554">bits</span>&nbsp;<span class="op" id="5348559">|=</span>&nbsp;<span class="ident" id="5348562">c</span>&nbsp;<span class="op" id="5348564">&lt;&lt;</span>&nbsp;<span class="op" id="5348567">(</span><span class="num" id="5348568">32</span>&nbsp;<span class="op" id="5348571">-</span>&nbsp;<span class="ident" id="5348573">e</span><span class="op" id="5348574">.</span><span class="ident" id="5348575">width</span>&nbsp;<span class="op" id="5348581">-</span>&nbsp;<span class="ident" id="5348583">e</span><span class="op" id="5348584">.</span><span class="ident" id="5348585">nBits</span><span class="op" id="5348590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5348593">e</span><span class="op" id="5348594">.</span><span class="ident" id="5348595">nBits</span>&nbsp;<span class="op" id="5348601">+=</span>&nbsp;<span class="ident" id="5348604">e</span><span class="op" id="5348605">.</span><span class="ident" id="5348606">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5348613">for</span>&nbsp;<span class="ident" id="5348617">e</span><span class="op" id="5348618">.</span><span class="ident" id="5348619">nBits</span>&nbsp;<span class="op" id="5348625">&gt;=</span>&nbsp;<span class="num" id="5348628">8</span>&nbsp;<span class="op" id="5348630">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5348634">if</span>&nbsp;<span class="ident" id="5348637">err</span>&nbsp;<span class="op" id="5348641">:=</span>&nbsp;<span class="ident" id="5348644">e</span><span class="op" id="5348645">.</span><span class="ident" id="5348646">w</span><span class="op" id="5348647">.</span><span class="ident" id="5348648">WriteByte</span><span class="op" id="5348657">(</span><span class="builtintype" id="5348658">uint8</span><span class="op" id="5348663">(</span><span class="ident" id="5348664">e</span><span class="op" id="5348665">.</span><span class="ident" id="5348666">bits</span>&nbsp;<span class="op" id="5348671">&gt;&gt;</span>&nbsp;<span class="num" id="5348674">24</span><span class="op" id="5348676">)</span><span class="op" id="5348677">)</span><span class="op" id="5348678">;</span>&nbsp;<span class="ident" id="5348680">err</span>&nbsp;<span class="op" id="5348684">!=</span>&nbsp;<span class="ident" id="5348687">nil</span>&nbsp;<span class="op" id="5348691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5348696">return</span>&nbsp;<span class="ident" id="5348703">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5348709">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5348713">e</span><span class="op" id="5348714">.</span><span class="ident" id="5348715">bits</span>&nbsp;<span class="op" id="5348720">&lt;&lt;=</span>&nbsp;<span class="num" id="5348724">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5348728">e</span><span class="op" id="5348729">.</span><span class="ident" id="5348730">nBits</span>&nbsp;<span class="op" id="5348736">-=</span>&nbsp;<span class="num" id="5348739">8</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5348742">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5348745">return</span>&nbsp;<span class="ident" id="5348752">nil</span><br>
<span class="lineno"></span><span class="op" id="5348756">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5348759">//&nbsp;errOutOfCodes&nbsp;is&nbsp;an&nbsp;internal&nbsp;error&nbsp;that&nbsp;means&nbsp;that&nbsp;the&nbsp;encoder&nbsp;has&nbsp;run&nbsp;out</span><br>
<span class="lineno">105</span><span class="comment" id="5348837">//&nbsp;of&nbsp;unused&nbsp;codes&nbsp;and&nbsp;a&nbsp;clear&nbsp;code&nbsp;needs&nbsp;to&nbsp;be&nbsp;sent&nbsp;next.</span><br>
<span class="lineno"></span><span class="keyword" id="5348896">var</span>&nbsp;<span class="ident" id="5348900">errOutOfCodes</span>&nbsp;<span class="op" id="5348914">=</span>&nbsp;<span class="ident" id="5348916">errors</span><span class="op" id="5348922">.</span><span class="ident" id="5348923">New</span><span class="op" id="5348926">(</span><span class="string" id="5348927">&#34;lzw:&nbsp;out&nbsp;of&nbsp;codes&#34;</span><span class="op" id="5348946">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5348949">//&nbsp;incHi&nbsp;increments&nbsp;e.hi&nbsp;and&nbsp;checks&nbsp;for&nbsp;both&nbsp;overflow&nbsp;and&nbsp;running&nbsp;out&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5349022">//&nbsp;unused&nbsp;codes.&nbsp;In&nbsp;the&nbsp;latter&nbsp;case,&nbsp;incHi&nbsp;sends&nbsp;a&nbsp;clear&nbsp;code,&nbsp;resets&nbsp;the</span><br>
<span class="lineno">110</span><span class="comment" id="5349096">//&nbsp;encoder&nbsp;state&nbsp;and&nbsp;returns&nbsp;errOutOfCodes.</span><br>
<span class="lineno"></span><span class="keyword" id="5349140">func</span>&nbsp;<span class="op" id="5349145">(</span><span class="ident" id="5349146">e</span>&nbsp;<span class="op" id="5349148">*</span><span class="ident" id="5349149">encoder</span><span class="op" id="5349156">)</span>&nbsp;<span class="ident" id="5349158">incHi</span><span class="op" id="5349163">(</span><span class="op" id="5349164">)</span>&nbsp;<span class="builtintype" id="5349166">error</span>&nbsp;<span class="op" id="5349172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5349175">e</span><span class="op" id="5349176">.</span><span class="ident" id="5349177">hi</span><span class="op" id="5349179">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5349183">if</span>&nbsp;<span class="ident" id="5349186">e</span><span class="op" id="5349187">.</span><span class="ident" id="5349188">hi</span>&nbsp;<span class="op" id="5349191">==</span>&nbsp;<span class="ident" id="5349194">e</span><span class="op" id="5349195">.</span><span class="ident" id="5349196">overflow</span>&nbsp;<span class="op" id="5349205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5349209">e</span><span class="op" id="5349210">.</span><span class="ident" id="5349211">width</span><span class="op" id="5349216">++</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5349221">e</span><span class="op" id="5349222">.</span><span class="ident" id="5349223">overflow</span>&nbsp;<span class="op" id="5349232">&lt;&lt;=</span>&nbsp;<span class="num" id="5349236">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5349239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5349242">if</span>&nbsp;<span class="ident" id="5349245">e</span><span class="op" id="5349246">.</span><span class="ident" id="5349247">hi</span>&nbsp;<span class="op" id="5349250">==</span>&nbsp;<span class="ident" id="5349253">maxCode</span>&nbsp;<span class="op" id="5349261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5349265">clear</span>&nbsp;<span class="op" id="5349271">:=</span>&nbsp;<span class="builtintype" id="5349274">uint32</span><span class="op" id="5349280">(</span><span class="num" id="5349281">1</span><span class="op" id="5349282">)</span>&nbsp;<span class="op" id="5349284">&lt;&lt;</span>&nbsp;<span class="ident" id="5349287">e</span><span class="op" id="5349288">.</span><span class="ident" id="5349289">litWidth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5349300">if</span>&nbsp;<span class="ident" id="5349303">err</span>&nbsp;<span class="op" id="5349307">:=</span>&nbsp;<span class="ident" id="5349310">e</span><span class="op" id="5349311">.</span><span class="ident" id="5349312">write</span><span class="op" id="5349317">(</span><span class="ident" id="5349318">e</span><span class="op" id="5349319">,</span>&nbsp;<span class="ident" id="5349321">clear</span><span class="op" id="5349326">)</span><span class="op" id="5349327">;</span>&nbsp;<span class="ident" id="5349329">err</span>&nbsp;<span class="op" id="5349333">!=</span>&nbsp;<span class="ident" id="5349336">nil</span>&nbsp;<span class="op" id="5349340">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5349345">return</span>&nbsp;<span class="ident" id="5349352">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5349358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5349362">e</span><span class="op" id="5349363">.</span><span class="ident" id="5349364">width</span>&nbsp;<span class="op" id="5349370">=</span>&nbsp;<span class="builtintype" id="5349372">uint</span><span class="op" id="5349376">(</span><span class="ident" id="5349377">e</span><span class="op" id="5349378">.</span><span class="ident" id="5349379">litWidth</span><span class="op" id="5349387">)</span>&nbsp;<span class="op" id="5349389">+</span>&nbsp;<span class="num" id="5349391">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5349395">e</span><span class="op" id="5349396">.</span><span class="ident" id="5349397">hi</span>&nbsp;<span class="op" id="5349400">=</span>&nbsp;<span class="ident" id="5349402">clear</span>&nbsp;<span class="op" id="5349408">+</span>&nbsp;<span class="num" id="5349410">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5349414">e</span><span class="op" id="5349415">.</span><span class="ident" id="5349416">overflow</span>&nbsp;<span class="op" id="5349425">=</span>&nbsp;<span class="ident" id="5349427">clear</span>&nbsp;<span class="op" id="5349433">&lt;&lt;</span>&nbsp;<span class="num" id="5349436">1</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5349440">for</span>&nbsp;<span class="ident" id="5349444">i</span>&nbsp;<span class="op" id="5349446">:=</span>&nbsp;<span class="keyword" id="5349449">range</span>&nbsp;<span class="ident" id="5349455">e</span><span class="op" id="5349456">.</span><span class="ident" id="5349457">table</span>&nbsp;<span class="op" id="5349463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5349468">e</span><span class="op" id="5349469">.</span><span class="ident" id="5349470">table</span><span class="op" id="5349475">[</span><span class="ident" id="5349476">i</span><span class="op" id="5349477">]</span>&nbsp;<span class="op" id="5349479">=</span>&nbsp;<span class="ident" id="5349481">invalidEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5349496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5349500">return</span>&nbsp;<span class="ident" id="5349507">errOutOfCodes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5349522">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5349525">return</span>&nbsp;<span class="ident" id="5349532">nil</span><br>
<span class="lineno"></span><span class="op" id="5349536">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5349539">//&nbsp;Write&nbsp;writes&nbsp;a&nbsp;compressed&nbsp;representation&nbsp;of&nbsp;p&nbsp;to&nbsp;e&#39;s&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5349614">func</span>&nbsp;<span class="op" id="5349619">(</span><span class="ident" id="5349620">e</span>&nbsp;<span class="op" id="5349622">*</span><span class="ident" id="5349623">encoder</span><span class="op" id="5349630">)</span>&nbsp;<span class="ident" id="5349632">Write</span><span class="op" id="5349637">(</span><span class="ident" id="5349638">p</span>&nbsp;<span class="op" id="5349640">[</span><span class="op" id="5349641">]</span><span class="builtintype" id="5349642">byte</span><span class="op" id="5349646">)</span>&nbsp;<span class="op" id="5349648">(</span><span class="ident" id="5349649">n</span>&nbsp;<span class="builtintype" id="5349651">int</span><span class="op" id="5349654">,</span>&nbsp;<span class="ident" id="5349656">err</span>&nbsp;<span class="builtintype" id="5349660">error</span><span class="op" id="5349665">)</span>&nbsp;<span class="op" id="5349667">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5349670">if</span>&nbsp;<span class="ident" id="5349673">e</span><span class="op" id="5349674">.</span><span class="ident" id="5349675">err</span>&nbsp;<span class="op" id="5349679">!=</span>&nbsp;<span class="ident" id="5349682">nil</span>&nbsp;<span class="op" id="5349686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5349690">return</span>&nbsp;<span class="num" id="5349697">0</span><span class="op" id="5349698">,</span>&nbsp;<span class="ident" id="5349700">e</span><span class="op" id="5349701">.</span><span class="ident" id="5349702">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5349707">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5349710">if</span>&nbsp;<span class="builtinfunc" id="5349713">len</span><span class="op" id="5349716">(</span><span class="ident" id="5349717">p</span><span class="op" id="5349718">)</span>&nbsp;<span class="op" id="5349720">==</span>&nbsp;<span class="num" id="5349723">0</span>&nbsp;<span class="op" id="5349725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5349729">return</span>&nbsp;<span class="num" id="5349736">0</span><span class="op" id="5349737">,</span>&nbsp;<span class="ident" id="5349739">nil</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5349744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5349747">n</span>&nbsp;<span class="op" id="5349749">=</span>&nbsp;<span class="builtinfunc" id="5349751">len</span><span class="op" id="5349754">(</span><span class="ident" id="5349755">p</span><span class="op" id="5349756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5349759">litMask</span>&nbsp;<span class="op" id="5349767">:=</span>&nbsp;<span class="builtintype" id="5349770">uint32</span><span class="op" id="5349776">(</span><span class="num" id="5349777">1</span><span class="op" id="5349778">&lt;&lt;</span><span class="ident" id="5349780">e</span><span class="op" id="5349781">.</span><span class="ident" id="5349782">litWidth</span>&nbsp;<span class="op" id="5349791">-</span>&nbsp;<span class="num" id="5349793">1</span><span class="op" id="5349794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5349797">code</span>&nbsp;<span class="op" id="5349802">:=</span>&nbsp;<span class="ident" id="5349805">e</span><span class="op" id="5349806">.</span><span class="ident" id="5349807">savedCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5349818">if</span>&nbsp;<span class="ident" id="5349821">code</span>&nbsp;<span class="op" id="5349826">==</span>&nbsp;<span class="ident" id="5349829">invalidCode</span>&nbsp;<span class="op" id="5349841">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5349845">//&nbsp;The&nbsp;first&nbsp;code&nbsp;sent&nbsp;is&nbsp;always&nbsp;a&nbsp;literal&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5349896">code</span><span class="op" id="5349900">,</span>&nbsp;<span class="ident" id="5349902">p</span>&nbsp;<span class="op" id="5349904">=</span>&nbsp;<span class="builtintype" id="5349906">uint32</span><span class="op" id="5349912">(</span><span class="ident" id="5349913">p</span><span class="op" id="5349914">[</span><span class="num" id="5349915">0</span><span class="op" id="5349916">]</span><span class="op" id="5349917">)</span><span class="op" id="5349918">&amp;</span><span class="ident" id="5349919">litMask</span><span class="op" id="5349926">,</span>&nbsp;<span class="ident" id="5349928">p</span><span class="op" id="5349929">[</span><span class="num" id="5349930">1</span><span class="op" id="5349931">:</span><span class="op" id="5349932">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5349935">}</span><br>
<span class="lineno"></span><span class="ident" id="5349937">loop</span><span class="op" id="5349941">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5349944">for</span>&nbsp;<span class="ident" id="5349948">_</span><span class="op" id="5349949">,</span>&nbsp;<span class="ident" id="5349951">x</span>&nbsp;<span class="op" id="5349953">:=</span>&nbsp;<span class="keyword" id="5349956">range</span>&nbsp;<span class="ident" id="5349962">p</span>&nbsp;<span class="op" id="5349964">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5349968">literal</span>&nbsp;<span class="op" id="5349976">:=</span>&nbsp;<span class="builtintype" id="5349979">uint32</span><span class="op" id="5349985">(</span><span class="ident" id="5349986">x</span><span class="op" id="5349987">)</span>&nbsp;<span class="op" id="5349989">&amp;</span>&nbsp;<span class="ident" id="5349991">litMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5350001">key</span>&nbsp;<span class="op" id="5350005">:=</span>&nbsp;<span class="ident" id="5350008">code</span><span class="op" id="5350012">&lt;&lt;</span><span class="num" id="5350014">8</span>&nbsp;<span class="op" id="5350016">|</span>&nbsp;<span class="ident" id="5350018">literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5350028">//&nbsp;If&nbsp;there&nbsp;is&nbsp;a&nbsp;hash&nbsp;table&nbsp;hit&nbsp;for&nbsp;this&nbsp;key&nbsp;then&nbsp;we&nbsp;continue&nbsp;the&nbsp;loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5350101">//&nbsp;and&nbsp;do&nbsp;not&nbsp;emit&nbsp;a&nbsp;code&nbsp;yet.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5350134">hash</span>&nbsp;<span class="op" id="5350139">:=</span>&nbsp;<span class="op" id="5350142">(</span><span class="ident" id="5350143">key</span><span class="op" id="5350146">&gt;&gt;</span><span class="num" id="5350148">12</span>&nbsp;<span class="op" id="5350151">^</span>&nbsp;<span class="ident" id="5350153">key</span><span class="op" id="5350156">)</span>&nbsp;<span class="op" id="5350158">&amp;</span>&nbsp;<span class="ident" id="5350160">tableMask</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5350172">for</span>&nbsp;<span class="ident" id="5350176">h</span><span class="op" id="5350177">,</span>&nbsp;<span class="ident" id="5350179">t</span>&nbsp;<span class="op" id="5350181">:=</span>&nbsp;<span class="ident" id="5350184">hash</span><span class="op" id="5350188">,</span>&nbsp;<span class="ident" id="5350190">e</span><span class="op" id="5350191">.</span><span class="ident" id="5350192">table</span><span class="op" id="5350197">[</span><span class="ident" id="5350198">hash</span><span class="op" id="5350202">]</span><span class="op" id="5350203">;</span>&nbsp;<span class="ident" id="5350205">t</span>&nbsp;<span class="op" id="5350207">!=</span>&nbsp;<span class="ident" id="5350210">invalidEntry</span><span class="op" id="5350222">;</span>&nbsp;<span class="op" id="5350224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5350229">if</span>&nbsp;<span class="ident" id="5350232">key</span>&nbsp;<span class="op" id="5350236">==</span>&nbsp;<span class="ident" id="5350239">t</span><span class="op" id="5350240">&gt;&gt;</span><span class="num" id="5350242">12</span>&nbsp;<span class="op" id="5350245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5350251">code</span>&nbsp;<span class="op" id="5350256">=</span>&nbsp;<span class="ident" id="5350258">t</span>&nbsp;<span class="op" id="5350260">&amp;</span>&nbsp;<span class="ident" id="5350262">maxCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5350274">continue</span>&nbsp;<span class="ident" id="5350283">loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5350291">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5350296">h</span>&nbsp;<span class="op" id="5350298">=</span>&nbsp;<span class="op" id="5350300">(</span><span class="ident" id="5350301">h</span>&nbsp;<span class="op" id="5350303">+</span>&nbsp;<span class="num" id="5350305">1</span><span class="op" id="5350306">)</span>&nbsp;<span class="op" id="5350308">&amp;</span>&nbsp;<span class="ident" id="5350310">tableMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5350323">t</span>&nbsp;<span class="op" id="5350325">=</span>&nbsp;<span class="ident" id="5350327">e</span><span class="op" id="5350328">.</span><span class="ident" id="5350329">table</span><span class="op" id="5350334">[</span><span class="ident" id="5350335">h</span><span class="op" id="5350336">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5350340">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5350344">//&nbsp;Otherwise,&nbsp;write&nbsp;the&nbsp;current&nbsp;code,&nbsp;and&nbsp;literal&nbsp;becomes&nbsp;the&nbsp;start&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5350417">//&nbsp;the&nbsp;next&nbsp;emitted&nbsp;code.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5350445">if</span>&nbsp;<span class="ident" id="5350448">e</span><span class="op" id="5350449">.</span><span class="ident" id="5350450">err</span>&nbsp;<span class="op" id="5350454">=</span>&nbsp;<span class="ident" id="5350456">e</span><span class="op" id="5350457">.</span><span class="ident" id="5350458">write</span><span class="op" id="5350463">(</span><span class="ident" id="5350464">e</span><span class="op" id="5350465">,</span>&nbsp;<span class="ident" id="5350467">code</span><span class="op" id="5350471">)</span><span class="op" id="5350472">;</span>&nbsp;<span class="ident" id="5350474">e</span><span class="op" id="5350475">.</span><span class="ident" id="5350476">err</span>&nbsp;<span class="op" id="5350480">!=</span>&nbsp;<span class="ident" id="5350483">nil</span>&nbsp;<span class="op" id="5350487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5350492">return</span>&nbsp;<span class="num" id="5350499">0</span><span class="op" id="5350500">,</span>&nbsp;<span class="ident" id="5350502">e</span><span class="op" id="5350503">.</span><span class="ident" id="5350504">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5350510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5350514">code</span>&nbsp;<span class="op" id="5350519">=</span>&nbsp;<span class="ident" id="5350521">literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5350531">//&nbsp;Increment&nbsp;e.hi,&nbsp;the&nbsp;next&nbsp;implied&nbsp;code.&nbsp;If&nbsp;we&nbsp;run&nbsp;out&nbsp;of&nbsp;codes,&nbsp;reset</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5350605">//&nbsp;the&nbsp;encoder&nbsp;state&nbsp;(including&nbsp;clearing&nbsp;the&nbsp;hash&nbsp;table)&nbsp;and&nbsp;continue.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5350678">if</span>&nbsp;<span class="ident" id="5350681">err1</span>&nbsp;<span class="op" id="5350686">:=</span>&nbsp;<span class="ident" id="5350689">e</span><span class="op" id="5350690">.</span><span class="ident" id="5350691">incHi</span><span class="op" id="5350696">(</span><span class="op" id="5350697">)</span><span class="op" id="5350698">;</span>&nbsp;<span class="ident" id="5350700">err1</span>&nbsp;<span class="op" id="5350705">!=</span>&nbsp;<span class="ident" id="5350708">nil</span>&nbsp;<span class="op" id="5350712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5350717">if</span>&nbsp;<span class="ident" id="5350720">err1</span>&nbsp;<span class="op" id="5350725">==</span>&nbsp;<span class="ident" id="5350728">errOutOfCodes</span>&nbsp;<span class="op" id="5350742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5350748">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5350760">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5350765">e</span><span class="op" id="5350766">.</span><span class="ident" id="5350767">err</span>&nbsp;<span class="op" id="5350771">=</span>&nbsp;<span class="ident" id="5350773">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5350781">return</span>&nbsp;<span class="num" id="5350788">0</span><span class="op" id="5350789">,</span>&nbsp;<span class="ident" id="5350791">e</span><span class="op" id="5350792">.</span><span class="ident" id="5350793">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5350799">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5350803">//&nbsp;Otherwise,&nbsp;insert&nbsp;key&nbsp;-&gt;&nbsp;e.hi&nbsp;into&nbsp;the&nbsp;map&nbsp;that&nbsp;e.table&nbsp;represents.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5350876">for</span>&nbsp;<span class="op" id="5350880">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5350885">if</span>&nbsp;<span class="ident" id="5350888">e</span><span class="op" id="5350889">.</span><span class="ident" id="5350890">table</span><span class="op" id="5350895">[</span><span class="ident" id="5350896">hash</span><span class="op" id="5350900">]</span>&nbsp;<span class="op" id="5350902">==</span>&nbsp;<span class="ident" id="5350905">invalidEntry</span>&nbsp;<span class="op" id="5350918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5350924">e</span><span class="op" id="5350925">.</span><span class="ident" id="5350926">table</span><span class="op" id="5350931">[</span><span class="ident" id="5350932">hash</span><span class="op" id="5350936">]</span>&nbsp;<span class="op" id="5350938">=</span>&nbsp;<span class="op" id="5350940">(</span><span class="ident" id="5350941">key</span>&nbsp;<span class="op" id="5350945">&lt;&lt;</span>&nbsp;<span class="num" id="5350948">12</span><span class="op" id="5350950">)</span>&nbsp;<span class="op" id="5350952">|</span>&nbsp;<span class="ident" id="5350954">e</span><span class="op" id="5350955">.</span><span class="ident" id="5350956">hi</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5350963">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5350972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5350977">hash</span>&nbsp;<span class="op" id="5350982">=</span>&nbsp;<span class="op" id="5350984">(</span><span class="ident" id="5350985">hash</span>&nbsp;<span class="op" id="5350990">+</span>&nbsp;<span class="num" id="5350992">1</span><span class="op" id="5350993">)</span>&nbsp;<span class="op" id="5350995">&amp;</span>&nbsp;<span class="ident" id="5350997">tableMask</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5351009">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5351012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5351015">e</span><span class="op" id="5351016">.</span><span class="ident" id="5351017">savedCode</span>&nbsp;<span class="op" id="5351027">=</span>&nbsp;<span class="ident" id="5351029">code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5351035">return</span>&nbsp;<span class="ident" id="5351042">n</span><span class="op" id="5351043">,</span>&nbsp;<span class="ident" id="5351045">nil</span><br>
<span class="lineno"></span><span class="op" id="5351049">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="5351052">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;encoder,&nbsp;flushing&nbsp;any&nbsp;pending&nbsp;output.&nbsp;It&nbsp;does&nbsp;not&nbsp;close&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="5351131">//&nbsp;flush&nbsp;e&#39;s&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5351163">func</span>&nbsp;<span class="op" id="5351168">(</span><span class="ident" id="5351169">e</span>&nbsp;<span class="op" id="5351171">*</span><span class="ident" id="5351172">encoder</span><span class="op" id="5351179">)</span>&nbsp;<span class="ident" id="5351181">Close</span><span class="op" id="5351186">(</span><span class="op" id="5351187">)</span>&nbsp;<span class="builtintype" id="5351189">error</span>&nbsp;<span class="op" id="5351195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5351198">if</span>&nbsp;<span class="ident" id="5351201">e</span><span class="op" id="5351202">.</span><span class="ident" id="5351203">err</span>&nbsp;<span class="op" id="5351207">!=</span>&nbsp;<span class="ident" id="5351210">nil</span>&nbsp;<span class="op" id="5351214">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5351218">if</span>&nbsp;<span class="ident" id="5351221">e</span><span class="op" id="5351222">.</span><span class="ident" id="5351223">err</span>&nbsp;<span class="op" id="5351227">==</span>&nbsp;<span class="ident" id="5351230">errClosed</span>&nbsp;<span class="op" id="5351240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5351245">return</span>&nbsp;<span class="ident" id="5351252">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5351258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5351262">return</span>&nbsp;<span class="ident" id="5351269">e</span><span class="op" id="5351270">.</span><span class="ident" id="5351271">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5351276">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5351279">//&nbsp;Make&nbsp;any&nbsp;future&nbsp;calls&nbsp;to&nbsp;Write&nbsp;return&nbsp;errClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5351332">e</span><span class="op" id="5351333">.</span><span class="ident" id="5351334">err</span>&nbsp;<span class="op" id="5351338">=</span>&nbsp;<span class="ident" id="5351340">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5351351">//&nbsp;Write&nbsp;the&nbsp;savedCode&nbsp;if&nbsp;valid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5351385">if</span>&nbsp;<span class="ident" id="5351388">e</span><span class="op" id="5351389">.</span><span class="ident" id="5351390">savedCode</span>&nbsp;<span class="op" id="5351400">!=</span>&nbsp;<span class="ident" id="5351403">invalidCode</span>&nbsp;<span class="op" id="5351415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5351419">if</span>&nbsp;<span class="ident" id="5351422">err</span>&nbsp;<span class="op" id="5351426">:=</span>&nbsp;<span class="ident" id="5351429">e</span><span class="op" id="5351430">.</span><span class="ident" id="5351431">write</span><span class="op" id="5351436">(</span><span class="ident" id="5351437">e</span><span class="op" id="5351438">,</span>&nbsp;<span class="ident" id="5351440">e</span><span class="op" id="5351441">.</span><span class="ident" id="5351442">savedCode</span><span class="op" id="5351451">)</span><span class="op" id="5351452">;</span>&nbsp;<span class="ident" id="5351454">err</span>&nbsp;<span class="op" id="5351458">!=</span>&nbsp;<span class="ident" id="5351461">nil</span>&nbsp;<span class="op" id="5351465">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5351470">return</span>&nbsp;<span class="ident" id="5351477">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5351483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5351487">if</span>&nbsp;<span class="ident" id="5351490">err</span>&nbsp;<span class="op" id="5351494">:=</span>&nbsp;<span class="ident" id="5351497">e</span><span class="op" id="5351498">.</span><span class="ident" id="5351499">incHi</span><span class="op" id="5351504">(</span><span class="op" id="5351505">)</span><span class="op" id="5351506">;</span>&nbsp;<span class="ident" id="5351508">err</span>&nbsp;<span class="op" id="5351512">!=</span>&nbsp;<span class="ident" id="5351515">nil</span>&nbsp;<span class="op" id="5351519">&amp;&amp;</span>&nbsp;<span class="ident" id="5351522">err</span>&nbsp;<span class="op" id="5351526">!=</span>&nbsp;<span class="ident" id="5351529">errOutOfCodes</span>&nbsp;<span class="op" id="5351543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5351548">return</span>&nbsp;<span class="ident" id="5351555">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5351561">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5351564">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5351567">//&nbsp;Write&nbsp;the&nbsp;eof&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5351591">eof</span>&nbsp;<span class="op" id="5351595">:=</span>&nbsp;<span class="builtintype" id="5351598">uint32</span><span class="op" id="5351604">(</span><span class="num" id="5351605">1</span><span class="op" id="5351606">)</span><span class="op" id="5351607">&lt;&lt;</span><span class="ident" id="5351609">e</span><span class="op" id="5351610">.</span><span class="ident" id="5351611">litWidth</span>&nbsp;<span class="op" id="5351620">+</span>&nbsp;<span class="num" id="5351622">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5351625">if</span>&nbsp;<span class="ident" id="5351628">err</span>&nbsp;<span class="op" id="5351632">:=</span>&nbsp;<span class="ident" id="5351635">e</span><span class="op" id="5351636">.</span><span class="ident" id="5351637">write</span><span class="op" id="5351642">(</span><span class="ident" id="5351643">e</span><span class="op" id="5351644">,</span>&nbsp;<span class="ident" id="5351646">eof</span><span class="op" id="5351649">)</span><span class="op" id="5351650">;</span>&nbsp;<span class="ident" id="5351652">err</span>&nbsp;<span class="op" id="5351656">!=</span>&nbsp;<span class="ident" id="5351659">nil</span>&nbsp;<span class="op" id="5351663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5351667">return</span>&nbsp;<span class="ident" id="5351674">err</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5351679">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5351682">//&nbsp;Write&nbsp;the&nbsp;final&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5351708">if</span>&nbsp;<span class="ident" id="5351711">e</span><span class="op" id="5351712">.</span><span class="ident" id="5351713">nBits</span>&nbsp;<span class="op" id="5351719">&gt;</span>&nbsp;<span class="num" id="5351721">0</span>&nbsp;<span class="op" id="5351723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5351727">if</span>&nbsp;<span class="ident" id="5351730">e</span><span class="op" id="5351731">.</span><span class="ident" id="5351732">order</span>&nbsp;<span class="op" id="5351738">==</span>&nbsp;<span class="ident" id="5351741">MSB</span>&nbsp;<span class="op" id="5351745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5351750">e</span><span class="op" id="5351751">.</span><span class="ident" id="5351752">bits</span>&nbsp;<span class="op" id="5351757">&gt;&gt;=</span>&nbsp;<span class="num" id="5351761">24</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5351766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5351770">if</span>&nbsp;<span class="ident" id="5351773">err</span>&nbsp;<span class="op" id="5351777">:=</span>&nbsp;<span class="ident" id="5351780">e</span><span class="op" id="5351781">.</span><span class="ident" id="5351782">w</span><span class="op" id="5351783">.</span><span class="ident" id="5351784">WriteByte</span><span class="op" id="5351793">(</span><span class="builtintype" id="5351794">uint8</span><span class="op" id="5351799">(</span><span class="ident" id="5351800">e</span><span class="op" id="5351801">.</span><span class="ident" id="5351802">bits</span><span class="op" id="5351806">)</span><span class="op" id="5351807">)</span><span class="op" id="5351808">;</span>&nbsp;<span class="ident" id="5351810">err</span>&nbsp;<span class="op" id="5351814">!=</span>&nbsp;<span class="ident" id="5351817">nil</span>&nbsp;<span class="op" id="5351821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5351826">return</span>&nbsp;<span class="ident" id="5351833">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5351839">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5351842">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5351845">return</span>&nbsp;<span class="ident" id="5351852">e</span><span class="op" id="5351853">.</span><span class="ident" id="5351854">w</span><span class="op" id="5351855">.</span><span class="ident" id="5351856">Flush</span><span class="op" id="5351861">(</span><span class="op" id="5351862">)</span><br>
<span class="lineno"></span><span class="op" id="5351864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5351867">//&nbsp;NewWriter&nbsp;creates&nbsp;a&nbsp;new&nbsp;io.WriteCloser.</span><br>
<span class="lineno"></span><span class="comment" id="5351910">//&nbsp;Writes&nbsp;to&nbsp;the&nbsp;returned&nbsp;io.WriteCloser&nbsp;are&nbsp;compressed&nbsp;and&nbsp;written&nbsp;to&nbsp;w.</span><br>
<span class="lineno">230</span><span class="comment" id="5351984">//&nbsp;It&nbsp;is&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;call&nbsp;Close&nbsp;on&nbsp;the&nbsp;WriteCloser&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="5352059">//&nbsp;finished&nbsp;writing.</span><br>
<span class="lineno"></span><span class="comment" id="5352080">//&nbsp;The&nbsp;number&nbsp;of&nbsp;bits&nbsp;to&nbsp;use&nbsp;for&nbsp;literal&nbsp;codes,&nbsp;litWidth,&nbsp;must&nbsp;be&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5352153">//&nbsp;range&nbsp;[2,8]&nbsp;and&nbsp;is&nbsp;typically&nbsp;8.</span><br>
<span class="lineno"></span><span class="keyword" id="5352188">func</span>&nbsp;<span class="ident" id="5352193">NewWriter</span><span class="op" id="5352202">(</span><span class="ident" id="5352203">w</span>&nbsp;<span class="ident" id="5352205">io</span><span class="op" id="5352207">.</span><span class="ident" id="5352208">Writer</span><span class="op" id="5352214">,</span>&nbsp;<span class="ident" id="5352216">order</span>&nbsp;<span class="ident" id="5352222">Order</span><span class="op" id="5352227">,</span>&nbsp;<span class="ident" id="5352229">litWidth</span>&nbsp;<span class="builtintype" id="5352238">int</span><span class="op" id="5352241">)</span>&nbsp;<span class="ident" id="5352243">io</span><span class="op" id="5352245">.</span><span class="ident" id="5352246">WriteCloser</span>&nbsp;<span class="op" id="5352258">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5352261">var</span>&nbsp;<span class="ident" id="5352265">write</span>&nbsp;<span class="keyword" id="5352271">func</span><span class="op" id="5352275">(</span><span class="op" id="5352276">*</span><span class="ident" id="5352277">encoder</span><span class="op" id="5352284">,</span>&nbsp;<span class="builtintype" id="5352286">uint32</span><span class="op" id="5352292">)</span>&nbsp;<span class="builtintype" id="5352294">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5352301">switch</span>&nbsp;<span class="ident" id="5352308">order</span>&nbsp;<span class="op" id="5352314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5352317">case</span>&nbsp;<span class="ident" id="5352322">LSB</span><span class="op" id="5352325">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5352329">write</span>&nbsp;<span class="op" id="5352335">=</span>&nbsp;<span class="op" id="5352337">(</span><span class="op" id="5352338">*</span><span class="ident" id="5352339">encoder</span><span class="op" id="5352346">)</span><span class="op" id="5352347">.</span><span class="ident" id="5352348">writeLSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5352358">case</span>&nbsp;<span class="ident" id="5352363">MSB</span><span class="op" id="5352366">:</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5352370">write</span>&nbsp;<span class="op" id="5352376">=</span>&nbsp;<span class="op" id="5352378">(</span><span class="op" id="5352379">*</span><span class="ident" id="5352380">encoder</span><span class="op" id="5352387">)</span><span class="op" id="5352388">.</span><span class="ident" id="5352389">writeMSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5352399">default</span><span class="op" id="5352406">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5352410">return</span>&nbsp;<span class="op" id="5352417">&amp;</span><span class="ident" id="5352418">errWriteCloser</span><span class="op" id="5352432">{</span><span class="ident" id="5352433">errors</span><span class="op" id="5352439">.</span><span class="ident" id="5352440">New</span><span class="op" id="5352443">(</span><span class="string" id="5352444">&#34;lzw:&nbsp;unknown&nbsp;order&#34;</span><span class="op" id="5352464">)</span><span class="op" id="5352465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5352468">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5352471">if</span>&nbsp;<span class="ident" id="5352474">litWidth</span>&nbsp;<span class="op" id="5352483">&lt;</span>&nbsp;<span class="num" id="5352485">2</span>&nbsp;<span class="op" id="5352487">||</span>&nbsp;<span class="num" id="5352490">8</span>&nbsp;<span class="op" id="5352492">&lt;</span>&nbsp;<span class="ident" id="5352494">litWidth</span>&nbsp;<span class="op" id="5352503">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5352507">return</span>&nbsp;<span class="op" id="5352514">&amp;</span><span class="ident" id="5352515">errWriteCloser</span><span class="op" id="5352529">{</span><span class="ident" id="5352530">fmt</span><span class="op" id="5352533">.</span><span class="ident" id="5352534">Errorf</span><span class="op" id="5352540">(</span><span class="string" id="5352541">&#34;lzw:&nbsp;litWidth&nbsp;%d&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="5352572">,</span>&nbsp;<span class="ident" id="5352574">litWidth</span><span class="op" id="5352582">)</span><span class="op" id="5352583">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5352586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5352589">bw</span><span class="op" id="5352591">,</span>&nbsp;<span class="ident" id="5352593">ok</span>&nbsp;<span class="op" id="5352596">:=</span>&nbsp;<span class="ident" id="5352599">w</span><span class="op" id="5352600">.</span><span class="op" id="5352601">(</span><span class="ident" id="5352602">writer</span><span class="op" id="5352608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5352611">if</span>&nbsp;<span class="op" id="5352614">!</span><span class="ident" id="5352615">ok</span>&nbsp;<span class="op" id="5352618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5352622">bw</span>&nbsp;<span class="op" id="5352625">=</span>&nbsp;<span class="ident" id="5352627">bufio</span><span class="op" id="5352632">.</span><span class="ident" id="5352633">NewWriter</span><span class="op" id="5352642">(</span><span class="ident" id="5352643">w</span><span class="op" id="5352644">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5352647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5352650">lw</span>&nbsp;<span class="op" id="5352653">:=</span>&nbsp;<span class="builtintype" id="5352656">uint</span><span class="op" id="5352660">(</span><span class="ident" id="5352661">litWidth</span><span class="op" id="5352669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5352672">return</span>&nbsp;<span class="op" id="5352679">&amp;</span><span class="ident" id="5352680">encoder</span><span class="op" id="5352687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5352691">w</span><span class="op" id="5352692">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5352702">bw</span><span class="op" id="5352704">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5352708">order</span><span class="op" id="5352713">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5352719">order</span><span class="op" id="5352724">,</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5352728">write</span><span class="op" id="5352733">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5352739">write</span><span class="op" id="5352744">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5352748">width</span><span class="op" id="5352753">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="5352759">1</span>&nbsp;<span class="op" id="5352761">+</span>&nbsp;<span class="ident" id="5352763">lw</span><span class="op" id="5352765">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5352769">litWidth</span><span class="op" id="5352777">:</span>&nbsp;&nbsp;<span class="ident" id="5352780">lw</span><span class="op" id="5352782">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5352786">hi</span><span class="op" id="5352788">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="5352797">1</span><span class="op" id="5352798">&lt;&lt;</span><span class="ident" id="5352800">lw</span>&nbsp;<span class="op" id="5352803">+</span>&nbsp;<span class="num" id="5352805">1</span><span class="op" id="5352806">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5352810">overflow</span><span class="op" id="5352818">:</span>&nbsp;&nbsp;<span class="num" id="5352821">1</span>&nbsp;<span class="op" id="5352823">&lt;&lt;</span>&nbsp;<span class="op" id="5352826">(</span><span class="ident" id="5352827">lw</span>&nbsp;<span class="op" id="5352830">+</span>&nbsp;<span class="num" id="5352832">1</span><span class="op" id="5352833">)</span><span class="op" id="5352834">,</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5352838">savedCode</span><span class="op" id="5352847">:</span>&nbsp;<span class="ident" id="5352849">invalidCode</span><span class="op" id="5352860">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5352863">}</span><br>
<span class="lineno"></span><span class="op" id="5352865">}</span>
</div>
</body>
</html>
