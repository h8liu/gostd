<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="6137033">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6137089">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6137143">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6137194">package</span>&nbsp;<span class="ident" id="6137202">jsonrpc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6137211">import</span>&nbsp;<span class="op" id="6137218">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6137221">&#34;encoding/json&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6137238">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6137248">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6137254">&#34;net/rpc&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6137265">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="6137272">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="6137275">var</span>&nbsp;<span class="ident" id="6137279">errMissingParams</span>&nbsp;<span class="op" id="6137296">=</span>&nbsp;<span class="ident" id="6137298">errors</span><span class="op" id="6137304">.</span><span class="ident" id="6137305">New</span><span class="op" id="6137308">(</span><span class="string" id="6137309">&#34;jsonrpc:&nbsp;request&nbsp;body&nbsp;missing&nbsp;params&#34;</span><span class="op" id="6137347">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6137350">type</span>&nbsp;<span class="ident" id="6137355">serverCodec</span>&nbsp;<span class="keyword" id="6137367">struct</span>&nbsp;<span class="op" id="6137374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6137377">dec</span>&nbsp;<span class="op" id="6137381">*</span><span class="ident" id="6137382">json</span><span class="op" id="6137386">.</span><span class="ident" id="6137387">Decoder</span>&nbsp;<span class="comment" id="6137395">//&nbsp;for&nbsp;reading&nbsp;JSON&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6137423">enc</span>&nbsp;<span class="op" id="6137427">*</span><span class="ident" id="6137428">json</span><span class="op" id="6137432">.</span><span class="ident" id="6137433">Encoder</span>&nbsp;<span class="comment" id="6137441">//&nbsp;for&nbsp;writing&nbsp;JSON&nbsp;values</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6137469">c</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6137473">io</span><span class="op" id="6137475">.</span><span class="ident" id="6137476">Closer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6137485">//&nbsp;temporary&nbsp;work&nbsp;space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6137510">req</span>&nbsp;<span class="ident" id="6137514">serverRequest</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6137530">//&nbsp;JSON-RPC&nbsp;clients&nbsp;can&nbsp;use&nbsp;arbitrary&nbsp;json&nbsp;values&nbsp;as&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6137597">//&nbsp;Package&nbsp;rpc&nbsp;expects&nbsp;uint64&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6137641">//&nbsp;We&nbsp;assign&nbsp;uint64&nbsp;sequence&nbsp;numbers&nbsp;to&nbsp;incoming&nbsp;requests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6137700">//&nbsp;but&nbsp;save&nbsp;the&nbsp;original&nbsp;request&nbsp;ID&nbsp;in&nbsp;the&nbsp;pending&nbsp;map.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6137757">//&nbsp;When&nbsp;rpc&nbsp;responds,&nbsp;we&nbsp;use&nbsp;the&nbsp;sequence&nbsp;number&nbsp;in</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6137810">//&nbsp;the&nbsp;response&nbsp;to&nbsp;find&nbsp;the&nbsp;original&nbsp;request&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6137860">mutex</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6137868">sync</span><span class="op" id="6137872">.</span><span class="ident" id="6137873">Mutex</span>&nbsp;<span class="comment" id="6137879">//&nbsp;protects&nbsp;seq,&nbsp;pending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6137905">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6137913">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6137921">pending</span>&nbsp;<span class="keyword" id="6137929">map</span><span class="op" id="6137932">[</span><span class="ident" id="6137933">uint64</span><span class="op" id="6137939">]</span><span class="op" id="6137940">*</span><span class="ident" id="6137941">json</span><span class="op" id="6137945">.</span><span class="ident" id="6137946">RawMessage</span><br>
<span class="lineno"></span><span class="op" id="6137957">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="6137960">//&nbsp;NewServerCodec&nbsp;returns&nbsp;a&nbsp;new&nbsp;rpc.ServerCodec&nbsp;using&nbsp;JSON-RPC&nbsp;on&nbsp;conn.</span><br>
<span class="lineno"></span><span class="keyword" id="6138032">func</span>&nbsp;<span class="ident" id="6138037">NewServerCodec</span><span class="op" id="6138051">(</span><span class="ident" id="6138052">conn</span>&nbsp;<span class="ident" id="6138057">io</span><span class="op" id="6138059">.</span><span class="ident" id="6138060">ReadWriteCloser</span><span class="op" id="6138075">)</span>&nbsp;<span class="ident" id="6138077">rpc</span><span class="op" id="6138080">.</span><span class="ident" id="6138081">ServerCodec</span>&nbsp;<span class="op" id="6138093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6138096">return</span>&nbsp;<span class="op" id="6138103">&amp;</span><span class="ident" id="6138104">serverCodec</span><span class="op" id="6138115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6138119">dec</span><span class="op" id="6138122">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6138128">json</span><span class="op" id="6138132">.</span><span class="ident" id="6138133">NewDecoder</span><span class="op" id="6138143">(</span><span class="ident" id="6138144">conn</span><span class="op" id="6138148">)</span><span class="op" id="6138149">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6138153">enc</span><span class="op" id="6138156">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6138162">json</span><span class="op" id="6138166">.</span><span class="ident" id="6138167">NewEncoder</span><span class="op" id="6138177">(</span><span class="ident" id="6138178">conn</span><span class="op" id="6138182">)</span><span class="op" id="6138183">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6138187">c</span><span class="op" id="6138188">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6138196">conn</span><span class="op" id="6138200">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6138204">pending</span><span class="op" id="6138211">:</span>&nbsp;<span class="builtinfunc" id="6138213">make</span><span class="op" id="6138217">(</span><span class="keyword" id="6138218">map</span><span class="op" id="6138221">[</span><span class="ident" id="6138222">uint64</span><span class="op" id="6138228">]</span><span class="op" id="6138229">*</span><span class="ident" id="6138230">json</span><span class="op" id="6138234">.</span><span class="ident" id="6138235">RawMessage</span><span class="op" id="6138245">)</span><span class="op" id="6138246">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6138249">}</span><br>
<span class="lineno"></span><span class="op" id="6138251">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="keyword" id="6138254">type</span>&nbsp;<span class="ident" id="6138259">serverRequest</span>&nbsp;<span class="keyword" id="6138273">struct</span>&nbsp;<span class="op" id="6138280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6138283">Method</span>&nbsp;<span class="builtintype" id="6138290">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6138307">`json:&#34;method&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6138324">Params</span>&nbsp;<span class="op" id="6138331">*</span><span class="ident" id="6138332">json</span><span class="op" id="6138336">.</span><span class="ident" id="6138337">RawMessage</span>&nbsp;<span class="string" id="6138348">`json:&#34;params&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6138365">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6138372">*</span><span class="ident" id="6138373">json</span><span class="op" id="6138377">.</span><span class="ident" id="6138378">RawMessage</span>&nbsp;<span class="string" id="6138389">`json:&#34;id&#34;`</span><br>
<span class="lineno">50</span><span class="op" id="6138401">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6138404">func</span>&nbsp;<span class="op" id="6138409">(</span><span class="ident" id="6138410">r</span>&nbsp;<span class="op" id="6138412">*</span><span class="ident" id="6138413">serverRequest</span><span class="op" id="6138426">)</span>&nbsp;<span class="ident" id="6138428">reset</span><span class="op" id="6138433">(</span><span class="op" id="6138434">)</span>&nbsp;<span class="op" id="6138436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6138439">r</span><span class="op" id="6138440">.</span><span class="ident" id="6138441">Method</span>&nbsp;<span class="op" id="6138448">=</span>&nbsp;<span class="string" id="6138450">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6138454">r</span><span class="op" id="6138455">.</span><span class="ident" id="6138456">Params</span>&nbsp;<span class="op" id="6138463">=</span>&nbsp;<span class="ident" id="6138465">nil</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6138470">r</span><span class="op" id="6138471">.</span><span class="ident" id="6138472">Id</span>&nbsp;<span class="op" id="6138475">=</span>&nbsp;<span class="ident" id="6138477">nil</span><br>
<span class="lineno"></span><span class="op" id="6138481">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6138484">type</span>&nbsp;<span class="ident" id="6138489">serverResponse</span>&nbsp;<span class="keyword" id="6138504">struct</span>&nbsp;<span class="op" id="6138511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6138514">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6138521">*</span><span class="ident" id="6138522">json</span><span class="op" id="6138526">.</span><span class="ident" id="6138527">RawMessage</span>&nbsp;<span class="string" id="6138538">`json:&#34;id&#34;`</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6138551">Result</span>&nbsp;<span class="keyword" id="6138558">interface</span><span class="op" id="6138567">{</span><span class="op" id="6138568">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6138575">`json:&#34;result&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6138592">Error</span>&nbsp;&nbsp;<span class="keyword" id="6138599">interface</span><span class="op" id="6138608">{</span><span class="op" id="6138609">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6138616">`json:&#34;error&#34;`</span><br>
<span class="lineno"></span><span class="op" id="6138631">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6138634">func</span>&nbsp;<span class="op" id="6138639">(</span><span class="ident" id="6138640">c</span>&nbsp;<span class="op" id="6138642">*</span><span class="ident" id="6138643">serverCodec</span><span class="op" id="6138654">)</span>&nbsp;<span class="ident" id="6138656">ReadRequestHeader</span><span class="op" id="6138673">(</span><span class="ident" id="6138674">r</span>&nbsp;<span class="op" id="6138676">*</span><span class="ident" id="6138677">rpc</span><span class="op" id="6138680">.</span><span class="ident" id="6138681">Request</span><span class="op" id="6138688">)</span>&nbsp;<span class="builtintype" id="6138690">error</span>&nbsp;<span class="op" id="6138696">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6138699">c</span><span class="op" id="6138700">.</span><span class="ident" id="6138701">req</span><span class="op" id="6138704">.</span><span class="ident" id="6138705">reset</span><span class="op" id="6138710">(</span><span class="op" id="6138711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6138714">if</span>&nbsp;<span class="ident" id="6138717">err</span>&nbsp;<span class="op" id="6138721">:=</span>&nbsp;<span class="ident" id="6138724">c</span><span class="op" id="6138725">.</span><span class="ident" id="6138726">dec</span><span class="op" id="6138729">.</span><span class="ident" id="6138730">Decode</span><span class="op" id="6138736">(</span><span class="op" id="6138737">&amp;</span><span class="ident" id="6138738">c</span><span class="op" id="6138739">.</span><span class="ident" id="6138740">req</span><span class="op" id="6138743">)</span><span class="op" id="6138744">;</span>&nbsp;<span class="ident" id="6138746">err</span>&nbsp;<span class="op" id="6138750">!=</span>&nbsp;<span class="ident" id="6138753">nil</span>&nbsp;<span class="op" id="6138757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6138761">return</span>&nbsp;<span class="ident" id="6138768">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6138773">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6138776">r</span><span class="op" id="6138777">.</span><span class="ident" id="6138778">ServiceMethod</span>&nbsp;<span class="op" id="6138792">=</span>&nbsp;<span class="ident" id="6138794">c</span><span class="op" id="6138795">.</span><span class="ident" id="6138796">req</span><span class="op" id="6138799">.</span><span class="ident" id="6138800">Method</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6138809">//&nbsp;JSON&nbsp;request&nbsp;id&nbsp;can&nbsp;be&nbsp;any&nbsp;JSON&nbsp;value;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6138852">//&nbsp;RPC&nbsp;package&nbsp;expects&nbsp;uint64.&nbsp;&nbsp;Translate&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6138898">//&nbsp;internal&nbsp;uint64&nbsp;and&nbsp;save&nbsp;JSON&nbsp;on&nbsp;the&nbsp;side.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6138945">c</span><span class="op" id="6138946">.</span><span class="ident" id="6138947">mutex</span><span class="op" id="6138952">.</span><span class="ident" id="6138953">Lock</span><span class="op" id="6138957">(</span><span class="op" id="6138958">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6138961">c</span><span class="op" id="6138962">.</span><span class="ident" id="6138963">seq</span><span class="op" id="6138966">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6138970">c</span><span class="op" id="6138971">.</span><span class="ident" id="6138972">pending</span><span class="op" id="6138979">[</span><span class="ident" id="6138980">c</span><span class="op" id="6138981">.</span><span class="ident" id="6138982">seq</span><span class="op" id="6138985">]</span>&nbsp;<span class="op" id="6138987">=</span>&nbsp;<span class="ident" id="6138989">c</span><span class="op" id="6138990">.</span><span class="ident" id="6138991">req</span><span class="op" id="6138994">.</span><span class="ident" id="6138995">Id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6138999">c</span><span class="op" id="6139000">.</span><span class="ident" id="6139001">req</span><span class="op" id="6139004">.</span><span class="ident" id="6139005">Id</span>&nbsp;<span class="op" id="6139008">=</span>&nbsp;<span class="ident" id="6139010">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6139015">r</span><span class="op" id="6139016">.</span><span class="ident" id="6139017">Seq</span>&nbsp;<span class="op" id="6139021">=</span>&nbsp;<span class="ident" id="6139023">c</span><span class="op" id="6139024">.</span><span class="ident" id="6139025">seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6139030">c</span><span class="op" id="6139031">.</span><span class="ident" id="6139032">mutex</span><span class="op" id="6139037">.</span><span class="ident" id="6139038">Unlock</span><span class="op" id="6139044">(</span><span class="op" id="6139045">)</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6139049">return</span>&nbsp;<span class="ident" id="6139056">nil</span><br>
<span class="lineno"></span><span class="op" id="6139060">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6139063">func</span>&nbsp;<span class="op" id="6139068">(</span><span class="ident" id="6139069">c</span>&nbsp;<span class="op" id="6139071">*</span><span class="ident" id="6139072">serverCodec</span><span class="op" id="6139083">)</span>&nbsp;<span class="ident" id="6139085">ReadRequestBody</span><span class="op" id="6139100">(</span><span class="ident" id="6139101">x</span>&nbsp;<span class="keyword" id="6139103">interface</span><span class="op" id="6139112">{</span><span class="op" id="6139113">}</span><span class="op" id="6139114">)</span>&nbsp;<span class="builtintype" id="6139116">error</span>&nbsp;<span class="op" id="6139122">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6139125">if</span>&nbsp;<span class="ident" id="6139128">x</span>&nbsp;<span class="op" id="6139130">==</span>&nbsp;<span class="ident" id="6139133">nil</span>&nbsp;<span class="op" id="6139137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6139141">return</span>&nbsp;<span class="ident" id="6139148">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6139153">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6139156">if</span>&nbsp;<span class="ident" id="6139159">c</span><span class="op" id="6139160">.</span><span class="ident" id="6139161">req</span><span class="op" id="6139164">.</span><span class="ident" id="6139165">Params</span>&nbsp;<span class="op" id="6139172">==</span>&nbsp;<span class="ident" id="6139175">nil</span>&nbsp;<span class="op" id="6139179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6139183">return</span>&nbsp;<span class="ident" id="6139190">errMissingParams</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6139208">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6139211">//&nbsp;JSON&nbsp;params&nbsp;is&nbsp;array&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6139243">//&nbsp;RPC&nbsp;params&nbsp;is&nbsp;struct.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6139269">//&nbsp;Unmarshal&nbsp;into&nbsp;array&nbsp;containing&nbsp;struct&nbsp;for&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6139321">//&nbsp;Should&nbsp;think&nbsp;about&nbsp;making&nbsp;RPC&nbsp;more&nbsp;general.</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6139369">var</span>&nbsp;<span class="ident" id="6139373">params</span>&nbsp;<span class="op" id="6139380">[</span><span class="num" id="6139381">1</span><span class="op" id="6139382">]</span><span class="keyword" id="6139383">interface</span><span class="op" id="6139392">{</span><span class="op" id="6139393">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6139396">params</span><span class="op" id="6139402">[</span><span class="num" id="6139403">0</span><span class="op" id="6139404">]</span>&nbsp;<span class="op" id="6139406">=</span>&nbsp;<span class="ident" id="6139408">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6139411">return</span>&nbsp;<span class="ident" id="6139418">json</span><span class="op" id="6139422">.</span><span class="ident" id="6139423">Unmarshal</span><span class="op" id="6139432">(</span><span class="op" id="6139433">*</span><span class="ident" id="6139434">c</span><span class="op" id="6139435">.</span><span class="ident" id="6139436">req</span><span class="op" id="6139439">.</span><span class="ident" id="6139440">Params</span><span class="op" id="6139446">,</span>&nbsp;<span class="op" id="6139448">&amp;</span><span class="ident" id="6139449">params</span><span class="op" id="6139455">)</span><br>
<span class="lineno"></span><span class="op" id="6139457">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="6139460">var</span>&nbsp;<span class="ident" id="6139464">null</span>&nbsp;<span class="op" id="6139469">=</span>&nbsp;<span class="ident" id="6139471">json</span><span class="op" id="6139475">.</span><span class="ident" id="6139476">RawMessage</span><span class="op" id="6139486">(</span><span class="op" id="6139487">[</span><span class="op" id="6139488">]</span><span class="builtintype" id="6139489">byte</span><span class="op" id="6139493">(</span><span class="string" id="6139494">&#34;null&#34;</span><span class="op" id="6139500">)</span><span class="op" id="6139501">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6139504">func</span>&nbsp;<span class="op" id="6139509">(</span><span class="ident" id="6139510">c</span>&nbsp;<span class="op" id="6139512">*</span><span class="ident" id="6139513">serverCodec</span><span class="op" id="6139524">)</span>&nbsp;<span class="ident" id="6139526">WriteResponse</span><span class="op" id="6139539">(</span><span class="ident" id="6139540">r</span>&nbsp;<span class="op" id="6139542">*</span><span class="ident" id="6139543">rpc</span><span class="op" id="6139546">.</span><span class="ident" id="6139547">Response</span><span class="op" id="6139555">,</span>&nbsp;<span class="ident" id="6139557">x</span>&nbsp;<span class="keyword" id="6139559">interface</span><span class="op" id="6139568">{</span><span class="op" id="6139569">}</span><span class="op" id="6139570">)</span>&nbsp;<span class="builtintype" id="6139572">error</span>&nbsp;<span class="op" id="6139578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6139581">c</span><span class="op" id="6139582">.</span><span class="ident" id="6139583">mutex</span><span class="op" id="6139588">.</span><span class="ident" id="6139589">Lock</span><span class="op" id="6139593">(</span><span class="op" id="6139594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6139597">b</span><span class="op" id="6139598">,</span>&nbsp;<span class="ident" id="6139600">ok</span>&nbsp;<span class="op" id="6139603">:=</span>&nbsp;<span class="ident" id="6139606">c</span><span class="op" id="6139607">.</span><span class="ident" id="6139608">pending</span><span class="op" id="6139615">[</span><span class="ident" id="6139616">r</span><span class="op" id="6139617">.</span><span class="ident" id="6139618">Seq</span><span class="op" id="6139621">]</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6139624">if</span>&nbsp;<span class="op" id="6139627">!</span><span class="ident" id="6139628">ok</span>&nbsp;<span class="op" id="6139631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6139635">c</span><span class="op" id="6139636">.</span><span class="ident" id="6139637">mutex</span><span class="op" id="6139642">.</span><span class="ident" id="6139643">Unlock</span><span class="op" id="6139649">(</span><span class="op" id="6139650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6139654">return</span>&nbsp;<span class="ident" id="6139661">errors</span><span class="op" id="6139667">.</span><span class="ident" id="6139668">New</span><span class="op" id="6139671">(</span><span class="string" id="6139672">&#34;invalid&nbsp;sequence&nbsp;number&nbsp;in&nbsp;response&#34;</span><span class="op" id="6139709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6139712">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6139715">delete</span><span class="op" id="6139721">(</span><span class="ident" id="6139722">c</span><span class="op" id="6139723">.</span><span class="ident" id="6139724">pending</span><span class="op" id="6139731">,</span>&nbsp;<span class="ident" id="6139733">r</span><span class="op" id="6139734">.</span><span class="ident" id="6139735">Seq</span><span class="op" id="6139738">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6139741">c</span><span class="op" id="6139742">.</span><span class="ident" id="6139743">mutex</span><span class="op" id="6139748">.</span><span class="ident" id="6139749">Unlock</span><span class="op" id="6139755">(</span><span class="op" id="6139756">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6139760">if</span>&nbsp;<span class="ident" id="6139763">b</span>&nbsp;<span class="op" id="6139765">==</span>&nbsp;<span class="ident" id="6139768">nil</span>&nbsp;<span class="op" id="6139772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6139776">//&nbsp;Invalid&nbsp;request&nbsp;so&nbsp;no&nbsp;id.&nbsp;&nbsp;Use&nbsp;JSON&nbsp;null.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6139823">b</span>&nbsp;<span class="op" id="6139825">=</span>&nbsp;<span class="op" id="6139827">&amp;</span><span class="ident" id="6139828">null</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6139834">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6139837">resp</span>&nbsp;<span class="op" id="6139842">:=</span>&nbsp;<span class="ident" id="6139845">serverResponse</span><span class="op" id="6139859">{</span><span class="ident" id="6139860">Id</span><span class="op" id="6139862">:</span>&nbsp;<span class="ident" id="6139864">b</span><span class="op" id="6139865">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6139868">if</span>&nbsp;<span class="ident" id="6139871">r</span><span class="op" id="6139872">.</span><span class="ident" id="6139873">Error</span>&nbsp;<span class="op" id="6139879">==</span>&nbsp;<span class="string" id="6139882">&#34;&#34;</span>&nbsp;<span class="op" id="6139885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6139889">resp</span><span class="op" id="6139893">.</span><span class="ident" id="6139894">Result</span>&nbsp;<span class="op" id="6139901">=</span>&nbsp;<span class="ident" id="6139903">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6139906">}</span>&nbsp;<span class="keyword" id="6139908">else</span>&nbsp;<span class="op" id="6139913">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6139917">resp</span><span class="op" id="6139921">.</span><span class="ident" id="6139922">Error</span>&nbsp;<span class="op" id="6139928">=</span>&nbsp;<span class="ident" id="6139930">r</span><span class="op" id="6139931">.</span><span class="ident" id="6139932">Error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6139939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6139942">return</span>&nbsp;<span class="ident" id="6139949">c</span><span class="op" id="6139950">.</span><span class="ident" id="6139951">enc</span><span class="op" id="6139954">.</span><span class="ident" id="6139955">Encode</span><span class="op" id="6139961">(</span><span class="ident" id="6139962">resp</span><span class="op" id="6139966">)</span><br>
<span class="lineno"></span><span class="op" id="6139968">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="keyword" id="6139971">func</span>&nbsp;<span class="op" id="6139976">(</span><span class="ident" id="6139977">c</span>&nbsp;<span class="op" id="6139979">*</span><span class="ident" id="6139980">serverCodec</span><span class="op" id="6139991">)</span>&nbsp;<span class="ident" id="6139993">Close</span><span class="op" id="6139998">(</span><span class="op" id="6139999">)</span>&nbsp;<span class="builtintype" id="6140001">error</span>&nbsp;<span class="op" id="6140007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6140010">return</span>&nbsp;<span class="ident" id="6140017">c</span><span class="op" id="6140018">.</span><span class="ident" id="6140019">c</span><span class="op" id="6140020">.</span><span class="ident" id="6140021">Close</span><span class="op" id="6140026">(</span><span class="op" id="6140027">)</span><br>
<span class="lineno"></span><span class="op" id="6140029">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6140032">//&nbsp;ServeConn&nbsp;runs&nbsp;the&nbsp;JSON-RPC&nbsp;server&nbsp;on&nbsp;a&nbsp;single&nbsp;connection.</span><br>
<span class="lineno">130</span><span class="comment" id="6140094">//&nbsp;ServeConn&nbsp;blocks,&nbsp;serving&nbsp;the&nbsp;connection&nbsp;until&nbsp;the&nbsp;client&nbsp;hangs&nbsp;up.</span><br>
<span class="lineno"></span><span class="comment" id="6140165">//&nbsp;The&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;ServeConn&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="6140226">func</span>&nbsp;<span class="ident" id="6140231">ServeConn</span><span class="op" id="6140240">(</span><span class="ident" id="6140241">conn</span>&nbsp;<span class="ident" id="6140246">io</span><span class="op" id="6140248">.</span><span class="ident" id="6140249">ReadWriteCloser</span><span class="op" id="6140264">)</span>&nbsp;<span class="op" id="6140266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6140269">rpc</span><span class="op" id="6140272">.</span><span class="ident" id="6140273">ServeCodec</span><span class="op" id="6140283">(</span><span class="ident" id="6140284">NewServerCodec</span><span class="op" id="6140298">(</span><span class="ident" id="6140299">conn</span><span class="op" id="6140303">)</span><span class="op" id="6140304">)</span><br>
<span class="lineno"></span><span class="op" id="6140306">}</span>
</div>
</body>
</html>
