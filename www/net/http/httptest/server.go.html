<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="5443914">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5443969">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5444023">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5444074">//&nbsp;Implementation&nbsp;of&nbsp;Server</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5444103">package</span>&nbsp;<span class="ident" id="5444111">httptest</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5444121">import</span>&nbsp;<span class="op" id="5444128">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5444131">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5444145">&#34;flag&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5444153">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5444160">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5444167">&#34;net/http&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5444179">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5444185">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="5444192">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5444195">//&nbsp;A&nbsp;Server&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;server&nbsp;listening&nbsp;on&nbsp;a&nbsp;system-chosen&nbsp;port&nbsp;on&nbsp;the</span><br>
<span class="lineno">20</span><span class="comment" id="5444266">//&nbsp;local&nbsp;loopback&nbsp;interface,&nbsp;for&nbsp;use&nbsp;in&nbsp;end-to-end&nbsp;HTTP&nbsp;tests.</span><br>
<span class="lineno"></span><span class="keyword" id="5444329">type</span>&nbsp;<span class="ident" id="5444334">Server</span>&nbsp;<span class="keyword" id="5444341">struct</span>&nbsp;<span class="op" id="5444348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5444351">URL</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5444360">string</span>&nbsp;<span class="comment" id="5444367">//&nbsp;base&nbsp;URL&nbsp;of&nbsp;form&nbsp;http://ipaddr:port&nbsp;with&nbsp;no&nbsp;trailing&nbsp;slash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5444430">Listener</span>&nbsp;<span class="ident" id="5444439">net</span><span class="op" id="5444442">.</span><span class="ident" id="5444443">Listener</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5444454">//&nbsp;TLS&nbsp;is&nbsp;the&nbsp;optional&nbsp;TLS&nbsp;configuration,&nbsp;populated&nbsp;with&nbsp;a&nbsp;new&nbsp;config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5444525">//&nbsp;after&nbsp;TLS&nbsp;is&nbsp;started.&nbsp;If&nbsp;set&nbsp;on&nbsp;an&nbsp;unstarted&nbsp;server&nbsp;before&nbsp;StartTLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5444597">//&nbsp;is&nbsp;called,&nbsp;existing&nbsp;fields&nbsp;are&nbsp;copied&nbsp;into&nbsp;the&nbsp;new&nbsp;config.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5444660">TLS</span>&nbsp;<span class="op" id="5444664">*</span><span class="ident" id="5444665">tls</span><span class="op" id="5444668">.</span><span class="ident" id="5444669">Config</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5444678">//&nbsp;Config&nbsp;may&nbsp;be&nbsp;changed&nbsp;after&nbsp;calling&nbsp;NewUnstartedServer&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5444741">//&nbsp;before&nbsp;Start&nbsp;or&nbsp;StartTLS.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5444771">Config</span>&nbsp;<span class="op" id="5444778">*</span><span class="ident" id="5444779">http</span><span class="op" id="5444783">.</span><span class="ident" id="5444784">Server</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5444793">//&nbsp;wg&nbsp;counts&nbsp;the&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;HTTP&nbsp;requests&nbsp;on&nbsp;this&nbsp;server.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5444863">//&nbsp;Close&nbsp;blocks&nbsp;until&nbsp;all&nbsp;requests&nbsp;are&nbsp;finished.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5444913">wg</span>&nbsp;<span class="ident" id="5444916">sync</span><span class="op" id="5444920">.</span><span class="ident" id="5444921">WaitGroup</span><br>
<span class="lineno"></span><span class="op" id="5444931">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5444934">//&nbsp;historyListener&nbsp;keeps&nbsp;track&nbsp;of&nbsp;all&nbsp;connections&nbsp;that&nbsp;it&#39;s&nbsp;ever</span><br>
<span class="lineno">40</span><span class="comment" id="5444999">//&nbsp;accepted.</span><br>
<span class="lineno"></span><span class="keyword" id="5445012">type</span>&nbsp;<span class="ident" id="5445017">historyListener</span>&nbsp;<span class="keyword" id="5445033">struct</span>&nbsp;<span class="op" id="5445040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5445043">net</span><span class="op" id="5445046">.</span><span class="ident" id="5445047">Listener</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5445057">sync</span><span class="op" id="5445061">.</span><span class="ident" id="5445062">Mutex</span>&nbsp;<span class="comment" id="5445068">//&nbsp;protects&nbsp;history</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5445089">history</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5445100">[</span><span class="op" id="5445101">]</span><span class="ident" id="5445102">net</span><span class="op" id="5445105">.</span><span class="ident" id="5445106">Conn</span><br>
<span class="lineno">45</span><span class="op" id="5445111">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5445114">func</span>&nbsp;<span class="op" id="5445119">(</span><span class="ident" id="5445120">hs</span>&nbsp;<span class="op" id="5445123">*</span><span class="ident" id="5445124">historyListener</span><span class="op" id="5445139">)</span>&nbsp;<span class="ident" id="5445141">Accept</span><span class="op" id="5445147">(</span><span class="op" id="5445148">)</span>&nbsp;<span class="op" id="5445150">(</span><span class="ident" id="5445151">c</span>&nbsp;<span class="ident" id="5445153">net</span><span class="op" id="5445156">.</span><span class="ident" id="5445157">Conn</span><span class="op" id="5445161">,</span>&nbsp;<span class="ident" id="5445163">err</span>&nbsp;<span class="builtintype" id="5445167">error</span><span class="op" id="5445172">)</span>&nbsp;<span class="op" id="5445174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5445177">c</span><span class="op" id="5445178">,</span>&nbsp;<span class="ident" id="5445180">err</span>&nbsp;<span class="op" id="5445184">=</span>&nbsp;<span class="ident" id="5445186">hs</span><span class="op" id="5445188">.</span><span class="ident" id="5445189">Listener</span><span class="op" id="5445197">.</span><span class="ident" id="5445198">Accept</span><span class="op" id="5445204">(</span><span class="op" id="5445205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445208">if</span>&nbsp;<span class="ident" id="5445211">err</span>&nbsp;<span class="op" id="5445215">==</span>&nbsp;<span class="ident" id="5445218">nil</span>&nbsp;<span class="op" id="5445222">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5445226">hs</span><span class="op" id="5445228">.</span><span class="ident" id="5445229">Lock</span><span class="op" id="5445233">(</span><span class="op" id="5445234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5445238">hs</span><span class="op" id="5445240">.</span><span class="ident" id="5445241">history</span>&nbsp;<span class="op" id="5445249">=</span>&nbsp;<span class="builtinfunc" id="5445251">append</span><span class="op" id="5445257">(</span><span class="ident" id="5445258">hs</span><span class="op" id="5445260">.</span><span class="ident" id="5445261">history</span><span class="op" id="5445268">,</span>&nbsp;<span class="ident" id="5445270">c</span><span class="op" id="5445271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5445275">hs</span><span class="op" id="5445277">.</span><span class="ident" id="5445278">Unlock</span><span class="op" id="5445284">(</span><span class="op" id="5445285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5445288">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445291">return</span><br>
<span class="lineno">55</span><span class="op" id="5445298">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5445301">func</span>&nbsp;<span class="ident" id="5445306">newLocalListener</span><span class="op" id="5445322">(</span><span class="op" id="5445323">)</span>&nbsp;<span class="ident" id="5445325">net</span><span class="op" id="5445328">.</span><span class="ident" id="5445329">Listener</span>&nbsp;<span class="op" id="5445338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445341">if</span>&nbsp;<span class="op" id="5445344">*</span><span class="ident" id="5445345">serve</span>&nbsp;<span class="op" id="5445351">!=</span>&nbsp;<span class="string" id="5445354">&#34;&#34;</span>&nbsp;<span class="op" id="5445357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5445361">l</span><span class="op" id="5445362">,</span>&nbsp;<span class="ident" id="5445364">err</span>&nbsp;<span class="op" id="5445368">:=</span>&nbsp;<span class="ident" id="5445371">net</span><span class="op" id="5445374">.</span><span class="ident" id="5445375">Listen</span><span class="op" id="5445381">(</span><span class="string" id="5445382">&#34;tcp&#34;</span><span class="op" id="5445387">,</span>&nbsp;<span class="op" id="5445389">*</span><span class="ident" id="5445390">serve</span><span class="op" id="5445395">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445399">if</span>&nbsp;<span class="ident" id="5445402">err</span>&nbsp;<span class="op" id="5445406">!=</span>&nbsp;<span class="ident" id="5445409">nil</span>&nbsp;<span class="op" id="5445413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5445418">panic</span><span class="op" id="5445423">(</span><span class="ident" id="5445424">fmt</span><span class="op" id="5445427">.</span><span class="ident" id="5445428">Sprintf</span><span class="op" id="5445435">(</span><span class="string" id="5445436">&#34;httptest:&nbsp;failed&nbsp;to&nbsp;listen&nbsp;on&nbsp;%v:&nbsp;%v&#34;</span><span class="op" id="5445474">,</span>&nbsp;<span class="op" id="5445476">*</span><span class="ident" id="5445477">serve</span><span class="op" id="5445482">,</span>&nbsp;<span class="ident" id="5445484">err</span><span class="op" id="5445487">)</span><span class="op" id="5445488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5445492">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445496">return</span>&nbsp;<span class="ident" id="5445503">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5445506">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5445509">l</span><span class="op" id="5445510">,</span>&nbsp;<span class="ident" id="5445512">err</span>&nbsp;<span class="op" id="5445516">:=</span>&nbsp;<span class="ident" id="5445519">net</span><span class="op" id="5445522">.</span><span class="ident" id="5445523">Listen</span><span class="op" id="5445529">(</span><span class="string" id="5445530">&#34;tcp&#34;</span><span class="op" id="5445535">,</span>&nbsp;<span class="string" id="5445537">&#34;127.0.0.1:0&#34;</span><span class="op" id="5445550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445553">if</span>&nbsp;<span class="ident" id="5445556">err</span>&nbsp;<span class="op" id="5445560">!=</span>&nbsp;<span class="ident" id="5445563">nil</span>&nbsp;<span class="op" id="5445567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445571">if</span>&nbsp;<span class="ident" id="5445574">l</span><span class="op" id="5445575">,</span>&nbsp;<span class="ident" id="5445577">err</span>&nbsp;<span class="op" id="5445581">=</span>&nbsp;<span class="ident" id="5445583">net</span><span class="op" id="5445586">.</span><span class="ident" id="5445587">Listen</span><span class="op" id="5445593">(</span><span class="string" id="5445594">&#34;tcp6&#34;</span><span class="op" id="5445600">,</span>&nbsp;<span class="string" id="5445602">&#34;[::1]:0&#34;</span><span class="op" id="5445611">)</span><span class="op" id="5445612">;</span>&nbsp;<span class="ident" id="5445614">err</span>&nbsp;<span class="op" id="5445618">!=</span>&nbsp;<span class="ident" id="5445621">nil</span>&nbsp;<span class="op" id="5445625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5445630">panic</span><span class="op" id="5445635">(</span><span class="ident" id="5445636">fmt</span><span class="op" id="5445639">.</span><span class="ident" id="5445640">Sprintf</span><span class="op" id="5445647">(</span><span class="string" id="5445648">&#34;httptest:&nbsp;failed&nbsp;to&nbsp;listen&nbsp;on&nbsp;a&nbsp;port:&nbsp;%v&#34;</span><span class="op" id="5445690">,</span>&nbsp;<span class="ident" id="5445692">err</span><span class="op" id="5445695">)</span><span class="op" id="5445696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5445700">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5445703">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445706">return</span>&nbsp;<span class="ident" id="5445713">l</span><br>
<span class="lineno"></span><span class="op" id="5445715">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5445718">//&nbsp;When&nbsp;debugging&nbsp;a&nbsp;particular&nbsp;http&nbsp;server-based&nbsp;test,</span><br>
<span class="lineno">75</span><span class="comment" id="5445773">//&nbsp;this&nbsp;flag&nbsp;lets&nbsp;you&nbsp;run</span><br>
<span class="lineno"></span><span class="comment" id="5445799">//&nbsp;&nbsp;&nbsp;&nbspgo&nbsp;test&nbsp;-run=BrokenTest&nbsp;-httptest.serve=127.0.0.1:8000</span><br>
<span class="lineno"></span><span class="comment" id="5445857">//&nbsp;to&nbsp;start&nbsp;the&nbsp;broken&nbsp;server&nbsp;so&nbsp;you&nbsp;can&nbsp;interact&nbsp;with&nbsp;it&nbsp;manually.</span><br>
<span class="lineno"></span><span class="keyword" id="5445925">var</span>&nbsp;<span class="ident" id="5445929">serve</span>&nbsp;<span class="op" id="5445935">=</span>&nbsp;<span class="ident" id="5445937">flag</span><span class="op" id="5445941">.</span><span class="ident" id="5445942">String</span><span class="op" id="5445948">(</span><span class="string" id="5445949">&#34;httptest.serve&#34;</span><span class="op" id="5445965">,</span>&nbsp;<span class="string" id="5445967">&#34;&#34;</span><span class="op" id="5445969">,</span>&nbsp;<span class="string" id="5445971">&#34;if&nbsp;non-empty,&nbsp;httptest.NewServer&nbsp;serves&nbsp;on&nbsp;this&nbsp;address&nbsp;and&nbsp;blocks&#34;</span><span class="op" id="5446039">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment" id="5446042">//&nbsp;NewServer&nbsp;starts&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server.</span><br>
<span class="lineno"></span><span class="comment" id="5446088">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="5446152">func</span>&nbsp;<span class="ident" id="5446157">NewServer</span><span class="op" id="5446166">(</span><span class="ident" id="5446167">handler</span>&nbsp;<span class="ident" id="5446175">http</span><span class="op" id="5446179">.</span><span class="ident" id="5446180">Handler</span><span class="op" id="5446187">)</span>&nbsp;<span class="op" id="5446189">*</span><span class="ident" id="5446190">Server</span>&nbsp;<span class="op" id="5446197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5446200">ts</span>&nbsp;<span class="op" id="5446203">:=</span>&nbsp;<span class="ident" id="5446206">NewUnstartedServer</span><span class="op" id="5446224">(</span><span class="ident" id="5446225">handler</span><span class="op" id="5446232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5446235">ts</span><span class="op" id="5446237">.</span><span class="ident" id="5446238">Start</span><span class="op" id="5446243">(</span><span class="op" id="5446244">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5446247">return</span>&nbsp;<span class="ident" id="5446254">ts</span><br>
<span class="lineno"></span><span class="op" id="5446257">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5446260">//&nbsp;NewUnstartedServer&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server&nbsp;but&nbsp;doesn&#39;t&nbsp;start&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="5446325">//</span><br>
<span class="lineno">90</span><span class="comment" id="5446328">//&nbsp;After&nbsp;changing&nbsp;its&nbsp;configuration,&nbsp;the&nbsp;caller&nbsp;should&nbsp;call&nbsp;Start&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="5446397">//&nbsp;StartTLS.</span><br>
<span class="lineno"></span><span class="comment" id="5446410">//</span><br>
<span class="lineno"></span><span class="comment" id="5446413">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="5446477">func</span>&nbsp;<span class="ident" id="5446482">NewUnstartedServer</span><span class="op" id="5446500">(</span><span class="ident" id="5446501">handler</span>&nbsp;<span class="ident" id="5446509">http</span><span class="op" id="5446513">.</span><span class="ident" id="5446514">Handler</span><span class="op" id="5446521">)</span>&nbsp;<span class="op" id="5446523">*</span><span class="ident" id="5446524">Server</span>&nbsp;<span class="op" id="5446531">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5446534">return</span>&nbsp;<span class="op" id="5446541">&amp;</span><span class="ident" id="5446542">Server</span><span class="op" id="5446548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5446552">Listener</span><span class="op" id="5446560">:</span>&nbsp;<span class="ident" id="5446562">newLocalListener</span><span class="op" id="5446578">(</span><span class="op" id="5446579">)</span><span class="op" id="5446580">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5446584">Config</span><span class="op" id="5446590">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5446594">&amp;</span><span class="ident" id="5446595">http</span><span class="op" id="5446599">.</span><span class="ident" id="5446600">Server</span><span class="op" id="5446606">{</span><span class="ident" id="5446607">Handler</span><span class="op" id="5446614">:</span>&nbsp;<span class="ident" id="5446616">handler</span><span class="op" id="5446623">}</span><span class="op" id="5446624">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5446627">}</span><br>
<span class="lineno"></span><span class="op" id="5446629">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="5446632">//&nbsp;Start&nbsp;starts&nbsp;a&nbsp;server&nbsp;from&nbsp;NewUnstartedServer.</span><br>
<span class="lineno"></span><span class="keyword" id="5446682">func</span>&nbsp;<span class="op" id="5446687">(</span><span class="ident" id="5446688">s</span>&nbsp;<span class="op" id="5446690">*</span><span class="ident" id="5446691">Server</span><span class="op" id="5446697">)</span>&nbsp;<span class="ident" id="5446699">Start</span><span class="op" id="5446704">(</span><span class="op" id="5446705">)</span>&nbsp;<span class="op" id="5446707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5446710">if</span>&nbsp;<span class="ident" id="5446713">s</span><span class="op" id="5446714">.</span><span class="ident" id="5446715">URL</span>&nbsp;<span class="op" id="5446719">!=</span>&nbsp;<span class="string" id="5446722">&#34;&#34;</span>&nbsp;<span class="op" id="5446725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5446729">panic</span><span class="op" id="5446734">(</span><span class="string" id="5446735">&#34;Server&nbsp;already&nbsp;started&#34;</span><span class="op" id="5446759">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5446762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5446765">s</span><span class="op" id="5446766">.</span><span class="ident" id="5446767">Listener</span>&nbsp;<span class="op" id="5446776">=</span>&nbsp;<span class="op" id="5446778">&amp;</span><span class="ident" id="5446779">historyListener</span><span class="op" id="5446794">{</span><span class="ident" id="5446795">Listener</span><span class="op" id="5446803">:</span>&nbsp;<span class="ident" id="5446805">s</span><span class="op" id="5446806">.</span><span class="ident" id="5446807">Listener</span><span class="op" id="5446815">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5446818">s</span><span class="op" id="5446819">.</span><span class="ident" id="5446820">URL</span>&nbsp;<span class="op" id="5446824">=</span>&nbsp;<span class="string" id="5446826">&#34;http://&#34;</span>&nbsp;<span class="op" id="5446836">+</span>&nbsp;<span class="ident" id="5446838">s</span><span class="op" id="5446839">.</span><span class="ident" id="5446840">Listener</span><span class="op" id="5446848">.</span><span class="ident" id="5446849">Addr</span><span class="op" id="5446853">(</span><span class="op" id="5446854">)</span><span class="op" id="5446855">.</span><span class="ident" id="5446856">String</span><span class="op" id="5446862">(</span><span class="op" id="5446863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5446866">s</span><span class="op" id="5446867">.</span><span class="ident" id="5446868">wrapHandler</span><span class="op" id="5446879">(</span><span class="op" id="5446880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5446883">go</span>&nbsp;<span class="ident" id="5446886">s</span><span class="op" id="5446887">.</span><span class="ident" id="5446888">Config</span><span class="op" id="5446894">.</span><span class="ident" id="5446895">Serve</span><span class="op" id="5446900">(</span><span class="ident" id="5446901">s</span><span class="op" id="5446902">.</span><span class="ident" id="5446903">Listener</span><span class="op" id="5446911">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5446914">if</span>&nbsp;<span class="op" id="5446917">*</span><span class="ident" id="5446918">serve</span>&nbsp;<span class="op" id="5446924">!=</span>&nbsp;<span class="string" id="5446927">&#34;&#34;</span>&nbsp;<span class="op" id="5446930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5446934">fmt</span><span class="op" id="5446937">.</span><span class="ident" id="5446938">Fprintln</span><span class="op" id="5446946">(</span><span class="ident" id="5446947">os</span><span class="op" id="5446949">.</span><span class="ident" id="5446950">Stderr</span><span class="op" id="5446956">,</span>&nbsp;<span class="string" id="5446958">&#34;httptest:&nbsp;serving&nbsp;on&#34;</span><span class="op" id="5446980">,</span>&nbsp;<span class="ident" id="5446982">s</span><span class="op" id="5446983">.</span><span class="ident" id="5446984">URL</span><span class="op" id="5446987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5446991">select</span>&nbsp;<span class="op" id="5446998">{</span><span class="op" id="5446999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5447002">}</span><br>
<span class="lineno"></span><span class="op" id="5447004">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="comment" id="5447007">//&nbsp;StartTLS&nbsp;starts&nbsp;TLS&nbsp;on&nbsp;a&nbsp;server&nbsp;from&nbsp;NewUnstartedServer.</span><br>
<span class="lineno"></span><span class="keyword" id="5447067">func</span>&nbsp;<span class="op" id="5447072">(</span><span class="ident" id="5447073">s</span>&nbsp;<span class="op" id="5447075">*</span><span class="ident" id="5447076">Server</span><span class="op" id="5447082">)</span>&nbsp;<span class="ident" id="5447084">StartTLS</span><span class="op" id="5447092">(</span><span class="op" id="5447093">)</span>&nbsp;<span class="op" id="5447095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5447098">if</span>&nbsp;<span class="ident" id="5447101">s</span><span class="op" id="5447102">.</span><span class="ident" id="5447103">URL</span>&nbsp;<span class="op" id="5447107">!=</span>&nbsp;<span class="string" id="5447110">&#34;&#34;</span>&nbsp;<span class="op" id="5447113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5447117">panic</span><span class="op" id="5447122">(</span><span class="string" id="5447123">&#34;Server&nbsp;already&nbsp;started&#34;</span><span class="op" id="5447147">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5447150">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5447153">cert</span><span class="op" id="5447157">,</span>&nbsp;<span class="ident" id="5447159">err</span>&nbsp;<span class="op" id="5447163">:=</span>&nbsp;<span class="ident" id="5447166">tls</span><span class="op" id="5447169">.</span><span class="ident" id="5447170">X509KeyPair</span><span class="op" id="5447181">(</span><span class="ident" id="5447182">localhostCert</span><span class="op" id="5447195">,</span>&nbsp;<span class="ident" id="5447197">localhostKey</span><span class="op" id="5447209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5447212">if</span>&nbsp;<span class="ident" id="5447215">err</span>&nbsp;<span class="op" id="5447219">!=</span>&nbsp;<span class="ident" id="5447222">nil</span>&nbsp;<span class="op" id="5447226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5447230">panic</span><span class="op" id="5447235">(</span><span class="ident" id="5447236">fmt</span><span class="op" id="5447239">.</span><span class="ident" id="5447240">Sprintf</span><span class="op" id="5447247">(</span><span class="string" id="5447248">&#34;httptest:&nbsp;NewTLSServer:&nbsp;%v&#34;</span><span class="op" id="5447276">,</span>&nbsp;<span class="ident" id="5447278">err</span><span class="op" id="5447281">)</span><span class="op" id="5447282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5447285">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5447289">existingConfig</span>&nbsp;<span class="op" id="5447304">:=</span>&nbsp;<span class="ident" id="5447307">s</span><span class="op" id="5447308">.</span><span class="ident" id="5447309">TLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5447314">s</span><span class="op" id="5447315">.</span><span class="ident" id="5447316">TLS</span>&nbsp;<span class="op" id="5447320">=</span>&nbsp;<span class="builtinfunc" id="5447322">new</span><span class="op" id="5447325">(</span><span class="ident" id="5447326">tls</span><span class="op" id="5447329">.</span><span class="ident" id="5447330">Config</span><span class="op" id="5447336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5447339">if</span>&nbsp;<span class="ident" id="5447342">existingConfig</span>&nbsp;<span class="op" id="5447357">!=</span>&nbsp;<span class="ident" id="5447360">nil</span>&nbsp;<span class="op" id="5447364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5447368">*</span><span class="ident" id="5447369">s</span><span class="op" id="5447370">.</span><span class="ident" id="5447371">TLS</span>&nbsp;<span class="op" id="5447375">=</span>&nbsp;<span class="op" id="5447377">*</span><span class="ident" id="5447378">existingConfig</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5447394">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5447397">if</span>&nbsp;<span class="ident" id="5447400">s</span><span class="op" id="5447401">.</span><span class="ident" id="5447402">TLS</span><span class="op" id="5447405">.</span><span class="ident" id="5447406">NextProtos</span>&nbsp;<span class="op" id="5447417">==</span>&nbsp;<span class="ident" id="5447420">nil</span>&nbsp;<span class="op" id="5447424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5447428">s</span><span class="op" id="5447429">.</span><span class="ident" id="5447430">TLS</span><span class="op" id="5447433">.</span><span class="ident" id="5447434">NextProtos</span>&nbsp;<span class="op" id="5447445">=</span>&nbsp;<span class="op" id="5447447">[</span><span class="op" id="5447448">]</span><span class="builtintype" id="5447449">string</span><span class="op" id="5447455">{</span><span class="string" id="5447456">&#34;http/1.1&#34;</span><span class="op" id="5447466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5447469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5447472">if</span>&nbsp;<span class="builtinfunc" id="5447475">len</span><span class="op" id="5447478">(</span><span class="ident" id="5447479">s</span><span class="op" id="5447480">.</span><span class="ident" id="5447481">TLS</span><span class="op" id="5447484">.</span><span class="ident" id="5447485">Certificates</span><span class="op" id="5447497">)</span>&nbsp;<span class="op" id="5447499">==</span>&nbsp;<span class="num" id="5447502">0</span>&nbsp;<span class="op" id="5447504">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5447508">s</span><span class="op" id="5447509">.</span><span class="ident" id="5447510">TLS</span><span class="op" id="5447513">.</span><span class="ident" id="5447514">Certificates</span>&nbsp;<span class="op" id="5447527">=</span>&nbsp;<span class="op" id="5447529">[</span><span class="op" id="5447530">]</span><span class="ident" id="5447531">tls</span><span class="op" id="5447534">.</span><span class="ident" id="5447535">Certificate</span><span class="op" id="5447546">{</span><span class="ident" id="5447547">cert</span><span class="op" id="5447551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5447554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5447557">tlsListener</span>&nbsp;<span class="op" id="5447569">:=</span>&nbsp;<span class="ident" id="5447572">tls</span><span class="op" id="5447575">.</span><span class="ident" id="5447576">NewListener</span><span class="op" id="5447587">(</span><span class="ident" id="5447588">s</span><span class="op" id="5447589">.</span><span class="ident" id="5447590">Listener</span><span class="op" id="5447598">,</span>&nbsp;<span class="ident" id="5447600">s</span><span class="op" id="5447601">.</span><span class="ident" id="5447602">TLS</span><span class="op" id="5447605">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5447609">s</span><span class="op" id="5447610">.</span><span class="ident" id="5447611">Listener</span>&nbsp;<span class="op" id="5447620">=</span>&nbsp;<span class="op" id="5447622">&amp;</span><span class="ident" id="5447623">historyListener</span><span class="op" id="5447638">{</span><span class="ident" id="5447639">Listener</span><span class="op" id="5447647">:</span>&nbsp;<span class="ident" id="5447649">tlsListener</span><span class="op" id="5447660">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5447663">s</span><span class="op" id="5447664">.</span><span class="ident" id="5447665">URL</span>&nbsp;<span class="op" id="5447669">=</span>&nbsp;<span class="string" id="5447671">&#34;https://&#34;</span>&nbsp;<span class="op" id="5447682">+</span>&nbsp;<span class="ident" id="5447684">s</span><span class="op" id="5447685">.</span><span class="ident" id="5447686">Listener</span><span class="op" id="5447694">.</span><span class="ident" id="5447695">Addr</span><span class="op" id="5447699">(</span><span class="op" id="5447700">)</span><span class="op" id="5447701">.</span><span class="ident" id="5447702">String</span><span class="op" id="5447708">(</span><span class="op" id="5447709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5447712">s</span><span class="op" id="5447713">.</span><span class="ident" id="5447714">wrapHandler</span><span class="op" id="5447725">(</span><span class="op" id="5447726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5447729">go</span>&nbsp;<span class="ident" id="5447732">s</span><span class="op" id="5447733">.</span><span class="ident" id="5447734">Config</span><span class="op" id="5447740">.</span><span class="ident" id="5447741">Serve</span><span class="op" id="5447746">(</span><span class="ident" id="5447747">s</span><span class="op" id="5447748">.</span><span class="ident" id="5447749">Listener</span><span class="op" id="5447757">)</span><br>
<span class="lineno"></span><span class="op" id="5447759">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="5447762">func</span>&nbsp;<span class="op" id="5447767">(</span><span class="ident" id="5447768">s</span>&nbsp;<span class="op" id="5447770">*</span><span class="ident" id="5447771">Server</span><span class="op" id="5447777">)</span>&nbsp;<span class="ident" id="5447779">wrapHandler</span><span class="op" id="5447790">(</span><span class="op" id="5447791">)</span>&nbsp;<span class="op" id="5447793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5447796">h</span>&nbsp;<span class="op" id="5447798">:=</span>&nbsp;<span class="ident" id="5447801">s</span><span class="op" id="5447802">.</span><span class="ident" id="5447803">Config</span><span class="op" id="5447809">.</span><span class="ident" id="5447810">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5447819">if</span>&nbsp;<span class="ident" id="5447822">h</span>&nbsp;<span class="op" id="5447824">==</span>&nbsp;<span class="ident" id="5447827">nil</span>&nbsp;<span class="op" id="5447831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5447835">h</span>&nbsp;<span class="op" id="5447837">=</span>&nbsp;<span class="ident" id="5447839">http</span><span class="op" id="5447843">.</span><span class="ident" id="5447844">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5447861">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5447864">s</span><span class="op" id="5447865">.</span><span class="ident" id="5447866">Config</span><span class="op" id="5447872">.</span><span class="ident" id="5447873">Handler</span>&nbsp;<span class="op" id="5447881">=</span>&nbsp;<span class="op" id="5447883">&amp;</span><span class="ident" id="5447884">waitGroupHandler</span><span class="op" id="5447900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5447904">s</span><span class="op" id="5447905">:</span>&nbsp;<span class="ident" id="5447907">s</span><span class="op" id="5447908">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5447912">h</span><span class="op" id="5447913">:</span>&nbsp;<span class="ident" id="5447915">h</span><span class="op" id="5447916">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5447919">}</span><br>
<span class="lineno"></span><span class="op" id="5447921">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="5447924">//&nbsp;NewTLSServer&nbsp;starts&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server&nbsp;using&nbsp;TLS.</span><br>
<span class="lineno"></span><span class="comment" id="5447983">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="5448047">func</span>&nbsp;<span class="ident" id="5448052">NewTLSServer</span><span class="op" id="5448064">(</span><span class="ident" id="5448065">handler</span>&nbsp;<span class="ident" id="5448073">http</span><span class="op" id="5448077">.</span><span class="ident" id="5448078">Handler</span><span class="op" id="5448085">)</span>&nbsp;<span class="op" id="5448087">*</span><span class="ident" id="5448088">Server</span>&nbsp;<span class="op" id="5448095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5448098">ts</span>&nbsp;<span class="op" id="5448101">:=</span>&nbsp;<span class="ident" id="5448104">NewUnstartedServer</span><span class="op" id="5448122">(</span><span class="ident" id="5448123">handler</span><span class="op" id="5448130">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5448133">ts</span><span class="op" id="5448135">.</span><span class="ident" id="5448136">StartTLS</span><span class="op" id="5448144">(</span><span class="op" id="5448145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5448148">return</span>&nbsp;<span class="ident" id="5448155">ts</span><br>
<span class="lineno"></span><span class="op" id="5448158">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5448161">//&nbsp;Close&nbsp;shuts&nbsp;down&nbsp;the&nbsp;server&nbsp;and&nbsp;blocks&nbsp;until&nbsp;all&nbsp;outstanding</span><br>
<span class="lineno">165</span><span class="comment" id="5448225">//&nbsp;requests&nbsp;on&nbsp;this&nbsp;server&nbsp;have&nbsp;completed.</span><br>
<span class="lineno"></span><span class="keyword" id="5448268">func</span>&nbsp;<span class="op" id="5448273">(</span><span class="ident" id="5448274">s</span>&nbsp;<span class="op" id="5448276">*</span><span class="ident" id="5448277">Server</span><span class="op" id="5448283">)</span>&nbsp;<span class="ident" id="5448285">Close</span><span class="op" id="5448290">(</span><span class="op" id="5448291">)</span>&nbsp;<span class="op" id="5448293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5448296">s</span><span class="op" id="5448297">.</span><span class="ident" id="5448298">Listener</span><span class="op" id="5448306">.</span><span class="ident" id="5448307">Close</span><span class="op" id="5448312">(</span><span class="op" id="5448313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5448316">s</span><span class="op" id="5448317">.</span><span class="ident" id="5448318">wg</span><span class="op" id="5448320">.</span><span class="ident" id="5448321">Wait</span><span class="op" id="5448325">(</span><span class="op" id="5448326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5448329">s</span><span class="op" id="5448330">.</span><span class="ident" id="5448331">CloseClientConnections</span><span class="op" id="5448353">(</span><span class="op" id="5448354">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5448357">if</span>&nbsp;<span class="ident" id="5448360">t</span><span class="op" id="5448361">,</span>&nbsp;<span class="ident" id="5448363">ok</span>&nbsp;<span class="op" id="5448366">:=</span>&nbsp;<span class="ident" id="5448369">http</span><span class="op" id="5448373">.</span><span class="ident" id="5448374">DefaultTransport</span><span class="op" id="5448390">.</span><span class="op" id="5448391">(</span><span class="op" id="5448392">*</span><span class="ident" id="5448393">http</span><span class="op" id="5448397">.</span><span class="ident" id="5448398">Transport</span><span class="op" id="5448407">)</span><span class="op" id="5448408">;</span>&nbsp;<span class="ident" id="5448410">ok</span>&nbsp;<span class="op" id="5448413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5448417">t</span><span class="op" id="5448418">.</span><span class="ident" id="5448419">CloseIdleConnections</span><span class="op" id="5448439">(</span><span class="op" id="5448440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5448443">}</span><br>
<span class="lineno"></span><span class="op" id="5448445">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="comment" id="5448448">//&nbsp;CloseClientConnections&nbsp;closes&nbsp;any&nbsp;currently&nbsp;open&nbsp;HTTP&nbsp;connections</span><br>
<span class="lineno"></span><span class="comment" id="5448517">//&nbsp;to&nbsp;the&nbsp;test&nbsp;Server.</span><br>
<span class="lineno"></span><span class="keyword" id="5448540">func</span>&nbsp;<span class="op" id="5448545">(</span><span class="ident" id="5448546">s</span>&nbsp;<span class="op" id="5448548">*</span><span class="ident" id="5448549">Server</span><span class="op" id="5448555">)</span>&nbsp;<span class="ident" id="5448557">CloseClientConnections</span><span class="op" id="5448579">(</span><span class="op" id="5448580">)</span>&nbsp;<span class="op" id="5448582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5448585">hl</span><span class="op" id="5448587">,</span>&nbsp;<span class="ident" id="5448589">ok</span>&nbsp;<span class="op" id="5448592">:=</span>&nbsp;<span class="ident" id="5448595">s</span><span class="op" id="5448596">.</span><span class="ident" id="5448597">Listener</span><span class="op" id="5448605">.</span><span class="op" id="5448606">(</span><span class="op" id="5448607">*</span><span class="ident" id="5448608">historyListener</span><span class="op" id="5448623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5448626">if</span>&nbsp;<span class="op" id="5448629">!</span><span class="ident" id="5448630">ok</span>&nbsp;<span class="op" id="5448633">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5448637">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5448645">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5448648">hl</span><span class="op" id="5448650">.</span><span class="ident" id="5448651">Lock</span><span class="op" id="5448655">(</span><span class="op" id="5448656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5448659">for</span>&nbsp;<span class="ident" id="5448663">_</span><span class="op" id="5448664">,</span>&nbsp;<span class="ident" id="5448666">conn</span>&nbsp;<span class="op" id="5448671">:=</span>&nbsp;<span class="keyword" id="5448674">range</span>&nbsp;<span class="ident" id="5448680">hl</span><span class="op" id="5448682">.</span><span class="ident" id="5448683">history</span>&nbsp;<span class="op" id="5448691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5448695">conn</span><span class="op" id="5448699">.</span><span class="ident" id="5448700">Close</span><span class="op" id="5448705">(</span><span class="op" id="5448706">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5448709">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5448712">hl</span><span class="op" id="5448714">.</span><span class="ident" id="5448715">Unlock</span><span class="op" id="5448721">(</span><span class="op" id="5448722">)</span><br>
<span class="lineno"></span><span class="op" id="5448724">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5448727">//&nbsp;waitGroupHandler&nbsp;wraps&nbsp;a&nbsp;handler,&nbsp;incrementing&nbsp;and&nbsp;decrementing&nbsp;a</span><br>
<span class="lineno">190</span><span class="comment" id="5448796">//&nbsp;sync.WaitGroup&nbsp;on&nbsp;each&nbsp;request,&nbsp;to&nbsp;enable&nbsp;Server.Close&nbsp;to&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="5448863">//&nbsp;until&nbsp;outstanding&nbsp;requests&nbsp;are&nbsp;finished.</span><br>
<span class="lineno"></span><span class="keyword" id="5448907">type</span>&nbsp;<span class="ident" id="5448912">waitGroupHandler</span>&nbsp;<span class="keyword" id="5448929">struct</span>&nbsp;<span class="op" id="5448936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5448939">s</span>&nbsp;<span class="op" id="5448941">*</span><span class="ident" id="5448942">Server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5448950">h</span>&nbsp;<span class="ident" id="5448952">http</span><span class="op" id="5448956">.</span><span class="ident" id="5448957">Handler</span>&nbsp;<span class="comment" id="5448965">//&nbsp;non-nil</span><br>
<span class="lineno">195</span><span class="op" id="5448976">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5448979">func</span>&nbsp;<span class="op" id="5448984">(</span><span class="ident" id="5448985">h</span>&nbsp;<span class="op" id="5448987">*</span><span class="ident" id="5448988">waitGroupHandler</span><span class="op" id="5449004">)</span>&nbsp;<span class="ident" id="5449006">ServeHTTP</span><span class="op" id="5449015">(</span><span class="ident" id="5449016">w</span>&nbsp;<span class="ident" id="5449018">http</span><span class="op" id="5449022">.</span><span class="ident" id="5449023">ResponseWriter</span><span class="op" id="5449037">,</span>&nbsp;<span class="ident" id="5449039">r</span>&nbsp;<span class="op" id="5449041">*</span><span class="ident" id="5449042">http</span><span class="op" id="5449046">.</span><span class="ident" id="5449047">Request</span><span class="op" id="5449054">)</span>&nbsp;<span class="op" id="5449056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5449059">h</span><span class="op" id="5449060">.</span><span class="ident" id="5449061">s</span><span class="op" id="5449062">.</span><span class="ident" id="5449063">wg</span><span class="op" id="5449065">.</span><span class="ident" id="5449066">Add</span><span class="op" id="5449069">(</span><span class="num" id="5449070">1</span><span class="op" id="5449071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5449074">defer</span>&nbsp;<span class="ident" id="5449080">h</span><span class="op" id="5449081">.</span><span class="ident" id="5449082">s</span><span class="op" id="5449083">.</span><span class="ident" id="5449084">wg</span><span class="op" id="5449086">.</span><span class="ident" id="5449087">Done</span><span class="op" id="5449091">(</span><span class="op" id="5449092">)</span>&nbsp;<span class="comment" id="5449094">//&nbsp;a&nbsp;defer,&nbsp;in&nbsp;case&nbsp;ServeHTTP&nbsp;below&nbsp;panics</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5449138">h</span><span class="op" id="5449139">.</span><span class="ident" id="5449140">h</span><span class="op" id="5449141">.</span><span class="ident" id="5449142">ServeHTTP</span><span class="op" id="5449151">(</span><span class="ident" id="5449152">w</span><span class="op" id="5449153">,</span>&nbsp;<span class="ident" id="5449155">r</span><span class="op" id="5449156">)</span><br>
<span class="lineno"></span><span class="op" id="5449158">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5449161">//&nbsp;localhostCert&nbsp;is&nbsp;a&nbsp;PEM-encoded&nbsp;TLS&nbsp;cert&nbsp;with&nbsp;SAN&nbsp;IPs</span><br>
<span class="lineno"></span><span class="comment" id="5449217">//&nbsp;&#34;127.0.0.1&#34;&nbsp;and&nbsp;&#34;[::1]&#34;,&nbsp;expiring&nbsp;at&nbsp;the&nbsp;last&nbsp;second&nbsp;of&nbsp;2049&nbsp;(the&nbsp;end</span><br>
<span class="lineno">205</span><span class="comment" id="5449290">//&nbsp;of&nbsp;ASN.1&nbsp;time).</span><br>
<span class="lineno"></span><span class="comment" id="5449309">//&nbsp;generated&nbsp;from&nbsp;src/crypto/tls:</span><br>
<span class="lineno"></span><span class="comment" id="5449343">//&nbsp;go&nbsp;run&nbsp;generate_cert.go&nbsp;&nbsp;--rsa-bits&nbsp;512&nbsp;--host&nbsp;127.0.0.1,::1,example.com&nbsp;--ca&nbsp;--start-date&nbsp;&#34;Jan&nbsp;1&nbsp;00:00:00&nbsp;1970&#34;&nbsp;--duration=1000000h</span><br>
<span class="lineno"></span><span class="keyword" id="5449479">var</span>&nbsp;<span class="ident" id="5449483">localhostCert</span>&nbsp;<span class="op" id="5449497">=</span>&nbsp;<span class="op" id="5449499">[</span><span class="op" id="5449500">]</span><span class="builtintype" id="5449501">byte</span><span class="op" id="5449505">(</span><span class="string" id="5449506">`-----BEGIN&nbsp;CERTIFICATE-----<br>
<span class="lineno"></span>MIIBdzCCASOgAwIBAgIBADALBgkqhkiG9w0BAQUwEjEQMA4GA1UEChMHQWNtZSBD<br>
<span class="lineno">210</span>bzAeFw03MDAxMDEwMDAwMDBaFw00OTEyMzEyMzU5NTlaMBIxEDAOBgNVBAoTB0Fj<br>
<span class="lineno"></span>bWUgQ28wWjALBgkqhkiG9w0BAQEDSwAwSAJBAN55NcYKZeInyTuhcCwFMhDHCmwa<br>
<span class="lineno"></span>IUSdtXdcbItRB/yfXGBhiex00IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEA<br>
<span class="lineno"></span>AaNoMGYwDgYDVR0PAQH/BAQDAgCkMBMGA1UdJQQMMAoGCCsGAQUFBwMBMA8GA1Ud<br>
<span class="lineno"></span>EwEB/wQFMAMBAf8wLgYDVR0RBCcwJYILZXhhbXBsZS5jb22HBH8AAAGHEAAAAAAA<br>
<span class="lineno">215</span>AAAAAAAAAAAAAAEwCwYJKoZIhvcNAQEFA0EAAoQn/ytgqpiLcZu9XKbCJsJcvkgk<br>
<span class="lineno"></span>Se6AbGXgSlq+ZCEVo0qIwSgeBqmsJxUu7NCSOwVJLYNEBO2DtIxoYVk+MA==<br>
<span class="lineno"></span>-----END&nbsp;CERTIFICATE-----`</span><span class="op" id="5450077">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5450080">//&nbsp;localhostKey&nbsp;is&nbsp;the&nbsp;private&nbsp;key&nbsp;for&nbsp;localhostCert.</span><br>
<span class="lineno">220</span><span class="keyword" id="5450134">var</span>&nbsp;<span class="ident" id="5450138">localhostKey</span>&nbsp;<span class="op" id="5450151">=</span>&nbsp;<span class="op" id="5450153">[</span><span class="op" id="5450154">]</span><span class="builtintype" id="5450155">byte</span><span class="op" id="5450159">(</span><span class="string" id="5450160">`-----BEGIN&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----<br>
<span class="lineno"></span>MIIBPAIBAAJBAN55NcYKZeInyTuhcCwFMhDHCmwaIUSdtXdcbItRB/yfXGBhiex0<br>
<span class="lineno"></span>0IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEAAQJBAQdUx66rfh8sYsgfdcvV<br>
<span class="lineno"></span>NoafYpnEcB5s4m/vSVe6SU7dCK6eYec9f9wpT353ljhDUHq3EbmE4foNzJngh35d<br>
<span class="lineno"></span>AekCIQDhRQG5Li0Wj8TM4obOnnXUXf1jRv0UkzE9AHWLG5q3AwIhAPzSjpYUDjVW<br>
<span class="lineno">225</span>MCUXgckTpKCuGwbJk7424Nb8bLzf3kllAiA5mUBgjfr/WtFSJdWcPQ4Zt9KTMNKD<br>
<span class="lineno"></span>EUO0ukpTwEIl6wIhAMbGqZK3zAAFdq8DD2jPx+UJXnh0rnOkZBzDtJ6/iN69AiEA<br>
<span class="lineno"></span>1Aq8MJgTaYsDQWyU/hDq5YkDJc9e9DSCvUIzqxQWMQE=<br>
<span class="lineno"></span>-----END&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----`</span><span class="op" id="5450658">)</span>
</div>
</body>
</html>
