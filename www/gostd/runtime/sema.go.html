<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html" class="current">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1666759">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1666814">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1666868">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1666919">//&nbsp;Semaphore&nbsp;implementation&nbsp;exposed&nbsp;to&nbsp;Go.</span><br>
<span class="lineno"></span><span class="comment" id="1666962">//&nbsp;Intended&nbsp;use&nbsp;is&nbsp;provide&nbsp;a&nbsp;sleep&nbsp;and&nbsp;wakeup</span><br>
<span class="lineno"></span><span class="comment" id="1667008">//&nbsp;primitive&nbsp;that&nbsp;can&nbsp;be&nbsp;used&nbsp;in&nbsp;the&nbsp;contended&nbsp;case</span><br>
<span class="lineno"></span><span class="comment" id="1667060">//&nbsp;of&nbsp;other&nbsp;synchronization&nbsp;primitives.</span><br>
<span class="lineno"></span><span class="comment" id="1667100">//&nbsp;Thus&nbsp;it&nbsp;targets&nbsp;the&nbsp;same&nbsp;goal&nbsp;as&nbsp;Linux&#39;s&nbsp;futex,</span><br>
<span class="lineno">10</span><span class="comment" id="1667151">//&nbsp;but&nbsp;it&nbsp;has&nbsp;much&nbsp;simpler&nbsp;semantics.</span><br>
<span class="lineno"></span><span class="comment" id="1667189">//</span><br>
<span class="lineno"></span><span class="comment" id="1667192">//&nbsp;That&nbsp;is,&nbsp;don&#39;t&nbsp;think&nbsp;of&nbsp;these&nbsp;as&nbsp;semaphores.</span><br>
<span class="lineno"></span><span class="comment" id="1667240">//&nbsp;Think&nbsp;of&nbsp;them&nbsp;as&nbsp;a&nbsp;way&nbsp;to&nbsp;implement&nbsp;sleep&nbsp;and&nbsp;wakeup</span><br>
<span class="lineno"></span><span class="comment" id="1667296">//&nbsp;such&nbsp;that&nbsp;every&nbsp;sleep&nbsp;is&nbsp;paired&nbsp;with&nbsp;a&nbsp;single&nbsp;wakeup,</span><br>
<span class="lineno">15</span><span class="comment" id="1667353">//&nbsp;even&nbsp;if,&nbsp;due&nbsp;to&nbsp;races,&nbsp;the&nbsp;wakeup&nbsp;happens&nbsp;before&nbsp;the&nbsp;sleep.</span><br>
<span class="lineno"></span><span class="comment" id="1667416">//</span><br>
<span class="lineno"></span><span class="comment" id="1667419">//&nbsp;See&nbsp;Mullender&nbsp;and&nbsp;Cox,&nbsp;``Semaphores&nbsp;in&nbsp;Plan&nbsp;9,&#39;&#39;</span><br>
<span class="lineno"></span><span class="comment" id="1667471">//&nbsp;http://swtch.com/semaphore.pdf</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="1667506">package</span>&nbsp;<span class="ident" id="1667514">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1667523">import</span>&nbsp;<span class="string" id="1667530">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1667540">//&nbsp;Asynchronous&nbsp;semaphore&nbsp;for&nbsp;sync.Mutex.</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="1667583">type</span>&nbsp;<span class="ident" id="1667588">semaRoot</span>&nbsp;<span class="keyword" id="1667597">struct</span>&nbsp;<span class="op" id="1667604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1667607">lock</span>&nbsp;&nbsp;<span class="ident" id="1667613">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1667620">head</span>&nbsp;&nbsp;<span class="op" id="1667626">*</span><span class="ident" id="1667627">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1667634">tail</span>&nbsp;&nbsp;<span class="op" id="1667640">*</span><span class="ident" id="1667641">sudog</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1667648">nwait</span>&nbsp;<span class="builtintype" id="1667654">uint32</span>&nbsp;<span class="comment" id="1667661">//&nbsp;Number&nbsp;of&nbsp;waiters.&nbsp;Read&nbsp;w/o&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="op" id="1667702">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1667705">//&nbsp;Prime&nbsp;to&nbsp;not&nbsp;correlate&nbsp;with&nbsp;any&nbsp;user&nbsp;patterns.</span><br>
<span class="lineno"></span><span class="keyword" id="1667755">const</span>&nbsp;<span class="ident" id="1667761">semTabSize</span>&nbsp;<span class="op" id="1667772">=</span>&nbsp;<span class="num" id="1667774">251</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="1667779">var</span>&nbsp;<span class="ident" id="1667783">semtable</span>&nbsp;<span class="op" id="1667792">[</span><span class="ident" id="1667793">semTabSize</span><span class="op" id="1667803">]</span><span class="keyword" id="1667804">struct</span>&nbsp;<span class="op" id="1667811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1667814">root</span>&nbsp;<span class="ident" id="1667819">semaRoot</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1667829">pad</span>&nbsp;&nbsp;<span class="op" id="1667834">[</span><span class="ident" id="1667835">_CacheLineSize</span>&nbsp;<span class="op" id="1667850">-</span>&nbsp;<span class="ident" id="1667852">unsafe</span><span class="op" id="1667858">.</span><span class="ident" id="1667859">Sizeof</span><span class="op" id="1667865">(</span><span class="ident" id="1667866">semaRoot</span><span class="op" id="1667874">{</span><span class="op" id="1667875">}</span><span class="op" id="1667876">)</span><span class="op" id="1667877">]</span><span class="builtintype" id="1667878">byte</span><br>
<span class="lineno"></span><span class="op" id="1667883">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="1667886">//&nbsp;Called&nbsp;from&nbsp;sync/net&nbsp;packages.</span><br>
<span class="lineno"></span><span class="keyword" id="1667920">func</span>&nbsp;<span class="ident" id="1667925">asyncsemacquire</span><span class="op" id="1667940">(</span><span class="ident" id="1667941">addr</span>&nbsp;<span class="op" id="1667946">*</span><span class="builtintype" id="1667947">uint32</span><span class="op" id="1667953">)</span>&nbsp;<span class="op" id="1667955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1667958">semacquire</span><span class="op" id="1667968">(</span><span class="ident" id="1667969">addr</span><span class="op" id="1667973">,</span>&nbsp;<span class="builtintype" id="1667975">true</span><span class="op" id="1667979">)</span><br>
<span class="lineno"></span><span class="op" id="1667981">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="keyword" id="1667984">func</span>&nbsp;<span class="ident" id="1667989">asyncsemrelease</span><span class="op" id="1668004">(</span><span class="ident" id="1668005">addr</span>&nbsp;<span class="op" id="1668010">*</span><span class="builtintype" id="1668011">uint32</span><span class="op" id="1668017">)</span>&nbsp;<span class="op" id="1668019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1668022">semrelease</span><span class="op" id="1668032">(</span><span class="ident" id="1668033">addr</span><span class="op" id="1668037">)</span><br>
<span class="lineno"></span><span class="op" id="1668039">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="1668042">//&nbsp;Called&nbsp;from&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="keyword" id="1668066">func</span>&nbsp;<span class="ident" id="1668071">semacquire</span><span class="op" id="1668081">(</span><span class="ident" id="1668082">addr</span>&nbsp;<span class="op" id="1668087">*</span><span class="builtintype" id="1668088">uint32</span><span class="op" id="1668094">,</span>&nbsp;<span class="ident" id="1668096">profile</span>&nbsp;<span class="builtintype" id="1668104">bool</span><span class="op" id="1668108">)</span>&nbsp;<span class="op" id="1668110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1668113">gp</span>&nbsp;<span class="op" id="1668116">:=</span>&nbsp;<span class="ident" id="1668119">getg</span><span class="op" id="1668123">(</span><span class="op" id="1668124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1668127">if</span>&nbsp;<span class="ident" id="1668130">gp</span>&nbsp;<span class="op" id="1668133">!=</span>&nbsp;<span class="ident" id="1668136">gp</span><span class="op" id="1668138">.</span><span class="ident" id="1668139">m</span><span class="op" id="1668140">.</span><span class="ident" id="1668141">curg</span>&nbsp;<span class="op" id="1668146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1668150">gothrow</span><span class="op" id="1668157">(</span><span class="string" id="1668158">&#34;semacquire&nbsp;not&nbsp;on&nbsp;the&nbsp;G&nbsp;stack&#34;</span><span class="op" id="1668189">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1668192">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1668196">//&nbsp;Easy&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1668211">if</span>&nbsp;<span class="ident" id="1668214">cansemacquire</span><span class="op" id="1668227">(</span><span class="ident" id="1668228">addr</span><span class="op" id="1668232">)</span>&nbsp;<span class="op" id="1668234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1668238">return</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1668246">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1668250">//&nbsp;Harder&nbsp;case:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1668267">//&nbsp;&nbsp;&nbsp;&nbsp;increment&nbsp;waiter&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1668294">//&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;cansemacquire&nbsp;one&nbsp;more&nbsp;time,&nbsp;return&nbsp;if&nbsp;succeeded</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1668351">//&nbsp;&nbsp;&nbsp;&nbsp;enqueue&nbsp;itself&nbsp;as&nbsp;a&nbsp;waiter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1668382">//&nbsp;&nbsp;&nbsp;&nbsp;sleep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1668392">//&nbsp;&nbsp;&nbsp;&nbsp;(waiter&nbsp;descriptor&nbsp;is&nbsp;dequeued&nbsp;by&nbsp;signaler)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1668440">s</span>&nbsp;<span class="op" id="1668442">:=</span>&nbsp;<span class="ident" id="1668445">acquireSudog</span><span class="op" id="1668457">(</span><span class="op" id="1668458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1668461">root</span>&nbsp;<span class="op" id="1668466">:=</span>&nbsp;<span class="ident" id="1668469">semroot</span><span class="op" id="1668476">(</span><span class="ident" id="1668477">addr</span><span class="op" id="1668481">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1668484">t0</span>&nbsp;<span class="op" id="1668487">:=</span>&nbsp;<span class="ident" id="1668490">int64</span><span class="op" id="1668495">(</span><span class="num" id="1668496">0</span><span class="op" id="1668497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1668500">s</span><span class="op" id="1668501">.</span><span class="ident" id="1668502">releasetime</span>&nbsp;<span class="op" id="1668514">=</span>&nbsp;<span class="num" id="1668516">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1668519">if</span>&nbsp;<span class="ident" id="1668522">profile</span>&nbsp;<span class="op" id="1668530">&amp;&amp;</span>&nbsp;<span class="ident" id="1668533">blockprofilerate</span>&nbsp;<span class="op" id="1668550">&gt;</span>&nbsp;<span class="num" id="1668552">0</span>&nbsp;<span class="op" id="1668554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1668558">t0</span>&nbsp;<span class="op" id="1668561">=</span>&nbsp;<span class="ident" id="1668563">cputicks</span><span class="op" id="1668571">(</span><span class="op" id="1668572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1668576">s</span><span class="op" id="1668577">.</span><span class="ident" id="1668578">releasetime</span>&nbsp;<span class="op" id="1668590">=</span>&nbsp;<span class="op" id="1668592">-</span><span class="num" id="1668593">1</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1668596">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1668599">for</span>&nbsp;<span class="op" id="1668603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1668607">lock</span><span class="op" id="1668611">(</span><span class="op" id="1668612">&amp;</span><span class="ident" id="1668613">root</span><span class="op" id="1668617">.</span><span class="ident" id="1668618">lock</span><span class="op" id="1668622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1668626">//&nbsp;Add&nbsp;ourselves&nbsp;to&nbsp;nwait&nbsp;to&nbsp;disable&nbsp;&#34;easy&nbsp;case&#34;&nbsp;in&nbsp;semrelease.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1668692">xadd</span><span class="op" id="1668696">(</span><span class="op" id="1668697">&amp;</span><span class="ident" id="1668698">root</span><span class="op" id="1668702">.</span><span class="ident" id="1668703">nwait</span><span class="op" id="1668708">,</span>&nbsp;<span class="num" id="1668710">1</span><span class="op" id="1668711">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1668715">//&nbsp;Check&nbsp;cansemacquire&nbsp;to&nbsp;avoid&nbsp;missed&nbsp;wakeup.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1668764">if</span>&nbsp;<span class="ident" id="1668767">cansemacquire</span><span class="op" id="1668780">(</span><span class="ident" id="1668781">addr</span><span class="op" id="1668785">)</span>&nbsp;<span class="op" id="1668787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1668792">xadd</span><span class="op" id="1668796">(</span><span class="op" id="1668797">&amp;</span><span class="ident" id="1668798">root</span><span class="op" id="1668802">.</span><span class="ident" id="1668803">nwait</span><span class="op" id="1668808">,</span>&nbsp;<span class="op" id="1668810">-</span><span class="num" id="1668811">1</span><span class="op" id="1668812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1668817">unlock</span><span class="op" id="1668823">(</span><span class="op" id="1668824">&amp;</span><span class="ident" id="1668825">root</span><span class="op" id="1668829">.</span><span class="ident" id="1668830">lock</span><span class="op" id="1668834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1668839">break</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1668847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1668851">//&nbsp;Any&nbsp;semrelease&nbsp;after&nbsp;the&nbsp;cansemacquire&nbsp;knows&nbsp;we&#39;re&nbsp;waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1668915">//&nbsp;(we&nbsp;set&nbsp;nwait&nbsp;above),&nbsp;so&nbsp;go&nbsp;to&nbsp;sleep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1668958">root</span><span class="op" id="1668962">.</span><span class="ident" id="1668963">queue</span><span class="op" id="1668968">(</span><span class="ident" id="1668969">addr</span><span class="op" id="1668973">,</span>&nbsp;<span class="ident" id="1668975">s</span><span class="op" id="1668976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1668980">goparkunlock</span><span class="op" id="1668992">(</span><span class="op" id="1668993">&amp;</span><span class="ident" id="1668994">root</span><span class="op" id="1668998">.</span><span class="ident" id="1668999">lock</span><span class="op" id="1669003">,</span>&nbsp;<span class="string" id="1669005">&#34;semacquire&#34;</span><span class="op" id="1669017">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1669021">if</span>&nbsp;<span class="ident" id="1669024">cansemacquire</span><span class="op" id="1669037">(</span><span class="ident" id="1669038">addr</span><span class="op" id="1669042">)</span>&nbsp;<span class="op" id="1669044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1669049">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1669057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1669060">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1669063">if</span>&nbsp;<span class="ident" id="1669066">s</span><span class="op" id="1669067">.</span><span class="ident" id="1669068">releasetime</span>&nbsp;<span class="op" id="1669080">&gt;</span>&nbsp;<span class="num" id="1669082">0</span>&nbsp;<span class="op" id="1669084">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1669088">blockevent</span><span class="op" id="1669098">(</span><span class="ident" id="1669099">int64</span><span class="op" id="1669104">(</span><span class="ident" id="1669105">s</span><span class="op" id="1669106">.</span><span class="ident" id="1669107">releasetime</span><span class="op" id="1669118">)</span><span class="op" id="1669119">-</span><span class="ident" id="1669120">t0</span><span class="op" id="1669122">,</span>&nbsp;<span class="num" id="1669124">3</span><span class="op" id="1669125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1669128">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1669131">releaseSudog</span><span class="op" id="1669143">(</span><span class="ident" id="1669144">s</span><span class="op" id="1669145">)</span><br>
<span class="lineno"></span><span class="op" id="1669147">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="1669150">func</span>&nbsp;<span class="ident" id="1669155">semrelease</span><span class="op" id="1669165">(</span><span class="ident" id="1669166">addr</span>&nbsp;<span class="op" id="1669171">*</span><span class="builtintype" id="1669172">uint32</span><span class="op" id="1669178">)</span>&nbsp;<span class="op" id="1669180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1669183">root</span>&nbsp;<span class="op" id="1669188">:=</span>&nbsp;<span class="ident" id="1669191">semroot</span><span class="op" id="1669198">(</span><span class="ident" id="1669199">addr</span><span class="op" id="1669203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1669206">xadd</span><span class="op" id="1669210">(</span><span class="ident" id="1669211">addr</span><span class="op" id="1669215">,</span>&nbsp;<span class="num" id="1669217">1</span><span class="op" id="1669218">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1669222">//&nbsp;Easy&nbsp;case:&nbsp;no&nbsp;waiters?</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1669249">//&nbsp;This&nbsp;check&nbsp;must&nbsp;happen&nbsp;after&nbsp;the&nbsp;xadd,&nbsp;to&nbsp;avoid&nbsp;a&nbsp;missed&nbsp;wakeup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1669317">//&nbsp;(see&nbsp;loop&nbsp;in&nbsp;semacquire).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1669347">if</span>&nbsp;<span class="ident" id="1669350">atomicload</span><span class="op" id="1669360">(</span><span class="op" id="1669361">&amp;</span><span class="ident" id="1669362">root</span><span class="op" id="1669366">.</span><span class="ident" id="1669367">nwait</span><span class="op" id="1669372">)</span>&nbsp;<span class="op" id="1669374">==</span>&nbsp;<span class="num" id="1669377">0</span>&nbsp;<span class="op" id="1669379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1669383">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1669391">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1669395">//&nbsp;Harder&nbsp;case:&nbsp;search&nbsp;for&nbsp;a&nbsp;waiter&nbsp;and&nbsp;wake&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1669445">lock</span><span class="op" id="1669449">(</span><span class="op" id="1669450">&amp;</span><span class="ident" id="1669451">root</span><span class="op" id="1669455">.</span><span class="ident" id="1669456">lock</span><span class="op" id="1669460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1669463">if</span>&nbsp;<span class="ident" id="1669466">atomicload</span><span class="op" id="1669476">(</span><span class="op" id="1669477">&amp;</span><span class="ident" id="1669478">root</span><span class="op" id="1669482">.</span><span class="ident" id="1669483">nwait</span><span class="op" id="1669488">)</span>&nbsp;<span class="op" id="1669490">==</span>&nbsp;<span class="num" id="1669493">0</span>&nbsp;<span class="op" id="1669495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1669499">//&nbsp;The&nbsp;count&nbsp;is&nbsp;already&nbsp;consumed&nbsp;by&nbsp;another&nbsp;goroutine,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1669556">//&nbsp;so&nbsp;no&nbsp;need&nbsp;to&nbsp;wake&nbsp;up&nbsp;another&nbsp;goroutine.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1669602">unlock</span><span class="op" id="1669608">(</span><span class="op" id="1669609">&amp;</span><span class="ident" id="1669610">root</span><span class="op" id="1669614">.</span><span class="ident" id="1669615">lock</span><span class="op" id="1669619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1669623">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1669631">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1669634">s</span>&nbsp;<span class="op" id="1669636">:=</span>&nbsp;<span class="ident" id="1669639">root</span><span class="op" id="1669643">.</span><span class="ident" id="1669644">head</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1669650">for</span>&nbsp;<span class="op" id="1669654">;</span>&nbsp;<span class="ident" id="1669656">s</span>&nbsp;<span class="op" id="1669658">!=</span>&nbsp;<span class="builtintype" id="1669661">nil</span><span class="op" id="1669664">;</span>&nbsp;<span class="ident" id="1669666">s</span>&nbsp;<span class="op" id="1669668">=</span>&nbsp;<span class="ident" id="1669670">s</span><span class="op" id="1669671">.</span><span class="ident" id="1669672">next</span>&nbsp;<span class="op" id="1669677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1669681">if</span>&nbsp;<span class="ident" id="1669684">s</span><span class="op" id="1669685">.</span><span class="ident" id="1669686">elem</span>&nbsp;<span class="op" id="1669691">==</span>&nbsp;<span class="ident" id="1669694">unsafe</span><span class="op" id="1669700">.</span><span class="ident" id="1669701">Pointer</span><span class="op" id="1669708">(</span><span class="ident" id="1669709">addr</span><span class="op" id="1669713">)</span>&nbsp;<span class="op" id="1669715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1669720">xadd</span><span class="op" id="1669724">(</span><span class="op" id="1669725">&amp;</span><span class="ident" id="1669726">root</span><span class="op" id="1669730">.</span><span class="ident" id="1669731">nwait</span><span class="op" id="1669736">,</span>&nbsp;<span class="op" id="1669738">-</span><span class="num" id="1669739">1</span><span class="op" id="1669740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1669745">root</span><span class="op" id="1669749">.</span><span class="ident" id="1669750">dequeue</span><span class="op" id="1669757">(</span><span class="ident" id="1669758">s</span><span class="op" id="1669759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1669764">break</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1669772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1669775">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1669778">unlock</span><span class="op" id="1669784">(</span><span class="op" id="1669785">&amp;</span><span class="ident" id="1669786">root</span><span class="op" id="1669790">.</span><span class="ident" id="1669791">lock</span><span class="op" id="1669795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1669798">if</span>&nbsp;<span class="ident" id="1669801">s</span>&nbsp;<span class="op" id="1669803">!=</span>&nbsp;<span class="builtintype" id="1669806">nil</span>&nbsp;<span class="op" id="1669810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1669814">if</span>&nbsp;<span class="ident" id="1669817">s</span><span class="op" id="1669818">.</span><span class="ident" id="1669819">releasetime</span>&nbsp;<span class="op" id="1669831">!=</span>&nbsp;<span class="num" id="1669834">0</span>&nbsp;<span class="op" id="1669836">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1669841">s</span><span class="op" id="1669842">.</span><span class="ident" id="1669843">releasetime</span>&nbsp;<span class="op" id="1669855">=</span>&nbsp;<span class="ident" id="1669857">cputicks</span><span class="op" id="1669865">(</span><span class="op" id="1669866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1669870">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1669874">goready</span><span class="op" id="1669881">(</span><span class="ident" id="1669882">s</span><span class="op" id="1669883">.</span><span class="ident" id="1669884">g</span><span class="op" id="1669885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1669888">}</span><br>
<span class="lineno"></span><span class="op" id="1669890">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="1669893">func</span>&nbsp;<span class="ident" id="1669898">semroot</span><span class="op" id="1669905">(</span><span class="ident" id="1669906">addr</span>&nbsp;<span class="op" id="1669911">*</span><span class="builtintype" id="1669912">uint32</span><span class="op" id="1669918">)</span>&nbsp;<span class="op" id="1669920">*</span><span class="ident" id="1669921">semaRoot</span>&nbsp;<span class="op" id="1669930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1669933">return</span>&nbsp;<span class="op" id="1669940">&amp;</span><span class="ident" id="1669941">semtable</span><span class="op" id="1669949">[</span><span class="op" id="1669950">(</span><span class="builtintype" id="1669951">uintptr</span><span class="op" id="1669958">(</span><span class="ident" id="1669959">unsafe</span><span class="op" id="1669965">.</span><span class="ident" id="1669966">Pointer</span><span class="op" id="1669973">(</span><span class="ident" id="1669974">addr</span><span class="op" id="1669978">)</span><span class="op" id="1669979">)</span><span class="op" id="1669980">&gt;&gt;</span><span class="num" id="1669982">3</span><span class="op" id="1669983">)</span><span class="op" id="1669984">%</span><span class="ident" id="1669985">semTabSize</span><span class="op" id="1669995">]</span><span class="op" id="1669996">.</span><span class="ident" id="1669997">root</span><br>
<span class="lineno"></span><span class="op" id="1670002">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="keyword" id="1670005">func</span>&nbsp;<span class="ident" id="1670010">cansemacquire</span><span class="op" id="1670023">(</span><span class="ident" id="1670024">addr</span>&nbsp;<span class="op" id="1670029">*</span><span class="builtintype" id="1670030">uint32</span><span class="op" id="1670036">)</span>&nbsp;<span class="builtintype" id="1670038">bool</span>&nbsp;<span class="op" id="1670043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1670046">for</span>&nbsp;<span class="op" id="1670050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1670054">v</span>&nbsp;<span class="op" id="1670056">:=</span>&nbsp;<span class="ident" id="1670059">atomicload</span><span class="op" id="1670069">(</span><span class="ident" id="1670070">addr</span><span class="op" id="1670074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1670078">if</span>&nbsp;<span class="ident" id="1670081">v</span>&nbsp;<span class="op" id="1670083">==</span>&nbsp;<span class="num" id="1670086">0</span>&nbsp;<span class="op" id="1670088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1670093">return</span>&nbsp;<span class="builtintype" id="1670100">false</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1670108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1670112">if</span>&nbsp;<span class="ident" id="1670115">cas</span><span class="op" id="1670118">(</span><span class="ident" id="1670119">addr</span><span class="op" id="1670123">,</span>&nbsp;<span class="ident" id="1670125">v</span><span class="op" id="1670126">,</span>&nbsp;<span class="ident" id="1670128">v</span><span class="op" id="1670129">-</span><span class="num" id="1670130">1</span><span class="op" id="1670131">)</span>&nbsp;<span class="op" id="1670133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1670138">return</span>&nbsp;<span class="builtintype" id="1670145">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1670152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1670155">}</span><br>
<span class="lineno">150</span><span class="op" id="1670157">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1670160">func</span>&nbsp;<span class="op" id="1670165">(</span><span class="ident" id="1670166">root</span>&nbsp;<span class="op" id="1670171">*</span><span class="ident" id="1670172">semaRoot</span><span class="op" id="1670180">)</span>&nbsp;<span class="ident" id="1670182">queue</span><span class="op" id="1670187">(</span><span class="ident" id="1670188">addr</span>&nbsp;<span class="op" id="1670193">*</span><span class="builtintype" id="1670194">uint32</span><span class="op" id="1670200">,</span>&nbsp;<span class="ident" id="1670202">s</span>&nbsp;<span class="op" id="1670204">*</span><span class="ident" id="1670205">sudog</span><span class="op" id="1670210">)</span>&nbsp;<span class="op" id="1670212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1670215">s</span><span class="op" id="1670216">.</span><span class="ident" id="1670217">g</span>&nbsp;<span class="op" id="1670219">=</span>&nbsp;<span class="ident" id="1670221">getg</span><span class="op" id="1670225">(</span><span class="op" id="1670226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1670229">s</span><span class="op" id="1670230">.</span><span class="ident" id="1670231">elem</span>&nbsp;<span class="op" id="1670236">=</span>&nbsp;<span class="ident" id="1670238">unsafe</span><span class="op" id="1670244">.</span><span class="ident" id="1670245">Pointer</span><span class="op" id="1670252">(</span><span class="ident" id="1670253">addr</span><span class="op" id="1670257">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1670260">s</span><span class="op" id="1670261">.</span><span class="ident" id="1670262">next</span>&nbsp;<span class="op" id="1670267">=</span>&nbsp;<span class="builtintype" id="1670269">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1670274">s</span><span class="op" id="1670275">.</span><span class="ident" id="1670276">prev</span>&nbsp;<span class="op" id="1670281">=</span>&nbsp;<span class="ident" id="1670283">root</span><span class="op" id="1670287">.</span><span class="ident" id="1670288">tail</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1670294">if</span>&nbsp;<span class="ident" id="1670297">root</span><span class="op" id="1670301">.</span><span class="ident" id="1670302">tail</span>&nbsp;<span class="op" id="1670307">!=</span>&nbsp;<span class="builtintype" id="1670310">nil</span>&nbsp;<span class="op" id="1670314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1670318">root</span><span class="op" id="1670322">.</span><span class="ident" id="1670323">tail</span><span class="op" id="1670327">.</span><span class="ident" id="1670328">next</span>&nbsp;<span class="op" id="1670333">=</span>&nbsp;<span class="ident" id="1670335">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1670338">}</span>&nbsp;<span class="keyword" id="1670340">else</span>&nbsp;<span class="op" id="1670345">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1670349">root</span><span class="op" id="1670353">.</span><span class="ident" id="1670354">head</span>&nbsp;<span class="op" id="1670359">=</span>&nbsp;<span class="ident" id="1670361">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1670364">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1670367">root</span><span class="op" id="1670371">.</span><span class="ident" id="1670372">tail</span>&nbsp;<span class="op" id="1670377">=</span>&nbsp;<span class="ident" id="1670379">s</span><br>
<span class="lineno"></span><span class="op" id="1670381">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="1670384">func</span>&nbsp;<span class="op" id="1670389">(</span><span class="ident" id="1670390">root</span>&nbsp;<span class="op" id="1670395">*</span><span class="ident" id="1670396">semaRoot</span><span class="op" id="1670404">)</span>&nbsp;<span class="ident" id="1670406">dequeue</span><span class="op" id="1670413">(</span><span class="ident" id="1670414">s</span>&nbsp;<span class="op" id="1670416">*</span><span class="ident" id="1670417">sudog</span><span class="op" id="1670422">)</span>&nbsp;<span class="op" id="1670424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1670427">if</span>&nbsp;<span class="ident" id="1670430">s</span><span class="op" id="1670431">.</span><span class="ident" id="1670432">next</span>&nbsp;<span class="op" id="1670437">!=</span>&nbsp;<span class="builtintype" id="1670440">nil</span>&nbsp;<span class="op" id="1670444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1670448">s</span><span class="op" id="1670449">.</span><span class="ident" id="1670450">next</span><span class="op" id="1670454">.</span><span class="ident" id="1670455">prev</span>&nbsp;<span class="op" id="1670460">=</span>&nbsp;<span class="ident" id="1670462">s</span><span class="op" id="1670463">.</span><span class="ident" id="1670464">prev</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1670470">}</span>&nbsp;<span class="keyword" id="1670472">else</span>&nbsp;<span class="op" id="1670477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1670481">root</span><span class="op" id="1670485">.</span><span class="ident" id="1670486">tail</span>&nbsp;<span class="op" id="1670491">=</span>&nbsp;<span class="ident" id="1670493">s</span><span class="op" id="1670494">.</span><span class="ident" id="1670495">prev</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1670501">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1670504">if</span>&nbsp;<span class="ident" id="1670507">s</span><span class="op" id="1670508">.</span><span class="ident" id="1670509">prev</span>&nbsp;<span class="op" id="1670514">!=</span>&nbsp;<span class="builtintype" id="1670517">nil</span>&nbsp;<span class="op" id="1670521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1670525">s</span><span class="op" id="1670526">.</span><span class="ident" id="1670527">prev</span><span class="op" id="1670531">.</span><span class="ident" id="1670532">next</span>&nbsp;<span class="op" id="1670537">=</span>&nbsp;<span class="ident" id="1670539">s</span><span class="op" id="1670540">.</span><span class="ident" id="1670541">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1670547">}</span>&nbsp;<span class="keyword" id="1670549">else</span>&nbsp;<span class="op" id="1670554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1670558">root</span><span class="op" id="1670562">.</span><span class="ident" id="1670563">head</span>&nbsp;<span class="op" id="1670568">=</span>&nbsp;<span class="ident" id="1670570">s</span><span class="op" id="1670571">.</span><span class="ident" id="1670572">next</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1670578">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1670581">s</span><span class="op" id="1670582">.</span><span class="ident" id="1670583">elem</span>&nbsp;<span class="op" id="1670588">=</span>&nbsp;<span class="builtintype" id="1670590">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1670595">s</span><span class="op" id="1670596">.</span><span class="ident" id="1670597">next</span>&nbsp;<span class="op" id="1670602">=</span>&nbsp;<span class="builtintype" id="1670604">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1670609">s</span><span class="op" id="1670610">.</span><span class="ident" id="1670611">prev</span>&nbsp;<span class="op" id="1670616">=</span>&nbsp;<span class="builtintype" id="1670618">nil</span><br>
<span class="lineno"></span><span class="op" id="1670622">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span><span class="comment" id="1670625">//&nbsp;Synchronous&nbsp;semaphore&nbsp;for&nbsp;sync.Cond.</span><br>
<span class="lineno"></span><span class="keyword" id="1670665">type</span>&nbsp;<span class="ident" id="1670670">syncSema</span>&nbsp;<span class="keyword" id="1670679">struct</span>&nbsp;<span class="op" id="1670686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1670689">lock</span>&nbsp;<span class="ident" id="1670694">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1670701">head</span>&nbsp;<span class="op" id="1670706">*</span><span class="ident" id="1670707">sudog</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1670714">tail</span>&nbsp;<span class="op" id="1670719">*</span><span class="ident" id="1670720">sudog</span><br>
<span class="lineno"></span><span class="op" id="1670726">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1670729">//&nbsp;Syncsemacquire&nbsp;waits&nbsp;for&nbsp;a&nbsp;pairing&nbsp;syncsemrelease&nbsp;on&nbsp;the&nbsp;same&nbsp;semaphore&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="1670807">func</span>&nbsp;<span class="ident" id="1670812">syncsemacquire</span><span class="op" id="1670826">(</span><span class="ident" id="1670827">s</span>&nbsp;<span class="op" id="1670829">*</span><span class="ident" id="1670830">syncSema</span><span class="op" id="1670838">)</span>&nbsp;<span class="op" id="1670840">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1670843">lock</span><span class="op" id="1670847">(</span><span class="op" id="1670848">&amp;</span><span class="ident" id="1670849">s</span><span class="op" id="1670850">.</span><span class="ident" id="1670851">lock</span><span class="op" id="1670855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1670858">if</span>&nbsp;<span class="ident" id="1670861">s</span><span class="op" id="1670862">.</span><span class="ident" id="1670863">head</span>&nbsp;<span class="op" id="1670868">!=</span>&nbsp;<span class="builtintype" id="1670871">nil</span>&nbsp;<span class="op" id="1670875">&amp;&amp;</span>&nbsp;<span class="ident" id="1670878">s</span><span class="op" id="1670879">.</span><span class="ident" id="1670880">head</span><span class="op" id="1670884">.</span><span class="ident" id="1670885">nrelease</span>&nbsp;<span class="op" id="1670894">&gt;</span>&nbsp;<span class="num" id="1670896">0</span>&nbsp;<span class="op" id="1670898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1670902">//&nbsp;Have&nbsp;pending&nbsp;release,&nbsp;consume&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1670941">var</span>&nbsp;<span class="ident" id="1670945">wake</span>&nbsp;<span class="op" id="1670950">*</span><span class="ident" id="1670951">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1670959">s</span><span class="op" id="1670960">.</span><span class="ident" id="1670961">head</span><span class="op" id="1670965">.</span><span class="ident" id="1670966">nrelease</span><span class="op" id="1670974">--</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1670979">if</span>&nbsp;<span class="ident" id="1670982">s</span><span class="op" id="1670983">.</span><span class="ident" id="1670984">head</span><span class="op" id="1670988">.</span><span class="ident" id="1670989">nrelease</span>&nbsp;<span class="op" id="1670998">==</span>&nbsp;<span class="num" id="1671001">0</span>&nbsp;<span class="op" id="1671003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1671008">wake</span>&nbsp;<span class="op" id="1671013">=</span>&nbsp;<span class="ident" id="1671015">s</span><span class="op" id="1671016">.</span><span class="ident" id="1671017">head</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1671025">s</span><span class="op" id="1671026">.</span><span class="ident" id="1671027">head</span>&nbsp;<span class="op" id="1671032">=</span>&nbsp;<span class="ident" id="1671034">wake</span><span class="op" id="1671038">.</span><span class="ident" id="1671039">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1671047">if</span>&nbsp;<span class="ident" id="1671050">s</span><span class="op" id="1671051">.</span><span class="ident" id="1671052">head</span>&nbsp;<span class="op" id="1671057">==</span>&nbsp;<span class="builtintype" id="1671060">nil</span>&nbsp;<span class="op" id="1671064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1671070">s</span><span class="op" id="1671071">.</span><span class="ident" id="1671072">tail</span>&nbsp;<span class="op" id="1671077">=</span>&nbsp;<span class="builtintype" id="1671079">nil</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1671086">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1671090">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1671094">unlock</span><span class="op" id="1671100">(</span><span class="op" id="1671101">&amp;</span><span class="ident" id="1671102">s</span><span class="op" id="1671103">.</span><span class="ident" id="1671104">lock</span><span class="op" id="1671108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1671112">if</span>&nbsp;<span class="ident" id="1671115">wake</span>&nbsp;<span class="op" id="1671120">!=</span>&nbsp;<span class="builtintype" id="1671123">nil</span>&nbsp;<span class="op" id="1671127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1671132">wake</span><span class="op" id="1671136">.</span><span class="ident" id="1671137">next</span>&nbsp;<span class="op" id="1671142">=</span>&nbsp;<span class="builtintype" id="1671144">nil</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1671151">goready</span><span class="op" id="1671158">(</span><span class="ident" id="1671159">wake</span><span class="op" id="1671163">.</span><span class="ident" id="1671164">g</span><span class="op" id="1671165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1671169">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1671172">}</span>&nbsp;<span class="keyword" id="1671174">else</span>&nbsp;<span class="op" id="1671179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1671183">//&nbsp;Enqueue&nbsp;itself.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1671204">w</span>&nbsp;<span class="op" id="1671206">:=</span>&nbsp;<span class="ident" id="1671209">acquireSudog</span><span class="op" id="1671221">(</span><span class="op" id="1671222">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1671226">w</span><span class="op" id="1671227">.</span><span class="ident" id="1671228">g</span>&nbsp;<span class="op" id="1671230">=</span>&nbsp;<span class="ident" id="1671232">getg</span><span class="op" id="1671236">(</span><span class="op" id="1671237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1671241">w</span><span class="op" id="1671242">.</span><span class="ident" id="1671243">nrelease</span>&nbsp;<span class="op" id="1671252">=</span>&nbsp;<span class="op" id="1671254">-</span><span class="num" id="1671255">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1671259">w</span><span class="op" id="1671260">.</span><span class="ident" id="1671261">next</span>&nbsp;<span class="op" id="1671266">=</span>&nbsp;<span class="builtintype" id="1671268">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1671274">w</span><span class="op" id="1671275">.</span><span class="ident" id="1671276">releasetime</span>&nbsp;<span class="op" id="1671288">=</span>&nbsp;<span class="num" id="1671290">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1671294">t0</span>&nbsp;<span class="op" id="1671297">:=</span>&nbsp;<span class="ident" id="1671300">int64</span><span class="op" id="1671305">(</span><span class="num" id="1671306">0</span><span class="op" id="1671307">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1671311">if</span>&nbsp;<span class="ident" id="1671314">blockprofilerate</span>&nbsp;<span class="op" id="1671331">&gt;</span>&nbsp;<span class="num" id="1671333">0</span>&nbsp;<span class="op" id="1671335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1671340">t0</span>&nbsp;<span class="op" id="1671343">=</span>&nbsp;<span class="ident" id="1671345">cputicks</span><span class="op" id="1671353">(</span><span class="op" id="1671354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1671359">w</span><span class="op" id="1671360">.</span><span class="ident" id="1671361">releasetime</span>&nbsp;<span class="op" id="1671373">=</span>&nbsp;<span class="op" id="1671375">-</span><span class="num" id="1671376">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1671380">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1671384">if</span>&nbsp;<span class="ident" id="1671387">s</span><span class="op" id="1671388">.</span><span class="ident" id="1671389">tail</span>&nbsp;<span class="op" id="1671394">==</span>&nbsp;<span class="builtintype" id="1671397">nil</span>&nbsp;<span class="op" id="1671401">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1671406">s</span><span class="op" id="1671407">.</span><span class="ident" id="1671408">head</span>&nbsp;<span class="op" id="1671413">=</span>&nbsp;<span class="ident" id="1671415">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1671419">}</span>&nbsp;<span class="keyword" id="1671421">else</span>&nbsp;<span class="op" id="1671426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1671431">s</span><span class="op" id="1671432">.</span><span class="ident" id="1671433">tail</span><span class="op" id="1671437">.</span><span class="ident" id="1671438">next</span>&nbsp;<span class="op" id="1671443">=</span>&nbsp;<span class="ident" id="1671445">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1671449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1671453">s</span><span class="op" id="1671454">.</span><span class="ident" id="1671455">tail</span>&nbsp;<span class="op" id="1671460">=</span>&nbsp;<span class="ident" id="1671462">w</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1671466">goparkunlock</span><span class="op" id="1671478">(</span><span class="op" id="1671479">&amp;</span><span class="ident" id="1671480">s</span><span class="op" id="1671481">.</span><span class="ident" id="1671482">lock</span><span class="op" id="1671486">,</span>&nbsp;<span class="string" id="1671488">&#34;semacquire&#34;</span><span class="op" id="1671500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1671504">if</span>&nbsp;<span class="ident" id="1671507">t0</span>&nbsp;<span class="op" id="1671510">!=</span>&nbsp;<span class="num" id="1671513">0</span>&nbsp;<span class="op" id="1671515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1671520">blockevent</span><span class="op" id="1671530">(</span><span class="ident" id="1671531">int64</span><span class="op" id="1671536">(</span><span class="ident" id="1671537">w</span><span class="op" id="1671538">.</span><span class="ident" id="1671539">releasetime</span><span class="op" id="1671550">)</span><span class="op" id="1671551">-</span><span class="ident" id="1671552">t0</span><span class="op" id="1671554">,</span>&nbsp;<span class="num" id="1671556">2</span><span class="op" id="1671557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1671561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1671565">releaseSudog</span><span class="op" id="1671577">(</span><span class="ident" id="1671578">w</span><span class="op" id="1671579">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1671582">}</span><br>
<span class="lineno"></span><span class="op" id="1671584">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1671587">//&nbsp;Syncsemrelease&nbsp;waits&nbsp;for&nbsp;n&nbsp;pairing&nbsp;syncsemacquire&nbsp;on&nbsp;the&nbsp;same&nbsp;semaphore&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="1671665">func</span>&nbsp;<span class="ident" id="1671670">syncsemrelease</span><span class="op" id="1671684">(</span><span class="ident" id="1671685">s</span>&nbsp;<span class="op" id="1671687">*</span><span class="ident" id="1671688">syncSema</span><span class="op" id="1671696">,</span>&nbsp;<span class="ident" id="1671698">n</span>&nbsp;<span class="builtintype" id="1671700">uint32</span><span class="op" id="1671706">)</span>&nbsp;<span class="op" id="1671708">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1671711">lock</span><span class="op" id="1671715">(</span><span class="op" id="1671716">&amp;</span><span class="ident" id="1671717">s</span><span class="op" id="1671718">.</span><span class="ident" id="1671719">lock</span><span class="op" id="1671723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1671726">for</span>&nbsp;<span class="ident" id="1671730">n</span>&nbsp;<span class="op" id="1671732">&gt;</span>&nbsp;<span class="num" id="1671734">0</span>&nbsp;<span class="op" id="1671736">&amp;&amp;</span>&nbsp;<span class="ident" id="1671739">s</span><span class="op" id="1671740">.</span><span class="ident" id="1671741">head</span>&nbsp;<span class="op" id="1671746">!=</span>&nbsp;<span class="builtintype" id="1671749">nil</span>&nbsp;<span class="op" id="1671753">&amp;&amp;</span>&nbsp;<span class="ident" id="1671756">s</span><span class="op" id="1671757">.</span><span class="ident" id="1671758">head</span><span class="op" id="1671762">.</span><span class="ident" id="1671763">nrelease</span>&nbsp;<span class="op" id="1671772">&lt;</span>&nbsp;<span class="num" id="1671774">0</span>&nbsp;<span class="op" id="1671776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1671780">//&nbsp;Have&nbsp;pending&nbsp;acquire,&nbsp;satisfy&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1671819">wake</span>&nbsp;<span class="op" id="1671824">:=</span>&nbsp;<span class="ident" id="1671827">s</span><span class="op" id="1671828">.</span><span class="ident" id="1671829">head</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1671836">s</span><span class="op" id="1671837">.</span><span class="ident" id="1671838">head</span>&nbsp;<span class="op" id="1671843">=</span>&nbsp;<span class="ident" id="1671845">wake</span><span class="op" id="1671849">.</span><span class="ident" id="1671850">next</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1671857">if</span>&nbsp;<span class="ident" id="1671860">s</span><span class="op" id="1671861">.</span><span class="ident" id="1671862">head</span>&nbsp;<span class="op" id="1671867">==</span>&nbsp;<span class="builtintype" id="1671870">nil</span>&nbsp;<span class="op" id="1671874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1671879">s</span><span class="op" id="1671880">.</span><span class="ident" id="1671881">tail</span>&nbsp;<span class="op" id="1671886">=</span>&nbsp;<span class="builtintype" id="1671888">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1671894">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1671898">if</span>&nbsp;<span class="ident" id="1671901">wake</span><span class="op" id="1671905">.</span><span class="ident" id="1671906">releasetime</span>&nbsp;<span class="op" id="1671918">!=</span>&nbsp;<span class="num" id="1671921">0</span>&nbsp;<span class="op" id="1671923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1671928">wake</span><span class="op" id="1671932">.</span><span class="ident" id="1671933">releasetime</span>&nbsp;<span class="op" id="1671945">=</span>&nbsp;<span class="ident" id="1671947">cputicks</span><span class="op" id="1671955">(</span><span class="op" id="1671956">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1671960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1671964">wake</span><span class="op" id="1671968">.</span><span class="ident" id="1671969">next</span>&nbsp;<span class="op" id="1671974">=</span>&nbsp;<span class="builtintype" id="1671976">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1671982">goready</span><span class="op" id="1671989">(</span><span class="ident" id="1671990">wake</span><span class="op" id="1671994">.</span><span class="ident" id="1671995">g</span><span class="op" id="1671996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1672000">n</span><span class="op" id="1672001">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1672005">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1672008">if</span>&nbsp;<span class="ident" id="1672011">n</span>&nbsp;<span class="op" id="1672013">&gt;</span>&nbsp;<span class="num" id="1672015">0</span>&nbsp;<span class="op" id="1672017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1672021">//&nbsp;enqueue&nbsp;itself</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1672041">w</span>&nbsp;<span class="op" id="1672043">:=</span>&nbsp;<span class="ident" id="1672046">acquireSudog</span><span class="op" id="1672058">(</span><span class="op" id="1672059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1672063">w</span><span class="op" id="1672064">.</span><span class="ident" id="1672065">g</span>&nbsp;<span class="op" id="1672067">=</span>&nbsp;<span class="ident" id="1672069">getg</span><span class="op" id="1672073">(</span><span class="op" id="1672074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1672078">w</span><span class="op" id="1672079">.</span><span class="ident" id="1672080">nrelease</span>&nbsp;<span class="op" id="1672089">=</span>&nbsp;<span class="builtintype" id="1672091">int32</span><span class="op" id="1672096">(</span><span class="ident" id="1672097">n</span><span class="op" id="1672098">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1672102">w</span><span class="op" id="1672103">.</span><span class="ident" id="1672104">next</span>&nbsp;<span class="op" id="1672109">=</span>&nbsp;<span class="builtintype" id="1672111">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1672117">w</span><span class="op" id="1672118">.</span><span class="ident" id="1672119">releasetime</span>&nbsp;<span class="op" id="1672131">=</span>&nbsp;<span class="num" id="1672133">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1672137">if</span>&nbsp;<span class="ident" id="1672140">s</span><span class="op" id="1672141">.</span><span class="ident" id="1672142">tail</span>&nbsp;<span class="op" id="1672147">==</span>&nbsp;<span class="builtintype" id="1672150">nil</span>&nbsp;<span class="op" id="1672154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1672159">s</span><span class="op" id="1672160">.</span><span class="ident" id="1672161">head</span>&nbsp;<span class="op" id="1672166">=</span>&nbsp;<span class="ident" id="1672168">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1672172">}</span>&nbsp;<span class="keyword" id="1672174">else</span>&nbsp;<span class="op" id="1672179">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1672184">s</span><span class="op" id="1672185">.</span><span class="ident" id="1672186">tail</span><span class="op" id="1672190">.</span><span class="ident" id="1672191">next</span>&nbsp;<span class="op" id="1672196">=</span>&nbsp;<span class="ident" id="1672198">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1672202">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1672206">s</span><span class="op" id="1672207">.</span><span class="ident" id="1672208">tail</span>&nbsp;<span class="op" id="1672213">=</span>&nbsp;<span class="ident" id="1672215">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1672219">goparkunlock</span><span class="op" id="1672231">(</span><span class="op" id="1672232">&amp;</span><span class="ident" id="1672233">s</span><span class="op" id="1672234">.</span><span class="ident" id="1672235">lock</span><span class="op" id="1672239">,</span>&nbsp;<span class="string" id="1672241">&#34;semarelease&#34;</span><span class="op" id="1672254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1672258">releaseSudog</span><span class="op" id="1672270">(</span><span class="ident" id="1672271">w</span><span class="op" id="1672272">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1672275">}</span>&nbsp;<span class="keyword" id="1672277">else</span>&nbsp;<span class="op" id="1672282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1672286">unlock</span><span class="op" id="1672292">(</span><span class="op" id="1672293">&amp;</span><span class="ident" id="1672294">s</span><span class="op" id="1672295">.</span><span class="ident" id="1672296">lock</span><span class="op" id="1672300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1672303">}</span><br>
<span class="lineno"></span><span class="op" id="1672305">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="keyword" id="1672308">func</span>&nbsp;<span class="ident" id="1672313">syncsemcheck</span><span class="op" id="1672325">(</span><span class="ident" id="1672326">sz</span>&nbsp;<span class="builtintype" id="1672329">uintptr</span><span class="op" id="1672336">)</span>&nbsp;<span class="op" id="1672338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1672341">if</span>&nbsp;<span class="ident" id="1672344">sz</span>&nbsp;<span class="op" id="1672347">!=</span>&nbsp;<span class="ident" id="1672350">unsafe</span><span class="op" id="1672356">.</span><span class="ident" id="1672357">Sizeof</span><span class="op" id="1672363">(</span><span class="ident" id="1672364">syncSema</span><span class="op" id="1672372">{</span><span class="op" id="1672373">}</span><span class="op" id="1672374">)</span>&nbsp;<span class="op" id="1672376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1672380">print</span><span class="op" id="1672385">(</span><span class="string" id="1672386">&#34;runtime:&nbsp;bad&nbsp;syncSema&nbsp;size&nbsp;-&nbsp;sync=&#34;</span><span class="op" id="1672422">,</span>&nbsp;<span class="ident" id="1672424">sz</span><span class="op" id="1672426">,</span>&nbsp;<span class="string" id="1672428">&#34;&nbsp;runtime=&#34;</span><span class="op" id="1672439">,</span>&nbsp;<span class="ident" id="1672441">unsafe</span><span class="op" id="1672447">.</span><span class="ident" id="1672448">Sizeof</span><span class="op" id="1672454">(</span><span class="ident" id="1672455">syncSema</span><span class="op" id="1672463">{</span><span class="op" id="1672464">}</span><span class="op" id="1672465">)</span><span class="op" id="1672466">,</span>&nbsp;<span class="string" id="1672468">&#34;\n&#34;</span><span class="op" id="1672472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1672476">gothrow</span><span class="op" id="1672483">(</span><span class="string" id="1672484">&#34;bad&nbsp;syncSema&nbsp;size&#34;</span><span class="op" id="1672503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1672506">}</span><br>
<span class="lineno">275</span><span class="op" id="1672508">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
