<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/jpeg</h2>
<ul>
<li><a href="/gostd/image/jpeg/dct_test.go.html">dct_test.go</a></li>
<li><a href="/gostd/image/jpeg/fdct.go.html">fdct.go</a></li>
<li><a href="/gostd/image/jpeg/huffman.go.html">huffman.go</a></li>
<li><a href="/gostd/image/jpeg/idct.go.html">idct.go</a></li>
<li><a href="/gostd/image/jpeg/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/jpeg/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/image/jpeg/scan.go.html">scan.go</a></li>
<li><a href="/gostd/image/jpeg/writer.go.html">writer.go</a></li>
<li><a href="/gostd/image/jpeg/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8313731">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8313786">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8313840">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="8313891">package</span>&nbsp;<span class="ident" id="8313899">jpeg</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8313905">import</span>&nbsp;<span class="op" id="8313912">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8313915">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8313924">&#34;fmt&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8313931">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8313940">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8313955">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8313961">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8313974">&#34;math/rand&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8313987">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8313993">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8314004">&#34;testing&#34;</span><br>
<span class="lineno"></span><span class="op" id="8314014">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="8314017">//&nbsp;TestDecodeProgressive&nbsp;tests&nbsp;that&nbsp;decoding&nbsp;the&nbsp;baseline&nbsp;and&nbsp;progressive</span><br>
<span class="lineno"></span><span class="comment" id="8314091">//&nbsp;versions&nbsp;of&nbsp;the&nbsp;same&nbsp;image&nbsp;result&nbsp;in&nbsp;exactly&nbsp;the&nbsp;same&nbsp;pixel&nbsp;data,&nbsp;in&nbsp;YCbCr</span><br>
<span class="lineno"></span><span class="comment" id="8314169">//&nbsp;space&nbsp;for&nbsp;color&nbsp;images,&nbsp;and&nbsp;Y&nbsp;space&nbsp;for&nbsp;grayscale&nbsp;images.</span><br>
<span class="lineno"></span><span class="keyword" id="8314230">func</span>&nbsp;<span class="ident" id="8314235">TestDecodeProgressive</span><span class="op" id="8314256">(</span><span class="ident" id="8314257">t</span>&nbsp;<span class="op" id="8314259">*</span><span class="ident" id="8314260">testing</span><span class="op" id="8314267">.</span><span class="ident" id="8314268">T</span><span class="op" id="8314269">)</span>&nbsp;<span class="op" id="8314271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8314274">testCases</span>&nbsp;<span class="op" id="8314284">:=</span>&nbsp;<span class="op" id="8314287">[</span><span class="op" id="8314288">]</span><span class="builtintype" id="8314289">string</span><span class="op" id="8314295">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8314299">&#34;../testdata/video-001&#34;</span><span class="op" id="8314322">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8314326">&#34;../testdata/video-001.q50.420&#34;</span><span class="op" id="8314357">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8314361">&#34;../testdata/video-001.q50.422&#34;</span><span class="op" id="8314392">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8314396">&#34;../testdata/video-001.q50.440&#34;</span><span class="op" id="8314427">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8314431">&#34;../testdata/video-001.q50.444&#34;</span><span class="op" id="8314462">,</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8314466">&#34;../testdata/video-005.gray.q50&#34;</span><span class="op" id="8314498">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8314502">&#34;../testdata/video-005.gray.q50.2x2&#34;</span><span class="op" id="8314538">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8314542">&#34;../testdata/video-001.separate.dc.progression&#34;</span><span class="op" id="8314589">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8314592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8314595">for</span>&nbsp;<span class="ident" id="8314599">_</span><span class="op" id="8314600">,</span>&nbsp;<span class="ident" id="8314602">tc</span>&nbsp;<span class="op" id="8314605">:=</span>&nbsp;<span class="keyword" id="8314608">range</span>&nbsp;<span class="ident" id="8314614">testCases</span>&nbsp;<span class="op" id="8314624">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8314628">m0</span><span class="op" id="8314630">,</span>&nbsp;<span class="ident" id="8314632">err</span>&nbsp;<span class="op" id="8314636">:=</span>&nbsp;<span class="ident" id="8314639">decodeFile</span><span class="op" id="8314649">(</span><span class="ident" id="8314650">tc</span>&nbsp;<span class="op" id="8314653">+</span>&nbsp;<span class="string" id="8314655">&#34;.jpeg&#34;</span><span class="op" id="8314662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8314666">if</span>&nbsp;<span class="ident" id="8314669">err</span>&nbsp;<span class="op" id="8314673">!=</span>&nbsp;<span class="ident" id="8314676">nil</span>&nbsp;<span class="op" id="8314680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8314685">t</span><span class="op" id="8314686">.</span><span class="ident" id="8314687">Errorf</span><span class="op" id="8314693">(</span><span class="string" id="8314694">&#34;%s:&nbsp;%v&#34;</span><span class="op" id="8314702">,</span>&nbsp;<span class="ident" id="8314704">tc</span><span class="op" id="8314706">+</span><span class="string" id="8314707">&#34;.jpeg&#34;</span><span class="op" id="8314714">,</span>&nbsp;<span class="ident" id="8314716">err</span><span class="op" id="8314719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8314724">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8314735">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8314739">m1</span><span class="op" id="8314741">,</span>&nbsp;<span class="ident" id="8314743">err</span>&nbsp;<span class="op" id="8314747">:=</span>&nbsp;<span class="ident" id="8314750">decodeFile</span><span class="op" id="8314760">(</span><span class="ident" id="8314761">tc</span>&nbsp;<span class="op" id="8314764">+</span>&nbsp;<span class="string" id="8314766">&#34;.progressive.jpeg&#34;</span><span class="op" id="8314785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8314789">if</span>&nbsp;<span class="ident" id="8314792">err</span>&nbsp;<span class="op" id="8314796">!=</span>&nbsp;<span class="ident" id="8314799">nil</span>&nbsp;<span class="op" id="8314803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8314808">t</span><span class="op" id="8314809">.</span><span class="ident" id="8314810">Errorf</span><span class="op" id="8314816">(</span><span class="string" id="8314817">&#34;%s:&nbsp;%v&#34;</span><span class="op" id="8314825">,</span>&nbsp;<span class="ident" id="8314827">tc</span><span class="op" id="8314829">+</span><span class="string" id="8314830">&#34;.progressive.jpeg&#34;</span><span class="op" id="8314849">,</span>&nbsp;<span class="ident" id="8314851">err</span><span class="op" id="8314854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8314859">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8314870">}</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8314874">if</span>&nbsp;<span class="ident" id="8314877">m0</span><span class="op" id="8314879">.</span><span class="ident" id="8314880">Bounds</span><span class="op" id="8314886">(</span><span class="op" id="8314887">)</span>&nbsp;<span class="op" id="8314889">!=</span>&nbsp;<span class="ident" id="8314892">m1</span><span class="op" id="8314894">.</span><span class="ident" id="8314895">Bounds</span><span class="op" id="8314901">(</span><span class="op" id="8314902">)</span>&nbsp;<span class="op" id="8314904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8314909">t</span><span class="op" id="8314910">.</span><span class="ident" id="8314911">Errorf</span><span class="op" id="8314917">(</span><span class="string" id="8314918">&#34;%s:&nbsp;bounds&nbsp;differ:&nbsp;%v&nbsp;and&nbsp;%v&#34;</span><span class="op" id="8314948">,</span>&nbsp;<span class="ident" id="8314950">tc</span><span class="op" id="8314952">,</span>&nbsp;<span class="ident" id="8314954">m0</span><span class="op" id="8314956">.</span><span class="ident" id="8314957">Bounds</span><span class="op" id="8314963">(</span><span class="op" id="8314964">)</span><span class="op" id="8314965">,</span>&nbsp;<span class="ident" id="8314967">m1</span><span class="op" id="8314969">.</span><span class="ident" id="8314970">Bounds</span><span class="op" id="8314976">(</span><span class="op" id="8314977">)</span><span class="op" id="8314978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8314983">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8314994">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8314998">//&nbsp;All&nbsp;of&nbsp;the&nbsp;video-*.jpeg&nbsp;files&nbsp;are&nbsp;150x103.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8315046">if</span>&nbsp;<span class="ident" id="8315049">m0</span><span class="op" id="8315051">.</span><span class="ident" id="8315052">Bounds</span><span class="op" id="8315058">(</span><span class="op" id="8315059">)</span>&nbsp;<span class="op" id="8315061">!=</span>&nbsp;<span class="ident" id="8315064">image</span><span class="op" id="8315069">.</span><span class="ident" id="8315070">Rect</span><span class="op" id="8315074">(</span><span class="num" id="8315075">0</span><span class="op" id="8315076">,</span>&nbsp;<span class="num" id="8315078">0</span><span class="op" id="8315079">,</span>&nbsp;<span class="num" id="8315081">150</span><span class="op" id="8315084">,</span>&nbsp;<span class="num" id="8315086">103</span><span class="op" id="8315089">)</span>&nbsp;<span class="op" id="8315091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8315096">t</span><span class="op" id="8315097">.</span><span class="ident" id="8315098">Errorf</span><span class="op" id="8315104">(</span><span class="string" id="8315105">&#34;%s:&nbsp;bad&nbsp;bounds:&nbsp;%v&#34;</span><span class="op" id="8315125">,</span>&nbsp;<span class="ident" id="8315127">tc</span><span class="op" id="8315129">,</span>&nbsp;<span class="ident" id="8315131">m0</span><span class="op" id="8315133">.</span><span class="ident" id="8315134">Bounds</span><span class="op" id="8315140">(</span><span class="op" id="8315141">)</span><span class="op" id="8315142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8315147">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8315158">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8315163">switch</span>&nbsp;<span class="ident" id="8315170">m0</span>&nbsp;<span class="op" id="8315173">:=</span>&nbsp;<span class="ident" id="8315176">m0</span><span class="op" id="8315178">.</span><span class="op" id="8315179">(</span><span class="keyword" id="8315180">type</span><span class="op" id="8315184">)</span>&nbsp;<span class="op" id="8315186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8315190">case</span>&nbsp;<span class="op" id="8315195">*</span><span class="ident" id="8315196">image</span><span class="op" id="8315201">.</span><span class="ident" id="8315202">YCbCr</span><span class="op" id="8315207">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8315212">m1</span>&nbsp;<span class="op" id="8315215">:=</span>&nbsp;<span class="ident" id="8315218">m1</span><span class="op" id="8315220">.</span><span class="op" id="8315221">(</span><span class="op" id="8315222">*</span><span class="ident" id="8315223">image</span><span class="op" id="8315228">.</span><span class="ident" id="8315229">YCbCr</span><span class="op" id="8315234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8315239">if</span>&nbsp;<span class="ident" id="8315242">err</span>&nbsp;<span class="op" id="8315246">:=</span>&nbsp;<span class="ident" id="8315249">check</span><span class="op" id="8315254">(</span><span class="ident" id="8315255">m0</span><span class="op" id="8315257">.</span><span class="ident" id="8315258">Bounds</span><span class="op" id="8315264">(</span><span class="op" id="8315265">)</span><span class="op" id="8315266">,</span>&nbsp;<span class="ident" id="8315268">m0</span><span class="op" id="8315270">.</span><span class="ident" id="8315271">Y</span><span class="op" id="8315272">,</span>&nbsp;<span class="ident" id="8315274">m1</span><span class="op" id="8315276">.</span><span class="ident" id="8315277">Y</span><span class="op" id="8315278">,</span>&nbsp;<span class="ident" id="8315280">m0</span><span class="op" id="8315282">.</span><span class="ident" id="8315283">YStride</span><span class="op" id="8315290">,</span>&nbsp;<span class="ident" id="8315292">m1</span><span class="op" id="8315294">.</span><span class="ident" id="8315295">YStride</span><span class="op" id="8315302">)</span><span class="op" id="8315303">;</span>&nbsp;<span class="ident" id="8315305">err</span>&nbsp;<span class="op" id="8315309">!=</span>&nbsp;<span class="ident" id="8315312">nil</span>&nbsp;<span class="op" id="8315316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8315322">t</span><span class="op" id="8315323">.</span><span class="ident" id="8315324">Errorf</span><span class="op" id="8315330">(</span><span class="string" id="8315331">&#34;%s&nbsp;(Y):&nbsp;%v&#34;</span><span class="op" id="8315343">,</span>&nbsp;<span class="ident" id="8315345">tc</span><span class="op" id="8315347">,</span>&nbsp;<span class="ident" id="8315349">err</span><span class="op" id="8315352">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8315358">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8315370">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8315375">if</span>&nbsp;<span class="ident" id="8315378">err</span>&nbsp;<span class="op" id="8315382">:=</span>&nbsp;<span class="ident" id="8315385">check</span><span class="op" id="8315390">(</span><span class="ident" id="8315391">m0</span><span class="op" id="8315393">.</span><span class="ident" id="8315394">Bounds</span><span class="op" id="8315400">(</span><span class="op" id="8315401">)</span><span class="op" id="8315402">,</span>&nbsp;<span class="ident" id="8315404">m0</span><span class="op" id="8315406">.</span><span class="ident" id="8315407">Cb</span><span class="op" id="8315409">,</span>&nbsp;<span class="ident" id="8315411">m1</span><span class="op" id="8315413">.</span><span class="ident" id="8315414">Cb</span><span class="op" id="8315416">,</span>&nbsp;<span class="ident" id="8315418">m0</span><span class="op" id="8315420">.</span><span class="ident" id="8315421">CStride</span><span class="op" id="8315428">,</span>&nbsp;<span class="ident" id="8315430">m1</span><span class="op" id="8315432">.</span><span class="ident" id="8315433">CStride</span><span class="op" id="8315440">)</span><span class="op" id="8315441">;</span>&nbsp;<span class="ident" id="8315443">err</span>&nbsp;<span class="op" id="8315447">!=</span>&nbsp;<span class="ident" id="8315450">nil</span>&nbsp;<span class="op" id="8315454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8315460">t</span><span class="op" id="8315461">.</span><span class="ident" id="8315462">Errorf</span><span class="op" id="8315468">(</span><span class="string" id="8315469">&#34;%s&nbsp;(Cb):&nbsp;%v&#34;</span><span class="op" id="8315482">,</span>&nbsp;<span class="ident" id="8315484">tc</span><span class="op" id="8315486">,</span>&nbsp;<span class="ident" id="8315488">err</span><span class="op" id="8315491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8315497">continue</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8315509">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8315514">if</span>&nbsp;<span class="ident" id="8315517">err</span>&nbsp;<span class="op" id="8315521">:=</span>&nbsp;<span class="ident" id="8315524">check</span><span class="op" id="8315529">(</span><span class="ident" id="8315530">m0</span><span class="op" id="8315532">.</span><span class="ident" id="8315533">Bounds</span><span class="op" id="8315539">(</span><span class="op" id="8315540">)</span><span class="op" id="8315541">,</span>&nbsp;<span class="ident" id="8315543">m0</span><span class="op" id="8315545">.</span><span class="ident" id="8315546">Cr</span><span class="op" id="8315548">,</span>&nbsp;<span class="ident" id="8315550">m1</span><span class="op" id="8315552">.</span><span class="ident" id="8315553">Cr</span><span class="op" id="8315555">,</span>&nbsp;<span class="ident" id="8315557">m0</span><span class="op" id="8315559">.</span><span class="ident" id="8315560">CStride</span><span class="op" id="8315567">,</span>&nbsp;<span class="ident" id="8315569">m1</span><span class="op" id="8315571">.</span><span class="ident" id="8315572">CStride</span><span class="op" id="8315579">)</span><span class="op" id="8315580">;</span>&nbsp;<span class="ident" id="8315582">err</span>&nbsp;<span class="op" id="8315586">!=</span>&nbsp;<span class="ident" id="8315589">nil</span>&nbsp;<span class="op" id="8315593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8315599">t</span><span class="op" id="8315600">.</span><span class="ident" id="8315601">Errorf</span><span class="op" id="8315607">(</span><span class="string" id="8315608">&#34;%s&nbsp;(Cr):&nbsp;%v&#34;</span><span class="op" id="8315621">,</span>&nbsp;<span class="ident" id="8315623">tc</span><span class="op" id="8315625">,</span>&nbsp;<span class="ident" id="8315627">err</span><span class="op" id="8315630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8315636">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8315648">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8315652">case</span>&nbsp;<span class="op" id="8315657">*</span><span class="ident" id="8315658">image</span><span class="op" id="8315663">.</span><span class="ident" id="8315664">Gray</span><span class="op" id="8315668">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8315673">m1</span>&nbsp;<span class="op" id="8315676">:=</span>&nbsp;<span class="ident" id="8315679">m1</span><span class="op" id="8315681">.</span><span class="op" id="8315682">(</span><span class="op" id="8315683">*</span><span class="ident" id="8315684">image</span><span class="op" id="8315689">.</span><span class="ident" id="8315690">Gray</span><span class="op" id="8315694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8315699">if</span>&nbsp;<span class="ident" id="8315702">err</span>&nbsp;<span class="op" id="8315706">:=</span>&nbsp;<span class="ident" id="8315709">check</span><span class="op" id="8315714">(</span><span class="ident" id="8315715">m0</span><span class="op" id="8315717">.</span><span class="ident" id="8315718">Bounds</span><span class="op" id="8315724">(</span><span class="op" id="8315725">)</span><span class="op" id="8315726">,</span>&nbsp;<span class="ident" id="8315728">m0</span><span class="op" id="8315730">.</span><span class="ident" id="8315731">Pix</span><span class="op" id="8315734">,</span>&nbsp;<span class="ident" id="8315736">m1</span><span class="op" id="8315738">.</span><span class="ident" id="8315739">Pix</span><span class="op" id="8315742">,</span>&nbsp;<span class="ident" id="8315744">m0</span><span class="op" id="8315746">.</span><span class="ident" id="8315747">Stride</span><span class="op" id="8315753">,</span>&nbsp;<span class="ident" id="8315755">m1</span><span class="op" id="8315757">.</span><span class="ident" id="8315758">Stride</span><span class="op" id="8315764">)</span><span class="op" id="8315765">;</span>&nbsp;<span class="ident" id="8315767">err</span>&nbsp;<span class="op" id="8315771">!=</span>&nbsp;<span class="ident" id="8315774">nil</span>&nbsp;<span class="op" id="8315778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8315784">t</span><span class="op" id="8315785">.</span><span class="ident" id="8315786">Errorf</span><span class="op" id="8315792">(</span><span class="string" id="8315793">&#34;%s:&nbsp;%v&#34;</span><span class="op" id="8315801">,</span>&nbsp;<span class="ident" id="8315803">tc</span><span class="op" id="8315805">,</span>&nbsp;<span class="ident" id="8315807">err</span><span class="op" id="8315810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8315816">continue</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8315828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8315832">default</span><span class="op" id="8315839">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8315844">t</span><span class="op" id="8315845">.</span><span class="ident" id="8315846">Errorf</span><span class="op" id="8315852">(</span><span class="string" id="8315853">&#34;%s:&nbsp;unexpected&nbsp;image&nbsp;type&nbsp;%T&#34;</span><span class="op" id="8315883">,</span>&nbsp;<span class="ident" id="8315885">tc</span><span class="op" id="8315887">,</span>&nbsp;<span class="ident" id="8315889">m0</span><span class="op" id="8315891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8315896">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8315907">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8315910">}</span><br>
<span class="lineno"></span><span class="op" id="8315912">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8315915">func</span>&nbsp;<span class="ident" id="8315920">decodeFile</span><span class="op" id="8315930">(</span><span class="ident" id="8315931">filename</span>&nbsp;<span class="builtintype" id="8315940">string</span><span class="op" id="8315946">)</span>&nbsp;<span class="op" id="8315948">(</span><span class="ident" id="8315949">image</span><span class="op" id="8315954">.</span><span class="ident" id="8315955">Image</span><span class="op" id="8315960">,</span>&nbsp;<span class="builtintype" id="8315962">error</span><span class="op" id="8315967">)</span>&nbsp;<span class="op" id="8315969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8315972">f</span><span class="op" id="8315973">,</span>&nbsp;<span class="ident" id="8315975">err</span>&nbsp;<span class="op" id="8315979">:=</span>&nbsp;<span class="ident" id="8315982">os</span><span class="op" id="8315984">.</span><span class="ident" id="8315985">Open</span><span class="op" id="8315989">(</span><span class="ident" id="8315990">filename</span><span class="op" id="8315998">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8316001">if</span>&nbsp;<span class="ident" id="8316004">err</span>&nbsp;<span class="op" id="8316008">!=</span>&nbsp;<span class="ident" id="8316011">nil</span>&nbsp;<span class="op" id="8316015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8316019">return</span>&nbsp;<span class="ident" id="8316026">nil</span><span class="op" id="8316029">,</span>&nbsp;<span class="ident" id="8316031">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8316036">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8316039">defer</span>&nbsp;<span class="ident" id="8316045">f</span><span class="op" id="8316046">.</span><span class="ident" id="8316047">Close</span><span class="op" id="8316052">(</span><span class="op" id="8316053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8316056">return</span>&nbsp;<span class="ident" id="8316063">Decode</span><span class="op" id="8316069">(</span><span class="ident" id="8316070">f</span><span class="op" id="8316071">)</span><br>
<span class="lineno">90</span><span class="op" id="8316073">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8316076">type</span>&nbsp;<span class="ident" id="8316081">eofReader</span>&nbsp;<span class="keyword" id="8316091">struct</span>&nbsp;<span class="op" id="8316098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8316101">data</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8316110">[</span><span class="op" id="8316111">]</span><span class="builtintype" id="8316112">byte</span>&nbsp;<span class="comment" id="8316117">//&nbsp;deliver&nbsp;from&nbsp;Read&nbsp;without&nbsp;EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8316151">dataEOF</span>&nbsp;&nbsp;<span class="op" id="8316160">[</span><span class="op" id="8316161">]</span><span class="builtintype" id="8316162">byte</span>&nbsp;<span class="comment" id="8316167">//&nbsp;then&nbsp;deliver&nbsp;from&nbsp;Read&nbsp;with&nbsp;EOF&nbsp;on&nbsp;last&nbsp;chunk</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8316217">lenAtEOF</span>&nbsp;<span class="builtintype" id="8316226">int</span><br>
<span class="lineno"></span><span class="op" id="8316230">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8316233">func</span>&nbsp;<span class="op" id="8316238">(</span><span class="ident" id="8316239">r</span>&nbsp;<span class="op" id="8316241">*</span><span class="ident" id="8316242">eofReader</span><span class="op" id="8316251">)</span>&nbsp;<span class="ident" id="8316253">Read</span><span class="op" id="8316257">(</span><span class="ident" id="8316258">b</span>&nbsp;<span class="op" id="8316260">[</span><span class="op" id="8316261">]</span><span class="builtintype" id="8316262">byte</span><span class="op" id="8316266">)</span>&nbsp;<span class="op" id="8316268">(</span><span class="ident" id="8316269">n</span>&nbsp;<span class="builtintype" id="8316271">int</span><span class="op" id="8316274">,</span>&nbsp;<span class="ident" id="8316276">err</span>&nbsp;<span class="builtintype" id="8316280">error</span><span class="op" id="8316285">)</span>&nbsp;<span class="op" id="8316287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8316290">if</span>&nbsp;<span class="builtinfunc" id="8316293">len</span><span class="op" id="8316296">(</span><span class="ident" id="8316297">r</span><span class="op" id="8316298">.</span><span class="ident" id="8316299">data</span><span class="op" id="8316303">)</span>&nbsp;<span class="op" id="8316305">&gt;</span>&nbsp;<span class="num" id="8316307">0</span>&nbsp;<span class="op" id="8316309">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8316313">n</span>&nbsp;<span class="op" id="8316315">=</span>&nbsp;<span class="builtinfunc" id="8316317">copy</span><span class="op" id="8316321">(</span><span class="ident" id="8316322">b</span><span class="op" id="8316323">,</span>&nbsp;<span class="ident" id="8316325">r</span><span class="op" id="8316326">.</span><span class="ident" id="8316327">data</span><span class="op" id="8316331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8316335">r</span><span class="op" id="8316336">.</span><span class="ident" id="8316337">data</span>&nbsp;<span class="op" id="8316342">=</span>&nbsp;<span class="ident" id="8316344">r</span><span class="op" id="8316345">.</span><span class="ident" id="8316346">data</span><span class="op" id="8316350">[</span><span class="ident" id="8316351">n</span><span class="op" id="8316352">:</span><span class="op" id="8316353">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8316356">}</span>&nbsp;<span class="keyword" id="8316358">else</span>&nbsp;<span class="op" id="8316363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8316367">n</span>&nbsp;<span class="op" id="8316369">=</span>&nbsp;<span class="builtinfunc" id="8316371">copy</span><span class="op" id="8316375">(</span><span class="ident" id="8316376">b</span><span class="op" id="8316377">,</span>&nbsp;<span class="ident" id="8316379">r</span><span class="op" id="8316380">.</span><span class="ident" id="8316381">dataEOF</span><span class="op" id="8316388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8316392">r</span><span class="op" id="8316393">.</span><span class="ident" id="8316394">dataEOF</span>&nbsp;<span class="op" id="8316402">=</span>&nbsp;<span class="ident" id="8316404">r</span><span class="op" id="8316405">.</span><span class="ident" id="8316406">dataEOF</span><span class="op" id="8316413">[</span><span class="ident" id="8316414">n</span><span class="op" id="8316415">:</span><span class="op" id="8316416">]</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8316420">if</span>&nbsp;<span class="builtinfunc" id="8316423">len</span><span class="op" id="8316426">(</span><span class="ident" id="8316427">r</span><span class="op" id="8316428">.</span><span class="ident" id="8316429">dataEOF</span><span class="op" id="8316436">)</span>&nbsp;<span class="op" id="8316438">==</span>&nbsp;<span class="num" id="8316441">0</span>&nbsp;<span class="op" id="8316443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8316448">err</span>&nbsp;<span class="op" id="8316452">=</span>&nbsp;<span class="ident" id="8316454">io</span><span class="op" id="8316456">.</span><span class="ident" id="8316457">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8316464">if</span>&nbsp;<span class="ident" id="8316467">r</span><span class="op" id="8316468">.</span><span class="ident" id="8316469">lenAtEOF</span>&nbsp;<span class="op" id="8316478">==</span>&nbsp;<span class="op" id="8316481">-</span><span class="num" id="8316482">1</span>&nbsp;<span class="op" id="8316484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8316490">r</span><span class="op" id="8316491">.</span><span class="ident" id="8316492">lenAtEOF</span>&nbsp;<span class="op" id="8316501">=</span>&nbsp;<span class="ident" id="8316503">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8316508">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8316512">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8316515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8316518">return</span><br>
<span class="lineno"></span><span class="op" id="8316525">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="8316528">func</span>&nbsp;<span class="ident" id="8316533">TestDecodeEOF</span><span class="op" id="8316546">(</span><span class="ident" id="8316547">t</span>&nbsp;<span class="op" id="8316549">*</span><span class="ident" id="8316550">testing</span><span class="op" id="8316557">.</span><span class="ident" id="8316558">T</span><span class="op" id="8316559">)</span>&nbsp;<span class="op" id="8316561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8316564">//&nbsp;Check&nbsp;that&nbsp;if&nbsp;reader&nbsp;returns&nbsp;final&nbsp;data&nbsp;and&nbsp;EOF&nbsp;at&nbsp;same&nbsp;time,&nbsp;jpeg&nbsp;handles&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8316647">data</span><span class="op" id="8316651">,</span>&nbsp;<span class="ident" id="8316653">err</span>&nbsp;<span class="op" id="8316657">:=</span>&nbsp;<span class="ident" id="8316660">ioutil</span><span class="op" id="8316666">.</span><span class="ident" id="8316667">ReadFile</span><span class="op" id="8316675">(</span><span class="string" id="8316676">&#34;../testdata/video-001.jpeg&#34;</span><span class="op" id="8316704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8316707">if</span>&nbsp;<span class="ident" id="8316710">err</span>&nbsp;<span class="op" id="8316714">!=</span>&nbsp;<span class="ident" id="8316717">nil</span>&nbsp;<span class="op" id="8316721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8316725">t</span><span class="op" id="8316726">.</span><span class="ident" id="8316727">Fatal</span><span class="op" id="8316732">(</span><span class="ident" id="8316733">err</span><span class="op" id="8316736">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8316739">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8316743">n</span>&nbsp;<span class="op" id="8316745">:=</span>&nbsp;<span class="builtinfunc" id="8316748">len</span><span class="op" id="8316751">(</span><span class="ident" id="8316752">data</span><span class="op" id="8316756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8316759">for</span>&nbsp;<span class="ident" id="8316763">i</span>&nbsp;<span class="op" id="8316765">:=</span>&nbsp;<span class="num" id="8316768">0</span><span class="op" id="8316769">;</span>&nbsp;<span class="ident" id="8316771">i</span>&nbsp;<span class="op" id="8316773">&lt;</span>&nbsp;<span class="ident" id="8316775">n</span><span class="op" id="8316776">;</span>&nbsp;<span class="op" id="8316778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8316782">r</span>&nbsp;<span class="op" id="8316784">:=</span>&nbsp;<span class="op" id="8316787">&amp;</span><span class="ident" id="8316788">eofReader</span><span class="op" id="8316797">{</span><span class="ident" id="8316798">data</span><span class="op" id="8316802">[</span><span class="op" id="8316803">:</span><span class="ident" id="8316804">n</span><span class="op" id="8316805">-</span><span class="ident" id="8316806">i</span><span class="op" id="8316807">]</span><span class="op" id="8316808">,</span>&nbsp;<span class="ident" id="8316810">data</span><span class="op" id="8316814">[</span><span class="ident" id="8316815">n</span><span class="op" id="8316816">-</span><span class="ident" id="8316817">i</span><span class="op" id="8316818">:</span><span class="op" id="8316819">]</span><span class="op" id="8316820">,</span>&nbsp;<span class="op" id="8316822">-</span><span class="num" id="8316823">1</span><span class="op" id="8316824">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8316828">_</span><span class="op" id="8316829">,</span>&nbsp;<span class="ident" id="8316831">err</span>&nbsp;<span class="op" id="8316835">:=</span>&nbsp;<span class="ident" id="8316838">Decode</span><span class="op" id="8316844">(</span><span class="ident" id="8316845">r</span><span class="op" id="8316846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8316850">if</span>&nbsp;<span class="ident" id="8316853">err</span>&nbsp;<span class="op" id="8316857">!=</span>&nbsp;<span class="ident" id="8316860">nil</span>&nbsp;<span class="op" id="8316864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8316869">t</span><span class="op" id="8316870">.</span><span class="ident" id="8316871">Errorf</span><span class="op" id="8316877">(</span><span class="string" id="8316878">&#34;Decode&nbsp;with&nbsp;Read()&nbsp;=&nbsp;%d,&nbsp;EOF:&nbsp;%v&#34;</span><span class="op" id="8316912">,</span>&nbsp;<span class="ident" id="8316914">r</span><span class="op" id="8316915">.</span><span class="ident" id="8316916">lenAtEOF</span><span class="op" id="8316924">,</span>&nbsp;<span class="ident" id="8316926">err</span><span class="op" id="8316929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8316933">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8316937">if</span>&nbsp;<span class="ident" id="8316940">i</span>&nbsp;<span class="op" id="8316942">==</span>&nbsp;<span class="num" id="8316945">0</span>&nbsp;<span class="op" id="8316947">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8316952">i</span>&nbsp;<span class="op" id="8316954">=</span>&nbsp;<span class="num" id="8316956">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8316960">}</span>&nbsp;<span class="keyword" id="8316962">else</span>&nbsp;<span class="op" id="8316967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8316972">i</span>&nbsp;<span class="op" id="8316974">*=</span>&nbsp;<span class="num" id="8316977">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8316981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8316984">}</span><br>
<span class="lineno">135</span><span class="op" id="8316986">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8316989">//&nbsp;check&nbsp;checks&nbsp;that&nbsp;the&nbsp;two&nbsp;pix&nbsp;data&nbsp;are&nbsp;equal,&nbsp;within&nbsp;the&nbsp;given&nbsp;bounds.</span><br>
<span class="lineno"></span><span class="keyword" id="8317063">func</span>&nbsp;<span class="ident" id="8317068">check</span><span class="op" id="8317073">(</span><span class="ident" id="8317074">bounds</span>&nbsp;<span class="ident" id="8317081">image</span><span class="op" id="8317086">.</span><span class="ident" id="8317087">Rectangle</span><span class="op" id="8317096">,</span>&nbsp;<span class="ident" id="8317098">pix0</span><span class="op" id="8317102">,</span>&nbsp;<span class="ident" id="8317104">pix1</span>&nbsp;<span class="op" id="8317109">[</span><span class="op" id="8317110">]</span><span class="builtintype" id="8317111">byte</span><span class="op" id="8317115">,</span>&nbsp;<span class="ident" id="8317117">stride0</span><span class="op" id="8317124">,</span>&nbsp;<span class="ident" id="8317126">stride1</span>&nbsp;<span class="builtintype" id="8317134">int</span><span class="op" id="8317137">)</span>&nbsp;<span class="builtintype" id="8317139">error</span>&nbsp;<span class="op" id="8317145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8317148">if</span>&nbsp;<span class="ident" id="8317151">stride0</span>&nbsp;<span class="op" id="8317159">&lt;=</span>&nbsp;<span class="num" id="8317162">0</span>&nbsp;<span class="op" id="8317164">||</span>&nbsp;<span class="ident" id="8317167">stride0</span><span class="op" id="8317174">%</span><span class="num" id="8317175">8</span>&nbsp;<span class="op" id="8317177">!=</span>&nbsp;<span class="num" id="8317180">0</span>&nbsp;<span class="op" id="8317182">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8317186">return</span>&nbsp;<span class="ident" id="8317193">fmt</span><span class="op" id="8317196">.</span><span class="ident" id="8317197">Errorf</span><span class="op" id="8317203">(</span><span class="string" id="8317204">&#34;bad&nbsp;stride&nbsp;%d&#34;</span><span class="op" id="8317219">,</span>&nbsp;<span class="ident" id="8317221">stride0</span><span class="op" id="8317228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8317231">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8317234">if</span>&nbsp;<span class="ident" id="8317237">stride1</span>&nbsp;<span class="op" id="8317245">&lt;=</span>&nbsp;<span class="num" id="8317248">0</span>&nbsp;<span class="op" id="8317250">||</span>&nbsp;<span class="ident" id="8317253">stride1</span><span class="op" id="8317260">%</span><span class="num" id="8317261">8</span>&nbsp;<span class="op" id="8317263">!=</span>&nbsp;<span class="num" id="8317266">0</span>&nbsp;<span class="op" id="8317268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8317272">return</span>&nbsp;<span class="ident" id="8317279">fmt</span><span class="op" id="8317282">.</span><span class="ident" id="8317283">Errorf</span><span class="op" id="8317289">(</span><span class="string" id="8317290">&#34;bad&nbsp;stride&nbsp;%d&#34;</span><span class="op" id="8317305">,</span>&nbsp;<span class="ident" id="8317307">stride1</span><span class="op" id="8317314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8317317">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8317320">//&nbsp;Compare&nbsp;the&nbsp;two&nbsp;pix&nbsp;data,&nbsp;one&nbsp;8x8&nbsp;block&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8317375">for</span>&nbsp;<span class="ident" id="8317379">y</span>&nbsp;<span class="op" id="8317381">:=</span>&nbsp;<span class="num" id="8317384">0</span><span class="op" id="8317385">;</span>&nbsp;<span class="ident" id="8317387">y</span>&nbsp;<span class="op" id="8317389">&lt;</span>&nbsp;<span class="builtinfunc" id="8317391">len</span><span class="op" id="8317394">(</span><span class="ident" id="8317395">pix0</span><span class="op" id="8317399">)</span><span class="op" id="8317400">/</span><span class="ident" id="8317401">stride0</span>&nbsp;<span class="op" id="8317409">&amp;&amp;</span>&nbsp;<span class="ident" id="8317412">y</span>&nbsp;<span class="op" id="8317414">&lt;</span>&nbsp;<span class="builtinfunc" id="8317416">len</span><span class="op" id="8317419">(</span><span class="ident" id="8317420">pix1</span><span class="op" id="8317424">)</span><span class="op" id="8317425">/</span><span class="ident" id="8317426">stride1</span><span class="op" id="8317433">;</span>&nbsp;<span class="ident" id="8317435">y</span>&nbsp;<span class="op" id="8317437">+=</span>&nbsp;<span class="num" id="8317440">8</span>&nbsp;<span class="op" id="8317442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8317446">for</span>&nbsp;<span class="ident" id="8317450">x</span>&nbsp;<span class="op" id="8317452">:=</span>&nbsp;<span class="num" id="8317455">0</span><span class="op" id="8317456">;</span>&nbsp;<span class="ident" id="8317458">x</span>&nbsp;<span class="op" id="8317460">&lt;</span>&nbsp;<span class="ident" id="8317462">stride0</span>&nbsp;<span class="op" id="8317470">&amp;&amp;</span>&nbsp;<span class="ident" id="8317473">x</span>&nbsp;<span class="op" id="8317475">&lt;</span>&nbsp;<span class="ident" id="8317477">stride1</span><span class="op" id="8317484">;</span>&nbsp;<span class="ident" id="8317486">x</span>&nbsp;<span class="op" id="8317488">+=</span>&nbsp;<span class="num" id="8317491">8</span>&nbsp;<span class="op" id="8317493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8317498">if</span>&nbsp;<span class="ident" id="8317501">x</span>&nbsp;<span class="op" id="8317503">&gt;=</span>&nbsp;<span class="ident" id="8317506">bounds</span><span class="op" id="8317512">.</span><span class="ident" id="8317513">Max</span><span class="op" id="8317516">.</span><span class="ident" id="8317517">X</span>&nbsp;<span class="op" id="8317519">||</span>&nbsp;<span class="ident" id="8317522">y</span>&nbsp;<span class="op" id="8317524">&gt;=</span>&nbsp;<span class="ident" id="8317527">bounds</span><span class="op" id="8317533">.</span><span class="ident" id="8317534">Max</span><span class="op" id="8317537">.</span><span class="ident" id="8317538">Y</span>&nbsp;<span class="op" id="8317540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8317546">//&nbsp;We&nbsp;don&#39;t&nbsp;care&nbsp;if&nbsp;the&nbsp;two&nbsp;pix&nbsp;data&nbsp;differ&nbsp;if&nbsp;the&nbsp;8x8&nbsp;block&nbsp;is</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8317614">//&nbsp;entirely&nbsp;outside&nbsp;of&nbsp;the&nbsp;image&#39;s&nbsp;bounds.&nbsp;For&nbsp;example,&nbsp;this&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8317683">//&nbsp;occur&nbsp;with&nbsp;a&nbsp;4:2:0&nbsp;chroma&nbsp;subsampling&nbsp;and&nbsp;a&nbsp;1x1&nbsp;image.&nbsp;Baseline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8317754">//&nbsp;decoding&nbsp;works&nbsp;on&nbsp;the&nbsp;one&nbsp;16x16&nbsp;MCU&nbsp;as&nbsp;a&nbsp;whole;&nbsp;progressive</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8317821">//&nbsp;decoding&#39;s&nbsp;first&nbsp;pass&nbsp;works&nbsp;on&nbsp;that&nbsp;16x16&nbsp;MCU&nbsp;as&nbsp;a&nbsp;whole&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8317889">//&nbsp;refinement&nbsp;passes&nbsp;only&nbsp;process&nbsp;one&nbsp;8x8&nbsp;block&nbsp;within&nbsp;the&nbsp;MCU.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8317957">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8317969">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8317975">for</span>&nbsp;<span class="ident" id="8317979">j</span>&nbsp;<span class="op" id="8317981">:=</span>&nbsp;<span class="num" id="8317984">0</span><span class="op" id="8317985">;</span>&nbsp;<span class="ident" id="8317987">j</span>&nbsp;<span class="op" id="8317989">&lt;</span>&nbsp;<span class="num" id="8317991">8</span><span class="op" id="8317992">;</span>&nbsp;<span class="ident" id="8317994">j</span><span class="op" id="8317995">++</span>&nbsp;<span class="op" id="8317998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8318004">for</span>&nbsp;<span class="ident" id="8318008">i</span>&nbsp;<span class="op" id="8318010">:=</span>&nbsp;<span class="num" id="8318013">0</span><span class="op" id="8318014">;</span>&nbsp;<span class="ident" id="8318016">i</span>&nbsp;<span class="op" id="8318018">&lt;</span>&nbsp;<span class="num" id="8318020">8</span><span class="op" id="8318021">;</span>&nbsp;<span class="ident" id="8318023">i</span><span class="op" id="8318024">++</span>&nbsp;<span class="op" id="8318027">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8318034">index0</span>&nbsp;<span class="op" id="8318041">:=</span>&nbsp;<span class="op" id="8318044">(</span><span class="ident" id="8318045">y</span><span class="op" id="8318046">+</span><span class="ident" id="8318047">j</span><span class="op" id="8318048">)</span><span class="op" id="8318049">*</span><span class="ident" id="8318050">stride0</span>&nbsp;<span class="op" id="8318058">+</span>&nbsp;<span class="op" id="8318060">(</span><span class="ident" id="8318061">x</span>&nbsp;<span class="op" id="8318063">+</span>&nbsp;<span class="ident" id="8318065">i</span><span class="op" id="8318066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8318073">index1</span>&nbsp;<span class="op" id="8318080">:=</span>&nbsp;<span class="op" id="8318083">(</span><span class="ident" id="8318084">y</span><span class="op" id="8318085">+</span><span class="ident" id="8318086">j</span><span class="op" id="8318087">)</span><span class="op" id="8318088">*</span><span class="ident" id="8318089">stride1</span>&nbsp;<span class="op" id="8318097">+</span>&nbsp;<span class="op" id="8318099">(</span><span class="ident" id="8318100">x</span>&nbsp;<span class="op" id="8318102">+</span>&nbsp;<span class="ident" id="8318104">i</span><span class="op" id="8318105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8318112">if</span>&nbsp;<span class="ident" id="8318115">pix0</span><span class="op" id="8318119">[</span><span class="ident" id="8318120">index0</span><span class="op" id="8318126">]</span>&nbsp;<span class="op" id="8318128">!=</span>&nbsp;<span class="ident" id="8318131">pix1</span><span class="op" id="8318135">[</span><span class="ident" id="8318136">index1</span><span class="op" id="8318142">]</span>&nbsp;<span class="op" id="8318144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8318152">return</span>&nbsp;<span class="ident" id="8318159">fmt</span><span class="op" id="8318162">.</span><span class="ident" id="8318163">Errorf</span><span class="op" id="8318169">(</span><span class="string" id="8318170">&#34;blocks&nbsp;at&nbsp;(%d,&nbsp;%d)&nbsp;differ:\n%sand\n%s&#34;</span><span class="op" id="8318209">,</span>&nbsp;<span class="ident" id="8318211">x</span><span class="op" id="8318212">,</span>&nbsp;<span class="ident" id="8318214">y</span><span class="op" id="8318215">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8318224">pixString</span><span class="op" id="8318233">(</span><span class="ident" id="8318234">pix0</span><span class="op" id="8318238">,</span>&nbsp;<span class="ident" id="8318240">stride0</span><span class="op" id="8318247">,</span>&nbsp;<span class="ident" id="8318249">x</span><span class="op" id="8318250">,</span>&nbsp;<span class="ident" id="8318252">y</span><span class="op" id="8318253">)</span><span class="op" id="8318254">,</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8318263">pixString</span><span class="op" id="8318272">(</span><span class="ident" id="8318273">pix1</span><span class="op" id="8318277">,</span>&nbsp;<span class="ident" id="8318279">stride1</span><span class="op" id="8318286">,</span>&nbsp;<span class="ident" id="8318288">x</span><span class="op" id="8318289">,</span>&nbsp;<span class="ident" id="8318291">y</span><span class="op" id="8318292">)</span><span class="op" id="8318293">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8318301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8318308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8318314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8318319">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8318323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8318326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8318329">return</span>&nbsp;<span class="ident" id="8318336">nil</span><br>
<span class="lineno"></span><span class="op" id="8318340">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="keyword" id="8318343">func</span>&nbsp;<span class="ident" id="8318348">pixString</span><span class="op" id="8318357">(</span><span class="ident" id="8318358">pix</span>&nbsp;<span class="op" id="8318362">[</span><span class="op" id="8318363">]</span><span class="builtintype" id="8318364">byte</span><span class="op" id="8318368">,</span>&nbsp;<span class="ident" id="8318370">stride</span><span class="op" id="8318376">,</span>&nbsp;<span class="ident" id="8318378">x</span><span class="op" id="8318379">,</span>&nbsp;<span class="ident" id="8318381">y</span>&nbsp;<span class="builtintype" id="8318383">int</span><span class="op" id="8318386">)</span>&nbsp;<span class="builtintype" id="8318388">string</span>&nbsp;<span class="op" id="8318395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8318398">s</span>&nbsp;<span class="op" id="8318400">:=</span>&nbsp;<span class="ident" id="8318403">bytes</span><span class="op" id="8318408">.</span><span class="ident" id="8318409">NewBuffer</span><span class="op" id="8318418">(</span><span class="ident" id="8318419">nil</span><span class="op" id="8318422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8318425">for</span>&nbsp;<span class="ident" id="8318429">j</span>&nbsp;<span class="op" id="8318431">:=</span>&nbsp;<span class="num" id="8318434">0</span><span class="op" id="8318435">;</span>&nbsp;<span class="ident" id="8318437">j</span>&nbsp;<span class="op" id="8318439">&lt;</span>&nbsp;<span class="num" id="8318441">8</span><span class="op" id="8318442">;</span>&nbsp;<span class="ident" id="8318444">j</span><span class="op" id="8318445">++</span>&nbsp;<span class="op" id="8318448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8318452">fmt</span><span class="op" id="8318455">.</span><span class="ident" id="8318456">Fprintf</span><span class="op" id="8318463">(</span><span class="ident" id="8318464">s</span><span class="op" id="8318465">,</span>&nbsp;<span class="string" id="8318467">&#34;\t&#34;</span><span class="op" id="8318471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8318475">for</span>&nbsp;<span class="ident" id="8318479">i</span>&nbsp;<span class="op" id="8318481">:=</span>&nbsp;<span class="num" id="8318484">0</span><span class="op" id="8318485">;</span>&nbsp;<span class="ident" id="8318487">i</span>&nbsp;<span class="op" id="8318489">&lt;</span>&nbsp;<span class="num" id="8318491">8</span><span class="op" id="8318492">;</span>&nbsp;<span class="ident" id="8318494">i</span><span class="op" id="8318495">++</span>&nbsp;<span class="op" id="8318498">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8318503">fmt</span><span class="op" id="8318506">.</span><span class="ident" id="8318507">Fprintf</span><span class="op" id="8318514">(</span><span class="ident" id="8318515">s</span><span class="op" id="8318516">,</span>&nbsp;<span class="string" id="8318518">&#34;%02x&nbsp;&#34;</span><span class="op" id="8318525">,</span>&nbsp;<span class="ident" id="8318527">pix</span><span class="op" id="8318530">[</span><span class="op" id="8318531">(</span><span class="ident" id="8318532">y</span><span class="op" id="8318533">+</span><span class="ident" id="8318534">j</span><span class="op" id="8318535">)</span><span class="op" id="8318536">*</span><span class="ident" id="8318537">stride</span><span class="op" id="8318543">+</span><span class="op" id="8318544">(</span><span class="ident" id="8318545">x</span><span class="op" id="8318546">+</span><span class="ident" id="8318547">i</span><span class="op" id="8318548">)</span><span class="op" id="8318549">]</span><span class="op" id="8318550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8318554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8318558">fmt</span><span class="op" id="8318561">.</span><span class="ident" id="8318562">Fprintf</span><span class="op" id="8318569">(</span><span class="ident" id="8318570">s</span><span class="op" id="8318571">,</span>&nbsp;<span class="string" id="8318573">&#34;\n&#34;</span><span class="op" id="8318577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8318580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8318583">return</span>&nbsp;<span class="ident" id="8318590">s</span><span class="op" id="8318591">.</span><span class="ident" id="8318592">String</span><span class="op" id="8318598">(</span><span class="op" id="8318599">)</span><br>
<span class="lineno">185</span><span class="op" id="8318601">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8318604">func</span>&nbsp;<span class="ident" id="8318609">TestExtraneousData</span><span class="op" id="8318627">(</span><span class="ident" id="8318628">t</span>&nbsp;<span class="op" id="8318630">*</span><span class="ident" id="8318631">testing</span><span class="op" id="8318638">.</span><span class="ident" id="8318639">T</span><span class="op" id="8318640">)</span>&nbsp;<span class="op" id="8318642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8318645">//&nbsp;Encode&nbsp;a&nbsp;1x1&nbsp;red&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8318673">src</span>&nbsp;<span class="op" id="8318677">:=</span>&nbsp;<span class="ident" id="8318680">image</span><span class="op" id="8318685">.</span><span class="ident" id="8318686">NewRGBA</span><span class="op" id="8318693">(</span><span class="ident" id="8318694">image</span><span class="op" id="8318699">.</span><span class="ident" id="8318700">Rect</span><span class="op" id="8318704">(</span><span class="num" id="8318705">0</span><span class="op" id="8318706">,</span>&nbsp;<span class="num" id="8318708">0</span><span class="op" id="8318709">,</span>&nbsp;<span class="num" id="8318711">1</span><span class="op" id="8318712">,</span>&nbsp;<span class="num" id="8318714">1</span><span class="op" id="8318715">)</span><span class="op" id="8318716">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8318719">src</span><span class="op" id="8318722">.</span><span class="ident" id="8318723">Set</span><span class="op" id="8318726">(</span><span class="num" id="8318727">0</span><span class="op" id="8318728">,</span>&nbsp;<span class="num" id="8318730">0</span><span class="op" id="8318731">,</span>&nbsp;<span class="ident" id="8318733">color</span><span class="op" id="8318738">.</span><span class="ident" id="8318739">RGBA</span><span class="op" id="8318743">{</span><span class="num" id="8318744">0xff</span><span class="op" id="8318748">,</span>&nbsp;<span class="num" id="8318750">0x00</span><span class="op" id="8318754">,</span>&nbsp;<span class="num" id="8318756">0x00</span><span class="op" id="8318760">,</span>&nbsp;<span class="num" id="8318762">0xff</span><span class="op" id="8318766">}</span><span class="op" id="8318767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8318770">buf</span>&nbsp;<span class="op" id="8318774">:=</span>&nbsp;<span class="builtinfunc" id="8318777">new</span><span class="op" id="8318780">(</span><span class="ident" id="8318781">bytes</span><span class="op" id="8318786">.</span><span class="ident" id="8318787">Buffer</span><span class="op" id="8318793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8318796">if</span>&nbsp;<span class="ident" id="8318799">err</span>&nbsp;<span class="op" id="8318803">:=</span>&nbsp;<span class="ident" id="8318806">Encode</span><span class="op" id="8318812">(</span><span class="ident" id="8318813">buf</span><span class="op" id="8318816">,</span>&nbsp;<span class="ident" id="8318818">src</span><span class="op" id="8318821">,</span>&nbsp;<span class="ident" id="8318823">nil</span><span class="op" id="8318826">)</span><span class="op" id="8318827">;</span>&nbsp;<span class="ident" id="8318829">err</span>&nbsp;<span class="op" id="8318833">!=</span>&nbsp;<span class="ident" id="8318836">nil</span>&nbsp;<span class="op" id="8318840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8318844">t</span><span class="op" id="8318845">.</span><span class="ident" id="8318846">Fatalf</span><span class="op" id="8318852">(</span><span class="string" id="8318853">&#34;encode:&nbsp;%v&#34;</span><span class="op" id="8318865">,</span>&nbsp;<span class="ident" id="8318867">err</span><span class="op" id="8318870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8318873">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8318876">enc</span>&nbsp;<span class="op" id="8318880">:=</span>&nbsp;<span class="ident" id="8318883">buf</span><span class="op" id="8318886">.</span><span class="ident" id="8318887">String</span><span class="op" id="8318893">(</span><span class="op" id="8318894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8318897">//&nbsp;Sanity&nbsp;check&nbsp;that&nbsp;the&nbsp;encoded&nbsp;JPEG&nbsp;is&nbsp;long&nbsp;enough,&nbsp;that&nbsp;it&nbsp;ends&nbsp;in&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8318970">//&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker,&nbsp;and&nbsp;that&nbsp;it&nbsp;contains&nbsp;a&nbsp;&#34;\xff\xda&#34;&nbsp;SOS&nbsp;marker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8319042">//&nbsp;somewhere&nbsp;in&nbsp;the&nbsp;final&nbsp;64&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8319079">if</span>&nbsp;<span class="builtinfunc" id="8319082">len</span><span class="op" id="8319085">(</span><span class="ident" id="8319086">enc</span><span class="op" id="8319089">)</span>&nbsp;<span class="op" id="8319091">&lt;</span>&nbsp;<span class="num" id="8319093">64</span>&nbsp;<span class="op" id="8319096">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8319100">t</span><span class="op" id="8319101">.</span><span class="ident" id="8319102">Fatalf</span><span class="op" id="8319108">(</span><span class="string" id="8319109">&#34;encoded&nbsp;JPEG&nbsp;is&nbsp;too&nbsp;short:&nbsp;%d&nbsp;bytes&#34;</span><span class="op" id="8319146">,</span>&nbsp;<span class="builtinfunc" id="8319148">len</span><span class="op" id="8319151">(</span><span class="ident" id="8319152">enc</span><span class="op" id="8319155">)</span><span class="op" id="8319156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8319159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8319162">if</span>&nbsp;<span class="ident" id="8319165">got</span><span class="op" id="8319168">,</span>&nbsp;<span class="ident" id="8319170">want</span>&nbsp;<span class="op" id="8319175">:=</span>&nbsp;<span class="ident" id="8319178">enc</span><span class="op" id="8319181">[</span><span class="builtinfunc" id="8319182">len</span><span class="op" id="8319185">(</span><span class="ident" id="8319186">enc</span><span class="op" id="8319189">)</span><span class="op" id="8319190">-</span><span class="num" id="8319191">2</span><span class="op" id="8319192">:</span><span class="op" id="8319193">]</span><span class="op" id="8319194">,</span>&nbsp;<span class="string" id="8319196">&#34;\xff\xd9&#34;</span><span class="op" id="8319206">;</span>&nbsp;<span class="ident" id="8319208">got</span>&nbsp;<span class="op" id="8319212">!=</span>&nbsp;<span class="ident" id="8319215">want</span>&nbsp;<span class="op" id="8319220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8319224">t</span><span class="op" id="8319225">.</span><span class="ident" id="8319226">Fatalf</span><span class="op" id="8319232">(</span><span class="string" id="8319233">&#34;encoded&nbsp;JPEG&nbsp;ends&nbsp;with&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="8319269">,</span>&nbsp;<span class="ident" id="8319271">got</span><span class="op" id="8319274">,</span>&nbsp;<span class="ident" id="8319276">want</span><span class="op" id="8319280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8319283">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8319286">if</span>&nbsp;<span class="ident" id="8319289">s</span>&nbsp;<span class="op" id="8319291">:=</span>&nbsp;<span class="ident" id="8319294">enc</span><span class="op" id="8319297">[</span><span class="builtinfunc" id="8319298">len</span><span class="op" id="8319301">(</span><span class="ident" id="8319302">enc</span><span class="op" id="8319305">)</span><span class="op" id="8319306">-</span><span class="num" id="8319307">64</span><span class="op" id="8319309">:</span><span class="op" id="8319310">]</span><span class="op" id="8319311">;</span>&nbsp;<span class="op" id="8319313">!</span><span class="ident" id="8319314">strings</span><span class="op" id="8319321">.</span><span class="ident" id="8319322">Contains</span><span class="op" id="8319330">(</span><span class="ident" id="8319331">s</span><span class="op" id="8319332">,</span>&nbsp;<span class="string" id="8319334">&#34;\xff\xda&#34;</span><span class="op" id="8319344">)</span>&nbsp;<span class="op" id="8319346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8319350">t</span><span class="op" id="8319351">.</span><span class="ident" id="8319352">Fatalf</span><span class="op" id="8319358">(</span><span class="string" id="8319359">&#34;encoded&nbsp;JPEG&nbsp;does&nbsp;not&nbsp;contain&nbsp;a&nbsp;SOS&nbsp;marker&nbsp;(ff&nbsp;da)&nbsp;near&nbsp;the&nbsp;end:&nbsp;%&nbsp;x&#34;</span><span class="op" id="8319429">,</span>&nbsp;<span class="ident" id="8319431">s</span><span class="op" id="8319432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8319435">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8319438">//&nbsp;Test&nbsp;that&nbsp;adding&nbsp;some&nbsp;random&nbsp;junk&nbsp;between&nbsp;the&nbsp;SOS&nbsp;marker&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8319507">//&nbsp;EOI&nbsp;marker&nbsp;does&nbsp;not&nbsp;affect&nbsp;the&nbsp;decoding.</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8319552">rnd</span>&nbsp;<span class="op" id="8319556">:=</span>&nbsp;<span class="ident" id="8319559">rand</span><span class="op" id="8319563">.</span><span class="ident" id="8319564">New</span><span class="op" id="8319567">(</span><span class="ident" id="8319568">rand</span><span class="op" id="8319572">.</span><span class="ident" id="8319573">NewSource</span><span class="op" id="8319582">(</span><span class="num" id="8319583">1</span><span class="op" id="8319584">)</span><span class="op" id="8319585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8319588">for</span>&nbsp;<span class="ident" id="8319592">i</span><span class="op" id="8319593">,</span>&nbsp;<span class="ident" id="8319595">nerr</span>&nbsp;<span class="op" id="8319600">:=</span>&nbsp;<span class="num" id="8319603">0</span><span class="op" id="8319604">,</span>&nbsp;<span class="num" id="8319606">0</span><span class="op" id="8319607">;</span>&nbsp;<span class="ident" id="8319609">i</span>&nbsp;<span class="op" id="8319611">&lt;</span>&nbsp;<span class="num" id="8319613">1000</span>&nbsp;<span class="op" id="8319618">&amp;&amp;</span>&nbsp;<span class="ident" id="8319621">nerr</span>&nbsp;<span class="op" id="8319626">&lt;</span>&nbsp;<span class="num" id="8319628">10</span><span class="op" id="8319630">;</span>&nbsp;<span class="ident" id="8319632">i</span><span class="op" id="8319633">++</span>&nbsp;<span class="op" id="8319636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8319640">buf</span><span class="op" id="8319643">.</span><span class="ident" id="8319644">Reset</span><span class="op" id="8319649">(</span><span class="op" id="8319650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8319654">//&nbsp;Write&nbsp;all&nbsp;but&nbsp;the&nbsp;trailing&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8319709">buf</span><span class="op" id="8319712">.</span><span class="ident" id="8319713">WriteString</span><span class="op" id="8319724">(</span><span class="ident" id="8319725">enc</span><span class="op" id="8319728">[</span><span class="op" id="8319729">:</span><span class="builtinfunc" id="8319730">len</span><span class="op" id="8319733">(</span><span class="ident" id="8319734">enc</span><span class="op" id="8319737">)</span><span class="op" id="8319738">-</span><span class="num" id="8319739">2</span><span class="op" id="8319740">]</span><span class="op" id="8319741">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8319745">//&nbsp;Write&nbsp;some&nbsp;random&nbsp;extraneous&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8319785">for</span>&nbsp;<span class="ident" id="8319789">n</span>&nbsp;<span class="op" id="8319791">:=</span>&nbsp;<span class="ident" id="8319794">rnd</span><span class="op" id="8319797">.</span><span class="ident" id="8319798">Intn</span><span class="op" id="8319802">(</span><span class="num" id="8319803">10</span><span class="op" id="8319805">)</span><span class="op" id="8319806">;</span>&nbsp;<span class="ident" id="8319808">n</span>&nbsp;<span class="op" id="8319810">&gt;</span>&nbsp;<span class="num" id="8319812">0</span><span class="op" id="8319813">;</span>&nbsp;<span class="ident" id="8319815">n</span><span class="op" id="8319816">--</span>&nbsp;<span class="op" id="8319819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8319824">if</span>&nbsp;<span class="ident" id="8319827">x</span>&nbsp;<span class="op" id="8319829">:=</span>&nbsp;<span class="builtintype" id="8319832">byte</span><span class="op" id="8319836">(</span><span class="ident" id="8319837">rnd</span><span class="op" id="8319840">.</span><span class="ident" id="8319841">Intn</span><span class="op" id="8319845">(</span><span class="num" id="8319846">256</span><span class="op" id="8319849">)</span><span class="op" id="8319850">)</span><span class="op" id="8319851">;</span>&nbsp;<span class="ident" id="8319853">x</span>&nbsp;<span class="op" id="8319855">!=</span>&nbsp;<span class="num" id="8319858">0xff</span>&nbsp;<span class="op" id="8319863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8319869">buf</span><span class="op" id="8319872">.</span><span class="ident" id="8319873">WriteByte</span><span class="op" id="8319882">(</span><span class="ident" id="8319883">x</span><span class="op" id="8319884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8319889">}</span>&nbsp;<span class="keyword" id="8319891">else</span>&nbsp;<span class="op" id="8319896">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8319902">//&nbsp;The&nbsp;JPEG&nbsp;format&nbsp;escapes&nbsp;a&nbsp;SOS&nbsp;0xff&nbsp;data&nbsp;byte&nbsp;as&nbsp;&#34;\xff\x00&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8319969">buf</span><span class="op" id="8319972">.</span><span class="ident" id="8319973">WriteString</span><span class="op" id="8319984">(</span><span class="string" id="8319985">&#34;\xff\x00&#34;</span><span class="op" id="8319995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8320000">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8320004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8320008">//&nbsp;Write&nbsp;the&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8320046">buf</span><span class="op" id="8320049">.</span><span class="ident" id="8320050">WriteString</span><span class="op" id="8320061">(</span><span class="string" id="8320062">&#34;\xff\xd9&#34;</span><span class="op" id="8320072">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8320077">//&nbsp;Check&nbsp;that&nbsp;we&nbsp;can&nbsp;still&nbsp;decode&nbsp;the&nbsp;resultant&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8320134">got</span><span class="op" id="8320137">,</span>&nbsp;<span class="ident" id="8320139">err</span>&nbsp;<span class="op" id="8320143">:=</span>&nbsp;<span class="ident" id="8320146">Decode</span><span class="op" id="8320152">(</span><span class="ident" id="8320153">buf</span><span class="op" id="8320156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8320160">if</span>&nbsp;<span class="ident" id="8320163">err</span>&nbsp;<span class="op" id="8320167">!=</span>&nbsp;<span class="ident" id="8320170">nil</span>&nbsp;<span class="op" id="8320174">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8320179">t</span><span class="op" id="8320180">.</span><span class="ident" id="8320181">Errorf</span><span class="op" id="8320187">(</span><span class="string" id="8320188">&#34;could&nbsp;not&nbsp;decode&nbsp;image&nbsp;#%d:&nbsp;%v&#34;</span><span class="op" id="8320220">,</span>&nbsp;<span class="ident" id="8320222">i</span><span class="op" id="8320223">,</span>&nbsp;<span class="ident" id="8320225">err</span><span class="op" id="8320228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8320233">nerr</span><span class="op" id="8320237">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8320243">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8320254">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8320258">if</span>&nbsp;<span class="ident" id="8320261">got</span><span class="op" id="8320264">.</span><span class="ident" id="8320265">Bounds</span><span class="op" id="8320271">(</span><span class="op" id="8320272">)</span>&nbsp;<span class="op" id="8320274">!=</span>&nbsp;<span class="ident" id="8320277">src</span><span class="op" id="8320280">.</span><span class="ident" id="8320281">Bounds</span><span class="op" id="8320287">(</span><span class="op" id="8320288">)</span>&nbsp;<span class="op" id="8320290">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8320295">t</span><span class="op" id="8320296">.</span><span class="ident" id="8320297">Errorf</span><span class="op" id="8320303">(</span><span class="string" id="8320304">&#34;image&nbsp;#%d,&nbsp;bounds&nbsp;differ:&nbsp;%v&nbsp;and&nbsp;%v&#34;</span><span class="op" id="8320341">,</span>&nbsp;<span class="ident" id="8320343">i</span><span class="op" id="8320344">,</span>&nbsp;<span class="ident" id="8320346">got</span><span class="op" id="8320349">.</span><span class="ident" id="8320350">Bounds</span><span class="op" id="8320356">(</span><span class="op" id="8320357">)</span><span class="op" id="8320358">,</span>&nbsp;<span class="ident" id="8320360">src</span><span class="op" id="8320363">.</span><span class="ident" id="8320364">Bounds</span><span class="op" id="8320370">(</span><span class="op" id="8320371">)</span><span class="op" id="8320372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8320377">nerr</span><span class="op" id="8320381">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8320387">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8320398">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8320402">if</span>&nbsp;<span class="ident" id="8320405">averageDelta</span><span class="op" id="8320417">(</span><span class="ident" id="8320418">got</span><span class="op" id="8320421">,</span>&nbsp;<span class="ident" id="8320423">src</span><span class="op" id="8320426">)</span>&nbsp;<span class="op" id="8320428">&gt;</span>&nbsp;<span class="num" id="8320430">2</span><span class="op" id="8320431">&lt;&lt;</span><span class="num" id="8320433">8</span>&nbsp;<span class="op" id="8320435">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8320440">t</span><span class="op" id="8320441">.</span><span class="ident" id="8320442">Errorf</span><span class="op" id="8320448">(</span><span class="string" id="8320449">&#34;image&nbsp;#%d&nbsp;changed&nbsp;too&nbsp;much&nbsp;after&nbsp;a&nbsp;round&nbsp;trip&#34;</span><span class="op" id="8320496">,</span>&nbsp;<span class="ident" id="8320498">i</span><span class="op" id="8320499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8320504">nerr</span><span class="op" id="8320508">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8320514">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8320525">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8320528">}</span><br>
<span class="lineno">245</span><span class="op" id="8320530">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8320533">func</span>&nbsp;<span class="ident" id="8320538">benchmarkDecode</span><span class="op" id="8320553">(</span><span class="ident" id="8320554">b</span>&nbsp;<span class="op" id="8320556">*</span><span class="ident" id="8320557">testing</span><span class="op" id="8320564">.</span><span class="ident" id="8320565">B</span><span class="op" id="8320566">,</span>&nbsp;<span class="ident" id="8320568">filename</span>&nbsp;<span class="builtintype" id="8320577">string</span><span class="op" id="8320583">)</span>&nbsp;<span class="op" id="8320585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8320588">b</span><span class="op" id="8320589">.</span><span class="ident" id="8320590">StopTimer</span><span class="op" id="8320599">(</span><span class="op" id="8320600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8320603">data</span><span class="op" id="8320607">,</span>&nbsp;<span class="ident" id="8320609">err</span>&nbsp;<span class="op" id="8320613">:=</span>&nbsp;<span class="ident" id="8320616">ioutil</span><span class="op" id="8320622">.</span><span class="ident" id="8320623">ReadFile</span><span class="op" id="8320631">(</span><span class="ident" id="8320632">filename</span><span class="op" id="8320640">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8320643">if</span>&nbsp;<span class="ident" id="8320646">err</span>&nbsp;<span class="op" id="8320650">!=</span>&nbsp;<span class="ident" id="8320653">nil</span>&nbsp;<span class="op" id="8320657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8320661">b</span><span class="op" id="8320662">.</span><span class="ident" id="8320663">Fatal</span><span class="op" id="8320668">(</span><span class="ident" id="8320669">err</span><span class="op" id="8320672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8320675">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8320678">cfg</span><span class="op" id="8320681">,</span>&nbsp;<span class="ident" id="8320683">err</span>&nbsp;<span class="op" id="8320687">:=</span>&nbsp;<span class="ident" id="8320690">DecodeConfig</span><span class="op" id="8320702">(</span><span class="ident" id="8320703">bytes</span><span class="op" id="8320708">.</span><span class="ident" id="8320709">NewReader</span><span class="op" id="8320718">(</span><span class="ident" id="8320719">data</span><span class="op" id="8320723">)</span><span class="op" id="8320724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8320727">if</span>&nbsp;<span class="ident" id="8320730">err</span>&nbsp;<span class="op" id="8320734">!=</span>&nbsp;<span class="ident" id="8320737">nil</span>&nbsp;<span class="op" id="8320741">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8320745">b</span><span class="op" id="8320746">.</span><span class="ident" id="8320747">Fatal</span><span class="op" id="8320752">(</span><span class="ident" id="8320753">err</span><span class="op" id="8320756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8320759">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8320762">b</span><span class="op" id="8320763">.</span><span class="ident" id="8320764">SetBytes</span><span class="op" id="8320772">(</span><span class="ident" id="8320773">int64</span><span class="op" id="8320778">(</span><span class="ident" id="8320779">cfg</span><span class="op" id="8320782">.</span><span class="ident" id="8320783">Width</span>&nbsp;<span class="op" id="8320789">*</span>&nbsp;<span class="ident" id="8320791">cfg</span><span class="op" id="8320794">.</span><span class="ident" id="8320795">Height</span>&nbsp;<span class="op" id="8320802">*</span>&nbsp;<span class="num" id="8320804">4</span><span class="op" id="8320805">)</span><span class="op" id="8320806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8320809">b</span><span class="op" id="8320810">.</span><span class="ident" id="8320811">StartTimer</span><span class="op" id="8320821">(</span><span class="op" id="8320822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8320825">for</span>&nbsp;<span class="ident" id="8320829">i</span>&nbsp;<span class="op" id="8320831">:=</span>&nbsp;<span class="num" id="8320834">0</span><span class="op" id="8320835">;</span>&nbsp;<span class="ident" id="8320837">i</span>&nbsp;<span class="op" id="8320839">&lt;</span>&nbsp;<span class="ident" id="8320841">b</span><span class="op" id="8320842">.</span><span class="ident" id="8320843">N</span><span class="op" id="8320844">;</span>&nbsp;<span class="ident" id="8320846">i</span><span class="op" id="8320847">++</span>&nbsp;<span class="op" id="8320850">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8320854">Decode</span><span class="op" id="8320860">(</span><span class="ident" id="8320861">bytes</span><span class="op" id="8320866">.</span><span class="ident" id="8320867">NewReader</span><span class="op" id="8320876">(</span><span class="ident" id="8320877">data</span><span class="op" id="8320881">)</span><span class="op" id="8320882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8320885">}</span><br>
<span class="lineno"></span><span class="op" id="8320887">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8320890">func</span>&nbsp;<span class="ident" id="8320895">BenchmarkDecodeBaseline</span><span class="op" id="8320918">(</span><span class="ident" id="8320919">b</span>&nbsp;<span class="op" id="8320921">*</span><span class="ident" id="8320922">testing</span><span class="op" id="8320929">.</span><span class="ident" id="8320930">B</span><span class="op" id="8320931">)</span>&nbsp;<span class="op" id="8320933">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8320936">benchmarkDecode</span><span class="op" id="8320951">(</span><span class="ident" id="8320952">b</span><span class="op" id="8320953">,</span>&nbsp;<span class="string" id="8320955">&#34;../testdata/video-001.jpeg&#34;</span><span class="op" id="8320983">)</span><br>
<span class="lineno"></span><span class="op" id="8320985">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8320988">func</span>&nbsp;<span class="ident" id="8320993">BenchmarkDecodeProgressive</span><span class="op" id="8321019">(</span><span class="ident" id="8321020">b</span>&nbsp;<span class="op" id="8321022">*</span><span class="ident" id="8321023">testing</span><span class="op" id="8321030">.</span><span class="ident" id="8321031">B</span><span class="op" id="8321032">)</span>&nbsp;<span class="op" id="8321034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8321037">benchmarkDecode</span><span class="op" id="8321052">(</span><span class="ident" id="8321053">b</span><span class="op" id="8321054">,</span>&nbsp;<span class="string" id="8321056">&#34;../testdata/video-001.progressive.jpeg&#34;</span><span class="op" id="8321096">)</span><br>
<span class="lineno">270</span><span class="op" id="8321098">}</span>
</div>
</body>
</html>
