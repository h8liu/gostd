<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>go/parser</h2>
<ul>
<li><a href="/gostd/go/parser/error_test.go.html">error_test.go</a></li>
<li><a href="/gostd/go/parser/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/go/parser/interface.go.html">interface.go</a></li>
<li><a href="/gostd/go/parser/parser.go.html">parser.go</a></li>
<li><a href="/gostd/go/parser/parser_test.go.html">parser_test.go</a></li>
<li><a href="/gostd/go/parser/performance_test.go.html">performance_test.go</a></li>
<li><a href="/gostd/go/parser/short_test.go.html">short_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4095835">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4095890">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4095944">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4095995">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;exported&nbsp;entry&nbsp;points&nbsp;for&nbsp;invoking&nbsp;the&nbsp;parser.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4096069">package</span>&nbsp;<span class="ident" id="4096077">parser</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4096085">import</span>&nbsp;<span class="op" id="4096092">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4096095">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4096104">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4096114">&#34;go/ast&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4096124">&#34;go/token&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4096136">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4096142">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4096155">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4096161">&#34;path/filepath&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4096178">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="4096188">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="4096191">//&nbsp;If&nbsp;src&nbsp;!=&nbsp;nil,&nbsp;readSource&nbsp;converts&nbsp;src&nbsp;to&nbsp;a&nbsp;[]byte&nbsp;if&nbsp;possible;</span><br>
<span class="lineno"></span><span class="comment" id="4096258">//&nbsp;otherwise&nbsp;it&nbsp;returns&nbsp;an&nbsp;error.&nbsp;If&nbsp;src&nbsp;==&nbsp;nil,&nbsp;readSource&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="4096326">//&nbsp;the&nbsp;result&nbsp;of&nbsp;reading&nbsp;the&nbsp;file&nbsp;specified&nbsp;by&nbsp;filename.</span><br>
<span class="lineno"></span><span class="comment" id="4096383">//</span><br>
<span class="lineno">25</span><span class="keyword" id="4096386">func</span>&nbsp;<span class="ident" id="4096391">readSource</span><span class="op" id="4096401">(</span><span class="ident" id="4096402">filename</span>&nbsp;<span class="builtintype" id="4096411">string</span><span class="op" id="4096417">,</span>&nbsp;<span class="ident" id="4096419">src</span>&nbsp;<span class="keyword" id="4096423">interface</span><span class="op" id="4096432">{</span><span class="op" id="4096433">}</span><span class="op" id="4096434">)</span>&nbsp;<span class="op" id="4096436">(</span><span class="op" id="4096437">[</span><span class="op" id="4096438">]</span><span class="builtintype" id="4096439">byte</span><span class="op" id="4096443">,</span>&nbsp;<span class="builtintype" id="4096445">error</span><span class="op" id="4096450">)</span>&nbsp;<span class="op" id="4096452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096455">if</span>&nbsp;<span class="ident" id="4096458">src</span>&nbsp;<span class="op" id="4096462">!=</span>&nbsp;<span class="ident" id="4096465">nil</span>&nbsp;<span class="op" id="4096469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096473">switch</span>&nbsp;<span class="ident" id="4096480">s</span>&nbsp;<span class="op" id="4096482">:=</span>&nbsp;<span class="ident" id="4096485">src</span><span class="op" id="4096488">.</span><span class="op" id="4096489">(</span><span class="keyword" id="4096490">type</span><span class="op" id="4096494">)</span>&nbsp;<span class="op" id="4096496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096500">case</span>&nbsp;<span class="builtintype" id="4096505">string</span><span class="op" id="4096511">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096516">return</span>&nbsp;<span class="op" id="4096523">[</span><span class="op" id="4096524">]</span><span class="builtintype" id="4096525">byte</span><span class="op" id="4096529">(</span><span class="ident" id="4096530">s</span><span class="op" id="4096531">)</span><span class="op" id="4096532">,</span>&nbsp;<span class="ident" id="4096534">nil</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096540">case</span>&nbsp;<span class="op" id="4096545">[</span><span class="op" id="4096546">]</span><span class="builtintype" id="4096547">byte</span><span class="op" id="4096551">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096556">return</span>&nbsp;<span class="ident" id="4096563">s</span><span class="op" id="4096564">,</span>&nbsp;<span class="ident" id="4096566">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096572">case</span>&nbsp;<span class="op" id="4096577">*</span><span class="ident" id="4096578">bytes</span><span class="op" id="4096583">.</span><span class="ident" id="4096584">Buffer</span><span class="op" id="4096590">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4096595">//&nbsp;is&nbsp;io.Reader,&nbsp;but&nbsp;src&nbsp;is&nbsp;already&nbsp;available&nbsp;in&nbsp;[]byte&nbsp;form</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096659">if</span>&nbsp;<span class="ident" id="4096662">s</span>&nbsp;<span class="op" id="4096664">!=</span>&nbsp;<span class="ident" id="4096667">nil</span>&nbsp;<span class="op" id="4096671">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096677">return</span>&nbsp;<span class="ident" id="4096684">s</span><span class="op" id="4096685">.</span><span class="ident" id="4096686">Bytes</span><span class="op" id="4096691">(</span><span class="op" id="4096692">)</span><span class="op" id="4096693">,</span>&nbsp;<span class="ident" id="4096695">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4096702">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096706">case</span>&nbsp;<span class="ident" id="4096711">io</span><span class="op" id="4096713">.</span><span class="ident" id="4096714">Reader</span><span class="op" id="4096720">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096725">var</span>&nbsp;<span class="ident" id="4096729">buf</span>&nbsp;<span class="ident" id="4096733">bytes</span><span class="op" id="4096738">.</span><span class="ident" id="4096739">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096749">if</span>&nbsp;<span class="ident" id="4096752">_</span><span class="op" id="4096753">,</span>&nbsp;<span class="ident" id="4096755">err</span>&nbsp;<span class="op" id="4096759">:=</span>&nbsp;<span class="ident" id="4096762">io</span><span class="op" id="4096764">.</span><span class="ident" id="4096765">Copy</span><span class="op" id="4096769">(</span><span class="op" id="4096770">&amp;</span><span class="ident" id="4096771">buf</span><span class="op" id="4096774">,</span>&nbsp;<span class="ident" id="4096776">s</span><span class="op" id="4096777">)</span><span class="op" id="4096778">;</span>&nbsp;<span class="ident" id="4096780">err</span>&nbsp;<span class="op" id="4096784">!=</span>&nbsp;<span class="ident" id="4096787">nil</span>&nbsp;<span class="op" id="4096791">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096797">return</span>&nbsp;<span class="ident" id="4096804">nil</span><span class="op" id="4096807">,</span>&nbsp;<span class="ident" id="4096809">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4096816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096821">return</span>&nbsp;<span class="ident" id="4096828">buf</span><span class="op" id="4096831">.</span><span class="ident" id="4096832">Bytes</span><span class="op" id="4096837">(</span><span class="op" id="4096838">)</span><span class="op" id="4096839">,</span>&nbsp;<span class="ident" id="4096841">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4096847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096851">return</span>&nbsp;<span class="ident" id="4096858">nil</span><span class="op" id="4096861">,</span>&nbsp;<span class="ident" id="4096863">errors</span><span class="op" id="4096869">.</span><span class="ident" id="4096870">New</span><span class="op" id="4096873">(</span><span class="string" id="4096874">&#34;invalid&nbsp;source&#34;</span><span class="op" id="4096890">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4096893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096896">return</span>&nbsp;<span class="ident" id="4096903">ioutil</span><span class="op" id="4096909">.</span><span class="ident" id="4096910">ReadFile</span><span class="op" id="4096918">(</span><span class="ident" id="4096919">filename</span><span class="op" id="4096927">)</span><br>
<span class="lineno"></span><span class="op" id="4096929">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4096932">//&nbsp;A&nbsp;Mode&nbsp;value&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;flags&nbsp;(or&nbsp;0).</span><br>
<span class="lineno">50</span><span class="comment" id="4096974">//&nbsp;They&nbsp;control&nbsp;the&nbsp;amount&nbsp;of&nbsp;source&nbsp;code&nbsp;parsed&nbsp;and&nbsp;other&nbsp;optional</span><br>
<span class="lineno"></span><span class="comment" id="4097042">//&nbsp;parser&nbsp;functionality.</span><br>
<span class="lineno"></span><span class="comment" id="4097067">//</span><br>
<span class="lineno"></span><span class="keyword" id="4097070">type</span>&nbsp;<span class="ident" id="4097075">Mode</span>&nbsp;<span class="builtintype" id="4097080">uint</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="4097086">const</span>&nbsp;<span class="op" id="4097092">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4097095">PackageClauseOnly</span>&nbsp;<span class="ident" id="4097113">Mode</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4097130">=</span>&nbsp;<span class="num" id="4097132">1</span>&nbsp;<span class="op" id="4097134">&lt;&lt;</span>&nbsp;<span class="ident" id="4097137">iota</span>&nbsp;<span class="comment" id="4097142">//&nbsp;stop&nbsp;parsing&nbsp;after&nbsp;package&nbsp;clause</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4097180">ImportsOnly</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4097227">//&nbsp;stop&nbsp;parsing&nbsp;after&nbsp;import&nbsp;declarations</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4097270">ParseComments</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4097317">//&nbsp;parse&nbsp;comments&nbsp;and&nbsp;add&nbsp;them&nbsp;to&nbsp;AST</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4097356">Trace</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4097403">//&nbsp;print&nbsp;a&nbsp;trace&nbsp;of&nbsp;parsed&nbsp;productions</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4097443">DeclarationErrors</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4097490">//&nbsp;report&nbsp;declaration&nbsp;errors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4097520">SpuriousErrors</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4097567">//&nbsp;same&nbsp;as&nbsp;AllErrors,&nbsp;for&nbsp;backward-compatibility</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4097617">AllErrors</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4097635">=</span>&nbsp;<span class="ident" id="4097637">SpuriousErrors</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4097664">//&nbsp;report&nbsp;all&nbsp;errors&nbsp;(not&nbsp;just&nbsp;the&nbsp;first&nbsp;10&nbsp;on&nbsp;different&nbsp;lines)</span><br>
<span class="lineno"></span><span class="op" id="4097728">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="4097731">//&nbsp;ParseFile&nbsp;parses&nbsp;the&nbsp;source&nbsp;code&nbsp;of&nbsp;a&nbsp;single&nbsp;Go&nbsp;source&nbsp;file&nbsp;and&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="4097806">//&nbsp;the&nbsp;corresponding&nbsp;ast.File&nbsp;node.&nbsp;The&nbsp;source&nbsp;code&nbsp;may&nbsp;be&nbsp;provided&nbsp;via</span><br>
<span class="lineno"></span><span class="comment" id="4097878">//&nbsp;the&nbsp;filename&nbsp;of&nbsp;the&nbsp;source&nbsp;file,&nbsp;or&nbsp;via&nbsp;the&nbsp;src&nbsp;parameter.</span><br>
<span class="lineno"></span><span class="comment" id="4097940">//</span><br>
<span class="lineno"></span><span class="comment" id="4097943">//&nbsp;If&nbsp;src&nbsp;!=&nbsp;nil,&nbsp;ParseFile&nbsp;parses&nbsp;the&nbsp;source&nbsp;from&nbsp;src&nbsp;and&nbsp;the&nbsp;filename&nbsp;is</span><br>
<span class="lineno">70</span><span class="comment" id="4098018">//&nbsp;only&nbsp;used&nbsp;when&nbsp;recording&nbsp;position&nbsp;information.&nbsp;The&nbsp;type&nbsp;of&nbsp;the&nbsp;argument</span><br>
<span class="lineno"></span><span class="comment" id="4098093">//&nbsp;for&nbsp;the&nbsp;src&nbsp;parameter&nbsp;must&nbsp;be&nbsp;string,&nbsp;[]byte,&nbsp;or&nbsp;io.Reader.</span><br>
<span class="lineno"></span><span class="comment" id="4098156">//&nbsp;If&nbsp;src&nbsp;==&nbsp;nil,&nbsp;ParseFile&nbsp;parses&nbsp;the&nbsp;file&nbsp;specified&nbsp;by&nbsp;filename.</span><br>
<span class="lineno"></span><span class="comment" id="4098223">//</span><br>
<span class="lineno"></span><span class="comment" id="4098226">//&nbsp;The&nbsp;mode&nbsp;parameter&nbsp;controls&nbsp;the&nbsp;amount&nbsp;of&nbsp;source&nbsp;text&nbsp;parsed&nbsp;and&nbsp;other</span><br>
<span class="lineno">75</span><span class="comment" id="4098300">//&nbsp;optional&nbsp;parser&nbsp;functionality.&nbsp;Position&nbsp;information&nbsp;is&nbsp;recorded&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4098374">//&nbsp;file&nbsp;set&nbsp;fset.</span><br>
<span class="lineno"></span><span class="comment" id="4098392">//</span><br>
<span class="lineno"></span><span class="comment" id="4098395">//&nbsp;If&nbsp;the&nbsp;source&nbsp;couldn&#39;t&nbsp;be&nbsp;read,&nbsp;the&nbsp;returned&nbsp;AST&nbsp;is&nbsp;nil&nbsp;and&nbsp;the&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="4098468">//&nbsp;indicates&nbsp;the&nbsp;specific&nbsp;failure.&nbsp;If&nbsp;the&nbsp;source&nbsp;was&nbsp;read&nbsp;but&nbsp;syntax</span><br>
<span class="lineno">80</span><span class="comment" id="4098537">//&nbsp;errors&nbsp;were&nbsp;found,&nbsp;the&nbsp;result&nbsp;is&nbsp;a&nbsp;partial&nbsp;AST&nbsp;(with&nbsp;ast.Bad*&nbsp;nodes</span><br>
<span class="lineno"></span><span class="comment" id="4098608">//&nbsp;representing&nbsp;the&nbsp;fragments&nbsp;of&nbsp;erroneous&nbsp;source&nbsp;code).&nbsp;Multiple&nbsp;errors</span><br>
<span class="lineno"></span><span class="comment" id="4098681">//&nbsp;are&nbsp;returned&nbsp;via&nbsp;a&nbsp;scanner.ErrorList&nbsp;which&nbsp;is&nbsp;sorted&nbsp;by&nbsp;file&nbsp;position.</span><br>
<span class="lineno"></span><span class="comment" id="4098755">//</span><br>
<span class="lineno"></span><span class="keyword" id="4098758">func</span>&nbsp;<span class="ident" id="4098763">ParseFile</span><span class="op" id="4098772">(</span><span class="ident" id="4098773">fset</span>&nbsp;<span class="op" id="4098778">*</span><span class="ident" id="4098779">token</span><span class="op" id="4098784">.</span><span class="ident" id="4098785">FileSet</span><span class="op" id="4098792">,</span>&nbsp;<span class="ident" id="4098794">filename</span>&nbsp;<span class="builtintype" id="4098803">string</span><span class="op" id="4098809">,</span>&nbsp;<span class="ident" id="4098811">src</span>&nbsp;<span class="keyword" id="4098815">interface</span><span class="op" id="4098824">{</span><span class="op" id="4098825">}</span><span class="op" id="4098826">,</span>&nbsp;<span class="ident" id="4098828">mode</span>&nbsp;<span class="ident" id="4098833">Mode</span><span class="op" id="4098837">)</span>&nbsp;<span class="op" id="4098839">(</span><span class="ident" id="4098840">f</span>&nbsp;<span class="op" id="4098842">*</span><span class="ident" id="4098843">ast</span><span class="op" id="4098846">.</span><span class="ident" id="4098847">File</span><span class="op" id="4098851">,</span>&nbsp;<span class="ident" id="4098853">err</span>&nbsp;<span class="builtintype" id="4098857">error</span><span class="op" id="4098862">)</span>&nbsp;<span class="op" id="4098864">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4098867">//&nbsp;get&nbsp;source</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4098882">text</span><span class="op" id="4098886">,</span>&nbsp;<span class="ident" id="4098888">err</span>&nbsp;<span class="op" id="4098892">:=</span>&nbsp;<span class="ident" id="4098895">readSource</span><span class="op" id="4098905">(</span><span class="ident" id="4098906">filename</span><span class="op" id="4098914">,</span>&nbsp;<span class="ident" id="4098916">src</span><span class="op" id="4098919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4098922">if</span>&nbsp;<span class="ident" id="4098925">err</span>&nbsp;<span class="op" id="4098929">!=</span>&nbsp;<span class="ident" id="4098932">nil</span>&nbsp;<span class="op" id="4098936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4098940">return</span>&nbsp;<span class="ident" id="4098947">nil</span><span class="op" id="4098950">,</span>&nbsp;<span class="ident" id="4098952">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4098957">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4098961">var</span>&nbsp;<span class="ident" id="4098965">p</span>&nbsp;<span class="ident" id="4098967">parser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4098975">defer</span>&nbsp;<span class="keyword" id="4098981">func</span><span class="op" id="4098985">(</span><span class="op" id="4098986">)</span>&nbsp;<span class="op" id="4098988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4098992">if</span>&nbsp;<span class="ident" id="4098995">e</span>&nbsp;<span class="op" id="4098997">:=</span>&nbsp;<span class="builtinfunc" id="4099000">recover</span><span class="op" id="4099007">(</span><span class="op" id="4099008">)</span><span class="op" id="4099009">;</span>&nbsp;<span class="ident" id="4099011">e</span>&nbsp;<span class="op" id="4099013">!=</span>&nbsp;<span class="ident" id="4099016">nil</span>&nbsp;<span class="op" id="4099020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4099025">_</span>&nbsp;<span class="op" id="4099027">=</span>&nbsp;<span class="ident" id="4099029">e</span><span class="op" id="4099030">.</span><span class="op" id="4099031">(</span><span class="ident" id="4099032">bailout</span><span class="op" id="4099039">)</span>&nbsp;<span class="comment" id="4099041">//&nbsp;re-panics&nbsp;if&nbsp;it&#39;s&nbsp;not&nbsp;a&nbsp;bailout</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4099078">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4099083">//&nbsp;set&nbsp;result&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4099106">if</span>&nbsp;<span class="ident" id="4099109">f</span>&nbsp;<span class="op" id="4099111">==</span>&nbsp;<span class="ident" id="4099114">nil</span>&nbsp;<span class="op" id="4099118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4099123">//&nbsp;source&nbsp;is&nbsp;not&nbsp;a&nbsp;valid&nbsp;Go&nbsp;source&nbsp;file&nbsp;-&nbsp;satisfy</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4099176">//&nbsp;ParseFile&nbsp;API&nbsp;and&nbsp;return&nbsp;a&nbsp;valid&nbsp;(but)&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4099227">//&nbsp;*ast.File</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4099243">f</span>&nbsp;<span class="op" id="4099245">=</span>&nbsp;<span class="op" id="4099247">&amp;</span><span class="ident" id="4099248">ast</span><span class="op" id="4099251">.</span><span class="ident" id="4099252">File</span><span class="op" id="4099256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4099262">Name</span><span class="op" id="4099266">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="4099269">new</span><span class="op" id="4099272">(</span><span class="ident" id="4099273">ast</span><span class="op" id="4099276">.</span><span class="ident" id="4099277">Ident</span><span class="op" id="4099282">)</span><span class="op" id="4099283">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4099289">Scope</span><span class="op" id="4099294">:</span>&nbsp;<span class="ident" id="4099296">ast</span><span class="op" id="4099299">.</span><span class="ident" id="4099300">NewScope</span><span class="op" id="4099308">(</span><span class="ident" id="4099309">nil</span><span class="op" id="4099312">)</span><span class="op" id="4099313">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4099318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4099322">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4099327">p</span><span class="op" id="4099328">.</span><span class="ident" id="4099329">errors</span><span class="op" id="4099335">.</span><span class="ident" id="4099336">Sort</span><span class="op" id="4099340">(</span><span class="op" id="4099341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4099345">err</span>&nbsp;<span class="op" id="4099349">=</span>&nbsp;<span class="ident" id="4099351">p</span><span class="op" id="4099352">.</span><span class="ident" id="4099353">errors</span><span class="op" id="4099359">.</span><span class="ident" id="4099360">Err</span><span class="op" id="4099363">(</span><span class="op" id="4099364">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4099367">}</span><span class="op" id="4099368">(</span><span class="op" id="4099369">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4099373">//&nbsp;parse&nbsp;source</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4099390">p</span><span class="op" id="4099391">.</span><span class="ident" id="4099392">init</span><span class="op" id="4099396">(</span><span class="ident" id="4099397">fset</span><span class="op" id="4099401">,</span>&nbsp;<span class="ident" id="4099403">filename</span><span class="op" id="4099411">,</span>&nbsp;<span class="ident" id="4099413">text</span><span class="op" id="4099417">,</span>&nbsp;<span class="ident" id="4099419">mode</span><span class="op" id="4099423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4099426">f</span>&nbsp;<span class="op" id="4099428">=</span>&nbsp;<span class="ident" id="4099430">p</span><span class="op" id="4099431">.</span><span class="ident" id="4099432">parseFile</span><span class="op" id="4099441">(</span><span class="op" id="4099442">)</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4099446">return</span><br>
<span class="lineno"></span><span class="op" id="4099453">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4099456">//&nbsp;ParseDir&nbsp;calls&nbsp;ParseFile&nbsp;for&nbsp;all&nbsp;files&nbsp;with&nbsp;names&nbsp;ending&nbsp;in&nbsp;&#34;.go&#34;&nbsp;in&nbsp;the</span><br>
<span class="lineno">120</span><span class="comment" id="4099532">//&nbsp;directory&nbsp;specified&nbsp;by&nbsp;path&nbsp;and&nbsp;returns&nbsp;a&nbsp;map&nbsp;of&nbsp;package&nbsp;name&nbsp;-&gt;&nbsp;package</span><br>
<span class="lineno"></span><span class="comment" id="4099608">//&nbsp;AST&nbsp;with&nbsp;all&nbsp;the&nbsp;packages&nbsp;found.</span><br>
<span class="lineno"></span><span class="comment" id="4099644">//</span><br>
<span class="lineno"></span><span class="comment" id="4099647">//&nbsp;If&nbsp;filter&nbsp;!=&nbsp;nil,&nbsp;only&nbsp;the&nbsp;files&nbsp;with&nbsp;os.FileInfo&nbsp;entries&nbsp;passing&nbsp;through</span><br>
<span class="lineno"></span><span class="comment" id="4099724">//&nbsp;the&nbsp;filter&nbsp;(and&nbsp;ending&nbsp;in&nbsp;&#34;.go&#34;)&nbsp;are&nbsp;considered.&nbsp;The&nbsp;mode&nbsp;bits&nbsp;are&nbsp;passed</span><br>
<span class="lineno">125</span><span class="comment" id="4099801">//&nbsp;to&nbsp;ParseFile&nbsp;unchanged.&nbsp;Position&nbsp;information&nbsp;is&nbsp;recorded&nbsp;in&nbsp;fset.</span><br>
<span class="lineno"></span><span class="comment" id="4099870">//</span><br>
<span class="lineno"></span><span class="comment" id="4099873">//&nbsp;If&nbsp;the&nbsp;directory&nbsp;couldn&#39;t&nbsp;be&nbsp;read,&nbsp;a&nbsp;nil&nbsp;map&nbsp;and&nbsp;the&nbsp;respective&nbsp;error&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="4099950">//&nbsp;returned.&nbsp;If&nbsp;a&nbsp;parse&nbsp;error&nbsp;occurred,&nbsp;a&nbsp;non-nil&nbsp;but&nbsp;incomplete&nbsp;map&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4100027">//&nbsp;first&nbsp;error&nbsp;encountered&nbsp;are&nbsp;returned.</span><br>
<span class="lineno">130</span><span class="comment" id="4100068">//</span><br>
<span class="lineno"></span><span class="keyword" id="4100071">func</span>&nbsp;<span class="ident" id="4100076">ParseDir</span><span class="op" id="4100084">(</span><span class="ident" id="4100085">fset</span>&nbsp;<span class="op" id="4100090">*</span><span class="ident" id="4100091">token</span><span class="op" id="4100096">.</span><span class="ident" id="4100097">FileSet</span><span class="op" id="4100104">,</span>&nbsp;<span class="ident" id="4100106">path</span>&nbsp;<span class="builtintype" id="4100111">string</span><span class="op" id="4100117">,</span>&nbsp;<span class="ident" id="4100119">filter</span>&nbsp;<span class="keyword" id="4100126">func</span><span class="op" id="4100130">(</span><span class="ident" id="4100131">os</span><span class="op" id="4100133">.</span><span class="ident" id="4100134">FileInfo</span><span class="op" id="4100142">)</span>&nbsp;<span class="builtintype" id="4100144">bool</span><span class="op" id="4100148">,</span>&nbsp;<span class="ident" id="4100150">mode</span>&nbsp;<span class="ident" id="4100155">Mode</span><span class="op" id="4100159">)</span>&nbsp;<span class="op" id="4100161">(</span><span class="ident" id="4100162">pkgs</span>&nbsp;<span class="keyword" id="4100167">map</span><span class="op" id="4100170">[</span><span class="builtintype" id="4100171">string</span><span class="op" id="4100177">]</span><span class="op" id="4100178">*</span><span class="ident" id="4100179">ast</span><span class="op" id="4100182">.</span><span class="ident" id="4100183">Package</span><span class="op" id="4100190">,</span>&nbsp;<span class="ident" id="4100192">first</span>&nbsp;<span class="builtintype" id="4100198">error</span><span class="op" id="4100203">)</span>&nbsp;<span class="op" id="4100205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4100208">fd</span><span class="op" id="4100210">,</span>&nbsp;<span class="ident" id="4100212">err</span>&nbsp;<span class="op" id="4100216">:=</span>&nbsp;<span class="ident" id="4100219">os</span><span class="op" id="4100221">.</span><span class="ident" id="4100222">Open</span><span class="op" id="4100226">(</span><span class="ident" id="4100227">path</span><span class="op" id="4100231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4100234">if</span>&nbsp;<span class="ident" id="4100237">err</span>&nbsp;<span class="op" id="4100241">!=</span>&nbsp;<span class="ident" id="4100244">nil</span>&nbsp;<span class="op" id="4100248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4100252">return</span>&nbsp;<span class="ident" id="4100259">nil</span><span class="op" id="4100262">,</span>&nbsp;<span class="ident" id="4100264">err</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4100269">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4100272">defer</span>&nbsp;<span class="ident" id="4100278">fd</span><span class="op" id="4100280">.</span><span class="ident" id="4100281">Close</span><span class="op" id="4100286">(</span><span class="op" id="4100287">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4100291">list</span><span class="op" id="4100295">,</span>&nbsp;<span class="ident" id="4100297">err</span>&nbsp;<span class="op" id="4100301">:=</span>&nbsp;<span class="ident" id="4100304">fd</span><span class="op" id="4100306">.</span><span class="ident" id="4100307">Readdir</span><span class="op" id="4100314">(</span><span class="op" id="4100315">-</span><span class="num" id="4100316">1</span><span class="op" id="4100317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4100320">if</span>&nbsp;<span class="ident" id="4100323">err</span>&nbsp;<span class="op" id="4100327">!=</span>&nbsp;<span class="ident" id="4100330">nil</span>&nbsp;<span class="op" id="4100334">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4100338">return</span>&nbsp;<span class="ident" id="4100345">nil</span><span class="op" id="4100348">,</span>&nbsp;<span class="ident" id="4100350">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4100355">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4100359">pkgs</span>&nbsp;<span class="op" id="4100364">=</span>&nbsp;<span class="builtinfunc" id="4100366">make</span><span class="op" id="4100370">(</span><span class="keyword" id="4100371">map</span><span class="op" id="4100374">[</span><span class="builtintype" id="4100375">string</span><span class="op" id="4100381">]</span><span class="op" id="4100382">*</span><span class="ident" id="4100383">ast</span><span class="op" id="4100386">.</span><span class="ident" id="4100387">Package</span><span class="op" id="4100394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4100397">for</span>&nbsp;<span class="ident" id="4100401">_</span><span class="op" id="4100402">,</span>&nbsp;<span class="ident" id="4100404">d</span>&nbsp;<span class="op" id="4100406">:=</span>&nbsp;<span class="keyword" id="4100409">range</span>&nbsp;<span class="ident" id="4100415">list</span>&nbsp;<span class="op" id="4100420">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4100424">if</span>&nbsp;<span class="ident" id="4100427">strings</span><span class="op" id="4100434">.</span><span class="ident" id="4100435">HasSuffix</span><span class="op" id="4100444">(</span><span class="ident" id="4100445">d</span><span class="op" id="4100446">.</span><span class="ident" id="4100447">Name</span><span class="op" id="4100451">(</span><span class="op" id="4100452">)</span><span class="op" id="4100453">,</span>&nbsp;<span class="string" id="4100455">&#34;.go&#34;</span><span class="op" id="4100460">)</span>&nbsp;<span class="op" id="4100462">&amp;&amp;</span>&nbsp;<span class="op" id="4100465">(</span><span class="ident" id="4100466">filter</span>&nbsp;<span class="op" id="4100473">==</span>&nbsp;<span class="ident" id="4100476">nil</span>&nbsp;<span class="op" id="4100480">||</span>&nbsp;<span class="ident" id="4100483">filter</span><span class="op" id="4100489">(</span><span class="ident" id="4100490">d</span><span class="op" id="4100491">)</span><span class="op" id="4100492">)</span>&nbsp;<span class="op" id="4100494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4100499">filename</span>&nbsp;<span class="op" id="4100508">:=</span>&nbsp;<span class="ident" id="4100511">filepath</span><span class="op" id="4100519">.</span><span class="ident" id="4100520">Join</span><span class="op" id="4100524">(</span><span class="ident" id="4100525">path</span><span class="op" id="4100529">,</span>&nbsp;<span class="ident" id="4100531">d</span><span class="op" id="4100532">.</span><span class="ident" id="4100533">Name</span><span class="op" id="4100537">(</span><span class="op" id="4100538">)</span><span class="op" id="4100539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4100544">if</span>&nbsp;<span class="ident" id="4100547">src</span><span class="op" id="4100550">,</span>&nbsp;<span class="ident" id="4100552">err</span>&nbsp;<span class="op" id="4100556">:=</span>&nbsp;<span class="ident" id="4100559">ParseFile</span><span class="op" id="4100568">(</span><span class="ident" id="4100569">fset</span><span class="op" id="4100573">,</span>&nbsp;<span class="ident" id="4100575">filename</span><span class="op" id="4100583">,</span>&nbsp;<span class="ident" id="4100585">nil</span><span class="op" id="4100588">,</span>&nbsp;<span class="ident" id="4100590">mode</span><span class="op" id="4100594">)</span><span class="op" id="4100595">;</span>&nbsp;<span class="ident" id="4100597">err</span>&nbsp;<span class="op" id="4100601">==</span>&nbsp;<span class="ident" id="4100604">nil</span>&nbsp;<span class="op" id="4100608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4100614">name</span>&nbsp;<span class="op" id="4100619">:=</span>&nbsp;<span class="ident" id="4100622">src</span><span class="op" id="4100625">.</span><span class="ident" id="4100626">Name</span><span class="op" id="4100630">.</span><span class="ident" id="4100631">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4100640">pkg</span><span class="op" id="4100643">,</span>&nbsp;<span class="ident" id="4100645">found</span>&nbsp;<span class="op" id="4100651">:=</span>&nbsp;<span class="ident" id="4100654">pkgs</span><span class="op" id="4100658">[</span><span class="ident" id="4100659">name</span><span class="op" id="4100663">]</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4100669">if</span>&nbsp;<span class="op" id="4100672">!</span><span class="ident" id="4100673">found</span>&nbsp;<span class="op" id="4100679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4100686">pkg</span>&nbsp;<span class="op" id="4100690">=</span>&nbsp;<span class="op" id="4100692">&amp;</span><span class="ident" id="4100693">ast</span><span class="op" id="4100696">.</span><span class="ident" id="4100697">Package</span><span class="op" id="4100704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4100712">Name</span><span class="op" id="4100716">:</span>&nbsp;&nbsp;<span class="ident" id="4100719">name</span><span class="op" id="4100723">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4100731">Files</span><span class="op" id="4100736">:</span>&nbsp;<span class="builtinfunc" id="4100738">make</span><span class="op" id="4100742">(</span><span class="keyword" id="4100743">map</span><span class="op" id="4100746">[</span><span class="builtintype" id="4100747">string</span><span class="op" id="4100753">]</span><span class="op" id="4100754">*</span><span class="ident" id="4100755">ast</span><span class="op" id="4100758">.</span><span class="ident" id="4100759">File</span><span class="op" id="4100763">)</span><span class="op" id="4100764">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4100771">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4100778">pkgs</span><span class="op" id="4100782">[</span><span class="ident" id="4100783">name</span><span class="op" id="4100787">]</span>&nbsp;<span class="op" id="4100789">=</span>&nbsp;<span class="ident" id="4100791">pkg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4100799">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4100805">pkg</span><span class="op" id="4100808">.</span><span class="ident" id="4100809">Files</span><span class="op" id="4100814">[</span><span class="ident" id="4100815">filename</span><span class="op" id="4100823">]</span>&nbsp;<span class="op" id="4100825">=</span>&nbsp;<span class="ident" id="4100827">src</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4100834">}</span>&nbsp;<span class="keyword" id="4100836">else</span>&nbsp;<span class="keyword" id="4100841">if</span>&nbsp;<span class="ident" id="4100844">first</span>&nbsp;<span class="op" id="4100850">==</span>&nbsp;<span class="ident" id="4100853">nil</span>&nbsp;<span class="op" id="4100857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4100863">first</span>&nbsp;<span class="op" id="4100869">=</span>&nbsp;<span class="ident" id="4100871">err</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4100878">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4100882">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4100885">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4100889">return</span><br>
<span class="lineno">165</span><span class="op" id="4100896">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4100899">//&nbsp;ParseExpr&nbsp;is&nbsp;a&nbsp;convenience&nbsp;function&nbsp;for&nbsp;obtaining&nbsp;the&nbsp;AST&nbsp;of&nbsp;an&nbsp;expression&nbsp;x.</span><br>
<span class="lineno"></span><span class="comment" id="4100980">//&nbsp;The&nbsp;position&nbsp;information&nbsp;recorded&nbsp;in&nbsp;the&nbsp;AST&nbsp;is&nbsp;undefined.&nbsp;The&nbsp;filename&nbsp;used</span><br>
<span class="lineno"></span><span class="comment" id="4101060">//&nbsp;in&nbsp;error&nbsp;messages&nbsp;is&nbsp;the&nbsp;empty&nbsp;string.</span><br>
<span class="lineno">170</span><span class="comment" id="4101102">//</span><br>
<span class="lineno"></span><span class="keyword" id="4101105">func</span>&nbsp;<span class="ident" id="4101110">ParseExpr</span><span class="op" id="4101119">(</span><span class="ident" id="4101120">x</span>&nbsp;<span class="builtintype" id="4101122">string</span><span class="op" id="4101128">)</span>&nbsp;<span class="op" id="4101130">(</span><span class="ident" id="4101131">ast</span><span class="op" id="4101134">.</span><span class="ident" id="4101135">Expr</span><span class="op" id="4101139">,</span>&nbsp;<span class="builtintype" id="4101141">error</span><span class="op" id="4101146">)</span>&nbsp;<span class="op" id="4101148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4101151">var</span>&nbsp;<span class="ident" id="4101155">p</span>&nbsp;<span class="ident" id="4101157">parser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4101165">p</span><span class="op" id="4101166">.</span><span class="ident" id="4101167">init</span><span class="op" id="4101171">(</span><span class="ident" id="4101172">token</span><span class="op" id="4101177">.</span><span class="ident" id="4101178">NewFileSet</span><span class="op" id="4101188">(</span><span class="op" id="4101189">)</span><span class="op" id="4101190">,</span>&nbsp;<span class="string" id="4101192">&#34;&#34;</span><span class="op" id="4101194">,</span>&nbsp;<span class="op" id="4101196">[</span><span class="op" id="4101197">]</span><span class="builtintype" id="4101198">byte</span><span class="op" id="4101202">(</span><span class="ident" id="4101203">x</span><span class="op" id="4101204">)</span><span class="op" id="4101205">,</span>&nbsp;<span class="num" id="4101207">0</span><span class="op" id="4101208">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4101212">//&nbsp;Set&nbsp;up&nbsp;pkg-level&nbsp;scopes&nbsp;to&nbsp;avoid&nbsp;nil-pointer&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4101269">//&nbsp;This&nbsp;is&nbsp;not&nbsp;needed&nbsp;for&nbsp;a&nbsp;correct&nbsp;expression&nbsp;x&nbsp;as&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4101326">//&nbsp;parser&nbsp;will&nbsp;be&nbsp;ok&nbsp;with&nbsp;a&nbsp;nil&nbsp;topScope,&nbsp;but&nbsp;be&nbsp;cautious</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4101385">//&nbsp;in&nbsp;case&nbsp;of&nbsp;an&nbsp;erroneous&nbsp;x.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4101416">p</span><span class="op" id="4101417">.</span><span class="ident" id="4101418">openScope</span><span class="op" id="4101427">(</span><span class="op" id="4101428">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4101431">p</span><span class="op" id="4101432">.</span><span class="ident" id="4101433">pkgScope</span>&nbsp;<span class="op" id="4101442">=</span>&nbsp;<span class="ident" id="4101444">p</span><span class="op" id="4101445">.</span><span class="ident" id="4101446">topScope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4101456">e</span>&nbsp;<span class="op" id="4101458">:=</span>&nbsp;<span class="ident" id="4101461">p</span><span class="op" id="4101462">.</span><span class="ident" id="4101463">parseRhsOrType</span><span class="op" id="4101477">(</span><span class="op" id="4101478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4101481">p</span><span class="op" id="4101482">.</span><span class="ident" id="4101483">closeScope</span><span class="op" id="4101493">(</span><span class="op" id="4101494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4101497">assert</span><span class="op" id="4101503">(</span><span class="ident" id="4101504">p</span><span class="op" id="4101505">.</span><span class="ident" id="4101506">topScope</span>&nbsp;<span class="op" id="4101515">==</span>&nbsp;<span class="ident" id="4101518">nil</span><span class="op" id="4101521">,</span>&nbsp;<span class="string" id="4101523">&#34;unbalanced&nbsp;scopes&#34;</span><span class="op" id="4101542">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4101546">//&nbsp;If&nbsp;a&nbsp;semicolon&nbsp;was&nbsp;inserted,&nbsp;consume&nbsp;it;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4101591">//&nbsp;report&nbsp;an&nbsp;error&nbsp;if&nbsp;there&#39;s&nbsp;more&nbsp;tokens.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4101635">if</span>&nbsp;<span class="ident" id="4101638">p</span><span class="op" id="4101639">.</span><span class="ident" id="4101640">tok</span>&nbsp;<span class="op" id="4101644">==</span>&nbsp;<span class="ident" id="4101647">token</span><span class="op" id="4101652">.</span><span class="ident" id="4101653">SEMICOLON</span>&nbsp;<span class="op" id="4101663">&amp;&amp;</span>&nbsp;<span class="ident" id="4101666">p</span><span class="op" id="4101667">.</span><span class="ident" id="4101668">lit</span>&nbsp;<span class="op" id="4101672">==</span>&nbsp;<span class="string" id="4101675">&#34;\n&#34;</span>&nbsp;<span class="op" id="4101680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4101684">p</span><span class="op" id="4101685">.</span><span class="ident" id="4101686">next</span><span class="op" id="4101690">(</span><span class="op" id="4101691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4101694">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4101697">p</span><span class="op" id="4101698">.</span><span class="ident" id="4101699">expect</span><span class="op" id="4101705">(</span><span class="ident" id="4101706">token</span><span class="op" id="4101711">.</span><span class="ident" id="4101712">EOF</span><span class="op" id="4101715">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4101719">if</span>&nbsp;<span class="ident" id="4101722">p</span><span class="op" id="4101723">.</span><span class="ident" id="4101724">errors</span><span class="op" id="4101730">.</span><span class="ident" id="4101731">Len</span><span class="op" id="4101734">(</span><span class="op" id="4101735">)</span>&nbsp;<span class="op" id="4101737">&gt;</span>&nbsp;<span class="num" id="4101739">0</span>&nbsp;<span class="op" id="4101741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4101745">p</span><span class="op" id="4101746">.</span><span class="ident" id="4101747">errors</span><span class="op" id="4101753">.</span><span class="ident" id="4101754">Sort</span><span class="op" id="4101758">(</span><span class="op" id="4101759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4101763">return</span>&nbsp;<span class="ident" id="4101770">nil</span><span class="op" id="4101773">,</span>&nbsp;<span class="ident" id="4101775">p</span><span class="op" id="4101776">.</span><span class="ident" id="4101777">errors</span><span class="op" id="4101783">.</span><span class="ident" id="4101784">Err</span><span class="op" id="4101787">(</span><span class="op" id="4101788">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4101791">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4101795">return</span>&nbsp;<span class="ident" id="4101802">e</span><span class="op" id="4101803">,</span>&nbsp;<span class="ident" id="4101805">nil</span><br>
<span class="lineno"></span><span class="op" id="4101809">}</span>
</div>
</body>
</html>
