<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html" class="current">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1353028">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1353083">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1353137">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1353188">package</span>&nbsp;<span class="ident" id="1353196">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1353202">import</span>&nbsp;<span class="op" id="1353209">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1353212">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1353227">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><span class="op" id="1353236">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1353239">//&nbsp;Cond&nbsp;implements&nbsp;a&nbsp;condition&nbsp;variable,&nbsp;a&nbsp;rendezvous&nbsp;point</span><br>
<span class="lineno"></span><span class="comment" id="1353299">//&nbsp;for&nbsp;goroutines&nbsp;waiting&nbsp;for&nbsp;or&nbsp;announcing&nbsp;the&nbsp;occurrence</span><br>
<span class="lineno"></span><span class="comment" id="1353358">//&nbsp;of&nbsp;an&nbsp;event.</span><br>
<span class="lineno">15</span><span class="comment" id="1353374">//</span><br>
<span class="lineno"></span><span class="comment" id="1353377">//&nbsp;Each&nbsp;Cond&nbsp;has&nbsp;an&nbsp;associated&nbsp;Locker&nbsp;L&nbsp;(often&nbsp;a&nbsp;*Mutex&nbsp;or&nbsp;*RWMutex),</span><br>
<span class="lineno"></span><span class="comment" id="1353447">//&nbsp;which&nbsp;must&nbsp;be&nbsp;held&nbsp;when&nbsp;changing&nbsp;the&nbsp;condition&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1353501">//&nbsp;when&nbsp;calling&nbsp;the&nbsp;Wait&nbsp;method.</span><br>
<span class="lineno"></span><span class="comment" id="1353534">//</span><br>
<span class="lineno">20</span><span class="comment" id="1353537">//&nbsp;A&nbsp;Cond&nbsp;can&nbsp;be&nbsp;created&nbsp;as&nbsp;part&nbsp;of&nbsp;other&nbsp;structures.</span><br>
<span class="lineno"></span><span class="comment" id="1353591">//&nbsp;A&nbsp;Cond&nbsp;must&nbsp;not&nbsp;be&nbsp;copied&nbsp;after&nbsp;first&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="1353637">type</span>&nbsp;<span class="ident" id="1353642">Cond</span>&nbsp;<span class="keyword" id="1353647">struct</span>&nbsp;<span class="op" id="1353654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1353657">//&nbsp;L&nbsp;is&nbsp;held&nbsp;while&nbsp;observing&nbsp;or&nbsp;changing&nbsp;the&nbsp;condition</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1353713">L</span>&nbsp;<span class="ident" id="1353715">Locker</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1353724">sema</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1353732">syncSema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1353742">waiters</span>&nbsp;<span class="builtintype" id="1353750">uint32</span>&nbsp;<span class="comment" id="1353757">//&nbsp;number&nbsp;of&nbsp;waiters</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1353779">checker</span>&nbsp;<span class="ident" id="1353787">copyChecker</span><br>
<span class="lineno"></span><span class="op" id="1353799">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="comment" id="1353802">//&nbsp;NewCond&nbsp;returns&nbsp;a&nbsp;new&nbsp;Cond&nbsp;with&nbsp;Locker&nbsp;l.</span><br>
<span class="lineno"></span><span class="keyword" id="1353847">func</span>&nbsp;<span class="ident" id="1353852">NewCond</span><span class="op" id="1353859">(</span><span class="ident" id="1353860">l</span>&nbsp;<span class="ident" id="1353862">Locker</span><span class="op" id="1353868">)</span>&nbsp;<span class="op" id="1353870">*</span><span class="ident" id="1353871">Cond</span>&nbsp;<span class="op" id="1353876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1353879">return</span>&nbsp;<span class="op" id="1353886">&amp;</span><span class="ident" id="1353887">Cond</span><span class="op" id="1353891">{</span><span class="ident" id="1353892">L</span><span class="op" id="1353893">:</span>&nbsp;<span class="ident" id="1353895">l</span><span class="op" id="1353896">}</span><br>
<span class="lineno"></span><span class="op" id="1353898">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="1353901">//&nbsp;Wait&nbsp;atomically&nbsp;unlocks&nbsp;c.L&nbsp;and&nbsp;suspends&nbsp;execution</span><br>
<span class="lineno"></span><span class="comment" id="1353955">//&nbsp;of&nbsp;the&nbsp;calling&nbsp;goroutine.&nbsp;&nbsp;After&nbsp;later&nbsp;resuming&nbsp;execution,</span><br>
<span class="lineno"></span><span class="comment" id="1354017">//&nbsp;Wait&nbsp;locks&nbsp;c.L&nbsp;before&nbsp;returning.&nbsp;&nbsp;Unlike&nbsp;in&nbsp;other&nbsp;systems,</span><br>
<span class="lineno"></span><span class="comment" id="1354079">//&nbsp;Wait&nbsp;cannot&nbsp;return&nbsp;unless&nbsp;awoken&nbsp;by&nbsp;Broadcast&nbsp;or&nbsp;Signal.</span><br>
<span class="lineno">40</span><span class="comment" id="1354139">//</span><br>
<span class="lineno"></span><span class="comment" id="1354142">//&nbsp;Because&nbsp;c.L&nbsp;is&nbsp;not&nbsp;locked&nbsp;when&nbsp;Wait&nbsp;first&nbsp;resumes,&nbsp;the&nbsp;caller</span><br>
<span class="lineno"></span><span class="comment" id="1354207">//&nbsp;typically&nbsp;cannot&nbsp;assume&nbsp;that&nbsp;the&nbsp;condition&nbsp;is&nbsp;true&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="1354266">//&nbsp;Wait&nbsp;returns.&nbsp;&nbsp;Instead,&nbsp;the&nbsp;caller&nbsp;should&nbsp;Wait&nbsp;in&nbsp;a&nbsp;loop:</span><br>
<span class="lineno"></span><span class="comment" id="1354327">//</span><br>
<span class="lineno">45</span><span class="comment" id="1354330">//&nbsp;&nbsp;&nbsp;&nbsp;c.L.Lock()</span><br>
<span class="lineno"></span><span class="comment" id="1354347">//&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;!condition()&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1354372">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c.Wait()</span><br>
<span class="lineno"></span><span class="comment" id="1354391">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="1354399">//&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;make&nbsp;use&nbsp;of&nbsp;condition&nbsp;...</span><br>
<span class="lineno">50</span><span class="comment" id="1354435">//&nbsp;&nbsp;&nbsp;&nbsp;c.L.Unlock()</span><br>
<span class="lineno"></span><span class="comment" id="1354454">//</span><br>
<span class="lineno"></span><span class="keyword" id="1354457">func</span>&nbsp;<span class="op" id="1354462">(</span><span class="ident" id="1354463">c</span>&nbsp;<span class="op" id="1354465">*</span><span class="ident" id="1354466">Cond</span><span class="op" id="1354470">)</span>&nbsp;<span class="ident" id="1354472">Wait</span><span class="op" id="1354476">(</span><span class="op" id="1354477">)</span>&nbsp;<span class="op" id="1354479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1354482">c</span><span class="op" id="1354483">.</span><span class="ident" id="1354484">checker</span><span class="op" id="1354491">.</span><span class="ident" id="1354492">check</span><span class="op" id="1354497">(</span><span class="op" id="1354498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1354501">if</span>&nbsp;<span class="ident" id="1354504">raceenabled</span>&nbsp;<span class="op" id="1354516">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1354520">raceDisable</span><span class="op" id="1354531">(</span><span class="op" id="1354532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1354535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1354538">atomic</span><span class="op" id="1354544">.</span><span class="ident" id="1354545">AddUint32</span><span class="op" id="1354554">(</span><span class="op" id="1354555">&amp;</span><span class="ident" id="1354556">c</span><span class="op" id="1354557">.</span><span class="ident" id="1354558">waiters</span><span class="op" id="1354565">,</span>&nbsp;<span class="num" id="1354567">1</span><span class="op" id="1354568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1354571">if</span>&nbsp;<span class="ident" id="1354574">raceenabled</span>&nbsp;<span class="op" id="1354586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1354590">raceEnable</span><span class="op" id="1354600">(</span><span class="op" id="1354601">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1354604">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1354607">c</span><span class="op" id="1354608">.</span><span class="ident" id="1354609">L</span><span class="op" id="1354610">.</span><span class="ident" id="1354611">Unlock</span><span class="op" id="1354617">(</span><span class="op" id="1354618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1354621">runtime_Syncsemacquire</span><span class="op" id="1354643">(</span><span class="op" id="1354644">&amp;</span><span class="ident" id="1354645">c</span><span class="op" id="1354646">.</span><span class="ident" id="1354647">sema</span><span class="op" id="1354651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1354654">c</span><span class="op" id="1354655">.</span><span class="ident" id="1354656">L</span><span class="op" id="1354657">.</span><span class="ident" id="1354658">Lock</span><span class="op" id="1354662">(</span><span class="op" id="1354663">)</span><br>
<span class="lineno"></span><span class="op" id="1354665">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="1354668">//&nbsp;Signal&nbsp;wakes&nbsp;one&nbsp;goroutine&nbsp;waiting&nbsp;on&nbsp;c,&nbsp;if&nbsp;there&nbsp;is&nbsp;any.</span><br>
<span class="lineno"></span><span class="comment" id="1354729">//</span><br>
<span class="lineno"></span><span class="comment" id="1354732">//&nbsp;It&nbsp;is&nbsp;allowed&nbsp;but&nbsp;not&nbsp;required&nbsp;for&nbsp;the&nbsp;caller&nbsp;to&nbsp;hold&nbsp;c.L</span><br>
<span class="lineno"></span><span class="comment" id="1354793">//&nbsp;during&nbsp;the&nbsp;call.</span><br>
<span class="lineno">70</span><span class="keyword" id="1354813">func</span>&nbsp;<span class="op" id="1354818">(</span><span class="ident" id="1354819">c</span>&nbsp;<span class="op" id="1354821">*</span><span class="ident" id="1354822">Cond</span><span class="op" id="1354826">)</span>&nbsp;<span class="ident" id="1354828">Signal</span><span class="op" id="1354834">(</span><span class="op" id="1354835">)</span>&nbsp;<span class="op" id="1354837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1354840">c</span><span class="op" id="1354841">.</span><span class="ident" id="1354842">signalImpl</span><span class="op" id="1354852">(</span><span class="builtintype" id="1354853">false</span><span class="op" id="1354858">)</span><br>
<span class="lineno"></span><span class="op" id="1354860">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1354863">//&nbsp;Broadcast&nbsp;wakes&nbsp;all&nbsp;goroutines&nbsp;waiting&nbsp;on&nbsp;c.</span><br>
<span class="lineno">75</span><span class="comment" id="1354911">//</span><br>
<span class="lineno"></span><span class="comment" id="1354914">//&nbsp;It&nbsp;is&nbsp;allowed&nbsp;but&nbsp;not&nbsp;required&nbsp;for&nbsp;the&nbsp;caller&nbsp;to&nbsp;hold&nbsp;c.L</span><br>
<span class="lineno"></span><span class="comment" id="1354975">//&nbsp;during&nbsp;the&nbsp;call.</span><br>
<span class="lineno"></span><span class="keyword" id="1354995">func</span>&nbsp;<span class="op" id="1355000">(</span><span class="ident" id="1355001">c</span>&nbsp;<span class="op" id="1355003">*</span><span class="ident" id="1355004">Cond</span><span class="op" id="1355008">)</span>&nbsp;<span class="ident" id="1355010">Broadcast</span><span class="op" id="1355019">(</span><span class="op" id="1355020">)</span>&nbsp;<span class="op" id="1355022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1355025">c</span><span class="op" id="1355026">.</span><span class="ident" id="1355027">signalImpl</span><span class="op" id="1355037">(</span><span class="builtintype" id="1355038">true</span><span class="op" id="1355042">)</span><br>
<span class="lineno">80</span><span class="op" id="1355044">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1355047">func</span>&nbsp;<span class="op" id="1355052">(</span><span class="ident" id="1355053">c</span>&nbsp;<span class="op" id="1355055">*</span><span class="ident" id="1355056">Cond</span><span class="op" id="1355060">)</span>&nbsp;<span class="ident" id="1355062">signalImpl</span><span class="op" id="1355072">(</span><span class="ident" id="1355073">all</span>&nbsp;<span class="builtintype" id="1355077">bool</span><span class="op" id="1355081">)</span>&nbsp;<span class="op" id="1355083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1355086">c</span><span class="op" id="1355087">.</span><span class="ident" id="1355088">checker</span><span class="op" id="1355095">.</span><span class="ident" id="1355096">check</span><span class="op" id="1355101">(</span><span class="op" id="1355102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1355105">if</span>&nbsp;<span class="ident" id="1355108">raceenabled</span>&nbsp;<span class="op" id="1355120">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1355124">raceDisable</span><span class="op" id="1355135">(</span><span class="op" id="1355136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1355139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1355142">for</span>&nbsp;<span class="op" id="1355146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1355150">old</span>&nbsp;<span class="op" id="1355154">:=</span>&nbsp;<span class="ident" id="1355157">atomic</span><span class="op" id="1355163">.</span><span class="ident" id="1355164">LoadUint32</span><span class="op" id="1355174">(</span><span class="op" id="1355175">&amp;</span><span class="ident" id="1355176">c</span><span class="op" id="1355177">.</span><span class="ident" id="1355178">waiters</span><span class="op" id="1355185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1355189">if</span>&nbsp;<span class="ident" id="1355192">old</span>&nbsp;<span class="op" id="1355196">==</span>&nbsp;<span class="num" id="1355199">0</span>&nbsp;<span class="op" id="1355201">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1355206">if</span>&nbsp;<span class="ident" id="1355209">raceenabled</span>&nbsp;<span class="op" id="1355221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1355227">raceEnable</span><span class="op" id="1355237">(</span><span class="op" id="1355238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1355243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1355248">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1355257">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1355261">new</span>&nbsp;<span class="op" id="1355265">:=</span>&nbsp;<span class="ident" id="1355268">old</span>&nbsp;<span class="op" id="1355272">-</span>&nbsp;<span class="num" id="1355274">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1355278">if</span>&nbsp;<span class="ident" id="1355281">all</span>&nbsp;<span class="op" id="1355285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1355290">new</span>&nbsp;<span class="op" id="1355294">=</span>&nbsp;<span class="num" id="1355296">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1355300">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1355304">if</span>&nbsp;<span class="ident" id="1355307">atomic</span><span class="op" id="1355313">.</span><span class="ident" id="1355314">CompareAndSwapUint32</span><span class="op" id="1355334">(</span><span class="op" id="1355335">&amp;</span><span class="ident" id="1355336">c</span><span class="op" id="1355337">.</span><span class="ident" id="1355338">waiters</span><span class="op" id="1355345">,</span>&nbsp;<span class="ident" id="1355347">old</span><span class="op" id="1355350">,</span>&nbsp;<span class="builtinfunc" id="1355352">new</span><span class="op" id="1355355">)</span>&nbsp;<span class="op" id="1355357">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1355362">if</span>&nbsp;<span class="ident" id="1355365">raceenabled</span>&nbsp;<span class="op" id="1355377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1355383">raceEnable</span><span class="op" id="1355393">(</span><span class="op" id="1355394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1355399">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1355404">runtime_Syncsemrelease</span><span class="op" id="1355426">(</span><span class="op" id="1355427">&amp;</span><span class="ident" id="1355428">c</span><span class="op" id="1355429">.</span><span class="ident" id="1355430">sema</span><span class="op" id="1355434">,</span>&nbsp;<span class="ident" id="1355436">old</span><span class="op" id="1355439">-</span><span class="builtinfunc" id="1355440">new</span><span class="op" id="1355443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1355448">return</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1355457">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1355460">}</span><br>
<span class="lineno"></span><span class="op" id="1355462">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1355465">//&nbsp;copyChecker&nbsp;holds&nbsp;back&nbsp;pointer&nbsp;to&nbsp;itself&nbsp;to&nbsp;detect&nbsp;object&nbsp;copying.</span><br>
<span class="lineno">110</span><span class="keyword" id="1355535">type</span>&nbsp;<span class="ident" id="1355540">copyChecker</span>&nbsp;<span class="builtintype" id="1355552">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1355561">func</span>&nbsp;<span class="op" id="1355566">(</span><span class="ident" id="1355567">c</span>&nbsp;<span class="op" id="1355569">*</span><span class="ident" id="1355570">copyChecker</span><span class="op" id="1355581">)</span>&nbsp;<span class="ident" id="1355583">check</span><span class="op" id="1355588">(</span><span class="op" id="1355589">)</span>&nbsp;<span class="op" id="1355591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1355594">if</span>&nbsp;<span class="builtintype" id="1355597">uintptr</span><span class="op" id="1355604">(</span><span class="op" id="1355605">*</span><span class="ident" id="1355606">c</span><span class="op" id="1355607">)</span>&nbsp;<span class="op" id="1355609">!=</span>&nbsp;<span class="builtintype" id="1355612">uintptr</span><span class="op" id="1355619">(</span><span class="ident" id="1355620">unsafe</span><span class="op" id="1355626">.</span><span class="ident" id="1355627">Pointer</span><span class="op" id="1355634">(</span><span class="ident" id="1355635">c</span><span class="op" id="1355636">)</span><span class="op" id="1355637">)</span>&nbsp;<span class="op" id="1355639">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1355644">!</span><span class="ident" id="1355645">atomic</span><span class="op" id="1355651">.</span><span class="ident" id="1355652">CompareAndSwapUintptr</span><span class="op" id="1355673">(</span><span class="op" id="1355674">(</span><span class="op" id="1355675">*</span><span class="builtintype" id="1355676">uintptr</span><span class="op" id="1355683">)</span><span class="op" id="1355684">(</span><span class="ident" id="1355685">c</span><span class="op" id="1355686">)</span><span class="op" id="1355687">,</span>&nbsp;<span class="num" id="1355689">0</span><span class="op" id="1355690">,</span>&nbsp;<span class="builtintype" id="1355692">uintptr</span><span class="op" id="1355699">(</span><span class="ident" id="1355700">unsafe</span><span class="op" id="1355706">.</span><span class="ident" id="1355707">Pointer</span><span class="op" id="1355714">(</span><span class="ident" id="1355715">c</span><span class="op" id="1355716">)</span><span class="op" id="1355717">)</span><span class="op" id="1355718">)</span>&nbsp;<span class="op" id="1355720">&amp;&amp;</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1355725">uintptr</span><span class="op" id="1355732">(</span><span class="op" id="1355733">*</span><span class="ident" id="1355734">c</span><span class="op" id="1355735">)</span>&nbsp;<span class="op" id="1355737">!=</span>&nbsp;<span class="builtintype" id="1355740">uintptr</span><span class="op" id="1355747">(</span><span class="ident" id="1355748">unsafe</span><span class="op" id="1355754">.</span><span class="ident" id="1355755">Pointer</span><span class="op" id="1355762">(</span><span class="ident" id="1355763">c</span><span class="op" id="1355764">)</span><span class="op" id="1355765">)</span>&nbsp;<span class="op" id="1355767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1355771">panic</span><span class="op" id="1355776">(</span><span class="string" id="1355777">&#34;sync.Cond&nbsp;is&nbsp;copied&#34;</span><span class="op" id="1355798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1355801">}</span><br>
<span class="lineno"></span><span class="op" id="1355803">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
