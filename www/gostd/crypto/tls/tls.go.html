<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html" class="current">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4313293">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4313348">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4313402">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4313453">//&nbsp;Package&nbsp;tls&nbsp;partially&nbsp;implements&nbsp;TLS&nbsp;1.2,&nbsp;as&nbsp;specified&nbsp;in&nbsp;RFC&nbsp;5246.</span><br>
<span class="lineno"></span><span class="keyword" id="4313524">package</span>&nbsp;<span class="ident" id="4313532">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4313537">import</span>&nbsp;<span class="op" id="4313544">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4313547">&#34;crypto&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4313557">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4313573">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4313587">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4313602">&#34;encoding/pem&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4313618">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4313628">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4313641">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4313648">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4313659">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="4313666">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="4313669">//&nbsp;Server&nbsp;returns&nbsp;a&nbsp;new&nbsp;TLS&nbsp;server&nbsp;side&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="4313720">//&nbsp;using&nbsp;conn&nbsp;as&nbsp;the&nbsp;underlying&nbsp;transport.</span><br>
<span class="lineno"></span><span class="comment" id="4313763">//&nbsp;The&nbsp;configuration&nbsp;config&nbsp;must&nbsp;be&nbsp;non-nil&nbsp;and&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="4313821">//&nbsp;at&nbsp;least&nbsp;one&nbsp;certificate.</span><br>
<span class="lineno">25</span><span class="keyword" id="4313850">func</span>&nbsp;<span class="ident" id="4313855">Server</span><span class="op" id="4313861">(</span><span class="ident" id="4313862">conn</span>&nbsp;<span class="ident" id="4313867">net</span><span class="op" id="4313870">.</span><span class="ident" id="4313871">Conn</span><span class="op" id="4313875">,</span>&nbsp;<span class="ident" id="4313877">config</span>&nbsp;<span class="op" id="4313884">*</span><span class="ident" id="4313885">Config</span><span class="op" id="4313891">)</span>&nbsp;<span class="op" id="4313893">*</span><span class="ident" id="4313894">Conn</span>&nbsp;<span class="op" id="4313899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4313902">return</span>&nbsp;<span class="op" id="4313909">&amp;</span><span class="ident" id="4313910">Conn</span><span class="op" id="4313914">{</span><span class="ident" id="4313915">conn</span><span class="op" id="4313919">:</span>&nbsp;<span class="ident" id="4313921">conn</span><span class="op" id="4313925">,</span>&nbsp;<span class="ident" id="4313927">config</span><span class="op" id="4313933">:</span>&nbsp;<span class="ident" id="4313935">config</span><span class="op" id="4313941">}</span><br>
<span class="lineno"></span><span class="op" id="4313943">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4313946">//&nbsp;Client&nbsp;returns&nbsp;a&nbsp;new&nbsp;TLS&nbsp;client&nbsp;side&nbsp;connection</span><br>
<span class="lineno">30</span><span class="comment" id="4313997">//&nbsp;using&nbsp;conn&nbsp;as&nbsp;the&nbsp;underlying&nbsp;transport.</span><br>
<span class="lineno"></span><span class="comment" id="4314040">//&nbsp;The&nbsp;config&nbsp;cannot&nbsp;be&nbsp;nil:&nbsp;users&nbsp;must&nbsp;set&nbsp;either&nbsp;ServerName&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="4314105">//&nbsp;InsecureSkipVerify&nbsp;in&nbsp;the&nbsp;config.</span><br>
<span class="lineno"></span><span class="keyword" id="4314142">func</span>&nbsp;<span class="ident" id="4314147">Client</span><span class="op" id="4314153">(</span><span class="ident" id="4314154">conn</span>&nbsp;<span class="ident" id="4314159">net</span><span class="op" id="4314162">.</span><span class="ident" id="4314163">Conn</span><span class="op" id="4314167">,</span>&nbsp;<span class="ident" id="4314169">config</span>&nbsp;<span class="op" id="4314176">*</span><span class="ident" id="4314177">Config</span><span class="op" id="4314183">)</span>&nbsp;<span class="op" id="4314185">*</span><span class="ident" id="4314186">Conn</span>&nbsp;<span class="op" id="4314191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4314194">return</span>&nbsp;<span class="op" id="4314201">&amp;</span><span class="ident" id="4314202">Conn</span><span class="op" id="4314206">{</span><span class="ident" id="4314207">conn</span><span class="op" id="4314211">:</span>&nbsp;<span class="ident" id="4314213">conn</span><span class="op" id="4314217">,</span>&nbsp;<span class="ident" id="4314219">config</span><span class="op" id="4314225">:</span>&nbsp;<span class="ident" id="4314227">config</span><span class="op" id="4314233">,</span>&nbsp;<span class="ident" id="4314235">isClient</span><span class="op" id="4314243">:</span>&nbsp;<span class="builtintype" id="4314245">true</span><span class="op" id="4314249">}</span><br>
<span class="lineno">35</span><span class="op" id="4314251">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4314254">//&nbsp;A&nbsp;listener&nbsp;implements&nbsp;a&nbsp;network&nbsp;listener&nbsp;(net.Listener)&nbsp;for&nbsp;TLS&nbsp;connections.</span><br>
<span class="lineno"></span><span class="keyword" id="4314334">type</span>&nbsp;<span class="ident" id="4314339">listener</span>&nbsp;<span class="keyword" id="4314348">struct</span>&nbsp;<span class="op" id="4314355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4314358">net</span><span class="op" id="4314361">.</span><span class="ident" id="4314362">Listener</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4314372">config</span>&nbsp;<span class="op" id="4314379">*</span><span class="ident" id="4314380">Config</span><br>
<span class="lineno"></span><span class="op" id="4314387">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4314390">//&nbsp;Accept&nbsp;waits&nbsp;for&nbsp;and&nbsp;returns&nbsp;the&nbsp;next&nbsp;incoming&nbsp;TLS&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4314456">//&nbsp;The&nbsp;returned&nbsp;connection&nbsp;c&nbsp;is&nbsp;a&nbsp;*tls.Conn.</span><br>
<span class="lineno">45</span><span class="keyword" id="4314501">func</span>&nbsp;<span class="op" id="4314506">(</span><span class="ident" id="4314507">l</span>&nbsp;<span class="op" id="4314509">*</span><span class="ident" id="4314510">listener</span><span class="op" id="4314518">)</span>&nbsp;<span class="ident" id="4314520">Accept</span><span class="op" id="4314526">(</span><span class="op" id="4314527">)</span>&nbsp;<span class="op" id="4314529">(</span><span class="ident" id="4314530">c</span>&nbsp;<span class="ident" id="4314532">net</span><span class="op" id="4314535">.</span><span class="ident" id="4314536">Conn</span><span class="op" id="4314540">,</span>&nbsp;<span class="ident" id="4314542">err</span>&nbsp;<span class="builtintype" id="4314546">error</span><span class="op" id="4314551">)</span>&nbsp;<span class="op" id="4314553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4314556">c</span><span class="op" id="4314557">,</span>&nbsp;<span class="ident" id="4314559">err</span>&nbsp;<span class="op" id="4314563">=</span>&nbsp;<span class="ident" id="4314565">l</span><span class="op" id="4314566">.</span><span class="ident" id="4314567">Listener</span><span class="op" id="4314575">.</span><span class="ident" id="4314576">Accept</span><span class="op" id="4314582">(</span><span class="op" id="4314583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4314586">if</span>&nbsp;<span class="ident" id="4314589">err</span>&nbsp;<span class="op" id="4314593">!=</span>&nbsp;<span class="builtintype" id="4314596">nil</span>&nbsp;<span class="op" id="4314600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4314604">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4314612">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4314615">c</span>&nbsp;<span class="op" id="4314617">=</span>&nbsp;<span class="ident" id="4314619">Server</span><span class="op" id="4314625">(</span><span class="ident" id="4314626">c</span><span class="op" id="4314627">,</span>&nbsp;<span class="ident" id="4314629">l</span><span class="op" id="4314630">.</span><span class="ident" id="4314631">config</span><span class="op" id="4314637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4314640">return</span><br>
<span class="lineno"></span><span class="op" id="4314647">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4314650">//&nbsp;NewListener&nbsp;creates&nbsp;a&nbsp;Listener&nbsp;which&nbsp;accepts&nbsp;connections&nbsp;from&nbsp;an&nbsp;inner</span><br>
<span class="lineno">55</span><span class="comment" id="4314724">//&nbsp;Listener&nbsp;and&nbsp;wraps&nbsp;each&nbsp;connection&nbsp;with&nbsp;Server.</span><br>
<span class="lineno"></span><span class="comment" id="4314775">//&nbsp;The&nbsp;configuration&nbsp;config&nbsp;must&nbsp;be&nbsp;non-nil&nbsp;and&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="4314833">//&nbsp;at&nbsp;least&nbsp;one&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="4314862">func</span>&nbsp;<span class="ident" id="4314867">NewListener</span><span class="op" id="4314878">(</span><span class="ident" id="4314879">inner</span>&nbsp;<span class="ident" id="4314885">net</span><span class="op" id="4314888">.</span><span class="ident" id="4314889">Listener</span><span class="op" id="4314897">,</span>&nbsp;<span class="ident" id="4314899">config</span>&nbsp;<span class="op" id="4314906">*</span><span class="ident" id="4314907">Config</span><span class="op" id="4314913">)</span>&nbsp;<span class="ident" id="4314915">net</span><span class="op" id="4314918">.</span><span class="ident" id="4314919">Listener</span>&nbsp;<span class="op" id="4314928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4314931">l</span>&nbsp;<span class="op" id="4314933">:=</span>&nbsp;<span class="builtinfunc" id="4314936">new</span><span class="op" id="4314939">(</span><span class="ident" id="4314940">listener</span><span class="op" id="4314948">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4314951">l</span><span class="op" id="4314952">.</span><span class="ident" id="4314953">Listener</span>&nbsp;<span class="op" id="4314962">=</span>&nbsp;<span class="ident" id="4314964">inner</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4314971">l</span><span class="op" id="4314972">.</span><span class="ident" id="4314973">config</span>&nbsp;<span class="op" id="4314980">=</span>&nbsp;<span class="ident" id="4314982">config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4314990">return</span>&nbsp;<span class="ident" id="4314997">l</span><br>
<span class="lineno"></span><span class="op" id="4314999">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="4315002">//&nbsp;Listen&nbsp;creates&nbsp;a&nbsp;TLS&nbsp;listener&nbsp;accepting&nbsp;connections&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4315064">//&nbsp;given&nbsp;network&nbsp;address&nbsp;using&nbsp;net.Listen.</span><br>
<span class="lineno"></span><span class="comment" id="4315107">//&nbsp;The&nbsp;configuration&nbsp;config&nbsp;must&nbsp;be&nbsp;non-nil&nbsp;and&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="4315165">//&nbsp;at&nbsp;least&nbsp;one&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="4315194">func</span>&nbsp;<span class="ident" id="4315199">Listen</span><span class="op" id="4315205">(</span><span class="ident" id="4315206">network</span><span class="op" id="4315213">,</span>&nbsp;<span class="ident" id="4315215">laddr</span>&nbsp;<span class="builtintype" id="4315221">string</span><span class="op" id="4315227">,</span>&nbsp;<span class="ident" id="4315229">config</span>&nbsp;<span class="op" id="4315236">*</span><span class="ident" id="4315237">Config</span><span class="op" id="4315243">)</span>&nbsp;<span class="op" id="4315245">(</span><span class="ident" id="4315246">net</span><span class="op" id="4315249">.</span><span class="ident" id="4315250">Listener</span><span class="op" id="4315258">,</span>&nbsp;<span class="builtintype" id="4315260">error</span><span class="op" id="4315265">)</span>&nbsp;<span class="op" id="4315267">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4315270">if</span>&nbsp;<span class="ident" id="4315273">config</span>&nbsp;<span class="op" id="4315280">==</span>&nbsp;<span class="builtintype" id="4315283">nil</span>&nbsp;<span class="op" id="4315287">||</span>&nbsp;<span class="builtinfunc" id="4315290">len</span><span class="op" id="4315293">(</span><span class="ident" id="4315294">config</span><span class="op" id="4315300">.</span><span class="ident" id="4315301">Certificates</span><span class="op" id="4315313">)</span>&nbsp;<span class="op" id="4315315">==</span>&nbsp;<span class="num" id="4315318">0</span>&nbsp;<span class="op" id="4315320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4315324">return</span>&nbsp;<span class="builtintype" id="4315331">nil</span><span class="op" id="4315334">,</span>&nbsp;<span class="ident" id="4315336">errors</span><span class="op" id="4315342">.</span><span class="ident" id="4315343">New</span><span class="op" id="4315346">(</span><span class="string" id="4315347">&#34;tls.Listen:&nbsp;no&nbsp;certificates&nbsp;in&nbsp;configuration&#34;</span><span class="op" id="4315393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4315396">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4315399">l</span><span class="op" id="4315400">,</span>&nbsp;<span class="ident" id="4315402">err</span>&nbsp;<span class="op" id="4315406">:=</span>&nbsp;<span class="ident" id="4315409">net</span><span class="op" id="4315412">.</span><span class="ident" id="4315413">Listen</span><span class="op" id="4315419">(</span><span class="ident" id="4315420">network</span><span class="op" id="4315427">,</span>&nbsp;<span class="ident" id="4315429">laddr</span><span class="op" id="4315434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4315437">if</span>&nbsp;<span class="ident" id="4315440">err</span>&nbsp;<span class="op" id="4315444">!=</span>&nbsp;<span class="builtintype" id="4315447">nil</span>&nbsp;<span class="op" id="4315451">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4315455">return</span>&nbsp;<span class="builtintype" id="4315462">nil</span><span class="op" id="4315465">,</span>&nbsp;<span class="ident" id="4315467">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4315472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4315475">return</span>&nbsp;<span class="ident" id="4315482">NewListener</span><span class="op" id="4315493">(</span><span class="ident" id="4315494">l</span><span class="op" id="4315495">,</span>&nbsp;<span class="ident" id="4315497">config</span><span class="op" id="4315503">)</span><span class="op" id="4315504">,</span>&nbsp;<span class="builtintype" id="4315506">nil</span><br>
<span class="lineno"></span><span class="op" id="4315510">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="keyword" id="4315513">type</span>&nbsp;<span class="ident" id="4315518">timeoutError</span>&nbsp;<span class="keyword" id="4315531">struct</span><span class="op" id="4315537">{</span><span class="op" id="4315538">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4315541">func</span>&nbsp;<span class="op" id="4315546">(</span><span class="ident" id="4315547">timeoutError</span><span class="op" id="4315559">)</span>&nbsp;<span class="ident" id="4315561">Error</span><span class="op" id="4315566">(</span><span class="op" id="4315567">)</span>&nbsp;<span class="builtintype" id="4315569">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4315578">{</span>&nbsp;<span class="keyword" id="4315580">return</span>&nbsp;<span class="string" id="4315587">&#34;tls:&nbsp;DialWithDialer&nbsp;timed&nbsp;out&#34;</span>&nbsp;<span class="op" id="4315619">}</span><br>
<span class="lineno"></span><span class="keyword" id="4315621">func</span>&nbsp;<span class="op" id="4315626">(</span><span class="ident" id="4315627">timeoutError</span><span class="op" id="4315639">)</span>&nbsp;<span class="ident" id="4315641">Timeout</span><span class="op" id="4315648">(</span><span class="op" id="4315649">)</span>&nbsp;<span class="builtintype" id="4315651">bool</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4315658">{</span>&nbsp;<span class="keyword" id="4315660">return</span>&nbsp;<span class="builtintype" id="4315667">true</span>&nbsp;<span class="op" id="4315672">}</span><br>
<span class="lineno"></span><span class="keyword" id="4315674">func</span>&nbsp;<span class="op" id="4315679">(</span><span class="ident" id="4315680">timeoutError</span><span class="op" id="4315692">)</span>&nbsp;<span class="ident" id="4315694">Temporary</span><span class="op" id="4315703">(</span><span class="op" id="4315704">)</span>&nbsp;<span class="builtintype" id="4315706">bool</span>&nbsp;<span class="op" id="4315711">{</span>&nbsp;<span class="keyword" id="4315713">return</span>&nbsp;<span class="builtintype" id="4315720">true</span>&nbsp;<span class="op" id="4315725">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="comment" id="4315728">//&nbsp;DialWithDialer&nbsp;connects&nbsp;to&nbsp;the&nbsp;given&nbsp;network&nbsp;address&nbsp;using&nbsp;dialer.Dial&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4315806">//&nbsp;then&nbsp;initiates&nbsp;a&nbsp;TLS&nbsp;handshake,&nbsp;returning&nbsp;the&nbsp;resulting&nbsp;TLS&nbsp;connection.&nbsp;Any</span><br>
<span class="lineno"></span><span class="comment" id="4315885">//&nbsp;timeout&nbsp;or&nbsp;deadline&nbsp;given&nbsp;in&nbsp;the&nbsp;dialer&nbsp;apply&nbsp;to&nbsp;connection&nbsp;and&nbsp;TLS</span><br>
<span class="lineno"></span><span class="comment" id="4315956">//&nbsp;handshake&nbsp;as&nbsp;a&nbsp;whole.</span><br>
<span class="lineno">90</span><span class="comment" id="4315981">//</span><br>
<span class="lineno"></span><span class="comment" id="4315984">//&nbsp;DialWithDialer&nbsp;interprets&nbsp;a&nbsp;nil&nbsp;configuration&nbsp;as&nbsp;equivalent&nbsp;to&nbsp;the&nbsp;zero</span><br>
<span class="lineno"></span><span class="comment" id="4316059">//&nbsp;configuration;&nbsp;see&nbsp;the&nbsp;documentation&nbsp;of&nbsp;Config&nbsp;for&nbsp;the&nbsp;defaults.</span><br>
<span class="lineno"></span><span class="keyword" id="4316127">func</span>&nbsp;<span class="ident" id="4316132">DialWithDialer</span><span class="op" id="4316146">(</span><span class="ident" id="4316147">dialer</span>&nbsp;<span class="op" id="4316154">*</span><span class="ident" id="4316155">net</span><span class="op" id="4316158">.</span><span class="ident" id="4316159">Dialer</span><span class="op" id="4316165">,</span>&nbsp;<span class="ident" id="4316167">network</span><span class="op" id="4316174">,</span>&nbsp;<span class="ident" id="4316176">addr</span>&nbsp;<span class="builtintype" id="4316181">string</span><span class="op" id="4316187">,</span>&nbsp;<span class="ident" id="4316189">config</span>&nbsp;<span class="op" id="4316196">*</span><span class="ident" id="4316197">Config</span><span class="op" id="4316203">)</span>&nbsp;<span class="op" id="4316205">(</span><span class="op" id="4316206">*</span><span class="ident" id="4316207">Conn</span><span class="op" id="4316211">,</span>&nbsp;<span class="builtintype" id="4316213">error</span><span class="op" id="4316218">)</span>&nbsp;<span class="op" id="4316220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4316223">//&nbsp;We&nbsp;want&nbsp;the&nbsp;Timeout&nbsp;and&nbsp;Deadline&nbsp;values&nbsp;from&nbsp;dialer&nbsp;to&nbsp;cover&nbsp;the</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4316292">//&nbsp;whole&nbsp;process:&nbsp;TCP&nbsp;connection&nbsp;and&nbsp;TLS&nbsp;handshake.&nbsp;This&nbsp;means&nbsp;that&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4316364">//&nbsp;also&nbsp;need&nbsp;to&nbsp;start&nbsp;our&nbsp;own&nbsp;timers&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4316407">timeout</span>&nbsp;<span class="op" id="4316415">:=</span>&nbsp;<span class="ident" id="4316418">dialer</span><span class="op" id="4316424">.</span><span class="ident" id="4316425">Timeout</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4316435">if</span>&nbsp;<span class="op" id="4316438">!</span><span class="ident" id="4316439">dialer</span><span class="op" id="4316445">.</span><span class="ident" id="4316446">Deadline</span><span class="op" id="4316454">.</span><span class="ident" id="4316455">IsZero</span><span class="op" id="4316461">(</span><span class="op" id="4316462">)</span>&nbsp;<span class="op" id="4316464">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4316468">deadlineTimeout</span>&nbsp;<span class="op" id="4316484">:=</span>&nbsp;<span class="ident" id="4316487">dialer</span><span class="op" id="4316493">.</span><span class="ident" id="4316494">Deadline</span><span class="op" id="4316502">.</span><span class="ident" id="4316503">Sub</span><span class="op" id="4316506">(</span><span class="ident" id="4316507">time</span><span class="op" id="4316511">.</span><span class="ident" id="4316512">Now</span><span class="op" id="4316515">(</span><span class="op" id="4316516">)</span><span class="op" id="4316517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4316521">if</span>&nbsp;<span class="ident" id="4316524">timeout</span>&nbsp;<span class="op" id="4316532">==</span>&nbsp;<span class="num" id="4316535">0</span>&nbsp;<span class="op" id="4316537">||</span>&nbsp;<span class="ident" id="4316540">deadlineTimeout</span>&nbsp;<span class="op" id="4316556">&lt;</span>&nbsp;<span class="ident" id="4316558">timeout</span>&nbsp;<span class="op" id="4316566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4316571">timeout</span>&nbsp;<span class="op" id="4316579">=</span>&nbsp;<span class="ident" id="4316581">deadlineTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4316599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4316602">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4316606">var</span>&nbsp;<span class="ident" id="4316610">errChannel</span>&nbsp;<span class="keyword" id="4316621">chan</span>&nbsp;<span class="builtintype" id="4316626">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4316634">if</span>&nbsp;<span class="ident" id="4316637">timeout</span>&nbsp;<span class="op" id="4316645">!=</span>&nbsp;<span class="num" id="4316648">0</span>&nbsp;<span class="op" id="4316650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4316654">errChannel</span>&nbsp;<span class="op" id="4316665">=</span>&nbsp;<span class="builtinfunc" id="4316667">make</span><span class="op" id="4316671">(</span><span class="keyword" id="4316672">chan</span>&nbsp;<span class="builtintype" id="4316677">error</span><span class="op" id="4316682">,</span>&nbsp;<span class="num" id="4316684">2</span><span class="op" id="4316685">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4316689">time</span><span class="op" id="4316693">.</span><span class="ident" id="4316694">AfterFunc</span><span class="op" id="4316703">(</span><span class="ident" id="4316704">timeout</span><span class="op" id="4316711">,</span>&nbsp;<span class="keyword" id="4316713">func</span><span class="op" id="4316717">(</span><span class="op" id="4316718">)</span>&nbsp;<span class="op" id="4316720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4316725">errChannel</span>&nbsp;<span class="op" id="4316736">&lt;-</span>&nbsp;<span class="ident" id="4316739">timeoutError</span><span class="op" id="4316751">{</span><span class="op" id="4316752">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4316756">}</span><span class="op" id="4316757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4316760">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4316764">rawConn</span><span class="op" id="4316771">,</span>&nbsp;<span class="ident" id="4316773">err</span>&nbsp;<span class="op" id="4316777">:=</span>&nbsp;<span class="ident" id="4316780">dialer</span><span class="op" id="4316786">.</span><span class="ident" id="4316787">Dial</span><span class="op" id="4316791">(</span><span class="ident" id="4316792">network</span><span class="op" id="4316799">,</span>&nbsp;<span class="ident" id="4316801">addr</span><span class="op" id="4316805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4316808">if</span>&nbsp;<span class="ident" id="4316811">err</span>&nbsp;<span class="op" id="4316815">!=</span>&nbsp;<span class="builtintype" id="4316818">nil</span>&nbsp;<span class="op" id="4316822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4316826">return</span>&nbsp;<span class="builtintype" id="4316833">nil</span><span class="op" id="4316836">,</span>&nbsp;<span class="ident" id="4316838">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4316843">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4316847">colonPos</span>&nbsp;<span class="op" id="4316856">:=</span>&nbsp;<span class="ident" id="4316859">strings</span><span class="op" id="4316866">.</span><span class="ident" id="4316867">LastIndex</span><span class="op" id="4316876">(</span><span class="ident" id="4316877">addr</span><span class="op" id="4316881">,</span>&nbsp;<span class="string" id="4316883">&#34;:&#34;</span><span class="op" id="4316886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4316889">if</span>&nbsp;<span class="ident" id="4316892">colonPos</span>&nbsp;<span class="op" id="4316901">==</span>&nbsp;<span class="op" id="4316904">-</span><span class="num" id="4316905">1</span>&nbsp;<span class="op" id="4316907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4316911">colonPos</span>&nbsp;<span class="op" id="4316920">=</span>&nbsp;<span class="builtinfunc" id="4316922">len</span><span class="op" id="4316925">(</span><span class="ident" id="4316926">addr</span><span class="op" id="4316930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4316933">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4316936">hostname</span>&nbsp;<span class="op" id="4316945">:=</span>&nbsp;<span class="ident" id="4316948">addr</span><span class="op" id="4316952">[</span><span class="op" id="4316953">:</span><span class="ident" id="4316954">colonPos</span><span class="op" id="4316962">]</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4316966">if</span>&nbsp;<span class="ident" id="4316969">config</span>&nbsp;<span class="op" id="4316976">==</span>&nbsp;<span class="builtintype" id="4316979">nil</span>&nbsp;<span class="op" id="4316983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4316987">config</span>&nbsp;<span class="op" id="4316994">=</span>&nbsp;<span class="ident" id="4316996">defaultConfig</span><span class="op" id="4317009">(</span><span class="op" id="4317010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4317013">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4317016">//&nbsp;If&nbsp;no&nbsp;ServerName&nbsp;is&nbsp;set,&nbsp;infer&nbsp;the&nbsp;ServerName</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4317066">//&nbsp;from&nbsp;the&nbsp;hostname&nbsp;we&#39;re&nbsp;connecting&nbsp;to.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4317109">if</span>&nbsp;<span class="ident" id="4317112">config</span><span class="op" id="4317118">.</span><span class="ident" id="4317119">ServerName</span>&nbsp;<span class="op" id="4317130">==</span>&nbsp;<span class="string" id="4317133">&#34;&#34;</span>&nbsp;<span class="op" id="4317136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4317140">//&nbsp;Make&nbsp;a&nbsp;copy&nbsp;to&nbsp;avoid&nbsp;polluting&nbsp;argument&nbsp;or&nbsp;default.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4317197">c</span>&nbsp;<span class="op" id="4317199">:=</span>&nbsp;<span class="op" id="4317202">*</span><span class="ident" id="4317203">config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4317212">c</span><span class="op" id="4317213">.</span><span class="ident" id="4317214">ServerName</span>&nbsp;<span class="op" id="4317225">=</span>&nbsp;<span class="ident" id="4317227">hostname</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4317238">config</span>&nbsp;<span class="op" id="4317245">=</span>&nbsp;<span class="op" id="4317247">&amp;</span><span class="ident" id="4317248">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4317251">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4317255">conn</span>&nbsp;<span class="op" id="4317260">:=</span>&nbsp;<span class="ident" id="4317263">Client</span><span class="op" id="4317269">(</span><span class="ident" id="4317270">rawConn</span><span class="op" id="4317277">,</span>&nbsp;<span class="ident" id="4317279">config</span><span class="op" id="4317285">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4317289">if</span>&nbsp;<span class="ident" id="4317292">timeout</span>&nbsp;<span class="op" id="4317300">==</span>&nbsp;<span class="num" id="4317303">0</span>&nbsp;<span class="op" id="4317305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4317309">err</span>&nbsp;<span class="op" id="4317313">=</span>&nbsp;<span class="ident" id="4317315">conn</span><span class="op" id="4317319">.</span><span class="ident" id="4317320">Handshake</span><span class="op" id="4317329">(</span><span class="op" id="4317330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4317333">}</span>&nbsp;<span class="keyword" id="4317335">else</span>&nbsp;<span class="op" id="4317340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4317344">go</span>&nbsp;<span class="keyword" id="4317347">func</span><span class="op" id="4317351">(</span><span class="op" id="4317352">)</span>&nbsp;<span class="op" id="4317354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4317359">errChannel</span>&nbsp;<span class="op" id="4317370">&lt;-</span>&nbsp;<span class="ident" id="4317373">conn</span><span class="op" id="4317377">.</span><span class="ident" id="4317378">Handshake</span><span class="op" id="4317387">(</span><span class="op" id="4317388">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4317392">}</span><span class="op" id="4317393">(</span><span class="op" id="4317394">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4317399">err</span>&nbsp;<span class="op" id="4317403">=</span>&nbsp;<span class="op" id="4317405">&lt;-</span><span class="ident" id="4317407">errChannel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4317419">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4317423">if</span>&nbsp;<span class="ident" id="4317426">err</span>&nbsp;<span class="op" id="4317430">!=</span>&nbsp;<span class="builtintype" id="4317433">nil</span>&nbsp;<span class="op" id="4317437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4317441">rawConn</span><span class="op" id="4317448">.</span><span class="ident" id="4317449">Close</span><span class="op" id="4317454">(</span><span class="op" id="4317455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4317459">return</span>&nbsp;<span class="builtintype" id="4317466">nil</span><span class="op" id="4317469">,</span>&nbsp;<span class="ident" id="4317471">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4317476">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4317480">return</span>&nbsp;<span class="ident" id="4317487">conn</span><span class="op" id="4317491">,</span>&nbsp;<span class="builtintype" id="4317493">nil</span><br>
<span class="lineno"></span><span class="op" id="4317497">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4317500">//&nbsp;Dial&nbsp;connects&nbsp;to&nbsp;the&nbsp;given&nbsp;network&nbsp;address&nbsp;using&nbsp;net.Dial</span><br>
<span class="lineno"></span><span class="comment" id="4317561">//&nbsp;and&nbsp;then&nbsp;initiates&nbsp;a&nbsp;TLS&nbsp;handshake,&nbsp;returning&nbsp;the&nbsp;resulting</span><br>
<span class="lineno">160</span><span class="comment" id="4317624">//&nbsp;TLS&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4317643">//&nbsp;Dial&nbsp;interprets&nbsp;a&nbsp;nil&nbsp;configuration&nbsp;as&nbsp;equivalent&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4317699">//&nbsp;the&nbsp;zero&nbsp;configuration;&nbsp;see&nbsp;the&nbsp;documentation&nbsp;of&nbsp;Config</span><br>
<span class="lineno"></span><span class="comment" id="4317758">//&nbsp;for&nbsp;the&nbsp;defaults.</span><br>
<span class="lineno"></span><span class="keyword" id="4317779">func</span>&nbsp;<span class="ident" id="4317784">Dial</span><span class="op" id="4317788">(</span><span class="ident" id="4317789">network</span><span class="op" id="4317796">,</span>&nbsp;<span class="ident" id="4317798">addr</span>&nbsp;<span class="builtintype" id="4317803">string</span><span class="op" id="4317809">,</span>&nbsp;<span class="ident" id="4317811">config</span>&nbsp;<span class="op" id="4317818">*</span><span class="ident" id="4317819">Config</span><span class="op" id="4317825">)</span>&nbsp;<span class="op" id="4317827">(</span><span class="op" id="4317828">*</span><span class="ident" id="4317829">Conn</span><span class="op" id="4317833">,</span>&nbsp;<span class="builtintype" id="4317835">error</span><span class="op" id="4317840">)</span>&nbsp;<span class="op" id="4317842">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4317845">return</span>&nbsp;<span class="ident" id="4317852">DialWithDialer</span><span class="op" id="4317866">(</span><span class="builtinfunc" id="4317867">new</span><span class="op" id="4317870">(</span><span class="ident" id="4317871">net</span><span class="op" id="4317874">.</span><span class="ident" id="4317875">Dialer</span><span class="op" id="4317881">)</span><span class="op" id="4317882">,</span>&nbsp;<span class="ident" id="4317884">network</span><span class="op" id="4317891">,</span>&nbsp;<span class="ident" id="4317893">addr</span><span class="op" id="4317897">,</span>&nbsp;<span class="ident" id="4317899">config</span><span class="op" id="4317905">)</span><br>
<span class="lineno"></span><span class="op" id="4317907">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4317910">//&nbsp;LoadX509KeyPair&nbsp;reads&nbsp;and&nbsp;parses&nbsp;a&nbsp;public/private&nbsp;key&nbsp;pair&nbsp;from&nbsp;a&nbsp;pair&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4317987">//&nbsp;files.&nbsp;The&nbsp;files&nbsp;must&nbsp;contain&nbsp;PEM&nbsp;encoded&nbsp;data.</span><br>
<span class="lineno">170</span><span class="keyword" id="4318038">func</span>&nbsp;<span class="ident" id="4318043">LoadX509KeyPair</span><span class="op" id="4318058">(</span><span class="ident" id="4318059">certFile</span><span class="op" id="4318067">,</span>&nbsp;<span class="ident" id="4318069">keyFile</span>&nbsp;<span class="builtintype" id="4318077">string</span><span class="op" id="4318083">)</span>&nbsp;<span class="op" id="4318085">(</span><span class="ident" id="4318086">cert</span>&nbsp;<span class="ident" id="4318091">Certificate</span><span class="op" id="4318102">,</span>&nbsp;<span class="ident" id="4318104">err</span>&nbsp;<span class="builtintype" id="4318108">error</span><span class="op" id="4318113">)</span>&nbsp;<span class="op" id="4318115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4318118">certPEMBlock</span><span class="op" id="4318130">,</span>&nbsp;<span class="ident" id="4318132">err</span>&nbsp;<span class="op" id="4318136">:=</span>&nbsp;<span class="ident" id="4318139">ioutil</span><span class="op" id="4318145">.</span><span class="ident" id="4318146">ReadFile</span><span class="op" id="4318154">(</span><span class="ident" id="4318155">certFile</span><span class="op" id="4318163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4318166">if</span>&nbsp;<span class="ident" id="4318169">err</span>&nbsp;<span class="op" id="4318173">!=</span>&nbsp;<span class="builtintype" id="4318176">nil</span>&nbsp;<span class="op" id="4318180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4318184">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4318192">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4318195">keyPEMBlock</span><span class="op" id="4318206">,</span>&nbsp;<span class="ident" id="4318208">err</span>&nbsp;<span class="op" id="4318212">:=</span>&nbsp;<span class="ident" id="4318215">ioutil</span><span class="op" id="4318221">.</span><span class="ident" id="4318222">ReadFile</span><span class="op" id="4318230">(</span><span class="ident" id="4318231">keyFile</span><span class="op" id="4318238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4318241">if</span>&nbsp;<span class="ident" id="4318244">err</span>&nbsp;<span class="op" id="4318248">!=</span>&nbsp;<span class="builtintype" id="4318251">nil</span>&nbsp;<span class="op" id="4318255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4318259">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4318267">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4318270">return</span>&nbsp;<span class="ident" id="4318277">X509KeyPair</span><span class="op" id="4318288">(</span><span class="ident" id="4318289">certPEMBlock</span><span class="op" id="4318301">,</span>&nbsp;<span class="ident" id="4318303">keyPEMBlock</span><span class="op" id="4318314">)</span><br>
<span class="lineno">180</span><span class="op" id="4318316">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4318319">//&nbsp;X509KeyPair&nbsp;parses&nbsp;a&nbsp;public/private&nbsp;key&nbsp;pair&nbsp;from&nbsp;a&nbsp;pair&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4318382">//&nbsp;PEM&nbsp;encoded&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="4318403">func</span>&nbsp;<span class="ident" id="4318408">X509KeyPair</span><span class="op" id="4318419">(</span><span class="ident" id="4318420">certPEMBlock</span><span class="op" id="4318432">,</span>&nbsp;<span class="ident" id="4318434">keyPEMBlock</span>&nbsp;<span class="op" id="4318446">[</span><span class="op" id="4318447">]</span><span class="builtintype" id="4318448">byte</span><span class="op" id="4318452">)</span>&nbsp;<span class="op" id="4318454">(</span><span class="ident" id="4318455">cert</span>&nbsp;<span class="ident" id="4318460">Certificate</span><span class="op" id="4318471">,</span>&nbsp;<span class="ident" id="4318473">err</span>&nbsp;<span class="builtintype" id="4318477">error</span><span class="op" id="4318482">)</span>&nbsp;<span class="op" id="4318484">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4318487">var</span>&nbsp;<span class="ident" id="4318491">certDERBlock</span>&nbsp;<span class="op" id="4318504">*</span><span class="ident" id="4318505">pem</span><span class="op" id="4318508">.</span><span class="ident" id="4318509">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4318516">for</span>&nbsp;<span class="op" id="4318520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4318524">certDERBlock</span><span class="op" id="4318536">,</span>&nbsp;<span class="ident" id="4318538">certPEMBlock</span>&nbsp;<span class="op" id="4318551">=</span>&nbsp;<span class="ident" id="4318553">pem</span><span class="op" id="4318556">.</span><span class="ident" id="4318557">Decode</span><span class="op" id="4318563">(</span><span class="ident" id="4318564">certPEMBlock</span><span class="op" id="4318576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4318580">if</span>&nbsp;<span class="ident" id="4318583">certDERBlock</span>&nbsp;<span class="op" id="4318596">==</span>&nbsp;<span class="builtintype" id="4318599">nil</span>&nbsp;<span class="op" id="4318603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4318608">break</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4318616">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4318620">if</span>&nbsp;<span class="ident" id="4318623">certDERBlock</span><span class="op" id="4318635">.</span><span class="ident" id="4318636">Type</span>&nbsp;<span class="op" id="4318641">==</span>&nbsp;<span class="string" id="4318644">&#34;CERTIFICATE&#34;</span>&nbsp;<span class="op" id="4318658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4318663">cert</span><span class="op" id="4318667">.</span><span class="ident" id="4318668">Certificate</span>&nbsp;<span class="op" id="4318680">=</span>&nbsp;<span class="builtinfunc" id="4318682">append</span><span class="op" id="4318688">(</span><span class="ident" id="4318689">cert</span><span class="op" id="4318693">.</span><span class="ident" id="4318694">Certificate</span><span class="op" id="4318705">,</span>&nbsp;<span class="ident" id="4318707">certDERBlock</span><span class="op" id="4318719">.</span><span class="ident" id="4318720">Bytes</span><span class="op" id="4318725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4318729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4318732">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4318736">if</span>&nbsp;<span class="builtinfunc" id="4318739">len</span><span class="op" id="4318742">(</span><span class="ident" id="4318743">cert</span><span class="op" id="4318747">.</span><span class="ident" id="4318748">Certificate</span><span class="op" id="4318759">)</span>&nbsp;<span class="op" id="4318761">==</span>&nbsp;<span class="num" id="4318764">0</span>&nbsp;<span class="op" id="4318766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4318770">err</span>&nbsp;<span class="op" id="4318774">=</span>&nbsp;<span class="ident" id="4318776">errors</span><span class="op" id="4318782">.</span><span class="ident" id="4318783">New</span><span class="op" id="4318786">(</span><span class="string" id="4318787">&#34;crypto/tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;certificate&nbsp;PEM&nbsp;data&#34;</span><span class="op" id="4318837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4318841">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4318849">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4318853">var</span>&nbsp;<span class="ident" id="4318857">keyDERBlock</span>&nbsp;<span class="op" id="4318869">*</span><span class="ident" id="4318870">pem</span><span class="op" id="4318873">.</span><span class="ident" id="4318874">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4318881">for</span>&nbsp;<span class="op" id="4318885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4318889">keyDERBlock</span><span class="op" id="4318900">,</span>&nbsp;<span class="ident" id="4318902">keyPEMBlock</span>&nbsp;<span class="op" id="4318914">=</span>&nbsp;<span class="ident" id="4318916">pem</span><span class="op" id="4318919">.</span><span class="ident" id="4318920">Decode</span><span class="op" id="4318926">(</span><span class="ident" id="4318927">keyPEMBlock</span><span class="op" id="4318938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4318942">if</span>&nbsp;<span class="ident" id="4318945">keyDERBlock</span>&nbsp;<span class="op" id="4318957">==</span>&nbsp;<span class="builtintype" id="4318960">nil</span>&nbsp;<span class="op" id="4318964">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4318969">err</span>&nbsp;<span class="op" id="4318973">=</span>&nbsp;<span class="ident" id="4318975">errors</span><span class="op" id="4318981">.</span><span class="ident" id="4318982">New</span><span class="op" id="4318985">(</span><span class="string" id="4318986">&#34;crypto/tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;key&nbsp;PEM&nbsp;data&#34;</span><span class="op" id="4319028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4319033">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4319042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4319046">if</span>&nbsp;<span class="ident" id="4319049">keyDERBlock</span><span class="op" id="4319060">.</span><span class="ident" id="4319061">Type</span>&nbsp;<span class="op" id="4319066">==</span>&nbsp;<span class="string" id="4319069">&#34;PRIVATE&nbsp;KEY&#34;</span>&nbsp;<span class="op" id="4319083">||</span>&nbsp;<span class="ident" id="4319086">strings</span><span class="op" id="4319093">.</span><span class="ident" id="4319094">HasSuffix</span><span class="op" id="4319103">(</span><span class="ident" id="4319104">keyDERBlock</span><span class="op" id="4319115">.</span><span class="ident" id="4319116">Type</span><span class="op" id="4319120">,</span>&nbsp;<span class="string" id="4319122">&#34;&nbsp;PRIVATE&nbsp;KEY&#34;</span><span class="op" id="4319136">)</span>&nbsp;<span class="op" id="4319138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4319143">break</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4319151">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4319154">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4319158">cert</span><span class="op" id="4319162">.</span><span class="ident" id="4319163">PrivateKey</span><span class="op" id="4319173">,</span>&nbsp;<span class="ident" id="4319175">err</span>&nbsp;<span class="op" id="4319179">=</span>&nbsp;<span class="ident" id="4319181">parsePrivateKey</span><span class="op" id="4319196">(</span><span class="ident" id="4319197">keyDERBlock</span><span class="op" id="4319208">.</span><span class="ident" id="4319209">Bytes</span><span class="op" id="4319214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4319217">if</span>&nbsp;<span class="ident" id="4319220">err</span>&nbsp;<span class="op" id="4319224">!=</span>&nbsp;<span class="builtintype" id="4319227">nil</span>&nbsp;<span class="op" id="4319231">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4319235">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4319243">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4319247">//&nbsp;We&nbsp;don&#39;t&nbsp;need&nbsp;to&nbsp;parse&nbsp;the&nbsp;public&nbsp;key&nbsp;for&nbsp;TLS,&nbsp;but&nbsp;we&nbsp;so&nbsp;do&nbsp;anyway</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4319318">//&nbsp;to&nbsp;check&nbsp;that&nbsp;it&nbsp;looks&nbsp;sane&nbsp;and&nbsp;matches&nbsp;the&nbsp;private&nbsp;key.</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4319379">x509Cert</span><span class="op" id="4319387">,</span>&nbsp;<span class="ident" id="4319389">err</span>&nbsp;<span class="op" id="4319393">:=</span>&nbsp;<span class="ident" id="4319396">x509</span><span class="op" id="4319400">.</span><span class="ident" id="4319401">ParseCertificate</span><span class="op" id="4319417">(</span><span class="ident" id="4319418">cert</span><span class="op" id="4319422">.</span><span class="ident" id="4319423">Certificate</span><span class="op" id="4319434">[</span><span class="num" id="4319435">0</span><span class="op" id="4319436">]</span><span class="op" id="4319437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4319440">if</span>&nbsp;<span class="ident" id="4319443">err</span>&nbsp;<span class="op" id="4319447">!=</span>&nbsp;<span class="builtintype" id="4319450">nil</span>&nbsp;<span class="op" id="4319454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4319458">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4319466">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4319470">switch</span>&nbsp;<span class="ident" id="4319477">pub</span>&nbsp;<span class="op" id="4319481">:=</span>&nbsp;<span class="ident" id="4319484">x509Cert</span><span class="op" id="4319492">.</span><span class="ident" id="4319493">PublicKey</span><span class="op" id="4319502">.</span><span class="op" id="4319503">(</span><span class="keyword" id="4319504">type</span><span class="op" id="4319508">)</span>&nbsp;<span class="op" id="4319510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4319513">case</span>&nbsp;<span class="op" id="4319518">*</span><span class="ident" id="4319519">rsa</span><span class="op" id="4319522">.</span><span class="ident" id="4319523">PublicKey</span><span class="op" id="4319532">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4319536">priv</span><span class="op" id="4319540">,</span>&nbsp;<span class="ident" id="4319542">ok</span>&nbsp;<span class="op" id="4319545">:=</span>&nbsp;<span class="ident" id="4319548">cert</span><span class="op" id="4319552">.</span><span class="ident" id="4319553">PrivateKey</span><span class="op" id="4319563">.</span><span class="op" id="4319564">(</span><span class="op" id="4319565">*</span><span class="ident" id="4319566">rsa</span><span class="op" id="4319569">.</span><span class="ident" id="4319570">PrivateKey</span><span class="op" id="4319580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4319584">if</span>&nbsp;<span class="op" id="4319587">!</span><span class="ident" id="4319588">ok</span>&nbsp;<span class="op" id="4319591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4319596">err</span>&nbsp;<span class="op" id="4319600">=</span>&nbsp;<span class="ident" id="4319602">errors</span><span class="op" id="4319608">.</span><span class="ident" id="4319609">New</span><span class="op" id="4319612">(</span><span class="string" id="4319613">&#34;crypto/tls:&nbsp;private&nbsp;key&nbsp;type&nbsp;does&nbsp;not&nbsp;match&nbsp;public&nbsp;key&nbsp;type&#34;</span><span class="op" id="4319674">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4319679">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4319688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4319692">if</span>&nbsp;<span class="ident" id="4319695">pub</span><span class="op" id="4319698">.</span><span class="ident" id="4319699">N</span><span class="op" id="4319700">.</span><span class="ident" id="4319701">Cmp</span><span class="op" id="4319704">(</span><span class="ident" id="4319705">priv</span><span class="op" id="4319709">.</span><span class="ident" id="4319710">N</span><span class="op" id="4319711">)</span>&nbsp;<span class="op" id="4319713">!=</span>&nbsp;<span class="num" id="4319716">0</span>&nbsp;<span class="op" id="4319718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4319723">err</span>&nbsp;<span class="op" id="4319727">=</span>&nbsp;<span class="ident" id="4319729">errors</span><span class="op" id="4319735">.</span><span class="ident" id="4319736">New</span><span class="op" id="4319739">(</span><span class="string" id="4319740">&#34;crypto/tls:&nbsp;private&nbsp;key&nbsp;does&nbsp;not&nbsp;match&nbsp;public&nbsp;key&#34;</span><span class="op" id="4319791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4319796">return</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4319805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4319808">case</span>&nbsp;<span class="op" id="4319813">*</span><span class="ident" id="4319814">ecdsa</span><span class="op" id="4319819">.</span><span class="ident" id="4319820">PublicKey</span><span class="op" id="4319829">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4319833">priv</span><span class="op" id="4319837">,</span>&nbsp;<span class="ident" id="4319839">ok</span>&nbsp;<span class="op" id="4319842">:=</span>&nbsp;<span class="ident" id="4319845">cert</span><span class="op" id="4319849">.</span><span class="ident" id="4319850">PrivateKey</span><span class="op" id="4319860">.</span><span class="op" id="4319861">(</span><span class="op" id="4319862">*</span><span class="ident" id="4319863">ecdsa</span><span class="op" id="4319868">.</span><span class="ident" id="4319869">PrivateKey</span><span class="op" id="4319879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4319883">if</span>&nbsp;<span class="op" id="4319886">!</span><span class="ident" id="4319887">ok</span>&nbsp;<span class="op" id="4319890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4319895">err</span>&nbsp;<span class="op" id="4319899">=</span>&nbsp;<span class="ident" id="4319901">errors</span><span class="op" id="4319907">.</span><span class="ident" id="4319908">New</span><span class="op" id="4319911">(</span><span class="string" id="4319912">&#34;crypto/tls:&nbsp;private&nbsp;key&nbsp;type&nbsp;does&nbsp;not&nbsp;match&nbsp;public&nbsp;key&nbsp;type&#34;</span><span class="op" id="4319973">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4319978">return</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4319988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4319992">if</span>&nbsp;<span class="ident" id="4319995">pub</span><span class="op" id="4319998">.</span><span class="ident" id="4319999">X</span><span class="op" id="4320000">.</span><span class="ident" id="4320001">Cmp</span><span class="op" id="4320004">(</span><span class="ident" id="4320005">priv</span><span class="op" id="4320009">.</span><span class="ident" id="4320010">X</span><span class="op" id="4320011">)</span>&nbsp;<span class="op" id="4320013">!=</span>&nbsp;<span class="num" id="4320016">0</span>&nbsp;<span class="op" id="4320018">||</span>&nbsp;<span class="ident" id="4320021">pub</span><span class="op" id="4320024">.</span><span class="ident" id="4320025">Y</span><span class="op" id="4320026">.</span><span class="ident" id="4320027">Cmp</span><span class="op" id="4320030">(</span><span class="ident" id="4320031">priv</span><span class="op" id="4320035">.</span><span class="ident" id="4320036">Y</span><span class="op" id="4320037">)</span>&nbsp;<span class="op" id="4320039">!=</span>&nbsp;<span class="num" id="4320042">0</span>&nbsp;<span class="op" id="4320044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4320049">err</span>&nbsp;<span class="op" id="4320053">=</span>&nbsp;<span class="ident" id="4320055">errors</span><span class="op" id="4320061">.</span><span class="ident" id="4320062">New</span><span class="op" id="4320065">(</span><span class="string" id="4320066">&#34;crypto/tls:&nbsp;private&nbsp;key&nbsp;does&nbsp;not&nbsp;match&nbsp;public&nbsp;key&#34;</span><span class="op" id="4320117">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4320122">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4320131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4320134">default</span><span class="op" id="4320141">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4320145">err</span>&nbsp;<span class="op" id="4320149">=</span>&nbsp;<span class="ident" id="4320151">errors</span><span class="op" id="4320157">.</span><span class="ident" id="4320158">New</span><span class="op" id="4320161">(</span><span class="string" id="4320162">&#34;crypto/tls:&nbsp;unknown&nbsp;public&nbsp;key&nbsp;algorithm&#34;</span><span class="op" id="4320204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4320208">return</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4320216">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4320220">return</span><br>
<span class="lineno"></span><span class="op" id="4320227">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="comment" id="4320230">//&nbsp;Attempt&nbsp;to&nbsp;parse&nbsp;the&nbsp;given&nbsp;private&nbsp;key&nbsp;DER&nbsp;block.&nbsp;OpenSSL&nbsp;0.9.8&nbsp;generates</span><br>
<span class="lineno"></span><span class="comment" id="4320307">//&nbsp;PKCS#1&nbsp;private&nbsp;keys&nbsp;by&nbsp;default,&nbsp;while&nbsp;OpenSSL&nbsp;1.0.0&nbsp;generates&nbsp;PKCS#8&nbsp;keys.</span><br>
<span class="lineno"></span><span class="comment" id="4320385">//&nbsp;OpenSSL&nbsp;ecparam&nbsp;generates&nbsp;SEC1&nbsp;EC&nbsp;private&nbsp;keys&nbsp;for&nbsp;ECDSA.&nbsp;We&nbsp;try&nbsp;all&nbsp;three.</span><br>
<span class="lineno"></span><span class="keyword" id="4320464">func</span>&nbsp;<span class="ident" id="4320469">parsePrivateKey</span><span class="op" id="4320484">(</span><span class="ident" id="4320485">der</span>&nbsp;<span class="op" id="4320489">[</span><span class="op" id="4320490">]</span><span class="builtintype" id="4320491">byte</span><span class="op" id="4320495">)</span>&nbsp;<span class="op" id="4320497">(</span><span class="ident" id="4320498">crypto</span><span class="op" id="4320504">.</span><span class="ident" id="4320505">PrivateKey</span><span class="op" id="4320515">,</span>&nbsp;<span class="builtintype" id="4320517">error</span><span class="op" id="4320522">)</span>&nbsp;<span class="op" id="4320524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4320527">if</span>&nbsp;<span class="ident" id="4320530">key</span><span class="op" id="4320533">,</span>&nbsp;<span class="ident" id="4320535">err</span>&nbsp;<span class="op" id="4320539">:=</span>&nbsp;<span class="ident" id="4320542">x509</span><span class="op" id="4320546">.</span><span class="ident" id="4320547">ParsePKCS1PrivateKey</span><span class="op" id="4320567">(</span><span class="ident" id="4320568">der</span><span class="op" id="4320571">)</span><span class="op" id="4320572">;</span>&nbsp;<span class="ident" id="4320574">err</span>&nbsp;<span class="op" id="4320578">==</span>&nbsp;<span class="builtintype" id="4320581">nil</span>&nbsp;<span class="op" id="4320585">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4320589">return</span>&nbsp;<span class="ident" id="4320596">key</span><span class="op" id="4320599">,</span>&nbsp;<span class="builtintype" id="4320601">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4320606">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4320609">if</span>&nbsp;<span class="ident" id="4320612">key</span><span class="op" id="4320615">,</span>&nbsp;<span class="ident" id="4320617">err</span>&nbsp;<span class="op" id="4320621">:=</span>&nbsp;<span class="ident" id="4320624">x509</span><span class="op" id="4320628">.</span><span class="ident" id="4320629">ParsePKCS8PrivateKey</span><span class="op" id="4320649">(</span><span class="ident" id="4320650">der</span><span class="op" id="4320653">)</span><span class="op" id="4320654">;</span>&nbsp;<span class="ident" id="4320656">err</span>&nbsp;<span class="op" id="4320660">==</span>&nbsp;<span class="builtintype" id="4320663">nil</span>&nbsp;<span class="op" id="4320667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4320671">switch</span>&nbsp;<span class="ident" id="4320678">key</span>&nbsp;<span class="op" id="4320682">:=</span>&nbsp;<span class="ident" id="4320685">key</span><span class="op" id="4320688">.</span><span class="op" id="4320689">(</span><span class="keyword" id="4320690">type</span><span class="op" id="4320694">)</span>&nbsp;<span class="op" id="4320696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4320700">case</span>&nbsp;<span class="op" id="4320705">*</span><span class="ident" id="4320706">rsa</span><span class="op" id="4320709">.</span><span class="ident" id="4320710">PrivateKey</span><span class="op" id="4320720">,</span>&nbsp;<span class="op" id="4320722">*</span><span class="ident" id="4320723">ecdsa</span><span class="op" id="4320728">.</span><span class="ident" id="4320729">PrivateKey</span><span class="op" id="4320739">:</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4320744">return</span>&nbsp;<span class="ident" id="4320751">key</span><span class="op" id="4320754">,</span>&nbsp;<span class="builtintype" id="4320756">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4320762">default</span><span class="op" id="4320769">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4320774">return</span>&nbsp;<span class="builtintype" id="4320781">nil</span><span class="op" id="4320784">,</span>&nbsp;<span class="ident" id="4320786">errors</span><span class="op" id="4320792">.</span><span class="ident" id="4320793">New</span><span class="op" id="4320796">(</span><span class="string" id="4320797">&#34;crypto/tls:&nbsp;found&nbsp;unknown&nbsp;private&nbsp;key&nbsp;type&nbsp;in&nbsp;PKCS#8&nbsp;wrapping&#34;</span><span class="op" id="4320860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4320864">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4320867">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4320870">if</span>&nbsp;<span class="ident" id="4320873">key</span><span class="op" id="4320876">,</span>&nbsp;<span class="ident" id="4320878">err</span>&nbsp;<span class="op" id="4320882">:=</span>&nbsp;<span class="ident" id="4320885">x509</span><span class="op" id="4320889">.</span><span class="ident" id="4320890">ParseECPrivateKey</span><span class="op" id="4320907">(</span><span class="ident" id="4320908">der</span><span class="op" id="4320911">)</span><span class="op" id="4320912">;</span>&nbsp;<span class="ident" id="4320914">err</span>&nbsp;<span class="op" id="4320918">==</span>&nbsp;<span class="builtintype" id="4320921">nil</span>&nbsp;<span class="op" id="4320925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4320929">return</span>&nbsp;<span class="ident" id="4320936">key</span><span class="op" id="4320939">,</span>&nbsp;<span class="builtintype" id="4320941">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4320946">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4320950">return</span>&nbsp;<span class="builtintype" id="4320957">nil</span><span class="op" id="4320960">,</span>&nbsp;<span class="ident" id="4320962">errors</span><span class="op" id="4320968">.</span><span class="ident" id="4320969">New</span><span class="op" id="4320972">(</span><span class="string" id="4320973">&#34;crypto/tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;private&nbsp;key&#34;</span><span class="op" id="4321014">)</span><br>
<span class="lineno">275</span><span class="op" id="4321016">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
