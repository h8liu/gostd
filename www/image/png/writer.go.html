<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="4881329">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4881384">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4881438">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4881489">package</span>&nbsp;<span class="ident" id="4881497">png</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4881502">import</span>&nbsp;<span class="op" id="4881509">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4881512">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4881521">&#34;compress/zlib&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4881538">&#34;hash/crc32&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4881552">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4881561">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4881576">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4881582">&#34;strconv&#34;</span><br>
<span class="lineno">15</span><span class="op" id="4881592">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4881595">//&nbsp;Encoder&nbsp;configures&nbsp;encoding&nbsp;PNG&nbsp;images.</span><br>
<span class="lineno"></span><span class="keyword" id="4881638">type</span>&nbsp;<span class="ident" id="4881643">Encoder</span>&nbsp;<span class="keyword" id="4881651">struct</span>&nbsp;<span class="op" id="4881658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4881661">CompressionLevel</span>&nbsp;<span class="ident" id="4881678"><a href="/image/png/writer.go.html#4881863">CompressionLevel</a></span><br>
<span class="lineno">20</span><span class="op" id="4881695">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4881698">type</span>&nbsp;<span class="ident" id="4881703">encoder</span>&nbsp;<span class="keyword" id="4881711">struct</span>&nbsp;<span class="op" id="4881718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4881721">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4881728">*</span><span class="ident" id="4881729"><a href="/image/png/writer.go.html#4881643">Encoder</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4881738">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4881745"><a href="/image/png/writer.go.html#4881576">io</a></span><span class="op" id="4881747">.</span><span class="ident" id="4881748">Writer</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4881756">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4881763"><a href="/image/png/writer.go.html#4881552">image</a></span><span class="op" id="4881768">.</span><span class="ident" id="4881769">Image</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4881776">cb</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4881783">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4881788">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4881795">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4881802">header</span>&nbsp;<span class="op" id="4881809">[</span><span class="num" id="4881810">8</span><span class="op" id="4881811">]</span><span class="builtintype" id="4881812">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4881818">footer</span>&nbsp;<span class="op" id="4881825">[</span><span class="num" id="4881826">4</span><span class="op" id="4881827">]</span><span class="builtintype" id="4881828">byte</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4881834">tmp</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4881841">[</span><span class="num" id="4881842">4</span>&nbsp;<span class="op" id="4881844">*</span>&nbsp;<span class="num" id="4881846">256</span><span class="op" id="4881849">]</span><span class="builtintype" id="4881850">byte</span><br>
<span class="lineno"></span><span class="op" id="4881855">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4881858">type</span>&nbsp;<span class="ident" id="4881863">CompressionLevel</span>&nbsp;<span class="builtintype" id="4881880">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="4881885">const</span>&nbsp;<span class="op" id="4881891">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4881894">DefaultCompression</span>&nbsp;<span class="ident" id="4881913"><a href="/image/png/writer.go.html#4881863">CompressionLevel</a></span>&nbsp;<span class="op" id="4881930">=</span>&nbsp;<span class="num" id="4881932">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4881935">NoCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4881954"><a href="/image/png/writer.go.html#4881863">CompressionLevel</a></span>&nbsp;<span class="op" id="4881971">=</span>&nbsp;<span class="op" id="4881973">-</span><span class="num" id="4881974">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4881977">BestSpeed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4881996"><a href="/image/png/writer.go.html#4881863">CompressionLevel</a></span>&nbsp;<span class="op" id="4882013">=</span>&nbsp;<span class="op" id="4882015">-</span><span class="num" id="4882016">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4882019">BestCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4882038"><a href="/image/png/writer.go.html#4881863">CompressionLevel</a></span>&nbsp;<span class="op" id="4882055">=</span>&nbsp;<span class="op" id="4882057">-</span><span class="num" id="4882058">3</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4882062">//&nbsp;Positive&nbsp;CompressionLevel&nbsp;values&nbsp;are&nbsp;reserved&nbsp;to&nbsp;mean&nbsp;a&nbsp;numeric&nbsp;zlib</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4882135">//&nbsp;compression&nbsp;level,&nbsp;although&nbsp;that&nbsp;is&nbsp;not&nbsp;implemented&nbsp;yet.</span><br>
<span class="lineno"></span><span class="op" id="4882195">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="4882198">//&nbsp;Big-endian.</span><br>
<span class="lineno"></span><span class="keyword" id="4882213">func</span>&nbsp;<span class="ident" id="4882218">writeUint32</span><span class="op" id="4882229">(</span><span class="ident" id="4882230">b</span>&nbsp;<span class="op" id="4882232">[</span><span class="op" id="4882233">]</span><span class="builtintype" id="4882234">uint8</span><span class="op" id="4882239">,</span>&nbsp;<span class="ident" id="4882241">u</span>&nbsp;<span class="builtintype" id="4882243">uint32</span><span class="op" id="4882249">)</span>&nbsp;<span class="op" id="4882251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4882254"><a href="/image/png/writer.go.html#4882230">b</a></span><span class="op" id="4882255">[</span><span class="num" id="4882256">0</span><span class="op" id="4882257">]</span>&nbsp;<span class="op" id="4882259">=</span>&nbsp;<span class="builtintype" id="4882261">uint8</span><span class="op" id="4882266">(</span><span class="ident" id="4882267"><a href="/image/png/writer.go.html#4882241">u</a></span>&nbsp;<span class="op" id="4882269">&gt;&gt;</span>&nbsp;<span class="num" id="4882272">24</span><span class="op" id="4882274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4882277"><a href="/image/png/writer.go.html#4882230">b</a></span><span class="op" id="4882278">[</span><span class="num" id="4882279">1</span><span class="op" id="4882280">]</span>&nbsp;<span class="op" id="4882282">=</span>&nbsp;<span class="builtintype" id="4882284">uint8</span><span class="op" id="4882289">(</span><span class="ident" id="4882290"><a href="/image/png/writer.go.html#4882241">u</a></span>&nbsp;<span class="op" id="4882292">&gt;&gt;</span>&nbsp;<span class="num" id="4882295">16</span><span class="op" id="4882297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4882300"><a href="/image/png/writer.go.html#4882230">b</a></span><span class="op" id="4882301">[</span><span class="num" id="4882302">2</span><span class="op" id="4882303">]</span>&nbsp;<span class="op" id="4882305">=</span>&nbsp;<span class="builtintype" id="4882307">uint8</span><span class="op" id="4882312">(</span><span class="ident" id="4882313"><a href="/image/png/writer.go.html#4882241">u</a></span>&nbsp;<span class="op" id="4882315">&gt;&gt;</span>&nbsp;<span class="num" id="4882318">8</span><span class="op" id="4882319">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4882322"><a href="/image/png/writer.go.html#4882230">b</a></span><span class="op" id="4882323">[</span><span class="num" id="4882324">3</span><span class="op" id="4882325">]</span>&nbsp;<span class="op" id="4882327">=</span>&nbsp;<span class="builtintype" id="4882329">uint8</span><span class="op" id="4882334">(</span><span class="ident" id="4882335"><a href="/image/png/writer.go.html#4882241">u</a></span>&nbsp;<span class="op" id="4882337">&gt;&gt;</span>&nbsp;<span class="num" id="4882340">0</span><span class="op" id="4882341">)</span><br>
<span class="lineno"></span><span class="op" id="4882343">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4882346">type</span>&nbsp;<span class="ident" id="4882351">opaquer</span>&nbsp;<span class="keyword" id="4882359">interface</span>&nbsp;<span class="op" id="4882369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4882372">Opaque</span><span class="op" id="4882378">(</span><span class="op" id="4882379">)</span>&nbsp;<span class="builtintype" id="4882381">bool</span><br>
<span class="lineno">55</span><span class="op" id="4882386">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4882389">//&nbsp;Returns&nbsp;whether&nbsp;or&nbsp;not&nbsp;the&nbsp;image&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span><span class="keyword" id="4882442">func</span>&nbsp;<span class="ident" id="4882447">opaque</span><span class="op" id="4882453">(</span><span class="ident" id="4882454">m</span>&nbsp;<span class="ident" id="4882456"><a href="/image/png/writer.go.html#4881552">image</a></span><span class="op" id="4882461">.</span><span class="ident" id="4882462">Image</span><span class="op" id="4882467">)</span>&nbsp;<span class="builtintype" id="4882469">bool</span>&nbsp;<span class="op" id="4882474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4882477">if</span>&nbsp;<span class="ident" id="4882480">o</span><span class="op" id="4882481">,</span>&nbsp;<span class="ident" id="4882483">ok</span>&nbsp;<span class="op" id="4882486">:=</span>&nbsp;<span class="ident" id="4882489"><a href="/image/png/writer.go.html#4882454">m</a></span><span class="op" id="4882490">.</span><span class="op" id="4882491">(</span><span class="ident" id="4882492"><a href="/image/png/writer.go.html#4882351">opaquer</a></span><span class="op" id="4882499">)</span><span class="op" id="4882500">;</span>&nbsp;<span class="ident" id="4882502"><a href="/image/png/writer.go.html#4882483">ok</a></span>&nbsp;<span class="op" id="4882505">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4882509">return</span>&nbsp;<span class="ident" id="4882516"><a href="/image/png/writer.go.html#4882480">o</a></span><span class="op" id="4882517">.</span><span class="ident" id="4882518">Opaque</span><span class="op" id="4882524">(</span><span class="op" id="4882525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4882528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4882531">b</span>&nbsp;<span class="op" id="4882533">:=</span>&nbsp;<span class="ident" id="4882536"><a href="/image/png/writer.go.html#4882454">m</a></span><span class="op" id="4882537">.</span><span class="ident" id="4882538">Bounds</span><span class="op" id="4882544">(</span><span class="op" id="4882545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4882548">for</span>&nbsp;<span class="ident" id="4882552">y</span>&nbsp;<span class="op" id="4882554">:=</span>&nbsp;<span class="ident" id="4882557"><a href="/image/png/writer.go.html#4882531">b</a></span><span class="op" id="4882558">.</span><span class="ident" id="4882559">Min</span><span class="op" id="4882562">.</span><span class="ident" id="4882563">Y</span><span class="op" id="4882564">;</span>&nbsp;<span class="ident" id="4882566"><a href="/image/png/writer.go.html#4882552">y</a></span>&nbsp;<span class="op" id="4882568">&lt;</span>&nbsp;<span class="ident" id="4882570"><a href="/image/png/writer.go.html#4882531">b</a></span><span class="op" id="4882571">.</span><span class="ident" id="4882572">Max</span><span class="op" id="4882575">.</span><span class="ident" id="4882576">Y</span><span class="op" id="4882577">;</span>&nbsp;<span class="ident" id="4882579"><a href="/image/png/writer.go.html#4882552">y</a></span><span class="op" id="4882580">++</span>&nbsp;<span class="op" id="4882583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4882587">for</span>&nbsp;<span class="ident" id="4882591">x</span>&nbsp;<span class="op" id="4882593">:=</span>&nbsp;<span class="ident" id="4882596"><a href="/image/png/writer.go.html#4882531">b</a></span><span class="op" id="4882597">.</span><span class="ident" id="4882598">Min</span><span class="op" id="4882601">.</span><span class="ident" id="4882602">X</span><span class="op" id="4882603">;</span>&nbsp;<span class="ident" id="4882605"><a href="/image/png/writer.go.html#4882591">x</a></span>&nbsp;<span class="op" id="4882607">&lt;</span>&nbsp;<span class="ident" id="4882609"><a href="/image/png/writer.go.html#4882531">b</a></span><span class="op" id="4882610">.</span><span class="ident" id="4882611">Max</span><span class="op" id="4882614">.</span><span class="ident" id="4882615">X</span><span class="op" id="4882616">;</span>&nbsp;<span class="ident" id="4882618"><a href="/image/png/writer.go.html#4882591">x</a></span><span class="op" id="4882619">++</span>&nbsp;<span class="op" id="4882622">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4882627">_</span><span class="op" id="4882628">,</span>&nbsp;<span class="ident" id="4882630">_</span><span class="op" id="4882631">,</span>&nbsp;<span class="ident" id="4882633">_</span><span class="op" id="4882634">,</span>&nbsp;<span class="ident" id="4882636">a</span>&nbsp;<span class="op" id="4882638">:=</span>&nbsp;<span class="ident" id="4882641"><a href="/image/png/writer.go.html#4882454">m</a></span><span class="op" id="4882642">.</span><span class="ident" id="4882643">At</span><span class="op" id="4882645">(</span><span class="ident" id="4882646"><a href="/image/png/writer.go.html#4882591">x</a></span><span class="op" id="4882647">,</span>&nbsp;<span class="ident" id="4882649"><a href="/image/png/writer.go.html#4882552">y</a></span><span class="op" id="4882650">)</span><span class="op" id="4882651">.</span><span class="ident" id="4882652">RGBA</span><span class="op" id="4882656">(</span><span class="op" id="4882657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4882662">if</span>&nbsp;<span class="ident" id="4882665"><a href="/image/png/writer.go.html#4882636">a</a></span>&nbsp;<span class="op" id="4882667">!=</span>&nbsp;<span class="num" id="4882670">0xffff</span>&nbsp;<span class="op" id="4882677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4882683">return</span>&nbsp;<span class="builtintype" id="4882690">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4882699">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4882703">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4882706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4882709">return</span>&nbsp;<span class="builtintype" id="4882716">true</span><br>
<span class="lineno"></span><span class="op" id="4882721">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4882724">//&nbsp;The&nbsp;absolute&nbsp;value&nbsp;of&nbsp;a&nbsp;byte&nbsp;interpreted&nbsp;as&nbsp;a&nbsp;signed&nbsp;int8.</span><br>
<span class="lineno">75</span><span class="keyword" id="4882786">func</span>&nbsp;<span class="ident" id="4882791">abs8</span><span class="op" id="4882795">(</span><span class="ident" id="4882796">d</span>&nbsp;<span class="builtintype" id="4882798">uint8</span><span class="op" id="4882803">)</span>&nbsp;<span class="builtintype" id="4882805">int</span>&nbsp;<span class="op" id="4882809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4882812">if</span>&nbsp;<span class="ident" id="4882815"><a href="/image/png/writer.go.html#4882796">d</a></span>&nbsp;<span class="op" id="4882817">&lt;</span>&nbsp;<span class="num" id="4882819">128</span>&nbsp;<span class="op" id="4882823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4882827">return</span>&nbsp;<span class="builtintype" id="4882834">int</span><span class="op" id="4882837">(</span><span class="ident" id="4882838"><a href="/image/png/writer.go.html#4882796">d</a></span><span class="op" id="4882839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4882842">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4882845">return</span>&nbsp;<span class="num" id="4882852">256</span>&nbsp;<span class="op" id="4882856">-</span>&nbsp;<span class="builtintype" id="4882858">int</span><span class="op" id="4882861">(</span><span class="ident" id="4882862"><a href="/image/png/writer.go.html#4882796">d</a></span><span class="op" id="4882863">)</span><br>
<span class="lineno">80</span><span class="op" id="4882865">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4882868">func</span>&nbsp;<span class="op" id="4882873">(</span><span class="ident" id="4882874">e</span>&nbsp;<span class="op" id="4882876">*</span><span class="ident" id="4882877"><a href="/image/png/writer.go.html#4881703">encoder</a></span><span class="op" id="4882884">)</span>&nbsp;<span class="ident" id="4882886">writeChunk</span><span class="op" id="4882896">(</span><span class="ident" id="4882897">b</span>&nbsp;<span class="op" id="4882899">[</span><span class="op" id="4882900">]</span><span class="builtintype" id="4882901">byte</span><span class="op" id="4882905">,</span>&nbsp;<span class="ident" id="4882907">name</span>&nbsp;<span class="builtintype" id="4882912">string</span><span class="op" id="4882918">)</span>&nbsp;<span class="op" id="4882920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4882923">if</span>&nbsp;<span class="ident" id="4882926"><a href="/image/png/writer.go.html#4882874">e</a></span><span class="op" id="4882927">.</span><span class="ident" id="4882928">err</span>&nbsp;<span class="op" id="4882932">!=</span>&nbsp;<span class="ident" id="4882935">nil</span>&nbsp;<span class="op" id="4882939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4882943">return</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4882951">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4882954">n</span>&nbsp;<span class="op" id="4882956">:=</span>&nbsp;<span class="builtintype" id="4882959">uint32</span><span class="op" id="4882965">(</span><span class="builtinfunc" id="4882966">len</span><span class="op" id="4882969">(</span><span class="ident" id="4882970"><a href="/image/png/writer.go.html#4882897">b</a></span><span class="op" id="4882971">)</span><span class="op" id="4882972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4882975">if</span>&nbsp;<span class="builtintype" id="4882978">int</span><span class="op" id="4882981">(</span><span class="ident" id="4882982"><a href="/image/png/writer.go.html#4882954">n</a></span><span class="op" id="4882983">)</span>&nbsp;<span class="op" id="4882985">!=</span>&nbsp;<span class="builtinfunc" id="4882988">len</span><span class="op" id="4882991">(</span><span class="ident" id="4882992"><a href="/image/png/writer.go.html#4882897">b</a></span><span class="op" id="4882993">)</span>&nbsp;<span class="op" id="4882995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4882999"><a href="/image/png/writer.go.html#4882874">e</a></span><span class="op" id="4883000">.</span><span class="ident" id="4883001">err</span>&nbsp;<span class="op" id="4883005">=</span>&nbsp;<span class="ident" id="4883007"><a href="/image/png/reader.go.html#4863140">UnsupportedError</a></span><span class="op" id="4883023">(</span><span class="ident" id="4883024"><a href="/image/png/writer.go.html#4882907">name</a></span>&nbsp;<span class="op" id="4883029">+</span>&nbsp;<span class="string" id="4883031">&#34;&nbsp;chunk&nbsp;is&nbsp;too&nbsp;large:&nbsp;&#34;</span>&nbsp;<span class="op" id="4883055">+</span>&nbsp;<span class="ident" id="4883057"><a href="/image/png/writer.go.html#4881582">strconv</a></span><span class="op" id="4883064">.</span><span class="ident" id="4883065">Itoa</span><span class="op" id="4883069">(</span><span class="builtinfunc" id="4883070">len</span><span class="op" id="4883073">(</span><span class="ident" id="4883074"><a href="/image/png/writer.go.html#4882897">b</a></span><span class="op" id="4883075">)</span><span class="op" id="4883076">)</span><span class="op" id="4883077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4883081">return</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4883089">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4883092"><a href="/image/png/writer.go.html#4882218">writeUint32</a></span><span class="op" id="4883103">(</span><span class="ident" id="4883104"><a href="/image/png/writer.go.html#4882874">e</a></span><span class="op" id="4883105">.</span><span class="ident" id="4883106">header</span><span class="op" id="4883112">[</span><span class="op" id="4883113">:</span><span class="num" id="4883114">4</span><span class="op" id="4883115">]</span><span class="op" id="4883116">,</span>&nbsp;<span class="ident" id="4883118"><a href="/image/png/writer.go.html#4882954">n</a></span><span class="op" id="4883119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4883122"><a href="/image/png/writer.go.html#4882874">e</a></span><span class="op" id="4883123">.</span><span class="ident" id="4883124">header</span><span class="op" id="4883130">[</span><span class="num" id="4883131">4</span><span class="op" id="4883132">]</span>&nbsp;<span class="op" id="4883134">=</span>&nbsp;<span class="ident" id="4883136"><a href="/image/png/writer.go.html#4882907">name</a></span><span class="op" id="4883140">[</span><span class="num" id="4883141">0</span><span class="op" id="4883142">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4883145"><a href="/image/png/writer.go.html#4882874">e</a></span><span class="op" id="4883146">.</span><span class="ident" id="4883147">header</span><span class="op" id="4883153">[</span><span class="num" id="4883154">5</span><span class="op" id="4883155">]</span>&nbsp;<span class="op" id="4883157">=</span>&nbsp;<span class="ident" id="4883159"><a href="/image/png/writer.go.html#4882907">name</a></span><span class="op" id="4883163">[</span><span class="num" id="4883164">1</span><span class="op" id="4883165">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4883168"><a href="/image/png/writer.go.html#4882874">e</a></span><span class="op" id="4883169">.</span><span class="ident" id="4883170">header</span><span class="op" id="4883176">[</span><span class="num" id="4883177">6</span><span class="op" id="4883178">]</span>&nbsp;<span class="op" id="4883180">=</span>&nbsp;<span class="ident" id="4883182"><a href="/image/png/writer.go.html#4882907">name</a></span><span class="op" id="4883186">[</span><span class="num" id="4883187">2</span><span class="op" id="4883188">]</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4883191"><a href="/image/png/writer.go.html#4882874">e</a></span><span class="op" id="4883192">.</span><span class="ident" id="4883193">header</span><span class="op" id="4883199">[</span><span class="num" id="4883200">7</span><span class="op" id="4883201">]</span>&nbsp;<span class="op" id="4883203">=</span>&nbsp;<span class="ident" id="4883205"><a href="/image/png/writer.go.html#4882907">name</a></span><span class="op" id="4883209">[</span><span class="num" id="4883210">3</span><span class="op" id="4883211">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4883214">crc</span>&nbsp;<span class="op" id="4883218">:=</span>&nbsp;<span class="ident" id="4883221"><a href="/image/png/writer.go.html#4881538">crc32</a></span><span class="op" id="4883226">.</span><span class="ident" id="4883227">NewIEEE</span><span class="op" id="4883234">(</span><span class="op" id="4883235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4883238"><a href="/image/png/writer.go.html#4883214">crc</a></span><span class="op" id="4883241">.</span><span class="ident" id="4883242">Write</span><span class="op" id="4883247">(</span><span class="ident" id="4883248"><a href="/image/png/writer.go.html#4882874">e</a></span><span class="op" id="4883249">.</span><span class="ident" id="4883250">header</span><span class="op" id="4883256">[</span><span class="num" id="4883257">4</span><span class="op" id="4883258">:</span><span class="num" id="4883259">8</span><span class="op" id="4883260">]</span><span class="op" id="4883261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4883264"><a href="/image/png/writer.go.html#4883214">crc</a></span><span class="op" id="4883267">.</span><span class="ident" id="4883268">Write</span><span class="op" id="4883273">(</span><span class="ident" id="4883274"><a href="/image/png/writer.go.html#4882897">b</a></span><span class="op" id="4883275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4883278"><a href="/image/png/writer.go.html#4882218">writeUint32</a></span><span class="op" id="4883289">(</span><span class="ident" id="4883290"><a href="/image/png/writer.go.html#4882874">e</a></span><span class="op" id="4883291">.</span><span class="ident" id="4883292">footer</span><span class="op" id="4883298">[</span><span class="op" id="4883299">:</span><span class="num" id="4883300">4</span><span class="op" id="4883301">]</span><span class="op" id="4883302">,</span>&nbsp;<span class="ident" id="4883304"><a href="/image/png/writer.go.html#4883214">crc</a></span><span class="op" id="4883307">.</span><span class="ident" id="4883308">Sum32</span><span class="op" id="4883313">(</span><span class="op" id="4883314">)</span><span class="op" id="4883315">)</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4883319">_</span><span class="op" id="4883320">,</span>&nbsp;<span class="ident" id="4883322"><a href="/image/png/writer.go.html#4882874">e</a></span><span class="op" id="4883323">.</span><span class="ident" id="4883324">err</span>&nbsp;<span class="op" id="4883328">=</span>&nbsp;<span class="ident" id="4883330"><a href="/image/png/writer.go.html#4882874">e</a></span><span class="op" id="4883331">.</span><span class="ident" id="4883332">w</span><span class="op" id="4883333">.</span><span class="ident" id="4883334">Write</span><span class="op" id="4883339">(</span><span class="ident" id="4883340"><a href="/image/png/writer.go.html#4882874">e</a></span><span class="op" id="4883341">.</span><span class="ident" id="4883342">header</span><span class="op" id="4883348">[</span><span class="op" id="4883349">:</span><span class="num" id="4883350">8</span><span class="op" id="4883351">]</span><span class="op" id="4883352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4883355">if</span>&nbsp;<span class="ident" id="4883358"><a href="/image/png/writer.go.html#4882874">e</a></span><span class="op" id="4883359">.</span><span class="ident" id="4883360">err</span>&nbsp;<span class="op" id="4883364">!=</span>&nbsp;<span class="ident" id="4883367">nil</span>&nbsp;<span class="op" id="4883371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4883375">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4883383">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4883386">_</span><span class="op" id="4883387">,</span>&nbsp;<span class="ident" id="4883389"><a href="/image/png/writer.go.html#4882874">e</a></span><span class="op" id="4883390">.</span><span class="ident" id="4883391">err</span>&nbsp;<span class="op" id="4883395">=</span>&nbsp;<span class="ident" id="4883397"><a href="/image/png/writer.go.html#4882874">e</a></span><span class="op" id="4883398">.</span><span class="ident" id="4883399">w</span><span class="op" id="4883400">.</span><span class="ident" id="4883401">Write</span><span class="op" id="4883406">(</span><span class="ident" id="4883407"><a href="/image/png/writer.go.html#4882897">b</a></span><span class="op" id="4883408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4883411">if</span>&nbsp;<span class="ident" id="4883414"><a href="/image/png/writer.go.html#4882874">e</a></span><span class="op" id="4883415">.</span><span class="ident" id="4883416">err</span>&nbsp;<span class="op" id="4883420">!=</span>&nbsp;<span class="ident" id="4883423">nil</span>&nbsp;<span class="op" id="4883427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4883431">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4883439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4883442">_</span><span class="op" id="4883443">,</span>&nbsp;<span class="ident" id="4883445"><a href="/image/png/writer.go.html#4882874">e</a></span><span class="op" id="4883446">.</span><span class="ident" id="4883447">err</span>&nbsp;<span class="op" id="4883451">=</span>&nbsp;<span class="ident" id="4883453"><a href="/image/png/writer.go.html#4882874">e</a></span><span class="op" id="4883454">.</span><span class="ident" id="4883455">w</span><span class="op" id="4883456">.</span><span class="ident" id="4883457">Write</span><span class="op" id="4883462">(</span><span class="ident" id="4883463"><a href="/image/png/writer.go.html#4882874">e</a></span><span class="op" id="4883464">.</span><span class="ident" id="4883465">footer</span><span class="op" id="4883471">[</span><span class="op" id="4883472">:</span><span class="num" id="4883473">4</span><span class="op" id="4883474">]</span><span class="op" id="4883475">)</span><br>
<span class="lineno">110</span><span class="op" id="4883477">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4883480">func</span>&nbsp;<span class="op" id="4883485">(</span><span class="ident" id="4883486">e</span>&nbsp;<span class="op" id="4883488">*</span><span class="ident" id="4883489"><a href="/image/png/writer.go.html#4881703">encoder</a></span><span class="op" id="4883496">)</span>&nbsp;<span class="ident" id="4883498">writeIHDR</span><span class="op" id="4883507">(</span><span class="op" id="4883508">)</span>&nbsp;<span class="op" id="4883510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4883513">b</span>&nbsp;<span class="op" id="4883515">:=</span>&nbsp;<span class="ident" id="4883518"><a href="/image/png/writer.go.html#4883486">e</a></span><span class="op" id="4883519">.</span><span class="ident" id="4883520">m</span><span class="op" id="4883521">.</span><span class="ident" id="4883522">Bounds</span><span class="op" id="4883528">(</span><span class="op" id="4883529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4883532"><a href="/image/png/writer.go.html#4882218">writeUint32</a></span><span class="op" id="4883543">(</span><span class="ident" id="4883544"><a href="/image/png/writer.go.html#4883486">e</a></span><span class="op" id="4883545">.</span><span class="ident" id="4883546">tmp</span><span class="op" id="4883549">[</span><span class="num" id="4883550">0</span><span class="op" id="4883551">:</span><span class="num" id="4883552">4</span><span class="op" id="4883553">]</span><span class="op" id="4883554">,</span>&nbsp;<span class="builtintype" id="4883556">uint32</span><span class="op" id="4883562">(</span><span class="ident" id="4883563"><a href="/image/png/writer.go.html#4883513">b</a></span><span class="op" id="4883564">.</span><span class="ident" id="4883565">Dx</span><span class="op" id="4883567">(</span><span class="op" id="4883568">)</span><span class="op" id="4883569">)</span><span class="op" id="4883570">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4883573"><a href="/image/png/writer.go.html#4882218">writeUint32</a></span><span class="op" id="4883584">(</span><span class="ident" id="4883585"><a href="/image/png/writer.go.html#4883486">e</a></span><span class="op" id="4883586">.</span><span class="ident" id="4883587">tmp</span><span class="op" id="4883590">[</span><span class="num" id="4883591">4</span><span class="op" id="4883592">:</span><span class="num" id="4883593">8</span><span class="op" id="4883594">]</span><span class="op" id="4883595">,</span>&nbsp;<span class="builtintype" id="4883597">uint32</span><span class="op" id="4883603">(</span><span class="ident" id="4883604"><a href="/image/png/writer.go.html#4883513">b</a></span><span class="op" id="4883605">.</span><span class="ident" id="4883606">Dy</span><span class="op" id="4883608">(</span><span class="op" id="4883609">)</span><span class="op" id="4883610">)</span><span class="op" id="4883611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4883614">//&nbsp;Set&nbsp;bit&nbsp;depth&nbsp;and&nbsp;color&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4883648">switch</span>&nbsp;<span class="ident" id="4883655"><a href="/image/png/writer.go.html#4883486">e</a></span><span class="op" id="4883656">.</span><span class="ident" id="4883657">cb</span>&nbsp;<span class="op" id="4883660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4883663">case</span>&nbsp;<span class="ident" id="4883668"><a href="/image/png/reader.go.html#4861422">cbG8</a></span><span class="op" id="4883672">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4883676"><a href="/image/png/writer.go.html#4883486">e</a></span><span class="op" id="4883677">.</span><span class="ident" id="4883678">tmp</span><span class="op" id="4883681">[</span><span class="num" id="4883682">8</span><span class="op" id="4883683">]</span>&nbsp;<span class="op" id="4883685">=</span>&nbsp;<span class="num" id="4883687">8</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4883691"><a href="/image/png/writer.go.html#4883486">e</a></span><span class="op" id="4883692">.</span><span class="ident" id="4883693">tmp</span><span class="op" id="4883696">[</span><span class="num" id="4883697">9</span><span class="op" id="4883698">]</span>&nbsp;<span class="op" id="4883700">=</span>&nbsp;<span class="ident" id="4883702"><a href="/image/png/reader.go.html#4861211">ctGrayscale</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4883715">case</span>&nbsp;<span class="ident" id="4883720"><a href="/image/png/reader.go.html#4861435">cbTC8</a></span><span class="op" id="4883725">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4883729"><a href="/image/png/writer.go.html#4883486">e</a></span><span class="op" id="4883730">.</span><span class="ident" id="4883731">tmp</span><span class="op" id="4883734">[</span><span class="num" id="4883735">8</span><span class="op" id="4883736">]</span>&nbsp;<span class="op" id="4883738">=</span>&nbsp;<span class="num" id="4883740">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4883744"><a href="/image/png/writer.go.html#4883486">e</a></span><span class="op" id="4883745">.</span><span class="ident" id="4883746">tmp</span><span class="op" id="4883749">[</span><span class="num" id="4883750">9</span><span class="op" id="4883751">]</span>&nbsp;<span class="op" id="4883753">=</span>&nbsp;<span class="ident" id="4883755"><a href="/image/png/reader.go.html#4861233">ctTrueColor</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4883768">case</span>&nbsp;<span class="ident" id="4883773"><a href="/image/png/reader.go.html#4861460">cbP8</a></span><span class="op" id="4883777">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4883781"><a href="/image/png/writer.go.html#4883486">e</a></span><span class="op" id="4883782">.</span><span class="ident" id="4883783">tmp</span><span class="op" id="4883786">[</span><span class="num" id="4883787">8</span><span class="op" id="4883788">]</span>&nbsp;<span class="op" id="4883790">=</span>&nbsp;<span class="num" id="4883792">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4883796"><a href="/image/png/writer.go.html#4883486">e</a></span><span class="op" id="4883797">.</span><span class="ident" id="4883798">tmp</span><span class="op" id="4883801">[</span><span class="num" id="4883802">9</span><span class="op" id="4883803">]</span>&nbsp;<span class="op" id="4883805">=</span>&nbsp;<span class="ident" id="4883807"><a href="/image/png/reader.go.html#4861255">ctPaletted</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4883819">case</span>&nbsp;<span class="ident" id="4883824"><a href="/image/png/reader.go.html#4861466">cbTCA8</a></span><span class="op" id="4883830">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4883834"><a href="/image/png/writer.go.html#4883486">e</a></span><span class="op" id="4883835">.</span><span class="ident" id="4883836">tmp</span><span class="op" id="4883839">[</span><span class="num" id="4883840">8</span><span class="op" id="4883841">]</span>&nbsp;<span class="op" id="4883843">=</span>&nbsp;<span class="num" id="4883845">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4883849"><a href="/image/png/writer.go.html#4883486">e</a></span><span class="op" id="4883850">.</span><span class="ident" id="4883851">tmp</span><span class="op" id="4883854">[</span><span class="num" id="4883855">9</span><span class="op" id="4883856">]</span>&nbsp;<span class="op" id="4883858">=</span>&nbsp;<span class="ident" id="4883860"><a href="/image/png/reader.go.html#4861299">ctTrueColorAlpha</a></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4883878">case</span>&nbsp;<span class="ident" id="4883883"><a href="/image/png/reader.go.html#4861474">cbG16</a></span><span class="op" id="4883888">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4883892"><a href="/image/png/writer.go.html#4883486">e</a></span><span class="op" id="4883893">.</span><span class="ident" id="4883894">tmp</span><span class="op" id="4883897">[</span><span class="num" id="4883898">8</span><span class="op" id="4883899">]</span>&nbsp;<span class="op" id="4883901">=</span>&nbsp;<span class="num" id="4883903">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4883908"><a href="/image/png/writer.go.html#4883486">e</a></span><span class="op" id="4883909">.</span><span class="ident" id="4883910">tmp</span><span class="op" id="4883913">[</span><span class="num" id="4883914">9</span><span class="op" id="4883915">]</span>&nbsp;<span class="op" id="4883917">=</span>&nbsp;<span class="ident" id="4883919"><a href="/image/png/reader.go.html#4861211">ctGrayscale</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4883932">case</span>&nbsp;<span class="ident" id="4883937"><a href="/image/png/reader.go.html#4861489">cbTC16</a></span><span class="op" id="4883943">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4883947"><a href="/image/png/writer.go.html#4883486">e</a></span><span class="op" id="4883948">.</span><span class="ident" id="4883949">tmp</span><span class="op" id="4883952">[</span><span class="num" id="4883953">8</span><span class="op" id="4883954">]</span>&nbsp;<span class="op" id="4883956">=</span>&nbsp;<span class="num" id="4883958">16</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4883963"><a href="/image/png/writer.go.html#4883486">e</a></span><span class="op" id="4883964">.</span><span class="ident" id="4883965">tmp</span><span class="op" id="4883968">[</span><span class="num" id="4883969">9</span><span class="op" id="4883970">]</span>&nbsp;<span class="op" id="4883972">=</span>&nbsp;<span class="ident" id="4883974"><a href="/image/png/reader.go.html#4861233">ctTrueColor</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4883987">case</span>&nbsp;<span class="ident" id="4883992"><a href="/image/png/reader.go.html#4861497">cbTCA16</a></span><span class="op" id="4883999">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4884003"><a href="/image/png/writer.go.html#4883486">e</a></span><span class="op" id="4884004">.</span><span class="ident" id="4884005">tmp</span><span class="op" id="4884008">[</span><span class="num" id="4884009">8</span><span class="op" id="4884010">]</span>&nbsp;<span class="op" id="4884012">=</span>&nbsp;<span class="num" id="4884014">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4884019"><a href="/image/png/writer.go.html#4883486">e</a></span><span class="op" id="4884020">.</span><span class="ident" id="4884021">tmp</span><span class="op" id="4884024">[</span><span class="num" id="4884025">9</span><span class="op" id="4884026">]</span>&nbsp;<span class="op" id="4884028">=</span>&nbsp;<span class="ident" id="4884030"><a href="/image/png/reader.go.html#4861299">ctTrueColorAlpha</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4884048">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4884051"><a href="/image/png/writer.go.html#4883486">e</a></span><span class="op" id="4884052">.</span><span class="ident" id="4884053">tmp</span><span class="op" id="4884056">[</span><span class="num" id="4884057">10</span><span class="op" id="4884059">]</span>&nbsp;<span class="op" id="4884061">=</span>&nbsp;<span class="num" id="4884063">0</span>&nbsp;<span class="comment" id="4884065">//&nbsp;default&nbsp;compression&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4884096"><a href="/image/png/writer.go.html#4883486">e</a></span><span class="op" id="4884097">.</span><span class="ident" id="4884098">tmp</span><span class="op" id="4884101">[</span><span class="num" id="4884102">11</span><span class="op" id="4884104">]</span>&nbsp;<span class="op" id="4884106">=</span>&nbsp;<span class="num" id="4884108">0</span>&nbsp;<span class="comment" id="4884110">//&nbsp;default&nbsp;filter&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4884136"><a href="/image/png/writer.go.html#4883486">e</a></span><span class="op" id="4884137">.</span><span class="ident" id="4884138">tmp</span><span class="op" id="4884141">[</span><span class="num" id="4884142">12</span><span class="op" id="4884144">]</span>&nbsp;<span class="op" id="4884146">=</span>&nbsp;<span class="num" id="4884148">0</span>&nbsp;<span class="comment" id="4884150">//&nbsp;non-interlaced</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4884169"><a href="/image/png/writer.go.html#4883486">e</a></span><span class="op" id="4884170">.</span><span class="ident" id="4884171">writeChunk</span><span class="op" id="4884181">(</span><span class="ident" id="4884182"><a href="/image/png/writer.go.html#4883486">e</a></span><span class="op" id="4884183">.</span><span class="ident" id="4884184">tmp</span><span class="op" id="4884187">[</span><span class="op" id="4884188">:</span><span class="num" id="4884189">13</span><span class="op" id="4884191">]</span><span class="op" id="4884192">,</span>&nbsp;<span class="string" id="4884194">&#34;IHDR&#34;</span><span class="op" id="4884200">)</span><br>
<span class="lineno"></span><span class="op" id="4884202">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span><span class="keyword" id="4884205">func</span>&nbsp;<span class="op" id="4884210">(</span><span class="ident" id="4884211">e</span>&nbsp;<span class="op" id="4884213">*</span><span class="ident" id="4884214"><a href="/image/png/writer.go.html#4881703">encoder</a></span><span class="op" id="4884221">)</span>&nbsp;<span class="ident" id="4884223">writePLTEAndTRNS</span><span class="op" id="4884239">(</span><span class="ident" id="4884240">p</span>&nbsp;<span class="ident" id="4884242"><a href="/image/png/writer.go.html#4881561">color</a></span><span class="op" id="4884247">.</span><span class="ident" id="4884248">Palette</span><span class="op" id="4884255">)</span>&nbsp;<span class="op" id="4884257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4884260">if</span>&nbsp;<span class="builtinfunc" id="4884263">len</span><span class="op" id="4884266">(</span><span class="ident" id="4884267"><a href="/image/png/writer.go.html#4884240">p</a></span><span class="op" id="4884268">)</span>&nbsp;<span class="op" id="4884270">&lt;</span>&nbsp;<span class="num" id="4884272">1</span>&nbsp;<span class="op" id="4884274">||</span>&nbsp;<span class="builtinfunc" id="4884277">len</span><span class="op" id="4884280">(</span><span class="ident" id="4884281"><a href="/image/png/writer.go.html#4884240">p</a></span><span class="op" id="4884282">)</span>&nbsp;<span class="op" id="4884284">&gt;</span>&nbsp;<span class="num" id="4884286">256</span>&nbsp;<span class="op" id="4884290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4884294"><a href="/image/png/writer.go.html#4884211">e</a></span><span class="op" id="4884295">.</span><span class="ident" id="4884296">err</span>&nbsp;<span class="op" id="4884300">=</span>&nbsp;<span class="ident" id="4884302"><a href="/image/png/reader.go.html#4862884">FormatError</a></span><span class="op" id="4884313">(</span><span class="string" id="4884314">&#34;bad&nbsp;palette&nbsp;length:&nbsp;&#34;</span>&nbsp;<span class="op" id="4884337">+</span>&nbsp;<span class="ident" id="4884339"><a href="/image/png/writer.go.html#4881582">strconv</a></span><span class="op" id="4884346">.</span><span class="ident" id="4884347">Itoa</span><span class="op" id="4884351">(</span><span class="builtinfunc" id="4884352">len</span><span class="op" id="4884355">(</span><span class="ident" id="4884356"><a href="/image/png/writer.go.html#4884240">p</a></span><span class="op" id="4884357">)</span><span class="op" id="4884358">)</span><span class="op" id="4884359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4884363">return</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4884371">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4884374">last</span>&nbsp;<span class="op" id="4884379">:=</span>&nbsp;<span class="op" id="4884382">-</span><span class="num" id="4884383">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4884386">for</span>&nbsp;<span class="ident" id="4884390">i</span><span class="op" id="4884391">,</span>&nbsp;<span class="ident" id="4884393">c</span>&nbsp;<span class="op" id="4884395">:=</span>&nbsp;<span class="keyword" id="4884398">range</span>&nbsp;<span class="ident" id="4884404"><a href="/image/png/writer.go.html#4884240">p</a></span>&nbsp;<span class="op" id="4884406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4884410">c1</span>&nbsp;<span class="op" id="4884413">:=</span>&nbsp;<span class="ident" id="4884416"><a href="/image/png/writer.go.html#4881561">color</a></span><span class="op" id="4884421">.</span><span class="ident" id="4884422">NRGBAModel</span><span class="op" id="4884432">.</span><span class="ident" id="4884433">Convert</span><span class="op" id="4884440">(</span><span class="ident" id="4884441"><a href="/image/png/writer.go.html#4884393">c</a></span><span class="op" id="4884442">)</span><span class="op" id="4884443">.</span><span class="op" id="4884444">(</span><span class="ident" id="4884445"><a href="/image/png/writer.go.html#4881561">color</a></span><span class="op" id="4884450">.</span><span class="ident" id="4884451">NRGBA</span><span class="op" id="4884456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4884460"><a href="/image/png/writer.go.html#4884211">e</a></span><span class="op" id="4884461">.</span><span class="ident" id="4884462">tmp</span><span class="op" id="4884465">[</span><span class="num" id="4884466">3</span><span class="op" id="4884467">*</span><span class="ident" id="4884468"><a href="/image/png/writer.go.html#4884390">i</a></span><span class="op" id="4884469">+</span><span class="num" id="4884470">0</span><span class="op" id="4884471">]</span>&nbsp;<span class="op" id="4884473">=</span>&nbsp;<span class="ident" id="4884475"><a href="/image/png/writer.go.html#4884410">c1</a></span><span class="op" id="4884477">.</span><span class="ident" id="4884478">R</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4884482"><a href="/image/png/writer.go.html#4884211">e</a></span><span class="op" id="4884483">.</span><span class="ident" id="4884484">tmp</span><span class="op" id="4884487">[</span><span class="num" id="4884488">3</span><span class="op" id="4884489">*</span><span class="ident" id="4884490"><a href="/image/png/writer.go.html#4884390">i</a></span><span class="op" id="4884491">+</span><span class="num" id="4884492">1</span><span class="op" id="4884493">]</span>&nbsp;<span class="op" id="4884495">=</span>&nbsp;<span class="ident" id="4884497"><a href="/image/png/writer.go.html#4884410">c1</a></span><span class="op" id="4884499">.</span><span class="ident" id="4884500">G</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4884504"><a href="/image/png/writer.go.html#4884211">e</a></span><span class="op" id="4884505">.</span><span class="ident" id="4884506">tmp</span><span class="op" id="4884509">[</span><span class="num" id="4884510">3</span><span class="op" id="4884511">*</span><span class="ident" id="4884512"><a href="/image/png/writer.go.html#4884390">i</a></span><span class="op" id="4884513">+</span><span class="num" id="4884514">2</span><span class="op" id="4884515">]</span>&nbsp;<span class="op" id="4884517">=</span>&nbsp;<span class="ident" id="4884519"><a href="/image/png/writer.go.html#4884410">c1</a></span><span class="op" id="4884521">.</span><span class="ident" id="4884522">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4884526">if</span>&nbsp;<span class="ident" id="4884529"><a href="/image/png/writer.go.html#4884410">c1</a></span><span class="op" id="4884531">.</span><span class="ident" id="4884532">A</span>&nbsp;<span class="op" id="4884534">!=</span>&nbsp;<span class="num" id="4884537">0xff</span>&nbsp;<span class="op" id="4884542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4884547"><a href="/image/png/writer.go.html#4884374">last</a></span>&nbsp;<span class="op" id="4884552">=</span>&nbsp;<span class="ident" id="4884554"><a href="/image/png/writer.go.html#4884390">i</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4884558">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4884562"><a href="/image/png/writer.go.html#4884211">e</a></span><span class="op" id="4884563">.</span><span class="ident" id="4884564">tmp</span><span class="op" id="4884567">[</span><span class="num" id="4884568">3</span><span class="op" id="4884569">*</span><span class="num" id="4884570">256</span><span class="op" id="4884573">+</span><span class="ident" id="4884574"><a href="/image/png/writer.go.html#4884390">i</a></span><span class="op" id="4884575">]</span>&nbsp;<span class="op" id="4884577">=</span>&nbsp;<span class="ident" id="4884579"><a href="/image/png/writer.go.html#4884410">c1</a></span><span class="op" id="4884581">.</span><span class="ident" id="4884582">A</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4884585">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4884588"><a href="/image/png/writer.go.html#4884211">e</a></span><span class="op" id="4884589">.</span><span class="ident" id="4884590">writeChunk</span><span class="op" id="4884600">(</span><span class="ident" id="4884601"><a href="/image/png/writer.go.html#4884211">e</a></span><span class="op" id="4884602">.</span><span class="ident" id="4884603">tmp</span><span class="op" id="4884606">[</span><span class="op" id="4884607">:</span><span class="num" id="4884608">3</span><span class="op" id="4884609">*</span><span class="builtinfunc" id="4884610">len</span><span class="op" id="4884613">(</span><span class="ident" id="4884614"><a href="/image/png/writer.go.html#4884240">p</a></span><span class="op" id="4884615">)</span><span class="op" id="4884616">]</span><span class="op" id="4884617">,</span>&nbsp;<span class="string" id="4884619">&#34;PLTE&#34;</span><span class="op" id="4884625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4884628">if</span>&nbsp;<span class="ident" id="4884631"><a href="/image/png/writer.go.html#4884374">last</a></span>&nbsp;<span class="op" id="4884636">!=</span>&nbsp;<span class="op" id="4884639">-</span><span class="num" id="4884640">1</span>&nbsp;<span class="op" id="4884642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4884646"><a href="/image/png/writer.go.html#4884211">e</a></span><span class="op" id="4884647">.</span><span class="ident" id="4884648">writeChunk</span><span class="op" id="4884658">(</span><span class="ident" id="4884659"><a href="/image/png/writer.go.html#4884211">e</a></span><span class="op" id="4884660">.</span><span class="ident" id="4884661">tmp</span><span class="op" id="4884664">[</span><span class="num" id="4884665">3</span><span class="op" id="4884666">*</span><span class="num" id="4884667">256</span><span class="op" id="4884670">:</span><span class="num" id="4884671">3</span><span class="op" id="4884672">*</span><span class="num" id="4884673">256</span><span class="op" id="4884676">+</span><span class="num" id="4884677">1</span><span class="op" id="4884678">+</span><span class="ident" id="4884679"><a href="/image/png/writer.go.html#4884374">last</a></span><span class="op" id="4884683">]</span><span class="op" id="4884684">,</span>&nbsp;<span class="string" id="4884686">&#34;tRNS&#34;</span><span class="op" id="4884692">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4884695">}</span><br>
<span class="lineno"></span><span class="op" id="4884697">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4884700">//&nbsp;An&nbsp;encoder&nbsp;is&nbsp;an&nbsp;io.Writer&nbsp;that&nbsp;satisfies&nbsp;writes&nbsp;by&nbsp;writing&nbsp;PNG&nbsp;IDAT&nbsp;chunks,</span><br>
<span class="lineno"></span><span class="comment" id="4884780">//&nbsp;including&nbsp;an&nbsp;8-byte&nbsp;header&nbsp;and&nbsp;4-byte&nbsp;CRC&nbsp;checksum&nbsp;per&nbsp;Write&nbsp;call.&nbsp;Such&nbsp;calls</span><br>
<span class="lineno">170</span><span class="comment" id="4884861">//&nbsp;should&nbsp;be&nbsp;relatively&nbsp;infrequent,&nbsp;since&nbsp;writeIDATs&nbsp;uses&nbsp;a&nbsp;bufio.Writer.</span><br>
<span class="lineno"></span><span class="comment" id="4884935">//</span><br>
<span class="lineno"></span><span class="comment" id="4884938">//&nbsp;This&nbsp;method&nbsp;should&nbsp;only&nbsp;be&nbsp;called&nbsp;from&nbsp;writeIDATs&nbsp;(via&nbsp;writeImage).</span><br>
<span class="lineno"></span><span class="comment" id="4885009">//&nbsp;No&nbsp;other&nbsp;code&nbsp;should&nbsp;treat&nbsp;an&nbsp;encoder&nbsp;as&nbsp;an&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4885067">func</span>&nbsp;<span class="op" id="4885072">(</span><span class="ident" id="4885073">e</span>&nbsp;<span class="op" id="4885075">*</span><span class="ident" id="4885076"><a href="/image/png/writer.go.html#4881703">encoder</a></span><span class="op" id="4885083">)</span>&nbsp;<span class="ident" id="4885085">Write</span><span class="op" id="4885090">(</span><span class="ident" id="4885091">b</span>&nbsp;<span class="op" id="4885093">[</span><span class="op" id="4885094">]</span><span class="builtintype" id="4885095">byte</span><span class="op" id="4885099">)</span>&nbsp;<span class="op" id="4885101">(</span><span class="builtintype" id="4885102">int</span><span class="op" id="4885105">,</span>&nbsp;<span class="builtintype" id="4885107">error</span><span class="op" id="4885112">)</span>&nbsp;<span class="op" id="4885114">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4885117"><a href="/image/png/writer.go.html#4885073">e</a></span><span class="op" id="4885118">.</span><span class="ident" id="4885119">writeChunk</span><span class="op" id="4885129">(</span><span class="ident" id="4885130"><a href="/image/png/writer.go.html#4885091">b</a></span><span class="op" id="4885131">,</span>&nbsp;<span class="string" id="4885133">&#34;IDAT&#34;</span><span class="op" id="4885139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4885142">if</span>&nbsp;<span class="ident" id="4885145"><a href="/image/png/writer.go.html#4885073">e</a></span><span class="op" id="4885146">.</span><span class="ident" id="4885147">err</span>&nbsp;<span class="op" id="4885151">!=</span>&nbsp;<span class="ident" id="4885154">nil</span>&nbsp;<span class="op" id="4885158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4885162">return</span>&nbsp;<span class="num" id="4885169">0</span><span class="op" id="4885170">,</span>&nbsp;<span class="ident" id="4885172"><a href="/image/png/writer.go.html#4885073">e</a></span><span class="op" id="4885173">.</span><span class="ident" id="4885174">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4885179">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4885182">return</span>&nbsp;<span class="builtinfunc" id="4885189">len</span><span class="op" id="4885192">(</span><span class="ident" id="4885193"><a href="/image/png/writer.go.html#4885091">b</a></span><span class="op" id="4885194">)</span><span class="op" id="4885195">,</span>&nbsp;<span class="ident" id="4885197">nil</span><br>
<span class="lineno">180</span><span class="op" id="4885201">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4885204">//&nbsp;Chooses&nbsp;the&nbsp;filter&nbsp;to&nbsp;use&nbsp;for&nbsp;encoding&nbsp;the&nbsp;current&nbsp;row,&nbsp;and&nbsp;applies&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="4885279">//&nbsp;The&nbsp;return&nbsp;value&nbsp;is&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;filter&nbsp;and&nbsp;also&nbsp;of&nbsp;the&nbsp;row&nbsp;in&nbsp;cr&nbsp;that&nbsp;has&nbsp;had&nbsp;it&nbsp;applied.</span><br>
<span class="lineno"></span><span class="keyword" id="4885377">func</span>&nbsp;<span class="ident" id="4885382">filter</span><span class="op" id="4885388">(</span><span class="ident" id="4885389">cr</span>&nbsp;<span class="op" id="4885392">*</span><span class="op" id="4885393">[</span><span class="ident" id="4885394"><a href="/image/png/reader.go.html#4861629">nFilter</a></span><span class="op" id="4885401">]</span><span class="op" id="4885402">[</span><span class="op" id="4885403">]</span><span class="builtintype" id="4885404">byte</span><span class="op" id="4885408">,</span>&nbsp;<span class="ident" id="4885410">pr</span>&nbsp;<span class="op" id="4885413">[</span><span class="op" id="4885414">]</span><span class="builtintype" id="4885415">byte</span><span class="op" id="4885419">,</span>&nbsp;<span class="ident" id="4885421">bpp</span>&nbsp;<span class="builtintype" id="4885425">int</span><span class="op" id="4885428">)</span>&nbsp;<span class="builtintype" id="4885430">int</span>&nbsp;<span class="op" id="4885434">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4885437">//&nbsp;We&nbsp;try&nbsp;all&nbsp;five&nbsp;filter&nbsp;types,&nbsp;and&nbsp;pick&nbsp;the&nbsp;one&nbsp;that&nbsp;minimizes&nbsp;the&nbsp;sum&nbsp;of&nbsp;absolute&nbsp;differences.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4885536">//&nbsp;This&nbsp;is&nbsp;the&nbsp;same&nbsp;heuristic&nbsp;that&nbsp;libpng&nbsp;uses,&nbsp;although&nbsp;the&nbsp;filters&nbsp;are&nbsp;attempted&nbsp;in&nbsp;order&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4885632">//&nbsp;estimated&nbsp;most&nbsp;likely&nbsp;to&nbsp;be&nbsp;minimal&nbsp;(ftUp,&nbsp;ftPaeth,&nbsp;ftNone,&nbsp;ftSub,&nbsp;ftAverage),&nbsp;rather&nbsp;than</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4885727">//&nbsp;in&nbsp;their&nbsp;enumeration&nbsp;order&nbsp;(ftNone,&nbsp;ftSub,&nbsp;ftUp,&nbsp;ftAverage,&nbsp;ftPaeth).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4885801">cdat0</span>&nbsp;<span class="op" id="4885807">:=</span>&nbsp;<span class="ident" id="4885810"><a href="/image/png/writer.go.html#4885389">cr</a></span><span class="op" id="4885812">[</span><span class="num" id="4885813">0</span><span class="op" id="4885814">]</span><span class="op" id="4885815">[</span><span class="num" id="4885816">1</span><span class="op" id="4885817">:</span><span class="op" id="4885818">]</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4885821">cdat1</span>&nbsp;<span class="op" id="4885827">:=</span>&nbsp;<span class="ident" id="4885830"><a href="/image/png/writer.go.html#4885389">cr</a></span><span class="op" id="4885832">[</span><span class="num" id="4885833">1</span><span class="op" id="4885834">]</span><span class="op" id="4885835">[</span><span class="num" id="4885836">1</span><span class="op" id="4885837">:</span><span class="op" id="4885838">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4885841">cdat2</span>&nbsp;<span class="op" id="4885847">:=</span>&nbsp;<span class="ident" id="4885850"><a href="/image/png/writer.go.html#4885389">cr</a></span><span class="op" id="4885852">[</span><span class="num" id="4885853">2</span><span class="op" id="4885854">]</span><span class="op" id="4885855">[</span><span class="num" id="4885856">1</span><span class="op" id="4885857">:</span><span class="op" id="4885858">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4885861">cdat3</span>&nbsp;<span class="op" id="4885867">:=</span>&nbsp;<span class="ident" id="4885870"><a href="/image/png/writer.go.html#4885389">cr</a></span><span class="op" id="4885872">[</span><span class="num" id="4885873">3</span><span class="op" id="4885874">]</span><span class="op" id="4885875">[</span><span class="num" id="4885876">1</span><span class="op" id="4885877">:</span><span class="op" id="4885878">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4885881">cdat4</span>&nbsp;<span class="op" id="4885887">:=</span>&nbsp;<span class="ident" id="4885890"><a href="/image/png/writer.go.html#4885389">cr</a></span><span class="op" id="4885892">[</span><span class="num" id="4885893">4</span><span class="op" id="4885894">]</span><span class="op" id="4885895">[</span><span class="num" id="4885896">1</span><span class="op" id="4885897">:</span><span class="op" id="4885898">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4885901">pdat</span>&nbsp;<span class="op" id="4885906">:=</span>&nbsp;<span class="ident" id="4885909"><a href="/image/png/writer.go.html#4885410">pr</a></span><span class="op" id="4885911">[</span><span class="num" id="4885912">1</span><span class="op" id="4885913">:</span><span class="op" id="4885914">]</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4885917">n</span>&nbsp;<span class="op" id="4885919">:=</span>&nbsp;<span class="builtinfunc" id="4885922">len</span><span class="op" id="4885925">(</span><span class="ident" id="4885926"><a href="/image/png/writer.go.html#4885801">cdat0</a></span><span class="op" id="4885931">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4885935">//&nbsp;The&nbsp;up&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4885954">sum</span>&nbsp;<span class="op" id="4885958">:=</span>&nbsp;<span class="num" id="4885961">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4885964">for</span>&nbsp;<span class="ident" id="4885968">i</span>&nbsp;<span class="op" id="4885970">:=</span>&nbsp;<span class="num" id="4885973">0</span><span class="op" id="4885974">;</span>&nbsp;<span class="ident" id="4885976"><a href="/image/png/writer.go.html#4885968">i</a></span>&nbsp;<span class="op" id="4885978">&lt;</span>&nbsp;<span class="ident" id="4885980"><a href="/image/png/writer.go.html#4885917">n</a></span><span class="op" id="4885981">;</span>&nbsp;<span class="ident" id="4885983"><a href="/image/png/writer.go.html#4885968">i</a></span><span class="op" id="4885984">++</span>&nbsp;<span class="op" id="4885987">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4885991"><a href="/image/png/writer.go.html#4885841">cdat2</a></span><span class="op" id="4885996">[</span><span class="ident" id="4885997"><a href="/image/png/writer.go.html#4885968">i</a></span><span class="op" id="4885998">]</span>&nbsp;<span class="op" id="4886000">=</span>&nbsp;<span class="ident" id="4886002"><a href="/image/png/writer.go.html#4885801">cdat0</a></span><span class="op" id="4886007">[</span><span class="ident" id="4886008"><a href="/image/png/writer.go.html#4885968">i</a></span><span class="op" id="4886009">]</span>&nbsp;<span class="op" id="4886011">-</span>&nbsp;<span class="ident" id="4886013"><a href="/image/png/writer.go.html#4885901">pdat</a></span><span class="op" id="4886017">[</span><span class="ident" id="4886018"><a href="/image/png/writer.go.html#4885968">i</a></span><span class="op" id="4886019">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4886023"><a href="/image/png/writer.go.html#4885954">sum</a></span>&nbsp;<span class="op" id="4886027">+=</span>&nbsp;<span class="ident" id="4886030"><a href="/image/png/writer.go.html#4882791">abs8</a></span><span class="op" id="4886034">(</span><span class="ident" id="4886035"><a href="/image/png/writer.go.html#4885841">cdat2</a></span><span class="op" id="4886040">[</span><span class="ident" id="4886041"><a href="/image/png/writer.go.html#4885968">i</a></span><span class="op" id="4886042">]</span><span class="op" id="4886043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4886046">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4886049">best</span>&nbsp;<span class="op" id="4886054">:=</span>&nbsp;<span class="ident" id="4886057"><a href="/image/png/writer.go.html#4885954">sum</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4886062">filter</span>&nbsp;<span class="op" id="4886069">:=</span>&nbsp;<span class="ident" id="4886072"><a href="/image/png/reader.go.html#4861584">ftUp</a></span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4886079">//&nbsp;The&nbsp;Paeth&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4886101"><a href="/image/png/writer.go.html#4885954">sum</a></span>&nbsp;<span class="op" id="4886105">=</span>&nbsp;<span class="num" id="4886107">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4886110">for</span>&nbsp;<span class="ident" id="4886114">i</span>&nbsp;<span class="op" id="4886116">:=</span>&nbsp;<span class="num" id="4886119">0</span><span class="op" id="4886120">;</span>&nbsp;<span class="ident" id="4886122"><a href="/image/png/writer.go.html#4886114">i</a></span>&nbsp;<span class="op" id="4886124">&lt;</span>&nbsp;<span class="ident" id="4886126"><a href="/image/png/writer.go.html#4885421">bpp</a></span><span class="op" id="4886129">;</span>&nbsp;<span class="ident" id="4886131"><a href="/image/png/writer.go.html#4886114">i</a></span><span class="op" id="4886132">++</span>&nbsp;<span class="op" id="4886135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4886139"><a href="/image/png/writer.go.html#4885881">cdat4</a></span><span class="op" id="4886144">[</span><span class="ident" id="4886145"><a href="/image/png/writer.go.html#4886114">i</a></span><span class="op" id="4886146">]</span>&nbsp;<span class="op" id="4886148">=</span>&nbsp;<span class="ident" id="4886150"><a href="/image/png/writer.go.html#4885801">cdat0</a></span><span class="op" id="4886155">[</span><span class="ident" id="4886156"><a href="/image/png/writer.go.html#4886114">i</a></span><span class="op" id="4886157">]</span>&nbsp;<span class="op" id="4886159">-</span>&nbsp;<span class="ident" id="4886161"><a href="/image/png/writer.go.html#4885901">pdat</a></span><span class="op" id="4886165">[</span><span class="ident" id="4886166"><a href="/image/png/writer.go.html#4886114">i</a></span><span class="op" id="4886167">]</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4886171"><a href="/image/png/writer.go.html#4885954">sum</a></span>&nbsp;<span class="op" id="4886175">+=</span>&nbsp;<span class="ident" id="4886178"><a href="/image/png/writer.go.html#4882791">abs8</a></span><span class="op" id="4886182">(</span><span class="ident" id="4886183"><a href="/image/png/writer.go.html#4885881">cdat4</a></span><span class="op" id="4886188">[</span><span class="ident" id="4886189"><a href="/image/png/writer.go.html#4886114">i</a></span><span class="op" id="4886190">]</span><span class="op" id="4886191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4886194">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4886197">for</span>&nbsp;<span class="ident" id="4886201">i</span>&nbsp;<span class="op" id="4886203">:=</span>&nbsp;<span class="ident" id="4886206"><a href="/image/png/writer.go.html#4885421">bpp</a></span><span class="op" id="4886209">;</span>&nbsp;<span class="ident" id="4886211"><a href="/image/png/writer.go.html#4886201">i</a></span>&nbsp;<span class="op" id="4886213">&lt;</span>&nbsp;<span class="ident" id="4886215"><a href="/image/png/writer.go.html#4885917">n</a></span><span class="op" id="4886216">;</span>&nbsp;<span class="ident" id="4886218"><a href="/image/png/writer.go.html#4886201">i</a></span><span class="op" id="4886219">++</span>&nbsp;<span class="op" id="4886222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4886226"><a href="/image/png/writer.go.html#4885881">cdat4</a></span><span class="op" id="4886231">[</span><span class="ident" id="4886232"><a href="/image/png/writer.go.html#4886201">i</a></span><span class="op" id="4886233">]</span>&nbsp;<span class="op" id="4886235">=</span>&nbsp;<span class="ident" id="4886237"><a href="/image/png/writer.go.html#4885801">cdat0</a></span><span class="op" id="4886242">[</span><span class="ident" id="4886243"><a href="/image/png/writer.go.html#4886201">i</a></span><span class="op" id="4886244">]</span>&nbsp;<span class="op" id="4886246">-</span>&nbsp;<span class="ident" id="4886248"><a href="/image/png/paeth.go.html#4859677">paeth</a></span><span class="op" id="4886253">(</span><span class="ident" id="4886254"><a href="/image/png/writer.go.html#4885801">cdat0</a></span><span class="op" id="4886259">[</span><span class="ident" id="4886260"><a href="/image/png/writer.go.html#4886201">i</a></span><span class="op" id="4886261">-</span><span class="ident" id="4886262"><a href="/image/png/writer.go.html#4885421">bpp</a></span><span class="op" id="4886265">]</span><span class="op" id="4886266">,</span>&nbsp;<span class="ident" id="4886268"><a href="/image/png/writer.go.html#4885901">pdat</a></span><span class="op" id="4886272">[</span><span class="ident" id="4886273"><a href="/image/png/writer.go.html#4886201">i</a></span><span class="op" id="4886274">]</span><span class="op" id="4886275">,</span>&nbsp;<span class="ident" id="4886277"><a href="/image/png/writer.go.html#4885901">pdat</a></span><span class="op" id="4886281">[</span><span class="ident" id="4886282"><a href="/image/png/writer.go.html#4886201">i</a></span><span class="op" id="4886283">-</span><span class="ident" id="4886284"><a href="/image/png/writer.go.html#4885421">bpp</a></span><span class="op" id="4886287">]</span><span class="op" id="4886288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4886292"><a href="/image/png/writer.go.html#4885954">sum</a></span>&nbsp;<span class="op" id="4886296">+=</span>&nbsp;<span class="ident" id="4886299"><a href="/image/png/writer.go.html#4882791">abs8</a></span><span class="op" id="4886303">(</span><span class="ident" id="4886304"><a href="/image/png/writer.go.html#4885881">cdat4</a></span><span class="op" id="4886309">[</span><span class="ident" id="4886310"><a href="/image/png/writer.go.html#4886201">i</a></span><span class="op" id="4886311">]</span><span class="op" id="4886312">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4886316">if</span>&nbsp;<span class="ident" id="4886319"><a href="/image/png/writer.go.html#4885954">sum</a></span>&nbsp;<span class="op" id="4886323">&gt;=</span>&nbsp;<span class="ident" id="4886326"><a href="/image/png/writer.go.html#4886049">best</a></span>&nbsp;<span class="op" id="4886331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4886336">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4886344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4886347">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4886350">if</span>&nbsp;<span class="ident" id="4886353"><a href="/image/png/writer.go.html#4885954">sum</a></span>&nbsp;<span class="op" id="4886357">&lt;</span>&nbsp;<span class="ident" id="4886359"><a href="/image/png/writer.go.html#4886049">best</a></span>&nbsp;<span class="op" id="4886364">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4886368"><a href="/image/png/writer.go.html#4886049">best</a></span>&nbsp;<span class="op" id="4886373">=</span>&nbsp;<span class="ident" id="4886375"><a href="/image/png/writer.go.html#4885954">sum</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4886381"><a href="/image/png/writer.go.html#4886062">filter</a></span>&nbsp;<span class="op" id="4886388">=</span>&nbsp;<span class="ident" id="4886390"><a href="/image/png/reader.go.html#4861614">ftPaeth</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4886399">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4886403">//&nbsp;The&nbsp;none&nbsp;filter.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4886424"><a href="/image/png/writer.go.html#4885954">sum</a></span>&nbsp;<span class="op" id="4886428">=</span>&nbsp;<span class="num" id="4886430">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4886433">for</span>&nbsp;<span class="ident" id="4886437">i</span>&nbsp;<span class="op" id="4886439">:=</span>&nbsp;<span class="num" id="4886442">0</span><span class="op" id="4886443">;</span>&nbsp;<span class="ident" id="4886445"><a href="/image/png/writer.go.html#4886437">i</a></span>&nbsp;<span class="op" id="4886447">&lt;</span>&nbsp;<span class="ident" id="4886449"><a href="/image/png/writer.go.html#4885917">n</a></span><span class="op" id="4886450">;</span>&nbsp;<span class="ident" id="4886452"><a href="/image/png/writer.go.html#4886437">i</a></span><span class="op" id="4886453">++</span>&nbsp;<span class="op" id="4886456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4886460"><a href="/image/png/writer.go.html#4885954">sum</a></span>&nbsp;<span class="op" id="4886464">+=</span>&nbsp;<span class="ident" id="4886467"><a href="/image/png/writer.go.html#4882791">abs8</a></span><span class="op" id="4886471">(</span><span class="ident" id="4886472"><a href="/image/png/writer.go.html#4885801">cdat0</a></span><span class="op" id="4886477">[</span><span class="ident" id="4886478"><a href="/image/png/writer.go.html#4886437">i</a></span><span class="op" id="4886479">]</span><span class="op" id="4886480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4886484">if</span>&nbsp;<span class="ident" id="4886487"><a href="/image/png/writer.go.html#4885954">sum</a></span>&nbsp;<span class="op" id="4886491">&gt;=</span>&nbsp;<span class="ident" id="4886494"><a href="/image/png/writer.go.html#4886049">best</a></span>&nbsp;<span class="op" id="4886499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4886504">break</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4886512">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4886515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4886518">if</span>&nbsp;<span class="ident" id="4886521"><a href="/image/png/writer.go.html#4885954">sum</a></span>&nbsp;<span class="op" id="4886525">&lt;</span>&nbsp;<span class="ident" id="4886527"><a href="/image/png/writer.go.html#4886049">best</a></span>&nbsp;<span class="op" id="4886532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4886536"><a href="/image/png/writer.go.html#4886049">best</a></span>&nbsp;<span class="op" id="4886541">=</span>&nbsp;<span class="ident" id="4886543"><a href="/image/png/writer.go.html#4885954">sum</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4886549"><a href="/image/png/writer.go.html#4886062">filter</a></span>&nbsp;<span class="op" id="4886556">=</span>&nbsp;<span class="ident" id="4886558"><a href="/image/png/reader.go.html#4861554">ftNone</a></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4886566">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4886570">//&nbsp;The&nbsp;sub&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4886590"><a href="/image/png/writer.go.html#4885954">sum</a></span>&nbsp;<span class="op" id="4886594">=</span>&nbsp;<span class="num" id="4886596">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4886599">for</span>&nbsp;<span class="ident" id="4886603">i</span>&nbsp;<span class="op" id="4886605">:=</span>&nbsp;<span class="num" id="4886608">0</span><span class="op" id="4886609">;</span>&nbsp;<span class="ident" id="4886611"><a href="/image/png/writer.go.html#4886603">i</a></span>&nbsp;<span class="op" id="4886613">&lt;</span>&nbsp;<span class="ident" id="4886615"><a href="/image/png/writer.go.html#4885421">bpp</a></span><span class="op" id="4886618">;</span>&nbsp;<span class="ident" id="4886620"><a href="/image/png/writer.go.html#4886603">i</a></span><span class="op" id="4886621">++</span>&nbsp;<span class="op" id="4886624">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4886628"><a href="/image/png/writer.go.html#4885821">cdat1</a></span><span class="op" id="4886633">[</span><span class="ident" id="4886634"><a href="/image/png/writer.go.html#4886603">i</a></span><span class="op" id="4886635">]</span>&nbsp;<span class="op" id="4886637">=</span>&nbsp;<span class="ident" id="4886639"><a href="/image/png/writer.go.html#4885801">cdat0</a></span><span class="op" id="4886644">[</span><span class="ident" id="4886645"><a href="/image/png/writer.go.html#4886603">i</a></span><span class="op" id="4886646">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4886650"><a href="/image/png/writer.go.html#4885954">sum</a></span>&nbsp;<span class="op" id="4886654">+=</span>&nbsp;<span class="ident" id="4886657"><a href="/image/png/writer.go.html#4882791">abs8</a></span><span class="op" id="4886661">(</span><span class="ident" id="4886662"><a href="/image/png/writer.go.html#4885821">cdat1</a></span><span class="op" id="4886667">[</span><span class="ident" id="4886668"><a href="/image/png/writer.go.html#4886603">i</a></span><span class="op" id="4886669">]</span><span class="op" id="4886670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4886673">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4886676">for</span>&nbsp;<span class="ident" id="4886680">i</span>&nbsp;<span class="op" id="4886682">:=</span>&nbsp;<span class="ident" id="4886685"><a href="/image/png/writer.go.html#4885421">bpp</a></span><span class="op" id="4886688">;</span>&nbsp;<span class="ident" id="4886690"><a href="/image/png/writer.go.html#4886680">i</a></span>&nbsp;<span class="op" id="4886692">&lt;</span>&nbsp;<span class="ident" id="4886694"><a href="/image/png/writer.go.html#4885917">n</a></span><span class="op" id="4886695">;</span>&nbsp;<span class="ident" id="4886697"><a href="/image/png/writer.go.html#4886680">i</a></span><span class="op" id="4886698">++</span>&nbsp;<span class="op" id="4886701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4886705"><a href="/image/png/writer.go.html#4885821">cdat1</a></span><span class="op" id="4886710">[</span><span class="ident" id="4886711"><a href="/image/png/writer.go.html#4886680">i</a></span><span class="op" id="4886712">]</span>&nbsp;<span class="op" id="4886714">=</span>&nbsp;<span class="ident" id="4886716"><a href="/image/png/writer.go.html#4885801">cdat0</a></span><span class="op" id="4886721">[</span><span class="ident" id="4886722"><a href="/image/png/writer.go.html#4886680">i</a></span><span class="op" id="4886723">]</span>&nbsp;<span class="op" id="4886725">-</span>&nbsp;<span class="ident" id="4886727"><a href="/image/png/writer.go.html#4885801">cdat0</a></span><span class="op" id="4886732">[</span><span class="ident" id="4886733"><a href="/image/png/writer.go.html#4886680">i</a></span><span class="op" id="4886734">-</span><span class="ident" id="4886735"><a href="/image/png/writer.go.html#4885421">bpp</a></span><span class="op" id="4886738">]</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4886742"><a href="/image/png/writer.go.html#4885954">sum</a></span>&nbsp;<span class="op" id="4886746">+=</span>&nbsp;<span class="ident" id="4886749"><a href="/image/png/writer.go.html#4882791">abs8</a></span><span class="op" id="4886753">(</span><span class="ident" id="4886754"><a href="/image/png/writer.go.html#4885821">cdat1</a></span><span class="op" id="4886759">[</span><span class="ident" id="4886760"><a href="/image/png/writer.go.html#4886680">i</a></span><span class="op" id="4886761">]</span><span class="op" id="4886762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4886766">if</span>&nbsp;<span class="ident" id="4886769"><a href="/image/png/writer.go.html#4885954">sum</a></span>&nbsp;<span class="op" id="4886773">&gt;=</span>&nbsp;<span class="ident" id="4886776"><a href="/image/png/writer.go.html#4886049">best</a></span>&nbsp;<span class="op" id="4886781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4886786">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4886794">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4886797">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4886800">if</span>&nbsp;<span class="ident" id="4886803"><a href="/image/png/writer.go.html#4885954">sum</a></span>&nbsp;<span class="op" id="4886807">&lt;</span>&nbsp;<span class="ident" id="4886809"><a href="/image/png/writer.go.html#4886049">best</a></span>&nbsp;<span class="op" id="4886814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4886818"><a href="/image/png/writer.go.html#4886049">best</a></span>&nbsp;<span class="op" id="4886823">=</span>&nbsp;<span class="ident" id="4886825"><a href="/image/png/writer.go.html#4885954">sum</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4886831"><a href="/image/png/writer.go.html#4886062">filter</a></span>&nbsp;<span class="op" id="4886838">=</span>&nbsp;<span class="ident" id="4886840"><a href="/image/png/reader.go.html#4861569">ftSub</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4886847">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4886851">//&nbsp;The&nbsp;average&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4886875"><a href="/image/png/writer.go.html#4885954">sum</a></span>&nbsp;<span class="op" id="4886879">=</span>&nbsp;<span class="num" id="4886881">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4886884">for</span>&nbsp;<span class="ident" id="4886888">i</span>&nbsp;<span class="op" id="4886890">:=</span>&nbsp;<span class="num" id="4886893">0</span><span class="op" id="4886894">;</span>&nbsp;<span class="ident" id="4886896"><a href="/image/png/writer.go.html#4886888">i</a></span>&nbsp;<span class="op" id="4886898">&lt;</span>&nbsp;<span class="ident" id="4886900"><a href="/image/png/writer.go.html#4885421">bpp</a></span><span class="op" id="4886903">;</span>&nbsp;<span class="ident" id="4886905"><a href="/image/png/writer.go.html#4886888">i</a></span><span class="op" id="4886906">++</span>&nbsp;<span class="op" id="4886909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4886913"><a href="/image/png/writer.go.html#4885861">cdat3</a></span><span class="op" id="4886918">[</span><span class="ident" id="4886919"><a href="/image/png/writer.go.html#4886888">i</a></span><span class="op" id="4886920">]</span>&nbsp;<span class="op" id="4886922">=</span>&nbsp;<span class="ident" id="4886924"><a href="/image/png/writer.go.html#4885801">cdat0</a></span><span class="op" id="4886929">[</span><span class="ident" id="4886930"><a href="/image/png/writer.go.html#4886888">i</a></span><span class="op" id="4886931">]</span>&nbsp;<span class="op" id="4886933">-</span>&nbsp;<span class="ident" id="4886935"><a href="/image/png/writer.go.html#4885901">pdat</a></span><span class="op" id="4886939">[</span><span class="ident" id="4886940"><a href="/image/png/writer.go.html#4886888">i</a></span><span class="op" id="4886941">]</span><span class="op" id="4886942">/</span><span class="num" id="4886943">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4886947"><a href="/image/png/writer.go.html#4885954">sum</a></span>&nbsp;<span class="op" id="4886951">+=</span>&nbsp;<span class="ident" id="4886954"><a href="/image/png/writer.go.html#4882791">abs8</a></span><span class="op" id="4886958">(</span><span class="ident" id="4886959"><a href="/image/png/writer.go.html#4885861">cdat3</a></span><span class="op" id="4886964">[</span><span class="ident" id="4886965"><a href="/image/png/writer.go.html#4886888">i</a></span><span class="op" id="4886966">]</span><span class="op" id="4886967">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4886970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4886973">for</span>&nbsp;<span class="ident" id="4886977">i</span>&nbsp;<span class="op" id="4886979">:=</span>&nbsp;<span class="ident" id="4886982"><a href="/image/png/writer.go.html#4885421">bpp</a></span><span class="op" id="4886985">;</span>&nbsp;<span class="ident" id="4886987"><a href="/image/png/writer.go.html#4886977">i</a></span>&nbsp;<span class="op" id="4886989">&lt;</span>&nbsp;<span class="ident" id="4886991"><a href="/image/png/writer.go.html#4885917">n</a></span><span class="op" id="4886992">;</span>&nbsp;<span class="ident" id="4886994"><a href="/image/png/writer.go.html#4886977">i</a></span><span class="op" id="4886995">++</span>&nbsp;<span class="op" id="4886998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4887002"><a href="/image/png/writer.go.html#4885861">cdat3</a></span><span class="op" id="4887007">[</span><span class="ident" id="4887008"><a href="/image/png/writer.go.html#4886977">i</a></span><span class="op" id="4887009">]</span>&nbsp;<span class="op" id="4887011">=</span>&nbsp;<span class="ident" id="4887013"><a href="/image/png/writer.go.html#4885801">cdat0</a></span><span class="op" id="4887018">[</span><span class="ident" id="4887019"><a href="/image/png/writer.go.html#4886977">i</a></span><span class="op" id="4887020">]</span>&nbsp;<span class="op" id="4887022">-</span>&nbsp;<span class="builtintype" id="4887024">uint8</span><span class="op" id="4887029">(</span><span class="op" id="4887030">(</span><span class="builtintype" id="4887031">int</span><span class="op" id="4887034">(</span><span class="ident" id="4887035"><a href="/image/png/writer.go.html#4885801">cdat0</a></span><span class="op" id="4887040">[</span><span class="ident" id="4887041"><a href="/image/png/writer.go.html#4886977">i</a></span><span class="op" id="4887042">-</span><span class="ident" id="4887043"><a href="/image/png/writer.go.html#4885421">bpp</a></span><span class="op" id="4887046">]</span><span class="op" id="4887047">)</span><span class="op" id="4887048">+</span><span class="builtintype" id="4887049">int</span><span class="op" id="4887052">(</span><span class="ident" id="4887053"><a href="/image/png/writer.go.html#4885901">pdat</a></span><span class="op" id="4887057">[</span><span class="ident" id="4887058"><a href="/image/png/writer.go.html#4886977">i</a></span><span class="op" id="4887059">]</span><span class="op" id="4887060">)</span><span class="op" id="4887061">)</span><span class="op" id="4887062">/</span><span class="num" id="4887063">2</span><span class="op" id="4887064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4887068"><a href="/image/png/writer.go.html#4885954">sum</a></span>&nbsp;<span class="op" id="4887072">+=</span>&nbsp;<span class="ident" id="4887075"><a href="/image/png/writer.go.html#4882791">abs8</a></span><span class="op" id="4887079">(</span><span class="ident" id="4887080"><a href="/image/png/writer.go.html#4885861">cdat3</a></span><span class="op" id="4887085">[</span><span class="ident" id="4887086"><a href="/image/png/writer.go.html#4886977">i</a></span><span class="op" id="4887087">]</span><span class="op" id="4887088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4887092">if</span>&nbsp;<span class="ident" id="4887095"><a href="/image/png/writer.go.html#4885954">sum</a></span>&nbsp;<span class="op" id="4887099">&gt;=</span>&nbsp;<span class="ident" id="4887102"><a href="/image/png/writer.go.html#4886049">best</a></span>&nbsp;<span class="op" id="4887107">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4887112">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4887120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4887123">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4887126">if</span>&nbsp;<span class="ident" id="4887129"><a href="/image/png/writer.go.html#4885954">sum</a></span>&nbsp;<span class="op" id="4887133">&lt;</span>&nbsp;<span class="ident" id="4887135"><a href="/image/png/writer.go.html#4886049">best</a></span>&nbsp;<span class="op" id="4887140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4887144"><a href="/image/png/writer.go.html#4886049">best</a></span>&nbsp;<span class="op" id="4887149">=</span>&nbsp;<span class="ident" id="4887151"><a href="/image/png/writer.go.html#4885954">sum</a></span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4887157"><a href="/image/png/writer.go.html#4886062">filter</a></span>&nbsp;<span class="op" id="4887164">=</span>&nbsp;<span class="ident" id="4887166"><a href="/image/png/reader.go.html#4861599">ftAverage</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4887177">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4887181">return</span>&nbsp;<span class="ident" id="4887188"><a href="/image/png/writer.go.html#4886062">filter</a></span><br>
<span class="lineno"></span><span class="op" id="4887195">}</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span><span class="keyword" id="4887198">func</span>&nbsp;<span class="ident" id="4887203">writeImage</span><span class="op" id="4887213">(</span><span class="ident" id="4887214">w</span>&nbsp;<span class="ident" id="4887216"><a href="/image/png/writer.go.html#4881576">io</a></span><span class="op" id="4887218">.</span><span class="ident" id="4887219">Writer</span><span class="op" id="4887225">,</span>&nbsp;<span class="ident" id="4887227">m</span>&nbsp;<span class="ident" id="4887229"><a href="/image/png/writer.go.html#4881552">image</a></span><span class="op" id="4887234">.</span><span class="ident" id="4887235">Image</span><span class="op" id="4887240">,</span>&nbsp;<span class="ident" id="4887242">cb</span>&nbsp;<span class="builtintype" id="4887245">int</span><span class="op" id="4887248">,</span>&nbsp;<span class="ident" id="4887250">level</span>&nbsp;<span class="builtintype" id="4887256">int</span><span class="op" id="4887259">)</span>&nbsp;<span class="builtintype" id="4887261">error</span>&nbsp;<span class="op" id="4887267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4887270">zw</span><span class="op" id="4887272">,</span>&nbsp;<span class="ident" id="4887274">err</span>&nbsp;<span class="op" id="4887278">:=</span>&nbsp;<span class="ident" id="4887281"><a href="/image/png/writer.go.html#4881521">zlib</a></span><span class="op" id="4887285">.</span><span class="ident" id="4887286">NewWriterLevel</span><span class="op" id="4887300">(</span><span class="ident" id="4887301"><a href="/image/png/writer.go.html#4887214">w</a></span><span class="op" id="4887302">,</span>&nbsp;<span class="ident" id="4887304"><a href="/image/png/writer.go.html#4887250">level</a></span><span class="op" id="4887309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4887312">if</span>&nbsp;<span class="ident" id="4887315"><a href="/image/png/writer.go.html#4887274">err</a></span>&nbsp;<span class="op" id="4887319">!=</span>&nbsp;<span class="ident" id="4887322">nil</span>&nbsp;<span class="op" id="4887326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4887330">return</span>&nbsp;<span class="ident" id="4887337"><a href="/image/png/writer.go.html#4887274">err</a></span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4887342">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4887345">defer</span>&nbsp;<span class="ident" id="4887351"><a href="/image/png/writer.go.html#4887270">zw</a></span><span class="op" id="4887353">.</span><span class="ident" id="4887354">Close</span><span class="op" id="4887359">(</span><span class="op" id="4887360">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4887364">bpp</span>&nbsp;<span class="op" id="4887368">:=</span>&nbsp;<span class="num" id="4887371">0</span>&nbsp;<span class="comment" id="4887373">//&nbsp;Bytes&nbsp;per&nbsp;pixel.</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4887395">switch</span>&nbsp;<span class="ident" id="4887402"><a href="/image/png/writer.go.html#4887242">cb</a></span>&nbsp;<span class="op" id="4887405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4887408">case</span>&nbsp;<span class="ident" id="4887413"><a href="/image/png/reader.go.html#4861422">cbG8</a></span><span class="op" id="4887417">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4887421"><a href="/image/png/writer.go.html#4887364">bpp</a></span>&nbsp;<span class="op" id="4887425">=</span>&nbsp;<span class="num" id="4887427">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4887430">case</span>&nbsp;<span class="ident" id="4887435"><a href="/image/png/reader.go.html#4861435">cbTC8</a></span><span class="op" id="4887440">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4887444"><a href="/image/png/writer.go.html#4887364">bpp</a></span>&nbsp;<span class="op" id="4887448">=</span>&nbsp;<span class="num" id="4887450">3</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4887453">case</span>&nbsp;<span class="ident" id="4887458"><a href="/image/png/reader.go.html#4861460">cbP8</a></span><span class="op" id="4887462">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4887466"><a href="/image/png/writer.go.html#4887364">bpp</a></span>&nbsp;<span class="op" id="4887470">=</span>&nbsp;<span class="num" id="4887472">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4887475">case</span>&nbsp;<span class="ident" id="4887480"><a href="/image/png/reader.go.html#4861466">cbTCA8</a></span><span class="op" id="4887486">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4887490"><a href="/image/png/writer.go.html#4887364">bpp</a></span>&nbsp;<span class="op" id="4887494">=</span>&nbsp;<span class="num" id="4887496">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4887499">case</span>&nbsp;<span class="ident" id="4887504"><a href="/image/png/reader.go.html#4861489">cbTC16</a></span><span class="op" id="4887510">:</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4887514"><a href="/image/png/writer.go.html#4887364">bpp</a></span>&nbsp;<span class="op" id="4887518">=</span>&nbsp;<span class="num" id="4887520">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4887523">case</span>&nbsp;<span class="ident" id="4887528"><a href="/image/png/reader.go.html#4861497">cbTCA16</a></span><span class="op" id="4887535">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4887539"><a href="/image/png/writer.go.html#4887364">bpp</a></span>&nbsp;<span class="op" id="4887543">=</span>&nbsp;<span class="num" id="4887545">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4887548">case</span>&nbsp;<span class="ident" id="4887553"><a href="/image/png/reader.go.html#4861474">cbG16</a></span><span class="op" id="4887558">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4887562"><a href="/image/png/writer.go.html#4887364">bpp</a></span>&nbsp;<span class="op" id="4887566">=</span>&nbsp;<span class="num" id="4887568">2</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4887571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4887574">//&nbsp;cr[*]&nbsp;and&nbsp;pr&nbsp;are&nbsp;the&nbsp;bytes&nbsp;for&nbsp;the&nbsp;current&nbsp;and&nbsp;previous&nbsp;row.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4887639">//&nbsp;cr[0]&nbsp;is&nbsp;unfiltered&nbsp;(or&nbsp;equivalently,&nbsp;filtered&nbsp;with&nbsp;the&nbsp;ftNone&nbsp;filter).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4887715">//&nbsp;cr[ft],&nbsp;for&nbsp;non-zero&nbsp;filter&nbsp;types&nbsp;ft,&nbsp;are&nbsp;buffers&nbsp;for&nbsp;transforming&nbsp;cr[0]&nbsp;under&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4887802">//&nbsp;other&nbsp;PNG&nbsp;filter&nbsp;types.&nbsp;These&nbsp;buffers&nbsp;are&nbsp;allocated&nbsp;once&nbsp;and&nbsp;re-used&nbsp;for&nbsp;each&nbsp;row.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4887889">//&nbsp;The&nbsp;+1&nbsp;is&nbsp;for&nbsp;the&nbsp;per-row&nbsp;filter&nbsp;type,&nbsp;which&nbsp;is&nbsp;at&nbsp;cr[*][0].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4887954">b</span>&nbsp;<span class="op" id="4887956">:=</span>&nbsp;<span class="ident" id="4887959"><a href="/image/png/writer.go.html#4887227">m</a></span><span class="op" id="4887960">.</span><span class="ident" id="4887961">Bounds</span><span class="op" id="4887967">(</span><span class="op" id="4887968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4887971">var</span>&nbsp;<span class="ident" id="4887975">cr</span>&nbsp;<span class="op" id="4887978">[</span><span class="ident" id="4887979"><a href="/image/png/reader.go.html#4861629">nFilter</a></span><span class="op" id="4887986">]</span><span class="op" id="4887987">[</span><span class="op" id="4887988">]</span><span class="builtintype" id="4887989">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4887996">for</span>&nbsp;<span class="ident" id="4888000">i</span>&nbsp;<span class="op" id="4888002">:=</span>&nbsp;<span class="keyword" id="4888005">range</span>&nbsp;<span class="ident" id="4888011"><a href="/image/png/writer.go.html#4887975">cr</a></span>&nbsp;<span class="op" id="4888014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4888018"><a href="/image/png/writer.go.html#4887975">cr</a></span><span class="op" id="4888020">[</span><span class="ident" id="4888021"><a href="/image/png/writer.go.html#4888000">i</a></span><span class="op" id="4888022">]</span>&nbsp;<span class="op" id="4888024">=</span>&nbsp;<span class="builtinfunc" id="4888026">make</span><span class="op" id="4888030">(</span><span class="op" id="4888031">[</span><span class="op" id="4888032">]</span><span class="builtintype" id="4888033">uint8</span><span class="op" id="4888038">,</span>&nbsp;<span class="num" id="4888040">1</span><span class="op" id="4888041">+</span><span class="ident" id="4888042"><a href="/image/png/writer.go.html#4887364">bpp</a></span><span class="op" id="4888045">*</span><span class="ident" id="4888046"><a href="/image/png/writer.go.html#4887954">b</a></span><span class="op" id="4888047">.</span><span class="ident" id="4888048">Dx</span><span class="op" id="4888050">(</span><span class="op" id="4888051">)</span><span class="op" id="4888052">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4888056"><a href="/image/png/writer.go.html#4887975">cr</a></span><span class="op" id="4888058">[</span><span class="ident" id="4888059"><a href="/image/png/writer.go.html#4888000">i</a></span><span class="op" id="4888060">]</span><span class="op" id="4888061">[</span><span class="num" id="4888062">0</span><span class="op" id="4888063">]</span>&nbsp;<span class="op" id="4888065">=</span>&nbsp;<span class="builtintype" id="4888067">uint8</span><span class="op" id="4888072">(</span><span class="ident" id="4888073"><a href="/image/png/writer.go.html#4888000">i</a></span><span class="op" id="4888074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4888077">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4888080">pr</span>&nbsp;<span class="op" id="4888083">:=</span>&nbsp;<span class="builtinfunc" id="4888086">make</span><span class="op" id="4888090">(</span><span class="op" id="4888091">[</span><span class="op" id="4888092">]</span><span class="builtintype" id="4888093">uint8</span><span class="op" id="4888098">,</span>&nbsp;<span class="num" id="4888100">1</span><span class="op" id="4888101">+</span><span class="ident" id="4888102"><a href="/image/png/writer.go.html#4887364">bpp</a></span><span class="op" id="4888105">*</span><span class="ident" id="4888106"><a href="/image/png/writer.go.html#4887954">b</a></span><span class="op" id="4888107">.</span><span class="ident" id="4888108">Dx</span><span class="op" id="4888110">(</span><span class="op" id="4888111">)</span><span class="op" id="4888112">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4888116">gray</span><span class="op" id="4888120">,</span>&nbsp;<span class="ident" id="4888122">_</span>&nbsp;<span class="op" id="4888124">:=</span>&nbsp;<span class="ident" id="4888127"><a href="/image/png/writer.go.html#4887227">m</a></span><span class="op" id="4888128">.</span><span class="op" id="4888129">(</span><span class="op" id="4888130">*</span><span class="ident" id="4888131"><a href="/image/png/writer.go.html#4881552">image</a></span><span class="op" id="4888136">.</span><span class="ident" id="4888137">Gray</span><span class="op" id="4888141">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4888144">rgba</span><span class="op" id="4888148">,</span>&nbsp;<span class="ident" id="4888150">_</span>&nbsp;<span class="op" id="4888152">:=</span>&nbsp;<span class="ident" id="4888155"><a href="/image/png/writer.go.html#4887227">m</a></span><span class="op" id="4888156">.</span><span class="op" id="4888157">(</span><span class="op" id="4888158">*</span><span class="ident" id="4888159"><a href="/image/png/writer.go.html#4881552">image</a></span><span class="op" id="4888164">.</span><span class="ident" id="4888165">RGBA</span><span class="op" id="4888169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4888172">paletted</span><span class="op" id="4888180">,</span>&nbsp;<span class="ident" id="4888182">_</span>&nbsp;<span class="op" id="4888184">:=</span>&nbsp;<span class="ident" id="4888187"><a href="/image/png/writer.go.html#4887227">m</a></span><span class="op" id="4888188">.</span><span class="op" id="4888189">(</span><span class="op" id="4888190">*</span><span class="ident" id="4888191"><a href="/image/png/writer.go.html#4881552">image</a></span><span class="op" id="4888196">.</span><span class="ident" id="4888197">Paletted</span><span class="op" id="4888205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4888208">nrgba</span><span class="op" id="4888213">,</span>&nbsp;<span class="ident" id="4888215">_</span>&nbsp;<span class="op" id="4888217">:=</span>&nbsp;<span class="ident" id="4888220"><a href="/image/png/writer.go.html#4887227">m</a></span><span class="op" id="4888221">.</span><span class="op" id="4888222">(</span><span class="op" id="4888223">*</span><span class="ident" id="4888224"><a href="/image/png/writer.go.html#4881552">image</a></span><span class="op" id="4888229">.</span><span class="ident" id="4888230">NRGBA</span><span class="op" id="4888235">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4888239">for</span>&nbsp;<span class="ident" id="4888243">y</span>&nbsp;<span class="op" id="4888245">:=</span>&nbsp;<span class="ident" id="4888248"><a href="/image/png/writer.go.html#4887954">b</a></span><span class="op" id="4888249">.</span><span class="ident" id="4888250">Min</span><span class="op" id="4888253">.</span><span class="ident" id="4888254">Y</span><span class="op" id="4888255">;</span>&nbsp;<span class="ident" id="4888257"><a href="/image/png/writer.go.html#4888243">y</a></span>&nbsp;<span class="op" id="4888259">&lt;</span>&nbsp;<span class="ident" id="4888261"><a href="/image/png/writer.go.html#4887954">b</a></span><span class="op" id="4888262">.</span><span class="ident" id="4888263">Max</span><span class="op" id="4888266">.</span><span class="ident" id="4888267">Y</span><span class="op" id="4888268">;</span>&nbsp;<span class="ident" id="4888270"><a href="/image/png/writer.go.html#4888243">y</a></span><span class="op" id="4888271">++</span>&nbsp;<span class="op" id="4888274">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4888278">//&nbsp;Convert&nbsp;from&nbsp;colors&nbsp;to&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4888313">i</span>&nbsp;<span class="op" id="4888315">:=</span>&nbsp;<span class="num" id="4888318">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4888322">switch</span>&nbsp;<span class="ident" id="4888329"><a href="/image/png/writer.go.html#4887242">cb</a></span>&nbsp;<span class="op" id="4888332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4888336">case</span>&nbsp;<span class="ident" id="4888341"><a href="/image/png/reader.go.html#4861422">cbG8</a></span><span class="op" id="4888345">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4888350">if</span>&nbsp;<span class="ident" id="4888353"><a href="/image/png/writer.go.html#4888116">gray</a></span>&nbsp;<span class="op" id="4888358">!=</span>&nbsp;<span class="ident" id="4888361">nil</span>&nbsp;<span class="op" id="4888365">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4888371">offset</span>&nbsp;<span class="op" id="4888378">:=</span>&nbsp;<span class="op" id="4888381">(</span><span class="ident" id="4888382"><a href="/image/png/writer.go.html#4888243">y</a></span>&nbsp;<span class="op" id="4888384">-</span>&nbsp;<span class="ident" id="4888386"><a href="/image/png/writer.go.html#4887954">b</a></span><span class="op" id="4888387">.</span><span class="ident" id="4888388">Min</span><span class="op" id="4888391">.</span><span class="ident" id="4888392">Y</span><span class="op" id="4888393">)</span>&nbsp;<span class="op" id="4888395">*</span>&nbsp;<span class="ident" id="4888397"><a href="/image/png/writer.go.html#4888116">gray</a></span><span class="op" id="4888401">.</span><span class="ident" id="4888402">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4888413">copy</span><span class="op" id="4888417">(</span><span class="ident" id="4888418"><a href="/image/png/writer.go.html#4887975">cr</a></span><span class="op" id="4888420">[</span><span class="num" id="4888421">0</span><span class="op" id="4888422">]</span><span class="op" id="4888423">[</span><span class="num" id="4888424">1</span><span class="op" id="4888425">:</span><span class="op" id="4888426">]</span><span class="op" id="4888427">,</span>&nbsp;<span class="ident" id="4888429"><a href="/image/png/writer.go.html#4888116">gray</a></span><span class="op" id="4888433">.</span><span class="ident" id="4888434">Pix</span><span class="op" id="4888437">[</span><span class="ident" id="4888438"><a href="/image/png/writer.go.html#4888371">offset</a></span><span class="op" id="4888444">:</span><span class="ident" id="4888445"><a href="/image/png/writer.go.html#4888371">offset</a></span><span class="op" id="4888451">+</span><span class="ident" id="4888452"><a href="/image/png/writer.go.html#4887954">b</a></span><span class="op" id="4888453">.</span><span class="ident" id="4888454">Dx</span><span class="op" id="4888456">(</span><span class="op" id="4888457">)</span><span class="op" id="4888458">]</span><span class="op" id="4888459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4888464">}</span>&nbsp;<span class="keyword" id="4888466">else</span>&nbsp;<span class="op" id="4888471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4888477">for</span>&nbsp;<span class="ident" id="4888481">x</span>&nbsp;<span class="op" id="4888483">:=</span>&nbsp;<span class="ident" id="4888486"><a href="/image/png/writer.go.html#4887954">b</a></span><span class="op" id="4888487">.</span><span class="ident" id="4888488">Min</span><span class="op" id="4888491">.</span><span class="ident" id="4888492">X</span><span class="op" id="4888493">;</span>&nbsp;<span class="ident" id="4888495"><a href="/image/png/writer.go.html#4888481">x</a></span>&nbsp;<span class="op" id="4888497">&lt;</span>&nbsp;<span class="ident" id="4888499"><a href="/image/png/writer.go.html#4887954">b</a></span><span class="op" id="4888500">.</span><span class="ident" id="4888501">Max</span><span class="op" id="4888504">.</span><span class="ident" id="4888505">X</span><span class="op" id="4888506">;</span>&nbsp;<span class="ident" id="4888508"><a href="/image/png/writer.go.html#4888481">x</a></span><span class="op" id="4888509">++</span>&nbsp;<span class="op" id="4888512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4888519">c</span>&nbsp;<span class="op" id="4888521">:=</span>&nbsp;<span class="ident" id="4888524"><a href="/image/png/writer.go.html#4881561">color</a></span><span class="op" id="4888529">.</span><span class="ident" id="4888530">GrayModel</span><span class="op" id="4888539">.</span><span class="ident" id="4888540">Convert</span><span class="op" id="4888547">(</span><span class="ident" id="4888548"><a href="/image/png/writer.go.html#4887227">m</a></span><span class="op" id="4888549">.</span><span class="ident" id="4888550">At</span><span class="op" id="4888552">(</span><span class="ident" id="4888553"><a href="/image/png/writer.go.html#4888481">x</a></span><span class="op" id="4888554">,</span>&nbsp;<span class="ident" id="4888556"><a href="/image/png/writer.go.html#4888243">y</a></span><span class="op" id="4888557">)</span><span class="op" id="4888558">)</span><span class="op" id="4888559">.</span><span class="op" id="4888560">(</span><span class="ident" id="4888561"><a href="/image/png/writer.go.html#4881561">color</a></span><span class="op" id="4888566">.</span><span class="ident" id="4888567">Gray</span><span class="op" id="4888571">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4888578"><a href="/image/png/writer.go.html#4887975">cr</a></span><span class="op" id="4888580">[</span><span class="num" id="4888581">0</span><span class="op" id="4888582">]</span><span class="op" id="4888583">[</span><span class="ident" id="4888584"><a href="/image/png/writer.go.html#4888313">i</a></span><span class="op" id="4888585">]</span>&nbsp;<span class="op" id="4888587">=</span>&nbsp;<span class="ident" id="4888589"><a href="/image/png/writer.go.html#4888519">c</a></span><span class="op" id="4888590">.</span><span class="ident" id="4888591">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4888598"><a href="/image/png/writer.go.html#4888313">i</a></span><span class="op" id="4888599">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4888606">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4888611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4888615">case</span>&nbsp;<span class="ident" id="4888620"><a href="/image/png/reader.go.html#4861435">cbTC8</a></span><span class="op" id="4888625">:</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4888630">//&nbsp;We&nbsp;have&nbsp;previously&nbsp;verified&nbsp;that&nbsp;the&nbsp;alpha&nbsp;value&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4888702">cr0</span>&nbsp;<span class="op" id="4888706">:=</span>&nbsp;<span class="ident" id="4888709"><a href="/image/png/writer.go.html#4887975">cr</a></span><span class="op" id="4888711">[</span><span class="num" id="4888712">0</span><span class="op" id="4888713">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4888718">stride</span><span class="op" id="4888724">,</span>&nbsp;<span class="ident" id="4888726">pix</span>&nbsp;<span class="op" id="4888730">:=</span>&nbsp;<span class="num" id="4888733">0</span><span class="op" id="4888734">,</span>&nbsp;<span class="op" id="4888736">[</span><span class="op" id="4888737">]</span><span class="builtintype" id="4888738">byte</span><span class="op" id="4888742">(</span><span class="ident" id="4888743">nil</span><span class="op" id="4888746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4888751">if</span>&nbsp;<span class="ident" id="4888754"><a href="/image/png/writer.go.html#4888144">rgba</a></span>&nbsp;<span class="op" id="4888759">!=</span>&nbsp;<span class="ident" id="4888762">nil</span>&nbsp;<span class="op" id="4888766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4888772"><a href="/image/png/writer.go.html#4888718">stride</a></span><span class="op" id="4888778">,</span>&nbsp;<span class="ident" id="4888780"><a href="/image/png/writer.go.html#4888726">pix</a></span>&nbsp;<span class="op" id="4888784">=</span>&nbsp;<span class="ident" id="4888786"><a href="/image/png/writer.go.html#4888144">rgba</a></span><span class="op" id="4888790">.</span><span class="ident" id="4888791">Stride</span><span class="op" id="4888797">,</span>&nbsp;<span class="ident" id="4888799"><a href="/image/png/writer.go.html#4888144">rgba</a></span><span class="op" id="4888803">.</span><span class="ident" id="4888804">Pix</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4888811">}</span>&nbsp;<span class="keyword" id="4888813">else</span>&nbsp;<span class="keyword" id="4888818">if</span>&nbsp;<span class="ident" id="4888821"><a href="/image/png/writer.go.html#4888208">nrgba</a></span>&nbsp;<span class="op" id="4888827">!=</span>&nbsp;<span class="ident" id="4888830">nil</span>&nbsp;<span class="op" id="4888834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4888840"><a href="/image/png/writer.go.html#4888718">stride</a></span><span class="op" id="4888846">,</span>&nbsp;<span class="ident" id="4888848"><a href="/image/png/writer.go.html#4888726">pix</a></span>&nbsp;<span class="op" id="4888852">=</span>&nbsp;<span class="ident" id="4888854"><a href="/image/png/writer.go.html#4888208">nrgba</a></span><span class="op" id="4888859">.</span><span class="ident" id="4888860">Stride</span><span class="op" id="4888866">,</span>&nbsp;<span class="ident" id="4888868"><a href="/image/png/writer.go.html#4888208">nrgba</a></span><span class="op" id="4888873">.</span><span class="ident" id="4888874">Pix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4888881">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4888886">if</span>&nbsp;<span class="ident" id="4888889"><a href="/image/png/writer.go.html#4888718">stride</a></span>&nbsp;<span class="op" id="4888896">!=</span>&nbsp;<span class="num" id="4888899">0</span>&nbsp;<span class="op" id="4888901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4888907">j0</span>&nbsp;<span class="op" id="4888910">:=</span>&nbsp;<span class="op" id="4888913">(</span><span class="ident" id="4888914"><a href="/image/png/writer.go.html#4888243">y</a></span>&nbsp;<span class="op" id="4888916">-</span>&nbsp;<span class="ident" id="4888918"><a href="/image/png/writer.go.html#4887954">b</a></span><span class="op" id="4888919">.</span><span class="ident" id="4888920">Min</span><span class="op" id="4888923">.</span><span class="ident" id="4888924">Y</span><span class="op" id="4888925">)</span>&nbsp;<span class="op" id="4888927">*</span>&nbsp;<span class="ident" id="4888929"><a href="/image/png/writer.go.html#4888718">stride</a></span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4888940">j1</span>&nbsp;<span class="op" id="4888943">:=</span>&nbsp;<span class="ident" id="4888946"><a href="/image/png/writer.go.html#4888907">j0</a></span>&nbsp;<span class="op" id="4888949">+</span>&nbsp;<span class="ident" id="4888951"><a href="/image/png/writer.go.html#4887954">b</a></span><span class="op" id="4888952">.</span><span class="ident" id="4888953">Dx</span><span class="op" id="4888955">(</span><span class="op" id="4888956">)</span><span class="op" id="4888957">*</span><span class="num" id="4888958">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4888964">for</span>&nbsp;<span class="ident" id="4888968">j</span>&nbsp;<span class="op" id="4888970">:=</span>&nbsp;<span class="ident" id="4888973"><a href="/image/png/writer.go.html#4888907">j0</a></span><span class="op" id="4888975">;</span>&nbsp;<span class="ident" id="4888977"><a href="/image/png/writer.go.html#4888968">j</a></span>&nbsp;<span class="op" id="4888979">&lt;</span>&nbsp;<span class="ident" id="4888981"><a href="/image/png/writer.go.html#4888940">j1</a></span><span class="op" id="4888983">;</span>&nbsp;<span class="ident" id="4888985"><a href="/image/png/writer.go.html#4888968">j</a></span>&nbsp;<span class="op" id="4888987">+=</span>&nbsp;<span class="num" id="4888990">4</span>&nbsp;<span class="op" id="4888992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4888999"><a href="/image/png/writer.go.html#4888702">cr0</a></span><span class="op" id="4889002">[</span><span class="ident" id="4889003"><a href="/image/png/writer.go.html#4888313">i</a></span><span class="op" id="4889004">+</span><span class="num" id="4889005">0</span><span class="op" id="4889006">]</span>&nbsp;<span class="op" id="4889008">=</span>&nbsp;<span class="ident" id="4889010"><a href="/image/png/writer.go.html#4888726">pix</a></span><span class="op" id="4889013">[</span><span class="ident" id="4889014"><a href="/image/png/writer.go.html#4888968">j</a></span><span class="op" id="4889015">+</span><span class="num" id="4889016">0</span><span class="op" id="4889017">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4889024"><a href="/image/png/writer.go.html#4888702">cr0</a></span><span class="op" id="4889027">[</span><span class="ident" id="4889028"><a href="/image/png/writer.go.html#4888313">i</a></span><span class="op" id="4889029">+</span><span class="num" id="4889030">1</span><span class="op" id="4889031">]</span>&nbsp;<span class="op" id="4889033">=</span>&nbsp;<span class="ident" id="4889035"><a href="/image/png/writer.go.html#4888726">pix</a></span><span class="op" id="4889038">[</span><span class="ident" id="4889039"><a href="/image/png/writer.go.html#4888968">j</a></span><span class="op" id="4889040">+</span><span class="num" id="4889041">1</span><span class="op" id="4889042">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4889049"><a href="/image/png/writer.go.html#4888702">cr0</a></span><span class="op" id="4889052">[</span><span class="ident" id="4889053"><a href="/image/png/writer.go.html#4888313">i</a></span><span class="op" id="4889054">+</span><span class="num" id="4889055">2</span><span class="op" id="4889056">]</span>&nbsp;<span class="op" id="4889058">=</span>&nbsp;<span class="ident" id="4889060"><a href="/image/png/writer.go.html#4888726">pix</a></span><span class="op" id="4889063">[</span><span class="ident" id="4889064"><a href="/image/png/writer.go.html#4888968">j</a></span><span class="op" id="4889065">+</span><span class="num" id="4889066">2</span><span class="op" id="4889067">]</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4889074"><a href="/image/png/writer.go.html#4888313">i</a></span>&nbsp;<span class="op" id="4889076">+=</span>&nbsp;<span class="num" id="4889079">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4889085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4889090">}</span>&nbsp;<span class="keyword" id="4889092">else</span>&nbsp;<span class="op" id="4889097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4889103">for</span>&nbsp;<span class="ident" id="4889107">x</span>&nbsp;<span class="op" id="4889109">:=</span>&nbsp;<span class="ident" id="4889112"><a href="/image/png/writer.go.html#4887954">b</a></span><span class="op" id="4889113">.</span><span class="ident" id="4889114">Min</span><span class="op" id="4889117">.</span><span class="ident" id="4889118">X</span><span class="op" id="4889119">;</span>&nbsp;<span class="ident" id="4889121"><a href="/image/png/writer.go.html#4889107">x</a></span>&nbsp;<span class="op" id="4889123">&lt;</span>&nbsp;<span class="ident" id="4889125"><a href="/image/png/writer.go.html#4887954">b</a></span><span class="op" id="4889126">.</span><span class="ident" id="4889127">Max</span><span class="op" id="4889130">.</span><span class="ident" id="4889131">X</span><span class="op" id="4889132">;</span>&nbsp;<span class="ident" id="4889134"><a href="/image/png/writer.go.html#4889107">x</a></span><span class="op" id="4889135">++</span>&nbsp;<span class="op" id="4889138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4889145">r</span><span class="op" id="4889146">,</span>&nbsp;<span class="ident" id="4889148">g</span><span class="op" id="4889149">,</span>&nbsp;<span class="ident" id="4889151">b</span><span class="op" id="4889152">,</span>&nbsp;<span class="ident" id="4889154">_</span>&nbsp;<span class="op" id="4889156">:=</span>&nbsp;<span class="ident" id="4889159"><a href="/image/png/writer.go.html#4887227">m</a></span><span class="op" id="4889160">.</span><span class="ident" id="4889161">At</span><span class="op" id="4889163">(</span><span class="ident" id="4889164"><a href="/image/png/writer.go.html#4889107">x</a></span><span class="op" id="4889165">,</span>&nbsp;<span class="ident" id="4889167"><a href="/image/png/writer.go.html#4888243">y</a></span><span class="op" id="4889168">)</span><span class="op" id="4889169">.</span><span class="ident" id="4889170">RGBA</span><span class="op" id="4889174">(</span><span class="op" id="4889175">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4889182"><a href="/image/png/writer.go.html#4888702">cr0</a></span><span class="op" id="4889185">[</span><span class="ident" id="4889186"><a href="/image/png/writer.go.html#4888313">i</a></span><span class="op" id="4889187">+</span><span class="num" id="4889188">0</span><span class="op" id="4889189">]</span>&nbsp;<span class="op" id="4889191">=</span>&nbsp;<span class="builtintype" id="4889193">uint8</span><span class="op" id="4889198">(</span><span class="ident" id="4889199"><a href="/image/png/writer.go.html#4889145">r</a></span>&nbsp;<span class="op" id="4889201">&gt;&gt;</span>&nbsp;<span class="num" id="4889204">8</span><span class="op" id="4889205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4889212"><a href="/image/png/writer.go.html#4888702">cr0</a></span><span class="op" id="4889215">[</span><span class="ident" id="4889216"><a href="/image/png/writer.go.html#4888313">i</a></span><span class="op" id="4889217">+</span><span class="num" id="4889218">1</span><span class="op" id="4889219">]</span>&nbsp;<span class="op" id="4889221">=</span>&nbsp;<span class="builtintype" id="4889223">uint8</span><span class="op" id="4889228">(</span><span class="ident" id="4889229"><a href="/image/png/writer.go.html#4889148">g</a></span>&nbsp;<span class="op" id="4889231">&gt;&gt;</span>&nbsp;<span class="num" id="4889234">8</span><span class="op" id="4889235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4889242"><a href="/image/png/writer.go.html#4888702">cr0</a></span><span class="op" id="4889245">[</span><span class="ident" id="4889246"><a href="/image/png/writer.go.html#4888313">i</a></span><span class="op" id="4889247">+</span><span class="num" id="4889248">2</span><span class="op" id="4889249">]</span>&nbsp;<span class="op" id="4889251">=</span>&nbsp;<span class="builtintype" id="4889253">uint8</span><span class="op" id="4889258">(</span><span class="ident" id="4889259"><a href="/image/png/writer.go.html#4889151">b</a></span>&nbsp;<span class="op" id="4889261">&gt;&gt;</span>&nbsp;<span class="num" id="4889264">8</span><span class="op" id="4889265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4889272"><a href="/image/png/writer.go.html#4888313">i</a></span>&nbsp;<span class="op" id="4889274">+=</span>&nbsp;<span class="num" id="4889277">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4889283">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4889288">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4889292">case</span>&nbsp;<span class="ident" id="4889297"><a href="/image/png/reader.go.html#4861460">cbP8</a></span><span class="op" id="4889301">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4889306">if</span>&nbsp;<span class="ident" id="4889309"><a href="/image/png/writer.go.html#4888172">paletted</a></span>&nbsp;<span class="op" id="4889318">!=</span>&nbsp;<span class="ident" id="4889321">nil</span>&nbsp;<span class="op" id="4889325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4889331">offset</span>&nbsp;<span class="op" id="4889338">:=</span>&nbsp;<span class="op" id="4889341">(</span><span class="ident" id="4889342"><a href="/image/png/writer.go.html#4888243">y</a></span>&nbsp;<span class="op" id="4889344">-</span>&nbsp;<span class="ident" id="4889346"><a href="/image/png/writer.go.html#4887954">b</a></span><span class="op" id="4889347">.</span><span class="ident" id="4889348">Min</span><span class="op" id="4889351">.</span><span class="ident" id="4889352">Y</span><span class="op" id="4889353">)</span>&nbsp;<span class="op" id="4889355">*</span>&nbsp;<span class="ident" id="4889357"><a href="/image/png/writer.go.html#4888172">paletted</a></span><span class="op" id="4889365">.</span><span class="ident" id="4889366">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4889377">copy</span><span class="op" id="4889381">(</span><span class="ident" id="4889382"><a href="/image/png/writer.go.html#4887975">cr</a></span><span class="op" id="4889384">[</span><span class="num" id="4889385">0</span><span class="op" id="4889386">]</span><span class="op" id="4889387">[</span><span class="num" id="4889388">1</span><span class="op" id="4889389">:</span><span class="op" id="4889390">]</span><span class="op" id="4889391">,</span>&nbsp;<span class="ident" id="4889393"><a href="/image/png/writer.go.html#4888172">paletted</a></span><span class="op" id="4889401">.</span><span class="ident" id="4889402">Pix</span><span class="op" id="4889405">[</span><span class="ident" id="4889406"><a href="/image/png/writer.go.html#4889331">offset</a></span><span class="op" id="4889412">:</span><span class="ident" id="4889413"><a href="/image/png/writer.go.html#4889331">offset</a></span><span class="op" id="4889419">+</span><span class="ident" id="4889420"><a href="/image/png/writer.go.html#4887954">b</a></span><span class="op" id="4889421">.</span><span class="ident" id="4889422">Dx</span><span class="op" id="4889424">(</span><span class="op" id="4889425">)</span><span class="op" id="4889426">]</span><span class="op" id="4889427">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4889432">}</span>&nbsp;<span class="keyword" id="4889434">else</span>&nbsp;<span class="op" id="4889439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4889445">pi</span>&nbsp;<span class="op" id="4889448">:=</span>&nbsp;<span class="ident" id="4889451"><a href="/image/png/writer.go.html#4887227">m</a></span><span class="op" id="4889452">.</span><span class="op" id="4889453">(</span><span class="ident" id="4889454"><a href="/image/png/writer.go.html#4881552">image</a></span><span class="op" id="4889459">.</span><span class="ident" id="4889460">PalettedImage</span><span class="op" id="4889473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4889479">for</span>&nbsp;<span class="ident" id="4889483">x</span>&nbsp;<span class="op" id="4889485">:=</span>&nbsp;<span class="ident" id="4889488"><a href="/image/png/writer.go.html#4887954">b</a></span><span class="op" id="4889489">.</span><span class="ident" id="4889490">Min</span><span class="op" id="4889493">.</span><span class="ident" id="4889494">X</span><span class="op" id="4889495">;</span>&nbsp;<span class="ident" id="4889497"><a href="/image/png/writer.go.html#4889483">x</a></span>&nbsp;<span class="op" id="4889499">&lt;</span>&nbsp;<span class="ident" id="4889501"><a href="/image/png/writer.go.html#4887954">b</a></span><span class="op" id="4889502">.</span><span class="ident" id="4889503">Max</span><span class="op" id="4889506">.</span><span class="ident" id="4889507">X</span><span class="op" id="4889508">;</span>&nbsp;<span class="ident" id="4889510"><a href="/image/png/writer.go.html#4889483">x</a></span><span class="op" id="4889511">++</span>&nbsp;<span class="op" id="4889514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4889521"><a href="/image/png/writer.go.html#4887975">cr</a></span><span class="op" id="4889523">[</span><span class="num" id="4889524">0</span><span class="op" id="4889525">]</span><span class="op" id="4889526">[</span><span class="ident" id="4889527"><a href="/image/png/writer.go.html#4888313">i</a></span><span class="op" id="4889528">]</span>&nbsp;<span class="op" id="4889530">=</span>&nbsp;<span class="ident" id="4889532"><a href="/image/png/writer.go.html#4889445">pi</a></span><span class="op" id="4889534">.</span><span class="ident" id="4889535">ColorIndexAt</span><span class="op" id="4889547">(</span><span class="ident" id="4889548"><a href="/image/png/writer.go.html#4889483">x</a></span><span class="op" id="4889549">,</span>&nbsp;<span class="ident" id="4889551"><a href="/image/png/writer.go.html#4888243">y</a></span><span class="op" id="4889552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4889559"><a href="/image/png/writer.go.html#4888313">i</a></span>&nbsp;<span class="op" id="4889561">+=</span>&nbsp;<span class="num" id="4889564">1</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4889570">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4889575">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4889579">case</span>&nbsp;<span class="ident" id="4889584"><a href="/image/png/reader.go.html#4861466">cbTCA8</a></span><span class="op" id="4889590">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4889595">if</span>&nbsp;<span class="ident" id="4889598"><a href="/image/png/writer.go.html#4888208">nrgba</a></span>&nbsp;<span class="op" id="4889604">!=</span>&nbsp;<span class="ident" id="4889607">nil</span>&nbsp;<span class="op" id="4889611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4889617">offset</span>&nbsp;<span class="op" id="4889624">:=</span>&nbsp;<span class="op" id="4889627">(</span><span class="ident" id="4889628"><a href="/image/png/writer.go.html#4888243">y</a></span>&nbsp;<span class="op" id="4889630">-</span>&nbsp;<span class="ident" id="4889632"><a href="/image/png/writer.go.html#4887954">b</a></span><span class="op" id="4889633">.</span><span class="ident" id="4889634">Min</span><span class="op" id="4889637">.</span><span class="ident" id="4889638">Y</span><span class="op" id="4889639">)</span>&nbsp;<span class="op" id="4889641">*</span>&nbsp;<span class="ident" id="4889643"><a href="/image/png/writer.go.html#4888208">nrgba</a></span><span class="op" id="4889648">.</span><span class="ident" id="4889649">Stride</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4889660">copy</span><span class="op" id="4889664">(</span><span class="ident" id="4889665"><a href="/image/png/writer.go.html#4887975">cr</a></span><span class="op" id="4889667">[</span><span class="num" id="4889668">0</span><span class="op" id="4889669">]</span><span class="op" id="4889670">[</span><span class="num" id="4889671">1</span><span class="op" id="4889672">:</span><span class="op" id="4889673">]</span><span class="op" id="4889674">,</span>&nbsp;<span class="ident" id="4889676"><a href="/image/png/writer.go.html#4888208">nrgba</a></span><span class="op" id="4889681">.</span><span class="ident" id="4889682">Pix</span><span class="op" id="4889685">[</span><span class="ident" id="4889686"><a href="/image/png/writer.go.html#4889617">offset</a></span><span class="op" id="4889692">:</span><span class="ident" id="4889693"><a href="/image/png/writer.go.html#4889617">offset</a></span><span class="op" id="4889699">+</span><span class="ident" id="4889700"><a href="/image/png/writer.go.html#4887954">b</a></span><span class="op" id="4889701">.</span><span class="ident" id="4889702">Dx</span><span class="op" id="4889704">(</span><span class="op" id="4889705">)</span><span class="op" id="4889706">*</span><span class="num" id="4889707">4</span><span class="op" id="4889708">]</span><span class="op" id="4889709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4889714">}</span>&nbsp;<span class="keyword" id="4889716">else</span>&nbsp;<span class="op" id="4889721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4889727">//&nbsp;Convert&nbsp;from&nbsp;image.Image&nbsp;(which&nbsp;is&nbsp;alpha-premultiplied)&nbsp;to&nbsp;PNG&#39;s&nbsp;non-alpha-premultiplied.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4889824">for</span>&nbsp;<span class="ident" id="4889828">x</span>&nbsp;<span class="op" id="4889830">:=</span>&nbsp;<span class="ident" id="4889833"><a href="/image/png/writer.go.html#4887954">b</a></span><span class="op" id="4889834">.</span><span class="ident" id="4889835">Min</span><span class="op" id="4889838">.</span><span class="ident" id="4889839">X</span><span class="op" id="4889840">;</span>&nbsp;<span class="ident" id="4889842"><a href="/image/png/writer.go.html#4889828">x</a></span>&nbsp;<span class="op" id="4889844">&lt;</span>&nbsp;<span class="ident" id="4889846"><a href="/image/png/writer.go.html#4887954">b</a></span><span class="op" id="4889847">.</span><span class="ident" id="4889848">Max</span><span class="op" id="4889851">.</span><span class="ident" id="4889852">X</span><span class="op" id="4889853">;</span>&nbsp;<span class="ident" id="4889855"><a href="/image/png/writer.go.html#4889828">x</a></span><span class="op" id="4889856">++</span>&nbsp;<span class="op" id="4889859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4889866">c</span>&nbsp;<span class="op" id="4889868">:=</span>&nbsp;<span class="ident" id="4889871"><a href="/image/png/writer.go.html#4881561">color</a></span><span class="op" id="4889876">.</span><span class="ident" id="4889877">NRGBAModel</span><span class="op" id="4889887">.</span><span class="ident" id="4889888">Convert</span><span class="op" id="4889895">(</span><span class="ident" id="4889896"><a href="/image/png/writer.go.html#4887227">m</a></span><span class="op" id="4889897">.</span><span class="ident" id="4889898">At</span><span class="op" id="4889900">(</span><span class="ident" id="4889901"><a href="/image/png/writer.go.html#4889828">x</a></span><span class="op" id="4889902">,</span>&nbsp;<span class="ident" id="4889904"><a href="/image/png/writer.go.html#4888243">y</a></span><span class="op" id="4889905">)</span><span class="op" id="4889906">)</span><span class="op" id="4889907">.</span><span class="op" id="4889908">(</span><span class="ident" id="4889909"><a href="/image/png/writer.go.html#4881561">color</a></span><span class="op" id="4889914">.</span><span class="ident" id="4889915">NRGBA</span><span class="op" id="4889920">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4889927"><a href="/image/png/writer.go.html#4887975">cr</a></span><span class="op" id="4889929">[</span><span class="num" id="4889930">0</span><span class="op" id="4889931">]</span><span class="op" id="4889932">[</span><span class="ident" id="4889933"><a href="/image/png/writer.go.html#4888313">i</a></span><span class="op" id="4889934">+</span><span class="num" id="4889935">0</span><span class="op" id="4889936">]</span>&nbsp;<span class="op" id="4889938">=</span>&nbsp;<span class="ident" id="4889940"><a href="/image/png/writer.go.html#4889866">c</a></span><span class="op" id="4889941">.</span><span class="ident" id="4889942">R</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4889949"><a href="/image/png/writer.go.html#4887975">cr</a></span><span class="op" id="4889951">[</span><span class="num" id="4889952">0</span><span class="op" id="4889953">]</span><span class="op" id="4889954">[</span><span class="ident" id="4889955"><a href="/image/png/writer.go.html#4888313">i</a></span><span class="op" id="4889956">+</span><span class="num" id="4889957">1</span><span class="op" id="4889958">]</span>&nbsp;<span class="op" id="4889960">=</span>&nbsp;<span class="ident" id="4889962"><a href="/image/png/writer.go.html#4889866">c</a></span><span class="op" id="4889963">.</span><span class="ident" id="4889964">G</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4889971"><a href="/image/png/writer.go.html#4887975">cr</a></span><span class="op" id="4889973">[</span><span class="num" id="4889974">0</span><span class="op" id="4889975">]</span><span class="op" id="4889976">[</span><span class="ident" id="4889977"><a href="/image/png/writer.go.html#4888313">i</a></span><span class="op" id="4889978">+</span><span class="num" id="4889979">2</span><span class="op" id="4889980">]</span>&nbsp;<span class="op" id="4889982">=</span>&nbsp;<span class="ident" id="4889984"><a href="/image/png/writer.go.html#4889866">c</a></span><span class="op" id="4889985">.</span><span class="ident" id="4889986">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4889993"><a href="/image/png/writer.go.html#4887975">cr</a></span><span class="op" id="4889995">[</span><span class="num" id="4889996">0</span><span class="op" id="4889997">]</span><span class="op" id="4889998">[</span><span class="ident" id="4889999"><a href="/image/png/writer.go.html#4888313">i</a></span><span class="op" id="4890000">+</span><span class="num" id="4890001">3</span><span class="op" id="4890002">]</span>&nbsp;<span class="op" id="4890004">=</span>&nbsp;<span class="ident" id="4890006"><a href="/image/png/writer.go.html#4889866">c</a></span><span class="op" id="4890007">.</span><span class="ident" id="4890008">A</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4890015"><a href="/image/png/writer.go.html#4888313">i</a></span>&nbsp;<span class="op" id="4890017">+=</span>&nbsp;<span class="num" id="4890020">4</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4890026">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4890031">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4890035">case</span>&nbsp;<span class="ident" id="4890040"><a href="/image/png/reader.go.html#4861474">cbG16</a></span><span class="op" id="4890045">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4890050">for</span>&nbsp;<span class="ident" id="4890054">x</span>&nbsp;<span class="op" id="4890056">:=</span>&nbsp;<span class="ident" id="4890059"><a href="/image/png/writer.go.html#4887954">b</a></span><span class="op" id="4890060">.</span><span class="ident" id="4890061">Min</span><span class="op" id="4890064">.</span><span class="ident" id="4890065">X</span><span class="op" id="4890066">;</span>&nbsp;<span class="ident" id="4890068"><a href="/image/png/writer.go.html#4890054">x</a></span>&nbsp;<span class="op" id="4890070">&lt;</span>&nbsp;<span class="ident" id="4890072"><a href="/image/png/writer.go.html#4887954">b</a></span><span class="op" id="4890073">.</span><span class="ident" id="4890074">Max</span><span class="op" id="4890077">.</span><span class="ident" id="4890078">X</span><span class="op" id="4890079">;</span>&nbsp;<span class="ident" id="4890081"><a href="/image/png/writer.go.html#4890054">x</a></span><span class="op" id="4890082">++</span>&nbsp;<span class="op" id="4890085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4890091">c</span>&nbsp;<span class="op" id="4890093">:=</span>&nbsp;<span class="ident" id="4890096"><a href="/image/png/writer.go.html#4881561">color</a></span><span class="op" id="4890101">.</span><span class="ident" id="4890102">Gray16Model</span><span class="op" id="4890113">.</span><span class="ident" id="4890114">Convert</span><span class="op" id="4890121">(</span><span class="ident" id="4890122"><a href="/image/png/writer.go.html#4887227">m</a></span><span class="op" id="4890123">.</span><span class="ident" id="4890124">At</span><span class="op" id="4890126">(</span><span class="ident" id="4890127"><a href="/image/png/writer.go.html#4890054">x</a></span><span class="op" id="4890128">,</span>&nbsp;<span class="ident" id="4890130"><a href="/image/png/writer.go.html#4888243">y</a></span><span class="op" id="4890131">)</span><span class="op" id="4890132">)</span><span class="op" id="4890133">.</span><span class="op" id="4890134">(</span><span class="ident" id="4890135"><a href="/image/png/writer.go.html#4881561">color</a></span><span class="op" id="4890140">.</span><span class="ident" id="4890141">Gray16</span><span class="op" id="4890147">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4890153"><a href="/image/png/writer.go.html#4887975">cr</a></span><span class="op" id="4890155">[</span><span class="num" id="4890156">0</span><span class="op" id="4890157">]</span><span class="op" id="4890158">[</span><span class="ident" id="4890159"><a href="/image/png/writer.go.html#4888313">i</a></span><span class="op" id="4890160">+</span><span class="num" id="4890161">0</span><span class="op" id="4890162">]</span>&nbsp;<span class="op" id="4890164">=</span>&nbsp;<span class="builtintype" id="4890166">uint8</span><span class="op" id="4890171">(</span><span class="ident" id="4890172"><a href="/image/png/writer.go.html#4890091">c</a></span><span class="op" id="4890173">.</span><span class="ident" id="4890174">Y</span>&nbsp;<span class="op" id="4890176">&gt;&gt;</span>&nbsp;<span class="num" id="4890179">8</span><span class="op" id="4890180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4890186"><a href="/image/png/writer.go.html#4887975">cr</a></span><span class="op" id="4890188">[</span><span class="num" id="4890189">0</span><span class="op" id="4890190">]</span><span class="op" id="4890191">[</span><span class="ident" id="4890192"><a href="/image/png/writer.go.html#4888313">i</a></span><span class="op" id="4890193">+</span><span class="num" id="4890194">1</span><span class="op" id="4890195">]</span>&nbsp;<span class="op" id="4890197">=</span>&nbsp;<span class="builtintype" id="4890199">uint8</span><span class="op" id="4890204">(</span><span class="ident" id="4890205"><a href="/image/png/writer.go.html#4890091">c</a></span><span class="op" id="4890206">.</span><span class="ident" id="4890207">Y</span><span class="op" id="4890208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4890214"><a href="/image/png/writer.go.html#4888313">i</a></span>&nbsp;<span class="op" id="4890216">+=</span>&nbsp;<span class="num" id="4890219">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4890224">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4890228">case</span>&nbsp;<span class="ident" id="4890233"><a href="/image/png/reader.go.html#4861489">cbTC16</a></span><span class="op" id="4890239">:</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4890244">//&nbsp;We&nbsp;have&nbsp;previously&nbsp;verified&nbsp;that&nbsp;the&nbsp;alpha&nbsp;value&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4890316">for</span>&nbsp;<span class="ident" id="4890320">x</span>&nbsp;<span class="op" id="4890322">:=</span>&nbsp;<span class="ident" id="4890325"><a href="/image/png/writer.go.html#4887954">b</a></span><span class="op" id="4890326">.</span><span class="ident" id="4890327">Min</span><span class="op" id="4890330">.</span><span class="ident" id="4890331">X</span><span class="op" id="4890332">;</span>&nbsp;<span class="ident" id="4890334"><a href="/image/png/writer.go.html#4890320">x</a></span>&nbsp;<span class="op" id="4890336">&lt;</span>&nbsp;<span class="ident" id="4890338"><a href="/image/png/writer.go.html#4887954">b</a></span><span class="op" id="4890339">.</span><span class="ident" id="4890340">Max</span><span class="op" id="4890343">.</span><span class="ident" id="4890344">X</span><span class="op" id="4890345">;</span>&nbsp;<span class="ident" id="4890347"><a href="/image/png/writer.go.html#4890320">x</a></span><span class="op" id="4890348">++</span>&nbsp;<span class="op" id="4890351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4890357">r</span><span class="op" id="4890358">,</span>&nbsp;<span class="ident" id="4890360">g</span><span class="op" id="4890361">,</span>&nbsp;<span class="ident" id="4890363">b</span><span class="op" id="4890364">,</span>&nbsp;<span class="ident" id="4890366">_</span>&nbsp;<span class="op" id="4890368">:=</span>&nbsp;<span class="ident" id="4890371"><a href="/image/png/writer.go.html#4887227">m</a></span><span class="op" id="4890372">.</span><span class="ident" id="4890373">At</span><span class="op" id="4890375">(</span><span class="ident" id="4890376"><a href="/image/png/writer.go.html#4890320">x</a></span><span class="op" id="4890377">,</span>&nbsp;<span class="ident" id="4890379"><a href="/image/png/writer.go.html#4888243">y</a></span><span class="op" id="4890380">)</span><span class="op" id="4890381">.</span><span class="ident" id="4890382">RGBA</span><span class="op" id="4890386">(</span><span class="op" id="4890387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4890393"><a href="/image/png/writer.go.html#4887975">cr</a></span><span class="op" id="4890395">[</span><span class="num" id="4890396">0</span><span class="op" id="4890397">]</span><span class="op" id="4890398">[</span><span class="ident" id="4890399"><a href="/image/png/writer.go.html#4888313">i</a></span><span class="op" id="4890400">+</span><span class="num" id="4890401">0</span><span class="op" id="4890402">]</span>&nbsp;<span class="op" id="4890404">=</span>&nbsp;<span class="builtintype" id="4890406">uint8</span><span class="op" id="4890411">(</span><span class="ident" id="4890412"><a href="/image/png/writer.go.html#4890357">r</a></span>&nbsp;<span class="op" id="4890414">&gt;&gt;</span>&nbsp;<span class="num" id="4890417">8</span><span class="op" id="4890418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4890424"><a href="/image/png/writer.go.html#4887975">cr</a></span><span class="op" id="4890426">[</span><span class="num" id="4890427">0</span><span class="op" id="4890428">]</span><span class="op" id="4890429">[</span><span class="ident" id="4890430"><a href="/image/png/writer.go.html#4888313">i</a></span><span class="op" id="4890431">+</span><span class="num" id="4890432">1</span><span class="op" id="4890433">]</span>&nbsp;<span class="op" id="4890435">=</span>&nbsp;<span class="builtintype" id="4890437">uint8</span><span class="op" id="4890442">(</span><span class="ident" id="4890443"><a href="/image/png/writer.go.html#4890357">r</a></span><span class="op" id="4890444">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4890450"><a href="/image/png/writer.go.html#4887975">cr</a></span><span class="op" id="4890452">[</span><span class="num" id="4890453">0</span><span class="op" id="4890454">]</span><span class="op" id="4890455">[</span><span class="ident" id="4890456"><a href="/image/png/writer.go.html#4888313">i</a></span><span class="op" id="4890457">+</span><span class="num" id="4890458">2</span><span class="op" id="4890459">]</span>&nbsp;<span class="op" id="4890461">=</span>&nbsp;<span class="builtintype" id="4890463">uint8</span><span class="op" id="4890468">(</span><span class="ident" id="4890469"><a href="/image/png/writer.go.html#4890360">g</a></span>&nbsp;<span class="op" id="4890471">&gt;&gt;</span>&nbsp;<span class="num" id="4890474">8</span><span class="op" id="4890475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4890481"><a href="/image/png/writer.go.html#4887975">cr</a></span><span class="op" id="4890483">[</span><span class="num" id="4890484">0</span><span class="op" id="4890485">]</span><span class="op" id="4890486">[</span><span class="ident" id="4890487"><a href="/image/png/writer.go.html#4888313">i</a></span><span class="op" id="4890488">+</span><span class="num" id="4890489">3</span><span class="op" id="4890490">]</span>&nbsp;<span class="op" id="4890492">=</span>&nbsp;<span class="builtintype" id="4890494">uint8</span><span class="op" id="4890499">(</span><span class="ident" id="4890500"><a href="/image/png/writer.go.html#4890360">g</a></span><span class="op" id="4890501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4890507"><a href="/image/png/writer.go.html#4887975">cr</a></span><span class="op" id="4890509">[</span><span class="num" id="4890510">0</span><span class="op" id="4890511">]</span><span class="op" id="4890512">[</span><span class="ident" id="4890513"><a href="/image/png/writer.go.html#4888313">i</a></span><span class="op" id="4890514">+</span><span class="num" id="4890515">4</span><span class="op" id="4890516">]</span>&nbsp;<span class="op" id="4890518">=</span>&nbsp;<span class="builtintype" id="4890520">uint8</span><span class="op" id="4890525">(</span><span class="ident" id="4890526"><a href="/image/png/writer.go.html#4890363">b</a></span>&nbsp;<span class="op" id="4890528">&gt;&gt;</span>&nbsp;<span class="num" id="4890531">8</span><span class="op" id="4890532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4890538"><a href="/image/png/writer.go.html#4887975">cr</a></span><span class="op" id="4890540">[</span><span class="num" id="4890541">0</span><span class="op" id="4890542">]</span><span class="op" id="4890543">[</span><span class="ident" id="4890544"><a href="/image/png/writer.go.html#4888313">i</a></span><span class="op" id="4890545">+</span><span class="num" id="4890546">5</span><span class="op" id="4890547">]</span>&nbsp;<span class="op" id="4890549">=</span>&nbsp;<span class="builtintype" id="4890551">uint8</span><span class="op" id="4890556">(</span><span class="ident" id="4890557"><a href="/image/png/writer.go.html#4890363">b</a></span><span class="op" id="4890558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4890564"><a href="/image/png/writer.go.html#4888313">i</a></span>&nbsp;<span class="op" id="4890566">+=</span>&nbsp;<span class="num" id="4890569">6</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4890574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4890578">case</span>&nbsp;<span class="ident" id="4890583"><a href="/image/png/reader.go.html#4861497">cbTCA16</a></span><span class="op" id="4890590">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4890595">//&nbsp;Convert&nbsp;from&nbsp;image.Image&nbsp;(which&nbsp;is&nbsp;alpha-premultiplied)&nbsp;to&nbsp;PNG&#39;s&nbsp;non-alpha-premultiplied.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4890691">for</span>&nbsp;<span class="ident" id="4890695">x</span>&nbsp;<span class="op" id="4890697">:=</span>&nbsp;<span class="ident" id="4890700"><a href="/image/png/writer.go.html#4887954">b</a></span><span class="op" id="4890701">.</span><span class="ident" id="4890702">Min</span><span class="op" id="4890705">.</span><span class="ident" id="4890706">X</span><span class="op" id="4890707">;</span>&nbsp;<span class="ident" id="4890709"><a href="/image/png/writer.go.html#4890695">x</a></span>&nbsp;<span class="op" id="4890711">&lt;</span>&nbsp;<span class="ident" id="4890713"><a href="/image/png/writer.go.html#4887954">b</a></span><span class="op" id="4890714">.</span><span class="ident" id="4890715">Max</span><span class="op" id="4890718">.</span><span class="ident" id="4890719">X</span><span class="op" id="4890720">;</span>&nbsp;<span class="ident" id="4890722"><a href="/image/png/writer.go.html#4890695">x</a></span><span class="op" id="4890723">++</span>&nbsp;<span class="op" id="4890726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4890732">c</span>&nbsp;<span class="op" id="4890734">:=</span>&nbsp;<span class="ident" id="4890737"><a href="/image/png/writer.go.html#4881561">color</a></span><span class="op" id="4890742">.</span><span class="ident" id="4890743">NRGBA64Model</span><span class="op" id="4890755">.</span><span class="ident" id="4890756">Convert</span><span class="op" id="4890763">(</span><span class="ident" id="4890764"><a href="/image/png/writer.go.html#4887227">m</a></span><span class="op" id="4890765">.</span><span class="ident" id="4890766">At</span><span class="op" id="4890768">(</span><span class="ident" id="4890769"><a href="/image/png/writer.go.html#4890695">x</a></span><span class="op" id="4890770">,</span>&nbsp;<span class="ident" id="4890772"><a href="/image/png/writer.go.html#4888243">y</a></span><span class="op" id="4890773">)</span><span class="op" id="4890774">)</span><span class="op" id="4890775">.</span><span class="op" id="4890776">(</span><span class="ident" id="4890777"><a href="/image/png/writer.go.html#4881561">color</a></span><span class="op" id="4890782">.</span><span class="ident" id="4890783">NRGBA64</span><span class="op" id="4890790">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4890796"><a href="/image/png/writer.go.html#4887975">cr</a></span><span class="op" id="4890798">[</span><span class="num" id="4890799">0</span><span class="op" id="4890800">]</span><span class="op" id="4890801">[</span><span class="ident" id="4890802"><a href="/image/png/writer.go.html#4888313">i</a></span><span class="op" id="4890803">+</span><span class="num" id="4890804">0</span><span class="op" id="4890805">]</span>&nbsp;<span class="op" id="4890807">=</span>&nbsp;<span class="builtintype" id="4890809">uint8</span><span class="op" id="4890814">(</span><span class="ident" id="4890815"><a href="/image/png/writer.go.html#4890732">c</a></span><span class="op" id="4890816">.</span><span class="ident" id="4890817">R</span>&nbsp;<span class="op" id="4890819">&gt;&gt;</span>&nbsp;<span class="num" id="4890822">8</span><span class="op" id="4890823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4890829"><a href="/image/png/writer.go.html#4887975">cr</a></span><span class="op" id="4890831">[</span><span class="num" id="4890832">0</span><span class="op" id="4890833">]</span><span class="op" id="4890834">[</span><span class="ident" id="4890835"><a href="/image/png/writer.go.html#4888313">i</a></span><span class="op" id="4890836">+</span><span class="num" id="4890837">1</span><span class="op" id="4890838">]</span>&nbsp;<span class="op" id="4890840">=</span>&nbsp;<span class="builtintype" id="4890842">uint8</span><span class="op" id="4890847">(</span><span class="ident" id="4890848"><a href="/image/png/writer.go.html#4890732">c</a></span><span class="op" id="4890849">.</span><span class="ident" id="4890850">R</span><span class="op" id="4890851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4890857"><a href="/image/png/writer.go.html#4887975">cr</a></span><span class="op" id="4890859">[</span><span class="num" id="4890860">0</span><span class="op" id="4890861">]</span><span class="op" id="4890862">[</span><span class="ident" id="4890863"><a href="/image/png/writer.go.html#4888313">i</a></span><span class="op" id="4890864">+</span><span class="num" id="4890865">2</span><span class="op" id="4890866">]</span>&nbsp;<span class="op" id="4890868">=</span>&nbsp;<span class="builtintype" id="4890870">uint8</span><span class="op" id="4890875">(</span><span class="ident" id="4890876"><a href="/image/png/writer.go.html#4890732">c</a></span><span class="op" id="4890877">.</span><span class="ident" id="4890878">G</span>&nbsp;<span class="op" id="4890880">&gt;&gt;</span>&nbsp;<span class="num" id="4890883">8</span><span class="op" id="4890884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4890890"><a href="/image/png/writer.go.html#4887975">cr</a></span><span class="op" id="4890892">[</span><span class="num" id="4890893">0</span><span class="op" id="4890894">]</span><span class="op" id="4890895">[</span><span class="ident" id="4890896"><a href="/image/png/writer.go.html#4888313">i</a></span><span class="op" id="4890897">+</span><span class="num" id="4890898">3</span><span class="op" id="4890899">]</span>&nbsp;<span class="op" id="4890901">=</span>&nbsp;<span class="builtintype" id="4890903">uint8</span><span class="op" id="4890908">(</span><span class="ident" id="4890909"><a href="/image/png/writer.go.html#4890732">c</a></span><span class="op" id="4890910">.</span><span class="ident" id="4890911">G</span><span class="op" id="4890912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4890918"><a href="/image/png/writer.go.html#4887975">cr</a></span><span class="op" id="4890920">[</span><span class="num" id="4890921">0</span><span class="op" id="4890922">]</span><span class="op" id="4890923">[</span><span class="ident" id="4890924"><a href="/image/png/writer.go.html#4888313">i</a></span><span class="op" id="4890925">+</span><span class="num" id="4890926">4</span><span class="op" id="4890927">]</span>&nbsp;<span class="op" id="4890929">=</span>&nbsp;<span class="builtintype" id="4890931">uint8</span><span class="op" id="4890936">(</span><span class="ident" id="4890937"><a href="/image/png/writer.go.html#4890732">c</a></span><span class="op" id="4890938">.</span><span class="ident" id="4890939">B</span>&nbsp;<span class="op" id="4890941">&gt;&gt;</span>&nbsp;<span class="num" id="4890944">8</span><span class="op" id="4890945">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4890951"><a href="/image/png/writer.go.html#4887975">cr</a></span><span class="op" id="4890953">[</span><span class="num" id="4890954">0</span><span class="op" id="4890955">]</span><span class="op" id="4890956">[</span><span class="ident" id="4890957"><a href="/image/png/writer.go.html#4888313">i</a></span><span class="op" id="4890958">+</span><span class="num" id="4890959">5</span><span class="op" id="4890960">]</span>&nbsp;<span class="op" id="4890962">=</span>&nbsp;<span class="builtintype" id="4890964">uint8</span><span class="op" id="4890969">(</span><span class="ident" id="4890970"><a href="/image/png/writer.go.html#4890732">c</a></span><span class="op" id="4890971">.</span><span class="ident" id="4890972">B</span><span class="op" id="4890973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4890979"><a href="/image/png/writer.go.html#4887975">cr</a></span><span class="op" id="4890981">[</span><span class="num" id="4890982">0</span><span class="op" id="4890983">]</span><span class="op" id="4890984">[</span><span class="ident" id="4890985"><a href="/image/png/writer.go.html#4888313">i</a></span><span class="op" id="4890986">+</span><span class="num" id="4890987">6</span><span class="op" id="4890988">]</span>&nbsp;<span class="op" id="4890990">=</span>&nbsp;<span class="builtintype" id="4890992">uint8</span><span class="op" id="4890997">(</span><span class="ident" id="4890998"><a href="/image/png/writer.go.html#4890732">c</a></span><span class="op" id="4890999">.</span><span class="ident" id="4891000">A</span>&nbsp;<span class="op" id="4891002">&gt;&gt;</span>&nbsp;<span class="num" id="4891005">8</span><span class="op" id="4891006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4891012"><a href="/image/png/writer.go.html#4887975">cr</a></span><span class="op" id="4891014">[</span><span class="num" id="4891015">0</span><span class="op" id="4891016">]</span><span class="op" id="4891017">[</span><span class="ident" id="4891018"><a href="/image/png/writer.go.html#4888313">i</a></span><span class="op" id="4891019">+</span><span class="num" id="4891020">7</span><span class="op" id="4891021">]</span>&nbsp;<span class="op" id="4891023">=</span>&nbsp;<span class="builtintype" id="4891025">uint8</span><span class="op" id="4891030">(</span><span class="ident" id="4891031"><a href="/image/png/writer.go.html#4890732">c</a></span><span class="op" id="4891032">.</span><span class="ident" id="4891033">A</span><span class="op" id="4891034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4891040"><a href="/image/png/writer.go.html#4888313">i</a></span>&nbsp;<span class="op" id="4891042">+=</span>&nbsp;<span class="num" id="4891045">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4891050">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4891054">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4891059">//&nbsp;Apply&nbsp;the&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4891082">f</span>&nbsp;<span class="op" id="4891084">:=</span>&nbsp;<span class="ident" id="4891087"><a href="/image/png/reader.go.html#4861554">ftNone</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4891096">if</span>&nbsp;<span class="ident" id="4891099"><a href="/image/png/writer.go.html#4887250">level</a></span>&nbsp;<span class="op" id="4891105">!=</span>&nbsp;<span class="ident" id="4891108"><a href="/image/png/writer.go.html#4881521">zlib</a></span><span class="op" id="4891112">.</span><span class="ident" id="4891113">NoCompression</span>&nbsp;<span class="op" id="4891127">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4891132"><a href="/image/png/writer.go.html#4891082">f</a></span>&nbsp;<span class="op" id="4891134">=</span>&nbsp;<span class="ident" id="4891136"><a href="/image/png/writer.go.html#4885382">filter</a></span><span class="op" id="4891142">(</span><span class="op" id="4891143">&amp;</span><span class="ident" id="4891144"><a href="/image/png/writer.go.html#4887975">cr</a></span><span class="op" id="4891146">,</span>&nbsp;<span class="ident" id="4891148"><a href="/image/png/writer.go.html#4888080">pr</a></span><span class="op" id="4891150">,</span>&nbsp;<span class="ident" id="4891152"><a href="/image/png/writer.go.html#4887364">bpp</a></span><span class="op" id="4891155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4891159">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4891164">//&nbsp;Write&nbsp;the&nbsp;compressed&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4891197">if</span>&nbsp;<span class="ident" id="4891200">_</span><span class="op" id="4891201">,</span>&nbsp;<span class="ident" id="4891203">err</span>&nbsp;<span class="op" id="4891207">:=</span>&nbsp;<span class="ident" id="4891210"><a href="/image/png/writer.go.html#4887270">zw</a></span><span class="op" id="4891212">.</span><span class="ident" id="4891213">Write</span><span class="op" id="4891218">(</span><span class="ident" id="4891219"><a href="/image/png/writer.go.html#4887975">cr</a></span><span class="op" id="4891221">[</span><span class="ident" id="4891222"><a href="/image/png/writer.go.html#4891082">f</a></span><span class="op" id="4891223">]</span><span class="op" id="4891224">)</span><span class="op" id="4891225">;</span>&nbsp;<span class="ident" id="4891227"><a href="/image/png/writer.go.html#4891203">err</a></span>&nbsp;<span class="op" id="4891231">!=</span>&nbsp;<span class="ident" id="4891234">nil</span>&nbsp;<span class="op" id="4891238">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4891243">return</span>&nbsp;<span class="ident" id="4891250"><a href="/image/png/writer.go.html#4891203">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4891256">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4891261">//&nbsp;The&nbsp;current&nbsp;row&nbsp;for&nbsp;y&nbsp;is&nbsp;the&nbsp;previous&nbsp;row&nbsp;for&nbsp;y+1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4891317"><a href="/image/png/writer.go.html#4888080">pr</a></span><span class="op" id="4891319">,</span>&nbsp;<span class="ident" id="4891321"><a href="/image/png/writer.go.html#4887975">cr</a></span><span class="op" id="4891323">[</span><span class="num" id="4891324">0</span><span class="op" id="4891325">]</span>&nbsp;<span class="op" id="4891327">=</span>&nbsp;<span class="ident" id="4891329"><a href="/image/png/writer.go.html#4887975">cr</a></span><span class="op" id="4891331">[</span><span class="num" id="4891332">0</span><span class="op" id="4891333">]</span><span class="op" id="4891334">,</span>&nbsp;<span class="ident" id="4891336"><a href="/image/png/writer.go.html#4888080">pr</a></span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4891340">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4891343">return</span>&nbsp;<span class="ident" id="4891350">nil</span><br>
<span class="lineno"></span><span class="op" id="4891354">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4891357">//&nbsp;Write&nbsp;the&nbsp;actual&nbsp;image&nbsp;data&nbsp;to&nbsp;one&nbsp;or&nbsp;more&nbsp;IDAT&nbsp;chunks.</span><br>
<span class="lineno">440</span><span class="keyword" id="4891416">func</span>&nbsp;<span class="op" id="4891421">(</span><span class="ident" id="4891422">e</span>&nbsp;<span class="op" id="4891424">*</span><span class="ident" id="4891425"><a href="/image/png/writer.go.html#4881703">encoder</a></span><span class="op" id="4891432">)</span>&nbsp;<span class="ident" id="4891434">writeIDATs</span><span class="op" id="4891444">(</span><span class="op" id="4891445">)</span>&nbsp;<span class="op" id="4891447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4891450">if</span>&nbsp;<span class="ident" id="4891453"><a href="/image/png/writer.go.html#4891422">e</a></span><span class="op" id="4891454">.</span><span class="ident" id="4891455">err</span>&nbsp;<span class="op" id="4891459">!=</span>&nbsp;<span class="ident" id="4891462">nil</span>&nbsp;<span class="op" id="4891466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4891470">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4891478">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4891481">var</span>&nbsp;<span class="ident" id="4891485">bw</span>&nbsp;<span class="op" id="4891488">*</span><span class="ident" id="4891489"><a href="/image/png/writer.go.html#4881512">bufio</a></span><span class="op" id="4891494">.</span><span class="ident" id="4891495">Writer</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4891503"><a href="/image/png/writer.go.html#4891485">bw</a></span>&nbsp;<span class="op" id="4891506">=</span>&nbsp;<span class="ident" id="4891508"><a href="/image/png/writer.go.html#4881512">bufio</a></span><span class="op" id="4891513">.</span><span class="ident" id="4891514">NewWriterSize</span><span class="op" id="4891527">(</span><span class="ident" id="4891528"><a href="/image/png/writer.go.html#4891422">e</a></span><span class="op" id="4891529">,</span>&nbsp;<span class="num" id="4891531">1</span><span class="op" id="4891532">&lt;&lt;</span><span class="num" id="4891534">15</span><span class="op" id="4891536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4891539"><a href="/image/png/writer.go.html#4891422">e</a></span><span class="op" id="4891540">.</span><span class="ident" id="4891541">err</span>&nbsp;<span class="op" id="4891545">=</span>&nbsp;<span class="ident" id="4891547"><a href="/image/png/writer.go.html#4887203">writeImage</a></span><span class="op" id="4891557">(</span><span class="ident" id="4891558"><a href="/image/png/writer.go.html#4891485">bw</a></span><span class="op" id="4891560">,</span>&nbsp;<span class="ident" id="4891562"><a href="/image/png/writer.go.html#4891422">e</a></span><span class="op" id="4891563">.</span><span class="ident" id="4891564">m</span><span class="op" id="4891565">,</span>&nbsp;<span class="ident" id="4891567"><a href="/image/png/writer.go.html#4891422">e</a></span><span class="op" id="4891568">.</span><span class="ident" id="4891569">cb</span><span class="op" id="4891571">,</span>&nbsp;<span class="ident" id="4891573"><a href="/image/png/writer.go.html#4891795">levelToZlib</a></span><span class="op" id="4891584">(</span><span class="ident" id="4891585"><a href="/image/png/writer.go.html#4891422">e</a></span><span class="op" id="4891586">.</span><span class="ident" id="4891587">enc</span><span class="op" id="4891590">.</span><span class="ident" id="4891591">CompressionLevel</span><span class="op" id="4891607">)</span><span class="op" id="4891608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4891611">if</span>&nbsp;<span class="ident" id="4891614"><a href="/image/png/writer.go.html#4891422">e</a></span><span class="op" id="4891615">.</span><span class="ident" id="4891616">err</span>&nbsp;<span class="op" id="4891620">!=</span>&nbsp;<span class="ident" id="4891623">nil</span>&nbsp;<span class="op" id="4891627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4891631">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4891639">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4891642"><a href="/image/png/writer.go.html#4891422">e</a></span><span class="op" id="4891643">.</span><span class="ident" id="4891644">err</span>&nbsp;<span class="op" id="4891648">=</span>&nbsp;<span class="ident" id="4891650"><a href="/image/png/writer.go.html#4891485">bw</a></span><span class="op" id="4891652">.</span><span class="ident" id="4891653">Flush</span><span class="op" id="4891658">(</span><span class="op" id="4891659">)</span><br>
<span class="lineno"></span><span class="op" id="4891661">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4891664">//&nbsp;This&nbsp;function&nbsp;is&nbsp;required&nbsp;because&nbsp;we&nbsp;want&nbsp;the&nbsp;zero&nbsp;value&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4891727">//&nbsp;Encoder.CompressionLevel&nbsp;to&nbsp;map&nbsp;to&nbsp;zlib.DefaultCompression.</span><br>
<span class="lineno">455</span><span class="keyword" id="4891790">func</span>&nbsp;<span class="ident" id="4891795">levelToZlib</span><span class="op" id="4891806">(</span><span class="ident" id="4891807">l</span>&nbsp;<span class="ident" id="4891809"><a href="/image/png/writer.go.html#4881863">CompressionLevel</a></span><span class="op" id="4891825">)</span>&nbsp;<span class="builtintype" id="4891827">int</span>&nbsp;<span class="op" id="4891831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4891834">switch</span>&nbsp;<span class="ident" id="4891841"><a href="/image/png/writer.go.html#4891807">l</a></span>&nbsp;<span class="op" id="4891843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4891846">case</span>&nbsp;<span class="ident" id="4891851"><a href="/image/png/writer.go.html#4881894">DefaultCompression</a></span><span class="op" id="4891869">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4891873">return</span>&nbsp;<span class="ident" id="4891880"><a href="/image/png/writer.go.html#4881521">zlib</a></span><span class="op" id="4891884">.</span><span class="ident" id="4891885">DefaultCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4891905">case</span>&nbsp;<span class="ident" id="4891910"><a href="/image/png/writer.go.html#4881935">NoCompression</a></span><span class="op" id="4891923">:</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4891927">return</span>&nbsp;<span class="ident" id="4891934"><a href="/image/png/writer.go.html#4881521">zlib</a></span><span class="op" id="4891938">.</span><span class="ident" id="4891939">NoCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4891954">case</span>&nbsp;<span class="ident" id="4891959"><a href="/image/png/writer.go.html#4881977">BestSpeed</a></span><span class="op" id="4891968">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4891972">return</span>&nbsp;<span class="ident" id="4891979"><a href="/image/png/writer.go.html#4881521">zlib</a></span><span class="op" id="4891983">.</span><span class="ident" id="4891984">BestSpeed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4891995">case</span>&nbsp;<span class="ident" id="4892000"><a href="/image/png/writer.go.html#4882019">BestCompression</a></span><span class="op" id="4892015">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4892019">return</span>&nbsp;<span class="ident" id="4892026"><a href="/image/png/writer.go.html#4881521">zlib</a></span><span class="op" id="4892030">.</span><span class="ident" id="4892031">BestCompression</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4892048">default</span><span class="op" id="4892055">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4892059">return</span>&nbsp;<span class="ident" id="4892066"><a href="/image/png/writer.go.html#4881521">zlib</a></span><span class="op" id="4892070">.</span><span class="ident" id="4892071">DefaultCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4892091">}</span><br>
<span class="lineno"></span><span class="op" id="4892093">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">470</span><span class="keyword" id="4892096">func</span>&nbsp;<span class="op" id="4892101">(</span><span class="ident" id="4892102">e</span>&nbsp;<span class="op" id="4892104">*</span><span class="ident" id="4892105"><a href="/image/png/writer.go.html#4881703">encoder</a></span><span class="op" id="4892112">)</span>&nbsp;<span class="ident" id="4892114">writeIEND</span><span class="op" id="4892123">(</span><span class="op" id="4892124">)</span>&nbsp;<span class="op" id="4892126">{</span>&nbsp;<span class="ident" id="4892128"><a href="/image/png/writer.go.html#4892102">e</a></span><span class="op" id="4892129">.</span><span class="ident" id="4892130">writeChunk</span><span class="op" id="4892140">(</span><span class="ident" id="4892141">nil</span><span class="op" id="4892144">,</span>&nbsp;<span class="string" id="4892146">&#34;IEND&#34;</span><span class="op" id="4892152">)</span>&nbsp;<span class="op" id="4892154">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4892157">//&nbsp;Encode&nbsp;writes&nbsp;the&nbsp;Image&nbsp;m&nbsp;to&nbsp;w&nbsp;in&nbsp;PNG&nbsp;format.&nbsp;Any&nbsp;Image&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="4892223">//&nbsp;encoded,&nbsp;but&nbsp;images&nbsp;that&nbsp;are&nbsp;not&nbsp;image.NRGBA&nbsp;might&nbsp;be&nbsp;encoded&nbsp;lossily.</span><br>
<span class="lineno"></span><span class="keyword" id="4892297">func</span>&nbsp;<span class="ident" id="4892302">Encode</span><span class="op" id="4892308">(</span><span class="ident" id="4892309">w</span>&nbsp;<span class="ident" id="4892311"><a href="/image/png/writer.go.html#4881576">io</a></span><span class="op" id="4892313">.</span><span class="ident" id="4892314">Writer</span><span class="op" id="4892320">,</span>&nbsp;<span class="ident" id="4892322">m</span>&nbsp;<span class="ident" id="4892324"><a href="/image/png/writer.go.html#4881552">image</a></span><span class="op" id="4892329">.</span><span class="ident" id="4892330">Image</span><span class="op" id="4892335">)</span>&nbsp;<span class="builtintype" id="4892337">error</span>&nbsp;<span class="op" id="4892343">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4892346">var</span>&nbsp;<span class="ident" id="4892350">e</span>&nbsp;<span class="ident" id="4892352"><a href="/image/png/writer.go.html#4881643">Encoder</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4892361">return</span>&nbsp;<span class="ident" id="4892368"><a href="/image/png/writer.go.html#4892350">e</a></span><span class="op" id="4892369">.</span><span class="ident" id="4892370">Encode</span><span class="op" id="4892376">(</span><span class="ident" id="4892377"><a href="/image/png/writer.go.html#4892309">w</a></span><span class="op" id="4892378">,</span>&nbsp;<span class="ident" id="4892380"><a href="/image/png/writer.go.html#4892322">m</a></span><span class="op" id="4892381">)</span><br>
<span class="lineno"></span><span class="op" id="4892383">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4892386">//&nbsp;Encode&nbsp;writes&nbsp;the&nbsp;Image&nbsp;m&nbsp;to&nbsp;w&nbsp;in&nbsp;PNG&nbsp;format.</span><br>
<span class="lineno">480</span><span class="keyword" id="4892435">func</span>&nbsp;<span class="op" id="4892440">(</span><span class="ident" id="4892441">enc</span>&nbsp;<span class="op" id="4892445">*</span><span class="ident" id="4892446"><a href="/image/png/writer.go.html#4881643">Encoder</a></span><span class="op" id="4892453">)</span>&nbsp;<span class="ident" id="4892455">Encode</span><span class="op" id="4892461">(</span><span class="ident" id="4892462">w</span>&nbsp;<span class="ident" id="4892464"><a href="/image/png/writer.go.html#4881576">io</a></span><span class="op" id="4892466">.</span><span class="ident" id="4892467">Writer</span><span class="op" id="4892473">,</span>&nbsp;<span class="ident" id="4892475">m</span>&nbsp;<span class="ident" id="4892477"><a href="/image/png/writer.go.html#4881552">image</a></span><span class="op" id="4892482">.</span><span class="ident" id="4892483">Image</span><span class="op" id="4892488">)</span>&nbsp;<span class="builtintype" id="4892490">error</span>&nbsp;<span class="op" id="4892496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4892499">//&nbsp;Obviously,&nbsp;negative&nbsp;widths&nbsp;and&nbsp;heights&nbsp;are&nbsp;invalid.&nbsp;Furthermore,&nbsp;the&nbsp;PNG</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4892576">//&nbsp;spec&nbsp;section&nbsp;11.2.2&nbsp;says&nbsp;that&nbsp;zero&nbsp;is&nbsp;invalid.&nbsp;Excessively&nbsp;large&nbsp;images&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4892656">//&nbsp;also&nbsp;rejected.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4892675">mw</span><span class="op" id="4892677">,</span>&nbsp;<span class="ident" id="4892679">mh</span>&nbsp;<span class="op" id="4892682">:=</span>&nbsp;<span class="ident" id="4892685">int64</span><span class="op" id="4892690">(</span><span class="ident" id="4892691"><a href="/image/png/writer.go.html#4892475">m</a></span><span class="op" id="4892692">.</span><span class="ident" id="4892693">Bounds</span><span class="op" id="4892699">(</span><span class="op" id="4892700">)</span><span class="op" id="4892701">.</span><span class="ident" id="4892702">Dx</span><span class="op" id="4892704">(</span><span class="op" id="4892705">)</span><span class="op" id="4892706">)</span><span class="op" id="4892707">,</span>&nbsp;<span class="ident" id="4892709">int64</span><span class="op" id="4892714">(</span><span class="ident" id="4892715"><a href="/image/png/writer.go.html#4892475">m</a></span><span class="op" id="4892716">.</span><span class="ident" id="4892717">Bounds</span><span class="op" id="4892723">(</span><span class="op" id="4892724">)</span><span class="op" id="4892725">.</span><span class="ident" id="4892726">Dy</span><span class="op" id="4892728">(</span><span class="op" id="4892729">)</span><span class="op" id="4892730">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4892733">if</span>&nbsp;<span class="ident" id="4892736"><a href="/image/png/writer.go.html#4892675">mw</a></span>&nbsp;<span class="op" id="4892739">&lt;=</span>&nbsp;<span class="num" id="4892742">0</span>&nbsp;<span class="op" id="4892744">||</span>&nbsp;<span class="ident" id="4892747"><a href="/image/png/writer.go.html#4892679">mh</a></span>&nbsp;<span class="op" id="4892750">&lt;=</span>&nbsp;<span class="num" id="4892753">0</span>&nbsp;<span class="op" id="4892755">||</span>&nbsp;<span class="ident" id="4892758"><a href="/image/png/writer.go.html#4892675">mw</a></span>&nbsp;<span class="op" id="4892761">&gt;=</span>&nbsp;<span class="num" id="4892764">1</span><span class="op" id="4892765">&lt;&lt;</span><span class="num" id="4892767">32</span>&nbsp;<span class="op" id="4892770">||</span>&nbsp;<span class="ident" id="4892773"><a href="/image/png/writer.go.html#4892679">mh</a></span>&nbsp;<span class="op" id="4892776">&gt;=</span>&nbsp;<span class="num" id="4892779">1</span><span class="op" id="4892780">&lt;&lt;</span><span class="num" id="4892782">32</span>&nbsp;<span class="op" id="4892785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4892789">return</span>&nbsp;<span class="ident" id="4892796"><a href="/image/png/reader.go.html#4862884">FormatError</a></span><span class="op" id="4892807">(</span><span class="string" id="4892808">&#34;invalid&nbsp;image&nbsp;size:&nbsp;&#34;</span>&nbsp;<span class="op" id="4892831">+</span>&nbsp;<span class="ident" id="4892833"><a href="/image/png/writer.go.html#4881582">strconv</a></span><span class="op" id="4892840">.</span><span class="ident" id="4892841">FormatInt</span><span class="op" id="4892850">(</span><span class="ident" id="4892851"><a href="/image/png/writer.go.html#4892675">mw</a></span><span class="op" id="4892853">,</span>&nbsp;<span class="num" id="4892855">10</span><span class="op" id="4892857">)</span>&nbsp;<span class="op" id="4892859">+</span>&nbsp;<span class="string" id="4892861">&#34;x&#34;</span>&nbsp;<span class="op" id="4892865">+</span>&nbsp;<span class="ident" id="4892867"><a href="/image/png/writer.go.html#4881582">strconv</a></span><span class="op" id="4892874">.</span><span class="ident" id="4892875">FormatInt</span><span class="op" id="4892884">(</span><span class="ident" id="4892885"><a href="/image/png/writer.go.html#4892679">mh</a></span><span class="op" id="4892887">,</span>&nbsp;<span class="num" id="4892889">10</span><span class="op" id="4892891">)</span><span class="op" id="4892892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4892895">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4892899">var</span>&nbsp;<span class="ident" id="4892903">e</span>&nbsp;<span class="ident" id="4892905"><a href="/image/png/writer.go.html#4881703">encoder</a></span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4892914"><a href="/image/png/writer.go.html#4892903">e</a></span><span class="op" id="4892915">.</span><span class="ident" id="4892916">enc</span>&nbsp;<span class="op" id="4892920">=</span>&nbsp;<span class="ident" id="4892922"><a href="/image/png/writer.go.html#4892441">enc</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4892927"><a href="/image/png/writer.go.html#4892903">e</a></span><span class="op" id="4892928">.</span><span class="ident" id="4892929">w</span>&nbsp;<span class="op" id="4892931">=</span>&nbsp;<span class="ident" id="4892933"><a href="/image/png/writer.go.html#4892462">w</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4892936"><a href="/image/png/writer.go.html#4892903">e</a></span><span class="op" id="4892937">.</span><span class="ident" id="4892938">m</span>&nbsp;<span class="op" id="4892940">=</span>&nbsp;<span class="ident" id="4892942"><a href="/image/png/writer.go.html#4892475">m</a></span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4892946">var</span>&nbsp;<span class="ident" id="4892950">pal</span>&nbsp;<span class="ident" id="4892954"><a href="/image/png/writer.go.html#4881561">color</a></span><span class="op" id="4892959">.</span><span class="ident" id="4892960">Palette</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4892969">//&nbsp;cbP8&nbsp;encoding&nbsp;needs&nbsp;PalettedImage&#39;s&nbsp;ColorIndexAt&nbsp;method.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4893030">if</span>&nbsp;<span class="ident" id="4893033">_</span><span class="op" id="4893034">,</span>&nbsp;<span class="ident" id="4893036">ok</span>&nbsp;<span class="op" id="4893039">:=</span>&nbsp;<span class="ident" id="4893042"><a href="/image/png/writer.go.html#4892475">m</a></span><span class="op" id="4893043">.</span><span class="op" id="4893044">(</span><span class="ident" id="4893045"><a href="/image/png/writer.go.html#4881552">image</a></span><span class="op" id="4893050">.</span><span class="ident" id="4893051">PalettedImage</span><span class="op" id="4893064">)</span><span class="op" id="4893065">;</span>&nbsp;<span class="ident" id="4893067"><a href="/image/png/writer.go.html#4893036">ok</a></span>&nbsp;<span class="op" id="4893070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4893074"><a href="/image/png/writer.go.html#4892950">pal</a></span><span class="op" id="4893077">,</span>&nbsp;<span class="ident" id="4893079">_</span>&nbsp;<span class="op" id="4893081">=</span>&nbsp;<span class="ident" id="4893083"><a href="/image/png/writer.go.html#4892475">m</a></span><span class="op" id="4893084">.</span><span class="ident" id="4893085">ColorModel</span><span class="op" id="4893095">(</span><span class="op" id="4893096">)</span><span class="op" id="4893097">.</span><span class="op" id="4893098">(</span><span class="ident" id="4893099"><a href="/image/png/writer.go.html#4881561">color</a></span><span class="op" id="4893104">.</span><span class="ident" id="4893105">Palette</span><span class="op" id="4893112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4893115">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4893118">if</span>&nbsp;<span class="ident" id="4893121"><a href="/image/png/writer.go.html#4892950">pal</a></span>&nbsp;<span class="op" id="4893125">!=</span>&nbsp;<span class="ident" id="4893128">nil</span>&nbsp;<span class="op" id="4893132">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4893136"><a href="/image/png/writer.go.html#4892903">e</a></span><span class="op" id="4893137">.</span><span class="ident" id="4893138">cb</span>&nbsp;<span class="op" id="4893141">=</span>&nbsp;<span class="ident" id="4893143"><a href="/image/png/reader.go.html#4861460">cbP8</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4893149">}</span>&nbsp;<span class="keyword" id="4893151">else</span>&nbsp;<span class="op" id="4893156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4893160">switch</span>&nbsp;<span class="ident" id="4893167"><a href="/image/png/writer.go.html#4892475">m</a></span><span class="op" id="4893168">.</span><span class="ident" id="4893169">ColorModel</span><span class="op" id="4893179">(</span><span class="op" id="4893180">)</span>&nbsp;<span class="op" id="4893182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4893186">case</span>&nbsp;<span class="ident" id="4893191"><a href="/image/png/writer.go.html#4881561">color</a></span><span class="op" id="4893196">.</span><span class="ident" id="4893197">GrayModel</span><span class="op" id="4893206">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4893211"><a href="/image/png/writer.go.html#4892903">e</a></span><span class="op" id="4893212">.</span><span class="ident" id="4893213">cb</span>&nbsp;<span class="op" id="4893216">=</span>&nbsp;<span class="ident" id="4893218"><a href="/image/png/reader.go.html#4861422">cbG8</a></span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4893225">case</span>&nbsp;<span class="ident" id="4893230"><a href="/image/png/writer.go.html#4881561">color</a></span><span class="op" id="4893235">.</span><span class="ident" id="4893236">Gray16Model</span><span class="op" id="4893247">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4893252"><a href="/image/png/writer.go.html#4892903">e</a></span><span class="op" id="4893253">.</span><span class="ident" id="4893254">cb</span>&nbsp;<span class="op" id="4893257">=</span>&nbsp;<span class="ident" id="4893259"><a href="/image/png/reader.go.html#4861474">cbG16</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4893267">case</span>&nbsp;<span class="ident" id="4893272"><a href="/image/png/writer.go.html#4881561">color</a></span><span class="op" id="4893277">.</span><span class="ident" id="4893278">RGBAModel</span><span class="op" id="4893287">,</span>&nbsp;<span class="ident" id="4893289"><a href="/image/png/writer.go.html#4881561">color</a></span><span class="op" id="4893294">.</span><span class="ident" id="4893295">NRGBAModel</span><span class="op" id="4893305">,</span>&nbsp;<span class="ident" id="4893307"><a href="/image/png/writer.go.html#4881561">color</a></span><span class="op" id="4893312">.</span><span class="ident" id="4893313">AlphaModel</span><span class="op" id="4893323">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4893328">if</span>&nbsp;<span class="ident" id="4893331"><a href="/image/png/writer.go.html#4882447">opaque</a></span><span class="op" id="4893337">(</span><span class="ident" id="4893338"><a href="/image/png/writer.go.html#4892475">m</a></span><span class="op" id="4893339">)</span>&nbsp;<span class="op" id="4893341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4893347"><a href="/image/png/writer.go.html#4892903">e</a></span><span class="op" id="4893348">.</span><span class="ident" id="4893349">cb</span>&nbsp;<span class="op" id="4893352">=</span>&nbsp;<span class="ident" id="4893354"><a href="/image/png/reader.go.html#4861435">cbTC8</a></span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4893363">}</span>&nbsp;<span class="keyword" id="4893365">else</span>&nbsp;<span class="op" id="4893370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4893376"><a href="/image/png/writer.go.html#4892903">e</a></span><span class="op" id="4893377">.</span><span class="ident" id="4893378">cb</span>&nbsp;<span class="op" id="4893381">=</span>&nbsp;<span class="ident" id="4893383"><a href="/image/png/reader.go.html#4861466">cbTCA8</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4893393">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4893397">default</span><span class="op" id="4893404">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4893409">if</span>&nbsp;<span class="ident" id="4893412"><a href="/image/png/writer.go.html#4882447">opaque</a></span><span class="op" id="4893418">(</span><span class="ident" id="4893419"><a href="/image/png/writer.go.html#4892475">m</a></span><span class="op" id="4893420">)</span>&nbsp;<span class="op" id="4893422">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4893428"><a href="/image/png/writer.go.html#4892903">e</a></span><span class="op" id="4893429">.</span><span class="ident" id="4893430">cb</span>&nbsp;<span class="op" id="4893433">=</span>&nbsp;<span class="ident" id="4893435"><a href="/image/png/reader.go.html#4861489">cbTC16</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4893445">}</span>&nbsp;<span class="keyword" id="4893447">else</span>&nbsp;<span class="op" id="4893452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4893458"><a href="/image/png/writer.go.html#4892903">e</a></span><span class="op" id="4893459">.</span><span class="ident" id="4893460">cb</span>&nbsp;<span class="op" id="4893463">=</span>&nbsp;<span class="ident" id="4893465"><a href="/image/png/reader.go.html#4861497">cbTCA16</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4893476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4893480">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4893483">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4893487">_</span><span class="op" id="4893488">,</span>&nbsp;<span class="ident" id="4893490"><a href="/image/png/writer.go.html#4892903">e</a></span><span class="op" id="4893491">.</span><span class="ident" id="4893492">err</span>&nbsp;<span class="op" id="4893496">=</span>&nbsp;<span class="ident" id="4893498"><a href="/image/png/writer.go.html#4881576">io</a></span><span class="op" id="4893500">.</span><span class="ident" id="4893501">WriteString</span><span class="op" id="4893512">(</span><span class="ident" id="4893513"><a href="/image/png/writer.go.html#4892462">w</a></span><span class="op" id="4893514">,</span>&nbsp;<span class="ident" id="4893516"><a href="/image/png/reader.go.html#4862507">pngHeader</a></span><span class="op" id="4893525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4893528"><a href="/image/png/writer.go.html#4892903">e</a></span><span class="op" id="4893529">.</span><span class="ident" id="4893530">writeIHDR</span><span class="op" id="4893539">(</span><span class="op" id="4893540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4893543">if</span>&nbsp;<span class="ident" id="4893546"><a href="/image/png/writer.go.html#4892950">pal</a></span>&nbsp;<span class="op" id="4893550">!=</span>&nbsp;<span class="ident" id="4893553">nil</span>&nbsp;<span class="op" id="4893557">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4893561"><a href="/image/png/writer.go.html#4892903">e</a></span><span class="op" id="4893562">.</span><span class="ident" id="4893563">writePLTEAndTRNS</span><span class="op" id="4893579">(</span><span class="ident" id="4893580"><a href="/image/png/writer.go.html#4892950">pal</a></span><span class="op" id="4893583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4893586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4893589"><a href="/image/png/writer.go.html#4892903">e</a></span><span class="op" id="4893590">.</span><span class="ident" id="4893591">writeIDATs</span><span class="op" id="4893601">(</span><span class="op" id="4893602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4893605"><a href="/image/png/writer.go.html#4892903">e</a></span><span class="op" id="4893606">.</span><span class="ident" id="4893607">writeIEND</span><span class="op" id="4893616">(</span><span class="op" id="4893617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4893620">return</span>&nbsp;<span class="ident" id="4893627"><a href="/image/png/writer.go.html#4892903">e</a></span><span class="op" id="4893628">.</span><span class="ident" id="4893629">err</span><br>
<span class="lineno">530</span><span class="op" id="4893633">}</span>
</div>
</body>
</html>
