<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/cgi</h2>
<ul>
<li><a href="/gostd/net/http/cgi/child.go.html" class="current">child.go</a></li>
<li><a href="/gostd/net/http/cgi/child_test.go.html">child_test.go</a></li>
<li><a href="/gostd/net/http/cgi/host.go.html">host.go</a></li>
<li><a href="/gostd/net/http/cgi/host_test.go.html">host_test.go</a></li>
<li><a href="/gostd/net/http/cgi/matryoshka_test.go.html">matryoshka_test.go</a></li>
<li><a href="/gostd/net/http/cgi/posix_test.go.html">posix_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6051155">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6051210">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6051264">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6051315">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;CGI&nbsp;from&nbsp;the&nbsp;perspective&nbsp;of&nbsp;a&nbsp;child</span><br>
<span class="lineno"></span><span class="comment" id="6051375">//&nbsp;process.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6051388">package</span>&nbsp;<span class="ident" id="6051396">cgi</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="6051401">import</span>&nbsp;<span class="op" id="6051408">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6051411">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6051420">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6051434">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6051444">&#34;fmt&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6051451">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6051457">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6051470">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6051477">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6051489">&#34;net/url&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6051500">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6051506">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6051517">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="6051527">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="6051530">//&nbsp;Request&nbsp;returns&nbsp;the&nbsp;HTTP&nbsp;request&nbsp;as&nbsp;represented&nbsp;in&nbsp;the&nbsp;current</span><br>
<span class="lineno"></span><span class="comment" id="6051596">//&nbsp;environment.&nbsp;This&nbsp;assumes&nbsp;the&nbsp;current&nbsp;program&nbsp;is&nbsp;being&nbsp;run</span><br>
<span class="lineno"></span><span class="comment" id="6051658">//&nbsp;by&nbsp;a&nbsp;web&nbsp;server&nbsp;in&nbsp;a&nbsp;CGI&nbsp;environment.</span><br>
<span class="lineno"></span><span class="comment" id="6051699">//&nbsp;The&nbsp;returned&nbsp;Request&#39;s&nbsp;Body&nbsp;is&nbsp;populated,&nbsp;if&nbsp;applicable.</span><br>
<span class="lineno"></span><span class="keyword" id="6051759">func</span>&nbsp;<span class="ident" id="6051764">Request</span><span class="op" id="6051771">(</span><span class="op" id="6051772">)</span>&nbsp;<span class="op" id="6051774">(</span><span class="op" id="6051775">*</span><span class="ident" id="6051776">http</span><span class="op" id="6051780">.</span><span class="ident" id="6051781">Request</span><span class="op" id="6051788">,</span>&nbsp;<span class="builtintype" id="6051790">error</span><span class="op" id="6051795">)</span>&nbsp;<span class="op" id="6051797">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6051800">r</span><span class="op" id="6051801">,</span>&nbsp;<span class="ident" id="6051803">err</span>&nbsp;<span class="op" id="6051807">:=</span>&nbsp;<span class="ident" id="6051810">RequestFromMap</span><span class="op" id="6051824">(</span><span class="ident" id="6051825">envMap</span><span class="op" id="6051831">(</span><span class="ident" id="6051832">os</span><span class="op" id="6051834">.</span><span class="ident" id="6051835">Environ</span><span class="op" id="6051842">(</span><span class="op" id="6051843">)</span><span class="op" id="6051844">)</span><span class="op" id="6051845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6051848">if</span>&nbsp;<span class="ident" id="6051851">err</span>&nbsp;<span class="op" id="6051855">!=</span>&nbsp;<span class="builtintype" id="6051858">nil</span>&nbsp;<span class="op" id="6051862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6051866">return</span>&nbsp;<span class="builtintype" id="6051873">nil</span><span class="op" id="6051876">,</span>&nbsp;<span class="ident" id="6051878">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6051883">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6051886">if</span>&nbsp;<span class="ident" id="6051889">r</span><span class="op" id="6051890">.</span><span class="ident" id="6051891">ContentLength</span>&nbsp;<span class="op" id="6051905">&gt;</span>&nbsp;<span class="num" id="6051907">0</span>&nbsp;<span class="op" id="6051909">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6051913">r</span><span class="op" id="6051914">.</span><span class="ident" id="6051915">Body</span>&nbsp;<span class="op" id="6051920">=</span>&nbsp;<span class="ident" id="6051922">ioutil</span><span class="op" id="6051928">.</span><span class="ident" id="6051929">NopCloser</span><span class="op" id="6051938">(</span><span class="ident" id="6051939">io</span><span class="op" id="6051941">.</span><span class="ident" id="6051942">LimitReader</span><span class="op" id="6051953">(</span><span class="ident" id="6051954">os</span><span class="op" id="6051956">.</span><span class="ident" id="6051957">Stdin</span><span class="op" id="6051962">,</span>&nbsp;<span class="ident" id="6051964">r</span><span class="op" id="6051965">.</span><span class="ident" id="6051966">ContentLength</span><span class="op" id="6051979">)</span><span class="op" id="6051980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6051983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6051986">return</span>&nbsp;<span class="ident" id="6051993">r</span><span class="op" id="6051994">,</span>&nbsp;<span class="builtintype" id="6051996">nil</span><br>
<span class="lineno"></span><span class="op" id="6052000">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="6052003">func</span>&nbsp;<span class="ident" id="6052008">envMap</span><span class="op" id="6052014">(</span><span class="ident" id="6052015">env</span>&nbsp;<span class="op" id="6052019">[</span><span class="op" id="6052020">]</span><span class="builtintype" id="6052021">string</span><span class="op" id="6052027">)</span>&nbsp;<span class="keyword" id="6052029">map</span><span class="op" id="6052032">[</span><span class="builtintype" id="6052033">string</span><span class="op" id="6052039">]</span><span class="builtintype" id="6052040">string</span>&nbsp;<span class="op" id="6052047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6052050">m</span>&nbsp;<span class="op" id="6052052">:=</span>&nbsp;<span class="builtinfunc" id="6052055">make</span><span class="op" id="6052059">(</span><span class="keyword" id="6052060">map</span><span class="op" id="6052063">[</span><span class="builtintype" id="6052064">string</span><span class="op" id="6052070">]</span><span class="builtintype" id="6052071">string</span><span class="op" id="6052077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6052080">for</span>&nbsp;<span class="ident" id="6052084">_</span><span class="op" id="6052085">,</span>&nbsp;<span class="ident" id="6052087">kv</span>&nbsp;<span class="op" id="6052090">:=</span>&nbsp;<span class="keyword" id="6052093">range</span>&nbsp;<span class="ident" id="6052099">env</span>&nbsp;<span class="op" id="6052103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6052107">if</span>&nbsp;<span class="ident" id="6052110">idx</span>&nbsp;<span class="op" id="6052114">:=</span>&nbsp;<span class="ident" id="6052117">strings</span><span class="op" id="6052124">.</span><span class="ident" id="6052125">Index</span><span class="op" id="6052130">(</span><span class="ident" id="6052131">kv</span><span class="op" id="6052133">,</span>&nbsp;<span class="string" id="6052135">&#34;=&#34;</span><span class="op" id="6052138">)</span><span class="op" id="6052139">;</span>&nbsp;<span class="ident" id="6052141">idx</span>&nbsp;<span class="op" id="6052145">!=</span>&nbsp;<span class="op" id="6052148">-</span><span class="num" id="6052149">1</span>&nbsp;<span class="op" id="6052151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6052156">m</span><span class="op" id="6052157">[</span><span class="ident" id="6052158">kv</span><span class="op" id="6052160">[</span><span class="op" id="6052161">:</span><span class="ident" id="6052162">idx</span><span class="op" id="6052165">]</span><span class="op" id="6052166">]</span>&nbsp;<span class="op" id="6052168">=</span>&nbsp;<span class="ident" id="6052170">kv</span><span class="op" id="6052172">[</span><span class="ident" id="6052173">idx</span><span class="op" id="6052176">+</span><span class="num" id="6052177">1</span><span class="op" id="6052178">:</span><span class="op" id="6052179">]</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6052183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6052186">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6052189">return</span>&nbsp;<span class="ident" id="6052196">m</span><br>
<span class="lineno"></span><span class="op" id="6052198">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="6052201">//&nbsp;RequestFromMap&nbsp;creates&nbsp;an&nbsp;http.Request&nbsp;from&nbsp;CGI&nbsp;variables.</span><br>
<span class="lineno"></span><span class="comment" id="6052263">//&nbsp;The&nbsp;returned&nbsp;Request&#39;s&nbsp;Body&nbsp;field&nbsp;is&nbsp;not&nbsp;populated.</span><br>
<span class="lineno"></span><span class="keyword" id="6052318">func</span>&nbsp;<span class="ident" id="6052323">RequestFromMap</span><span class="op" id="6052337">(</span><span class="ident" id="6052338">params</span>&nbsp;<span class="keyword" id="6052345">map</span><span class="op" id="6052348">[</span><span class="builtintype" id="6052349">string</span><span class="op" id="6052355">]</span><span class="builtintype" id="6052356">string</span><span class="op" id="6052362">)</span>&nbsp;<span class="op" id="6052364">(</span><span class="op" id="6052365">*</span><span class="ident" id="6052366">http</span><span class="op" id="6052370">.</span><span class="ident" id="6052371">Request</span><span class="op" id="6052378">,</span>&nbsp;<span class="builtintype" id="6052380">error</span><span class="op" id="6052385">)</span>&nbsp;<span class="op" id="6052387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6052390">r</span>&nbsp;<span class="op" id="6052392">:=</span>&nbsp;<span class="builtinfunc" id="6052395">new</span><span class="op" id="6052398">(</span><span class="ident" id="6052399">http</span><span class="op" id="6052403">.</span><span class="ident" id="6052404">Request</span><span class="op" id="6052411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6052414">r</span><span class="op" id="6052415">.</span><span class="ident" id="6052416">Method</span>&nbsp;<span class="op" id="6052423">=</span>&nbsp;<span class="ident" id="6052425">params</span><span class="op" id="6052431">[</span><span class="string" id="6052432">&#34;REQUEST_METHOD&#34;</span><span class="op" id="6052448">]</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6052451">if</span>&nbsp;<span class="ident" id="6052454">r</span><span class="op" id="6052455">.</span><span class="ident" id="6052456">Method</span>&nbsp;<span class="op" id="6052463">==</span>&nbsp;<span class="string" id="6052466">&#34;&#34;</span>&nbsp;<span class="op" id="6052469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6052473">return</span>&nbsp;<span class="builtintype" id="6052480">nil</span><span class="op" id="6052483">,</span>&nbsp;<span class="ident" id="6052485">errors</span><span class="op" id="6052491">.</span><span class="ident" id="6052492">New</span><span class="op" id="6052495">(</span><span class="string" id="6052496">&#34;cgi:&nbsp;no&nbsp;REQUEST_METHOD&nbsp;in&nbsp;environment&#34;</span><span class="op" id="6052535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6052538">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6052542">r</span><span class="op" id="6052543">.</span><span class="ident" id="6052544">Proto</span>&nbsp;<span class="op" id="6052550">=</span>&nbsp;<span class="ident" id="6052552">params</span><span class="op" id="6052558">[</span><span class="string" id="6052559">&#34;SERVER_PROTOCOL&#34;</span><span class="op" id="6052576">]</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6052579">var</span>&nbsp;<span class="ident" id="6052583">ok</span>&nbsp;<span class="builtintype" id="6052586">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6052592">r</span><span class="op" id="6052593">.</span><span class="ident" id="6052594">ProtoMajor</span><span class="op" id="6052604">,</span>&nbsp;<span class="ident" id="6052606">r</span><span class="op" id="6052607">.</span><span class="ident" id="6052608">ProtoMinor</span><span class="op" id="6052618">,</span>&nbsp;<span class="ident" id="6052620">ok</span>&nbsp;<span class="op" id="6052623">=</span>&nbsp;<span class="ident" id="6052625">http</span><span class="op" id="6052629">.</span><span class="ident" id="6052630">ParseHTTPVersion</span><span class="op" id="6052646">(</span><span class="ident" id="6052647">r</span><span class="op" id="6052648">.</span><span class="ident" id="6052649">Proto</span><span class="op" id="6052654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6052657">if</span>&nbsp;<span class="op" id="6052660">!</span><span class="ident" id="6052661">ok</span>&nbsp;<span class="op" id="6052664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6052668">return</span>&nbsp;<span class="builtintype" id="6052675">nil</span><span class="op" id="6052678">,</span>&nbsp;<span class="ident" id="6052680">errors</span><span class="op" id="6052686">.</span><span class="ident" id="6052687">New</span><span class="op" id="6052690">(</span><span class="string" id="6052691">&#34;cgi:&nbsp;invalid&nbsp;SERVER_PROTOCOL&nbsp;version&#34;</span><span class="op" id="6052729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6052732">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6052736">r</span><span class="op" id="6052737">.</span><span class="ident" id="6052738">Close</span>&nbsp;<span class="op" id="6052744">=</span>&nbsp;<span class="builtintype" id="6052746">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6052752">r</span><span class="op" id="6052753">.</span><span class="ident" id="6052754">Trailer</span>&nbsp;<span class="op" id="6052762">=</span>&nbsp;<span class="ident" id="6052764">http</span><span class="op" id="6052768">.</span><span class="ident" id="6052769">Header</span><span class="op" id="6052775">{</span><span class="op" id="6052776">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6052779">r</span><span class="op" id="6052780">.</span><span class="ident" id="6052781">Header</span>&nbsp;<span class="op" id="6052788">=</span>&nbsp;<span class="ident" id="6052790">http</span><span class="op" id="6052794">.</span><span class="ident" id="6052795">Header</span><span class="op" id="6052801">{</span><span class="op" id="6052802">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6052806">r</span><span class="op" id="6052807">.</span><span class="ident" id="6052808">Host</span>&nbsp;<span class="op" id="6052813">=</span>&nbsp;<span class="ident" id="6052815">params</span><span class="op" id="6052821">[</span><span class="string" id="6052822">&#34;HTTP_HOST&#34;</span><span class="op" id="6052833">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6052837">if</span>&nbsp;<span class="ident" id="6052840">lenstr</span>&nbsp;<span class="op" id="6052847">:=</span>&nbsp;<span class="ident" id="6052850">params</span><span class="op" id="6052856">[</span><span class="string" id="6052857">&#34;CONTENT_LENGTH&#34;</span><span class="op" id="6052873">]</span><span class="op" id="6052874">;</span>&nbsp;<span class="ident" id="6052876">lenstr</span>&nbsp;<span class="op" id="6052883">!=</span>&nbsp;<span class="string" id="6052886">&#34;&#34;</span>&nbsp;<span class="op" id="6052889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6052893">clen</span><span class="op" id="6052897">,</span>&nbsp;<span class="ident" id="6052899">err</span>&nbsp;<span class="op" id="6052903">:=</span>&nbsp;<span class="ident" id="6052906">strconv</span><span class="op" id="6052913">.</span><span class="ident" id="6052914">ParseInt</span><span class="op" id="6052922">(</span><span class="ident" id="6052923">lenstr</span><span class="op" id="6052929">,</span>&nbsp;<span class="num" id="6052931">10</span><span class="op" id="6052933">,</span>&nbsp;<span class="num" id="6052935">64</span><span class="op" id="6052937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6052941">if</span>&nbsp;<span class="ident" id="6052944">err</span>&nbsp;<span class="op" id="6052948">!=</span>&nbsp;<span class="builtintype" id="6052951">nil</span>&nbsp;<span class="op" id="6052955">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6052960">return</span>&nbsp;<span class="builtintype" id="6052967">nil</span><span class="op" id="6052970">,</span>&nbsp;<span class="ident" id="6052972">errors</span><span class="op" id="6052978">.</span><span class="ident" id="6052979">New</span><span class="op" id="6052982">(</span><span class="string" id="6052983">&#34;cgi:&nbsp;bad&nbsp;CONTENT_LENGTH&nbsp;in&nbsp;environment:&nbsp;&#34;</span>&nbsp;<span class="op" id="6053026">+</span>&nbsp;<span class="ident" id="6053028">lenstr</span><span class="op" id="6053034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6053038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6053042">r</span><span class="op" id="6053043">.</span><span class="ident" id="6053044">ContentLength</span>&nbsp;<span class="op" id="6053058">=</span>&nbsp;<span class="ident" id="6053060">clen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6053066">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6053070">if</span>&nbsp;<span class="ident" id="6053073">ct</span>&nbsp;<span class="op" id="6053076">:=</span>&nbsp;<span class="ident" id="6053079">params</span><span class="op" id="6053085">[</span><span class="string" id="6053086">&#34;CONTENT_TYPE&#34;</span><span class="op" id="6053100">]</span><span class="op" id="6053101">;</span>&nbsp;<span class="ident" id="6053103">ct</span>&nbsp;<span class="op" id="6053106">!=</span>&nbsp;<span class="string" id="6053109">&#34;&#34;</span>&nbsp;<span class="op" id="6053112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6053116">r</span><span class="op" id="6053117">.</span><span class="ident" id="6053118">Header</span><span class="op" id="6053124">.</span><span class="ident" id="6053125">Set</span><span class="op" id="6053128">(</span><span class="string" id="6053129">&#34;Content-Type&#34;</span><span class="op" id="6053143">,</span>&nbsp;<span class="ident" id="6053145">ct</span><span class="op" id="6053147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6053150">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6053154">//&nbsp;Copy&nbsp;&#34;HTTP_FOO_BAR&#34;&nbsp;variables&nbsp;to&nbsp;&#34;Foo-Bar&#34;&nbsp;Headers</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6053209">for</span>&nbsp;<span class="ident" id="6053213">k</span><span class="op" id="6053214">,</span>&nbsp;<span class="ident" id="6053216">v</span>&nbsp;<span class="op" id="6053218">:=</span>&nbsp;<span class="keyword" id="6053221">range</span>&nbsp;<span class="ident" id="6053227">params</span>&nbsp;<span class="op" id="6053234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6053238">if</span>&nbsp;<span class="op" id="6053241">!</span><span class="ident" id="6053242">strings</span><span class="op" id="6053249">.</span><span class="ident" id="6053250">HasPrefix</span><span class="op" id="6053259">(</span><span class="ident" id="6053260">k</span><span class="op" id="6053261">,</span>&nbsp;<span class="string" id="6053263">&#34;HTTP_&#34;</span><span class="op" id="6053270">)</span>&nbsp;<span class="op" id="6053272">||</span>&nbsp;<span class="ident" id="6053275">k</span>&nbsp;<span class="op" id="6053277">==</span>&nbsp;<span class="string" id="6053280">&#34;HTTP_HOST&#34;</span>&nbsp;<span class="op" id="6053292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6053297">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6053308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6053312">r</span><span class="op" id="6053313">.</span><span class="ident" id="6053314">Header</span><span class="op" id="6053320">.</span><span class="ident" id="6053321">Add</span><span class="op" id="6053324">(</span><span class="ident" id="6053325">strings</span><span class="op" id="6053332">.</span><span class="ident" id="6053333">Replace</span><span class="op" id="6053340">(</span><span class="ident" id="6053341">k</span><span class="op" id="6053342">[</span><span class="num" id="6053343">5</span><span class="op" id="6053344">:</span><span class="op" id="6053345">]</span><span class="op" id="6053346">,</span>&nbsp;<span class="string" id="6053348">&#34;_&#34;</span><span class="op" id="6053351">,</span>&nbsp;<span class="string" id="6053353">&#34;-&#34;</span><span class="op" id="6053356">,</span>&nbsp;<span class="op" id="6053358">-</span><span class="num" id="6053359">1</span><span class="op" id="6053360">)</span><span class="op" id="6053361">,</span>&nbsp;<span class="ident" id="6053363">v</span><span class="op" id="6053364">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6053367">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6053371">//&nbsp;TODO:&nbsp;cookies.&nbsp;&nbsp;parsing&nbsp;them&nbsp;isn&#39;t&nbsp;exported,&nbsp;though.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6053429">uriStr</span>&nbsp;<span class="op" id="6053436">:=</span>&nbsp;<span class="ident" id="6053439">params</span><span class="op" id="6053445">[</span><span class="string" id="6053446">&#34;REQUEST_URI&#34;</span><span class="op" id="6053459">]</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6053462">if</span>&nbsp;<span class="ident" id="6053465">uriStr</span>&nbsp;<span class="op" id="6053472">==</span>&nbsp;<span class="string" id="6053475">&#34;&#34;</span>&nbsp;<span class="op" id="6053478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6053482">//&nbsp;Fallback&nbsp;to&nbsp;SCRIPT_NAME,&nbsp;PATH_INFO&nbsp;and&nbsp;QUERY_STRING.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6053540">uriStr</span>&nbsp;<span class="op" id="6053547">=</span>&nbsp;<span class="ident" id="6053549">params</span><span class="op" id="6053555">[</span><span class="string" id="6053556">&#34;SCRIPT_NAME&#34;</span><span class="op" id="6053569">]</span>&nbsp;<span class="op" id="6053571">+</span>&nbsp;<span class="ident" id="6053573">params</span><span class="op" id="6053579">[</span><span class="string" id="6053580">&#34;PATH_INFO&#34;</span><span class="op" id="6053591">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6053595">s</span>&nbsp;<span class="op" id="6053597">:=</span>&nbsp;<span class="ident" id="6053600">params</span><span class="op" id="6053606">[</span><span class="string" id="6053607">&#34;QUERY_STRING&#34;</span><span class="op" id="6053621">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6053625">if</span>&nbsp;<span class="ident" id="6053628">s</span>&nbsp;<span class="op" id="6053630">!=</span>&nbsp;<span class="string" id="6053633">&#34;&#34;</span>&nbsp;<span class="op" id="6053636">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6053641">uriStr</span>&nbsp;<span class="op" id="6053648">+=</span>&nbsp;<span class="string" id="6053651">&#34;?&#34;</span>&nbsp;<span class="op" id="6053655">+</span>&nbsp;<span class="ident" id="6053657">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6053661">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6053664">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6053668">//&nbsp;There&#39;s&nbsp;apparently&nbsp;a&nbsp;de-facto&nbsp;standard&nbsp;for&nbsp;this.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6053721">//&nbsp;http://docstore.mik.ua/orelly/linux/cgi/ch03_02.htm#ch03-35636</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6053788">if</span>&nbsp;<span class="ident" id="6053791">s</span>&nbsp;<span class="op" id="6053793">:=</span>&nbsp;<span class="ident" id="6053796">params</span><span class="op" id="6053802">[</span><span class="string" id="6053803">&#34;HTTPS&#34;</span><span class="op" id="6053810">]</span><span class="op" id="6053811">;</span>&nbsp;<span class="ident" id="6053813">s</span>&nbsp;<span class="op" id="6053815">==</span>&nbsp;<span class="string" id="6053818">&#34;on&#34;</span>&nbsp;<span class="op" id="6053823">||</span>&nbsp;<span class="ident" id="6053826">s</span>&nbsp;<span class="op" id="6053828">==</span>&nbsp;<span class="string" id="6053831">&#34;ON&#34;</span>&nbsp;<span class="op" id="6053836">||</span>&nbsp;<span class="ident" id="6053839">s</span>&nbsp;<span class="op" id="6053841">==</span>&nbsp;<span class="string" id="6053844">&#34;1&#34;</span>&nbsp;<span class="op" id="6053848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6053852">r</span><span class="op" id="6053853">.</span><span class="ident" id="6053854">TLS</span>&nbsp;<span class="op" id="6053858">=</span>&nbsp;<span class="op" id="6053860">&amp;</span><span class="ident" id="6053861">tls</span><span class="op" id="6053864">.</span><span class="ident" id="6053865">ConnectionState</span><span class="op" id="6053880">{</span><span class="ident" id="6053881">HandshakeComplete</span><span class="op" id="6053898">:</span>&nbsp;<span class="builtintype" id="6053900">true</span><span class="op" id="6053904">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6053907">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6053911">if</span>&nbsp;<span class="ident" id="6053914">r</span><span class="op" id="6053915">.</span><span class="ident" id="6053916">Host</span>&nbsp;<span class="op" id="6053921">!=</span>&nbsp;<span class="string" id="6053924">&#34;&#34;</span>&nbsp;<span class="op" id="6053927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6053931">//&nbsp;Hostname&nbsp;is&nbsp;provided,&nbsp;so&nbsp;we&nbsp;can&nbsp;reasonably&nbsp;construct&nbsp;a&nbsp;URL.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6053996">rawurl</span>&nbsp;<span class="op" id="6054003">:=</span>&nbsp;<span class="ident" id="6054006">r</span><span class="op" id="6054007">.</span><span class="ident" id="6054008">Host</span>&nbsp;<span class="op" id="6054013">+</span>&nbsp;<span class="ident" id="6054015">uriStr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6054024">if</span>&nbsp;<span class="ident" id="6054027">r</span><span class="op" id="6054028">.</span><span class="ident" id="6054029">TLS</span>&nbsp;<span class="op" id="6054033">==</span>&nbsp;<span class="builtintype" id="6054036">nil</span>&nbsp;<span class="op" id="6054040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6054045">rawurl</span>&nbsp;<span class="op" id="6054052">=</span>&nbsp;<span class="string" id="6054054">&#34;http://&#34;</span>&nbsp;<span class="op" id="6054064">+</span>&nbsp;<span class="ident" id="6054066">rawurl</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6054075">}</span>&nbsp;<span class="keyword" id="6054077">else</span>&nbsp;<span class="op" id="6054082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6054087">rawurl</span>&nbsp;<span class="op" id="6054094">=</span>&nbsp;<span class="string" id="6054096">&#34;https://&#34;</span>&nbsp;<span class="op" id="6054107">+</span>&nbsp;<span class="ident" id="6054109">rawurl</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6054118">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6054122">url</span><span class="op" id="6054125">,</span>&nbsp;<span class="ident" id="6054127">err</span>&nbsp;<span class="op" id="6054131">:=</span>&nbsp;<span class="ident" id="6054134">url</span><span class="op" id="6054137">.</span><span class="ident" id="6054138">Parse</span><span class="op" id="6054143">(</span><span class="ident" id="6054144">rawurl</span><span class="op" id="6054150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6054154">if</span>&nbsp;<span class="ident" id="6054157">err</span>&nbsp;<span class="op" id="6054161">!=</span>&nbsp;<span class="builtintype" id="6054164">nil</span>&nbsp;<span class="op" id="6054168">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6054173">return</span>&nbsp;<span class="builtintype" id="6054180">nil</span><span class="op" id="6054183">,</span>&nbsp;<span class="ident" id="6054185">errors</span><span class="op" id="6054191">.</span><span class="ident" id="6054192">New</span><span class="op" id="6054195">(</span><span class="string" id="6054196">&#34;cgi:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;host&nbsp;and&nbsp;REQUEST_URI&nbsp;into&nbsp;a&nbsp;URL:&nbsp;&#34;</span>&nbsp;<span class="op" id="6054253">+</span>&nbsp;<span class="ident" id="6054255">rawurl</span><span class="op" id="6054261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6054265">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6054269">r</span><span class="op" id="6054270">.</span><span class="ident" id="6054271">URL</span>&nbsp;<span class="op" id="6054275">=</span>&nbsp;<span class="ident" id="6054277">url</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6054282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6054285">//&nbsp;Fallback&nbsp;logic&nbsp;if&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;a&nbsp;Host&nbsp;header&nbsp;or&nbsp;the&nbsp;URL</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6054346">//&nbsp;failed&nbsp;to&nbsp;parse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6054366">if</span>&nbsp;<span class="ident" id="6054369">r</span><span class="op" id="6054370">.</span><span class="ident" id="6054371">URL</span>&nbsp;<span class="op" id="6054375">==</span>&nbsp;<span class="builtintype" id="6054378">nil</span>&nbsp;<span class="op" id="6054382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6054386">url</span><span class="op" id="6054389">,</span>&nbsp;<span class="ident" id="6054391">err</span>&nbsp;<span class="op" id="6054395">:=</span>&nbsp;<span class="ident" id="6054398">url</span><span class="op" id="6054401">.</span><span class="ident" id="6054402">Parse</span><span class="op" id="6054407">(</span><span class="ident" id="6054408">uriStr</span><span class="op" id="6054414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6054418">if</span>&nbsp;<span class="ident" id="6054421">err</span>&nbsp;<span class="op" id="6054425">!=</span>&nbsp;<span class="builtintype" id="6054428">nil</span>&nbsp;<span class="op" id="6054432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6054437">return</span>&nbsp;<span class="builtintype" id="6054444">nil</span><span class="op" id="6054447">,</span>&nbsp;<span class="ident" id="6054449">errors</span><span class="op" id="6054455">.</span><span class="ident" id="6054456">New</span><span class="op" id="6054459">(</span><span class="string" id="6054460">&#34;cgi:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;REQUEST_URI&nbsp;into&nbsp;a&nbsp;URL:&nbsp;&#34;</span>&nbsp;<span class="op" id="6054508">+</span>&nbsp;<span class="ident" id="6054510">uriStr</span><span class="op" id="6054516">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6054520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6054524">r</span><span class="op" id="6054525">.</span><span class="ident" id="6054526">URL</span>&nbsp;<span class="op" id="6054530">=</span>&nbsp;<span class="ident" id="6054532">url</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6054537">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6054541">//&nbsp;Request.RemoteAddr&nbsp;has&nbsp;its&nbsp;port&nbsp;set&nbsp;by&nbsp;Go&#39;s&nbsp;standard&nbsp;http</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6054603">//&nbsp;server,&nbsp;so&nbsp;we&nbsp;do&nbsp;here&nbsp;too.&nbsp;We&nbsp;don&#39;t&nbsp;have&nbsp;one,&nbsp;though,&nbsp;so&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6054667">//&nbsp;use&nbsp;a&nbsp;dummy&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6054688">r</span><span class="op" id="6054689">.</span><span class="ident" id="6054690">RemoteAddr</span>&nbsp;<span class="op" id="6054701">=</span>&nbsp;<span class="ident" id="6054703">net</span><span class="op" id="6054706">.</span><span class="ident" id="6054707">JoinHostPort</span><span class="op" id="6054719">(</span><span class="ident" id="6054720">params</span><span class="op" id="6054726">[</span><span class="string" id="6054727">&#34;REMOTE_ADDR&#34;</span><span class="op" id="6054740">]</span><span class="op" id="6054741">,</span>&nbsp;<span class="string" id="6054743">&#34;0&#34;</span><span class="op" id="6054746">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6054750">return</span>&nbsp;<span class="ident" id="6054757">r</span><span class="op" id="6054758">,</span>&nbsp;<span class="builtintype" id="6054760">nil</span><br>
<span class="lineno">140</span><span class="op" id="6054764">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6054767">//&nbsp;Serve&nbsp;executes&nbsp;the&nbsp;provided&nbsp;Handler&nbsp;on&nbsp;the&nbsp;currently&nbsp;active&nbsp;CGI</span><br>
<span class="lineno"></span><span class="comment" id="6054834">//&nbsp;request,&nbsp;if&nbsp;any.&nbsp;If&nbsp;there&#39;s&nbsp;no&nbsp;current&nbsp;CGI&nbsp;environment</span><br>
<span class="lineno"></span><span class="comment" id="6054892">//&nbsp;an&nbsp;error&nbsp;is&nbsp;returned.&nbsp;The&nbsp;provided&nbsp;handler&nbsp;may&nbsp;be&nbsp;nil&nbsp;to&nbsp;use</span><br>
<span class="lineno">145</span><span class="comment" id="6054956">//&nbsp;http.DefaultServeMux.</span><br>
<span class="lineno"></span><span class="keyword" id="6054981">func</span>&nbsp;<span class="ident" id="6054986">Serve</span><span class="op" id="6054991">(</span><span class="ident" id="6054992">handler</span>&nbsp;<span class="ident" id="6055000">http</span><span class="op" id="6055004">.</span><span class="ident" id="6055005">Handler</span><span class="op" id="6055012">)</span>&nbsp;<span class="builtintype" id="6055014">error</span>&nbsp;<span class="op" id="6055020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6055023">req</span><span class="op" id="6055026">,</span>&nbsp;<span class="ident" id="6055028">err</span>&nbsp;<span class="op" id="6055032">:=</span>&nbsp;<span class="ident" id="6055035">Request</span><span class="op" id="6055042">(</span><span class="op" id="6055043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6055046">if</span>&nbsp;<span class="ident" id="6055049">err</span>&nbsp;<span class="op" id="6055053">!=</span>&nbsp;<span class="builtintype" id="6055056">nil</span>&nbsp;<span class="op" id="6055060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6055064">return</span>&nbsp;<span class="ident" id="6055071">err</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6055076">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6055079">if</span>&nbsp;<span class="ident" id="6055082">handler</span>&nbsp;<span class="op" id="6055090">==</span>&nbsp;<span class="builtintype" id="6055093">nil</span>&nbsp;<span class="op" id="6055097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6055101">handler</span>&nbsp;<span class="op" id="6055109">=</span>&nbsp;<span class="ident" id="6055111">http</span><span class="op" id="6055115">.</span><span class="ident" id="6055116">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6055133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6055136">rw</span>&nbsp;<span class="op" id="6055139">:=</span>&nbsp;<span class="op" id="6055142">&amp;</span><span class="ident" id="6055143">response</span><span class="op" id="6055151">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6055155">req</span><span class="op" id="6055158">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6055163">req</span><span class="op" id="6055166">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6055170">header</span><span class="op" id="6055176">:</span>&nbsp;<span class="builtinfunc" id="6055178">make</span><span class="op" id="6055182">(</span><span class="ident" id="6055183">http</span><span class="op" id="6055187">.</span><span class="ident" id="6055188">Header</span><span class="op" id="6055194">)</span><span class="op" id="6055195">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6055199">bufw</span><span class="op" id="6055203">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6055207">bufio</span><span class="op" id="6055212">.</span><span class="ident" id="6055213">NewWriter</span><span class="op" id="6055222">(</span><span class="ident" id="6055223">os</span><span class="op" id="6055225">.</span><span class="ident" id="6055226">Stdout</span><span class="op" id="6055232">)</span><span class="op" id="6055233">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6055236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6055239">handler</span><span class="op" id="6055246">.</span><span class="ident" id="6055247">ServeHTTP</span><span class="op" id="6055256">(</span><span class="ident" id="6055257">rw</span><span class="op" id="6055259">,</span>&nbsp;<span class="ident" id="6055261">req</span><span class="op" id="6055264">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6055267">rw</span><span class="op" id="6055269">.</span><span class="ident" id="6055270">Write</span><span class="op" id="6055275">(</span><span class="builtintype" id="6055276">nil</span><span class="op" id="6055279">)</span>&nbsp;<span class="comment" id="6055281">//&nbsp;make&nbsp;sure&nbsp;a&nbsp;response&nbsp;is&nbsp;sent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6055314">if</span>&nbsp;<span class="ident" id="6055317">err</span>&nbsp;<span class="op" id="6055321">=</span>&nbsp;<span class="ident" id="6055323">rw</span><span class="op" id="6055325">.</span><span class="ident" id="6055326">bufw</span><span class="op" id="6055330">.</span><span class="ident" id="6055331">Flush</span><span class="op" id="6055336">(</span><span class="op" id="6055337">)</span><span class="op" id="6055338">;</span>&nbsp;<span class="ident" id="6055340">err</span>&nbsp;<span class="op" id="6055344">!=</span>&nbsp;<span class="builtintype" id="6055347">nil</span>&nbsp;<span class="op" id="6055351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6055355">return</span>&nbsp;<span class="ident" id="6055362">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6055367">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6055370">return</span>&nbsp;<span class="builtintype" id="6055377">nil</span><br>
<span class="lineno">165</span><span class="op" id="6055381">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6055384">type</span>&nbsp;<span class="ident" id="6055389">response</span>&nbsp;<span class="keyword" id="6055398">struct</span>&nbsp;<span class="op" id="6055405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6055408">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6055419">*</span><span class="ident" id="6055420">http</span><span class="op" id="6055424">.</span><span class="ident" id="6055425">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6055434">header</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6055445">http</span><span class="op" id="6055449">.</span><span class="ident" id="6055450">Header</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6055458">bufw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6055469">*</span><span class="ident" id="6055470">bufio</span><span class="op" id="6055475">.</span><span class="ident" id="6055476">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6055484">headerSent</span>&nbsp;<span class="builtintype" id="6055495">bool</span><br>
<span class="lineno"></span><span class="op" id="6055500">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6055503">func</span>&nbsp;<span class="op" id="6055508">(</span><span class="ident" id="6055509">r</span>&nbsp;<span class="op" id="6055511">*</span><span class="ident" id="6055512">response</span><span class="op" id="6055520">)</span>&nbsp;<span class="ident" id="6055522">Flush</span><span class="op" id="6055527">(</span><span class="op" id="6055528">)</span>&nbsp;<span class="op" id="6055530">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6055533">r</span><span class="op" id="6055534">.</span><span class="ident" id="6055535">bufw</span><span class="op" id="6055539">.</span><span class="ident" id="6055540">Flush</span><span class="op" id="6055545">(</span><span class="op" id="6055546">)</span><br>
<span class="lineno"></span><span class="op" id="6055548">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6055551">func</span>&nbsp;<span class="op" id="6055556">(</span><span class="ident" id="6055557">r</span>&nbsp;<span class="op" id="6055559">*</span><span class="ident" id="6055560">response</span><span class="op" id="6055568">)</span>&nbsp;<span class="ident" id="6055570">Header</span><span class="op" id="6055576">(</span><span class="op" id="6055577">)</span>&nbsp;<span class="ident" id="6055579">http</span><span class="op" id="6055583">.</span><span class="ident" id="6055584">Header</span>&nbsp;<span class="op" id="6055591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6055594">return</span>&nbsp;<span class="ident" id="6055601">r</span><span class="op" id="6055602">.</span><span class="ident" id="6055603">header</span><br>
<span class="lineno">180</span><span class="op" id="6055610">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6055613">func</span>&nbsp;<span class="op" id="6055618">(</span><span class="ident" id="6055619">r</span>&nbsp;<span class="op" id="6055621">*</span><span class="ident" id="6055622">response</span><span class="op" id="6055630">)</span>&nbsp;<span class="ident" id="6055632">Write</span><span class="op" id="6055637">(</span><span class="ident" id="6055638">p</span>&nbsp;<span class="op" id="6055640">[</span><span class="op" id="6055641">]</span><span class="builtintype" id="6055642">byte</span><span class="op" id="6055646">)</span>&nbsp;<span class="op" id="6055648">(</span><span class="ident" id="6055649">n</span>&nbsp;<span class="builtintype" id="6055651">int</span><span class="op" id="6055654">,</span>&nbsp;<span class="ident" id="6055656">err</span>&nbsp;<span class="builtintype" id="6055660">error</span><span class="op" id="6055665">)</span>&nbsp;<span class="op" id="6055667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6055670">if</span>&nbsp;<span class="op" id="6055673">!</span><span class="ident" id="6055674">r</span><span class="op" id="6055675">.</span><span class="ident" id="6055676">headerSent</span>&nbsp;<span class="op" id="6055687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6055691">r</span><span class="op" id="6055692">.</span><span class="ident" id="6055693">WriteHeader</span><span class="op" id="6055704">(</span><span class="ident" id="6055705">http</span><span class="op" id="6055709">.</span><span class="ident" id="6055710">StatusOK</span><span class="op" id="6055718">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6055721">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6055724">return</span>&nbsp;<span class="ident" id="6055731">r</span><span class="op" id="6055732">.</span><span class="ident" id="6055733">bufw</span><span class="op" id="6055737">.</span><span class="ident" id="6055738">Write</span><span class="op" id="6055743">(</span><span class="ident" id="6055744">p</span><span class="op" id="6055745">)</span><br>
<span class="lineno"></span><span class="op" id="6055747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6055750">func</span>&nbsp;<span class="op" id="6055755">(</span><span class="ident" id="6055756">r</span>&nbsp;<span class="op" id="6055758">*</span><span class="ident" id="6055759">response</span><span class="op" id="6055767">)</span>&nbsp;<span class="ident" id="6055769">WriteHeader</span><span class="op" id="6055780">(</span><span class="ident" id="6055781">code</span>&nbsp;<span class="builtintype" id="6055786">int</span><span class="op" id="6055789">)</span>&nbsp;<span class="op" id="6055791">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6055794">if</span>&nbsp;<span class="ident" id="6055797">r</span><span class="op" id="6055798">.</span><span class="ident" id="6055799">headerSent</span>&nbsp;<span class="op" id="6055810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6055814">//&nbsp;Note:&nbsp;explicitly&nbsp;using&nbsp;Stderr,&nbsp;as&nbsp;Stdout&nbsp;is&nbsp;our&nbsp;HTTP&nbsp;output.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6055880">fmt</span><span class="op" id="6055883">.</span><span class="ident" id="6055884">Fprintf</span><span class="op" id="6055891">(</span><span class="ident" id="6055892">os</span><span class="op" id="6055894">.</span><span class="ident" id="6055895">Stderr</span><span class="op" id="6055901">,</span>&nbsp;<span class="string" id="6055903">&#34;CGI&nbsp;attempted&nbsp;to&nbsp;write&nbsp;header&nbsp;twice&nbsp;on&nbsp;request&nbsp;for&nbsp;%s&#34;</span><span class="op" id="6055958">,</span>&nbsp;<span class="ident" id="6055960">r</span><span class="op" id="6055961">.</span><span class="ident" id="6055962">req</span><span class="op" id="6055965">.</span><span class="ident" id="6055966">URL</span><span class="op" id="6055969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6055973">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6055981">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6055984">r</span><span class="op" id="6055985">.</span><span class="ident" id="6055986">headerSent</span>&nbsp;<span class="op" id="6055997">=</span>&nbsp;<span class="builtintype" id="6055999">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6056005">fmt</span><span class="op" id="6056008">.</span><span class="ident" id="6056009">Fprintf</span><span class="op" id="6056016">(</span><span class="ident" id="6056017">r</span><span class="op" id="6056018">.</span><span class="ident" id="6056019">bufw</span><span class="op" id="6056023">,</span>&nbsp;<span class="string" id="6056025">&#34;Status:&nbsp;%d&nbsp;%s\r\n&#34;</span><span class="op" id="6056044">,</span>&nbsp;<span class="ident" id="6056046">code</span><span class="op" id="6056050">,</span>&nbsp;<span class="ident" id="6056052">http</span><span class="op" id="6056056">.</span><span class="ident" id="6056057">StatusText</span><span class="op" id="6056067">(</span><span class="ident" id="6056068">code</span><span class="op" id="6056072">)</span><span class="op" id="6056073">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6056077">//&nbsp;Set&nbsp;a&nbsp;default&nbsp;Content-Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6056108">if</span>&nbsp;<span class="ident" id="6056111">_</span><span class="op" id="6056112">,</span>&nbsp;<span class="ident" id="6056114">hasType</span>&nbsp;<span class="op" id="6056122">:=</span>&nbsp;<span class="ident" id="6056125">r</span><span class="op" id="6056126">.</span><span class="ident" id="6056127">header</span><span class="op" id="6056133">[</span><span class="string" id="6056134">&#34;Content-Type&#34;</span><span class="op" id="6056148">]</span><span class="op" id="6056149">;</span>&nbsp;<span class="op" id="6056151">!</span><span class="ident" id="6056152">hasType</span>&nbsp;<span class="op" id="6056160">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6056164">r</span><span class="op" id="6056165">.</span><span class="ident" id="6056166">header</span><span class="op" id="6056172">.</span><span class="ident" id="6056173">Add</span><span class="op" id="6056176">(</span><span class="string" id="6056177">&#34;Content-Type&#34;</span><span class="op" id="6056191">,</span>&nbsp;<span class="string" id="6056193">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="6056219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6056222">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6056226">r</span><span class="op" id="6056227">.</span><span class="ident" id="6056228">header</span><span class="op" id="6056234">.</span><span class="ident" id="6056235">Write</span><span class="op" id="6056240">(</span><span class="ident" id="6056241">r</span><span class="op" id="6056242">.</span><span class="ident" id="6056243">bufw</span><span class="op" id="6056247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6056250">r</span><span class="op" id="6056251">.</span><span class="ident" id="6056252">bufw</span><span class="op" id="6056256">.</span><span class="ident" id="6056257">WriteString</span><span class="op" id="6056268">(</span><span class="string" id="6056269">&#34;\r\n&#34;</span><span class="op" id="6056275">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6056278">r</span><span class="op" id="6056279">.</span><span class="ident" id="6056280">bufw</span><span class="op" id="6056284">.</span><span class="ident" id="6056285">Flush</span><span class="op" id="6056290">(</span><span class="op" id="6056291">)</span><br>
<span class="lineno"></span><span class="op" id="6056293">}</span>
</div>
</body>
</html>
