<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="6394168">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6394223">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6394277">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6394328">package</span>&nbsp;<span class="ident" id="6394336">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6394346">import</span>&nbsp;<span class="op" id="6394353">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6394356">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6394365">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6394374">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6394384">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6394391">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6394397">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6394410">&#34;net&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6394417">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6394429">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6394440">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6394451">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6394458">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="6394461">//&nbsp;One&nbsp;of&nbsp;the&nbsp;copies,&nbsp;say&nbsp;from&nbsp;b&nbsp;to&nbsp;r2,&nbsp;could&nbsp;be&nbsp;avoided&nbsp;by&nbsp;using&nbsp;a&nbsp;more</span><br>
<span class="lineno"></span><span class="comment" id="6394534">//&nbsp;elaborate&nbsp;trick&nbsp;where&nbsp;the&nbsp;other&nbsp;copy&nbsp;is&nbsp;made&nbsp;during&nbsp;Request/Response.Write.</span><br>
<span class="lineno"></span><span class="comment" id="6394613">//&nbsp;This&nbsp;would&nbsp;complicate&nbsp;things&nbsp;too&nbsp;much,&nbsp;given&nbsp;that&nbsp;these&nbsp;functions&nbsp;are&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="6394690">//&nbsp;debugging&nbsp;only.</span><br>
<span class="lineno">25</span><span class="keyword" id="6394709">func</span>&nbsp;<span class="ident" id="6394714">drainBody</span><span class="op" id="6394723">(</span><span class="ident" id="6394724">b</span>&nbsp;<span class="ident" id="6394726">io</span><span class="op" id="6394728">.</span><span class="ident" id="6394729">ReadCloser</span><span class="op" id="6394739">)</span>&nbsp;<span class="op" id="6394741">(</span><span class="ident" id="6394742">r1</span><span class="op" id="6394744">,</span>&nbsp;<span class="ident" id="6394746">r2</span>&nbsp;<span class="ident" id="6394749">io</span><span class="op" id="6394751">.</span><span class="ident" id="6394752">ReadCloser</span><span class="op" id="6394762">,</span>&nbsp;<span class="ident" id="6394764">err</span>&nbsp;<span class="builtintype" id="6394768">error</span><span class="op" id="6394773">)</span>&nbsp;<span class="op" id="6394775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6394778">var</span>&nbsp;<span class="ident" id="6394782">buf</span>&nbsp;<span class="ident" id="6394786">bytes</span><span class="op" id="6394791">.</span><span class="ident" id="6394792">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6394800">if</span>&nbsp;<span class="ident" id="6394803">_</span><span class="op" id="6394804">,</span>&nbsp;<span class="ident" id="6394806">err</span>&nbsp;<span class="op" id="6394810">=</span>&nbsp;<span class="ident" id="6394812">buf</span><span class="op" id="6394815">.</span><span class="ident" id="6394816">ReadFrom</span><span class="op" id="6394824">(</span><span class="ident" id="6394825">b</span><span class="op" id="6394826">)</span><span class="op" id="6394827">;</span>&nbsp;<span class="ident" id="6394829">err</span>&nbsp;<span class="op" id="6394833">!=</span>&nbsp;<span class="ident" id="6394836">nil</span>&nbsp;<span class="op" id="6394840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6394844">return</span>&nbsp;<span class="ident" id="6394851">nil</span><span class="op" id="6394854">,</span>&nbsp;<span class="ident" id="6394856">nil</span><span class="op" id="6394859">,</span>&nbsp;<span class="ident" id="6394861">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6394866">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6394869">if</span>&nbsp;<span class="ident" id="6394872">err</span>&nbsp;<span class="op" id="6394876">=</span>&nbsp;<span class="ident" id="6394878">b</span><span class="op" id="6394879">.</span><span class="ident" id="6394880">Close</span><span class="op" id="6394885">(</span><span class="op" id="6394886">)</span><span class="op" id="6394887">;</span>&nbsp;<span class="ident" id="6394889">err</span>&nbsp;<span class="op" id="6394893">!=</span>&nbsp;<span class="ident" id="6394896">nil</span>&nbsp;<span class="op" id="6394900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6394904">return</span>&nbsp;<span class="ident" id="6394911">nil</span><span class="op" id="6394914">,</span>&nbsp;<span class="ident" id="6394916">nil</span><span class="op" id="6394919">,</span>&nbsp;<span class="ident" id="6394921">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6394926">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6394929">return</span>&nbsp;<span class="ident" id="6394936">ioutil</span><span class="op" id="6394942">.</span><span class="ident" id="6394943">NopCloser</span><span class="op" id="6394952">(</span><span class="op" id="6394953">&amp;</span><span class="ident" id="6394954">buf</span><span class="op" id="6394957">)</span><span class="op" id="6394958">,</span>&nbsp;<span class="ident" id="6394960">ioutil</span><span class="op" id="6394966">.</span><span class="ident" id="6394967">NopCloser</span><span class="op" id="6394976">(</span><span class="ident" id="6394977">bytes</span><span class="op" id="6394982">.</span><span class="ident" id="6394983">NewReader</span><span class="op" id="6394992">(</span><span class="ident" id="6394993">buf</span><span class="op" id="6394996">.</span><span class="ident" id="6394997">Bytes</span><span class="op" id="6395002">(</span><span class="op" id="6395003">)</span><span class="op" id="6395004">)</span><span class="op" id="6395005">)</span><span class="op" id="6395006">,</span>&nbsp;<span class="ident" id="6395008">nil</span><br>
<span class="lineno"></span><span class="op" id="6395012">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="6395015">//&nbsp;dumpConn&nbsp;is&nbsp;a&nbsp;net.Conn&nbsp;which&nbsp;writes&nbsp;to&nbsp;Writer&nbsp;and&nbsp;reads&nbsp;from&nbsp;Reader</span><br>
<span class="lineno"></span><span class="keyword" id="6395086">type</span>&nbsp;<span class="ident" id="6395091">dumpConn</span>&nbsp;<span class="keyword" id="6395100">struct</span>&nbsp;<span class="op" id="6395107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6395110">io</span><span class="op" id="6395112">.</span><span class="ident" id="6395113">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6395121">io</span><span class="op" id="6395123">.</span><span class="ident" id="6395124">Reader</span><br>
<span class="lineno">40</span><span class="op" id="6395131">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6395134">func</span>&nbsp;<span class="op" id="6395139">(</span><span class="ident" id="6395140">c</span>&nbsp;<span class="op" id="6395142">*</span><span class="ident" id="6395143">dumpConn</span><span class="op" id="6395151">)</span>&nbsp;<span class="ident" id="6395153">Close</span><span class="op" id="6395158">(</span><span class="op" id="6395159">)</span>&nbsp;<span class="builtintype" id="6395161">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6395189">{</span>&nbsp;<span class="keyword" id="6395191">return</span>&nbsp;<span class="ident" id="6395198">nil</span>&nbsp;<span class="op" id="6395202">}</span><br>
<span class="lineno"></span><span class="keyword" id="6395204">func</span>&nbsp;<span class="op" id="6395209">(</span><span class="ident" id="6395210">c</span>&nbsp;<span class="op" id="6395212">*</span><span class="ident" id="6395213">dumpConn</span><span class="op" id="6395221">)</span>&nbsp;<span class="ident" id="6395223">LocalAddr</span><span class="op" id="6395232">(</span><span class="op" id="6395233">)</span>&nbsp;<span class="ident" id="6395235">net</span><span class="op" id="6395238">.</span><span class="ident" id="6395239">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6395259">{</span>&nbsp;<span class="keyword" id="6395261">return</span>&nbsp;<span class="ident" id="6395268">nil</span>&nbsp;<span class="op" id="6395272">}</span><br>
<span class="lineno"></span><span class="keyword" id="6395274">func</span>&nbsp;<span class="op" id="6395279">(</span><span class="ident" id="6395280">c</span>&nbsp;<span class="op" id="6395282">*</span><span class="ident" id="6395283">dumpConn</span><span class="op" id="6395291">)</span>&nbsp;<span class="ident" id="6395293">RemoteAddr</span><span class="op" id="6395303">(</span><span class="op" id="6395304">)</span>&nbsp;<span class="ident" id="6395306">net</span><span class="op" id="6395309">.</span><span class="ident" id="6395310">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6395329">{</span>&nbsp;<span class="keyword" id="6395331">return</span>&nbsp;<span class="ident" id="6395338">nil</span>&nbsp;<span class="op" id="6395342">}</span><br>
<span class="lineno">45</span><span class="keyword" id="6395344">func</span>&nbsp;<span class="op" id="6395349">(</span><span class="ident" id="6395350">c</span>&nbsp;<span class="op" id="6395352">*</span><span class="ident" id="6395353">dumpConn</span><span class="op" id="6395361">)</span>&nbsp;<span class="ident" id="6395363">SetDeadline</span><span class="op" id="6395374">(</span><span class="ident" id="6395375">t</span>&nbsp;<span class="ident" id="6395377">time</span><span class="op" id="6395381">.</span><span class="ident" id="6395382">Time</span><span class="op" id="6395386">)</span>&nbsp;<span class="builtintype" id="6395388">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6395399">{</span>&nbsp;<span class="keyword" id="6395401">return</span>&nbsp;<span class="ident" id="6395408">nil</span>&nbsp;<span class="op" id="6395412">}</span><br>
<span class="lineno"></span><span class="keyword" id="6395414">func</span>&nbsp;<span class="op" id="6395419">(</span><span class="ident" id="6395420">c</span>&nbsp;<span class="op" id="6395422">*</span><span class="ident" id="6395423">dumpConn</span><span class="op" id="6395431">)</span>&nbsp;<span class="ident" id="6395433">SetReadDeadline</span><span class="op" id="6395448">(</span><span class="ident" id="6395449">t</span>&nbsp;<span class="ident" id="6395451">time</span><span class="op" id="6395455">.</span><span class="ident" id="6395456">Time</span><span class="op" id="6395460">)</span>&nbsp;<span class="builtintype" id="6395462">error</span>&nbsp;&nbsp;<span class="op" id="6395469">{</span>&nbsp;<span class="keyword" id="6395471">return</span>&nbsp;<span class="ident" id="6395478">nil</span>&nbsp;<span class="op" id="6395482">}</span><br>
<span class="lineno"></span><span class="keyword" id="6395484">func</span>&nbsp;<span class="op" id="6395489">(</span><span class="ident" id="6395490">c</span>&nbsp;<span class="op" id="6395492">*</span><span class="ident" id="6395493">dumpConn</span><span class="op" id="6395501">)</span>&nbsp;<span class="ident" id="6395503">SetWriteDeadline</span><span class="op" id="6395519">(</span><span class="ident" id="6395520">t</span>&nbsp;<span class="ident" id="6395522">time</span><span class="op" id="6395526">.</span><span class="ident" id="6395527">Time</span><span class="op" id="6395531">)</span>&nbsp;<span class="builtintype" id="6395533">error</span>&nbsp;<span class="op" id="6395539">{</span>&nbsp;<span class="keyword" id="6395541">return</span>&nbsp;<span class="ident" id="6395548">nil</span>&nbsp;<span class="op" id="6395552">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6395555">type</span>&nbsp;<span class="ident" id="6395560">neverEnding</span>&nbsp;<span class="builtintype" id="6395572">byte</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="6395578">func</span>&nbsp;<span class="op" id="6395583">(</span><span class="ident" id="6395584">b</span>&nbsp;<span class="ident" id="6395586">neverEnding</span><span class="op" id="6395597">)</span>&nbsp;<span class="ident" id="6395599">Read</span><span class="op" id="6395603">(</span><span class="ident" id="6395604">p</span>&nbsp;<span class="op" id="6395606">[</span><span class="op" id="6395607">]</span><span class="builtintype" id="6395608">byte</span><span class="op" id="6395612">)</span>&nbsp;<span class="op" id="6395614">(</span><span class="ident" id="6395615">n</span>&nbsp;<span class="builtintype" id="6395617">int</span><span class="op" id="6395620">,</span>&nbsp;<span class="ident" id="6395622">err</span>&nbsp;<span class="builtintype" id="6395626">error</span><span class="op" id="6395631">)</span>&nbsp;<span class="op" id="6395633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6395636">for</span>&nbsp;<span class="ident" id="6395640">i</span>&nbsp;<span class="op" id="6395642">:=</span>&nbsp;<span class="keyword" id="6395645">range</span>&nbsp;<span class="ident" id="6395651">p</span>&nbsp;<span class="op" id="6395653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6395657">p</span><span class="op" id="6395658">[</span><span class="ident" id="6395659">i</span><span class="op" id="6395660">]</span>&nbsp;<span class="op" id="6395662">=</span>&nbsp;<span class="builtintype" id="6395664">byte</span><span class="op" id="6395668">(</span><span class="ident" id="6395669">b</span><span class="op" id="6395670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6395673">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6395676">return</span>&nbsp;<span class="builtinfunc" id="6395683">len</span><span class="op" id="6395686">(</span><span class="ident" id="6395687">p</span><span class="op" id="6395688">)</span><span class="op" id="6395689">,</span>&nbsp;<span class="ident" id="6395691">nil</span><br>
<span class="lineno"></span><span class="op" id="6395695">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6395698">//&nbsp;DumpRequestOut&nbsp;is&nbsp;like&nbsp;DumpRequest&nbsp;but&nbsp;includes</span><br>
<span class="lineno"></span><span class="comment" id="6395749">//&nbsp;headers&nbsp;that&nbsp;the&nbsp;standard&nbsp;http.Transport&nbsp;adds,</span><br>
<span class="lineno">60</span><span class="comment" id="6395799">//&nbsp;such&nbsp;as&nbsp;User-Agent.</span><br>
<span class="lineno"></span><span class="keyword" id="6395822">func</span>&nbsp;<span class="ident" id="6395827">DumpRequestOut</span><span class="op" id="6395841">(</span><span class="ident" id="6395842">req</span>&nbsp;<span class="op" id="6395846">*</span><span class="ident" id="6395847">http</span><span class="op" id="6395851">.</span><span class="ident" id="6395852">Request</span><span class="op" id="6395859">,</span>&nbsp;<span class="ident" id="6395861">body</span>&nbsp;<span class="builtintype" id="6395866">bool</span><span class="op" id="6395870">)</span>&nbsp;<span class="op" id="6395872">(</span><span class="op" id="6395873">[</span><span class="op" id="6395874">]</span><span class="builtintype" id="6395875">byte</span><span class="op" id="6395879">,</span>&nbsp;<span class="builtintype" id="6395881">error</span><span class="op" id="6395886">)</span>&nbsp;<span class="op" id="6395888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6395891">save</span>&nbsp;<span class="op" id="6395896">:=</span>&nbsp;<span class="ident" id="6395899">req</span><span class="op" id="6395902">.</span><span class="ident" id="6395903">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6395909">dummyBody</span>&nbsp;<span class="op" id="6395919">:=</span>&nbsp;<span class="builtintype" id="6395922">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6395929">if</span>&nbsp;<span class="op" id="6395932">!</span><span class="ident" id="6395933">body</span>&nbsp;<span class="op" id="6395938">||</span>&nbsp;<span class="ident" id="6395941">req</span><span class="op" id="6395944">.</span><span class="ident" id="6395945">Body</span>&nbsp;<span class="op" id="6395950">==</span>&nbsp;<span class="ident" id="6395953">nil</span>&nbsp;<span class="op" id="6395957">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6395961">req</span><span class="op" id="6395964">.</span><span class="ident" id="6395965">Body</span>&nbsp;<span class="op" id="6395970">=</span>&nbsp;<span class="ident" id="6395972">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6395978">if</span>&nbsp;<span class="ident" id="6395981">req</span><span class="op" id="6395984">.</span><span class="ident" id="6395985">ContentLength</span>&nbsp;<span class="op" id="6395999">!=</span>&nbsp;<span class="num" id="6396002">0</span>&nbsp;<span class="op" id="6396004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6396009">req</span><span class="op" id="6396012">.</span><span class="ident" id="6396013">Body</span>&nbsp;<span class="op" id="6396018">=</span>&nbsp;<span class="ident" id="6396020">ioutil</span><span class="op" id="6396026">.</span><span class="ident" id="6396027">NopCloser</span><span class="op" id="6396036">(</span><span class="ident" id="6396037">io</span><span class="op" id="6396039">.</span><span class="ident" id="6396040">LimitReader</span><span class="op" id="6396051">(</span><span class="ident" id="6396052">neverEnding</span><span class="op" id="6396063">(</span><span class="string" id="6396064">&#39;x&#39;</span><span class="op" id="6396067">)</span><span class="op" id="6396068">,</span>&nbsp;<span class="ident" id="6396070">req</span><span class="op" id="6396073">.</span><span class="ident" id="6396074">ContentLength</span><span class="op" id="6396087">)</span><span class="op" id="6396088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6396093">dummyBody</span>&nbsp;<span class="op" id="6396103">=</span>&nbsp;<span class="builtintype" id="6396105">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6396112">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6396115">}</span>&nbsp;<span class="keyword" id="6396117">else</span>&nbsp;<span class="op" id="6396122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6396126">var</span>&nbsp;<span class="ident" id="6396130">err</span>&nbsp;<span class="builtintype" id="6396134">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6396142">save</span><span class="op" id="6396146">,</span>&nbsp;<span class="ident" id="6396148">req</span><span class="op" id="6396151">.</span><span class="ident" id="6396152">Body</span><span class="op" id="6396156">,</span>&nbsp;<span class="ident" id="6396158">err</span>&nbsp;<span class="op" id="6396162">=</span>&nbsp;<span class="ident" id="6396164">drainBody</span><span class="op" id="6396173">(</span><span class="ident" id="6396174">req</span><span class="op" id="6396177">.</span><span class="ident" id="6396178">Body</span><span class="op" id="6396182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6396186">if</span>&nbsp;<span class="ident" id="6396189">err</span>&nbsp;<span class="op" id="6396193">!=</span>&nbsp;<span class="ident" id="6396196">nil</span>&nbsp;<span class="op" id="6396200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6396205">return</span>&nbsp;<span class="ident" id="6396212">nil</span><span class="op" id="6396215">,</span>&nbsp;<span class="ident" id="6396217">err</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6396223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6396226">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6396230">//&nbsp;Since&nbsp;we&#39;re&nbsp;using&nbsp;the&nbsp;actual&nbsp;Transport&nbsp;code&nbsp;to&nbsp;write&nbsp;the&nbsp;request,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6396300">//&nbsp;switch&nbsp;to&nbsp;http&nbsp;so&nbsp;the&nbsp;Transport&nbsp;doesn&#39;t&nbsp;try&nbsp;to&nbsp;do&nbsp;an&nbsp;SSL</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6396361">//&nbsp;negotiation&nbsp;with&nbsp;our&nbsp;dumpConn&nbsp;and&nbsp;its&nbsp;bytes.Buffer&nbsp;&amp;&nbsp;pipe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6396424">//&nbsp;The&nbsp;wire&nbsp;format&nbsp;for&nbsp;https&nbsp;and&nbsp;http&nbsp;are&nbsp;the&nbsp;same,&nbsp;anyway.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6396485">reqSend</span>&nbsp;<span class="op" id="6396493">:=</span>&nbsp;<span class="ident" id="6396496">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6396501">if</span>&nbsp;<span class="ident" id="6396504">req</span><span class="op" id="6396507">.</span><span class="ident" id="6396508">URL</span><span class="op" id="6396511">.</span><span class="ident" id="6396512">Scheme</span>&nbsp;<span class="op" id="6396519">==</span>&nbsp;<span class="string" id="6396522">&#34;https&#34;</span>&nbsp;<span class="op" id="6396530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6396534">reqSend</span>&nbsp;<span class="op" id="6396542">=</span>&nbsp;<span class="builtinfunc" id="6396544">new</span><span class="op" id="6396547">(</span><span class="ident" id="6396548">http</span><span class="op" id="6396552">.</span><span class="ident" id="6396553">Request</span><span class="op" id="6396560">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6396564">*</span><span class="ident" id="6396565">reqSend</span>&nbsp;<span class="op" id="6396573">=</span>&nbsp;<span class="op" id="6396575">*</span><span class="ident" id="6396576">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6396582">reqSend</span><span class="op" id="6396589">.</span><span class="ident" id="6396590">URL</span>&nbsp;<span class="op" id="6396594">=</span>&nbsp;<span class="builtinfunc" id="6396596">new</span><span class="op" id="6396599">(</span><span class="ident" id="6396600">url</span><span class="op" id="6396603">.</span><span class="ident" id="6396604">URL</span><span class="op" id="6396607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6396611">*</span><span class="ident" id="6396612">reqSend</span><span class="op" id="6396619">.</span><span class="ident" id="6396620">URL</span>&nbsp;<span class="op" id="6396624">=</span>&nbsp;<span class="op" id="6396626">*</span><span class="ident" id="6396627">req</span><span class="op" id="6396630">.</span><span class="ident" id="6396631">URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6396637">reqSend</span><span class="op" id="6396644">.</span><span class="ident" id="6396645">URL</span><span class="op" id="6396648">.</span><span class="ident" id="6396649">Scheme</span>&nbsp;<span class="op" id="6396656">=</span>&nbsp;<span class="string" id="6396658">&#34;http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6396666">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6396670">//&nbsp;Use&nbsp;the&nbsp;actual&nbsp;Transport&nbsp;code&nbsp;to&nbsp;record&nbsp;what&nbsp;we&nbsp;would&nbsp;send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6396733">//&nbsp;on&nbsp;the&nbsp;wire,&nbsp;but&nbsp;not&nbsp;using&nbsp;TCP.&nbsp;&nbsp;Use&nbsp;a&nbsp;Transport&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6396793">//&nbsp;custom&nbsp;dialer&nbsp;that&nbsp;returns&nbsp;a&nbsp;fake&nbsp;net.Conn&nbsp;that&nbsp;waits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6396851">//&nbsp;for&nbsp;the&nbsp;full&nbsp;input&nbsp;(and&nbsp;recording&nbsp;it),&nbsp;and&nbsp;then&nbsp;responds</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6396912">//&nbsp;with&nbsp;a&nbsp;dummy&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6396939">var</span>&nbsp;<span class="ident" id="6396943">buf</span>&nbsp;<span class="ident" id="6396947">bytes</span><span class="op" id="6396952">.</span><span class="ident" id="6396953">Buffer</span>&nbsp;<span class="comment" id="6396960">//&nbsp;records&nbsp;the&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6396983">pr</span><span class="op" id="6396985">,</span>&nbsp;<span class="ident" id="6396987">pw</span>&nbsp;<span class="op" id="6396990">:=</span>&nbsp;<span class="ident" id="6396993">io</span><span class="op" id="6396995">.</span><span class="ident" id="6396996">Pipe</span><span class="op" id="6397000">(</span><span class="op" id="6397001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6397004">defer</span>&nbsp;<span class="ident" id="6397010">pr</span><span class="op" id="6397012">.</span><span class="ident" id="6397013">Close</span><span class="op" id="6397018">(</span><span class="op" id="6397019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6397022">defer</span>&nbsp;<span class="ident" id="6397028">pw</span><span class="op" id="6397030">.</span><span class="ident" id="6397031">Close</span><span class="op" id="6397036">(</span><span class="op" id="6397037">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6397040">dr</span>&nbsp;<span class="op" id="6397043">:=</span>&nbsp;<span class="op" id="6397046">&amp;</span><span class="ident" id="6397047">delegateReader</span><span class="op" id="6397061">{</span><span class="ident" id="6397062">c</span><span class="op" id="6397063">:</span>&nbsp;<span class="builtinfunc" id="6397065">make</span><span class="op" id="6397069">(</span><span class="keyword" id="6397070">chan</span>&nbsp;<span class="ident" id="6397075">io</span><span class="op" id="6397077">.</span><span class="ident" id="6397078">Reader</span><span class="op" id="6397084">)</span><span class="op" id="6397085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6397088">//&nbsp;Wait&nbsp;for&nbsp;the&nbsp;request&nbsp;before&nbsp;replying&nbsp;with&nbsp;a&nbsp;dummy&nbsp;response:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6397152">go</span>&nbsp;<span class="keyword" id="6397155">func</span><span class="op" id="6397159">(</span><span class="op" id="6397160">)</span>&nbsp;<span class="op" id="6397162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6397166">req</span><span class="op" id="6397169">,</span>&nbsp;<span class="ident" id="6397171">err</span>&nbsp;<span class="op" id="6397175">:=</span>&nbsp;<span class="ident" id="6397178">http</span><span class="op" id="6397182">.</span><span class="ident" id="6397183">ReadRequest</span><span class="op" id="6397194">(</span><span class="ident" id="6397195">bufio</span><span class="op" id="6397200">.</span><span class="ident" id="6397201">NewReader</span><span class="op" id="6397210">(</span><span class="ident" id="6397211">pr</span><span class="op" id="6397213">)</span><span class="op" id="6397214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6397218">if</span>&nbsp;<span class="ident" id="6397221">err</span>&nbsp;<span class="op" id="6397225">==</span>&nbsp;<span class="ident" id="6397228">nil</span>&nbsp;<span class="op" id="6397232">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6397237">//&nbsp;Ensure&nbsp;all&nbsp;the&nbsp;body&nbsp;is&nbsp;read;&nbsp;otherwise</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6397282">//&nbsp;we&#39;ll&nbsp;get&nbsp;a&nbsp;partial&nbsp;dump.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6397314">io</span><span class="op" id="6397316">.</span><span class="ident" id="6397317">Copy</span><span class="op" id="6397321">(</span><span class="ident" id="6397322">ioutil</span><span class="op" id="6397328">.</span><span class="ident" id="6397329">Discard</span><span class="op" id="6397336">,</span>&nbsp;<span class="ident" id="6397338">req</span><span class="op" id="6397341">.</span><span class="ident" id="6397342">Body</span><span class="op" id="6397346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6397351">req</span><span class="op" id="6397354">.</span><span class="ident" id="6397355">Body</span><span class="op" id="6397359">.</span><span class="ident" id="6397360">Close</span><span class="op" id="6397365">(</span><span class="op" id="6397366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6397370">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6397374">dr</span><span class="op" id="6397376">.</span><span class="ident" id="6397377">c</span>&nbsp;<span class="op" id="6397379">&lt;-</span>&nbsp;<span class="ident" id="6397382">strings</span><span class="op" id="6397389">.</span><span class="ident" id="6397390">NewReader</span><span class="op" id="6397399">(</span><span class="string" id="6397400">&#34;HTTP/1.1&nbsp;204&nbsp;No&nbsp;Content\r\n\r\n&#34;</span><span class="op" id="6397433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6397436">}</span><span class="op" id="6397437">(</span><span class="op" id="6397438">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6397442">t</span>&nbsp;<span class="op" id="6397444">:=</span>&nbsp;<span class="op" id="6397447">&amp;</span><span class="ident" id="6397448">http</span><span class="op" id="6397452">.</span><span class="ident" id="6397453">Transport</span><span class="op" id="6397462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6397466">DisableKeepAlives</span><span class="op" id="6397483">:</span>&nbsp;<span class="builtintype" id="6397485">true</span><span class="op" id="6397489">,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6397493">Dial</span><span class="op" id="6397497">:</span>&nbsp;<span class="keyword" id="6397499">func</span><span class="op" id="6397503">(</span><span class="ident" id="6397504">net</span><span class="op" id="6397507">,</span>&nbsp;<span class="ident" id="6397509">addr</span>&nbsp;<span class="builtintype" id="6397514">string</span><span class="op" id="6397520">)</span>&nbsp;<span class="op" id="6397522">(</span><span class="ident" id="6397523">net</span><span class="op" id="6397526">.</span><span class="ident" id="6397527">Conn</span><span class="op" id="6397531">,</span>&nbsp;<span class="builtintype" id="6397533">error</span><span class="op" id="6397538">)</span>&nbsp;<span class="op" id="6397540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6397545">return</span>&nbsp;<span class="op" id="6397552">&amp;</span><span class="ident" id="6397553">dumpConn</span><span class="op" id="6397561">{</span><span class="ident" id="6397562">io</span><span class="op" id="6397564">.</span><span class="ident" id="6397565">MultiWriter</span><span class="op" id="6397576">(</span><span class="op" id="6397577">&amp;</span><span class="ident" id="6397578">buf</span><span class="op" id="6397581">,</span>&nbsp;<span class="ident" id="6397583">pw</span><span class="op" id="6397585">)</span><span class="op" id="6397586">,</span>&nbsp;<span class="ident" id="6397588">dr</span><span class="op" id="6397590">}</span><span class="op" id="6397591">,</span>&nbsp;<span class="ident" id="6397593">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6397599">}</span><span class="op" id="6397600">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6397603">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6397607">_</span><span class="op" id="6397608">,</span>&nbsp;<span class="ident" id="6397610">err</span>&nbsp;<span class="op" id="6397614">:=</span>&nbsp;<span class="ident" id="6397617">t</span><span class="op" id="6397618">.</span><span class="ident" id="6397619">RoundTrip</span><span class="op" id="6397628">(</span><span class="ident" id="6397629">reqSend</span><span class="op" id="6397636">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6397640">req</span><span class="op" id="6397643">.</span><span class="ident" id="6397644">Body</span>&nbsp;<span class="op" id="6397649">=</span>&nbsp;<span class="ident" id="6397651">save</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6397657">if</span>&nbsp;<span class="ident" id="6397660">err</span>&nbsp;<span class="op" id="6397664">!=</span>&nbsp;<span class="ident" id="6397667">nil</span>&nbsp;<span class="op" id="6397671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6397675">return</span>&nbsp;<span class="ident" id="6397682">nil</span><span class="op" id="6397685">,</span>&nbsp;<span class="ident" id="6397687">err</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6397692">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6397695">dump</span>&nbsp;<span class="op" id="6397700">:=</span>&nbsp;<span class="ident" id="6397703">buf</span><span class="op" id="6397706">.</span><span class="ident" id="6397707">Bytes</span><span class="op" id="6397712">(</span><span class="op" id="6397713">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6397717">//&nbsp;If&nbsp;we&nbsp;used&nbsp;a&nbsp;dummy&nbsp;body&nbsp;above,&nbsp;remove&nbsp;it&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6397767">//&nbsp;TODO:&nbsp;if&nbsp;the&nbsp;req.ContentLength&nbsp;is&nbsp;large,&nbsp;we&nbsp;allocate&nbsp;memory</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6397831">//&nbsp;unnecessarily&nbsp;just&nbsp;to&nbsp;slice&nbsp;it&nbsp;off&nbsp;here.&nbsp;&nbsp;But&nbsp;this&nbsp;is&nbsp;just</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6397894">//&nbsp;a&nbsp;debug&nbsp;function,&nbsp;so&nbsp;this&nbsp;is&nbsp;acceptable&nbsp;for&nbsp;now.&nbsp;We&nbsp;could</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6397956">//&nbsp;discard&nbsp;the&nbsp;body&nbsp;earlier&nbsp;if&nbsp;this&nbsp;matters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6398002">if</span>&nbsp;<span class="ident" id="6398005">dummyBody</span>&nbsp;<span class="op" id="6398015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6398019">if</span>&nbsp;<span class="ident" id="6398022">i</span>&nbsp;<span class="op" id="6398024">:=</span>&nbsp;<span class="ident" id="6398027">bytes</span><span class="op" id="6398032">.</span><span class="ident" id="6398033">Index</span><span class="op" id="6398038">(</span><span class="ident" id="6398039">dump</span><span class="op" id="6398043">,</span>&nbsp;<span class="op" id="6398045">[</span><span class="op" id="6398046">]</span><span class="builtintype" id="6398047">byte</span><span class="op" id="6398051">(</span><span class="string" id="6398052">&#34;\r\n\r\n&#34;</span><span class="op" id="6398062">)</span><span class="op" id="6398063">)</span><span class="op" id="6398064">;</span>&nbsp;<span class="ident" id="6398066">i</span>&nbsp;<span class="op" id="6398068">&gt;=</span>&nbsp;<span class="num" id="6398071">0</span>&nbsp;<span class="op" id="6398073">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6398078">dump</span>&nbsp;<span class="op" id="6398083">=</span>&nbsp;<span class="ident" id="6398085">dump</span><span class="op" id="6398089">[</span><span class="op" id="6398090">:</span><span class="ident" id="6398091">i</span><span class="op" id="6398092">+</span><span class="num" id="6398093">4</span><span class="op" id="6398094">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6398098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6398101">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6398104">return</span>&nbsp;<span class="ident" id="6398111">dump</span><span class="op" id="6398115">,</span>&nbsp;<span class="ident" id="6398117">nil</span><br>
<span class="lineno"></span><span class="op" id="6398121">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="comment" id="6398124">//&nbsp;delegateReader&nbsp;is&nbsp;a&nbsp;reader&nbsp;that&nbsp;delegates&nbsp;to&nbsp;another&nbsp;reader,</span><br>
<span class="lineno"></span><span class="comment" id="6398188">//&nbsp;once&nbsp;it&nbsp;arrives&nbsp;on&nbsp;a&nbsp;channel.</span><br>
<span class="lineno"></span><span class="keyword" id="6398221">type</span>&nbsp;<span class="ident" id="6398226">delegateReader</span>&nbsp;<span class="keyword" id="6398241">struct</span>&nbsp;<span class="op" id="6398248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6398251">c</span>&nbsp;<span class="keyword" id="6398253">chan</span>&nbsp;<span class="ident" id="6398258">io</span><span class="op" id="6398260">.</span><span class="ident" id="6398261">Reader</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6398269">r</span>&nbsp;<span class="ident" id="6398271">io</span><span class="op" id="6398273">.</span><span class="ident" id="6398274">Reader</span>&nbsp;<span class="comment" id="6398281">//&nbsp;nil&nbsp;until&nbsp;received&nbsp;from&nbsp;c</span><br>
<span class="lineno"></span><span class="op" id="6398310">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6398313">func</span>&nbsp;<span class="op" id="6398318">(</span><span class="ident" id="6398319">r</span>&nbsp;<span class="op" id="6398321">*</span><span class="ident" id="6398322">delegateReader</span><span class="op" id="6398336">)</span>&nbsp;<span class="ident" id="6398338">Read</span><span class="op" id="6398342">(</span><span class="ident" id="6398343">p</span>&nbsp;<span class="op" id="6398345">[</span><span class="op" id="6398346">]</span><span class="builtintype" id="6398347">byte</span><span class="op" id="6398351">)</span>&nbsp;<span class="op" id="6398353">(</span><span class="builtintype" id="6398354">int</span><span class="op" id="6398357">,</span>&nbsp;<span class="builtintype" id="6398359">error</span><span class="op" id="6398364">)</span>&nbsp;<span class="op" id="6398366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6398369">if</span>&nbsp;<span class="ident" id="6398372">r</span><span class="op" id="6398373">.</span><span class="ident" id="6398374">r</span>&nbsp;<span class="op" id="6398376">==</span>&nbsp;<span class="ident" id="6398379">nil</span>&nbsp;<span class="op" id="6398383">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6398387">r</span><span class="op" id="6398388">.</span><span class="ident" id="6398389">r</span>&nbsp;<span class="op" id="6398391">=</span>&nbsp;<span class="op" id="6398393">&lt;-</span><span class="ident" id="6398395">r</span><span class="op" id="6398396">.</span><span class="ident" id="6398397">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6398400">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6398403">return</span>&nbsp;<span class="ident" id="6398410">r</span><span class="op" id="6398411">.</span><span class="ident" id="6398412">r</span><span class="op" id="6398413">.</span><span class="ident" id="6398414">Read</span><span class="op" id="6398418">(</span><span class="ident" id="6398419">p</span><span class="op" id="6398420">)</span><br>
<span class="lineno"></span><span class="op" id="6398422">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span><span class="comment" id="6398425">//&nbsp;Return&nbsp;value&nbsp;if&nbsp;nonempty,&nbsp;def&nbsp;otherwise.</span><br>
<span class="lineno"></span><span class="keyword" id="6398469">func</span>&nbsp;<span class="ident" id="6398474">valueOrDefault</span><span class="op" id="6398488">(</span><span class="ident" id="6398489">value</span><span class="op" id="6398494">,</span>&nbsp;<span class="ident" id="6398496">def</span>&nbsp;<span class="builtintype" id="6398500">string</span><span class="op" id="6398506">)</span>&nbsp;<span class="builtintype" id="6398508">string</span>&nbsp;<span class="op" id="6398515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6398518">if</span>&nbsp;<span class="ident" id="6398521">value</span>&nbsp;<span class="op" id="6398527">!=</span>&nbsp;<span class="string" id="6398530">&#34;&#34;</span>&nbsp;<span class="op" id="6398533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6398537">return</span>&nbsp;<span class="ident" id="6398544">value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6398551">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6398554">return</span>&nbsp;<span class="ident" id="6398561">def</span><br>
<span class="lineno"></span><span class="op" id="6398565">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6398568">var</span>&nbsp;<span class="ident" id="6398572">reqWriteExcludeHeaderDump</span>&nbsp;<span class="op" id="6398598">=</span>&nbsp;<span class="keyword" id="6398600">map</span><span class="op" id="6398603">[</span><span class="builtintype" id="6398604">string</span><span class="op" id="6398610">]</span><span class="builtintype" id="6398611">bool</span><span class="op" id="6398615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6398618">&#34;Host&#34;</span><span class="op" id="6398624">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6398639">true</span><span class="op" id="6398643">,</span>&nbsp;<span class="comment" id="6398645">//&nbsp;not&nbsp;in&nbsp;Header&nbsp;map&nbsp;anyway</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6398674">&#34;Content-Length&#34;</span><span class="op" id="6398690">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6398695">true</span><span class="op" id="6398699">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6398702">&#34;Transfer-Encoding&#34;</span><span class="op" id="6398721">:</span>&nbsp;<span class="builtintype" id="6398723">true</span><span class="op" id="6398727">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6398730">&#34;Trailer&#34;</span><span class="op" id="6398739">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6398751">true</span><span class="op" id="6398755">,</span><br>
<span class="lineno"></span><span class="op" id="6398757">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="comment" id="6398760">//&nbsp;dumpAsReceived&nbsp;writes&nbsp;req&nbsp;to&nbsp;w&nbsp;in&nbsp;the&nbsp;form&nbsp;as&nbsp;it&nbsp;was&nbsp;received,&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="6398829">//&nbsp;at&nbsp;least&nbsp;as&nbsp;accurately&nbsp;as&nbsp;possible&nbsp;from&nbsp;the&nbsp;information&nbsp;retained&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="6398900">//&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span><span class="keyword" id="6398916">func</span>&nbsp;<span class="ident" id="6398921">dumpAsReceived</span><span class="op" id="6398935">(</span><span class="ident" id="6398936">req</span>&nbsp;<span class="op" id="6398940">*</span><span class="ident" id="6398941">http</span><span class="op" id="6398945">.</span><span class="ident" id="6398946">Request</span><span class="op" id="6398953">,</span>&nbsp;<span class="ident" id="6398955">w</span>&nbsp;<span class="ident" id="6398957">io</span><span class="op" id="6398959">.</span><span class="ident" id="6398960">Writer</span><span class="op" id="6398966">)</span>&nbsp;<span class="builtintype" id="6398968">error</span>&nbsp;<span class="op" id="6398974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6398977">return</span>&nbsp;<span class="ident" id="6398984">nil</span><br>
<span class="lineno">175</span><span class="op" id="6398988">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6398991">//&nbsp;DumpRequest&nbsp;returns&nbsp;the&nbsp;as-received&nbsp;wire&nbsp;representation&nbsp;of&nbsp;req,</span><br>
<span class="lineno"></span><span class="comment" id="6399058">//&nbsp;optionally&nbsp;including&nbsp;the&nbsp;request&nbsp;body,&nbsp;for&nbsp;debugging.</span><br>
<span class="lineno"></span><span class="comment" id="6399115">//&nbsp;DumpRequest&nbsp;is&nbsp;semantically&nbsp;a&nbsp;no-op,&nbsp;but&nbsp;in&nbsp;order&nbsp;to</span><br>
<span class="lineno">180</span><span class="comment" id="6399171">//&nbsp;dump&nbsp;the&nbsp;body,&nbsp;it&nbsp;reads&nbsp;the&nbsp;body&nbsp;data&nbsp;into&nbsp;memory&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="6399228">//&nbsp;changes&nbsp;req.Body&nbsp;to&nbsp;refer&nbsp;to&nbsp;the&nbsp;in-memory&nbsp;copy.</span><br>
<span class="lineno"></span><span class="comment" id="6399280">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;http.Request.Write&nbsp;details&nbsp;which&nbsp;fields</span><br>
<span class="lineno"></span><span class="comment" id="6399345">//&nbsp;of&nbsp;req&nbsp;are&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="6399365">func</span>&nbsp;<span class="ident" id="6399370">DumpRequest</span><span class="op" id="6399381">(</span><span class="ident" id="6399382">req</span>&nbsp;<span class="op" id="6399386">*</span><span class="ident" id="6399387">http</span><span class="op" id="6399391">.</span><span class="ident" id="6399392">Request</span><span class="op" id="6399399">,</span>&nbsp;<span class="ident" id="6399401">body</span>&nbsp;<span class="builtintype" id="6399406">bool</span><span class="op" id="6399410">)</span>&nbsp;<span class="op" id="6399412">(</span><span class="ident" id="6399413">dump</span>&nbsp;<span class="op" id="6399418">[</span><span class="op" id="6399419">]</span><span class="builtintype" id="6399420">byte</span><span class="op" id="6399424">,</span>&nbsp;<span class="ident" id="6399426">err</span>&nbsp;<span class="builtintype" id="6399430">error</span><span class="op" id="6399435">)</span>&nbsp;<span class="op" id="6399437">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6399440">save</span>&nbsp;<span class="op" id="6399445">:=</span>&nbsp;<span class="ident" id="6399448">req</span><span class="op" id="6399451">.</span><span class="ident" id="6399452">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6399458">if</span>&nbsp;<span class="op" id="6399461">!</span><span class="ident" id="6399462">body</span>&nbsp;<span class="op" id="6399467">||</span>&nbsp;<span class="ident" id="6399470">req</span><span class="op" id="6399473">.</span><span class="ident" id="6399474">Body</span>&nbsp;<span class="op" id="6399479">==</span>&nbsp;<span class="ident" id="6399482">nil</span>&nbsp;<span class="op" id="6399486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6399490">req</span><span class="op" id="6399493">.</span><span class="ident" id="6399494">Body</span>&nbsp;<span class="op" id="6399499">=</span>&nbsp;<span class="ident" id="6399501">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6399506">}</span>&nbsp;<span class="keyword" id="6399508">else</span>&nbsp;<span class="op" id="6399513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6399517">save</span><span class="op" id="6399521">,</span>&nbsp;<span class="ident" id="6399523">req</span><span class="op" id="6399526">.</span><span class="ident" id="6399527">Body</span><span class="op" id="6399531">,</span>&nbsp;<span class="ident" id="6399533">err</span>&nbsp;<span class="op" id="6399537">=</span>&nbsp;<span class="ident" id="6399539">drainBody</span><span class="op" id="6399548">(</span><span class="ident" id="6399549">req</span><span class="op" id="6399552">.</span><span class="ident" id="6399553">Body</span><span class="op" id="6399557">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6399561">if</span>&nbsp;<span class="ident" id="6399564">err</span>&nbsp;<span class="op" id="6399568">!=</span>&nbsp;<span class="ident" id="6399571">nil</span>&nbsp;<span class="op" id="6399575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6399580">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6399589">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6399592">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6399596">var</span>&nbsp;<span class="ident" id="6399600">b</span>&nbsp;<span class="ident" id="6399602">bytes</span><span class="op" id="6399607">.</span><span class="ident" id="6399608">Buffer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6399617">fmt</span><span class="op" id="6399620">.</span><span class="ident" id="6399621">Fprintf</span><span class="op" id="6399628">(</span><span class="op" id="6399629">&amp;</span><span class="ident" id="6399630">b</span><span class="op" id="6399631">,</span>&nbsp;<span class="string" id="6399633">&#34;%s&nbsp;%s&nbsp;HTTP/%d.%d\r\n&#34;</span><span class="op" id="6399655">,</span>&nbsp;<span class="ident" id="6399657">valueOrDefault</span><span class="op" id="6399671">(</span><span class="ident" id="6399672">req</span><span class="op" id="6399675">.</span><span class="ident" id="6399676">Method</span><span class="op" id="6399682">,</span>&nbsp;<span class="string" id="6399684">&#34;GET&#34;</span><span class="op" id="6399689">)</span><span class="op" id="6399690">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6399694">req</span><span class="op" id="6399697">.</span><span class="ident" id="6399698">URL</span><span class="op" id="6399701">.</span><span class="ident" id="6399702">RequestURI</span><span class="op" id="6399712">(</span><span class="op" id="6399713">)</span><span class="op" id="6399714">,</span>&nbsp;<span class="ident" id="6399716">req</span><span class="op" id="6399719">.</span><span class="ident" id="6399720">ProtoMajor</span><span class="op" id="6399730">,</span>&nbsp;<span class="ident" id="6399732">req</span><span class="op" id="6399735">.</span><span class="ident" id="6399736">ProtoMinor</span><span class="op" id="6399746">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6399750">host</span>&nbsp;<span class="op" id="6399755">:=</span>&nbsp;<span class="ident" id="6399758">req</span><span class="op" id="6399761">.</span><span class="ident" id="6399762">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6399768">if</span>&nbsp;<span class="ident" id="6399771">host</span>&nbsp;<span class="op" id="6399776">==</span>&nbsp;<span class="string" id="6399779">&#34;&#34;</span>&nbsp;<span class="op" id="6399782">&amp;&amp;</span>&nbsp;<span class="ident" id="6399785">req</span><span class="op" id="6399788">.</span><span class="ident" id="6399789">URL</span>&nbsp;<span class="op" id="6399793">!=</span>&nbsp;<span class="ident" id="6399796">nil</span>&nbsp;<span class="op" id="6399800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6399804">host</span>&nbsp;<span class="op" id="6399809">=</span>&nbsp;<span class="ident" id="6399811">req</span><span class="op" id="6399814">.</span><span class="ident" id="6399815">URL</span><span class="op" id="6399818">.</span><span class="ident" id="6399819">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6399825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6399828">if</span>&nbsp;<span class="ident" id="6399831">host</span>&nbsp;<span class="op" id="6399836">!=</span>&nbsp;<span class="string" id="6399839">&#34;&#34;</span>&nbsp;<span class="op" id="6399842">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6399846">fmt</span><span class="op" id="6399849">.</span><span class="ident" id="6399850">Fprintf</span><span class="op" id="6399857">(</span><span class="op" id="6399858">&amp;</span><span class="ident" id="6399859">b</span><span class="op" id="6399860">,</span>&nbsp;<span class="string" id="6399862">&#34;Host:&nbsp;%s\r\n&#34;</span><span class="op" id="6399876">,</span>&nbsp;<span class="ident" id="6399878">host</span><span class="op" id="6399882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6399885">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6399889">chunked</span>&nbsp;<span class="op" id="6399897">:=</span>&nbsp;<span class="builtinfunc" id="6399900">len</span><span class="op" id="6399903">(</span><span class="ident" id="6399904">req</span><span class="op" id="6399907">.</span><span class="ident" id="6399908">TransferEncoding</span><span class="op" id="6399924">)</span>&nbsp;<span class="op" id="6399926">&gt;</span>&nbsp;<span class="num" id="6399928">0</span>&nbsp;<span class="op" id="6399930">&amp;&amp;</span>&nbsp;<span class="ident" id="6399933">req</span><span class="op" id="6399936">.</span><span class="ident" id="6399937">TransferEncoding</span><span class="op" id="6399953">[</span><span class="num" id="6399954">0</span><span class="op" id="6399955">]</span>&nbsp;<span class="op" id="6399957">==</span>&nbsp;<span class="string" id="6399960">&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6399971">if</span>&nbsp;<span class="builtinfunc" id="6399974">len</span><span class="op" id="6399977">(</span><span class="ident" id="6399978">req</span><span class="op" id="6399981">.</span><span class="ident" id="6399982">TransferEncoding</span><span class="op" id="6399998">)</span>&nbsp;<span class="op" id="6400000">&gt;</span>&nbsp;<span class="num" id="6400002">0</span>&nbsp;<span class="op" id="6400004">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6400008">fmt</span><span class="op" id="6400011">.</span><span class="ident" id="6400012">Fprintf</span><span class="op" id="6400019">(</span><span class="op" id="6400020">&amp;</span><span class="ident" id="6400021">b</span><span class="op" id="6400022">,</span>&nbsp;<span class="string" id="6400024">&#34;Transfer-Encoding:&nbsp;%s\r\n&#34;</span><span class="op" id="6400051">,</span>&nbsp;<span class="ident" id="6400053">strings</span><span class="op" id="6400060">.</span><span class="ident" id="6400061">Join</span><span class="op" id="6400065">(</span><span class="ident" id="6400066">req</span><span class="op" id="6400069">.</span><span class="ident" id="6400070">TransferEncoding</span><span class="op" id="6400086">,</span>&nbsp;<span class="string" id="6400088">&#34;,&#34;</span><span class="op" id="6400091">)</span><span class="op" id="6400092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6400095">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6400098">if</span>&nbsp;<span class="ident" id="6400101">req</span><span class="op" id="6400104">.</span><span class="ident" id="6400105">Close</span>&nbsp;<span class="op" id="6400111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6400115">fmt</span><span class="op" id="6400118">.</span><span class="ident" id="6400119">Fprintf</span><span class="op" id="6400126">(</span><span class="op" id="6400127">&amp;</span><span class="ident" id="6400128">b</span><span class="op" id="6400129">,</span>&nbsp;<span class="string" id="6400131">&#34;Connection:&nbsp;close\r\n&#34;</span><span class="op" id="6400154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6400157">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6400161">err</span>&nbsp;<span class="op" id="6400165">=</span>&nbsp;<span class="ident" id="6400167">req</span><span class="op" id="6400170">.</span><span class="ident" id="6400171">Header</span><span class="op" id="6400177">.</span><span class="ident" id="6400178">WriteSubset</span><span class="op" id="6400189">(</span><span class="op" id="6400190">&amp;</span><span class="ident" id="6400191">b</span><span class="op" id="6400192">,</span>&nbsp;<span class="ident" id="6400194">reqWriteExcludeHeaderDump</span><span class="op" id="6400219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6400222">if</span>&nbsp;<span class="ident" id="6400225">err</span>&nbsp;<span class="op" id="6400229">!=</span>&nbsp;<span class="ident" id="6400232">nil</span>&nbsp;<span class="op" id="6400236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6400240">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6400248">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6400252">io</span><span class="op" id="6400254">.</span><span class="ident" id="6400255">WriteString</span><span class="op" id="6400266">(</span><span class="op" id="6400267">&amp;</span><span class="ident" id="6400268">b</span><span class="op" id="6400269">,</span>&nbsp;<span class="string" id="6400271">&#34;\r\n&#34;</span><span class="op" id="6400277">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6400281">if</span>&nbsp;<span class="ident" id="6400284">req</span><span class="op" id="6400287">.</span><span class="ident" id="6400288">Body</span>&nbsp;<span class="op" id="6400293">!=</span>&nbsp;<span class="ident" id="6400296">nil</span>&nbsp;<span class="op" id="6400300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6400304">var</span>&nbsp;<span class="ident" id="6400308">dest</span>&nbsp;<span class="ident" id="6400313">io</span><span class="op" id="6400315">.</span><span class="ident" id="6400316">Writer</span>&nbsp;<span class="op" id="6400323">=</span>&nbsp;<span class="op" id="6400325">&amp;</span><span class="ident" id="6400326">b</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6400330">if</span>&nbsp;<span class="ident" id="6400333">chunked</span>&nbsp;<span class="op" id="6400341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6400346">dest</span>&nbsp;<span class="op" id="6400351">=</span>&nbsp;<span class="ident" id="6400353">NewChunkedWriter</span><span class="op" id="6400369">(</span><span class="ident" id="6400370">dest</span><span class="op" id="6400374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6400378">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6400382">_</span><span class="op" id="6400383">,</span>&nbsp;<span class="ident" id="6400385">err</span>&nbsp;<span class="op" id="6400389">=</span>&nbsp;<span class="ident" id="6400391">io</span><span class="op" id="6400393">.</span><span class="ident" id="6400394">Copy</span><span class="op" id="6400398">(</span><span class="ident" id="6400399">dest</span><span class="op" id="6400403">,</span>&nbsp;<span class="ident" id="6400405">req</span><span class="op" id="6400408">.</span><span class="ident" id="6400409">Body</span><span class="op" id="6400413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6400417">if</span>&nbsp;<span class="ident" id="6400420">chunked</span>&nbsp;<span class="op" id="6400428">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6400433">dest</span><span class="op" id="6400437">.</span><span class="op" id="6400438">(</span><span class="ident" id="6400439">io</span><span class="op" id="6400441">.</span><span class="ident" id="6400442">Closer</span><span class="op" id="6400448">)</span><span class="op" id="6400449">.</span><span class="ident" id="6400450">Close</span><span class="op" id="6400455">(</span><span class="op" id="6400456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6400461">io</span><span class="op" id="6400463">.</span><span class="ident" id="6400464">WriteString</span><span class="op" id="6400475">(</span><span class="op" id="6400476">&amp;</span><span class="ident" id="6400477">b</span><span class="op" id="6400478">,</span>&nbsp;<span class="string" id="6400480">&#34;\r\n&#34;</span><span class="op" id="6400486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6400490">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6400493">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6400497">req</span><span class="op" id="6400500">.</span><span class="ident" id="6400501">Body</span>&nbsp;<span class="op" id="6400506">=</span>&nbsp;<span class="ident" id="6400508">save</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6400514">if</span>&nbsp;<span class="ident" id="6400517">err</span>&nbsp;<span class="op" id="6400521">!=</span>&nbsp;<span class="ident" id="6400524">nil</span>&nbsp;<span class="op" id="6400528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6400532">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6400540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6400543">dump</span>&nbsp;<span class="op" id="6400548">=</span>&nbsp;<span class="ident" id="6400550">b</span><span class="op" id="6400551">.</span><span class="ident" id="6400552">Bytes</span><span class="op" id="6400557">(</span><span class="op" id="6400558">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6400561">return</span><br>
<span class="lineno"></span><span class="op" id="6400568">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6400571">//&nbsp;errNoBody&nbsp;is&nbsp;a&nbsp;sentinel&nbsp;error&nbsp;value&nbsp;used&nbsp;by&nbsp;failureToReadBody&nbsp;so&nbsp;we&nbsp;can&nbsp;detect</span><br>
<span class="lineno"></span><span class="comment" id="6400653">//&nbsp;that&nbsp;the&nbsp;lack&nbsp;of&nbsp;body&nbsp;was&nbsp;intentional.</span><br>
<span class="lineno">245</span><span class="keyword" id="6400695">var</span>&nbsp;<span class="ident" id="6400699">errNoBody</span>&nbsp;<span class="op" id="6400709">=</span>&nbsp;<span class="ident" id="6400711">errors</span><span class="op" id="6400717">.</span><span class="ident" id="6400718">New</span><span class="op" id="6400721">(</span><span class="string" id="6400722">&#34;sentinel&nbsp;error&nbsp;value&#34;</span><span class="op" id="6400744">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6400747">//&nbsp;failureToReadBody&nbsp;is&nbsp;a&nbsp;io.ReadCloser&nbsp;that&nbsp;just&nbsp;returns&nbsp;errNoBody&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="6400818">//&nbsp;Read.&nbsp;&nbsp;It&#39;s&nbsp;swapped&nbsp;in&nbsp;when&nbsp;we&nbsp;don&#39;t&nbsp;actually&nbsp;want&nbsp;to&nbsp;consume&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6400887">//&nbsp;body,&nbsp;but&nbsp;need&nbsp;a&nbsp;non-nil&nbsp;one,&nbsp;and&nbsp;want&nbsp;to&nbsp;distinguish&nbsp;the&nbsp;error</span><br>
<span class="lineno">250</span><span class="comment" id="6400954">//&nbsp;from&nbsp;reading&nbsp;the&nbsp;dummy&nbsp;body.</span><br>
<span class="lineno"></span><span class="keyword" id="6400986">type</span>&nbsp;<span class="ident" id="6400991">failureToReadBody</span>&nbsp;<span class="keyword" id="6401009">struct</span><span class="op" id="6401015">{</span><span class="op" id="6401016">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6401019">func</span>&nbsp;<span class="op" id="6401024">(</span><span class="ident" id="6401025">failureToReadBody</span><span class="op" id="6401042">)</span>&nbsp;<span class="ident" id="6401044">Read</span><span class="op" id="6401048">(</span><span class="op" id="6401049">[</span><span class="op" id="6401050">]</span><span class="builtintype" id="6401051">byte</span><span class="op" id="6401055">)</span>&nbsp;<span class="op" id="6401057">(</span><span class="builtintype" id="6401058">int</span><span class="op" id="6401061">,</span>&nbsp;<span class="builtintype" id="6401063">error</span><span class="op" id="6401068">)</span>&nbsp;<span class="op" id="6401070">{</span>&nbsp;<span class="keyword" id="6401072">return</span>&nbsp;<span class="num" id="6401079">0</span><span class="op" id="6401080">,</span>&nbsp;<span class="ident" id="6401082">errNoBody</span>&nbsp;<span class="op" id="6401092">}</span><br>
<span class="lineno"></span><span class="keyword" id="6401094">func</span>&nbsp;<span class="op" id="6401099">(</span><span class="ident" id="6401100">failureToReadBody</span><span class="op" id="6401117">)</span>&nbsp;<span class="ident" id="6401119">Close</span><span class="op" id="6401124">(</span><span class="op" id="6401125">)</span>&nbsp;<span class="builtintype" id="6401127">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6401145">{</span>&nbsp;<span class="keyword" id="6401147">return</span>&nbsp;<span class="ident" id="6401154">nil</span>&nbsp;<span class="op" id="6401158">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="6401161">var</span>&nbsp;<span class="ident" id="6401165">emptyBody</span>&nbsp;<span class="op" id="6401175">=</span>&nbsp;<span class="ident" id="6401177">ioutil</span><span class="op" id="6401183">.</span><span class="ident" id="6401184">NopCloser</span><span class="op" id="6401193">(</span><span class="ident" id="6401194">strings</span><span class="op" id="6401201">.</span><span class="ident" id="6401202">NewReader</span><span class="op" id="6401211">(</span><span class="string" id="6401212">&#34;&#34;</span><span class="op" id="6401214">)</span><span class="op" id="6401215">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6401218">//&nbsp;DumpResponse&nbsp;is&nbsp;like&nbsp;DumpRequest&nbsp;but&nbsp;dumps&nbsp;a&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="6401276">func</span>&nbsp;<span class="ident" id="6401281">DumpResponse</span><span class="op" id="6401293">(</span><span class="ident" id="6401294">resp</span>&nbsp;<span class="op" id="6401299">*</span><span class="ident" id="6401300">http</span><span class="op" id="6401304">.</span><span class="ident" id="6401305">Response</span><span class="op" id="6401313">,</span>&nbsp;<span class="ident" id="6401315">body</span>&nbsp;<span class="builtintype" id="6401320">bool</span><span class="op" id="6401324">)</span>&nbsp;<span class="op" id="6401326">(</span><span class="ident" id="6401327">dump</span>&nbsp;<span class="op" id="6401332">[</span><span class="op" id="6401333">]</span><span class="builtintype" id="6401334">byte</span><span class="op" id="6401338">,</span>&nbsp;<span class="ident" id="6401340">err</span>&nbsp;<span class="builtintype" id="6401344">error</span><span class="op" id="6401349">)</span>&nbsp;<span class="op" id="6401351">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6401354">var</span>&nbsp;<span class="ident" id="6401358">b</span>&nbsp;<span class="ident" id="6401360">bytes</span><span class="op" id="6401365">.</span><span class="ident" id="6401366">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6401374">save</span>&nbsp;<span class="op" id="6401379">:=</span>&nbsp;<span class="ident" id="6401382">resp</span><span class="op" id="6401386">.</span><span class="ident" id="6401387">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6401393">savecl</span>&nbsp;<span class="op" id="6401400">:=</span>&nbsp;<span class="ident" id="6401403">resp</span><span class="op" id="6401407">.</span><span class="ident" id="6401408">ContentLength</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6401424">if</span>&nbsp;<span class="op" id="6401427">!</span><span class="ident" id="6401428">body</span>&nbsp;<span class="op" id="6401433">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6401437">resp</span><span class="op" id="6401441">.</span><span class="ident" id="6401442">Body</span>&nbsp;<span class="op" id="6401447">=</span>&nbsp;<span class="ident" id="6401449">failureToReadBody</span><span class="op" id="6401466">{</span><span class="op" id="6401467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6401470">}</span>&nbsp;<span class="keyword" id="6401472">else</span>&nbsp;<span class="keyword" id="6401477">if</span>&nbsp;<span class="ident" id="6401480">resp</span><span class="op" id="6401484">.</span><span class="ident" id="6401485">Body</span>&nbsp;<span class="op" id="6401490">==</span>&nbsp;<span class="ident" id="6401493">nil</span>&nbsp;<span class="op" id="6401497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6401501">resp</span><span class="op" id="6401505">.</span><span class="ident" id="6401506">Body</span>&nbsp;<span class="op" id="6401511">=</span>&nbsp;<span class="ident" id="6401513">emptyBody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6401524">}</span>&nbsp;<span class="keyword" id="6401526">else</span>&nbsp;<span class="op" id="6401531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6401535">save</span><span class="op" id="6401539">,</span>&nbsp;<span class="ident" id="6401541">resp</span><span class="op" id="6401545">.</span><span class="ident" id="6401546">Body</span><span class="op" id="6401550">,</span>&nbsp;<span class="ident" id="6401552">err</span>&nbsp;<span class="op" id="6401556">=</span>&nbsp;<span class="ident" id="6401558">drainBody</span><span class="op" id="6401567">(</span><span class="ident" id="6401568">resp</span><span class="op" id="6401572">.</span><span class="ident" id="6401573">Body</span><span class="op" id="6401577">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6401581">if</span>&nbsp;<span class="ident" id="6401584">err</span>&nbsp;<span class="op" id="6401588">!=</span>&nbsp;<span class="ident" id="6401591">nil</span>&nbsp;<span class="op" id="6401595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6401600">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6401609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6401612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6401615">err</span>&nbsp;<span class="op" id="6401619">=</span>&nbsp;<span class="ident" id="6401621">resp</span><span class="op" id="6401625">.</span><span class="ident" id="6401626">Write</span><span class="op" id="6401631">(</span><span class="op" id="6401632">&amp;</span><span class="ident" id="6401633">b</span><span class="op" id="6401634">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6401637">if</span>&nbsp;<span class="ident" id="6401640">err</span>&nbsp;<span class="op" id="6401644">==</span>&nbsp;<span class="ident" id="6401647">errNoBody</span>&nbsp;<span class="op" id="6401657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6401661">err</span>&nbsp;<span class="op" id="6401665">=</span>&nbsp;<span class="ident" id="6401667">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6401672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6401675">resp</span><span class="op" id="6401679">.</span><span class="ident" id="6401680">Body</span>&nbsp;<span class="op" id="6401685">=</span>&nbsp;<span class="ident" id="6401687">save</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6401693">resp</span><span class="op" id="6401697">.</span><span class="ident" id="6401698">ContentLength</span>&nbsp;<span class="op" id="6401712">=</span>&nbsp;<span class="ident" id="6401714">savecl</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6401722">if</span>&nbsp;<span class="ident" id="6401725">err</span>&nbsp;<span class="op" id="6401729">!=</span>&nbsp;<span class="ident" id="6401732">nil</span>&nbsp;<span class="op" id="6401736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6401740">return</span>&nbsp;<span class="ident" id="6401747">nil</span><span class="op" id="6401750">,</span>&nbsp;<span class="ident" id="6401752">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6401757">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6401760">return</span>&nbsp;<span class="ident" id="6401767">b</span><span class="op" id="6401768">.</span><span class="ident" id="6401769">Bytes</span><span class="op" id="6401774">(</span><span class="op" id="6401775">)</span><span class="op" id="6401776">,</span>&nbsp;<span class="ident" id="6401778">nil</span><br>
<span class="lineno"></span><span class="op" id="6401782">}</span>
</div>
</body>
</html>
