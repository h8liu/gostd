<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime/debug</h2>
<ul>
<li><a href="/gostd/runtime/debug/garbage.go.html">garbage.go</a></li>
<li><a href="/gostd/runtime/debug/garbage_test.go.html">garbage_test.go</a></li>
<li><a href="/gostd/runtime/debug/heapdump_test.go.html">heapdump_test.go</a></li>
<li><a href="/gostd/runtime/debug/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/debug/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/debug/stubs.go.html">stubs.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8474407">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8474463">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8474517">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="8474568">package</span>&nbsp;<span class="ident" id="8474576">debug</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8474583">import</span>&nbsp;<span class="op" id="8474590">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8474593">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8474604">&#34;testing&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8474615">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="8474622">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8474625">func</span>&nbsp;<span class="ident" id="8474630">TestReadGCStats</span><span class="op" id="8474645">(</span><span class="ident" id="8474646">t</span>&nbsp;<span class="op" id="8474648">*</span><span class="ident" id="8474649">testing</span><span class="op" id="8474656">.</span><span class="ident" id="8474657">T</span><span class="op" id="8474658">)</span>&nbsp;<span class="op" id="8474660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8474663">defer</span>&nbsp;<span class="ident" id="8474669">SetGCPercent</span><span class="op" id="8474681">(</span><span class="ident" id="8474682">SetGCPercent</span><span class="op" id="8474694">(</span><span class="op" id="8474695">-</span><span class="num" id="8474696">1</span><span class="op" id="8474697">)</span><span class="op" id="8474698">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8474702">var</span>&nbsp;<span class="ident" id="8474706">stats</span>&nbsp;<span class="ident" id="8474712">GCStats</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8474721">var</span>&nbsp;<span class="ident" id="8474725">mstats</span>&nbsp;<span class="ident" id="8474732">runtime</span><span class="op" id="8474739">.</span><span class="ident" id="8474740">MemStats</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8474750">var</span>&nbsp;<span class="ident" id="8474754">min</span><span class="op" id="8474757">,</span>&nbsp;<span class="ident" id="8474759">max</span>&nbsp;<span class="ident" id="8474763">time</span><span class="op" id="8474767">.</span><span class="ident" id="8474768">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8474779">//&nbsp;First&nbsp;ReadGCStats&nbsp;will&nbsp;allocate,&nbsp;second&nbsp;should&nbsp;not,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8474835">//&nbsp;especially&nbsp;if&nbsp;we&nbsp;follow&nbsp;up&nbsp;with&nbsp;an&nbsp;explicit&nbsp;garbage&nbsp;collection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8474903">stats</span><span class="op" id="8474908">.</span><span class="ident" id="8474909">PauseQuantiles</span>&nbsp;<span class="op" id="8474924">=</span>&nbsp;<span class="builtinfunc" id="8474926">make</span><span class="op" id="8474930">(</span><span class="op" id="8474931">[</span><span class="op" id="8474932">]</span><span class="ident" id="8474933">time</span><span class="op" id="8474937">.</span><span class="ident" id="8474938">Duration</span><span class="op" id="8474946">,</span>&nbsp;<span class="num" id="8474948">10</span><span class="op" id="8474950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8474953">ReadGCStats</span><span class="op" id="8474964">(</span><span class="op" id="8474965">&amp;</span><span class="ident" id="8474966">stats</span><span class="op" id="8474971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8474974">runtime</span><span class="op" id="8474981">.</span><span class="ident" id="8474982">GC</span><span class="op" id="8474984">(</span><span class="op" id="8474985">)</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8474989">//&nbsp;Assume&nbsp;these&nbsp;will&nbsp;return&nbsp;same&nbsp;data:&nbsp;no&nbsp;GC&nbsp;during&nbsp;ReadGCStats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8475055">ReadGCStats</span><span class="op" id="8475066">(</span><span class="op" id="8475067">&amp;</span><span class="ident" id="8475068">stats</span><span class="op" id="8475073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8475076">runtime</span><span class="op" id="8475083">.</span><span class="ident" id="8475084">ReadMemStats</span><span class="op" id="8475096">(</span><span class="op" id="8475097">&amp;</span><span class="ident" id="8475098">mstats</span><span class="op" id="8475104">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8475108">if</span>&nbsp;<span class="ident" id="8475111">stats</span><span class="op" id="8475116">.</span><span class="ident" id="8475117">NumGC</span>&nbsp;<span class="op" id="8475123">!=</span>&nbsp;<span class="ident" id="8475126">int64</span><span class="op" id="8475131">(</span><span class="ident" id="8475132">mstats</span><span class="op" id="8475138">.</span><span class="ident" id="8475139">NumGC</span><span class="op" id="8475144">)</span>&nbsp;<span class="op" id="8475146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8475150">t</span><span class="op" id="8475151">.</span><span class="ident" id="8475152">Errorf</span><span class="op" id="8475158">(</span><span class="string" id="8475159">&#34;stats.NumGC&nbsp;=&nbsp;%d,&nbsp;but&nbsp;mstats.NumGC&nbsp;=&nbsp;%d&#34;</span><span class="op" id="8475200">,</span>&nbsp;<span class="ident" id="8475202">stats</span><span class="op" id="8475207">.</span><span class="ident" id="8475208">NumGC</span><span class="op" id="8475213">,</span>&nbsp;<span class="ident" id="8475215">mstats</span><span class="op" id="8475221">.</span><span class="ident" id="8475222">NumGC</span><span class="op" id="8475227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8475230">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8475233">if</span>&nbsp;<span class="ident" id="8475236">stats</span><span class="op" id="8475241">.</span><span class="ident" id="8475242">PauseTotal</span>&nbsp;<span class="op" id="8475253">!=</span>&nbsp;<span class="ident" id="8475256">time</span><span class="op" id="8475260">.</span><span class="ident" id="8475261">Duration</span><span class="op" id="8475269">(</span><span class="ident" id="8475270">mstats</span><span class="op" id="8475276">.</span><span class="ident" id="8475277">PauseTotalNs</span><span class="op" id="8475289">)</span>&nbsp;<span class="op" id="8475291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8475295">t</span><span class="op" id="8475296">.</span><span class="ident" id="8475297">Errorf</span><span class="op" id="8475303">(</span><span class="string" id="8475304">&#34;stats.PauseTotal&nbsp;=&nbsp;%d,&nbsp;but&nbsp;mstats.PauseTotalNs&nbsp;=&nbsp;%d&#34;</span><span class="op" id="8475357">,</span>&nbsp;<span class="ident" id="8475359">stats</span><span class="op" id="8475364">.</span><span class="ident" id="8475365">PauseTotal</span><span class="op" id="8475375">,</span>&nbsp;<span class="ident" id="8475377">mstats</span><span class="op" id="8475383">.</span><span class="ident" id="8475384">PauseTotalNs</span><span class="op" id="8475396">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8475399">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8475402">if</span>&nbsp;<span class="ident" id="8475405">stats</span><span class="op" id="8475410">.</span><span class="ident" id="8475411">LastGC</span><span class="op" id="8475417">.</span><span class="ident" id="8475418">UnixNano</span><span class="op" id="8475426">(</span><span class="op" id="8475427">)</span>&nbsp;<span class="op" id="8475429">!=</span>&nbsp;<span class="ident" id="8475432">int64</span><span class="op" id="8475437">(</span><span class="ident" id="8475438">mstats</span><span class="op" id="8475444">.</span><span class="ident" id="8475445">LastGC</span><span class="op" id="8475451">)</span>&nbsp;<span class="op" id="8475453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8475457">t</span><span class="op" id="8475458">.</span><span class="ident" id="8475459">Errorf</span><span class="op" id="8475465">(</span><span class="string" id="8475466">&#34;stats.LastGC.UnixNano&nbsp;=&nbsp;%d,&nbsp;but&nbsp;mstats.LastGC&nbsp;=&nbsp;%d&#34;</span><span class="op" id="8475518">,</span>&nbsp;<span class="ident" id="8475520">stats</span><span class="op" id="8475525">.</span><span class="ident" id="8475526">LastGC</span><span class="op" id="8475532">.</span><span class="ident" id="8475533">UnixNano</span><span class="op" id="8475541">(</span><span class="op" id="8475542">)</span><span class="op" id="8475543">,</span>&nbsp;<span class="ident" id="8475545">mstats</span><span class="op" id="8475551">.</span><span class="ident" id="8475552">LastGC</span><span class="op" id="8475558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8475561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8475564">n</span>&nbsp;<span class="op" id="8475566">:=</span>&nbsp;<span class="builtintype" id="8475569">int</span><span class="op" id="8475572">(</span><span class="ident" id="8475573">mstats</span><span class="op" id="8475579">.</span><span class="ident" id="8475580">NumGC</span><span class="op" id="8475585">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8475588">if</span>&nbsp;<span class="ident" id="8475591">n</span>&nbsp;<span class="op" id="8475593">&gt;</span>&nbsp;<span class="builtinfunc" id="8475595">len</span><span class="op" id="8475598">(</span><span class="ident" id="8475599">mstats</span><span class="op" id="8475605">.</span><span class="ident" id="8475606">PauseNs</span><span class="op" id="8475613">)</span>&nbsp;<span class="op" id="8475615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8475619">n</span>&nbsp;<span class="op" id="8475621">=</span>&nbsp;<span class="builtinfunc" id="8475623">len</span><span class="op" id="8475626">(</span><span class="ident" id="8475627">mstats</span><span class="op" id="8475633">.</span><span class="ident" id="8475634">PauseNs</span><span class="op" id="8475641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8475644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8475647">if</span>&nbsp;<span class="builtinfunc" id="8475650">len</span><span class="op" id="8475653">(</span><span class="ident" id="8475654">stats</span><span class="op" id="8475659">.</span><span class="ident" id="8475660">Pause</span><span class="op" id="8475665">)</span>&nbsp;<span class="op" id="8475667">!=</span>&nbsp;<span class="ident" id="8475670">n</span>&nbsp;<span class="op" id="8475672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8475676">t</span><span class="op" id="8475677">.</span><span class="ident" id="8475678">Errorf</span><span class="op" id="8475684">(</span><span class="string" id="8475685">&#34;len(stats.Pause)&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8475717">,</span>&nbsp;<span class="builtinfunc" id="8475719">len</span><span class="op" id="8475722">(</span><span class="ident" id="8475723">stats</span><span class="op" id="8475728">.</span><span class="ident" id="8475729">Pause</span><span class="op" id="8475734">)</span><span class="op" id="8475735">,</span>&nbsp;<span class="ident" id="8475737">n</span><span class="op" id="8475738">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8475741">}</span>&nbsp;<span class="keyword" id="8475743">else</span>&nbsp;<span class="op" id="8475748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8475752">off</span>&nbsp;<span class="op" id="8475756">:=</span>&nbsp;<span class="op" id="8475759">(</span><span class="builtintype" id="8475760">int</span><span class="op" id="8475763">(</span><span class="ident" id="8475764">mstats</span><span class="op" id="8475770">.</span><span class="ident" id="8475771">NumGC</span><span class="op" id="8475776">)</span>&nbsp;<span class="op" id="8475778">+</span>&nbsp;<span class="builtinfunc" id="8475780">len</span><span class="op" id="8475783">(</span><span class="ident" id="8475784">mstats</span><span class="op" id="8475790">.</span><span class="ident" id="8475791">PauseNs</span><span class="op" id="8475798">)</span>&nbsp;<span class="op" id="8475800">-</span>&nbsp;<span class="num" id="8475802">1</span><span class="op" id="8475803">)</span>&nbsp;<span class="op" id="8475805">%</span>&nbsp;<span class="builtinfunc" id="8475807">len</span><span class="op" id="8475810">(</span><span class="ident" id="8475811">mstats</span><span class="op" id="8475817">.</span><span class="ident" id="8475818">PauseNs</span><span class="op" id="8475825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8475829">for</span>&nbsp;<span class="ident" id="8475833">i</span>&nbsp;<span class="op" id="8475835">:=</span>&nbsp;<span class="num" id="8475838">0</span><span class="op" id="8475839">;</span>&nbsp;<span class="ident" id="8475841">i</span>&nbsp;<span class="op" id="8475843">&lt;</span>&nbsp;<span class="ident" id="8475845">n</span><span class="op" id="8475846">;</span>&nbsp;<span class="ident" id="8475848">i</span><span class="op" id="8475849">++</span>&nbsp;<span class="op" id="8475852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8475857">dt</span>&nbsp;<span class="op" id="8475860">:=</span>&nbsp;<span class="ident" id="8475863">stats</span><span class="op" id="8475868">.</span><span class="ident" id="8475869">Pause</span><span class="op" id="8475874">[</span><span class="ident" id="8475875">i</span><span class="op" id="8475876">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8475881">if</span>&nbsp;<span class="ident" id="8475884">dt</span>&nbsp;<span class="op" id="8475887">!=</span>&nbsp;<span class="ident" id="8475890">time</span><span class="op" id="8475894">.</span><span class="ident" id="8475895">Duration</span><span class="op" id="8475903">(</span><span class="ident" id="8475904">mstats</span><span class="op" id="8475910">.</span><span class="ident" id="8475911">PauseNs</span><span class="op" id="8475918">[</span><span class="ident" id="8475919">off</span><span class="op" id="8475922">]</span><span class="op" id="8475923">)</span>&nbsp;<span class="op" id="8475925">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8475931">t</span><span class="op" id="8475932">.</span><span class="ident" id="8475933">Errorf</span><span class="op" id="8475939">(</span><span class="string" id="8475940">&#34;stats.Pause[%d]&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8475971">,</span>&nbsp;<span class="ident" id="8475973">i</span><span class="op" id="8475974">,</span>&nbsp;<span class="ident" id="8475976">dt</span><span class="op" id="8475978">,</span>&nbsp;<span class="ident" id="8475980">mstats</span><span class="op" id="8475986">.</span><span class="ident" id="8475987">PauseNs</span><span class="op" id="8475994">[</span><span class="ident" id="8475995">off</span><span class="op" id="8475998">]</span><span class="op" id="8475999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8476004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8476009">if</span>&nbsp;<span class="ident" id="8476012">max</span>&nbsp;<span class="op" id="8476016">&lt;</span>&nbsp;<span class="ident" id="8476018">dt</span>&nbsp;<span class="op" id="8476021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8476027">max</span>&nbsp;<span class="op" id="8476031">=</span>&nbsp;<span class="ident" id="8476033">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8476039">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8476044">if</span>&nbsp;<span class="ident" id="8476047">min</span>&nbsp;<span class="op" id="8476051">&gt;</span>&nbsp;<span class="ident" id="8476053">dt</span>&nbsp;<span class="op" id="8476056">||</span>&nbsp;<span class="ident" id="8476059">i</span>&nbsp;<span class="op" id="8476061">==</span>&nbsp;<span class="num" id="8476064">0</span>&nbsp;<span class="op" id="8476066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8476072">min</span>&nbsp;<span class="op" id="8476076">=</span>&nbsp;<span class="ident" id="8476078">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8476084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8476089">off</span>&nbsp;<span class="op" id="8476093">=</span>&nbsp;<span class="op" id="8476095">(</span><span class="ident" id="8476096">off</span>&nbsp;<span class="op" id="8476100">+</span>&nbsp;<span class="builtinfunc" id="8476102">len</span><span class="op" id="8476105">(</span><span class="ident" id="8476106">mstats</span><span class="op" id="8476112">.</span><span class="ident" id="8476113">PauseNs</span><span class="op" id="8476120">)</span>&nbsp;<span class="op" id="8476122">-</span>&nbsp;<span class="num" id="8476124">1</span><span class="op" id="8476125">)</span>&nbsp;<span class="op" id="8476127">%</span>&nbsp;<span class="builtinfunc" id="8476129">len</span><span class="op" id="8476132">(</span><span class="ident" id="8476133">mstats</span><span class="op" id="8476139">.</span><span class="ident" id="8476140">PauseNs</span><span class="op" id="8476147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8476151">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8476154">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8476158">q</span>&nbsp;<span class="op" id="8476160">:=</span>&nbsp;<span class="ident" id="8476163">stats</span><span class="op" id="8476168">.</span><span class="ident" id="8476169">PauseQuantiles</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8476185">nq</span>&nbsp;<span class="op" id="8476188">:=</span>&nbsp;<span class="builtinfunc" id="8476191">len</span><span class="op" id="8476194">(</span><span class="ident" id="8476195">q</span><span class="op" id="8476196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8476199">if</span>&nbsp;<span class="ident" id="8476202">q</span><span class="op" id="8476203">[</span><span class="num" id="8476204">0</span><span class="op" id="8476205">]</span>&nbsp;<span class="op" id="8476207">!=</span>&nbsp;<span class="ident" id="8476210">min</span>&nbsp;<span class="op" id="8476214">||</span>&nbsp;<span class="ident" id="8476217">q</span><span class="op" id="8476218">[</span><span class="ident" id="8476219">nq</span><span class="op" id="8476221">-</span><span class="num" id="8476222">1</span><span class="op" id="8476223">]</span>&nbsp;<span class="op" id="8476225">!=</span>&nbsp;<span class="ident" id="8476228">max</span>&nbsp;<span class="op" id="8476232">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8476236">t</span><span class="op" id="8476237">.</span><span class="ident" id="8476238">Errorf</span><span class="op" id="8476244">(</span><span class="string" id="8476245">&#34;stats.PauseQuantiles&nbsp;=&nbsp;[%d,&nbsp;...,&nbsp;%d],&nbsp;want&nbsp;[%d,&nbsp;...,&nbsp;%d]&#34;</span><span class="op" id="8476303">,</span>&nbsp;<span class="ident" id="8476305">q</span><span class="op" id="8476306">[</span><span class="num" id="8476307">0</span><span class="op" id="8476308">]</span><span class="op" id="8476309">,</span>&nbsp;<span class="ident" id="8476311">q</span><span class="op" id="8476312">[</span><span class="ident" id="8476313">nq</span><span class="op" id="8476315">-</span><span class="num" id="8476316">1</span><span class="op" id="8476317">]</span><span class="op" id="8476318">,</span>&nbsp;<span class="ident" id="8476320">min</span><span class="op" id="8476323">,</span>&nbsp;<span class="ident" id="8476325">max</span><span class="op" id="8476328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8476331">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8476335">for</span>&nbsp;<span class="ident" id="8476339">i</span>&nbsp;<span class="op" id="8476341">:=</span>&nbsp;<span class="num" id="8476344">0</span><span class="op" id="8476345">;</span>&nbsp;<span class="ident" id="8476347">i</span>&nbsp;<span class="op" id="8476349">&lt;</span>&nbsp;<span class="ident" id="8476351">nq</span><span class="op" id="8476353">-</span><span class="num" id="8476354">1</span><span class="op" id="8476355">;</span>&nbsp;<span class="ident" id="8476357">i</span><span class="op" id="8476358">++</span>&nbsp;<span class="op" id="8476361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8476365">if</span>&nbsp;<span class="ident" id="8476368">q</span><span class="op" id="8476369">[</span><span class="ident" id="8476370">i</span><span class="op" id="8476371">]</span>&nbsp;<span class="op" id="8476373">&gt;</span>&nbsp;<span class="ident" id="8476375">q</span><span class="op" id="8476376">[</span><span class="ident" id="8476377">i</span><span class="op" id="8476378">+</span><span class="num" id="8476379">1</span><span class="op" id="8476380">]</span>&nbsp;<span class="op" id="8476382">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8476387">t</span><span class="op" id="8476388">.</span><span class="ident" id="8476389">Errorf</span><span class="op" id="8476395">(</span><span class="string" id="8476396">&#34;stats.PauseQuantiles[%d]=%d&nbsp;&gt;&nbsp;stats.PauseQuantiles[%d]=%d&#34;</span><span class="op" id="8476455">,</span>&nbsp;<span class="ident" id="8476457">i</span><span class="op" id="8476458">,</span>&nbsp;<span class="ident" id="8476460">q</span><span class="op" id="8476461">[</span><span class="ident" id="8476462">i</span><span class="op" id="8476463">]</span><span class="op" id="8476464">,</span>&nbsp;<span class="ident" id="8476466">i</span><span class="op" id="8476467">+</span><span class="num" id="8476468">1</span><span class="op" id="8476469">,</span>&nbsp;<span class="ident" id="8476471">q</span><span class="op" id="8476472">[</span><span class="ident" id="8476473">i</span><span class="op" id="8476474">+</span><span class="num" id="8476475">1</span><span class="op" id="8476476">]</span><span class="op" id="8476477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8476481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8476484">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8476488">//&nbsp;compare&nbsp;memory&nbsp;stats&nbsp;with&nbsp;gc&nbsp;stats:</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8476528">if</span>&nbsp;<span class="builtinfunc" id="8476531">len</span><span class="op" id="8476534">(</span><span class="ident" id="8476535">stats</span><span class="op" id="8476540">.</span><span class="ident" id="8476541">PauseEnd</span><span class="op" id="8476549">)</span>&nbsp;<span class="op" id="8476551">!=</span>&nbsp;<span class="ident" id="8476554">n</span>&nbsp;<span class="op" id="8476556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8476560">t</span><span class="op" id="8476561">.</span><span class="ident" id="8476562">Fatalf</span><span class="op" id="8476568">(</span><span class="string" id="8476569">&#34;len(stats.PauseEnd)&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8476604">,</span>&nbsp;<span class="builtinfunc" id="8476606">len</span><span class="op" id="8476609">(</span><span class="ident" id="8476610">stats</span><span class="op" id="8476615">.</span><span class="ident" id="8476616">PauseEnd</span><span class="op" id="8476624">)</span><span class="op" id="8476625">,</span>&nbsp;<span class="ident" id="8476627">n</span><span class="op" id="8476628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8476631">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8476634">off</span>&nbsp;<span class="op" id="8476638">:=</span>&nbsp;<span class="op" id="8476641">(</span><span class="builtintype" id="8476642">int</span><span class="op" id="8476645">(</span><span class="ident" id="8476646">mstats</span><span class="op" id="8476652">.</span><span class="ident" id="8476653">NumGC</span><span class="op" id="8476658">)</span>&nbsp;<span class="op" id="8476660">+</span>&nbsp;<span class="builtinfunc" id="8476662">len</span><span class="op" id="8476665">(</span><span class="ident" id="8476666">mstats</span><span class="op" id="8476672">.</span><span class="ident" id="8476673">PauseEnd</span><span class="op" id="8476681">)</span>&nbsp;<span class="op" id="8476683">-</span>&nbsp;<span class="num" id="8476685">1</span><span class="op" id="8476686">)</span>&nbsp;<span class="op" id="8476688">%</span>&nbsp;<span class="builtinfunc" id="8476690">len</span><span class="op" id="8476693">(</span><span class="ident" id="8476694">mstats</span><span class="op" id="8476700">.</span><span class="ident" id="8476701">PauseEnd</span><span class="op" id="8476709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8476712">for</span>&nbsp;<span class="ident" id="8476716">i</span>&nbsp;<span class="op" id="8476718">:=</span>&nbsp;<span class="num" id="8476721">0</span><span class="op" id="8476722">;</span>&nbsp;<span class="ident" id="8476724">i</span>&nbsp;<span class="op" id="8476726">&lt;</span>&nbsp;<span class="ident" id="8476728">n</span><span class="op" id="8476729">;</span>&nbsp;<span class="ident" id="8476731">i</span><span class="op" id="8476732">++</span>&nbsp;<span class="op" id="8476735">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8476739">dt</span>&nbsp;<span class="op" id="8476742">:=</span>&nbsp;<span class="ident" id="8476745">stats</span><span class="op" id="8476750">.</span><span class="ident" id="8476751">PauseEnd</span><span class="op" id="8476759">[</span><span class="ident" id="8476760">i</span><span class="op" id="8476761">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8476765">if</span>&nbsp;<span class="ident" id="8476768">dt</span><span class="op" id="8476770">.</span><span class="ident" id="8476771">UnixNano</span><span class="op" id="8476779">(</span><span class="op" id="8476780">)</span>&nbsp;<span class="op" id="8476782">!=</span>&nbsp;<span class="ident" id="8476785">int64</span><span class="op" id="8476790">(</span><span class="ident" id="8476791">mstats</span><span class="op" id="8476797">.</span><span class="ident" id="8476798">PauseEnd</span><span class="op" id="8476806">[</span><span class="ident" id="8476807">off</span><span class="op" id="8476810">]</span><span class="op" id="8476811">)</span>&nbsp;<span class="op" id="8476813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8476818">t</span><span class="op" id="8476819">.</span><span class="ident" id="8476820">Errorf</span><span class="op" id="8476826">(</span><span class="string" id="8476827">&#34;stats.PauseEnd[%d]&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8476861">,</span>&nbsp;<span class="ident" id="8476863">i</span><span class="op" id="8476864">,</span>&nbsp;<span class="ident" id="8476866">dt</span><span class="op" id="8476868">,</span>&nbsp;<span class="ident" id="8476870">mstats</span><span class="op" id="8476876">.</span><span class="ident" id="8476877">PauseEnd</span><span class="op" id="8476885">[</span><span class="ident" id="8476886">off</span><span class="op" id="8476889">]</span><span class="op" id="8476890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8476894">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8476898">off</span>&nbsp;<span class="op" id="8476902">=</span>&nbsp;<span class="op" id="8476904">(</span><span class="ident" id="8476905">off</span>&nbsp;<span class="op" id="8476909">+</span>&nbsp;<span class="builtinfunc" id="8476911">len</span><span class="op" id="8476914">(</span><span class="ident" id="8476915">mstats</span><span class="op" id="8476921">.</span><span class="ident" id="8476922">PauseEnd</span><span class="op" id="8476930">)</span>&nbsp;<span class="op" id="8476932">-</span>&nbsp;<span class="num" id="8476934">1</span><span class="op" id="8476935">)</span>&nbsp;<span class="op" id="8476937">%</span>&nbsp;<span class="builtinfunc" id="8476939">len</span><span class="op" id="8476942">(</span><span class="ident" id="8476943">mstats</span><span class="op" id="8476949">.</span><span class="ident" id="8476950">PauseEnd</span><span class="op" id="8476958">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8476961">}</span><br>
<span class="lineno"></span><span class="op" id="8476963">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8476966">var</span>&nbsp;<span class="ident" id="8476970">big</span>&nbsp;<span class="op" id="8476974">=</span>&nbsp;<span class="builtinfunc" id="8476976">make</span><span class="op" id="8476980">(</span><span class="op" id="8476981">[</span><span class="op" id="8476982">]</span><span class="builtintype" id="8476983">byte</span><span class="op" id="8476987">,</span>&nbsp;<span class="num" id="8476989">1</span><span class="op" id="8476990">&lt;&lt;</span><span class="num" id="8476992">20</span><span class="op" id="8476994">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="8476997">func</span>&nbsp;<span class="ident" id="8477002">TestFreeOSMemory</span><span class="op" id="8477018">(</span><span class="ident" id="8477019">t</span>&nbsp;<span class="op" id="8477021">*</span><span class="ident" id="8477022">testing</span><span class="op" id="8477029">.</span><span class="ident" id="8477030">T</span><span class="op" id="8477031">)</span>&nbsp;<span class="op" id="8477033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8477036">var</span>&nbsp;<span class="ident" id="8477040">ms1</span><span class="op" id="8477043">,</span>&nbsp;<span class="ident" id="8477045">ms2</span>&nbsp;<span class="ident" id="8477049">runtime</span><span class="op" id="8477056">.</span><span class="ident" id="8477057">MemStats</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8477068">if</span>&nbsp;<span class="ident" id="8477071">big</span>&nbsp;<span class="op" id="8477075">==</span>&nbsp;<span class="ident" id="8477078">nil</span>&nbsp;<span class="op" id="8477082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8477086">t</span><span class="op" id="8477087">.</span><span class="ident" id="8477088">Skip</span><span class="op" id="8477092">(</span><span class="string" id="8477093">&#34;test&nbsp;is&nbsp;not&nbsp;reliable&nbsp;when&nbsp;run&nbsp;multiple&nbsp;times&#34;</span><span class="op" id="8477139">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8477142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8477145">big</span>&nbsp;<span class="op" id="8477149">=</span>&nbsp;<span class="ident" id="8477151">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8477156">runtime</span><span class="op" id="8477163">.</span><span class="ident" id="8477164">GC</span><span class="op" id="8477166">(</span><span class="op" id="8477167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8477170">runtime</span><span class="op" id="8477177">.</span><span class="ident" id="8477178">ReadMemStats</span><span class="op" id="8477190">(</span><span class="op" id="8477191">&amp;</span><span class="ident" id="8477192">ms1</span><span class="op" id="8477195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8477198">FreeOSMemory</span><span class="op" id="8477210">(</span><span class="op" id="8477211">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8477214">runtime</span><span class="op" id="8477221">.</span><span class="ident" id="8477222">ReadMemStats</span><span class="op" id="8477234">(</span><span class="op" id="8477235">&amp;</span><span class="ident" id="8477236">ms2</span><span class="op" id="8477239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8477242">if</span>&nbsp;<span class="ident" id="8477245">ms1</span><span class="op" id="8477248">.</span><span class="ident" id="8477249">HeapReleased</span>&nbsp;<span class="op" id="8477262">&gt;=</span>&nbsp;<span class="ident" id="8477265">ms2</span><span class="op" id="8477268">.</span><span class="ident" id="8477269">HeapReleased</span>&nbsp;<span class="op" id="8477282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8477286">t</span><span class="op" id="8477287">.</span><span class="ident" id="8477288">Errorf</span><span class="op" id="8477294">(</span><span class="string" id="8477295">&#34;released&nbsp;before=%d;&nbsp;released&nbsp;after=%d;&nbsp;did&nbsp;not&nbsp;go&nbsp;up&#34;</span><span class="op" id="8477349">,</span>&nbsp;<span class="ident" id="8477351">ms1</span><span class="op" id="8477354">.</span><span class="ident" id="8477355">HeapReleased</span><span class="op" id="8477367">,</span>&nbsp;<span class="ident" id="8477369">ms2</span><span class="op" id="8477372">.</span><span class="ident" id="8477373">HeapReleased</span><span class="op" id="8477385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8477388">}</span><br>
<span class="lineno"></span><span class="op" id="8477390">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="8477393">func</span>&nbsp;<span class="ident" id="8477398">TestSetGCPercent</span><span class="op" id="8477414">(</span><span class="ident" id="8477415">t</span>&nbsp;<span class="op" id="8477417">*</span><span class="ident" id="8477418">testing</span><span class="op" id="8477425">.</span><span class="ident" id="8477426">T</span><span class="op" id="8477427">)</span>&nbsp;<span class="op" id="8477429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8477432">//&nbsp;Test&nbsp;that&nbsp;the&nbsp;variable&nbsp;is&nbsp;being&nbsp;set&nbsp;and&nbsp;returned&nbsp;correctly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8477496">//&nbsp;Assume&nbsp;the&nbsp;percentage&nbsp;itself&nbsp;is&nbsp;implemented&nbsp;fine&nbsp;during&nbsp;GC,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8477560">//&nbsp;which&nbsp;is&nbsp;harder&nbsp;to&nbsp;test.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8477589">old</span>&nbsp;<span class="op" id="8477593">:=</span>&nbsp;<span class="ident" id="8477596">SetGCPercent</span><span class="op" id="8477608">(</span><span class="num" id="8477609">123</span><span class="op" id="8477612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8477615">new</span>&nbsp;<span class="op" id="8477619">:=</span>&nbsp;<span class="ident" id="8477622">SetGCPercent</span><span class="op" id="8477634">(</span><span class="ident" id="8477635">old</span><span class="op" id="8477638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8477641">if</span>&nbsp;<span class="builtinfunc" id="8477644">new</span>&nbsp;<span class="op" id="8477648">!=</span>&nbsp;<span class="num" id="8477651">123</span>&nbsp;<span class="op" id="8477655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8477659">t</span><span class="op" id="8477660">.</span><span class="ident" id="8477661">Errorf</span><span class="op" id="8477667">(</span><span class="string" id="8477668">&#34;SetGCPercent(123);&nbsp;SetGCPercent(x)&nbsp;=&nbsp;%d,&nbsp;want&nbsp;123&#34;</span><span class="op" id="8477719">,</span>&nbsp;<span class="builtinfunc" id="8477721">new</span><span class="op" id="8477724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8477727">}</span><br>
<span class="lineno">115</span><span class="op" id="8477729">}</span>
</div>
</body>
</html>
