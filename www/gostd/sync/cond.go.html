<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1396504">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1396559">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1396613">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1396664">package</span>&nbsp;<span class="ident" id="1396672">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1396678">import</span>&nbsp;<span class="op" id="1396685">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1396688">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1396703">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><span class="op" id="1396712">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1396715">//&nbsp;Cond&nbsp;implements&nbsp;a&nbsp;condition&nbsp;variable,&nbsp;a&nbsp;rendezvous&nbsp;point</span><br>
<span class="lineno"></span><span class="comment" id="1396775">//&nbsp;for&nbsp;goroutines&nbsp;waiting&nbsp;for&nbsp;or&nbsp;announcing&nbsp;the&nbsp;occurrence</span><br>
<span class="lineno"></span><span class="comment" id="1396834">//&nbsp;of&nbsp;an&nbsp;event.</span><br>
<span class="lineno">15</span><span class="comment" id="1396850">//</span><br>
<span class="lineno"></span><span class="comment" id="1396853">//&nbsp;Each&nbsp;Cond&nbsp;has&nbsp;an&nbsp;associated&nbsp;Locker&nbsp;L&nbsp;(often&nbsp;a&nbsp;*Mutex&nbsp;or&nbsp;*RWMutex),</span><br>
<span class="lineno"></span><span class="comment" id="1396923">//&nbsp;which&nbsp;must&nbsp;be&nbsp;held&nbsp;when&nbsp;changing&nbsp;the&nbsp;condition&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1396977">//&nbsp;when&nbsp;calling&nbsp;the&nbsp;Wait&nbsp;method.</span><br>
<span class="lineno"></span><span class="comment" id="1397010">//</span><br>
<span class="lineno">20</span><span class="comment" id="1397013">//&nbsp;A&nbsp;Cond&nbsp;can&nbsp;be&nbsp;created&nbsp;as&nbsp;part&nbsp;of&nbsp;other&nbsp;structures.</span><br>
<span class="lineno"></span><span class="comment" id="1397067">//&nbsp;A&nbsp;Cond&nbsp;must&nbsp;not&nbsp;be&nbsp;copied&nbsp;after&nbsp;first&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="1397113">type</span>&nbsp;<span class="ident" id="1397118">Cond</span>&nbsp;<span class="keyword" id="1397123">struct</span>&nbsp;<span class="op" id="1397130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1397133">//&nbsp;L&nbsp;is&nbsp;held&nbsp;while&nbsp;observing&nbsp;or&nbsp;changing&nbsp;the&nbsp;condition</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1397189">L</span>&nbsp;<span class="ident" id="1397191">Locker</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1397200">sema</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1397208">syncSema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1397218">waiters</span>&nbsp;<span class="builtintype" id="1397226">uint32</span>&nbsp;<span class="comment" id="1397233">//&nbsp;number&nbsp;of&nbsp;waiters</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1397255">checker</span>&nbsp;<span class="ident" id="1397263">copyChecker</span><br>
<span class="lineno"></span><span class="op" id="1397275">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="comment" id="1397278">//&nbsp;NewCond&nbsp;returns&nbsp;a&nbsp;new&nbsp;Cond&nbsp;with&nbsp;Locker&nbsp;l.</span><br>
<span class="lineno"></span><span class="keyword" id="1397323">func</span>&nbsp;<span class="ident" id="1397328">NewCond</span><span class="op" id="1397335">(</span><span class="ident" id="1397336">l</span>&nbsp;<span class="ident" id="1397338">Locker</span><span class="op" id="1397344">)</span>&nbsp;<span class="op" id="1397346">*</span><span class="ident" id="1397347">Cond</span>&nbsp;<span class="op" id="1397352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1397355">return</span>&nbsp;<span class="op" id="1397362">&amp;</span><span class="ident" id="1397363">Cond</span><span class="op" id="1397367">{</span><span class="ident" id="1397368">L</span><span class="op" id="1397369">:</span>&nbsp;<span class="ident" id="1397371">l</span><span class="op" id="1397372">}</span><br>
<span class="lineno"></span><span class="op" id="1397374">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="1397377">//&nbsp;Wait&nbsp;atomically&nbsp;unlocks&nbsp;c.L&nbsp;and&nbsp;suspends&nbsp;execution</span><br>
<span class="lineno"></span><span class="comment" id="1397431">//&nbsp;of&nbsp;the&nbsp;calling&nbsp;goroutine.&nbsp;&nbsp;After&nbsp;later&nbsp;resuming&nbsp;execution,</span><br>
<span class="lineno"></span><span class="comment" id="1397493">//&nbsp;Wait&nbsp;locks&nbsp;c.L&nbsp;before&nbsp;returning.&nbsp;&nbsp;Unlike&nbsp;in&nbsp;other&nbsp;systems,</span><br>
<span class="lineno"></span><span class="comment" id="1397555">//&nbsp;Wait&nbsp;cannot&nbsp;return&nbsp;unless&nbsp;awoken&nbsp;by&nbsp;Broadcast&nbsp;or&nbsp;Signal.</span><br>
<span class="lineno">40</span><span class="comment" id="1397615">//</span><br>
<span class="lineno"></span><span class="comment" id="1397618">//&nbsp;Because&nbsp;c.L&nbsp;is&nbsp;not&nbsp;locked&nbsp;when&nbsp;Wait&nbsp;first&nbsp;resumes,&nbsp;the&nbsp;caller</span><br>
<span class="lineno"></span><span class="comment" id="1397683">//&nbsp;typically&nbsp;cannot&nbsp;assume&nbsp;that&nbsp;the&nbsp;condition&nbsp;is&nbsp;true&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="1397742">//&nbsp;Wait&nbsp;returns.&nbsp;&nbsp;Instead,&nbsp;the&nbsp;caller&nbsp;should&nbsp;Wait&nbsp;in&nbsp;a&nbsp;loop:</span><br>
<span class="lineno"></span><span class="comment" id="1397803">//</span><br>
<span class="lineno">45</span><span class="comment" id="1397806">//&nbsp;&nbsp;&nbsp;&nbsp;c.L.Lock()</span><br>
<span class="lineno"></span><span class="comment" id="1397823">//&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;!condition()&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1397848">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c.Wait()</span><br>
<span class="lineno"></span><span class="comment" id="1397867">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="1397875">//&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;make&nbsp;use&nbsp;of&nbsp;condition&nbsp;...</span><br>
<span class="lineno">50</span><span class="comment" id="1397911">//&nbsp;&nbsp;&nbsp;&nbsp;c.L.Unlock()</span><br>
<span class="lineno"></span><span class="comment" id="1397930">//</span><br>
<span class="lineno"></span><span class="keyword" id="1397933">func</span>&nbsp;<span class="op" id="1397938">(</span><span class="ident" id="1397939">c</span>&nbsp;<span class="op" id="1397941">*</span><span class="ident" id="1397942">Cond</span><span class="op" id="1397946">)</span>&nbsp;<span class="ident" id="1397948">Wait</span><span class="op" id="1397952">(</span><span class="op" id="1397953">)</span>&nbsp;<span class="op" id="1397955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1397958">c</span><span class="op" id="1397959">.</span><span class="ident" id="1397960">checker</span><span class="op" id="1397967">.</span><span class="ident" id="1397968">check</span><span class="op" id="1397973">(</span><span class="op" id="1397974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1397977">if</span>&nbsp;<span class="ident" id="1397980">raceenabled</span>&nbsp;<span class="op" id="1397992">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1397996">raceDisable</span><span class="op" id="1398007">(</span><span class="op" id="1398008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1398011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1398014">atomic</span><span class="op" id="1398020">.</span><span class="ident" id="1398021">AddUint32</span><span class="op" id="1398030">(</span><span class="op" id="1398031">&amp;</span><span class="ident" id="1398032">c</span><span class="op" id="1398033">.</span><span class="ident" id="1398034">waiters</span><span class="op" id="1398041">,</span>&nbsp;<span class="num" id="1398043">1</span><span class="op" id="1398044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1398047">if</span>&nbsp;<span class="ident" id="1398050">raceenabled</span>&nbsp;<span class="op" id="1398062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1398066">raceEnable</span><span class="op" id="1398076">(</span><span class="op" id="1398077">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1398080">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1398083">c</span><span class="op" id="1398084">.</span><span class="ident" id="1398085">L</span><span class="op" id="1398086">.</span><span class="ident" id="1398087">Unlock</span><span class="op" id="1398093">(</span><span class="op" id="1398094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1398097">runtime_Syncsemacquire</span><span class="op" id="1398119">(</span><span class="op" id="1398120">&amp;</span><span class="ident" id="1398121">c</span><span class="op" id="1398122">.</span><span class="ident" id="1398123">sema</span><span class="op" id="1398127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1398130">c</span><span class="op" id="1398131">.</span><span class="ident" id="1398132">L</span><span class="op" id="1398133">.</span><span class="ident" id="1398134">Lock</span><span class="op" id="1398138">(</span><span class="op" id="1398139">)</span><br>
<span class="lineno"></span><span class="op" id="1398141">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="1398144">//&nbsp;Signal&nbsp;wakes&nbsp;one&nbsp;goroutine&nbsp;waiting&nbsp;on&nbsp;c,&nbsp;if&nbsp;there&nbsp;is&nbsp;any.</span><br>
<span class="lineno"></span><span class="comment" id="1398205">//</span><br>
<span class="lineno"></span><span class="comment" id="1398208">//&nbsp;It&nbsp;is&nbsp;allowed&nbsp;but&nbsp;not&nbsp;required&nbsp;for&nbsp;the&nbsp;caller&nbsp;to&nbsp;hold&nbsp;c.L</span><br>
<span class="lineno"></span><span class="comment" id="1398269">//&nbsp;during&nbsp;the&nbsp;call.</span><br>
<span class="lineno">70</span><span class="keyword" id="1398289">func</span>&nbsp;<span class="op" id="1398294">(</span><span class="ident" id="1398295">c</span>&nbsp;<span class="op" id="1398297">*</span><span class="ident" id="1398298">Cond</span><span class="op" id="1398302">)</span>&nbsp;<span class="ident" id="1398304">Signal</span><span class="op" id="1398310">(</span><span class="op" id="1398311">)</span>&nbsp;<span class="op" id="1398313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1398316">c</span><span class="op" id="1398317">.</span><span class="ident" id="1398318">signalImpl</span><span class="op" id="1398328">(</span><span class="builtintype" id="1398329">false</span><span class="op" id="1398334">)</span><br>
<span class="lineno"></span><span class="op" id="1398336">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1398339">//&nbsp;Broadcast&nbsp;wakes&nbsp;all&nbsp;goroutines&nbsp;waiting&nbsp;on&nbsp;c.</span><br>
<span class="lineno">75</span><span class="comment" id="1398387">//</span><br>
<span class="lineno"></span><span class="comment" id="1398390">//&nbsp;It&nbsp;is&nbsp;allowed&nbsp;but&nbsp;not&nbsp;required&nbsp;for&nbsp;the&nbsp;caller&nbsp;to&nbsp;hold&nbsp;c.L</span><br>
<span class="lineno"></span><span class="comment" id="1398451">//&nbsp;during&nbsp;the&nbsp;call.</span><br>
<span class="lineno"></span><span class="keyword" id="1398471">func</span>&nbsp;<span class="op" id="1398476">(</span><span class="ident" id="1398477">c</span>&nbsp;<span class="op" id="1398479">*</span><span class="ident" id="1398480">Cond</span><span class="op" id="1398484">)</span>&nbsp;<span class="ident" id="1398486">Broadcast</span><span class="op" id="1398495">(</span><span class="op" id="1398496">)</span>&nbsp;<span class="op" id="1398498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1398501">c</span><span class="op" id="1398502">.</span><span class="ident" id="1398503">signalImpl</span><span class="op" id="1398513">(</span><span class="builtintype" id="1398514">true</span><span class="op" id="1398518">)</span><br>
<span class="lineno">80</span><span class="op" id="1398520">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1398523">func</span>&nbsp;<span class="op" id="1398528">(</span><span class="ident" id="1398529">c</span>&nbsp;<span class="op" id="1398531">*</span><span class="ident" id="1398532">Cond</span><span class="op" id="1398536">)</span>&nbsp;<span class="ident" id="1398538">signalImpl</span><span class="op" id="1398548">(</span><span class="ident" id="1398549">all</span>&nbsp;<span class="builtintype" id="1398553">bool</span><span class="op" id="1398557">)</span>&nbsp;<span class="op" id="1398559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1398562">c</span><span class="op" id="1398563">.</span><span class="ident" id="1398564">checker</span><span class="op" id="1398571">.</span><span class="ident" id="1398572">check</span><span class="op" id="1398577">(</span><span class="op" id="1398578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1398581">if</span>&nbsp;<span class="ident" id="1398584">raceenabled</span>&nbsp;<span class="op" id="1398596">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1398600">raceDisable</span><span class="op" id="1398611">(</span><span class="op" id="1398612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1398615">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1398618">for</span>&nbsp;<span class="op" id="1398622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1398626">old</span>&nbsp;<span class="op" id="1398630">:=</span>&nbsp;<span class="ident" id="1398633">atomic</span><span class="op" id="1398639">.</span><span class="ident" id="1398640">LoadUint32</span><span class="op" id="1398650">(</span><span class="op" id="1398651">&amp;</span><span class="ident" id="1398652">c</span><span class="op" id="1398653">.</span><span class="ident" id="1398654">waiters</span><span class="op" id="1398661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1398665">if</span>&nbsp;<span class="ident" id="1398668">old</span>&nbsp;<span class="op" id="1398672">==</span>&nbsp;<span class="num" id="1398675">0</span>&nbsp;<span class="op" id="1398677">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1398682">if</span>&nbsp;<span class="ident" id="1398685">raceenabled</span>&nbsp;<span class="op" id="1398697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1398703">raceEnable</span><span class="op" id="1398713">(</span><span class="op" id="1398714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1398719">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1398724">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1398733">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1398737">new</span>&nbsp;<span class="op" id="1398741">:=</span>&nbsp;<span class="ident" id="1398744">old</span>&nbsp;<span class="op" id="1398748">-</span>&nbsp;<span class="num" id="1398750">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1398754">if</span>&nbsp;<span class="ident" id="1398757">all</span>&nbsp;<span class="op" id="1398761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1398766">new</span>&nbsp;<span class="op" id="1398770">=</span>&nbsp;<span class="num" id="1398772">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1398776">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1398780">if</span>&nbsp;<span class="ident" id="1398783">atomic</span><span class="op" id="1398789">.</span><span class="ident" id="1398790">CompareAndSwapUint32</span><span class="op" id="1398810">(</span><span class="op" id="1398811">&amp;</span><span class="ident" id="1398812">c</span><span class="op" id="1398813">.</span><span class="ident" id="1398814">waiters</span><span class="op" id="1398821">,</span>&nbsp;<span class="ident" id="1398823">old</span><span class="op" id="1398826">,</span>&nbsp;<span class="builtinfunc" id="1398828">new</span><span class="op" id="1398831">)</span>&nbsp;<span class="op" id="1398833">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1398838">if</span>&nbsp;<span class="ident" id="1398841">raceenabled</span>&nbsp;<span class="op" id="1398853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1398859">raceEnable</span><span class="op" id="1398869">(</span><span class="op" id="1398870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1398875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1398880">runtime_Syncsemrelease</span><span class="op" id="1398902">(</span><span class="op" id="1398903">&amp;</span><span class="ident" id="1398904">c</span><span class="op" id="1398905">.</span><span class="ident" id="1398906">sema</span><span class="op" id="1398910">,</span>&nbsp;<span class="ident" id="1398912">old</span><span class="op" id="1398915">-</span><span class="builtinfunc" id="1398916">new</span><span class="op" id="1398919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1398924">return</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1398933">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1398936">}</span><br>
<span class="lineno"></span><span class="op" id="1398938">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1398941">//&nbsp;copyChecker&nbsp;holds&nbsp;back&nbsp;pointer&nbsp;to&nbsp;itself&nbsp;to&nbsp;detect&nbsp;object&nbsp;copying.</span><br>
<span class="lineno">110</span><span class="keyword" id="1399011">type</span>&nbsp;<span class="ident" id="1399016">copyChecker</span>&nbsp;<span class="builtintype" id="1399028">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1399037">func</span>&nbsp;<span class="op" id="1399042">(</span><span class="ident" id="1399043">c</span>&nbsp;<span class="op" id="1399045">*</span><span class="ident" id="1399046">copyChecker</span><span class="op" id="1399057">)</span>&nbsp;<span class="ident" id="1399059">check</span><span class="op" id="1399064">(</span><span class="op" id="1399065">)</span>&nbsp;<span class="op" id="1399067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1399070">if</span>&nbsp;<span class="builtintype" id="1399073">uintptr</span><span class="op" id="1399080">(</span><span class="op" id="1399081">*</span><span class="ident" id="1399082">c</span><span class="op" id="1399083">)</span>&nbsp;<span class="op" id="1399085">!=</span>&nbsp;<span class="builtintype" id="1399088">uintptr</span><span class="op" id="1399095">(</span><span class="ident" id="1399096">unsafe</span><span class="op" id="1399102">.</span><span class="ident" id="1399103">Pointer</span><span class="op" id="1399110">(</span><span class="ident" id="1399111">c</span><span class="op" id="1399112">)</span><span class="op" id="1399113">)</span>&nbsp;<span class="op" id="1399115">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1399120">!</span><span class="ident" id="1399121">atomic</span><span class="op" id="1399127">.</span><span class="ident" id="1399128">CompareAndSwapUintptr</span><span class="op" id="1399149">(</span><span class="op" id="1399150">(</span><span class="op" id="1399151">*</span><span class="builtintype" id="1399152">uintptr</span><span class="op" id="1399159">)</span><span class="op" id="1399160">(</span><span class="ident" id="1399161">c</span><span class="op" id="1399162">)</span><span class="op" id="1399163">,</span>&nbsp;<span class="num" id="1399165">0</span><span class="op" id="1399166">,</span>&nbsp;<span class="builtintype" id="1399168">uintptr</span><span class="op" id="1399175">(</span><span class="ident" id="1399176">unsafe</span><span class="op" id="1399182">.</span><span class="ident" id="1399183">Pointer</span><span class="op" id="1399190">(</span><span class="ident" id="1399191">c</span><span class="op" id="1399192">)</span><span class="op" id="1399193">)</span><span class="op" id="1399194">)</span>&nbsp;<span class="op" id="1399196">&amp;&amp;</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="1399201">uintptr</span><span class="op" id="1399208">(</span><span class="op" id="1399209">*</span><span class="ident" id="1399210">c</span><span class="op" id="1399211">)</span>&nbsp;<span class="op" id="1399213">!=</span>&nbsp;<span class="builtintype" id="1399216">uintptr</span><span class="op" id="1399223">(</span><span class="ident" id="1399224">unsafe</span><span class="op" id="1399230">.</span><span class="ident" id="1399231">Pointer</span><span class="op" id="1399238">(</span><span class="ident" id="1399239">c</span><span class="op" id="1399240">)</span><span class="op" id="1399241">)</span>&nbsp;<span class="op" id="1399243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1399247">panic</span><span class="op" id="1399252">(</span><span class="string" id="1399253">&#34;sync.Cond&nbsp;is&nbsp;copied&#34;</span><span class="op" id="1399274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1399277">}</span><br>
<span class="lineno"></span><span class="op" id="1399279">}</span>
</div>
</body>
</html>
