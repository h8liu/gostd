<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3233979">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3234035">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3234089">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3234140">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris&nbsp;windows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3234218">//&nbsp;Internet&nbsp;protocol&nbsp;family&nbsp;sockets&nbsp;for&nbsp;POSIX</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3234265">package</span>&nbsp;<span class="ident" id="3234273">net</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="3234278">import</span>&nbsp;<span class="op" id="3234285">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3234288">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3234299">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3234306">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="3234309">func</span>&nbsp;<span class="ident" id="3234314">probeIPv4Stack</span><span class="op" id="3234328">(</span><span class="op" id="3234329">)</span>&nbsp;<span class="builtintype" id="3234331">bool</span>&nbsp;<span class="op" id="3234336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3234339">s</span><span class="op" id="3234340">,</span>&nbsp;<span class="ident" id="3234342">err</span>&nbsp;<span class="op" id="3234346">:=</span>&nbsp;<span class="ident" id="3234349">syscall</span><span class="op" id="3234356">.</span><span class="ident" id="3234357">Socket</span><span class="op" id="3234363">(</span><span class="ident" id="3234364">syscall</span><span class="op" id="3234371">.</span><span class="ident" id="3234372">AF_INET</span><span class="op" id="3234379">,</span>&nbsp;<span class="ident" id="3234381">syscall</span><span class="op" id="3234388">.</span><span class="ident" id="3234389">SOCK_STREAM</span><span class="op" id="3234400">,</span>&nbsp;<span class="ident" id="3234402">syscall</span><span class="op" id="3234409">.</span><span class="ident" id="3234410">IPPROTO_TCP</span><span class="op" id="3234421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3234424">switch</span>&nbsp;<span class="ident" id="3234431">err</span>&nbsp;<span class="op" id="3234435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3234438">case</span>&nbsp;<span class="ident" id="3234443">syscall</span><span class="op" id="3234450">.</span><span class="ident" id="3234451">EAFNOSUPPORT</span><span class="op" id="3234463">,</span>&nbsp;<span class="ident" id="3234465">syscall</span><span class="op" id="3234472">.</span><span class="ident" id="3234473">EPROTONOSUPPORT</span><span class="op" id="3234488">:</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3234492">return</span>&nbsp;<span class="builtintype" id="3234499">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3234506">case</span>&nbsp;<span class="ident" id="3234511">nil</span><span class="op" id="3234514">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3234518">closesocket</span><span class="op" id="3234529">(</span><span class="ident" id="3234530">s</span><span class="op" id="3234531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3234534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3234537">return</span>&nbsp;<span class="builtintype" id="3234544">true</span><br>
<span class="lineno">25</span><span class="op" id="3234549">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3234552">//&nbsp;Should&nbsp;we&nbsp;try&nbsp;to&nbsp;use&nbsp;the&nbsp;IPv4&nbsp;socket&nbsp;interface&nbsp;if&nbsp;we&#39;re</span><br>
<span class="lineno"></span><span class="comment" id="3234611">//&nbsp;only&nbsp;dealing&nbsp;with&nbsp;IPv4&nbsp;sockets?&nbsp;&nbsp;As&nbsp;long&nbsp;as&nbsp;the&nbsp;host&nbsp;system</span><br>
<span class="lineno"></span><span class="comment" id="3234674">//&nbsp;understands&nbsp;IPv6,&nbsp;it&#39;s&nbsp;okay&nbsp;to&nbsp;pass&nbsp;IPv4&nbsp;addresses&nbsp;to&nbsp;the&nbsp;IPv6</span><br>
<span class="lineno">30</span><span class="comment" id="3234740">//&nbsp;interface.&nbsp;&nbsp;That&nbsp;simplifies&nbsp;our&nbsp;code&nbsp;and&nbsp;is&nbsp;most&nbsp;general.</span><br>
<span class="lineno"></span><span class="comment" id="3234801">//&nbsp;Unfortunately,&nbsp;we&nbsp;need&nbsp;to&nbsp;run&nbsp;on&nbsp;kernels&nbsp;built&nbsp;without&nbsp;IPv6</span><br>
<span class="lineno"></span><span class="comment" id="3234864">//&nbsp;support&nbsp;too.&nbsp;&nbsp;So&nbsp;probe&nbsp;the&nbsp;kernel&nbsp;to&nbsp;figure&nbsp;it&nbsp;out.</span><br>
<span class="lineno"></span><span class="comment" id="3234919">//</span><br>
<span class="lineno"></span><span class="comment" id="3234922">//&nbsp;probeIPv6Stack&nbsp;probes&nbsp;both&nbsp;basic&nbsp;IPv6&nbsp;capability&nbsp;and&nbsp;IPv6&nbsp;IPv4-</span><br>
<span class="lineno">35</span><span class="comment" id="3234989">//&nbsp;mapping&nbsp;capability&nbsp;which&nbsp;is&nbsp;controlled&nbsp;by&nbsp;IPV6_V6ONLY&nbsp;socket</span><br>
<span class="lineno"></span><span class="comment" id="3235053">//&nbsp;option&nbsp;and/or&nbsp;kernel&nbsp;state&nbsp;&#34;net.inet6.ip6.v6only&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="3235107">//&nbsp;It&nbsp;returns&nbsp;two&nbsp;boolean&nbsp;values.&nbsp;&nbsp;If&nbsp;the&nbsp;first&nbsp;boolean&nbsp;value&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3235172">//&nbsp;true,&nbsp;kernel&nbsp;supports&nbsp;basic&nbsp;IPv6&nbsp;functionality.&nbsp;&nbsp;If&nbsp;the&nbsp;second</span><br>
<span class="lineno"></span><span class="comment" id="3235238">//&nbsp;boolean&nbsp;value&nbsp;is&nbsp;true,&nbsp;kernel&nbsp;supports&nbsp;IPv6&nbsp;IPv4-mapping.</span><br>
<span class="lineno">40</span><span class="keyword" id="3235299">func</span>&nbsp;<span class="ident" id="3235304">probeIPv6Stack</span><span class="op" id="3235318">(</span><span class="op" id="3235319">)</span>&nbsp;<span class="op" id="3235321">(</span><span class="ident" id="3235322">supportsIPv6</span><span class="op" id="3235334">,</span>&nbsp;<span class="ident" id="3235336">supportsIPv4map</span>&nbsp;<span class="builtintype" id="3235352">bool</span><span class="op" id="3235356">)</span>&nbsp;<span class="op" id="3235358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3235361">var</span>&nbsp;<span class="ident" id="3235365">probes</span>&nbsp;<span class="op" id="3235372">=</span>&nbsp;<span class="op" id="3235374">[</span><span class="op" id="3235375">]</span><span class="keyword" id="3235376">struct</span>&nbsp;<span class="op" id="3235383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3235387">laddr</span>&nbsp;<span class="ident" id="3235393">TCPAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3235403">value</span>&nbsp;<span class="builtintype" id="3235409">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3235415">ok</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3235421">bool</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3235427">}</span><span class="op" id="3235428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3235432">//&nbsp;IPv6&nbsp;communication&nbsp;capability</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3235467">{</span><span class="ident" id="3235468">laddr</span><span class="op" id="3235473">:</span>&nbsp;<span class="ident" id="3235475">TCPAddr</span><span class="op" id="3235482">{</span><span class="ident" id="3235483">IP</span><span class="op" id="3235485">:</span>&nbsp;<span class="ident" id="3235487">ParseIP</span><span class="op" id="3235494">(</span><span class="string" id="3235495">&#34;::1&#34;</span><span class="op" id="3235500">)</span><span class="op" id="3235501">}</span><span class="op" id="3235502">,</span>&nbsp;<span class="ident" id="3235504">value</span><span class="op" id="3235509">:</span>&nbsp;<span class="num" id="3235511">1</span><span class="op" id="3235512">}</span><span class="op" id="3235513">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3235517">//&nbsp;IPv6&nbsp;IPv4-mapped&nbsp;address&nbsp;communication&nbsp;capability</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3235572">{</span><span class="ident" id="3235573">laddr</span><span class="op" id="3235578">:</span>&nbsp;<span class="ident" id="3235580">TCPAddr</span><span class="op" id="3235587">{</span><span class="ident" id="3235588">IP</span><span class="op" id="3235590">:</span>&nbsp;<span class="ident" id="3235592">IPv4</span><span class="op" id="3235596">(</span><span class="num" id="3235597">127</span><span class="op" id="3235600">,</span>&nbsp;<span class="num" id="3235602">0</span><span class="op" id="3235603">,</span>&nbsp;<span class="num" id="3235605">0</span><span class="op" id="3235606">,</span>&nbsp;<span class="num" id="3235608">1</span><span class="op" id="3235609">)</span><span class="op" id="3235610">}</span><span class="op" id="3235611">,</span>&nbsp;<span class="ident" id="3235613">value</span><span class="op" id="3235618">:</span>&nbsp;<span class="num" id="3235620">0</span><span class="op" id="3235621">}</span><span class="op" id="3235622">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3235625">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3235629">for</span>&nbsp;<span class="ident" id="3235633">i</span>&nbsp;<span class="op" id="3235635">:=</span>&nbsp;<span class="keyword" id="3235638">range</span>&nbsp;<span class="ident" id="3235644">probes</span>&nbsp;<span class="op" id="3235651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3235655">s</span><span class="op" id="3235656">,</span>&nbsp;<span class="ident" id="3235658">err</span>&nbsp;<span class="op" id="3235662">:=</span>&nbsp;<span class="ident" id="3235665">syscall</span><span class="op" id="3235672">.</span><span class="ident" id="3235673">Socket</span><span class="op" id="3235679">(</span><span class="ident" id="3235680">syscall</span><span class="op" id="3235687">.</span><span class="ident" id="3235688">AF_INET6</span><span class="op" id="3235696">,</span>&nbsp;<span class="ident" id="3235698">syscall</span><span class="op" id="3235705">.</span><span class="ident" id="3235706">SOCK_STREAM</span><span class="op" id="3235717">,</span>&nbsp;<span class="ident" id="3235719">syscall</span><span class="op" id="3235726">.</span><span class="ident" id="3235727">IPPROTO_TCP</span><span class="op" id="3235738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3235742">if</span>&nbsp;<span class="ident" id="3235745">err</span>&nbsp;<span class="op" id="3235749">!=</span>&nbsp;<span class="ident" id="3235752">nil</span>&nbsp;<span class="op" id="3235756">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3235761">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3235772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3235776">defer</span>&nbsp;<span class="ident" id="3235782">closesocket</span><span class="op" id="3235793">(</span><span class="ident" id="3235794">s</span><span class="op" id="3235795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3235799">syscall</span><span class="op" id="3235806">.</span><span class="ident" id="3235807">SetsockoptInt</span><span class="op" id="3235820">(</span><span class="ident" id="3235821">s</span><span class="op" id="3235822">,</span>&nbsp;<span class="ident" id="3235824">syscall</span><span class="op" id="3235831">.</span><span class="ident" id="3235832">IPPROTO_IPV6</span><span class="op" id="3235844">,</span>&nbsp;<span class="ident" id="3235846">syscall</span><span class="op" id="3235853">.</span><span class="ident" id="3235854">IPV6_V6ONLY</span><span class="op" id="3235865">,</span>&nbsp;<span class="ident" id="3235867">probes</span><span class="op" id="3235873">[</span><span class="ident" id="3235874">i</span><span class="op" id="3235875">]</span><span class="op" id="3235876">.</span><span class="ident" id="3235877">value</span><span class="op" id="3235882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3235886">sa</span><span class="op" id="3235888">,</span>&nbsp;<span class="ident" id="3235890">err</span>&nbsp;<span class="op" id="3235894">:=</span>&nbsp;<span class="ident" id="3235897">probes</span><span class="op" id="3235903">[</span><span class="ident" id="3235904">i</span><span class="op" id="3235905">]</span><span class="op" id="3235906">.</span><span class="ident" id="3235907">laddr</span><span class="op" id="3235912">.</span><span class="ident" id="3235913">sockaddr</span><span class="op" id="3235921">(</span><span class="ident" id="3235922">syscall</span><span class="op" id="3235929">.</span><span class="ident" id="3235930">AF_INET6</span><span class="op" id="3235938">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3235942">if</span>&nbsp;<span class="ident" id="3235945">err</span>&nbsp;<span class="op" id="3235949">!=</span>&nbsp;<span class="ident" id="3235952">nil</span>&nbsp;<span class="op" id="3235956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3235961">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3235972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3235976">if</span>&nbsp;<span class="ident" id="3235979">err</span>&nbsp;<span class="op" id="3235983">:=</span>&nbsp;<span class="ident" id="3235986">syscall</span><span class="op" id="3235993">.</span><span class="ident" id="3235994">Bind</span><span class="op" id="3235998">(</span><span class="ident" id="3235999">s</span><span class="op" id="3236000">,</span>&nbsp;<span class="ident" id="3236002">sa</span><span class="op" id="3236004">)</span><span class="op" id="3236005">;</span>&nbsp;<span class="ident" id="3236007">err</span>&nbsp;<span class="op" id="3236011">!=</span>&nbsp;<span class="ident" id="3236014">nil</span>&nbsp;<span class="op" id="3236018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3236023">continue</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3236034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3236038">probes</span><span class="op" id="3236044">[</span><span class="ident" id="3236045">i</span><span class="op" id="3236046">]</span><span class="op" id="3236047">.</span><span class="ident" id="3236048">ok</span>&nbsp;<span class="op" id="3236051">=</span>&nbsp;<span class="builtintype" id="3236053">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3236059">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3236063">return</span>&nbsp;<span class="ident" id="3236070">probes</span><span class="op" id="3236076">[</span><span class="num" id="3236077">0</span><span class="op" id="3236078">]</span><span class="op" id="3236079">.</span><span class="ident" id="3236080">ok</span><span class="op" id="3236082">,</span>&nbsp;<span class="ident" id="3236084">probes</span><span class="op" id="3236090">[</span><span class="num" id="3236091">1</span><span class="op" id="3236092">]</span><span class="op" id="3236093">.</span><span class="ident" id="3236094">ok</span><br>
<span class="lineno">70</span><span class="op" id="3236097">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3236100">//&nbsp;favoriteAddrFamily&nbsp;returns&nbsp;the&nbsp;appropriate&nbsp;address&nbsp;family&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3236164">//&nbsp;the&nbsp;given&nbsp;net,&nbsp;laddr,&nbsp;raddr&nbsp;and&nbsp;mode.&nbsp;&nbsp;At&nbsp;first&nbsp;it&nbsp;figures</span><br>
<span class="lineno"></span><span class="comment" id="3236226">//&nbsp;address&nbsp;family&nbsp;out&nbsp;from&nbsp;the&nbsp;net.&nbsp;&nbsp;If&nbsp;mode&nbsp;indicates&nbsp;&#34;listen&#34;</span><br>
<span class="lineno">75</span><span class="comment" id="3236290">//&nbsp;and&nbsp;laddr&nbsp;is&nbsp;a&nbsp;wildcard,&nbsp;it&nbsp;assumes&nbsp;that&nbsp;the&nbsp;user&nbsp;wants&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3236352">//&nbsp;make&nbsp;a&nbsp;passive&nbsp;connection&nbsp;with&nbsp;a&nbsp;wildcard&nbsp;address&nbsp;family,&nbsp;both</span><br>
<span class="lineno"></span><span class="comment" id="3236418">//&nbsp;AF_INET&nbsp;and&nbsp;AF_INET6,&nbsp;and&nbsp;a&nbsp;wildcard&nbsp;address&nbsp;like&nbsp;following:</span><br>
<span class="lineno"></span><span class="comment" id="3236482">//</span><br>
<span class="lineno"></span><span class="comment" id="3236485">//&nbsp;&nbsp;&nbsp;&nbsp1.&nbsp;A&nbsp;wild-wild&nbsp;listen,&nbsp;&#34;tcp&#34;&nbsp;+&nbsp;&#34;&#34;</span><br>
<span class="lineno">80</span><span class="comment" id="3236522">//&nbsp;&nbsp;&nbsp;&nbspIf&nbsp;the&nbsp;platform&nbsp;supports&nbsp;both&nbsp;IPv6&nbsp;and&nbsp;IPv6&nbsp;IPv4-mapping</span><br>
<span class="lineno"></span><span class="comment" id="3236582">//&nbsp;&nbsp;&nbsp;&nbspcapabilities,&nbsp;we&nbsp;assume&nbsp;that&nbsp;the&nbsp;user&nbsp;want&nbsp;to&nbsp;listen&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="3236641">//&nbsp;&nbsp;&nbsp;&nbspboth&nbsp;IPv4&nbsp;and&nbsp;IPv6&nbsp;wildcard&nbsp;address&nbsp;over&nbsp;an&nbsp;AF_INET6</span><br>
<span class="lineno"></span><span class="comment" id="3236697">//&nbsp;&nbsp;&nbsp;&nbspsocket&nbsp;with&nbsp;IPV6_V6ONLY=0.&nbsp;&nbsp;Otherwise&nbsp;we&nbsp;prefer&nbsp;an&nbsp;IPv4</span><br>
<span class="lineno"></span><span class="comment" id="3236756">//&nbsp;&nbsp;&nbsp;&nbspwildcard&nbsp;address&nbsp;listen&nbsp;over&nbsp;an&nbsp;AF_INET&nbsp;socket.</span><br>
<span class="lineno">85</span><span class="comment" id="3236807">//</span><br>
<span class="lineno"></span><span class="comment" id="3236810">//&nbsp;&nbsp;&nbsp;&nbsp2.&nbsp;A&nbsp;wild-ipv4wild&nbsp;listen,&nbsp;&#34;tcp&#34;&nbsp;+&nbsp;&#34;0.0.0.0&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3236858">//&nbsp;&nbsp;&nbsp;&nbspSame&nbsp;as&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="3236872">//</span><br>
<span class="lineno"></span><span class="comment" id="3236875">//&nbsp;&nbsp;&nbsp;&nbsp3.&nbsp;A&nbsp;wild-ipv6wild&nbsp;listen,&nbsp;&#34;tcp&#34;&nbsp;+&nbsp;&#34;[::]&#34;</span><br>
<span class="lineno">90</span><span class="comment" id="3236920">//&nbsp;&nbsp;&nbsp;&nbspAlmost&nbsp;same&nbsp;as&nbsp;1&nbsp;but&nbsp;we&nbsp;prefer&nbsp;an&nbsp;IPv6&nbsp;wildcard&nbsp;address</span><br>
<span class="lineno"></span><span class="comment" id="3236979">//&nbsp;&nbsp;&nbsp;&nbsplisten&nbsp;over&nbsp;an&nbsp;AF_INET6&nbsp;socket&nbsp;with&nbsp;IPV6_V6ONLY=0&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="3237037">//&nbsp;&nbsp;&nbsp;&nbspthe&nbsp;platform&nbsp;supports&nbsp;IPv6&nbsp;capability&nbsp;but&nbsp;not&nbsp;IPv6&nbsp;IPv4-</span><br>
<span class="lineno"></span><span class="comment" id="3237097">//&nbsp;&nbsp;&nbsp;&nbspmapping&nbsp;capability.</span><br>
<span class="lineno"></span><span class="comment" id="3237120">//</span><br>
<span class="lineno">95</span><span class="comment" id="3237123">//&nbsp;&nbsp;&nbsp;&nbsp4.&nbsp;A&nbsp;ipv4-ipv4wild&nbsp;listen,&nbsp;&#34;tcp4&#34;&nbsp;+&nbsp;&#34;&#34;&nbsp;or&nbsp;&#34;0.0.0.0&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3237178">//&nbsp;&nbsp;&nbsp;&nbspWe&nbsp;use&nbsp;an&nbsp;IPv4&nbsp;(AF_INET)&nbsp;wildcard&nbsp;address&nbsp;listen.</span><br>
<span class="lineno"></span><span class="comment" id="3237231">//</span><br>
<span class="lineno"></span><span class="comment" id="3237234">//&nbsp;&nbsp;&nbsp;&nbsp5.&nbsp;A&nbsp;ipv6-ipv6wild&nbsp;listen,&nbsp;&#34;tcp6&#34;&nbsp;+&nbsp;&#34;&#34;&nbsp;or&nbsp;&#34;[::]&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3237286">//&nbsp;&nbsp;&nbsp;&nbspWe&nbsp;use&nbsp;an&nbsp;IPv6&nbsp;(AF_INET6,&nbsp;IPV6_V6ONLY=1)&nbsp;wildcard&nbsp;address</span><br>
<span class="lineno">100</span><span class="comment" id="3237347">//&nbsp;&nbsp;&nbsp;&nbsplisten.</span><br>
<span class="lineno"></span><span class="comment" id="3237358">//</span><br>
<span class="lineno"></span><span class="comment" id="3237361">//&nbsp;Otherwise&nbsp;guess:&nbsp;if&nbsp;the&nbsp;addresses&nbsp;are&nbsp;IPv4&nbsp;then&nbsp;returns&nbsp;AF_INET,</span><br>
<span class="lineno"></span><span class="comment" id="3237429">//&nbsp;or&nbsp;else&nbsp;returns&nbsp;AF_INET6.&nbsp;&nbsp;It&nbsp;also&nbsp;returns&nbsp;a&nbsp;boolean&nbsp;value&nbsp;what</span><br>
<span class="lineno"></span><span class="comment" id="3237496">//&nbsp;designates&nbsp;IPV6_V6ONLY&nbsp;option.</span><br>
<span class="lineno">105</span><span class="comment" id="3237530">//</span><br>
<span class="lineno"></span><span class="comment" id="3237533">//&nbsp;Note&nbsp;that&nbsp;OpenBSD&nbsp;allows&nbsp;neither&nbsp;&#34;net.inet6.ip6.v6only=1&#34;&nbsp;change</span><br>
<span class="lineno"></span><span class="comment" id="3237601">//&nbsp;nor&nbsp;IPPROTO_IPV6&nbsp;level&nbsp;IPV6_V6ONLY&nbsp;socket&nbsp;option&nbsp;setting.</span><br>
<span class="lineno"></span><span class="keyword" id="3237662">func</span>&nbsp;<span class="ident" id="3237667">favoriteAddrFamily</span><span class="op" id="3237685">(</span><span class="ident" id="3237686">net</span>&nbsp;<span class="builtintype" id="3237690">string</span><span class="op" id="3237696">,</span>&nbsp;<span class="ident" id="3237698">laddr</span><span class="op" id="3237703">,</span>&nbsp;<span class="ident" id="3237705">raddr</span>&nbsp;<span class="ident" id="3237711">sockaddr</span><span class="op" id="3237719">,</span>&nbsp;<span class="ident" id="3237721">mode</span>&nbsp;<span class="builtintype" id="3237726">string</span><span class="op" id="3237732">)</span>&nbsp;<span class="op" id="3237734">(</span><span class="ident" id="3237735">family</span>&nbsp;<span class="builtintype" id="3237742">int</span><span class="op" id="3237745">,</span>&nbsp;<span class="ident" id="3237747">ipv6only</span>&nbsp;<span class="builtintype" id="3237756">bool</span><span class="op" id="3237760">)</span>&nbsp;<span class="op" id="3237762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3237765">switch</span>&nbsp;<span class="ident" id="3237772">net</span><span class="op" id="3237775">[</span><span class="builtinfunc" id="3237776">len</span><span class="op" id="3237779">(</span><span class="ident" id="3237780">net</span><span class="op" id="3237783">)</span><span class="op" id="3237784">-</span><span class="num" id="3237785">1</span><span class="op" id="3237786">]</span>&nbsp;<span class="op" id="3237788">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3237791">case</span>&nbsp;<span class="string" id="3237796">&#39;4&#39;</span><span class="op" id="3237799">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3237803">return</span>&nbsp;<span class="ident" id="3237810">syscall</span><span class="op" id="3237817">.</span><span class="ident" id="3237818">AF_INET</span><span class="op" id="3237825">,</span>&nbsp;<span class="builtintype" id="3237827">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3237834">case</span>&nbsp;<span class="string" id="3237839">&#39;6&#39;</span><span class="op" id="3237842">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3237846">return</span>&nbsp;<span class="ident" id="3237853">syscall</span><span class="op" id="3237860">.</span><span class="ident" id="3237861">AF_INET6</span><span class="op" id="3237869">,</span>&nbsp;<span class="builtintype" id="3237871">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3237877">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3237881">if</span>&nbsp;<span class="ident" id="3237884">mode</span>&nbsp;<span class="op" id="3237889">==</span>&nbsp;<span class="string" id="3237892">&#34;listen&#34;</span>&nbsp;<span class="op" id="3237901">&amp;&amp;</span>&nbsp;<span class="op" id="3237904">(</span><span class="ident" id="3237905">laddr</span>&nbsp;<span class="op" id="3237911">==</span>&nbsp;<span class="ident" id="3237914">nil</span>&nbsp;<span class="op" id="3237918">||</span>&nbsp;<span class="ident" id="3237921">laddr</span><span class="op" id="3237926">.</span><span class="ident" id="3237927">isWildcard</span><span class="op" id="3237937">(</span><span class="op" id="3237938">)</span><span class="op" id="3237939">)</span>&nbsp;<span class="op" id="3237941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3237945">if</span>&nbsp;<span class="ident" id="3237948">supportsIPv4map</span>&nbsp;<span class="op" id="3237964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3237969">return</span>&nbsp;<span class="ident" id="3237976">syscall</span><span class="op" id="3237983">.</span><span class="ident" id="3237984">AF_INET6</span><span class="op" id="3237992">,</span>&nbsp;<span class="builtintype" id="3237994">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3238002">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3238006">if</span>&nbsp;<span class="ident" id="3238009">laddr</span>&nbsp;<span class="op" id="3238015">==</span>&nbsp;<span class="ident" id="3238018">nil</span>&nbsp;<span class="op" id="3238022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3238027">return</span>&nbsp;<span class="ident" id="3238034">syscall</span><span class="op" id="3238041">.</span><span class="ident" id="3238042">AF_INET</span><span class="op" id="3238049">,</span>&nbsp;<span class="builtintype" id="3238051">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3238059">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3238063">return</span>&nbsp;<span class="ident" id="3238070">laddr</span><span class="op" id="3238075">.</span><span class="ident" id="3238076">family</span><span class="op" id="3238082">(</span><span class="op" id="3238083">)</span><span class="op" id="3238084">,</span>&nbsp;<span class="builtintype" id="3238086">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3238093">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3238097">if</span>&nbsp;<span class="op" id="3238100">(</span><span class="ident" id="3238101">laddr</span>&nbsp;<span class="op" id="3238107">==</span>&nbsp;<span class="ident" id="3238110">nil</span>&nbsp;<span class="op" id="3238114">||</span>&nbsp;<span class="ident" id="3238117">laddr</span><span class="op" id="3238122">.</span><span class="ident" id="3238123">family</span><span class="op" id="3238129">(</span><span class="op" id="3238130">)</span>&nbsp;<span class="op" id="3238132">==</span>&nbsp;<span class="ident" id="3238135">syscall</span><span class="op" id="3238142">.</span><span class="ident" id="3238143">AF_INET</span><span class="op" id="3238150">)</span>&nbsp;<span class="op" id="3238152">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3238157">(</span><span class="ident" id="3238158">raddr</span>&nbsp;<span class="op" id="3238164">==</span>&nbsp;<span class="ident" id="3238167">nil</span>&nbsp;<span class="op" id="3238171">||</span>&nbsp;<span class="ident" id="3238174">raddr</span><span class="op" id="3238179">.</span><span class="ident" id="3238180">family</span><span class="op" id="3238186">(</span><span class="op" id="3238187">)</span>&nbsp;<span class="op" id="3238189">==</span>&nbsp;<span class="ident" id="3238192">syscall</span><span class="op" id="3238199">.</span><span class="ident" id="3238200">AF_INET</span><span class="op" id="3238207">)</span>&nbsp;<span class="op" id="3238209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3238213">return</span>&nbsp;<span class="ident" id="3238220">syscall</span><span class="op" id="3238227">.</span><span class="ident" id="3238228">AF_INET</span><span class="op" id="3238235">,</span>&nbsp;<span class="builtintype" id="3238237">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3238244">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3238247">return</span>&nbsp;<span class="ident" id="3238254">syscall</span><span class="op" id="3238261">.</span><span class="ident" id="3238262">AF_INET6</span><span class="op" id="3238270">,</span>&nbsp;<span class="builtintype" id="3238272">false</span><br>
<span class="lineno"></span><span class="op" id="3238278">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3238281">//&nbsp;Internet&nbsp;sockets&nbsp;(TCP,&nbsp;UDP,&nbsp;IP)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="keyword" id="3238317">func</span>&nbsp;<span class="ident" id="3238322">internetSocket</span><span class="op" id="3238336">(</span><span class="ident" id="3238337">net</span>&nbsp;<span class="builtintype" id="3238341">string</span><span class="op" id="3238347">,</span>&nbsp;<span class="ident" id="3238349">laddr</span><span class="op" id="3238354">,</span>&nbsp;<span class="ident" id="3238356">raddr</span>&nbsp;<span class="ident" id="3238362">sockaddr</span><span class="op" id="3238370">,</span>&nbsp;<span class="ident" id="3238372">deadline</span>&nbsp;<span class="ident" id="3238381">time</span><span class="op" id="3238385">.</span><span class="ident" id="3238386">Time</span><span class="op" id="3238390">,</span>&nbsp;<span class="ident" id="3238392">sotype</span><span class="op" id="3238398">,</span>&nbsp;<span class="ident" id="3238400">proto</span>&nbsp;<span class="builtintype" id="3238406">int</span><span class="op" id="3238409">,</span>&nbsp;<span class="ident" id="3238411">mode</span>&nbsp;<span class="builtintype" id="3238416">string</span><span class="op" id="3238422">)</span>&nbsp;<span class="op" id="3238424">(</span><span class="ident" id="3238425">fd</span>&nbsp;<span class="op" id="3238428">*</span><span class="ident" id="3238429">netFD</span><span class="op" id="3238434">,</span>&nbsp;<span class="ident" id="3238436">err</span>&nbsp;<span class="builtintype" id="3238440">error</span><span class="op" id="3238445">)</span>&nbsp;<span class="op" id="3238447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3238450">family</span><span class="op" id="3238456">,</span>&nbsp;<span class="ident" id="3238458">ipv6only</span>&nbsp;<span class="op" id="3238467">:=</span>&nbsp;<span class="ident" id="3238470">favoriteAddrFamily</span><span class="op" id="3238488">(</span><span class="ident" id="3238489">net</span><span class="op" id="3238492">,</span>&nbsp;<span class="ident" id="3238494">laddr</span><span class="op" id="3238499">,</span>&nbsp;<span class="ident" id="3238501">raddr</span><span class="op" id="3238506">,</span>&nbsp;<span class="ident" id="3238508">mode</span><span class="op" id="3238512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3238515">return</span>&nbsp;<span class="ident" id="3238522">socket</span><span class="op" id="3238528">(</span><span class="ident" id="3238529">net</span><span class="op" id="3238532">,</span>&nbsp;<span class="ident" id="3238534">family</span><span class="op" id="3238540">,</span>&nbsp;<span class="ident" id="3238542">sotype</span><span class="op" id="3238548">,</span>&nbsp;<span class="ident" id="3238550">proto</span><span class="op" id="3238555">,</span>&nbsp;<span class="ident" id="3238557">ipv6only</span><span class="op" id="3238565">,</span>&nbsp;<span class="ident" id="3238567">laddr</span><span class="op" id="3238572">,</span>&nbsp;<span class="ident" id="3238574">raddr</span><span class="op" id="3238579">,</span>&nbsp;<span class="ident" id="3238581">deadline</span><span class="op" id="3238589">)</span><br>
<span class="lineno"></span><span class="op" id="3238591">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="keyword" id="3238594">func</span>&nbsp;<span class="ident" id="3238599">ipToSockaddr</span><span class="op" id="3238611">(</span><span class="ident" id="3238612">family</span>&nbsp;<span class="builtintype" id="3238619">int</span><span class="op" id="3238622">,</span>&nbsp;<span class="ident" id="3238624">ip</span>&nbsp;<span class="ident" id="3238627">IP</span><span class="op" id="3238629">,</span>&nbsp;<span class="ident" id="3238631">port</span>&nbsp;<span class="builtintype" id="3238636">int</span><span class="op" id="3238639">,</span>&nbsp;<span class="ident" id="3238641">zone</span>&nbsp;<span class="builtintype" id="3238646">string</span><span class="op" id="3238652">)</span>&nbsp;<span class="op" id="3238654">(</span><span class="ident" id="3238655">syscall</span><span class="op" id="3238662">.</span><span class="ident" id="3238663">Sockaddr</span><span class="op" id="3238671">,</span>&nbsp;<span class="builtintype" id="3238673">error</span><span class="op" id="3238678">)</span>&nbsp;<span class="op" id="3238680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3238683">switch</span>&nbsp;<span class="ident" id="3238690">family</span>&nbsp;<span class="op" id="3238697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3238700">case</span>&nbsp;<span class="ident" id="3238705">syscall</span><span class="op" id="3238712">.</span><span class="ident" id="3238713">AF_INET</span><span class="op" id="3238720">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3238724">if</span>&nbsp;<span class="builtinfunc" id="3238727">len</span><span class="op" id="3238730">(</span><span class="ident" id="3238731">ip</span><span class="op" id="3238733">)</span>&nbsp;<span class="op" id="3238735">==</span>&nbsp;<span class="num" id="3238738">0</span>&nbsp;<span class="op" id="3238740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3238745">ip</span>&nbsp;<span class="op" id="3238748">=</span>&nbsp;<span class="ident" id="3238750">IPv4zero</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3238761">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3238765">if</span>&nbsp;<span class="ident" id="3238768">ip</span>&nbsp;<span class="op" id="3238771">=</span>&nbsp;<span class="ident" id="3238773">ip</span><span class="op" id="3238775">.</span><span class="ident" id="3238776">To4</span><span class="op" id="3238779">(</span><span class="op" id="3238780">)</span><span class="op" id="3238781">;</span>&nbsp;<span class="ident" id="3238783">ip</span>&nbsp;<span class="op" id="3238786">==</span>&nbsp;<span class="ident" id="3238789">nil</span>&nbsp;<span class="op" id="3238793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3238798">return</span>&nbsp;<span class="ident" id="3238805">nil</span><span class="op" id="3238808">,</span>&nbsp;<span class="ident" id="3238810">InvalidAddrError</span><span class="op" id="3238826">(</span><span class="string" id="3238827">&#34;non-IPv4&nbsp;address&#34;</span><span class="op" id="3238845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3238849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3238853">sa</span>&nbsp;<span class="op" id="3238856">:=</span>&nbsp;<span class="builtinfunc" id="3238859">new</span><span class="op" id="3238862">(</span><span class="ident" id="3238863">syscall</span><span class="op" id="3238870">.</span><span class="ident" id="3238871">SockaddrInet4</span><span class="op" id="3238884">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3238888">for</span>&nbsp;<span class="ident" id="3238892">i</span>&nbsp;<span class="op" id="3238894">:=</span>&nbsp;<span class="num" id="3238897">0</span><span class="op" id="3238898">;</span>&nbsp;<span class="ident" id="3238900">i</span>&nbsp;<span class="op" id="3238902">&lt;</span>&nbsp;<span class="ident" id="3238904">IPv4len</span><span class="op" id="3238911">;</span>&nbsp;<span class="ident" id="3238913">i</span><span class="op" id="3238914">++</span>&nbsp;<span class="op" id="3238917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3238922">sa</span><span class="op" id="3238924">.</span><span class="ident" id="3238925">Addr</span><span class="op" id="3238929">[</span><span class="ident" id="3238930">i</span><span class="op" id="3238931">]</span>&nbsp;<span class="op" id="3238933">=</span>&nbsp;<span class="ident" id="3238935">ip</span><span class="op" id="3238937">[</span><span class="ident" id="3238938">i</span><span class="op" id="3238939">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3238943">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3238947">sa</span><span class="op" id="3238949">.</span><span class="ident" id="3238950">Port</span>&nbsp;<span class="op" id="3238955">=</span>&nbsp;<span class="ident" id="3238957">port</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3238964">return</span>&nbsp;<span class="ident" id="3238971">sa</span><span class="op" id="3238973">,</span>&nbsp;<span class="ident" id="3238975">nil</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3238980">case</span>&nbsp;<span class="ident" id="3238985">syscall</span><span class="op" id="3238992">.</span><span class="ident" id="3238993">AF_INET6</span><span class="op" id="3239001">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3239005">if</span>&nbsp;<span class="builtinfunc" id="3239008">len</span><span class="op" id="3239011">(</span><span class="ident" id="3239012">ip</span><span class="op" id="3239014">)</span>&nbsp;<span class="op" id="3239016">==</span>&nbsp;<span class="num" id="3239019">0</span>&nbsp;<span class="op" id="3239021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239026">ip</span>&nbsp;<span class="op" id="3239029">=</span>&nbsp;<span class="ident" id="3239031">IPv6zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3239042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3239046">//&nbsp;IPv4&nbsp;callers&nbsp;use&nbsp;0.0.0.0&nbsp;to&nbsp;mean&nbsp;&#34;announce&nbsp;on&nbsp;any&nbsp;available&nbsp;address&#34;.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3239121">//&nbsp;In&nbsp;IPv6&nbsp;mode,&nbsp;Linux&nbsp;treats&nbsp;that&nbsp;as&nbsp;meaning&nbsp;&#34;announce&nbsp;on&nbsp;0.0.0.0&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3239192">//&nbsp;which&nbsp;it&nbsp;refuses&nbsp;to&nbsp;do.&nbsp;&nbsp;Rewrite&nbsp;to&nbsp;the&nbsp;IPv6&nbsp;unspecified&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3239263">if</span>&nbsp;<span class="ident" id="3239266">ip</span><span class="op" id="3239268">.</span><span class="ident" id="3239269">Equal</span><span class="op" id="3239274">(</span><span class="ident" id="3239275">IPv4zero</span><span class="op" id="3239283">)</span>&nbsp;<span class="op" id="3239285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239290">ip</span>&nbsp;<span class="op" id="3239293">=</span>&nbsp;<span class="ident" id="3239295">IPv6zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3239306">}</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3239310">if</span>&nbsp;<span class="ident" id="3239313">ip</span>&nbsp;<span class="op" id="3239316">=</span>&nbsp;<span class="ident" id="3239318">ip</span><span class="op" id="3239320">.</span><span class="ident" id="3239321">To16</span><span class="op" id="3239325">(</span><span class="op" id="3239326">)</span><span class="op" id="3239327">;</span>&nbsp;<span class="ident" id="3239329">ip</span>&nbsp;<span class="op" id="3239332">==</span>&nbsp;<span class="ident" id="3239335">nil</span>&nbsp;<span class="op" id="3239339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3239344">return</span>&nbsp;<span class="ident" id="3239351">nil</span><span class="op" id="3239354">,</span>&nbsp;<span class="ident" id="3239356">InvalidAddrError</span><span class="op" id="3239372">(</span><span class="string" id="3239373">&#34;non-IPv6&nbsp;address&#34;</span><span class="op" id="3239391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3239395">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239399">sa</span>&nbsp;<span class="op" id="3239402">:=</span>&nbsp;<span class="builtinfunc" id="3239405">new</span><span class="op" id="3239408">(</span><span class="ident" id="3239409">syscall</span><span class="op" id="3239416">.</span><span class="ident" id="3239417">SockaddrInet6</span><span class="op" id="3239430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3239434">for</span>&nbsp;<span class="ident" id="3239438">i</span>&nbsp;<span class="op" id="3239440">:=</span>&nbsp;<span class="num" id="3239443">0</span><span class="op" id="3239444">;</span>&nbsp;<span class="ident" id="3239446">i</span>&nbsp;<span class="op" id="3239448">&lt;</span>&nbsp;<span class="ident" id="3239450">IPv6len</span><span class="op" id="3239457">;</span>&nbsp;<span class="ident" id="3239459">i</span><span class="op" id="3239460">++</span>&nbsp;<span class="op" id="3239463">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239468">sa</span><span class="op" id="3239470">.</span><span class="ident" id="3239471">Addr</span><span class="op" id="3239475">[</span><span class="ident" id="3239476">i</span><span class="op" id="3239477">]</span>&nbsp;<span class="op" id="3239479">=</span>&nbsp;<span class="ident" id="3239481">ip</span><span class="op" id="3239483">[</span><span class="ident" id="3239484">i</span><span class="op" id="3239485">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3239489">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239493">sa</span><span class="op" id="3239495">.</span><span class="ident" id="3239496">Port</span>&nbsp;<span class="op" id="3239501">=</span>&nbsp;<span class="ident" id="3239503">port</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239510">sa</span><span class="op" id="3239512">.</span><span class="ident" id="3239513">ZoneId</span>&nbsp;<span class="op" id="3239520">=</span>&nbsp;<span class="builtintype" id="3239522">uint32</span><span class="op" id="3239528">(</span><span class="ident" id="3239529">zoneToInt</span><span class="op" id="3239538">(</span><span class="ident" id="3239539">zone</span><span class="op" id="3239543">)</span><span class="op" id="3239544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3239548">return</span>&nbsp;<span class="ident" id="3239555">sa</span><span class="op" id="3239557">,</span>&nbsp;<span class="ident" id="3239559">nil</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3239564">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3239567">return</span>&nbsp;<span class="ident" id="3239574">nil</span><span class="op" id="3239577">,</span>&nbsp;<span class="ident" id="3239579">InvalidAddrError</span><span class="op" id="3239595">(</span><span class="string" id="3239596">&#34;unexpected&nbsp;socket&nbsp;family&#34;</span><span class="op" id="3239622">)</span><br>
<span class="lineno"></span><span class="op" id="3239624">}</span>
</div>
</body>
</html>
