<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>log/syslog</h2>
<ul>
<li><a href="/gostd/log/syslog/syslog.go.html">syslog.go</a></li>
<li><a href="/gostd/log/syslog/syslog_test.go.html">syslog_test.go</a></li>
<li><a href="/gostd/log/syslog/syslog_unix.go.html">syslog_unix.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8488639">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8488694">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8488748">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="8488799">//&nbsp;+build&nbsp;!windows,!nacl,!plan9</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8488832">package</span>&nbsp;<span class="ident" id="8488840">syslog</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8488848">import</span>&nbsp;<span class="op" id="8488855">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8488858">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8488867">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8488874">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8488880">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8488893">&#34;log&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8488900">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8488907">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8488913">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8488921">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8488932">&#34;time&#34;</span><br>
<span class="lineno">20</span><span class="op" id="8488939">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8488942">func</span>&nbsp;<span class="ident" id="8488947">runPktSyslog</span><span class="op" id="8488959">(</span><span class="ident" id="8488960">c</span>&nbsp;<span class="ident" id="8488962">net</span><span class="op" id="8488965">.</span><span class="ident" id="8488966">PacketConn</span><span class="op" id="8488976">,</span>&nbsp;<span class="ident" id="8488978">done</span>&nbsp;<span class="keyword" id="8488983">chan</span><span class="op" id="8488987">&lt;-</span>&nbsp;<span class="builtintype" id="8488990">string</span><span class="op" id="8488996">)</span>&nbsp;<span class="op" id="8488998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8489001">var</span>&nbsp;<span class="ident" id="8489005">buf</span>&nbsp;<span class="op" id="8489009">[</span><span class="num" id="8489010">4096</span><span class="op" id="8489014">]</span><span class="builtintype" id="8489015">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8489021">var</span>&nbsp;<span class="ident" id="8489025">rcvd</span>&nbsp;<span class="builtintype" id="8489030">string</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8489038">ct</span>&nbsp;<span class="op" id="8489041">:=</span>&nbsp;<span class="num" id="8489044">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8489047">for</span>&nbsp;<span class="op" id="8489051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8489055">var</span>&nbsp;<span class="ident" id="8489059">n</span>&nbsp;<span class="builtintype" id="8489061">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8489067">var</span>&nbsp;<span class="ident" id="8489071">err</span>&nbsp;<span class="builtintype" id="8489075">error</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8489084">c</span><span class="op" id="8489085">.</span><span class="ident" id="8489086">SetReadDeadline</span><span class="op" id="8489101">(</span><span class="ident" id="8489102">time</span><span class="op" id="8489106">.</span><span class="ident" id="8489107">Now</span><span class="op" id="8489110">(</span><span class="op" id="8489111">)</span><span class="op" id="8489112">.</span><span class="ident" id="8489113">Add</span><span class="op" id="8489116">(</span><span class="num" id="8489117">100</span>&nbsp;<span class="op" id="8489121">*</span>&nbsp;<span class="ident" id="8489123">time</span><span class="op" id="8489127">.</span><span class="ident" id="8489128">Millisecond</span><span class="op" id="8489139">)</span><span class="op" id="8489140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8489144">n</span><span class="op" id="8489145">,</span>&nbsp;<span class="ident" id="8489147">_</span><span class="op" id="8489148">,</span>&nbsp;<span class="ident" id="8489150">err</span>&nbsp;<span class="op" id="8489154">=</span>&nbsp;<span class="ident" id="8489156">c</span><span class="op" id="8489157">.</span><span class="ident" id="8489158">ReadFrom</span><span class="op" id="8489166">(</span><span class="ident" id="8489167">buf</span><span class="op" id="8489170">[</span><span class="op" id="8489171">:</span><span class="op" id="8489172">]</span><span class="op" id="8489173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8489177">rcvd</span>&nbsp;<span class="op" id="8489182">+=</span>&nbsp;<span class="builtintype" id="8489185">string</span><span class="op" id="8489191">(</span><span class="ident" id="8489192">buf</span><span class="op" id="8489195">[</span><span class="op" id="8489196">:</span><span class="ident" id="8489197">n</span><span class="op" id="8489198">]</span><span class="op" id="8489199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8489203">if</span>&nbsp;<span class="ident" id="8489206">err</span>&nbsp;<span class="op" id="8489210">!=</span>&nbsp;<span class="ident" id="8489213">nil</span>&nbsp;<span class="op" id="8489217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8489222">if</span>&nbsp;<span class="ident" id="8489225">oe</span><span class="op" id="8489227">,</span>&nbsp;<span class="ident" id="8489229">ok</span>&nbsp;<span class="op" id="8489232">:=</span>&nbsp;<span class="ident" id="8489235">err</span><span class="op" id="8489238">.</span><span class="op" id="8489239">(</span><span class="op" id="8489240">*</span><span class="ident" id="8489241">net</span><span class="op" id="8489244">.</span><span class="ident" id="8489245">OpError</span><span class="op" id="8489252">)</span><span class="op" id="8489253">;</span>&nbsp;<span class="ident" id="8489255">ok</span>&nbsp;<span class="op" id="8489258">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8489264">if</span>&nbsp;<span class="ident" id="8489267">ct</span>&nbsp;<span class="op" id="8489270">&lt;</span>&nbsp;<span class="num" id="8489272">3</span>&nbsp;<span class="op" id="8489274">&amp;&amp;</span>&nbsp;<span class="ident" id="8489277">oe</span><span class="op" id="8489279">.</span><span class="ident" id="8489280">Temporary</span><span class="op" id="8489289">(</span><span class="op" id="8489290">)</span>&nbsp;<span class="op" id="8489292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8489299">ct</span><span class="op" id="8489301">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8489309">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8489322">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8489327">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8489332">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8489340">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8489343">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8489346">c</span><span class="op" id="8489347">.</span><span class="ident" id="8489348">Close</span><span class="op" id="8489353">(</span><span class="op" id="8489354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8489357">done</span>&nbsp;<span class="op" id="8489362">&lt;-</span>&nbsp;<span class="ident" id="8489365">rcvd</span><br>
<span class="lineno">45</span><span class="op" id="8489370">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8489373">var</span>&nbsp;<span class="ident" id="8489377">crashy</span>&nbsp;<span class="op" id="8489384">=</span>&nbsp;<span class="builtintype" id="8489386">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8489393">func</span>&nbsp;<span class="ident" id="8489398">runStreamSyslog</span><span class="op" id="8489413">(</span><span class="ident" id="8489414">l</span>&nbsp;<span class="ident" id="8489416">net</span><span class="op" id="8489419">.</span><span class="ident" id="8489420">Listener</span><span class="op" id="8489428">,</span>&nbsp;<span class="ident" id="8489430">done</span>&nbsp;<span class="keyword" id="8489435">chan</span><span class="op" id="8489439">&lt;-</span>&nbsp;<span class="builtintype" id="8489442">string</span><span class="op" id="8489448">,</span>&nbsp;<span class="ident" id="8489450">wg</span>&nbsp;<span class="op" id="8489453">*</span><span class="ident" id="8489454">sync</span><span class="op" id="8489458">.</span><span class="ident" id="8489459">WaitGroup</span><span class="op" id="8489468">)</span>&nbsp;<span class="op" id="8489470">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8489473">for</span>&nbsp;<span class="op" id="8489477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8489481">var</span>&nbsp;<span class="ident" id="8489485">c</span>&nbsp;<span class="ident" id="8489487">net</span><span class="op" id="8489490">.</span><span class="ident" id="8489491">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8489498">var</span>&nbsp;<span class="ident" id="8489502">err</span>&nbsp;<span class="builtintype" id="8489506">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8489514">if</span>&nbsp;<span class="ident" id="8489517">c</span><span class="op" id="8489518">,</span>&nbsp;<span class="ident" id="8489520">err</span>&nbsp;<span class="op" id="8489524">=</span>&nbsp;<span class="ident" id="8489526">l</span><span class="op" id="8489527">.</span><span class="ident" id="8489528">Accept</span><span class="op" id="8489534">(</span><span class="op" id="8489535">)</span><span class="op" id="8489536">;</span>&nbsp;<span class="ident" id="8489538">err</span>&nbsp;<span class="op" id="8489542">!=</span>&nbsp;<span class="ident" id="8489545">nil</span>&nbsp;<span class="op" id="8489549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8489554">return</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8489563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8489567">wg</span><span class="op" id="8489569">.</span><span class="ident" id="8489570">Add</span><span class="op" id="8489573">(</span><span class="num" id="8489574">1</span><span class="op" id="8489575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8489579">go</span>&nbsp;<span class="keyword" id="8489582">func</span><span class="op" id="8489586">(</span><span class="ident" id="8489587">c</span>&nbsp;<span class="ident" id="8489589">net</span><span class="op" id="8489592">.</span><span class="ident" id="8489593">Conn</span><span class="op" id="8489597">)</span>&nbsp;<span class="op" id="8489599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8489604">defer</span>&nbsp;<span class="ident" id="8489610">wg</span><span class="op" id="8489612">.</span><span class="ident" id="8489613">Done</span><span class="op" id="8489617">(</span><span class="op" id="8489618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8489623">c</span><span class="op" id="8489624">.</span><span class="ident" id="8489625">SetReadDeadline</span><span class="op" id="8489640">(</span><span class="ident" id="8489641">time</span><span class="op" id="8489645">.</span><span class="ident" id="8489646">Now</span><span class="op" id="8489649">(</span><span class="op" id="8489650">)</span><span class="op" id="8489651">.</span><span class="ident" id="8489652">Add</span><span class="op" id="8489655">(</span><span class="num" id="8489656">5</span>&nbsp;<span class="op" id="8489658">*</span>&nbsp;<span class="ident" id="8489660">time</span><span class="op" id="8489664">.</span><span class="ident" id="8489665">Second</span><span class="op" id="8489671">)</span><span class="op" id="8489672">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8489677">b</span>&nbsp;<span class="op" id="8489679">:=</span>&nbsp;<span class="ident" id="8489682">bufio</span><span class="op" id="8489687">.</span><span class="ident" id="8489688">NewReader</span><span class="op" id="8489697">(</span><span class="ident" id="8489698">c</span><span class="op" id="8489699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8489704">for</span>&nbsp;<span class="ident" id="8489708">ct</span>&nbsp;<span class="op" id="8489711">:=</span>&nbsp;<span class="num" id="8489714">1</span><span class="op" id="8489715">;</span>&nbsp;<span class="op" id="8489717">!</span><span class="ident" id="8489718">crashy</span>&nbsp;<span class="op" id="8489725">||</span>&nbsp;<span class="ident" id="8489728">ct</span><span class="op" id="8489730">&amp;</span><span class="num" id="8489731">7</span>&nbsp;<span class="op" id="8489733">!=</span>&nbsp;<span class="num" id="8489736">0</span><span class="op" id="8489737">;</span>&nbsp;<span class="ident" id="8489739">ct</span><span class="op" id="8489741">++</span>&nbsp;<span class="op" id="8489744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8489750">s</span><span class="op" id="8489751">,</span>&nbsp;<span class="ident" id="8489753">err</span>&nbsp;<span class="op" id="8489757">:=</span>&nbsp;<span class="ident" id="8489760">b</span><span class="op" id="8489761">.</span><span class="ident" id="8489762">ReadString</span><span class="op" id="8489772">(</span><span class="string" id="8489773">&#39;\n&#39;</span><span class="op" id="8489777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8489783">if</span>&nbsp;<span class="ident" id="8489786">err</span>&nbsp;<span class="op" id="8489790">!=</span>&nbsp;<span class="ident" id="8489793">nil</span>&nbsp;<span class="op" id="8489797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8489804">break</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8489814">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8489820">done</span>&nbsp;<span class="op" id="8489825">&lt;-</span>&nbsp;<span class="ident" id="8489828">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8489833">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8489838">c</span><span class="op" id="8489839">.</span><span class="ident" id="8489840">Close</span><span class="op" id="8489845">(</span><span class="op" id="8489846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8489850">}</span><span class="op" id="8489851">(</span><span class="ident" id="8489852">c</span><span class="op" id="8489853">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8489856">}</span><br>
<span class="lineno"></span><span class="op" id="8489858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8489861">func</span>&nbsp;<span class="ident" id="8489866">startServer</span><span class="op" id="8489877">(</span><span class="ident" id="8489878">n</span><span class="op" id="8489879">,</span>&nbsp;<span class="ident" id="8489881">la</span>&nbsp;<span class="builtintype" id="8489884">string</span><span class="op" id="8489890">,</span>&nbsp;<span class="ident" id="8489892">done</span>&nbsp;<span class="keyword" id="8489897">chan</span><span class="op" id="8489901">&lt;-</span>&nbsp;<span class="builtintype" id="8489904">string</span><span class="op" id="8489910">)</span>&nbsp;<span class="op" id="8489912">(</span><span class="ident" id="8489913">addr</span>&nbsp;<span class="builtintype" id="8489918">string</span><span class="op" id="8489924">,</span>&nbsp;<span class="ident" id="8489926">sock</span>&nbsp;<span class="ident" id="8489931">io</span><span class="op" id="8489933">.</span><span class="ident" id="8489934">Closer</span><span class="op" id="8489940">,</span>&nbsp;<span class="ident" id="8489942">wg</span>&nbsp;<span class="op" id="8489945">*</span><span class="ident" id="8489946">sync</span><span class="op" id="8489950">.</span><span class="ident" id="8489951">WaitGroup</span><span class="op" id="8489960">)</span>&nbsp;<span class="op" id="8489962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8489965">if</span>&nbsp;<span class="ident" id="8489968">n</span>&nbsp;<span class="op" id="8489970">==</span>&nbsp;<span class="string" id="8489973">&#34;udp&#34;</span>&nbsp;<span class="op" id="8489979">||</span>&nbsp;<span class="ident" id="8489982">n</span>&nbsp;<span class="op" id="8489984">==</span>&nbsp;<span class="string" id="8489987">&#34;tcp&#34;</span>&nbsp;<span class="op" id="8489993">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8489997">la</span>&nbsp;<span class="op" id="8490000">=</span>&nbsp;<span class="string" id="8490002">&#34;127.0.0.1:0&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8490017">}</span>&nbsp;<span class="keyword" id="8490019">else</span>&nbsp;<span class="op" id="8490024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8490028">//&nbsp;unix&nbsp;and&nbsp;unixgram:&nbsp;choose&nbsp;an&nbsp;address&nbsp;if&nbsp;none&nbsp;given</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8490084">if</span>&nbsp;<span class="ident" id="8490087">la</span>&nbsp;<span class="op" id="8490090">==</span>&nbsp;<span class="string" id="8490093">&#34;&#34;</span>&nbsp;<span class="op" id="8490096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8490101">//&nbsp;use&nbsp;ioutil.TempFile&nbsp;to&nbsp;get&nbsp;a&nbsp;name&nbsp;that&nbsp;is&nbsp;unique</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8490156">f</span><span class="op" id="8490157">,</span>&nbsp;<span class="ident" id="8490159">err</span>&nbsp;<span class="op" id="8490163">:=</span>&nbsp;<span class="ident" id="8490166">ioutil</span><span class="op" id="8490172">.</span><span class="ident" id="8490173">TempFile</span><span class="op" id="8490181">(</span><span class="string" id="8490182">&#34;&#34;</span><span class="op" id="8490184">,</span>&nbsp;<span class="string" id="8490186">&#34;syslogtest&#34;</span><span class="op" id="8490198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8490203">if</span>&nbsp;<span class="ident" id="8490206">err</span>&nbsp;<span class="op" id="8490210">!=</span>&nbsp;<span class="ident" id="8490213">nil</span>&nbsp;<span class="op" id="8490217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8490223">log</span><span class="op" id="8490226">.</span><span class="ident" id="8490227">Fatal</span><span class="op" id="8490232">(</span><span class="string" id="8490233">&#34;TempFile:&nbsp;&#34;</span><span class="op" id="8490245">,</span>&nbsp;<span class="ident" id="8490247">err</span><span class="op" id="8490250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8490255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8490260">f</span><span class="op" id="8490261">.</span><span class="ident" id="8490262">Close</span><span class="op" id="8490267">(</span><span class="op" id="8490268">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8490273">la</span>&nbsp;<span class="op" id="8490276">=</span>&nbsp;<span class="ident" id="8490278">f</span><span class="op" id="8490279">.</span><span class="ident" id="8490280">Name</span><span class="op" id="8490284">(</span><span class="op" id="8490285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8490289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8490293">os</span><span class="op" id="8490295">.</span><span class="ident" id="8490296">Remove</span><span class="op" id="8490302">(</span><span class="ident" id="8490303">la</span><span class="op" id="8490305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8490308">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8490312">wg</span>&nbsp;<span class="op" id="8490315">=</span>&nbsp;<span class="builtinfunc" id="8490317">new</span><span class="op" id="8490320">(</span><span class="ident" id="8490321">sync</span><span class="op" id="8490325">.</span><span class="ident" id="8490326">WaitGroup</span><span class="op" id="8490335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8490338">if</span>&nbsp;<span class="ident" id="8490341">n</span>&nbsp;<span class="op" id="8490343">==</span>&nbsp;<span class="string" id="8490346">&#34;udp&#34;</span>&nbsp;<span class="op" id="8490352">||</span>&nbsp;<span class="ident" id="8490355">n</span>&nbsp;<span class="op" id="8490357">==</span>&nbsp;<span class="string" id="8490360">&#34;unixgram&#34;</span>&nbsp;<span class="op" id="8490371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8490375">l</span><span class="op" id="8490376">,</span>&nbsp;<span class="ident" id="8490378">e</span>&nbsp;<span class="op" id="8490380">:=</span>&nbsp;<span class="ident" id="8490383">net</span><span class="op" id="8490386">.</span><span class="ident" id="8490387">ListenPacket</span><span class="op" id="8490399">(</span><span class="ident" id="8490400">n</span><span class="op" id="8490401">,</span>&nbsp;<span class="ident" id="8490403">la</span><span class="op" id="8490405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8490409">if</span>&nbsp;<span class="ident" id="8490412">e</span>&nbsp;<span class="op" id="8490414">!=</span>&nbsp;<span class="ident" id="8490417">nil</span>&nbsp;<span class="op" id="8490421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8490426">log</span><span class="op" id="8490429">.</span><span class="ident" id="8490430">Fatalf</span><span class="op" id="8490436">(</span><span class="string" id="8490437">&#34;startServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8490461">,</span>&nbsp;<span class="ident" id="8490463">e</span><span class="op" id="8490464">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8490468">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8490472">addr</span>&nbsp;<span class="op" id="8490477">=</span>&nbsp;<span class="ident" id="8490479">l</span><span class="op" id="8490480">.</span><span class="ident" id="8490481">LocalAddr</span><span class="op" id="8490490">(</span><span class="op" id="8490491">)</span><span class="op" id="8490492">.</span><span class="ident" id="8490493">String</span><span class="op" id="8490499">(</span><span class="op" id="8490500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8490504">sock</span>&nbsp;<span class="op" id="8490509">=</span>&nbsp;<span class="ident" id="8490511">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8490515">wg</span><span class="op" id="8490517">.</span><span class="ident" id="8490518">Add</span><span class="op" id="8490521">(</span><span class="num" id="8490522">1</span><span class="op" id="8490523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8490527">go</span>&nbsp;<span class="keyword" id="8490530">func</span><span class="op" id="8490534">(</span><span class="op" id="8490535">)</span>&nbsp;<span class="op" id="8490537">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8490542">defer</span>&nbsp;<span class="ident" id="8490548">wg</span><span class="op" id="8490550">.</span><span class="ident" id="8490551">Done</span><span class="op" id="8490555">(</span><span class="op" id="8490556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8490561">runPktSyslog</span><span class="op" id="8490573">(</span><span class="ident" id="8490574">l</span><span class="op" id="8490575">,</span>&nbsp;<span class="ident" id="8490577">done</span><span class="op" id="8490581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8490585">}</span><span class="op" id="8490586">(</span><span class="op" id="8490587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8490590">}</span>&nbsp;<span class="keyword" id="8490592">else</span>&nbsp;<span class="op" id="8490597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8490601">l</span><span class="op" id="8490602">,</span>&nbsp;<span class="ident" id="8490604">e</span>&nbsp;<span class="op" id="8490606">:=</span>&nbsp;<span class="ident" id="8490609">net</span><span class="op" id="8490612">.</span><span class="ident" id="8490613">Listen</span><span class="op" id="8490619">(</span><span class="ident" id="8490620">n</span><span class="op" id="8490621">,</span>&nbsp;<span class="ident" id="8490623">la</span><span class="op" id="8490625">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8490629">if</span>&nbsp;<span class="ident" id="8490632">e</span>&nbsp;<span class="op" id="8490634">!=</span>&nbsp;<span class="ident" id="8490637">nil</span>&nbsp;<span class="op" id="8490641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8490646">log</span><span class="op" id="8490649">.</span><span class="ident" id="8490650">Fatalf</span><span class="op" id="8490656">(</span><span class="string" id="8490657">&#34;startServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8490681">,</span>&nbsp;<span class="ident" id="8490683">e</span><span class="op" id="8490684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8490688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8490692">addr</span>&nbsp;<span class="op" id="8490697">=</span>&nbsp;<span class="ident" id="8490699">l</span><span class="op" id="8490700">.</span><span class="ident" id="8490701">Addr</span><span class="op" id="8490705">(</span><span class="op" id="8490706">)</span><span class="op" id="8490707">.</span><span class="ident" id="8490708">String</span><span class="op" id="8490714">(</span><span class="op" id="8490715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8490719">sock</span>&nbsp;<span class="op" id="8490724">=</span>&nbsp;<span class="ident" id="8490726">l</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8490730">wg</span><span class="op" id="8490732">.</span><span class="ident" id="8490733">Add</span><span class="op" id="8490736">(</span><span class="num" id="8490737">1</span><span class="op" id="8490738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8490742">go</span>&nbsp;<span class="keyword" id="8490745">func</span><span class="op" id="8490749">(</span><span class="op" id="8490750">)</span>&nbsp;<span class="op" id="8490752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8490757">defer</span>&nbsp;<span class="ident" id="8490763">wg</span><span class="op" id="8490765">.</span><span class="ident" id="8490766">Done</span><span class="op" id="8490770">(</span><span class="op" id="8490771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8490776">runStreamSyslog</span><span class="op" id="8490791">(</span><span class="ident" id="8490792">l</span><span class="op" id="8490793">,</span>&nbsp;<span class="ident" id="8490795">done</span><span class="op" id="8490799">,</span>&nbsp;<span class="ident" id="8490801">wg</span><span class="op" id="8490803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8490807">}</span><span class="op" id="8490808">(</span><span class="op" id="8490809">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8490812">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8490815">return</span><br>
<span class="lineno"></span><span class="op" id="8490822">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8490825">func</span>&nbsp;<span class="ident" id="8490830">TestWithSimulated</span><span class="op" id="8490847">(</span><span class="ident" id="8490848">t</span>&nbsp;<span class="op" id="8490850">*</span><span class="ident" id="8490851">testing</span><span class="op" id="8490858">.</span><span class="ident" id="8490859">T</span><span class="op" id="8490860">)</span>&nbsp;<span class="op" id="8490862">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8490865">msg</span>&nbsp;<span class="op" id="8490869">:=</span>&nbsp;<span class="string" id="8490872">&#34;Test&nbsp;123&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8490884">transport</span>&nbsp;<span class="op" id="8490894">:=</span>&nbsp;<span class="op" id="8490897">[</span><span class="op" id="8490898">]</span><span class="builtintype" id="8490899">string</span><span class="op" id="8490905">{</span><span class="string" id="8490906">&#34;unix&#34;</span><span class="op" id="8490912">,</span>&nbsp;<span class="string" id="8490914">&#34;unixgram&#34;</span><span class="op" id="8490924">,</span>&nbsp;<span class="string" id="8490926">&#34;udp&#34;</span><span class="op" id="8490931">,</span>&nbsp;<span class="string" id="8490933">&#34;tcp&#34;</span><span class="op" id="8490938">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8490942">for</span>&nbsp;<span class="ident" id="8490946">_</span><span class="op" id="8490947">,</span>&nbsp;<span class="ident" id="8490949">tr</span>&nbsp;<span class="op" id="8490952">:=</span>&nbsp;<span class="keyword" id="8490955">range</span>&nbsp;<span class="ident" id="8490961">transport</span>&nbsp;<span class="op" id="8490971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8490975">done</span>&nbsp;<span class="op" id="8490980">:=</span>&nbsp;<span class="builtinfunc" id="8490983">make</span><span class="op" id="8490987">(</span><span class="keyword" id="8490988">chan</span>&nbsp;<span class="builtintype" id="8490993">string</span><span class="op" id="8490999">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8491003">addr</span><span class="op" id="8491007">,</span>&nbsp;<span class="ident" id="8491009">sock</span><span class="op" id="8491013">,</span>&nbsp;<span class="ident" id="8491015">srvWG</span>&nbsp;<span class="op" id="8491021">:=</span>&nbsp;<span class="ident" id="8491024">startServer</span><span class="op" id="8491035">(</span><span class="ident" id="8491036">tr</span><span class="op" id="8491038">,</span>&nbsp;<span class="string" id="8491040">&#34;&#34;</span><span class="op" id="8491042">,</span>&nbsp;<span class="ident" id="8491044">done</span><span class="op" id="8491048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8491052">defer</span>&nbsp;<span class="ident" id="8491058">srvWG</span><span class="op" id="8491063">.</span><span class="ident" id="8491064">Wait</span><span class="op" id="8491068">(</span><span class="op" id="8491069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8491073">defer</span>&nbsp;<span class="ident" id="8491079">sock</span><span class="op" id="8491083">.</span><span class="ident" id="8491084">Close</span><span class="op" id="8491089">(</span><span class="op" id="8491090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8491094">if</span>&nbsp;<span class="ident" id="8491097">tr</span>&nbsp;<span class="op" id="8491100">==</span>&nbsp;<span class="string" id="8491103">&#34;unix&#34;</span>&nbsp;<span class="op" id="8491110">||</span>&nbsp;<span class="ident" id="8491113">tr</span>&nbsp;<span class="op" id="8491116">==</span>&nbsp;<span class="string" id="8491119">&#34;unixgram&#34;</span>&nbsp;<span class="op" id="8491130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8491135">defer</span>&nbsp;<span class="ident" id="8491141">os</span><span class="op" id="8491143">.</span><span class="ident" id="8491144">Remove</span><span class="op" id="8491150">(</span><span class="ident" id="8491151">addr</span><span class="op" id="8491155">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8491159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8491163">s</span><span class="op" id="8491164">,</span>&nbsp;<span class="ident" id="8491166">err</span>&nbsp;<span class="op" id="8491170">:=</span>&nbsp;<span class="ident" id="8491173">Dial</span><span class="op" id="8491177">(</span><span class="ident" id="8491178">tr</span><span class="op" id="8491180">,</span>&nbsp;<span class="ident" id="8491182">addr</span><span class="op" id="8491186">,</span>&nbsp;<span class="ident" id="8491188">LOG_INFO</span><span class="op" id="8491196">|</span><span class="ident" id="8491197">LOG_USER</span><span class="op" id="8491205">,</span>&nbsp;<span class="string" id="8491207">&#34;syslog_test&#34;</span><span class="op" id="8491220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8491224">if</span>&nbsp;<span class="ident" id="8491227">err</span>&nbsp;<span class="op" id="8491231">!=</span>&nbsp;<span class="ident" id="8491234">nil</span>&nbsp;<span class="op" id="8491238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8491243">t</span><span class="op" id="8491244">.</span><span class="ident" id="8491245">Fatalf</span><span class="op" id="8491251">(</span><span class="string" id="8491252">&#34;Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8491271">,</span>&nbsp;<span class="ident" id="8491273">err</span><span class="op" id="8491276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8491280">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8491284">err</span>&nbsp;<span class="op" id="8491288">=</span>&nbsp;<span class="ident" id="8491290">s</span><span class="op" id="8491291">.</span><span class="ident" id="8491292">Info</span><span class="op" id="8491296">(</span><span class="ident" id="8491297">msg</span><span class="op" id="8491300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8491304">if</span>&nbsp;<span class="ident" id="8491307">err</span>&nbsp;<span class="op" id="8491311">!=</span>&nbsp;<span class="ident" id="8491314">nil</span>&nbsp;<span class="op" id="8491318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8491323">t</span><span class="op" id="8491324">.</span><span class="ident" id="8491325">Fatalf</span><span class="op" id="8491331">(</span><span class="string" id="8491332">&#34;log&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8491348">,</span>&nbsp;<span class="ident" id="8491350">err</span><span class="op" id="8491353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8491357">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8491361">check</span><span class="op" id="8491366">(</span><span class="ident" id="8491367">t</span><span class="op" id="8491368">,</span>&nbsp;<span class="ident" id="8491370">msg</span><span class="op" id="8491373">,</span>&nbsp;<span class="op" id="8491375">&lt;-</span><span class="ident" id="8491377">done</span><span class="op" id="8491381">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8491385">s</span><span class="op" id="8491386">.</span><span class="ident" id="8491387">Close</span><span class="op" id="8491392">(</span><span class="op" id="8491393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8491396">}</span><br>
<span class="lineno"></span><span class="op" id="8491398">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8491401">func</span>&nbsp;<span class="ident" id="8491406">TestFlap</span><span class="op" id="8491414">(</span><span class="ident" id="8491415">t</span>&nbsp;<span class="op" id="8491417">*</span><span class="ident" id="8491418">testing</span><span class="op" id="8491425">.</span><span class="ident" id="8491426">T</span><span class="op" id="8491427">)</span>&nbsp;<span class="op" id="8491429">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8491432">net</span>&nbsp;<span class="op" id="8491436">:=</span>&nbsp;<span class="string" id="8491439">&#34;unix&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8491447">done</span>&nbsp;<span class="op" id="8491452">:=</span>&nbsp;<span class="builtinfunc" id="8491455">make</span><span class="op" id="8491459">(</span><span class="keyword" id="8491460">chan</span>&nbsp;<span class="builtintype" id="8491465">string</span><span class="op" id="8491471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8491474">addr</span><span class="op" id="8491478">,</span>&nbsp;<span class="ident" id="8491480">sock</span><span class="op" id="8491484">,</span>&nbsp;<span class="ident" id="8491486">srvWG</span>&nbsp;<span class="op" id="8491492">:=</span>&nbsp;<span class="ident" id="8491495">startServer</span><span class="op" id="8491506">(</span><span class="ident" id="8491507">net</span><span class="op" id="8491510">,</span>&nbsp;<span class="string" id="8491512">&#34;&#34;</span><span class="op" id="8491514">,</span>&nbsp;<span class="ident" id="8491516">done</span><span class="op" id="8491520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8491523">defer</span>&nbsp;<span class="ident" id="8491529">srvWG</span><span class="op" id="8491534">.</span><span class="ident" id="8491535">Wait</span><span class="op" id="8491539">(</span><span class="op" id="8491540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8491543">defer</span>&nbsp;<span class="ident" id="8491549">os</span><span class="op" id="8491551">.</span><span class="ident" id="8491552">Remove</span><span class="op" id="8491558">(</span><span class="ident" id="8491559">addr</span><span class="op" id="8491563">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8491566">defer</span>&nbsp;<span class="ident" id="8491572">sock</span><span class="op" id="8491576">.</span><span class="ident" id="8491577">Close</span><span class="op" id="8491582">(</span><span class="op" id="8491583">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8491587">s</span><span class="op" id="8491588">,</span>&nbsp;<span class="ident" id="8491590">err</span>&nbsp;<span class="op" id="8491594">:=</span>&nbsp;<span class="ident" id="8491597">Dial</span><span class="op" id="8491601">(</span><span class="ident" id="8491602">net</span><span class="op" id="8491605">,</span>&nbsp;<span class="ident" id="8491607">addr</span><span class="op" id="8491611">,</span>&nbsp;<span class="ident" id="8491613">LOG_INFO</span><span class="op" id="8491621">|</span><span class="ident" id="8491622">LOG_USER</span><span class="op" id="8491630">,</span>&nbsp;<span class="string" id="8491632">&#34;syslog_test&#34;</span><span class="op" id="8491645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8491648">if</span>&nbsp;<span class="ident" id="8491651">err</span>&nbsp;<span class="op" id="8491655">!=</span>&nbsp;<span class="ident" id="8491658">nil</span>&nbsp;<span class="op" id="8491662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8491666">t</span><span class="op" id="8491667">.</span><span class="ident" id="8491668">Fatalf</span><span class="op" id="8491674">(</span><span class="string" id="8491675">&#34;Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8491694">,</span>&nbsp;<span class="ident" id="8491696">err</span><span class="op" id="8491699">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8491702">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8491705">msg</span>&nbsp;<span class="op" id="8491709">:=</span>&nbsp;<span class="string" id="8491712">&#34;Moo&nbsp;2&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8491721">err</span>&nbsp;<span class="op" id="8491725">=</span>&nbsp;<span class="ident" id="8491727">s</span><span class="op" id="8491728">.</span><span class="ident" id="8491729">Info</span><span class="op" id="8491733">(</span><span class="ident" id="8491734">msg</span><span class="op" id="8491737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8491740">if</span>&nbsp;<span class="ident" id="8491743">err</span>&nbsp;<span class="op" id="8491747">!=</span>&nbsp;<span class="ident" id="8491750">nil</span>&nbsp;<span class="op" id="8491754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8491758">t</span><span class="op" id="8491759">.</span><span class="ident" id="8491760">Fatalf</span><span class="op" id="8491766">(</span><span class="string" id="8491767">&#34;log&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8491783">,</span>&nbsp;<span class="ident" id="8491785">err</span><span class="op" id="8491788">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8491791">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8491794">check</span><span class="op" id="8491799">(</span><span class="ident" id="8491800">t</span><span class="op" id="8491801">,</span>&nbsp;<span class="ident" id="8491803">msg</span><span class="op" id="8491806">,</span>&nbsp;<span class="op" id="8491808">&lt;-</span><span class="ident" id="8491810">done</span><span class="op" id="8491814">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8491818">//&nbsp;restart&nbsp;the&nbsp;server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8491841">_</span><span class="op" id="8491842">,</span>&nbsp;<span class="ident" id="8491844">sock2</span><span class="op" id="8491849">,</span>&nbsp;<span class="ident" id="8491851">srvWG2</span>&nbsp;<span class="op" id="8491858">:=</span>&nbsp;<span class="ident" id="8491861">startServer</span><span class="op" id="8491872">(</span><span class="ident" id="8491873">net</span><span class="op" id="8491876">,</span>&nbsp;<span class="ident" id="8491878">addr</span><span class="op" id="8491882">,</span>&nbsp;<span class="ident" id="8491884">done</span><span class="op" id="8491888">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8491891">defer</span>&nbsp;<span class="ident" id="8491897">srvWG2</span><span class="op" id="8491903">.</span><span class="ident" id="8491904">Wait</span><span class="op" id="8491908">(</span><span class="op" id="8491909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8491912">defer</span>&nbsp;<span class="ident" id="8491918">sock2</span><span class="op" id="8491923">.</span><span class="ident" id="8491924">Close</span><span class="op" id="8491929">(</span><span class="op" id="8491930">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8491934">//&nbsp;and&nbsp;try&nbsp;retransmitting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8491961">msg</span>&nbsp;<span class="op" id="8491965">=</span>&nbsp;<span class="string" id="8491967">&#34;Moo&nbsp;3&#34;</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8491976">err</span>&nbsp;<span class="op" id="8491980">=</span>&nbsp;<span class="ident" id="8491982">s</span><span class="op" id="8491983">.</span><span class="ident" id="8491984">Info</span><span class="op" id="8491988">(</span><span class="ident" id="8491989">msg</span><span class="op" id="8491992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8491995">if</span>&nbsp;<span class="ident" id="8491998">err</span>&nbsp;<span class="op" id="8492002">!=</span>&nbsp;<span class="ident" id="8492005">nil</span>&nbsp;<span class="op" id="8492009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8492013">t</span><span class="op" id="8492014">.</span><span class="ident" id="8492015">Fatalf</span><span class="op" id="8492021">(</span><span class="string" id="8492022">&#34;log&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8492038">,</span>&nbsp;<span class="ident" id="8492040">err</span><span class="op" id="8492043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8492046">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8492049">check</span><span class="op" id="8492054">(</span><span class="ident" id="8492055">t</span><span class="op" id="8492056">,</span>&nbsp;<span class="ident" id="8492058">msg</span><span class="op" id="8492061">,</span>&nbsp;<span class="op" id="8492063">&lt;-</span><span class="ident" id="8492065">done</span><span class="op" id="8492069">)</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8492073">s</span><span class="op" id="8492074">.</span><span class="ident" id="8492075">Close</span><span class="op" id="8492080">(</span><span class="op" id="8492081">)</span><br>
<span class="lineno"></span><span class="op" id="8492083">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8492086">func</span>&nbsp;<span class="ident" id="8492091">TestNew</span><span class="op" id="8492098">(</span><span class="ident" id="8492099">t</span>&nbsp;<span class="op" id="8492101">*</span><span class="ident" id="8492102">testing</span><span class="op" id="8492109">.</span><span class="ident" id="8492110">T</span><span class="op" id="8492111">)</span>&nbsp;<span class="op" id="8492113">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8492116">if</span>&nbsp;<span class="ident" id="8492119">LOG_LOCAL7</span>&nbsp;<span class="op" id="8492130">!=</span>&nbsp;<span class="num" id="8492133">23</span><span class="op" id="8492135">&lt;&lt;</span><span class="num" id="8492137">3</span>&nbsp;<span class="op" id="8492139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8492143">t</span><span class="op" id="8492144">.</span><span class="ident" id="8492145">Fatalf</span><span class="op" id="8492151">(</span><span class="string" id="8492152">&#34;LOG_LOCAL7&nbsp;has&nbsp;wrong&nbsp;value&#34;</span><span class="op" id="8492180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8492183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8492186">if</span>&nbsp;<span class="ident" id="8492189">testing</span><span class="op" id="8492196">.</span><span class="ident" id="8492197">Short</span><span class="op" id="8492202">(</span><span class="op" id="8492203">)</span>&nbsp;<span class="op" id="8492205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8492209">//&nbsp;Depends&nbsp;on&nbsp;syslog&nbsp;daemon&nbsp;running,&nbsp;and&nbsp;sometimes&nbsp;it&#39;s&nbsp;not.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8492272">t</span><span class="op" id="8492273">.</span><span class="ident" id="8492274">Skip</span><span class="op" id="8492278">(</span><span class="string" id="8492279">&#34;skipping&nbsp;syslog&nbsp;test&nbsp;during&nbsp;-short&#34;</span><span class="op" id="8492315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8492318">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8492322">s</span><span class="op" id="8492323">,</span>&nbsp;<span class="ident" id="8492325">err</span>&nbsp;<span class="op" id="8492329">:=</span>&nbsp;<span class="ident" id="8492332">New</span><span class="op" id="8492335">(</span><span class="ident" id="8492336">LOG_INFO</span><span class="op" id="8492344">|</span><span class="ident" id="8492345">LOG_USER</span><span class="op" id="8492353">,</span>&nbsp;<span class="string" id="8492355">&#34;the_tag&#34;</span><span class="op" id="8492364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8492367">if</span>&nbsp;<span class="ident" id="8492370">err</span>&nbsp;<span class="op" id="8492374">!=</span>&nbsp;<span class="ident" id="8492377">nil</span>&nbsp;<span class="op" id="8492381">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8492385">t</span><span class="op" id="8492386">.</span><span class="ident" id="8492387">Fatalf</span><span class="op" id="8492393">(</span><span class="string" id="8492394">&#34;New()&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8492412">,</span>&nbsp;<span class="ident" id="8492414">err</span><span class="op" id="8492417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8492420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8492423">//&nbsp;Don&#39;t&nbsp;send&nbsp;any&nbsp;messages.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8492452">s</span><span class="op" id="8492453">.</span><span class="ident" id="8492454">Close</span><span class="op" id="8492459">(</span><span class="op" id="8492460">)</span><br>
<span class="lineno"></span><span class="op" id="8492462">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="keyword" id="8492465">func</span>&nbsp;<span class="ident" id="8492470">TestNewLogger</span><span class="op" id="8492483">(</span><span class="ident" id="8492484">t</span>&nbsp;<span class="op" id="8492486">*</span><span class="ident" id="8492487">testing</span><span class="op" id="8492494">.</span><span class="ident" id="8492495">T</span><span class="op" id="8492496">)</span>&nbsp;<span class="op" id="8492498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8492501">if</span>&nbsp;<span class="ident" id="8492504">testing</span><span class="op" id="8492511">.</span><span class="ident" id="8492512">Short</span><span class="op" id="8492517">(</span><span class="op" id="8492518">)</span>&nbsp;<span class="op" id="8492520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8492524">t</span><span class="op" id="8492525">.</span><span class="ident" id="8492526">Skip</span><span class="op" id="8492530">(</span><span class="string" id="8492531">&#34;skipping&nbsp;syslog&nbsp;test&nbsp;during&nbsp;-short&#34;</span><span class="op" id="8492567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8492570">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8492573">f</span><span class="op" id="8492574">,</span>&nbsp;<span class="ident" id="8492576">err</span>&nbsp;<span class="op" id="8492580">:=</span>&nbsp;<span class="ident" id="8492583">NewLogger</span><span class="op" id="8492592">(</span><span class="ident" id="8492593">LOG_USER</span><span class="op" id="8492601">|</span><span class="ident" id="8492602">LOG_INFO</span><span class="op" id="8492610">,</span>&nbsp;<span class="num" id="8492612">0</span><span class="op" id="8492613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8492616">if</span>&nbsp;<span class="ident" id="8492619">f</span>&nbsp;<span class="op" id="8492621">==</span>&nbsp;<span class="ident" id="8492624">nil</span>&nbsp;<span class="op" id="8492628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8492632">t</span><span class="op" id="8492633">.</span><span class="ident" id="8492634">Error</span><span class="op" id="8492639">(</span><span class="ident" id="8492640">err</span><span class="op" id="8492643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8492646">}</span><br>
<span class="lineno"></span><span class="op" id="8492648">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="8492651">func</span>&nbsp;<span class="ident" id="8492656">TestDial</span><span class="op" id="8492664">(</span><span class="ident" id="8492665">t</span>&nbsp;<span class="op" id="8492667">*</span><span class="ident" id="8492668">testing</span><span class="op" id="8492675">.</span><span class="ident" id="8492676">T</span><span class="op" id="8492677">)</span>&nbsp;<span class="op" id="8492679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8492682">if</span>&nbsp;<span class="ident" id="8492685">testing</span><span class="op" id="8492692">.</span><span class="ident" id="8492693">Short</span><span class="op" id="8492698">(</span><span class="op" id="8492699">)</span>&nbsp;<span class="op" id="8492701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8492705">t</span><span class="op" id="8492706">.</span><span class="ident" id="8492707">Skip</span><span class="op" id="8492711">(</span><span class="string" id="8492712">&#34;skipping&nbsp;syslog&nbsp;test&nbsp;during&nbsp;-short&#34;</span><span class="op" id="8492748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8492751">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8492754">f</span><span class="op" id="8492755">,</span>&nbsp;<span class="ident" id="8492757">err</span>&nbsp;<span class="op" id="8492761">:=</span>&nbsp;<span class="ident" id="8492764">Dial</span><span class="op" id="8492768">(</span><span class="string" id="8492769">&#34;&#34;</span><span class="op" id="8492771">,</span>&nbsp;<span class="string" id="8492773">&#34;&#34;</span><span class="op" id="8492775">,</span>&nbsp;<span class="op" id="8492777">(</span><span class="ident" id="8492778">LOG_LOCAL7</span><span class="op" id="8492788">|</span><span class="ident" id="8492789">LOG_DEBUG</span><span class="op" id="8492798">)</span><span class="op" id="8492799">+</span><span class="num" id="8492800">1</span><span class="op" id="8492801">,</span>&nbsp;<span class="string" id="8492803">&#34;syslog_test&#34;</span><span class="op" id="8492816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8492819">if</span>&nbsp;<span class="ident" id="8492822">f</span>&nbsp;<span class="op" id="8492824">!=</span>&nbsp;<span class="ident" id="8492827">nil</span>&nbsp;<span class="op" id="8492831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8492835">t</span><span class="op" id="8492836">.</span><span class="ident" id="8492837">Fatalf</span><span class="op" id="8492843">(</span><span class="string" id="8492844">&#34;Should&nbsp;have&nbsp;trapped&nbsp;bad&nbsp;priority&#34;</span><span class="op" id="8492878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8492881">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8492884">f</span><span class="op" id="8492885">,</span>&nbsp;<span class="ident" id="8492887">err</span>&nbsp;<span class="op" id="8492891">=</span>&nbsp;<span class="ident" id="8492893">Dial</span><span class="op" id="8492897">(</span><span class="string" id="8492898">&#34;&#34;</span><span class="op" id="8492900">,</span>&nbsp;<span class="string" id="8492902">&#34;&#34;</span><span class="op" id="8492904">,</span>&nbsp;<span class="op" id="8492906">-</span><span class="num" id="8492907">1</span><span class="op" id="8492908">,</span>&nbsp;<span class="string" id="8492910">&#34;syslog_test&#34;</span><span class="op" id="8492923">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8492926">if</span>&nbsp;<span class="ident" id="8492929">f</span>&nbsp;<span class="op" id="8492931">!=</span>&nbsp;<span class="ident" id="8492934">nil</span>&nbsp;<span class="op" id="8492938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8492942">t</span><span class="op" id="8492943">.</span><span class="ident" id="8492944">Fatalf</span><span class="op" id="8492950">(</span><span class="string" id="8492951">&#34;Should&nbsp;have&nbsp;trapped&nbsp;bad&nbsp;priority&#34;</span><span class="op" id="8492985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8492988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8492991">l</span><span class="op" id="8492992">,</span>&nbsp;<span class="ident" id="8492994">err</span>&nbsp;<span class="op" id="8492998">:=</span>&nbsp;<span class="ident" id="8493001">Dial</span><span class="op" id="8493005">(</span><span class="string" id="8493006">&#34;&#34;</span><span class="op" id="8493008">,</span>&nbsp;<span class="string" id="8493010">&#34;&#34;</span><span class="op" id="8493012">,</span>&nbsp;<span class="ident" id="8493014">LOG_USER</span><span class="op" id="8493022">|</span><span class="ident" id="8493023">LOG_ERR</span><span class="op" id="8493030">,</span>&nbsp;<span class="string" id="8493032">&#34;syslog_test&#34;</span><span class="op" id="8493045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8493048">if</span>&nbsp;<span class="ident" id="8493051">err</span>&nbsp;<span class="op" id="8493055">!=</span>&nbsp;<span class="ident" id="8493058">nil</span>&nbsp;<span class="op" id="8493062">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8493066">t</span><span class="op" id="8493067">.</span><span class="ident" id="8493068">Fatalf</span><span class="op" id="8493074">(</span><span class="string" id="8493075">&#34;Dial()&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8493094">,</span>&nbsp;<span class="ident" id="8493096">err</span><span class="op" id="8493099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8493102">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8493105">l</span><span class="op" id="8493106">.</span><span class="ident" id="8493107">Close</span><span class="op" id="8493112">(</span><span class="op" id="8493113">)</span><br>
<span class="lineno"></span><span class="op" id="8493115">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="8493118">func</span>&nbsp;<span class="ident" id="8493123">check</span><span class="op" id="8493128">(</span><span class="ident" id="8493129">t</span>&nbsp;<span class="op" id="8493131">*</span><span class="ident" id="8493132">testing</span><span class="op" id="8493139">.</span><span class="ident" id="8493140">T</span><span class="op" id="8493141">,</span>&nbsp;<span class="ident" id="8493143">in</span><span class="op" id="8493145">,</span>&nbsp;<span class="ident" id="8493147">out</span>&nbsp;<span class="builtintype" id="8493151">string</span><span class="op" id="8493157">)</span>&nbsp;<span class="op" id="8493159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8493162">tmpl</span>&nbsp;<span class="op" id="8493167">:=</span>&nbsp;<span class="ident" id="8493170">fmt</span><span class="op" id="8493173">.</span><span class="ident" id="8493174">Sprintf</span><span class="op" id="8493181">(</span><span class="string" id="8493182">&#34;&lt;%d&gt;%%s&nbsp;%%s&nbsp;syslog_test[%%d]:&nbsp;%s\n&#34;</span><span class="op" id="8493218">,</span>&nbsp;<span class="ident" id="8493220">LOG_USER</span><span class="op" id="8493228">+</span><span class="ident" id="8493229">LOG_INFO</span><span class="op" id="8493237">,</span>&nbsp;<span class="ident" id="8493239">in</span><span class="op" id="8493241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8493244">if</span>&nbsp;<span class="ident" id="8493247">hostname</span><span class="op" id="8493255">,</span>&nbsp;<span class="ident" id="8493257">err</span>&nbsp;<span class="op" id="8493261">:=</span>&nbsp;<span class="ident" id="8493264">os</span><span class="op" id="8493266">.</span><span class="ident" id="8493267">Hostname</span><span class="op" id="8493275">(</span><span class="op" id="8493276">)</span><span class="op" id="8493277">;</span>&nbsp;<span class="ident" id="8493279">err</span>&nbsp;<span class="op" id="8493283">!=</span>&nbsp;<span class="ident" id="8493286">nil</span>&nbsp;<span class="op" id="8493290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8493294">t</span><span class="op" id="8493295">.</span><span class="ident" id="8493296">Error</span><span class="op" id="8493301">(</span><span class="string" id="8493302">&#34;Error&nbsp;retrieving&nbsp;hostname&#34;</span><span class="op" id="8493329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8493332">}</span>&nbsp;<span class="keyword" id="8493334">else</span>&nbsp;<span class="op" id="8493339">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8493343">var</span>&nbsp;<span class="ident" id="8493347">parsedHostname</span><span class="op" id="8493361">,</span>&nbsp;<span class="ident" id="8493363">timestamp</span>&nbsp;<span class="builtintype" id="8493373">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8493382">var</span>&nbsp;<span class="ident" id="8493386">pid</span>&nbsp;<span class="builtintype" id="8493390">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8493396">if</span>&nbsp;<span class="ident" id="8493399">n</span><span class="op" id="8493400">,</span>&nbsp;<span class="ident" id="8493402">err</span>&nbsp;<span class="op" id="8493406">:=</span>&nbsp;<span class="ident" id="8493409">fmt</span><span class="op" id="8493412">.</span><span class="ident" id="8493413">Sscanf</span><span class="op" id="8493419">(</span><span class="ident" id="8493420">out</span><span class="op" id="8493423">,</span>&nbsp;<span class="ident" id="8493425">tmpl</span><span class="op" id="8493429">,</span>&nbsp;<span class="op" id="8493431">&amp;</span><span class="ident" id="8493432">timestamp</span><span class="op" id="8493441">,</span>&nbsp;<span class="op" id="8493443">&amp;</span><span class="ident" id="8493444">parsedHostname</span><span class="op" id="8493458">,</span>&nbsp;<span class="op" id="8493460">&amp;</span><span class="ident" id="8493461">pid</span><span class="op" id="8493464">)</span><span class="op" id="8493465">;</span>&nbsp;<span class="ident" id="8493467">n</span>&nbsp;<span class="op" id="8493469">!=</span>&nbsp;<span class="num" id="8493472">3</span>&nbsp;<span class="op" id="8493474">||</span>&nbsp;<span class="ident" id="8493477">err</span>&nbsp;<span class="op" id="8493481">!=</span>&nbsp;<span class="ident" id="8493484">nil</span>&nbsp;<span class="op" id="8493488">||</span>&nbsp;<span class="ident" id="8493491">hostname</span>&nbsp;<span class="op" id="8493500">!=</span>&nbsp;<span class="ident" id="8493503">parsedHostname</span>&nbsp;<span class="op" id="8493518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8493523">t</span><span class="op" id="8493524">.</span><span class="ident" id="8493525">Errorf</span><span class="op" id="8493531">(</span><span class="string" id="8493532">&#34;Got&nbsp;%q,&nbsp;does&nbsp;not&nbsp;match&nbsp;template&nbsp;%q&nbsp;(%d&nbsp;%s)&#34;</span><span class="op" id="8493576">,</span>&nbsp;<span class="ident" id="8493578">out</span><span class="op" id="8493581">,</span>&nbsp;<span class="ident" id="8493583">tmpl</span><span class="op" id="8493587">,</span>&nbsp;<span class="ident" id="8493589">n</span><span class="op" id="8493590">,</span>&nbsp;<span class="ident" id="8493592">err</span><span class="op" id="8493595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8493599">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8493602">}</span><br>
<span class="lineno"></span><span class="op" id="8493604">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8493607">func</span>&nbsp;<span class="ident" id="8493612">TestWrite</span><span class="op" id="8493621">(</span><span class="ident" id="8493622">t</span>&nbsp;<span class="op" id="8493624">*</span><span class="ident" id="8493625">testing</span><span class="op" id="8493632">.</span><span class="ident" id="8493633">T</span><span class="op" id="8493634">)</span>&nbsp;<span class="op" id="8493636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8493639">tests</span>&nbsp;<span class="op" id="8493645">:=</span>&nbsp;<span class="op" id="8493648">[</span><span class="op" id="8493649">]</span><span class="keyword" id="8493650">struct</span>&nbsp;<span class="op" id="8493657">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8493661">pri</span>&nbsp;<span class="ident" id="8493665">Priority</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8493676">pre</span>&nbsp;<span class="builtintype" id="8493680">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8493689">msg</span>&nbsp;<span class="builtintype" id="8493693">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8493702">exp</span>&nbsp;<span class="builtintype" id="8493706">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8493714">}</span><span class="op" id="8493715">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8493719">{</span><span class="ident" id="8493720">LOG_USER</span>&nbsp;<span class="op" id="8493729">|</span>&nbsp;<span class="ident" id="8493731">LOG_ERR</span><span class="op" id="8493738">,</span>&nbsp;<span class="string" id="8493740">&#34;syslog_test&#34;</span><span class="op" id="8493753">,</span>&nbsp;<span class="string" id="8493755">&#34;&#34;</span><span class="op" id="8493757">,</span>&nbsp;<span class="string" id="8493759">&#34;%s&nbsp;%s&nbsp;syslog_test[%d]:&nbsp;\n&#34;</span><span class="op" id="8493786">}</span><span class="op" id="8493787">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8493791">{</span><span class="ident" id="8493792">LOG_USER</span>&nbsp;<span class="op" id="8493801">|</span>&nbsp;<span class="ident" id="8493803">LOG_ERR</span><span class="op" id="8493810">,</span>&nbsp;<span class="string" id="8493812">&#34;syslog_test&#34;</span><span class="op" id="8493825">,</span>&nbsp;<span class="string" id="8493827">&#34;write&nbsp;test&#34;</span><span class="op" id="8493839">,</span>&nbsp;<span class="string" id="8493841">&#34;%s&nbsp;%s&nbsp;syslog_test[%d]:&nbsp;write&nbsp;test\n&#34;</span><span class="op" id="8493878">}</span><span class="op" id="8493879">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8493883">//&nbsp;Write&nbsp;should&nbsp;not&nbsp;add&nbsp;\n&nbsp;if&nbsp;there&nbsp;already&nbsp;is&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8493936">{</span><span class="ident" id="8493937">LOG_USER</span>&nbsp;<span class="op" id="8493946">|</span>&nbsp;<span class="ident" id="8493948">LOG_ERR</span><span class="op" id="8493955">,</span>&nbsp;<span class="string" id="8493957">&#34;syslog_test&#34;</span><span class="op" id="8493970">,</span>&nbsp;<span class="string" id="8493972">&#34;write&nbsp;test&nbsp;2\n&#34;</span><span class="op" id="8493988">,</span>&nbsp;<span class="string" id="8493990">&#34;%s&nbsp;%s&nbsp;syslog_test[%d]:&nbsp;write&nbsp;test&nbsp;2\n&#34;</span><span class="op" id="8494029">}</span><span class="op" id="8494030">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8494033">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8494037">if</span>&nbsp;<span class="ident" id="8494040">hostname</span><span class="op" id="8494048">,</span>&nbsp;<span class="ident" id="8494050">err</span>&nbsp;<span class="op" id="8494054">:=</span>&nbsp;<span class="ident" id="8494057">os</span><span class="op" id="8494059">.</span><span class="ident" id="8494060">Hostname</span><span class="op" id="8494068">(</span><span class="op" id="8494069">)</span><span class="op" id="8494070">;</span>&nbsp;<span class="ident" id="8494072">err</span>&nbsp;<span class="op" id="8494076">!=</span>&nbsp;<span class="ident" id="8494079">nil</span>&nbsp;<span class="op" id="8494083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8494087">t</span><span class="op" id="8494088">.</span><span class="ident" id="8494089">Fatalf</span><span class="op" id="8494095">(</span><span class="string" id="8494096">&#34;Error&nbsp;retrieving&nbsp;hostname&#34;</span><span class="op" id="8494123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8494126">}</span>&nbsp;<span class="keyword" id="8494128">else</span>&nbsp;<span class="op" id="8494133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8494137">for</span>&nbsp;<span class="ident" id="8494141">_</span><span class="op" id="8494142">,</span>&nbsp;<span class="ident" id="8494144">test</span>&nbsp;<span class="op" id="8494149">:=</span>&nbsp;<span class="keyword" id="8494152">range</span>&nbsp;<span class="ident" id="8494158">tests</span>&nbsp;<span class="op" id="8494164">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8494169">done</span>&nbsp;<span class="op" id="8494174">:=</span>&nbsp;<span class="builtinfunc" id="8494177">make</span><span class="op" id="8494181">(</span><span class="keyword" id="8494182">chan</span>&nbsp;<span class="builtintype" id="8494187">string</span><span class="op" id="8494193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8494198">addr</span><span class="op" id="8494202">,</span>&nbsp;<span class="ident" id="8494204">sock</span><span class="op" id="8494208">,</span>&nbsp;<span class="ident" id="8494210">srvWG</span>&nbsp;<span class="op" id="8494216">:=</span>&nbsp;<span class="ident" id="8494219">startServer</span><span class="op" id="8494230">(</span><span class="string" id="8494231">&#34;udp&#34;</span><span class="op" id="8494236">,</span>&nbsp;<span class="string" id="8494238">&#34;&#34;</span><span class="op" id="8494240">,</span>&nbsp;<span class="ident" id="8494242">done</span><span class="op" id="8494246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8494251">defer</span>&nbsp;<span class="ident" id="8494257">srvWG</span><span class="op" id="8494262">.</span><span class="ident" id="8494263">Wait</span><span class="op" id="8494267">(</span><span class="op" id="8494268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8494273">defer</span>&nbsp;<span class="ident" id="8494279">sock</span><span class="op" id="8494283">.</span><span class="ident" id="8494284">Close</span><span class="op" id="8494289">(</span><span class="op" id="8494290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8494295">l</span><span class="op" id="8494296">,</span>&nbsp;<span class="ident" id="8494298">err</span>&nbsp;<span class="op" id="8494302">:=</span>&nbsp;<span class="ident" id="8494305">Dial</span><span class="op" id="8494309">(</span><span class="string" id="8494310">&#34;udp&#34;</span><span class="op" id="8494315">,</span>&nbsp;<span class="ident" id="8494317">addr</span><span class="op" id="8494321">,</span>&nbsp;<span class="ident" id="8494323">test</span><span class="op" id="8494327">.</span><span class="ident" id="8494328">pri</span><span class="op" id="8494331">,</span>&nbsp;<span class="ident" id="8494333">test</span><span class="op" id="8494337">.</span><span class="ident" id="8494338">pre</span><span class="op" id="8494341">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8494346">if</span>&nbsp;<span class="ident" id="8494349">err</span>&nbsp;<span class="op" id="8494353">!=</span>&nbsp;<span class="ident" id="8494356">nil</span>&nbsp;<span class="op" id="8494360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8494366">t</span><span class="op" id="8494367">.</span><span class="ident" id="8494368">Fatalf</span><span class="op" id="8494374">(</span><span class="string" id="8494375">&#34;syslog.Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8494401">,</span>&nbsp;<span class="ident" id="8494403">err</span><span class="op" id="8494406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8494411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8494416">defer</span>&nbsp;<span class="ident" id="8494422">l</span><span class="op" id="8494423">.</span><span class="ident" id="8494424">Close</span><span class="op" id="8494429">(</span><span class="op" id="8494430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8494435">_</span><span class="op" id="8494436">,</span>&nbsp;<span class="ident" id="8494438">err</span>&nbsp;<span class="op" id="8494442">=</span>&nbsp;<span class="ident" id="8494444">io</span><span class="op" id="8494446">.</span><span class="ident" id="8494447">WriteString</span><span class="op" id="8494458">(</span><span class="ident" id="8494459">l</span><span class="op" id="8494460">,</span>&nbsp;<span class="ident" id="8494462">test</span><span class="op" id="8494466">.</span><span class="ident" id="8494467">msg</span><span class="op" id="8494470">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8494475">if</span>&nbsp;<span class="ident" id="8494478">err</span>&nbsp;<span class="op" id="8494482">!=</span>&nbsp;<span class="ident" id="8494485">nil</span>&nbsp;<span class="op" id="8494489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8494495">t</span><span class="op" id="8494496">.</span><span class="ident" id="8494497">Fatalf</span><span class="op" id="8494503">(</span><span class="string" id="8494504">&#34;WriteString()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8494530">,</span>&nbsp;<span class="ident" id="8494532">err</span><span class="op" id="8494535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8494540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8494545">rcvd</span>&nbsp;<span class="op" id="8494550">:=</span>&nbsp;<span class="op" id="8494553">&lt;-</span><span class="ident" id="8494555">done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8494563">test</span><span class="op" id="8494567">.</span><span class="ident" id="8494568">exp</span>&nbsp;<span class="op" id="8494572">=</span>&nbsp;<span class="ident" id="8494574">fmt</span><span class="op" id="8494577">.</span><span class="ident" id="8494578">Sprintf</span><span class="op" id="8494585">(</span><span class="string" id="8494586">&#34;&lt;%d&gt;&#34;</span><span class="op" id="8494592">,</span>&nbsp;<span class="ident" id="8494594">test</span><span class="op" id="8494598">.</span><span class="ident" id="8494599">pri</span><span class="op" id="8494602">)</span>&nbsp;<span class="op" id="8494604">+</span>&nbsp;<span class="ident" id="8494606">test</span><span class="op" id="8494610">.</span><span class="ident" id="8494611">exp</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8494618">var</span>&nbsp;<span class="ident" id="8494622">parsedHostname</span><span class="op" id="8494636">,</span>&nbsp;<span class="ident" id="8494638">timestamp</span>&nbsp;<span class="builtintype" id="8494648">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8494658">var</span>&nbsp;<span class="ident" id="8494662">pid</span>&nbsp;<span class="builtintype" id="8494666">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8494673">if</span>&nbsp;<span class="ident" id="8494676">n</span><span class="op" id="8494677">,</span>&nbsp;<span class="ident" id="8494679">err</span>&nbsp;<span class="op" id="8494683">:=</span>&nbsp;<span class="ident" id="8494686">fmt</span><span class="op" id="8494689">.</span><span class="ident" id="8494690">Sscanf</span><span class="op" id="8494696">(</span><span class="ident" id="8494697">rcvd</span><span class="op" id="8494701">,</span>&nbsp;<span class="ident" id="8494703">test</span><span class="op" id="8494707">.</span><span class="ident" id="8494708">exp</span><span class="op" id="8494711">,</span>&nbsp;<span class="op" id="8494713">&amp;</span><span class="ident" id="8494714">timestamp</span><span class="op" id="8494723">,</span>&nbsp;<span class="op" id="8494725">&amp;</span><span class="ident" id="8494726">parsedHostname</span><span class="op" id="8494740">,</span>&nbsp;<span class="op" id="8494742">&amp;</span><span class="ident" id="8494743">pid</span><span class="op" id="8494746">)</span><span class="op" id="8494747">;</span>&nbsp;<span class="ident" id="8494749">n</span>&nbsp;<span class="op" id="8494751">!=</span>&nbsp;<span class="num" id="8494754">3</span>&nbsp;<span class="op" id="8494756">||</span>&nbsp;<span class="ident" id="8494759">err</span>&nbsp;<span class="op" id="8494763">!=</span>&nbsp;<span class="ident" id="8494766">nil</span>&nbsp;<span class="op" id="8494770">||</span>&nbsp;<span class="ident" id="8494773">hostname</span>&nbsp;<span class="op" id="8494782">!=</span>&nbsp;<span class="ident" id="8494785">parsedHostname</span>&nbsp;<span class="op" id="8494800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8494806">t</span><span class="op" id="8494807">.</span><span class="ident" id="8494808">Errorf</span><span class="op" id="8494814">(</span><span class="string" id="8494815">&#34;s.Info()&nbsp;=&nbsp;&#39;%q&#39;,&nbsp;didn&#39;t&nbsp;match&nbsp;&#39;%q&#39;&nbsp;(%d&nbsp;%s)&#34;</span><span class="op" id="8494859">,</span>&nbsp;<span class="ident" id="8494861">rcvd</span><span class="op" id="8494865">,</span>&nbsp;<span class="ident" id="8494867">test</span><span class="op" id="8494871">.</span><span class="ident" id="8494872">exp</span><span class="op" id="8494875">,</span>&nbsp;<span class="ident" id="8494877">n</span><span class="op" id="8494878">,</span>&nbsp;<span class="ident" id="8494880">err</span><span class="op" id="8494883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8494888">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8494892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8494895">}</span><br>
<span class="lineno"></span><span class="op" id="8494897">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8494900">func</span>&nbsp;<span class="ident" id="8494905">TestConcurrentWrite</span><span class="op" id="8494924">(</span><span class="ident" id="8494925">t</span>&nbsp;<span class="op" id="8494927">*</span><span class="ident" id="8494928">testing</span><span class="op" id="8494935">.</span><span class="ident" id="8494936">T</span><span class="op" id="8494937">)</span>&nbsp;<span class="op" id="8494939">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8494942">addr</span><span class="op" id="8494946">,</span>&nbsp;<span class="ident" id="8494948">sock</span><span class="op" id="8494952">,</span>&nbsp;<span class="ident" id="8494954">srvWG</span>&nbsp;<span class="op" id="8494960">:=</span>&nbsp;<span class="ident" id="8494963">startServer</span><span class="op" id="8494974">(</span><span class="string" id="8494975">&#34;udp&#34;</span><span class="op" id="8494980">,</span>&nbsp;<span class="string" id="8494982">&#34;&#34;</span><span class="op" id="8494984">,</span>&nbsp;<span class="builtinfunc" id="8494986">make</span><span class="op" id="8494990">(</span><span class="keyword" id="8494991">chan</span>&nbsp;<span class="builtintype" id="8494996">string</span><span class="op" id="8495002">,</span>&nbsp;<span class="num" id="8495004">1</span><span class="op" id="8495005">)</span><span class="op" id="8495006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8495009">defer</span>&nbsp;<span class="ident" id="8495015">srvWG</span><span class="op" id="8495020">.</span><span class="ident" id="8495021">Wait</span><span class="op" id="8495025">(</span><span class="op" id="8495026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8495029">defer</span>&nbsp;<span class="ident" id="8495035">sock</span><span class="op" id="8495039">.</span><span class="ident" id="8495040">Close</span><span class="op" id="8495045">(</span><span class="op" id="8495046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8495049">w</span><span class="op" id="8495050">,</span>&nbsp;<span class="ident" id="8495052">err</span>&nbsp;<span class="op" id="8495056">:=</span>&nbsp;<span class="ident" id="8495059">Dial</span><span class="op" id="8495063">(</span><span class="string" id="8495064">&#34;udp&#34;</span><span class="op" id="8495069">,</span>&nbsp;<span class="ident" id="8495071">addr</span><span class="op" id="8495075">,</span>&nbsp;<span class="ident" id="8495077">LOG_USER</span><span class="op" id="8495085">|</span><span class="ident" id="8495086">LOG_ERR</span><span class="op" id="8495093">,</span>&nbsp;<span class="string" id="8495095">&#34;how&#39;s&nbsp;it&nbsp;going?&#34;</span><span class="op" id="8495112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8495115">if</span>&nbsp;<span class="ident" id="8495118">err</span>&nbsp;<span class="op" id="8495122">!=</span>&nbsp;<span class="ident" id="8495125">nil</span>&nbsp;<span class="op" id="8495129">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8495133">t</span><span class="op" id="8495134">.</span><span class="ident" id="8495135">Fatalf</span><span class="op" id="8495141">(</span><span class="string" id="8495142">&#34;syslog.Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8495168">,</span>&nbsp;<span class="ident" id="8495170">err</span><span class="op" id="8495173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8495176">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8495179">var</span>&nbsp;<span class="ident" id="8495183">wg</span>&nbsp;<span class="ident" id="8495186">sync</span><span class="op" id="8495190">.</span><span class="ident" id="8495191">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8495202">for</span>&nbsp;<span class="ident" id="8495206">i</span>&nbsp;<span class="op" id="8495208">:=</span>&nbsp;<span class="num" id="8495211">0</span><span class="op" id="8495212">;</span>&nbsp;<span class="ident" id="8495214">i</span>&nbsp;<span class="op" id="8495216">&lt;</span>&nbsp;<span class="num" id="8495218">10</span><span class="op" id="8495220">;</span>&nbsp;<span class="ident" id="8495222">i</span><span class="op" id="8495223">++</span>&nbsp;<span class="op" id="8495226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8495230">wg</span><span class="op" id="8495232">.</span><span class="ident" id="8495233">Add</span><span class="op" id="8495236">(</span><span class="num" id="8495237">1</span><span class="op" id="8495238">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8495242">go</span>&nbsp;<span class="keyword" id="8495245">func</span><span class="op" id="8495249">(</span><span class="op" id="8495250">)</span>&nbsp;<span class="op" id="8495252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8495257">defer</span>&nbsp;<span class="ident" id="8495263">wg</span><span class="op" id="8495265">.</span><span class="ident" id="8495266">Done</span><span class="op" id="8495270">(</span><span class="op" id="8495271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8495276">err</span>&nbsp;<span class="op" id="8495280">:=</span>&nbsp;<span class="ident" id="8495283">w</span><span class="op" id="8495284">.</span><span class="ident" id="8495285">Info</span><span class="op" id="8495289">(</span><span class="string" id="8495290">&#34;test&#34;</span><span class="op" id="8495296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8495301">if</span>&nbsp;<span class="ident" id="8495304">err</span>&nbsp;<span class="op" id="8495308">!=</span>&nbsp;<span class="ident" id="8495311">nil</span>&nbsp;<span class="op" id="8495315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8495321">t</span><span class="op" id="8495322">.</span><span class="ident" id="8495323">Errorf</span><span class="op" id="8495329">(</span><span class="string" id="8495330">&#34;Info()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8495349">,</span>&nbsp;<span class="ident" id="8495351">err</span><span class="op" id="8495354">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8495360">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8495370">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8495374">}</span><span class="op" id="8495375">(</span><span class="op" id="8495376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8495379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8495382">wg</span><span class="op" id="8495384">.</span><span class="ident" id="8495385">Wait</span><span class="op" id="8495389">(</span><span class="op" id="8495390">)</span><br>
<span class="lineno">300</span><span class="op" id="8495392">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8495395">func</span>&nbsp;<span class="ident" id="8495400">TestConcurrentReconnect</span><span class="op" id="8495423">(</span><span class="ident" id="8495424">t</span>&nbsp;<span class="op" id="8495426">*</span><span class="ident" id="8495427">testing</span><span class="op" id="8495434">.</span><span class="ident" id="8495435">T</span><span class="op" id="8495436">)</span>&nbsp;<span class="op" id="8495438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8495441">crashy</span>&nbsp;<span class="op" id="8495448">=</span>&nbsp;<span class="builtintype" id="8495450">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8495456">defer</span>&nbsp;<span class="keyword" id="8495462">func</span><span class="op" id="8495466">(</span><span class="op" id="8495467">)</span>&nbsp;<span class="op" id="8495469">{</span>&nbsp;<span class="ident" id="8495471">crashy</span>&nbsp;<span class="op" id="8495478">=</span>&nbsp;<span class="builtintype" id="8495480">false</span>&nbsp;<span class="op" id="8495486">}</span><span class="op" id="8495487">(</span><span class="op" id="8495488">)</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8495492">const</span>&nbsp;<span class="ident" id="8495498">N</span>&nbsp;<span class="op" id="8495500">=</span>&nbsp;<span class="num" id="8495502">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8495506">const</span>&nbsp;<span class="ident" id="8495512">M</span>&nbsp;<span class="op" id="8495514">=</span>&nbsp;<span class="num" id="8495516">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8495521">net</span>&nbsp;<span class="op" id="8495525">:=</span>&nbsp;<span class="string" id="8495528">&#34;unix&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8495536">done</span>&nbsp;<span class="op" id="8495541">:=</span>&nbsp;<span class="builtinfunc" id="8495544">make</span><span class="op" id="8495548">(</span><span class="keyword" id="8495549">chan</span>&nbsp;<span class="builtintype" id="8495554">string</span><span class="op" id="8495560">,</span>&nbsp;<span class="ident" id="8495562">N</span><span class="op" id="8495563">*</span><span class="ident" id="8495564">M</span><span class="op" id="8495565">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8495568">addr</span><span class="op" id="8495572">,</span>&nbsp;<span class="ident" id="8495574">sock</span><span class="op" id="8495578">,</span>&nbsp;<span class="ident" id="8495580">srvWG</span>&nbsp;<span class="op" id="8495586">:=</span>&nbsp;<span class="ident" id="8495589">startServer</span><span class="op" id="8495600">(</span><span class="ident" id="8495601">net</span><span class="op" id="8495604">,</span>&nbsp;<span class="string" id="8495606">&#34;&#34;</span><span class="op" id="8495608">,</span>&nbsp;<span class="ident" id="8495610">done</span><span class="op" id="8495614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8495617">defer</span>&nbsp;<span class="ident" id="8495623">os</span><span class="op" id="8495625">.</span><span class="ident" id="8495626">Remove</span><span class="op" id="8495632">(</span><span class="ident" id="8495633">addr</span><span class="op" id="8495637">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8495641">//&nbsp;count&nbsp;all&nbsp;the&nbsp;messages&nbsp;arriving</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8495677">count</span>&nbsp;<span class="op" id="8495683">:=</span>&nbsp;<span class="builtinfunc" id="8495686">make</span><span class="op" id="8495690">(</span><span class="keyword" id="8495691">chan</span>&nbsp;<span class="builtintype" id="8495696">int</span><span class="op" id="8495699">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8495702">go</span>&nbsp;<span class="keyword" id="8495705">func</span><span class="op" id="8495709">(</span><span class="op" id="8495710">)</span>&nbsp;<span class="op" id="8495712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8495716">ct</span>&nbsp;<span class="op" id="8495719">:=</span>&nbsp;<span class="num" id="8495722">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8495726">for</span>&nbsp;<span class="keyword" id="8495730">range</span>&nbsp;<span class="ident" id="8495736">done</span>&nbsp;<span class="op" id="8495741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8495746">ct</span><span class="op" id="8495748">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8495754">//&nbsp;we&nbsp;are&nbsp;looking&nbsp;for&nbsp;500&nbsp;out&nbsp;of&nbsp;1000&nbsp;events</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8495802">//&nbsp;here&nbsp;because&nbsp;lots&nbsp;of&nbsp;log&nbsp;messages&nbsp;are&nbsp;lost</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8495851">//&nbsp;in&nbsp;buffers&nbsp;(kernel&nbsp;and/or&nbsp;bufio)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8495890">if</span>&nbsp;<span class="ident" id="8495893">ct</span>&nbsp;<span class="op" id="8495896">&gt;</span>&nbsp;<span class="ident" id="8495898">N</span><span class="op" id="8495899">*</span><span class="ident" id="8495900">M</span><span class="op" id="8495901">/</span><span class="num" id="8495902">2</span>&nbsp;<span class="op" id="8495904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8495910">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8495919">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8495923">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8495927">count</span>&nbsp;<span class="op" id="8495933">&lt;-</span>&nbsp;<span class="ident" id="8495936">ct</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8495940">}</span><span class="op" id="8495941">(</span><span class="op" id="8495942">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8495946">var</span>&nbsp;<span class="ident" id="8495950">wg</span>&nbsp;<span class="ident" id="8495953">sync</span><span class="op" id="8495957">.</span><span class="ident" id="8495958">WaitGroup</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8495969">wg</span><span class="op" id="8495971">.</span><span class="ident" id="8495972">Add</span><span class="op" id="8495975">(</span><span class="ident" id="8495976">N</span><span class="op" id="8495977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8495980">for</span>&nbsp;<span class="ident" id="8495984">i</span>&nbsp;<span class="op" id="8495986">:=</span>&nbsp;<span class="num" id="8495989">0</span><span class="op" id="8495990">;</span>&nbsp;<span class="ident" id="8495992">i</span>&nbsp;<span class="op" id="8495994">&lt;</span>&nbsp;<span class="ident" id="8495996">N</span><span class="op" id="8495997">;</span>&nbsp;<span class="ident" id="8495999">i</span><span class="op" id="8496000">++</span>&nbsp;<span class="op" id="8496003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8496007">go</span>&nbsp;<span class="keyword" id="8496010">func</span><span class="op" id="8496014">(</span><span class="op" id="8496015">)</span>&nbsp;<span class="op" id="8496017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8496022">defer</span>&nbsp;<span class="ident" id="8496028">wg</span><span class="op" id="8496030">.</span><span class="ident" id="8496031">Done</span><span class="op" id="8496035">(</span><span class="op" id="8496036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8496041">w</span><span class="op" id="8496042">,</span>&nbsp;<span class="ident" id="8496044">err</span>&nbsp;<span class="op" id="8496048">:=</span>&nbsp;<span class="ident" id="8496051">Dial</span><span class="op" id="8496055">(</span><span class="ident" id="8496056">net</span><span class="op" id="8496059">,</span>&nbsp;<span class="ident" id="8496061">addr</span><span class="op" id="8496065">,</span>&nbsp;<span class="ident" id="8496067">LOG_USER</span><span class="op" id="8496075">|</span><span class="ident" id="8496076">LOG_ERR</span><span class="op" id="8496083">,</span>&nbsp;<span class="string" id="8496085">&#34;tag&#34;</span><span class="op" id="8496090">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8496095">if</span>&nbsp;<span class="ident" id="8496098">err</span>&nbsp;<span class="op" id="8496102">!=</span>&nbsp;<span class="ident" id="8496105">nil</span>&nbsp;<span class="op" id="8496109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8496115">t</span><span class="op" id="8496116">.</span><span class="ident" id="8496117">Fatalf</span><span class="op" id="8496123">(</span><span class="string" id="8496124">&#34;syslog.Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8496150">,</span>&nbsp;<span class="ident" id="8496152">err</span><span class="op" id="8496155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8496160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8496165">defer</span>&nbsp;<span class="ident" id="8496171">w</span><span class="op" id="8496172">.</span><span class="ident" id="8496173">Close</span><span class="op" id="8496178">(</span><span class="op" id="8496179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8496184">for</span>&nbsp;<span class="ident" id="8496188">i</span>&nbsp;<span class="op" id="8496190">:=</span>&nbsp;<span class="num" id="8496193">0</span><span class="op" id="8496194">;</span>&nbsp;<span class="ident" id="8496196">i</span>&nbsp;<span class="op" id="8496198">&lt;</span>&nbsp;<span class="ident" id="8496200">M</span><span class="op" id="8496201">;</span>&nbsp;<span class="ident" id="8496203">i</span><span class="op" id="8496204">++</span>&nbsp;<span class="op" id="8496207">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8496213">err</span>&nbsp;<span class="op" id="8496217">:=</span>&nbsp;<span class="ident" id="8496220">w</span><span class="op" id="8496221">.</span><span class="ident" id="8496222">Info</span><span class="op" id="8496226">(</span><span class="string" id="8496227">&#34;test&#34;</span><span class="op" id="8496233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8496239">if</span>&nbsp;<span class="ident" id="8496242">err</span>&nbsp;<span class="op" id="8496246">!=</span>&nbsp;<span class="ident" id="8496249">nil</span>&nbsp;<span class="op" id="8496253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8496260">t</span><span class="op" id="8496261">.</span><span class="ident" id="8496262">Errorf</span><span class="op" id="8496268">(</span><span class="string" id="8496269">&#34;Info()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8496288">,</span>&nbsp;<span class="ident" id="8496290">err</span><span class="op" id="8496293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8496300">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8496311">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8496316">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8496320">}</span><span class="op" id="8496321">(</span><span class="op" id="8496322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8496325">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8496328">wg</span><span class="op" id="8496330">.</span><span class="ident" id="8496331">Wait</span><span class="op" id="8496335">(</span><span class="op" id="8496336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8496339">sock</span><span class="op" id="8496343">.</span><span class="ident" id="8496344">Close</span><span class="op" id="8496349">(</span><span class="op" id="8496350">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8496353">srvWG</span><span class="op" id="8496358">.</span><span class="ident" id="8496359">Wait</span><span class="op" id="8496363">(</span><span class="op" id="8496364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8496367">close</span><span class="op" id="8496372">(</span><span class="ident" id="8496373">done</span><span class="op" id="8496377">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8496381">select</span>&nbsp;<span class="op" id="8496388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8496391">case</span>&nbsp;<span class="op" id="8496396">&lt;-</span><span class="ident" id="8496398">count</span><span class="op" id="8496403">:</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8496406">case</span>&nbsp;<span class="op" id="8496411">&lt;-</span><span class="ident" id="8496413">time</span><span class="op" id="8496417">.</span><span class="ident" id="8496418">After</span><span class="op" id="8496423">(</span><span class="num" id="8496424">100</span>&nbsp;<span class="op" id="8496428">*</span>&nbsp;<span class="ident" id="8496430">time</span><span class="op" id="8496434">.</span><span class="ident" id="8496435">Millisecond</span><span class="op" id="8496446">)</span><span class="op" id="8496447">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8496451">t</span><span class="op" id="8496452">.</span><span class="ident" id="8496453">Error</span><span class="op" id="8496458">(</span><span class="string" id="8496459">&#34;timeout&nbsp;in&nbsp;concurrent&nbsp;reconnect&#34;</span><span class="op" id="8496492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8496495">}</span><br>
<span class="lineno"></span><span class="op" id="8496497">}</span>
</div>
</body>
</html>
