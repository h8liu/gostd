<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>lonnie.io/e8vm/arch8</h2>
<ul>
<li><a href="/gostd/lonnie.io/e8vm/arch8/console.go.html">console.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/cpu.go.html">cpu.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/cpu_test.go.html">cpu_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/device.go.html">device.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/exception.go.html">exception.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_all.go.html">inst_all.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_br.go.html">inst_br.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_br_test.go.html">inst_br_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_imm.go.html">inst_imm.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_imm_test.go.html">inst_imm_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_jmp.go.html">inst_jmp.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_reg.go.html">inst_reg.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_reg_test.go.html">inst_reg_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_sys.go.html">inst_sys.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/int_bus.go.html">int_bus.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/interrupt.go.html">interrupt.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/interrupt_test.go.html">interrupt_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/machine.go.html">machine.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/multi_core.go.html">multi_core.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/page.go.html">page.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/page_table.go.html">page_table.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/page_table_test.go.html">page_table_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/page_test.go.html">page_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/phy_memory.go.html">phy_memory.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/phy_memory_test.go.html">phy_memory_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/regs.go.html">regs.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/regs_test.go.html">regs_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/run_image.go.html">run_image.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/serial.go.html">serial.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/ticker.go.html">ticker.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/virt_memory.go.html">virt_memory.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/virt_memory_test.go.html">virt_memory_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="keyword" id="4784747">package</span>&nbsp;<span class="ident" id="4784755">arch8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4784762">//&nbsp;InstImm&nbsp;executes&nbsp;immediate&nbsp;instructions</span><br>
<span class="lineno"></span><span class="keyword" id="4784805">type</span>&nbsp;<span class="ident" id="4784810">instImm</span>&nbsp;<span class="keyword" id="4784818">struct</span><span class="op" id="4784824">{</span><span class="op" id="4784825">}</span><br>
<span class="lineno">5</span><br>
<span class="lineno"></span><span class="comment" id="4784828">//&nbsp;I&nbsp;executes&nbsp;the&nbsp;instruction.</span><br>
<span class="lineno"></span><span class="comment" id="4784859">//&nbsp;Might&nbsp;return&nbsp;invalid&nbsp;instruction&nbsp;exception,</span><br>
<span class="lineno"></span><span class="comment" id="4784906">//&nbsp;or&nbsp;memory&nbsp;related&nbsp;exceptions.</span><br>
<span class="lineno"></span><span class="keyword" id="4784939">func</span>&nbsp;<span class="op" id="4784944">(</span><span class="ident" id="4784945">i</span>&nbsp;<span class="op" id="4784947">*</span><span class="ident" id="4784948">instImm</span><span class="op" id="4784955">)</span>&nbsp;<span class="ident" id="4784957">I</span><span class="op" id="4784958">(</span><span class="ident" id="4784959">cpu</span>&nbsp;<span class="op" id="4784963">*</span><span class="ident" id="4784964">cpu</span><span class="op" id="4784967">,</span>&nbsp;<span class="ident" id="4784969">in</span>&nbsp;<span class="builtintype" id="4784972">uint32</span><span class="op" id="4784978">)</span>&nbsp;<span class="op" id="4784980">*</span><span class="ident" id="4784981">Excep</span>&nbsp;<span class="op" id="4784987">{</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4784990">op</span>&nbsp;<span class="op" id="4784993">:=</span>&nbsp;<span class="op" id="4784996">(</span><span class="ident" id="4784997">in</span>&nbsp;<span class="op" id="4785000">&gt;&gt;</span>&nbsp;<span class="num" id="4785003">24</span><span class="op" id="4785005">)</span>&nbsp;<span class="op" id="4785007">&amp;</span>&nbsp;<span class="num" id="4785009">0xff</span>&nbsp;&nbsp;<span class="comment" id="4785015">//&nbsp;(32:24]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4785027">dest</span>&nbsp;<span class="op" id="4785032">:=</span>&nbsp;<span class="op" id="4785035">(</span><span class="ident" id="4785036">in</span>&nbsp;<span class="op" id="4785039">&gt;&gt;</span>&nbsp;<span class="num" id="4785042">21</span><span class="op" id="4785044">)</span>&nbsp;<span class="op" id="4785046">&amp;</span>&nbsp;<span class="num" id="4785048">0x7</span>&nbsp;<span class="comment" id="4785052">//&nbsp;(24:21]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4785064">src</span>&nbsp;<span class="op" id="4785068">:=</span>&nbsp;<span class="op" id="4785071">(</span><span class="ident" id="4785072">in</span>&nbsp;<span class="op" id="4785075">&gt;&gt;</span>&nbsp;<span class="num" id="4785078">18</span><span class="op" id="4785080">)</span>&nbsp;<span class="op" id="4785082">&amp;</span>&nbsp;<span class="num" id="4785084">0x7</span>&nbsp;&nbsp;<span class="comment" id="4785089">//&nbsp;(21:18]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4785101">im</span>&nbsp;<span class="op" id="4785104">:=</span>&nbsp;<span class="ident" id="4785107">in</span>&nbsp;<span class="op" id="4785110">&amp;</span>&nbsp;<span class="num" id="4785112">0xffff</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4785126">//&nbsp;(16:0]</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4785138">s</span>&nbsp;<span class="op" id="4785140">:=</span>&nbsp;<span class="ident" id="4785143">cpu</span><span class="op" id="4785146">.</span><span class="ident" id="4785147">regs</span><span class="op" id="4785151">[</span><span class="ident" id="4785152">src</span><span class="op" id="4785155">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4785158">d</span>&nbsp;<span class="op" id="4785160">:=</span>&nbsp;<span class="ident" id="4785163">cpu</span><span class="op" id="4785166">.</span><span class="ident" id="4785167">regs</span><span class="op" id="4785171">[</span><span class="ident" id="4785172">dest</span><span class="op" id="4785176">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4785179">ims</span>&nbsp;<span class="op" id="4785183">:=</span>&nbsp;<span class="builtintype" id="4785186">uint32</span><span class="op" id="4785192">(</span><span class="builtintype" id="4785193">int32</span><span class="op" id="4785198">(</span><span class="ident" id="4785199">im</span><span class="op" id="4785201">&lt;&lt;</span><span class="num" id="4785203">16</span><span class="op" id="4785205">)</span>&nbsp;<span class="op" id="4785207">&gt;&gt;</span>&nbsp;<span class="num" id="4785210">16</span><span class="op" id="4785212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4785215">addr</span>&nbsp;<span class="op" id="4785220">:=</span>&nbsp;<span class="ident" id="4785223">s</span>&nbsp;<span class="op" id="4785225">+</span>&nbsp;<span class="ident" id="4785227">ims</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4785232">var</span>&nbsp;<span class="ident" id="4785236">e</span>&nbsp;<span class="op" id="4785238">*</span><span class="ident" id="4785239">Excep</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4785246">var</span>&nbsp;<span class="ident" id="4785250">b</span>&nbsp;<span class="builtintype" id="4785252">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4785259">switch</span>&nbsp;<span class="ident" id="4785266">op</span>&nbsp;<span class="op" id="4785269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4785272">case</span>&nbsp;<span class="num" id="4785277">0</span><span class="op" id="4785278">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4785282">panic</span><span class="op" id="4785287">(</span><span class="string" id="4785288">&#34;register&nbsp;based&nbsp;instruction&#34;</span><span class="op" id="4785316">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4785319">case</span>&nbsp;<span class="num" id="4785324">1</span><span class="op" id="4785325">:</span>&nbsp;<span class="comment" id="4785327">//&nbsp;addi</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4785337">d</span>&nbsp;<span class="op" id="4785339">=</span>&nbsp;<span class="ident" id="4785341">s</span>&nbsp;<span class="op" id="4785343">+</span>&nbsp;<span class="ident" id="4785345">ims</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4785350">case</span>&nbsp;<span class="num" id="4785355">2</span><span class="op" id="4785356">:</span>&nbsp;<span class="comment" id="4785358">//&nbsp;slti</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4785368">if</span>&nbsp;<span class="builtintype" id="4785371">int32</span><span class="op" id="4785376">(</span><span class="ident" id="4785377">s</span><span class="op" id="4785378">)</span>&nbsp;<span class="op" id="4785380">&lt;</span>&nbsp;<span class="builtintype" id="4785382">int32</span><span class="op" id="4785387">(</span><span class="ident" id="4785388">ims</span><span class="op" id="4785391">)</span>&nbsp;<span class="op" id="4785393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4785398">d</span>&nbsp;<span class="op" id="4785400">=</span>&nbsp;<span class="num" id="4785402">1</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4785406">}</span>&nbsp;<span class="keyword" id="4785408">else</span>&nbsp;<span class="op" id="4785413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4785418">d</span>&nbsp;<span class="op" id="4785420">=</span>&nbsp;<span class="num" id="4785422">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4785426">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4785429">case</span>&nbsp;<span class="num" id="4785434">3</span><span class="op" id="4785435">:</span>&nbsp;<span class="comment" id="4785437">//&nbsp;andi</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4785447">d</span>&nbsp;<span class="op" id="4785449">=</span>&nbsp;<span class="ident" id="4785451">s</span>&nbsp;<span class="op" id="4785453">&amp;</span>&nbsp;<span class="ident" id="4785455">im</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4785459">case</span>&nbsp;<span class="num" id="4785464">4</span><span class="op" id="4785465">:</span>&nbsp;<span class="comment" id="4785467">//&nbsp;ori</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4785476">d</span>&nbsp;<span class="op" id="4785478">=</span>&nbsp;<span class="ident" id="4785480">s</span>&nbsp;<span class="op" id="4785482">|</span>&nbsp;<span class="ident" id="4785484">im</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4785488">case</span>&nbsp;<span class="num" id="4785493">5</span><span class="op" id="4785494">:</span>&nbsp;<span class="comment" id="4785496">//&nbsp;lui</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4785505">d</span>&nbsp;<span class="op" id="4785507">=</span>&nbsp;<span class="ident" id="4785509">im</span>&nbsp;<span class="op" id="4785512">&lt;&lt;</span>&nbsp;<span class="num" id="4785515">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4785519">case</span>&nbsp;<span class="num" id="4785524">6</span><span class="op" id="4785525">:</span>&nbsp;<span class="comment" id="4785527">//&nbsp;lw</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4785535">d</span><span class="op" id="4785536">,</span>&nbsp;<span class="ident" id="4785538">e</span>&nbsp;<span class="op" id="4785540">=</span>&nbsp;<span class="ident" id="4785542">cpu</span><span class="op" id="4785545">.</span><span class="ident" id="4785546">readWord</span><span class="op" id="4785554">(</span><span class="ident" id="4785555">addr</span><span class="op" id="4785559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4785562">case</span>&nbsp;<span class="num" id="4785567">7</span><span class="op" id="4785568">:</span>&nbsp;<span class="comment" id="4785570">//&nbsp;lb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4785578">b</span><span class="op" id="4785579">,</span>&nbsp;<span class="ident" id="4785581">e</span>&nbsp;<span class="op" id="4785583">=</span>&nbsp;<span class="ident" id="4785585">cpu</span><span class="op" id="4785588">.</span><span class="ident" id="4785589">readByte</span><span class="op" id="4785597">(</span><span class="ident" id="4785598">addr</span><span class="op" id="4785602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4785606">d</span>&nbsp;<span class="op" id="4785608">=</span>&nbsp;<span class="builtintype" id="4785610">uint32</span><span class="op" id="4785616">(</span><span class="builtintype" id="4785617">int32</span><span class="op" id="4785622">(</span><span class="builtintype" id="4785623">int8</span><span class="op" id="4785627">(</span><span class="ident" id="4785628">b</span><span class="op" id="4785629">)</span><span class="op" id="4785630">)</span><span class="op" id="4785631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4785634">case</span>&nbsp;<span class="num" id="4785639">8</span><span class="op" id="4785640">:</span>&nbsp;<span class="comment" id="4785642">//&nbsp;lbu</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4785651">b</span><span class="op" id="4785652">,</span>&nbsp;<span class="ident" id="4785654">e</span>&nbsp;<span class="op" id="4785656">=</span>&nbsp;<span class="ident" id="4785658">cpu</span><span class="op" id="4785661">.</span><span class="ident" id="4785662">readByte</span><span class="op" id="4785670">(</span><span class="ident" id="4785671">addr</span><span class="op" id="4785675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4785679">d</span>&nbsp;<span class="op" id="4785681">=</span>&nbsp;<span class="builtintype" id="4785683">uint32</span><span class="op" id="4785689">(</span><span class="ident" id="4785690">b</span><span class="op" id="4785691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4785694">case</span>&nbsp;<span class="num" id="4785699">9</span><span class="op" id="4785700">:</span>&nbsp;<span class="comment" id="4785702">//&nbsp;sw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4785710">e</span>&nbsp;<span class="op" id="4785712">=</span>&nbsp;<span class="ident" id="4785714">cpu</span><span class="op" id="4785717">.</span><span class="ident" id="4785718">writeWord</span><span class="op" id="4785727">(</span><span class="ident" id="4785728">addr</span><span class="op" id="4785732">,</span>&nbsp;<span class="ident" id="4785734">d</span><span class="op" id="4785735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4785738">case</span>&nbsp;<span class="num" id="4785743">10</span><span class="op" id="4785745">:</span>&nbsp;<span class="comment" id="4785747">//&nbsp;sb</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4785755">e</span>&nbsp;<span class="op" id="4785757">=</span>&nbsp;<span class="ident" id="4785759">cpu</span><span class="op" id="4785762">.</span><span class="ident" id="4785763">writeByte</span><span class="op" id="4785772">(</span><span class="ident" id="4785773">addr</span><span class="op" id="4785777">,</span>&nbsp;<span class="builtintype" id="4785779">byte</span><span class="op" id="4785783">(</span><span class="ident" id="4785784">d</span><span class="op" id="4785785">)</span><span class="op" id="4785786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4785789">default</span><span class="op" id="4785796">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4785800">return</span>&nbsp;<span class="ident" id="4785807">errInvalidInst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4785823">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4785827">if</span>&nbsp;<span class="ident" id="4785830">e</span>&nbsp;<span class="op" id="4785832">!=</span>&nbsp;<span class="ident" id="4785835">nil</span>&nbsp;<span class="op" id="4785839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4785843">return</span>&nbsp;<span class="ident" id="4785850">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4785853">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4785857">cpu</span><span class="op" id="4785860">.</span><span class="ident" id="4785861">regs</span><span class="op" id="4785865">[</span><span class="ident" id="4785866">dest</span><span class="op" id="4785870">]</span>&nbsp;<span class="op" id="4785872">=</span>&nbsp;<span class="ident" id="4785874">d</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4785877">return</span>&nbsp;<span class="ident" id="4785884">nil</span><br>
<span class="lineno"></span><span class="op" id="4785888">}</span>
</div>
</body>
</html>
