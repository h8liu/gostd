<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="2720565">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2720620">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2720674">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="2720725">package</span>&nbsp;<span class="ident" id="2720733">strings</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2720742">import</span>&nbsp;<span class="string" id="2720749">&#34;io&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2720755">//&nbsp;Replacer&nbsp;replaces&nbsp;a&nbsp;list&nbsp;of&nbsp;strings&nbsp;with&nbsp;replacements.</span><br>
<span class="lineno">10</span><span class="comment" id="2720813">//&nbsp;It&nbsp;is&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="2720870">type</span>&nbsp;<span class="ident" id="2720875">Replacer</span>&nbsp;<span class="keyword" id="2720884">struct</span>&nbsp;<span class="op" id="2720891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2720894">r</span>&nbsp;<span class="ident" id="2720896">replacer</span><br>
<span class="lineno"></span><span class="op" id="2720905">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="2720908">//&nbsp;replacer&nbsp;is&nbsp;the&nbsp;interface&nbsp;that&nbsp;a&nbsp;replacement&nbsp;algorithm&nbsp;needs&nbsp;to&nbsp;implement.</span><br>
<span class="lineno"></span><span class="keyword" id="2720986">type</span>&nbsp;<span class="ident" id="2720991">replacer</span>&nbsp;<span class="keyword" id="2721000">interface</span>&nbsp;<span class="op" id="2721010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2721013">Replace</span><span class="op" id="2721020">(</span><span class="ident" id="2721021">s</span>&nbsp;<span class="builtintype" id="2721023">string</span><span class="op" id="2721029">)</span>&nbsp;<span class="builtintype" id="2721031">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2721039">WriteString</span><span class="op" id="2721050">(</span><span class="ident" id="2721051">w</span>&nbsp;<span class="ident" id="2721053">io</span><span class="op" id="2721055">.</span><span class="ident" id="2721056">Writer</span><span class="op" id="2721062">,</span>&nbsp;<span class="ident" id="2721064">s</span>&nbsp;<span class="builtintype" id="2721066">string</span><span class="op" id="2721072">)</span>&nbsp;<span class="op" id="2721074">(</span><span class="ident" id="2721075">n</span>&nbsp;<span class="builtintype" id="2721077">int</span><span class="op" id="2721080">,</span>&nbsp;<span class="ident" id="2721082">err</span>&nbsp;<span class="builtintype" id="2721086">error</span><span class="op" id="2721091">)</span><br>
<span class="lineno"></span><span class="op" id="2721093">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="2721096">//&nbsp;NewReplacer&nbsp;returns&nbsp;a&nbsp;new&nbsp;Replacer&nbsp;from&nbsp;a&nbsp;list&nbsp;of&nbsp;old,&nbsp;new&nbsp;string&nbsp;pairs.</span><br>
<span class="lineno"></span><span class="comment" id="2721172">//&nbsp;Replacements&nbsp;are&nbsp;performed&nbsp;in&nbsp;order,&nbsp;without&nbsp;overlapping&nbsp;matches.</span><br>
<span class="lineno"></span><span class="keyword" id="2721241">func</span>&nbsp;<span class="ident" id="2721246">NewReplacer</span><span class="op" id="2721257">(</span><span class="ident" id="2721258">oldnew</span>&nbsp;<span class="op" id="2721265">...</span><span class="builtintype" id="2721268">string</span><span class="op" id="2721274">)</span>&nbsp;<span class="op" id="2721276">*</span><span class="ident" id="2721277">Replacer</span>&nbsp;<span class="op" id="2721286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2721289">if</span>&nbsp;<span class="builtinfunc" id="2721292">len</span><span class="op" id="2721295">(</span><span class="ident" id="2721296">oldnew</span><span class="op" id="2721302">)</span><span class="op" id="2721303">%</span><span class="num" id="2721304">2</span>&nbsp;<span class="op" id="2721306">==</span>&nbsp;<span class="num" id="2721309">1</span>&nbsp;<span class="op" id="2721311">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2721315">panic</span><span class="op" id="2721320">(</span><span class="string" id="2721321">&#34;strings.NewReplacer:&nbsp;odd&nbsp;argument&nbsp;count&#34;</span><span class="op" id="2721362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2721365">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2721369">if</span>&nbsp;<span class="builtinfunc" id="2721372">len</span><span class="op" id="2721375">(</span><span class="ident" id="2721376">oldnew</span><span class="op" id="2721382">)</span>&nbsp;<span class="op" id="2721384">==</span>&nbsp;<span class="num" id="2721387">2</span>&nbsp;<span class="op" id="2721389">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="2721392">len</span><span class="op" id="2721395">(</span><span class="ident" id="2721396">oldnew</span><span class="op" id="2721402">[</span><span class="num" id="2721403">0</span><span class="op" id="2721404">]</span><span class="op" id="2721405">)</span>&nbsp;<span class="op" id="2721407">&gt;</span>&nbsp;<span class="num" id="2721409">1</span>&nbsp;<span class="op" id="2721411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2721415">return</span>&nbsp;<span class="op" id="2721422">&amp;</span><span class="ident" id="2721423">Replacer</span><span class="op" id="2721431">{</span><span class="ident" id="2721432">r</span><span class="op" id="2721433">:</span>&nbsp;<span class="ident" id="2721435">makeSingleStringReplacer</span><span class="op" id="2721459">(</span><span class="ident" id="2721460">oldnew</span><span class="op" id="2721466">[</span><span class="num" id="2721467">0</span><span class="op" id="2721468">]</span><span class="op" id="2721469">,</span>&nbsp;<span class="ident" id="2721471">oldnew</span><span class="op" id="2721477">[</span><span class="num" id="2721478">1</span><span class="op" id="2721479">]</span><span class="op" id="2721480">)</span><span class="op" id="2721481">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2721484">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2721488">allNewBytes</span>&nbsp;<span class="op" id="2721500">:=</span>&nbsp;<span class="ident" id="2721503">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2721509">for</span>&nbsp;<span class="ident" id="2721513">i</span>&nbsp;<span class="op" id="2721515">:=</span>&nbsp;<span class="num" id="2721518">0</span><span class="op" id="2721519">;</span>&nbsp;<span class="ident" id="2721521">i</span>&nbsp;<span class="op" id="2721523">&lt;</span>&nbsp;<span class="builtinfunc" id="2721525">len</span><span class="op" id="2721528">(</span><span class="ident" id="2721529">oldnew</span><span class="op" id="2721535">)</span><span class="op" id="2721536">;</span>&nbsp;<span class="ident" id="2721538">i</span>&nbsp;<span class="op" id="2721540">+=</span>&nbsp;<span class="num" id="2721543">2</span>&nbsp;<span class="op" id="2721545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2721549">if</span>&nbsp;<span class="builtinfunc" id="2721552">len</span><span class="op" id="2721555">(</span><span class="ident" id="2721556">oldnew</span><span class="op" id="2721562">[</span><span class="ident" id="2721563">i</span><span class="op" id="2721564">]</span><span class="op" id="2721565">)</span>&nbsp;<span class="op" id="2721567">!=</span>&nbsp;<span class="num" id="2721570">1</span>&nbsp;<span class="op" id="2721572">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2721577">return</span>&nbsp;<span class="op" id="2721584">&amp;</span><span class="ident" id="2721585">Replacer</span><span class="op" id="2721593">{</span><span class="ident" id="2721594">r</span><span class="op" id="2721595">:</span>&nbsp;<span class="ident" id="2721597">makeGenericReplacer</span><span class="op" id="2721616">(</span><span class="ident" id="2721617">oldnew</span><span class="op" id="2721623">)</span><span class="op" id="2721624">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2721628">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2721632">if</span>&nbsp;<span class="builtinfunc" id="2721635">len</span><span class="op" id="2721638">(</span><span class="ident" id="2721639">oldnew</span><span class="op" id="2721645">[</span><span class="ident" id="2721646">i</span><span class="op" id="2721647">+</span><span class="num" id="2721648">1</span><span class="op" id="2721649">]</span><span class="op" id="2721650">)</span>&nbsp;<span class="op" id="2721652">!=</span>&nbsp;<span class="num" id="2721655">1</span>&nbsp;<span class="op" id="2721657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2721662">allNewBytes</span>&nbsp;<span class="op" id="2721674">=</span>&nbsp;<span class="ident" id="2721676">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2721684">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2721687">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2721691">if</span>&nbsp;<span class="ident" id="2721694">allNewBytes</span>&nbsp;<span class="op" id="2721706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2721710">r</span>&nbsp;<span class="op" id="2721712">:=</span>&nbsp;<span class="ident" id="2721715">byteReplacer</span><span class="op" id="2721727">{</span><span class="op" id="2721728">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2721732">for</span>&nbsp;<span class="ident" id="2721736">i</span>&nbsp;<span class="op" id="2721738">:=</span>&nbsp;<span class="keyword" id="2721741">range</span>&nbsp;<span class="ident" id="2721747">r</span>&nbsp;<span class="op" id="2721749">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2721754">r</span><span class="op" id="2721755">[</span><span class="ident" id="2721756">i</span><span class="op" id="2721757">]</span>&nbsp;<span class="op" id="2721759">=</span>&nbsp;<span class="builtintype" id="2721761">byte</span><span class="op" id="2721765">(</span><span class="ident" id="2721766">i</span><span class="op" id="2721767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2721771">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2721775">//&nbsp;The&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;old-&gt;new&nbsp;map&nbsp;takes&nbsp;precedence</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2721834">//&nbsp;over&nbsp;the&nbsp;others&nbsp;with&nbsp;the&nbsp;same&nbsp;old&nbsp;string.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2721881">for</span>&nbsp;<span class="ident" id="2721885">i</span>&nbsp;<span class="op" id="2721887">:=</span>&nbsp;<span class="builtinfunc" id="2721890">len</span><span class="op" id="2721893">(</span><span class="ident" id="2721894">oldnew</span><span class="op" id="2721900">)</span>&nbsp;<span class="op" id="2721902">-</span>&nbsp;<span class="num" id="2721904">2</span><span class="op" id="2721905">;</span>&nbsp;<span class="ident" id="2721907">i</span>&nbsp;<span class="op" id="2721909">&gt;=</span>&nbsp;<span class="num" id="2721912">0</span><span class="op" id="2721913">;</span>&nbsp;<span class="ident" id="2721915">i</span>&nbsp;<span class="op" id="2721917">-=</span>&nbsp;<span class="num" id="2721920">2</span>&nbsp;<span class="op" id="2721922">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2721927">o</span>&nbsp;<span class="op" id="2721929">:=</span>&nbsp;<span class="ident" id="2721932">oldnew</span><span class="op" id="2721938">[</span><span class="ident" id="2721939">i</span><span class="op" id="2721940">]</span><span class="op" id="2721941">[</span><span class="num" id="2721942">0</span><span class="op" id="2721943">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2721948">n</span>&nbsp;<span class="op" id="2721950">:=</span>&nbsp;<span class="ident" id="2721953">oldnew</span><span class="op" id="2721959">[</span><span class="ident" id="2721960">i</span><span class="op" id="2721961">+</span><span class="num" id="2721962">1</span><span class="op" id="2721963">]</span><span class="op" id="2721964">[</span><span class="num" id="2721965">0</span><span class="op" id="2721966">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2721971">r</span><span class="op" id="2721972">[</span><span class="ident" id="2721973">o</span><span class="op" id="2721974">]</span>&nbsp;<span class="op" id="2721976">=</span>&nbsp;<span class="ident" id="2721978">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2721982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2721986">return</span>&nbsp;<span class="op" id="2721993">&amp;</span><span class="ident" id="2721994">Replacer</span><span class="op" id="2722002">{</span><span class="ident" id="2722003">r</span><span class="op" id="2722004">:</span>&nbsp;<span class="op" id="2722006">&amp;</span><span class="ident" id="2722007">r</span><span class="op" id="2722008">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2722011">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2722015">r</span>&nbsp;<span class="op" id="2722017">:=</span>&nbsp;<span class="ident" id="2722020">byteStringReplacer</span><span class="op" id="2722038">{</span><span class="op" id="2722039">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2722042">//&nbsp;The&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;old-&gt;new&nbsp;map&nbsp;takes&nbsp;precedence</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2722100">//&nbsp;over&nbsp;the&nbsp;others&nbsp;with&nbsp;the&nbsp;same&nbsp;old&nbsp;string.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2722146">for</span>&nbsp;<span class="ident" id="2722150">i</span>&nbsp;<span class="op" id="2722152">:=</span>&nbsp;<span class="builtinfunc" id="2722155">len</span><span class="op" id="2722158">(</span><span class="ident" id="2722159">oldnew</span><span class="op" id="2722165">)</span>&nbsp;<span class="op" id="2722167">-</span>&nbsp;<span class="num" id="2722169">2</span><span class="op" id="2722170">;</span>&nbsp;<span class="ident" id="2722172">i</span>&nbsp;<span class="op" id="2722174">&gt;=</span>&nbsp;<span class="num" id="2722177">0</span><span class="op" id="2722178">;</span>&nbsp;<span class="ident" id="2722180">i</span>&nbsp;<span class="op" id="2722182">-=</span>&nbsp;<span class="num" id="2722185">2</span>&nbsp;<span class="op" id="2722187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2722191">o</span>&nbsp;<span class="op" id="2722193">:=</span>&nbsp;<span class="ident" id="2722196">oldnew</span><span class="op" id="2722202">[</span><span class="ident" id="2722203">i</span><span class="op" id="2722204">]</span><span class="op" id="2722205">[</span><span class="num" id="2722206">0</span><span class="op" id="2722207">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2722211">n</span>&nbsp;<span class="op" id="2722213">:=</span>&nbsp;<span class="ident" id="2722216">oldnew</span><span class="op" id="2722222">[</span><span class="ident" id="2722223">i</span><span class="op" id="2722224">+</span><span class="num" id="2722225">1</span><span class="op" id="2722226">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2722230">r</span><span class="op" id="2722231">[</span><span class="ident" id="2722232">o</span><span class="op" id="2722233">]</span>&nbsp;<span class="op" id="2722235">=</span>&nbsp;<span class="op" id="2722237">[</span><span class="op" id="2722238">]</span><span class="builtintype" id="2722239">byte</span><span class="op" id="2722243">(</span><span class="ident" id="2722244">n</span><span class="op" id="2722245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2722248">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2722251">return</span>&nbsp;<span class="op" id="2722258">&amp;</span><span class="ident" id="2722259">Replacer</span><span class="op" id="2722267">{</span><span class="ident" id="2722268">r</span><span class="op" id="2722269">:</span>&nbsp;<span class="op" id="2722271">&amp;</span><span class="ident" id="2722272">r</span><span class="op" id="2722273">}</span><br>
<span class="lineno"></span><span class="op" id="2722275">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2722278">//&nbsp;Replace&nbsp;returns&nbsp;a&nbsp;copy&nbsp;of&nbsp;s&nbsp;with&nbsp;all&nbsp;replacements&nbsp;performed.</span><br>
<span class="lineno"></span><span class="keyword" id="2722342">func</span>&nbsp;<span class="op" id="2722347">(</span><span class="ident" id="2722348">r</span>&nbsp;<span class="op" id="2722350">*</span><span class="ident" id="2722351">Replacer</span><span class="op" id="2722359">)</span>&nbsp;<span class="ident" id="2722361">Replace</span><span class="op" id="2722368">(</span><span class="ident" id="2722369">s</span>&nbsp;<span class="builtintype" id="2722371">string</span><span class="op" id="2722377">)</span>&nbsp;<span class="builtintype" id="2722379">string</span>&nbsp;<span class="op" id="2722386">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2722389">return</span>&nbsp;<span class="ident" id="2722396">r</span><span class="op" id="2722397">.</span><span class="ident" id="2722398">r</span><span class="op" id="2722399">.</span><span class="ident" id="2722400">Replace</span><span class="op" id="2722407">(</span><span class="ident" id="2722408">s</span><span class="op" id="2722409">)</span><br>
<span class="lineno"></span><span class="op" id="2722411">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2722414">//&nbsp;WriteString&nbsp;writes&nbsp;s&nbsp;to&nbsp;w&nbsp;with&nbsp;all&nbsp;replacements&nbsp;performed.</span><br>
<span class="lineno"></span><span class="keyword" id="2722476">func</span>&nbsp;<span class="op" id="2722481">(</span><span class="ident" id="2722482">r</span>&nbsp;<span class="op" id="2722484">*</span><span class="ident" id="2722485">Replacer</span><span class="op" id="2722493">)</span>&nbsp;<span class="ident" id="2722495">WriteString</span><span class="op" id="2722506">(</span><span class="ident" id="2722507">w</span>&nbsp;<span class="ident" id="2722509">io</span><span class="op" id="2722511">.</span><span class="ident" id="2722512">Writer</span><span class="op" id="2722518">,</span>&nbsp;<span class="ident" id="2722520">s</span>&nbsp;<span class="builtintype" id="2722522">string</span><span class="op" id="2722528">)</span>&nbsp;<span class="op" id="2722530">(</span><span class="ident" id="2722531">n</span>&nbsp;<span class="builtintype" id="2722533">int</span><span class="op" id="2722536">,</span>&nbsp;<span class="ident" id="2722538">err</span>&nbsp;<span class="builtintype" id="2722542">error</span><span class="op" id="2722547">)</span>&nbsp;<span class="op" id="2722549">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2722552">return</span>&nbsp;<span class="ident" id="2722559">r</span><span class="op" id="2722560">.</span><span class="ident" id="2722561">r</span><span class="op" id="2722562">.</span><span class="ident" id="2722563">WriteString</span><span class="op" id="2722574">(</span><span class="ident" id="2722575">w</span><span class="op" id="2722576">,</span>&nbsp;<span class="ident" id="2722578">s</span><span class="op" id="2722579">)</span><br>
<span class="lineno"></span><span class="op" id="2722581">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2722584">//&nbsp;trieNode&nbsp;is&nbsp;a&nbsp;node&nbsp;in&nbsp;a&nbsp;lookup&nbsp;trie&nbsp;for&nbsp;prioritized&nbsp;key/value&nbsp;pairs.&nbsp;Keys</span><br>
<span class="lineno"></span><span class="comment" id="2722661">//&nbsp;and&nbsp;values&nbsp;may&nbsp;be&nbsp;empty.&nbsp;For&nbsp;example,&nbsp;the&nbsp;trie&nbsp;containing&nbsp;keys&nbsp;&#34;ax&#34;,&nbsp;&#34;ay&#34;,</span><br>
<span class="lineno">80</span><span class="comment" id="2722739">//&nbsp;&#34;bcbc&#34;,&nbsp;&#34;x&#34;&nbsp;and&nbsp;&#34;xy&#34;&nbsp;could&nbsp;have&nbsp;eight&nbsp;nodes:</span><br>
<span class="lineno"></span><span class="comment" id="2722787">//</span><br>
<span class="lineno"></span><span class="comment" id="2722790">//&nbsp;&nbsp;n0&nbsp;&nbsp;-</span><br>
<span class="lineno"></span><span class="comment" id="2722800">//&nbsp;&nbsp;n1&nbsp;&nbsp;a-</span><br>
<span class="lineno"></span><span class="comment" id="2722811">//&nbsp;&nbsp;n2&nbsp;&nbsp;.x+</span><br>
<span class="lineno">85</span><span class="comment" id="2722823">//&nbsp;&nbsp;n3&nbsp;&nbsp;.y+</span><br>
<span class="lineno"></span><span class="comment" id="2722835">//&nbsp;&nbsp;n4&nbsp;&nbsp;b-</span><br>
<span class="lineno"></span><span class="comment" id="2722846">//&nbsp;&nbsp;n5&nbsp;&nbsp;.cbc+</span><br>
<span class="lineno"></span><span class="comment" id="2722860">//&nbsp;&nbsp;n6&nbsp;&nbsp;x+</span><br>
<span class="lineno"></span><span class="comment" id="2722871">//&nbsp;&nbsp;n7&nbsp;&nbsp;.y+</span><br>
<span class="lineno">90</span><span class="comment" id="2722883">//</span><br>
<span class="lineno"></span><span class="comment" id="2722886">//&nbsp;n0&nbsp;is&nbsp;the&nbsp;root&nbsp;node,&nbsp;and&nbsp;its&nbsp;children&nbsp;are&nbsp;n1,&nbsp;n4&nbsp;and&nbsp;n6;&nbsp;n1&#39;s&nbsp;children&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="2722964">//&nbsp;n2&nbsp;and&nbsp;n3;&nbsp;n4&#39;s&nbsp;child&nbsp;is&nbsp;n5;&nbsp;n6&#39;s&nbsp;child&nbsp;is&nbsp;n7.&nbsp;Nodes&nbsp;n0,&nbsp;n1&nbsp;and&nbsp;n4&nbsp;(marked</span><br>
<span class="lineno"></span><span class="comment" id="2723042">//&nbsp;with&nbsp;a&nbsp;trailing&nbsp;&#34;-&#34;)&nbsp;are&nbsp;partial&nbsp;keys,&nbsp;and&nbsp;nodes&nbsp;n2,&nbsp;n3,&nbsp;n5,&nbsp;n6&nbsp;and&nbsp;n7</span><br>
<span class="lineno"></span><span class="comment" id="2723116">//&nbsp;(marked&nbsp;with&nbsp;a&nbsp;trailing&nbsp;&#34;+&#34;)&nbsp;are&nbsp;complete&nbsp;keys.</span><br>
<span class="lineno">95</span><span class="keyword" id="2723167">type</span>&nbsp;<span class="ident" id="2723172">trieNode</span>&nbsp;<span class="keyword" id="2723181">struct</span>&nbsp;<span class="op" id="2723188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2723191">//&nbsp;value&nbsp;is&nbsp;the&nbsp;value&nbsp;of&nbsp;the&nbsp;trie&nbsp;node&#39;s&nbsp;key/value&nbsp;pair.&nbsp;It&nbsp;is&nbsp;empty&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2723264">//&nbsp;this&nbsp;node&nbsp;is&nbsp;not&nbsp;a&nbsp;complete&nbsp;key.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2723301">value</span>&nbsp;<span class="builtintype" id="2723307">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2723315">//&nbsp;priority&nbsp;is&nbsp;the&nbsp;priority&nbsp;(higher&nbsp;is&nbsp;more&nbsp;important)&nbsp;of&nbsp;the&nbsp;trie&nbsp;node&#39;s</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2723390">//&nbsp;key/value&nbsp;pair;&nbsp;keys&nbsp;are&nbsp;not&nbsp;necessarily&nbsp;matched&nbsp;shortest-&nbsp;or&nbsp;longest-</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2723465">//&nbsp;first.&nbsp;Priority&nbsp;is&nbsp;positive&nbsp;if&nbsp;this&nbsp;node&nbsp;is&nbsp;a&nbsp;complete&nbsp;key,&nbsp;and&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2723538">//&nbsp;otherwise.&nbsp;In&nbsp;the&nbsp;example&nbsp;above,&nbsp;positive/zero&nbsp;priorities&nbsp;are&nbsp;marked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2723611">//&nbsp;with&nbsp;a&nbsp;trailing&nbsp;&#34;+&#34;&nbsp;or&nbsp;&#34;-&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2723643">priority</span>&nbsp;<span class="builtintype" id="2723652">int</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2723658">//&nbsp;A&nbsp;trie&nbsp;node&nbsp;may&nbsp;have&nbsp;zero,&nbsp;one&nbsp;or&nbsp;more&nbsp;child&nbsp;nodes:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2723714">//&nbsp;&nbsp;*&nbsp;if&nbsp;the&nbsp;remaining&nbsp;fields&nbsp;are&nbsp;zero,&nbsp;there&nbsp;are&nbsp;no&nbsp;children.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2723778">//&nbsp;&nbsp;*&nbsp;if&nbsp;prefix&nbsp;and&nbsp;next&nbsp;are&nbsp;non-zero,&nbsp;there&nbsp;is&nbsp;one&nbsp;child&nbsp;in&nbsp;next.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2723846">//&nbsp;&nbsp;*&nbsp;if&nbsp;table&nbsp;is&nbsp;non-zero,&nbsp;it&nbsp;defines&nbsp;all&nbsp;the&nbsp;children.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2723904">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2723908">//&nbsp;Prefixes&nbsp;are&nbsp;preferred&nbsp;over&nbsp;tables&nbsp;when&nbsp;there&nbsp;is&nbsp;one&nbsp;child,&nbsp;but&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2723980">//&nbsp;root&nbsp;node&nbsp;always&nbsp;uses&nbsp;a&nbsp;table&nbsp;for&nbsp;lookup&nbsp;efficiency.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2724038">//&nbsp;prefix&nbsp;is&nbsp;the&nbsp;difference&nbsp;in&nbsp;keys&nbsp;between&nbsp;this&nbsp;trie&nbsp;node&nbsp;and&nbsp;the&nbsp;next.</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2724112">//&nbsp;In&nbsp;the&nbsp;example&nbsp;above,&nbsp;node&nbsp;n4&nbsp;has&nbsp;prefix&nbsp;&#34;cbc&#34;&nbsp;and&nbsp;n4&#39;s&nbsp;next&nbsp;node&nbsp;is&nbsp;n5.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2724189">//&nbsp;Node&nbsp;n5&nbsp;has&nbsp;no&nbsp;children&nbsp;and&nbsp;so&nbsp;has&nbsp;zero&nbsp;prefix,&nbsp;next&nbsp;and&nbsp;table&nbsp;fields.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2724264">prefix</span>&nbsp;<span class="builtintype" id="2724271">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2724279">next</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2724286">*</span><span class="ident" id="2724287">trieNode</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2724298">//&nbsp;table&nbsp;is&nbsp;a&nbsp;lookup&nbsp;table&nbsp;indexed&nbsp;by&nbsp;the&nbsp;next&nbsp;byte&nbsp;in&nbsp;the&nbsp;key,&nbsp;after</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2724369">//&nbsp;remapping&nbsp;that&nbsp;byte&nbsp;through&nbsp;genericReplacer.mapping&nbsp;to&nbsp;create&nbsp;a&nbsp;dense</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2724443">//&nbsp;index.&nbsp;In&nbsp;the&nbsp;example&nbsp;above,&nbsp;the&nbsp;keys&nbsp;only&nbsp;use&nbsp;&#39;a&#39;,&nbsp;&#39;b&#39;,&nbsp;&#39;c&#39;,&nbsp;&#39;x&#39;&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2724517">//&nbsp;&#39;y&#39;,&nbsp;which&nbsp;remap&nbsp;to&nbsp;0,&nbsp;1,&nbsp;2,&nbsp;3&nbsp;and&nbsp;4.&nbsp;All&nbsp;other&nbsp;bytes&nbsp;remap&nbsp;to&nbsp;5,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2724591">//&nbsp;genericReplacer.tableSize&nbsp;will&nbsp;be&nbsp;5.&nbsp;Node&nbsp;n0&#39;s&nbsp;table&nbsp;will&nbsp;be</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2724656">//&nbsp;[]*trieNode{&nbsp;0:n1,&nbsp;1:n4,&nbsp;3:n6&nbsp;},&nbsp;where&nbsp;the&nbsp;0,&nbsp;1&nbsp;and&nbsp;3&nbsp;are&nbsp;the&nbsp;remapped</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2724731">//&nbsp;&#39;a&#39;,&nbsp;&#39;b&#39;&nbsp;and&nbsp;&#39;x&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2724753">table</span>&nbsp;<span class="op" id="2724759">[</span><span class="op" id="2724760">]</span><span class="op" id="2724761">*</span><span class="ident" id="2724762">trieNode</span><br>
<span class="lineno"></span><span class="op" id="2724771">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="2724774">func</span>&nbsp;<span class="op" id="2724779">(</span><span class="ident" id="2724780">t</span>&nbsp;<span class="op" id="2724782">*</span><span class="ident" id="2724783">trieNode</span><span class="op" id="2724791">)</span>&nbsp;<span class="ident" id="2724793">add</span><span class="op" id="2724796">(</span><span class="ident" id="2724797">key</span><span class="op" id="2724800">,</span>&nbsp;<span class="ident" id="2724802">val</span>&nbsp;<span class="builtintype" id="2724806">string</span><span class="op" id="2724812">,</span>&nbsp;<span class="ident" id="2724814">priority</span>&nbsp;<span class="builtintype" id="2724823">int</span><span class="op" id="2724826">,</span>&nbsp;<span class="ident" id="2724828">r</span>&nbsp;<span class="op" id="2724830">*</span><span class="ident" id="2724831">genericReplacer</span><span class="op" id="2724846">)</span>&nbsp;<span class="op" id="2724848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2724851">if</span>&nbsp;<span class="ident" id="2724854">key</span>&nbsp;<span class="op" id="2724858">==</span>&nbsp;<span class="string" id="2724861">&#34;&#34;</span>&nbsp;<span class="op" id="2724864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2724868">if</span>&nbsp;<span class="ident" id="2724871">t</span><span class="op" id="2724872">.</span><span class="ident" id="2724873">priority</span>&nbsp;<span class="op" id="2724882">==</span>&nbsp;<span class="num" id="2724885">0</span>&nbsp;<span class="op" id="2724887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2724892">t</span><span class="op" id="2724893">.</span><span class="ident" id="2724894">value</span>&nbsp;<span class="op" id="2724900">=</span>&nbsp;<span class="ident" id="2724902">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2724909">t</span><span class="op" id="2724910">.</span><span class="ident" id="2724911">priority</span>&nbsp;<span class="op" id="2724920">=</span>&nbsp;<span class="ident" id="2724922">priority</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2724933">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2724937">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2724945">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2724949">if</span>&nbsp;<span class="ident" id="2724952">t</span><span class="op" id="2724953">.</span><span class="ident" id="2724954">prefix</span>&nbsp;<span class="op" id="2724961">!=</span>&nbsp;<span class="string" id="2724964">&#34;&#34;</span>&nbsp;<span class="op" id="2724967">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2724971">//&nbsp;Need&nbsp;to&nbsp;split&nbsp;the&nbsp;prefix&nbsp;among&nbsp;multiple&nbsp;nodes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2725023">var</span>&nbsp;<span class="ident" id="2725027">n</span>&nbsp;<span class="builtintype" id="2725029">int</span>&nbsp;<span class="comment" id="2725033">//&nbsp;length&nbsp;of&nbsp;the&nbsp;longest&nbsp;common&nbsp;prefix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2725074">for</span>&nbsp;<span class="op" id="2725078">;</span>&nbsp;<span class="ident" id="2725080">n</span>&nbsp;<span class="op" id="2725082">&lt;</span>&nbsp;<span class="builtinfunc" id="2725084">len</span><span class="op" id="2725087">(</span><span class="ident" id="2725088">t</span><span class="op" id="2725089">.</span><span class="ident" id="2725090">prefix</span><span class="op" id="2725096">)</span>&nbsp;<span class="op" id="2725098">&amp;&amp;</span>&nbsp;<span class="ident" id="2725101">n</span>&nbsp;<span class="op" id="2725103">&lt;</span>&nbsp;<span class="builtinfunc" id="2725105">len</span><span class="op" id="2725108">(</span><span class="ident" id="2725109">key</span><span class="op" id="2725112">)</span><span class="op" id="2725113">;</span>&nbsp;<span class="ident" id="2725115">n</span><span class="op" id="2725116">++</span>&nbsp;<span class="op" id="2725119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2725124">if</span>&nbsp;<span class="ident" id="2725127">t</span><span class="op" id="2725128">.</span><span class="ident" id="2725129">prefix</span><span class="op" id="2725135">[</span><span class="ident" id="2725136">n</span><span class="op" id="2725137">]</span>&nbsp;<span class="op" id="2725139">!=</span>&nbsp;<span class="ident" id="2725142">key</span><span class="op" id="2725145">[</span><span class="ident" id="2725146">n</span><span class="op" id="2725147">]</span>&nbsp;<span class="op" id="2725149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2725155">break</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2725164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2725168">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2725172">if</span>&nbsp;<span class="ident" id="2725175">n</span>&nbsp;<span class="op" id="2725177">==</span>&nbsp;<span class="builtinfunc" id="2725180">len</span><span class="op" id="2725183">(</span><span class="ident" id="2725184">t</span><span class="op" id="2725185">.</span><span class="ident" id="2725186">prefix</span><span class="op" id="2725192">)</span>&nbsp;<span class="op" id="2725194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2725199">t</span><span class="op" id="2725200">.</span><span class="ident" id="2725201">next</span><span class="op" id="2725205">.</span><span class="ident" id="2725206">add</span><span class="op" id="2725209">(</span><span class="ident" id="2725210">key</span><span class="op" id="2725213">[</span><span class="ident" id="2725214">n</span><span class="op" id="2725215">:</span><span class="op" id="2725216">]</span><span class="op" id="2725217">,</span>&nbsp;<span class="ident" id="2725219">val</span><span class="op" id="2725222">,</span>&nbsp;<span class="ident" id="2725224">priority</span><span class="op" id="2725232">,</span>&nbsp;<span class="ident" id="2725234">r</span><span class="op" id="2725235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2725239">}</span>&nbsp;<span class="keyword" id="2725241">else</span>&nbsp;<span class="keyword" id="2725246">if</span>&nbsp;<span class="ident" id="2725249">n</span>&nbsp;<span class="op" id="2725251">==</span>&nbsp;<span class="num" id="2725254">0</span>&nbsp;<span class="op" id="2725256">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2725261">//&nbsp;First&nbsp;byte&nbsp;differs,&nbsp;start&nbsp;a&nbsp;new&nbsp;lookup&nbsp;table&nbsp;here.&nbsp;Looking&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2725329">//&nbsp;what&nbsp;is&nbsp;currently&nbsp;t.prefix[0]&nbsp;will&nbsp;lead&nbsp;to&nbsp;prefixNode,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2725394">//&nbsp;looking&nbsp;up&nbsp;key[0]&nbsp;will&nbsp;lead&nbsp;to&nbsp;keyNode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2725440">var</span>&nbsp;<span class="ident" id="2725444">prefixNode</span>&nbsp;<span class="op" id="2725455">*</span><span class="ident" id="2725456">trieNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2725468">if</span>&nbsp;<span class="builtinfunc" id="2725471">len</span><span class="op" id="2725474">(</span><span class="ident" id="2725475">t</span><span class="op" id="2725476">.</span><span class="ident" id="2725477">prefix</span><span class="op" id="2725483">)</span>&nbsp;<span class="op" id="2725485">==</span>&nbsp;<span class="num" id="2725488">1</span>&nbsp;<span class="op" id="2725490">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2725496">prefixNode</span>&nbsp;<span class="op" id="2725507">=</span>&nbsp;<span class="ident" id="2725509">t</span><span class="op" id="2725510">.</span><span class="ident" id="2725511">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2725519">}</span>&nbsp;<span class="keyword" id="2725521">else</span>&nbsp;<span class="op" id="2725526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2725532">prefixNode</span>&nbsp;<span class="op" id="2725543">=</span>&nbsp;<span class="op" id="2725545">&amp;</span><span class="ident" id="2725546">trieNode</span><span class="op" id="2725554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2725561">prefix</span><span class="op" id="2725567">:</span>&nbsp;<span class="ident" id="2725569">t</span><span class="op" id="2725570">.</span><span class="ident" id="2725571">prefix</span><span class="op" id="2725577">[</span><span class="num" id="2725578">1</span><span class="op" id="2725579">:</span><span class="op" id="2725580">]</span><span class="op" id="2725581">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2725588">next</span><span class="op" id="2725592">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2725596">t</span><span class="op" id="2725597">.</span><span class="ident" id="2725598">next</span><span class="op" id="2725602">,</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2725608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2725613">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2725618">keyNode</span>&nbsp;<span class="op" id="2725626">:=</span>&nbsp;<span class="builtinfunc" id="2725629">new</span><span class="op" id="2725632">(</span><span class="ident" id="2725633">trieNode</span><span class="op" id="2725641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2725646">t</span><span class="op" id="2725647">.</span><span class="ident" id="2725648">table</span>&nbsp;<span class="op" id="2725654">=</span>&nbsp;<span class="builtinfunc" id="2725656">make</span><span class="op" id="2725660">(</span><span class="op" id="2725661">[</span><span class="op" id="2725662">]</span><span class="op" id="2725663">*</span><span class="ident" id="2725664">trieNode</span><span class="op" id="2725672">,</span>&nbsp;<span class="ident" id="2725674">r</span><span class="op" id="2725675">.</span><span class="ident" id="2725676">tableSize</span><span class="op" id="2725685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2725690">t</span><span class="op" id="2725691">.</span><span class="ident" id="2725692">table</span><span class="op" id="2725697">[</span><span class="ident" id="2725698">r</span><span class="op" id="2725699">.</span><span class="ident" id="2725700">mapping</span><span class="op" id="2725707">[</span><span class="ident" id="2725708">t</span><span class="op" id="2725709">.</span><span class="ident" id="2725710">prefix</span><span class="op" id="2725716">[</span><span class="num" id="2725717">0</span><span class="op" id="2725718">]</span><span class="op" id="2725719">]</span><span class="op" id="2725720">]</span>&nbsp;<span class="op" id="2725722">=</span>&nbsp;<span class="ident" id="2725724">prefixNode</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2725738">t</span><span class="op" id="2725739">.</span><span class="ident" id="2725740">table</span><span class="op" id="2725745">[</span><span class="ident" id="2725746">r</span><span class="op" id="2725747">.</span><span class="ident" id="2725748">mapping</span><span class="op" id="2725755">[</span><span class="ident" id="2725756">key</span><span class="op" id="2725759">[</span><span class="num" id="2725760">0</span><span class="op" id="2725761">]</span><span class="op" id="2725762">]</span><span class="op" id="2725763">]</span>&nbsp;<span class="op" id="2725765">=</span>&nbsp;<span class="ident" id="2725767">keyNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2725778">t</span><span class="op" id="2725779">.</span><span class="ident" id="2725780">prefix</span>&nbsp;<span class="op" id="2725787">=</span>&nbsp;<span class="string" id="2725789">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2725795">t</span><span class="op" id="2725796">.</span><span class="ident" id="2725797">next</span>&nbsp;<span class="op" id="2725802">=</span>&nbsp;<span class="ident" id="2725804">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2725811">keyNode</span><span class="op" id="2725818">.</span><span class="ident" id="2725819">add</span><span class="op" id="2725822">(</span><span class="ident" id="2725823">key</span><span class="op" id="2725826">[</span><span class="num" id="2725827">1</span><span class="op" id="2725828">:</span><span class="op" id="2725829">]</span><span class="op" id="2725830">,</span>&nbsp;<span class="ident" id="2725832">val</span><span class="op" id="2725835">,</span>&nbsp;<span class="ident" id="2725837">priority</span><span class="op" id="2725845">,</span>&nbsp;<span class="ident" id="2725847">r</span><span class="op" id="2725848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2725852">}</span>&nbsp;<span class="keyword" id="2725854">else</span>&nbsp;<span class="op" id="2725859">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2725864">//&nbsp;Insert&nbsp;new&nbsp;node&nbsp;after&nbsp;the&nbsp;common&nbsp;section&nbsp;of&nbsp;the&nbsp;prefix.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2725926">next</span>&nbsp;<span class="op" id="2725931">:=</span>&nbsp;<span class="op" id="2725934">&amp;</span><span class="ident" id="2725935">trieNode</span><span class="op" id="2725943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2725949">prefix</span><span class="op" id="2725955">:</span>&nbsp;<span class="ident" id="2725957">t</span><span class="op" id="2725958">.</span><span class="ident" id="2725959">prefix</span><span class="op" id="2725965">[</span><span class="ident" id="2725966">n</span><span class="op" id="2725967">:</span><span class="op" id="2725968">]</span><span class="op" id="2725969">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2725975">next</span><span class="op" id="2725979">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2725983">t</span><span class="op" id="2725984">.</span><span class="ident" id="2725985">next</span><span class="op" id="2725989">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2725994">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2725999">t</span><span class="op" id="2726000">.</span><span class="ident" id="2726001">prefix</span>&nbsp;<span class="op" id="2726008">=</span>&nbsp;<span class="ident" id="2726010">t</span><span class="op" id="2726011">.</span><span class="ident" id="2726012">prefix</span><span class="op" id="2726018">[</span><span class="op" id="2726019">:</span><span class="ident" id="2726020">n</span><span class="op" id="2726021">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2726026">t</span><span class="op" id="2726027">.</span><span class="ident" id="2726028">next</span>&nbsp;<span class="op" id="2726033">=</span>&nbsp;<span class="ident" id="2726035">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2726043">next</span><span class="op" id="2726047">.</span><span class="ident" id="2726048">add</span><span class="op" id="2726051">(</span><span class="ident" id="2726052">key</span><span class="op" id="2726055">[</span><span class="ident" id="2726056">n</span><span class="op" id="2726057">:</span><span class="op" id="2726058">]</span><span class="op" id="2726059">,</span>&nbsp;<span class="ident" id="2726061">val</span><span class="op" id="2726064">,</span>&nbsp;<span class="ident" id="2726066">priority</span><span class="op" id="2726074">,</span>&nbsp;<span class="ident" id="2726076">r</span><span class="op" id="2726077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2726081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2726084">}</span>&nbsp;<span class="keyword" id="2726086">else</span>&nbsp;<span class="keyword" id="2726091">if</span>&nbsp;<span class="ident" id="2726094">t</span><span class="op" id="2726095">.</span><span class="ident" id="2726096">table</span>&nbsp;<span class="op" id="2726102">!=</span>&nbsp;<span class="ident" id="2726105">nil</span>&nbsp;<span class="op" id="2726109">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2726113">//&nbsp;Insert&nbsp;into&nbsp;existing&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2726146">m</span>&nbsp;<span class="op" id="2726148">:=</span>&nbsp;<span class="ident" id="2726151">r</span><span class="op" id="2726152">.</span><span class="ident" id="2726153">mapping</span><span class="op" id="2726160">[</span><span class="ident" id="2726161">key</span><span class="op" id="2726164">[</span><span class="num" id="2726165">0</span><span class="op" id="2726166">]</span><span class="op" id="2726167">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2726171">if</span>&nbsp;<span class="ident" id="2726174">t</span><span class="op" id="2726175">.</span><span class="ident" id="2726176">table</span><span class="op" id="2726181">[</span><span class="ident" id="2726182">m</span><span class="op" id="2726183">]</span>&nbsp;<span class="op" id="2726185">==</span>&nbsp;<span class="ident" id="2726188">nil</span>&nbsp;<span class="op" id="2726192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2726197">t</span><span class="op" id="2726198">.</span><span class="ident" id="2726199">table</span><span class="op" id="2726204">[</span><span class="ident" id="2726205">m</span><span class="op" id="2726206">]</span>&nbsp;<span class="op" id="2726208">=</span>&nbsp;<span class="builtinfunc" id="2726210">new</span><span class="op" id="2726213">(</span><span class="ident" id="2726214">trieNode</span><span class="op" id="2726222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2726226">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2726230">t</span><span class="op" id="2726231">.</span><span class="ident" id="2726232">table</span><span class="op" id="2726237">[</span><span class="ident" id="2726238">m</span><span class="op" id="2726239">]</span><span class="op" id="2726240">.</span><span class="ident" id="2726241">add</span><span class="op" id="2726244">(</span><span class="ident" id="2726245">key</span><span class="op" id="2726248">[</span><span class="num" id="2726249">1</span><span class="op" id="2726250">:</span><span class="op" id="2726251">]</span><span class="op" id="2726252">,</span>&nbsp;<span class="ident" id="2726254">val</span><span class="op" id="2726257">,</span>&nbsp;<span class="ident" id="2726259">priority</span><span class="op" id="2726267">,</span>&nbsp;<span class="ident" id="2726269">r</span><span class="op" id="2726270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2726273">}</span>&nbsp;<span class="keyword" id="2726275">else</span>&nbsp;<span class="op" id="2726280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2726284">t</span><span class="op" id="2726285">.</span><span class="ident" id="2726286">prefix</span>&nbsp;<span class="op" id="2726293">=</span>&nbsp;<span class="ident" id="2726295">key</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2726301">t</span><span class="op" id="2726302">.</span><span class="ident" id="2726303">next</span>&nbsp;<span class="op" id="2726308">=</span>&nbsp;<span class="builtinfunc" id="2726310">new</span><span class="op" id="2726313">(</span><span class="ident" id="2726314">trieNode</span><span class="op" id="2726322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2726326">t</span><span class="op" id="2726327">.</span><span class="ident" id="2726328">next</span><span class="op" id="2726332">.</span><span class="ident" id="2726333">add</span><span class="op" id="2726336">(</span><span class="string" id="2726337">&#34;&#34;</span><span class="op" id="2726339">,</span>&nbsp;<span class="ident" id="2726341">val</span><span class="op" id="2726344">,</span>&nbsp;<span class="ident" id="2726346">priority</span><span class="op" id="2726354">,</span>&nbsp;<span class="ident" id="2726356">r</span><span class="op" id="2726357">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2726360">}</span><br>
<span class="lineno"></span><span class="op" id="2726362">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2726365">func</span>&nbsp;<span class="op" id="2726370">(</span><span class="ident" id="2726371">r</span>&nbsp;<span class="op" id="2726373">*</span><span class="ident" id="2726374">genericReplacer</span><span class="op" id="2726389">)</span>&nbsp;<span class="ident" id="2726391">lookup</span><span class="op" id="2726397">(</span><span class="ident" id="2726398">s</span>&nbsp;<span class="builtintype" id="2726400">string</span><span class="op" id="2726406">,</span>&nbsp;<span class="ident" id="2726408">ignoreRoot</span>&nbsp;<span class="builtintype" id="2726419">bool</span><span class="op" id="2726423">)</span>&nbsp;<span class="op" id="2726425">(</span><span class="ident" id="2726426">val</span>&nbsp;<span class="builtintype" id="2726430">string</span><span class="op" id="2726436">,</span>&nbsp;<span class="ident" id="2726438">keylen</span>&nbsp;<span class="builtintype" id="2726445">int</span><span class="op" id="2726448">,</span>&nbsp;<span class="ident" id="2726450">found</span>&nbsp;<span class="builtintype" id="2726456">bool</span><span class="op" id="2726460">)</span>&nbsp;<span class="op" id="2726462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2726465">//&nbsp;Iterate&nbsp;down&nbsp;the&nbsp;trie&nbsp;to&nbsp;the&nbsp;end,&nbsp;and&nbsp;grab&nbsp;the&nbsp;value&nbsp;and&nbsp;keylen&nbsp;with</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2726538">//&nbsp;the&nbsp;highest&nbsp;priority.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2726564">bestPriority</span>&nbsp;<span class="op" id="2726577">:=</span>&nbsp;<span class="num" id="2726580">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2726583">node</span>&nbsp;<span class="op" id="2726588">:=</span>&nbsp;<span class="op" id="2726591">&amp;</span><span class="ident" id="2726592">r</span><span class="op" id="2726593">.</span><span class="ident" id="2726594">root</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2726600">n</span>&nbsp;<span class="op" id="2726602">:=</span>&nbsp;<span class="num" id="2726605">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2726608">for</span>&nbsp;<span class="ident" id="2726612">node</span>&nbsp;<span class="op" id="2726617">!=</span>&nbsp;<span class="ident" id="2726620">nil</span>&nbsp;<span class="op" id="2726624">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2726628">if</span>&nbsp;<span class="ident" id="2726631">node</span><span class="op" id="2726635">.</span><span class="ident" id="2726636">priority</span>&nbsp;<span class="op" id="2726645">&gt;</span>&nbsp;<span class="ident" id="2726647">bestPriority</span>&nbsp;<span class="op" id="2726660">&amp;&amp;</span>&nbsp;<span class="op" id="2726663">!</span><span class="op" id="2726664">(</span><span class="ident" id="2726665">ignoreRoot</span>&nbsp;<span class="op" id="2726676">&amp;&amp;</span>&nbsp;<span class="ident" id="2726679">node</span>&nbsp;<span class="op" id="2726684">==</span>&nbsp;<span class="op" id="2726687">&amp;</span><span class="ident" id="2726688">r</span><span class="op" id="2726689">.</span><span class="ident" id="2726690">root</span><span class="op" id="2726694">)</span>&nbsp;<span class="op" id="2726696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2726701">bestPriority</span>&nbsp;<span class="op" id="2726714">=</span>&nbsp;<span class="ident" id="2726716">node</span><span class="op" id="2726720">.</span><span class="ident" id="2726721">priority</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2726733">val</span>&nbsp;<span class="op" id="2726737">=</span>&nbsp;<span class="ident" id="2726739">node</span><span class="op" id="2726743">.</span><span class="ident" id="2726744">value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2726753">keylen</span>&nbsp;<span class="op" id="2726760">=</span>&nbsp;<span class="ident" id="2726762">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2726767">found</span>&nbsp;<span class="op" id="2726773">=</span>&nbsp;<span class="ident" id="2726775">true</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2726782">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2726787">if</span>&nbsp;<span class="ident" id="2726790">s</span>&nbsp;<span class="op" id="2726792">==</span>&nbsp;<span class="string" id="2726795">&#34;&#34;</span>&nbsp;<span class="op" id="2726798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2726803">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2726811">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2726815">if</span>&nbsp;<span class="ident" id="2726818">node</span><span class="op" id="2726822">.</span><span class="ident" id="2726823">table</span>&nbsp;<span class="op" id="2726829">!=</span>&nbsp;<span class="ident" id="2726832">nil</span>&nbsp;<span class="op" id="2726836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2726841">index</span>&nbsp;<span class="op" id="2726847">:=</span>&nbsp;<span class="ident" id="2726850">r</span><span class="op" id="2726851">.</span><span class="ident" id="2726852">mapping</span><span class="op" id="2726859">[</span><span class="ident" id="2726860">s</span><span class="op" id="2726861">[</span><span class="num" id="2726862">0</span><span class="op" id="2726863">]</span><span class="op" id="2726864">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2726869">if</span>&nbsp;<span class="builtintype" id="2726872">int</span><span class="op" id="2726875">(</span><span class="ident" id="2726876">index</span><span class="op" id="2726881">)</span>&nbsp;<span class="op" id="2726883">==</span>&nbsp;<span class="ident" id="2726886">r</span><span class="op" id="2726887">.</span><span class="ident" id="2726888">tableSize</span>&nbsp;<span class="op" id="2726898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2726904">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2726913">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2726918">node</span>&nbsp;<span class="op" id="2726923">=</span>&nbsp;<span class="ident" id="2726925">node</span><span class="op" id="2726929">.</span><span class="ident" id="2726930">table</span><span class="op" id="2726935">[</span><span class="ident" id="2726936">index</span><span class="op" id="2726941">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2726946">s</span>&nbsp;<span class="op" id="2726948">=</span>&nbsp;<span class="ident" id="2726950">s</span><span class="op" id="2726951">[</span><span class="num" id="2726952">1</span><span class="op" id="2726953">:</span><span class="op" id="2726954">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2726959">n</span><span class="op" id="2726960">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2726965">}</span>&nbsp;<span class="keyword" id="2726967">else</span>&nbsp;<span class="keyword" id="2726972">if</span>&nbsp;<span class="ident" id="2726975">node</span><span class="op" id="2726979">.</span><span class="ident" id="2726980">prefix</span>&nbsp;<span class="op" id="2726987">!=</span>&nbsp;<span class="string" id="2726990">&#34;&#34;</span>&nbsp;<span class="op" id="2726993">&amp;&amp;</span>&nbsp;<span class="ident" id="2726996">HasPrefix</span><span class="op" id="2727005">(</span><span class="ident" id="2727006">s</span><span class="op" id="2727007">,</span>&nbsp;<span class="ident" id="2727009">node</span><span class="op" id="2727013">.</span><span class="ident" id="2727014">prefix</span><span class="op" id="2727020">)</span>&nbsp;<span class="op" id="2727022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2727027">n</span>&nbsp;<span class="op" id="2727029">+=</span>&nbsp;<span class="builtinfunc" id="2727032">len</span><span class="op" id="2727035">(</span><span class="ident" id="2727036">node</span><span class="op" id="2727040">.</span><span class="ident" id="2727041">prefix</span><span class="op" id="2727047">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2727052">s</span>&nbsp;<span class="op" id="2727054">=</span>&nbsp;<span class="ident" id="2727056">s</span><span class="op" id="2727057">[</span><span class="builtinfunc" id="2727058">len</span><span class="op" id="2727061">(</span><span class="ident" id="2727062">node</span><span class="op" id="2727066">.</span><span class="ident" id="2727067">prefix</span><span class="op" id="2727073">)</span><span class="op" id="2727074">:</span><span class="op" id="2727075">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2727080">node</span>&nbsp;<span class="op" id="2727085">=</span>&nbsp;<span class="ident" id="2727087">node</span><span class="op" id="2727091">.</span><span class="ident" id="2727092">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2727099">}</span>&nbsp;<span class="keyword" id="2727101">else</span>&nbsp;<span class="op" id="2727106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2727111">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2727119">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2727122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2727125">return</span><br>
<span class="lineno"></span><span class="op" id="2727132">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2727135">//&nbsp;genericReplacer&nbsp;is&nbsp;the&nbsp;fully&nbsp;generic&nbsp;algorithm.</span><br>
<span class="lineno">230</span><span class="comment" id="2727186">//&nbsp;It&#39;s&nbsp;used&nbsp;as&nbsp;a&nbsp;fallback&nbsp;when&nbsp;nothing&nbsp;faster&nbsp;can&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="2727246">type</span>&nbsp;<span class="ident" id="2727251">genericReplacer</span>&nbsp;<span class="keyword" id="2727267">struct</span>&nbsp;<span class="op" id="2727274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2727277">root</span>&nbsp;<span class="ident" id="2727282">trieNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2727292">//&nbsp;tableSize&nbsp;is&nbsp;the&nbsp;size&nbsp;of&nbsp;a&nbsp;trie&nbsp;node&#39;s&nbsp;lookup&nbsp;table.&nbsp;It&nbsp;is&nbsp;the&nbsp;number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2727366">//&nbsp;of&nbsp;unique&nbsp;key&nbsp;bytes.</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2727391">tableSize</span>&nbsp;<span class="builtintype" id="2727401">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2727406">//&nbsp;mapping&nbsp;maps&nbsp;from&nbsp;key&nbsp;bytes&nbsp;to&nbsp;a&nbsp;dense&nbsp;index&nbsp;for&nbsp;trieNode.table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2727475">mapping</span>&nbsp;<span class="op" id="2727483">[</span><span class="num" id="2727484">256</span><span class="op" id="2727487">]</span><span class="builtintype" id="2727488">byte</span><br>
<span class="lineno"></span><span class="op" id="2727493">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span><span class="keyword" id="2727496">func</span>&nbsp;<span class="ident" id="2727501">makeGenericReplacer</span><span class="op" id="2727520">(</span><span class="ident" id="2727521">oldnew</span>&nbsp;<span class="op" id="2727528">[</span><span class="op" id="2727529">]</span><span class="builtintype" id="2727530">string</span><span class="op" id="2727536">)</span>&nbsp;<span class="op" id="2727538">*</span><span class="ident" id="2727539">genericReplacer</span>&nbsp;<span class="op" id="2727555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2727558">r</span>&nbsp;<span class="op" id="2727560">:=</span>&nbsp;<span class="builtinfunc" id="2727563">new</span><span class="op" id="2727566">(</span><span class="ident" id="2727567">genericReplacer</span><span class="op" id="2727582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2727585">//&nbsp;Find&nbsp;each&nbsp;byte&nbsp;used,&nbsp;then&nbsp;assign&nbsp;them&nbsp;each&nbsp;an&nbsp;index.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2727642">for</span>&nbsp;<span class="ident" id="2727646">i</span>&nbsp;<span class="op" id="2727648">:=</span>&nbsp;<span class="num" id="2727651">0</span><span class="op" id="2727652">;</span>&nbsp;<span class="ident" id="2727654">i</span>&nbsp;<span class="op" id="2727656">&lt;</span>&nbsp;<span class="builtinfunc" id="2727658">len</span><span class="op" id="2727661">(</span><span class="ident" id="2727662">oldnew</span><span class="op" id="2727668">)</span><span class="op" id="2727669">;</span>&nbsp;<span class="ident" id="2727671">i</span>&nbsp;<span class="op" id="2727673">+=</span>&nbsp;<span class="num" id="2727676">2</span>&nbsp;<span class="op" id="2727678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2727682">key</span>&nbsp;<span class="op" id="2727686">:=</span>&nbsp;<span class="ident" id="2727689">oldnew</span><span class="op" id="2727695">[</span><span class="ident" id="2727696">i</span><span class="op" id="2727697">]</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2727701">for</span>&nbsp;<span class="ident" id="2727705">j</span>&nbsp;<span class="op" id="2727707">:=</span>&nbsp;<span class="num" id="2727710">0</span><span class="op" id="2727711">;</span>&nbsp;<span class="ident" id="2727713">j</span>&nbsp;<span class="op" id="2727715">&lt;</span>&nbsp;<span class="builtinfunc" id="2727717">len</span><span class="op" id="2727720">(</span><span class="ident" id="2727721">key</span><span class="op" id="2727724">)</span><span class="op" id="2727725">;</span>&nbsp;<span class="ident" id="2727727">j</span><span class="op" id="2727728">++</span>&nbsp;<span class="op" id="2727731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2727736">r</span><span class="op" id="2727737">.</span><span class="ident" id="2727738">mapping</span><span class="op" id="2727745">[</span><span class="ident" id="2727746">key</span><span class="op" id="2727749">[</span><span class="ident" id="2727750">j</span><span class="op" id="2727751">]</span><span class="op" id="2727752">]</span>&nbsp;<span class="op" id="2727754">=</span>&nbsp;<span class="num" id="2727756">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2727760">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2727763">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2727767">for</span>&nbsp;<span class="ident" id="2727771">_</span><span class="op" id="2727772">,</span>&nbsp;<span class="ident" id="2727774">b</span>&nbsp;<span class="op" id="2727776">:=</span>&nbsp;<span class="keyword" id="2727779">range</span>&nbsp;<span class="ident" id="2727785">r</span><span class="op" id="2727786">.</span><span class="ident" id="2727787">mapping</span>&nbsp;<span class="op" id="2727795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2727799">r</span><span class="op" id="2727800">.</span><span class="ident" id="2727801">tableSize</span>&nbsp;<span class="op" id="2727811">+=</span>&nbsp;<span class="builtintype" id="2727814">int</span><span class="op" id="2727817">(</span><span class="ident" id="2727818">b</span><span class="op" id="2727819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2727822">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2727826">var</span>&nbsp;<span class="ident" id="2727830">index</span>&nbsp;<span class="builtintype" id="2727836">byte</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2727842">for</span>&nbsp;<span class="ident" id="2727846">i</span><span class="op" id="2727847">,</span>&nbsp;<span class="ident" id="2727849">b</span>&nbsp;<span class="op" id="2727851">:=</span>&nbsp;<span class="keyword" id="2727854">range</span>&nbsp;<span class="ident" id="2727860">r</span><span class="op" id="2727861">.</span><span class="ident" id="2727862">mapping</span>&nbsp;<span class="op" id="2727870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2727874">if</span>&nbsp;<span class="ident" id="2727877">b</span>&nbsp;<span class="op" id="2727879">==</span>&nbsp;<span class="num" id="2727882">0</span>&nbsp;<span class="op" id="2727884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2727889">r</span><span class="op" id="2727890">.</span><span class="ident" id="2727891">mapping</span><span class="op" id="2727898">[</span><span class="ident" id="2727899">i</span><span class="op" id="2727900">]</span>&nbsp;<span class="op" id="2727902">=</span>&nbsp;<span class="builtintype" id="2727904">byte</span><span class="op" id="2727908">(</span><span class="ident" id="2727909">r</span><span class="op" id="2727910">.</span><span class="ident" id="2727911">tableSize</span><span class="op" id="2727920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2727924">}</span>&nbsp;<span class="keyword" id="2727926">else</span>&nbsp;<span class="op" id="2727931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2727936">r</span><span class="op" id="2727937">.</span><span class="ident" id="2727938">mapping</span><span class="op" id="2727945">[</span><span class="ident" id="2727946">i</span><span class="op" id="2727947">]</span>&nbsp;<span class="op" id="2727949">=</span>&nbsp;<span class="ident" id="2727951">index</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2727960">index</span><span class="op" id="2727965">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2727970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2727973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2727976">//&nbsp;Ensure&nbsp;root&nbsp;node&nbsp;uses&nbsp;a&nbsp;lookup&nbsp;table&nbsp;(for&nbsp;performance).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2728036">r</span><span class="op" id="2728037">.</span><span class="ident" id="2728038">root</span><span class="op" id="2728042">.</span><span class="ident" id="2728043">table</span>&nbsp;<span class="op" id="2728049">=</span>&nbsp;<span class="builtinfunc" id="2728051">make</span><span class="op" id="2728055">(</span><span class="op" id="2728056">[</span><span class="op" id="2728057">]</span><span class="op" id="2728058">*</span><span class="ident" id="2728059">trieNode</span><span class="op" id="2728067">,</span>&nbsp;<span class="ident" id="2728069">r</span><span class="op" id="2728070">.</span><span class="ident" id="2728071">tableSize</span><span class="op" id="2728080">)</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2728084">for</span>&nbsp;<span class="ident" id="2728088">i</span>&nbsp;<span class="op" id="2728090">:=</span>&nbsp;<span class="num" id="2728093">0</span><span class="op" id="2728094">;</span>&nbsp;<span class="ident" id="2728096">i</span>&nbsp;<span class="op" id="2728098">&lt;</span>&nbsp;<span class="builtinfunc" id="2728100">len</span><span class="op" id="2728103">(</span><span class="ident" id="2728104">oldnew</span><span class="op" id="2728110">)</span><span class="op" id="2728111">;</span>&nbsp;<span class="ident" id="2728113">i</span>&nbsp;<span class="op" id="2728115">+=</span>&nbsp;<span class="num" id="2728118">2</span>&nbsp;<span class="op" id="2728120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2728124">r</span><span class="op" id="2728125">.</span><span class="ident" id="2728126">root</span><span class="op" id="2728130">.</span><span class="ident" id="2728131">add</span><span class="op" id="2728134">(</span><span class="ident" id="2728135">oldnew</span><span class="op" id="2728141">[</span><span class="ident" id="2728142">i</span><span class="op" id="2728143">]</span><span class="op" id="2728144">,</span>&nbsp;<span class="ident" id="2728146">oldnew</span><span class="op" id="2728152">[</span><span class="ident" id="2728153">i</span><span class="op" id="2728154">+</span><span class="num" id="2728155">1</span><span class="op" id="2728156">]</span><span class="op" id="2728157">,</span>&nbsp;<span class="builtinfunc" id="2728159">len</span><span class="op" id="2728162">(</span><span class="ident" id="2728163">oldnew</span><span class="op" id="2728169">)</span><span class="op" id="2728170">-</span><span class="ident" id="2728171">i</span><span class="op" id="2728172">,</span>&nbsp;<span class="ident" id="2728174">r</span><span class="op" id="2728175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2728178">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2728181">return</span>&nbsp;<span class="ident" id="2728188">r</span><br>
<span class="lineno">270</span><span class="op" id="2728190">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2728193">type</span>&nbsp;<span class="ident" id="2728198">appendSliceWriter</span>&nbsp;<span class="op" id="2728216">[</span><span class="op" id="2728217">]</span><span class="builtintype" id="2728218">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2728224">//&nbsp;Write&nbsp;writes&nbsp;to&nbsp;the&nbsp;buffer&nbsp;to&nbsp;satisfy&nbsp;io.Writer.</span><br>
<span class="lineno">275</span><span class="keyword" id="2728276">func</span>&nbsp;<span class="op" id="2728281">(</span><span class="ident" id="2728282">w</span>&nbsp;<span class="op" id="2728284">*</span><span class="ident" id="2728285">appendSliceWriter</span><span class="op" id="2728302">)</span>&nbsp;<span class="ident" id="2728304">Write</span><span class="op" id="2728309">(</span><span class="ident" id="2728310">p</span>&nbsp;<span class="op" id="2728312">[</span><span class="op" id="2728313">]</span><span class="builtintype" id="2728314">byte</span><span class="op" id="2728318">)</span>&nbsp;<span class="op" id="2728320">(</span><span class="builtintype" id="2728321">int</span><span class="op" id="2728324">,</span>&nbsp;<span class="builtintype" id="2728326">error</span><span class="op" id="2728331">)</span>&nbsp;<span class="op" id="2728333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2728336">*</span><span class="ident" id="2728337">w</span>&nbsp;<span class="op" id="2728339">=</span>&nbsp;<span class="builtinfunc" id="2728341">append</span><span class="op" id="2728347">(</span><span class="op" id="2728348">*</span><span class="ident" id="2728349">w</span><span class="op" id="2728350">,</span>&nbsp;<span class="ident" id="2728352">p</span><span class="op" id="2728353">...</span><span class="op" id="2728356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2728359">return</span>&nbsp;<span class="builtinfunc" id="2728366">len</span><span class="op" id="2728369">(</span><span class="ident" id="2728370">p</span><span class="op" id="2728371">)</span><span class="op" id="2728372">,</span>&nbsp;<span class="ident" id="2728374">nil</span><br>
<span class="lineno"></span><span class="op" id="2728378">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="comment" id="2728381">//&nbsp;WriteString&nbsp;writes&nbsp;to&nbsp;the&nbsp;buffer&nbsp;without&nbsp;string-&gt;[]byte-&gt;string&nbsp;allocations.</span><br>
<span class="lineno"></span><span class="keyword" id="2728461">func</span>&nbsp;<span class="op" id="2728466">(</span><span class="ident" id="2728467">w</span>&nbsp;<span class="op" id="2728469">*</span><span class="ident" id="2728470">appendSliceWriter</span><span class="op" id="2728487">)</span>&nbsp;<span class="ident" id="2728489">WriteString</span><span class="op" id="2728500">(</span><span class="ident" id="2728501">s</span>&nbsp;<span class="builtintype" id="2728503">string</span><span class="op" id="2728509">)</span>&nbsp;<span class="op" id="2728511">(</span><span class="builtintype" id="2728512">int</span><span class="op" id="2728515">,</span>&nbsp;<span class="builtintype" id="2728517">error</span><span class="op" id="2728522">)</span>&nbsp;<span class="op" id="2728524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2728527">*</span><span class="ident" id="2728528">w</span>&nbsp;<span class="op" id="2728530">=</span>&nbsp;<span class="builtinfunc" id="2728532">append</span><span class="op" id="2728538">(</span><span class="op" id="2728539">*</span><span class="ident" id="2728540">w</span><span class="op" id="2728541">,</span>&nbsp;<span class="ident" id="2728543">s</span><span class="op" id="2728544">...</span><span class="op" id="2728547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2728550">return</span>&nbsp;<span class="builtinfunc" id="2728557">len</span><span class="op" id="2728560">(</span><span class="ident" id="2728561">s</span><span class="op" id="2728562">)</span><span class="op" id="2728563">,</span>&nbsp;<span class="ident" id="2728565">nil</span><br>
<span class="lineno"></span><span class="op" id="2728569">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="keyword" id="2728572">type</span>&nbsp;<span class="ident" id="2728577">stringWriterIface</span>&nbsp;<span class="keyword" id="2728595">interface</span>&nbsp;<span class="op" id="2728605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2728608">WriteString</span><span class="op" id="2728619">(</span><span class="builtintype" id="2728620">string</span><span class="op" id="2728626">)</span>&nbsp;<span class="op" id="2728628">(</span><span class="builtintype" id="2728629">int</span><span class="op" id="2728632">,</span>&nbsp;<span class="builtintype" id="2728634">error</span><span class="op" id="2728639">)</span><br>
<span class="lineno"></span><span class="op" id="2728641">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span><span class="keyword" id="2728644">type</span>&nbsp;<span class="ident" id="2728649">stringWriter</span>&nbsp;<span class="keyword" id="2728662">struct</span>&nbsp;<span class="op" id="2728669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2728672">w</span>&nbsp;<span class="ident" id="2728674">io</span><span class="op" id="2728676">.</span><span class="ident" id="2728677">Writer</span><br>
<span class="lineno"></span><span class="op" id="2728684">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2728687">func</span>&nbsp;<span class="op" id="2728692">(</span><span class="ident" id="2728693">w</span>&nbsp;<span class="ident" id="2728695">stringWriter</span><span class="op" id="2728707">)</span>&nbsp;<span class="ident" id="2728709">WriteString</span><span class="op" id="2728720">(</span><span class="ident" id="2728721">s</span>&nbsp;<span class="builtintype" id="2728723">string</span><span class="op" id="2728729">)</span>&nbsp;<span class="op" id="2728731">(</span><span class="builtintype" id="2728732">int</span><span class="op" id="2728735">,</span>&nbsp;<span class="builtintype" id="2728737">error</span><span class="op" id="2728742">)</span>&nbsp;<span class="op" id="2728744">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2728747">return</span>&nbsp;<span class="ident" id="2728754">w</span><span class="op" id="2728755">.</span><span class="ident" id="2728756">w</span><span class="op" id="2728757">.</span><span class="ident" id="2728758">Write</span><span class="op" id="2728763">(</span><span class="op" id="2728764">[</span><span class="op" id="2728765">]</span><span class="builtintype" id="2728766">byte</span><span class="op" id="2728770">(</span><span class="ident" id="2728771">s</span><span class="op" id="2728772">)</span><span class="op" id="2728773">)</span><br>
<span class="lineno"></span><span class="op" id="2728775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2728778">func</span>&nbsp;<span class="ident" id="2728783">getStringWriter</span><span class="op" id="2728798">(</span><span class="ident" id="2728799">w</span>&nbsp;<span class="ident" id="2728801">io</span><span class="op" id="2728803">.</span><span class="ident" id="2728804">Writer</span><span class="op" id="2728810">)</span>&nbsp;<span class="ident" id="2728812">stringWriterIface</span>&nbsp;<span class="op" id="2728830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2728833">sw</span><span class="op" id="2728835">,</span>&nbsp;<span class="ident" id="2728837">ok</span>&nbsp;<span class="op" id="2728840">:=</span>&nbsp;<span class="ident" id="2728843">w</span><span class="op" id="2728844">.</span><span class="op" id="2728845">(</span><span class="ident" id="2728846">stringWriterIface</span><span class="op" id="2728863">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2728866">if</span>&nbsp;<span class="op" id="2728869">!</span><span class="ident" id="2728870">ok</span>&nbsp;<span class="op" id="2728873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2728877">sw</span>&nbsp;<span class="op" id="2728880">=</span>&nbsp;<span class="ident" id="2728882">stringWriter</span><span class="op" id="2728894">{</span><span class="ident" id="2728895">w</span><span class="op" id="2728896">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2728899">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2728902">return</span>&nbsp;<span class="ident" id="2728909">sw</span><br>
<span class="lineno"></span><span class="op" id="2728912">}</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span><span class="keyword" id="2728915">func</span>&nbsp;<span class="op" id="2728920">(</span><span class="ident" id="2728921">r</span>&nbsp;<span class="op" id="2728923">*</span><span class="ident" id="2728924">genericReplacer</span><span class="op" id="2728939">)</span>&nbsp;<span class="ident" id="2728941">Replace</span><span class="op" id="2728948">(</span><span class="ident" id="2728949">s</span>&nbsp;<span class="builtintype" id="2728951">string</span><span class="op" id="2728957">)</span>&nbsp;<span class="builtintype" id="2728959">string</span>&nbsp;<span class="op" id="2728966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2728969">buf</span>&nbsp;<span class="op" id="2728973">:=</span>&nbsp;<span class="builtinfunc" id="2728976">make</span><span class="op" id="2728980">(</span><span class="ident" id="2728981">appendSliceWriter</span><span class="op" id="2728998">,</span>&nbsp;<span class="num" id="2729000">0</span><span class="op" id="2729001">,</span>&nbsp;<span class="builtinfunc" id="2729003">len</span><span class="op" id="2729006">(</span><span class="ident" id="2729007">s</span><span class="op" id="2729008">)</span><span class="op" id="2729009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2729012">r</span><span class="op" id="2729013">.</span><span class="ident" id="2729014">WriteString</span><span class="op" id="2729025">(</span><span class="op" id="2729026">&amp;</span><span class="ident" id="2729027">buf</span><span class="op" id="2729030">,</span>&nbsp;<span class="ident" id="2729032">s</span><span class="op" id="2729033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2729036">return</span>&nbsp;<span class="builtintype" id="2729043">string</span><span class="op" id="2729049">(</span><span class="ident" id="2729050">buf</span><span class="op" id="2729053">)</span><br>
<span class="lineno">310</span><span class="op" id="2729055">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2729058">func</span>&nbsp;<span class="op" id="2729063">(</span><span class="ident" id="2729064">r</span>&nbsp;<span class="op" id="2729066">*</span><span class="ident" id="2729067">genericReplacer</span><span class="op" id="2729082">)</span>&nbsp;<span class="ident" id="2729084">WriteString</span><span class="op" id="2729095">(</span><span class="ident" id="2729096">w</span>&nbsp;<span class="ident" id="2729098">io</span><span class="op" id="2729100">.</span><span class="ident" id="2729101">Writer</span><span class="op" id="2729107">,</span>&nbsp;<span class="ident" id="2729109">s</span>&nbsp;<span class="builtintype" id="2729111">string</span><span class="op" id="2729117">)</span>&nbsp;<span class="op" id="2729119">(</span><span class="ident" id="2729120">n</span>&nbsp;<span class="builtintype" id="2729122">int</span><span class="op" id="2729125">,</span>&nbsp;<span class="ident" id="2729127">err</span>&nbsp;<span class="builtintype" id="2729131">error</span><span class="op" id="2729136">)</span>&nbsp;<span class="op" id="2729138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2729141">sw</span>&nbsp;<span class="op" id="2729144">:=</span>&nbsp;<span class="ident" id="2729147">getStringWriter</span><span class="op" id="2729162">(</span><span class="ident" id="2729163">w</span><span class="op" id="2729164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2729167">var</span>&nbsp;<span class="ident" id="2729171">last</span><span class="op" id="2729175">,</span>&nbsp;<span class="ident" id="2729177">wn</span>&nbsp;<span class="builtintype" id="2729180">int</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2729185">var</span>&nbsp;<span class="ident" id="2729189">prevMatchEmpty</span>&nbsp;<span class="builtintype" id="2729204">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2729210">for</span>&nbsp;<span class="ident" id="2729214">i</span>&nbsp;<span class="op" id="2729216">:=</span>&nbsp;<span class="num" id="2729219">0</span><span class="op" id="2729220">;</span>&nbsp;<span class="ident" id="2729222">i</span>&nbsp;<span class="op" id="2729224">&lt;=</span>&nbsp;<span class="builtinfunc" id="2729227">len</span><span class="op" id="2729230">(</span><span class="ident" id="2729231">s</span><span class="op" id="2729232">)</span><span class="op" id="2729233">;</span>&nbsp;<span class="op" id="2729235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2729239">//&nbsp;Fast&nbsp;path:&nbsp;s[i]&nbsp;is&nbsp;not&nbsp;a&nbsp;prefix&nbsp;of&nbsp;any&nbsp;pattern.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2729292">if</span>&nbsp;<span class="ident" id="2729295">i</span>&nbsp;<span class="op" id="2729297">!=</span>&nbsp;<span class="builtinfunc" id="2729300">len</span><span class="op" id="2729303">(</span><span class="ident" id="2729304">s</span><span class="op" id="2729305">)</span>&nbsp;<span class="op" id="2729307">&amp;&amp;</span>&nbsp;<span class="ident" id="2729310">r</span><span class="op" id="2729311">.</span><span class="ident" id="2729312">root</span><span class="op" id="2729316">.</span><span class="ident" id="2729317">priority</span>&nbsp;<span class="op" id="2729326">==</span>&nbsp;<span class="num" id="2729329">0</span>&nbsp;<span class="op" id="2729331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2729336">index</span>&nbsp;<span class="op" id="2729342">:=</span>&nbsp;<span class="builtintype" id="2729345">int</span><span class="op" id="2729348">(</span><span class="ident" id="2729349">r</span><span class="op" id="2729350">.</span><span class="ident" id="2729351">mapping</span><span class="op" id="2729358">[</span><span class="ident" id="2729359">s</span><span class="op" id="2729360">[</span><span class="ident" id="2729361">i</span><span class="op" id="2729362">]</span><span class="op" id="2729363">]</span><span class="op" id="2729364">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2729369">if</span>&nbsp;<span class="ident" id="2729372">index</span>&nbsp;<span class="op" id="2729378">==</span>&nbsp;<span class="ident" id="2729381">r</span><span class="op" id="2729382">.</span><span class="ident" id="2729383">tableSize</span>&nbsp;<span class="op" id="2729393">||</span>&nbsp;<span class="ident" id="2729396">r</span><span class="op" id="2729397">.</span><span class="ident" id="2729398">root</span><span class="op" id="2729402">.</span><span class="ident" id="2729403">table</span><span class="op" id="2729408">[</span><span class="ident" id="2729409">index</span><span class="op" id="2729414">]</span>&nbsp;<span class="op" id="2729416">==</span>&nbsp;<span class="ident" id="2729419">nil</span>&nbsp;<span class="op" id="2729423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2729429">i</span><span class="op" id="2729430">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2729437">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2729449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2729453">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2729458">//&nbsp;Ignore&nbsp;the&nbsp;empty&nbsp;match&nbsp;iff&nbsp;the&nbsp;previous&nbsp;loop&nbsp;found&nbsp;the&nbsp;empty&nbsp;match.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2729531">val</span><span class="op" id="2729534">,</span>&nbsp;<span class="ident" id="2729536">keylen</span><span class="op" id="2729542">,</span>&nbsp;<span class="ident" id="2729544">match</span>&nbsp;<span class="op" id="2729550">:=</span>&nbsp;<span class="ident" id="2729553">r</span><span class="op" id="2729554">.</span><span class="ident" id="2729555">lookup</span><span class="op" id="2729561">(</span><span class="ident" id="2729562">s</span><span class="op" id="2729563">[</span><span class="ident" id="2729564">i</span><span class="op" id="2729565">:</span><span class="op" id="2729566">]</span><span class="op" id="2729567">,</span>&nbsp;<span class="ident" id="2729569">prevMatchEmpty</span><span class="op" id="2729583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2729587">prevMatchEmpty</span>&nbsp;<span class="op" id="2729602">=</span>&nbsp;<span class="ident" id="2729604">match</span>&nbsp;<span class="op" id="2729610">&amp;&amp;</span>&nbsp;<span class="ident" id="2729613">keylen</span>&nbsp;<span class="op" id="2729620">==</span>&nbsp;<span class="num" id="2729623">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2729627">if</span>&nbsp;<span class="ident" id="2729630">match</span>&nbsp;<span class="op" id="2729636">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2729641">wn</span><span class="op" id="2729643">,</span>&nbsp;<span class="ident" id="2729645">err</span>&nbsp;<span class="op" id="2729649">=</span>&nbsp;<span class="ident" id="2729651">sw</span><span class="op" id="2729653">.</span><span class="ident" id="2729654">WriteString</span><span class="op" id="2729665">(</span><span class="ident" id="2729666">s</span><span class="op" id="2729667">[</span><span class="ident" id="2729668">last</span><span class="op" id="2729672">:</span><span class="ident" id="2729673">i</span><span class="op" id="2729674">]</span><span class="op" id="2729675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2729680">n</span>&nbsp;<span class="op" id="2729682">+=</span>&nbsp;<span class="ident" id="2729685">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2729691">if</span>&nbsp;<span class="ident" id="2729694">err</span>&nbsp;<span class="op" id="2729698">!=</span>&nbsp;<span class="ident" id="2729701">nil</span>&nbsp;<span class="op" id="2729705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2729711">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2729721">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2729726">wn</span><span class="op" id="2729728">,</span>&nbsp;<span class="ident" id="2729730">err</span>&nbsp;<span class="op" id="2729734">=</span>&nbsp;<span class="ident" id="2729736">sw</span><span class="op" id="2729738">.</span><span class="ident" id="2729739">WriteString</span><span class="op" id="2729750">(</span><span class="ident" id="2729751">val</span><span class="op" id="2729754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2729759">n</span>&nbsp;<span class="op" id="2729761">+=</span>&nbsp;<span class="ident" id="2729764">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2729770">if</span>&nbsp;<span class="ident" id="2729773">err</span>&nbsp;<span class="op" id="2729777">!=</span>&nbsp;<span class="ident" id="2729780">nil</span>&nbsp;<span class="op" id="2729784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2729790">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2729800">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2729805">i</span>&nbsp;<span class="op" id="2729807">+=</span>&nbsp;<span class="ident" id="2729810">keylen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2729820">last</span>&nbsp;<span class="op" id="2729825">=</span>&nbsp;<span class="ident" id="2729827">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2729832">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2729843">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2729847">i</span><span class="op" id="2729848">++</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2729852">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2729855">if</span>&nbsp;<span class="ident" id="2729858">last</span>&nbsp;<span class="op" id="2729863">!=</span>&nbsp;<span class="builtinfunc" id="2729866">len</span><span class="op" id="2729869">(</span><span class="ident" id="2729870">s</span><span class="op" id="2729871">)</span>&nbsp;<span class="op" id="2729873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2729877">wn</span><span class="op" id="2729879">,</span>&nbsp;<span class="ident" id="2729881">err</span>&nbsp;<span class="op" id="2729885">=</span>&nbsp;<span class="ident" id="2729887">sw</span><span class="op" id="2729889">.</span><span class="ident" id="2729890">WriteString</span><span class="op" id="2729901">(</span><span class="ident" id="2729902">s</span><span class="op" id="2729903">[</span><span class="ident" id="2729904">last</span><span class="op" id="2729908">:</span><span class="op" id="2729909">]</span><span class="op" id="2729910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2729914">n</span>&nbsp;<span class="op" id="2729916">+=</span>&nbsp;<span class="ident" id="2729919">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2729923">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2729926">return</span><br>
<span class="lineno"></span><span class="op" id="2729933">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2729936">//&nbsp;singleStringReplacer&nbsp;is&nbsp;the&nbsp;implementation&nbsp;that&#39;s&nbsp;used&nbsp;when&nbsp;there&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="2730013">//&nbsp;one&nbsp;string&nbsp;to&nbsp;replace&nbsp;(and&nbsp;that&nbsp;string&nbsp;has&nbsp;more&nbsp;than&nbsp;one&nbsp;byte).</span><br>
<span class="lineno">355</span><span class="keyword" id="2730080">type</span>&nbsp;<span class="ident" id="2730085">singleStringReplacer</span>&nbsp;<span class="keyword" id="2730106">struct</span>&nbsp;<span class="op" id="2730113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2730116">finder</span>&nbsp;<span class="op" id="2730123">*</span><span class="ident" id="2730124">stringFinder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2730138">//&nbsp;value&nbsp;is&nbsp;the&nbsp;new&nbsp;string&nbsp;that&nbsp;replaces&nbsp;that&nbsp;pattern&nbsp;when&nbsp;it&#39;s&nbsp;found.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2730210">value</span>&nbsp;<span class="builtintype" id="2730216">string</span><br>
<span class="lineno"></span><span class="op" id="2730223">}</span><br>
<span class="lineno">360</span><br>
<span class="lineno"></span><span class="keyword" id="2730226">func</span>&nbsp;<span class="ident" id="2730231">makeSingleStringReplacer</span><span class="op" id="2730255">(</span><span class="ident" id="2730256">pattern</span>&nbsp;<span class="builtintype" id="2730264">string</span><span class="op" id="2730270">,</span>&nbsp;<span class="ident" id="2730272">value</span>&nbsp;<span class="builtintype" id="2730278">string</span><span class="op" id="2730284">)</span>&nbsp;<span class="op" id="2730286">*</span><span class="ident" id="2730287">singleStringReplacer</span>&nbsp;<span class="op" id="2730308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2730311">return</span>&nbsp;<span class="op" id="2730318">&amp;</span><span class="ident" id="2730319">singleStringReplacer</span><span class="op" id="2730339">{</span><span class="ident" id="2730340">finder</span><span class="op" id="2730346">:</span>&nbsp;<span class="ident" id="2730348">makeStringFinder</span><span class="op" id="2730364">(</span><span class="ident" id="2730365">pattern</span><span class="op" id="2730372">)</span><span class="op" id="2730373">,</span>&nbsp;<span class="ident" id="2730375">value</span><span class="op" id="2730380">:</span>&nbsp;<span class="ident" id="2730382">value</span><span class="op" id="2730387">}</span><br>
<span class="lineno"></span><span class="op" id="2730389">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="keyword" id="2730392">func</span>&nbsp;<span class="op" id="2730397">(</span><span class="ident" id="2730398">r</span>&nbsp;<span class="op" id="2730400">*</span><span class="ident" id="2730401">singleStringReplacer</span><span class="op" id="2730421">)</span>&nbsp;<span class="ident" id="2730423">Replace</span><span class="op" id="2730430">(</span><span class="ident" id="2730431">s</span>&nbsp;<span class="builtintype" id="2730433">string</span><span class="op" id="2730439">)</span>&nbsp;<span class="builtintype" id="2730441">string</span>&nbsp;<span class="op" id="2730448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2730451">var</span>&nbsp;<span class="ident" id="2730455">buf</span>&nbsp;<span class="op" id="2730459">[</span><span class="op" id="2730460">]</span><span class="builtintype" id="2730461">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2730467">i</span><span class="op" id="2730468">,</span>&nbsp;<span class="ident" id="2730470">matched</span>&nbsp;<span class="op" id="2730478">:=</span>&nbsp;<span class="num" id="2730481">0</span><span class="op" id="2730482">,</span>&nbsp;<span class="ident" id="2730484">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2730491">for</span>&nbsp;<span class="op" id="2730495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2730499">match</span>&nbsp;<span class="op" id="2730505">:=</span>&nbsp;<span class="ident" id="2730508">r</span><span class="op" id="2730509">.</span><span class="ident" id="2730510">finder</span><span class="op" id="2730516">.</span><span class="ident" id="2730517">next</span><span class="op" id="2730521">(</span><span class="ident" id="2730522">s</span><span class="op" id="2730523">[</span><span class="ident" id="2730524">i</span><span class="op" id="2730525">:</span><span class="op" id="2730526">]</span><span class="op" id="2730527">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2730531">if</span>&nbsp;<span class="ident" id="2730534">match</span>&nbsp;<span class="op" id="2730540">==</span>&nbsp;<span class="op" id="2730543">-</span><span class="num" id="2730544">1</span>&nbsp;<span class="op" id="2730546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2730551">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2730559">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2730563">matched</span>&nbsp;<span class="op" id="2730571">=</span>&nbsp;<span class="ident" id="2730573">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2730580">buf</span>&nbsp;<span class="op" id="2730584">=</span>&nbsp;<span class="builtinfunc" id="2730586">append</span><span class="op" id="2730592">(</span><span class="ident" id="2730593">buf</span><span class="op" id="2730596">,</span>&nbsp;<span class="ident" id="2730598">s</span><span class="op" id="2730599">[</span><span class="ident" id="2730600">i</span><span class="op" id="2730601">:</span><span class="ident" id="2730602">i</span><span class="op" id="2730603">+</span><span class="ident" id="2730604">match</span><span class="op" id="2730609">]</span><span class="op" id="2730610">...</span><span class="op" id="2730613">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2730617">buf</span>&nbsp;<span class="op" id="2730621">=</span>&nbsp;<span class="builtinfunc" id="2730623">append</span><span class="op" id="2730629">(</span><span class="ident" id="2730630">buf</span><span class="op" id="2730633">,</span>&nbsp;<span class="ident" id="2730635">r</span><span class="op" id="2730636">.</span><span class="ident" id="2730637">value</span><span class="op" id="2730642">...</span><span class="op" id="2730645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2730649">i</span>&nbsp;<span class="op" id="2730651">+=</span>&nbsp;<span class="ident" id="2730654">match</span>&nbsp;<span class="op" id="2730660">+</span>&nbsp;<span class="builtinfunc" id="2730662">len</span><span class="op" id="2730665">(</span><span class="ident" id="2730666">r</span><span class="op" id="2730667">.</span><span class="ident" id="2730668">finder</span><span class="op" id="2730674">.</span><span class="ident" id="2730675">pattern</span><span class="op" id="2730682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2730685">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2730688">if</span>&nbsp;<span class="op" id="2730691">!</span><span class="ident" id="2730692">matched</span>&nbsp;<span class="op" id="2730700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2730704">return</span>&nbsp;<span class="ident" id="2730711">s</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2730714">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2730717">buf</span>&nbsp;<span class="op" id="2730721">=</span>&nbsp;<span class="builtinfunc" id="2730723">append</span><span class="op" id="2730729">(</span><span class="ident" id="2730730">buf</span><span class="op" id="2730733">,</span>&nbsp;<span class="ident" id="2730735">s</span><span class="op" id="2730736">[</span><span class="ident" id="2730737">i</span><span class="op" id="2730738">:</span><span class="op" id="2730739">]</span><span class="op" id="2730740">...</span><span class="op" id="2730743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2730746">return</span>&nbsp;<span class="builtintype" id="2730753">string</span><span class="op" id="2730759">(</span><span class="ident" id="2730760">buf</span><span class="op" id="2730763">)</span><br>
<span class="lineno"></span><span class="op" id="2730765">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span><span class="keyword" id="2730768">func</span>&nbsp;<span class="op" id="2730773">(</span><span class="ident" id="2730774">r</span>&nbsp;<span class="op" id="2730776">*</span><span class="ident" id="2730777">singleStringReplacer</span><span class="op" id="2730797">)</span>&nbsp;<span class="ident" id="2730799">WriteString</span><span class="op" id="2730810">(</span><span class="ident" id="2730811">w</span>&nbsp;<span class="ident" id="2730813">io</span><span class="op" id="2730815">.</span><span class="ident" id="2730816">Writer</span><span class="op" id="2730822">,</span>&nbsp;<span class="ident" id="2730824">s</span>&nbsp;<span class="builtintype" id="2730826">string</span><span class="op" id="2730832">)</span>&nbsp;<span class="op" id="2730834">(</span><span class="ident" id="2730835">n</span>&nbsp;<span class="builtintype" id="2730837">int</span><span class="op" id="2730840">,</span>&nbsp;<span class="ident" id="2730842">err</span>&nbsp;<span class="builtintype" id="2730846">error</span><span class="op" id="2730851">)</span>&nbsp;<span class="op" id="2730853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2730856">sw</span>&nbsp;<span class="op" id="2730859">:=</span>&nbsp;<span class="ident" id="2730862">getStringWriter</span><span class="op" id="2730877">(</span><span class="ident" id="2730878">w</span><span class="op" id="2730879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2730882">var</span>&nbsp;<span class="ident" id="2730886">i</span><span class="op" id="2730887">,</span>&nbsp;<span class="ident" id="2730889">wn</span>&nbsp;<span class="builtintype" id="2730892">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2730897">for</span>&nbsp;<span class="op" id="2730901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2730905">match</span>&nbsp;<span class="op" id="2730911">:=</span>&nbsp;<span class="ident" id="2730914">r</span><span class="op" id="2730915">.</span><span class="ident" id="2730916">finder</span><span class="op" id="2730922">.</span><span class="ident" id="2730923">next</span><span class="op" id="2730927">(</span><span class="ident" id="2730928">s</span><span class="op" id="2730929">[</span><span class="ident" id="2730930">i</span><span class="op" id="2730931">:</span><span class="op" id="2730932">]</span><span class="op" id="2730933">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2730937">if</span>&nbsp;<span class="ident" id="2730940">match</span>&nbsp;<span class="op" id="2730946">==</span>&nbsp;<span class="op" id="2730949">-</span><span class="num" id="2730950">1</span>&nbsp;<span class="op" id="2730952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2730957">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2730965">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2730969">wn</span><span class="op" id="2730971">,</span>&nbsp;<span class="ident" id="2730973">err</span>&nbsp;<span class="op" id="2730977">=</span>&nbsp;<span class="ident" id="2730979">sw</span><span class="op" id="2730981">.</span><span class="ident" id="2730982">WriteString</span><span class="op" id="2730993">(</span><span class="ident" id="2730994">s</span><span class="op" id="2730995">[</span><span class="ident" id="2730996">i</span>&nbsp;<span class="op" id="2730998">:</span>&nbsp;<span class="ident" id="2731000">i</span><span class="op" id="2731001">+</span><span class="ident" id="2731002">match</span><span class="op" id="2731007">]</span><span class="op" id="2731008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2731012">n</span>&nbsp;<span class="op" id="2731014">+=</span>&nbsp;<span class="ident" id="2731017">wn</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2731022">if</span>&nbsp;<span class="ident" id="2731025">err</span>&nbsp;<span class="op" id="2731029">!=</span>&nbsp;<span class="ident" id="2731032">nil</span>&nbsp;<span class="op" id="2731036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2731041">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2731050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2731054">wn</span><span class="op" id="2731056">,</span>&nbsp;<span class="ident" id="2731058">err</span>&nbsp;<span class="op" id="2731062">=</span>&nbsp;<span class="ident" id="2731064">sw</span><span class="op" id="2731066">.</span><span class="ident" id="2731067">WriteString</span><span class="op" id="2731078">(</span><span class="ident" id="2731079">r</span><span class="op" id="2731080">.</span><span class="ident" id="2731081">value</span><span class="op" id="2731086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2731090">n</span>&nbsp;<span class="op" id="2731092">+=</span>&nbsp;<span class="ident" id="2731095">wn</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2731100">if</span>&nbsp;<span class="ident" id="2731103">err</span>&nbsp;<span class="op" id="2731107">!=</span>&nbsp;<span class="ident" id="2731110">nil</span>&nbsp;<span class="op" id="2731114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2731119">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2731128">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2731132">i</span>&nbsp;<span class="op" id="2731134">+=</span>&nbsp;<span class="ident" id="2731137">match</span>&nbsp;<span class="op" id="2731143">+</span>&nbsp;<span class="builtinfunc" id="2731145">len</span><span class="op" id="2731148">(</span><span class="ident" id="2731149">r</span><span class="op" id="2731150">.</span><span class="ident" id="2731151">finder</span><span class="op" id="2731157">.</span><span class="ident" id="2731158">pattern</span><span class="op" id="2731165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2731168">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2731171">wn</span><span class="op" id="2731173">,</span>&nbsp;<span class="ident" id="2731175">err</span>&nbsp;<span class="op" id="2731179">=</span>&nbsp;<span class="ident" id="2731181">sw</span><span class="op" id="2731183">.</span><span class="ident" id="2731184">WriteString</span><span class="op" id="2731195">(</span><span class="ident" id="2731196">s</span><span class="op" id="2731197">[</span><span class="ident" id="2731198">i</span><span class="op" id="2731199">:</span><span class="op" id="2731200">]</span><span class="op" id="2731201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2731204">n</span>&nbsp;<span class="op" id="2731206">+=</span>&nbsp;<span class="ident" id="2731209">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2731213">return</span><br>
<span class="lineno"></span><span class="op" id="2731220">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="comment" id="2731223">//&nbsp;byteReplacer&nbsp;is&nbsp;the&nbsp;implementation&nbsp;that&#39;s&nbsp;used&nbsp;when&nbsp;all&nbsp;the&nbsp;&#34;old&#34;</span><br>
<span class="lineno"></span><span class="comment" id="2731292">//&nbsp;and&nbsp;&#34;new&#34;&nbsp;values&nbsp;are&nbsp;single&nbsp;ASCII&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="2731336">//&nbsp;The&nbsp;array&nbsp;contains&nbsp;replacement&nbsp;bytes&nbsp;indexed&nbsp;by&nbsp;old&nbsp;byte.</span><br>
<span class="lineno"></span><span class="keyword" id="2731397">type</span>&nbsp;<span class="ident" id="2731402">byteReplacer</span>&nbsp;<span class="op" id="2731415">[</span><span class="num" id="2731416">256</span><span class="op" id="2731419">]</span><span class="builtintype" id="2731420">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="keyword" id="2731426">func</span>&nbsp;<span class="op" id="2731431">(</span><span class="ident" id="2731432">r</span>&nbsp;<span class="op" id="2731434">*</span><span class="ident" id="2731435">byteReplacer</span><span class="op" id="2731447">)</span>&nbsp;<span class="ident" id="2731449">Replace</span><span class="op" id="2731456">(</span><span class="ident" id="2731457">s</span>&nbsp;<span class="builtintype" id="2731459">string</span><span class="op" id="2731465">)</span>&nbsp;<span class="builtintype" id="2731467">string</span>&nbsp;<span class="op" id="2731474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2731477">var</span>&nbsp;<span class="ident" id="2731481">buf</span>&nbsp;<span class="op" id="2731485">[</span><span class="op" id="2731486">]</span><span class="builtintype" id="2731487">byte</span>&nbsp;<span class="comment" id="2731492">//&nbsp;lazily&nbsp;allocated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2731513">for</span>&nbsp;<span class="ident" id="2731517">i</span>&nbsp;<span class="op" id="2731519">:=</span>&nbsp;<span class="num" id="2731522">0</span><span class="op" id="2731523">;</span>&nbsp;<span class="ident" id="2731525">i</span>&nbsp;<span class="op" id="2731527">&lt;</span>&nbsp;<span class="builtinfunc" id="2731529">len</span><span class="op" id="2731532">(</span><span class="ident" id="2731533">s</span><span class="op" id="2731534">)</span><span class="op" id="2731535">;</span>&nbsp;<span class="ident" id="2731537">i</span><span class="op" id="2731538">++</span>&nbsp;<span class="op" id="2731541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2731545">b</span>&nbsp;<span class="op" id="2731547">:=</span>&nbsp;<span class="ident" id="2731550">s</span><span class="op" id="2731551">[</span><span class="ident" id="2731552">i</span><span class="op" id="2731553">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2731557">if</span>&nbsp;<span class="ident" id="2731560">r</span><span class="op" id="2731561">[</span><span class="ident" id="2731562">b</span><span class="op" id="2731563">]</span>&nbsp;<span class="op" id="2731565">!=</span>&nbsp;<span class="ident" id="2731568">b</span>&nbsp;<span class="op" id="2731570">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2731575">if</span>&nbsp;<span class="ident" id="2731578">buf</span>&nbsp;<span class="op" id="2731582">==</span>&nbsp;<span class="ident" id="2731585">nil</span>&nbsp;<span class="op" id="2731589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2731595">buf</span>&nbsp;<span class="op" id="2731599">=</span>&nbsp;<span class="op" id="2731601">[</span><span class="op" id="2731602">]</span><span class="builtintype" id="2731603">byte</span><span class="op" id="2731607">(</span><span class="ident" id="2731608">s</span><span class="op" id="2731609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2731614">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2731619">buf</span><span class="op" id="2731622">[</span><span class="ident" id="2731623">i</span><span class="op" id="2731624">]</span>&nbsp;<span class="op" id="2731626">=</span>&nbsp;<span class="ident" id="2731628">r</span><span class="op" id="2731629">[</span><span class="ident" id="2731630">b</span><span class="op" id="2731631">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2731635">}</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2731638">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2731641">if</span>&nbsp;<span class="ident" id="2731644">buf</span>&nbsp;<span class="op" id="2731648">==</span>&nbsp;<span class="ident" id="2731651">nil</span>&nbsp;<span class="op" id="2731655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2731659">return</span>&nbsp;<span class="ident" id="2731666">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2731669">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2731672">return</span>&nbsp;<span class="builtintype" id="2731679">string</span><span class="op" id="2731685">(</span><span class="ident" id="2731686">buf</span><span class="op" id="2731689">)</span><br>
<span class="lineno">430</span><span class="op" id="2731691">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2731694">func</span>&nbsp;<span class="op" id="2731699">(</span><span class="ident" id="2731700">r</span>&nbsp;<span class="op" id="2731702">*</span><span class="ident" id="2731703">byteReplacer</span><span class="op" id="2731715">)</span>&nbsp;<span class="ident" id="2731717">WriteString</span><span class="op" id="2731728">(</span><span class="ident" id="2731729">w</span>&nbsp;<span class="ident" id="2731731">io</span><span class="op" id="2731733">.</span><span class="ident" id="2731734">Writer</span><span class="op" id="2731740">,</span>&nbsp;<span class="ident" id="2731742">s</span>&nbsp;<span class="builtintype" id="2731744">string</span><span class="op" id="2731750">)</span>&nbsp;<span class="op" id="2731752">(</span><span class="ident" id="2731753">n</span>&nbsp;<span class="builtintype" id="2731755">int</span><span class="op" id="2731758">,</span>&nbsp;<span class="ident" id="2731760">err</span>&nbsp;<span class="builtintype" id="2731764">error</span><span class="op" id="2731769">)</span>&nbsp;<span class="op" id="2731771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2731774">//&nbsp;TODO(bradfitz):&nbsp;use&nbsp;io.WriteString&nbsp;with&nbsp;slices&nbsp;of&nbsp;s,&nbsp;avoiding&nbsp;allocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2731852">bufsize</span>&nbsp;<span class="op" id="2731860">:=</span>&nbsp;<span class="num" id="2731863">32</span>&nbsp;<span class="op" id="2731866">&lt;&lt;</span>&nbsp;<span class="num" id="2731869">10</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2731873">if</span>&nbsp;<span class="builtinfunc" id="2731876">len</span><span class="op" id="2731879">(</span><span class="ident" id="2731880">s</span><span class="op" id="2731881">)</span>&nbsp;<span class="op" id="2731883">&lt;</span>&nbsp;<span class="ident" id="2731885">bufsize</span>&nbsp;<span class="op" id="2731893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2731897">bufsize</span>&nbsp;<span class="op" id="2731905">=</span>&nbsp;<span class="builtinfunc" id="2731907">len</span><span class="op" id="2731910">(</span><span class="ident" id="2731911">s</span><span class="op" id="2731912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2731915">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2731918">buf</span>&nbsp;<span class="op" id="2731922">:=</span>&nbsp;<span class="builtinfunc" id="2731925">make</span><span class="op" id="2731929">(</span><span class="op" id="2731930">[</span><span class="op" id="2731931">]</span><span class="builtintype" id="2731932">byte</span><span class="op" id="2731936">,</span>&nbsp;<span class="ident" id="2731938">bufsize</span><span class="op" id="2731945">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2731949">for</span>&nbsp;<span class="builtinfunc" id="2731953">len</span><span class="op" id="2731956">(</span><span class="ident" id="2731957">s</span><span class="op" id="2731958">)</span>&nbsp;<span class="op" id="2731960">&gt;</span>&nbsp;<span class="num" id="2731962">0</span>&nbsp;<span class="op" id="2731964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2731968">ncopy</span>&nbsp;<span class="op" id="2731974">:=</span>&nbsp;<span class="builtinfunc" id="2731977">copy</span><span class="op" id="2731981">(</span><span class="ident" id="2731982">buf</span><span class="op" id="2731985">,</span>&nbsp;<span class="ident" id="2731987">s</span><span class="op" id="2731988">[</span><span class="op" id="2731989">:</span><span class="op" id="2731990">]</span><span class="op" id="2731991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2731995">s</span>&nbsp;<span class="op" id="2731997">=</span>&nbsp;<span class="ident" id="2731999">s</span><span class="op" id="2732000">[</span><span class="ident" id="2732001">ncopy</span><span class="op" id="2732006">:</span><span class="op" id="2732007">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2732011">for</span>&nbsp;<span class="ident" id="2732015">i</span><span class="op" id="2732016">,</span>&nbsp;<span class="ident" id="2732018">b</span>&nbsp;<span class="op" id="2732020">:=</span>&nbsp;<span class="keyword" id="2732023">range</span>&nbsp;<span class="ident" id="2732029">buf</span><span class="op" id="2732032">[</span><span class="op" id="2732033">:</span><span class="ident" id="2732034">ncopy</span><span class="op" id="2732039">]</span>&nbsp;<span class="op" id="2732041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2732046">buf</span><span class="op" id="2732049">[</span><span class="ident" id="2732050">i</span><span class="op" id="2732051">]</span>&nbsp;<span class="op" id="2732053">=</span>&nbsp;<span class="ident" id="2732055">r</span><span class="op" id="2732056">[</span><span class="ident" id="2732057">b</span><span class="op" id="2732058">]</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2732062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2732066">wn</span><span class="op" id="2732068">,</span>&nbsp;<span class="ident" id="2732070">err</span>&nbsp;<span class="op" id="2732074">:=</span>&nbsp;<span class="ident" id="2732077">w</span><span class="op" id="2732078">.</span><span class="ident" id="2732079">Write</span><span class="op" id="2732084">(</span><span class="ident" id="2732085">buf</span><span class="op" id="2732088">[</span><span class="op" id="2732089">:</span><span class="ident" id="2732090">ncopy</span><span class="op" id="2732095">]</span><span class="op" id="2732096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2732100">n</span>&nbsp;<span class="op" id="2732102">+=</span>&nbsp;<span class="ident" id="2732105">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2732110">if</span>&nbsp;<span class="ident" id="2732113">err</span>&nbsp;<span class="op" id="2732117">!=</span>&nbsp;<span class="ident" id="2732120">nil</span>&nbsp;<span class="op" id="2732124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2732129">return</span>&nbsp;<span class="ident" id="2732136">n</span><span class="op" id="2732137">,</span>&nbsp;<span class="ident" id="2732139">err</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2732145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2732148">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2732151">return</span>&nbsp;<span class="ident" id="2732158">n</span><span class="op" id="2732159">,</span>&nbsp;<span class="ident" id="2732161">nil</span><br>
<span class="lineno"></span><span class="op" id="2732165">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span><span class="comment" id="2732168">//&nbsp;byteStringReplacer&nbsp;is&nbsp;the&nbsp;implementation&nbsp;that&#39;s&nbsp;used&nbsp;when&nbsp;all&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2732237">//&nbsp;&#34;old&#34;&nbsp;values&nbsp;are&nbsp;single&nbsp;ASCII&nbsp;bytes&nbsp;but&nbsp;the&nbsp;&#34;new&#34;&nbsp;values&nbsp;vary&nbsp;in&nbsp;size.</span><br>
<span class="lineno"></span><span class="comment" id="2732311">//&nbsp;The&nbsp;array&nbsp;contains&nbsp;replacement&nbsp;byte&nbsp;slices&nbsp;indexed&nbsp;by&nbsp;old&nbsp;byte.</span><br>
<span class="lineno"></span><span class="comment" id="2732378">//&nbsp;A&nbsp;nil&nbsp;[]byte&nbsp;means&nbsp;that&nbsp;the&nbsp;old&nbsp;byte&nbsp;should&nbsp;not&nbsp;be&nbsp;replaced.</span><br>
<span class="lineno"></span><span class="keyword" id="2732442">type</span>&nbsp;<span class="ident" id="2732447">byteStringReplacer</span>&nbsp;<span class="op" id="2732466">[</span><span class="num" id="2732467">256</span><span class="op" id="2732470">]</span><span class="op" id="2732471">[</span><span class="op" id="2732472">]</span><span class="builtintype" id="2732473">byte</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span><span class="keyword" id="2732479">func</span>&nbsp;<span class="op" id="2732484">(</span><span class="ident" id="2732485">r</span>&nbsp;<span class="op" id="2732487">*</span><span class="ident" id="2732488">byteStringReplacer</span><span class="op" id="2732506">)</span>&nbsp;<span class="ident" id="2732508">Replace</span><span class="op" id="2732515">(</span><span class="ident" id="2732516">s</span>&nbsp;<span class="builtintype" id="2732518">string</span><span class="op" id="2732524">)</span>&nbsp;<span class="builtintype" id="2732526">string</span>&nbsp;<span class="op" id="2732533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2732536">newSize</span>&nbsp;<span class="op" id="2732544">:=</span>&nbsp;<span class="builtinfunc" id="2732547">len</span><span class="op" id="2732550">(</span><span class="ident" id="2732551">s</span><span class="op" id="2732552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2732555">anyChanges</span>&nbsp;<span class="op" id="2732566">:=</span>&nbsp;<span class="ident" id="2732569">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2732576">for</span>&nbsp;<span class="ident" id="2732580">i</span>&nbsp;<span class="op" id="2732582">:=</span>&nbsp;<span class="num" id="2732585">0</span><span class="op" id="2732586">;</span>&nbsp;<span class="ident" id="2732588">i</span>&nbsp;<span class="op" id="2732590">&lt;</span>&nbsp;<span class="builtinfunc" id="2732592">len</span><span class="op" id="2732595">(</span><span class="ident" id="2732596">s</span><span class="op" id="2732597">)</span><span class="op" id="2732598">;</span>&nbsp;<span class="ident" id="2732600">i</span><span class="op" id="2732601">++</span>&nbsp;<span class="op" id="2732604">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2732608">b</span>&nbsp;<span class="op" id="2732610">:=</span>&nbsp;<span class="ident" id="2732613">s</span><span class="op" id="2732614">[</span><span class="ident" id="2732615">i</span><span class="op" id="2732616">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2732620">if</span>&nbsp;<span class="ident" id="2732623">r</span><span class="op" id="2732624">[</span><span class="ident" id="2732625">b</span><span class="op" id="2732626">]</span>&nbsp;<span class="op" id="2732628">!=</span>&nbsp;<span class="ident" id="2732631">nil</span>&nbsp;<span class="op" id="2732635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2732640">anyChanges</span>&nbsp;<span class="op" id="2732651">=</span>&nbsp;<span class="ident" id="2732653">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2732661">//&nbsp;The&nbsp;-1&nbsp;is&nbsp;because&nbsp;we&nbsp;are&nbsp;replacing&nbsp;1&nbsp;byte&nbsp;with&nbsp;len(r[b])&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2732731">newSize</span>&nbsp;<span class="op" id="2732739">+=</span>&nbsp;<span class="builtinfunc" id="2732742">len</span><span class="op" id="2732745">(</span><span class="ident" id="2732746">r</span><span class="op" id="2732747">[</span><span class="ident" id="2732748">b</span><span class="op" id="2732749">]</span><span class="op" id="2732750">)</span>&nbsp;<span class="op" id="2732752">-</span>&nbsp;<span class="num" id="2732754">1</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2732758">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2732761">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2732764">if</span>&nbsp;<span class="op" id="2732767">!</span><span class="ident" id="2732768">anyChanges</span>&nbsp;<span class="op" id="2732779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2732783">return</span>&nbsp;<span class="ident" id="2732790">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2732793">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2732796">buf</span>&nbsp;<span class="op" id="2732800">:=</span>&nbsp;<span class="builtinfunc" id="2732803">make</span><span class="op" id="2732807">(</span><span class="op" id="2732808">[</span><span class="op" id="2732809">]</span><span class="builtintype" id="2732810">byte</span><span class="op" id="2732814">,</span>&nbsp;<span class="ident" id="2732816">newSize</span><span class="op" id="2732823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2732826">bi</span>&nbsp;<span class="op" id="2732829">:=</span>&nbsp;<span class="ident" id="2732832">buf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2732837">for</span>&nbsp;<span class="ident" id="2732841">i</span>&nbsp;<span class="op" id="2732843">:=</span>&nbsp;<span class="num" id="2732846">0</span><span class="op" id="2732847">;</span>&nbsp;<span class="ident" id="2732849">i</span>&nbsp;<span class="op" id="2732851">&lt;</span>&nbsp;<span class="builtinfunc" id="2732853">len</span><span class="op" id="2732856">(</span><span class="ident" id="2732857">s</span><span class="op" id="2732858">)</span><span class="op" id="2732859">;</span>&nbsp;<span class="ident" id="2732861">i</span><span class="op" id="2732862">++</span>&nbsp;<span class="op" id="2732865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2732869">b</span>&nbsp;<span class="op" id="2732871">:=</span>&nbsp;<span class="ident" id="2732874">s</span><span class="op" id="2732875">[</span><span class="ident" id="2732876">i</span><span class="op" id="2732877">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2732881">if</span>&nbsp;<span class="ident" id="2732884">r</span><span class="op" id="2732885">[</span><span class="ident" id="2732886">b</span><span class="op" id="2732887">]</span>&nbsp;<span class="op" id="2732889">!=</span>&nbsp;<span class="ident" id="2732892">nil</span>&nbsp;<span class="op" id="2732896">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2732901">n</span>&nbsp;<span class="op" id="2732903">:=</span>&nbsp;<span class="builtinfunc" id="2732906">copy</span><span class="op" id="2732910">(</span><span class="ident" id="2732911">bi</span><span class="op" id="2732913">,</span>&nbsp;<span class="ident" id="2732915">r</span><span class="op" id="2732916">[</span><span class="ident" id="2732917">b</span><span class="op" id="2732918">]</span><span class="op" id="2732919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2732924">bi</span>&nbsp;<span class="op" id="2732927">=</span>&nbsp;<span class="ident" id="2732929">bi</span><span class="op" id="2732931">[</span><span class="ident" id="2732932">n</span><span class="op" id="2732933">:</span><span class="op" id="2732934">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2732938">}</span>&nbsp;<span class="keyword" id="2732940">else</span>&nbsp;<span class="op" id="2732945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2732950">bi</span><span class="op" id="2732952">[</span><span class="num" id="2732953">0</span><span class="op" id="2732954">]</span>&nbsp;<span class="op" id="2732956">=</span>&nbsp;<span class="ident" id="2732958">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2732963">bi</span>&nbsp;<span class="op" id="2732966">=</span>&nbsp;<span class="ident" id="2732968">bi</span><span class="op" id="2732970">[</span><span class="num" id="2732971">1</span><span class="op" id="2732972">:</span><span class="op" id="2732973">]</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2732977">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2732980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2732983">return</span>&nbsp;<span class="builtintype" id="2732990">string</span><span class="op" id="2732996">(</span><span class="ident" id="2732997">buf</span><span class="op" id="2733000">)</span><br>
<span class="lineno"></span><span class="op" id="2733002">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">490</span><span class="keyword" id="2733005">func</span>&nbsp;<span class="op" id="2733010">(</span><span class="ident" id="2733011">r</span>&nbsp;<span class="op" id="2733013">*</span><span class="ident" id="2733014">byteStringReplacer</span><span class="op" id="2733032">)</span>&nbsp;<span class="ident" id="2733034">WriteString</span><span class="op" id="2733045">(</span><span class="ident" id="2733046">w</span>&nbsp;<span class="ident" id="2733048">io</span><span class="op" id="2733050">.</span><span class="ident" id="2733051">Writer</span><span class="op" id="2733057">,</span>&nbsp;<span class="ident" id="2733059">s</span>&nbsp;<span class="builtintype" id="2733061">string</span><span class="op" id="2733067">)</span>&nbsp;<span class="op" id="2733069">(</span><span class="ident" id="2733070">n</span>&nbsp;<span class="builtintype" id="2733072">int</span><span class="op" id="2733075">,</span>&nbsp;<span class="ident" id="2733077">err</span>&nbsp;<span class="builtintype" id="2733081">error</span><span class="op" id="2733086">)</span>&nbsp;<span class="op" id="2733088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2733091">sw</span>&nbsp;<span class="op" id="2733094">:=</span>&nbsp;<span class="ident" id="2733097">getStringWriter</span><span class="op" id="2733112">(</span><span class="ident" id="2733113">w</span><span class="op" id="2733114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2733117">last</span>&nbsp;<span class="op" id="2733122">:=</span>&nbsp;<span class="num" id="2733125">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2733128">for</span>&nbsp;<span class="ident" id="2733132">i</span>&nbsp;<span class="op" id="2733134">:=</span>&nbsp;<span class="num" id="2733137">0</span><span class="op" id="2733138">;</span>&nbsp;<span class="ident" id="2733140">i</span>&nbsp;<span class="op" id="2733142">&lt;</span>&nbsp;<span class="builtinfunc" id="2733144">len</span><span class="op" id="2733147">(</span><span class="ident" id="2733148">s</span><span class="op" id="2733149">)</span><span class="op" id="2733150">;</span>&nbsp;<span class="ident" id="2733152">i</span><span class="op" id="2733153">++</span>&nbsp;<span class="op" id="2733156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2733160">b</span>&nbsp;<span class="op" id="2733162">:=</span>&nbsp;<span class="ident" id="2733165">s</span><span class="op" id="2733166">[</span><span class="ident" id="2733167">i</span><span class="op" id="2733168">]</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2733172">if</span>&nbsp;<span class="ident" id="2733175">r</span><span class="op" id="2733176">[</span><span class="ident" id="2733177">b</span><span class="op" id="2733178">]</span>&nbsp;<span class="op" id="2733180">==</span>&nbsp;<span class="ident" id="2733183">nil</span>&nbsp;<span class="op" id="2733187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2733192">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2733203">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2733207">if</span>&nbsp;<span class="ident" id="2733210">last</span>&nbsp;<span class="op" id="2733215">!=</span>&nbsp;<span class="ident" id="2733218">i</span>&nbsp;<span class="op" id="2733220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2733225">nw</span><span class="op" id="2733227">,</span>&nbsp;<span class="ident" id="2733229">err</span>&nbsp;<span class="op" id="2733233">:=</span>&nbsp;<span class="ident" id="2733236">sw</span><span class="op" id="2733238">.</span><span class="ident" id="2733239">WriteString</span><span class="op" id="2733250">(</span><span class="ident" id="2733251">s</span><span class="op" id="2733252">[</span><span class="ident" id="2733253">last</span><span class="op" id="2733257">:</span><span class="ident" id="2733258">i</span><span class="op" id="2733259">]</span><span class="op" id="2733260">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2733265">n</span>&nbsp;<span class="op" id="2733267">+=</span>&nbsp;<span class="ident" id="2733270">nw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2733276">if</span>&nbsp;<span class="ident" id="2733279">err</span>&nbsp;<span class="op" id="2733283">!=</span>&nbsp;<span class="ident" id="2733286">nil</span>&nbsp;<span class="op" id="2733290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2733296">return</span>&nbsp;<span class="ident" id="2733303">n</span><span class="op" id="2733304">,</span>&nbsp;<span class="ident" id="2733306">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2733313">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2733317">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2733321">last</span>&nbsp;<span class="op" id="2733326">=</span>&nbsp;<span class="ident" id="2733328">i</span>&nbsp;<span class="op" id="2733330">+</span>&nbsp;<span class="num" id="2733332">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2733336">nw</span><span class="op" id="2733338">,</span>&nbsp;<span class="ident" id="2733340">err</span>&nbsp;<span class="op" id="2733344">:=</span>&nbsp;<span class="ident" id="2733347">w</span><span class="op" id="2733348">.</span><span class="ident" id="2733349">Write</span><span class="op" id="2733354">(</span><span class="ident" id="2733355">r</span><span class="op" id="2733356">[</span><span class="ident" id="2733357">b</span><span class="op" id="2733358">]</span><span class="op" id="2733359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2733363">n</span>&nbsp;<span class="op" id="2733365">+=</span>&nbsp;<span class="ident" id="2733368">nw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2733373">if</span>&nbsp;<span class="ident" id="2733376">err</span>&nbsp;<span class="op" id="2733380">!=</span>&nbsp;<span class="ident" id="2733383">nil</span>&nbsp;<span class="op" id="2733387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2733392">return</span>&nbsp;<span class="ident" id="2733399">n</span><span class="op" id="2733400">,</span>&nbsp;<span class="ident" id="2733402">err</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2733408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2733411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2733414">if</span>&nbsp;<span class="ident" id="2733417">last</span>&nbsp;<span class="op" id="2733422">!=</span>&nbsp;<span class="builtinfunc" id="2733425">len</span><span class="op" id="2733428">(</span><span class="ident" id="2733429">s</span><span class="op" id="2733430">)</span>&nbsp;<span class="op" id="2733432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2733436">var</span>&nbsp;<span class="ident" id="2733440">nw</span>&nbsp;<span class="builtintype" id="2733443">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2733449">nw</span><span class="op" id="2733451">,</span>&nbsp;<span class="ident" id="2733453">err</span>&nbsp;<span class="op" id="2733457">=</span>&nbsp;<span class="ident" id="2733459">sw</span><span class="op" id="2733461">.</span><span class="ident" id="2733462">WriteString</span><span class="op" id="2733473">(</span><span class="ident" id="2733474">s</span><span class="op" id="2733475">[</span><span class="ident" id="2733476">last</span><span class="op" id="2733480">:</span><span class="op" id="2733481">]</span><span class="op" id="2733482">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2733486">n</span>&nbsp;<span class="op" id="2733488">+=</span>&nbsp;<span class="ident" id="2733491">nw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2733495">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2733498">return</span><br>
<span class="lineno"></span><span class="op" id="2733505">}</span>
</div>
</body>
</html>
