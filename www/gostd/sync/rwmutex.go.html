<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1788407">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1788462">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1788516">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1788567">package</span>&nbsp;<span class="ident" id="1788575">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1788581">import</span>&nbsp;<span class="op" id="1788588">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1788591">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1788606">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><span class="op" id="1788615">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1788618">//&nbsp;An&nbsp;RWMutex&nbsp;is&nbsp;a&nbsp;reader/writer&nbsp;mutual&nbsp;exclusion&nbsp;lock.</span><br>
<span class="lineno"></span><span class="comment" id="1788674">//&nbsp;The&nbsp;lock&nbsp;can&nbsp;be&nbsp;held&nbsp;by&nbsp;an&nbsp;arbitrary&nbsp;number&nbsp;of&nbsp;readers</span><br>
<span class="lineno"></span><span class="comment" id="1788732">//&nbsp;or&nbsp;a&nbsp;single&nbsp;writer.</span><br>
<span class="lineno">15</span><span class="comment" id="1788755">//&nbsp;RWMutexes&nbsp;can&nbsp;be&nbsp;created&nbsp;as&nbsp;part&nbsp;of&nbsp;other</span><br>
<span class="lineno"></span><span class="comment" id="1788800">//&nbsp;structures;&nbsp;the&nbsp;zero&nbsp;value&nbsp;for&nbsp;a&nbsp;RWMutex&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1788847">//&nbsp;an&nbsp;unlocked&nbsp;mutex.</span><br>
<span class="lineno"></span><span class="keyword" id="1788869">type</span>&nbsp;<span class="ident" id="1788874">RWMutex</span>&nbsp;<span class="keyword" id="1788882">struct</span>&nbsp;<span class="op" id="1788889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1788892">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1788904">Mutex</span>&nbsp;&nbsp;<span class="comment" id="1788911">//&nbsp;held&nbsp;if&nbsp;there&nbsp;are&nbsp;pending&nbsp;writers</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1788949">writerSem</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1788961">uint32</span>&nbsp;<span class="comment" id="1788968">//&nbsp;semaphore&nbsp;for&nbsp;writers&nbsp;to&nbsp;wait&nbsp;for&nbsp;completing&nbsp;readers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1789025">readerSem</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1789037">uint32</span>&nbsp;<span class="comment" id="1789044">//&nbsp;semaphore&nbsp;for&nbsp;readers&nbsp;to&nbsp;wait&nbsp;for&nbsp;completing&nbsp;writers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1789101">readerCount</span>&nbsp;<span class="builtintype" id="1789113">int32</span>&nbsp;&nbsp;<span class="comment" id="1789120">//&nbsp;number&nbsp;of&nbsp;pending&nbsp;readers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1789150">readerWait</span>&nbsp;&nbsp;<span class="builtintype" id="1789162">int32</span>&nbsp;&nbsp;<span class="comment" id="1789169">//&nbsp;number&nbsp;of&nbsp;departing&nbsp;readers</span><br>
<span class="lineno"></span><span class="op" id="1789200">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="1789203">const</span>&nbsp;<span class="ident" id="1789209">rwmutexMaxReaders</span>&nbsp;<span class="op" id="1789227">=</span>&nbsp;<span class="num" id="1789229">1</span>&nbsp;<span class="op" id="1789231">&lt;&lt;</span>&nbsp;<span class="num" id="1789234">30</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1789238">//&nbsp;RLock&nbsp;locks&nbsp;rw&nbsp;for&nbsp;reading.</span><br>
<span class="lineno"></span><span class="keyword" id="1789269">func</span>&nbsp;<span class="op" id="1789274">(</span><span class="ident" id="1789275">rw</span>&nbsp;<span class="op" id="1789278">*</span><span class="ident" id="1789279">RWMutex</span><span class="op" id="1789286">)</span>&nbsp;<span class="ident" id="1789288">RLock</span><span class="op" id="1789293">(</span><span class="op" id="1789294">)</span>&nbsp;<span class="op" id="1789296">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1789299">if</span>&nbsp;<span class="ident" id="1789302">raceenabled</span>&nbsp;<span class="op" id="1789314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1789318">_</span>&nbsp;<span class="op" id="1789320">=</span>&nbsp;<span class="ident" id="1789322">rw</span><span class="op" id="1789324">.</span><span class="ident" id="1789325">w</span><span class="op" id="1789326">.</span><span class="ident" id="1789327">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1789335">raceDisable</span><span class="op" id="1789346">(</span><span class="op" id="1789347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1789350">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1789353">if</span>&nbsp;<span class="ident" id="1789356">atomic</span><span class="op" id="1789362">.</span><span class="ident" id="1789363">AddInt32</span><span class="op" id="1789371">(</span><span class="op" id="1789372">&amp;</span><span class="ident" id="1789373">rw</span><span class="op" id="1789375">.</span><span class="ident" id="1789376">readerCount</span><span class="op" id="1789387">,</span>&nbsp;<span class="num" id="1789389">1</span><span class="op" id="1789390">)</span>&nbsp;<span class="op" id="1789392">&lt;</span>&nbsp;<span class="num" id="1789394">0</span>&nbsp;<span class="op" id="1789396">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1789400">//&nbsp;A&nbsp;writer&nbsp;is&nbsp;pending,&nbsp;wait&nbsp;for&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1789439">runtime_Semacquire</span><span class="op" id="1789457">(</span><span class="op" id="1789458">&amp;</span><span class="ident" id="1789459">rw</span><span class="op" id="1789461">.</span><span class="ident" id="1789462">readerSem</span><span class="op" id="1789471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1789474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1789477">if</span>&nbsp;<span class="ident" id="1789480">raceenabled</span>&nbsp;<span class="op" id="1789492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1789496">raceEnable</span><span class="op" id="1789506">(</span><span class="op" id="1789507">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1789511">raceAcquire</span><span class="op" id="1789522">(</span><span class="ident" id="1789523">unsafe</span><span class="op" id="1789529">.</span><span class="ident" id="1789530">Pointer</span><span class="op" id="1789537">(</span><span class="op" id="1789538">&amp;</span><span class="ident" id="1789539">rw</span><span class="op" id="1789541">.</span><span class="ident" id="1789542">readerSem</span><span class="op" id="1789551">)</span><span class="op" id="1789552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1789555">}</span><br>
<span class="lineno"></span><span class="op" id="1789557">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1789560">//&nbsp;RUnlock&nbsp;undoes&nbsp;a&nbsp;single&nbsp;RLock&nbsp;call;</span><br>
<span class="lineno">45</span><span class="comment" id="1789599">//&nbsp;it&nbsp;does&nbsp;not&nbsp;affect&nbsp;other&nbsp;simultaneous&nbsp;readers.</span><br>
<span class="lineno"></span><span class="comment" id="1789649">//&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error&nbsp;if&nbsp;rw&nbsp;is&nbsp;not&nbsp;locked&nbsp;for&nbsp;reading</span><br>
<span class="lineno"></span><span class="comment" id="1789707">//&nbsp;on&nbsp;entry&nbsp;to&nbsp;RUnlock.</span><br>
<span class="lineno"></span><span class="keyword" id="1789731">func</span>&nbsp;<span class="op" id="1789736">(</span><span class="ident" id="1789737">rw</span>&nbsp;<span class="op" id="1789740">*</span><span class="ident" id="1789741">RWMutex</span><span class="op" id="1789748">)</span>&nbsp;<span class="ident" id="1789750">RUnlock</span><span class="op" id="1789757">(</span><span class="op" id="1789758">)</span>&nbsp;<span class="op" id="1789760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1789763">if</span>&nbsp;<span class="ident" id="1789766">raceenabled</span>&nbsp;<span class="op" id="1789778">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1789782">_</span>&nbsp;<span class="op" id="1789784">=</span>&nbsp;<span class="ident" id="1789786">rw</span><span class="op" id="1789788">.</span><span class="ident" id="1789789">w</span><span class="op" id="1789790">.</span><span class="ident" id="1789791">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1789799">raceReleaseMerge</span><span class="op" id="1789815">(</span><span class="ident" id="1789816">unsafe</span><span class="op" id="1789822">.</span><span class="ident" id="1789823">Pointer</span><span class="op" id="1789830">(</span><span class="op" id="1789831">&amp;</span><span class="ident" id="1789832">rw</span><span class="op" id="1789834">.</span><span class="ident" id="1789835">writerSem</span><span class="op" id="1789844">)</span><span class="op" id="1789845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1789849">raceDisable</span><span class="op" id="1789860">(</span><span class="op" id="1789861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1789864">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1789867">if</span>&nbsp;<span class="ident" id="1789870">r</span>&nbsp;<span class="op" id="1789872">:=</span>&nbsp;<span class="ident" id="1789875">atomic</span><span class="op" id="1789881">.</span><span class="ident" id="1789882">AddInt32</span><span class="op" id="1789890">(</span><span class="op" id="1789891">&amp;</span><span class="ident" id="1789892">rw</span><span class="op" id="1789894">.</span><span class="ident" id="1789895">readerCount</span><span class="op" id="1789906">,</span>&nbsp;<span class="op" id="1789908">-</span><span class="num" id="1789909">1</span><span class="op" id="1789910">)</span><span class="op" id="1789911">;</span>&nbsp;<span class="ident" id="1789913">r</span>&nbsp;<span class="op" id="1789915">&lt;</span>&nbsp;<span class="num" id="1789917">0</span>&nbsp;<span class="op" id="1789919">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1789923">if</span>&nbsp;<span class="ident" id="1789926">r</span><span class="op" id="1789927">+</span><span class="num" id="1789928">1</span>&nbsp;<span class="op" id="1789930">==</span>&nbsp;<span class="num" id="1789933">0</span>&nbsp;<span class="op" id="1789935">||</span>&nbsp;<span class="ident" id="1789938">r</span><span class="op" id="1789939">+</span><span class="num" id="1789940">1</span>&nbsp;<span class="op" id="1789942">==</span>&nbsp;<span class="op" id="1789945">-</span><span class="ident" id="1789946">rwmutexMaxReaders</span>&nbsp;<span class="op" id="1789964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1789969">raceEnable</span><span class="op" id="1789979">(</span><span class="op" id="1789980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1789985">panic</span><span class="op" id="1789990">(</span><span class="string" id="1789991">&#34;sync:&nbsp;RUnlock&nbsp;of&nbsp;unlocked&nbsp;RWMutex&#34;</span><span class="op" id="1790026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1790030">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1790034">//&nbsp;A&nbsp;writer&nbsp;is&nbsp;pending.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1790060">if</span>&nbsp;<span class="ident" id="1790063">atomic</span><span class="op" id="1790069">.</span><span class="ident" id="1790070">AddInt32</span><span class="op" id="1790078">(</span><span class="op" id="1790079">&amp;</span><span class="ident" id="1790080">rw</span><span class="op" id="1790082">.</span><span class="ident" id="1790083">readerWait</span><span class="op" id="1790093">,</span>&nbsp;<span class="op" id="1790095">-</span><span class="num" id="1790096">1</span><span class="op" id="1790097">)</span>&nbsp;<span class="op" id="1790099">==</span>&nbsp;<span class="num" id="1790102">0</span>&nbsp;<span class="op" id="1790104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1790109">//&nbsp;The&nbsp;last&nbsp;reader&nbsp;unblocks&nbsp;the&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1790152">runtime_Semrelease</span><span class="op" id="1790170">(</span><span class="op" id="1790171">&amp;</span><span class="ident" id="1790172">rw</span><span class="op" id="1790174">.</span><span class="ident" id="1790175">writerSem</span><span class="op" id="1790184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1790188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1790191">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1790194">if</span>&nbsp;<span class="ident" id="1790197">raceenabled</span>&nbsp;<span class="op" id="1790209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1790213">raceEnable</span><span class="op" id="1790223">(</span><span class="op" id="1790224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1790227">}</span><br>
<span class="lineno"></span><span class="op" id="1790229">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="comment" id="1790232">//&nbsp;Lock&nbsp;locks&nbsp;rw&nbsp;for&nbsp;writing.</span><br>
<span class="lineno"></span><span class="comment" id="1790262">//&nbsp;If&nbsp;the&nbsp;lock&nbsp;is&nbsp;already&nbsp;locked&nbsp;for&nbsp;reading&nbsp;or&nbsp;writing,</span><br>
<span class="lineno"></span><span class="comment" id="1790319">//&nbsp;Lock&nbsp;blocks&nbsp;until&nbsp;the&nbsp;lock&nbsp;is&nbsp;available.</span><br>
<span class="lineno"></span><span class="comment" id="1790363">//&nbsp;To&nbsp;ensure&nbsp;that&nbsp;the&nbsp;lock&nbsp;eventually&nbsp;becomes&nbsp;available,</span><br>
<span class="lineno"></span><span class="comment" id="1790420">//&nbsp;a&nbsp;blocked&nbsp;Lock&nbsp;call&nbsp;excludes&nbsp;new&nbsp;readers&nbsp;from&nbsp;acquiring</span><br>
<span class="lineno">75</span><span class="comment" id="1790479">//&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="keyword" id="1790492">func</span>&nbsp;<span class="op" id="1790497">(</span><span class="ident" id="1790498">rw</span>&nbsp;<span class="op" id="1790501">*</span><span class="ident" id="1790502">RWMutex</span><span class="op" id="1790509">)</span>&nbsp;<span class="ident" id="1790511">Lock</span><span class="op" id="1790515">(</span><span class="op" id="1790516">)</span>&nbsp;<span class="op" id="1790518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1790521">if</span>&nbsp;<span class="ident" id="1790524">raceenabled</span>&nbsp;<span class="op" id="1790536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1790540">_</span>&nbsp;<span class="op" id="1790542">=</span>&nbsp;<span class="ident" id="1790544">rw</span><span class="op" id="1790546">.</span><span class="ident" id="1790547">w</span><span class="op" id="1790548">.</span><span class="ident" id="1790549">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1790557">raceDisable</span><span class="op" id="1790568">(</span><span class="op" id="1790569">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1790572">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1790575">//&nbsp;First,&nbsp;resolve&nbsp;competition&nbsp;with&nbsp;other&nbsp;writers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1790626">rw</span><span class="op" id="1790628">.</span><span class="ident" id="1790629">w</span><span class="op" id="1790630">.</span><span class="ident" id="1790631">Lock</span><span class="op" id="1790635">(</span><span class="op" id="1790636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1790639">//&nbsp;Announce&nbsp;to&nbsp;readers&nbsp;there&nbsp;is&nbsp;a&nbsp;pending&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1790690">r</span>&nbsp;<span class="op" id="1790692">:=</span>&nbsp;<span class="ident" id="1790695">atomic</span><span class="op" id="1790701">.</span><span class="ident" id="1790702">AddInt32</span><span class="op" id="1790710">(</span><span class="op" id="1790711">&amp;</span><span class="ident" id="1790712">rw</span><span class="op" id="1790714">.</span><span class="ident" id="1790715">readerCount</span><span class="op" id="1790726">,</span>&nbsp;<span class="op" id="1790728">-</span><span class="ident" id="1790729">rwmutexMaxReaders</span><span class="op" id="1790746">)</span>&nbsp;<span class="op" id="1790748">+</span>&nbsp;<span class="ident" id="1790750">rwmutexMaxReaders</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1790769">//&nbsp;Wait&nbsp;for&nbsp;active&nbsp;readers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1790798">if</span>&nbsp;<span class="ident" id="1790801">r</span>&nbsp;<span class="op" id="1790803">!=</span>&nbsp;<span class="num" id="1790806">0</span>&nbsp;<span class="op" id="1790808">&amp;&amp;</span>&nbsp;<span class="ident" id="1790811">atomic</span><span class="op" id="1790817">.</span><span class="ident" id="1790818">AddInt32</span><span class="op" id="1790826">(</span><span class="op" id="1790827">&amp;</span><span class="ident" id="1790828">rw</span><span class="op" id="1790830">.</span><span class="ident" id="1790831">readerWait</span><span class="op" id="1790841">,</span>&nbsp;<span class="ident" id="1790843">r</span><span class="op" id="1790844">)</span>&nbsp;<span class="op" id="1790846">!=</span>&nbsp;<span class="num" id="1790849">0</span>&nbsp;<span class="op" id="1790851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1790855">runtime_Semacquire</span><span class="op" id="1790873">(</span><span class="op" id="1790874">&amp;</span><span class="ident" id="1790875">rw</span><span class="op" id="1790877">.</span><span class="ident" id="1790878">writerSem</span><span class="op" id="1790887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1790890">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1790893">if</span>&nbsp;<span class="ident" id="1790896">raceenabled</span>&nbsp;<span class="op" id="1790908">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1790912">raceEnable</span><span class="op" id="1790922">(</span><span class="op" id="1790923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1790927">raceAcquire</span><span class="op" id="1790938">(</span><span class="ident" id="1790939">unsafe</span><span class="op" id="1790945">.</span><span class="ident" id="1790946">Pointer</span><span class="op" id="1790953">(</span><span class="op" id="1790954">&amp;</span><span class="ident" id="1790955">rw</span><span class="op" id="1790957">.</span><span class="ident" id="1790958">readerSem</span><span class="op" id="1790967">)</span><span class="op" id="1790968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1790972">raceAcquire</span><span class="op" id="1790983">(</span><span class="ident" id="1790984">unsafe</span><span class="op" id="1790990">.</span><span class="ident" id="1790991">Pointer</span><span class="op" id="1790998">(</span><span class="op" id="1790999">&amp;</span><span class="ident" id="1791000">rw</span><span class="op" id="1791002">.</span><span class="ident" id="1791003">writerSem</span><span class="op" id="1791012">)</span><span class="op" id="1791013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1791016">}</span><br>
<span class="lineno"></span><span class="op" id="1791018">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="1791021">//&nbsp;Unlock&nbsp;unlocks&nbsp;rw&nbsp;for&nbsp;writing.&nbsp;&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error&nbsp;if&nbsp;rw&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1791088">//&nbsp;not&nbsp;locked&nbsp;for&nbsp;writing&nbsp;on&nbsp;entry&nbsp;to&nbsp;Unlock.</span><br>
<span class="lineno"></span><span class="comment" id="1791134">//</span><br>
<span class="lineno"></span><span class="comment" id="1791137">//&nbsp;As&nbsp;with&nbsp;Mutexes,&nbsp;a&nbsp;locked&nbsp;RWMutex&nbsp;is&nbsp;not&nbsp;associated&nbsp;with&nbsp;a&nbsp;particular</span><br>
<span class="lineno">100</span><span class="comment" id="1791210">//&nbsp;goroutine.&nbsp;&nbsp;One&nbsp;goroutine&nbsp;may&nbsp;RLock&nbsp;(Lock)&nbsp;an&nbsp;RWMutex&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="1791276">//&nbsp;arrange&nbsp;for&nbsp;another&nbsp;goroutine&nbsp;to&nbsp;RUnlock&nbsp;(Unlock)&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="1791333">func</span>&nbsp;<span class="op" id="1791338">(</span><span class="ident" id="1791339">rw</span>&nbsp;<span class="op" id="1791342">*</span><span class="ident" id="1791343">RWMutex</span><span class="op" id="1791350">)</span>&nbsp;<span class="ident" id="1791352">Unlock</span><span class="op" id="1791358">(</span><span class="op" id="1791359">)</span>&nbsp;<span class="op" id="1791361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1791364">if</span>&nbsp;<span class="ident" id="1791367">raceenabled</span>&nbsp;<span class="op" id="1791379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1791383">_</span>&nbsp;<span class="op" id="1791385">=</span>&nbsp;<span class="ident" id="1791387">rw</span><span class="op" id="1791389">.</span><span class="ident" id="1791390">w</span><span class="op" id="1791391">.</span><span class="ident" id="1791392">state</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1791400">raceRelease</span><span class="op" id="1791411">(</span><span class="ident" id="1791412">unsafe</span><span class="op" id="1791418">.</span><span class="ident" id="1791419">Pointer</span><span class="op" id="1791426">(</span><span class="op" id="1791427">&amp;</span><span class="ident" id="1791428">rw</span><span class="op" id="1791430">.</span><span class="ident" id="1791431">readerSem</span><span class="op" id="1791440">)</span><span class="op" id="1791441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1791445">raceRelease</span><span class="op" id="1791456">(</span><span class="ident" id="1791457">unsafe</span><span class="op" id="1791463">.</span><span class="ident" id="1791464">Pointer</span><span class="op" id="1791471">(</span><span class="op" id="1791472">&amp;</span><span class="ident" id="1791473">rw</span><span class="op" id="1791475">.</span><span class="ident" id="1791476">writerSem</span><span class="op" id="1791485">)</span><span class="op" id="1791486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1791490">raceDisable</span><span class="op" id="1791501">(</span><span class="op" id="1791502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1791505">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1791509">//&nbsp;Announce&nbsp;to&nbsp;readers&nbsp;there&nbsp;is&nbsp;no&nbsp;active&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1791560">r</span>&nbsp;<span class="op" id="1791562">:=</span>&nbsp;<span class="ident" id="1791565">atomic</span><span class="op" id="1791571">.</span><span class="ident" id="1791572">AddInt32</span><span class="op" id="1791580">(</span><span class="op" id="1791581">&amp;</span><span class="ident" id="1791582">rw</span><span class="op" id="1791584">.</span><span class="ident" id="1791585">readerCount</span><span class="op" id="1791596">,</span>&nbsp;<span class="ident" id="1791598">rwmutexMaxReaders</span><span class="op" id="1791615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1791618">if</span>&nbsp;<span class="ident" id="1791621">r</span>&nbsp;<span class="op" id="1791623">&gt;=</span>&nbsp;<span class="ident" id="1791626">rwmutexMaxReaders</span>&nbsp;<span class="op" id="1791644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1791648">raceEnable</span><span class="op" id="1791658">(</span><span class="op" id="1791659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1791663">panic</span><span class="op" id="1791668">(</span><span class="string" id="1791669">&#34;sync:&nbsp;Unlock&nbsp;of&nbsp;unlocked&nbsp;RWMutex&#34;</span><span class="op" id="1791703">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1791706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1791709">//&nbsp;Unblock&nbsp;blocked&nbsp;readers,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1791746">for</span>&nbsp;<span class="ident" id="1791750">i</span>&nbsp;<span class="op" id="1791752">:=</span>&nbsp;<span class="num" id="1791755">0</span><span class="op" id="1791756">;</span>&nbsp;<span class="ident" id="1791758">i</span>&nbsp;<span class="op" id="1791760">&lt;</span>&nbsp;<span class="builtintype" id="1791762">int</span><span class="op" id="1791765">(</span><span class="ident" id="1791766">r</span><span class="op" id="1791767">)</span><span class="op" id="1791768">;</span>&nbsp;<span class="ident" id="1791770">i</span><span class="op" id="1791771">++</span>&nbsp;<span class="op" id="1791774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1791778">runtime_Semrelease</span><span class="op" id="1791796">(</span><span class="op" id="1791797">&amp;</span><span class="ident" id="1791798">rw</span><span class="op" id="1791800">.</span><span class="ident" id="1791801">readerSem</span><span class="op" id="1791810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1791813">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1791816">//&nbsp;Allow&nbsp;other&nbsp;writers&nbsp;to&nbsp;proceed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1791852">rw</span><span class="op" id="1791854">.</span><span class="ident" id="1791855">w</span><span class="op" id="1791856">.</span><span class="ident" id="1791857">Unlock</span><span class="op" id="1791863">(</span><span class="op" id="1791864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1791867">if</span>&nbsp;<span class="ident" id="1791870">raceenabled</span>&nbsp;<span class="op" id="1791882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1791886">raceEnable</span><span class="op" id="1791896">(</span><span class="op" id="1791897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1791900">}</span><br>
<span class="lineno">125</span><span class="op" id="1791902">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1791905">//&nbsp;RLocker&nbsp;returns&nbsp;a&nbsp;Locker&nbsp;interface&nbsp;that&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1791959">//&nbsp;the&nbsp;Lock&nbsp;and&nbsp;Unlock&nbsp;methods&nbsp;by&nbsp;calling&nbsp;rw.RLock&nbsp;and&nbsp;rw.RUnlock.</span><br>
<span class="lineno"></span><span class="keyword" id="1792026">func</span>&nbsp;<span class="op" id="1792031">(</span><span class="ident" id="1792032">rw</span>&nbsp;<span class="op" id="1792035">*</span><span class="ident" id="1792036">RWMutex</span><span class="op" id="1792043">)</span>&nbsp;<span class="ident" id="1792045">RLocker</span><span class="op" id="1792052">(</span><span class="op" id="1792053">)</span>&nbsp;<span class="ident" id="1792055">Locker</span>&nbsp;<span class="op" id="1792062">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1792065">return</span>&nbsp;<span class="op" id="1792072">(</span><span class="op" id="1792073">*</span><span class="ident" id="1792074">rlocker</span><span class="op" id="1792081">)</span><span class="op" id="1792082">(</span><span class="ident" id="1792083">rw</span><span class="op" id="1792085">)</span><br>
<span class="lineno"></span><span class="op" id="1792087">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1792090">type</span>&nbsp;<span class="ident" id="1792095">rlocker</span>&nbsp;<span class="ident" id="1792103">RWMutex</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="keyword" id="1792112">func</span>&nbsp;<span class="op" id="1792117">(</span><span class="ident" id="1792118">r</span>&nbsp;<span class="op" id="1792120">*</span><span class="ident" id="1792121">rlocker</span><span class="op" id="1792128">)</span>&nbsp;<span class="ident" id="1792130">Lock</span><span class="op" id="1792134">(</span><span class="op" id="1792135">)</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1792139">{</span>&nbsp;<span class="op" id="1792141">(</span><span class="op" id="1792142">*</span><span class="ident" id="1792143">RWMutex</span><span class="op" id="1792150">)</span><span class="op" id="1792151">(</span><span class="ident" id="1792152">r</span><span class="op" id="1792153">)</span><span class="op" id="1792154">.</span><span class="ident" id="1792155">RLock</span><span class="op" id="1792160">(</span><span class="op" id="1792161">)</span>&nbsp;<span class="op" id="1792163">}</span><br>
<span class="lineno"></span><span class="keyword" id="1792165">func</span>&nbsp;<span class="op" id="1792170">(</span><span class="ident" id="1792171">r</span>&nbsp;<span class="op" id="1792173">*</span><span class="ident" id="1792174">rlocker</span><span class="op" id="1792181">)</span>&nbsp;<span class="ident" id="1792183">Unlock</span><span class="op" id="1792189">(</span><span class="op" id="1792190">)</span>&nbsp;<span class="op" id="1792192">{</span>&nbsp;<span class="op" id="1792194">(</span><span class="op" id="1792195">*</span><span class="ident" id="1792196">RWMutex</span><span class="op" id="1792203">)</span><span class="op" id="1792204">(</span><span class="ident" id="1792205">r</span><span class="op" id="1792206">)</span><span class="op" id="1792207">.</span><span class="ident" id="1792208">RUnlock</span><span class="op" id="1792215">(</span><span class="op" id="1792216">)</span>&nbsp;<span class="op" id="1792218">}</span>
</div>
</body>
</html>
