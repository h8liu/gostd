<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync/atomic</h2>
<ul>
<li><a href="/gostd/sync/atomic/atomic_test.go.html">atomic_test.go</a></li>
<li><a href="/gostd/sync/atomic/doc.go.html">doc.go</a></li>
<li><a href="/gostd/sync/atomic/value.go.html" class="current">value.go</a></li>
<li><a href="/gostd/sync/atomic/value_test.go.html">value_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1469027">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1469082">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1469136">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1469187">package</span>&nbsp;<span class="ident" id="1469195">atomic</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1469203">import</span>&nbsp;<span class="op" id="1469210">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1469213">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1469222">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="1469225">//&nbsp;A&nbsp;Value&nbsp;provides&nbsp;an&nbsp;atomic&nbsp;load&nbsp;and&nbsp;store&nbsp;of&nbsp;a&nbsp;consistently&nbsp;typed&nbsp;value.</span><br>
<span class="lineno"></span><span class="comment" id="1469301">//&nbsp;Values&nbsp;can&nbsp;be&nbsp;created&nbsp;as&nbsp;part&nbsp;of&nbsp;other&nbsp;data&nbsp;structures.</span><br>
<span class="lineno"></span><span class="comment" id="1469360">//&nbsp;The&nbsp;zero&nbsp;value&nbsp;for&nbsp;a&nbsp;Value&nbsp;returns&nbsp;nil&nbsp;from&nbsp;Load.</span><br>
<span class="lineno"></span><span class="comment" id="1469413">//&nbsp;Once&nbsp;Store&nbsp;has&nbsp;been&nbsp;called,&nbsp;a&nbsp;Value&nbsp;must&nbsp;not&nbsp;be&nbsp;copied.</span><br>
<span class="lineno">15</span><span class="keyword" id="1469472">type</span>&nbsp;<span class="ident" id="1469477">Value</span>&nbsp;<span class="keyword" id="1469483">struct</span>&nbsp;<span class="op" id="1469490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1469493">v</span>&nbsp;<span class="keyword" id="1469495">interface</span><span class="op" id="1469504">{</span><span class="op" id="1469505">}</span><br>
<span class="lineno"></span><span class="op" id="1469507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1469510">//&nbsp;ifaceWords&nbsp;is&nbsp;interface{}&nbsp;internal&nbsp;representation.</span><br>
<span class="lineno">20</span><span class="keyword" id="1469564">type</span>&nbsp;<span class="ident" id="1469569">ifaceWords</span>&nbsp;<span class="keyword" id="1469580">struct</span>&nbsp;<span class="op" id="1469587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1469590">typ</span>&nbsp;&nbsp;<span class="ident" id="1469595"><a href="/gostd/sync/atomic/value.go.html#1469213">unsafe</a></span><span class="op" id="1469601">.</span><span class="ident" id="1469602">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1469611">data</span>&nbsp;<span class="ident" id="1469616"><a href="/gostd/sync/atomic/value.go.html#1469213">unsafe</a></span><span class="op" id="1469622">.</span><span class="ident" id="1469623">Pointer</span><br>
<span class="lineno"></span><span class="op" id="1469631">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="1469634">//&nbsp;Load&nbsp;returns&nbsp;the&nbsp;value&nbsp;set&nbsp;by&nbsp;the&nbsp;most&nbsp;recent&nbsp;Store.</span><br>
<span class="lineno"></span><span class="comment" id="1469690">//&nbsp;It&nbsp;returns&nbsp;nil&nbsp;if&nbsp;there&nbsp;has&nbsp;been&nbsp;no&nbsp;call&nbsp;to&nbsp;Store&nbsp;for&nbsp;this&nbsp;Value.</span><br>
<span class="lineno"></span><span class="keyword" id="1469759">func</span>&nbsp;<span class="op" id="1469764">(</span><span class="ident" id="1469765">v</span>&nbsp;<span class="op" id="1469767">*</span><span class="ident" id="1469768"><a href="/gostd/sync/atomic/value.go.html#1469477">Value</a></span><span class="op" id="1469773">)</span>&nbsp;<span class="ident" id="1469775">Load</span><span class="op" id="1469779">(</span><span class="op" id="1469780">)</span>&nbsp;<span class="op" id="1469782">(</span><span class="ident" id="1469783">x</span>&nbsp;<span class="keyword" id="1469785">interface</span><span class="op" id="1469794">{</span><span class="op" id="1469795">}</span><span class="op" id="1469796">)</span>&nbsp;<span class="op" id="1469798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1469801">vp</span>&nbsp;<span class="op" id="1469804">:=</span>&nbsp;<span class="op" id="1469807">(</span><span class="op" id="1469808">*</span><span class="ident" id="1469809"><a href="/gostd/sync/atomic/value.go.html#1469569">ifaceWords</a></span><span class="op" id="1469819">)</span><span class="op" id="1469820">(</span><span class="ident" id="1469821"><a href="/gostd/sync/atomic/value.go.html#1469213">unsafe</a></span><span class="op" id="1469827">.</span><span class="ident" id="1469828">Pointer</span><span class="op" id="1469835">(</span><span class="ident" id="1469836"><a href="/gostd/sync/atomic/value.go.html#1469765">v</a></span><span class="op" id="1469837">)</span><span class="op" id="1469838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1469841">typ</span>&nbsp;<span class="op" id="1469845">:=</span>&nbsp;<span class="ident" id="1469848"><a href="/gostd/sync/atomic/doc.go.html#1468254">LoadPointer</a></span><span class="op" id="1469859">(</span><span class="op" id="1469860">&amp;</span><span class="ident" id="1469861"><a href="/gostd/sync/atomic/value.go.html#1469801">vp</a></span><span class="op" id="1469863">.</span><span class="ident" id="1469864"><a href="/gostd/sync/atomic/value.go.html#1469590">typ</a></span><span class="op" id="1469867">)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1469870">if</span>&nbsp;<span class="ident" id="1469873"><a href="/gostd/sync/atomic/value.go.html#1469841">typ</a></span>&nbsp;<span class="op" id="1469877">==</span>&nbsp;<span class="builtintype" id="1469880">nil</span>&nbsp;<span class="op" id="1469884">||</span>&nbsp;<span class="builtintype" id="1469887">uintptr</span><span class="op" id="1469894">(</span><span class="ident" id="1469895"><a href="/gostd/sync/atomic/value.go.html#1469841">typ</a></span><span class="op" id="1469898">)</span>&nbsp;<span class="op" id="1469900">==</span>&nbsp;<span class="op" id="1469903">^</span><span class="builtintype" id="1469904">uintptr</span><span class="op" id="1469911">(</span><span class="num" id="1469912">0</span><span class="op" id="1469913">)</span>&nbsp;<span class="op" id="1469915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1469919">//&nbsp;First&nbsp;store&nbsp;not&nbsp;yet&nbsp;completed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1469955">return</span>&nbsp;<span class="builtintype" id="1469962">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1469967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1469970">data</span>&nbsp;<span class="op" id="1469975">:=</span>&nbsp;<span class="ident" id="1469978"><a href="/gostd/sync/atomic/doc.go.html#1468254">LoadPointer</a></span><span class="op" id="1469989">(</span><span class="op" id="1469990">&amp;</span><span class="ident" id="1469991"><a href="/gostd/sync/atomic/value.go.html#1469801">vp</a></span><span class="op" id="1469993">.</span><span class="ident" id="1469994"><a href="/gostd/sync/atomic/value.go.html#1469611">data</a></span><span class="op" id="1469998">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470001">xp</span>&nbsp;<span class="op" id="1470004">:=</span>&nbsp;<span class="op" id="1470007">(</span><span class="op" id="1470008">*</span><span class="ident" id="1470009"><a href="/gostd/sync/atomic/value.go.html#1469569">ifaceWords</a></span><span class="op" id="1470019">)</span><span class="op" id="1470020">(</span><span class="ident" id="1470021"><a href="/gostd/sync/atomic/value.go.html#1469213">unsafe</a></span><span class="op" id="1470027">.</span><span class="ident" id="1470028">Pointer</span><span class="op" id="1470035">(</span><span class="op" id="1470036">&amp;</span><span class="ident" id="1470037"><a href="/gostd/sync/atomic/value.go.html#1469783">x</a></span><span class="op" id="1470038">)</span><span class="op" id="1470039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470042"><a href="/gostd/sync/atomic/value.go.html#1470001">xp</a></span><span class="op" id="1470044">.</span><span class="ident" id="1470045"><a href="/gostd/sync/atomic/value.go.html#1469590">typ</a></span>&nbsp;<span class="op" id="1470049">=</span>&nbsp;<span class="ident" id="1470051"><a href="/gostd/sync/atomic/value.go.html#1469841">typ</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470056"><a href="/gostd/sync/atomic/value.go.html#1470001">xp</a></span><span class="op" id="1470058">.</span><span class="ident" id="1470059"><a href="/gostd/sync/atomic/value.go.html#1469611">data</a></span>&nbsp;<span class="op" id="1470064">=</span>&nbsp;<span class="ident" id="1470066"><a href="/gostd/sync/atomic/value.go.html#1469970">data</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1470072">return</span><br>
<span class="lineno"></span><span class="op" id="1470079">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="1470082">//&nbsp;Store&nbsp;sets&nbsp;the&nbsp;value&nbsp;of&nbsp;the&nbsp;Value&nbsp;to&nbsp;x.</span><br>
<span class="lineno"></span><span class="comment" id="1470125">//&nbsp;All&nbsp;calls&nbsp;to&nbsp;Store&nbsp;for&nbsp;a&nbsp;given&nbsp;Value&nbsp;must&nbsp;use&nbsp;values&nbsp;of&nbsp;the&nbsp;same&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="1470208">//&nbsp;Store&nbsp;of&nbsp;an&nbsp;inconsistent&nbsp;type&nbsp;panics,&nbsp;as&nbsp;does&nbsp;Store(nil).</span><br>
<span class="lineno"></span><span class="keyword" id="1470269">func</span>&nbsp;<span class="op" id="1470274">(</span><span class="ident" id="1470275">v</span>&nbsp;<span class="op" id="1470277">*</span><span class="ident" id="1470278"><a href="/gostd/sync/atomic/value.go.html#1469477">Value</a></span><span class="op" id="1470283">)</span>&nbsp;<span class="ident" id="1470285">Store</span><span class="op" id="1470290">(</span><span class="ident" id="1470291">x</span>&nbsp;<span class="keyword" id="1470293">interface</span><span class="op" id="1470302">{</span><span class="op" id="1470303">}</span><span class="op" id="1470304">)</span>&nbsp;<span class="op" id="1470306">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1470309">if</span>&nbsp;<span class="ident" id="1470312"><a href="/gostd/sync/atomic/value.go.html#1470291">x</a></span>&nbsp;<span class="op" id="1470314">==</span>&nbsp;<span class="builtintype" id="1470317">nil</span>&nbsp;<span class="op" id="1470321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1470325">panic</span><span class="op" id="1470330">(</span><span class="string" id="1470331">&#34;sync/atomic:&nbsp;store&nbsp;of&nbsp;nil&nbsp;value&nbsp;into&nbsp;Value&#34;</span><span class="op" id="1470375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1470378">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470381">vp</span>&nbsp;<span class="op" id="1470384">:=</span>&nbsp;<span class="op" id="1470387">(</span><span class="op" id="1470388">*</span><span class="ident" id="1470389"><a href="/gostd/sync/atomic/value.go.html#1469569">ifaceWords</a></span><span class="op" id="1470399">)</span><span class="op" id="1470400">(</span><span class="ident" id="1470401"><a href="/gostd/sync/atomic/value.go.html#1469213">unsafe</a></span><span class="op" id="1470407">.</span><span class="ident" id="1470408">Pointer</span><span class="op" id="1470415">(</span><span class="ident" id="1470416"><a href="/gostd/sync/atomic/value.go.html#1470275">v</a></span><span class="op" id="1470417">)</span><span class="op" id="1470418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470421">xp</span>&nbsp;<span class="op" id="1470424">:=</span>&nbsp;<span class="op" id="1470427">(</span><span class="op" id="1470428">*</span><span class="ident" id="1470429"><a href="/gostd/sync/atomic/value.go.html#1469569">ifaceWords</a></span><span class="op" id="1470439">)</span><span class="op" id="1470440">(</span><span class="ident" id="1470441"><a href="/gostd/sync/atomic/value.go.html#1469213">unsafe</a></span><span class="op" id="1470447">.</span><span class="ident" id="1470448">Pointer</span><span class="op" id="1470455">(</span><span class="op" id="1470456">&amp;</span><span class="ident" id="1470457"><a href="/gostd/sync/atomic/value.go.html#1470291">x</a></span><span class="op" id="1470458">)</span><span class="op" id="1470459">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1470462">for</span>&nbsp;<span class="op" id="1470466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470470">typ</span>&nbsp;<span class="op" id="1470474">:=</span>&nbsp;<span class="ident" id="1470477"><a href="/gostd/sync/atomic/doc.go.html#1468254">LoadPointer</a></span><span class="op" id="1470488">(</span><span class="op" id="1470489">&amp;</span><span class="ident" id="1470490"><a href="/gostd/sync/atomic/value.go.html#1470381">vp</a></span><span class="op" id="1470492">.</span><span class="ident" id="1470493"><a href="/gostd/sync/atomic/value.go.html#1469590">typ</a></span><span class="op" id="1470496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1470500">if</span>&nbsp;<span class="ident" id="1470503"><a href="/gostd/sync/atomic/value.go.html#1470470">typ</a></span>&nbsp;<span class="op" id="1470507">==</span>&nbsp;<span class="builtintype" id="1470510">nil</span>&nbsp;<span class="op" id="1470514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1470519">//&nbsp;Attempt&nbsp;to&nbsp;start&nbsp;first&nbsp;store.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1470555">//&nbsp;Disable&nbsp;preemption&nbsp;so&nbsp;that&nbsp;other&nbsp;goroutines&nbsp;can&nbsp;use</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1470613">//&nbsp;active&nbsp;spin&nbsp;wait&nbsp;to&nbsp;wait&nbsp;for&nbsp;completion;&nbsp;and&nbsp;so&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1470672">//&nbsp;GC&nbsp;does&nbsp;not&nbsp;see&nbsp;the&nbsp;fake&nbsp;type&nbsp;accidentally.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470722"><a href="/gostd/sync/atomic/value.go.html#1471439">runtime_procPin</a></span><span class="op" id="1470737">(</span><span class="op" id="1470738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1470743">if</span>&nbsp;<span class="op" id="1470746">!</span><span class="ident" id="1470747"><a href="/gostd/sync/atomic/doc.go.html#1466776">CompareAndSwapPointer</a></span><span class="op" id="1470768">(</span><span class="op" id="1470769">&amp;</span><span class="ident" id="1470770"><a href="/gostd/sync/atomic/value.go.html#1470381">vp</a></span><span class="op" id="1470772">.</span><span class="ident" id="1470773"><a href="/gostd/sync/atomic/value.go.html#1469590">typ</a></span><span class="op" id="1470776">,</span>&nbsp;<span class="builtintype" id="1470778">nil</span><span class="op" id="1470781">,</span>&nbsp;<span class="ident" id="1470783"><a href="/gostd/sync/atomic/value.go.html#1469213">unsafe</a></span><span class="op" id="1470789">.</span><span class="ident" id="1470790">Pointer</span><span class="op" id="1470797">(</span><span class="op" id="1470798">^</span><span class="builtintype" id="1470799">uintptr</span><span class="op" id="1470806">(</span><span class="num" id="1470807">0</span><span class="op" id="1470808">)</span><span class="op" id="1470809">)</span><span class="op" id="1470810">)</span>&nbsp;<span class="op" id="1470812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470818"><a href="/gostd/sync/atomic/value.go.html#1471462">runtime_procUnpin</a></span><span class="op" id="1470835">(</span><span class="op" id="1470836">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1470842">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1470854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1470859">//&nbsp;Complete&nbsp;first&nbsp;store.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470887"><a href="/gostd/sync/atomic/doc.go.html#1468826">StorePointer</a></span><span class="op" id="1470899">(</span><span class="op" id="1470900">&amp;</span><span class="ident" id="1470901"><a href="/gostd/sync/atomic/value.go.html#1470381">vp</a></span><span class="op" id="1470903">.</span><span class="ident" id="1470904"><a href="/gostd/sync/atomic/value.go.html#1469611">data</a></span><span class="op" id="1470908">,</span>&nbsp;<span class="ident" id="1470910"><a href="/gostd/sync/atomic/value.go.html#1470421">xp</a></span><span class="op" id="1470912">.</span><span class="ident" id="1470913"><a href="/gostd/sync/atomic/value.go.html#1469611">data</a></span><span class="op" id="1470917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470922"><a href="/gostd/sync/atomic/doc.go.html#1468826">StorePointer</a></span><span class="op" id="1470934">(</span><span class="op" id="1470935">&amp;</span><span class="ident" id="1470936"><a href="/gostd/sync/atomic/value.go.html#1470381">vp</a></span><span class="op" id="1470938">.</span><span class="ident" id="1470939"><a href="/gostd/sync/atomic/value.go.html#1469590">typ</a></span><span class="op" id="1470942">,</span>&nbsp;<span class="ident" id="1470944"><a href="/gostd/sync/atomic/value.go.html#1470421">xp</a></span><span class="op" id="1470946">.</span><span class="ident" id="1470947"><a href="/gostd/sync/atomic/value.go.html#1469590">typ</a></span><span class="op" id="1470950">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470955"><a href="/gostd/sync/atomic/value.go.html#1471462">runtime_procUnpin</a></span><span class="op" id="1470972">(</span><span class="op" id="1470973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1470978">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1470987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1470991">if</span>&nbsp;<span class="builtintype" id="1470994">uintptr</span><span class="op" id="1471001">(</span><span class="ident" id="1471002"><a href="/gostd/sync/atomic/value.go.html#1470470">typ</a></span><span class="op" id="1471005">)</span>&nbsp;<span class="op" id="1471007">==</span>&nbsp;<span class="op" id="1471010">^</span><span class="builtintype" id="1471011">uintptr</span><span class="op" id="1471018">(</span><span class="num" id="1471019">0</span><span class="op" id="1471020">)</span>&nbsp;<span class="op" id="1471022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1471027">//&nbsp;First&nbsp;store&nbsp;in&nbsp;progress.&nbsp;Wait.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1471064">//&nbsp;Since&nbsp;we&nbsp;disable&nbsp;preemption&nbsp;around&nbsp;the&nbsp;first&nbsp;store,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1471122">//&nbsp;we&nbsp;can&nbsp;wait&nbsp;with&nbsp;active&nbsp;spinning.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1471162">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1471173">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1471177">//&nbsp;First&nbsp;store&nbsp;completed.&nbsp;Check&nbsp;type&nbsp;and&nbsp;overwrite&nbsp;data.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1471236">if</span>&nbsp;<span class="ident" id="1471239"><a href="/gostd/sync/atomic/value.go.html#1470470">typ</a></span>&nbsp;<span class="op" id="1471243">!=</span>&nbsp;<span class="ident" id="1471246"><a href="/gostd/sync/atomic/value.go.html#1470421">xp</a></span><span class="op" id="1471248">.</span><span class="ident" id="1471249"><a href="/gostd/sync/atomic/value.go.html#1469590">typ</a></span>&nbsp;<span class="op" id="1471253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1471258">panic</span><span class="op" id="1471263">(</span><span class="string" id="1471264">&#34;sync/atomic:&nbsp;store&nbsp;of&nbsp;inconsistently&nbsp;typed&nbsp;value&nbsp;into&nbsp;Value&#34;</span><span class="op" id="1471325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1471329">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1471333"><a href="/gostd/sync/atomic/doc.go.html#1468826">StorePointer</a></span><span class="op" id="1471345">(</span><span class="op" id="1471346">&amp;</span><span class="ident" id="1471347"><a href="/gostd/sync/atomic/value.go.html#1470381">vp</a></span><span class="op" id="1471349">.</span><span class="ident" id="1471350"><a href="/gostd/sync/atomic/value.go.html#1469611">data</a></span><span class="op" id="1471354">,</span>&nbsp;<span class="ident" id="1471356"><a href="/gostd/sync/atomic/value.go.html#1470421">xp</a></span><span class="op" id="1471358">.</span><span class="ident" id="1471359"><a href="/gostd/sync/atomic/value.go.html#1469611">data</a></span><span class="op" id="1471363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1471367">return</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1471375">}</span><br>
<span class="lineno"></span><span class="op" id="1471377">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1471380">//&nbsp;Disable/enable&nbsp;preemption,&nbsp;implemented&nbsp;in&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="keyword" id="1471434">func</span>&nbsp;<span class="ident" id="1471439">runtime_procPin</span><span class="op" id="1471454">(</span><span class="op" id="1471455">)</span><br>
<span class="lineno">85</span><span class="keyword" id="1471457">func</span>&nbsp;<span class="ident" id="1471462">runtime_procUnpin</span><span class="op" id="1471479">(</span><span class="op" id="1471480">)</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
