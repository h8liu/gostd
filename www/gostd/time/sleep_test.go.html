<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>time</h2>
<ul>
<li><a href="/gostd/time/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/time/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/time/format.go.html">format.go</a></li>
<li><a href="/gostd/time/format_test.go.html">format_test.go</a></li>
<li><a href="/gostd/time/internal_test.go.html">internal_test.go</a></li>
<li><a href="/gostd/time/sleep.go.html">sleep.go</a></li>
<li><a href="/gostd/time/sleep_test.go.html" class="current">sleep_test.go</a></li>
<li><a href="/gostd/time/sys_unix.go.html">sys_unix.go</a></li>
<li><a href="/gostd/time/tick.go.html">tick.go</a></li>
<li><a href="/gostd/time/tick_test.go.html">tick_test.go</a></li>
<li><a href="/gostd/time/time.go.html">time.go</a></li>
<li><a href="/gostd/time/time_test.go.html">time_test.go</a></li>
<li><a href="/gostd/time/zoneinfo.go.html">zoneinfo.go</a></li>
<li><a href="/gostd/time/zoneinfo_read.go.html">zoneinfo_read.go</a></li>
<li><a href="/gostd/time/zoneinfo_test.go.html">zoneinfo_test.go</a></li>
<li><a href="/gostd/time/zoneinfo_unix.go.html">zoneinfo_unix.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1244730">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1244785">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1244839">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1244890">package</span>&nbsp;<span class="ident" id="1244898">time_test</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1244909">import</span>&nbsp;<span class="op" id="1244916">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1244919">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1244929">&#34;fmt&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1244936">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1244947">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1244955">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1244966">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1244974">&#34;sync/atomic&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1244989">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1245000">.</span>&nbsp;<span class="string" id="1245002">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="1245009">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1245012">//&nbsp;Go&nbsp;runtime&nbsp;uses&nbsp;different&nbsp;Windows&nbsp;timers&nbsp;for&nbsp;time.Now&nbsp;and&nbsp;sleeping.</span><br>
<span class="lineno">20</span><span class="comment" id="1245083">//&nbsp;These&nbsp;can&nbsp;tick&nbsp;at&nbsp;different&nbsp;frequencies&nbsp;and&nbsp;can&nbsp;arrive&nbsp;out&nbsp;of&nbsp;sync.</span><br>
<span class="lineno"></span><span class="comment" id="1245154">//&nbsp;The&nbsp;effect&nbsp;can&nbsp;be&nbsp;seen,&nbsp;for&nbsp;example,&nbsp;as&nbsp;time.Sleep(100ms)&nbsp;is&nbsp;actually</span><br>
<span class="lineno"></span><span class="comment" id="1245227">//&nbsp;shorter&nbsp;then&nbsp;100ms&nbsp;when&nbsp;measured&nbsp;as&nbsp;difference&nbsp;between&nbsp;time.Now&nbsp;before&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1245305">//&nbsp;after&nbsp;time.Sleep&nbsp;call.&nbsp;This&nbsp;was&nbsp;observed&nbsp;on&nbsp;Windows&nbsp;XP&nbsp;SP3&nbsp;(windows/386).</span><br>
<span class="lineno"></span><span class="comment" id="1245382">//&nbsp;windowsInaccuracy&nbsp;is&nbsp;to&nbsp;ignore&nbsp;such&nbsp;errors.</span><br>
<span class="lineno">25</span><span class="keyword" id="1245429">const</span>&nbsp;<span class="ident" id="1245435">windowsInaccuracy</span>&nbsp;<span class="op" id="1245453">=</span>&nbsp;<span class="num" id="1245455">17</span>&nbsp;<span class="op" id="1245458">*</span>&nbsp;<span class="ident" id="1245460">Millisecond</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1245473">func</span>&nbsp;<span class="ident" id="1245478">TestSleep</span><span class="op" id="1245487">(</span><span class="ident" id="1245488">t</span>&nbsp;<span class="op" id="1245490">*</span><span class="ident" id="1245491">testing</span><span class="op" id="1245498">.</span><span class="ident" id="1245499">T</span><span class="op" id="1245500">)</span>&nbsp;<span class="op" id="1245502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1245505">const</span>&nbsp;<span class="ident" id="1245511">delay</span>&nbsp;<span class="op" id="1245517">=</span>&nbsp;<span class="num" id="1245519">100</span>&nbsp;<span class="op" id="1245523">*</span>&nbsp;<span class="ident" id="1245525">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1245538">go</span>&nbsp;<span class="keyword" id="1245541">func</span><span class="op" id="1245545">(</span><span class="op" id="1245546">)</span>&nbsp;<span class="op" id="1245548">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1245552">Sleep</span><span class="op" id="1245557">(</span><span class="ident" id="1245558">delay</span>&nbsp;<span class="op" id="1245564">/</span>&nbsp;<span class="num" id="1245566">2</span><span class="op" id="1245567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1245571">Interrupt</span><span class="op" id="1245580">(</span><span class="op" id="1245581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1245584">}</span><span class="op" id="1245585">(</span><span class="op" id="1245586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1245589">start</span>&nbsp;<span class="op" id="1245595">:=</span>&nbsp;<span class="ident" id="1245598">Now</span><span class="op" id="1245601">(</span><span class="op" id="1245602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1245605">Sleep</span><span class="op" id="1245610">(</span><span class="ident" id="1245611">delay</span><span class="op" id="1245616">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1245619">delayadj</span>&nbsp;<span class="op" id="1245628">:=</span>&nbsp;<span class="ident" id="1245631">delay</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1245638">if</span>&nbsp;<span class="ident" id="1245641">runtime</span><span class="op" id="1245648">.</span><span class="ident" id="1245649">GOOS</span>&nbsp;<span class="op" id="1245654">==</span>&nbsp;<span class="string" id="1245657">&#34;windows&#34;</span>&nbsp;<span class="op" id="1245667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1245671">delayadj</span>&nbsp;<span class="op" id="1245680">-=</span>&nbsp;<span class="ident" id="1245683">windowsInaccuracy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1245702">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1245705">duration</span>&nbsp;<span class="op" id="1245714">:=</span>&nbsp;<span class="ident" id="1245717">Now</span><span class="op" id="1245720">(</span><span class="op" id="1245721">)</span><span class="op" id="1245722">.</span><span class="ident" id="1245723">Sub</span><span class="op" id="1245726">(</span><span class="ident" id="1245727">start</span><span class="op" id="1245732">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1245735">if</span>&nbsp;<span class="ident" id="1245738">duration</span>&nbsp;<span class="op" id="1245747">&lt;</span>&nbsp;<span class="ident" id="1245749">delayadj</span>&nbsp;<span class="op" id="1245758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1245762">t</span><span class="op" id="1245763">.</span><span class="ident" id="1245764">Fatalf</span><span class="op" id="1245770">(</span><span class="string" id="1245771">&#34;Sleep(%s)&nbsp;slept&nbsp;for&nbsp;only&nbsp;%s&#34;</span><span class="op" id="1245800">,</span>&nbsp;<span class="ident" id="1245802">delay</span><span class="op" id="1245807">,</span>&nbsp;<span class="ident" id="1245809">duration</span><span class="op" id="1245817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1245820">}</span><br>
<span class="lineno"></span><span class="op" id="1245822">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="1245825">//&nbsp;Test&nbsp;the&nbsp;basic&nbsp;function&nbsp;calling&nbsp;behavior.&nbsp;Correct&nbsp;queueing</span><br>
<span class="lineno"></span><span class="comment" id="1245887">//&nbsp;behavior&nbsp;is&nbsp;tested&nbsp;elsewhere,&nbsp;since&nbsp;After&nbsp;and&nbsp;AfterFunc&nbsp;share</span><br>
<span class="lineno"></span><span class="comment" id="1245952">//&nbsp;the&nbsp;same&nbsp;code.</span><br>
<span class="lineno"></span><span class="keyword" id="1245970">func</span>&nbsp;<span class="ident" id="1245975">TestAfterFunc</span><span class="op" id="1245988">(</span><span class="ident" id="1245989">t</span>&nbsp;<span class="op" id="1245991">*</span><span class="ident" id="1245992">testing</span><span class="op" id="1245999">.</span><span class="ident" id="1246000">T</span><span class="op" id="1246001">)</span>&nbsp;<span class="op" id="1246003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1246006">i</span>&nbsp;<span class="op" id="1246008">:=</span>&nbsp;<span class="num" id="1246011">10</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1246015">c</span>&nbsp;<span class="op" id="1246017">:=</span>&nbsp;<span class="builtinfunc" id="1246020">make</span><span class="op" id="1246024">(</span><span class="keyword" id="1246025">chan</span>&nbsp;<span class="builtintype" id="1246030">bool</span><span class="op" id="1246034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1246037">var</span>&nbsp;<span class="ident" id="1246041">f</span>&nbsp;<span class="keyword" id="1246043">func</span><span class="op" id="1246047">(</span><span class="op" id="1246048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1246051">f</span>&nbsp;<span class="op" id="1246053">=</span>&nbsp;<span class="keyword" id="1246055">func</span><span class="op" id="1246059">(</span><span class="op" id="1246060">)</span>&nbsp;<span class="op" id="1246062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1246066">i</span><span class="op" id="1246067">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1246072">if</span>&nbsp;<span class="ident" id="1246075">i</span>&nbsp;<span class="op" id="1246077">&gt;=</span>&nbsp;<span class="num" id="1246080">0</span>&nbsp;<span class="op" id="1246082">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1246087">AfterFunc</span><span class="op" id="1246096">(</span><span class="num" id="1246097">0</span><span class="op" id="1246098">,</span>&nbsp;<span class="ident" id="1246100">f</span><span class="op" id="1246101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1246106">Sleep</span><span class="op" id="1246111">(</span><span class="num" id="1246112">1</span>&nbsp;<span class="op" id="1246114">*</span>&nbsp;<span class="ident" id="1246116">Second</span><span class="op" id="1246122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1246126">}</span>&nbsp;<span class="keyword" id="1246128">else</span>&nbsp;<span class="op" id="1246133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1246138">c</span>&nbsp;<span class="op" id="1246140">&lt;-</span>&nbsp;<span class="builtintype" id="1246143">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1246150">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1246153">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1246157">AfterFunc</span><span class="op" id="1246166">(</span><span class="num" id="1246167">0</span><span class="op" id="1246168">,</span>&nbsp;<span class="ident" id="1246170">f</span><span class="op" id="1246171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1246174">&lt;-</span><span class="ident" id="1246176">c</span><br>
<span class="lineno"></span><span class="op" id="1246178">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="keyword" id="1246181">func</span>&nbsp;<span class="ident" id="1246186">TestAfterStress</span><span class="op" id="1246201">(</span><span class="ident" id="1246202">t</span>&nbsp;<span class="op" id="1246204">*</span><span class="ident" id="1246205">testing</span><span class="op" id="1246212">.</span><span class="ident" id="1246213">T</span><span class="op" id="1246214">)</span>&nbsp;<span class="op" id="1246216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1246219">stop</span>&nbsp;<span class="op" id="1246224">:=</span>&nbsp;<span class="builtintype" id="1246227">uint32</span><span class="op" id="1246233">(</span><span class="num" id="1246234">0</span><span class="op" id="1246235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1246238">go</span>&nbsp;<span class="keyword" id="1246241">func</span><span class="op" id="1246245">(</span><span class="op" id="1246246">)</span>&nbsp;<span class="op" id="1246248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1246252">for</span>&nbsp;<span class="ident" id="1246256">atomic</span><span class="op" id="1246262">.</span><span class="ident" id="1246263">LoadUint32</span><span class="op" id="1246273">(</span><span class="op" id="1246274">&amp;</span><span class="ident" id="1246275">stop</span><span class="op" id="1246279">)</span>&nbsp;<span class="op" id="1246281">==</span>&nbsp;<span class="num" id="1246284">0</span>&nbsp;<span class="op" id="1246286">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1246291">runtime</span><span class="op" id="1246298">.</span><span class="ident" id="1246299">GC</span><span class="op" id="1246301">(</span><span class="op" id="1246302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1246307">//&nbsp;Yield&nbsp;so&nbsp;that&nbsp;the&nbsp;OS&nbsp;can&nbsp;wake&nbsp;up&nbsp;the&nbsp;timer&nbsp;thread,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1246364">//&nbsp;so&nbsp;that&nbsp;it&nbsp;can&nbsp;generate&nbsp;channel&nbsp;sends&nbsp;for&nbsp;the&nbsp;main&nbsp;goroutine,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1246432">//&nbsp;which&nbsp;will&nbsp;eventually&nbsp;set&nbsp;stop&nbsp;=&nbsp;1&nbsp;for&nbsp;us.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1246481">Sleep</span><span class="op" id="1246486">(</span><span class="ident" id="1246487">Nanosecond</span><span class="op" id="1246497">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1246501">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1246504">}</span><span class="op" id="1246505">(</span><span class="op" id="1246506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1246509">ticker</span>&nbsp;<span class="op" id="1246516">:=</span>&nbsp;<span class="ident" id="1246519">NewTicker</span><span class="op" id="1246528">(</span><span class="num" id="1246529">1</span><span class="op" id="1246530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1246533">for</span>&nbsp;<span class="ident" id="1246537">i</span>&nbsp;<span class="op" id="1246539">:=</span>&nbsp;<span class="num" id="1246542">0</span><span class="op" id="1246543">;</span>&nbsp;<span class="ident" id="1246545">i</span>&nbsp;<span class="op" id="1246547">&lt;</span>&nbsp;<span class="num" id="1246549">100</span><span class="op" id="1246552">;</span>&nbsp;<span class="ident" id="1246554">i</span><span class="op" id="1246555">++</span>&nbsp;<span class="op" id="1246558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1246562">&lt;-</span><span class="ident" id="1246564">ticker</span><span class="op" id="1246570">.</span><span class="ident" id="1246571">C</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1246574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1246577">ticker</span><span class="op" id="1246583">.</span><span class="ident" id="1246584">Stop</span><span class="op" id="1246588">(</span><span class="op" id="1246589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1246592">atomic</span><span class="op" id="1246598">.</span><span class="ident" id="1246599">StoreUint32</span><span class="op" id="1246610">(</span><span class="op" id="1246611">&amp;</span><span class="ident" id="1246612">stop</span><span class="op" id="1246616">,</span>&nbsp;<span class="num" id="1246618">1</span><span class="op" id="1246619">)</span><br>
<span class="lineno"></span><span class="op" id="1246621">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="keyword" id="1246624">func</span>&nbsp;<span class="ident" id="1246629">benchmark</span><span class="op" id="1246638">(</span><span class="ident" id="1246639">b</span>&nbsp;<span class="op" id="1246641">*</span><span class="ident" id="1246642">testing</span><span class="op" id="1246649">.</span><span class="ident" id="1246650">B</span><span class="op" id="1246651">,</span>&nbsp;<span class="ident" id="1246653">bench</span>&nbsp;<span class="keyword" id="1246659">func</span><span class="op" id="1246663">(</span><span class="ident" id="1246664">n</span>&nbsp;<span class="builtintype" id="1246666">int</span><span class="op" id="1246669">)</span><span class="op" id="1246670">)</span>&nbsp;<span class="op" id="1246672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1246675">garbage</span>&nbsp;<span class="op" id="1246683">:=</span>&nbsp;<span class="builtinfunc" id="1246686">make</span><span class="op" id="1246690">(</span><span class="op" id="1246691">[</span><span class="op" id="1246692">]</span><span class="op" id="1246693">*</span><span class="ident" id="1246694">Timer</span><span class="op" id="1246699">,</span>&nbsp;<span class="num" id="1246701">1</span><span class="op" id="1246702">&lt;&lt;</span><span class="num" id="1246704">17</span><span class="op" id="1246706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1246709">for</span>&nbsp;<span class="ident" id="1246713">i</span>&nbsp;<span class="op" id="1246715">:=</span>&nbsp;<span class="num" id="1246718">0</span><span class="op" id="1246719">;</span>&nbsp;<span class="ident" id="1246721">i</span>&nbsp;<span class="op" id="1246723">&lt;</span>&nbsp;<span class="builtinfunc" id="1246725">len</span><span class="op" id="1246728">(</span><span class="ident" id="1246729">garbage</span><span class="op" id="1246736">)</span><span class="op" id="1246737">;</span>&nbsp;<span class="ident" id="1246739">i</span><span class="op" id="1246740">++</span>&nbsp;<span class="op" id="1246743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1246747">garbage</span><span class="op" id="1246754">[</span><span class="ident" id="1246755">i</span><span class="op" id="1246756">]</span>&nbsp;<span class="op" id="1246758">=</span>&nbsp;<span class="ident" id="1246760">AfterFunc</span><span class="op" id="1246769">(</span><span class="ident" id="1246770">Hour</span><span class="op" id="1246774">,</span>&nbsp;<span class="ident" id="1246776">nil</span><span class="op" id="1246779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1246782">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1246785">b</span><span class="op" id="1246786">.</span><span class="ident" id="1246787">ResetTimer</span><span class="op" id="1246797">(</span><span class="op" id="1246798">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1246802">b</span><span class="op" id="1246803">.</span><span class="ident" id="1246804">RunParallel</span><span class="op" id="1246815">(</span><span class="keyword" id="1246816">func</span><span class="op" id="1246820">(</span><span class="ident" id="1246821">pb</span>&nbsp;<span class="op" id="1246824">*</span><span class="ident" id="1246825">testing</span><span class="op" id="1246832">.</span><span class="ident" id="1246833">PB</span><span class="op" id="1246835">)</span>&nbsp;<span class="op" id="1246837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1246841">for</span>&nbsp;<span class="ident" id="1246845">pb</span><span class="op" id="1246847">.</span><span class="ident" id="1246848">Next</span><span class="op" id="1246852">(</span><span class="op" id="1246853">)</span>&nbsp;<span class="op" id="1246855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1246860">bench</span><span class="op" id="1246865">(</span><span class="num" id="1246866">1000</span><span class="op" id="1246870">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1246874">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1246877">}</span><span class="op" id="1246878">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1246882">b</span><span class="op" id="1246883">.</span><span class="ident" id="1246884">StopTimer</span><span class="op" id="1246893">(</span><span class="op" id="1246894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1246897">for</span>&nbsp;<span class="ident" id="1246901">i</span>&nbsp;<span class="op" id="1246903">:=</span>&nbsp;<span class="num" id="1246906">0</span><span class="op" id="1246907">;</span>&nbsp;<span class="ident" id="1246909">i</span>&nbsp;<span class="op" id="1246911">&lt;</span>&nbsp;<span class="builtinfunc" id="1246913">len</span><span class="op" id="1246916">(</span><span class="ident" id="1246917">garbage</span><span class="op" id="1246924">)</span><span class="op" id="1246925">;</span>&nbsp;<span class="ident" id="1246927">i</span><span class="op" id="1246928">++</span>&nbsp;<span class="op" id="1246931">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1246935">garbage</span><span class="op" id="1246942">[</span><span class="ident" id="1246943">i</span><span class="op" id="1246944">]</span><span class="op" id="1246945">.</span><span class="ident" id="1246946">Stop</span><span class="op" id="1246950">(</span><span class="op" id="1246951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1246954">}</span><br>
<span class="lineno"></span><span class="op" id="1246956">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1246959">func</span>&nbsp;<span class="ident" id="1246964">BenchmarkAfterFunc</span><span class="op" id="1246982">(</span><span class="ident" id="1246983">b</span>&nbsp;<span class="op" id="1246985">*</span><span class="ident" id="1246986">testing</span><span class="op" id="1246993">.</span><span class="ident" id="1246994">B</span><span class="op" id="1246995">)</span>&nbsp;<span class="op" id="1246997">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1247000">benchmark</span><span class="op" id="1247009">(</span><span class="ident" id="1247010">b</span><span class="op" id="1247011">,</span>&nbsp;<span class="keyword" id="1247013">func</span><span class="op" id="1247017">(</span><span class="ident" id="1247018">n</span>&nbsp;<span class="builtintype" id="1247020">int</span><span class="op" id="1247023">)</span>&nbsp;<span class="op" id="1247025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1247029">c</span>&nbsp;<span class="op" id="1247031">:=</span>&nbsp;<span class="builtinfunc" id="1247034">make</span><span class="op" id="1247038">(</span><span class="keyword" id="1247039">chan</span>&nbsp;<span class="builtintype" id="1247044">bool</span><span class="op" id="1247048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1247052">var</span>&nbsp;<span class="ident" id="1247056">f</span>&nbsp;<span class="keyword" id="1247058">func</span><span class="op" id="1247062">(</span><span class="op" id="1247063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1247067">f</span>&nbsp;<span class="op" id="1247069">=</span>&nbsp;<span class="keyword" id="1247071">func</span><span class="op" id="1247075">(</span><span class="op" id="1247076">)</span>&nbsp;<span class="op" id="1247078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1247083">n</span><span class="op" id="1247084">--</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1247090">if</span>&nbsp;<span class="ident" id="1247093">n</span>&nbsp;<span class="op" id="1247095">&gt;=</span>&nbsp;<span class="num" id="1247098">0</span>&nbsp;<span class="op" id="1247100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1247106">AfterFunc</span><span class="op" id="1247115">(</span><span class="num" id="1247116">0</span><span class="op" id="1247117">,</span>&nbsp;<span class="ident" id="1247119">f</span><span class="op" id="1247120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1247125">}</span>&nbsp;<span class="keyword" id="1247127">else</span>&nbsp;<span class="op" id="1247132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1247138">c</span>&nbsp;<span class="op" id="1247140">&lt;-</span>&nbsp;<span class="builtintype" id="1247143">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1247151">}</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1247155">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1247160">AfterFunc</span><span class="op" id="1247169">(</span><span class="num" id="1247170">0</span><span class="op" id="1247171">,</span>&nbsp;<span class="ident" id="1247173">f</span><span class="op" id="1247174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1247178">&lt;-</span><span class="ident" id="1247180">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1247183">}</span><span class="op" id="1247184">)</span><br>
<span class="lineno">120</span><span class="op" id="1247186">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1247189">func</span>&nbsp;<span class="ident" id="1247194">BenchmarkAfter</span><span class="op" id="1247208">(</span><span class="ident" id="1247209">b</span>&nbsp;<span class="op" id="1247211">*</span><span class="ident" id="1247212">testing</span><span class="op" id="1247219">.</span><span class="ident" id="1247220">B</span><span class="op" id="1247221">)</span>&nbsp;<span class="op" id="1247223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1247226">benchmark</span><span class="op" id="1247235">(</span><span class="ident" id="1247236">b</span><span class="op" id="1247237">,</span>&nbsp;<span class="keyword" id="1247239">func</span><span class="op" id="1247243">(</span><span class="ident" id="1247244">n</span>&nbsp;<span class="builtintype" id="1247246">int</span><span class="op" id="1247249">)</span>&nbsp;<span class="op" id="1247251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1247255">for</span>&nbsp;<span class="ident" id="1247259">i</span>&nbsp;<span class="op" id="1247261">:=</span>&nbsp;<span class="num" id="1247264">0</span><span class="op" id="1247265">;</span>&nbsp;<span class="ident" id="1247267">i</span>&nbsp;<span class="op" id="1247269">&lt;</span>&nbsp;<span class="ident" id="1247271">n</span><span class="op" id="1247272">;</span>&nbsp;<span class="ident" id="1247274">i</span><span class="op" id="1247275">++</span>&nbsp;<span class="op" id="1247278">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1247283">&lt;-</span><span class="ident" id="1247285">After</span><span class="op" id="1247290">(</span><span class="num" id="1247291">1</span><span class="op" id="1247292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1247296">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1247299">}</span><span class="op" id="1247300">)</span><br>
<span class="lineno"></span><span class="op" id="1247302">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="1247305">func</span>&nbsp;<span class="ident" id="1247310">BenchmarkStop</span><span class="op" id="1247323">(</span><span class="ident" id="1247324">b</span>&nbsp;<span class="op" id="1247326">*</span><span class="ident" id="1247327">testing</span><span class="op" id="1247334">.</span><span class="ident" id="1247335">B</span><span class="op" id="1247336">)</span>&nbsp;<span class="op" id="1247338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1247341">benchmark</span><span class="op" id="1247350">(</span><span class="ident" id="1247351">b</span><span class="op" id="1247352">,</span>&nbsp;<span class="keyword" id="1247354">func</span><span class="op" id="1247358">(</span><span class="ident" id="1247359">n</span>&nbsp;<span class="builtintype" id="1247361">int</span><span class="op" id="1247364">)</span>&nbsp;<span class="op" id="1247366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1247370">for</span>&nbsp;<span class="ident" id="1247374">i</span>&nbsp;<span class="op" id="1247376">:=</span>&nbsp;<span class="num" id="1247379">0</span><span class="op" id="1247380">;</span>&nbsp;<span class="ident" id="1247382">i</span>&nbsp;<span class="op" id="1247384">&lt;</span>&nbsp;<span class="ident" id="1247386">n</span><span class="op" id="1247387">;</span>&nbsp;<span class="ident" id="1247389">i</span><span class="op" id="1247390">++</span>&nbsp;<span class="op" id="1247393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1247398">NewTimer</span><span class="op" id="1247406">(</span><span class="num" id="1247407">1</span>&nbsp;<span class="op" id="1247409">*</span>&nbsp;<span class="ident" id="1247411">Second</span><span class="op" id="1247417">)</span><span class="op" id="1247418">.</span><span class="ident" id="1247419">Stop</span><span class="op" id="1247423">(</span><span class="op" id="1247424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1247428">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1247431">}</span><span class="op" id="1247432">)</span><br>
<span class="lineno"></span><span class="op" id="1247434">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1247437">func</span>&nbsp;<span class="ident" id="1247442">BenchmarkSimultaneousAfterFunc</span><span class="op" id="1247472">(</span><span class="ident" id="1247473">b</span>&nbsp;<span class="op" id="1247475">*</span><span class="ident" id="1247476">testing</span><span class="op" id="1247483">.</span><span class="ident" id="1247484">B</span><span class="op" id="1247485">)</span>&nbsp;<span class="op" id="1247487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1247490">benchmark</span><span class="op" id="1247499">(</span><span class="ident" id="1247500">b</span><span class="op" id="1247501">,</span>&nbsp;<span class="keyword" id="1247503">func</span><span class="op" id="1247507">(</span><span class="ident" id="1247508">n</span>&nbsp;<span class="builtintype" id="1247510">int</span><span class="op" id="1247513">)</span>&nbsp;<span class="op" id="1247515">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1247519">var</span>&nbsp;<span class="ident" id="1247523">wg</span>&nbsp;<span class="ident" id="1247526">sync</span><span class="op" id="1247530">.</span><span class="ident" id="1247531">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1247543">wg</span><span class="op" id="1247545">.</span><span class="ident" id="1247546">Add</span><span class="op" id="1247549">(</span><span class="ident" id="1247550">n</span><span class="op" id="1247551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1247555">for</span>&nbsp;<span class="ident" id="1247559">i</span>&nbsp;<span class="op" id="1247561">:=</span>&nbsp;<span class="num" id="1247564">0</span><span class="op" id="1247565">;</span>&nbsp;<span class="ident" id="1247567">i</span>&nbsp;<span class="op" id="1247569">&lt;</span>&nbsp;<span class="ident" id="1247571">n</span><span class="op" id="1247572">;</span>&nbsp;<span class="ident" id="1247574">i</span><span class="op" id="1247575">++</span>&nbsp;<span class="op" id="1247578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1247583">AfterFunc</span><span class="op" id="1247592">(</span><span class="num" id="1247593">0</span><span class="op" id="1247594">,</span>&nbsp;<span class="ident" id="1247596">wg</span><span class="op" id="1247598">.</span><span class="ident" id="1247599">Done</span><span class="op" id="1247603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1247607">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1247611">wg</span><span class="op" id="1247613">.</span><span class="ident" id="1247614">Wait</span><span class="op" id="1247618">(</span><span class="op" id="1247619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1247622">}</span><span class="op" id="1247623">)</span><br>
<span class="lineno"></span><span class="op" id="1247625">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1247628">func</span>&nbsp;<span class="ident" id="1247633">BenchmarkStartStop</span><span class="op" id="1247651">(</span><span class="ident" id="1247652">b</span>&nbsp;<span class="op" id="1247654">*</span><span class="ident" id="1247655">testing</span><span class="op" id="1247662">.</span><span class="ident" id="1247663">B</span><span class="op" id="1247664">)</span>&nbsp;<span class="op" id="1247666">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1247669">benchmark</span><span class="op" id="1247678">(</span><span class="ident" id="1247679">b</span><span class="op" id="1247680">,</span>&nbsp;<span class="keyword" id="1247682">func</span><span class="op" id="1247686">(</span><span class="ident" id="1247687">n</span>&nbsp;<span class="builtintype" id="1247689">int</span><span class="op" id="1247692">)</span>&nbsp;<span class="op" id="1247694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1247698">timers</span>&nbsp;<span class="op" id="1247705">:=</span>&nbsp;<span class="builtinfunc" id="1247708">make</span><span class="op" id="1247712">(</span><span class="op" id="1247713">[</span><span class="op" id="1247714">]</span><span class="op" id="1247715">*</span><span class="ident" id="1247716">Timer</span><span class="op" id="1247721">,</span>&nbsp;<span class="ident" id="1247723">n</span><span class="op" id="1247724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1247728">for</span>&nbsp;<span class="ident" id="1247732">i</span>&nbsp;<span class="op" id="1247734">:=</span>&nbsp;<span class="num" id="1247737">0</span><span class="op" id="1247738">;</span>&nbsp;<span class="ident" id="1247740">i</span>&nbsp;<span class="op" id="1247742">&lt;</span>&nbsp;<span class="ident" id="1247744">n</span><span class="op" id="1247745">;</span>&nbsp;<span class="ident" id="1247747">i</span><span class="op" id="1247748">++</span>&nbsp;<span class="op" id="1247751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1247756">timers</span><span class="op" id="1247762">[</span><span class="ident" id="1247763">i</span><span class="op" id="1247764">]</span>&nbsp;<span class="op" id="1247766">=</span>&nbsp;<span class="ident" id="1247768">AfterFunc</span><span class="op" id="1247777">(</span><span class="ident" id="1247778">Hour</span><span class="op" id="1247782">,</span>&nbsp;<span class="ident" id="1247784">nil</span><span class="op" id="1247787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1247791">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1247796">for</span>&nbsp;<span class="ident" id="1247800">i</span>&nbsp;<span class="op" id="1247802">:=</span>&nbsp;<span class="num" id="1247805">0</span><span class="op" id="1247806">;</span>&nbsp;<span class="ident" id="1247808">i</span>&nbsp;<span class="op" id="1247810">&lt;</span>&nbsp;<span class="ident" id="1247812">n</span><span class="op" id="1247813">;</span>&nbsp;<span class="ident" id="1247815">i</span><span class="op" id="1247816">++</span>&nbsp;<span class="op" id="1247819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1247824">timers</span><span class="op" id="1247830">[</span><span class="ident" id="1247831">i</span><span class="op" id="1247832">]</span><span class="op" id="1247833">.</span><span class="ident" id="1247834">Stop</span><span class="op" id="1247838">(</span><span class="op" id="1247839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1247843">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1247846">}</span><span class="op" id="1247847">)</span><br>
<span class="lineno">160</span><span class="op" id="1247849">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1247852">func</span>&nbsp;<span class="ident" id="1247857">TestAfter</span><span class="op" id="1247866">(</span><span class="ident" id="1247867">t</span>&nbsp;<span class="op" id="1247869">*</span><span class="ident" id="1247870">testing</span><span class="op" id="1247877">.</span><span class="ident" id="1247878">T</span><span class="op" id="1247879">)</span>&nbsp;<span class="op" id="1247881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1247884">const</span>&nbsp;<span class="ident" id="1247890">delay</span>&nbsp;<span class="op" id="1247896">=</span>&nbsp;<span class="num" id="1247898">100</span>&nbsp;<span class="op" id="1247902">*</span>&nbsp;<span class="ident" id="1247904">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1247917">start</span>&nbsp;<span class="op" id="1247923">:=</span>&nbsp;<span class="ident" id="1247926">Now</span><span class="op" id="1247929">(</span><span class="op" id="1247930">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1247933">end</span>&nbsp;<span class="op" id="1247937">:=</span>&nbsp;<span class="op" id="1247940">&lt;-</span><span class="ident" id="1247942">After</span><span class="op" id="1247947">(</span><span class="ident" id="1247948">delay</span><span class="op" id="1247953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1247956">delayadj</span>&nbsp;<span class="op" id="1247965">:=</span>&nbsp;<span class="ident" id="1247968">delay</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1247975">if</span>&nbsp;<span class="ident" id="1247978">runtime</span><span class="op" id="1247985">.</span><span class="ident" id="1247986">GOOS</span>&nbsp;<span class="op" id="1247991">==</span>&nbsp;<span class="string" id="1247994">&#34;windows&#34;</span>&nbsp;<span class="op" id="1248004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1248008">delayadj</span>&nbsp;<span class="op" id="1248017">-=</span>&nbsp;<span class="ident" id="1248020">windowsInaccuracy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1248039">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1248042">if</span>&nbsp;<span class="ident" id="1248045">duration</span>&nbsp;<span class="op" id="1248054">:=</span>&nbsp;<span class="ident" id="1248057">Now</span><span class="op" id="1248060">(</span><span class="op" id="1248061">)</span><span class="op" id="1248062">.</span><span class="ident" id="1248063">Sub</span><span class="op" id="1248066">(</span><span class="ident" id="1248067">start</span><span class="op" id="1248072">)</span><span class="op" id="1248073">;</span>&nbsp;<span class="ident" id="1248075">duration</span>&nbsp;<span class="op" id="1248084">&lt;</span>&nbsp;<span class="ident" id="1248086">delayadj</span>&nbsp;<span class="op" id="1248095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1248099">t</span><span class="op" id="1248100">.</span><span class="ident" id="1248101">Fatalf</span><span class="op" id="1248107">(</span><span class="string" id="1248108">&#34;After(%s)&nbsp;slept&nbsp;for&nbsp;only&nbsp;%d&nbsp;ns&#34;</span><span class="op" id="1248140">,</span>&nbsp;<span class="ident" id="1248142">delay</span><span class="op" id="1248147">,</span>&nbsp;<span class="ident" id="1248149">duration</span><span class="op" id="1248157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1248160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1248163">if</span>&nbsp;<span class="ident" id="1248166">min</span>&nbsp;<span class="op" id="1248170">:=</span>&nbsp;<span class="ident" id="1248173">start</span><span class="op" id="1248178">.</span><span class="ident" id="1248179">Add</span><span class="op" id="1248182">(</span><span class="ident" id="1248183">delayadj</span><span class="op" id="1248191">)</span><span class="op" id="1248192">;</span>&nbsp;<span class="ident" id="1248194">end</span><span class="op" id="1248197">.</span><span class="ident" id="1248198">Before</span><span class="op" id="1248204">(</span><span class="ident" id="1248205">min</span><span class="op" id="1248208">)</span>&nbsp;<span class="op" id="1248210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1248214">t</span><span class="op" id="1248215">.</span><span class="ident" id="1248216">Fatalf</span><span class="op" id="1248222">(</span><span class="string" id="1248223">&#34;After(%s)&nbsp;expect&nbsp;&gt;=&nbsp;%s,&nbsp;got&nbsp;%s&#34;</span><span class="op" id="1248255">,</span>&nbsp;<span class="ident" id="1248257">delay</span><span class="op" id="1248262">,</span>&nbsp;<span class="ident" id="1248264">min</span><span class="op" id="1248267">,</span>&nbsp;<span class="ident" id="1248269">end</span><span class="op" id="1248272">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1248275">}</span><br>
<span class="lineno"></span><span class="op" id="1248277">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1248280">func</span>&nbsp;<span class="ident" id="1248285">TestAfterTick</span><span class="op" id="1248298">(</span><span class="ident" id="1248299">t</span>&nbsp;<span class="op" id="1248301">*</span><span class="ident" id="1248302">testing</span><span class="op" id="1248309">.</span><span class="ident" id="1248310">T</span><span class="op" id="1248311">)</span>&nbsp;<span class="op" id="1248313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1248316">const</span>&nbsp;<span class="ident" id="1248322">Count</span>&nbsp;<span class="op" id="1248328">=</span>&nbsp;<span class="num" id="1248330">10</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1248334">Delta</span>&nbsp;<span class="op" id="1248340">:=</span>&nbsp;<span class="num" id="1248343">100</span>&nbsp;<span class="op" id="1248347">*</span>&nbsp;<span class="ident" id="1248349">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1248362">if</span>&nbsp;<span class="ident" id="1248365">testing</span><span class="op" id="1248372">.</span><span class="ident" id="1248373">Short</span><span class="op" id="1248378">(</span><span class="op" id="1248379">)</span>&nbsp;<span class="op" id="1248381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1248385">Delta</span>&nbsp;<span class="op" id="1248391">=</span>&nbsp;<span class="num" id="1248393">10</span>&nbsp;<span class="op" id="1248396">*</span>&nbsp;<span class="ident" id="1248398">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1248411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1248414">t0</span>&nbsp;<span class="op" id="1248417">:=</span>&nbsp;<span class="ident" id="1248420">Now</span><span class="op" id="1248423">(</span><span class="op" id="1248424">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1248427">for</span>&nbsp;<span class="ident" id="1248431">i</span>&nbsp;<span class="op" id="1248433">:=</span>&nbsp;<span class="num" id="1248436">0</span><span class="op" id="1248437">;</span>&nbsp;<span class="ident" id="1248439">i</span>&nbsp;<span class="op" id="1248441">&lt;</span>&nbsp;<span class="ident" id="1248443">Count</span><span class="op" id="1248448">;</span>&nbsp;<span class="ident" id="1248450">i</span><span class="op" id="1248451">++</span>&nbsp;<span class="op" id="1248454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1248458">&lt;-</span><span class="ident" id="1248460">After</span><span class="op" id="1248465">(</span><span class="ident" id="1248466">Delta</span><span class="op" id="1248471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1248474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1248477">t1</span>&nbsp;<span class="op" id="1248480">:=</span>&nbsp;<span class="ident" id="1248483">Now</span><span class="op" id="1248486">(</span><span class="op" id="1248487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1248490">d</span>&nbsp;<span class="op" id="1248492">:=</span>&nbsp;<span class="ident" id="1248495">t1</span><span class="op" id="1248497">.</span><span class="ident" id="1248498">Sub</span><span class="op" id="1248501">(</span><span class="ident" id="1248502">t0</span><span class="op" id="1248504">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1248507">target</span>&nbsp;<span class="op" id="1248514">:=</span>&nbsp;<span class="ident" id="1248517">Delta</span>&nbsp;<span class="op" id="1248523">*</span>&nbsp;<span class="ident" id="1248525">Count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1248532">if</span>&nbsp;<span class="ident" id="1248535">d</span>&nbsp;<span class="op" id="1248537">&lt;</span>&nbsp;<span class="ident" id="1248539">target</span><span class="op" id="1248545">*</span><span class="num" id="1248546">9</span><span class="op" id="1248547">/</span><span class="num" id="1248548">10</span>&nbsp;<span class="op" id="1248551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1248555">t</span><span class="op" id="1248556">.</span><span class="ident" id="1248557">Fatalf</span><span class="op" id="1248563">(</span><span class="string" id="1248564">&#34;%d&nbsp;ticks&nbsp;of&nbsp;%s&nbsp;too&nbsp;fast:&nbsp;took&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="1248611">,</span>&nbsp;<span class="ident" id="1248613">Count</span><span class="op" id="1248618">,</span>&nbsp;<span class="ident" id="1248620">Delta</span><span class="op" id="1248625">,</span>&nbsp;<span class="ident" id="1248627">d</span><span class="op" id="1248628">,</span>&nbsp;<span class="ident" id="1248630">target</span><span class="op" id="1248636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1248639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1248642">if</span>&nbsp;<span class="op" id="1248645">!</span><span class="ident" id="1248646">testing</span><span class="op" id="1248653">.</span><span class="ident" id="1248654">Short</span><span class="op" id="1248659">(</span><span class="op" id="1248660">)</span>&nbsp;<span class="op" id="1248662">&amp;&amp;</span>&nbsp;<span class="ident" id="1248665">d</span>&nbsp;<span class="op" id="1248667">&gt;</span>&nbsp;<span class="ident" id="1248669">target</span><span class="op" id="1248675">*</span><span class="num" id="1248676">30</span><span class="op" id="1248678">/</span><span class="num" id="1248679">10</span>&nbsp;<span class="op" id="1248682">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1248686">t</span><span class="op" id="1248687">.</span><span class="ident" id="1248688">Fatalf</span><span class="op" id="1248694">(</span><span class="string" id="1248695">&#34;%d&nbsp;ticks&nbsp;of&nbsp;%s&nbsp;too&nbsp;slow:&nbsp;took&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="1248742">,</span>&nbsp;<span class="ident" id="1248744">Count</span><span class="op" id="1248749">,</span>&nbsp;<span class="ident" id="1248751">Delta</span><span class="op" id="1248756">,</span>&nbsp;<span class="ident" id="1248758">d</span><span class="op" id="1248759">,</span>&nbsp;<span class="ident" id="1248761">target</span><span class="op" id="1248767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1248770">}</span><br>
<span class="lineno"></span><span class="op" id="1248772">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1248775">func</span>&nbsp;<span class="ident" id="1248780">TestAfterStop</span><span class="op" id="1248793">(</span><span class="ident" id="1248794">t</span>&nbsp;<span class="op" id="1248796">*</span><span class="ident" id="1248797">testing</span><span class="op" id="1248804">.</span><span class="ident" id="1248805">T</span><span class="op" id="1248806">)</span>&nbsp;<span class="op" id="1248808">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1248811">AfterFunc</span><span class="op" id="1248820">(</span><span class="num" id="1248821">100</span><span class="op" id="1248824">*</span><span class="ident" id="1248825">Millisecond</span><span class="op" id="1248836">,</span>&nbsp;<span class="keyword" id="1248838">func</span><span class="op" id="1248842">(</span><span class="op" id="1248843">)</span>&nbsp;<span class="op" id="1248845">{</span><span class="op" id="1248846">}</span><span class="op" id="1248847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1248850">t0</span>&nbsp;<span class="op" id="1248853">:=</span>&nbsp;<span class="ident" id="1248856">NewTimer</span><span class="op" id="1248864">(</span><span class="num" id="1248865">50</span>&nbsp;<span class="op" id="1248868">*</span>&nbsp;<span class="ident" id="1248870">Millisecond</span><span class="op" id="1248881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1248884">c1</span>&nbsp;<span class="op" id="1248887">:=</span>&nbsp;<span class="builtinfunc" id="1248890">make</span><span class="op" id="1248894">(</span><span class="keyword" id="1248895">chan</span>&nbsp;<span class="builtintype" id="1248900">bool</span><span class="op" id="1248904">,</span>&nbsp;<span class="num" id="1248906">1</span><span class="op" id="1248907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1248910">t1</span>&nbsp;<span class="op" id="1248913">:=</span>&nbsp;<span class="ident" id="1248916">AfterFunc</span><span class="op" id="1248925">(</span><span class="num" id="1248926">150</span><span class="op" id="1248929">*</span><span class="ident" id="1248930">Millisecond</span><span class="op" id="1248941">,</span>&nbsp;<span class="keyword" id="1248943">func</span><span class="op" id="1248947">(</span><span class="op" id="1248948">)</span>&nbsp;<span class="op" id="1248950">{</span>&nbsp;<span class="ident" id="1248952">c1</span>&nbsp;<span class="op" id="1248955">&lt;-</span>&nbsp;<span class="builtintype" id="1248958">true</span>&nbsp;<span class="op" id="1248963">}</span><span class="op" id="1248964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1248967">c2</span>&nbsp;<span class="op" id="1248970">:=</span>&nbsp;<span class="ident" id="1248973">After</span><span class="op" id="1248978">(</span><span class="num" id="1248979">200</span>&nbsp;<span class="op" id="1248983">*</span>&nbsp;<span class="ident" id="1248985">Millisecond</span><span class="op" id="1248996">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1248999">if</span>&nbsp;<span class="op" id="1249002">!</span><span class="ident" id="1249003">t0</span><span class="op" id="1249005">.</span><span class="ident" id="1249006">Stop</span><span class="op" id="1249010">(</span><span class="op" id="1249011">)</span>&nbsp;<span class="op" id="1249013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1249017">t</span><span class="op" id="1249018">.</span><span class="ident" id="1249019">Fatalf</span><span class="op" id="1249025">(</span><span class="string" id="1249026">&#34;failed&nbsp;to&nbsp;stop&nbsp;event&nbsp;0&#34;</span><span class="op" id="1249050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1249053">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1249056">if</span>&nbsp;<span class="op" id="1249059">!</span><span class="ident" id="1249060">t1</span><span class="op" id="1249062">.</span><span class="ident" id="1249063">Stop</span><span class="op" id="1249067">(</span><span class="op" id="1249068">)</span>&nbsp;<span class="op" id="1249070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1249074">t</span><span class="op" id="1249075">.</span><span class="ident" id="1249076">Fatalf</span><span class="op" id="1249082">(</span><span class="string" id="1249083">&#34;failed&nbsp;to&nbsp;stop&nbsp;event&nbsp;1&#34;</span><span class="op" id="1249107">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1249110">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1249113">&lt;-</span><span class="ident" id="1249115">c2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1249119">select</span>&nbsp;<span class="op" id="1249126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1249129">case</span>&nbsp;<span class="op" id="1249134">&lt;-</span><span class="ident" id="1249136">t0</span><span class="op" id="1249138">.</span><span class="ident" id="1249139">C</span><span class="op" id="1249140">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1249144">t</span><span class="op" id="1249145">.</span><span class="ident" id="1249146">Fatalf</span><span class="op" id="1249152">(</span><span class="string" id="1249153">&#34;event&nbsp;0&nbsp;was&nbsp;not&nbsp;stopped&#34;</span><span class="op" id="1249178">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1249181">case</span>&nbsp;<span class="op" id="1249186">&lt;-</span><span class="ident" id="1249188">c1</span><span class="op" id="1249190">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1249194">t</span><span class="op" id="1249195">.</span><span class="ident" id="1249196">Fatalf</span><span class="op" id="1249202">(</span><span class="string" id="1249203">&#34;event&nbsp;1&nbsp;was&nbsp;not&nbsp;stopped&#34;</span><span class="op" id="1249228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1249231">default</span><span class="op" id="1249238">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1249241">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1249244">if</span>&nbsp;<span class="ident" id="1249247">t1</span><span class="op" id="1249249">.</span><span class="ident" id="1249250">Stop</span><span class="op" id="1249254">(</span><span class="op" id="1249255">)</span>&nbsp;<span class="op" id="1249257">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1249261">t</span><span class="op" id="1249262">.</span><span class="ident" id="1249263">Fatalf</span><span class="op" id="1249269">(</span><span class="string" id="1249270">&#34;Stop&nbsp;returned&nbsp;true&nbsp;twice&#34;</span><span class="op" id="1249296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1249299">}</span><br>
<span class="lineno"></span><span class="op" id="1249301">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1249304">func</span>&nbsp;<span class="ident" id="1249309">TestAfterQueuing</span><span class="op" id="1249325">(</span><span class="ident" id="1249326">t</span>&nbsp;<span class="op" id="1249328">*</span><span class="ident" id="1249329">testing</span><span class="op" id="1249336">.</span><span class="ident" id="1249337">T</span><span class="op" id="1249338">)</span>&nbsp;<span class="op" id="1249340">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1249343">//&nbsp;This&nbsp;test&nbsp;flakes&nbsp;out&nbsp;on&nbsp;some&nbsp;systems,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1249385">//&nbsp;so&nbsp;we&#39;ll&nbsp;try&nbsp;it&nbsp;a&nbsp;few&nbsp;times&nbsp;before&nbsp;declaring&nbsp;it&nbsp;a&nbsp;failure.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1249448">const</span>&nbsp;<span class="ident" id="1249454">attempts</span>&nbsp;<span class="op" id="1249463">=</span>&nbsp;<span class="num" id="1249465">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1249468">err</span>&nbsp;<span class="op" id="1249472">:=</span>&nbsp;<span class="ident" id="1249475">errors</span><span class="op" id="1249481">.</span><span class="ident" id="1249482">New</span><span class="op" id="1249485">(</span><span class="string" id="1249486">&#34;!=nil&#34;</span><span class="op" id="1249493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1249496">for</span>&nbsp;<span class="ident" id="1249500">i</span>&nbsp;<span class="op" id="1249502">:=</span>&nbsp;<span class="num" id="1249505">0</span><span class="op" id="1249506">;</span>&nbsp;<span class="ident" id="1249508">i</span>&nbsp;<span class="op" id="1249510">&lt;</span>&nbsp;<span class="ident" id="1249512">attempts</span>&nbsp;<span class="op" id="1249521">&amp;&amp;</span>&nbsp;<span class="ident" id="1249524">err</span>&nbsp;<span class="op" id="1249528">!=</span>&nbsp;<span class="ident" id="1249531">nil</span><span class="op" id="1249534">;</span>&nbsp;<span class="ident" id="1249536">i</span><span class="op" id="1249537">++</span>&nbsp;<span class="op" id="1249540">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1249544">if</span>&nbsp;<span class="ident" id="1249547">err</span>&nbsp;<span class="op" id="1249551">=</span>&nbsp;<span class="ident" id="1249553">testAfterQueuing</span><span class="op" id="1249569">(</span><span class="ident" id="1249570">t</span><span class="op" id="1249571">)</span><span class="op" id="1249572">;</span>&nbsp;<span class="ident" id="1249574">err</span>&nbsp;<span class="op" id="1249578">!=</span>&nbsp;<span class="ident" id="1249581">nil</span>&nbsp;<span class="op" id="1249585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1249590">t</span><span class="op" id="1249591">.</span><span class="ident" id="1249592">Logf</span><span class="op" id="1249596">(</span><span class="string" id="1249597">&#34;attempt&nbsp;%v&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="1249620">,</span>&nbsp;<span class="ident" id="1249622">i</span><span class="op" id="1249623">,</span>&nbsp;<span class="ident" id="1249625">err</span><span class="op" id="1249628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1249632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1249635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1249638">if</span>&nbsp;<span class="ident" id="1249641">err</span>&nbsp;<span class="op" id="1249645">!=</span>&nbsp;<span class="ident" id="1249648">nil</span>&nbsp;<span class="op" id="1249652">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1249656">t</span><span class="op" id="1249657">.</span><span class="ident" id="1249658">Fatal</span><span class="op" id="1249663">(</span><span class="ident" id="1249664">err</span><span class="op" id="1249667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1249670">}</span><br>
<span class="lineno"></span><span class="op" id="1249672">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1249675">var</span>&nbsp;<span class="ident" id="1249679">slots</span>&nbsp;<span class="op" id="1249685">=</span>&nbsp;<span class="op" id="1249687">[</span><span class="op" id="1249688">]</span><span class="builtintype" id="1249689">int</span><span class="op" id="1249692">{</span><span class="num" id="1249693">5</span><span class="op" id="1249694">,</span>&nbsp;<span class="num" id="1249696">3</span><span class="op" id="1249697">,</span>&nbsp;<span class="num" id="1249699">6</span><span class="op" id="1249700">,</span>&nbsp;<span class="num" id="1249702">6</span><span class="op" id="1249703">,</span>&nbsp;<span class="num" id="1249705">6</span><span class="op" id="1249706">,</span>&nbsp;<span class="num" id="1249708">1</span><span class="op" id="1249709">,</span>&nbsp;<span class="num" id="1249711">1</span><span class="op" id="1249712">,</span>&nbsp;<span class="num" id="1249714">2</span><span class="op" id="1249715">,</span>&nbsp;<span class="num" id="1249717">7</span><span class="op" id="1249718">,</span>&nbsp;<span class="num" id="1249720">9</span><span class="op" id="1249721">,</span>&nbsp;<span class="num" id="1249723">4</span><span class="op" id="1249724">,</span>&nbsp;<span class="num" id="1249726">8</span><span class="op" id="1249727">,</span>&nbsp;<span class="num" id="1249729">0</span><span class="op" id="1249730">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span><span class="keyword" id="1249733">type</span>&nbsp;<span class="ident" id="1249738">afterResult</span>&nbsp;<span class="keyword" id="1249750">struct</span>&nbsp;<span class="op" id="1249757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1249760">slot</span>&nbsp;<span class="builtintype" id="1249765">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1249770">t</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1249775">Time</span><br>
<span class="lineno"></span><span class="op" id="1249780">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span><span class="keyword" id="1249783">func</span>&nbsp;<span class="ident" id="1249788">await</span><span class="op" id="1249793">(</span><span class="ident" id="1249794">slot</span>&nbsp;<span class="builtintype" id="1249799">int</span><span class="op" id="1249802">,</span>&nbsp;<span class="ident" id="1249804">result</span>&nbsp;<span class="keyword" id="1249811">chan</span><span class="op" id="1249815">&lt;-</span>&nbsp;<span class="ident" id="1249818">afterResult</span><span class="op" id="1249829">,</span>&nbsp;<span class="ident" id="1249831">ac</span>&nbsp;<span class="op" id="1249834">&lt;-</span><span class="keyword" id="1249836">chan</span>&nbsp;<span class="ident" id="1249841">Time</span><span class="op" id="1249845">)</span>&nbsp;<span class="op" id="1249847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1249850">result</span>&nbsp;<span class="op" id="1249857">&lt;-</span>&nbsp;<span class="ident" id="1249860">afterResult</span><span class="op" id="1249871">{</span><span class="ident" id="1249872">slot</span><span class="op" id="1249876">,</span>&nbsp;<span class="op" id="1249878">&lt;-</span><span class="ident" id="1249880">ac</span><span class="op" id="1249882">}</span><br>
<span class="lineno"></span><span class="op" id="1249884">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span><span class="keyword" id="1249887">func</span>&nbsp;<span class="ident" id="1249892">testAfterQueuing</span><span class="op" id="1249908">(</span><span class="ident" id="1249909">t</span>&nbsp;<span class="op" id="1249911">*</span><span class="ident" id="1249912">testing</span><span class="op" id="1249919">.</span><span class="ident" id="1249920">T</span><span class="op" id="1249921">)</span>&nbsp;<span class="builtintype" id="1249923">error</span>&nbsp;<span class="op" id="1249929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1249932">Delta</span>&nbsp;<span class="op" id="1249938">:=</span>&nbsp;<span class="num" id="1249941">100</span>&nbsp;<span class="op" id="1249945">*</span>&nbsp;<span class="ident" id="1249947">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1249960">if</span>&nbsp;<span class="ident" id="1249963">testing</span><span class="op" id="1249970">.</span><span class="ident" id="1249971">Short</span><span class="op" id="1249976">(</span><span class="op" id="1249977">)</span>&nbsp;<span class="op" id="1249979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1249983">Delta</span>&nbsp;<span class="op" id="1249989">=</span>&nbsp;<span class="num" id="1249991">20</span>&nbsp;<span class="op" id="1249994">*</span>&nbsp;<span class="ident" id="1249996">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1250009">}</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1250012">//&nbsp;make&nbsp;the&nbsp;result&nbsp;channel&nbsp;buffered&nbsp;because&nbsp;we&nbsp;don&#39;t&nbsp;want</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1250071">//&nbsp;to&nbsp;depend&nbsp;on&nbsp;channel&nbsp;queueing&nbsp;semantics&nbsp;that&nbsp;might</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1250126">//&nbsp;possibly&nbsp;change&nbsp;in&nbsp;the&nbsp;future.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1250161">result</span>&nbsp;<span class="op" id="1250168">:=</span>&nbsp;<span class="builtinfunc" id="1250171">make</span><span class="op" id="1250175">(</span><span class="keyword" id="1250176">chan</span>&nbsp;<span class="ident" id="1250181">afterResult</span><span class="op" id="1250192">,</span>&nbsp;<span class="builtinfunc" id="1250194">len</span><span class="op" id="1250197">(</span><span class="ident" id="1250198">slots</span><span class="op" id="1250203">)</span><span class="op" id="1250204">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1250208">t0</span>&nbsp;<span class="op" id="1250211">:=</span>&nbsp;<span class="ident" id="1250214">Now</span><span class="op" id="1250217">(</span><span class="op" id="1250218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1250221">for</span>&nbsp;<span class="ident" id="1250225">_</span><span class="op" id="1250226">,</span>&nbsp;<span class="ident" id="1250228">slot</span>&nbsp;<span class="op" id="1250233">:=</span>&nbsp;<span class="keyword" id="1250236">range</span>&nbsp;<span class="ident" id="1250242">slots</span>&nbsp;<span class="op" id="1250248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1250252">go</span>&nbsp;<span class="ident" id="1250255">await</span><span class="op" id="1250260">(</span><span class="ident" id="1250261">slot</span><span class="op" id="1250265">,</span>&nbsp;<span class="ident" id="1250267">result</span><span class="op" id="1250273">,</span>&nbsp;<span class="ident" id="1250275">After</span><span class="op" id="1250280">(</span><span class="ident" id="1250281">Duration</span><span class="op" id="1250289">(</span><span class="ident" id="1250290">slot</span><span class="op" id="1250294">)</span><span class="op" id="1250295">*</span><span class="ident" id="1250296">Delta</span><span class="op" id="1250301">)</span><span class="op" id="1250302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1250305">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1250308">sort</span><span class="op" id="1250312">.</span><span class="ident" id="1250313">Ints</span><span class="op" id="1250317">(</span><span class="ident" id="1250318">slots</span><span class="op" id="1250323">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1250326">for</span>&nbsp;<span class="ident" id="1250330">_</span><span class="op" id="1250331">,</span>&nbsp;<span class="ident" id="1250333">slot</span>&nbsp;<span class="op" id="1250338">:=</span>&nbsp;<span class="keyword" id="1250341">range</span>&nbsp;<span class="ident" id="1250347">slots</span>&nbsp;<span class="op" id="1250353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1250357">r</span>&nbsp;<span class="op" id="1250359">:=</span>&nbsp;<span class="op" id="1250362">&lt;-</span><span class="ident" id="1250364">result</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1250373">if</span>&nbsp;<span class="ident" id="1250376">r</span><span class="op" id="1250377">.</span><span class="ident" id="1250378">slot</span>&nbsp;<span class="op" id="1250383">!=</span>&nbsp;<span class="ident" id="1250386">slot</span>&nbsp;<span class="op" id="1250391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1250396">return</span>&nbsp;<span class="ident" id="1250403">fmt</span><span class="op" id="1250406">.</span><span class="ident" id="1250407">Errorf</span><span class="op" id="1250413">(</span><span class="string" id="1250414">&#34;after&nbsp;slot&nbsp;%d,&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="1250442">,</span>&nbsp;<span class="ident" id="1250444">r</span><span class="op" id="1250445">.</span><span class="ident" id="1250446">slot</span><span class="op" id="1250450">,</span>&nbsp;<span class="ident" id="1250452">slot</span><span class="op" id="1250456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1250460">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1250464">dt</span>&nbsp;<span class="op" id="1250467">:=</span>&nbsp;<span class="ident" id="1250470">r</span><span class="op" id="1250471">.</span><span class="ident" id="1250472">t</span><span class="op" id="1250473">.</span><span class="ident" id="1250474">Sub</span><span class="op" id="1250477">(</span><span class="ident" id="1250478">t0</span><span class="op" id="1250480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1250484">target</span>&nbsp;<span class="op" id="1250491">:=</span>&nbsp;<span class="ident" id="1250494">Duration</span><span class="op" id="1250502">(</span><span class="ident" id="1250503">slot</span><span class="op" id="1250507">)</span>&nbsp;<span class="op" id="1250509">*</span>&nbsp;<span class="ident" id="1250511">Delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1250519">if</span>&nbsp;<span class="ident" id="1250522">dt</span>&nbsp;<span class="op" id="1250525">&lt;</span>&nbsp;<span class="ident" id="1250527">target</span><span class="op" id="1250533">-</span><span class="ident" id="1250534">Delta</span><span class="op" id="1250539">/</span><span class="num" id="1250540">2</span>&nbsp;<span class="op" id="1250542">||</span>&nbsp;<span class="ident" id="1250545">dt</span>&nbsp;<span class="op" id="1250548">&gt;</span>&nbsp;<span class="ident" id="1250550">target</span><span class="op" id="1250556">+</span><span class="ident" id="1250557">Delta</span><span class="op" id="1250562">*</span><span class="num" id="1250563">10</span>&nbsp;<span class="op" id="1250566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1250571">return</span>&nbsp;<span class="ident" id="1250578">fmt</span><span class="op" id="1250581">.</span><span class="ident" id="1250582">Errorf</span><span class="op" id="1250588">(</span><span class="string" id="1250589">&#34;After(%s)&nbsp;arrived&nbsp;at&nbsp;%s,&nbsp;expected&nbsp;[%s,%s]&#34;</span><span class="op" id="1250632">,</span>&nbsp;<span class="ident" id="1250634">target</span><span class="op" id="1250640">,</span>&nbsp;<span class="ident" id="1250642">dt</span><span class="op" id="1250644">,</span>&nbsp;<span class="ident" id="1250646">target</span><span class="op" id="1250652">-</span><span class="ident" id="1250653">Delta</span><span class="op" id="1250658">/</span><span class="num" id="1250659">2</span><span class="op" id="1250660">,</span>&nbsp;<span class="ident" id="1250662">target</span><span class="op" id="1250668">+</span><span class="ident" id="1250669">Delta</span><span class="op" id="1250674">*</span><span class="num" id="1250675">10</span><span class="op" id="1250677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1250681">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1250684">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1250687">return</span>&nbsp;<span class="ident" id="1250694">nil</span><br>
<span class="lineno"></span><span class="op" id="1250698">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1250701">func</span>&nbsp;<span class="ident" id="1250706">TestTimerStopStress</span><span class="op" id="1250725">(</span><span class="ident" id="1250726">t</span>&nbsp;<span class="op" id="1250728">*</span><span class="ident" id="1250729">testing</span><span class="op" id="1250736">.</span><span class="ident" id="1250737">T</span><span class="op" id="1250738">)</span>&nbsp;<span class="op" id="1250740">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1250743">if</span>&nbsp;<span class="ident" id="1250746">testing</span><span class="op" id="1250753">.</span><span class="ident" id="1250754">Short</span><span class="op" id="1250759">(</span><span class="op" id="1250760">)</span>&nbsp;<span class="op" id="1250762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1250766">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1250774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1250777">for</span>&nbsp;<span class="ident" id="1250781">i</span>&nbsp;<span class="op" id="1250783">:=</span>&nbsp;<span class="num" id="1250786">0</span><span class="op" id="1250787">;</span>&nbsp;<span class="ident" id="1250789">i</span>&nbsp;<span class="op" id="1250791">&lt;</span>&nbsp;<span class="num" id="1250793">100</span><span class="op" id="1250796">;</span>&nbsp;<span class="ident" id="1250798">i</span><span class="op" id="1250799">++</span>&nbsp;<span class="op" id="1250802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1250806">go</span>&nbsp;<span class="keyword" id="1250809">func</span><span class="op" id="1250813">(</span><span class="ident" id="1250814">i</span>&nbsp;<span class="builtintype" id="1250816">int</span><span class="op" id="1250819">)</span>&nbsp;<span class="op" id="1250821">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1250826">timer</span>&nbsp;<span class="op" id="1250832">:=</span>&nbsp;<span class="ident" id="1250835">AfterFunc</span><span class="op" id="1250844">(</span><span class="num" id="1250845">2</span><span class="op" id="1250846">*</span><span class="ident" id="1250847">Second</span><span class="op" id="1250853">,</span>&nbsp;<span class="keyword" id="1250855">func</span><span class="op" id="1250859">(</span><span class="op" id="1250860">)</span>&nbsp;<span class="op" id="1250862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1250868">t</span><span class="op" id="1250869">.</span><span class="ident" id="1250870">Fatalf</span><span class="op" id="1250876">(</span><span class="string" id="1250877">&#34;timer&nbsp;%d&nbsp;was&nbsp;not&nbsp;stopped&#34;</span><span class="op" id="1250903">,</span>&nbsp;<span class="ident" id="1250905">i</span><span class="op" id="1250906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1250911">}</span><span class="op" id="1250912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1250917">Sleep</span><span class="op" id="1250922">(</span><span class="num" id="1250923">1</span>&nbsp;<span class="op" id="1250925">*</span>&nbsp;<span class="ident" id="1250927">Second</span><span class="op" id="1250933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1250938">timer</span><span class="op" id="1250943">.</span><span class="ident" id="1250944">Stop</span><span class="op" id="1250948">(</span><span class="op" id="1250949">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1250953">}</span><span class="op" id="1250954">(</span><span class="ident" id="1250955">i</span><span class="op" id="1250956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1250959">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1250962">Sleep</span><span class="op" id="1250967">(</span><span class="num" id="1250968">3</span>&nbsp;<span class="op" id="1250970">*</span>&nbsp;<span class="ident" id="1250972">Second</span><span class="op" id="1250978">)</span><br>
<span class="lineno"></span><span class="op" id="1250980">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">295</span><span class="keyword" id="1250983">func</span>&nbsp;<span class="ident" id="1250988">TestSleepZeroDeadlock</span><span class="op" id="1251009">(</span><span class="ident" id="1251010">t</span>&nbsp;<span class="op" id="1251012">*</span><span class="ident" id="1251013">testing</span><span class="op" id="1251020">.</span><span class="ident" id="1251021">T</span><span class="op" id="1251022">)</span>&nbsp;<span class="op" id="1251024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1251027">//&nbsp;Sleep(0)&nbsp;used&nbsp;to&nbsp;hang,&nbsp;the&nbsp;sequence&nbsp;of&nbsp;events&nbsp;was&nbsp;as&nbsp;follows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1251093">//&nbsp;Sleep(0)&nbsp;sets&nbsp;G&#39;s&nbsp;status&nbsp;to&nbsp;Gwaiting,&nbsp;but&nbsp;then&nbsp;immediately&nbsp;returns&nbsp;leaving&nbsp;the&nbsp;status.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1251184">//&nbsp;Then&nbsp;the&nbsp;goroutine&nbsp;calls&nbsp;e.g.&nbsp;new&nbsp;and&nbsp;falls&nbsp;down&nbsp;into&nbsp;the&nbsp;scheduler&nbsp;due&nbsp;to&nbsp;pending&nbsp;GC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1251275">//&nbsp;After&nbsp;the&nbsp;GC&nbsp;nobody&nbsp;wakes&nbsp;up&nbsp;the&nbsp;goroutine&nbsp;from&nbsp;Gwaiting&nbsp;status.</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1251344">defer</span>&nbsp;<span class="ident" id="1251350">runtime</span><span class="op" id="1251357">.</span><span class="ident" id="1251358">GOMAXPROCS</span><span class="op" id="1251368">(</span><span class="ident" id="1251369">runtime</span><span class="op" id="1251376">.</span><span class="ident" id="1251377">GOMAXPROCS</span><span class="op" id="1251387">(</span><span class="num" id="1251388">4</span><span class="op" id="1251389">)</span><span class="op" id="1251390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1251393">c</span>&nbsp;<span class="op" id="1251395">:=</span>&nbsp;<span class="builtinfunc" id="1251398">make</span><span class="op" id="1251402">(</span><span class="keyword" id="1251403">chan</span>&nbsp;<span class="builtintype" id="1251408">bool</span><span class="op" id="1251412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1251415">go</span>&nbsp;<span class="keyword" id="1251418">func</span><span class="op" id="1251422">(</span><span class="op" id="1251423">)</span>&nbsp;<span class="op" id="1251425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1251429">for</span>&nbsp;<span class="ident" id="1251433">i</span>&nbsp;<span class="op" id="1251435">:=</span>&nbsp;<span class="num" id="1251438">0</span><span class="op" id="1251439">;</span>&nbsp;<span class="ident" id="1251441">i</span>&nbsp;<span class="op" id="1251443">&lt;</span>&nbsp;<span class="num" id="1251445">100</span><span class="op" id="1251448">;</span>&nbsp;<span class="ident" id="1251450">i</span><span class="op" id="1251451">++</span>&nbsp;<span class="op" id="1251454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1251459">runtime</span><span class="op" id="1251466">.</span><span class="ident" id="1251467">GC</span><span class="op" id="1251469">(</span><span class="op" id="1251470">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1251474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1251478">c</span>&nbsp;<span class="op" id="1251480">&lt;-</span>&nbsp;<span class="builtintype" id="1251483">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1251489">}</span><span class="op" id="1251490">(</span><span class="op" id="1251491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1251494">for</span>&nbsp;<span class="ident" id="1251498">i</span>&nbsp;<span class="op" id="1251500">:=</span>&nbsp;<span class="num" id="1251503">0</span><span class="op" id="1251504">;</span>&nbsp;<span class="ident" id="1251506">i</span>&nbsp;<span class="op" id="1251508">&lt;</span>&nbsp;<span class="num" id="1251510">100</span><span class="op" id="1251513">;</span>&nbsp;<span class="ident" id="1251515">i</span><span class="op" id="1251516">++</span>&nbsp;<span class="op" id="1251519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1251523">Sleep</span><span class="op" id="1251528">(</span><span class="num" id="1251529">0</span><span class="op" id="1251530">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1251534">tmp</span>&nbsp;<span class="op" id="1251538">:=</span>&nbsp;<span class="builtinfunc" id="1251541">make</span><span class="op" id="1251545">(</span><span class="keyword" id="1251546">chan</span>&nbsp;<span class="builtintype" id="1251551">bool</span><span class="op" id="1251555">,</span>&nbsp;<span class="num" id="1251557">1</span><span class="op" id="1251558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1251562">tmp</span>&nbsp;<span class="op" id="1251566">&lt;-</span>&nbsp;<span class="builtintype" id="1251569">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1251576">&lt;-</span><span class="ident" id="1251578">tmp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1251583">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1251586">&lt;-</span><span class="ident" id="1251588">c</span><br>
<span class="lineno">315</span><span class="op" id="1251590">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1251593">func</span>&nbsp;<span class="ident" id="1251598">testReset</span><span class="op" id="1251607">(</span><span class="ident" id="1251608">d</span>&nbsp;<span class="ident" id="1251610">Duration</span><span class="op" id="1251618">)</span>&nbsp;<span class="builtintype" id="1251620">error</span>&nbsp;<span class="op" id="1251626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1251629">t0</span>&nbsp;<span class="op" id="1251632">:=</span>&nbsp;<span class="ident" id="1251635">NewTimer</span><span class="op" id="1251643">(</span><span class="num" id="1251644">2</span>&nbsp;<span class="op" id="1251646">*</span>&nbsp;<span class="ident" id="1251648">d</span><span class="op" id="1251649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1251652">Sleep</span><span class="op" id="1251657">(</span><span class="ident" id="1251658">d</span><span class="op" id="1251659">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1251662">if</span>&nbsp;<span class="ident" id="1251665">t0</span><span class="op" id="1251667">.</span><span class="ident" id="1251668">Reset</span><span class="op" id="1251673">(</span><span class="num" id="1251674">3</span><span class="op" id="1251675">*</span><span class="ident" id="1251676">d</span><span class="op" id="1251677">)</span>&nbsp;<span class="op" id="1251679">!=</span>&nbsp;<span class="builtintype" id="1251682">true</span>&nbsp;<span class="op" id="1251687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1251691">return</span>&nbsp;<span class="ident" id="1251698">errors</span><span class="op" id="1251704">.</span><span class="ident" id="1251705">New</span><span class="op" id="1251708">(</span><span class="string" id="1251709">&#34;resetting&nbsp;unfired&nbsp;timer&nbsp;returned&nbsp;false&#34;</span><span class="op" id="1251749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1251752">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1251755">Sleep</span><span class="op" id="1251760">(</span><span class="num" id="1251761">2</span>&nbsp;<span class="op" id="1251763">*</span>&nbsp;<span class="ident" id="1251765">d</span><span class="op" id="1251766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1251769">select</span>&nbsp;<span class="op" id="1251776">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1251779">case</span>&nbsp;<span class="op" id="1251784">&lt;-</span><span class="ident" id="1251786">t0</span><span class="op" id="1251788">.</span><span class="ident" id="1251789">C</span><span class="op" id="1251790">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1251794">return</span>&nbsp;<span class="ident" id="1251801">errors</span><span class="op" id="1251807">.</span><span class="ident" id="1251808">New</span><span class="op" id="1251811">(</span><span class="string" id="1251812">&#34;timer&nbsp;fired&nbsp;early&#34;</span><span class="op" id="1251831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1251834">default</span><span class="op" id="1251841">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1251844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1251847">Sleep</span><span class="op" id="1251852">(</span><span class="num" id="1251853">2</span>&nbsp;<span class="op" id="1251855">*</span>&nbsp;<span class="ident" id="1251857">d</span><span class="op" id="1251858">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1251861">select</span>&nbsp;<span class="op" id="1251868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1251871">case</span>&nbsp;<span class="op" id="1251876">&lt;-</span><span class="ident" id="1251878">t0</span><span class="op" id="1251880">.</span><span class="ident" id="1251881">C</span><span class="op" id="1251882">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1251885">default</span><span class="op" id="1251892">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1251896">return</span>&nbsp;<span class="ident" id="1251903">errors</span><span class="op" id="1251909">.</span><span class="ident" id="1251910">New</span><span class="op" id="1251913">(</span><span class="string" id="1251914">&#34;reset&nbsp;timer&nbsp;did&nbsp;not&nbsp;fire&#34;</span><span class="op" id="1251940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1251943">}</span><br>
<span class="lineno">335</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1251947">if</span>&nbsp;<span class="ident" id="1251950">t0</span><span class="op" id="1251952">.</span><span class="ident" id="1251953">Reset</span><span class="op" id="1251958">(</span><span class="num" id="1251959">50</span><span class="op" id="1251961">*</span><span class="ident" id="1251962">Millisecond</span><span class="op" id="1251973">)</span>&nbsp;<span class="op" id="1251975">!=</span>&nbsp;<span class="builtintype" id="1251978">false</span>&nbsp;<span class="op" id="1251984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1251988">return</span>&nbsp;<span class="ident" id="1251995">errors</span><span class="op" id="1252001">.</span><span class="ident" id="1252002">New</span><span class="op" id="1252005">(</span><span class="string" id="1252006">&#34;resetting&nbsp;expired&nbsp;timer&nbsp;returned&nbsp;true&#34;</span><span class="op" id="1252045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1252048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1252051">return</span>&nbsp;<span class="ident" id="1252058">nil</span><br>
<span class="lineno">340</span><span class="op" id="1252062">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1252065">func</span>&nbsp;<span class="ident" id="1252070">TestReset</span><span class="op" id="1252079">(</span><span class="ident" id="1252080">t</span>&nbsp;<span class="op" id="1252082">*</span><span class="ident" id="1252083">testing</span><span class="op" id="1252090">.</span><span class="ident" id="1252091">T</span><span class="op" id="1252092">)</span>&nbsp;<span class="op" id="1252094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1252097">//&nbsp;We&nbsp;try&nbsp;to&nbsp;run&nbsp;this&nbsp;test&nbsp;with&nbsp;increasingly&nbsp;larger&nbsp;multiples</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1252160">//&nbsp;until&nbsp;one&nbsp;works&nbsp;so&nbsp;slow,&nbsp;loaded&nbsp;hardware&nbsp;isn&#39;t&nbsp;as&nbsp;flaky,</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1252221">//&nbsp;but&nbsp;without&nbsp;slowing&nbsp;down&nbsp;fast&nbsp;machines&nbsp;unnecessarily.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1252279">const</span>&nbsp;<span class="ident" id="1252285">unit</span>&nbsp;<span class="op" id="1252290">=</span>&nbsp;<span class="num" id="1252292">25</span>&nbsp;<span class="op" id="1252295">*</span>&nbsp;<span class="ident" id="1252297">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1252310">tries</span>&nbsp;<span class="op" id="1252316">:=</span>&nbsp;<span class="op" id="1252319">[</span><span class="op" id="1252320">]</span><span class="ident" id="1252321">Duration</span><span class="op" id="1252329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="1252333">1</span>&nbsp;<span class="op" id="1252335">*</span>&nbsp;<span class="ident" id="1252337">unit</span><span class="op" id="1252341">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="1252345">3</span>&nbsp;<span class="op" id="1252347">*</span>&nbsp;<span class="ident" id="1252349">unit</span><span class="op" id="1252353">,</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="1252357">7</span>&nbsp;<span class="op" id="1252359">*</span>&nbsp;<span class="ident" id="1252361">unit</span><span class="op" id="1252365">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="1252369">15</span>&nbsp;<span class="op" id="1252372">*</span>&nbsp;<span class="ident" id="1252374">unit</span><span class="op" id="1252378">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1252381">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1252384">var</span>&nbsp;<span class="ident" id="1252388">err</span>&nbsp;<span class="builtintype" id="1252392">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1252399">for</span>&nbsp;<span class="ident" id="1252403">_</span><span class="op" id="1252404">,</span>&nbsp;<span class="ident" id="1252406">d</span>&nbsp;<span class="op" id="1252408">:=</span>&nbsp;<span class="keyword" id="1252411">range</span>&nbsp;<span class="ident" id="1252417">tries</span>&nbsp;<span class="op" id="1252423">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1252427">err</span>&nbsp;<span class="op" id="1252431">=</span>&nbsp;<span class="ident" id="1252433">testReset</span><span class="op" id="1252442">(</span><span class="ident" id="1252443">d</span><span class="op" id="1252444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1252448">if</span>&nbsp;<span class="ident" id="1252451">err</span>&nbsp;<span class="op" id="1252455">==</span>&nbsp;<span class="ident" id="1252458">nil</span>&nbsp;<span class="op" id="1252462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1252467">t</span><span class="op" id="1252468">.</span><span class="ident" id="1252469">Logf</span><span class="op" id="1252473">(</span><span class="string" id="1252474">&#34;passed&nbsp;using&nbsp;duration&nbsp;%v&#34;</span><span class="op" id="1252500">,</span>&nbsp;<span class="ident" id="1252502">d</span><span class="op" id="1252503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1252508">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1252517">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1252520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1252523">t</span><span class="op" id="1252524">.</span><span class="ident" id="1252525">Error</span><span class="op" id="1252530">(</span><span class="ident" id="1252531">err</span><span class="op" id="1252534">)</span><br>
<span class="lineno"></span><span class="op" id="1252536">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1252539">//&nbsp;Test&nbsp;that&nbsp;sleeping&nbsp;for&nbsp;an&nbsp;interval&nbsp;so&nbsp;large&nbsp;it&nbsp;overflows&nbsp;does&nbsp;not</span><br>
<span class="lineno">365</span><span class="comment" id="1252608">//&nbsp;result&nbsp;in&nbsp;a&nbsp;short&nbsp;sleep&nbsp;duration.</span><br>
<span class="lineno"></span><span class="keyword" id="1252645">func</span>&nbsp;<span class="ident" id="1252650">TestOverflowSleep</span><span class="op" id="1252667">(</span><span class="ident" id="1252668">t</span>&nbsp;<span class="op" id="1252670">*</span><span class="ident" id="1252671">testing</span><span class="op" id="1252678">.</span><span class="ident" id="1252679">T</span><span class="op" id="1252680">)</span>&nbsp;<span class="op" id="1252682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1252685">const</span>&nbsp;<span class="ident" id="1252691">big</span>&nbsp;<span class="op" id="1252695">=</span>&nbsp;<span class="ident" id="1252697">Duration</span><span class="op" id="1252705">(</span><span class="ident" id="1252706">int64</span><span class="op" id="1252711">(</span><span class="num" id="1252712">1</span><span class="op" id="1252713">&lt;&lt;</span><span class="num" id="1252715">63</span>&nbsp;<span class="op" id="1252718">-</span>&nbsp;<span class="num" id="1252720">1</span><span class="op" id="1252721">)</span><span class="op" id="1252722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1252725">select</span>&nbsp;<span class="op" id="1252732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1252735">case</span>&nbsp;<span class="op" id="1252740">&lt;-</span><span class="ident" id="1252742">After</span><span class="op" id="1252747">(</span><span class="ident" id="1252748">big</span><span class="op" id="1252751">)</span><span class="op" id="1252752">:</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1252756">t</span><span class="op" id="1252757">.</span><span class="ident" id="1252758">Fatalf</span><span class="op" id="1252764">(</span><span class="string" id="1252765">&#34;big&nbsp;timeout&nbsp;fired&#34;</span><span class="op" id="1252784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1252787">case</span>&nbsp;<span class="op" id="1252792">&lt;-</span><span class="ident" id="1252794">After</span><span class="op" id="1252799">(</span><span class="num" id="1252800">25</span>&nbsp;<span class="op" id="1252803">*</span>&nbsp;<span class="ident" id="1252805">Millisecond</span><span class="op" id="1252816">)</span><span class="op" id="1252817">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1252821">//&nbsp;OK</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1252828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1252831">const</span>&nbsp;<span class="ident" id="1252837">neg</span>&nbsp;<span class="op" id="1252841">=</span>&nbsp;<span class="ident" id="1252843">Duration</span><span class="op" id="1252851">(</span><span class="op" id="1252852">-</span><span class="num" id="1252853">1</span>&nbsp;<span class="op" id="1252855">&lt;&lt;</span>&nbsp;<span class="num" id="1252858">63</span><span class="op" id="1252860">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1252863">select</span>&nbsp;<span class="op" id="1252870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1252873">case</span>&nbsp;<span class="op" id="1252878">&lt;-</span><span class="ident" id="1252880">After</span><span class="op" id="1252885">(</span><span class="ident" id="1252886">neg</span><span class="op" id="1252889">)</span><span class="op" id="1252890">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1252894">//&nbsp;OK</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1252901">case</span>&nbsp;<span class="op" id="1252906">&lt;-</span><span class="ident" id="1252908">After</span><span class="op" id="1252913">(</span><span class="num" id="1252914">1</span>&nbsp;<span class="op" id="1252916">*</span>&nbsp;<span class="ident" id="1252918">Second</span><span class="op" id="1252924">)</span><span class="op" id="1252925">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1252929">t</span><span class="op" id="1252930">.</span><span class="ident" id="1252931">Fatalf</span><span class="op" id="1252937">(</span><span class="string" id="1252938">&#34;negative&nbsp;timeout&nbsp;didn&#39;t&nbsp;fire&#34;</span><span class="op" id="1252968">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1252971">}</span><br>
<span class="lineno"></span><span class="op" id="1252973">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1252976">//&nbsp;Test&nbsp;that&nbsp;a&nbsp;panic&nbsp;while&nbsp;deleting&nbsp;a&nbsp;timer&nbsp;does&nbsp;not&nbsp;leave</span><br>
<span class="lineno"></span><span class="comment" id="1253035">//&nbsp;the&nbsp;timers&nbsp;mutex&nbsp;held,&nbsp;deadlocking&nbsp;a&nbsp;ticker.Stop&nbsp;in&nbsp;a&nbsp;defer.</span><br>
<span class="lineno">385</span><span class="keyword" id="1253099">func</span>&nbsp;<span class="ident" id="1253104">TestIssue5745</span><span class="op" id="1253117">(</span><span class="ident" id="1253118">t</span>&nbsp;<span class="op" id="1253120">*</span><span class="ident" id="1253121">testing</span><span class="op" id="1253128">.</span><span class="ident" id="1253129">T</span><span class="op" id="1253130">)</span>&nbsp;<span class="op" id="1253132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1253135">ticker</span>&nbsp;<span class="op" id="1253142">:=</span>&nbsp;<span class="ident" id="1253145">NewTicker</span><span class="op" id="1253154">(</span><span class="ident" id="1253155">Hour</span><span class="op" id="1253159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1253162">defer</span>&nbsp;<span class="keyword" id="1253168">func</span><span class="op" id="1253172">(</span><span class="op" id="1253173">)</span>&nbsp;<span class="op" id="1253175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1253179">//&nbsp;would&nbsp;deadlock&nbsp;here&nbsp;before&nbsp;the&nbsp;fix&nbsp;due&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1253226">//&nbsp;lock&nbsp;taken&nbsp;before&nbsp;the&nbsp;segfault.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1253263">ticker</span><span class="op" id="1253269">.</span><span class="ident" id="1253270">Stop</span><span class="op" id="1253274">(</span><span class="op" id="1253275">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1253280">if</span>&nbsp;<span class="ident" id="1253283">r</span>&nbsp;<span class="op" id="1253285">:=</span>&nbsp;<span class="builtinfunc" id="1253288">recover</span><span class="op" id="1253295">(</span><span class="op" id="1253296">)</span><span class="op" id="1253297">;</span>&nbsp;<span class="ident" id="1253299">r</span>&nbsp;<span class="op" id="1253301">==</span>&nbsp;<span class="ident" id="1253304">nil</span>&nbsp;<span class="op" id="1253308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1253313">t</span><span class="op" id="1253314">.</span><span class="ident" id="1253315">Error</span><span class="op" id="1253320">(</span><span class="string" id="1253321">&#34;Expected&nbsp;panic,&nbsp;but&nbsp;none&nbsp;happened.&#34;</span><span class="op" id="1253357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1253361">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1253364">}</span><span class="op" id="1253365">(</span><span class="op" id="1253366">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1253370">//&nbsp;cause&nbsp;a&nbsp;panic&nbsp;due&nbsp;to&nbsp;a&nbsp;segfault</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1253406">var</span>&nbsp;<span class="ident" id="1253410">timer</span>&nbsp;<span class="op" id="1253416">*</span><span class="ident" id="1253417">Timer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1253424">timer</span><span class="op" id="1253429">.</span><span class="ident" id="1253430">Stop</span><span class="op" id="1253434">(</span><span class="op" id="1253435">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1253438">t</span><span class="op" id="1253439">.</span><span class="ident" id="1253440">Error</span><span class="op" id="1253445">(</span><span class="string" id="1253446">&#34;Should&nbsp;be&nbsp;unreachable.&#34;</span><span class="op" id="1253470">)</span><br>
<span class="lineno"></span><span class="op" id="1253472">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1253475">func</span>&nbsp;<span class="ident" id="1253480">TestOverflowRuntimeTimer</span><span class="op" id="1253504">(</span><span class="ident" id="1253505">t</span>&nbsp;<span class="op" id="1253507">*</span><span class="ident" id="1253508">testing</span><span class="op" id="1253515">.</span><span class="ident" id="1253516">T</span><span class="op" id="1253517">)</span>&nbsp;<span class="op" id="1253519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1253522">if</span>&nbsp;<span class="ident" id="1253525">testing</span><span class="op" id="1253532">.</span><span class="ident" id="1253533">Short</span><span class="op" id="1253538">(</span><span class="op" id="1253539">)</span>&nbsp;<span class="op" id="1253541">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1253545">t</span><span class="op" id="1253546">.</span><span class="ident" id="1253547">Skip</span><span class="op" id="1253551">(</span><span class="string" id="1253552">&#34;skipping&nbsp;in&nbsp;short&nbsp;mode,&nbsp;see&nbsp;issue&nbsp;6874&#34;</span><span class="op" id="1253592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1253595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1253598">//&nbsp;This&nbsp;may&nbsp;hang&nbsp;forever&nbsp;if&nbsp;timers&nbsp;are&nbsp;broken.&nbsp;See&nbsp;comment&nbsp;near</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1253663">//&nbsp;the&nbsp;end&nbsp;of&nbsp;CheckRuntimeTimerOverflow&nbsp;in&nbsp;internal_test.go.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1253725">CheckRuntimeTimerOverflow</span><span class="op" id="1253750">(</span><span class="op" id="1253751">)</span><br>
<span class="lineno">410</span><span class="op" id="1253753">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1253756">func</span>&nbsp;<span class="ident" id="1253761">checkZeroPanicString</span><span class="op" id="1253781">(</span><span class="ident" id="1253782">t</span>&nbsp;<span class="op" id="1253784">*</span><span class="ident" id="1253785">testing</span><span class="op" id="1253792">.</span><span class="ident" id="1253793">T</span><span class="op" id="1253794">)</span>&nbsp;<span class="op" id="1253796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1253799">e</span>&nbsp;<span class="op" id="1253801">:=</span>&nbsp;<span class="builtinfunc" id="1253804">recover</span><span class="op" id="1253811">(</span><span class="op" id="1253812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1253815">s</span><span class="op" id="1253816">,</span>&nbsp;<span class="ident" id="1253818">_</span>&nbsp;<span class="op" id="1253820">:=</span>&nbsp;<span class="ident" id="1253823">e</span><span class="op" id="1253824">.</span><span class="op" id="1253825">(</span><span class="builtintype" id="1253826">string</span><span class="op" id="1253832">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1253835">if</span>&nbsp;<span class="ident" id="1253838">want</span>&nbsp;<span class="op" id="1253843">:=</span>&nbsp;<span class="string" id="1253846">&#34;called&nbsp;on&nbsp;uninitialized&nbsp;Timer&#34;</span><span class="op" id="1253877">;</span>&nbsp;<span class="op" id="1253879">!</span><span class="ident" id="1253880">strings</span><span class="op" id="1253887">.</span><span class="ident" id="1253888">Contains</span><span class="op" id="1253896">(</span><span class="ident" id="1253897">s</span><span class="op" id="1253898">,</span>&nbsp;<span class="ident" id="1253900">want</span><span class="op" id="1253904">)</span>&nbsp;<span class="op" id="1253906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1253910">t</span><span class="op" id="1253911">.</span><span class="ident" id="1253912">Errorf</span><span class="op" id="1253918">(</span><span class="string" id="1253919">&#34;panic&nbsp;=&nbsp;%v;&nbsp;want&nbsp;substring&nbsp;%q&#34;</span><span class="op" id="1253950">,</span>&nbsp;<span class="ident" id="1253952">e</span><span class="op" id="1253953">,</span>&nbsp;<span class="ident" id="1253955">want</span><span class="op" id="1253959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1253962">}</span><br>
<span class="lineno"></span><span class="op" id="1253964">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">420</span><span class="keyword" id="1253967">func</span>&nbsp;<span class="ident" id="1253972">TestZeroTimerResetPanics</span><span class="op" id="1253996">(</span><span class="ident" id="1253997">t</span>&nbsp;<span class="op" id="1253999">*</span><span class="ident" id="1254000">testing</span><span class="op" id="1254007">.</span><span class="ident" id="1254008">T</span><span class="op" id="1254009">)</span>&nbsp;<span class="op" id="1254011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1254014">defer</span>&nbsp;<span class="ident" id="1254020">checkZeroPanicString</span><span class="op" id="1254040">(</span><span class="ident" id="1254041">t</span><span class="op" id="1254042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1254045">var</span>&nbsp;<span class="ident" id="1254049">tr</span>&nbsp;<span class="ident" id="1254052">Timer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1254059">tr</span><span class="op" id="1254061">.</span><span class="ident" id="1254062">Reset</span><span class="op" id="1254067">(</span><span class="num" id="1254068">1</span><span class="op" id="1254069">)</span><br>
<span class="lineno"></span><span class="op" id="1254071">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="keyword" id="1254074">func</span>&nbsp;<span class="ident" id="1254079">TestZeroTimerStopPanics</span><span class="op" id="1254102">(</span><span class="ident" id="1254103">t</span>&nbsp;<span class="op" id="1254105">*</span><span class="ident" id="1254106">testing</span><span class="op" id="1254113">.</span><span class="ident" id="1254114">T</span><span class="op" id="1254115">)</span>&nbsp;<span class="op" id="1254117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1254120">defer</span>&nbsp;<span class="ident" id="1254126">checkZeroPanicString</span><span class="op" id="1254146">(</span><span class="ident" id="1254147">t</span><span class="op" id="1254148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1254151">var</span>&nbsp;<span class="ident" id="1254155">tr</span>&nbsp;<span class="ident" id="1254158">Timer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1254165">tr</span><span class="op" id="1254167">.</span><span class="ident" id="1254168">Stop</span><span class="op" id="1254172">(</span><span class="op" id="1254173">)</span><br>
<span class="lineno">430</span><span class="op" id="1254175">}</span>
</div>
</body>
</html>
