<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>strings</h2>
<ul>
<li><a href="/gostd/strings/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/strings/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/strings/reader.go.html">reader.go</a></li>
<li><a href="/gostd/strings/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/strings/replace.go.html">replace.go</a></li>
<li><a href="/gostd/strings/replace_test.go.html">replace_test.go</a></li>
<li><a href="/gostd/strings/search.go.html">search.go</a></li>
<li><a href="/gostd/strings/search_test.go.html">search_test.go</a></li>
<li><a href="/gostd/strings/strings.go.html">strings.go</a></li>
<li><a href="/gostd/strings/strings_decl.go.html">strings_decl.go</a></li>
<li><a href="/gostd/strings/strings_test.go.html">strings_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2906154">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2906209">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2906263">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="2906314">package</span>&nbsp;<span class="ident" id="2906322">strings</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2906331">import</span>&nbsp;<span class="string" id="2906338">&#34;io&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2906344">//&nbsp;Replacer&nbsp;replaces&nbsp;a&nbsp;list&nbsp;of&nbsp;strings&nbsp;with&nbsp;replacements.</span><br>
<span class="lineno">10</span><span class="comment" id="2906402">//&nbsp;It&nbsp;is&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="2906459">type</span>&nbsp;<span class="ident" id="2906464">Replacer</span>&nbsp;<span class="keyword" id="2906473">struct</span>&nbsp;<span class="op" id="2906480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2906483">r</span>&nbsp;<span class="ident" id="2906485">replacer</span><br>
<span class="lineno"></span><span class="op" id="2906494">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="2906497">//&nbsp;replacer&nbsp;is&nbsp;the&nbsp;interface&nbsp;that&nbsp;a&nbsp;replacement&nbsp;algorithm&nbsp;needs&nbsp;to&nbsp;implement.</span><br>
<span class="lineno"></span><span class="keyword" id="2906575">type</span>&nbsp;<span class="ident" id="2906580">replacer</span>&nbsp;<span class="keyword" id="2906589">interface</span>&nbsp;<span class="op" id="2906599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2906602">Replace</span><span class="op" id="2906609">(</span><span class="ident" id="2906610">s</span>&nbsp;<span class="builtintype" id="2906612">string</span><span class="op" id="2906618">)</span>&nbsp;<span class="builtintype" id="2906620">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2906628">WriteString</span><span class="op" id="2906639">(</span><span class="ident" id="2906640">w</span>&nbsp;<span class="ident" id="2906642">io</span><span class="op" id="2906644">.</span><span class="ident" id="2906645">Writer</span><span class="op" id="2906651">,</span>&nbsp;<span class="ident" id="2906653">s</span>&nbsp;<span class="builtintype" id="2906655">string</span><span class="op" id="2906661">)</span>&nbsp;<span class="op" id="2906663">(</span><span class="ident" id="2906664">n</span>&nbsp;<span class="builtintype" id="2906666">int</span><span class="op" id="2906669">,</span>&nbsp;<span class="ident" id="2906671">err</span>&nbsp;<span class="builtintype" id="2906675">error</span><span class="op" id="2906680">)</span><br>
<span class="lineno"></span><span class="op" id="2906682">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="2906685">//&nbsp;NewReplacer&nbsp;returns&nbsp;a&nbsp;new&nbsp;Replacer&nbsp;from&nbsp;a&nbsp;list&nbsp;of&nbsp;old,&nbsp;new&nbsp;string&nbsp;pairs.</span><br>
<span class="lineno"></span><span class="comment" id="2906761">//&nbsp;Replacements&nbsp;are&nbsp;performed&nbsp;in&nbsp;order,&nbsp;without&nbsp;overlapping&nbsp;matches.</span><br>
<span class="lineno"></span><span class="keyword" id="2906830">func</span>&nbsp;<span class="ident" id="2906835">NewReplacer</span><span class="op" id="2906846">(</span><span class="ident" id="2906847">oldnew</span>&nbsp;<span class="op" id="2906854">...</span><span class="builtintype" id="2906857">string</span><span class="op" id="2906863">)</span>&nbsp;<span class="op" id="2906865">*</span><span class="ident" id="2906866">Replacer</span>&nbsp;<span class="op" id="2906875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2906878">if</span>&nbsp;<span class="builtinfunc" id="2906881">len</span><span class="op" id="2906884">(</span><span class="ident" id="2906885">oldnew</span><span class="op" id="2906891">)</span><span class="op" id="2906892">%</span><span class="num" id="2906893">2</span>&nbsp;<span class="op" id="2906895">==</span>&nbsp;<span class="num" id="2906898">1</span>&nbsp;<span class="op" id="2906900">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2906904">panic</span><span class="op" id="2906909">(</span><span class="string" id="2906910">&#34;strings.NewReplacer:&nbsp;odd&nbsp;argument&nbsp;count&#34;</span><span class="op" id="2906951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2906954">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2906958">if</span>&nbsp;<span class="builtinfunc" id="2906961">len</span><span class="op" id="2906964">(</span><span class="ident" id="2906965">oldnew</span><span class="op" id="2906971">)</span>&nbsp;<span class="op" id="2906973">==</span>&nbsp;<span class="num" id="2906976">2</span>&nbsp;<span class="op" id="2906978">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="2906981">len</span><span class="op" id="2906984">(</span><span class="ident" id="2906985">oldnew</span><span class="op" id="2906991">[</span><span class="num" id="2906992">0</span><span class="op" id="2906993">]</span><span class="op" id="2906994">)</span>&nbsp;<span class="op" id="2906996">&gt;</span>&nbsp;<span class="num" id="2906998">1</span>&nbsp;<span class="op" id="2907000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2907004">return</span>&nbsp;<span class="op" id="2907011">&amp;</span><span class="ident" id="2907012">Replacer</span><span class="op" id="2907020">{</span><span class="ident" id="2907021">r</span><span class="op" id="2907022">:</span>&nbsp;<span class="ident" id="2907024">makeSingleStringReplacer</span><span class="op" id="2907048">(</span><span class="ident" id="2907049">oldnew</span><span class="op" id="2907055">[</span><span class="num" id="2907056">0</span><span class="op" id="2907057">]</span><span class="op" id="2907058">,</span>&nbsp;<span class="ident" id="2907060">oldnew</span><span class="op" id="2907066">[</span><span class="num" id="2907067">1</span><span class="op" id="2907068">]</span><span class="op" id="2907069">)</span><span class="op" id="2907070">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2907073">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2907077">allNewBytes</span>&nbsp;<span class="op" id="2907089">:=</span>&nbsp;<span class="builtintype" id="2907092">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2907098">for</span>&nbsp;<span class="ident" id="2907102">i</span>&nbsp;<span class="op" id="2907104">:=</span>&nbsp;<span class="num" id="2907107">0</span><span class="op" id="2907108">;</span>&nbsp;<span class="ident" id="2907110">i</span>&nbsp;<span class="op" id="2907112">&lt;</span>&nbsp;<span class="builtinfunc" id="2907114">len</span><span class="op" id="2907117">(</span><span class="ident" id="2907118">oldnew</span><span class="op" id="2907124">)</span><span class="op" id="2907125">;</span>&nbsp;<span class="ident" id="2907127">i</span>&nbsp;<span class="op" id="2907129">+=</span>&nbsp;<span class="num" id="2907132">2</span>&nbsp;<span class="op" id="2907134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2907138">if</span>&nbsp;<span class="builtinfunc" id="2907141">len</span><span class="op" id="2907144">(</span><span class="ident" id="2907145">oldnew</span><span class="op" id="2907151">[</span><span class="ident" id="2907152">i</span><span class="op" id="2907153">]</span><span class="op" id="2907154">)</span>&nbsp;<span class="op" id="2907156">!=</span>&nbsp;<span class="num" id="2907159">1</span>&nbsp;<span class="op" id="2907161">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2907166">return</span>&nbsp;<span class="op" id="2907173">&amp;</span><span class="ident" id="2907174">Replacer</span><span class="op" id="2907182">{</span><span class="ident" id="2907183">r</span><span class="op" id="2907184">:</span>&nbsp;<span class="ident" id="2907186">makeGenericReplacer</span><span class="op" id="2907205">(</span><span class="ident" id="2907206">oldnew</span><span class="op" id="2907212">)</span><span class="op" id="2907213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2907217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2907221">if</span>&nbsp;<span class="builtinfunc" id="2907224">len</span><span class="op" id="2907227">(</span><span class="ident" id="2907228">oldnew</span><span class="op" id="2907234">[</span><span class="ident" id="2907235">i</span><span class="op" id="2907236">+</span><span class="num" id="2907237">1</span><span class="op" id="2907238">]</span><span class="op" id="2907239">)</span>&nbsp;<span class="op" id="2907241">!=</span>&nbsp;<span class="num" id="2907244">1</span>&nbsp;<span class="op" id="2907246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2907251">allNewBytes</span>&nbsp;<span class="op" id="2907263">=</span>&nbsp;<span class="builtintype" id="2907265">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2907273">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2907276">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2907280">if</span>&nbsp;<span class="ident" id="2907283">allNewBytes</span>&nbsp;<span class="op" id="2907295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2907299">r</span>&nbsp;<span class="op" id="2907301">:=</span>&nbsp;<span class="ident" id="2907304">byteReplacer</span><span class="op" id="2907316">{</span><span class="op" id="2907317">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2907321">for</span>&nbsp;<span class="ident" id="2907325">i</span>&nbsp;<span class="op" id="2907327">:=</span>&nbsp;<span class="keyword" id="2907330">range</span>&nbsp;<span class="ident" id="2907336">r</span>&nbsp;<span class="op" id="2907338">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2907343">r</span><span class="op" id="2907344">[</span><span class="ident" id="2907345">i</span><span class="op" id="2907346">]</span>&nbsp;<span class="op" id="2907348">=</span>&nbsp;<span class="builtintype" id="2907350">byte</span><span class="op" id="2907354">(</span><span class="ident" id="2907355">i</span><span class="op" id="2907356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2907360">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2907364">//&nbsp;The&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;old-&gt;new&nbsp;map&nbsp;takes&nbsp;precedence</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2907423">//&nbsp;over&nbsp;the&nbsp;others&nbsp;with&nbsp;the&nbsp;same&nbsp;old&nbsp;string.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2907470">for</span>&nbsp;<span class="ident" id="2907474">i</span>&nbsp;<span class="op" id="2907476">:=</span>&nbsp;<span class="builtinfunc" id="2907479">len</span><span class="op" id="2907482">(</span><span class="ident" id="2907483">oldnew</span><span class="op" id="2907489">)</span>&nbsp;<span class="op" id="2907491">-</span>&nbsp;<span class="num" id="2907493">2</span><span class="op" id="2907494">;</span>&nbsp;<span class="ident" id="2907496">i</span>&nbsp;<span class="op" id="2907498">&gt;=</span>&nbsp;<span class="num" id="2907501">0</span><span class="op" id="2907502">;</span>&nbsp;<span class="ident" id="2907504">i</span>&nbsp;<span class="op" id="2907506">-=</span>&nbsp;<span class="num" id="2907509">2</span>&nbsp;<span class="op" id="2907511">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2907516">o</span>&nbsp;<span class="op" id="2907518">:=</span>&nbsp;<span class="ident" id="2907521">oldnew</span><span class="op" id="2907527">[</span><span class="ident" id="2907528">i</span><span class="op" id="2907529">]</span><span class="op" id="2907530">[</span><span class="num" id="2907531">0</span><span class="op" id="2907532">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2907537">n</span>&nbsp;<span class="op" id="2907539">:=</span>&nbsp;<span class="ident" id="2907542">oldnew</span><span class="op" id="2907548">[</span><span class="ident" id="2907549">i</span><span class="op" id="2907550">+</span><span class="num" id="2907551">1</span><span class="op" id="2907552">]</span><span class="op" id="2907553">[</span><span class="num" id="2907554">0</span><span class="op" id="2907555">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2907560">r</span><span class="op" id="2907561">[</span><span class="ident" id="2907562">o</span><span class="op" id="2907563">]</span>&nbsp;<span class="op" id="2907565">=</span>&nbsp;<span class="ident" id="2907567">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2907571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2907575">return</span>&nbsp;<span class="op" id="2907582">&amp;</span><span class="ident" id="2907583">Replacer</span><span class="op" id="2907591">{</span><span class="ident" id="2907592">r</span><span class="op" id="2907593">:</span>&nbsp;<span class="op" id="2907595">&amp;</span><span class="ident" id="2907596">r</span><span class="op" id="2907597">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2907600">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2907604">r</span>&nbsp;<span class="op" id="2907606">:=</span>&nbsp;<span class="ident" id="2907609">byteStringReplacer</span><span class="op" id="2907627">{</span><span class="op" id="2907628">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2907631">//&nbsp;The&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;old-&gt;new&nbsp;map&nbsp;takes&nbsp;precedence</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2907689">//&nbsp;over&nbsp;the&nbsp;others&nbsp;with&nbsp;the&nbsp;same&nbsp;old&nbsp;string.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2907735">for</span>&nbsp;<span class="ident" id="2907739">i</span>&nbsp;<span class="op" id="2907741">:=</span>&nbsp;<span class="builtinfunc" id="2907744">len</span><span class="op" id="2907747">(</span><span class="ident" id="2907748">oldnew</span><span class="op" id="2907754">)</span>&nbsp;<span class="op" id="2907756">-</span>&nbsp;<span class="num" id="2907758">2</span><span class="op" id="2907759">;</span>&nbsp;<span class="ident" id="2907761">i</span>&nbsp;<span class="op" id="2907763">&gt;=</span>&nbsp;<span class="num" id="2907766">0</span><span class="op" id="2907767">;</span>&nbsp;<span class="ident" id="2907769">i</span>&nbsp;<span class="op" id="2907771">-=</span>&nbsp;<span class="num" id="2907774">2</span>&nbsp;<span class="op" id="2907776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2907780">o</span>&nbsp;<span class="op" id="2907782">:=</span>&nbsp;<span class="ident" id="2907785">oldnew</span><span class="op" id="2907791">[</span><span class="ident" id="2907792">i</span><span class="op" id="2907793">]</span><span class="op" id="2907794">[</span><span class="num" id="2907795">0</span><span class="op" id="2907796">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2907800">n</span>&nbsp;<span class="op" id="2907802">:=</span>&nbsp;<span class="ident" id="2907805">oldnew</span><span class="op" id="2907811">[</span><span class="ident" id="2907812">i</span><span class="op" id="2907813">+</span><span class="num" id="2907814">1</span><span class="op" id="2907815">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2907819">r</span><span class="op" id="2907820">[</span><span class="ident" id="2907821">o</span><span class="op" id="2907822">]</span>&nbsp;<span class="op" id="2907824">=</span>&nbsp;<span class="op" id="2907826">[</span><span class="op" id="2907827">]</span><span class="builtintype" id="2907828">byte</span><span class="op" id="2907832">(</span><span class="ident" id="2907833">n</span><span class="op" id="2907834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2907837">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2907840">return</span>&nbsp;<span class="op" id="2907847">&amp;</span><span class="ident" id="2907848">Replacer</span><span class="op" id="2907856">{</span><span class="ident" id="2907857">r</span><span class="op" id="2907858">:</span>&nbsp;<span class="op" id="2907860">&amp;</span><span class="ident" id="2907861">r</span><span class="op" id="2907862">}</span><br>
<span class="lineno"></span><span class="op" id="2907864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2907867">//&nbsp;Replace&nbsp;returns&nbsp;a&nbsp;copy&nbsp;of&nbsp;s&nbsp;with&nbsp;all&nbsp;replacements&nbsp;performed.</span><br>
<span class="lineno"></span><span class="keyword" id="2907931">func</span>&nbsp;<span class="op" id="2907936">(</span><span class="ident" id="2907937">r</span>&nbsp;<span class="op" id="2907939">*</span><span class="ident" id="2907940">Replacer</span><span class="op" id="2907948">)</span>&nbsp;<span class="ident" id="2907950">Replace</span><span class="op" id="2907957">(</span><span class="ident" id="2907958">s</span>&nbsp;<span class="builtintype" id="2907960">string</span><span class="op" id="2907966">)</span>&nbsp;<span class="builtintype" id="2907968">string</span>&nbsp;<span class="op" id="2907975">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2907978">return</span>&nbsp;<span class="ident" id="2907985">r</span><span class="op" id="2907986">.</span><span class="ident" id="2907987">r</span><span class="op" id="2907988">.</span><span class="ident" id="2907989">Replace</span><span class="op" id="2907996">(</span><span class="ident" id="2907997">s</span><span class="op" id="2907998">)</span><br>
<span class="lineno"></span><span class="op" id="2908000">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2908003">//&nbsp;WriteString&nbsp;writes&nbsp;s&nbsp;to&nbsp;w&nbsp;with&nbsp;all&nbsp;replacements&nbsp;performed.</span><br>
<span class="lineno"></span><span class="keyword" id="2908065">func</span>&nbsp;<span class="op" id="2908070">(</span><span class="ident" id="2908071">r</span>&nbsp;<span class="op" id="2908073">*</span><span class="ident" id="2908074">Replacer</span><span class="op" id="2908082">)</span>&nbsp;<span class="ident" id="2908084">WriteString</span><span class="op" id="2908095">(</span><span class="ident" id="2908096">w</span>&nbsp;<span class="ident" id="2908098">io</span><span class="op" id="2908100">.</span><span class="ident" id="2908101">Writer</span><span class="op" id="2908107">,</span>&nbsp;<span class="ident" id="2908109">s</span>&nbsp;<span class="builtintype" id="2908111">string</span><span class="op" id="2908117">)</span>&nbsp;<span class="op" id="2908119">(</span><span class="ident" id="2908120">n</span>&nbsp;<span class="builtintype" id="2908122">int</span><span class="op" id="2908125">,</span>&nbsp;<span class="ident" id="2908127">err</span>&nbsp;<span class="builtintype" id="2908131">error</span><span class="op" id="2908136">)</span>&nbsp;<span class="op" id="2908138">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2908141">return</span>&nbsp;<span class="ident" id="2908148">r</span><span class="op" id="2908149">.</span><span class="ident" id="2908150">r</span><span class="op" id="2908151">.</span><span class="ident" id="2908152">WriteString</span><span class="op" id="2908163">(</span><span class="ident" id="2908164">w</span><span class="op" id="2908165">,</span>&nbsp;<span class="ident" id="2908167">s</span><span class="op" id="2908168">)</span><br>
<span class="lineno"></span><span class="op" id="2908170">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2908173">//&nbsp;trieNode&nbsp;is&nbsp;a&nbsp;node&nbsp;in&nbsp;a&nbsp;lookup&nbsp;trie&nbsp;for&nbsp;prioritized&nbsp;key/value&nbsp;pairs.&nbsp;Keys</span><br>
<span class="lineno"></span><span class="comment" id="2908250">//&nbsp;and&nbsp;values&nbsp;may&nbsp;be&nbsp;empty.&nbsp;For&nbsp;example,&nbsp;the&nbsp;trie&nbsp;containing&nbsp;keys&nbsp;&#34;ax&#34;,&nbsp;&#34;ay&#34;,</span><br>
<span class="lineno">80</span><span class="comment" id="2908328">//&nbsp;&#34;bcbc&#34;,&nbsp;&#34;x&#34;&nbsp;and&nbsp;&#34;xy&#34;&nbsp;could&nbsp;have&nbsp;eight&nbsp;nodes:</span><br>
<span class="lineno"></span><span class="comment" id="2908376">//</span><br>
<span class="lineno"></span><span class="comment" id="2908379">//&nbsp;&nbsp;n0&nbsp;&nbsp;-</span><br>
<span class="lineno"></span><span class="comment" id="2908389">//&nbsp;&nbsp;n1&nbsp;&nbsp;a-</span><br>
<span class="lineno"></span><span class="comment" id="2908400">//&nbsp;&nbsp;n2&nbsp;&nbsp;.x+</span><br>
<span class="lineno">85</span><span class="comment" id="2908412">//&nbsp;&nbsp;n3&nbsp;&nbsp;.y+</span><br>
<span class="lineno"></span><span class="comment" id="2908424">//&nbsp;&nbsp;n4&nbsp;&nbsp;b-</span><br>
<span class="lineno"></span><span class="comment" id="2908435">//&nbsp;&nbsp;n5&nbsp;&nbsp;.cbc+</span><br>
<span class="lineno"></span><span class="comment" id="2908449">//&nbsp;&nbsp;n6&nbsp;&nbsp;x+</span><br>
<span class="lineno"></span><span class="comment" id="2908460">//&nbsp;&nbsp;n7&nbsp;&nbsp;.y+</span><br>
<span class="lineno">90</span><span class="comment" id="2908472">//</span><br>
<span class="lineno"></span><span class="comment" id="2908475">//&nbsp;n0&nbsp;is&nbsp;the&nbsp;root&nbsp;node,&nbsp;and&nbsp;its&nbsp;children&nbsp;are&nbsp;n1,&nbsp;n4&nbsp;and&nbsp;n6;&nbsp;n1&#39;s&nbsp;children&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="2908553">//&nbsp;n2&nbsp;and&nbsp;n3;&nbsp;n4&#39;s&nbsp;child&nbsp;is&nbsp;n5;&nbsp;n6&#39;s&nbsp;child&nbsp;is&nbsp;n7.&nbsp;Nodes&nbsp;n0,&nbsp;n1&nbsp;and&nbsp;n4&nbsp;(marked</span><br>
<span class="lineno"></span><span class="comment" id="2908631">//&nbsp;with&nbsp;a&nbsp;trailing&nbsp;&#34;-&#34;)&nbsp;are&nbsp;partial&nbsp;keys,&nbsp;and&nbsp;nodes&nbsp;n2,&nbsp;n3,&nbsp;n5,&nbsp;n6&nbsp;and&nbsp;n7</span><br>
<span class="lineno"></span><span class="comment" id="2908705">//&nbsp;(marked&nbsp;with&nbsp;a&nbsp;trailing&nbsp;&#34;+&#34;)&nbsp;are&nbsp;complete&nbsp;keys.</span><br>
<span class="lineno">95</span><span class="keyword" id="2908756">type</span>&nbsp;<span class="ident" id="2908761">trieNode</span>&nbsp;<span class="keyword" id="2908770">struct</span>&nbsp;<span class="op" id="2908777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2908780">//&nbsp;value&nbsp;is&nbsp;the&nbsp;value&nbsp;of&nbsp;the&nbsp;trie&nbsp;node&#39;s&nbsp;key/value&nbsp;pair.&nbsp;It&nbsp;is&nbsp;empty&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2908853">//&nbsp;this&nbsp;node&nbsp;is&nbsp;not&nbsp;a&nbsp;complete&nbsp;key.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2908890">value</span>&nbsp;<span class="builtintype" id="2908896">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2908904">//&nbsp;priority&nbsp;is&nbsp;the&nbsp;priority&nbsp;(higher&nbsp;is&nbsp;more&nbsp;important)&nbsp;of&nbsp;the&nbsp;trie&nbsp;node&#39;s</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2908979">//&nbsp;key/value&nbsp;pair;&nbsp;keys&nbsp;are&nbsp;not&nbsp;necessarily&nbsp;matched&nbsp;shortest-&nbsp;or&nbsp;longest-</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2909054">//&nbsp;first.&nbsp;Priority&nbsp;is&nbsp;positive&nbsp;if&nbsp;this&nbsp;node&nbsp;is&nbsp;a&nbsp;complete&nbsp;key,&nbsp;and&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2909127">//&nbsp;otherwise.&nbsp;In&nbsp;the&nbsp;example&nbsp;above,&nbsp;positive/zero&nbsp;priorities&nbsp;are&nbsp;marked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2909200">//&nbsp;with&nbsp;a&nbsp;trailing&nbsp;&#34;+&#34;&nbsp;or&nbsp;&#34;-&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2909232">priority</span>&nbsp;<span class="builtintype" id="2909241">int</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2909247">//&nbsp;A&nbsp;trie&nbsp;node&nbsp;may&nbsp;have&nbsp;zero,&nbsp;one&nbsp;or&nbsp;more&nbsp;child&nbsp;nodes:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2909303">//&nbsp;&nbsp;*&nbsp;if&nbsp;the&nbsp;remaining&nbsp;fields&nbsp;are&nbsp;zero,&nbsp;there&nbsp;are&nbsp;no&nbsp;children.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2909367">//&nbsp;&nbsp;*&nbsp;if&nbsp;prefix&nbsp;and&nbsp;next&nbsp;are&nbsp;non-zero,&nbsp;there&nbsp;is&nbsp;one&nbsp;child&nbsp;in&nbsp;next.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2909435">//&nbsp;&nbsp;*&nbsp;if&nbsp;table&nbsp;is&nbsp;non-zero,&nbsp;it&nbsp;defines&nbsp;all&nbsp;the&nbsp;children.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2909493">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2909497">//&nbsp;Prefixes&nbsp;are&nbsp;preferred&nbsp;over&nbsp;tables&nbsp;when&nbsp;there&nbsp;is&nbsp;one&nbsp;child,&nbsp;but&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2909569">//&nbsp;root&nbsp;node&nbsp;always&nbsp;uses&nbsp;a&nbsp;table&nbsp;for&nbsp;lookup&nbsp;efficiency.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2909627">//&nbsp;prefix&nbsp;is&nbsp;the&nbsp;difference&nbsp;in&nbsp;keys&nbsp;between&nbsp;this&nbsp;trie&nbsp;node&nbsp;and&nbsp;the&nbsp;next.</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2909701">//&nbsp;In&nbsp;the&nbsp;example&nbsp;above,&nbsp;node&nbsp;n4&nbsp;has&nbsp;prefix&nbsp;&#34;cbc&#34;&nbsp;and&nbsp;n4&#39;s&nbsp;next&nbsp;node&nbsp;is&nbsp;n5.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2909778">//&nbsp;Node&nbsp;n5&nbsp;has&nbsp;no&nbsp;children&nbsp;and&nbsp;so&nbsp;has&nbsp;zero&nbsp;prefix,&nbsp;next&nbsp;and&nbsp;table&nbsp;fields.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2909853">prefix</span>&nbsp;<span class="builtintype" id="2909860">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2909868">next</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2909875">*</span><span class="ident" id="2909876">trieNode</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2909887">//&nbsp;table&nbsp;is&nbsp;a&nbsp;lookup&nbsp;table&nbsp;indexed&nbsp;by&nbsp;the&nbsp;next&nbsp;byte&nbsp;in&nbsp;the&nbsp;key,&nbsp;after</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2909958">//&nbsp;remapping&nbsp;that&nbsp;byte&nbsp;through&nbsp;genericReplacer.mapping&nbsp;to&nbsp;create&nbsp;a&nbsp;dense</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2910032">//&nbsp;index.&nbsp;In&nbsp;the&nbsp;example&nbsp;above,&nbsp;the&nbsp;keys&nbsp;only&nbsp;use&nbsp;&#39;a&#39;,&nbsp;&#39;b&#39;,&nbsp;&#39;c&#39;,&nbsp;&#39;x&#39;&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2910106">//&nbsp;&#39;y&#39;,&nbsp;which&nbsp;remap&nbsp;to&nbsp;0,&nbsp;1,&nbsp;2,&nbsp;3&nbsp;and&nbsp;4.&nbsp;All&nbsp;other&nbsp;bytes&nbsp;remap&nbsp;to&nbsp;5,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2910180">//&nbsp;genericReplacer.tableSize&nbsp;will&nbsp;be&nbsp;5.&nbsp;Node&nbsp;n0&#39;s&nbsp;table&nbsp;will&nbsp;be</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2910245">//&nbsp;[]*trieNode{&nbsp;0:n1,&nbsp;1:n4,&nbsp;3:n6&nbsp;},&nbsp;where&nbsp;the&nbsp;0,&nbsp;1&nbsp;and&nbsp;3&nbsp;are&nbsp;the&nbsp;remapped</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2910320">//&nbsp;&#39;a&#39;,&nbsp;&#39;b&#39;&nbsp;and&nbsp;&#39;x&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2910342">table</span>&nbsp;<span class="op" id="2910348">[</span><span class="op" id="2910349">]</span><span class="op" id="2910350">*</span><span class="ident" id="2910351">trieNode</span><br>
<span class="lineno"></span><span class="op" id="2910360">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="2910363">func</span>&nbsp;<span class="op" id="2910368">(</span><span class="ident" id="2910369">t</span>&nbsp;<span class="op" id="2910371">*</span><span class="ident" id="2910372">trieNode</span><span class="op" id="2910380">)</span>&nbsp;<span class="ident" id="2910382">add</span><span class="op" id="2910385">(</span><span class="ident" id="2910386">key</span><span class="op" id="2910389">,</span>&nbsp;<span class="ident" id="2910391">val</span>&nbsp;<span class="builtintype" id="2910395">string</span><span class="op" id="2910401">,</span>&nbsp;<span class="ident" id="2910403">priority</span>&nbsp;<span class="builtintype" id="2910412">int</span><span class="op" id="2910415">,</span>&nbsp;<span class="ident" id="2910417">r</span>&nbsp;<span class="op" id="2910419">*</span><span class="ident" id="2910420">genericReplacer</span><span class="op" id="2910435">)</span>&nbsp;<span class="op" id="2910437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2910440">if</span>&nbsp;<span class="ident" id="2910443">key</span>&nbsp;<span class="op" id="2910447">==</span>&nbsp;<span class="string" id="2910450">&#34;&#34;</span>&nbsp;<span class="op" id="2910453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2910457">if</span>&nbsp;<span class="ident" id="2910460">t</span><span class="op" id="2910461">.</span><span class="ident" id="2910462">priority</span>&nbsp;<span class="op" id="2910471">==</span>&nbsp;<span class="num" id="2910474">0</span>&nbsp;<span class="op" id="2910476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2910481">t</span><span class="op" id="2910482">.</span><span class="ident" id="2910483">value</span>&nbsp;<span class="op" id="2910489">=</span>&nbsp;<span class="ident" id="2910491">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2910498">t</span><span class="op" id="2910499">.</span><span class="ident" id="2910500">priority</span>&nbsp;<span class="op" id="2910509">=</span>&nbsp;<span class="ident" id="2910511">priority</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2910522">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2910526">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2910534">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2910538">if</span>&nbsp;<span class="ident" id="2910541">t</span><span class="op" id="2910542">.</span><span class="ident" id="2910543">prefix</span>&nbsp;<span class="op" id="2910550">!=</span>&nbsp;<span class="string" id="2910553">&#34;&#34;</span>&nbsp;<span class="op" id="2910556">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2910560">//&nbsp;Need&nbsp;to&nbsp;split&nbsp;the&nbsp;prefix&nbsp;among&nbsp;multiple&nbsp;nodes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2910612">var</span>&nbsp;<span class="ident" id="2910616">n</span>&nbsp;<span class="builtintype" id="2910618">int</span>&nbsp;<span class="comment" id="2910622">//&nbsp;length&nbsp;of&nbsp;the&nbsp;longest&nbsp;common&nbsp;prefix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2910663">for</span>&nbsp;<span class="op" id="2910667">;</span>&nbsp;<span class="ident" id="2910669">n</span>&nbsp;<span class="op" id="2910671">&lt;</span>&nbsp;<span class="builtinfunc" id="2910673">len</span><span class="op" id="2910676">(</span><span class="ident" id="2910677">t</span><span class="op" id="2910678">.</span><span class="ident" id="2910679">prefix</span><span class="op" id="2910685">)</span>&nbsp;<span class="op" id="2910687">&amp;&amp;</span>&nbsp;<span class="ident" id="2910690">n</span>&nbsp;<span class="op" id="2910692">&lt;</span>&nbsp;<span class="builtinfunc" id="2910694">len</span><span class="op" id="2910697">(</span><span class="ident" id="2910698">key</span><span class="op" id="2910701">)</span><span class="op" id="2910702">;</span>&nbsp;<span class="ident" id="2910704">n</span><span class="op" id="2910705">++</span>&nbsp;<span class="op" id="2910708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2910713">if</span>&nbsp;<span class="ident" id="2910716">t</span><span class="op" id="2910717">.</span><span class="ident" id="2910718">prefix</span><span class="op" id="2910724">[</span><span class="ident" id="2910725">n</span><span class="op" id="2910726">]</span>&nbsp;<span class="op" id="2910728">!=</span>&nbsp;<span class="ident" id="2910731">key</span><span class="op" id="2910734">[</span><span class="ident" id="2910735">n</span><span class="op" id="2910736">]</span>&nbsp;<span class="op" id="2910738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2910744">break</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2910753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2910757">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2910761">if</span>&nbsp;<span class="ident" id="2910764">n</span>&nbsp;<span class="op" id="2910766">==</span>&nbsp;<span class="builtinfunc" id="2910769">len</span><span class="op" id="2910772">(</span><span class="ident" id="2910773">t</span><span class="op" id="2910774">.</span><span class="ident" id="2910775">prefix</span><span class="op" id="2910781">)</span>&nbsp;<span class="op" id="2910783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2910788">t</span><span class="op" id="2910789">.</span><span class="ident" id="2910790">next</span><span class="op" id="2910794">.</span><span class="ident" id="2910795">add</span><span class="op" id="2910798">(</span><span class="ident" id="2910799">key</span><span class="op" id="2910802">[</span><span class="ident" id="2910803">n</span><span class="op" id="2910804">:</span><span class="op" id="2910805">]</span><span class="op" id="2910806">,</span>&nbsp;<span class="ident" id="2910808">val</span><span class="op" id="2910811">,</span>&nbsp;<span class="ident" id="2910813">priority</span><span class="op" id="2910821">,</span>&nbsp;<span class="ident" id="2910823">r</span><span class="op" id="2910824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2910828">}</span>&nbsp;<span class="keyword" id="2910830">else</span>&nbsp;<span class="keyword" id="2910835">if</span>&nbsp;<span class="ident" id="2910838">n</span>&nbsp;<span class="op" id="2910840">==</span>&nbsp;<span class="num" id="2910843">0</span>&nbsp;<span class="op" id="2910845">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2910850">//&nbsp;First&nbsp;byte&nbsp;differs,&nbsp;start&nbsp;a&nbsp;new&nbsp;lookup&nbsp;table&nbsp;here.&nbsp;Looking&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2910918">//&nbsp;what&nbsp;is&nbsp;currently&nbsp;t.prefix[0]&nbsp;will&nbsp;lead&nbsp;to&nbsp;prefixNode,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2910983">//&nbsp;looking&nbsp;up&nbsp;key[0]&nbsp;will&nbsp;lead&nbsp;to&nbsp;keyNode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2911029">var</span>&nbsp;<span class="ident" id="2911033">prefixNode</span>&nbsp;<span class="op" id="2911044">*</span><span class="ident" id="2911045">trieNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2911057">if</span>&nbsp;<span class="builtinfunc" id="2911060">len</span><span class="op" id="2911063">(</span><span class="ident" id="2911064">t</span><span class="op" id="2911065">.</span><span class="ident" id="2911066">prefix</span><span class="op" id="2911072">)</span>&nbsp;<span class="op" id="2911074">==</span>&nbsp;<span class="num" id="2911077">1</span>&nbsp;<span class="op" id="2911079">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2911085">prefixNode</span>&nbsp;<span class="op" id="2911096">=</span>&nbsp;<span class="ident" id="2911098">t</span><span class="op" id="2911099">.</span><span class="ident" id="2911100">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2911108">}</span>&nbsp;<span class="keyword" id="2911110">else</span>&nbsp;<span class="op" id="2911115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2911121">prefixNode</span>&nbsp;<span class="op" id="2911132">=</span>&nbsp;<span class="op" id="2911134">&amp;</span><span class="ident" id="2911135">trieNode</span><span class="op" id="2911143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2911150">prefix</span><span class="op" id="2911156">:</span>&nbsp;<span class="ident" id="2911158">t</span><span class="op" id="2911159">.</span><span class="ident" id="2911160">prefix</span><span class="op" id="2911166">[</span><span class="num" id="2911167">1</span><span class="op" id="2911168">:</span><span class="op" id="2911169">]</span><span class="op" id="2911170">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2911177">next</span><span class="op" id="2911181">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2911185">t</span><span class="op" id="2911186">.</span><span class="ident" id="2911187">next</span><span class="op" id="2911191">,</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2911197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2911202">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2911207">keyNode</span>&nbsp;<span class="op" id="2911215">:=</span>&nbsp;<span class="builtinfunc" id="2911218">new</span><span class="op" id="2911221">(</span><span class="ident" id="2911222">trieNode</span><span class="op" id="2911230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2911235">t</span><span class="op" id="2911236">.</span><span class="ident" id="2911237">table</span>&nbsp;<span class="op" id="2911243">=</span>&nbsp;<span class="builtinfunc" id="2911245">make</span><span class="op" id="2911249">(</span><span class="op" id="2911250">[</span><span class="op" id="2911251">]</span><span class="op" id="2911252">*</span><span class="ident" id="2911253">trieNode</span><span class="op" id="2911261">,</span>&nbsp;<span class="ident" id="2911263">r</span><span class="op" id="2911264">.</span><span class="ident" id="2911265">tableSize</span><span class="op" id="2911274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2911279">t</span><span class="op" id="2911280">.</span><span class="ident" id="2911281">table</span><span class="op" id="2911286">[</span><span class="ident" id="2911287">r</span><span class="op" id="2911288">.</span><span class="ident" id="2911289">mapping</span><span class="op" id="2911296">[</span><span class="ident" id="2911297">t</span><span class="op" id="2911298">.</span><span class="ident" id="2911299">prefix</span><span class="op" id="2911305">[</span><span class="num" id="2911306">0</span><span class="op" id="2911307">]</span><span class="op" id="2911308">]</span><span class="op" id="2911309">]</span>&nbsp;<span class="op" id="2911311">=</span>&nbsp;<span class="ident" id="2911313">prefixNode</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2911327">t</span><span class="op" id="2911328">.</span><span class="ident" id="2911329">table</span><span class="op" id="2911334">[</span><span class="ident" id="2911335">r</span><span class="op" id="2911336">.</span><span class="ident" id="2911337">mapping</span><span class="op" id="2911344">[</span><span class="ident" id="2911345">key</span><span class="op" id="2911348">[</span><span class="num" id="2911349">0</span><span class="op" id="2911350">]</span><span class="op" id="2911351">]</span><span class="op" id="2911352">]</span>&nbsp;<span class="op" id="2911354">=</span>&nbsp;<span class="ident" id="2911356">keyNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2911367">t</span><span class="op" id="2911368">.</span><span class="ident" id="2911369">prefix</span>&nbsp;<span class="op" id="2911376">=</span>&nbsp;<span class="string" id="2911378">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2911384">t</span><span class="op" id="2911385">.</span><span class="ident" id="2911386">next</span>&nbsp;<span class="op" id="2911391">=</span>&nbsp;<span class="ident" id="2911393">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2911400">keyNode</span><span class="op" id="2911407">.</span><span class="ident" id="2911408">add</span><span class="op" id="2911411">(</span><span class="ident" id="2911412">key</span><span class="op" id="2911415">[</span><span class="num" id="2911416">1</span><span class="op" id="2911417">:</span><span class="op" id="2911418">]</span><span class="op" id="2911419">,</span>&nbsp;<span class="ident" id="2911421">val</span><span class="op" id="2911424">,</span>&nbsp;<span class="ident" id="2911426">priority</span><span class="op" id="2911434">,</span>&nbsp;<span class="ident" id="2911436">r</span><span class="op" id="2911437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2911441">}</span>&nbsp;<span class="keyword" id="2911443">else</span>&nbsp;<span class="op" id="2911448">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2911453">//&nbsp;Insert&nbsp;new&nbsp;node&nbsp;after&nbsp;the&nbsp;common&nbsp;section&nbsp;of&nbsp;the&nbsp;prefix.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2911515">next</span>&nbsp;<span class="op" id="2911520">:=</span>&nbsp;<span class="op" id="2911523">&amp;</span><span class="ident" id="2911524">trieNode</span><span class="op" id="2911532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2911538">prefix</span><span class="op" id="2911544">:</span>&nbsp;<span class="ident" id="2911546">t</span><span class="op" id="2911547">.</span><span class="ident" id="2911548">prefix</span><span class="op" id="2911554">[</span><span class="ident" id="2911555">n</span><span class="op" id="2911556">:</span><span class="op" id="2911557">]</span><span class="op" id="2911558">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2911564">next</span><span class="op" id="2911568">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2911572">t</span><span class="op" id="2911573">.</span><span class="ident" id="2911574">next</span><span class="op" id="2911578">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2911583">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2911588">t</span><span class="op" id="2911589">.</span><span class="ident" id="2911590">prefix</span>&nbsp;<span class="op" id="2911597">=</span>&nbsp;<span class="ident" id="2911599">t</span><span class="op" id="2911600">.</span><span class="ident" id="2911601">prefix</span><span class="op" id="2911607">[</span><span class="op" id="2911608">:</span><span class="ident" id="2911609">n</span><span class="op" id="2911610">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2911615">t</span><span class="op" id="2911616">.</span><span class="ident" id="2911617">next</span>&nbsp;<span class="op" id="2911622">=</span>&nbsp;<span class="ident" id="2911624">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2911632">next</span><span class="op" id="2911636">.</span><span class="ident" id="2911637">add</span><span class="op" id="2911640">(</span><span class="ident" id="2911641">key</span><span class="op" id="2911644">[</span><span class="ident" id="2911645">n</span><span class="op" id="2911646">:</span><span class="op" id="2911647">]</span><span class="op" id="2911648">,</span>&nbsp;<span class="ident" id="2911650">val</span><span class="op" id="2911653">,</span>&nbsp;<span class="ident" id="2911655">priority</span><span class="op" id="2911663">,</span>&nbsp;<span class="ident" id="2911665">r</span><span class="op" id="2911666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2911670">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2911673">}</span>&nbsp;<span class="keyword" id="2911675">else</span>&nbsp;<span class="keyword" id="2911680">if</span>&nbsp;<span class="ident" id="2911683">t</span><span class="op" id="2911684">.</span><span class="ident" id="2911685">table</span>&nbsp;<span class="op" id="2911691">!=</span>&nbsp;<span class="ident" id="2911694">nil</span>&nbsp;<span class="op" id="2911698">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2911702">//&nbsp;Insert&nbsp;into&nbsp;existing&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2911735">m</span>&nbsp;<span class="op" id="2911737">:=</span>&nbsp;<span class="ident" id="2911740">r</span><span class="op" id="2911741">.</span><span class="ident" id="2911742">mapping</span><span class="op" id="2911749">[</span><span class="ident" id="2911750">key</span><span class="op" id="2911753">[</span><span class="num" id="2911754">0</span><span class="op" id="2911755">]</span><span class="op" id="2911756">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2911760">if</span>&nbsp;<span class="ident" id="2911763">t</span><span class="op" id="2911764">.</span><span class="ident" id="2911765">table</span><span class="op" id="2911770">[</span><span class="ident" id="2911771">m</span><span class="op" id="2911772">]</span>&nbsp;<span class="op" id="2911774">==</span>&nbsp;<span class="ident" id="2911777">nil</span>&nbsp;<span class="op" id="2911781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2911786">t</span><span class="op" id="2911787">.</span><span class="ident" id="2911788">table</span><span class="op" id="2911793">[</span><span class="ident" id="2911794">m</span><span class="op" id="2911795">]</span>&nbsp;<span class="op" id="2911797">=</span>&nbsp;<span class="builtinfunc" id="2911799">new</span><span class="op" id="2911802">(</span><span class="ident" id="2911803">trieNode</span><span class="op" id="2911811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2911815">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2911819">t</span><span class="op" id="2911820">.</span><span class="ident" id="2911821">table</span><span class="op" id="2911826">[</span><span class="ident" id="2911827">m</span><span class="op" id="2911828">]</span><span class="op" id="2911829">.</span><span class="ident" id="2911830">add</span><span class="op" id="2911833">(</span><span class="ident" id="2911834">key</span><span class="op" id="2911837">[</span><span class="num" id="2911838">1</span><span class="op" id="2911839">:</span><span class="op" id="2911840">]</span><span class="op" id="2911841">,</span>&nbsp;<span class="ident" id="2911843">val</span><span class="op" id="2911846">,</span>&nbsp;<span class="ident" id="2911848">priority</span><span class="op" id="2911856">,</span>&nbsp;<span class="ident" id="2911858">r</span><span class="op" id="2911859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2911862">}</span>&nbsp;<span class="keyword" id="2911864">else</span>&nbsp;<span class="op" id="2911869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2911873">t</span><span class="op" id="2911874">.</span><span class="ident" id="2911875">prefix</span>&nbsp;<span class="op" id="2911882">=</span>&nbsp;<span class="ident" id="2911884">key</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2911890">t</span><span class="op" id="2911891">.</span><span class="ident" id="2911892">next</span>&nbsp;<span class="op" id="2911897">=</span>&nbsp;<span class="builtinfunc" id="2911899">new</span><span class="op" id="2911902">(</span><span class="ident" id="2911903">trieNode</span><span class="op" id="2911911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2911915">t</span><span class="op" id="2911916">.</span><span class="ident" id="2911917">next</span><span class="op" id="2911921">.</span><span class="ident" id="2911922">add</span><span class="op" id="2911925">(</span><span class="string" id="2911926">&#34;&#34;</span><span class="op" id="2911928">,</span>&nbsp;<span class="ident" id="2911930">val</span><span class="op" id="2911933">,</span>&nbsp;<span class="ident" id="2911935">priority</span><span class="op" id="2911943">,</span>&nbsp;<span class="ident" id="2911945">r</span><span class="op" id="2911946">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2911949">}</span><br>
<span class="lineno"></span><span class="op" id="2911951">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2911954">func</span>&nbsp;<span class="op" id="2911959">(</span><span class="ident" id="2911960">r</span>&nbsp;<span class="op" id="2911962">*</span><span class="ident" id="2911963">genericReplacer</span><span class="op" id="2911978">)</span>&nbsp;<span class="ident" id="2911980">lookup</span><span class="op" id="2911986">(</span><span class="ident" id="2911987">s</span>&nbsp;<span class="builtintype" id="2911989">string</span><span class="op" id="2911995">,</span>&nbsp;<span class="ident" id="2911997">ignoreRoot</span>&nbsp;<span class="builtintype" id="2912008">bool</span><span class="op" id="2912012">)</span>&nbsp;<span class="op" id="2912014">(</span><span class="ident" id="2912015">val</span>&nbsp;<span class="builtintype" id="2912019">string</span><span class="op" id="2912025">,</span>&nbsp;<span class="ident" id="2912027">keylen</span>&nbsp;<span class="builtintype" id="2912034">int</span><span class="op" id="2912037">,</span>&nbsp;<span class="ident" id="2912039">found</span>&nbsp;<span class="builtintype" id="2912045">bool</span><span class="op" id="2912049">)</span>&nbsp;<span class="op" id="2912051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2912054">//&nbsp;Iterate&nbsp;down&nbsp;the&nbsp;trie&nbsp;to&nbsp;the&nbsp;end,&nbsp;and&nbsp;grab&nbsp;the&nbsp;value&nbsp;and&nbsp;keylen&nbsp;with</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2912127">//&nbsp;the&nbsp;highest&nbsp;priority.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2912153">bestPriority</span>&nbsp;<span class="op" id="2912166">:=</span>&nbsp;<span class="num" id="2912169">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2912172">node</span>&nbsp;<span class="op" id="2912177">:=</span>&nbsp;<span class="op" id="2912180">&amp;</span><span class="ident" id="2912181">r</span><span class="op" id="2912182">.</span><span class="ident" id="2912183">root</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2912189">n</span>&nbsp;<span class="op" id="2912191">:=</span>&nbsp;<span class="num" id="2912194">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2912197">for</span>&nbsp;<span class="ident" id="2912201">node</span>&nbsp;<span class="op" id="2912206">!=</span>&nbsp;<span class="ident" id="2912209">nil</span>&nbsp;<span class="op" id="2912213">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2912217">if</span>&nbsp;<span class="ident" id="2912220">node</span><span class="op" id="2912224">.</span><span class="ident" id="2912225">priority</span>&nbsp;<span class="op" id="2912234">&gt;</span>&nbsp;<span class="ident" id="2912236">bestPriority</span>&nbsp;<span class="op" id="2912249">&amp;&amp;</span>&nbsp;<span class="op" id="2912252">!</span><span class="op" id="2912253">(</span><span class="ident" id="2912254">ignoreRoot</span>&nbsp;<span class="op" id="2912265">&amp;&amp;</span>&nbsp;<span class="ident" id="2912268">node</span>&nbsp;<span class="op" id="2912273">==</span>&nbsp;<span class="op" id="2912276">&amp;</span><span class="ident" id="2912277">r</span><span class="op" id="2912278">.</span><span class="ident" id="2912279">root</span><span class="op" id="2912283">)</span>&nbsp;<span class="op" id="2912285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2912290">bestPriority</span>&nbsp;<span class="op" id="2912303">=</span>&nbsp;<span class="ident" id="2912305">node</span><span class="op" id="2912309">.</span><span class="ident" id="2912310">priority</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2912322">val</span>&nbsp;<span class="op" id="2912326">=</span>&nbsp;<span class="ident" id="2912328">node</span><span class="op" id="2912332">.</span><span class="ident" id="2912333">value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2912342">keylen</span>&nbsp;<span class="op" id="2912349">=</span>&nbsp;<span class="ident" id="2912351">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2912356">found</span>&nbsp;<span class="op" id="2912362">=</span>&nbsp;<span class="builtintype" id="2912364">true</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2912371">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2912376">if</span>&nbsp;<span class="ident" id="2912379">s</span>&nbsp;<span class="op" id="2912381">==</span>&nbsp;<span class="string" id="2912384">&#34;&#34;</span>&nbsp;<span class="op" id="2912387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2912392">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2912400">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2912404">if</span>&nbsp;<span class="ident" id="2912407">node</span><span class="op" id="2912411">.</span><span class="ident" id="2912412">table</span>&nbsp;<span class="op" id="2912418">!=</span>&nbsp;<span class="ident" id="2912421">nil</span>&nbsp;<span class="op" id="2912425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2912430">index</span>&nbsp;<span class="op" id="2912436">:=</span>&nbsp;<span class="ident" id="2912439">r</span><span class="op" id="2912440">.</span><span class="ident" id="2912441">mapping</span><span class="op" id="2912448">[</span><span class="ident" id="2912449">s</span><span class="op" id="2912450">[</span><span class="num" id="2912451">0</span><span class="op" id="2912452">]</span><span class="op" id="2912453">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2912458">if</span>&nbsp;<span class="builtintype" id="2912461">int</span><span class="op" id="2912464">(</span><span class="ident" id="2912465">index</span><span class="op" id="2912470">)</span>&nbsp;<span class="op" id="2912472">==</span>&nbsp;<span class="ident" id="2912475">r</span><span class="op" id="2912476">.</span><span class="ident" id="2912477">tableSize</span>&nbsp;<span class="op" id="2912487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2912493">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2912502">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2912507">node</span>&nbsp;<span class="op" id="2912512">=</span>&nbsp;<span class="ident" id="2912514">node</span><span class="op" id="2912518">.</span><span class="ident" id="2912519">table</span><span class="op" id="2912524">[</span><span class="ident" id="2912525">index</span><span class="op" id="2912530">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2912535">s</span>&nbsp;<span class="op" id="2912537">=</span>&nbsp;<span class="ident" id="2912539">s</span><span class="op" id="2912540">[</span><span class="num" id="2912541">1</span><span class="op" id="2912542">:</span><span class="op" id="2912543">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2912548">n</span><span class="op" id="2912549">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2912554">}</span>&nbsp;<span class="keyword" id="2912556">else</span>&nbsp;<span class="keyword" id="2912561">if</span>&nbsp;<span class="ident" id="2912564">node</span><span class="op" id="2912568">.</span><span class="ident" id="2912569">prefix</span>&nbsp;<span class="op" id="2912576">!=</span>&nbsp;<span class="string" id="2912579">&#34;&#34;</span>&nbsp;<span class="op" id="2912582">&amp;&amp;</span>&nbsp;<span class="ident" id="2912585">HasPrefix</span><span class="op" id="2912594">(</span><span class="ident" id="2912595">s</span><span class="op" id="2912596">,</span>&nbsp;<span class="ident" id="2912598">node</span><span class="op" id="2912602">.</span><span class="ident" id="2912603">prefix</span><span class="op" id="2912609">)</span>&nbsp;<span class="op" id="2912611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2912616">n</span>&nbsp;<span class="op" id="2912618">+=</span>&nbsp;<span class="builtinfunc" id="2912621">len</span><span class="op" id="2912624">(</span><span class="ident" id="2912625">node</span><span class="op" id="2912629">.</span><span class="ident" id="2912630">prefix</span><span class="op" id="2912636">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2912641">s</span>&nbsp;<span class="op" id="2912643">=</span>&nbsp;<span class="ident" id="2912645">s</span><span class="op" id="2912646">[</span><span class="builtinfunc" id="2912647">len</span><span class="op" id="2912650">(</span><span class="ident" id="2912651">node</span><span class="op" id="2912655">.</span><span class="ident" id="2912656">prefix</span><span class="op" id="2912662">)</span><span class="op" id="2912663">:</span><span class="op" id="2912664">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2912669">node</span>&nbsp;<span class="op" id="2912674">=</span>&nbsp;<span class="ident" id="2912676">node</span><span class="op" id="2912680">.</span><span class="ident" id="2912681">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2912688">}</span>&nbsp;<span class="keyword" id="2912690">else</span>&nbsp;<span class="op" id="2912695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2912700">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2912708">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2912711">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2912714">return</span><br>
<span class="lineno"></span><span class="op" id="2912721">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2912724">//&nbsp;genericReplacer&nbsp;is&nbsp;the&nbsp;fully&nbsp;generic&nbsp;algorithm.</span><br>
<span class="lineno">230</span><span class="comment" id="2912775">//&nbsp;It&#39;s&nbsp;used&nbsp;as&nbsp;a&nbsp;fallback&nbsp;when&nbsp;nothing&nbsp;faster&nbsp;can&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="2912835">type</span>&nbsp;<span class="ident" id="2912840">genericReplacer</span>&nbsp;<span class="keyword" id="2912856">struct</span>&nbsp;<span class="op" id="2912863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2912866">root</span>&nbsp;<span class="ident" id="2912871">trieNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2912881">//&nbsp;tableSize&nbsp;is&nbsp;the&nbsp;size&nbsp;of&nbsp;a&nbsp;trie&nbsp;node&#39;s&nbsp;lookup&nbsp;table.&nbsp;It&nbsp;is&nbsp;the&nbsp;number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2912955">//&nbsp;of&nbsp;unique&nbsp;key&nbsp;bytes.</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2912980">tableSize</span>&nbsp;<span class="builtintype" id="2912990">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2912995">//&nbsp;mapping&nbsp;maps&nbsp;from&nbsp;key&nbsp;bytes&nbsp;to&nbsp;a&nbsp;dense&nbsp;index&nbsp;for&nbsp;trieNode.table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2913064">mapping</span>&nbsp;<span class="op" id="2913072">[</span><span class="num" id="2913073">256</span><span class="op" id="2913076">]</span><span class="builtintype" id="2913077">byte</span><br>
<span class="lineno"></span><span class="op" id="2913082">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span><span class="keyword" id="2913085">func</span>&nbsp;<span class="ident" id="2913090">makeGenericReplacer</span><span class="op" id="2913109">(</span><span class="ident" id="2913110">oldnew</span>&nbsp;<span class="op" id="2913117">[</span><span class="op" id="2913118">]</span><span class="builtintype" id="2913119">string</span><span class="op" id="2913125">)</span>&nbsp;<span class="op" id="2913127">*</span><span class="ident" id="2913128">genericReplacer</span>&nbsp;<span class="op" id="2913144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2913147">r</span>&nbsp;<span class="op" id="2913149">:=</span>&nbsp;<span class="builtinfunc" id="2913152">new</span><span class="op" id="2913155">(</span><span class="ident" id="2913156">genericReplacer</span><span class="op" id="2913171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2913174">//&nbsp;Find&nbsp;each&nbsp;byte&nbsp;used,&nbsp;then&nbsp;assign&nbsp;them&nbsp;each&nbsp;an&nbsp;index.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2913231">for</span>&nbsp;<span class="ident" id="2913235">i</span>&nbsp;<span class="op" id="2913237">:=</span>&nbsp;<span class="num" id="2913240">0</span><span class="op" id="2913241">;</span>&nbsp;<span class="ident" id="2913243">i</span>&nbsp;<span class="op" id="2913245">&lt;</span>&nbsp;<span class="builtinfunc" id="2913247">len</span><span class="op" id="2913250">(</span><span class="ident" id="2913251">oldnew</span><span class="op" id="2913257">)</span><span class="op" id="2913258">;</span>&nbsp;<span class="ident" id="2913260">i</span>&nbsp;<span class="op" id="2913262">+=</span>&nbsp;<span class="num" id="2913265">2</span>&nbsp;<span class="op" id="2913267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2913271">key</span>&nbsp;<span class="op" id="2913275">:=</span>&nbsp;<span class="ident" id="2913278">oldnew</span><span class="op" id="2913284">[</span><span class="ident" id="2913285">i</span><span class="op" id="2913286">]</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2913290">for</span>&nbsp;<span class="ident" id="2913294">j</span>&nbsp;<span class="op" id="2913296">:=</span>&nbsp;<span class="num" id="2913299">0</span><span class="op" id="2913300">;</span>&nbsp;<span class="ident" id="2913302">j</span>&nbsp;<span class="op" id="2913304">&lt;</span>&nbsp;<span class="builtinfunc" id="2913306">len</span><span class="op" id="2913309">(</span><span class="ident" id="2913310">key</span><span class="op" id="2913313">)</span><span class="op" id="2913314">;</span>&nbsp;<span class="ident" id="2913316">j</span><span class="op" id="2913317">++</span>&nbsp;<span class="op" id="2913320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2913325">r</span><span class="op" id="2913326">.</span><span class="ident" id="2913327">mapping</span><span class="op" id="2913334">[</span><span class="ident" id="2913335">key</span><span class="op" id="2913338">[</span><span class="ident" id="2913339">j</span><span class="op" id="2913340">]</span><span class="op" id="2913341">]</span>&nbsp;<span class="op" id="2913343">=</span>&nbsp;<span class="num" id="2913345">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2913349">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2913352">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2913356">for</span>&nbsp;<span class="ident" id="2913360">_</span><span class="op" id="2913361">,</span>&nbsp;<span class="ident" id="2913363">b</span>&nbsp;<span class="op" id="2913365">:=</span>&nbsp;<span class="keyword" id="2913368">range</span>&nbsp;<span class="ident" id="2913374">r</span><span class="op" id="2913375">.</span><span class="ident" id="2913376">mapping</span>&nbsp;<span class="op" id="2913384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2913388">r</span><span class="op" id="2913389">.</span><span class="ident" id="2913390">tableSize</span>&nbsp;<span class="op" id="2913400">+=</span>&nbsp;<span class="builtintype" id="2913403">int</span><span class="op" id="2913406">(</span><span class="ident" id="2913407">b</span><span class="op" id="2913408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2913411">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2913415">var</span>&nbsp;<span class="ident" id="2913419">index</span>&nbsp;<span class="builtintype" id="2913425">byte</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2913431">for</span>&nbsp;<span class="ident" id="2913435">i</span><span class="op" id="2913436">,</span>&nbsp;<span class="ident" id="2913438">b</span>&nbsp;<span class="op" id="2913440">:=</span>&nbsp;<span class="keyword" id="2913443">range</span>&nbsp;<span class="ident" id="2913449">r</span><span class="op" id="2913450">.</span><span class="ident" id="2913451">mapping</span>&nbsp;<span class="op" id="2913459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2913463">if</span>&nbsp;<span class="ident" id="2913466">b</span>&nbsp;<span class="op" id="2913468">==</span>&nbsp;<span class="num" id="2913471">0</span>&nbsp;<span class="op" id="2913473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2913478">r</span><span class="op" id="2913479">.</span><span class="ident" id="2913480">mapping</span><span class="op" id="2913487">[</span><span class="ident" id="2913488">i</span><span class="op" id="2913489">]</span>&nbsp;<span class="op" id="2913491">=</span>&nbsp;<span class="builtintype" id="2913493">byte</span><span class="op" id="2913497">(</span><span class="ident" id="2913498">r</span><span class="op" id="2913499">.</span><span class="ident" id="2913500">tableSize</span><span class="op" id="2913509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2913513">}</span>&nbsp;<span class="keyword" id="2913515">else</span>&nbsp;<span class="op" id="2913520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2913525">r</span><span class="op" id="2913526">.</span><span class="ident" id="2913527">mapping</span><span class="op" id="2913534">[</span><span class="ident" id="2913535">i</span><span class="op" id="2913536">]</span>&nbsp;<span class="op" id="2913538">=</span>&nbsp;<span class="ident" id="2913540">index</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2913549">index</span><span class="op" id="2913554">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2913559">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2913562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2913565">//&nbsp;Ensure&nbsp;root&nbsp;node&nbsp;uses&nbsp;a&nbsp;lookup&nbsp;table&nbsp;(for&nbsp;performance).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2913625">r</span><span class="op" id="2913626">.</span><span class="ident" id="2913627">root</span><span class="op" id="2913631">.</span><span class="ident" id="2913632">table</span>&nbsp;<span class="op" id="2913638">=</span>&nbsp;<span class="builtinfunc" id="2913640">make</span><span class="op" id="2913644">(</span><span class="op" id="2913645">[</span><span class="op" id="2913646">]</span><span class="op" id="2913647">*</span><span class="ident" id="2913648">trieNode</span><span class="op" id="2913656">,</span>&nbsp;<span class="ident" id="2913658">r</span><span class="op" id="2913659">.</span><span class="ident" id="2913660">tableSize</span><span class="op" id="2913669">)</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2913673">for</span>&nbsp;<span class="ident" id="2913677">i</span>&nbsp;<span class="op" id="2913679">:=</span>&nbsp;<span class="num" id="2913682">0</span><span class="op" id="2913683">;</span>&nbsp;<span class="ident" id="2913685">i</span>&nbsp;<span class="op" id="2913687">&lt;</span>&nbsp;<span class="builtinfunc" id="2913689">len</span><span class="op" id="2913692">(</span><span class="ident" id="2913693">oldnew</span><span class="op" id="2913699">)</span><span class="op" id="2913700">;</span>&nbsp;<span class="ident" id="2913702">i</span>&nbsp;<span class="op" id="2913704">+=</span>&nbsp;<span class="num" id="2913707">2</span>&nbsp;<span class="op" id="2913709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2913713">r</span><span class="op" id="2913714">.</span><span class="ident" id="2913715">root</span><span class="op" id="2913719">.</span><span class="ident" id="2913720">add</span><span class="op" id="2913723">(</span><span class="ident" id="2913724">oldnew</span><span class="op" id="2913730">[</span><span class="ident" id="2913731">i</span><span class="op" id="2913732">]</span><span class="op" id="2913733">,</span>&nbsp;<span class="ident" id="2913735">oldnew</span><span class="op" id="2913741">[</span><span class="ident" id="2913742">i</span><span class="op" id="2913743">+</span><span class="num" id="2913744">1</span><span class="op" id="2913745">]</span><span class="op" id="2913746">,</span>&nbsp;<span class="builtinfunc" id="2913748">len</span><span class="op" id="2913751">(</span><span class="ident" id="2913752">oldnew</span><span class="op" id="2913758">)</span><span class="op" id="2913759">-</span><span class="ident" id="2913760">i</span><span class="op" id="2913761">,</span>&nbsp;<span class="ident" id="2913763">r</span><span class="op" id="2913764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2913767">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2913770">return</span>&nbsp;<span class="ident" id="2913777">r</span><br>
<span class="lineno">270</span><span class="op" id="2913779">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2913782">type</span>&nbsp;<span class="ident" id="2913787">appendSliceWriter</span>&nbsp;<span class="op" id="2913805">[</span><span class="op" id="2913806">]</span><span class="builtintype" id="2913807">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2913813">//&nbsp;Write&nbsp;writes&nbsp;to&nbsp;the&nbsp;buffer&nbsp;to&nbsp;satisfy&nbsp;io.Writer.</span><br>
<span class="lineno">275</span><span class="keyword" id="2913865">func</span>&nbsp;<span class="op" id="2913870">(</span><span class="ident" id="2913871">w</span>&nbsp;<span class="op" id="2913873">*</span><span class="ident" id="2913874">appendSliceWriter</span><span class="op" id="2913891">)</span>&nbsp;<span class="ident" id="2913893">Write</span><span class="op" id="2913898">(</span><span class="ident" id="2913899">p</span>&nbsp;<span class="op" id="2913901">[</span><span class="op" id="2913902">]</span><span class="builtintype" id="2913903">byte</span><span class="op" id="2913907">)</span>&nbsp;<span class="op" id="2913909">(</span><span class="builtintype" id="2913910">int</span><span class="op" id="2913913">,</span>&nbsp;<span class="builtintype" id="2913915">error</span><span class="op" id="2913920">)</span>&nbsp;<span class="op" id="2913922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2913925">*</span><span class="ident" id="2913926">w</span>&nbsp;<span class="op" id="2913928">=</span>&nbsp;<span class="builtinfunc" id="2913930">append</span><span class="op" id="2913936">(</span><span class="op" id="2913937">*</span><span class="ident" id="2913938">w</span><span class="op" id="2913939">,</span>&nbsp;<span class="ident" id="2913941">p</span><span class="op" id="2913942">...</span><span class="op" id="2913945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2913948">return</span>&nbsp;<span class="builtinfunc" id="2913955">len</span><span class="op" id="2913958">(</span><span class="ident" id="2913959">p</span><span class="op" id="2913960">)</span><span class="op" id="2913961">,</span>&nbsp;<span class="ident" id="2913963">nil</span><br>
<span class="lineno"></span><span class="op" id="2913967">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="comment" id="2913970">//&nbsp;WriteString&nbsp;writes&nbsp;to&nbsp;the&nbsp;buffer&nbsp;without&nbsp;string-&gt;[]byte-&gt;string&nbsp;allocations.</span><br>
<span class="lineno"></span><span class="keyword" id="2914050">func</span>&nbsp;<span class="op" id="2914055">(</span><span class="ident" id="2914056">w</span>&nbsp;<span class="op" id="2914058">*</span><span class="ident" id="2914059">appendSliceWriter</span><span class="op" id="2914076">)</span>&nbsp;<span class="ident" id="2914078">WriteString</span><span class="op" id="2914089">(</span><span class="ident" id="2914090">s</span>&nbsp;<span class="builtintype" id="2914092">string</span><span class="op" id="2914098">)</span>&nbsp;<span class="op" id="2914100">(</span><span class="builtintype" id="2914101">int</span><span class="op" id="2914104">,</span>&nbsp;<span class="builtintype" id="2914106">error</span><span class="op" id="2914111">)</span>&nbsp;<span class="op" id="2914113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2914116">*</span><span class="ident" id="2914117">w</span>&nbsp;<span class="op" id="2914119">=</span>&nbsp;<span class="builtinfunc" id="2914121">append</span><span class="op" id="2914127">(</span><span class="op" id="2914128">*</span><span class="ident" id="2914129">w</span><span class="op" id="2914130">,</span>&nbsp;<span class="ident" id="2914132">s</span><span class="op" id="2914133">...</span><span class="op" id="2914136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2914139">return</span>&nbsp;<span class="builtinfunc" id="2914146">len</span><span class="op" id="2914149">(</span><span class="ident" id="2914150">s</span><span class="op" id="2914151">)</span><span class="op" id="2914152">,</span>&nbsp;<span class="ident" id="2914154">nil</span><br>
<span class="lineno"></span><span class="op" id="2914158">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="keyword" id="2914161">type</span>&nbsp;<span class="ident" id="2914166">stringWriterIface</span>&nbsp;<span class="keyword" id="2914184">interface</span>&nbsp;<span class="op" id="2914194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2914197">WriteString</span><span class="op" id="2914208">(</span><span class="builtintype" id="2914209">string</span><span class="op" id="2914215">)</span>&nbsp;<span class="op" id="2914217">(</span><span class="builtintype" id="2914218">int</span><span class="op" id="2914221">,</span>&nbsp;<span class="builtintype" id="2914223">error</span><span class="op" id="2914228">)</span><br>
<span class="lineno"></span><span class="op" id="2914230">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span><span class="keyword" id="2914233">type</span>&nbsp;<span class="ident" id="2914238">stringWriter</span>&nbsp;<span class="keyword" id="2914251">struct</span>&nbsp;<span class="op" id="2914258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2914261">w</span>&nbsp;<span class="ident" id="2914263">io</span><span class="op" id="2914265">.</span><span class="ident" id="2914266">Writer</span><br>
<span class="lineno"></span><span class="op" id="2914273">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2914276">func</span>&nbsp;<span class="op" id="2914281">(</span><span class="ident" id="2914282">w</span>&nbsp;<span class="ident" id="2914284">stringWriter</span><span class="op" id="2914296">)</span>&nbsp;<span class="ident" id="2914298">WriteString</span><span class="op" id="2914309">(</span><span class="ident" id="2914310">s</span>&nbsp;<span class="builtintype" id="2914312">string</span><span class="op" id="2914318">)</span>&nbsp;<span class="op" id="2914320">(</span><span class="builtintype" id="2914321">int</span><span class="op" id="2914324">,</span>&nbsp;<span class="builtintype" id="2914326">error</span><span class="op" id="2914331">)</span>&nbsp;<span class="op" id="2914333">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2914336">return</span>&nbsp;<span class="ident" id="2914343">w</span><span class="op" id="2914344">.</span><span class="ident" id="2914345">w</span><span class="op" id="2914346">.</span><span class="ident" id="2914347">Write</span><span class="op" id="2914352">(</span><span class="op" id="2914353">[</span><span class="op" id="2914354">]</span><span class="builtintype" id="2914355">byte</span><span class="op" id="2914359">(</span><span class="ident" id="2914360">s</span><span class="op" id="2914361">)</span><span class="op" id="2914362">)</span><br>
<span class="lineno"></span><span class="op" id="2914364">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2914367">func</span>&nbsp;<span class="ident" id="2914372">getStringWriter</span><span class="op" id="2914387">(</span><span class="ident" id="2914388">w</span>&nbsp;<span class="ident" id="2914390">io</span><span class="op" id="2914392">.</span><span class="ident" id="2914393">Writer</span><span class="op" id="2914399">)</span>&nbsp;<span class="ident" id="2914401">stringWriterIface</span>&nbsp;<span class="op" id="2914419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2914422">sw</span><span class="op" id="2914424">,</span>&nbsp;<span class="ident" id="2914426">ok</span>&nbsp;<span class="op" id="2914429">:=</span>&nbsp;<span class="ident" id="2914432">w</span><span class="op" id="2914433">.</span><span class="op" id="2914434">(</span><span class="ident" id="2914435">stringWriterIface</span><span class="op" id="2914452">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2914455">if</span>&nbsp;<span class="op" id="2914458">!</span><span class="ident" id="2914459">ok</span>&nbsp;<span class="op" id="2914462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2914466">sw</span>&nbsp;<span class="op" id="2914469">=</span>&nbsp;<span class="ident" id="2914471">stringWriter</span><span class="op" id="2914483">{</span><span class="ident" id="2914484">w</span><span class="op" id="2914485">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2914488">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2914491">return</span>&nbsp;<span class="ident" id="2914498">sw</span><br>
<span class="lineno"></span><span class="op" id="2914501">}</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span><span class="keyword" id="2914504">func</span>&nbsp;<span class="op" id="2914509">(</span><span class="ident" id="2914510">r</span>&nbsp;<span class="op" id="2914512">*</span><span class="ident" id="2914513">genericReplacer</span><span class="op" id="2914528">)</span>&nbsp;<span class="ident" id="2914530">Replace</span><span class="op" id="2914537">(</span><span class="ident" id="2914538">s</span>&nbsp;<span class="builtintype" id="2914540">string</span><span class="op" id="2914546">)</span>&nbsp;<span class="builtintype" id="2914548">string</span>&nbsp;<span class="op" id="2914555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2914558">buf</span>&nbsp;<span class="op" id="2914562">:=</span>&nbsp;<span class="builtinfunc" id="2914565">make</span><span class="op" id="2914569">(</span><span class="ident" id="2914570">appendSliceWriter</span><span class="op" id="2914587">,</span>&nbsp;<span class="num" id="2914589">0</span><span class="op" id="2914590">,</span>&nbsp;<span class="builtinfunc" id="2914592">len</span><span class="op" id="2914595">(</span><span class="ident" id="2914596">s</span><span class="op" id="2914597">)</span><span class="op" id="2914598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2914601">r</span><span class="op" id="2914602">.</span><span class="ident" id="2914603">WriteString</span><span class="op" id="2914614">(</span><span class="op" id="2914615">&amp;</span><span class="ident" id="2914616">buf</span><span class="op" id="2914619">,</span>&nbsp;<span class="ident" id="2914621">s</span><span class="op" id="2914622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2914625">return</span>&nbsp;<span class="builtintype" id="2914632">string</span><span class="op" id="2914638">(</span><span class="ident" id="2914639">buf</span><span class="op" id="2914642">)</span><br>
<span class="lineno">310</span><span class="op" id="2914644">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2914647">func</span>&nbsp;<span class="op" id="2914652">(</span><span class="ident" id="2914653">r</span>&nbsp;<span class="op" id="2914655">*</span><span class="ident" id="2914656">genericReplacer</span><span class="op" id="2914671">)</span>&nbsp;<span class="ident" id="2914673">WriteString</span><span class="op" id="2914684">(</span><span class="ident" id="2914685">w</span>&nbsp;<span class="ident" id="2914687">io</span><span class="op" id="2914689">.</span><span class="ident" id="2914690">Writer</span><span class="op" id="2914696">,</span>&nbsp;<span class="ident" id="2914698">s</span>&nbsp;<span class="builtintype" id="2914700">string</span><span class="op" id="2914706">)</span>&nbsp;<span class="op" id="2914708">(</span><span class="ident" id="2914709">n</span>&nbsp;<span class="builtintype" id="2914711">int</span><span class="op" id="2914714">,</span>&nbsp;<span class="ident" id="2914716">err</span>&nbsp;<span class="builtintype" id="2914720">error</span><span class="op" id="2914725">)</span>&nbsp;<span class="op" id="2914727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2914730">sw</span>&nbsp;<span class="op" id="2914733">:=</span>&nbsp;<span class="ident" id="2914736">getStringWriter</span><span class="op" id="2914751">(</span><span class="ident" id="2914752">w</span><span class="op" id="2914753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2914756">var</span>&nbsp;<span class="ident" id="2914760">last</span><span class="op" id="2914764">,</span>&nbsp;<span class="ident" id="2914766">wn</span>&nbsp;<span class="builtintype" id="2914769">int</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2914774">var</span>&nbsp;<span class="ident" id="2914778">prevMatchEmpty</span>&nbsp;<span class="builtintype" id="2914793">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2914799">for</span>&nbsp;<span class="ident" id="2914803">i</span>&nbsp;<span class="op" id="2914805">:=</span>&nbsp;<span class="num" id="2914808">0</span><span class="op" id="2914809">;</span>&nbsp;<span class="ident" id="2914811">i</span>&nbsp;<span class="op" id="2914813">&lt;=</span>&nbsp;<span class="builtinfunc" id="2914816">len</span><span class="op" id="2914819">(</span><span class="ident" id="2914820">s</span><span class="op" id="2914821">)</span><span class="op" id="2914822">;</span>&nbsp;<span class="op" id="2914824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2914828">//&nbsp;Fast&nbsp;path:&nbsp;s[i]&nbsp;is&nbsp;not&nbsp;a&nbsp;prefix&nbsp;of&nbsp;any&nbsp;pattern.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2914881">if</span>&nbsp;<span class="ident" id="2914884">i</span>&nbsp;<span class="op" id="2914886">!=</span>&nbsp;<span class="builtinfunc" id="2914889">len</span><span class="op" id="2914892">(</span><span class="ident" id="2914893">s</span><span class="op" id="2914894">)</span>&nbsp;<span class="op" id="2914896">&amp;&amp;</span>&nbsp;<span class="ident" id="2914899">r</span><span class="op" id="2914900">.</span><span class="ident" id="2914901">root</span><span class="op" id="2914905">.</span><span class="ident" id="2914906">priority</span>&nbsp;<span class="op" id="2914915">==</span>&nbsp;<span class="num" id="2914918">0</span>&nbsp;<span class="op" id="2914920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2914925">index</span>&nbsp;<span class="op" id="2914931">:=</span>&nbsp;<span class="builtintype" id="2914934">int</span><span class="op" id="2914937">(</span><span class="ident" id="2914938">r</span><span class="op" id="2914939">.</span><span class="ident" id="2914940">mapping</span><span class="op" id="2914947">[</span><span class="ident" id="2914948">s</span><span class="op" id="2914949">[</span><span class="ident" id="2914950">i</span><span class="op" id="2914951">]</span><span class="op" id="2914952">]</span><span class="op" id="2914953">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2914958">if</span>&nbsp;<span class="ident" id="2914961">index</span>&nbsp;<span class="op" id="2914967">==</span>&nbsp;<span class="ident" id="2914970">r</span><span class="op" id="2914971">.</span><span class="ident" id="2914972">tableSize</span>&nbsp;<span class="op" id="2914982">||</span>&nbsp;<span class="ident" id="2914985">r</span><span class="op" id="2914986">.</span><span class="ident" id="2914987">root</span><span class="op" id="2914991">.</span><span class="ident" id="2914992">table</span><span class="op" id="2914997">[</span><span class="ident" id="2914998">index</span><span class="op" id="2915003">]</span>&nbsp;<span class="op" id="2915005">==</span>&nbsp;<span class="ident" id="2915008">nil</span>&nbsp;<span class="op" id="2915012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2915018">i</span><span class="op" id="2915019">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2915026">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2915038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2915042">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2915047">//&nbsp;Ignore&nbsp;the&nbsp;empty&nbsp;match&nbsp;iff&nbsp;the&nbsp;previous&nbsp;loop&nbsp;found&nbsp;the&nbsp;empty&nbsp;match.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2915120">val</span><span class="op" id="2915123">,</span>&nbsp;<span class="ident" id="2915125">keylen</span><span class="op" id="2915131">,</span>&nbsp;<span class="ident" id="2915133">match</span>&nbsp;<span class="op" id="2915139">:=</span>&nbsp;<span class="ident" id="2915142">r</span><span class="op" id="2915143">.</span><span class="ident" id="2915144">lookup</span><span class="op" id="2915150">(</span><span class="ident" id="2915151">s</span><span class="op" id="2915152">[</span><span class="ident" id="2915153">i</span><span class="op" id="2915154">:</span><span class="op" id="2915155">]</span><span class="op" id="2915156">,</span>&nbsp;<span class="ident" id="2915158">prevMatchEmpty</span><span class="op" id="2915172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2915176">prevMatchEmpty</span>&nbsp;<span class="op" id="2915191">=</span>&nbsp;<span class="ident" id="2915193">match</span>&nbsp;<span class="op" id="2915199">&amp;&amp;</span>&nbsp;<span class="ident" id="2915202">keylen</span>&nbsp;<span class="op" id="2915209">==</span>&nbsp;<span class="num" id="2915212">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2915216">if</span>&nbsp;<span class="ident" id="2915219">match</span>&nbsp;<span class="op" id="2915225">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2915230">wn</span><span class="op" id="2915232">,</span>&nbsp;<span class="ident" id="2915234">err</span>&nbsp;<span class="op" id="2915238">=</span>&nbsp;<span class="ident" id="2915240">sw</span><span class="op" id="2915242">.</span><span class="ident" id="2915243">WriteString</span><span class="op" id="2915254">(</span><span class="ident" id="2915255">s</span><span class="op" id="2915256">[</span><span class="ident" id="2915257">last</span><span class="op" id="2915261">:</span><span class="ident" id="2915262">i</span><span class="op" id="2915263">]</span><span class="op" id="2915264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2915269">n</span>&nbsp;<span class="op" id="2915271">+=</span>&nbsp;<span class="ident" id="2915274">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2915280">if</span>&nbsp;<span class="ident" id="2915283">err</span>&nbsp;<span class="op" id="2915287">!=</span>&nbsp;<span class="ident" id="2915290">nil</span>&nbsp;<span class="op" id="2915294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2915300">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2915310">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2915315">wn</span><span class="op" id="2915317">,</span>&nbsp;<span class="ident" id="2915319">err</span>&nbsp;<span class="op" id="2915323">=</span>&nbsp;<span class="ident" id="2915325">sw</span><span class="op" id="2915327">.</span><span class="ident" id="2915328">WriteString</span><span class="op" id="2915339">(</span><span class="ident" id="2915340">val</span><span class="op" id="2915343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2915348">n</span>&nbsp;<span class="op" id="2915350">+=</span>&nbsp;<span class="ident" id="2915353">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2915359">if</span>&nbsp;<span class="ident" id="2915362">err</span>&nbsp;<span class="op" id="2915366">!=</span>&nbsp;<span class="ident" id="2915369">nil</span>&nbsp;<span class="op" id="2915373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2915379">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2915389">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2915394">i</span>&nbsp;<span class="op" id="2915396">+=</span>&nbsp;<span class="ident" id="2915399">keylen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2915409">last</span>&nbsp;<span class="op" id="2915414">=</span>&nbsp;<span class="ident" id="2915416">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2915421">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2915432">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2915436">i</span><span class="op" id="2915437">++</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2915441">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2915444">if</span>&nbsp;<span class="ident" id="2915447">last</span>&nbsp;<span class="op" id="2915452">!=</span>&nbsp;<span class="builtinfunc" id="2915455">len</span><span class="op" id="2915458">(</span><span class="ident" id="2915459">s</span><span class="op" id="2915460">)</span>&nbsp;<span class="op" id="2915462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2915466">wn</span><span class="op" id="2915468">,</span>&nbsp;<span class="ident" id="2915470">err</span>&nbsp;<span class="op" id="2915474">=</span>&nbsp;<span class="ident" id="2915476">sw</span><span class="op" id="2915478">.</span><span class="ident" id="2915479">WriteString</span><span class="op" id="2915490">(</span><span class="ident" id="2915491">s</span><span class="op" id="2915492">[</span><span class="ident" id="2915493">last</span><span class="op" id="2915497">:</span><span class="op" id="2915498">]</span><span class="op" id="2915499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2915503">n</span>&nbsp;<span class="op" id="2915505">+=</span>&nbsp;<span class="ident" id="2915508">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2915512">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2915515">return</span><br>
<span class="lineno"></span><span class="op" id="2915522">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2915525">//&nbsp;singleStringReplacer&nbsp;is&nbsp;the&nbsp;implementation&nbsp;that&#39;s&nbsp;used&nbsp;when&nbsp;there&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="2915602">//&nbsp;one&nbsp;string&nbsp;to&nbsp;replace&nbsp;(and&nbsp;that&nbsp;string&nbsp;has&nbsp;more&nbsp;than&nbsp;one&nbsp;byte).</span><br>
<span class="lineno">355</span><span class="keyword" id="2915669">type</span>&nbsp;<span class="ident" id="2915674">singleStringReplacer</span>&nbsp;<span class="keyword" id="2915695">struct</span>&nbsp;<span class="op" id="2915702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2915705">finder</span>&nbsp;<span class="op" id="2915712">*</span><span class="ident" id="2915713">stringFinder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2915727">//&nbsp;value&nbsp;is&nbsp;the&nbsp;new&nbsp;string&nbsp;that&nbsp;replaces&nbsp;that&nbsp;pattern&nbsp;when&nbsp;it&#39;s&nbsp;found.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2915799">value</span>&nbsp;<span class="builtintype" id="2915805">string</span><br>
<span class="lineno"></span><span class="op" id="2915812">}</span><br>
<span class="lineno">360</span><br>
<span class="lineno"></span><span class="keyword" id="2915815">func</span>&nbsp;<span class="ident" id="2915820">makeSingleStringReplacer</span><span class="op" id="2915844">(</span><span class="ident" id="2915845">pattern</span>&nbsp;<span class="builtintype" id="2915853">string</span><span class="op" id="2915859">,</span>&nbsp;<span class="ident" id="2915861">value</span>&nbsp;<span class="builtintype" id="2915867">string</span><span class="op" id="2915873">)</span>&nbsp;<span class="op" id="2915875">*</span><span class="ident" id="2915876">singleStringReplacer</span>&nbsp;<span class="op" id="2915897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2915900">return</span>&nbsp;<span class="op" id="2915907">&amp;</span><span class="ident" id="2915908">singleStringReplacer</span><span class="op" id="2915928">{</span><span class="ident" id="2915929">finder</span><span class="op" id="2915935">:</span>&nbsp;<span class="ident" id="2915937">makeStringFinder</span><span class="op" id="2915953">(</span><span class="ident" id="2915954">pattern</span><span class="op" id="2915961">)</span><span class="op" id="2915962">,</span>&nbsp;<span class="ident" id="2915964">value</span><span class="op" id="2915969">:</span>&nbsp;<span class="ident" id="2915971">value</span><span class="op" id="2915976">}</span><br>
<span class="lineno"></span><span class="op" id="2915978">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="keyword" id="2915981">func</span>&nbsp;<span class="op" id="2915986">(</span><span class="ident" id="2915987">r</span>&nbsp;<span class="op" id="2915989">*</span><span class="ident" id="2915990">singleStringReplacer</span><span class="op" id="2916010">)</span>&nbsp;<span class="ident" id="2916012">Replace</span><span class="op" id="2916019">(</span><span class="ident" id="2916020">s</span>&nbsp;<span class="builtintype" id="2916022">string</span><span class="op" id="2916028">)</span>&nbsp;<span class="builtintype" id="2916030">string</span>&nbsp;<span class="op" id="2916037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2916040">var</span>&nbsp;<span class="ident" id="2916044">buf</span>&nbsp;<span class="op" id="2916048">[</span><span class="op" id="2916049">]</span><span class="builtintype" id="2916050">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2916056">i</span><span class="op" id="2916057">,</span>&nbsp;<span class="ident" id="2916059">matched</span>&nbsp;<span class="op" id="2916067">:=</span>&nbsp;<span class="num" id="2916070">0</span><span class="op" id="2916071">,</span>&nbsp;<span class="builtintype" id="2916073">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2916080">for</span>&nbsp;<span class="op" id="2916084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2916088">match</span>&nbsp;<span class="op" id="2916094">:=</span>&nbsp;<span class="ident" id="2916097">r</span><span class="op" id="2916098">.</span><span class="ident" id="2916099">finder</span><span class="op" id="2916105">.</span><span class="ident" id="2916106">next</span><span class="op" id="2916110">(</span><span class="ident" id="2916111">s</span><span class="op" id="2916112">[</span><span class="ident" id="2916113">i</span><span class="op" id="2916114">:</span><span class="op" id="2916115">]</span><span class="op" id="2916116">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2916120">if</span>&nbsp;<span class="ident" id="2916123">match</span>&nbsp;<span class="op" id="2916129">==</span>&nbsp;<span class="op" id="2916132">-</span><span class="num" id="2916133">1</span>&nbsp;<span class="op" id="2916135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2916140">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2916148">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2916152">matched</span>&nbsp;<span class="op" id="2916160">=</span>&nbsp;<span class="builtintype" id="2916162">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2916169">buf</span>&nbsp;<span class="op" id="2916173">=</span>&nbsp;<span class="builtinfunc" id="2916175">append</span><span class="op" id="2916181">(</span><span class="ident" id="2916182">buf</span><span class="op" id="2916185">,</span>&nbsp;<span class="ident" id="2916187">s</span><span class="op" id="2916188">[</span><span class="ident" id="2916189">i</span><span class="op" id="2916190">:</span><span class="ident" id="2916191">i</span><span class="op" id="2916192">+</span><span class="ident" id="2916193">match</span><span class="op" id="2916198">]</span><span class="op" id="2916199">...</span><span class="op" id="2916202">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2916206">buf</span>&nbsp;<span class="op" id="2916210">=</span>&nbsp;<span class="builtinfunc" id="2916212">append</span><span class="op" id="2916218">(</span><span class="ident" id="2916219">buf</span><span class="op" id="2916222">,</span>&nbsp;<span class="ident" id="2916224">r</span><span class="op" id="2916225">.</span><span class="ident" id="2916226">value</span><span class="op" id="2916231">...</span><span class="op" id="2916234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2916238">i</span>&nbsp;<span class="op" id="2916240">+=</span>&nbsp;<span class="ident" id="2916243">match</span>&nbsp;<span class="op" id="2916249">+</span>&nbsp;<span class="builtinfunc" id="2916251">len</span><span class="op" id="2916254">(</span><span class="ident" id="2916255">r</span><span class="op" id="2916256">.</span><span class="ident" id="2916257">finder</span><span class="op" id="2916263">.</span><span class="ident" id="2916264">pattern</span><span class="op" id="2916271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2916274">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2916277">if</span>&nbsp;<span class="op" id="2916280">!</span><span class="ident" id="2916281">matched</span>&nbsp;<span class="op" id="2916289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2916293">return</span>&nbsp;<span class="ident" id="2916300">s</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2916303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2916306">buf</span>&nbsp;<span class="op" id="2916310">=</span>&nbsp;<span class="builtinfunc" id="2916312">append</span><span class="op" id="2916318">(</span><span class="ident" id="2916319">buf</span><span class="op" id="2916322">,</span>&nbsp;<span class="ident" id="2916324">s</span><span class="op" id="2916325">[</span><span class="ident" id="2916326">i</span><span class="op" id="2916327">:</span><span class="op" id="2916328">]</span><span class="op" id="2916329">...</span><span class="op" id="2916332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2916335">return</span>&nbsp;<span class="builtintype" id="2916342">string</span><span class="op" id="2916348">(</span><span class="ident" id="2916349">buf</span><span class="op" id="2916352">)</span><br>
<span class="lineno"></span><span class="op" id="2916354">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span><span class="keyword" id="2916357">func</span>&nbsp;<span class="op" id="2916362">(</span><span class="ident" id="2916363">r</span>&nbsp;<span class="op" id="2916365">*</span><span class="ident" id="2916366">singleStringReplacer</span><span class="op" id="2916386">)</span>&nbsp;<span class="ident" id="2916388">WriteString</span><span class="op" id="2916399">(</span><span class="ident" id="2916400">w</span>&nbsp;<span class="ident" id="2916402">io</span><span class="op" id="2916404">.</span><span class="ident" id="2916405">Writer</span><span class="op" id="2916411">,</span>&nbsp;<span class="ident" id="2916413">s</span>&nbsp;<span class="builtintype" id="2916415">string</span><span class="op" id="2916421">)</span>&nbsp;<span class="op" id="2916423">(</span><span class="ident" id="2916424">n</span>&nbsp;<span class="builtintype" id="2916426">int</span><span class="op" id="2916429">,</span>&nbsp;<span class="ident" id="2916431">err</span>&nbsp;<span class="builtintype" id="2916435">error</span><span class="op" id="2916440">)</span>&nbsp;<span class="op" id="2916442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2916445">sw</span>&nbsp;<span class="op" id="2916448">:=</span>&nbsp;<span class="ident" id="2916451">getStringWriter</span><span class="op" id="2916466">(</span><span class="ident" id="2916467">w</span><span class="op" id="2916468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2916471">var</span>&nbsp;<span class="ident" id="2916475">i</span><span class="op" id="2916476">,</span>&nbsp;<span class="ident" id="2916478">wn</span>&nbsp;<span class="builtintype" id="2916481">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2916486">for</span>&nbsp;<span class="op" id="2916490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2916494">match</span>&nbsp;<span class="op" id="2916500">:=</span>&nbsp;<span class="ident" id="2916503">r</span><span class="op" id="2916504">.</span><span class="ident" id="2916505">finder</span><span class="op" id="2916511">.</span><span class="ident" id="2916512">next</span><span class="op" id="2916516">(</span><span class="ident" id="2916517">s</span><span class="op" id="2916518">[</span><span class="ident" id="2916519">i</span><span class="op" id="2916520">:</span><span class="op" id="2916521">]</span><span class="op" id="2916522">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2916526">if</span>&nbsp;<span class="ident" id="2916529">match</span>&nbsp;<span class="op" id="2916535">==</span>&nbsp;<span class="op" id="2916538">-</span><span class="num" id="2916539">1</span>&nbsp;<span class="op" id="2916541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2916546">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2916554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2916558">wn</span><span class="op" id="2916560">,</span>&nbsp;<span class="ident" id="2916562">err</span>&nbsp;<span class="op" id="2916566">=</span>&nbsp;<span class="ident" id="2916568">sw</span><span class="op" id="2916570">.</span><span class="ident" id="2916571">WriteString</span><span class="op" id="2916582">(</span><span class="ident" id="2916583">s</span><span class="op" id="2916584">[</span><span class="ident" id="2916585">i</span>&nbsp;<span class="op" id="2916587">:</span>&nbsp;<span class="ident" id="2916589">i</span><span class="op" id="2916590">+</span><span class="ident" id="2916591">match</span><span class="op" id="2916596">]</span><span class="op" id="2916597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2916601">n</span>&nbsp;<span class="op" id="2916603">+=</span>&nbsp;<span class="ident" id="2916606">wn</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2916611">if</span>&nbsp;<span class="ident" id="2916614">err</span>&nbsp;<span class="op" id="2916618">!=</span>&nbsp;<span class="ident" id="2916621">nil</span>&nbsp;<span class="op" id="2916625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2916630">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2916639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2916643">wn</span><span class="op" id="2916645">,</span>&nbsp;<span class="ident" id="2916647">err</span>&nbsp;<span class="op" id="2916651">=</span>&nbsp;<span class="ident" id="2916653">sw</span><span class="op" id="2916655">.</span><span class="ident" id="2916656">WriteString</span><span class="op" id="2916667">(</span><span class="ident" id="2916668">r</span><span class="op" id="2916669">.</span><span class="ident" id="2916670">value</span><span class="op" id="2916675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2916679">n</span>&nbsp;<span class="op" id="2916681">+=</span>&nbsp;<span class="ident" id="2916684">wn</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2916689">if</span>&nbsp;<span class="ident" id="2916692">err</span>&nbsp;<span class="op" id="2916696">!=</span>&nbsp;<span class="ident" id="2916699">nil</span>&nbsp;<span class="op" id="2916703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2916708">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2916717">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2916721">i</span>&nbsp;<span class="op" id="2916723">+=</span>&nbsp;<span class="ident" id="2916726">match</span>&nbsp;<span class="op" id="2916732">+</span>&nbsp;<span class="builtinfunc" id="2916734">len</span><span class="op" id="2916737">(</span><span class="ident" id="2916738">r</span><span class="op" id="2916739">.</span><span class="ident" id="2916740">finder</span><span class="op" id="2916746">.</span><span class="ident" id="2916747">pattern</span><span class="op" id="2916754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2916757">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2916760">wn</span><span class="op" id="2916762">,</span>&nbsp;<span class="ident" id="2916764">err</span>&nbsp;<span class="op" id="2916768">=</span>&nbsp;<span class="ident" id="2916770">sw</span><span class="op" id="2916772">.</span><span class="ident" id="2916773">WriteString</span><span class="op" id="2916784">(</span><span class="ident" id="2916785">s</span><span class="op" id="2916786">[</span><span class="ident" id="2916787">i</span><span class="op" id="2916788">:</span><span class="op" id="2916789">]</span><span class="op" id="2916790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2916793">n</span>&nbsp;<span class="op" id="2916795">+=</span>&nbsp;<span class="ident" id="2916798">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2916802">return</span><br>
<span class="lineno"></span><span class="op" id="2916809">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="comment" id="2916812">//&nbsp;byteReplacer&nbsp;is&nbsp;the&nbsp;implementation&nbsp;that&#39;s&nbsp;used&nbsp;when&nbsp;all&nbsp;the&nbsp;&#34;old&#34;</span><br>
<span class="lineno"></span><span class="comment" id="2916881">//&nbsp;and&nbsp;&#34;new&#34;&nbsp;values&nbsp;are&nbsp;single&nbsp;ASCII&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="2916925">//&nbsp;The&nbsp;array&nbsp;contains&nbsp;replacement&nbsp;bytes&nbsp;indexed&nbsp;by&nbsp;old&nbsp;byte.</span><br>
<span class="lineno"></span><span class="keyword" id="2916986">type</span>&nbsp;<span class="ident" id="2916991">byteReplacer</span>&nbsp;<span class="op" id="2917004">[</span><span class="num" id="2917005">256</span><span class="op" id="2917008">]</span><span class="builtintype" id="2917009">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="keyword" id="2917015">func</span>&nbsp;<span class="op" id="2917020">(</span><span class="ident" id="2917021">r</span>&nbsp;<span class="op" id="2917023">*</span><span class="ident" id="2917024">byteReplacer</span><span class="op" id="2917036">)</span>&nbsp;<span class="ident" id="2917038">Replace</span><span class="op" id="2917045">(</span><span class="ident" id="2917046">s</span>&nbsp;<span class="builtintype" id="2917048">string</span><span class="op" id="2917054">)</span>&nbsp;<span class="builtintype" id="2917056">string</span>&nbsp;<span class="op" id="2917063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2917066">var</span>&nbsp;<span class="ident" id="2917070">buf</span>&nbsp;<span class="op" id="2917074">[</span><span class="op" id="2917075">]</span><span class="builtintype" id="2917076">byte</span>&nbsp;<span class="comment" id="2917081">//&nbsp;lazily&nbsp;allocated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2917102">for</span>&nbsp;<span class="ident" id="2917106">i</span>&nbsp;<span class="op" id="2917108">:=</span>&nbsp;<span class="num" id="2917111">0</span><span class="op" id="2917112">;</span>&nbsp;<span class="ident" id="2917114">i</span>&nbsp;<span class="op" id="2917116">&lt;</span>&nbsp;<span class="builtinfunc" id="2917118">len</span><span class="op" id="2917121">(</span><span class="ident" id="2917122">s</span><span class="op" id="2917123">)</span><span class="op" id="2917124">;</span>&nbsp;<span class="ident" id="2917126">i</span><span class="op" id="2917127">++</span>&nbsp;<span class="op" id="2917130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2917134">b</span>&nbsp;<span class="op" id="2917136">:=</span>&nbsp;<span class="ident" id="2917139">s</span><span class="op" id="2917140">[</span><span class="ident" id="2917141">i</span><span class="op" id="2917142">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2917146">if</span>&nbsp;<span class="ident" id="2917149">r</span><span class="op" id="2917150">[</span><span class="ident" id="2917151">b</span><span class="op" id="2917152">]</span>&nbsp;<span class="op" id="2917154">!=</span>&nbsp;<span class="ident" id="2917157">b</span>&nbsp;<span class="op" id="2917159">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2917164">if</span>&nbsp;<span class="ident" id="2917167">buf</span>&nbsp;<span class="op" id="2917171">==</span>&nbsp;<span class="ident" id="2917174">nil</span>&nbsp;<span class="op" id="2917178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2917184">buf</span>&nbsp;<span class="op" id="2917188">=</span>&nbsp;<span class="op" id="2917190">[</span><span class="op" id="2917191">]</span><span class="builtintype" id="2917192">byte</span><span class="op" id="2917196">(</span><span class="ident" id="2917197">s</span><span class="op" id="2917198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2917203">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2917208">buf</span><span class="op" id="2917211">[</span><span class="ident" id="2917212">i</span><span class="op" id="2917213">]</span>&nbsp;<span class="op" id="2917215">=</span>&nbsp;<span class="ident" id="2917217">r</span><span class="op" id="2917218">[</span><span class="ident" id="2917219">b</span><span class="op" id="2917220">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2917224">}</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2917227">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2917230">if</span>&nbsp;<span class="ident" id="2917233">buf</span>&nbsp;<span class="op" id="2917237">==</span>&nbsp;<span class="ident" id="2917240">nil</span>&nbsp;<span class="op" id="2917244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2917248">return</span>&nbsp;<span class="ident" id="2917255">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2917258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2917261">return</span>&nbsp;<span class="builtintype" id="2917268">string</span><span class="op" id="2917274">(</span><span class="ident" id="2917275">buf</span><span class="op" id="2917278">)</span><br>
<span class="lineno">430</span><span class="op" id="2917280">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2917283">func</span>&nbsp;<span class="op" id="2917288">(</span><span class="ident" id="2917289">r</span>&nbsp;<span class="op" id="2917291">*</span><span class="ident" id="2917292">byteReplacer</span><span class="op" id="2917304">)</span>&nbsp;<span class="ident" id="2917306">WriteString</span><span class="op" id="2917317">(</span><span class="ident" id="2917318">w</span>&nbsp;<span class="ident" id="2917320">io</span><span class="op" id="2917322">.</span><span class="ident" id="2917323">Writer</span><span class="op" id="2917329">,</span>&nbsp;<span class="ident" id="2917331">s</span>&nbsp;<span class="builtintype" id="2917333">string</span><span class="op" id="2917339">)</span>&nbsp;<span class="op" id="2917341">(</span><span class="ident" id="2917342">n</span>&nbsp;<span class="builtintype" id="2917344">int</span><span class="op" id="2917347">,</span>&nbsp;<span class="ident" id="2917349">err</span>&nbsp;<span class="builtintype" id="2917353">error</span><span class="op" id="2917358">)</span>&nbsp;<span class="op" id="2917360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2917363">//&nbsp;TODO(bradfitz):&nbsp;use&nbsp;io.WriteString&nbsp;with&nbsp;slices&nbsp;of&nbsp;s,&nbsp;avoiding&nbsp;allocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2917441">bufsize</span>&nbsp;<span class="op" id="2917449">:=</span>&nbsp;<span class="num" id="2917452">32</span>&nbsp;<span class="op" id="2917455">&lt;&lt;</span>&nbsp;<span class="num" id="2917458">10</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2917462">if</span>&nbsp;<span class="builtinfunc" id="2917465">len</span><span class="op" id="2917468">(</span><span class="ident" id="2917469">s</span><span class="op" id="2917470">)</span>&nbsp;<span class="op" id="2917472">&lt;</span>&nbsp;<span class="ident" id="2917474">bufsize</span>&nbsp;<span class="op" id="2917482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2917486">bufsize</span>&nbsp;<span class="op" id="2917494">=</span>&nbsp;<span class="builtinfunc" id="2917496">len</span><span class="op" id="2917499">(</span><span class="ident" id="2917500">s</span><span class="op" id="2917501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2917504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2917507">buf</span>&nbsp;<span class="op" id="2917511">:=</span>&nbsp;<span class="builtinfunc" id="2917514">make</span><span class="op" id="2917518">(</span><span class="op" id="2917519">[</span><span class="op" id="2917520">]</span><span class="builtintype" id="2917521">byte</span><span class="op" id="2917525">,</span>&nbsp;<span class="ident" id="2917527">bufsize</span><span class="op" id="2917534">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2917538">for</span>&nbsp;<span class="builtinfunc" id="2917542">len</span><span class="op" id="2917545">(</span><span class="ident" id="2917546">s</span><span class="op" id="2917547">)</span>&nbsp;<span class="op" id="2917549">&gt;</span>&nbsp;<span class="num" id="2917551">0</span>&nbsp;<span class="op" id="2917553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2917557">ncopy</span>&nbsp;<span class="op" id="2917563">:=</span>&nbsp;<span class="builtinfunc" id="2917566">copy</span><span class="op" id="2917570">(</span><span class="ident" id="2917571">buf</span><span class="op" id="2917574">,</span>&nbsp;<span class="ident" id="2917576">s</span><span class="op" id="2917577">[</span><span class="op" id="2917578">:</span><span class="op" id="2917579">]</span><span class="op" id="2917580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2917584">s</span>&nbsp;<span class="op" id="2917586">=</span>&nbsp;<span class="ident" id="2917588">s</span><span class="op" id="2917589">[</span><span class="ident" id="2917590">ncopy</span><span class="op" id="2917595">:</span><span class="op" id="2917596">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2917600">for</span>&nbsp;<span class="ident" id="2917604">i</span><span class="op" id="2917605">,</span>&nbsp;<span class="ident" id="2917607">b</span>&nbsp;<span class="op" id="2917609">:=</span>&nbsp;<span class="keyword" id="2917612">range</span>&nbsp;<span class="ident" id="2917618">buf</span><span class="op" id="2917621">[</span><span class="op" id="2917622">:</span><span class="ident" id="2917623">ncopy</span><span class="op" id="2917628">]</span>&nbsp;<span class="op" id="2917630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2917635">buf</span><span class="op" id="2917638">[</span><span class="ident" id="2917639">i</span><span class="op" id="2917640">]</span>&nbsp;<span class="op" id="2917642">=</span>&nbsp;<span class="ident" id="2917644">r</span><span class="op" id="2917645">[</span><span class="ident" id="2917646">b</span><span class="op" id="2917647">]</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2917651">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2917655">wn</span><span class="op" id="2917657">,</span>&nbsp;<span class="ident" id="2917659">err</span>&nbsp;<span class="op" id="2917663">:=</span>&nbsp;<span class="ident" id="2917666">w</span><span class="op" id="2917667">.</span><span class="ident" id="2917668">Write</span><span class="op" id="2917673">(</span><span class="ident" id="2917674">buf</span><span class="op" id="2917677">[</span><span class="op" id="2917678">:</span><span class="ident" id="2917679">ncopy</span><span class="op" id="2917684">]</span><span class="op" id="2917685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2917689">n</span>&nbsp;<span class="op" id="2917691">+=</span>&nbsp;<span class="ident" id="2917694">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2917699">if</span>&nbsp;<span class="ident" id="2917702">err</span>&nbsp;<span class="op" id="2917706">!=</span>&nbsp;<span class="ident" id="2917709">nil</span>&nbsp;<span class="op" id="2917713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2917718">return</span>&nbsp;<span class="ident" id="2917725">n</span><span class="op" id="2917726">,</span>&nbsp;<span class="ident" id="2917728">err</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2917734">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2917737">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2917740">return</span>&nbsp;<span class="ident" id="2917747">n</span><span class="op" id="2917748">,</span>&nbsp;<span class="ident" id="2917750">nil</span><br>
<span class="lineno"></span><span class="op" id="2917754">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span><span class="comment" id="2917757">//&nbsp;byteStringReplacer&nbsp;is&nbsp;the&nbsp;implementation&nbsp;that&#39;s&nbsp;used&nbsp;when&nbsp;all&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2917826">//&nbsp;&#34;old&#34;&nbsp;values&nbsp;are&nbsp;single&nbsp;ASCII&nbsp;bytes&nbsp;but&nbsp;the&nbsp;&#34;new&#34;&nbsp;values&nbsp;vary&nbsp;in&nbsp;size.</span><br>
<span class="lineno"></span><span class="comment" id="2917900">//&nbsp;The&nbsp;array&nbsp;contains&nbsp;replacement&nbsp;byte&nbsp;slices&nbsp;indexed&nbsp;by&nbsp;old&nbsp;byte.</span><br>
<span class="lineno"></span><span class="comment" id="2917967">//&nbsp;A&nbsp;nil&nbsp;[]byte&nbsp;means&nbsp;that&nbsp;the&nbsp;old&nbsp;byte&nbsp;should&nbsp;not&nbsp;be&nbsp;replaced.</span><br>
<span class="lineno"></span><span class="keyword" id="2918031">type</span>&nbsp;<span class="ident" id="2918036">byteStringReplacer</span>&nbsp;<span class="op" id="2918055">[</span><span class="num" id="2918056">256</span><span class="op" id="2918059">]</span><span class="op" id="2918060">[</span><span class="op" id="2918061">]</span><span class="builtintype" id="2918062">byte</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span><span class="keyword" id="2918068">func</span>&nbsp;<span class="op" id="2918073">(</span><span class="ident" id="2918074">r</span>&nbsp;<span class="op" id="2918076">*</span><span class="ident" id="2918077">byteStringReplacer</span><span class="op" id="2918095">)</span>&nbsp;<span class="ident" id="2918097">Replace</span><span class="op" id="2918104">(</span><span class="ident" id="2918105">s</span>&nbsp;<span class="builtintype" id="2918107">string</span><span class="op" id="2918113">)</span>&nbsp;<span class="builtintype" id="2918115">string</span>&nbsp;<span class="op" id="2918122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2918125">newSize</span>&nbsp;<span class="op" id="2918133">:=</span>&nbsp;<span class="builtinfunc" id="2918136">len</span><span class="op" id="2918139">(</span><span class="ident" id="2918140">s</span><span class="op" id="2918141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2918144">anyChanges</span>&nbsp;<span class="op" id="2918155">:=</span>&nbsp;<span class="builtintype" id="2918158">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2918165">for</span>&nbsp;<span class="ident" id="2918169">i</span>&nbsp;<span class="op" id="2918171">:=</span>&nbsp;<span class="num" id="2918174">0</span><span class="op" id="2918175">;</span>&nbsp;<span class="ident" id="2918177">i</span>&nbsp;<span class="op" id="2918179">&lt;</span>&nbsp;<span class="builtinfunc" id="2918181">len</span><span class="op" id="2918184">(</span><span class="ident" id="2918185">s</span><span class="op" id="2918186">)</span><span class="op" id="2918187">;</span>&nbsp;<span class="ident" id="2918189">i</span><span class="op" id="2918190">++</span>&nbsp;<span class="op" id="2918193">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2918197">b</span>&nbsp;<span class="op" id="2918199">:=</span>&nbsp;<span class="ident" id="2918202">s</span><span class="op" id="2918203">[</span><span class="ident" id="2918204">i</span><span class="op" id="2918205">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2918209">if</span>&nbsp;<span class="ident" id="2918212">r</span><span class="op" id="2918213">[</span><span class="ident" id="2918214">b</span><span class="op" id="2918215">]</span>&nbsp;<span class="op" id="2918217">!=</span>&nbsp;<span class="ident" id="2918220">nil</span>&nbsp;<span class="op" id="2918224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2918229">anyChanges</span>&nbsp;<span class="op" id="2918240">=</span>&nbsp;<span class="builtintype" id="2918242">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2918250">//&nbsp;The&nbsp;-1&nbsp;is&nbsp;because&nbsp;we&nbsp;are&nbsp;replacing&nbsp;1&nbsp;byte&nbsp;with&nbsp;len(r[b])&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2918320">newSize</span>&nbsp;<span class="op" id="2918328">+=</span>&nbsp;<span class="builtinfunc" id="2918331">len</span><span class="op" id="2918334">(</span><span class="ident" id="2918335">r</span><span class="op" id="2918336">[</span><span class="ident" id="2918337">b</span><span class="op" id="2918338">]</span><span class="op" id="2918339">)</span>&nbsp;<span class="op" id="2918341">-</span>&nbsp;<span class="num" id="2918343">1</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2918347">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2918350">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2918353">if</span>&nbsp;<span class="op" id="2918356">!</span><span class="ident" id="2918357">anyChanges</span>&nbsp;<span class="op" id="2918368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2918372">return</span>&nbsp;<span class="ident" id="2918379">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2918382">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2918385">buf</span>&nbsp;<span class="op" id="2918389">:=</span>&nbsp;<span class="builtinfunc" id="2918392">make</span><span class="op" id="2918396">(</span><span class="op" id="2918397">[</span><span class="op" id="2918398">]</span><span class="builtintype" id="2918399">byte</span><span class="op" id="2918403">,</span>&nbsp;<span class="ident" id="2918405">newSize</span><span class="op" id="2918412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2918415">bi</span>&nbsp;<span class="op" id="2918418">:=</span>&nbsp;<span class="ident" id="2918421">buf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2918426">for</span>&nbsp;<span class="ident" id="2918430">i</span>&nbsp;<span class="op" id="2918432">:=</span>&nbsp;<span class="num" id="2918435">0</span><span class="op" id="2918436">;</span>&nbsp;<span class="ident" id="2918438">i</span>&nbsp;<span class="op" id="2918440">&lt;</span>&nbsp;<span class="builtinfunc" id="2918442">len</span><span class="op" id="2918445">(</span><span class="ident" id="2918446">s</span><span class="op" id="2918447">)</span><span class="op" id="2918448">;</span>&nbsp;<span class="ident" id="2918450">i</span><span class="op" id="2918451">++</span>&nbsp;<span class="op" id="2918454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2918458">b</span>&nbsp;<span class="op" id="2918460">:=</span>&nbsp;<span class="ident" id="2918463">s</span><span class="op" id="2918464">[</span><span class="ident" id="2918465">i</span><span class="op" id="2918466">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2918470">if</span>&nbsp;<span class="ident" id="2918473">r</span><span class="op" id="2918474">[</span><span class="ident" id="2918475">b</span><span class="op" id="2918476">]</span>&nbsp;<span class="op" id="2918478">!=</span>&nbsp;<span class="ident" id="2918481">nil</span>&nbsp;<span class="op" id="2918485">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2918490">n</span>&nbsp;<span class="op" id="2918492">:=</span>&nbsp;<span class="builtinfunc" id="2918495">copy</span><span class="op" id="2918499">(</span><span class="ident" id="2918500">bi</span><span class="op" id="2918502">,</span>&nbsp;<span class="ident" id="2918504">r</span><span class="op" id="2918505">[</span><span class="ident" id="2918506">b</span><span class="op" id="2918507">]</span><span class="op" id="2918508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2918513">bi</span>&nbsp;<span class="op" id="2918516">=</span>&nbsp;<span class="ident" id="2918518">bi</span><span class="op" id="2918520">[</span><span class="ident" id="2918521">n</span><span class="op" id="2918522">:</span><span class="op" id="2918523">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2918527">}</span>&nbsp;<span class="keyword" id="2918529">else</span>&nbsp;<span class="op" id="2918534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2918539">bi</span><span class="op" id="2918541">[</span><span class="num" id="2918542">0</span><span class="op" id="2918543">]</span>&nbsp;<span class="op" id="2918545">=</span>&nbsp;<span class="ident" id="2918547">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2918552">bi</span>&nbsp;<span class="op" id="2918555">=</span>&nbsp;<span class="ident" id="2918557">bi</span><span class="op" id="2918559">[</span><span class="num" id="2918560">1</span><span class="op" id="2918561">:</span><span class="op" id="2918562">]</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2918566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2918569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2918572">return</span>&nbsp;<span class="builtintype" id="2918579">string</span><span class="op" id="2918585">(</span><span class="ident" id="2918586">buf</span><span class="op" id="2918589">)</span><br>
<span class="lineno"></span><span class="op" id="2918591">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">490</span><span class="keyword" id="2918594">func</span>&nbsp;<span class="op" id="2918599">(</span><span class="ident" id="2918600">r</span>&nbsp;<span class="op" id="2918602">*</span><span class="ident" id="2918603">byteStringReplacer</span><span class="op" id="2918621">)</span>&nbsp;<span class="ident" id="2918623">WriteString</span><span class="op" id="2918634">(</span><span class="ident" id="2918635">w</span>&nbsp;<span class="ident" id="2918637">io</span><span class="op" id="2918639">.</span><span class="ident" id="2918640">Writer</span><span class="op" id="2918646">,</span>&nbsp;<span class="ident" id="2918648">s</span>&nbsp;<span class="builtintype" id="2918650">string</span><span class="op" id="2918656">)</span>&nbsp;<span class="op" id="2918658">(</span><span class="ident" id="2918659">n</span>&nbsp;<span class="builtintype" id="2918661">int</span><span class="op" id="2918664">,</span>&nbsp;<span class="ident" id="2918666">err</span>&nbsp;<span class="builtintype" id="2918670">error</span><span class="op" id="2918675">)</span>&nbsp;<span class="op" id="2918677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2918680">sw</span>&nbsp;<span class="op" id="2918683">:=</span>&nbsp;<span class="ident" id="2918686">getStringWriter</span><span class="op" id="2918701">(</span><span class="ident" id="2918702">w</span><span class="op" id="2918703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2918706">last</span>&nbsp;<span class="op" id="2918711">:=</span>&nbsp;<span class="num" id="2918714">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2918717">for</span>&nbsp;<span class="ident" id="2918721">i</span>&nbsp;<span class="op" id="2918723">:=</span>&nbsp;<span class="num" id="2918726">0</span><span class="op" id="2918727">;</span>&nbsp;<span class="ident" id="2918729">i</span>&nbsp;<span class="op" id="2918731">&lt;</span>&nbsp;<span class="builtinfunc" id="2918733">len</span><span class="op" id="2918736">(</span><span class="ident" id="2918737">s</span><span class="op" id="2918738">)</span><span class="op" id="2918739">;</span>&nbsp;<span class="ident" id="2918741">i</span><span class="op" id="2918742">++</span>&nbsp;<span class="op" id="2918745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2918749">b</span>&nbsp;<span class="op" id="2918751">:=</span>&nbsp;<span class="ident" id="2918754">s</span><span class="op" id="2918755">[</span><span class="ident" id="2918756">i</span><span class="op" id="2918757">]</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2918761">if</span>&nbsp;<span class="ident" id="2918764">r</span><span class="op" id="2918765">[</span><span class="ident" id="2918766">b</span><span class="op" id="2918767">]</span>&nbsp;<span class="op" id="2918769">==</span>&nbsp;<span class="ident" id="2918772">nil</span>&nbsp;<span class="op" id="2918776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2918781">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2918792">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2918796">if</span>&nbsp;<span class="ident" id="2918799">last</span>&nbsp;<span class="op" id="2918804">!=</span>&nbsp;<span class="ident" id="2918807">i</span>&nbsp;<span class="op" id="2918809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2918814">nw</span><span class="op" id="2918816">,</span>&nbsp;<span class="ident" id="2918818">err</span>&nbsp;<span class="op" id="2918822">:=</span>&nbsp;<span class="ident" id="2918825">sw</span><span class="op" id="2918827">.</span><span class="ident" id="2918828">WriteString</span><span class="op" id="2918839">(</span><span class="ident" id="2918840">s</span><span class="op" id="2918841">[</span><span class="ident" id="2918842">last</span><span class="op" id="2918846">:</span><span class="ident" id="2918847">i</span><span class="op" id="2918848">]</span><span class="op" id="2918849">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2918854">n</span>&nbsp;<span class="op" id="2918856">+=</span>&nbsp;<span class="ident" id="2918859">nw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2918865">if</span>&nbsp;<span class="ident" id="2918868">err</span>&nbsp;<span class="op" id="2918872">!=</span>&nbsp;<span class="ident" id="2918875">nil</span>&nbsp;<span class="op" id="2918879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2918885">return</span>&nbsp;<span class="ident" id="2918892">n</span><span class="op" id="2918893">,</span>&nbsp;<span class="ident" id="2918895">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2918902">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2918906">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2918910">last</span>&nbsp;<span class="op" id="2918915">=</span>&nbsp;<span class="ident" id="2918917">i</span>&nbsp;<span class="op" id="2918919">+</span>&nbsp;<span class="num" id="2918921">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2918925">nw</span><span class="op" id="2918927">,</span>&nbsp;<span class="ident" id="2918929">err</span>&nbsp;<span class="op" id="2918933">:=</span>&nbsp;<span class="ident" id="2918936">w</span><span class="op" id="2918937">.</span><span class="ident" id="2918938">Write</span><span class="op" id="2918943">(</span><span class="ident" id="2918944">r</span><span class="op" id="2918945">[</span><span class="ident" id="2918946">b</span><span class="op" id="2918947">]</span><span class="op" id="2918948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2918952">n</span>&nbsp;<span class="op" id="2918954">+=</span>&nbsp;<span class="ident" id="2918957">nw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2918962">if</span>&nbsp;<span class="ident" id="2918965">err</span>&nbsp;<span class="op" id="2918969">!=</span>&nbsp;<span class="ident" id="2918972">nil</span>&nbsp;<span class="op" id="2918976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2918981">return</span>&nbsp;<span class="ident" id="2918988">n</span><span class="op" id="2918989">,</span>&nbsp;<span class="ident" id="2918991">err</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2918997">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2919000">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2919003">if</span>&nbsp;<span class="ident" id="2919006">last</span>&nbsp;<span class="op" id="2919011">!=</span>&nbsp;<span class="builtinfunc" id="2919014">len</span><span class="op" id="2919017">(</span><span class="ident" id="2919018">s</span><span class="op" id="2919019">)</span>&nbsp;<span class="op" id="2919021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2919025">var</span>&nbsp;<span class="ident" id="2919029">nw</span>&nbsp;<span class="builtintype" id="2919032">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2919038">nw</span><span class="op" id="2919040">,</span>&nbsp;<span class="ident" id="2919042">err</span>&nbsp;<span class="op" id="2919046">=</span>&nbsp;<span class="ident" id="2919048">sw</span><span class="op" id="2919050">.</span><span class="ident" id="2919051">WriteString</span><span class="op" id="2919062">(</span><span class="ident" id="2919063">s</span><span class="op" id="2919064">[</span><span class="ident" id="2919065">last</span><span class="op" id="2919069">:</span><span class="op" id="2919070">]</span><span class="op" id="2919071">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2919075">n</span>&nbsp;<span class="op" id="2919077">+=</span>&nbsp;<span class="ident" id="2919080">nw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2919084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2919087">return</span><br>
<span class="lineno"></span><span class="op" id="2919094">}</span>
</div>
</body>
</html>
