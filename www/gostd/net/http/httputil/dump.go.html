<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html" class="current">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3807406">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3807461">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3807515">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3807566">package</span>&nbsp;<span class="ident" id="3807574">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3807584">import</span>&nbsp;<span class="op" id="3807591">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3807594">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3807603">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3807612">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3807622">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3807629">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3807635">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3807648">&#34;net&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3807655">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3807667">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3807678">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3807689">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3807696">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="3807699">//&nbsp;One&nbsp;of&nbsp;the&nbsp;copies,&nbsp;say&nbsp;from&nbsp;b&nbsp;to&nbsp;r2,&nbsp;could&nbsp;be&nbsp;avoided&nbsp;by&nbsp;using&nbsp;a&nbsp;more</span><br>
<span class="lineno"></span><span class="comment" id="3807772">//&nbsp;elaborate&nbsp;trick&nbsp;where&nbsp;the&nbsp;other&nbsp;copy&nbsp;is&nbsp;made&nbsp;during&nbsp;Request/Response.Write.</span><br>
<span class="lineno"></span><span class="comment" id="3807851">//&nbsp;This&nbsp;would&nbsp;complicate&nbsp;things&nbsp;too&nbsp;much,&nbsp;given&nbsp;that&nbsp;these&nbsp;functions&nbsp;are&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3807928">//&nbsp;debugging&nbsp;only.</span><br>
<span class="lineno">25</span><span class="keyword" id="3807947">func</span>&nbsp;<span class="ident" id="3807952">drainBody</span><span class="op" id="3807961">(</span><span class="ident" id="3807962">b</span>&nbsp;<span class="ident" id="3807964">io</span><span class="op" id="3807966">.</span><span class="ident" id="3807967">ReadCloser</span><span class="op" id="3807977">)</span>&nbsp;<span class="op" id="3807979">(</span><span class="ident" id="3807980">r1</span><span class="op" id="3807982">,</span>&nbsp;<span class="ident" id="3807984">r2</span>&nbsp;<span class="ident" id="3807987">io</span><span class="op" id="3807989">.</span><span class="ident" id="3807990">ReadCloser</span><span class="op" id="3808000">,</span>&nbsp;<span class="ident" id="3808002">err</span>&nbsp;<span class="builtintype" id="3808006">error</span><span class="op" id="3808011">)</span>&nbsp;<span class="op" id="3808013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3808016">var</span>&nbsp;<span class="ident" id="3808020">buf</span>&nbsp;<span class="ident" id="3808024">bytes</span><span class="op" id="3808029">.</span><span class="ident" id="3808030">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3808038">if</span>&nbsp;<span class="ident" id="3808041">_</span><span class="op" id="3808042">,</span>&nbsp;<span class="ident" id="3808044">err</span>&nbsp;<span class="op" id="3808048">=</span>&nbsp;<span class="ident" id="3808050">buf</span><span class="op" id="3808053">.</span><span class="ident" id="3808054">ReadFrom</span><span class="op" id="3808062">(</span><span class="ident" id="3808063">b</span><span class="op" id="3808064">)</span><span class="op" id="3808065">;</span>&nbsp;<span class="ident" id="3808067">err</span>&nbsp;<span class="op" id="3808071">!=</span>&nbsp;<span class="builtintype" id="3808074">nil</span>&nbsp;<span class="op" id="3808078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3808082">return</span>&nbsp;<span class="builtintype" id="3808089">nil</span><span class="op" id="3808092">,</span>&nbsp;<span class="builtintype" id="3808094">nil</span><span class="op" id="3808097">,</span>&nbsp;<span class="ident" id="3808099">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3808104">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3808107">if</span>&nbsp;<span class="ident" id="3808110">err</span>&nbsp;<span class="op" id="3808114">=</span>&nbsp;<span class="ident" id="3808116">b</span><span class="op" id="3808117">.</span><span class="ident" id="3808118">Close</span><span class="op" id="3808123">(</span><span class="op" id="3808124">)</span><span class="op" id="3808125">;</span>&nbsp;<span class="ident" id="3808127">err</span>&nbsp;<span class="op" id="3808131">!=</span>&nbsp;<span class="builtintype" id="3808134">nil</span>&nbsp;<span class="op" id="3808138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3808142">return</span>&nbsp;<span class="builtintype" id="3808149">nil</span><span class="op" id="3808152">,</span>&nbsp;<span class="builtintype" id="3808154">nil</span><span class="op" id="3808157">,</span>&nbsp;<span class="ident" id="3808159">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3808164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3808167">return</span>&nbsp;<span class="ident" id="3808174">ioutil</span><span class="op" id="3808180">.</span><span class="ident" id="3808181">NopCloser</span><span class="op" id="3808190">(</span><span class="op" id="3808191">&amp;</span><span class="ident" id="3808192">buf</span><span class="op" id="3808195">)</span><span class="op" id="3808196">,</span>&nbsp;<span class="ident" id="3808198">ioutil</span><span class="op" id="3808204">.</span><span class="ident" id="3808205">NopCloser</span><span class="op" id="3808214">(</span><span class="ident" id="3808215">bytes</span><span class="op" id="3808220">.</span><span class="ident" id="3808221">NewReader</span><span class="op" id="3808230">(</span><span class="ident" id="3808231">buf</span><span class="op" id="3808234">.</span><span class="ident" id="3808235">Bytes</span><span class="op" id="3808240">(</span><span class="op" id="3808241">)</span><span class="op" id="3808242">)</span><span class="op" id="3808243">)</span><span class="op" id="3808244">,</span>&nbsp;<span class="builtintype" id="3808246">nil</span><br>
<span class="lineno"></span><span class="op" id="3808250">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="3808253">//&nbsp;dumpConn&nbsp;is&nbsp;a&nbsp;net.Conn&nbsp;which&nbsp;writes&nbsp;to&nbsp;Writer&nbsp;and&nbsp;reads&nbsp;from&nbsp;Reader</span><br>
<span class="lineno"></span><span class="keyword" id="3808324">type</span>&nbsp;<span class="ident" id="3808329">dumpConn</span>&nbsp;<span class="keyword" id="3808338">struct</span>&nbsp;<span class="op" id="3808345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3808348">io</span><span class="op" id="3808350">.</span><span class="ident" id="3808351">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3808359">io</span><span class="op" id="3808361">.</span><span class="ident" id="3808362">Reader</span><br>
<span class="lineno">40</span><span class="op" id="3808369">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3808372">func</span>&nbsp;<span class="op" id="3808377">(</span><span class="ident" id="3808378">c</span>&nbsp;<span class="op" id="3808380">*</span><span class="ident" id="3808381">dumpConn</span><span class="op" id="3808389">)</span>&nbsp;<span class="ident" id="3808391">Close</span><span class="op" id="3808396">(</span><span class="op" id="3808397">)</span>&nbsp;<span class="builtintype" id="3808399">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3808427">{</span>&nbsp;<span class="keyword" id="3808429">return</span>&nbsp;<span class="builtintype" id="3808436">nil</span>&nbsp;<span class="op" id="3808440">}</span><br>
<span class="lineno"></span><span class="keyword" id="3808442">func</span>&nbsp;<span class="op" id="3808447">(</span><span class="ident" id="3808448">c</span>&nbsp;<span class="op" id="3808450">*</span><span class="ident" id="3808451">dumpConn</span><span class="op" id="3808459">)</span>&nbsp;<span class="ident" id="3808461">LocalAddr</span><span class="op" id="3808470">(</span><span class="op" id="3808471">)</span>&nbsp;<span class="ident" id="3808473">net</span><span class="op" id="3808476">.</span><span class="ident" id="3808477">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3808497">{</span>&nbsp;<span class="keyword" id="3808499">return</span>&nbsp;<span class="builtintype" id="3808506">nil</span>&nbsp;<span class="op" id="3808510">}</span><br>
<span class="lineno"></span><span class="keyword" id="3808512">func</span>&nbsp;<span class="op" id="3808517">(</span><span class="ident" id="3808518">c</span>&nbsp;<span class="op" id="3808520">*</span><span class="ident" id="3808521">dumpConn</span><span class="op" id="3808529">)</span>&nbsp;<span class="ident" id="3808531">RemoteAddr</span><span class="op" id="3808541">(</span><span class="op" id="3808542">)</span>&nbsp;<span class="ident" id="3808544">net</span><span class="op" id="3808547">.</span><span class="ident" id="3808548">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3808567">{</span>&nbsp;<span class="keyword" id="3808569">return</span>&nbsp;<span class="builtintype" id="3808576">nil</span>&nbsp;<span class="op" id="3808580">}</span><br>
<span class="lineno">45</span><span class="keyword" id="3808582">func</span>&nbsp;<span class="op" id="3808587">(</span><span class="ident" id="3808588">c</span>&nbsp;<span class="op" id="3808590">*</span><span class="ident" id="3808591">dumpConn</span><span class="op" id="3808599">)</span>&nbsp;<span class="ident" id="3808601">SetDeadline</span><span class="op" id="3808612">(</span><span class="ident" id="3808613">t</span>&nbsp;<span class="ident" id="3808615">time</span><span class="op" id="3808619">.</span><span class="ident" id="3808620">Time</span><span class="op" id="3808624">)</span>&nbsp;<span class="builtintype" id="3808626">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3808637">{</span>&nbsp;<span class="keyword" id="3808639">return</span>&nbsp;<span class="builtintype" id="3808646">nil</span>&nbsp;<span class="op" id="3808650">}</span><br>
<span class="lineno"></span><span class="keyword" id="3808652">func</span>&nbsp;<span class="op" id="3808657">(</span><span class="ident" id="3808658">c</span>&nbsp;<span class="op" id="3808660">*</span><span class="ident" id="3808661">dumpConn</span><span class="op" id="3808669">)</span>&nbsp;<span class="ident" id="3808671">SetReadDeadline</span><span class="op" id="3808686">(</span><span class="ident" id="3808687">t</span>&nbsp;<span class="ident" id="3808689">time</span><span class="op" id="3808693">.</span><span class="ident" id="3808694">Time</span><span class="op" id="3808698">)</span>&nbsp;<span class="builtintype" id="3808700">error</span>&nbsp;&nbsp;<span class="op" id="3808707">{</span>&nbsp;<span class="keyword" id="3808709">return</span>&nbsp;<span class="builtintype" id="3808716">nil</span>&nbsp;<span class="op" id="3808720">}</span><br>
<span class="lineno"></span><span class="keyword" id="3808722">func</span>&nbsp;<span class="op" id="3808727">(</span><span class="ident" id="3808728">c</span>&nbsp;<span class="op" id="3808730">*</span><span class="ident" id="3808731">dumpConn</span><span class="op" id="3808739">)</span>&nbsp;<span class="ident" id="3808741">SetWriteDeadline</span><span class="op" id="3808757">(</span><span class="ident" id="3808758">t</span>&nbsp;<span class="ident" id="3808760">time</span><span class="op" id="3808764">.</span><span class="ident" id="3808765">Time</span><span class="op" id="3808769">)</span>&nbsp;<span class="builtintype" id="3808771">error</span>&nbsp;<span class="op" id="3808777">{</span>&nbsp;<span class="keyword" id="3808779">return</span>&nbsp;<span class="builtintype" id="3808786">nil</span>&nbsp;<span class="op" id="3808790">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3808793">type</span>&nbsp;<span class="ident" id="3808798">neverEnding</span>&nbsp;<span class="builtintype" id="3808810">byte</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="3808816">func</span>&nbsp;<span class="op" id="3808821">(</span><span class="ident" id="3808822">b</span>&nbsp;<span class="ident" id="3808824">neverEnding</span><span class="op" id="3808835">)</span>&nbsp;<span class="ident" id="3808837">Read</span><span class="op" id="3808841">(</span><span class="ident" id="3808842">p</span>&nbsp;<span class="op" id="3808844">[</span><span class="op" id="3808845">]</span><span class="builtintype" id="3808846">byte</span><span class="op" id="3808850">)</span>&nbsp;<span class="op" id="3808852">(</span><span class="ident" id="3808853">n</span>&nbsp;<span class="builtintype" id="3808855">int</span><span class="op" id="3808858">,</span>&nbsp;<span class="ident" id="3808860">err</span>&nbsp;<span class="builtintype" id="3808864">error</span><span class="op" id="3808869">)</span>&nbsp;<span class="op" id="3808871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3808874">for</span>&nbsp;<span class="ident" id="3808878">i</span>&nbsp;<span class="op" id="3808880">:=</span>&nbsp;<span class="keyword" id="3808883">range</span>&nbsp;<span class="ident" id="3808889">p</span>&nbsp;<span class="op" id="3808891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3808895">p</span><span class="op" id="3808896">[</span><span class="ident" id="3808897">i</span><span class="op" id="3808898">]</span>&nbsp;<span class="op" id="3808900">=</span>&nbsp;<span class="builtintype" id="3808902">byte</span><span class="op" id="3808906">(</span><span class="ident" id="3808907">b</span><span class="op" id="3808908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3808911">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3808914">return</span>&nbsp;<span class="builtinfunc" id="3808921">len</span><span class="op" id="3808924">(</span><span class="ident" id="3808925">p</span><span class="op" id="3808926">)</span><span class="op" id="3808927">,</span>&nbsp;<span class="builtintype" id="3808929">nil</span><br>
<span class="lineno"></span><span class="op" id="3808933">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3808936">//&nbsp;DumpRequestOut&nbsp;is&nbsp;like&nbsp;DumpRequest&nbsp;but&nbsp;includes</span><br>
<span class="lineno"></span><span class="comment" id="3808987">//&nbsp;headers&nbsp;that&nbsp;the&nbsp;standard&nbsp;http.Transport&nbsp;adds,</span><br>
<span class="lineno">60</span><span class="comment" id="3809037">//&nbsp;such&nbsp;as&nbsp;User-Agent.</span><br>
<span class="lineno"></span><span class="keyword" id="3809060">func</span>&nbsp;<span class="ident" id="3809065">DumpRequestOut</span><span class="op" id="3809079">(</span><span class="ident" id="3809080">req</span>&nbsp;<span class="op" id="3809084">*</span><span class="ident" id="3809085">http</span><span class="op" id="3809089">.</span><span class="ident" id="3809090">Request</span><span class="op" id="3809097">,</span>&nbsp;<span class="ident" id="3809099">body</span>&nbsp;<span class="builtintype" id="3809104">bool</span><span class="op" id="3809108">)</span>&nbsp;<span class="op" id="3809110">(</span><span class="op" id="3809111">[</span><span class="op" id="3809112">]</span><span class="builtintype" id="3809113">byte</span><span class="op" id="3809117">,</span>&nbsp;<span class="builtintype" id="3809119">error</span><span class="op" id="3809124">)</span>&nbsp;<span class="op" id="3809126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3809129">save</span>&nbsp;<span class="op" id="3809134">:=</span>&nbsp;<span class="ident" id="3809137">req</span><span class="op" id="3809140">.</span><span class="ident" id="3809141">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3809147">dummyBody</span>&nbsp;<span class="op" id="3809157">:=</span>&nbsp;<span class="builtintype" id="3809160">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3809167">if</span>&nbsp;<span class="op" id="3809170">!</span><span class="ident" id="3809171">body</span>&nbsp;<span class="op" id="3809176">||</span>&nbsp;<span class="ident" id="3809179">req</span><span class="op" id="3809182">.</span><span class="ident" id="3809183">Body</span>&nbsp;<span class="op" id="3809188">==</span>&nbsp;<span class="builtintype" id="3809191">nil</span>&nbsp;<span class="op" id="3809195">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3809199">req</span><span class="op" id="3809202">.</span><span class="ident" id="3809203">Body</span>&nbsp;<span class="op" id="3809208">=</span>&nbsp;<span class="builtintype" id="3809210">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3809216">if</span>&nbsp;<span class="ident" id="3809219">req</span><span class="op" id="3809222">.</span><span class="ident" id="3809223">ContentLength</span>&nbsp;<span class="op" id="3809237">!=</span>&nbsp;<span class="num" id="3809240">0</span>&nbsp;<span class="op" id="3809242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3809247">req</span><span class="op" id="3809250">.</span><span class="ident" id="3809251">Body</span>&nbsp;<span class="op" id="3809256">=</span>&nbsp;<span class="ident" id="3809258">ioutil</span><span class="op" id="3809264">.</span><span class="ident" id="3809265">NopCloser</span><span class="op" id="3809274">(</span><span class="ident" id="3809275">io</span><span class="op" id="3809277">.</span><span class="ident" id="3809278">LimitReader</span><span class="op" id="3809289">(</span><span class="ident" id="3809290">neverEnding</span><span class="op" id="3809301">(</span><span class="string" id="3809302">&#39;x&#39;</span><span class="op" id="3809305">)</span><span class="op" id="3809306">,</span>&nbsp;<span class="ident" id="3809308">req</span><span class="op" id="3809311">.</span><span class="ident" id="3809312">ContentLength</span><span class="op" id="3809325">)</span><span class="op" id="3809326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3809331">dummyBody</span>&nbsp;<span class="op" id="3809341">=</span>&nbsp;<span class="builtintype" id="3809343">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3809350">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3809353">}</span>&nbsp;<span class="keyword" id="3809355">else</span>&nbsp;<span class="op" id="3809360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3809364">var</span>&nbsp;<span class="ident" id="3809368">err</span>&nbsp;<span class="builtintype" id="3809372">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3809380">save</span><span class="op" id="3809384">,</span>&nbsp;<span class="ident" id="3809386">req</span><span class="op" id="3809389">.</span><span class="ident" id="3809390">Body</span><span class="op" id="3809394">,</span>&nbsp;<span class="ident" id="3809396">err</span>&nbsp;<span class="op" id="3809400">=</span>&nbsp;<span class="ident" id="3809402">drainBody</span><span class="op" id="3809411">(</span><span class="ident" id="3809412">req</span><span class="op" id="3809415">.</span><span class="ident" id="3809416">Body</span><span class="op" id="3809420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3809424">if</span>&nbsp;<span class="ident" id="3809427">err</span>&nbsp;<span class="op" id="3809431">!=</span>&nbsp;<span class="builtintype" id="3809434">nil</span>&nbsp;<span class="op" id="3809438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3809443">return</span>&nbsp;<span class="builtintype" id="3809450">nil</span><span class="op" id="3809453">,</span>&nbsp;<span class="ident" id="3809455">err</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3809461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3809464">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3809468">//&nbsp;Since&nbsp;we&#39;re&nbsp;using&nbsp;the&nbsp;actual&nbsp;Transport&nbsp;code&nbsp;to&nbsp;write&nbsp;the&nbsp;request,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3809538">//&nbsp;switch&nbsp;to&nbsp;http&nbsp;so&nbsp;the&nbsp;Transport&nbsp;doesn&#39;t&nbsp;try&nbsp;to&nbsp;do&nbsp;an&nbsp;SSL</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3809599">//&nbsp;negotiation&nbsp;with&nbsp;our&nbsp;dumpConn&nbsp;and&nbsp;its&nbsp;bytes.Buffer&nbsp;&amp;&nbsp;pipe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3809662">//&nbsp;The&nbsp;wire&nbsp;format&nbsp;for&nbsp;https&nbsp;and&nbsp;http&nbsp;are&nbsp;the&nbsp;same,&nbsp;anyway.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3809723">reqSend</span>&nbsp;<span class="op" id="3809731">:=</span>&nbsp;<span class="ident" id="3809734">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3809739">if</span>&nbsp;<span class="ident" id="3809742">req</span><span class="op" id="3809745">.</span><span class="ident" id="3809746">URL</span><span class="op" id="3809749">.</span><span class="ident" id="3809750">Scheme</span>&nbsp;<span class="op" id="3809757">==</span>&nbsp;<span class="string" id="3809760">&#34;https&#34;</span>&nbsp;<span class="op" id="3809768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3809772">reqSend</span>&nbsp;<span class="op" id="3809780">=</span>&nbsp;<span class="builtinfunc" id="3809782">new</span><span class="op" id="3809785">(</span><span class="ident" id="3809786">http</span><span class="op" id="3809790">.</span><span class="ident" id="3809791">Request</span><span class="op" id="3809798">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3809802">*</span><span class="ident" id="3809803">reqSend</span>&nbsp;<span class="op" id="3809811">=</span>&nbsp;<span class="op" id="3809813">*</span><span class="ident" id="3809814">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3809820">reqSend</span><span class="op" id="3809827">.</span><span class="ident" id="3809828">URL</span>&nbsp;<span class="op" id="3809832">=</span>&nbsp;<span class="builtinfunc" id="3809834">new</span><span class="op" id="3809837">(</span><span class="ident" id="3809838">url</span><span class="op" id="3809841">.</span><span class="ident" id="3809842">URL</span><span class="op" id="3809845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3809849">*</span><span class="ident" id="3809850">reqSend</span><span class="op" id="3809857">.</span><span class="ident" id="3809858">URL</span>&nbsp;<span class="op" id="3809862">=</span>&nbsp;<span class="op" id="3809864">*</span><span class="ident" id="3809865">req</span><span class="op" id="3809868">.</span><span class="ident" id="3809869">URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3809875">reqSend</span><span class="op" id="3809882">.</span><span class="ident" id="3809883">URL</span><span class="op" id="3809886">.</span><span class="ident" id="3809887">Scheme</span>&nbsp;<span class="op" id="3809894">=</span>&nbsp;<span class="string" id="3809896">&#34;http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3809904">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3809908">//&nbsp;Use&nbsp;the&nbsp;actual&nbsp;Transport&nbsp;code&nbsp;to&nbsp;record&nbsp;what&nbsp;we&nbsp;would&nbsp;send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3809971">//&nbsp;on&nbsp;the&nbsp;wire,&nbsp;but&nbsp;not&nbsp;using&nbsp;TCP.&nbsp;&nbsp;Use&nbsp;a&nbsp;Transport&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3810031">//&nbsp;custom&nbsp;dialer&nbsp;that&nbsp;returns&nbsp;a&nbsp;fake&nbsp;net.Conn&nbsp;that&nbsp;waits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3810089">//&nbsp;for&nbsp;the&nbsp;full&nbsp;input&nbsp;(and&nbsp;recording&nbsp;it),&nbsp;and&nbsp;then&nbsp;responds</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3810150">//&nbsp;with&nbsp;a&nbsp;dummy&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3810177">var</span>&nbsp;<span class="ident" id="3810181">buf</span>&nbsp;<span class="ident" id="3810185">bytes</span><span class="op" id="3810190">.</span><span class="ident" id="3810191">Buffer</span>&nbsp;<span class="comment" id="3810198">//&nbsp;records&nbsp;the&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3810221">pr</span><span class="op" id="3810223">,</span>&nbsp;<span class="ident" id="3810225">pw</span>&nbsp;<span class="op" id="3810228">:=</span>&nbsp;<span class="ident" id="3810231">io</span><span class="op" id="3810233">.</span><span class="ident" id="3810234">Pipe</span><span class="op" id="3810238">(</span><span class="op" id="3810239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3810242">defer</span>&nbsp;<span class="ident" id="3810248">pr</span><span class="op" id="3810250">.</span><span class="ident" id="3810251">Close</span><span class="op" id="3810256">(</span><span class="op" id="3810257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3810260">defer</span>&nbsp;<span class="ident" id="3810266">pw</span><span class="op" id="3810268">.</span><span class="ident" id="3810269">Close</span><span class="op" id="3810274">(</span><span class="op" id="3810275">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3810278">dr</span>&nbsp;<span class="op" id="3810281">:=</span>&nbsp;<span class="op" id="3810284">&amp;</span><span class="ident" id="3810285">delegateReader</span><span class="op" id="3810299">{</span><span class="ident" id="3810300">c</span><span class="op" id="3810301">:</span>&nbsp;<span class="builtinfunc" id="3810303">make</span><span class="op" id="3810307">(</span><span class="keyword" id="3810308">chan</span>&nbsp;<span class="ident" id="3810313">io</span><span class="op" id="3810315">.</span><span class="ident" id="3810316">Reader</span><span class="op" id="3810322">)</span><span class="op" id="3810323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3810326">//&nbsp;Wait&nbsp;for&nbsp;the&nbsp;request&nbsp;before&nbsp;replying&nbsp;with&nbsp;a&nbsp;dummy&nbsp;response:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3810390">go</span>&nbsp;<span class="keyword" id="3810393">func</span><span class="op" id="3810397">(</span><span class="op" id="3810398">)</span>&nbsp;<span class="op" id="3810400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3810404">req</span><span class="op" id="3810407">,</span>&nbsp;<span class="ident" id="3810409">err</span>&nbsp;<span class="op" id="3810413">:=</span>&nbsp;<span class="ident" id="3810416">http</span><span class="op" id="3810420">.</span><span class="ident" id="3810421">ReadRequest</span><span class="op" id="3810432">(</span><span class="ident" id="3810433">bufio</span><span class="op" id="3810438">.</span><span class="ident" id="3810439">NewReader</span><span class="op" id="3810448">(</span><span class="ident" id="3810449">pr</span><span class="op" id="3810451">)</span><span class="op" id="3810452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3810456">if</span>&nbsp;<span class="ident" id="3810459">err</span>&nbsp;<span class="op" id="3810463">==</span>&nbsp;<span class="builtintype" id="3810466">nil</span>&nbsp;<span class="op" id="3810470">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3810475">//&nbsp;Ensure&nbsp;all&nbsp;the&nbsp;body&nbsp;is&nbsp;read;&nbsp;otherwise</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3810520">//&nbsp;we&#39;ll&nbsp;get&nbsp;a&nbsp;partial&nbsp;dump.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3810552">io</span><span class="op" id="3810554">.</span><span class="ident" id="3810555">Copy</span><span class="op" id="3810559">(</span><span class="ident" id="3810560">ioutil</span><span class="op" id="3810566">.</span><span class="ident" id="3810567">Discard</span><span class="op" id="3810574">,</span>&nbsp;<span class="ident" id="3810576">req</span><span class="op" id="3810579">.</span><span class="ident" id="3810580">Body</span><span class="op" id="3810584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3810589">req</span><span class="op" id="3810592">.</span><span class="ident" id="3810593">Body</span><span class="op" id="3810597">.</span><span class="ident" id="3810598">Close</span><span class="op" id="3810603">(</span><span class="op" id="3810604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3810608">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3810612">dr</span><span class="op" id="3810614">.</span><span class="ident" id="3810615">c</span>&nbsp;<span class="op" id="3810617">&lt;-</span>&nbsp;<span class="ident" id="3810620">strings</span><span class="op" id="3810627">.</span><span class="ident" id="3810628">NewReader</span><span class="op" id="3810637">(</span><span class="string" id="3810638">&#34;HTTP/1.1&nbsp;204&nbsp;No&nbsp;Content\r\n\r\n&#34;</span><span class="op" id="3810671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3810674">}</span><span class="op" id="3810675">(</span><span class="op" id="3810676">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3810680">t</span>&nbsp;<span class="op" id="3810682">:=</span>&nbsp;<span class="op" id="3810685">&amp;</span><span class="ident" id="3810686">http</span><span class="op" id="3810690">.</span><span class="ident" id="3810691">Transport</span><span class="op" id="3810700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3810704">DisableKeepAlives</span><span class="op" id="3810721">:</span>&nbsp;<span class="builtintype" id="3810723">true</span><span class="op" id="3810727">,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3810731">Dial</span><span class="op" id="3810735">:</span>&nbsp;<span class="keyword" id="3810737">func</span><span class="op" id="3810741">(</span><span class="ident" id="3810742">net</span><span class="op" id="3810745">,</span>&nbsp;<span class="ident" id="3810747">addr</span>&nbsp;<span class="builtintype" id="3810752">string</span><span class="op" id="3810758">)</span>&nbsp;<span class="op" id="3810760">(</span><span class="ident" id="3810761">net</span><span class="op" id="3810764">.</span><span class="ident" id="3810765">Conn</span><span class="op" id="3810769">,</span>&nbsp;<span class="builtintype" id="3810771">error</span><span class="op" id="3810776">)</span>&nbsp;<span class="op" id="3810778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3810783">return</span>&nbsp;<span class="op" id="3810790">&amp;</span><span class="ident" id="3810791">dumpConn</span><span class="op" id="3810799">{</span><span class="ident" id="3810800">io</span><span class="op" id="3810802">.</span><span class="ident" id="3810803">MultiWriter</span><span class="op" id="3810814">(</span><span class="op" id="3810815">&amp;</span><span class="ident" id="3810816">buf</span><span class="op" id="3810819">,</span>&nbsp;<span class="ident" id="3810821">pw</span><span class="op" id="3810823">)</span><span class="op" id="3810824">,</span>&nbsp;<span class="ident" id="3810826">dr</span><span class="op" id="3810828">}</span><span class="op" id="3810829">,</span>&nbsp;<span class="builtintype" id="3810831">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3810837">}</span><span class="op" id="3810838">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3810841">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3810845">_</span><span class="op" id="3810846">,</span>&nbsp;<span class="ident" id="3810848">err</span>&nbsp;<span class="op" id="3810852">:=</span>&nbsp;<span class="ident" id="3810855">t</span><span class="op" id="3810856">.</span><span class="ident" id="3810857">RoundTrip</span><span class="op" id="3810866">(</span><span class="ident" id="3810867">reqSend</span><span class="op" id="3810874">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3810878">req</span><span class="op" id="3810881">.</span><span class="ident" id="3810882">Body</span>&nbsp;<span class="op" id="3810887">=</span>&nbsp;<span class="ident" id="3810889">save</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3810895">if</span>&nbsp;<span class="ident" id="3810898">err</span>&nbsp;<span class="op" id="3810902">!=</span>&nbsp;<span class="builtintype" id="3810905">nil</span>&nbsp;<span class="op" id="3810909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3810913">return</span>&nbsp;<span class="builtintype" id="3810920">nil</span><span class="op" id="3810923">,</span>&nbsp;<span class="ident" id="3810925">err</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3810930">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3810933">dump</span>&nbsp;<span class="op" id="3810938">:=</span>&nbsp;<span class="ident" id="3810941">buf</span><span class="op" id="3810944">.</span><span class="ident" id="3810945">Bytes</span><span class="op" id="3810950">(</span><span class="op" id="3810951">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3810955">//&nbsp;If&nbsp;we&nbsp;used&nbsp;a&nbsp;dummy&nbsp;body&nbsp;above,&nbsp;remove&nbsp;it&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3811005">//&nbsp;TODO:&nbsp;if&nbsp;the&nbsp;req.ContentLength&nbsp;is&nbsp;large,&nbsp;we&nbsp;allocate&nbsp;memory</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3811069">//&nbsp;unnecessarily&nbsp;just&nbsp;to&nbsp;slice&nbsp;it&nbsp;off&nbsp;here.&nbsp;&nbsp;But&nbsp;this&nbsp;is&nbsp;just</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3811132">//&nbsp;a&nbsp;debug&nbsp;function,&nbsp;so&nbsp;this&nbsp;is&nbsp;acceptable&nbsp;for&nbsp;now.&nbsp;We&nbsp;could</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3811194">//&nbsp;discard&nbsp;the&nbsp;body&nbsp;earlier&nbsp;if&nbsp;this&nbsp;matters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3811240">if</span>&nbsp;<span class="ident" id="3811243">dummyBody</span>&nbsp;<span class="op" id="3811253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3811257">if</span>&nbsp;<span class="ident" id="3811260">i</span>&nbsp;<span class="op" id="3811262">:=</span>&nbsp;<span class="ident" id="3811265">bytes</span><span class="op" id="3811270">.</span><span class="ident" id="3811271">Index</span><span class="op" id="3811276">(</span><span class="ident" id="3811277">dump</span><span class="op" id="3811281">,</span>&nbsp;<span class="op" id="3811283">[</span><span class="op" id="3811284">]</span><span class="builtintype" id="3811285">byte</span><span class="op" id="3811289">(</span><span class="string" id="3811290">&#34;\r\n\r\n&#34;</span><span class="op" id="3811300">)</span><span class="op" id="3811301">)</span><span class="op" id="3811302">;</span>&nbsp;<span class="ident" id="3811304">i</span>&nbsp;<span class="op" id="3811306">&gt;=</span>&nbsp;<span class="num" id="3811309">0</span>&nbsp;<span class="op" id="3811311">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3811316">dump</span>&nbsp;<span class="op" id="3811321">=</span>&nbsp;<span class="ident" id="3811323">dump</span><span class="op" id="3811327">[</span><span class="op" id="3811328">:</span><span class="ident" id="3811329">i</span><span class="op" id="3811330">+</span><span class="num" id="3811331">4</span><span class="op" id="3811332">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3811336">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3811339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3811342">return</span>&nbsp;<span class="ident" id="3811349">dump</span><span class="op" id="3811353">,</span>&nbsp;<span class="builtintype" id="3811355">nil</span><br>
<span class="lineno"></span><span class="op" id="3811359">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="comment" id="3811362">//&nbsp;delegateReader&nbsp;is&nbsp;a&nbsp;reader&nbsp;that&nbsp;delegates&nbsp;to&nbsp;another&nbsp;reader,</span><br>
<span class="lineno"></span><span class="comment" id="3811426">//&nbsp;once&nbsp;it&nbsp;arrives&nbsp;on&nbsp;a&nbsp;channel.</span><br>
<span class="lineno"></span><span class="keyword" id="3811459">type</span>&nbsp;<span class="ident" id="3811464">delegateReader</span>&nbsp;<span class="keyword" id="3811479">struct</span>&nbsp;<span class="op" id="3811486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3811489">c</span>&nbsp;<span class="keyword" id="3811491">chan</span>&nbsp;<span class="ident" id="3811496">io</span><span class="op" id="3811498">.</span><span class="ident" id="3811499">Reader</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3811507">r</span>&nbsp;<span class="ident" id="3811509">io</span><span class="op" id="3811511">.</span><span class="ident" id="3811512">Reader</span>&nbsp;<span class="comment" id="3811519">//&nbsp;nil&nbsp;until&nbsp;received&nbsp;from&nbsp;c</span><br>
<span class="lineno"></span><span class="op" id="3811548">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3811551">func</span>&nbsp;<span class="op" id="3811556">(</span><span class="ident" id="3811557">r</span>&nbsp;<span class="op" id="3811559">*</span><span class="ident" id="3811560">delegateReader</span><span class="op" id="3811574">)</span>&nbsp;<span class="ident" id="3811576">Read</span><span class="op" id="3811580">(</span><span class="ident" id="3811581">p</span>&nbsp;<span class="op" id="3811583">[</span><span class="op" id="3811584">]</span><span class="builtintype" id="3811585">byte</span><span class="op" id="3811589">)</span>&nbsp;<span class="op" id="3811591">(</span><span class="builtintype" id="3811592">int</span><span class="op" id="3811595">,</span>&nbsp;<span class="builtintype" id="3811597">error</span><span class="op" id="3811602">)</span>&nbsp;<span class="op" id="3811604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3811607">if</span>&nbsp;<span class="ident" id="3811610">r</span><span class="op" id="3811611">.</span><span class="ident" id="3811612">r</span>&nbsp;<span class="op" id="3811614">==</span>&nbsp;<span class="builtintype" id="3811617">nil</span>&nbsp;<span class="op" id="3811621">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3811625">r</span><span class="op" id="3811626">.</span><span class="ident" id="3811627">r</span>&nbsp;<span class="op" id="3811629">=</span>&nbsp;<span class="op" id="3811631">&lt;-</span><span class="ident" id="3811633">r</span><span class="op" id="3811634">.</span><span class="ident" id="3811635">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3811638">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3811641">return</span>&nbsp;<span class="ident" id="3811648">r</span><span class="op" id="3811649">.</span><span class="ident" id="3811650">r</span><span class="op" id="3811651">.</span><span class="ident" id="3811652">Read</span><span class="op" id="3811656">(</span><span class="ident" id="3811657">p</span><span class="op" id="3811658">)</span><br>
<span class="lineno"></span><span class="op" id="3811660">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span><span class="comment" id="3811663">//&nbsp;Return&nbsp;value&nbsp;if&nbsp;nonempty,&nbsp;def&nbsp;otherwise.</span><br>
<span class="lineno"></span><span class="keyword" id="3811707">func</span>&nbsp;<span class="ident" id="3811712">valueOrDefault</span><span class="op" id="3811726">(</span><span class="ident" id="3811727">value</span><span class="op" id="3811732">,</span>&nbsp;<span class="ident" id="3811734">def</span>&nbsp;<span class="builtintype" id="3811738">string</span><span class="op" id="3811744">)</span>&nbsp;<span class="builtintype" id="3811746">string</span>&nbsp;<span class="op" id="3811753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3811756">if</span>&nbsp;<span class="ident" id="3811759">value</span>&nbsp;<span class="op" id="3811765">!=</span>&nbsp;<span class="string" id="3811768">&#34;&#34;</span>&nbsp;<span class="op" id="3811771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3811775">return</span>&nbsp;<span class="ident" id="3811782">value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3811789">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3811792">return</span>&nbsp;<span class="ident" id="3811799">def</span><br>
<span class="lineno"></span><span class="op" id="3811803">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3811806">var</span>&nbsp;<span class="ident" id="3811810">reqWriteExcludeHeaderDump</span>&nbsp;<span class="op" id="3811836">=</span>&nbsp;<span class="keyword" id="3811838">map</span><span class="op" id="3811841">[</span><span class="builtintype" id="3811842">string</span><span class="op" id="3811848">]</span><span class="builtintype" id="3811849">bool</span><span class="op" id="3811853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3811856">&#34;Host&#34;</span><span class="op" id="3811862">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3811877">true</span><span class="op" id="3811881">,</span>&nbsp;<span class="comment" id="3811883">//&nbsp;not&nbsp;in&nbsp;Header&nbsp;map&nbsp;anyway</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3811912">&#34;Content-Length&#34;</span><span class="op" id="3811928">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3811933">true</span><span class="op" id="3811937">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3811940">&#34;Transfer-Encoding&#34;</span><span class="op" id="3811959">:</span>&nbsp;<span class="builtintype" id="3811961">true</span><span class="op" id="3811965">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3811968">&#34;Trailer&#34;</span><span class="op" id="3811977">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3811989">true</span><span class="op" id="3811993">,</span><br>
<span class="lineno"></span><span class="op" id="3811995">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="comment" id="3811998">//&nbsp;dumpAsReceived&nbsp;writes&nbsp;req&nbsp;to&nbsp;w&nbsp;in&nbsp;the&nbsp;form&nbsp;as&nbsp;it&nbsp;was&nbsp;received,&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="3812067">//&nbsp;at&nbsp;least&nbsp;as&nbsp;accurately&nbsp;as&nbsp;possible&nbsp;from&nbsp;the&nbsp;information&nbsp;retained&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="3812138">//&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span><span class="keyword" id="3812154">func</span>&nbsp;<span class="ident" id="3812159">dumpAsReceived</span><span class="op" id="3812173">(</span><span class="ident" id="3812174">req</span>&nbsp;<span class="op" id="3812178">*</span><span class="ident" id="3812179">http</span><span class="op" id="3812183">.</span><span class="ident" id="3812184">Request</span><span class="op" id="3812191">,</span>&nbsp;<span class="ident" id="3812193">w</span>&nbsp;<span class="ident" id="3812195">io</span><span class="op" id="3812197">.</span><span class="ident" id="3812198">Writer</span><span class="op" id="3812204">)</span>&nbsp;<span class="builtintype" id="3812206">error</span>&nbsp;<span class="op" id="3812212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3812215">return</span>&nbsp;<span class="builtintype" id="3812222">nil</span><br>
<span class="lineno">175</span><span class="op" id="3812226">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3812229">//&nbsp;DumpRequest&nbsp;returns&nbsp;the&nbsp;as-received&nbsp;wire&nbsp;representation&nbsp;of&nbsp;req,</span><br>
<span class="lineno"></span><span class="comment" id="3812296">//&nbsp;optionally&nbsp;including&nbsp;the&nbsp;request&nbsp;body,&nbsp;for&nbsp;debugging.</span><br>
<span class="lineno"></span><span class="comment" id="3812353">//&nbsp;DumpRequest&nbsp;is&nbsp;semantically&nbsp;a&nbsp;no-op,&nbsp;but&nbsp;in&nbsp;order&nbsp;to</span><br>
<span class="lineno">180</span><span class="comment" id="3812409">//&nbsp;dump&nbsp;the&nbsp;body,&nbsp;it&nbsp;reads&nbsp;the&nbsp;body&nbsp;data&nbsp;into&nbsp;memory&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3812466">//&nbsp;changes&nbsp;req.Body&nbsp;to&nbsp;refer&nbsp;to&nbsp;the&nbsp;in-memory&nbsp;copy.</span><br>
<span class="lineno"></span><span class="comment" id="3812518">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;http.Request.Write&nbsp;details&nbsp;which&nbsp;fields</span><br>
<span class="lineno"></span><span class="comment" id="3812583">//&nbsp;of&nbsp;req&nbsp;are&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3812603">func</span>&nbsp;<span class="ident" id="3812608">DumpRequest</span><span class="op" id="3812619">(</span><span class="ident" id="3812620">req</span>&nbsp;<span class="op" id="3812624">*</span><span class="ident" id="3812625">http</span><span class="op" id="3812629">.</span><span class="ident" id="3812630">Request</span><span class="op" id="3812637">,</span>&nbsp;<span class="ident" id="3812639">body</span>&nbsp;<span class="builtintype" id="3812644">bool</span><span class="op" id="3812648">)</span>&nbsp;<span class="op" id="3812650">(</span><span class="ident" id="3812651">dump</span>&nbsp;<span class="op" id="3812656">[</span><span class="op" id="3812657">]</span><span class="builtintype" id="3812658">byte</span><span class="op" id="3812662">,</span>&nbsp;<span class="ident" id="3812664">err</span>&nbsp;<span class="builtintype" id="3812668">error</span><span class="op" id="3812673">)</span>&nbsp;<span class="op" id="3812675">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3812678">save</span>&nbsp;<span class="op" id="3812683">:=</span>&nbsp;<span class="ident" id="3812686">req</span><span class="op" id="3812689">.</span><span class="ident" id="3812690">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3812696">if</span>&nbsp;<span class="op" id="3812699">!</span><span class="ident" id="3812700">body</span>&nbsp;<span class="op" id="3812705">||</span>&nbsp;<span class="ident" id="3812708">req</span><span class="op" id="3812711">.</span><span class="ident" id="3812712">Body</span>&nbsp;<span class="op" id="3812717">==</span>&nbsp;<span class="builtintype" id="3812720">nil</span>&nbsp;<span class="op" id="3812724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3812728">req</span><span class="op" id="3812731">.</span><span class="ident" id="3812732">Body</span>&nbsp;<span class="op" id="3812737">=</span>&nbsp;<span class="builtintype" id="3812739">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3812744">}</span>&nbsp;<span class="keyword" id="3812746">else</span>&nbsp;<span class="op" id="3812751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3812755">save</span><span class="op" id="3812759">,</span>&nbsp;<span class="ident" id="3812761">req</span><span class="op" id="3812764">.</span><span class="ident" id="3812765">Body</span><span class="op" id="3812769">,</span>&nbsp;<span class="ident" id="3812771">err</span>&nbsp;<span class="op" id="3812775">=</span>&nbsp;<span class="ident" id="3812777">drainBody</span><span class="op" id="3812786">(</span><span class="ident" id="3812787">req</span><span class="op" id="3812790">.</span><span class="ident" id="3812791">Body</span><span class="op" id="3812795">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3812799">if</span>&nbsp;<span class="ident" id="3812802">err</span>&nbsp;<span class="op" id="3812806">!=</span>&nbsp;<span class="builtintype" id="3812809">nil</span>&nbsp;<span class="op" id="3812813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3812818">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3812827">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3812830">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3812834">var</span>&nbsp;<span class="ident" id="3812838">b</span>&nbsp;<span class="ident" id="3812840">bytes</span><span class="op" id="3812845">.</span><span class="ident" id="3812846">Buffer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3812855">fmt</span><span class="op" id="3812858">.</span><span class="ident" id="3812859">Fprintf</span><span class="op" id="3812866">(</span><span class="op" id="3812867">&amp;</span><span class="ident" id="3812868">b</span><span class="op" id="3812869">,</span>&nbsp;<span class="string" id="3812871">&#34;%s&nbsp;%s&nbsp;HTTP/%d.%d\r\n&#34;</span><span class="op" id="3812893">,</span>&nbsp;<span class="ident" id="3812895">valueOrDefault</span><span class="op" id="3812909">(</span><span class="ident" id="3812910">req</span><span class="op" id="3812913">.</span><span class="ident" id="3812914">Method</span><span class="op" id="3812920">,</span>&nbsp;<span class="string" id="3812922">&#34;GET&#34;</span><span class="op" id="3812927">)</span><span class="op" id="3812928">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3812932">req</span><span class="op" id="3812935">.</span><span class="ident" id="3812936">URL</span><span class="op" id="3812939">.</span><span class="ident" id="3812940">RequestURI</span><span class="op" id="3812950">(</span><span class="op" id="3812951">)</span><span class="op" id="3812952">,</span>&nbsp;<span class="ident" id="3812954">req</span><span class="op" id="3812957">.</span><span class="ident" id="3812958">ProtoMajor</span><span class="op" id="3812968">,</span>&nbsp;<span class="ident" id="3812970">req</span><span class="op" id="3812973">.</span><span class="ident" id="3812974">ProtoMinor</span><span class="op" id="3812984">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3812988">host</span>&nbsp;<span class="op" id="3812993">:=</span>&nbsp;<span class="ident" id="3812996">req</span><span class="op" id="3812999">.</span><span class="ident" id="3813000">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3813006">if</span>&nbsp;<span class="ident" id="3813009">host</span>&nbsp;<span class="op" id="3813014">==</span>&nbsp;<span class="string" id="3813017">&#34;&#34;</span>&nbsp;<span class="op" id="3813020">&amp;&amp;</span>&nbsp;<span class="ident" id="3813023">req</span><span class="op" id="3813026">.</span><span class="ident" id="3813027">URL</span>&nbsp;<span class="op" id="3813031">!=</span>&nbsp;<span class="builtintype" id="3813034">nil</span>&nbsp;<span class="op" id="3813038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3813042">host</span>&nbsp;<span class="op" id="3813047">=</span>&nbsp;<span class="ident" id="3813049">req</span><span class="op" id="3813052">.</span><span class="ident" id="3813053">URL</span><span class="op" id="3813056">.</span><span class="ident" id="3813057">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3813063">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3813066">if</span>&nbsp;<span class="ident" id="3813069">host</span>&nbsp;<span class="op" id="3813074">!=</span>&nbsp;<span class="string" id="3813077">&#34;&#34;</span>&nbsp;<span class="op" id="3813080">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3813084">fmt</span><span class="op" id="3813087">.</span><span class="ident" id="3813088">Fprintf</span><span class="op" id="3813095">(</span><span class="op" id="3813096">&amp;</span><span class="ident" id="3813097">b</span><span class="op" id="3813098">,</span>&nbsp;<span class="string" id="3813100">&#34;Host:&nbsp;%s\r\n&#34;</span><span class="op" id="3813114">,</span>&nbsp;<span class="ident" id="3813116">host</span><span class="op" id="3813120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3813123">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3813127">chunked</span>&nbsp;<span class="op" id="3813135">:=</span>&nbsp;<span class="builtinfunc" id="3813138">len</span><span class="op" id="3813141">(</span><span class="ident" id="3813142">req</span><span class="op" id="3813145">.</span><span class="ident" id="3813146">TransferEncoding</span><span class="op" id="3813162">)</span>&nbsp;<span class="op" id="3813164">&gt;</span>&nbsp;<span class="num" id="3813166">0</span>&nbsp;<span class="op" id="3813168">&amp;&amp;</span>&nbsp;<span class="ident" id="3813171">req</span><span class="op" id="3813174">.</span><span class="ident" id="3813175">TransferEncoding</span><span class="op" id="3813191">[</span><span class="num" id="3813192">0</span><span class="op" id="3813193">]</span>&nbsp;<span class="op" id="3813195">==</span>&nbsp;<span class="string" id="3813198">&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3813209">if</span>&nbsp;<span class="builtinfunc" id="3813212">len</span><span class="op" id="3813215">(</span><span class="ident" id="3813216">req</span><span class="op" id="3813219">.</span><span class="ident" id="3813220">TransferEncoding</span><span class="op" id="3813236">)</span>&nbsp;<span class="op" id="3813238">&gt;</span>&nbsp;<span class="num" id="3813240">0</span>&nbsp;<span class="op" id="3813242">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3813246">fmt</span><span class="op" id="3813249">.</span><span class="ident" id="3813250">Fprintf</span><span class="op" id="3813257">(</span><span class="op" id="3813258">&amp;</span><span class="ident" id="3813259">b</span><span class="op" id="3813260">,</span>&nbsp;<span class="string" id="3813262">&#34;Transfer-Encoding:&nbsp;%s\r\n&#34;</span><span class="op" id="3813289">,</span>&nbsp;<span class="ident" id="3813291">strings</span><span class="op" id="3813298">.</span><span class="ident" id="3813299">Join</span><span class="op" id="3813303">(</span><span class="ident" id="3813304">req</span><span class="op" id="3813307">.</span><span class="ident" id="3813308">TransferEncoding</span><span class="op" id="3813324">,</span>&nbsp;<span class="string" id="3813326">&#34;,&#34;</span><span class="op" id="3813329">)</span><span class="op" id="3813330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3813333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3813336">if</span>&nbsp;<span class="ident" id="3813339">req</span><span class="op" id="3813342">.</span><span class="ident" id="3813343">Close</span>&nbsp;<span class="op" id="3813349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3813353">fmt</span><span class="op" id="3813356">.</span><span class="ident" id="3813357">Fprintf</span><span class="op" id="3813364">(</span><span class="op" id="3813365">&amp;</span><span class="ident" id="3813366">b</span><span class="op" id="3813367">,</span>&nbsp;<span class="string" id="3813369">&#34;Connection:&nbsp;close\r\n&#34;</span><span class="op" id="3813392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3813395">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3813399">err</span>&nbsp;<span class="op" id="3813403">=</span>&nbsp;<span class="ident" id="3813405">req</span><span class="op" id="3813408">.</span><span class="ident" id="3813409">Header</span><span class="op" id="3813415">.</span><span class="ident" id="3813416">WriteSubset</span><span class="op" id="3813427">(</span><span class="op" id="3813428">&amp;</span><span class="ident" id="3813429">b</span><span class="op" id="3813430">,</span>&nbsp;<span class="ident" id="3813432">reqWriteExcludeHeaderDump</span><span class="op" id="3813457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3813460">if</span>&nbsp;<span class="ident" id="3813463">err</span>&nbsp;<span class="op" id="3813467">!=</span>&nbsp;<span class="builtintype" id="3813470">nil</span>&nbsp;<span class="op" id="3813474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3813478">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3813486">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3813490">io</span><span class="op" id="3813492">.</span><span class="ident" id="3813493">WriteString</span><span class="op" id="3813504">(</span><span class="op" id="3813505">&amp;</span><span class="ident" id="3813506">b</span><span class="op" id="3813507">,</span>&nbsp;<span class="string" id="3813509">&#34;\r\n&#34;</span><span class="op" id="3813515">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3813519">if</span>&nbsp;<span class="ident" id="3813522">req</span><span class="op" id="3813525">.</span><span class="ident" id="3813526">Body</span>&nbsp;<span class="op" id="3813531">!=</span>&nbsp;<span class="builtintype" id="3813534">nil</span>&nbsp;<span class="op" id="3813538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3813542">var</span>&nbsp;<span class="ident" id="3813546">dest</span>&nbsp;<span class="ident" id="3813551">io</span><span class="op" id="3813553">.</span><span class="ident" id="3813554">Writer</span>&nbsp;<span class="op" id="3813561">=</span>&nbsp;<span class="op" id="3813563">&amp;</span><span class="ident" id="3813564">b</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3813568">if</span>&nbsp;<span class="ident" id="3813571">chunked</span>&nbsp;<span class="op" id="3813579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3813584">dest</span>&nbsp;<span class="op" id="3813589">=</span>&nbsp;<span class="ident" id="3813591">NewChunkedWriter</span><span class="op" id="3813607">(</span><span class="ident" id="3813608">dest</span><span class="op" id="3813612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3813616">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3813620">_</span><span class="op" id="3813621">,</span>&nbsp;<span class="ident" id="3813623">err</span>&nbsp;<span class="op" id="3813627">=</span>&nbsp;<span class="ident" id="3813629">io</span><span class="op" id="3813631">.</span><span class="ident" id="3813632">Copy</span><span class="op" id="3813636">(</span><span class="ident" id="3813637">dest</span><span class="op" id="3813641">,</span>&nbsp;<span class="ident" id="3813643">req</span><span class="op" id="3813646">.</span><span class="ident" id="3813647">Body</span><span class="op" id="3813651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3813655">if</span>&nbsp;<span class="ident" id="3813658">chunked</span>&nbsp;<span class="op" id="3813666">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3813671">dest</span><span class="op" id="3813675">.</span><span class="op" id="3813676">(</span><span class="ident" id="3813677">io</span><span class="op" id="3813679">.</span><span class="ident" id="3813680">Closer</span><span class="op" id="3813686">)</span><span class="op" id="3813687">.</span><span class="ident" id="3813688">Close</span><span class="op" id="3813693">(</span><span class="op" id="3813694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3813699">io</span><span class="op" id="3813701">.</span><span class="ident" id="3813702">WriteString</span><span class="op" id="3813713">(</span><span class="op" id="3813714">&amp;</span><span class="ident" id="3813715">b</span><span class="op" id="3813716">,</span>&nbsp;<span class="string" id="3813718">&#34;\r\n&#34;</span><span class="op" id="3813724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3813728">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3813731">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3813735">req</span><span class="op" id="3813738">.</span><span class="ident" id="3813739">Body</span>&nbsp;<span class="op" id="3813744">=</span>&nbsp;<span class="ident" id="3813746">save</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3813752">if</span>&nbsp;<span class="ident" id="3813755">err</span>&nbsp;<span class="op" id="3813759">!=</span>&nbsp;<span class="builtintype" id="3813762">nil</span>&nbsp;<span class="op" id="3813766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3813770">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3813778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3813781">dump</span>&nbsp;<span class="op" id="3813786">=</span>&nbsp;<span class="ident" id="3813788">b</span><span class="op" id="3813789">.</span><span class="ident" id="3813790">Bytes</span><span class="op" id="3813795">(</span><span class="op" id="3813796">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3813799">return</span><br>
<span class="lineno"></span><span class="op" id="3813806">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3813809">//&nbsp;errNoBody&nbsp;is&nbsp;a&nbsp;sentinel&nbsp;error&nbsp;value&nbsp;used&nbsp;by&nbsp;failureToReadBody&nbsp;so&nbsp;we&nbsp;can&nbsp;detect</span><br>
<span class="lineno"></span><span class="comment" id="3813891">//&nbsp;that&nbsp;the&nbsp;lack&nbsp;of&nbsp;body&nbsp;was&nbsp;intentional.</span><br>
<span class="lineno">245</span><span class="keyword" id="3813933">var</span>&nbsp;<span class="ident" id="3813937">errNoBody</span>&nbsp;<span class="op" id="3813947">=</span>&nbsp;<span class="ident" id="3813949">errors</span><span class="op" id="3813955">.</span><span class="ident" id="3813956">New</span><span class="op" id="3813959">(</span><span class="string" id="3813960">&#34;sentinel&nbsp;error&nbsp;value&#34;</span><span class="op" id="3813982">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3813985">//&nbsp;failureToReadBody&nbsp;is&nbsp;a&nbsp;io.ReadCloser&nbsp;that&nbsp;just&nbsp;returns&nbsp;errNoBody&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="3814056">//&nbsp;Read.&nbsp;&nbsp;It&#39;s&nbsp;swapped&nbsp;in&nbsp;when&nbsp;we&nbsp;don&#39;t&nbsp;actually&nbsp;want&nbsp;to&nbsp;consume&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3814125">//&nbsp;body,&nbsp;but&nbsp;need&nbsp;a&nbsp;non-nil&nbsp;one,&nbsp;and&nbsp;want&nbsp;to&nbsp;distinguish&nbsp;the&nbsp;error</span><br>
<span class="lineno">250</span><span class="comment" id="3814192">//&nbsp;from&nbsp;reading&nbsp;the&nbsp;dummy&nbsp;body.</span><br>
<span class="lineno"></span><span class="keyword" id="3814224">type</span>&nbsp;<span class="ident" id="3814229">failureToReadBody</span>&nbsp;<span class="keyword" id="3814247">struct</span><span class="op" id="3814253">{</span><span class="op" id="3814254">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3814257">func</span>&nbsp;<span class="op" id="3814262">(</span><span class="ident" id="3814263">failureToReadBody</span><span class="op" id="3814280">)</span>&nbsp;<span class="ident" id="3814282">Read</span><span class="op" id="3814286">(</span><span class="op" id="3814287">[</span><span class="op" id="3814288">]</span><span class="builtintype" id="3814289">byte</span><span class="op" id="3814293">)</span>&nbsp;<span class="op" id="3814295">(</span><span class="builtintype" id="3814296">int</span><span class="op" id="3814299">,</span>&nbsp;<span class="builtintype" id="3814301">error</span><span class="op" id="3814306">)</span>&nbsp;<span class="op" id="3814308">{</span>&nbsp;<span class="keyword" id="3814310">return</span>&nbsp;<span class="num" id="3814317">0</span><span class="op" id="3814318">,</span>&nbsp;<span class="ident" id="3814320">errNoBody</span>&nbsp;<span class="op" id="3814330">}</span><br>
<span class="lineno"></span><span class="keyword" id="3814332">func</span>&nbsp;<span class="op" id="3814337">(</span><span class="ident" id="3814338">failureToReadBody</span><span class="op" id="3814355">)</span>&nbsp;<span class="ident" id="3814357">Close</span><span class="op" id="3814362">(</span><span class="op" id="3814363">)</span>&nbsp;<span class="builtintype" id="3814365">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3814383">{</span>&nbsp;<span class="keyword" id="3814385">return</span>&nbsp;<span class="builtintype" id="3814392">nil</span>&nbsp;<span class="op" id="3814396">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="3814399">var</span>&nbsp;<span class="ident" id="3814403">emptyBody</span>&nbsp;<span class="op" id="3814413">=</span>&nbsp;<span class="ident" id="3814415">ioutil</span><span class="op" id="3814421">.</span><span class="ident" id="3814422">NopCloser</span><span class="op" id="3814431">(</span><span class="ident" id="3814432">strings</span><span class="op" id="3814439">.</span><span class="ident" id="3814440">NewReader</span><span class="op" id="3814449">(</span><span class="string" id="3814450">&#34;&#34;</span><span class="op" id="3814452">)</span><span class="op" id="3814453">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3814456">//&nbsp;DumpResponse&nbsp;is&nbsp;like&nbsp;DumpRequest&nbsp;but&nbsp;dumps&nbsp;a&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="3814514">func</span>&nbsp;<span class="ident" id="3814519">DumpResponse</span><span class="op" id="3814531">(</span><span class="ident" id="3814532">resp</span>&nbsp;<span class="op" id="3814537">*</span><span class="ident" id="3814538">http</span><span class="op" id="3814542">.</span><span class="ident" id="3814543">Response</span><span class="op" id="3814551">,</span>&nbsp;<span class="ident" id="3814553">body</span>&nbsp;<span class="builtintype" id="3814558">bool</span><span class="op" id="3814562">)</span>&nbsp;<span class="op" id="3814564">(</span><span class="ident" id="3814565">dump</span>&nbsp;<span class="op" id="3814570">[</span><span class="op" id="3814571">]</span><span class="builtintype" id="3814572">byte</span><span class="op" id="3814576">,</span>&nbsp;<span class="ident" id="3814578">err</span>&nbsp;<span class="builtintype" id="3814582">error</span><span class="op" id="3814587">)</span>&nbsp;<span class="op" id="3814589">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3814592">var</span>&nbsp;<span class="ident" id="3814596">b</span>&nbsp;<span class="ident" id="3814598">bytes</span><span class="op" id="3814603">.</span><span class="ident" id="3814604">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3814612">save</span>&nbsp;<span class="op" id="3814617">:=</span>&nbsp;<span class="ident" id="3814620">resp</span><span class="op" id="3814624">.</span><span class="ident" id="3814625">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3814631">savecl</span>&nbsp;<span class="op" id="3814638">:=</span>&nbsp;<span class="ident" id="3814641">resp</span><span class="op" id="3814645">.</span><span class="ident" id="3814646">ContentLength</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3814662">if</span>&nbsp;<span class="op" id="3814665">!</span><span class="ident" id="3814666">body</span>&nbsp;<span class="op" id="3814671">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3814675">resp</span><span class="op" id="3814679">.</span><span class="ident" id="3814680">Body</span>&nbsp;<span class="op" id="3814685">=</span>&nbsp;<span class="ident" id="3814687">failureToReadBody</span><span class="op" id="3814704">{</span><span class="op" id="3814705">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3814708">}</span>&nbsp;<span class="keyword" id="3814710">else</span>&nbsp;<span class="keyword" id="3814715">if</span>&nbsp;<span class="ident" id="3814718">resp</span><span class="op" id="3814722">.</span><span class="ident" id="3814723">Body</span>&nbsp;<span class="op" id="3814728">==</span>&nbsp;<span class="builtintype" id="3814731">nil</span>&nbsp;<span class="op" id="3814735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3814739">resp</span><span class="op" id="3814743">.</span><span class="ident" id="3814744">Body</span>&nbsp;<span class="op" id="3814749">=</span>&nbsp;<span class="ident" id="3814751">emptyBody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3814762">}</span>&nbsp;<span class="keyword" id="3814764">else</span>&nbsp;<span class="op" id="3814769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3814773">save</span><span class="op" id="3814777">,</span>&nbsp;<span class="ident" id="3814779">resp</span><span class="op" id="3814783">.</span><span class="ident" id="3814784">Body</span><span class="op" id="3814788">,</span>&nbsp;<span class="ident" id="3814790">err</span>&nbsp;<span class="op" id="3814794">=</span>&nbsp;<span class="ident" id="3814796">drainBody</span><span class="op" id="3814805">(</span><span class="ident" id="3814806">resp</span><span class="op" id="3814810">.</span><span class="ident" id="3814811">Body</span><span class="op" id="3814815">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3814819">if</span>&nbsp;<span class="ident" id="3814822">err</span>&nbsp;<span class="op" id="3814826">!=</span>&nbsp;<span class="builtintype" id="3814829">nil</span>&nbsp;<span class="op" id="3814833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3814838">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3814847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3814850">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3814853">err</span>&nbsp;<span class="op" id="3814857">=</span>&nbsp;<span class="ident" id="3814859">resp</span><span class="op" id="3814863">.</span><span class="ident" id="3814864">Write</span><span class="op" id="3814869">(</span><span class="op" id="3814870">&amp;</span><span class="ident" id="3814871">b</span><span class="op" id="3814872">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3814875">if</span>&nbsp;<span class="ident" id="3814878">err</span>&nbsp;<span class="op" id="3814882">==</span>&nbsp;<span class="ident" id="3814885">errNoBody</span>&nbsp;<span class="op" id="3814895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3814899">err</span>&nbsp;<span class="op" id="3814903">=</span>&nbsp;<span class="builtintype" id="3814905">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3814910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3814913">resp</span><span class="op" id="3814917">.</span><span class="ident" id="3814918">Body</span>&nbsp;<span class="op" id="3814923">=</span>&nbsp;<span class="ident" id="3814925">save</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3814931">resp</span><span class="op" id="3814935">.</span><span class="ident" id="3814936">ContentLength</span>&nbsp;<span class="op" id="3814950">=</span>&nbsp;<span class="ident" id="3814952">savecl</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3814960">if</span>&nbsp;<span class="ident" id="3814963">err</span>&nbsp;<span class="op" id="3814967">!=</span>&nbsp;<span class="builtintype" id="3814970">nil</span>&nbsp;<span class="op" id="3814974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3814978">return</span>&nbsp;<span class="builtintype" id="3814985">nil</span><span class="op" id="3814988">,</span>&nbsp;<span class="ident" id="3814990">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3814995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3814998">return</span>&nbsp;<span class="ident" id="3815005">b</span><span class="op" id="3815006">.</span><span class="ident" id="3815007">Bytes</span><span class="op" id="3815012">(</span><span class="op" id="3815013">)</span><span class="op" id="3815014">,</span>&nbsp;<span class="builtintype" id="3815016">nil</span><br>
<span class="lineno"></span><span class="op" id="3815020">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
