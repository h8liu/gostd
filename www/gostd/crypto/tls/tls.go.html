<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html" class="current">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3762463">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3762518">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3762572">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3762623">//&nbsp;Package&nbsp;tls&nbsp;partially&nbsp;implements&nbsp;TLS&nbsp;1.2,&nbsp;as&nbsp;specified&nbsp;in&nbsp;RFC&nbsp;5246.</span><br>
<span class="lineno"></span><span class="keyword" id="3762694">package</span>&nbsp;<span class="ident" id="3762702">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3762707">import</span>&nbsp;<span class="op" id="3762714">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3762717">&#34;crypto&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3762727">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3762743">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3762757">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3762772">&#34;encoding/pem&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3762788">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3762798">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3762811">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3762818">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3762829">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3762836">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="3762839">//&nbsp;Server&nbsp;returns&nbsp;a&nbsp;new&nbsp;TLS&nbsp;server&nbsp;side&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="3762890">//&nbsp;using&nbsp;conn&nbsp;as&nbsp;the&nbsp;underlying&nbsp;transport.</span><br>
<span class="lineno"></span><span class="comment" id="3762933">//&nbsp;The&nbsp;configuration&nbsp;config&nbsp;must&nbsp;be&nbsp;non-nil&nbsp;and&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="3762991">//&nbsp;at&nbsp;least&nbsp;one&nbsp;certificate.</span><br>
<span class="lineno">25</span><span class="keyword" id="3763020">func</span>&nbsp;<span class="ident" id="3763025">Server</span><span class="op" id="3763031">(</span><span class="ident" id="3763032">conn</span>&nbsp;<span class="ident" id="3763037">net</span><span class="op" id="3763040">.</span><span class="ident" id="3763041">Conn</span><span class="op" id="3763045">,</span>&nbsp;<span class="ident" id="3763047">config</span>&nbsp;<span class="op" id="3763054">*</span><span class="ident" id="3763055">Config</span><span class="op" id="3763061">)</span>&nbsp;<span class="op" id="3763063">*</span><span class="ident" id="3763064">Conn</span>&nbsp;<span class="op" id="3763069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3763072">return</span>&nbsp;<span class="op" id="3763079">&amp;</span><span class="ident" id="3763080">Conn</span><span class="op" id="3763084">{</span><span class="ident" id="3763085">conn</span><span class="op" id="3763089">:</span>&nbsp;<span class="ident" id="3763091">conn</span><span class="op" id="3763095">,</span>&nbsp;<span class="ident" id="3763097">config</span><span class="op" id="3763103">:</span>&nbsp;<span class="ident" id="3763105">config</span><span class="op" id="3763111">}</span><br>
<span class="lineno"></span><span class="op" id="3763113">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3763116">//&nbsp;Client&nbsp;returns&nbsp;a&nbsp;new&nbsp;TLS&nbsp;client&nbsp;side&nbsp;connection</span><br>
<span class="lineno">30</span><span class="comment" id="3763167">//&nbsp;using&nbsp;conn&nbsp;as&nbsp;the&nbsp;underlying&nbsp;transport.</span><br>
<span class="lineno"></span><span class="comment" id="3763210">//&nbsp;The&nbsp;config&nbsp;cannot&nbsp;be&nbsp;nil:&nbsp;users&nbsp;must&nbsp;set&nbsp;either&nbsp;ServerName&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="3763275">//&nbsp;InsecureSkipVerify&nbsp;in&nbsp;the&nbsp;config.</span><br>
<span class="lineno"></span><span class="keyword" id="3763312">func</span>&nbsp;<span class="ident" id="3763317">Client</span><span class="op" id="3763323">(</span><span class="ident" id="3763324">conn</span>&nbsp;<span class="ident" id="3763329">net</span><span class="op" id="3763332">.</span><span class="ident" id="3763333">Conn</span><span class="op" id="3763337">,</span>&nbsp;<span class="ident" id="3763339">config</span>&nbsp;<span class="op" id="3763346">*</span><span class="ident" id="3763347">Config</span><span class="op" id="3763353">)</span>&nbsp;<span class="op" id="3763355">*</span><span class="ident" id="3763356">Conn</span>&nbsp;<span class="op" id="3763361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3763364">return</span>&nbsp;<span class="op" id="3763371">&amp;</span><span class="ident" id="3763372">Conn</span><span class="op" id="3763376">{</span><span class="ident" id="3763377">conn</span><span class="op" id="3763381">:</span>&nbsp;<span class="ident" id="3763383">conn</span><span class="op" id="3763387">,</span>&nbsp;<span class="ident" id="3763389">config</span><span class="op" id="3763395">:</span>&nbsp;<span class="ident" id="3763397">config</span><span class="op" id="3763403">,</span>&nbsp;<span class="ident" id="3763405">isClient</span><span class="op" id="3763413">:</span>&nbsp;<span class="builtintype" id="3763415">true</span><span class="op" id="3763419">}</span><br>
<span class="lineno">35</span><span class="op" id="3763421">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3763424">//&nbsp;A&nbsp;listener&nbsp;implements&nbsp;a&nbsp;network&nbsp;listener&nbsp;(net.Listener)&nbsp;for&nbsp;TLS&nbsp;connections.</span><br>
<span class="lineno"></span><span class="keyword" id="3763504">type</span>&nbsp;<span class="ident" id="3763509">listener</span>&nbsp;<span class="keyword" id="3763518">struct</span>&nbsp;<span class="op" id="3763525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3763528">net</span><span class="op" id="3763531">.</span><span class="ident" id="3763532">Listener</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3763542">config</span>&nbsp;<span class="op" id="3763549">*</span><span class="ident" id="3763550">Config</span><br>
<span class="lineno"></span><span class="op" id="3763557">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3763560">//&nbsp;Accept&nbsp;waits&nbsp;for&nbsp;and&nbsp;returns&nbsp;the&nbsp;next&nbsp;incoming&nbsp;TLS&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3763626">//&nbsp;The&nbsp;returned&nbsp;connection&nbsp;c&nbsp;is&nbsp;a&nbsp;*tls.Conn.</span><br>
<span class="lineno">45</span><span class="keyword" id="3763671">func</span>&nbsp;<span class="op" id="3763676">(</span><span class="ident" id="3763677">l</span>&nbsp;<span class="op" id="3763679">*</span><span class="ident" id="3763680">listener</span><span class="op" id="3763688">)</span>&nbsp;<span class="ident" id="3763690">Accept</span><span class="op" id="3763696">(</span><span class="op" id="3763697">)</span>&nbsp;<span class="op" id="3763699">(</span><span class="ident" id="3763700">c</span>&nbsp;<span class="ident" id="3763702">net</span><span class="op" id="3763705">.</span><span class="ident" id="3763706">Conn</span><span class="op" id="3763710">,</span>&nbsp;<span class="ident" id="3763712">err</span>&nbsp;<span class="builtintype" id="3763716">error</span><span class="op" id="3763721">)</span>&nbsp;<span class="op" id="3763723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3763726">c</span><span class="op" id="3763727">,</span>&nbsp;<span class="ident" id="3763729">err</span>&nbsp;<span class="op" id="3763733">=</span>&nbsp;<span class="ident" id="3763735">l</span><span class="op" id="3763736">.</span><span class="ident" id="3763737">Listener</span><span class="op" id="3763745">.</span><span class="ident" id="3763746">Accept</span><span class="op" id="3763752">(</span><span class="op" id="3763753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3763756">if</span>&nbsp;<span class="ident" id="3763759">err</span>&nbsp;<span class="op" id="3763763">!=</span>&nbsp;<span class="ident" id="3763766">nil</span>&nbsp;<span class="op" id="3763770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3763774">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3763782">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3763785">c</span>&nbsp;<span class="op" id="3763787">=</span>&nbsp;<span class="ident" id="3763789">Server</span><span class="op" id="3763795">(</span><span class="ident" id="3763796">c</span><span class="op" id="3763797">,</span>&nbsp;<span class="ident" id="3763799">l</span><span class="op" id="3763800">.</span><span class="ident" id="3763801">config</span><span class="op" id="3763807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3763810">return</span><br>
<span class="lineno"></span><span class="op" id="3763817">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3763820">//&nbsp;NewListener&nbsp;creates&nbsp;a&nbsp;Listener&nbsp;which&nbsp;accepts&nbsp;connections&nbsp;from&nbsp;an&nbsp;inner</span><br>
<span class="lineno">55</span><span class="comment" id="3763894">//&nbsp;Listener&nbsp;and&nbsp;wraps&nbsp;each&nbsp;connection&nbsp;with&nbsp;Server.</span><br>
<span class="lineno"></span><span class="comment" id="3763945">//&nbsp;The&nbsp;configuration&nbsp;config&nbsp;must&nbsp;be&nbsp;non-nil&nbsp;and&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="3764003">//&nbsp;at&nbsp;least&nbsp;one&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="3764032">func</span>&nbsp;<span class="ident" id="3764037">NewListener</span><span class="op" id="3764048">(</span><span class="ident" id="3764049">inner</span>&nbsp;<span class="ident" id="3764055">net</span><span class="op" id="3764058">.</span><span class="ident" id="3764059">Listener</span><span class="op" id="3764067">,</span>&nbsp;<span class="ident" id="3764069">config</span>&nbsp;<span class="op" id="3764076">*</span><span class="ident" id="3764077">Config</span><span class="op" id="3764083">)</span>&nbsp;<span class="ident" id="3764085">net</span><span class="op" id="3764088">.</span><span class="ident" id="3764089">Listener</span>&nbsp;<span class="op" id="3764098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3764101">l</span>&nbsp;<span class="op" id="3764103">:=</span>&nbsp;<span class="builtinfunc" id="3764106">new</span><span class="op" id="3764109">(</span><span class="ident" id="3764110">listener</span><span class="op" id="3764118">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3764121">l</span><span class="op" id="3764122">.</span><span class="ident" id="3764123">Listener</span>&nbsp;<span class="op" id="3764132">=</span>&nbsp;<span class="ident" id="3764134">inner</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3764141">l</span><span class="op" id="3764142">.</span><span class="ident" id="3764143">config</span>&nbsp;<span class="op" id="3764150">=</span>&nbsp;<span class="ident" id="3764152">config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3764160">return</span>&nbsp;<span class="ident" id="3764167">l</span><br>
<span class="lineno"></span><span class="op" id="3764169">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="3764172">//&nbsp;Listen&nbsp;creates&nbsp;a&nbsp;TLS&nbsp;listener&nbsp;accepting&nbsp;connections&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3764234">//&nbsp;given&nbsp;network&nbsp;address&nbsp;using&nbsp;net.Listen.</span><br>
<span class="lineno"></span><span class="comment" id="3764277">//&nbsp;The&nbsp;configuration&nbsp;config&nbsp;must&nbsp;be&nbsp;non-nil&nbsp;and&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="3764335">//&nbsp;at&nbsp;least&nbsp;one&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="3764364">func</span>&nbsp;<span class="ident" id="3764369">Listen</span><span class="op" id="3764375">(</span><span class="ident" id="3764376">network</span><span class="op" id="3764383">,</span>&nbsp;<span class="ident" id="3764385">laddr</span>&nbsp;<span class="builtintype" id="3764391">string</span><span class="op" id="3764397">,</span>&nbsp;<span class="ident" id="3764399">config</span>&nbsp;<span class="op" id="3764406">*</span><span class="ident" id="3764407">Config</span><span class="op" id="3764413">)</span>&nbsp;<span class="op" id="3764415">(</span><span class="ident" id="3764416">net</span><span class="op" id="3764419">.</span><span class="ident" id="3764420">Listener</span><span class="op" id="3764428">,</span>&nbsp;<span class="builtintype" id="3764430">error</span><span class="op" id="3764435">)</span>&nbsp;<span class="op" id="3764437">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3764440">if</span>&nbsp;<span class="ident" id="3764443">config</span>&nbsp;<span class="op" id="3764450">==</span>&nbsp;<span class="ident" id="3764453">nil</span>&nbsp;<span class="op" id="3764457">||</span>&nbsp;<span class="builtinfunc" id="3764460">len</span><span class="op" id="3764463">(</span><span class="ident" id="3764464">config</span><span class="op" id="3764470">.</span><span class="ident" id="3764471">Certificates</span><span class="op" id="3764483">)</span>&nbsp;<span class="op" id="3764485">==</span>&nbsp;<span class="num" id="3764488">0</span>&nbsp;<span class="op" id="3764490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3764494">return</span>&nbsp;<span class="ident" id="3764501">nil</span><span class="op" id="3764504">,</span>&nbsp;<span class="ident" id="3764506">errors</span><span class="op" id="3764512">.</span><span class="ident" id="3764513">New</span><span class="op" id="3764516">(</span><span class="string" id="3764517">&#34;tls.Listen:&nbsp;no&nbsp;certificates&nbsp;in&nbsp;configuration&#34;</span><span class="op" id="3764563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3764566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3764569">l</span><span class="op" id="3764570">,</span>&nbsp;<span class="ident" id="3764572">err</span>&nbsp;<span class="op" id="3764576">:=</span>&nbsp;<span class="ident" id="3764579">net</span><span class="op" id="3764582">.</span><span class="ident" id="3764583">Listen</span><span class="op" id="3764589">(</span><span class="ident" id="3764590">network</span><span class="op" id="3764597">,</span>&nbsp;<span class="ident" id="3764599">laddr</span><span class="op" id="3764604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3764607">if</span>&nbsp;<span class="ident" id="3764610">err</span>&nbsp;<span class="op" id="3764614">!=</span>&nbsp;<span class="ident" id="3764617">nil</span>&nbsp;<span class="op" id="3764621">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3764625">return</span>&nbsp;<span class="ident" id="3764632">nil</span><span class="op" id="3764635">,</span>&nbsp;<span class="ident" id="3764637">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3764642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3764645">return</span>&nbsp;<span class="ident" id="3764652">NewListener</span><span class="op" id="3764663">(</span><span class="ident" id="3764664">l</span><span class="op" id="3764665">,</span>&nbsp;<span class="ident" id="3764667">config</span><span class="op" id="3764673">)</span><span class="op" id="3764674">,</span>&nbsp;<span class="ident" id="3764676">nil</span><br>
<span class="lineno"></span><span class="op" id="3764680">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="keyword" id="3764683">type</span>&nbsp;<span class="ident" id="3764688">timeoutError</span>&nbsp;<span class="keyword" id="3764701">struct</span><span class="op" id="3764707">{</span><span class="op" id="3764708">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3764711">func</span>&nbsp;<span class="op" id="3764716">(</span><span class="ident" id="3764717">timeoutError</span><span class="op" id="3764729">)</span>&nbsp;<span class="ident" id="3764731">Error</span><span class="op" id="3764736">(</span><span class="op" id="3764737">)</span>&nbsp;<span class="builtintype" id="3764739">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3764748">{</span>&nbsp;<span class="keyword" id="3764750">return</span>&nbsp;<span class="string" id="3764757">&#34;tls:&nbsp;DialWithDialer&nbsp;timed&nbsp;out&#34;</span>&nbsp;<span class="op" id="3764789">}</span><br>
<span class="lineno"></span><span class="keyword" id="3764791">func</span>&nbsp;<span class="op" id="3764796">(</span><span class="ident" id="3764797">timeoutError</span><span class="op" id="3764809">)</span>&nbsp;<span class="ident" id="3764811">Timeout</span><span class="op" id="3764818">(</span><span class="op" id="3764819">)</span>&nbsp;<span class="builtintype" id="3764821">bool</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3764828">{</span>&nbsp;<span class="keyword" id="3764830">return</span>&nbsp;<span class="builtintype" id="3764837">true</span>&nbsp;<span class="op" id="3764842">}</span><br>
<span class="lineno"></span><span class="keyword" id="3764844">func</span>&nbsp;<span class="op" id="3764849">(</span><span class="ident" id="3764850">timeoutError</span><span class="op" id="3764862">)</span>&nbsp;<span class="ident" id="3764864">Temporary</span><span class="op" id="3764873">(</span><span class="op" id="3764874">)</span>&nbsp;<span class="builtintype" id="3764876">bool</span>&nbsp;<span class="op" id="3764881">{</span>&nbsp;<span class="keyword" id="3764883">return</span>&nbsp;<span class="builtintype" id="3764890">true</span>&nbsp;<span class="op" id="3764895">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="comment" id="3764898">//&nbsp;DialWithDialer&nbsp;connects&nbsp;to&nbsp;the&nbsp;given&nbsp;network&nbsp;address&nbsp;using&nbsp;dialer.Dial&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3764976">//&nbsp;then&nbsp;initiates&nbsp;a&nbsp;TLS&nbsp;handshake,&nbsp;returning&nbsp;the&nbsp;resulting&nbsp;TLS&nbsp;connection.&nbsp;Any</span><br>
<span class="lineno"></span><span class="comment" id="3765055">//&nbsp;timeout&nbsp;or&nbsp;deadline&nbsp;given&nbsp;in&nbsp;the&nbsp;dialer&nbsp;apply&nbsp;to&nbsp;connection&nbsp;and&nbsp;TLS</span><br>
<span class="lineno"></span><span class="comment" id="3765126">//&nbsp;handshake&nbsp;as&nbsp;a&nbsp;whole.</span><br>
<span class="lineno">90</span><span class="comment" id="3765151">//</span><br>
<span class="lineno"></span><span class="comment" id="3765154">//&nbsp;DialWithDialer&nbsp;interprets&nbsp;a&nbsp;nil&nbsp;configuration&nbsp;as&nbsp;equivalent&nbsp;to&nbsp;the&nbsp;zero</span><br>
<span class="lineno"></span><span class="comment" id="3765229">//&nbsp;configuration;&nbsp;see&nbsp;the&nbsp;documentation&nbsp;of&nbsp;Config&nbsp;for&nbsp;the&nbsp;defaults.</span><br>
<span class="lineno"></span><span class="keyword" id="3765297">func</span>&nbsp;<span class="ident" id="3765302">DialWithDialer</span><span class="op" id="3765316">(</span><span class="ident" id="3765317">dialer</span>&nbsp;<span class="op" id="3765324">*</span><span class="ident" id="3765325">net</span><span class="op" id="3765328">.</span><span class="ident" id="3765329">Dialer</span><span class="op" id="3765335">,</span>&nbsp;<span class="ident" id="3765337">network</span><span class="op" id="3765344">,</span>&nbsp;<span class="ident" id="3765346">addr</span>&nbsp;<span class="builtintype" id="3765351">string</span><span class="op" id="3765357">,</span>&nbsp;<span class="ident" id="3765359">config</span>&nbsp;<span class="op" id="3765366">*</span><span class="ident" id="3765367">Config</span><span class="op" id="3765373">)</span>&nbsp;<span class="op" id="3765375">(</span><span class="op" id="3765376">*</span><span class="ident" id="3765377">Conn</span><span class="op" id="3765381">,</span>&nbsp;<span class="builtintype" id="3765383">error</span><span class="op" id="3765388">)</span>&nbsp;<span class="op" id="3765390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3765393">//&nbsp;We&nbsp;want&nbsp;the&nbsp;Timeout&nbsp;and&nbsp;Deadline&nbsp;values&nbsp;from&nbsp;dialer&nbsp;to&nbsp;cover&nbsp;the</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3765462">//&nbsp;whole&nbsp;process:&nbsp;TCP&nbsp;connection&nbsp;and&nbsp;TLS&nbsp;handshake.&nbsp;This&nbsp;means&nbsp;that&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3765534">//&nbsp;also&nbsp;need&nbsp;to&nbsp;start&nbsp;our&nbsp;own&nbsp;timers&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3765577">timeout</span>&nbsp;<span class="op" id="3765585">:=</span>&nbsp;<span class="ident" id="3765588">dialer</span><span class="op" id="3765594">.</span><span class="ident" id="3765595">Timeout</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3765605">if</span>&nbsp;<span class="op" id="3765608">!</span><span class="ident" id="3765609">dialer</span><span class="op" id="3765615">.</span><span class="ident" id="3765616">Deadline</span><span class="op" id="3765624">.</span><span class="ident" id="3765625">IsZero</span><span class="op" id="3765631">(</span><span class="op" id="3765632">)</span>&nbsp;<span class="op" id="3765634">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3765638">deadlineTimeout</span>&nbsp;<span class="op" id="3765654">:=</span>&nbsp;<span class="ident" id="3765657">dialer</span><span class="op" id="3765663">.</span><span class="ident" id="3765664">Deadline</span><span class="op" id="3765672">.</span><span class="ident" id="3765673">Sub</span><span class="op" id="3765676">(</span><span class="ident" id="3765677">time</span><span class="op" id="3765681">.</span><span class="ident" id="3765682">Now</span><span class="op" id="3765685">(</span><span class="op" id="3765686">)</span><span class="op" id="3765687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3765691">if</span>&nbsp;<span class="ident" id="3765694">timeout</span>&nbsp;<span class="op" id="3765702">==</span>&nbsp;<span class="num" id="3765705">0</span>&nbsp;<span class="op" id="3765707">||</span>&nbsp;<span class="ident" id="3765710">deadlineTimeout</span>&nbsp;<span class="op" id="3765726">&lt;</span>&nbsp;<span class="ident" id="3765728">timeout</span>&nbsp;<span class="op" id="3765736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3765741">timeout</span>&nbsp;<span class="op" id="3765749">=</span>&nbsp;<span class="ident" id="3765751">deadlineTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3765769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3765772">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3765776">var</span>&nbsp;<span class="ident" id="3765780">errChannel</span>&nbsp;<span class="keyword" id="3765791">chan</span>&nbsp;<span class="builtintype" id="3765796">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3765804">if</span>&nbsp;<span class="ident" id="3765807">timeout</span>&nbsp;<span class="op" id="3765815">!=</span>&nbsp;<span class="num" id="3765818">0</span>&nbsp;<span class="op" id="3765820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3765824">errChannel</span>&nbsp;<span class="op" id="3765835">=</span>&nbsp;<span class="builtinfunc" id="3765837">make</span><span class="op" id="3765841">(</span><span class="keyword" id="3765842">chan</span>&nbsp;<span class="builtintype" id="3765847">error</span><span class="op" id="3765852">,</span>&nbsp;<span class="num" id="3765854">2</span><span class="op" id="3765855">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3765859">time</span><span class="op" id="3765863">.</span><span class="ident" id="3765864">AfterFunc</span><span class="op" id="3765873">(</span><span class="ident" id="3765874">timeout</span><span class="op" id="3765881">,</span>&nbsp;<span class="keyword" id="3765883">func</span><span class="op" id="3765887">(</span><span class="op" id="3765888">)</span>&nbsp;<span class="op" id="3765890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3765895">errChannel</span>&nbsp;<span class="op" id="3765906">&lt;-</span>&nbsp;<span class="ident" id="3765909">timeoutError</span><span class="op" id="3765921">{</span><span class="op" id="3765922">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3765926">}</span><span class="op" id="3765927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3765930">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3765934">rawConn</span><span class="op" id="3765941">,</span>&nbsp;<span class="ident" id="3765943">err</span>&nbsp;<span class="op" id="3765947">:=</span>&nbsp;<span class="ident" id="3765950">dialer</span><span class="op" id="3765956">.</span><span class="ident" id="3765957">Dial</span><span class="op" id="3765961">(</span><span class="ident" id="3765962">network</span><span class="op" id="3765969">,</span>&nbsp;<span class="ident" id="3765971">addr</span><span class="op" id="3765975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3765978">if</span>&nbsp;<span class="ident" id="3765981">err</span>&nbsp;<span class="op" id="3765985">!=</span>&nbsp;<span class="ident" id="3765988">nil</span>&nbsp;<span class="op" id="3765992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3765996">return</span>&nbsp;<span class="ident" id="3766003">nil</span><span class="op" id="3766006">,</span>&nbsp;<span class="ident" id="3766008">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3766013">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3766017">colonPos</span>&nbsp;<span class="op" id="3766026">:=</span>&nbsp;<span class="ident" id="3766029">strings</span><span class="op" id="3766036">.</span><span class="ident" id="3766037">LastIndex</span><span class="op" id="3766046">(</span><span class="ident" id="3766047">addr</span><span class="op" id="3766051">,</span>&nbsp;<span class="string" id="3766053">&#34;:&#34;</span><span class="op" id="3766056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3766059">if</span>&nbsp;<span class="ident" id="3766062">colonPos</span>&nbsp;<span class="op" id="3766071">==</span>&nbsp;<span class="op" id="3766074">-</span><span class="num" id="3766075">1</span>&nbsp;<span class="op" id="3766077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3766081">colonPos</span>&nbsp;<span class="op" id="3766090">=</span>&nbsp;<span class="builtinfunc" id="3766092">len</span><span class="op" id="3766095">(</span><span class="ident" id="3766096">addr</span><span class="op" id="3766100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3766103">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3766106">hostname</span>&nbsp;<span class="op" id="3766115">:=</span>&nbsp;<span class="ident" id="3766118">addr</span><span class="op" id="3766122">[</span><span class="op" id="3766123">:</span><span class="ident" id="3766124">colonPos</span><span class="op" id="3766132">]</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3766136">if</span>&nbsp;<span class="ident" id="3766139">config</span>&nbsp;<span class="op" id="3766146">==</span>&nbsp;<span class="ident" id="3766149">nil</span>&nbsp;<span class="op" id="3766153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3766157">config</span>&nbsp;<span class="op" id="3766164">=</span>&nbsp;<span class="ident" id="3766166">defaultConfig</span><span class="op" id="3766179">(</span><span class="op" id="3766180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3766183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3766186">//&nbsp;If&nbsp;no&nbsp;ServerName&nbsp;is&nbsp;set,&nbsp;infer&nbsp;the&nbsp;ServerName</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3766236">//&nbsp;from&nbsp;the&nbsp;hostname&nbsp;we&#39;re&nbsp;connecting&nbsp;to.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3766279">if</span>&nbsp;<span class="ident" id="3766282">config</span><span class="op" id="3766288">.</span><span class="ident" id="3766289">ServerName</span>&nbsp;<span class="op" id="3766300">==</span>&nbsp;<span class="string" id="3766303">&#34;&#34;</span>&nbsp;<span class="op" id="3766306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3766310">//&nbsp;Make&nbsp;a&nbsp;copy&nbsp;to&nbsp;avoid&nbsp;polluting&nbsp;argument&nbsp;or&nbsp;default.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3766367">c</span>&nbsp;<span class="op" id="3766369">:=</span>&nbsp;<span class="op" id="3766372">*</span><span class="ident" id="3766373">config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3766382">c</span><span class="op" id="3766383">.</span><span class="ident" id="3766384">ServerName</span>&nbsp;<span class="op" id="3766395">=</span>&nbsp;<span class="ident" id="3766397">hostname</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3766408">config</span>&nbsp;<span class="op" id="3766415">=</span>&nbsp;<span class="op" id="3766417">&amp;</span><span class="ident" id="3766418">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3766421">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3766425">conn</span>&nbsp;<span class="op" id="3766430">:=</span>&nbsp;<span class="ident" id="3766433">Client</span><span class="op" id="3766439">(</span><span class="ident" id="3766440">rawConn</span><span class="op" id="3766447">,</span>&nbsp;<span class="ident" id="3766449">config</span><span class="op" id="3766455">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3766459">if</span>&nbsp;<span class="ident" id="3766462">timeout</span>&nbsp;<span class="op" id="3766470">==</span>&nbsp;<span class="num" id="3766473">0</span>&nbsp;<span class="op" id="3766475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3766479">err</span>&nbsp;<span class="op" id="3766483">=</span>&nbsp;<span class="ident" id="3766485">conn</span><span class="op" id="3766489">.</span><span class="ident" id="3766490">Handshake</span><span class="op" id="3766499">(</span><span class="op" id="3766500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3766503">}</span>&nbsp;<span class="keyword" id="3766505">else</span>&nbsp;<span class="op" id="3766510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3766514">go</span>&nbsp;<span class="keyword" id="3766517">func</span><span class="op" id="3766521">(</span><span class="op" id="3766522">)</span>&nbsp;<span class="op" id="3766524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3766529">errChannel</span>&nbsp;<span class="op" id="3766540">&lt;-</span>&nbsp;<span class="ident" id="3766543">conn</span><span class="op" id="3766547">.</span><span class="ident" id="3766548">Handshake</span><span class="op" id="3766557">(</span><span class="op" id="3766558">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3766562">}</span><span class="op" id="3766563">(</span><span class="op" id="3766564">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3766569">err</span>&nbsp;<span class="op" id="3766573">=</span>&nbsp;<span class="op" id="3766575">&lt;-</span><span class="ident" id="3766577">errChannel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3766589">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3766593">if</span>&nbsp;<span class="ident" id="3766596">err</span>&nbsp;<span class="op" id="3766600">!=</span>&nbsp;<span class="ident" id="3766603">nil</span>&nbsp;<span class="op" id="3766607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3766611">rawConn</span><span class="op" id="3766618">.</span><span class="ident" id="3766619">Close</span><span class="op" id="3766624">(</span><span class="op" id="3766625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3766629">return</span>&nbsp;<span class="ident" id="3766636">nil</span><span class="op" id="3766639">,</span>&nbsp;<span class="ident" id="3766641">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3766646">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3766650">return</span>&nbsp;<span class="ident" id="3766657">conn</span><span class="op" id="3766661">,</span>&nbsp;<span class="ident" id="3766663">nil</span><br>
<span class="lineno"></span><span class="op" id="3766667">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3766670">//&nbsp;Dial&nbsp;connects&nbsp;to&nbsp;the&nbsp;given&nbsp;network&nbsp;address&nbsp;using&nbsp;net.Dial</span><br>
<span class="lineno"></span><span class="comment" id="3766731">//&nbsp;and&nbsp;then&nbsp;initiates&nbsp;a&nbsp;TLS&nbsp;handshake,&nbsp;returning&nbsp;the&nbsp;resulting</span><br>
<span class="lineno">160</span><span class="comment" id="3766794">//&nbsp;TLS&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3766813">//&nbsp;Dial&nbsp;interprets&nbsp;a&nbsp;nil&nbsp;configuration&nbsp;as&nbsp;equivalent&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3766869">//&nbsp;the&nbsp;zero&nbsp;configuration;&nbsp;see&nbsp;the&nbsp;documentation&nbsp;of&nbsp;Config</span><br>
<span class="lineno"></span><span class="comment" id="3766928">//&nbsp;for&nbsp;the&nbsp;defaults.</span><br>
<span class="lineno"></span><span class="keyword" id="3766949">func</span>&nbsp;<span class="ident" id="3766954">Dial</span><span class="op" id="3766958">(</span><span class="ident" id="3766959">network</span><span class="op" id="3766966">,</span>&nbsp;<span class="ident" id="3766968">addr</span>&nbsp;<span class="builtintype" id="3766973">string</span><span class="op" id="3766979">,</span>&nbsp;<span class="ident" id="3766981">config</span>&nbsp;<span class="op" id="3766988">*</span><span class="ident" id="3766989">Config</span><span class="op" id="3766995">)</span>&nbsp;<span class="op" id="3766997">(</span><span class="op" id="3766998">*</span><span class="ident" id="3766999">Conn</span><span class="op" id="3767003">,</span>&nbsp;<span class="builtintype" id="3767005">error</span><span class="op" id="3767010">)</span>&nbsp;<span class="op" id="3767012">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3767015">return</span>&nbsp;<span class="ident" id="3767022">DialWithDialer</span><span class="op" id="3767036">(</span><span class="builtinfunc" id="3767037">new</span><span class="op" id="3767040">(</span><span class="ident" id="3767041">net</span><span class="op" id="3767044">.</span><span class="ident" id="3767045">Dialer</span><span class="op" id="3767051">)</span><span class="op" id="3767052">,</span>&nbsp;<span class="ident" id="3767054">network</span><span class="op" id="3767061">,</span>&nbsp;<span class="ident" id="3767063">addr</span><span class="op" id="3767067">,</span>&nbsp;<span class="ident" id="3767069">config</span><span class="op" id="3767075">)</span><br>
<span class="lineno"></span><span class="op" id="3767077">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3767080">//&nbsp;LoadX509KeyPair&nbsp;reads&nbsp;and&nbsp;parses&nbsp;a&nbsp;public/private&nbsp;key&nbsp;pair&nbsp;from&nbsp;a&nbsp;pair&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3767157">//&nbsp;files.&nbsp;The&nbsp;files&nbsp;must&nbsp;contain&nbsp;PEM&nbsp;encoded&nbsp;data.</span><br>
<span class="lineno">170</span><span class="keyword" id="3767208">func</span>&nbsp;<span class="ident" id="3767213">LoadX509KeyPair</span><span class="op" id="3767228">(</span><span class="ident" id="3767229">certFile</span><span class="op" id="3767237">,</span>&nbsp;<span class="ident" id="3767239">keyFile</span>&nbsp;<span class="builtintype" id="3767247">string</span><span class="op" id="3767253">)</span>&nbsp;<span class="op" id="3767255">(</span><span class="ident" id="3767256">cert</span>&nbsp;<span class="ident" id="3767261">Certificate</span><span class="op" id="3767272">,</span>&nbsp;<span class="ident" id="3767274">err</span>&nbsp;<span class="builtintype" id="3767278">error</span><span class="op" id="3767283">)</span>&nbsp;<span class="op" id="3767285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3767288">certPEMBlock</span><span class="op" id="3767300">,</span>&nbsp;<span class="ident" id="3767302">err</span>&nbsp;<span class="op" id="3767306">:=</span>&nbsp;<span class="ident" id="3767309">ioutil</span><span class="op" id="3767315">.</span><span class="ident" id="3767316">ReadFile</span><span class="op" id="3767324">(</span><span class="ident" id="3767325">certFile</span><span class="op" id="3767333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3767336">if</span>&nbsp;<span class="ident" id="3767339">err</span>&nbsp;<span class="op" id="3767343">!=</span>&nbsp;<span class="ident" id="3767346">nil</span>&nbsp;<span class="op" id="3767350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3767354">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3767362">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3767365">keyPEMBlock</span><span class="op" id="3767376">,</span>&nbsp;<span class="ident" id="3767378">err</span>&nbsp;<span class="op" id="3767382">:=</span>&nbsp;<span class="ident" id="3767385">ioutil</span><span class="op" id="3767391">.</span><span class="ident" id="3767392">ReadFile</span><span class="op" id="3767400">(</span><span class="ident" id="3767401">keyFile</span><span class="op" id="3767408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3767411">if</span>&nbsp;<span class="ident" id="3767414">err</span>&nbsp;<span class="op" id="3767418">!=</span>&nbsp;<span class="ident" id="3767421">nil</span>&nbsp;<span class="op" id="3767425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3767429">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3767437">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3767440">return</span>&nbsp;<span class="ident" id="3767447">X509KeyPair</span><span class="op" id="3767458">(</span><span class="ident" id="3767459">certPEMBlock</span><span class="op" id="3767471">,</span>&nbsp;<span class="ident" id="3767473">keyPEMBlock</span><span class="op" id="3767484">)</span><br>
<span class="lineno">180</span><span class="op" id="3767486">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3767489">//&nbsp;X509KeyPair&nbsp;parses&nbsp;a&nbsp;public/private&nbsp;key&nbsp;pair&nbsp;from&nbsp;a&nbsp;pair&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3767552">//&nbsp;PEM&nbsp;encoded&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="3767573">func</span>&nbsp;<span class="ident" id="3767578">X509KeyPair</span><span class="op" id="3767589">(</span><span class="ident" id="3767590">certPEMBlock</span><span class="op" id="3767602">,</span>&nbsp;<span class="ident" id="3767604">keyPEMBlock</span>&nbsp;<span class="op" id="3767616">[</span><span class="op" id="3767617">]</span><span class="builtintype" id="3767618">byte</span><span class="op" id="3767622">)</span>&nbsp;<span class="op" id="3767624">(</span><span class="ident" id="3767625">cert</span>&nbsp;<span class="ident" id="3767630">Certificate</span><span class="op" id="3767641">,</span>&nbsp;<span class="ident" id="3767643">err</span>&nbsp;<span class="builtintype" id="3767647">error</span><span class="op" id="3767652">)</span>&nbsp;<span class="op" id="3767654">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3767657">var</span>&nbsp;<span class="ident" id="3767661">certDERBlock</span>&nbsp;<span class="op" id="3767674">*</span><span class="ident" id="3767675">pem</span><span class="op" id="3767678">.</span><span class="ident" id="3767679">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3767686">for</span>&nbsp;<span class="op" id="3767690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3767694">certDERBlock</span><span class="op" id="3767706">,</span>&nbsp;<span class="ident" id="3767708">certPEMBlock</span>&nbsp;<span class="op" id="3767721">=</span>&nbsp;<span class="ident" id="3767723">pem</span><span class="op" id="3767726">.</span><span class="ident" id="3767727">Decode</span><span class="op" id="3767733">(</span><span class="ident" id="3767734">certPEMBlock</span><span class="op" id="3767746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3767750">if</span>&nbsp;<span class="ident" id="3767753">certDERBlock</span>&nbsp;<span class="op" id="3767766">==</span>&nbsp;<span class="ident" id="3767769">nil</span>&nbsp;<span class="op" id="3767773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3767778">break</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3767786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3767790">if</span>&nbsp;<span class="ident" id="3767793">certDERBlock</span><span class="op" id="3767805">.</span><span class="ident" id="3767806">Type</span>&nbsp;<span class="op" id="3767811">==</span>&nbsp;<span class="string" id="3767814">&#34;CERTIFICATE&#34;</span>&nbsp;<span class="op" id="3767828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3767833">cert</span><span class="op" id="3767837">.</span><span class="ident" id="3767838">Certificate</span>&nbsp;<span class="op" id="3767850">=</span>&nbsp;<span class="builtinfunc" id="3767852">append</span><span class="op" id="3767858">(</span><span class="ident" id="3767859">cert</span><span class="op" id="3767863">.</span><span class="ident" id="3767864">Certificate</span><span class="op" id="3767875">,</span>&nbsp;<span class="ident" id="3767877">certDERBlock</span><span class="op" id="3767889">.</span><span class="ident" id="3767890">Bytes</span><span class="op" id="3767895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3767899">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3767902">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3767906">if</span>&nbsp;<span class="builtinfunc" id="3767909">len</span><span class="op" id="3767912">(</span><span class="ident" id="3767913">cert</span><span class="op" id="3767917">.</span><span class="ident" id="3767918">Certificate</span><span class="op" id="3767929">)</span>&nbsp;<span class="op" id="3767931">==</span>&nbsp;<span class="num" id="3767934">0</span>&nbsp;<span class="op" id="3767936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3767940">err</span>&nbsp;<span class="op" id="3767944">=</span>&nbsp;<span class="ident" id="3767946">errors</span><span class="op" id="3767952">.</span><span class="ident" id="3767953">New</span><span class="op" id="3767956">(</span><span class="string" id="3767957">&#34;crypto/tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;certificate&nbsp;PEM&nbsp;data&#34;</span><span class="op" id="3768007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3768011">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3768019">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3768023">var</span>&nbsp;<span class="ident" id="3768027">keyDERBlock</span>&nbsp;<span class="op" id="3768039">*</span><span class="ident" id="3768040">pem</span><span class="op" id="3768043">.</span><span class="ident" id="3768044">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3768051">for</span>&nbsp;<span class="op" id="3768055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3768059">keyDERBlock</span><span class="op" id="3768070">,</span>&nbsp;<span class="ident" id="3768072">keyPEMBlock</span>&nbsp;<span class="op" id="3768084">=</span>&nbsp;<span class="ident" id="3768086">pem</span><span class="op" id="3768089">.</span><span class="ident" id="3768090">Decode</span><span class="op" id="3768096">(</span><span class="ident" id="3768097">keyPEMBlock</span><span class="op" id="3768108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3768112">if</span>&nbsp;<span class="ident" id="3768115">keyDERBlock</span>&nbsp;<span class="op" id="3768127">==</span>&nbsp;<span class="ident" id="3768130">nil</span>&nbsp;<span class="op" id="3768134">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3768139">err</span>&nbsp;<span class="op" id="3768143">=</span>&nbsp;<span class="ident" id="3768145">errors</span><span class="op" id="3768151">.</span><span class="ident" id="3768152">New</span><span class="op" id="3768155">(</span><span class="string" id="3768156">&#34;crypto/tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;key&nbsp;PEM&nbsp;data&#34;</span><span class="op" id="3768198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3768203">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3768212">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3768216">if</span>&nbsp;<span class="ident" id="3768219">keyDERBlock</span><span class="op" id="3768230">.</span><span class="ident" id="3768231">Type</span>&nbsp;<span class="op" id="3768236">==</span>&nbsp;<span class="string" id="3768239">&#34;PRIVATE&nbsp;KEY&#34;</span>&nbsp;<span class="op" id="3768253">||</span>&nbsp;<span class="ident" id="3768256">strings</span><span class="op" id="3768263">.</span><span class="ident" id="3768264">HasSuffix</span><span class="op" id="3768273">(</span><span class="ident" id="3768274">keyDERBlock</span><span class="op" id="3768285">.</span><span class="ident" id="3768286">Type</span><span class="op" id="3768290">,</span>&nbsp;<span class="string" id="3768292">&#34;&nbsp;PRIVATE&nbsp;KEY&#34;</span><span class="op" id="3768306">)</span>&nbsp;<span class="op" id="3768308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3768313">break</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3768321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3768324">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3768328">cert</span><span class="op" id="3768332">.</span><span class="ident" id="3768333">PrivateKey</span><span class="op" id="3768343">,</span>&nbsp;<span class="ident" id="3768345">err</span>&nbsp;<span class="op" id="3768349">=</span>&nbsp;<span class="ident" id="3768351">parsePrivateKey</span><span class="op" id="3768366">(</span><span class="ident" id="3768367">keyDERBlock</span><span class="op" id="3768378">.</span><span class="ident" id="3768379">Bytes</span><span class="op" id="3768384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3768387">if</span>&nbsp;<span class="ident" id="3768390">err</span>&nbsp;<span class="op" id="3768394">!=</span>&nbsp;<span class="ident" id="3768397">nil</span>&nbsp;<span class="op" id="3768401">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3768405">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3768413">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3768417">//&nbsp;We&nbsp;don&#39;t&nbsp;need&nbsp;to&nbsp;parse&nbsp;the&nbsp;public&nbsp;key&nbsp;for&nbsp;TLS,&nbsp;but&nbsp;we&nbsp;so&nbsp;do&nbsp;anyway</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3768488">//&nbsp;to&nbsp;check&nbsp;that&nbsp;it&nbsp;looks&nbsp;sane&nbsp;and&nbsp;matches&nbsp;the&nbsp;private&nbsp;key.</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3768549">x509Cert</span><span class="op" id="3768557">,</span>&nbsp;<span class="ident" id="3768559">err</span>&nbsp;<span class="op" id="3768563">:=</span>&nbsp;<span class="ident" id="3768566">x509</span><span class="op" id="3768570">.</span><span class="ident" id="3768571">ParseCertificate</span><span class="op" id="3768587">(</span><span class="ident" id="3768588">cert</span><span class="op" id="3768592">.</span><span class="ident" id="3768593">Certificate</span><span class="op" id="3768604">[</span><span class="num" id="3768605">0</span><span class="op" id="3768606">]</span><span class="op" id="3768607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3768610">if</span>&nbsp;<span class="ident" id="3768613">err</span>&nbsp;<span class="op" id="3768617">!=</span>&nbsp;<span class="ident" id="3768620">nil</span>&nbsp;<span class="op" id="3768624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3768628">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3768636">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3768640">switch</span>&nbsp;<span class="ident" id="3768647">pub</span>&nbsp;<span class="op" id="3768651">:=</span>&nbsp;<span class="ident" id="3768654">x509Cert</span><span class="op" id="3768662">.</span><span class="ident" id="3768663">PublicKey</span><span class="op" id="3768672">.</span><span class="op" id="3768673">(</span><span class="keyword" id="3768674">type</span><span class="op" id="3768678">)</span>&nbsp;<span class="op" id="3768680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3768683">case</span>&nbsp;<span class="op" id="3768688">*</span><span class="ident" id="3768689">rsa</span><span class="op" id="3768692">.</span><span class="ident" id="3768693">PublicKey</span><span class="op" id="3768702">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3768706">priv</span><span class="op" id="3768710">,</span>&nbsp;<span class="ident" id="3768712">ok</span>&nbsp;<span class="op" id="3768715">:=</span>&nbsp;<span class="ident" id="3768718">cert</span><span class="op" id="3768722">.</span><span class="ident" id="3768723">PrivateKey</span><span class="op" id="3768733">.</span><span class="op" id="3768734">(</span><span class="op" id="3768735">*</span><span class="ident" id="3768736">rsa</span><span class="op" id="3768739">.</span><span class="ident" id="3768740">PrivateKey</span><span class="op" id="3768750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3768754">if</span>&nbsp;<span class="op" id="3768757">!</span><span class="ident" id="3768758">ok</span>&nbsp;<span class="op" id="3768761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3768766">err</span>&nbsp;<span class="op" id="3768770">=</span>&nbsp;<span class="ident" id="3768772">errors</span><span class="op" id="3768778">.</span><span class="ident" id="3768779">New</span><span class="op" id="3768782">(</span><span class="string" id="3768783">&#34;crypto/tls:&nbsp;private&nbsp;key&nbsp;type&nbsp;does&nbsp;not&nbsp;match&nbsp;public&nbsp;key&nbsp;type&#34;</span><span class="op" id="3768844">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3768849">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3768858">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3768862">if</span>&nbsp;<span class="ident" id="3768865">pub</span><span class="op" id="3768868">.</span><span class="ident" id="3768869">N</span><span class="op" id="3768870">.</span><span class="ident" id="3768871">Cmp</span><span class="op" id="3768874">(</span><span class="ident" id="3768875">priv</span><span class="op" id="3768879">.</span><span class="ident" id="3768880">N</span><span class="op" id="3768881">)</span>&nbsp;<span class="op" id="3768883">!=</span>&nbsp;<span class="num" id="3768886">0</span>&nbsp;<span class="op" id="3768888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3768893">err</span>&nbsp;<span class="op" id="3768897">=</span>&nbsp;<span class="ident" id="3768899">errors</span><span class="op" id="3768905">.</span><span class="ident" id="3768906">New</span><span class="op" id="3768909">(</span><span class="string" id="3768910">&#34;crypto/tls:&nbsp;private&nbsp;key&nbsp;does&nbsp;not&nbsp;match&nbsp;public&nbsp;key&#34;</span><span class="op" id="3768961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3768966">return</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3768975">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3768978">case</span>&nbsp;<span class="op" id="3768983">*</span><span class="ident" id="3768984">ecdsa</span><span class="op" id="3768989">.</span><span class="ident" id="3768990">PublicKey</span><span class="op" id="3768999">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3769003">priv</span><span class="op" id="3769007">,</span>&nbsp;<span class="ident" id="3769009">ok</span>&nbsp;<span class="op" id="3769012">:=</span>&nbsp;<span class="ident" id="3769015">cert</span><span class="op" id="3769019">.</span><span class="ident" id="3769020">PrivateKey</span><span class="op" id="3769030">.</span><span class="op" id="3769031">(</span><span class="op" id="3769032">*</span><span class="ident" id="3769033">ecdsa</span><span class="op" id="3769038">.</span><span class="ident" id="3769039">PrivateKey</span><span class="op" id="3769049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3769053">if</span>&nbsp;<span class="op" id="3769056">!</span><span class="ident" id="3769057">ok</span>&nbsp;<span class="op" id="3769060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3769065">err</span>&nbsp;<span class="op" id="3769069">=</span>&nbsp;<span class="ident" id="3769071">errors</span><span class="op" id="3769077">.</span><span class="ident" id="3769078">New</span><span class="op" id="3769081">(</span><span class="string" id="3769082">&#34;crypto/tls:&nbsp;private&nbsp;key&nbsp;type&nbsp;does&nbsp;not&nbsp;match&nbsp;public&nbsp;key&nbsp;type&#34;</span><span class="op" id="3769143">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3769148">return</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3769158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3769162">if</span>&nbsp;<span class="ident" id="3769165">pub</span><span class="op" id="3769168">.</span><span class="ident" id="3769169">X</span><span class="op" id="3769170">.</span><span class="ident" id="3769171">Cmp</span><span class="op" id="3769174">(</span><span class="ident" id="3769175">priv</span><span class="op" id="3769179">.</span><span class="ident" id="3769180">X</span><span class="op" id="3769181">)</span>&nbsp;<span class="op" id="3769183">!=</span>&nbsp;<span class="num" id="3769186">0</span>&nbsp;<span class="op" id="3769188">||</span>&nbsp;<span class="ident" id="3769191">pub</span><span class="op" id="3769194">.</span><span class="ident" id="3769195">Y</span><span class="op" id="3769196">.</span><span class="ident" id="3769197">Cmp</span><span class="op" id="3769200">(</span><span class="ident" id="3769201">priv</span><span class="op" id="3769205">.</span><span class="ident" id="3769206">Y</span><span class="op" id="3769207">)</span>&nbsp;<span class="op" id="3769209">!=</span>&nbsp;<span class="num" id="3769212">0</span>&nbsp;<span class="op" id="3769214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3769219">err</span>&nbsp;<span class="op" id="3769223">=</span>&nbsp;<span class="ident" id="3769225">errors</span><span class="op" id="3769231">.</span><span class="ident" id="3769232">New</span><span class="op" id="3769235">(</span><span class="string" id="3769236">&#34;crypto/tls:&nbsp;private&nbsp;key&nbsp;does&nbsp;not&nbsp;match&nbsp;public&nbsp;key&#34;</span><span class="op" id="3769287">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3769292">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3769301">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3769304">default</span><span class="op" id="3769311">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3769315">err</span>&nbsp;<span class="op" id="3769319">=</span>&nbsp;<span class="ident" id="3769321">errors</span><span class="op" id="3769327">.</span><span class="ident" id="3769328">New</span><span class="op" id="3769331">(</span><span class="string" id="3769332">&#34;crypto/tls:&nbsp;unknown&nbsp;public&nbsp;key&nbsp;algorithm&#34;</span><span class="op" id="3769374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3769378">return</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3769386">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3769390">return</span><br>
<span class="lineno"></span><span class="op" id="3769397">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="comment" id="3769400">//&nbsp;Attempt&nbsp;to&nbsp;parse&nbsp;the&nbsp;given&nbsp;private&nbsp;key&nbsp;DER&nbsp;block.&nbsp;OpenSSL&nbsp;0.9.8&nbsp;generates</span><br>
<span class="lineno"></span><span class="comment" id="3769477">//&nbsp;PKCS#1&nbsp;private&nbsp;keys&nbsp;by&nbsp;default,&nbsp;while&nbsp;OpenSSL&nbsp;1.0.0&nbsp;generates&nbsp;PKCS#8&nbsp;keys.</span><br>
<span class="lineno"></span><span class="comment" id="3769555">//&nbsp;OpenSSL&nbsp;ecparam&nbsp;generates&nbsp;SEC1&nbsp;EC&nbsp;private&nbsp;keys&nbsp;for&nbsp;ECDSA.&nbsp;We&nbsp;try&nbsp;all&nbsp;three.</span><br>
<span class="lineno"></span><span class="keyword" id="3769634">func</span>&nbsp;<span class="ident" id="3769639">parsePrivateKey</span><span class="op" id="3769654">(</span><span class="ident" id="3769655">der</span>&nbsp;<span class="op" id="3769659">[</span><span class="op" id="3769660">]</span><span class="builtintype" id="3769661">byte</span><span class="op" id="3769665">)</span>&nbsp;<span class="op" id="3769667">(</span><span class="ident" id="3769668">crypto</span><span class="op" id="3769674">.</span><span class="ident" id="3769675">PrivateKey</span><span class="op" id="3769685">,</span>&nbsp;<span class="builtintype" id="3769687">error</span><span class="op" id="3769692">)</span>&nbsp;<span class="op" id="3769694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3769697">if</span>&nbsp;<span class="ident" id="3769700">key</span><span class="op" id="3769703">,</span>&nbsp;<span class="ident" id="3769705">err</span>&nbsp;<span class="op" id="3769709">:=</span>&nbsp;<span class="ident" id="3769712">x509</span><span class="op" id="3769716">.</span><span class="ident" id="3769717">ParsePKCS1PrivateKey</span><span class="op" id="3769737">(</span><span class="ident" id="3769738">der</span><span class="op" id="3769741">)</span><span class="op" id="3769742">;</span>&nbsp;<span class="ident" id="3769744">err</span>&nbsp;<span class="op" id="3769748">==</span>&nbsp;<span class="ident" id="3769751">nil</span>&nbsp;<span class="op" id="3769755">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3769759">return</span>&nbsp;<span class="ident" id="3769766">key</span><span class="op" id="3769769">,</span>&nbsp;<span class="ident" id="3769771">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3769776">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3769779">if</span>&nbsp;<span class="ident" id="3769782">key</span><span class="op" id="3769785">,</span>&nbsp;<span class="ident" id="3769787">err</span>&nbsp;<span class="op" id="3769791">:=</span>&nbsp;<span class="ident" id="3769794">x509</span><span class="op" id="3769798">.</span><span class="ident" id="3769799">ParsePKCS8PrivateKey</span><span class="op" id="3769819">(</span><span class="ident" id="3769820">der</span><span class="op" id="3769823">)</span><span class="op" id="3769824">;</span>&nbsp;<span class="ident" id="3769826">err</span>&nbsp;<span class="op" id="3769830">==</span>&nbsp;<span class="ident" id="3769833">nil</span>&nbsp;<span class="op" id="3769837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3769841">switch</span>&nbsp;<span class="ident" id="3769848">key</span>&nbsp;<span class="op" id="3769852">:=</span>&nbsp;<span class="ident" id="3769855">key</span><span class="op" id="3769858">.</span><span class="op" id="3769859">(</span><span class="keyword" id="3769860">type</span><span class="op" id="3769864">)</span>&nbsp;<span class="op" id="3769866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3769870">case</span>&nbsp;<span class="op" id="3769875">*</span><span class="ident" id="3769876">rsa</span><span class="op" id="3769879">.</span><span class="ident" id="3769880">PrivateKey</span><span class="op" id="3769890">,</span>&nbsp;<span class="op" id="3769892">*</span><span class="ident" id="3769893">ecdsa</span><span class="op" id="3769898">.</span><span class="ident" id="3769899">PrivateKey</span><span class="op" id="3769909">:</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3769914">return</span>&nbsp;<span class="ident" id="3769921">key</span><span class="op" id="3769924">,</span>&nbsp;<span class="ident" id="3769926">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3769932">default</span><span class="op" id="3769939">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3769944">return</span>&nbsp;<span class="ident" id="3769951">nil</span><span class="op" id="3769954">,</span>&nbsp;<span class="ident" id="3769956">errors</span><span class="op" id="3769962">.</span><span class="ident" id="3769963">New</span><span class="op" id="3769966">(</span><span class="string" id="3769967">&#34;crypto/tls:&nbsp;found&nbsp;unknown&nbsp;private&nbsp;key&nbsp;type&nbsp;in&nbsp;PKCS#8&nbsp;wrapping&#34;</span><span class="op" id="3770030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3770034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3770037">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3770040">if</span>&nbsp;<span class="ident" id="3770043">key</span><span class="op" id="3770046">,</span>&nbsp;<span class="ident" id="3770048">err</span>&nbsp;<span class="op" id="3770052">:=</span>&nbsp;<span class="ident" id="3770055">x509</span><span class="op" id="3770059">.</span><span class="ident" id="3770060">ParseECPrivateKey</span><span class="op" id="3770077">(</span><span class="ident" id="3770078">der</span><span class="op" id="3770081">)</span><span class="op" id="3770082">;</span>&nbsp;<span class="ident" id="3770084">err</span>&nbsp;<span class="op" id="3770088">==</span>&nbsp;<span class="ident" id="3770091">nil</span>&nbsp;<span class="op" id="3770095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3770099">return</span>&nbsp;<span class="ident" id="3770106">key</span><span class="op" id="3770109">,</span>&nbsp;<span class="ident" id="3770111">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3770116">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3770120">return</span>&nbsp;<span class="ident" id="3770127">nil</span><span class="op" id="3770130">,</span>&nbsp;<span class="ident" id="3770132">errors</span><span class="op" id="3770138">.</span><span class="ident" id="3770139">New</span><span class="op" id="3770142">(</span><span class="string" id="3770143">&#34;crypto/tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;private&nbsp;key&#34;</span><span class="op" id="3770184">)</span><br>
<span class="lineno">275</span><span class="op" id="3770186">}</span>
</div>
</body>
</html>
