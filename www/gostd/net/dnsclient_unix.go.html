<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3131074">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3131129">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3131183">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3131234">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3131299">//&nbsp;DNS&nbsp;client:&nbsp;see&nbsp;RFC&nbsp;1035.</span><br>
<span class="lineno"></span><span class="comment" id="3131328">//&nbsp;Has&nbsp;to&nbsp;be&nbsp;linked&nbsp;into&nbsp;package&nbsp;net&nbsp;for&nbsp;Dial.</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="3131376">//&nbsp;TODO(rsc):</span><br>
<span class="lineno"></span><span class="comment" id="3131390">//&nbsp;&nbsp;&nbsp;&nbspCould&nbsp;potentially&nbsp;handle&nbsp;many&nbsp;outstanding&nbsp;lookups&nbsp;faster.</span><br>
<span class="lineno"></span><span class="comment" id="3131451">//&nbsp;&nbsp;&nbsp;&nbspCould&nbsp;have&nbsp;a&nbsp;small&nbsp;cache.</span><br>
<span class="lineno"></span><span class="comment" id="3131480">//&nbsp;&nbsp;&nbsp;&nbspRandom&nbsp;UDP&nbsp;source&nbsp;port&nbsp;(net.Dial&nbsp;should&nbsp;do&nbsp;that&nbsp;for&nbsp;us).</span><br>
<span class="lineno"></span><span class="comment" id="3131540">//&nbsp;&nbsp;&nbsp;&nbspRandom&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="3131564">package</span>&nbsp;<span class="ident" id="3131572">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3131577">import</span>&nbsp;<span class="op" id="3131584">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3131587">&#34;errors&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3131597">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3131603">&#34;math/rand&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3131616">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3131622">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3131630">&#34;time&#34;</span><br>
<span class="lineno">25</span><span class="op" id="3131637">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3131640">//&nbsp;A&nbsp;dnsConn&nbsp;represents&nbsp;a&nbsp;DNS&nbsp;transport&nbsp;endpoint.</span><br>
<span class="lineno"></span><span class="keyword" id="3131690">type</span>&nbsp;<span class="ident" id="3131695">dnsConn</span>&nbsp;<span class="keyword" id="3131703">interface</span>&nbsp;<span class="op" id="3131713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3131716">Conn</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3131723">//&nbsp;readDNSResponse&nbsp;reads&nbsp;a&nbsp;DNS&nbsp;response&nbsp;message&nbsp;from&nbsp;the&nbsp;DNS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3131785">//&nbsp;transport&nbsp;endpoint&nbsp;and&nbsp;returns&nbsp;the&nbsp;received&nbsp;DNS&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3131846">//&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3131859">readDNSResponse</span><span class="op" id="3131874">(</span><span class="op" id="3131875">)</span>&nbsp;<span class="op" id="3131877">(</span><span class="op" id="3131878">*</span><span class="ident" id="3131879">dnsMsg</span><span class="op" id="3131885">,</span>&nbsp;<span class="builtintype" id="3131887">error</span><span class="op" id="3131892">)</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3131896">//&nbsp;writeDNSQuery&nbsp;writes&nbsp;a&nbsp;DNS&nbsp;query&nbsp;message&nbsp;to&nbsp;the&nbsp;DNS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3131952">//&nbsp;connection&nbsp;endpoint.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3131977">writeDNSQuery</span><span class="op" id="3131990">(</span><span class="op" id="3131991">*</span><span class="ident" id="3131992">dnsMsg</span><span class="op" id="3131998">)</span>&nbsp;<span class="builtintype" id="3132000">error</span><br>
<span class="lineno"></span><span class="op" id="3132006">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="keyword" id="3132009">func</span>&nbsp;<span class="op" id="3132014">(</span><span class="ident" id="3132015">c</span>&nbsp;<span class="op" id="3132017">*</span><span class="ident" id="3132018">UDPConn</span><span class="op" id="3132025">)</span>&nbsp;<span class="ident" id="3132027">readDNSResponse</span><span class="op" id="3132042">(</span><span class="op" id="3132043">)</span>&nbsp;<span class="op" id="3132045">(</span><span class="op" id="3132046">*</span><span class="ident" id="3132047">dnsMsg</span><span class="op" id="3132053">,</span>&nbsp;<span class="builtintype" id="3132055">error</span><span class="op" id="3132060">)</span>&nbsp;<span class="op" id="3132062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3132065">b</span>&nbsp;<span class="op" id="3132067">:=</span>&nbsp;<span class="builtinfunc" id="3132070">make</span><span class="op" id="3132074">(</span><span class="op" id="3132075">[</span><span class="op" id="3132076">]</span><span class="builtintype" id="3132077">byte</span><span class="op" id="3132081">,</span>&nbsp;<span class="num" id="3132083">512</span><span class="op" id="3132086">)</span>&nbsp;<span class="comment" id="3132088">//&nbsp;see&nbsp;RFC&nbsp;1035</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3132105">n</span><span class="op" id="3132106">,</span>&nbsp;<span class="ident" id="3132108">err</span>&nbsp;<span class="op" id="3132112">:=</span>&nbsp;<span class="ident" id="3132115">c</span><span class="op" id="3132116">.</span><span class="ident" id="3132117">Read</span><span class="op" id="3132121">(</span><span class="ident" id="3132122">b</span><span class="op" id="3132123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3132126">if</span>&nbsp;<span class="ident" id="3132129">err</span>&nbsp;<span class="op" id="3132133">!=</span>&nbsp;<span class="ident" id="3132136">nil</span>&nbsp;<span class="op" id="3132140">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3132144">return</span>&nbsp;<span class="ident" id="3132151">nil</span><span class="op" id="3132154">,</span>&nbsp;<span class="ident" id="3132156">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3132161">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3132164">msg</span>&nbsp;<span class="op" id="3132168">:=</span>&nbsp;<span class="op" id="3132171">&amp;</span><span class="ident" id="3132172">dnsMsg</span><span class="op" id="3132178">{</span><span class="op" id="3132179">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3132182">if</span>&nbsp;<span class="op" id="3132185">!</span><span class="ident" id="3132186">msg</span><span class="op" id="3132189">.</span><span class="ident" id="3132190">Unpack</span><span class="op" id="3132196">(</span><span class="ident" id="3132197">b</span><span class="op" id="3132198">[</span><span class="op" id="3132199">:</span><span class="ident" id="3132200">n</span><span class="op" id="3132201">]</span><span class="op" id="3132202">)</span>&nbsp;<span class="op" id="3132204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3132208">return</span>&nbsp;<span class="ident" id="3132215">nil</span><span class="op" id="3132218">,</span>&nbsp;<span class="ident" id="3132220">errors</span><span class="op" id="3132226">.</span><span class="ident" id="3132227">New</span><span class="op" id="3132230">(</span><span class="string" id="3132231">&#34;cannot&nbsp;unmarshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="3132261">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3132264">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3132267">return</span>&nbsp;<span class="ident" id="3132274">msg</span><span class="op" id="3132277">,</span>&nbsp;<span class="ident" id="3132279">nil</span><br>
<span class="lineno"></span><span class="op" id="3132283">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3132286">func</span>&nbsp;<span class="op" id="3132291">(</span><span class="ident" id="3132292">c</span>&nbsp;<span class="op" id="3132294">*</span><span class="ident" id="3132295">UDPConn</span><span class="op" id="3132302">)</span>&nbsp;<span class="ident" id="3132304">writeDNSQuery</span><span class="op" id="3132317">(</span><span class="ident" id="3132318">msg</span>&nbsp;<span class="op" id="3132322">*</span><span class="ident" id="3132323">dnsMsg</span><span class="op" id="3132329">)</span>&nbsp;<span class="builtintype" id="3132331">error</span>&nbsp;<span class="op" id="3132337">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3132340">b</span><span class="op" id="3132341">,</span>&nbsp;<span class="ident" id="3132343">ok</span>&nbsp;<span class="op" id="3132346">:=</span>&nbsp;<span class="ident" id="3132349">msg</span><span class="op" id="3132352">.</span><span class="ident" id="3132353">Pack</span><span class="op" id="3132357">(</span><span class="op" id="3132358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3132361">if</span>&nbsp;<span class="op" id="3132364">!</span><span class="ident" id="3132365">ok</span>&nbsp;<span class="op" id="3132368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3132372">return</span>&nbsp;<span class="ident" id="3132379">errors</span><span class="op" id="3132385">.</span><span class="ident" id="3132386">New</span><span class="op" id="3132389">(</span><span class="string" id="3132390">&#34;cannot&nbsp;marshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="3132418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3132421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3132424">if</span>&nbsp;<span class="ident" id="3132427">_</span><span class="op" id="3132428">,</span>&nbsp;<span class="ident" id="3132430">err</span>&nbsp;<span class="op" id="3132434">:=</span>&nbsp;<span class="ident" id="3132437">c</span><span class="op" id="3132438">.</span><span class="ident" id="3132439">Write</span><span class="op" id="3132444">(</span><span class="ident" id="3132445">b</span><span class="op" id="3132446">)</span><span class="op" id="3132447">;</span>&nbsp;<span class="ident" id="3132449">err</span>&nbsp;<span class="op" id="3132453">!=</span>&nbsp;<span class="ident" id="3132456">nil</span>&nbsp;<span class="op" id="3132460">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3132464">return</span>&nbsp;<span class="ident" id="3132471">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3132476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3132479">return</span>&nbsp;<span class="ident" id="3132486">nil</span><br>
<span class="lineno"></span><span class="op" id="3132490">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="keyword" id="3132493">func</span>&nbsp;<span class="op" id="3132498">(</span><span class="ident" id="3132499">c</span>&nbsp;<span class="op" id="3132501">*</span><span class="ident" id="3132502">TCPConn</span><span class="op" id="3132509">)</span>&nbsp;<span class="ident" id="3132511">readDNSResponse</span><span class="op" id="3132526">(</span><span class="op" id="3132527">)</span>&nbsp;<span class="op" id="3132529">(</span><span class="op" id="3132530">*</span><span class="ident" id="3132531">dnsMsg</span><span class="op" id="3132537">,</span>&nbsp;<span class="builtintype" id="3132539">error</span><span class="op" id="3132544">)</span>&nbsp;<span class="op" id="3132546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3132549">b</span>&nbsp;<span class="op" id="3132551">:=</span>&nbsp;<span class="builtinfunc" id="3132554">make</span><span class="op" id="3132558">(</span><span class="op" id="3132559">[</span><span class="op" id="3132560">]</span><span class="builtintype" id="3132561">byte</span><span class="op" id="3132565">,</span>&nbsp;<span class="num" id="3132567">1280</span><span class="op" id="3132571">)</span>&nbsp;<span class="comment" id="3132573">//&nbsp;1280&nbsp;is&nbsp;a&nbsp;reasonable&nbsp;initial&nbsp;size&nbsp;for&nbsp;IP&nbsp;over&nbsp;Ethernet,&nbsp;see&nbsp;RFC&nbsp;4035</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3132646">if</span>&nbsp;<span class="ident" id="3132649">_</span><span class="op" id="3132650">,</span>&nbsp;<span class="ident" id="3132652">err</span>&nbsp;<span class="op" id="3132656">:=</span>&nbsp;<span class="ident" id="3132659">io</span><span class="op" id="3132661">.</span><span class="ident" id="3132662">ReadFull</span><span class="op" id="3132670">(</span><span class="ident" id="3132671">c</span><span class="op" id="3132672">,</span>&nbsp;<span class="ident" id="3132674">b</span><span class="op" id="3132675">[</span><span class="op" id="3132676">:</span><span class="num" id="3132677">2</span><span class="op" id="3132678">]</span><span class="op" id="3132679">)</span><span class="op" id="3132680">;</span>&nbsp;<span class="ident" id="3132682">err</span>&nbsp;<span class="op" id="3132686">!=</span>&nbsp;<span class="ident" id="3132689">nil</span>&nbsp;<span class="op" id="3132693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3132697">return</span>&nbsp;<span class="ident" id="3132704">nil</span><span class="op" id="3132707">,</span>&nbsp;<span class="ident" id="3132709">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3132714">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3132717">l</span>&nbsp;<span class="op" id="3132719">:=</span>&nbsp;<span class="builtintype" id="3132722">int</span><span class="op" id="3132725">(</span><span class="ident" id="3132726">b</span><span class="op" id="3132727">[</span><span class="num" id="3132728">0</span><span class="op" id="3132729">]</span><span class="op" id="3132730">)</span><span class="op" id="3132731">&lt;&lt;</span><span class="num" id="3132733">8</span>&nbsp;<span class="op" id="3132735">|</span>&nbsp;<span class="builtintype" id="3132737">int</span><span class="op" id="3132740">(</span><span class="ident" id="3132741">b</span><span class="op" id="3132742">[</span><span class="num" id="3132743">1</span><span class="op" id="3132744">]</span><span class="op" id="3132745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3132748">if</span>&nbsp;<span class="ident" id="3132751">l</span>&nbsp;<span class="op" id="3132753">&gt;</span>&nbsp;<span class="builtinfunc" id="3132755">len</span><span class="op" id="3132758">(</span><span class="ident" id="3132759">b</span><span class="op" id="3132760">)</span>&nbsp;<span class="op" id="3132762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3132766">b</span>&nbsp;<span class="op" id="3132768">=</span>&nbsp;<span class="builtinfunc" id="3132770">make</span><span class="op" id="3132774">(</span><span class="op" id="3132775">[</span><span class="op" id="3132776">]</span><span class="builtintype" id="3132777">byte</span><span class="op" id="3132781">,</span>&nbsp;<span class="ident" id="3132783">l</span><span class="op" id="3132784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3132787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3132790">n</span><span class="op" id="3132791">,</span>&nbsp;<span class="ident" id="3132793">err</span>&nbsp;<span class="op" id="3132797">:=</span>&nbsp;<span class="ident" id="3132800">io</span><span class="op" id="3132802">.</span><span class="ident" id="3132803">ReadFull</span><span class="op" id="3132811">(</span><span class="ident" id="3132812">c</span><span class="op" id="3132813">,</span>&nbsp;<span class="ident" id="3132815">b</span><span class="op" id="3132816">[</span><span class="op" id="3132817">:</span><span class="ident" id="3132818">l</span><span class="op" id="3132819">]</span><span class="op" id="3132820">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3132823">if</span>&nbsp;<span class="ident" id="3132826">err</span>&nbsp;<span class="op" id="3132830">!=</span>&nbsp;<span class="ident" id="3132833">nil</span>&nbsp;<span class="op" id="3132837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3132841">return</span>&nbsp;<span class="ident" id="3132848">nil</span><span class="op" id="3132851">,</span>&nbsp;<span class="ident" id="3132853">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3132858">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3132861">msg</span>&nbsp;<span class="op" id="3132865">:=</span>&nbsp;<span class="op" id="3132868">&amp;</span><span class="ident" id="3132869">dnsMsg</span><span class="op" id="3132875">{</span><span class="op" id="3132876">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3132879">if</span>&nbsp;<span class="op" id="3132882">!</span><span class="ident" id="3132883">msg</span><span class="op" id="3132886">.</span><span class="ident" id="3132887">Unpack</span><span class="op" id="3132893">(</span><span class="ident" id="3132894">b</span><span class="op" id="3132895">[</span><span class="op" id="3132896">:</span><span class="ident" id="3132897">n</span><span class="op" id="3132898">]</span><span class="op" id="3132899">)</span>&nbsp;<span class="op" id="3132901">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3132905">return</span>&nbsp;<span class="ident" id="3132912">nil</span><span class="op" id="3132915">,</span>&nbsp;<span class="ident" id="3132917">errors</span><span class="op" id="3132923">.</span><span class="ident" id="3132924">New</span><span class="op" id="3132927">(</span><span class="string" id="3132928">&#34;cannot&nbsp;unmarshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="3132958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3132961">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3132964">return</span>&nbsp;<span class="ident" id="3132971">msg</span><span class="op" id="3132974">,</span>&nbsp;<span class="ident" id="3132976">nil</span><br>
<span class="lineno"></span><span class="op" id="3132980">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="keyword" id="3132983">func</span>&nbsp;<span class="op" id="3132988">(</span><span class="ident" id="3132989">c</span>&nbsp;<span class="op" id="3132991">*</span><span class="ident" id="3132992">TCPConn</span><span class="op" id="3132999">)</span>&nbsp;<span class="ident" id="3133001">writeDNSQuery</span><span class="op" id="3133014">(</span><span class="ident" id="3133015">msg</span>&nbsp;<span class="op" id="3133019">*</span><span class="ident" id="3133020">dnsMsg</span><span class="op" id="3133026">)</span>&nbsp;<span class="builtintype" id="3133028">error</span>&nbsp;<span class="op" id="3133034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3133037">b</span><span class="op" id="3133038">,</span>&nbsp;<span class="ident" id="3133040">ok</span>&nbsp;<span class="op" id="3133043">:=</span>&nbsp;<span class="ident" id="3133046">msg</span><span class="op" id="3133049">.</span><span class="ident" id="3133050">Pack</span><span class="op" id="3133054">(</span><span class="op" id="3133055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3133058">if</span>&nbsp;<span class="op" id="3133061">!</span><span class="ident" id="3133062">ok</span>&nbsp;<span class="op" id="3133065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3133069">return</span>&nbsp;<span class="ident" id="3133076">errors</span><span class="op" id="3133082">.</span><span class="ident" id="3133083">New</span><span class="op" id="3133086">(</span><span class="string" id="3133087">&#34;cannot&nbsp;marshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="3133115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3133118">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3133121">l</span>&nbsp;<span class="op" id="3133123">:=</span>&nbsp;<span class="builtintype" id="3133126">uint16</span><span class="op" id="3133132">(</span><span class="builtinfunc" id="3133133">len</span><span class="op" id="3133136">(</span><span class="ident" id="3133137">b</span><span class="op" id="3133138">)</span><span class="op" id="3133139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3133142">b</span>&nbsp;<span class="op" id="3133144">=</span>&nbsp;<span class="builtinfunc" id="3133146">append</span><span class="op" id="3133152">(</span><span class="op" id="3133153">[</span><span class="op" id="3133154">]</span><span class="builtintype" id="3133155">byte</span><span class="op" id="3133159">{</span><span class="builtintype" id="3133160">byte</span><span class="op" id="3133164">(</span><span class="ident" id="3133165">l</span>&nbsp;<span class="op" id="3133167">&gt;&gt;</span>&nbsp;<span class="num" id="3133170">8</span><span class="op" id="3133171">)</span><span class="op" id="3133172">,</span>&nbsp;<span class="builtintype" id="3133174">byte</span><span class="op" id="3133178">(</span><span class="ident" id="3133179">l</span><span class="op" id="3133180">)</span><span class="op" id="3133181">}</span><span class="op" id="3133182">,</span>&nbsp;<span class="ident" id="3133184">b</span><span class="op" id="3133185">...</span><span class="op" id="3133188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3133191">if</span>&nbsp;<span class="ident" id="3133194">_</span><span class="op" id="3133195">,</span>&nbsp;<span class="ident" id="3133197">err</span>&nbsp;<span class="op" id="3133201">:=</span>&nbsp;<span class="ident" id="3133204">c</span><span class="op" id="3133205">.</span><span class="ident" id="3133206">Write</span><span class="op" id="3133211">(</span><span class="ident" id="3133212">b</span><span class="op" id="3133213">)</span><span class="op" id="3133214">;</span>&nbsp;<span class="ident" id="3133216">err</span>&nbsp;<span class="op" id="3133220">!=</span>&nbsp;<span class="ident" id="3133223">nil</span>&nbsp;<span class="op" id="3133227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3133231">return</span>&nbsp;<span class="ident" id="3133238">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3133243">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3133246">return</span>&nbsp;<span class="ident" id="3133253">nil</span><br>
<span class="lineno"></span><span class="op" id="3133257">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3133260">func</span>&nbsp;<span class="op" id="3133265">(</span><span class="ident" id="3133266">d</span>&nbsp;<span class="op" id="3133268">*</span><span class="ident" id="3133269">Dialer</span><span class="op" id="3133275">)</span>&nbsp;<span class="ident" id="3133277">dialDNS</span><span class="op" id="3133284">(</span><span class="ident" id="3133285">network</span><span class="op" id="3133292">,</span>&nbsp;<span class="ident" id="3133294">server</span>&nbsp;<span class="builtintype" id="3133301">string</span><span class="op" id="3133307">)</span>&nbsp;<span class="op" id="3133309">(</span><span class="ident" id="3133310">dnsConn</span><span class="op" id="3133317">,</span>&nbsp;<span class="builtintype" id="3133319">error</span><span class="op" id="3133324">)</span>&nbsp;<span class="op" id="3133326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3133329">switch</span>&nbsp;<span class="ident" id="3133336">network</span>&nbsp;<span class="op" id="3133344">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3133347">case</span>&nbsp;<span class="string" id="3133352">&#34;tcp&#34;</span><span class="op" id="3133357">,</span>&nbsp;<span class="string" id="3133359">&#34;tcp4&#34;</span><span class="op" id="3133365">,</span>&nbsp;<span class="string" id="3133367">&#34;tcp6&#34;</span><span class="op" id="3133373">,</span>&nbsp;<span class="string" id="3133375">&#34;udp&#34;</span><span class="op" id="3133380">,</span>&nbsp;<span class="string" id="3133382">&#34;udp4&#34;</span><span class="op" id="3133388">,</span>&nbsp;<span class="string" id="3133390">&#34;udp6&#34;</span><span class="op" id="3133396">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3133399">default</span><span class="op" id="3133406">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3133410">return</span>&nbsp;<span class="ident" id="3133417">nil</span><span class="op" id="3133420">,</span>&nbsp;<span class="ident" id="3133422">UnknownNetworkError</span><span class="op" id="3133441">(</span><span class="ident" id="3133442">network</span><span class="op" id="3133449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3133452">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3133455">//&nbsp;Calling&nbsp;Dial&nbsp;here&nbsp;is&nbsp;scary&nbsp;--&nbsp;we&nbsp;have&nbsp;to&nbsp;be&nbsp;sure&nbsp;not&nbsp;to</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3133515">//&nbsp;dial&nbsp;a&nbsp;name&nbsp;that&nbsp;will&nbsp;require&nbsp;a&nbsp;DNS&nbsp;lookup,&nbsp;or&nbsp;Dial&nbsp;will</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3133576">//&nbsp;call&nbsp;back&nbsp;here&nbsp;to&nbsp;translate&nbsp;it.&nbsp;The&nbsp;DNS&nbsp;config&nbsp;parser&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3133638">//&nbsp;already&nbsp;checked&nbsp;that&nbsp;all&nbsp;the&nbsp;cfg.servers[i]&nbsp;are&nbsp;IP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3133693">//&nbsp;addresses,&nbsp;which&nbsp;Dial&nbsp;will&nbsp;use&nbsp;without&nbsp;a&nbsp;DNS&nbsp;lookup.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3133750">c</span><span class="op" id="3133751">,</span>&nbsp;<span class="ident" id="3133753">err</span>&nbsp;<span class="op" id="3133757">:=</span>&nbsp;<span class="ident" id="3133760">d</span><span class="op" id="3133761">.</span><span class="ident" id="3133762">Dial</span><span class="op" id="3133766">(</span><span class="ident" id="3133767">network</span><span class="op" id="3133774">,</span>&nbsp;<span class="ident" id="3133776">server</span><span class="op" id="3133782">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3133785">if</span>&nbsp;<span class="ident" id="3133788">err</span>&nbsp;<span class="op" id="3133792">!=</span>&nbsp;<span class="ident" id="3133795">nil</span>&nbsp;<span class="op" id="3133799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3133803">return</span>&nbsp;<span class="ident" id="3133810">nil</span><span class="op" id="3133813">,</span>&nbsp;<span class="ident" id="3133815">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3133820">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3133823">switch</span>&nbsp;<span class="ident" id="3133830">network</span>&nbsp;<span class="op" id="3133838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3133841">case</span>&nbsp;<span class="string" id="3133846">&#34;tcp&#34;</span><span class="op" id="3133851">,</span>&nbsp;<span class="string" id="3133853">&#34;tcp4&#34;</span><span class="op" id="3133859">,</span>&nbsp;<span class="string" id="3133861">&#34;tcp6&#34;</span><span class="op" id="3133867">:</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3133871">return</span>&nbsp;<span class="ident" id="3133878">c</span><span class="op" id="3133879">.</span><span class="op" id="3133880">(</span><span class="op" id="3133881">*</span><span class="ident" id="3133882">TCPConn</span><span class="op" id="3133889">)</span><span class="op" id="3133890">,</span>&nbsp;<span class="ident" id="3133892">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3133897">case</span>&nbsp;<span class="string" id="3133902">&#34;udp&#34;</span><span class="op" id="3133907">,</span>&nbsp;<span class="string" id="3133909">&#34;udp4&#34;</span><span class="op" id="3133915">,</span>&nbsp;<span class="string" id="3133917">&#34;udp6&#34;</span><span class="op" id="3133923">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3133927">return</span>&nbsp;<span class="ident" id="3133934">c</span><span class="op" id="3133935">.</span><span class="op" id="3133936">(</span><span class="op" id="3133937">*</span><span class="ident" id="3133938">UDPConn</span><span class="op" id="3133945">)</span><span class="op" id="3133946">,</span>&nbsp;<span class="ident" id="3133948">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3133953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3133956">panic</span><span class="op" id="3133961">(</span><span class="string" id="3133962">&#34;unreachable&#34;</span><span class="op" id="3133975">)</span><br>
<span class="lineno">120</span><span class="op" id="3133977">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3133980">//&nbsp;exchange&nbsp;sends&nbsp;a&nbsp;query&nbsp;on&nbsp;the&nbsp;connection&nbsp;and&nbsp;hopes&nbsp;for&nbsp;a&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="3134050">func</span>&nbsp;<span class="ident" id="3134055">exchange</span><span class="op" id="3134063">(</span><span class="ident" id="3134064">server</span><span class="op" id="3134070">,</span>&nbsp;<span class="ident" id="3134072">name</span>&nbsp;<span class="builtintype" id="3134077">string</span><span class="op" id="3134083">,</span>&nbsp;<span class="ident" id="3134085">qtype</span>&nbsp;<span class="builtintype" id="3134091">uint16</span><span class="op" id="3134097">,</span>&nbsp;<span class="ident" id="3134099">timeout</span>&nbsp;<span class="ident" id="3134107">time</span><span class="op" id="3134111">.</span><span class="ident" id="3134112">Duration</span><span class="op" id="3134120">)</span>&nbsp;<span class="op" id="3134122">(</span><span class="op" id="3134123">*</span><span class="ident" id="3134124">dnsMsg</span><span class="op" id="3134130">,</span>&nbsp;<span class="builtintype" id="3134132">error</span><span class="op" id="3134137">)</span>&nbsp;<span class="op" id="3134139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3134142">d</span>&nbsp;<span class="op" id="3134144">:=</span>&nbsp;<span class="ident" id="3134147">Dialer</span><span class="op" id="3134153">{</span><span class="ident" id="3134154">Timeout</span><span class="op" id="3134161">:</span>&nbsp;<span class="ident" id="3134163">timeout</span><span class="op" id="3134170">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3134173">out</span>&nbsp;<span class="op" id="3134177">:=</span>&nbsp;<span class="ident" id="3134180">dnsMsg</span><span class="op" id="3134186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3134190">dnsMsgHdr</span><span class="op" id="3134199">:</span>&nbsp;<span class="ident" id="3134201">dnsMsgHdr</span><span class="op" id="3134210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3134215">recursion_desired</span><span class="op" id="3134232">:</span>&nbsp;<span class="builtintype" id="3134234">true</span><span class="op" id="3134238">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3134242">}</span><span class="op" id="3134243">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3134247">question</span><span class="op" id="3134255">:</span>&nbsp;<span class="op" id="3134257">[</span><span class="op" id="3134258">]</span><span class="ident" id="3134259">dnsQuestion</span><span class="op" id="3134270">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3134275">{</span><span class="ident" id="3134276">name</span><span class="op" id="3134280">,</span>&nbsp;<span class="ident" id="3134282">qtype</span><span class="op" id="3134287">,</span>&nbsp;<span class="ident" id="3134289">dnsClassINET</span><span class="op" id="3134301">}</span><span class="op" id="3134302">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3134306">}</span><span class="op" id="3134307">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3134310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134313">for</span>&nbsp;<span class="ident" id="3134317">_</span><span class="op" id="3134318">,</span>&nbsp;<span class="ident" id="3134320">network</span>&nbsp;<span class="op" id="3134328">:=</span>&nbsp;<span class="keyword" id="3134331">range</span>&nbsp;<span class="op" id="3134337">[</span><span class="op" id="3134338">]</span><span class="builtintype" id="3134339">string</span><span class="op" id="3134345">{</span><span class="string" id="3134346">&#34;udp&#34;</span><span class="op" id="3134351">,</span>&nbsp;<span class="string" id="3134353">&#34;tcp&#34;</span><span class="op" id="3134358">}</span>&nbsp;<span class="op" id="3134360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3134364">c</span><span class="op" id="3134365">,</span>&nbsp;<span class="ident" id="3134367">err</span>&nbsp;<span class="op" id="3134371">:=</span>&nbsp;<span class="ident" id="3134374">d</span><span class="op" id="3134375">.</span><span class="ident" id="3134376">dialDNS</span><span class="op" id="3134383">(</span><span class="ident" id="3134384">network</span><span class="op" id="3134391">,</span>&nbsp;<span class="ident" id="3134393">server</span><span class="op" id="3134399">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134403">if</span>&nbsp;<span class="ident" id="3134406">err</span>&nbsp;<span class="op" id="3134410">!=</span>&nbsp;<span class="ident" id="3134413">nil</span>&nbsp;<span class="op" id="3134417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134422">return</span>&nbsp;<span class="ident" id="3134429">nil</span><span class="op" id="3134432">,</span>&nbsp;<span class="ident" id="3134434">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3134440">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134444">defer</span>&nbsp;<span class="ident" id="3134450">c</span><span class="op" id="3134451">.</span><span class="ident" id="3134452">Close</span><span class="op" id="3134457">(</span><span class="op" id="3134458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134462">if</span>&nbsp;<span class="ident" id="3134465">timeout</span>&nbsp;<span class="op" id="3134473">&gt;</span>&nbsp;<span class="num" id="3134475">0</span>&nbsp;<span class="op" id="3134477">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3134482">c</span><span class="op" id="3134483">.</span><span class="ident" id="3134484">SetDeadline</span><span class="op" id="3134495">(</span><span class="ident" id="3134496">time</span><span class="op" id="3134500">.</span><span class="ident" id="3134501">Now</span><span class="op" id="3134504">(</span><span class="op" id="3134505">)</span><span class="op" id="3134506">.</span><span class="ident" id="3134507">Add</span><span class="op" id="3134510">(</span><span class="ident" id="3134511">timeout</span><span class="op" id="3134518">)</span><span class="op" id="3134519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3134523">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3134527">out</span><span class="op" id="3134530">.</span><span class="ident" id="3134531">id</span>&nbsp;<span class="op" id="3134534">=</span>&nbsp;<span class="builtintype" id="3134536">uint16</span><span class="op" id="3134542">(</span><span class="ident" id="3134543">rand</span><span class="op" id="3134547">.</span><span class="ident" id="3134548">Int</span><span class="op" id="3134551">(</span><span class="op" id="3134552">)</span><span class="op" id="3134553">)</span>&nbsp;<span class="op" id="3134555">^</span>&nbsp;<span class="builtintype" id="3134557">uint16</span><span class="op" id="3134563">(</span><span class="ident" id="3134564">time</span><span class="op" id="3134568">.</span><span class="ident" id="3134569">Now</span><span class="op" id="3134572">(</span><span class="op" id="3134573">)</span><span class="op" id="3134574">.</span><span class="ident" id="3134575">UnixNano</span><span class="op" id="3134583">(</span><span class="op" id="3134584">)</span><span class="op" id="3134585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134589">if</span>&nbsp;<span class="ident" id="3134592">err</span>&nbsp;<span class="op" id="3134596">:=</span>&nbsp;<span class="ident" id="3134599">c</span><span class="op" id="3134600">.</span><span class="ident" id="3134601">writeDNSQuery</span><span class="op" id="3134614">(</span><span class="op" id="3134615">&amp;</span><span class="ident" id="3134616">out</span><span class="op" id="3134619">)</span><span class="op" id="3134620">;</span>&nbsp;<span class="ident" id="3134622">err</span>&nbsp;<span class="op" id="3134626">!=</span>&nbsp;<span class="ident" id="3134629">nil</span>&nbsp;<span class="op" id="3134633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134638">return</span>&nbsp;<span class="ident" id="3134645">nil</span><span class="op" id="3134648">,</span>&nbsp;<span class="ident" id="3134650">err</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3134656">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3134660">in</span><span class="op" id="3134662">,</span>&nbsp;<span class="ident" id="3134664">err</span>&nbsp;<span class="op" id="3134668">:=</span>&nbsp;<span class="ident" id="3134671">c</span><span class="op" id="3134672">.</span><span class="ident" id="3134673">readDNSResponse</span><span class="op" id="3134688">(</span><span class="op" id="3134689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134693">if</span>&nbsp;<span class="ident" id="3134696">err</span>&nbsp;<span class="op" id="3134700">!=</span>&nbsp;<span class="ident" id="3134703">nil</span>&nbsp;<span class="op" id="3134707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134712">return</span>&nbsp;<span class="ident" id="3134719">nil</span><span class="op" id="3134722">,</span>&nbsp;<span class="ident" id="3134724">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3134730">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134734">if</span>&nbsp;<span class="ident" id="3134737">in</span><span class="op" id="3134739">.</span><span class="ident" id="3134740">id</span>&nbsp;<span class="op" id="3134743">!=</span>&nbsp;<span class="ident" id="3134746">out</span><span class="op" id="3134749">.</span><span class="ident" id="3134750">id</span>&nbsp;<span class="op" id="3134753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134758">return</span>&nbsp;<span class="ident" id="3134765">nil</span><span class="op" id="3134768">,</span>&nbsp;<span class="ident" id="3134770">errors</span><span class="op" id="3134776">.</span><span class="ident" id="3134777">New</span><span class="op" id="3134780">(</span><span class="string" id="3134781">&#34;DNS&nbsp;message&nbsp;ID&nbsp;mismatch&#34;</span><span class="op" id="3134806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3134810">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134814">if</span>&nbsp;<span class="ident" id="3134817">in</span><span class="op" id="3134819">.</span><span class="ident" id="3134820">truncated</span>&nbsp;<span class="op" id="3134830">{</span>&nbsp;<span class="comment" id="3134832">//&nbsp;see&nbsp;RFC&nbsp;5966</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134851">continue</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3134862">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134866">return</span>&nbsp;<span class="ident" id="3134873">in</span><span class="op" id="3134875">,</span>&nbsp;<span class="ident" id="3134877">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3134882">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134885">return</span>&nbsp;<span class="ident" id="3134892">nil</span><span class="op" id="3134895">,</span>&nbsp;<span class="ident" id="3134897">errors</span><span class="op" id="3134903">.</span><span class="ident" id="3134904">New</span><span class="op" id="3134907">(</span><span class="string" id="3134908">&#34;no&nbsp;answer&nbsp;from&nbsp;DNS&nbsp;server&#34;</span><span class="op" id="3134935">)</span><br>
<span class="lineno"></span><span class="op" id="3134937">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="comment" id="3134940">//&nbsp;Do&nbsp;a&nbsp;lookup&nbsp;for&nbsp;a&nbsp;single&nbsp;name,&nbsp;which&nbsp;must&nbsp;be&nbsp;rooted</span><br>
<span class="lineno"></span><span class="comment" id="3134995">//&nbsp;(otherwise&nbsp;answer&nbsp;will&nbsp;not&nbsp;find&nbsp;the&nbsp;answers).</span><br>
<span class="lineno"></span><span class="keyword" id="3135044">func</span>&nbsp;<span class="ident" id="3135049">tryOneName</span><span class="op" id="3135059">(</span><span class="ident" id="3135060">cfg</span>&nbsp;<span class="op" id="3135064">*</span><span class="ident" id="3135065">dnsConfig</span><span class="op" id="3135074">,</span>&nbsp;<span class="ident" id="3135076">name</span>&nbsp;<span class="builtintype" id="3135081">string</span><span class="op" id="3135087">,</span>&nbsp;<span class="ident" id="3135089">qtype</span>&nbsp;<span class="builtintype" id="3135095">uint16</span><span class="op" id="3135101">)</span>&nbsp;<span class="op" id="3135103">(</span><span class="builtintype" id="3135104">string</span><span class="op" id="3135110">,</span>&nbsp;<span class="op" id="3135112">[</span><span class="op" id="3135113">]</span><span class="ident" id="3135114">dnsRR</span><span class="op" id="3135119">,</span>&nbsp;<span class="builtintype" id="3135121">error</span><span class="op" id="3135126">)</span>&nbsp;<span class="op" id="3135128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3135131">if</span>&nbsp;<span class="builtinfunc" id="3135134">len</span><span class="op" id="3135137">(</span><span class="ident" id="3135138">cfg</span><span class="op" id="3135141">.</span><span class="ident" id="3135142">servers</span><span class="op" id="3135149">)</span>&nbsp;<span class="op" id="3135151">==</span>&nbsp;<span class="num" id="3135154">0</span>&nbsp;<span class="op" id="3135156">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3135160">return</span>&nbsp;<span class="string" id="3135167">&#34;&#34;</span><span class="op" id="3135169">,</span>&nbsp;<span class="ident" id="3135171">nil</span><span class="op" id="3135174">,</span>&nbsp;<span class="op" id="3135176">&amp;</span><span class="ident" id="3135177">DNSError</span><span class="op" id="3135185">{</span><span class="ident" id="3135186">Err</span><span class="op" id="3135189">:</span>&nbsp;<span class="string" id="3135191">&#34;no&nbsp;DNS&nbsp;servers&#34;</span><span class="op" id="3135207">,</span>&nbsp;<span class="ident" id="3135209">Name</span><span class="op" id="3135213">:</span>&nbsp;<span class="ident" id="3135215">name</span><span class="op" id="3135219">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3135222">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3135225">if</span>&nbsp;<span class="builtinfunc" id="3135228">len</span><span class="op" id="3135231">(</span><span class="ident" id="3135232">name</span><span class="op" id="3135236">)</span>&nbsp;<span class="op" id="3135238">&gt;=</span>&nbsp;<span class="num" id="3135241">256</span>&nbsp;<span class="op" id="3135245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3135249">return</span>&nbsp;<span class="string" id="3135256">&#34;&#34;</span><span class="op" id="3135258">,</span>&nbsp;<span class="ident" id="3135260">nil</span><span class="op" id="3135263">,</span>&nbsp;<span class="op" id="3135265">&amp;</span><span class="ident" id="3135266">DNSError</span><span class="op" id="3135274">{</span><span class="ident" id="3135275">Err</span><span class="op" id="3135278">:</span>&nbsp;<span class="string" id="3135280">&#34;DNS&nbsp;name&nbsp;too&nbsp;long&#34;</span><span class="op" id="3135299">,</span>&nbsp;<span class="ident" id="3135301">Name</span><span class="op" id="3135305">:</span>&nbsp;<span class="ident" id="3135307">name</span><span class="op" id="3135311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3135314">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135317">timeout</span>&nbsp;<span class="op" id="3135325">:=</span>&nbsp;<span class="ident" id="3135328">time</span><span class="op" id="3135332">.</span><span class="ident" id="3135333">Duration</span><span class="op" id="3135341">(</span><span class="ident" id="3135342">cfg</span><span class="op" id="3135345">.</span><span class="ident" id="3135346">timeout</span><span class="op" id="3135353">)</span>&nbsp;<span class="op" id="3135355">*</span>&nbsp;<span class="ident" id="3135357">time</span><span class="op" id="3135361">.</span><span class="ident" id="3135362">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3135370">var</span>&nbsp;<span class="ident" id="3135374">lastErr</span>&nbsp;<span class="builtintype" id="3135382">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3135389">for</span>&nbsp;<span class="ident" id="3135393">i</span>&nbsp;<span class="op" id="3135395">:=</span>&nbsp;<span class="num" id="3135398">0</span><span class="op" id="3135399">;</span>&nbsp;<span class="ident" id="3135401">i</span>&nbsp;<span class="op" id="3135403">&lt;</span>&nbsp;<span class="ident" id="3135405">cfg</span><span class="op" id="3135408">.</span><span class="ident" id="3135409">attempts</span><span class="op" id="3135417">;</span>&nbsp;<span class="ident" id="3135419">i</span><span class="op" id="3135420">++</span>&nbsp;<span class="op" id="3135423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3135427">for</span>&nbsp;<span class="ident" id="3135431">_</span><span class="op" id="3135432">,</span>&nbsp;<span class="ident" id="3135434">server</span>&nbsp;<span class="op" id="3135441">:=</span>&nbsp;<span class="keyword" id="3135444">range</span>&nbsp;<span class="ident" id="3135450">cfg</span><span class="op" id="3135453">.</span><span class="ident" id="3135454">servers</span>&nbsp;<span class="op" id="3135462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135467">server</span>&nbsp;<span class="op" id="3135474">=</span>&nbsp;<span class="ident" id="3135476">JoinHostPort</span><span class="op" id="3135488">(</span><span class="ident" id="3135489">server</span><span class="op" id="3135495">,</span>&nbsp;<span class="string" id="3135497">&#34;53&#34;</span><span class="op" id="3135501">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135506">msg</span><span class="op" id="3135509">,</span>&nbsp;<span class="ident" id="3135511">err</span>&nbsp;<span class="op" id="3135515">:=</span>&nbsp;<span class="ident" id="3135518">exchange</span><span class="op" id="3135526">(</span><span class="ident" id="3135527">server</span><span class="op" id="3135533">,</span>&nbsp;<span class="ident" id="3135535">name</span><span class="op" id="3135539">,</span>&nbsp;<span class="ident" id="3135541">qtype</span><span class="op" id="3135546">,</span>&nbsp;<span class="ident" id="3135548">timeout</span><span class="op" id="3135555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3135560">if</span>&nbsp;<span class="ident" id="3135563">err</span>&nbsp;<span class="op" id="3135567">!=</span>&nbsp;<span class="ident" id="3135570">nil</span>&nbsp;<span class="op" id="3135574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135580">lastErr</span>&nbsp;<span class="op" id="3135588">=</span>&nbsp;<span class="op" id="3135590">&amp;</span><span class="ident" id="3135591">DNSError</span><span class="op" id="3135599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135606">Err</span><span class="op" id="3135609">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3135614">err</span><span class="op" id="3135617">.</span><span class="ident" id="3135618">Error</span><span class="op" id="3135623">(</span><span class="op" id="3135624">)</span><span class="op" id="3135625">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135632">Name</span><span class="op" id="3135636">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3135640">name</span><span class="op" id="3135644">,</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135651">Server</span><span class="op" id="3135657">:</span>&nbsp;<span class="ident" id="3135659">server</span><span class="op" id="3135665">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3135671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3135677">if</span>&nbsp;<span class="ident" id="3135680">nerr</span><span class="op" id="3135684">,</span>&nbsp;<span class="ident" id="3135686">ok</span>&nbsp;<span class="op" id="3135689">:=</span>&nbsp;<span class="ident" id="3135692">err</span><span class="op" id="3135695">.</span><span class="op" id="3135696">(</span><span class="ident" id="3135697">Error</span><span class="op" id="3135702">)</span><span class="op" id="3135703">;</span>&nbsp;<span class="ident" id="3135705">ok</span>&nbsp;<span class="op" id="3135708">&amp;&amp;</span>&nbsp;<span class="ident" id="3135711">nerr</span><span class="op" id="3135715">.</span><span class="ident" id="3135716">Timeout</span><span class="op" id="3135723">(</span><span class="op" id="3135724">)</span>&nbsp;<span class="op" id="3135726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135733">lastErr</span><span class="op" id="3135740">.</span><span class="op" id="3135741">(</span><span class="op" id="3135742">*</span><span class="ident" id="3135743">DNSError</span><span class="op" id="3135751">)</span><span class="op" id="3135752">.</span><span class="ident" id="3135753">IsTimeout</span>&nbsp;<span class="op" id="3135763">=</span>&nbsp;<span class="builtintype" id="3135765">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3135774">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3135780">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3135792">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135797">cname</span><span class="op" id="3135802">,</span>&nbsp;<span class="ident" id="3135804">addrs</span><span class="op" id="3135809">,</span>&nbsp;<span class="ident" id="3135811">err</span>&nbsp;<span class="op" id="3135815">:=</span>&nbsp;<span class="ident" id="3135818">answer</span><span class="op" id="3135824">(</span><span class="ident" id="3135825">name</span><span class="op" id="3135829">,</span>&nbsp;<span class="ident" id="3135831">server</span><span class="op" id="3135837">,</span>&nbsp;<span class="ident" id="3135839">msg</span><span class="op" id="3135842">,</span>&nbsp;<span class="ident" id="3135844">qtype</span><span class="op" id="3135849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3135854">if</span>&nbsp;<span class="ident" id="3135857">err</span>&nbsp;<span class="op" id="3135861">==</span>&nbsp;<span class="ident" id="3135864">nil</span>&nbsp;<span class="op" id="3135868">||</span>&nbsp;<span class="ident" id="3135871">err</span><span class="op" id="3135874">.</span><span class="op" id="3135875">(</span><span class="op" id="3135876">*</span><span class="ident" id="3135877">DNSError</span><span class="op" id="3135885">)</span><span class="op" id="3135886">.</span><span class="ident" id="3135887">Err</span>&nbsp;<span class="op" id="3135891">==</span>&nbsp;<span class="ident" id="3135894">noSuchHost</span>&nbsp;<span class="op" id="3135905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3135911">return</span>&nbsp;<span class="ident" id="3135918">cname</span><span class="op" id="3135923">,</span>&nbsp;<span class="ident" id="3135925">addrs</span><span class="op" id="3135930">,</span>&nbsp;<span class="ident" id="3135932">err</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3135939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135944">lastErr</span>&nbsp;<span class="op" id="3135952">=</span>&nbsp;<span class="ident" id="3135954">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3135960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3135963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3135966">return</span>&nbsp;<span class="string" id="3135973">&#34;&#34;</span><span class="op" id="3135975">,</span>&nbsp;<span class="ident" id="3135977">nil</span><span class="op" id="3135980">,</span>&nbsp;<span class="ident" id="3135982">lastErr</span><br>
<span class="lineno">195</span><span class="op" id="3135990">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3135993">func</span>&nbsp;<span class="ident" id="3135998">convertRR_A</span><span class="op" id="3136009">(</span><span class="ident" id="3136010">records</span>&nbsp;<span class="op" id="3136018">[</span><span class="op" id="3136019">]</span><span class="ident" id="3136020">dnsRR</span><span class="op" id="3136025">)</span>&nbsp;<span class="op" id="3136027">[</span><span class="op" id="3136028">]</span><span class="ident" id="3136029">IP</span>&nbsp;<span class="op" id="3136032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136035">addrs</span>&nbsp;<span class="op" id="3136041">:=</span>&nbsp;<span class="builtinfunc" id="3136044">make</span><span class="op" id="3136048">(</span><span class="op" id="3136049">[</span><span class="op" id="3136050">]</span><span class="ident" id="3136051">IP</span><span class="op" id="3136053">,</span>&nbsp;<span class="builtinfunc" id="3136055">len</span><span class="op" id="3136058">(</span><span class="ident" id="3136059">records</span><span class="op" id="3136066">)</span><span class="op" id="3136067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3136070">for</span>&nbsp;<span class="ident" id="3136074">i</span><span class="op" id="3136075">,</span>&nbsp;<span class="ident" id="3136077">rr</span>&nbsp;<span class="op" id="3136080">:=</span>&nbsp;<span class="keyword" id="3136083">range</span>&nbsp;<span class="ident" id="3136089">records</span>&nbsp;<span class="op" id="3136097">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136101">a</span>&nbsp;<span class="op" id="3136103">:=</span>&nbsp;<span class="ident" id="3136106">rr</span><span class="op" id="3136108">.</span><span class="op" id="3136109">(</span><span class="op" id="3136110">*</span><span class="ident" id="3136111">dnsRR_A</span><span class="op" id="3136118">)</span><span class="op" id="3136119">.</span><span class="ident" id="3136120">A</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136124">addrs</span><span class="op" id="3136129">[</span><span class="ident" id="3136130">i</span><span class="op" id="3136131">]</span>&nbsp;<span class="op" id="3136133">=</span>&nbsp;<span class="ident" id="3136135">IPv4</span><span class="op" id="3136139">(</span><span class="builtintype" id="3136140">byte</span><span class="op" id="3136144">(</span><span class="ident" id="3136145">a</span><span class="op" id="3136146">&gt;&gt;</span><span class="num" id="3136148">24</span><span class="op" id="3136150">)</span><span class="op" id="3136151">,</span>&nbsp;<span class="builtintype" id="3136153">byte</span><span class="op" id="3136157">(</span><span class="ident" id="3136158">a</span><span class="op" id="3136159">&gt;&gt;</span><span class="num" id="3136161">16</span><span class="op" id="3136163">)</span><span class="op" id="3136164">,</span>&nbsp;<span class="builtintype" id="3136166">byte</span><span class="op" id="3136170">(</span><span class="ident" id="3136171">a</span><span class="op" id="3136172">&gt;&gt;</span><span class="num" id="3136174">8</span><span class="op" id="3136175">)</span><span class="op" id="3136176">,</span>&nbsp;<span class="builtintype" id="3136178">byte</span><span class="op" id="3136182">(</span><span class="ident" id="3136183">a</span><span class="op" id="3136184">)</span><span class="op" id="3136185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3136188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3136191">return</span>&nbsp;<span class="ident" id="3136198">addrs</span><br>
<span class="lineno"></span><span class="op" id="3136204">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="3136207">func</span>&nbsp;<span class="ident" id="3136212">convertRR_AAAA</span><span class="op" id="3136226">(</span><span class="ident" id="3136227">records</span>&nbsp;<span class="op" id="3136235">[</span><span class="op" id="3136236">]</span><span class="ident" id="3136237">dnsRR</span><span class="op" id="3136242">)</span>&nbsp;<span class="op" id="3136244">[</span><span class="op" id="3136245">]</span><span class="ident" id="3136246">IP</span>&nbsp;<span class="op" id="3136249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136252">addrs</span>&nbsp;<span class="op" id="3136258">:=</span>&nbsp;<span class="builtinfunc" id="3136261">make</span><span class="op" id="3136265">(</span><span class="op" id="3136266">[</span><span class="op" id="3136267">]</span><span class="ident" id="3136268">IP</span><span class="op" id="3136270">,</span>&nbsp;<span class="builtinfunc" id="3136272">len</span><span class="op" id="3136275">(</span><span class="ident" id="3136276">records</span><span class="op" id="3136283">)</span><span class="op" id="3136284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3136287">for</span>&nbsp;<span class="ident" id="3136291">i</span><span class="op" id="3136292">,</span>&nbsp;<span class="ident" id="3136294">rr</span>&nbsp;<span class="op" id="3136297">:=</span>&nbsp;<span class="keyword" id="3136300">range</span>&nbsp;<span class="ident" id="3136306">records</span>&nbsp;<span class="op" id="3136314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136318">a</span>&nbsp;<span class="op" id="3136320">:=</span>&nbsp;<span class="builtinfunc" id="3136323">make</span><span class="op" id="3136327">(</span><span class="ident" id="3136328">IP</span><span class="op" id="3136330">,</span>&nbsp;<span class="ident" id="3136332">IPv6len</span><span class="op" id="3136339">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3136343">copy</span><span class="op" id="3136347">(</span><span class="ident" id="3136348">a</span><span class="op" id="3136349">,</span>&nbsp;<span class="ident" id="3136351">rr</span><span class="op" id="3136353">.</span><span class="op" id="3136354">(</span><span class="op" id="3136355">*</span><span class="ident" id="3136356">dnsRR_AAAA</span><span class="op" id="3136366">)</span><span class="op" id="3136367">.</span><span class="ident" id="3136368">AAAA</span><span class="op" id="3136372">[</span><span class="op" id="3136373">:</span><span class="op" id="3136374">]</span><span class="op" id="3136375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136379">addrs</span><span class="op" id="3136384">[</span><span class="ident" id="3136385">i</span><span class="op" id="3136386">]</span>&nbsp;<span class="op" id="3136388">=</span>&nbsp;<span class="ident" id="3136390">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3136393">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3136396">return</span>&nbsp;<span class="ident" id="3136403">addrs</span><br>
<span class="lineno"></span><span class="op" id="3136409">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="3136412">var</span>&nbsp;<span class="ident" id="3136416">cfg</span>&nbsp;<span class="keyword" id="3136420">struct</span>&nbsp;<span class="op" id="3136427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136430">ch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3136440">chan</span>&nbsp;<span class="keyword" id="3136445">struct</span><span class="op" id="3136451">{</span><span class="op" id="3136452">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136455">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3136465">sync</span><span class="op" id="3136469">.</span><span class="ident" id="3136470">RWMutex</span>&nbsp;<span class="comment" id="3136478">//&nbsp;protects&nbsp;dnsConfig&nbsp;and&nbsp;dnserr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136512">dnsConfig</span>&nbsp;<span class="op" id="3136522">*</span><span class="ident" id="3136523">dnsConfig</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136534">dnserr</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3136544">error</span><br>
<span class="lineno"></span><span class="op" id="3136550">}</span><br>
<span class="lineno"></span><span class="keyword" id="3136552">var</span>&nbsp;<span class="ident" id="3136556">onceLoadConfig</span>&nbsp;<span class="ident" id="3136571">sync</span><span class="op" id="3136575">.</span><span class="ident" id="3136576">Once</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3136582">//&nbsp;Assume&nbsp;dns&nbsp;config&nbsp;file&nbsp;is&nbsp;/etc/resolv.conf&nbsp;here</span><br>
<span class="lineno">225</span><span class="keyword" id="3136633">func</span>&nbsp;<span class="ident" id="3136638">loadDefaultConfig</span><span class="op" id="3136655">(</span><span class="op" id="3136656">)</span>&nbsp;<span class="op" id="3136658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136661">loadConfig</span><span class="op" id="3136671">(</span><span class="string" id="3136672">&#34;/etc/resolv.conf&#34;</span><span class="op" id="3136690">,</span>&nbsp;<span class="num" id="3136692">5</span><span class="op" id="3136693">*</span><span class="ident" id="3136694">time</span><span class="op" id="3136698">.</span><span class="ident" id="3136699">Second</span><span class="op" id="3136705">,</span>&nbsp;<span class="ident" id="3136707">nil</span><span class="op" id="3136710">)</span><br>
<span class="lineno"></span><span class="op" id="3136712">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3136715">func</span>&nbsp;<span class="ident" id="3136720">loadConfig</span><span class="op" id="3136730">(</span><span class="ident" id="3136731">resolvConfPath</span>&nbsp;<span class="builtintype" id="3136746">string</span><span class="op" id="3136752">,</span>&nbsp;<span class="ident" id="3136754">reloadTime</span>&nbsp;<span class="ident" id="3136765">time</span><span class="op" id="3136769">.</span><span class="ident" id="3136770">Duration</span><span class="op" id="3136778">,</span>&nbsp;<span class="ident" id="3136780">quit</span>&nbsp;<span class="op" id="3136785">&lt;-</span><span class="keyword" id="3136787">chan</span>&nbsp;<span class="keyword" id="3136792">chan</span>&nbsp;<span class="keyword" id="3136797">struct</span><span class="op" id="3136803">{</span><span class="op" id="3136804">}</span><span class="op" id="3136805">)</span>&nbsp;<span class="op" id="3136807">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3136810">var</span>&nbsp;<span class="ident" id="3136814">mtime</span>&nbsp;<span class="ident" id="3136820">time</span><span class="op" id="3136824">.</span><span class="ident" id="3136825">Time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136831">cfg</span><span class="op" id="3136834">.</span><span class="ident" id="3136835">ch</span>&nbsp;<span class="op" id="3136838">=</span>&nbsp;<span class="builtinfunc" id="3136840">make</span><span class="op" id="3136844">(</span><span class="keyword" id="3136845">chan</span>&nbsp;<span class="keyword" id="3136850">struct</span><span class="op" id="3136856">{</span><span class="op" id="3136857">}</span><span class="op" id="3136858">,</span>&nbsp;<span class="num" id="3136860">1</span><span class="op" id="3136861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3136864">if</span>&nbsp;<span class="ident" id="3136867">fi</span><span class="op" id="3136869">,</span>&nbsp;<span class="ident" id="3136871">err</span>&nbsp;<span class="op" id="3136875">:=</span>&nbsp;<span class="ident" id="3136878">os</span><span class="op" id="3136880">.</span><span class="ident" id="3136881">Stat</span><span class="op" id="3136885">(</span><span class="ident" id="3136886">resolvConfPath</span><span class="op" id="3136900">)</span><span class="op" id="3136901">;</span>&nbsp;<span class="ident" id="3136903">err</span>&nbsp;<span class="op" id="3136907">!=</span>&nbsp;<span class="ident" id="3136910">nil</span>&nbsp;<span class="op" id="3136914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136918">cfg</span><span class="op" id="3136921">.</span><span class="ident" id="3136922">dnserr</span>&nbsp;<span class="op" id="3136929">=</span>&nbsp;<span class="ident" id="3136931">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3136936">}</span>&nbsp;<span class="keyword" id="3136938">else</span>&nbsp;<span class="op" id="3136943">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136947">mtime</span>&nbsp;<span class="op" id="3136953">=</span>&nbsp;<span class="ident" id="3136955">fi</span><span class="op" id="3136957">.</span><span class="ident" id="3136958">ModTime</span><span class="op" id="3136965">(</span><span class="op" id="3136966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136970">cfg</span><span class="op" id="3136973">.</span><span class="ident" id="3136974">dnsConfig</span><span class="op" id="3136983">,</span>&nbsp;<span class="ident" id="3136985">cfg</span><span class="op" id="3136988">.</span><span class="ident" id="3136989">dnserr</span>&nbsp;<span class="op" id="3136996">=</span>&nbsp;<span class="ident" id="3136998">dnsReadConfig</span><span class="op" id="3137011">(</span><span class="ident" id="3137012">resolvConfPath</span><span class="op" id="3137026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3137029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137032">go</span>&nbsp;<span class="keyword" id="3137035">func</span><span class="op" id="3137039">(</span><span class="op" id="3137040">)</span>&nbsp;<span class="op" id="3137042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137046">for</span>&nbsp;<span class="op" id="3137050">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3137055">time</span><span class="op" id="3137059">.</span><span class="ident" id="3137060">Sleep</span><span class="op" id="3137065">(</span><span class="ident" id="3137066">reloadTime</span><span class="op" id="3137076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137081">select</span>&nbsp;<span class="op" id="3137088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137093">case</span>&nbsp;<span class="ident" id="3137098">qresp</span>&nbsp;<span class="op" id="3137104">:=</span>&nbsp;<span class="op" id="3137107">&lt;-</span><span class="ident" id="3137109">quit</span><span class="op" id="3137113">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3137119">qresp</span>&nbsp;<span class="op" id="3137125">&lt;-</span>&nbsp;<span class="keyword" id="3137128">struct</span><span class="op" id="3137134">{</span><span class="op" id="3137135">}</span><span class="op" id="3137136">{</span><span class="op" id="3137137">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137143">return</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137153">case</span>&nbsp;<span class="op" id="3137158">&lt;-</span><span class="ident" id="3137160">cfg</span><span class="op" id="3137163">.</span><span class="ident" id="3137164">ch</span><span class="op" id="3137166">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3137171">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3137177">//&nbsp;In&nbsp;case&nbsp;of&nbsp;error,&nbsp;we&nbsp;keep&nbsp;the&nbsp;previous&nbsp;config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3137229">fi</span><span class="op" id="3137231">,</span>&nbsp;<span class="ident" id="3137233">err</span>&nbsp;<span class="op" id="3137237">:=</span>&nbsp;<span class="ident" id="3137240">os</span><span class="op" id="3137242">.</span><span class="ident" id="3137243">Stat</span><span class="op" id="3137247">(</span><span class="ident" id="3137248">resolvConfPath</span><span class="op" id="3137262">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137267">if</span>&nbsp;<span class="ident" id="3137270">err</span>&nbsp;<span class="op" id="3137274">!=</span>&nbsp;<span class="ident" id="3137277">nil</span>&nbsp;<span class="op" id="3137281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137287">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3137299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3137304">//&nbsp;If&nbsp;the&nbsp;resolv.conf&nbsp;mtime&nbsp;didn&#39;t&nbsp;change,&nbsp;do&nbsp;not&nbsp;reload</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3137364">m</span>&nbsp;<span class="op" id="3137366">:=</span>&nbsp;<span class="ident" id="3137369">fi</span><span class="op" id="3137371">.</span><span class="ident" id="3137372">ModTime</span><span class="op" id="3137379">(</span><span class="op" id="3137380">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137385">if</span>&nbsp;<span class="ident" id="3137388">m</span><span class="op" id="3137389">.</span><span class="ident" id="3137390">Equal</span><span class="op" id="3137395">(</span><span class="ident" id="3137396">mtime</span><span class="op" id="3137401">)</span>&nbsp;<span class="op" id="3137403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137409">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3137421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3137426">mtime</span>&nbsp;<span class="op" id="3137432">=</span>&nbsp;<span class="ident" id="3137434">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3137439">//&nbsp;In&nbsp;case&nbsp;of&nbsp;error,&nbsp;we&nbsp;keep&nbsp;the&nbsp;previous&nbsp;config</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3137491">ncfg</span><span class="op" id="3137495">,</span>&nbsp;<span class="ident" id="3137497">err</span>&nbsp;<span class="op" id="3137501">:=</span>&nbsp;<span class="ident" id="3137504">dnsReadConfig</span><span class="op" id="3137517">(</span><span class="ident" id="3137518">resolvConfPath</span><span class="op" id="3137532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137537">if</span>&nbsp;<span class="ident" id="3137540">err</span>&nbsp;<span class="op" id="3137544">!=</span>&nbsp;<span class="ident" id="3137547">nil</span>&nbsp;<span class="op" id="3137551">||</span>&nbsp;<span class="builtinfunc" id="3137554">len</span><span class="op" id="3137557">(</span><span class="ident" id="3137558">ncfg</span><span class="op" id="3137562">.</span><span class="ident" id="3137563">servers</span><span class="op" id="3137570">)</span>&nbsp;<span class="op" id="3137572">==</span>&nbsp;<span class="num" id="3137575">0</span>&nbsp;<span class="op" id="3137577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137583">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3137595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3137600">cfg</span><span class="op" id="3137603">.</span><span class="ident" id="3137604">mu</span><span class="op" id="3137606">.</span><span class="ident" id="3137607">Lock</span><span class="op" id="3137611">(</span><span class="op" id="3137612">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3137617">cfg</span><span class="op" id="3137620">.</span><span class="ident" id="3137621">dnsConfig</span>&nbsp;<span class="op" id="3137631">=</span>&nbsp;<span class="ident" id="3137633">ncfg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3137641">cfg</span><span class="op" id="3137644">.</span><span class="ident" id="3137645">dnserr</span>&nbsp;<span class="op" id="3137652">=</span>&nbsp;<span class="ident" id="3137654">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3137661">cfg</span><span class="op" id="3137664">.</span><span class="ident" id="3137665">mu</span><span class="op" id="3137667">.</span><span class="ident" id="3137668">Unlock</span><span class="op" id="3137674">(</span><span class="op" id="3137675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3137679">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3137682">}</span><span class="op" id="3137683">(</span><span class="op" id="3137684">)</span><br>
<span class="lineno">270</span><span class="op" id="3137686">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3137689">func</span>&nbsp;<span class="ident" id="3137694">lookup</span><span class="op" id="3137700">(</span><span class="ident" id="3137701">name</span>&nbsp;<span class="builtintype" id="3137706">string</span><span class="op" id="3137712">,</span>&nbsp;<span class="ident" id="3137714">qtype</span>&nbsp;<span class="builtintype" id="3137720">uint16</span><span class="op" id="3137726">)</span>&nbsp;<span class="op" id="3137728">(</span><span class="ident" id="3137729">cname</span>&nbsp;<span class="builtintype" id="3137735">string</span><span class="op" id="3137741">,</span>&nbsp;<span class="ident" id="3137743">addrs</span>&nbsp;<span class="op" id="3137749">[</span><span class="op" id="3137750">]</span><span class="ident" id="3137751">dnsRR</span><span class="op" id="3137756">,</span>&nbsp;<span class="ident" id="3137758">err</span>&nbsp;<span class="builtintype" id="3137762">error</span><span class="op" id="3137767">)</span>&nbsp;<span class="op" id="3137769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137772">if</span>&nbsp;<span class="op" id="3137775">!</span><span class="ident" id="3137776">isDomainName</span><span class="op" id="3137788">(</span><span class="ident" id="3137789">name</span><span class="op" id="3137793">)</span>&nbsp;<span class="op" id="3137795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137799">return</span>&nbsp;<span class="ident" id="3137806">name</span><span class="op" id="3137810">,</span>&nbsp;<span class="ident" id="3137812">nil</span><span class="op" id="3137815">,</span>&nbsp;<span class="op" id="3137817">&amp;</span><span class="ident" id="3137818">DNSError</span><span class="op" id="3137826">{</span><span class="ident" id="3137827">Err</span><span class="op" id="3137830">:</span>&nbsp;<span class="string" id="3137832">&#34;invalid&nbsp;domain&nbsp;name&#34;</span><span class="op" id="3137853">,</span>&nbsp;<span class="ident" id="3137855">Name</span><span class="op" id="3137859">:</span>&nbsp;<span class="ident" id="3137861">name</span><span class="op" id="3137865">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3137868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3137871">onceLoadConfig</span><span class="op" id="3137885">.</span><span class="ident" id="3137886">Do</span><span class="op" id="3137888">(</span><span class="ident" id="3137889">loadDefaultConfig</span><span class="op" id="3137906">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137910">select</span>&nbsp;<span class="op" id="3137917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137920">case</span>&nbsp;<span class="ident" id="3137925">cfg</span><span class="op" id="3137928">.</span><span class="ident" id="3137929">ch</span>&nbsp;<span class="op" id="3137932">&lt;-</span>&nbsp;<span class="keyword" id="3137935">struct</span><span class="op" id="3137941">{</span><span class="op" id="3137942">}</span><span class="op" id="3137943">{</span><span class="op" id="3137944">}</span><span class="op" id="3137945">:</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137948">default</span><span class="op" id="3137955">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3137958">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3137962">cfg</span><span class="op" id="3137965">.</span><span class="ident" id="3137966">mu</span><span class="op" id="3137968">.</span><span class="ident" id="3137969">RLock</span><span class="op" id="3137974">(</span><span class="op" id="3137975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137978">defer</span>&nbsp;<span class="ident" id="3137984">cfg</span><span class="op" id="3137987">.</span><span class="ident" id="3137988">mu</span><span class="op" id="3137990">.</span><span class="ident" id="3137991">RUnlock</span><span class="op" id="3137998">(</span><span class="op" id="3137999">)</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3138003">if</span>&nbsp;<span class="ident" id="3138006">cfg</span><span class="op" id="3138009">.</span><span class="ident" id="3138010">dnserr</span>&nbsp;<span class="op" id="3138017">!=</span>&nbsp;<span class="ident" id="3138020">nil</span>&nbsp;<span class="op" id="3138024">||</span>&nbsp;<span class="ident" id="3138027">cfg</span><span class="op" id="3138030">.</span><span class="ident" id="3138031">dnsConfig</span>&nbsp;<span class="op" id="3138041">==</span>&nbsp;<span class="ident" id="3138044">nil</span>&nbsp;<span class="op" id="3138048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3138052">err</span>&nbsp;<span class="op" id="3138056">=</span>&nbsp;<span class="ident" id="3138058">cfg</span><span class="op" id="3138061">.</span><span class="ident" id="3138062">dnserr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3138071">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3138079">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3138082">//&nbsp;If&nbsp;name&nbsp;is&nbsp;rooted&nbsp;(trailing&nbsp;dot)&nbsp;or&nbsp;has&nbsp;enough&nbsp;dots,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3138139">//&nbsp;try&nbsp;it&nbsp;by&nbsp;itself&nbsp;first.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3138167">rooted</span>&nbsp;<span class="op" id="3138174">:=</span>&nbsp;<span class="builtinfunc" id="3138177">len</span><span class="op" id="3138180">(</span><span class="ident" id="3138181">name</span><span class="op" id="3138185">)</span>&nbsp;<span class="op" id="3138187">&gt;</span>&nbsp;<span class="num" id="3138189">0</span>&nbsp;<span class="op" id="3138191">&amp;&amp;</span>&nbsp;<span class="ident" id="3138194">name</span><span class="op" id="3138198">[</span><span class="builtinfunc" id="3138199">len</span><span class="op" id="3138202">(</span><span class="ident" id="3138203">name</span><span class="op" id="3138207">)</span><span class="op" id="3138208">-</span><span class="num" id="3138209">1</span><span class="op" id="3138210">]</span>&nbsp;<span class="op" id="3138212">==</span>&nbsp;<span class="string" id="3138215">&#39;.&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3138220">if</span>&nbsp;<span class="ident" id="3138223">rooted</span>&nbsp;<span class="op" id="3138230">||</span>&nbsp;<span class="ident" id="3138233">count</span><span class="op" id="3138238">(</span><span class="ident" id="3138239">name</span><span class="op" id="3138243">,</span>&nbsp;<span class="string" id="3138245">&#39;.&#39;</span><span class="op" id="3138248">)</span>&nbsp;<span class="op" id="3138250">&gt;=</span>&nbsp;<span class="ident" id="3138253">cfg</span><span class="op" id="3138256">.</span><span class="ident" id="3138257">dnsConfig</span><span class="op" id="3138266">.</span><span class="ident" id="3138267">ndots</span>&nbsp;<span class="op" id="3138273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3138277">rname</span>&nbsp;<span class="op" id="3138283">:=</span>&nbsp;<span class="ident" id="3138286">name</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3138293">if</span>&nbsp;<span class="op" id="3138296">!</span><span class="ident" id="3138297">rooted</span>&nbsp;<span class="op" id="3138304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3138309">rname</span>&nbsp;<span class="op" id="3138315">+=</span>&nbsp;<span class="string" id="3138318">&#34;.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3138324">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3138328">//&nbsp;Can&nbsp;try&nbsp;as&nbsp;ordinary&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3138359">cname</span><span class="op" id="3138364">,</span>&nbsp;<span class="ident" id="3138366">addrs</span><span class="op" id="3138371">,</span>&nbsp;<span class="ident" id="3138373">err</span>&nbsp;<span class="op" id="3138377">=</span>&nbsp;<span class="ident" id="3138379">tryOneName</span><span class="op" id="3138389">(</span><span class="ident" id="3138390">cfg</span><span class="op" id="3138393">.</span><span class="ident" id="3138394">dnsConfig</span><span class="op" id="3138403">,</span>&nbsp;<span class="ident" id="3138405">rname</span><span class="op" id="3138410">,</span>&nbsp;<span class="ident" id="3138412">qtype</span><span class="op" id="3138417">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3138421">if</span>&nbsp;<span class="ident" id="3138424">rooted</span>&nbsp;<span class="op" id="3138431">||</span>&nbsp;<span class="ident" id="3138434">err</span>&nbsp;<span class="op" id="3138438">==</span>&nbsp;<span class="ident" id="3138441">nil</span>&nbsp;<span class="op" id="3138445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3138450">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3138459">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3138462">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3138466">//&nbsp;Otherwise,&nbsp;try&nbsp;suffixes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3138495">for</span>&nbsp;<span class="ident" id="3138499">i</span>&nbsp;<span class="op" id="3138501">:=</span>&nbsp;<span class="num" id="3138504">0</span><span class="op" id="3138505">;</span>&nbsp;<span class="ident" id="3138507">i</span>&nbsp;<span class="op" id="3138509">&lt;</span>&nbsp;<span class="builtinfunc" id="3138511">len</span><span class="op" id="3138514">(</span><span class="ident" id="3138515">cfg</span><span class="op" id="3138518">.</span><span class="ident" id="3138519">dnsConfig</span><span class="op" id="3138528">.</span><span class="ident" id="3138529">search</span><span class="op" id="3138535">)</span><span class="op" id="3138536">;</span>&nbsp;<span class="ident" id="3138538">i</span><span class="op" id="3138539">++</span>&nbsp;<span class="op" id="3138542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3138546">rname</span>&nbsp;<span class="op" id="3138552">:=</span>&nbsp;<span class="ident" id="3138555">name</span>&nbsp;<span class="op" id="3138560">+</span>&nbsp;<span class="string" id="3138562">&#34;.&#34;</span>&nbsp;<span class="op" id="3138566">+</span>&nbsp;<span class="ident" id="3138568">cfg</span><span class="op" id="3138571">.</span><span class="ident" id="3138572">dnsConfig</span><span class="op" id="3138581">.</span><span class="ident" id="3138582">search</span><span class="op" id="3138588">[</span><span class="ident" id="3138589">i</span><span class="op" id="3138590">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3138594">if</span>&nbsp;<span class="ident" id="3138597">rname</span><span class="op" id="3138602">[</span><span class="builtinfunc" id="3138603">len</span><span class="op" id="3138606">(</span><span class="ident" id="3138607">rname</span><span class="op" id="3138612">)</span><span class="op" id="3138613">-</span><span class="num" id="3138614">1</span><span class="op" id="3138615">]</span>&nbsp;<span class="op" id="3138617">!=</span>&nbsp;<span class="string" id="3138620">&#39;.&#39;</span>&nbsp;<span class="op" id="3138624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3138629">rname</span>&nbsp;<span class="op" id="3138635">+=</span>&nbsp;<span class="string" id="3138638">&#34;.&#34;</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3138644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3138648">cname</span><span class="op" id="3138653">,</span>&nbsp;<span class="ident" id="3138655">addrs</span><span class="op" id="3138660">,</span>&nbsp;<span class="ident" id="3138662">err</span>&nbsp;<span class="op" id="3138666">=</span>&nbsp;<span class="ident" id="3138668">tryOneName</span><span class="op" id="3138678">(</span><span class="ident" id="3138679">cfg</span><span class="op" id="3138682">.</span><span class="ident" id="3138683">dnsConfig</span><span class="op" id="3138692">,</span>&nbsp;<span class="ident" id="3138694">rname</span><span class="op" id="3138699">,</span>&nbsp;<span class="ident" id="3138701">qtype</span><span class="op" id="3138706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3138710">if</span>&nbsp;<span class="ident" id="3138713">err</span>&nbsp;<span class="op" id="3138717">==</span>&nbsp;<span class="ident" id="3138720">nil</span>&nbsp;<span class="op" id="3138724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3138729">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3138738">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3138741">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3138745">//&nbsp;Last&nbsp;ditch&nbsp;effort:&nbsp;try&nbsp;unsuffixed&nbsp;only&nbsp;if&nbsp;we&nbsp;haven&#39;t&nbsp;already,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3138811">//&nbsp;that&nbsp;is,&nbsp;name&nbsp;is&nbsp;not&nbsp;rooted&nbsp;and&nbsp;has&nbsp;less&nbsp;than&nbsp;ndots&nbsp;dots.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3138873">if</span>&nbsp;<span class="ident" id="3138876">count</span><span class="op" id="3138881">(</span><span class="ident" id="3138882">name</span><span class="op" id="3138886">,</span>&nbsp;<span class="string" id="3138888">&#39;.&#39;</span><span class="op" id="3138891">)</span>&nbsp;<span class="op" id="3138893">&lt;</span>&nbsp;<span class="ident" id="3138895">cfg</span><span class="op" id="3138898">.</span><span class="ident" id="3138899">dnsConfig</span><span class="op" id="3138908">.</span><span class="ident" id="3138909">ndots</span>&nbsp;<span class="op" id="3138915">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3138919">cname</span><span class="op" id="3138924">,</span>&nbsp;<span class="ident" id="3138926">addrs</span><span class="op" id="3138931">,</span>&nbsp;<span class="ident" id="3138933">err</span>&nbsp;<span class="op" id="3138937">=</span>&nbsp;<span class="ident" id="3138939">tryOneName</span><span class="op" id="3138949">(</span><span class="ident" id="3138950">cfg</span><span class="op" id="3138953">.</span><span class="ident" id="3138954">dnsConfig</span><span class="op" id="3138963">,</span>&nbsp;<span class="ident" id="3138965">name</span><span class="op" id="3138969">+</span><span class="string" id="3138970">&#34;.&#34;</span><span class="op" id="3138973">,</span>&nbsp;<span class="ident" id="3138975">qtype</span><span class="op" id="3138980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3138984">if</span>&nbsp;<span class="ident" id="3138987">err</span>&nbsp;<span class="op" id="3138991">==</span>&nbsp;<span class="ident" id="3138994">nil</span>&nbsp;<span class="op" id="3138998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3139003">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3139012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3139015">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3139019">if</span>&nbsp;<span class="ident" id="3139022">e</span><span class="op" id="3139023">,</span>&nbsp;<span class="ident" id="3139025">ok</span>&nbsp;<span class="op" id="3139028">:=</span>&nbsp;<span class="ident" id="3139031">err</span><span class="op" id="3139034">.</span><span class="op" id="3139035">(</span><span class="op" id="3139036">*</span><span class="ident" id="3139037">DNSError</span><span class="op" id="3139045">)</span><span class="op" id="3139046">;</span>&nbsp;<span class="ident" id="3139048">ok</span>&nbsp;<span class="op" id="3139051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3139055">//&nbsp;Show&nbsp;original&nbsp;name&nbsp;passed&nbsp;to&nbsp;lookup,&nbsp;not&nbsp;suffixed&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3139115">//&nbsp;In&nbsp;general&nbsp;we&nbsp;might&nbsp;have&nbsp;tried&nbsp;many&nbsp;suffixes;&nbsp;showing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3139174">//&nbsp;just&nbsp;one&nbsp;is&nbsp;misleading.&nbsp;See&nbsp;also&nbsp;golang.org/issue/6324.</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3139235">e</span><span class="op" id="3139236">.</span><span class="ident" id="3139237">Name</span>&nbsp;<span class="op" id="3139242">=</span>&nbsp;<span class="ident" id="3139244">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3139250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3139253">return</span><br>
<span class="lineno"></span><span class="op" id="3139260">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span><span class="comment" id="3139263">//&nbsp;goLookupHost&nbsp;is&nbsp;the&nbsp;native&nbsp;Go&nbsp;implementation&nbsp;of&nbsp;LookupHost.</span><br>
<span class="lineno"></span><span class="comment" id="3139326">//&nbsp;Used&nbsp;only&nbsp;if&nbsp;cgoLookupHost&nbsp;refuses&nbsp;to&nbsp;handle&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span><span class="comment" id="3139386">//&nbsp;(that&nbsp;is,&nbsp;only&nbsp;if&nbsp;cgoLookupHost&nbsp;is&nbsp;the&nbsp;stub&nbsp;in&nbsp;cgo_stub.go).</span><br>
<span class="lineno"></span><span class="comment" id="3139450">//&nbsp;Normally&nbsp;we&nbsp;let&nbsp;cgo&nbsp;use&nbsp;the&nbsp;C&nbsp;library&nbsp;resolver&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3139511">//&nbsp;depending&nbsp;on&nbsp;our&nbsp;lookup&nbsp;code,&nbsp;so&nbsp;that&nbsp;Go&nbsp;and&nbsp;C&nbsp;get&nbsp;the&nbsp;same</span><br>
<span class="lineno">340</span><span class="comment" id="3139574">//&nbsp;answers.</span><br>
<span class="lineno"></span><span class="keyword" id="3139586">func</span>&nbsp;<span class="ident" id="3139591">goLookupHost</span><span class="op" id="3139603">(</span><span class="ident" id="3139604">name</span>&nbsp;<span class="builtintype" id="3139609">string</span><span class="op" id="3139615">)</span>&nbsp;<span class="op" id="3139617">(</span><span class="ident" id="3139618">addrs</span>&nbsp;<span class="op" id="3139624">[</span><span class="op" id="3139625">]</span><span class="builtintype" id="3139626">string</span><span class="op" id="3139632">,</span>&nbsp;<span class="ident" id="3139634">err</span>&nbsp;<span class="builtintype" id="3139638">error</span><span class="op" id="3139643">)</span>&nbsp;<span class="op" id="3139645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3139648">//&nbsp;Use&nbsp;entries&nbsp;from&nbsp;/etc/hosts&nbsp;if&nbsp;they&nbsp;match.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3139695">addrs</span>&nbsp;<span class="op" id="3139701">=</span>&nbsp;<span class="ident" id="3139703">lookupStaticHost</span><span class="op" id="3139719">(</span><span class="ident" id="3139720">name</span><span class="op" id="3139724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3139727">if</span>&nbsp;<span class="builtinfunc" id="3139730">len</span><span class="op" id="3139733">(</span><span class="ident" id="3139734">addrs</span><span class="op" id="3139739">)</span>&nbsp;<span class="op" id="3139741">&gt;</span>&nbsp;<span class="num" id="3139743">0</span>&nbsp;<span class="op" id="3139745">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3139749">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3139757">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3139760">ips</span><span class="op" id="3139763">,</span>&nbsp;<span class="ident" id="3139765">err</span>&nbsp;<span class="op" id="3139769">:=</span>&nbsp;<span class="ident" id="3139772">goLookupIP</span><span class="op" id="3139782">(</span><span class="ident" id="3139783">name</span><span class="op" id="3139787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3139790">if</span>&nbsp;<span class="ident" id="3139793">err</span>&nbsp;<span class="op" id="3139797">!=</span>&nbsp;<span class="ident" id="3139800">nil</span>&nbsp;<span class="op" id="3139804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3139808">return</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3139816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3139819">addrs</span>&nbsp;<span class="op" id="3139825">=</span>&nbsp;<span class="builtinfunc" id="3139827">make</span><span class="op" id="3139831">(</span><span class="op" id="3139832">[</span><span class="op" id="3139833">]</span><span class="builtintype" id="3139834">string</span><span class="op" id="3139840">,</span>&nbsp;<span class="num" id="3139842">0</span><span class="op" id="3139843">,</span>&nbsp;<span class="builtinfunc" id="3139845">len</span><span class="op" id="3139848">(</span><span class="ident" id="3139849">ips</span><span class="op" id="3139852">)</span><span class="op" id="3139853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3139856">for</span>&nbsp;<span class="ident" id="3139860">_</span><span class="op" id="3139861">,</span>&nbsp;<span class="ident" id="3139863">ip</span>&nbsp;<span class="op" id="3139866">:=</span>&nbsp;<span class="keyword" id="3139869">range</span>&nbsp;<span class="ident" id="3139875">ips</span>&nbsp;<span class="op" id="3139879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3139883">addrs</span>&nbsp;<span class="op" id="3139889">=</span>&nbsp;<span class="builtinfunc" id="3139891">append</span><span class="op" id="3139897">(</span><span class="ident" id="3139898">addrs</span><span class="op" id="3139903">,</span>&nbsp;<span class="ident" id="3139905">ip</span><span class="op" id="3139907">.</span><span class="ident" id="3139908">String</span><span class="op" id="3139914">(</span><span class="op" id="3139915">)</span><span class="op" id="3139916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3139919">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3139922">return</span><br>
<span class="lineno"></span><span class="op" id="3139929">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3139932">//&nbsp;goLookupIP&nbsp;is&nbsp;the&nbsp;native&nbsp;Go&nbsp;implementation&nbsp;of&nbsp;LookupIP.</span><br>
<span class="lineno"></span><span class="comment" id="3139991">//&nbsp;Used&nbsp;only&nbsp;if&nbsp;cgoLookupIP&nbsp;refuses&nbsp;to&nbsp;handle&nbsp;the&nbsp;request</span><br>
<span class="lineno">360</span><span class="comment" id="3140049">//&nbsp;(that&nbsp;is,&nbsp;only&nbsp;if&nbsp;cgoLookupIP&nbsp;is&nbsp;the&nbsp;stub&nbsp;in&nbsp;cgo_stub.go).</span><br>
<span class="lineno"></span><span class="comment" id="3140111">//&nbsp;Normally&nbsp;we&nbsp;let&nbsp;cgo&nbsp;use&nbsp;the&nbsp;C&nbsp;library&nbsp;resolver&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3140172">//&nbsp;depending&nbsp;on&nbsp;our&nbsp;lookup&nbsp;code,&nbsp;so&nbsp;that&nbsp;Go&nbsp;and&nbsp;C&nbsp;get&nbsp;the&nbsp;same</span><br>
<span class="lineno"></span><span class="comment" id="3140235">//&nbsp;answers.</span><br>
<span class="lineno"></span><span class="keyword" id="3140247">func</span>&nbsp;<span class="ident" id="3140252">goLookupIP</span><span class="op" id="3140262">(</span><span class="ident" id="3140263">name</span>&nbsp;<span class="builtintype" id="3140268">string</span><span class="op" id="3140274">)</span>&nbsp;<span class="op" id="3140276">(</span><span class="ident" id="3140277">addrs</span>&nbsp;<span class="op" id="3140283">[</span><span class="op" id="3140284">]</span><span class="ident" id="3140285">IP</span><span class="op" id="3140287">,</span>&nbsp;<span class="ident" id="3140289">err</span>&nbsp;<span class="builtintype" id="3140293">error</span><span class="op" id="3140298">)</span>&nbsp;<span class="op" id="3140300">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3140303">//&nbsp;Use&nbsp;entries&nbsp;from&nbsp;/etc/hosts&nbsp;if&nbsp;possible.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3140348">haddrs</span>&nbsp;<span class="op" id="3140355">:=</span>&nbsp;<span class="ident" id="3140358">lookupStaticHost</span><span class="op" id="3140374">(</span><span class="ident" id="3140375">name</span><span class="op" id="3140379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3140382">if</span>&nbsp;<span class="builtinfunc" id="3140385">len</span><span class="op" id="3140388">(</span><span class="ident" id="3140389">haddrs</span><span class="op" id="3140395">)</span>&nbsp;<span class="op" id="3140397">&gt;</span>&nbsp;<span class="num" id="3140399">0</span>&nbsp;<span class="op" id="3140401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3140405">for</span>&nbsp;<span class="ident" id="3140409">_</span><span class="op" id="3140410">,</span>&nbsp;<span class="ident" id="3140412">haddr</span>&nbsp;<span class="op" id="3140418">:=</span>&nbsp;<span class="keyword" id="3140421">range</span>&nbsp;<span class="ident" id="3140427">haddrs</span>&nbsp;<span class="op" id="3140434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3140439">if</span>&nbsp;<span class="ident" id="3140442">ip</span>&nbsp;<span class="op" id="3140445">:=</span>&nbsp;<span class="ident" id="3140448">ParseIP</span><span class="op" id="3140455">(</span><span class="ident" id="3140456">haddr</span><span class="op" id="3140461">)</span><span class="op" id="3140462">;</span>&nbsp;<span class="ident" id="3140464">ip</span>&nbsp;<span class="op" id="3140467">!=</span>&nbsp;<span class="ident" id="3140470">nil</span>&nbsp;<span class="op" id="3140474">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3140480">addrs</span>&nbsp;<span class="op" id="3140486">=</span>&nbsp;<span class="builtinfunc" id="3140488">append</span><span class="op" id="3140494">(</span><span class="ident" id="3140495">addrs</span><span class="op" id="3140500">,</span>&nbsp;<span class="ident" id="3140502">ip</span><span class="op" id="3140504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3140509">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3140513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3140517">if</span>&nbsp;<span class="builtinfunc" id="3140520">len</span><span class="op" id="3140523">(</span><span class="ident" id="3140524">addrs</span><span class="op" id="3140529">)</span>&nbsp;<span class="op" id="3140531">&gt;</span>&nbsp;<span class="num" id="3140533">0</span>&nbsp;<span class="op" id="3140535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3140540">return</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3140549">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3140552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3140555">type</span>&nbsp;<span class="ident" id="3140560">racer</span>&nbsp;<span class="keyword" id="3140566">struct</span>&nbsp;<span class="op" id="3140573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3140577">qtype</span>&nbsp;<span class="builtintype" id="3140583">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3140592">rrs</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3140598">[</span><span class="op" id="3140599">]</span><span class="ident" id="3140600">dnsRR</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3140608">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3140615">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3140618">lane</span>&nbsp;<span class="op" id="3140623">:=</span>&nbsp;<span class="builtinfunc" id="3140626">make</span><span class="op" id="3140630">(</span><span class="keyword" id="3140631">chan</span>&nbsp;<span class="ident" id="3140636">racer</span><span class="op" id="3140641">,</span>&nbsp;<span class="num" id="3140643">1</span><span class="op" id="3140644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3140647">qtypes</span>&nbsp;<span class="op" id="3140654">:=</span>&nbsp;<span class="op" id="3140657">[</span><span class="op" id="3140658">...</span><span class="op" id="3140661">]</span><span class="builtintype" id="3140662">uint16</span><span class="op" id="3140668">{</span><span class="ident" id="3140669">dnsTypeA</span><span class="op" id="3140677">,</span>&nbsp;<span class="ident" id="3140679">dnsTypeAAAA</span><span class="op" id="3140690">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3140693">for</span>&nbsp;<span class="ident" id="3140697">_</span><span class="op" id="3140698">,</span>&nbsp;<span class="ident" id="3140700">qtype</span>&nbsp;<span class="op" id="3140706">:=</span>&nbsp;<span class="keyword" id="3140709">range</span>&nbsp;<span class="ident" id="3140715">qtypes</span>&nbsp;<span class="op" id="3140722">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3140726">go</span>&nbsp;<span class="keyword" id="3140729">func</span><span class="op" id="3140733">(</span><span class="ident" id="3140734">qtype</span>&nbsp;<span class="builtintype" id="3140740">uint16</span><span class="op" id="3140746">)</span>&nbsp;<span class="op" id="3140748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3140753">_</span><span class="op" id="3140754">,</span>&nbsp;<span class="ident" id="3140756">rrs</span><span class="op" id="3140759">,</span>&nbsp;<span class="ident" id="3140761">err</span>&nbsp;<span class="op" id="3140765">:=</span>&nbsp;<span class="ident" id="3140768">lookup</span><span class="op" id="3140774">(</span><span class="ident" id="3140775">name</span><span class="op" id="3140779">,</span>&nbsp;<span class="ident" id="3140781">qtype</span><span class="op" id="3140786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3140791">lane</span>&nbsp;<span class="op" id="3140796">&lt;-</span>&nbsp;<span class="ident" id="3140799">racer</span><span class="op" id="3140804">{</span><span class="ident" id="3140805">qtype</span><span class="op" id="3140810">,</span>&nbsp;<span class="ident" id="3140812">rrs</span><span class="op" id="3140815">,</span>&nbsp;<span class="ident" id="3140817">err</span><span class="op" id="3140820">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3140824">}</span><span class="op" id="3140825">(</span><span class="ident" id="3140826">qtype</span><span class="op" id="3140831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3140834">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3140837">var</span>&nbsp;<span class="ident" id="3140841">lastErr</span>&nbsp;<span class="builtintype" id="3140849">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3140856">for</span>&nbsp;<span class="keyword" id="3140860">range</span>&nbsp;<span class="ident" id="3140866">qtypes</span>&nbsp;<span class="op" id="3140873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3140877">racer</span>&nbsp;<span class="op" id="3140883">:=</span>&nbsp;<span class="op" id="3140886">&lt;-</span><span class="ident" id="3140888">lane</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3140895">if</span>&nbsp;<span class="ident" id="3140898">racer</span><span class="op" id="3140903">.</span><span class="builtintype" id="3140904">error</span>&nbsp;<span class="op" id="3140910">!=</span>&nbsp;<span class="ident" id="3140913">nil</span>&nbsp;<span class="op" id="3140917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3140922">lastErr</span>&nbsp;<span class="op" id="3140930">=</span>&nbsp;<span class="ident" id="3140932">racer</span><span class="op" id="3140937">.</span><span class="builtintype" id="3140938">error</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3140947">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3140958">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3140962">switch</span>&nbsp;<span class="ident" id="3140969">racer</span><span class="op" id="3140974">.</span><span class="ident" id="3140975">qtype</span>&nbsp;<span class="op" id="3140981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3140985">case</span>&nbsp;<span class="ident" id="3140990">dnsTypeA</span><span class="op" id="3140998">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3141003">addrs</span>&nbsp;<span class="op" id="3141009">=</span>&nbsp;<span class="builtinfunc" id="3141011">append</span><span class="op" id="3141017">(</span><span class="ident" id="3141018">addrs</span><span class="op" id="3141023">,</span>&nbsp;<span class="ident" id="3141025">convertRR_A</span><span class="op" id="3141036">(</span><span class="ident" id="3141037">racer</span><span class="op" id="3141042">.</span><span class="ident" id="3141043">rrs</span><span class="op" id="3141046">)</span><span class="op" id="3141047">...</span><span class="op" id="3141050">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3141054">case</span>&nbsp;<span class="ident" id="3141059">dnsTypeAAAA</span><span class="op" id="3141070">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3141075">addrs</span>&nbsp;<span class="op" id="3141081">=</span>&nbsp;<span class="builtinfunc" id="3141083">append</span><span class="op" id="3141089">(</span><span class="ident" id="3141090">addrs</span><span class="op" id="3141095">,</span>&nbsp;<span class="ident" id="3141097">convertRR_AAAA</span><span class="op" id="3141111">(</span><span class="ident" id="3141112">racer</span><span class="op" id="3141117">.</span><span class="ident" id="3141118">rrs</span><span class="op" id="3141121">)</span><span class="op" id="3141122">...</span><span class="op" id="3141125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3141129">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3141132">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3141135">if</span>&nbsp;<span class="builtinfunc" id="3141138">len</span><span class="op" id="3141141">(</span><span class="ident" id="3141142">addrs</span><span class="op" id="3141147">)</span>&nbsp;<span class="op" id="3141149">==</span>&nbsp;<span class="num" id="3141152">0</span>&nbsp;<span class="op" id="3141154">&amp;&amp;</span>&nbsp;<span class="ident" id="3141157">lastErr</span>&nbsp;<span class="op" id="3141165">!=</span>&nbsp;<span class="ident" id="3141168">nil</span>&nbsp;<span class="op" id="3141172">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3141176">return</span>&nbsp;<span class="ident" id="3141183">nil</span><span class="op" id="3141186">,</span>&nbsp;<span class="ident" id="3141188">lastErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3141197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3141200">return</span>&nbsp;<span class="ident" id="3141207">addrs</span><span class="op" id="3141212">,</span>&nbsp;<span class="ident" id="3141214">nil</span><br>
<span class="lineno"></span><span class="op" id="3141218">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="comment" id="3141221">//&nbsp;goLookupCNAME&nbsp;is&nbsp;the&nbsp;native&nbsp;Go&nbsp;implementation&nbsp;of&nbsp;LookupCNAME.</span><br>
<span class="lineno"></span><span class="comment" id="3141286">//&nbsp;Used&nbsp;only&nbsp;if&nbsp;cgoLookupCNAME&nbsp;refuses&nbsp;to&nbsp;handle&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span><span class="comment" id="3141347">//&nbsp;(that&nbsp;is,&nbsp;only&nbsp;if&nbsp;cgoLookupCNAME&nbsp;is&nbsp;the&nbsp;stub&nbsp;in&nbsp;cgo_stub.go).</span><br>
<span class="lineno"></span><span class="comment" id="3141412">//&nbsp;Normally&nbsp;we&nbsp;let&nbsp;cgo&nbsp;use&nbsp;the&nbsp;C&nbsp;library&nbsp;resolver&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3141473">//&nbsp;depending&nbsp;on&nbsp;our&nbsp;lookup&nbsp;code,&nbsp;so&nbsp;that&nbsp;Go&nbsp;and&nbsp;C&nbsp;get&nbsp;the&nbsp;same</span><br>
<span class="lineno">415</span><span class="comment" id="3141536">//&nbsp;answers.</span><br>
<span class="lineno"></span><span class="keyword" id="3141548">func</span>&nbsp;<span class="ident" id="3141553">goLookupCNAME</span><span class="op" id="3141566">(</span><span class="ident" id="3141567">name</span>&nbsp;<span class="builtintype" id="3141572">string</span><span class="op" id="3141578">)</span>&nbsp;<span class="op" id="3141580">(</span><span class="ident" id="3141581">cname</span>&nbsp;<span class="builtintype" id="3141587">string</span><span class="op" id="3141593">,</span>&nbsp;<span class="ident" id="3141595">err</span>&nbsp;<span class="builtintype" id="3141599">error</span><span class="op" id="3141604">)</span>&nbsp;<span class="op" id="3141606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3141609">_</span><span class="op" id="3141610">,</span>&nbsp;<span class="ident" id="3141612">rr</span><span class="op" id="3141614">,</span>&nbsp;<span class="ident" id="3141616">err</span>&nbsp;<span class="op" id="3141620">:=</span>&nbsp;<span class="ident" id="3141623">lookup</span><span class="op" id="3141629">(</span><span class="ident" id="3141630">name</span><span class="op" id="3141634">,</span>&nbsp;<span class="ident" id="3141636">dnsTypeCNAME</span><span class="op" id="3141648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3141651">if</span>&nbsp;<span class="ident" id="3141654">err</span>&nbsp;<span class="op" id="3141658">!=</span>&nbsp;<span class="ident" id="3141661">nil</span>&nbsp;<span class="op" id="3141665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3141669">return</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3141677">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3141680">cname</span>&nbsp;<span class="op" id="3141686">=</span>&nbsp;<span class="ident" id="3141688">rr</span><span class="op" id="3141690">[</span><span class="num" id="3141691">0</span><span class="op" id="3141692">]</span><span class="op" id="3141693">.</span><span class="op" id="3141694">(</span><span class="op" id="3141695">*</span><span class="ident" id="3141696">dnsRR_CNAME</span><span class="op" id="3141707">)</span><span class="op" id="3141708">.</span><span class="ident" id="3141709">Cname</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3141716">return</span><br>
<span class="lineno"></span><span class="op" id="3141723">}</span>
</div>
</body>
</html>
