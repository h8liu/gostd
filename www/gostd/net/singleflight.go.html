<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html" class="current">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4157607">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4157663">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4157717">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4157768">package</span>&nbsp;<span class="ident" id="4157776">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4157781">import</span>&nbsp;<span class="string" id="4157788">&#34;sync&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4157796">//&nbsp;call&nbsp;is&nbsp;an&nbsp;in-flight&nbsp;or&nbsp;completed&nbsp;singleflight.Do&nbsp;call</span><br>
<span class="lineno">10</span><span class="keyword" id="4157854">type</span>&nbsp;<span class="ident" id="4157859">call</span>&nbsp;<span class="keyword" id="4157864">struct</span>&nbsp;<span class="op" id="4157871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4157874">wg</span>&nbsp;<span class="ident" id="4157877">sync</span><span class="op" id="4157881">.</span><span class="ident" id="4157882">WaitGroup</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4157894">//&nbsp;These&nbsp;fields&nbsp;are&nbsp;written&nbsp;once&nbsp;before&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4157957">//&nbsp;and&nbsp;are&nbsp;only&nbsp;read&nbsp;after&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done.</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4158008">val</span>&nbsp;<span class="keyword" id="4158012">interface</span><span class="op" id="4158021">{</span><span class="op" id="4158022">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4158025">err</span>&nbsp;<span class="builtintype" id="4158029">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4158037">//&nbsp;These&nbsp;fields&nbsp;are&nbsp;read&nbsp;and&nbsp;written&nbsp;with&nbsp;the&nbsp;singleflight</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4158097">//&nbsp;mutex&nbsp;held&nbsp;before&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done,&nbsp;and&nbsp;are&nbsp;read&nbsp;but</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4158159">//&nbsp;not&nbsp;written&nbsp;after&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4158204">dups</span>&nbsp;&nbsp;<span class="builtintype" id="4158210">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4158215">chans</span>&nbsp;<span class="op" id="4158221">[</span><span class="op" id="4158222">]</span><span class="keyword" id="4158223">chan</span><span class="op" id="4158227">&lt;-</span>&nbsp;<span class="ident" id="4158230">singleflightResult</span><br>
<span class="lineno"></span><span class="op" id="4158249">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="4158252">//&nbsp;singleflight&nbsp;represents&nbsp;a&nbsp;class&nbsp;of&nbsp;work&nbsp;and&nbsp;forms&nbsp;a&nbsp;namespace&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="4158320">//&nbsp;which&nbsp;units&nbsp;of&nbsp;work&nbsp;can&nbsp;be&nbsp;executed&nbsp;with&nbsp;duplicate&nbsp;suppression.</span><br>
<span class="lineno"></span><span class="keyword" id="4158387">type</span>&nbsp;<span class="ident" id="4158392">singleflight</span>&nbsp;<span class="keyword" id="4158405">struct</span>&nbsp;<span class="op" id="4158412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4158415">mu</span>&nbsp;<span class="ident" id="4158418">sync</span><span class="op" id="4158422">.</span><span class="ident" id="4158423">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4158435">//&nbsp;protects&nbsp;m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4158450">m</span>&nbsp;&nbsp;<span class="keyword" id="4158453">map</span><span class="op" id="4158456">[</span><span class="builtintype" id="4158457">string</span><span class="op" id="4158463">]</span><span class="op" id="4158464">*</span><span class="ident" id="4158465">call</span>&nbsp;<span class="comment" id="4158470">//&nbsp;lazily&nbsp;initialized</span><br>
<span class="lineno">30</span><span class="op" id="4158492">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4158495">//&nbsp;singleflightResult&nbsp;holds&nbsp;the&nbsp;results&nbsp;of&nbsp;Do,&nbsp;so&nbsp;they&nbsp;can&nbsp;be&nbsp;passed</span><br>
<span class="lineno"></span><span class="comment" id="4158564">//&nbsp;on&nbsp;a&nbsp;channel.</span><br>
<span class="lineno"></span><span class="keyword" id="4158581">type</span>&nbsp;<span class="ident" id="4158586">singleflightResult</span>&nbsp;<span class="keyword" id="4158605">struct</span>&nbsp;<span class="op" id="4158612">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4158615">v</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4158622">interface</span><span class="op" id="4158631">{</span><span class="op" id="4158632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4158635">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4158642">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4158649">shared</span>&nbsp;<span class="builtintype" id="4158656">bool</span><br>
<span class="lineno"></span><span class="op" id="4158661">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="4158664">//&nbsp;Do&nbsp;executes&nbsp;and&nbsp;returns&nbsp;the&nbsp;results&nbsp;of&nbsp;the&nbsp;given&nbsp;function,&nbsp;making</span><br>
<span class="lineno"></span><span class="comment" id="4158733">//&nbsp;sure&nbsp;that&nbsp;only&nbsp;one&nbsp;execution&nbsp;is&nbsp;in-flight&nbsp;for&nbsp;a&nbsp;given&nbsp;key&nbsp;at&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4158799">//&nbsp;time.&nbsp;If&nbsp;a&nbsp;duplicate&nbsp;comes&nbsp;in,&nbsp;the&nbsp;duplicate&nbsp;caller&nbsp;waits&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4158868">//&nbsp;original&nbsp;to&nbsp;complete&nbsp;and&nbsp;receives&nbsp;the&nbsp;same&nbsp;results.</span><br>
<span class="lineno"></span><span class="comment" id="4158923">//&nbsp;The&nbsp;return&nbsp;value&nbsp;shared&nbsp;indicates&nbsp;whether&nbsp;v&nbsp;was&nbsp;given&nbsp;to&nbsp;multiple&nbsp;callers.</span><br>
<span class="lineno">45</span><span class="keyword" id="4159001">func</span>&nbsp;<span class="op" id="4159006">(</span><span class="ident" id="4159007">g</span>&nbsp;<span class="op" id="4159009">*</span><span class="ident" id="4159010">singleflight</span><span class="op" id="4159022">)</span>&nbsp;<span class="ident" id="4159024">Do</span><span class="op" id="4159026">(</span><span class="ident" id="4159027">key</span>&nbsp;<span class="builtintype" id="4159031">string</span><span class="op" id="4159037">,</span>&nbsp;<span class="ident" id="4159039">fn</span>&nbsp;<span class="keyword" id="4159042">func</span><span class="op" id="4159046">(</span><span class="op" id="4159047">)</span>&nbsp;<span class="op" id="4159049">(</span><span class="keyword" id="4159050">interface</span><span class="op" id="4159059">{</span><span class="op" id="4159060">}</span><span class="op" id="4159061">,</span>&nbsp;<span class="builtintype" id="4159063">error</span><span class="op" id="4159068">)</span><span class="op" id="4159069">)</span>&nbsp;<span class="op" id="4159071">(</span><span class="ident" id="4159072">v</span>&nbsp;<span class="keyword" id="4159074">interface</span><span class="op" id="4159083">{</span><span class="op" id="4159084">}</span><span class="op" id="4159085">,</span>&nbsp;<span class="ident" id="4159087">err</span>&nbsp;<span class="builtintype" id="4159091">error</span><span class="op" id="4159096">,</span>&nbsp;<span class="ident" id="4159098">shared</span>&nbsp;<span class="builtintype" id="4159105">bool</span><span class="op" id="4159109">)</span>&nbsp;<span class="op" id="4159111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4159114">g</span><span class="op" id="4159115">.</span><span class="ident" id="4159116">mu</span><span class="op" id="4159118">.</span><span class="ident" id="4159119">Lock</span><span class="op" id="4159123">(</span><span class="op" id="4159124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4159127">if</span>&nbsp;<span class="ident" id="4159130">g</span><span class="op" id="4159131">.</span><span class="ident" id="4159132">m</span>&nbsp;<span class="op" id="4159134">==</span>&nbsp;<span class="ident" id="4159137">nil</span>&nbsp;<span class="op" id="4159141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4159145">g</span><span class="op" id="4159146">.</span><span class="ident" id="4159147">m</span>&nbsp;<span class="op" id="4159149">=</span>&nbsp;<span class="builtinfunc" id="4159151">make</span><span class="op" id="4159155">(</span><span class="keyword" id="4159156">map</span><span class="op" id="4159159">[</span><span class="builtintype" id="4159160">string</span><span class="op" id="4159166">]</span><span class="op" id="4159167">*</span><span class="ident" id="4159168">call</span><span class="op" id="4159172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4159175">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4159178">if</span>&nbsp;<span class="ident" id="4159181">c</span><span class="op" id="4159182">,</span>&nbsp;<span class="ident" id="4159184">ok</span>&nbsp;<span class="op" id="4159187">:=</span>&nbsp;<span class="ident" id="4159190">g</span><span class="op" id="4159191">.</span><span class="ident" id="4159192">m</span><span class="op" id="4159193">[</span><span class="ident" id="4159194">key</span><span class="op" id="4159197">]</span><span class="op" id="4159198">;</span>&nbsp;<span class="ident" id="4159200">ok</span>&nbsp;<span class="op" id="4159203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4159207">c</span><span class="op" id="4159208">.</span><span class="ident" id="4159209">dups</span><span class="op" id="4159213">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4159218">g</span><span class="op" id="4159219">.</span><span class="ident" id="4159220">mu</span><span class="op" id="4159222">.</span><span class="ident" id="4159223">Unlock</span><span class="op" id="4159229">(</span><span class="op" id="4159230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4159234">c</span><span class="op" id="4159235">.</span><span class="ident" id="4159236">wg</span><span class="op" id="4159238">.</span><span class="ident" id="4159239">Wait</span><span class="op" id="4159243">(</span><span class="op" id="4159244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4159248">return</span>&nbsp;<span class="ident" id="4159255">c</span><span class="op" id="4159256">.</span><span class="ident" id="4159257">val</span><span class="op" id="4159260">,</span>&nbsp;<span class="ident" id="4159262">c</span><span class="op" id="4159263">.</span><span class="ident" id="4159264">err</span><span class="op" id="4159267">,</span>&nbsp;<span class="builtintype" id="4159269">true</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4159275">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4159278">c</span>&nbsp;<span class="op" id="4159280">:=</span>&nbsp;<span class="builtinfunc" id="4159283">new</span><span class="op" id="4159286">(</span><span class="ident" id="4159287">call</span><span class="op" id="4159291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4159294">c</span><span class="op" id="4159295">.</span><span class="ident" id="4159296">wg</span><span class="op" id="4159298">.</span><span class="ident" id="4159299">Add</span><span class="op" id="4159302">(</span><span class="num" id="4159303">1</span><span class="op" id="4159304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4159307">g</span><span class="op" id="4159308">.</span><span class="ident" id="4159309">m</span><span class="op" id="4159310">[</span><span class="ident" id="4159311">key</span><span class="op" id="4159314">]</span>&nbsp;<span class="op" id="4159316">=</span>&nbsp;<span class="ident" id="4159318">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4159321">g</span><span class="op" id="4159322">.</span><span class="ident" id="4159323">mu</span><span class="op" id="4159325">.</span><span class="ident" id="4159326">Unlock</span><span class="op" id="4159332">(</span><span class="op" id="4159333">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4159337">g</span><span class="op" id="4159338">.</span><span class="ident" id="4159339">doCall</span><span class="op" id="4159345">(</span><span class="ident" id="4159346">c</span><span class="op" id="4159347">,</span>&nbsp;<span class="ident" id="4159349">key</span><span class="op" id="4159352">,</span>&nbsp;<span class="ident" id="4159354">fn</span><span class="op" id="4159356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4159359">return</span>&nbsp;<span class="ident" id="4159366">c</span><span class="op" id="4159367">.</span><span class="ident" id="4159368">val</span><span class="op" id="4159371">,</span>&nbsp;<span class="ident" id="4159373">c</span><span class="op" id="4159374">.</span><span class="ident" id="4159375">err</span><span class="op" id="4159378">,</span>&nbsp;<span class="ident" id="4159380">c</span><span class="op" id="4159381">.</span><span class="ident" id="4159382">dups</span>&nbsp;<span class="op" id="4159387">&gt;</span>&nbsp;<span class="num" id="4159389">0</span><br>
<span class="lineno"></span><span class="op" id="4159391">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="4159394">//&nbsp;DoChan&nbsp;is&nbsp;like&nbsp;Do&nbsp;but&nbsp;returns&nbsp;a&nbsp;channel&nbsp;that&nbsp;will&nbsp;receive&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4159459">//&nbsp;results&nbsp;when&nbsp;they&nbsp;are&nbsp;ready.</span><br>
<span class="lineno"></span><span class="keyword" id="4159491">func</span>&nbsp;<span class="op" id="4159496">(</span><span class="ident" id="4159497">g</span>&nbsp;<span class="op" id="4159499">*</span><span class="ident" id="4159500">singleflight</span><span class="op" id="4159512">)</span>&nbsp;<span class="ident" id="4159514">DoChan</span><span class="op" id="4159520">(</span><span class="ident" id="4159521">key</span>&nbsp;<span class="builtintype" id="4159525">string</span><span class="op" id="4159531">,</span>&nbsp;<span class="ident" id="4159533">fn</span>&nbsp;<span class="keyword" id="4159536">func</span><span class="op" id="4159540">(</span><span class="op" id="4159541">)</span>&nbsp;<span class="op" id="4159543">(</span><span class="keyword" id="4159544">interface</span><span class="op" id="4159553">{</span><span class="op" id="4159554">}</span><span class="op" id="4159555">,</span>&nbsp;<span class="builtintype" id="4159557">error</span><span class="op" id="4159562">)</span><span class="op" id="4159563">)</span>&nbsp;<span class="op" id="4159565">&lt;-</span><span class="keyword" id="4159567">chan</span>&nbsp;<span class="ident" id="4159572">singleflightResult</span>&nbsp;<span class="op" id="4159591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4159594">ch</span>&nbsp;<span class="op" id="4159597">:=</span>&nbsp;<span class="builtinfunc" id="4159600">make</span><span class="op" id="4159604">(</span><span class="keyword" id="4159605">chan</span>&nbsp;<span class="ident" id="4159610">singleflightResult</span><span class="op" id="4159628">,</span>&nbsp;<span class="num" id="4159630">1</span><span class="op" id="4159631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4159634">g</span><span class="op" id="4159635">.</span><span class="ident" id="4159636">mu</span><span class="op" id="4159638">.</span><span class="ident" id="4159639">Lock</span><span class="op" id="4159643">(</span><span class="op" id="4159644">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4159647">if</span>&nbsp;<span class="ident" id="4159650">g</span><span class="op" id="4159651">.</span><span class="ident" id="4159652">m</span>&nbsp;<span class="op" id="4159654">==</span>&nbsp;<span class="ident" id="4159657">nil</span>&nbsp;<span class="op" id="4159661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4159665">g</span><span class="op" id="4159666">.</span><span class="ident" id="4159667">m</span>&nbsp;<span class="op" id="4159669">=</span>&nbsp;<span class="builtinfunc" id="4159671">make</span><span class="op" id="4159675">(</span><span class="keyword" id="4159676">map</span><span class="op" id="4159679">[</span><span class="builtintype" id="4159680">string</span><span class="op" id="4159686">]</span><span class="op" id="4159687">*</span><span class="ident" id="4159688">call</span><span class="op" id="4159692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4159695">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4159698">if</span>&nbsp;<span class="ident" id="4159701">c</span><span class="op" id="4159702">,</span>&nbsp;<span class="ident" id="4159704">ok</span>&nbsp;<span class="op" id="4159707">:=</span>&nbsp;<span class="ident" id="4159710">g</span><span class="op" id="4159711">.</span><span class="ident" id="4159712">m</span><span class="op" id="4159713">[</span><span class="ident" id="4159714">key</span><span class="op" id="4159717">]</span><span class="op" id="4159718">;</span>&nbsp;<span class="ident" id="4159720">ok</span>&nbsp;<span class="op" id="4159723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4159727">c</span><span class="op" id="4159728">.</span><span class="ident" id="4159729">dups</span><span class="op" id="4159733">++</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4159738">c</span><span class="op" id="4159739">.</span><span class="ident" id="4159740">chans</span>&nbsp;<span class="op" id="4159746">=</span>&nbsp;<span class="builtinfunc" id="4159748">append</span><span class="op" id="4159754">(</span><span class="ident" id="4159755">c</span><span class="op" id="4159756">.</span><span class="ident" id="4159757">chans</span><span class="op" id="4159762">,</span>&nbsp;<span class="ident" id="4159764">ch</span><span class="op" id="4159766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4159770">g</span><span class="op" id="4159771">.</span><span class="ident" id="4159772">mu</span><span class="op" id="4159774">.</span><span class="ident" id="4159775">Unlock</span><span class="op" id="4159781">(</span><span class="op" id="4159782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4159786">return</span>&nbsp;<span class="ident" id="4159793">ch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4159797">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4159800">c</span>&nbsp;<span class="op" id="4159802">:=</span>&nbsp;<span class="op" id="4159805">&amp;</span><span class="ident" id="4159806">call</span><span class="op" id="4159810">{</span><span class="ident" id="4159811">chans</span><span class="op" id="4159816">:</span>&nbsp;<span class="op" id="4159818">[</span><span class="op" id="4159819">]</span><span class="keyword" id="4159820">chan</span><span class="op" id="4159824">&lt;-</span>&nbsp;<span class="ident" id="4159827">singleflightResult</span><span class="op" id="4159845">{</span><span class="ident" id="4159846">ch</span><span class="op" id="4159848">}</span><span class="op" id="4159849">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4159852">c</span><span class="op" id="4159853">.</span><span class="ident" id="4159854">wg</span><span class="op" id="4159856">.</span><span class="ident" id="4159857">Add</span><span class="op" id="4159860">(</span><span class="num" id="4159861">1</span><span class="op" id="4159862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4159865">g</span><span class="op" id="4159866">.</span><span class="ident" id="4159867">m</span><span class="op" id="4159868">[</span><span class="ident" id="4159869">key</span><span class="op" id="4159872">]</span>&nbsp;<span class="op" id="4159874">=</span>&nbsp;<span class="ident" id="4159876">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4159879">g</span><span class="op" id="4159880">.</span><span class="ident" id="4159881">mu</span><span class="op" id="4159883">.</span><span class="ident" id="4159884">Unlock</span><span class="op" id="4159890">(</span><span class="op" id="4159891">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4159895">go</span>&nbsp;<span class="ident" id="4159898">g</span><span class="op" id="4159899">.</span><span class="ident" id="4159900">doCall</span><span class="op" id="4159906">(</span><span class="ident" id="4159907">c</span><span class="op" id="4159908">,</span>&nbsp;<span class="ident" id="4159910">key</span><span class="op" id="4159913">,</span>&nbsp;<span class="ident" id="4159915">fn</span><span class="op" id="4159917">)</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4159921">return</span>&nbsp;<span class="ident" id="4159928">ch</span><br>
<span class="lineno"></span><span class="op" id="4159931">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4159934">//&nbsp;doCall&nbsp;handles&nbsp;the&nbsp;single&nbsp;call&nbsp;for&nbsp;a&nbsp;key.</span><br>
<span class="lineno">90</span><span class="keyword" id="4159979">func</span>&nbsp;<span class="op" id="4159984">(</span><span class="ident" id="4159985">g</span>&nbsp;<span class="op" id="4159987">*</span><span class="ident" id="4159988">singleflight</span><span class="op" id="4160000">)</span>&nbsp;<span class="ident" id="4160002">doCall</span><span class="op" id="4160008">(</span><span class="ident" id="4160009">c</span>&nbsp;<span class="op" id="4160011">*</span><span class="ident" id="4160012">call</span><span class="op" id="4160016">,</span>&nbsp;<span class="ident" id="4160018">key</span>&nbsp;<span class="builtintype" id="4160022">string</span><span class="op" id="4160028">,</span>&nbsp;<span class="ident" id="4160030">fn</span>&nbsp;<span class="keyword" id="4160033">func</span><span class="op" id="4160037">(</span><span class="op" id="4160038">)</span>&nbsp;<span class="op" id="4160040">(</span><span class="keyword" id="4160041">interface</span><span class="op" id="4160050">{</span><span class="op" id="4160051">}</span><span class="op" id="4160052">,</span>&nbsp;<span class="builtintype" id="4160054">error</span><span class="op" id="4160059">)</span><span class="op" id="4160060">)</span>&nbsp;<span class="op" id="4160062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4160065">c</span><span class="op" id="4160066">.</span><span class="ident" id="4160067">val</span><span class="op" id="4160070">,</span>&nbsp;<span class="ident" id="4160072">c</span><span class="op" id="4160073">.</span><span class="ident" id="4160074">err</span>&nbsp;<span class="op" id="4160078">=</span>&nbsp;<span class="ident" id="4160080">fn</span><span class="op" id="4160082">(</span><span class="op" id="4160083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4160086">c</span><span class="op" id="4160087">.</span><span class="ident" id="4160088">wg</span><span class="op" id="4160090">.</span><span class="ident" id="4160091">Done</span><span class="op" id="4160095">(</span><span class="op" id="4160096">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4160100">g</span><span class="op" id="4160101">.</span><span class="ident" id="4160102">mu</span><span class="op" id="4160104">.</span><span class="ident" id="4160105">Lock</span><span class="op" id="4160109">(</span><span class="op" id="4160110">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4160113">delete</span><span class="op" id="4160119">(</span><span class="ident" id="4160120">g</span><span class="op" id="4160121">.</span><span class="ident" id="4160122">m</span><span class="op" id="4160123">,</span>&nbsp;<span class="ident" id="4160125">key</span><span class="op" id="4160128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4160131">for</span>&nbsp;<span class="ident" id="4160135">_</span><span class="op" id="4160136">,</span>&nbsp;<span class="ident" id="4160138">ch</span>&nbsp;<span class="op" id="4160141">:=</span>&nbsp;<span class="keyword" id="4160144">range</span>&nbsp;<span class="ident" id="4160150">c</span><span class="op" id="4160151">.</span><span class="ident" id="4160152">chans</span>&nbsp;<span class="op" id="4160158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4160162">ch</span>&nbsp;<span class="op" id="4160165">&lt;-</span>&nbsp;<span class="ident" id="4160168">singleflightResult</span><span class="op" id="4160186">{</span><span class="ident" id="4160187">c</span><span class="op" id="4160188">.</span><span class="ident" id="4160189">val</span><span class="op" id="4160192">,</span>&nbsp;<span class="ident" id="4160194">c</span><span class="op" id="4160195">.</span><span class="ident" id="4160196">err</span><span class="op" id="4160199">,</span>&nbsp;<span class="ident" id="4160201">c</span><span class="op" id="4160202">.</span><span class="ident" id="4160203">dups</span>&nbsp;<span class="op" id="4160208">&gt;</span>&nbsp;<span class="num" id="4160210">0</span><span class="op" id="4160211">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4160214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4160217">g</span><span class="op" id="4160218">.</span><span class="ident" id="4160219">mu</span><span class="op" id="4160221">.</span><span class="ident" id="4160222">Unlock</span><span class="op" id="4160228">(</span><span class="op" id="4160229">)</span><br>
<span class="lineno">100</span><span class="op" id="4160231">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4160234">//&nbsp;Forget&nbsp;tells&nbsp;the&nbsp;singleflight&nbsp;to&nbsp;forget&nbsp;about&nbsp;a&nbsp;key.&nbsp;&nbsp;Future&nbsp;calls</span><br>
<span class="lineno"></span><span class="comment" id="4160304">//&nbsp;to&nbsp;Do&nbsp;for&nbsp;this&nbsp;key&nbsp;will&nbsp;call&nbsp;the&nbsp;function&nbsp;rather&nbsp;than&nbsp;waiting&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="4160373">//&nbsp;an&nbsp;earlier&nbsp;call&nbsp;to&nbsp;complete.</span><br>
<span class="lineno">105</span><span class="keyword" id="4160405">func</span>&nbsp;<span class="op" id="4160410">(</span><span class="ident" id="4160411">g</span>&nbsp;<span class="op" id="4160413">*</span><span class="ident" id="4160414">singleflight</span><span class="op" id="4160426">)</span>&nbsp;<span class="ident" id="4160428">Forget</span><span class="op" id="4160434">(</span><span class="ident" id="4160435">key</span>&nbsp;<span class="builtintype" id="4160439">string</span><span class="op" id="4160445">)</span>&nbsp;<span class="op" id="4160447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4160450">g</span><span class="op" id="4160451">.</span><span class="ident" id="4160452">mu</span><span class="op" id="4160454">.</span><span class="ident" id="4160455">Lock</span><span class="op" id="4160459">(</span><span class="op" id="4160460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4160463">delete</span><span class="op" id="4160469">(</span><span class="ident" id="4160470">g</span><span class="op" id="4160471">.</span><span class="ident" id="4160472">m</span><span class="op" id="4160473">,</span>&nbsp;<span class="ident" id="4160475">key</span><span class="op" id="4160478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4160481">g</span><span class="op" id="4160482">.</span><span class="ident" id="4160483">mu</span><span class="op" id="4160485">.</span><span class="ident" id="4160486">Unlock</span><span class="op" id="4160492">(</span><span class="op" id="4160493">)</span><br>
<span class="lineno"></span><span class="op" id="4160495">}</span>
</div>
</body>
</html>
