<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="6107868">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6107923">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6107977">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6108028">package</span>&nbsp;<span class="ident" id="6108036">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6108046">import</span>&nbsp;<span class="op" id="6108053">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6108056">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6108065">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6108074">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6108084">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6108091">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6108097">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6108110">&#34;net&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6108117">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6108129">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6108140">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6108151">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6108158">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="6108161">//&nbsp;One&nbsp;of&nbsp;the&nbsp;copies,&nbsp;say&nbsp;from&nbsp;b&nbsp;to&nbsp;r2,&nbsp;could&nbsp;be&nbsp;avoided&nbsp;by&nbsp;using&nbsp;a&nbsp;more</span><br>
<span class="lineno"></span><span class="comment" id="6108234">//&nbsp;elaborate&nbsp;trick&nbsp;where&nbsp;the&nbsp;other&nbsp;copy&nbsp;is&nbsp;made&nbsp;during&nbsp;Request/Response.Write.</span><br>
<span class="lineno"></span><span class="comment" id="6108313">//&nbsp;This&nbsp;would&nbsp;complicate&nbsp;things&nbsp;too&nbsp;much,&nbsp;given&nbsp;that&nbsp;these&nbsp;functions&nbsp;are&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="6108390">//&nbsp;debugging&nbsp;only.</span><br>
<span class="lineno">25</span><span class="keyword" id="6108409">func</span>&nbsp;<span class="ident" id="6108414">drainBody</span><span class="op" id="6108423">(</span><span class="ident" id="6108424">b</span>&nbsp;<span class="ident" id="6108426">io</span><span class="op" id="6108428">.</span><span class="ident" id="6108429">ReadCloser</span><span class="op" id="6108439">)</span>&nbsp;<span class="op" id="6108441">(</span><span class="ident" id="6108442">r1</span><span class="op" id="6108444">,</span>&nbsp;<span class="ident" id="6108446">r2</span>&nbsp;<span class="ident" id="6108449">io</span><span class="op" id="6108451">.</span><span class="ident" id="6108452">ReadCloser</span><span class="op" id="6108462">,</span>&nbsp;<span class="ident" id="6108464">err</span>&nbsp;<span class="builtintype" id="6108468">error</span><span class="op" id="6108473">)</span>&nbsp;<span class="op" id="6108475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6108478">var</span>&nbsp;<span class="ident" id="6108482">buf</span>&nbsp;<span class="ident" id="6108486">bytes</span><span class="op" id="6108491">.</span><span class="ident" id="6108492">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6108500">if</span>&nbsp;<span class="ident" id="6108503">_</span><span class="op" id="6108504">,</span>&nbsp;<span class="ident" id="6108506">err</span>&nbsp;<span class="op" id="6108510">=</span>&nbsp;<span class="ident" id="6108512">buf</span><span class="op" id="6108515">.</span><span class="ident" id="6108516">ReadFrom</span><span class="op" id="6108524">(</span><span class="ident" id="6108525">b</span><span class="op" id="6108526">)</span><span class="op" id="6108527">;</span>&nbsp;<span class="ident" id="6108529">err</span>&nbsp;<span class="op" id="6108533">!=</span>&nbsp;<span class="ident" id="6108536">nil</span>&nbsp;<span class="op" id="6108540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6108544">return</span>&nbsp;<span class="ident" id="6108551">nil</span><span class="op" id="6108554">,</span>&nbsp;<span class="ident" id="6108556">nil</span><span class="op" id="6108559">,</span>&nbsp;<span class="ident" id="6108561">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6108566">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6108569">if</span>&nbsp;<span class="ident" id="6108572">err</span>&nbsp;<span class="op" id="6108576">=</span>&nbsp;<span class="ident" id="6108578">b</span><span class="op" id="6108579">.</span><span class="ident" id="6108580">Close</span><span class="op" id="6108585">(</span><span class="op" id="6108586">)</span><span class="op" id="6108587">;</span>&nbsp;<span class="ident" id="6108589">err</span>&nbsp;<span class="op" id="6108593">!=</span>&nbsp;<span class="ident" id="6108596">nil</span>&nbsp;<span class="op" id="6108600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6108604">return</span>&nbsp;<span class="ident" id="6108611">nil</span><span class="op" id="6108614">,</span>&nbsp;<span class="ident" id="6108616">nil</span><span class="op" id="6108619">,</span>&nbsp;<span class="ident" id="6108621">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6108626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6108629">return</span>&nbsp;<span class="ident" id="6108636">ioutil</span><span class="op" id="6108642">.</span><span class="ident" id="6108643">NopCloser</span><span class="op" id="6108652">(</span><span class="op" id="6108653">&amp;</span><span class="ident" id="6108654">buf</span><span class="op" id="6108657">)</span><span class="op" id="6108658">,</span>&nbsp;<span class="ident" id="6108660">ioutil</span><span class="op" id="6108666">.</span><span class="ident" id="6108667">NopCloser</span><span class="op" id="6108676">(</span><span class="ident" id="6108677">bytes</span><span class="op" id="6108682">.</span><span class="ident" id="6108683">NewReader</span><span class="op" id="6108692">(</span><span class="ident" id="6108693">buf</span><span class="op" id="6108696">.</span><span class="ident" id="6108697">Bytes</span><span class="op" id="6108702">(</span><span class="op" id="6108703">)</span><span class="op" id="6108704">)</span><span class="op" id="6108705">)</span><span class="op" id="6108706">,</span>&nbsp;<span class="ident" id="6108708">nil</span><br>
<span class="lineno"></span><span class="op" id="6108712">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="6108715">//&nbsp;dumpConn&nbsp;is&nbsp;a&nbsp;net.Conn&nbsp;which&nbsp;writes&nbsp;to&nbsp;Writer&nbsp;and&nbsp;reads&nbsp;from&nbsp;Reader</span><br>
<span class="lineno"></span><span class="keyword" id="6108786">type</span>&nbsp;<span class="ident" id="6108791">dumpConn</span>&nbsp;<span class="keyword" id="6108800">struct</span>&nbsp;<span class="op" id="6108807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6108810">io</span><span class="op" id="6108812">.</span><span class="ident" id="6108813">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6108821">io</span><span class="op" id="6108823">.</span><span class="ident" id="6108824">Reader</span><br>
<span class="lineno">40</span><span class="op" id="6108831">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6108834">func</span>&nbsp;<span class="op" id="6108839">(</span><span class="ident" id="6108840">c</span>&nbsp;<span class="op" id="6108842">*</span><span class="ident" id="6108843">dumpConn</span><span class="op" id="6108851">)</span>&nbsp;<span class="ident" id="6108853">Close</span><span class="op" id="6108858">(</span><span class="op" id="6108859">)</span>&nbsp;<span class="builtintype" id="6108861">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6108889">{</span>&nbsp;<span class="keyword" id="6108891">return</span>&nbsp;<span class="ident" id="6108898">nil</span>&nbsp;<span class="op" id="6108902">}</span><br>
<span class="lineno"></span><span class="keyword" id="6108904">func</span>&nbsp;<span class="op" id="6108909">(</span><span class="ident" id="6108910">c</span>&nbsp;<span class="op" id="6108912">*</span><span class="ident" id="6108913">dumpConn</span><span class="op" id="6108921">)</span>&nbsp;<span class="ident" id="6108923">LocalAddr</span><span class="op" id="6108932">(</span><span class="op" id="6108933">)</span>&nbsp;<span class="ident" id="6108935">net</span><span class="op" id="6108938">.</span><span class="ident" id="6108939">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6108959">{</span>&nbsp;<span class="keyword" id="6108961">return</span>&nbsp;<span class="ident" id="6108968">nil</span>&nbsp;<span class="op" id="6108972">}</span><br>
<span class="lineno"></span><span class="keyword" id="6108974">func</span>&nbsp;<span class="op" id="6108979">(</span><span class="ident" id="6108980">c</span>&nbsp;<span class="op" id="6108982">*</span><span class="ident" id="6108983">dumpConn</span><span class="op" id="6108991">)</span>&nbsp;<span class="ident" id="6108993">RemoteAddr</span><span class="op" id="6109003">(</span><span class="op" id="6109004">)</span>&nbsp;<span class="ident" id="6109006">net</span><span class="op" id="6109009">.</span><span class="ident" id="6109010">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6109029">{</span>&nbsp;<span class="keyword" id="6109031">return</span>&nbsp;<span class="ident" id="6109038">nil</span>&nbsp;<span class="op" id="6109042">}</span><br>
<span class="lineno">45</span><span class="keyword" id="6109044">func</span>&nbsp;<span class="op" id="6109049">(</span><span class="ident" id="6109050">c</span>&nbsp;<span class="op" id="6109052">*</span><span class="ident" id="6109053">dumpConn</span><span class="op" id="6109061">)</span>&nbsp;<span class="ident" id="6109063">SetDeadline</span><span class="op" id="6109074">(</span><span class="ident" id="6109075">t</span>&nbsp;<span class="ident" id="6109077">time</span><span class="op" id="6109081">.</span><span class="ident" id="6109082">Time</span><span class="op" id="6109086">)</span>&nbsp;<span class="builtintype" id="6109088">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6109099">{</span>&nbsp;<span class="keyword" id="6109101">return</span>&nbsp;<span class="ident" id="6109108">nil</span>&nbsp;<span class="op" id="6109112">}</span><br>
<span class="lineno"></span><span class="keyword" id="6109114">func</span>&nbsp;<span class="op" id="6109119">(</span><span class="ident" id="6109120">c</span>&nbsp;<span class="op" id="6109122">*</span><span class="ident" id="6109123">dumpConn</span><span class="op" id="6109131">)</span>&nbsp;<span class="ident" id="6109133">SetReadDeadline</span><span class="op" id="6109148">(</span><span class="ident" id="6109149">t</span>&nbsp;<span class="ident" id="6109151">time</span><span class="op" id="6109155">.</span><span class="ident" id="6109156">Time</span><span class="op" id="6109160">)</span>&nbsp;<span class="builtintype" id="6109162">error</span>&nbsp;&nbsp;<span class="op" id="6109169">{</span>&nbsp;<span class="keyword" id="6109171">return</span>&nbsp;<span class="ident" id="6109178">nil</span>&nbsp;<span class="op" id="6109182">}</span><br>
<span class="lineno"></span><span class="keyword" id="6109184">func</span>&nbsp;<span class="op" id="6109189">(</span><span class="ident" id="6109190">c</span>&nbsp;<span class="op" id="6109192">*</span><span class="ident" id="6109193">dumpConn</span><span class="op" id="6109201">)</span>&nbsp;<span class="ident" id="6109203">SetWriteDeadline</span><span class="op" id="6109219">(</span><span class="ident" id="6109220">t</span>&nbsp;<span class="ident" id="6109222">time</span><span class="op" id="6109226">.</span><span class="ident" id="6109227">Time</span><span class="op" id="6109231">)</span>&nbsp;<span class="builtintype" id="6109233">error</span>&nbsp;<span class="op" id="6109239">{</span>&nbsp;<span class="keyword" id="6109241">return</span>&nbsp;<span class="ident" id="6109248">nil</span>&nbsp;<span class="op" id="6109252">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6109255">type</span>&nbsp;<span class="ident" id="6109260">neverEnding</span>&nbsp;<span class="builtintype" id="6109272">byte</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="6109278">func</span>&nbsp;<span class="op" id="6109283">(</span><span class="ident" id="6109284">b</span>&nbsp;<span class="ident" id="6109286">neverEnding</span><span class="op" id="6109297">)</span>&nbsp;<span class="ident" id="6109299">Read</span><span class="op" id="6109303">(</span><span class="ident" id="6109304">p</span>&nbsp;<span class="op" id="6109306">[</span><span class="op" id="6109307">]</span><span class="builtintype" id="6109308">byte</span><span class="op" id="6109312">)</span>&nbsp;<span class="op" id="6109314">(</span><span class="ident" id="6109315">n</span>&nbsp;<span class="builtintype" id="6109317">int</span><span class="op" id="6109320">,</span>&nbsp;<span class="ident" id="6109322">err</span>&nbsp;<span class="builtintype" id="6109326">error</span><span class="op" id="6109331">)</span>&nbsp;<span class="op" id="6109333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6109336">for</span>&nbsp;<span class="ident" id="6109340">i</span>&nbsp;<span class="op" id="6109342">:=</span>&nbsp;<span class="keyword" id="6109345">range</span>&nbsp;<span class="ident" id="6109351">p</span>&nbsp;<span class="op" id="6109353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6109357">p</span><span class="op" id="6109358">[</span><span class="ident" id="6109359">i</span><span class="op" id="6109360">]</span>&nbsp;<span class="op" id="6109362">=</span>&nbsp;<span class="builtintype" id="6109364">byte</span><span class="op" id="6109368">(</span><span class="ident" id="6109369">b</span><span class="op" id="6109370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6109373">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6109376">return</span>&nbsp;<span class="builtinfunc" id="6109383">len</span><span class="op" id="6109386">(</span><span class="ident" id="6109387">p</span><span class="op" id="6109388">)</span><span class="op" id="6109389">,</span>&nbsp;<span class="ident" id="6109391">nil</span><br>
<span class="lineno"></span><span class="op" id="6109395">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6109398">//&nbsp;DumpRequestOut&nbsp;is&nbsp;like&nbsp;DumpRequest&nbsp;but&nbsp;includes</span><br>
<span class="lineno"></span><span class="comment" id="6109449">//&nbsp;headers&nbsp;that&nbsp;the&nbsp;standard&nbsp;http.Transport&nbsp;adds,</span><br>
<span class="lineno">60</span><span class="comment" id="6109499">//&nbsp;such&nbsp;as&nbsp;User-Agent.</span><br>
<span class="lineno"></span><span class="keyword" id="6109522">func</span>&nbsp;<span class="ident" id="6109527">DumpRequestOut</span><span class="op" id="6109541">(</span><span class="ident" id="6109542">req</span>&nbsp;<span class="op" id="6109546">*</span><span class="ident" id="6109547">http</span><span class="op" id="6109551">.</span><span class="ident" id="6109552">Request</span><span class="op" id="6109559">,</span>&nbsp;<span class="ident" id="6109561">body</span>&nbsp;<span class="builtintype" id="6109566">bool</span><span class="op" id="6109570">)</span>&nbsp;<span class="op" id="6109572">(</span><span class="op" id="6109573">[</span><span class="op" id="6109574">]</span><span class="builtintype" id="6109575">byte</span><span class="op" id="6109579">,</span>&nbsp;<span class="builtintype" id="6109581">error</span><span class="op" id="6109586">)</span>&nbsp;<span class="op" id="6109588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6109591">save</span>&nbsp;<span class="op" id="6109596">:=</span>&nbsp;<span class="ident" id="6109599">req</span><span class="op" id="6109602">.</span><span class="ident" id="6109603">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6109609">dummyBody</span>&nbsp;<span class="op" id="6109619">:=</span>&nbsp;<span class="ident" id="6109622">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6109629">if</span>&nbsp;<span class="op" id="6109632">!</span><span class="ident" id="6109633">body</span>&nbsp;<span class="op" id="6109638">||</span>&nbsp;<span class="ident" id="6109641">req</span><span class="op" id="6109644">.</span><span class="ident" id="6109645">Body</span>&nbsp;<span class="op" id="6109650">==</span>&nbsp;<span class="ident" id="6109653">nil</span>&nbsp;<span class="op" id="6109657">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6109661">req</span><span class="op" id="6109664">.</span><span class="ident" id="6109665">Body</span>&nbsp;<span class="op" id="6109670">=</span>&nbsp;<span class="ident" id="6109672">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6109678">if</span>&nbsp;<span class="ident" id="6109681">req</span><span class="op" id="6109684">.</span><span class="ident" id="6109685">ContentLength</span>&nbsp;<span class="op" id="6109699">!=</span>&nbsp;<span class="num" id="6109702">0</span>&nbsp;<span class="op" id="6109704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6109709">req</span><span class="op" id="6109712">.</span><span class="ident" id="6109713">Body</span>&nbsp;<span class="op" id="6109718">=</span>&nbsp;<span class="ident" id="6109720">ioutil</span><span class="op" id="6109726">.</span><span class="ident" id="6109727">NopCloser</span><span class="op" id="6109736">(</span><span class="ident" id="6109737">io</span><span class="op" id="6109739">.</span><span class="ident" id="6109740">LimitReader</span><span class="op" id="6109751">(</span><span class="ident" id="6109752">neverEnding</span><span class="op" id="6109763">(</span><span class="string" id="6109764">&#39;x&#39;</span><span class="op" id="6109767">)</span><span class="op" id="6109768">,</span>&nbsp;<span class="ident" id="6109770">req</span><span class="op" id="6109773">.</span><span class="ident" id="6109774">ContentLength</span><span class="op" id="6109787">)</span><span class="op" id="6109788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6109793">dummyBody</span>&nbsp;<span class="op" id="6109803">=</span>&nbsp;<span class="ident" id="6109805">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6109812">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6109815">}</span>&nbsp;<span class="keyword" id="6109817">else</span>&nbsp;<span class="op" id="6109822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6109826">var</span>&nbsp;<span class="ident" id="6109830">err</span>&nbsp;<span class="builtintype" id="6109834">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6109842">save</span><span class="op" id="6109846">,</span>&nbsp;<span class="ident" id="6109848">req</span><span class="op" id="6109851">.</span><span class="ident" id="6109852">Body</span><span class="op" id="6109856">,</span>&nbsp;<span class="ident" id="6109858">err</span>&nbsp;<span class="op" id="6109862">=</span>&nbsp;<span class="ident" id="6109864">drainBody</span><span class="op" id="6109873">(</span><span class="ident" id="6109874">req</span><span class="op" id="6109877">.</span><span class="ident" id="6109878">Body</span><span class="op" id="6109882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6109886">if</span>&nbsp;<span class="ident" id="6109889">err</span>&nbsp;<span class="op" id="6109893">!=</span>&nbsp;<span class="ident" id="6109896">nil</span>&nbsp;<span class="op" id="6109900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6109905">return</span>&nbsp;<span class="ident" id="6109912">nil</span><span class="op" id="6109915">,</span>&nbsp;<span class="ident" id="6109917">err</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6109923">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6109926">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6109930">//&nbsp;Since&nbsp;we&#39;re&nbsp;using&nbsp;the&nbsp;actual&nbsp;Transport&nbsp;code&nbsp;to&nbsp;write&nbsp;the&nbsp;request,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6110000">//&nbsp;switch&nbsp;to&nbsp;http&nbsp;so&nbsp;the&nbsp;Transport&nbsp;doesn&#39;t&nbsp;try&nbsp;to&nbsp;do&nbsp;an&nbsp;SSL</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6110061">//&nbsp;negotiation&nbsp;with&nbsp;our&nbsp;dumpConn&nbsp;and&nbsp;its&nbsp;bytes.Buffer&nbsp;&amp;&nbsp;pipe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6110124">//&nbsp;The&nbsp;wire&nbsp;format&nbsp;for&nbsp;https&nbsp;and&nbsp;http&nbsp;are&nbsp;the&nbsp;same,&nbsp;anyway.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6110185">reqSend</span>&nbsp;<span class="op" id="6110193">:=</span>&nbsp;<span class="ident" id="6110196">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6110201">if</span>&nbsp;<span class="ident" id="6110204">req</span><span class="op" id="6110207">.</span><span class="ident" id="6110208">URL</span><span class="op" id="6110211">.</span><span class="ident" id="6110212">Scheme</span>&nbsp;<span class="op" id="6110219">==</span>&nbsp;<span class="string" id="6110222">&#34;https&#34;</span>&nbsp;<span class="op" id="6110230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6110234">reqSend</span>&nbsp;<span class="op" id="6110242">=</span>&nbsp;<span class="builtinfunc" id="6110244">new</span><span class="op" id="6110247">(</span><span class="ident" id="6110248">http</span><span class="op" id="6110252">.</span><span class="ident" id="6110253">Request</span><span class="op" id="6110260">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6110264">*</span><span class="ident" id="6110265">reqSend</span>&nbsp;<span class="op" id="6110273">=</span>&nbsp;<span class="op" id="6110275">*</span><span class="ident" id="6110276">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6110282">reqSend</span><span class="op" id="6110289">.</span><span class="ident" id="6110290">URL</span>&nbsp;<span class="op" id="6110294">=</span>&nbsp;<span class="builtinfunc" id="6110296">new</span><span class="op" id="6110299">(</span><span class="ident" id="6110300">url</span><span class="op" id="6110303">.</span><span class="ident" id="6110304">URL</span><span class="op" id="6110307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6110311">*</span><span class="ident" id="6110312">reqSend</span><span class="op" id="6110319">.</span><span class="ident" id="6110320">URL</span>&nbsp;<span class="op" id="6110324">=</span>&nbsp;<span class="op" id="6110326">*</span><span class="ident" id="6110327">req</span><span class="op" id="6110330">.</span><span class="ident" id="6110331">URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6110337">reqSend</span><span class="op" id="6110344">.</span><span class="ident" id="6110345">URL</span><span class="op" id="6110348">.</span><span class="ident" id="6110349">Scheme</span>&nbsp;<span class="op" id="6110356">=</span>&nbsp;<span class="string" id="6110358">&#34;http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6110366">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6110370">//&nbsp;Use&nbsp;the&nbsp;actual&nbsp;Transport&nbsp;code&nbsp;to&nbsp;record&nbsp;what&nbsp;we&nbsp;would&nbsp;send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6110433">//&nbsp;on&nbsp;the&nbsp;wire,&nbsp;but&nbsp;not&nbsp;using&nbsp;TCP.&nbsp;&nbsp;Use&nbsp;a&nbsp;Transport&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6110493">//&nbsp;custom&nbsp;dialer&nbsp;that&nbsp;returns&nbsp;a&nbsp;fake&nbsp;net.Conn&nbsp;that&nbsp;waits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6110551">//&nbsp;for&nbsp;the&nbsp;full&nbsp;input&nbsp;(and&nbsp;recording&nbsp;it),&nbsp;and&nbsp;then&nbsp;responds</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6110612">//&nbsp;with&nbsp;a&nbsp;dummy&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6110639">var</span>&nbsp;<span class="ident" id="6110643">buf</span>&nbsp;<span class="ident" id="6110647">bytes</span><span class="op" id="6110652">.</span><span class="ident" id="6110653">Buffer</span>&nbsp;<span class="comment" id="6110660">//&nbsp;records&nbsp;the&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6110683">pr</span><span class="op" id="6110685">,</span>&nbsp;<span class="ident" id="6110687">pw</span>&nbsp;<span class="op" id="6110690">:=</span>&nbsp;<span class="ident" id="6110693">io</span><span class="op" id="6110695">.</span><span class="ident" id="6110696">Pipe</span><span class="op" id="6110700">(</span><span class="op" id="6110701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6110704">defer</span>&nbsp;<span class="ident" id="6110710">pr</span><span class="op" id="6110712">.</span><span class="ident" id="6110713">Close</span><span class="op" id="6110718">(</span><span class="op" id="6110719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6110722">defer</span>&nbsp;<span class="ident" id="6110728">pw</span><span class="op" id="6110730">.</span><span class="ident" id="6110731">Close</span><span class="op" id="6110736">(</span><span class="op" id="6110737">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6110740">dr</span>&nbsp;<span class="op" id="6110743">:=</span>&nbsp;<span class="op" id="6110746">&amp;</span><span class="ident" id="6110747">delegateReader</span><span class="op" id="6110761">{</span><span class="ident" id="6110762">c</span><span class="op" id="6110763">:</span>&nbsp;<span class="builtinfunc" id="6110765">make</span><span class="op" id="6110769">(</span><span class="keyword" id="6110770">chan</span>&nbsp;<span class="ident" id="6110775">io</span><span class="op" id="6110777">.</span><span class="ident" id="6110778">Reader</span><span class="op" id="6110784">)</span><span class="op" id="6110785">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6110788">//&nbsp;Wait&nbsp;for&nbsp;the&nbsp;request&nbsp;before&nbsp;replying&nbsp;with&nbsp;a&nbsp;dummy&nbsp;response:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6110852">go</span>&nbsp;<span class="keyword" id="6110855">func</span><span class="op" id="6110859">(</span><span class="op" id="6110860">)</span>&nbsp;<span class="op" id="6110862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6110866">req</span><span class="op" id="6110869">,</span>&nbsp;<span class="ident" id="6110871">err</span>&nbsp;<span class="op" id="6110875">:=</span>&nbsp;<span class="ident" id="6110878">http</span><span class="op" id="6110882">.</span><span class="ident" id="6110883">ReadRequest</span><span class="op" id="6110894">(</span><span class="ident" id="6110895">bufio</span><span class="op" id="6110900">.</span><span class="ident" id="6110901">NewReader</span><span class="op" id="6110910">(</span><span class="ident" id="6110911">pr</span><span class="op" id="6110913">)</span><span class="op" id="6110914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6110918">if</span>&nbsp;<span class="ident" id="6110921">err</span>&nbsp;<span class="op" id="6110925">==</span>&nbsp;<span class="ident" id="6110928">nil</span>&nbsp;<span class="op" id="6110932">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6110937">//&nbsp;Ensure&nbsp;all&nbsp;the&nbsp;body&nbsp;is&nbsp;read;&nbsp;otherwise</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6110982">//&nbsp;we&#39;ll&nbsp;get&nbsp;a&nbsp;partial&nbsp;dump.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6111014">io</span><span class="op" id="6111016">.</span><span class="ident" id="6111017">Copy</span><span class="op" id="6111021">(</span><span class="ident" id="6111022">ioutil</span><span class="op" id="6111028">.</span><span class="ident" id="6111029">Discard</span><span class="op" id="6111036">,</span>&nbsp;<span class="ident" id="6111038">req</span><span class="op" id="6111041">.</span><span class="ident" id="6111042">Body</span><span class="op" id="6111046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6111051">req</span><span class="op" id="6111054">.</span><span class="ident" id="6111055">Body</span><span class="op" id="6111059">.</span><span class="ident" id="6111060">Close</span><span class="op" id="6111065">(</span><span class="op" id="6111066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6111070">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6111074">dr</span><span class="op" id="6111076">.</span><span class="ident" id="6111077">c</span>&nbsp;<span class="op" id="6111079">&lt;-</span>&nbsp;<span class="ident" id="6111082">strings</span><span class="op" id="6111089">.</span><span class="ident" id="6111090">NewReader</span><span class="op" id="6111099">(</span><span class="string" id="6111100">&#34;HTTP/1.1&nbsp;204&nbsp;No&nbsp;Content\r\n\r\n&#34;</span><span class="op" id="6111133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6111136">}</span><span class="op" id="6111137">(</span><span class="op" id="6111138">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6111142">t</span>&nbsp;<span class="op" id="6111144">:=</span>&nbsp;<span class="op" id="6111147">&amp;</span><span class="ident" id="6111148">http</span><span class="op" id="6111152">.</span><span class="ident" id="6111153">Transport</span><span class="op" id="6111162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6111166">DisableKeepAlives</span><span class="op" id="6111183">:</span>&nbsp;<span class="ident" id="6111185">true</span><span class="op" id="6111189">,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6111193">Dial</span><span class="op" id="6111197">:</span>&nbsp;<span class="keyword" id="6111199">func</span><span class="op" id="6111203">(</span><span class="ident" id="6111204">net</span><span class="op" id="6111207">,</span>&nbsp;<span class="ident" id="6111209">addr</span>&nbsp;<span class="builtintype" id="6111214">string</span><span class="op" id="6111220">)</span>&nbsp;<span class="op" id="6111222">(</span><span class="ident" id="6111223">net</span><span class="op" id="6111226">.</span><span class="ident" id="6111227">Conn</span><span class="op" id="6111231">,</span>&nbsp;<span class="builtintype" id="6111233">error</span><span class="op" id="6111238">)</span>&nbsp;<span class="op" id="6111240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6111245">return</span>&nbsp;<span class="op" id="6111252">&amp;</span><span class="ident" id="6111253">dumpConn</span><span class="op" id="6111261">{</span><span class="ident" id="6111262">io</span><span class="op" id="6111264">.</span><span class="ident" id="6111265">MultiWriter</span><span class="op" id="6111276">(</span><span class="op" id="6111277">&amp;</span><span class="ident" id="6111278">buf</span><span class="op" id="6111281">,</span>&nbsp;<span class="ident" id="6111283">pw</span><span class="op" id="6111285">)</span><span class="op" id="6111286">,</span>&nbsp;<span class="ident" id="6111288">dr</span><span class="op" id="6111290">}</span><span class="op" id="6111291">,</span>&nbsp;<span class="ident" id="6111293">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6111299">}</span><span class="op" id="6111300">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6111303">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6111307">_</span><span class="op" id="6111308">,</span>&nbsp;<span class="ident" id="6111310">err</span>&nbsp;<span class="op" id="6111314">:=</span>&nbsp;<span class="ident" id="6111317">t</span><span class="op" id="6111318">.</span><span class="ident" id="6111319">RoundTrip</span><span class="op" id="6111328">(</span><span class="ident" id="6111329">reqSend</span><span class="op" id="6111336">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6111340">req</span><span class="op" id="6111343">.</span><span class="ident" id="6111344">Body</span>&nbsp;<span class="op" id="6111349">=</span>&nbsp;<span class="ident" id="6111351">save</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6111357">if</span>&nbsp;<span class="ident" id="6111360">err</span>&nbsp;<span class="op" id="6111364">!=</span>&nbsp;<span class="ident" id="6111367">nil</span>&nbsp;<span class="op" id="6111371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6111375">return</span>&nbsp;<span class="ident" id="6111382">nil</span><span class="op" id="6111385">,</span>&nbsp;<span class="ident" id="6111387">err</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6111392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6111395">dump</span>&nbsp;<span class="op" id="6111400">:=</span>&nbsp;<span class="ident" id="6111403">buf</span><span class="op" id="6111406">.</span><span class="ident" id="6111407">Bytes</span><span class="op" id="6111412">(</span><span class="op" id="6111413">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6111417">//&nbsp;If&nbsp;we&nbsp;used&nbsp;a&nbsp;dummy&nbsp;body&nbsp;above,&nbsp;remove&nbsp;it&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6111467">//&nbsp;TODO:&nbsp;if&nbsp;the&nbsp;req.ContentLength&nbsp;is&nbsp;large,&nbsp;we&nbsp;allocate&nbsp;memory</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6111531">//&nbsp;unnecessarily&nbsp;just&nbsp;to&nbsp;slice&nbsp;it&nbsp;off&nbsp;here.&nbsp;&nbsp;But&nbsp;this&nbsp;is&nbsp;just</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6111594">//&nbsp;a&nbsp;debug&nbsp;function,&nbsp;so&nbsp;this&nbsp;is&nbsp;acceptable&nbsp;for&nbsp;now.&nbsp;We&nbsp;could</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6111656">//&nbsp;discard&nbsp;the&nbsp;body&nbsp;earlier&nbsp;if&nbsp;this&nbsp;matters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6111702">if</span>&nbsp;<span class="ident" id="6111705">dummyBody</span>&nbsp;<span class="op" id="6111715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6111719">if</span>&nbsp;<span class="ident" id="6111722">i</span>&nbsp;<span class="op" id="6111724">:=</span>&nbsp;<span class="ident" id="6111727">bytes</span><span class="op" id="6111732">.</span><span class="ident" id="6111733">Index</span><span class="op" id="6111738">(</span><span class="ident" id="6111739">dump</span><span class="op" id="6111743">,</span>&nbsp;<span class="op" id="6111745">[</span><span class="op" id="6111746">]</span><span class="builtintype" id="6111747">byte</span><span class="op" id="6111751">(</span><span class="string" id="6111752">&#34;\r\n\r\n&#34;</span><span class="op" id="6111762">)</span><span class="op" id="6111763">)</span><span class="op" id="6111764">;</span>&nbsp;<span class="ident" id="6111766">i</span>&nbsp;<span class="op" id="6111768">&gt;=</span>&nbsp;<span class="num" id="6111771">0</span>&nbsp;<span class="op" id="6111773">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6111778">dump</span>&nbsp;<span class="op" id="6111783">=</span>&nbsp;<span class="ident" id="6111785">dump</span><span class="op" id="6111789">[</span><span class="op" id="6111790">:</span><span class="ident" id="6111791">i</span><span class="op" id="6111792">+</span><span class="num" id="6111793">4</span><span class="op" id="6111794">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6111798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6111801">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6111804">return</span>&nbsp;<span class="ident" id="6111811">dump</span><span class="op" id="6111815">,</span>&nbsp;<span class="ident" id="6111817">nil</span><br>
<span class="lineno"></span><span class="op" id="6111821">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="comment" id="6111824">//&nbsp;delegateReader&nbsp;is&nbsp;a&nbsp;reader&nbsp;that&nbsp;delegates&nbsp;to&nbsp;another&nbsp;reader,</span><br>
<span class="lineno"></span><span class="comment" id="6111888">//&nbsp;once&nbsp;it&nbsp;arrives&nbsp;on&nbsp;a&nbsp;channel.</span><br>
<span class="lineno"></span><span class="keyword" id="6111921">type</span>&nbsp;<span class="ident" id="6111926">delegateReader</span>&nbsp;<span class="keyword" id="6111941">struct</span>&nbsp;<span class="op" id="6111948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6111951">c</span>&nbsp;<span class="keyword" id="6111953">chan</span>&nbsp;<span class="ident" id="6111958">io</span><span class="op" id="6111960">.</span><span class="ident" id="6111961">Reader</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6111969">r</span>&nbsp;<span class="ident" id="6111971">io</span><span class="op" id="6111973">.</span><span class="ident" id="6111974">Reader</span>&nbsp;<span class="comment" id="6111981">//&nbsp;nil&nbsp;until&nbsp;received&nbsp;from&nbsp;c</span><br>
<span class="lineno"></span><span class="op" id="6112010">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6112013">func</span>&nbsp;<span class="op" id="6112018">(</span><span class="ident" id="6112019">r</span>&nbsp;<span class="op" id="6112021">*</span><span class="ident" id="6112022">delegateReader</span><span class="op" id="6112036">)</span>&nbsp;<span class="ident" id="6112038">Read</span><span class="op" id="6112042">(</span><span class="ident" id="6112043">p</span>&nbsp;<span class="op" id="6112045">[</span><span class="op" id="6112046">]</span><span class="builtintype" id="6112047">byte</span><span class="op" id="6112051">)</span>&nbsp;<span class="op" id="6112053">(</span><span class="builtintype" id="6112054">int</span><span class="op" id="6112057">,</span>&nbsp;<span class="builtintype" id="6112059">error</span><span class="op" id="6112064">)</span>&nbsp;<span class="op" id="6112066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6112069">if</span>&nbsp;<span class="ident" id="6112072">r</span><span class="op" id="6112073">.</span><span class="ident" id="6112074">r</span>&nbsp;<span class="op" id="6112076">==</span>&nbsp;<span class="ident" id="6112079">nil</span>&nbsp;<span class="op" id="6112083">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6112087">r</span><span class="op" id="6112088">.</span><span class="ident" id="6112089">r</span>&nbsp;<span class="op" id="6112091">=</span>&nbsp;<span class="op" id="6112093">&lt;-</span><span class="ident" id="6112095">r</span><span class="op" id="6112096">.</span><span class="ident" id="6112097">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6112100">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6112103">return</span>&nbsp;<span class="ident" id="6112110">r</span><span class="op" id="6112111">.</span><span class="ident" id="6112112">r</span><span class="op" id="6112113">.</span><span class="ident" id="6112114">Read</span><span class="op" id="6112118">(</span><span class="ident" id="6112119">p</span><span class="op" id="6112120">)</span><br>
<span class="lineno"></span><span class="op" id="6112122">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span><span class="comment" id="6112125">//&nbsp;Return&nbsp;value&nbsp;if&nbsp;nonempty,&nbsp;def&nbsp;otherwise.</span><br>
<span class="lineno"></span><span class="keyword" id="6112169">func</span>&nbsp;<span class="ident" id="6112174">valueOrDefault</span><span class="op" id="6112188">(</span><span class="ident" id="6112189">value</span><span class="op" id="6112194">,</span>&nbsp;<span class="ident" id="6112196">def</span>&nbsp;<span class="builtintype" id="6112200">string</span><span class="op" id="6112206">)</span>&nbsp;<span class="builtintype" id="6112208">string</span>&nbsp;<span class="op" id="6112215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6112218">if</span>&nbsp;<span class="ident" id="6112221">value</span>&nbsp;<span class="op" id="6112227">!=</span>&nbsp;<span class="string" id="6112230">&#34;&#34;</span>&nbsp;<span class="op" id="6112233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6112237">return</span>&nbsp;<span class="ident" id="6112244">value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6112251">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6112254">return</span>&nbsp;<span class="ident" id="6112261">def</span><br>
<span class="lineno"></span><span class="op" id="6112265">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6112268">var</span>&nbsp;<span class="ident" id="6112272">reqWriteExcludeHeaderDump</span>&nbsp;<span class="op" id="6112298">=</span>&nbsp;<span class="keyword" id="6112300">map</span><span class="op" id="6112303">[</span><span class="builtintype" id="6112304">string</span><span class="op" id="6112310">]</span><span class="builtintype" id="6112311">bool</span><span class="op" id="6112315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6112318">&#34;Host&#34;</span><span class="op" id="6112324">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6112339">true</span><span class="op" id="6112343">,</span>&nbsp;<span class="comment" id="6112345">//&nbsp;not&nbsp;in&nbsp;Header&nbsp;map&nbsp;anyway</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6112374">&#34;Content-Length&#34;</span><span class="op" id="6112390">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6112395">true</span><span class="op" id="6112399">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6112402">&#34;Transfer-Encoding&#34;</span><span class="op" id="6112421">:</span>&nbsp;<span class="ident" id="6112423">true</span><span class="op" id="6112427">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6112430">&#34;Trailer&#34;</span><span class="op" id="6112439">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6112451">true</span><span class="op" id="6112455">,</span><br>
<span class="lineno"></span><span class="op" id="6112457">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="comment" id="6112460">//&nbsp;dumpAsReceived&nbsp;writes&nbsp;req&nbsp;to&nbsp;w&nbsp;in&nbsp;the&nbsp;form&nbsp;as&nbsp;it&nbsp;was&nbsp;received,&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="6112529">//&nbsp;at&nbsp;least&nbsp;as&nbsp;accurately&nbsp;as&nbsp;possible&nbsp;from&nbsp;the&nbsp;information&nbsp;retained&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="6112600">//&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span><span class="keyword" id="6112616">func</span>&nbsp;<span class="ident" id="6112621">dumpAsReceived</span><span class="op" id="6112635">(</span><span class="ident" id="6112636">req</span>&nbsp;<span class="op" id="6112640">*</span><span class="ident" id="6112641">http</span><span class="op" id="6112645">.</span><span class="ident" id="6112646">Request</span><span class="op" id="6112653">,</span>&nbsp;<span class="ident" id="6112655">w</span>&nbsp;<span class="ident" id="6112657">io</span><span class="op" id="6112659">.</span><span class="ident" id="6112660">Writer</span><span class="op" id="6112666">)</span>&nbsp;<span class="builtintype" id="6112668">error</span>&nbsp;<span class="op" id="6112674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6112677">return</span>&nbsp;<span class="ident" id="6112684">nil</span><br>
<span class="lineno">175</span><span class="op" id="6112688">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6112691">//&nbsp;DumpRequest&nbsp;returns&nbsp;the&nbsp;as-received&nbsp;wire&nbsp;representation&nbsp;of&nbsp;req,</span><br>
<span class="lineno"></span><span class="comment" id="6112758">//&nbsp;optionally&nbsp;including&nbsp;the&nbsp;request&nbsp;body,&nbsp;for&nbsp;debugging.</span><br>
<span class="lineno"></span><span class="comment" id="6112815">//&nbsp;DumpRequest&nbsp;is&nbsp;semantically&nbsp;a&nbsp;no-op,&nbsp;but&nbsp;in&nbsp;order&nbsp;to</span><br>
<span class="lineno">180</span><span class="comment" id="6112871">//&nbsp;dump&nbsp;the&nbsp;body,&nbsp;it&nbsp;reads&nbsp;the&nbsp;body&nbsp;data&nbsp;into&nbsp;memory&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="6112928">//&nbsp;changes&nbsp;req.Body&nbsp;to&nbsp;refer&nbsp;to&nbsp;the&nbsp;in-memory&nbsp;copy.</span><br>
<span class="lineno"></span><span class="comment" id="6112980">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;http.Request.Write&nbsp;details&nbsp;which&nbsp;fields</span><br>
<span class="lineno"></span><span class="comment" id="6113045">//&nbsp;of&nbsp;req&nbsp;are&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="6113065">func</span>&nbsp;<span class="ident" id="6113070">DumpRequest</span><span class="op" id="6113081">(</span><span class="ident" id="6113082">req</span>&nbsp;<span class="op" id="6113086">*</span><span class="ident" id="6113087">http</span><span class="op" id="6113091">.</span><span class="ident" id="6113092">Request</span><span class="op" id="6113099">,</span>&nbsp;<span class="ident" id="6113101">body</span>&nbsp;<span class="builtintype" id="6113106">bool</span><span class="op" id="6113110">)</span>&nbsp;<span class="op" id="6113112">(</span><span class="ident" id="6113113">dump</span>&nbsp;<span class="op" id="6113118">[</span><span class="op" id="6113119">]</span><span class="builtintype" id="6113120">byte</span><span class="op" id="6113124">,</span>&nbsp;<span class="ident" id="6113126">err</span>&nbsp;<span class="builtintype" id="6113130">error</span><span class="op" id="6113135">)</span>&nbsp;<span class="op" id="6113137">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6113140">save</span>&nbsp;<span class="op" id="6113145">:=</span>&nbsp;<span class="ident" id="6113148">req</span><span class="op" id="6113151">.</span><span class="ident" id="6113152">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6113158">if</span>&nbsp;<span class="op" id="6113161">!</span><span class="ident" id="6113162">body</span>&nbsp;<span class="op" id="6113167">||</span>&nbsp;<span class="ident" id="6113170">req</span><span class="op" id="6113173">.</span><span class="ident" id="6113174">Body</span>&nbsp;<span class="op" id="6113179">==</span>&nbsp;<span class="ident" id="6113182">nil</span>&nbsp;<span class="op" id="6113186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6113190">req</span><span class="op" id="6113193">.</span><span class="ident" id="6113194">Body</span>&nbsp;<span class="op" id="6113199">=</span>&nbsp;<span class="ident" id="6113201">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6113206">}</span>&nbsp;<span class="keyword" id="6113208">else</span>&nbsp;<span class="op" id="6113213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6113217">save</span><span class="op" id="6113221">,</span>&nbsp;<span class="ident" id="6113223">req</span><span class="op" id="6113226">.</span><span class="ident" id="6113227">Body</span><span class="op" id="6113231">,</span>&nbsp;<span class="ident" id="6113233">err</span>&nbsp;<span class="op" id="6113237">=</span>&nbsp;<span class="ident" id="6113239">drainBody</span><span class="op" id="6113248">(</span><span class="ident" id="6113249">req</span><span class="op" id="6113252">.</span><span class="ident" id="6113253">Body</span><span class="op" id="6113257">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6113261">if</span>&nbsp;<span class="ident" id="6113264">err</span>&nbsp;<span class="op" id="6113268">!=</span>&nbsp;<span class="ident" id="6113271">nil</span>&nbsp;<span class="op" id="6113275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6113280">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6113289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6113292">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6113296">var</span>&nbsp;<span class="ident" id="6113300">b</span>&nbsp;<span class="ident" id="6113302">bytes</span><span class="op" id="6113307">.</span><span class="ident" id="6113308">Buffer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6113317">fmt</span><span class="op" id="6113320">.</span><span class="ident" id="6113321">Fprintf</span><span class="op" id="6113328">(</span><span class="op" id="6113329">&amp;</span><span class="ident" id="6113330">b</span><span class="op" id="6113331">,</span>&nbsp;<span class="string" id="6113333">&#34;%s&nbsp;%s&nbsp;HTTP/%d.%d\r\n&#34;</span><span class="op" id="6113355">,</span>&nbsp;<span class="ident" id="6113357">valueOrDefault</span><span class="op" id="6113371">(</span><span class="ident" id="6113372">req</span><span class="op" id="6113375">.</span><span class="ident" id="6113376">Method</span><span class="op" id="6113382">,</span>&nbsp;<span class="string" id="6113384">&#34;GET&#34;</span><span class="op" id="6113389">)</span><span class="op" id="6113390">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6113394">req</span><span class="op" id="6113397">.</span><span class="ident" id="6113398">URL</span><span class="op" id="6113401">.</span><span class="ident" id="6113402">RequestURI</span><span class="op" id="6113412">(</span><span class="op" id="6113413">)</span><span class="op" id="6113414">,</span>&nbsp;<span class="ident" id="6113416">req</span><span class="op" id="6113419">.</span><span class="ident" id="6113420">ProtoMajor</span><span class="op" id="6113430">,</span>&nbsp;<span class="ident" id="6113432">req</span><span class="op" id="6113435">.</span><span class="ident" id="6113436">ProtoMinor</span><span class="op" id="6113446">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6113450">host</span>&nbsp;<span class="op" id="6113455">:=</span>&nbsp;<span class="ident" id="6113458">req</span><span class="op" id="6113461">.</span><span class="ident" id="6113462">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6113468">if</span>&nbsp;<span class="ident" id="6113471">host</span>&nbsp;<span class="op" id="6113476">==</span>&nbsp;<span class="string" id="6113479">&#34;&#34;</span>&nbsp;<span class="op" id="6113482">&amp;&amp;</span>&nbsp;<span class="ident" id="6113485">req</span><span class="op" id="6113488">.</span><span class="ident" id="6113489">URL</span>&nbsp;<span class="op" id="6113493">!=</span>&nbsp;<span class="ident" id="6113496">nil</span>&nbsp;<span class="op" id="6113500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6113504">host</span>&nbsp;<span class="op" id="6113509">=</span>&nbsp;<span class="ident" id="6113511">req</span><span class="op" id="6113514">.</span><span class="ident" id="6113515">URL</span><span class="op" id="6113518">.</span><span class="ident" id="6113519">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6113525">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6113528">if</span>&nbsp;<span class="ident" id="6113531">host</span>&nbsp;<span class="op" id="6113536">!=</span>&nbsp;<span class="string" id="6113539">&#34;&#34;</span>&nbsp;<span class="op" id="6113542">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6113546">fmt</span><span class="op" id="6113549">.</span><span class="ident" id="6113550">Fprintf</span><span class="op" id="6113557">(</span><span class="op" id="6113558">&amp;</span><span class="ident" id="6113559">b</span><span class="op" id="6113560">,</span>&nbsp;<span class="string" id="6113562">&#34;Host:&nbsp;%s\r\n&#34;</span><span class="op" id="6113576">,</span>&nbsp;<span class="ident" id="6113578">host</span><span class="op" id="6113582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6113585">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6113589">chunked</span>&nbsp;<span class="op" id="6113597">:=</span>&nbsp;<span class="builtinfunc" id="6113600">len</span><span class="op" id="6113603">(</span><span class="ident" id="6113604">req</span><span class="op" id="6113607">.</span><span class="ident" id="6113608">TransferEncoding</span><span class="op" id="6113624">)</span>&nbsp;<span class="op" id="6113626">&gt;</span>&nbsp;<span class="num" id="6113628">0</span>&nbsp;<span class="op" id="6113630">&amp;&amp;</span>&nbsp;<span class="ident" id="6113633">req</span><span class="op" id="6113636">.</span><span class="ident" id="6113637">TransferEncoding</span><span class="op" id="6113653">[</span><span class="num" id="6113654">0</span><span class="op" id="6113655">]</span>&nbsp;<span class="op" id="6113657">==</span>&nbsp;<span class="string" id="6113660">&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6113671">if</span>&nbsp;<span class="builtinfunc" id="6113674">len</span><span class="op" id="6113677">(</span><span class="ident" id="6113678">req</span><span class="op" id="6113681">.</span><span class="ident" id="6113682">TransferEncoding</span><span class="op" id="6113698">)</span>&nbsp;<span class="op" id="6113700">&gt;</span>&nbsp;<span class="num" id="6113702">0</span>&nbsp;<span class="op" id="6113704">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6113708">fmt</span><span class="op" id="6113711">.</span><span class="ident" id="6113712">Fprintf</span><span class="op" id="6113719">(</span><span class="op" id="6113720">&amp;</span><span class="ident" id="6113721">b</span><span class="op" id="6113722">,</span>&nbsp;<span class="string" id="6113724">&#34;Transfer-Encoding:&nbsp;%s\r\n&#34;</span><span class="op" id="6113751">,</span>&nbsp;<span class="ident" id="6113753">strings</span><span class="op" id="6113760">.</span><span class="ident" id="6113761">Join</span><span class="op" id="6113765">(</span><span class="ident" id="6113766">req</span><span class="op" id="6113769">.</span><span class="ident" id="6113770">TransferEncoding</span><span class="op" id="6113786">,</span>&nbsp;<span class="string" id="6113788">&#34;,&#34;</span><span class="op" id="6113791">)</span><span class="op" id="6113792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6113795">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6113798">if</span>&nbsp;<span class="ident" id="6113801">req</span><span class="op" id="6113804">.</span><span class="ident" id="6113805">Close</span>&nbsp;<span class="op" id="6113811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6113815">fmt</span><span class="op" id="6113818">.</span><span class="ident" id="6113819">Fprintf</span><span class="op" id="6113826">(</span><span class="op" id="6113827">&amp;</span><span class="ident" id="6113828">b</span><span class="op" id="6113829">,</span>&nbsp;<span class="string" id="6113831">&#34;Connection:&nbsp;close\r\n&#34;</span><span class="op" id="6113854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6113857">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6113861">err</span>&nbsp;<span class="op" id="6113865">=</span>&nbsp;<span class="ident" id="6113867">req</span><span class="op" id="6113870">.</span><span class="ident" id="6113871">Header</span><span class="op" id="6113877">.</span><span class="ident" id="6113878">WriteSubset</span><span class="op" id="6113889">(</span><span class="op" id="6113890">&amp;</span><span class="ident" id="6113891">b</span><span class="op" id="6113892">,</span>&nbsp;<span class="ident" id="6113894">reqWriteExcludeHeaderDump</span><span class="op" id="6113919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6113922">if</span>&nbsp;<span class="ident" id="6113925">err</span>&nbsp;<span class="op" id="6113929">!=</span>&nbsp;<span class="ident" id="6113932">nil</span>&nbsp;<span class="op" id="6113936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6113940">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6113948">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6113952">io</span><span class="op" id="6113954">.</span><span class="ident" id="6113955">WriteString</span><span class="op" id="6113966">(</span><span class="op" id="6113967">&amp;</span><span class="ident" id="6113968">b</span><span class="op" id="6113969">,</span>&nbsp;<span class="string" id="6113971">&#34;\r\n&#34;</span><span class="op" id="6113977">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6113981">if</span>&nbsp;<span class="ident" id="6113984">req</span><span class="op" id="6113987">.</span><span class="ident" id="6113988">Body</span>&nbsp;<span class="op" id="6113993">!=</span>&nbsp;<span class="ident" id="6113996">nil</span>&nbsp;<span class="op" id="6114000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6114004">var</span>&nbsp;<span class="ident" id="6114008">dest</span>&nbsp;<span class="ident" id="6114013">io</span><span class="op" id="6114015">.</span><span class="ident" id="6114016">Writer</span>&nbsp;<span class="op" id="6114023">=</span>&nbsp;<span class="op" id="6114025">&amp;</span><span class="ident" id="6114026">b</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6114030">if</span>&nbsp;<span class="ident" id="6114033">chunked</span>&nbsp;<span class="op" id="6114041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6114046">dest</span>&nbsp;<span class="op" id="6114051">=</span>&nbsp;<span class="ident" id="6114053">NewChunkedWriter</span><span class="op" id="6114069">(</span><span class="ident" id="6114070">dest</span><span class="op" id="6114074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6114078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6114082">_</span><span class="op" id="6114083">,</span>&nbsp;<span class="ident" id="6114085">err</span>&nbsp;<span class="op" id="6114089">=</span>&nbsp;<span class="ident" id="6114091">io</span><span class="op" id="6114093">.</span><span class="ident" id="6114094">Copy</span><span class="op" id="6114098">(</span><span class="ident" id="6114099">dest</span><span class="op" id="6114103">,</span>&nbsp;<span class="ident" id="6114105">req</span><span class="op" id="6114108">.</span><span class="ident" id="6114109">Body</span><span class="op" id="6114113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6114117">if</span>&nbsp;<span class="ident" id="6114120">chunked</span>&nbsp;<span class="op" id="6114128">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6114133">dest</span><span class="op" id="6114137">.</span><span class="op" id="6114138">(</span><span class="ident" id="6114139">io</span><span class="op" id="6114141">.</span><span class="ident" id="6114142">Closer</span><span class="op" id="6114148">)</span><span class="op" id="6114149">.</span><span class="ident" id="6114150">Close</span><span class="op" id="6114155">(</span><span class="op" id="6114156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6114161">io</span><span class="op" id="6114163">.</span><span class="ident" id="6114164">WriteString</span><span class="op" id="6114175">(</span><span class="op" id="6114176">&amp;</span><span class="ident" id="6114177">b</span><span class="op" id="6114178">,</span>&nbsp;<span class="string" id="6114180">&#34;\r\n&#34;</span><span class="op" id="6114186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6114190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6114193">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6114197">req</span><span class="op" id="6114200">.</span><span class="ident" id="6114201">Body</span>&nbsp;<span class="op" id="6114206">=</span>&nbsp;<span class="ident" id="6114208">save</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6114214">if</span>&nbsp;<span class="ident" id="6114217">err</span>&nbsp;<span class="op" id="6114221">!=</span>&nbsp;<span class="ident" id="6114224">nil</span>&nbsp;<span class="op" id="6114228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6114232">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6114240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6114243">dump</span>&nbsp;<span class="op" id="6114248">=</span>&nbsp;<span class="ident" id="6114250">b</span><span class="op" id="6114251">.</span><span class="ident" id="6114252">Bytes</span><span class="op" id="6114257">(</span><span class="op" id="6114258">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6114261">return</span><br>
<span class="lineno"></span><span class="op" id="6114268">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6114271">//&nbsp;errNoBody&nbsp;is&nbsp;a&nbsp;sentinel&nbsp;error&nbsp;value&nbsp;used&nbsp;by&nbsp;failureToReadBody&nbsp;so&nbsp;we&nbsp;can&nbsp;detect</span><br>
<span class="lineno"></span><span class="comment" id="6114353">//&nbsp;that&nbsp;the&nbsp;lack&nbsp;of&nbsp;body&nbsp;was&nbsp;intentional.</span><br>
<span class="lineno">245</span><span class="keyword" id="6114395">var</span>&nbsp;<span class="ident" id="6114399">errNoBody</span>&nbsp;<span class="op" id="6114409">=</span>&nbsp;<span class="ident" id="6114411">errors</span><span class="op" id="6114417">.</span><span class="ident" id="6114418">New</span><span class="op" id="6114421">(</span><span class="string" id="6114422">&#34;sentinel&nbsp;error&nbsp;value&#34;</span><span class="op" id="6114444">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6114447">//&nbsp;failureToReadBody&nbsp;is&nbsp;a&nbsp;io.ReadCloser&nbsp;that&nbsp;just&nbsp;returns&nbsp;errNoBody&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="6114518">//&nbsp;Read.&nbsp;&nbsp;It&#39;s&nbsp;swapped&nbsp;in&nbsp;when&nbsp;we&nbsp;don&#39;t&nbsp;actually&nbsp;want&nbsp;to&nbsp;consume&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6114587">//&nbsp;body,&nbsp;but&nbsp;need&nbsp;a&nbsp;non-nil&nbsp;one,&nbsp;and&nbsp;want&nbsp;to&nbsp;distinguish&nbsp;the&nbsp;error</span><br>
<span class="lineno">250</span><span class="comment" id="6114654">//&nbsp;from&nbsp;reading&nbsp;the&nbsp;dummy&nbsp;body.</span><br>
<span class="lineno"></span><span class="keyword" id="6114686">type</span>&nbsp;<span class="ident" id="6114691">failureToReadBody</span>&nbsp;<span class="keyword" id="6114709">struct</span><span class="op" id="6114715">{</span><span class="op" id="6114716">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6114719">func</span>&nbsp;<span class="op" id="6114724">(</span><span class="ident" id="6114725">failureToReadBody</span><span class="op" id="6114742">)</span>&nbsp;<span class="ident" id="6114744">Read</span><span class="op" id="6114748">(</span><span class="op" id="6114749">[</span><span class="op" id="6114750">]</span><span class="builtintype" id="6114751">byte</span><span class="op" id="6114755">)</span>&nbsp;<span class="op" id="6114757">(</span><span class="builtintype" id="6114758">int</span><span class="op" id="6114761">,</span>&nbsp;<span class="builtintype" id="6114763">error</span><span class="op" id="6114768">)</span>&nbsp;<span class="op" id="6114770">{</span>&nbsp;<span class="keyword" id="6114772">return</span>&nbsp;<span class="num" id="6114779">0</span><span class="op" id="6114780">,</span>&nbsp;<span class="ident" id="6114782">errNoBody</span>&nbsp;<span class="op" id="6114792">}</span><br>
<span class="lineno"></span><span class="keyword" id="6114794">func</span>&nbsp;<span class="op" id="6114799">(</span><span class="ident" id="6114800">failureToReadBody</span><span class="op" id="6114817">)</span>&nbsp;<span class="ident" id="6114819">Close</span><span class="op" id="6114824">(</span><span class="op" id="6114825">)</span>&nbsp;<span class="builtintype" id="6114827">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6114845">{</span>&nbsp;<span class="keyword" id="6114847">return</span>&nbsp;<span class="ident" id="6114854">nil</span>&nbsp;<span class="op" id="6114858">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="6114861">var</span>&nbsp;<span class="ident" id="6114865">emptyBody</span>&nbsp;<span class="op" id="6114875">=</span>&nbsp;<span class="ident" id="6114877">ioutil</span><span class="op" id="6114883">.</span><span class="ident" id="6114884">NopCloser</span><span class="op" id="6114893">(</span><span class="ident" id="6114894">strings</span><span class="op" id="6114901">.</span><span class="ident" id="6114902">NewReader</span><span class="op" id="6114911">(</span><span class="string" id="6114912">&#34;&#34;</span><span class="op" id="6114914">)</span><span class="op" id="6114915">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6114918">//&nbsp;DumpResponse&nbsp;is&nbsp;like&nbsp;DumpRequest&nbsp;but&nbsp;dumps&nbsp;a&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="6114976">func</span>&nbsp;<span class="ident" id="6114981">DumpResponse</span><span class="op" id="6114993">(</span><span class="ident" id="6114994">resp</span>&nbsp;<span class="op" id="6114999">*</span><span class="ident" id="6115000">http</span><span class="op" id="6115004">.</span><span class="ident" id="6115005">Response</span><span class="op" id="6115013">,</span>&nbsp;<span class="ident" id="6115015">body</span>&nbsp;<span class="builtintype" id="6115020">bool</span><span class="op" id="6115024">)</span>&nbsp;<span class="op" id="6115026">(</span><span class="ident" id="6115027">dump</span>&nbsp;<span class="op" id="6115032">[</span><span class="op" id="6115033">]</span><span class="builtintype" id="6115034">byte</span><span class="op" id="6115038">,</span>&nbsp;<span class="ident" id="6115040">err</span>&nbsp;<span class="builtintype" id="6115044">error</span><span class="op" id="6115049">)</span>&nbsp;<span class="op" id="6115051">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6115054">var</span>&nbsp;<span class="ident" id="6115058">b</span>&nbsp;<span class="ident" id="6115060">bytes</span><span class="op" id="6115065">.</span><span class="ident" id="6115066">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6115074">save</span>&nbsp;<span class="op" id="6115079">:=</span>&nbsp;<span class="ident" id="6115082">resp</span><span class="op" id="6115086">.</span><span class="ident" id="6115087">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6115093">savecl</span>&nbsp;<span class="op" id="6115100">:=</span>&nbsp;<span class="ident" id="6115103">resp</span><span class="op" id="6115107">.</span><span class="ident" id="6115108">ContentLength</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6115124">if</span>&nbsp;<span class="op" id="6115127">!</span><span class="ident" id="6115128">body</span>&nbsp;<span class="op" id="6115133">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6115137">resp</span><span class="op" id="6115141">.</span><span class="ident" id="6115142">Body</span>&nbsp;<span class="op" id="6115147">=</span>&nbsp;<span class="ident" id="6115149">failureToReadBody</span><span class="op" id="6115166">{</span><span class="op" id="6115167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6115170">}</span>&nbsp;<span class="keyword" id="6115172">else</span>&nbsp;<span class="keyword" id="6115177">if</span>&nbsp;<span class="ident" id="6115180">resp</span><span class="op" id="6115184">.</span><span class="ident" id="6115185">Body</span>&nbsp;<span class="op" id="6115190">==</span>&nbsp;<span class="ident" id="6115193">nil</span>&nbsp;<span class="op" id="6115197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6115201">resp</span><span class="op" id="6115205">.</span><span class="ident" id="6115206">Body</span>&nbsp;<span class="op" id="6115211">=</span>&nbsp;<span class="ident" id="6115213">emptyBody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6115224">}</span>&nbsp;<span class="keyword" id="6115226">else</span>&nbsp;<span class="op" id="6115231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6115235">save</span><span class="op" id="6115239">,</span>&nbsp;<span class="ident" id="6115241">resp</span><span class="op" id="6115245">.</span><span class="ident" id="6115246">Body</span><span class="op" id="6115250">,</span>&nbsp;<span class="ident" id="6115252">err</span>&nbsp;<span class="op" id="6115256">=</span>&nbsp;<span class="ident" id="6115258">drainBody</span><span class="op" id="6115267">(</span><span class="ident" id="6115268">resp</span><span class="op" id="6115272">.</span><span class="ident" id="6115273">Body</span><span class="op" id="6115277">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6115281">if</span>&nbsp;<span class="ident" id="6115284">err</span>&nbsp;<span class="op" id="6115288">!=</span>&nbsp;<span class="ident" id="6115291">nil</span>&nbsp;<span class="op" id="6115295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6115300">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6115309">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6115312">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6115315">err</span>&nbsp;<span class="op" id="6115319">=</span>&nbsp;<span class="ident" id="6115321">resp</span><span class="op" id="6115325">.</span><span class="ident" id="6115326">Write</span><span class="op" id="6115331">(</span><span class="op" id="6115332">&amp;</span><span class="ident" id="6115333">b</span><span class="op" id="6115334">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6115337">if</span>&nbsp;<span class="ident" id="6115340">err</span>&nbsp;<span class="op" id="6115344">==</span>&nbsp;<span class="ident" id="6115347">errNoBody</span>&nbsp;<span class="op" id="6115357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6115361">err</span>&nbsp;<span class="op" id="6115365">=</span>&nbsp;<span class="ident" id="6115367">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6115372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6115375">resp</span><span class="op" id="6115379">.</span><span class="ident" id="6115380">Body</span>&nbsp;<span class="op" id="6115385">=</span>&nbsp;<span class="ident" id="6115387">save</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6115393">resp</span><span class="op" id="6115397">.</span><span class="ident" id="6115398">ContentLength</span>&nbsp;<span class="op" id="6115412">=</span>&nbsp;<span class="ident" id="6115414">savecl</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6115422">if</span>&nbsp;<span class="ident" id="6115425">err</span>&nbsp;<span class="op" id="6115429">!=</span>&nbsp;<span class="ident" id="6115432">nil</span>&nbsp;<span class="op" id="6115436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6115440">return</span>&nbsp;<span class="ident" id="6115447">nil</span><span class="op" id="6115450">,</span>&nbsp;<span class="ident" id="6115452">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6115457">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6115460">return</span>&nbsp;<span class="ident" id="6115467">b</span><span class="op" id="6115468">.</span><span class="ident" id="6115469">Bytes</span><span class="op" id="6115474">(</span><span class="op" id="6115475">)</span><span class="op" id="6115476">,</span>&nbsp;<span class="ident" id="6115478">nil</span><br>
<span class="lineno"></span><span class="op" id="6115482">}</span>
</div>
</body>
</html>
