<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3741337">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3741392">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3741446">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="3741496">//</span><br>
<span class="lineno">5</span><br>
<span class="lineno"></span><span class="comment" id="3741500">/*<br>
<span class="lineno"></span>Package&nbsp;multipart&nbsp;implements&nbsp;MIME&nbsp;multipart&nbsp;parsing,&nbsp;as&nbsp;defined&nbsp;in&nbsp;RFC<br>
<span class="lineno"></span>2046.<br>
<span class="lineno"></span><br>
<span class="lineno">10</span>The&nbsp;implementation&nbsp;is&nbsp;sufficient&nbsp;for&nbsp;HTTP&nbsp;(RFC&nbsp;2388)&nbsp;and&nbsp;the&nbsp;multipart<br>
<span class="lineno"></span>bodies&nbsp;generated&nbsp;by&nbsp;popular&nbsp;browsers.<br>
<span class="lineno"></span>*/</span><br>
<span class="lineno"></span><span class="keyword" id="3741693">package</span>&nbsp;<span class="ident" id="3741701">multipart</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="3741712">import</span>&nbsp;<span class="op" id="3741719">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3741722">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3741731">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3741740">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3741747">&#34;io&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3741753">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3741766">&#34;mime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3741774">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span><span class="op" id="3741790">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="3741793">var</span>&nbsp;<span class="ident" id="3741797">emptyParams</span>&nbsp;<span class="op" id="3741809">=</span>&nbsp;<span class="builtinfunc" id="3741811">make</span><span class="op" id="3741815">(</span><span class="keyword" id="3741816">map</span><span class="op" id="3741819">[</span><span class="builtintype" id="3741820">string</span><span class="op" id="3741826">]</span><span class="builtintype" id="3741827">string</span><span class="op" id="3741833">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3741836">//&nbsp;A&nbsp;Part&nbsp;represents&nbsp;a&nbsp;single&nbsp;part&nbsp;in&nbsp;a&nbsp;multipart&nbsp;body.</span><br>
<span class="lineno"></span><span class="keyword" id="3741892">type</span>&nbsp;<span class="ident" id="3741897">Part</span>&nbsp;<span class="keyword" id="3741902">struct</span>&nbsp;<span class="op" id="3741909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3741912">//&nbsp;The&nbsp;headers&nbsp;of&nbsp;the&nbsp;body,&nbsp;if&nbsp;any,&nbsp;with&nbsp;the&nbsp;keys&nbsp;canonicalized</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3741977">//&nbsp;in&nbsp;the&nbsp;same&nbsp;fashion&nbsp;that&nbsp;the&nbsp;Go&nbsp;http.Request&nbsp;headers&nbsp;are.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3742039">//&nbsp;For&nbsp;example,&nbsp;&#34;foo-bar&#34;&nbsp;changes&nbsp;case&nbsp;to&nbsp;&#34;Foo-Bar&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3742092">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3742096">//&nbsp;As&nbsp;a&nbsp;special&nbsp;case,&nbsp;if&nbsp;the&nbsp;&#34;Content-Transfer-Encoding&#34;&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3742161">//&nbsp;has&nbsp;a&nbsp;value&nbsp;of&nbsp;&#34;quoted-printable&#34;,&nbsp;that&nbsp;header&nbsp;is&nbsp;instead</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3742223">//&nbsp;hidden&nbsp;from&nbsp;this&nbsp;map&nbsp;and&nbsp;the&nbsp;body&nbsp;is&nbsp;transparently&nbsp;decoded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3742286">//&nbsp;during&nbsp;Read&nbsp;calls.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3742309">Header</span>&nbsp;<span class="ident" id="3742316">textproto</span><span class="op" id="3742325">.</span><span class="ident" id="3742326">MIMEHeader</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3742339">buffer</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3742349">*</span><span class="ident" id="3742350">bytes</span><span class="op" id="3742355">.</span><span class="ident" id="3742356">Buffer</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3742364">mr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3742374">*</span><span class="ident" id="3742375">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3742383">bytesRead</span>&nbsp;<span class="builtintype" id="3742393">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3742399">disposition</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3742417">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3742425">dispositionParams</span>&nbsp;<span class="keyword" id="3742443">map</span><span class="op" id="3742446">[</span><span class="builtintype" id="3742447">string</span><span class="op" id="3742453">]</span><span class="builtintype" id="3742454">string</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3742463">//&nbsp;r&nbsp;is&nbsp;either&nbsp;a&nbsp;reader&nbsp;directly&nbsp;reading&nbsp;from&nbsp;mr,&nbsp;or&nbsp;it&#39;s&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3742524">//&nbsp;wrapper&nbsp;around&nbsp;such&nbsp;a&nbsp;reader,&nbsp;decoding&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3742571">//&nbsp;Content-Transfer-Encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3742601">r</span>&nbsp;<span class="ident" id="3742603">io</span><span class="op" id="3742605">.</span><span class="ident" id="3742606">Reader</span><br>
<span class="lineno">50</span><span class="op" id="3742613">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3742616">//&nbsp;FormName&nbsp;returns&nbsp;the&nbsp;name&nbsp;parameter&nbsp;if&nbsp;p&nbsp;has&nbsp;a&nbsp;Content-Disposition</span><br>
<span class="lineno"></span><span class="comment" id="3742686">//&nbsp;of&nbsp;type&nbsp;&#34;form-data&#34;.&nbsp;&nbsp;Otherwise&nbsp;it&nbsp;returns&nbsp;the&nbsp;empty&nbsp;string.</span><br>
<span class="lineno"></span><span class="keyword" id="3742750">func</span>&nbsp;<span class="op" id="3742755">(</span><span class="ident" id="3742756">p</span>&nbsp;<span class="op" id="3742758">*</span><span class="ident" id="3742759">Part</span><span class="op" id="3742763">)</span>&nbsp;<span class="ident" id="3742765">FormName</span><span class="op" id="3742773">(</span><span class="op" id="3742774">)</span>&nbsp;<span class="builtintype" id="3742776">string</span>&nbsp;<span class="op" id="3742783">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3742786">//&nbsp;See&nbsp;http://tools.ietf.org/html/rfc2183&nbsp;section&nbsp;2&nbsp;for&nbsp;EBNF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3742848">//&nbsp;of&nbsp;Content-Disposition&nbsp;value&nbsp;format.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742889">if</span>&nbsp;<span class="ident" id="3742892">p</span><span class="op" id="3742893">.</span><span class="ident" id="3742894">dispositionParams</span>&nbsp;<span class="op" id="3742912">==</span>&nbsp;<span class="ident" id="3742915">nil</span>&nbsp;<span class="op" id="3742919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3742923">p</span><span class="op" id="3742924">.</span><span class="ident" id="3742925">parseContentDisposition</span><span class="op" id="3742948">(</span><span class="op" id="3742949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3742952">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742955">if</span>&nbsp;<span class="ident" id="3742958">p</span><span class="op" id="3742959">.</span><span class="ident" id="3742960">disposition</span>&nbsp;<span class="op" id="3742972">!=</span>&nbsp;<span class="string" id="3742975">&#34;form-data&#34;</span>&nbsp;<span class="op" id="3742987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742991">return</span>&nbsp;<span class="string" id="3742998">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3743002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3743005">return</span>&nbsp;<span class="ident" id="3743012">p</span><span class="op" id="3743013">.</span><span class="ident" id="3743014">dispositionParams</span><span class="op" id="3743031">[</span><span class="string" id="3743032">&#34;name&#34;</span><span class="op" id="3743038">]</span><br>
<span class="lineno"></span><span class="op" id="3743040">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="3743043">//&nbsp;FileName&nbsp;returns&nbsp;the&nbsp;filename&nbsp;parameter&nbsp;of&nbsp;the&nbsp;Part&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3743100">//&nbsp;Content-Disposition&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="3743131">func</span>&nbsp;<span class="op" id="3743136">(</span><span class="ident" id="3743137">p</span>&nbsp;<span class="op" id="3743139">*</span><span class="ident" id="3743140">Part</span><span class="op" id="3743144">)</span>&nbsp;<span class="ident" id="3743146">FileName</span><span class="op" id="3743154">(</span><span class="op" id="3743155">)</span>&nbsp;<span class="builtintype" id="3743157">string</span>&nbsp;<span class="op" id="3743164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3743167">if</span>&nbsp;<span class="ident" id="3743170">p</span><span class="op" id="3743171">.</span><span class="ident" id="3743172">dispositionParams</span>&nbsp;<span class="op" id="3743190">==</span>&nbsp;<span class="ident" id="3743193">nil</span>&nbsp;<span class="op" id="3743197">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3743201">p</span><span class="op" id="3743202">.</span><span class="ident" id="3743203">parseContentDisposition</span><span class="op" id="3743226">(</span><span class="op" id="3743227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3743230">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3743233">return</span>&nbsp;<span class="ident" id="3743240">p</span><span class="op" id="3743241">.</span><span class="ident" id="3743242">dispositionParams</span><span class="op" id="3743259">[</span><span class="string" id="3743260">&#34;filename&#34;</span><span class="op" id="3743270">]</span><br>
<span class="lineno"></span><span class="op" id="3743272">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="keyword" id="3743275">func</span>&nbsp;<span class="op" id="3743280">(</span><span class="ident" id="3743281">p</span>&nbsp;<span class="op" id="3743283">*</span><span class="ident" id="3743284">Part</span><span class="op" id="3743288">)</span>&nbsp;<span class="ident" id="3743290">parseContentDisposition</span><span class="op" id="3743313">(</span><span class="op" id="3743314">)</span>&nbsp;<span class="op" id="3743316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3743319">v</span>&nbsp;<span class="op" id="3743321">:=</span>&nbsp;<span class="ident" id="3743324">p</span><span class="op" id="3743325">.</span><span class="ident" id="3743326">Header</span><span class="op" id="3743332">.</span><span class="ident" id="3743333">Get</span><span class="op" id="3743336">(</span><span class="string" id="3743337">&#34;Content-Disposition&#34;</span><span class="op" id="3743358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3743361">var</span>&nbsp;<span class="ident" id="3743365">err</span>&nbsp;<span class="builtintype" id="3743369">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3743376">p</span><span class="op" id="3743377">.</span><span class="ident" id="3743378">disposition</span><span class="op" id="3743389">,</span>&nbsp;<span class="ident" id="3743391">p</span><span class="op" id="3743392">.</span><span class="ident" id="3743393">dispositionParams</span><span class="op" id="3743410">,</span>&nbsp;<span class="ident" id="3743412">err</span>&nbsp;<span class="op" id="3743416">=</span>&nbsp;<span class="ident" id="3743418">mime</span><span class="op" id="3743422">.</span><span class="ident" id="3743423">ParseMediaType</span><span class="op" id="3743437">(</span><span class="ident" id="3743438">v</span><span class="op" id="3743439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3743442">if</span>&nbsp;<span class="ident" id="3743445">err</span>&nbsp;<span class="op" id="3743449">!=</span>&nbsp;<span class="ident" id="3743452">nil</span>&nbsp;<span class="op" id="3743456">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3743460">p</span><span class="op" id="3743461">.</span><span class="ident" id="3743462">dispositionParams</span>&nbsp;<span class="op" id="3743480">=</span>&nbsp;<span class="ident" id="3743482">emptyParams</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3743495">}</span><br>
<span class="lineno"></span><span class="op" id="3743497">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3743500">//&nbsp;NewReader&nbsp;creates&nbsp;a&nbsp;new&nbsp;multipart&nbsp;Reader&nbsp;reading&nbsp;from&nbsp;r&nbsp;using&nbsp;the</span><br>
<span class="lineno">85</span><span class="comment" id="3743569">//&nbsp;given&nbsp;MIME&nbsp;boundary.</span><br>
<span class="lineno"></span><span class="comment" id="3743593">//</span><br>
<span class="lineno"></span><span class="comment" id="3743596">//&nbsp;The&nbsp;boundary&nbsp;is&nbsp;usually&nbsp;obtained&nbsp;from&nbsp;the&nbsp;&#34;boundary&#34;&nbsp;parameter&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3743665">//&nbsp;the&nbsp;message&#39;s&nbsp;&#34;Content-Type&#34;&nbsp;header.&nbsp;Use&nbsp;mime.ParseMediaType&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3743732">//&nbsp;parse&nbsp;such&nbsp;headers.</span><br>
<span class="lineno">90</span><span class="keyword" id="3743755">func</span>&nbsp;<span class="ident" id="3743760">NewReader</span><span class="op" id="3743769">(</span><span class="ident" id="3743770">r</span>&nbsp;<span class="ident" id="3743772">io</span><span class="op" id="3743774">.</span><span class="ident" id="3743775">Reader</span><span class="op" id="3743781">,</span>&nbsp;<span class="ident" id="3743783">boundary</span>&nbsp;<span class="builtintype" id="3743792">string</span><span class="op" id="3743798">)</span>&nbsp;<span class="op" id="3743800">*</span><span class="ident" id="3743801">Reader</span>&nbsp;<span class="op" id="3743808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3743811">b</span>&nbsp;<span class="op" id="3743813">:=</span>&nbsp;<span class="op" id="3743816">[</span><span class="op" id="3743817">]</span><span class="builtintype" id="3743818">byte</span><span class="op" id="3743822">(</span><span class="string" id="3743823">&#34;\r\n--&#34;</span>&nbsp;<span class="op" id="3743832">+</span>&nbsp;<span class="ident" id="3743834">boundary</span>&nbsp;<span class="op" id="3743843">+</span>&nbsp;<span class="string" id="3743845">&#34;--&#34;</span><span class="op" id="3743849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3743852">return</span>&nbsp;<span class="op" id="3743859">&amp;</span><span class="ident" id="3743860">Reader</span><span class="op" id="3743866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3743870">bufReader</span><span class="op" id="3743879">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3743888">bufio</span><span class="op" id="3743893">.</span><span class="ident" id="3743894">NewReader</span><span class="op" id="3743903">(</span><span class="ident" id="3743904">r</span><span class="op" id="3743905">)</span><span class="op" id="3743906">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3743910">nl</span><span class="op" id="3743912">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3743928">b</span><span class="op" id="3743929">[</span><span class="op" id="3743930">:</span><span class="num" id="3743931">2</span><span class="op" id="3743932">]</span><span class="op" id="3743933">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3743937">nlDashBoundary</span><span class="op" id="3743951">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3743955">b</span><span class="op" id="3743956">[</span><span class="op" id="3743957">:</span><span class="builtinfunc" id="3743958">len</span><span class="op" id="3743961">(</span><span class="ident" id="3743962">b</span><span class="op" id="3743963">)</span><span class="op" id="3743964">-</span><span class="num" id="3743965">2</span><span class="op" id="3743966">]</span><span class="op" id="3743967">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3743971">dashBoundaryDash</span><span class="op" id="3743987">:</span>&nbsp;<span class="ident" id="3743989">b</span><span class="op" id="3743990">[</span><span class="num" id="3743991">2</span><span class="op" id="3743992">:</span><span class="op" id="3743993">]</span><span class="op" id="3743994">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3743998">dashBoundary</span><span class="op" id="3744010">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3744016">b</span><span class="op" id="3744017">[</span><span class="num" id="3744018">2</span>&nbsp;<span class="op" id="3744020">:</span>&nbsp;<span class="builtinfunc" id="3744022">len</span><span class="op" id="3744025">(</span><span class="ident" id="3744026">b</span><span class="op" id="3744027">)</span><span class="op" id="3744028">-</span><span class="num" id="3744029">2</span><span class="op" id="3744030">]</span><span class="op" id="3744031">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3744034">}</span><br>
<span class="lineno"></span><span class="op" id="3744036">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="3744039">func</span>&nbsp;<span class="ident" id="3744044">newPart</span><span class="op" id="3744051">(</span><span class="ident" id="3744052">mr</span>&nbsp;<span class="op" id="3744055">*</span><span class="ident" id="3744056">Reader</span><span class="op" id="3744062">)</span>&nbsp;<span class="op" id="3744064">(</span><span class="op" id="3744065">*</span><span class="ident" id="3744066">Part</span><span class="op" id="3744070">,</span>&nbsp;<span class="builtintype" id="3744072">error</span><span class="op" id="3744077">)</span>&nbsp;<span class="op" id="3744079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3744082">bp</span>&nbsp;<span class="op" id="3744085">:=</span>&nbsp;<span class="op" id="3744088">&amp;</span><span class="ident" id="3744089">Part</span><span class="op" id="3744093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3744097">Header</span><span class="op" id="3744103">:</span>&nbsp;<span class="builtinfunc" id="3744105">make</span><span class="op" id="3744109">(</span><span class="keyword" id="3744110">map</span><span class="op" id="3744113">[</span><span class="builtintype" id="3744114">string</span><span class="op" id="3744120">]</span><span class="op" id="3744121">[</span><span class="op" id="3744122">]</span><span class="builtintype" id="3744123">string</span><span class="op" id="3744129">)</span><span class="op" id="3744130">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3744134">mr</span><span class="op" id="3744136">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3744142">mr</span><span class="op" id="3744144">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3744148">buffer</span><span class="op" id="3744154">:</span>&nbsp;<span class="builtinfunc" id="3744156">new</span><span class="op" id="3744159">(</span><span class="ident" id="3744160">bytes</span><span class="op" id="3744165">.</span><span class="ident" id="3744166">Buffer</span><span class="op" id="3744172">)</span><span class="op" id="3744173">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3744176">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3744179">if</span>&nbsp;<span class="ident" id="3744182">err</span>&nbsp;<span class="op" id="3744186">:=</span>&nbsp;<span class="ident" id="3744189">bp</span><span class="op" id="3744191">.</span><span class="ident" id="3744192">populateHeaders</span><span class="op" id="3744207">(</span><span class="op" id="3744208">)</span><span class="op" id="3744209">;</span>&nbsp;<span class="ident" id="3744211">err</span>&nbsp;<span class="op" id="3744215">!=</span>&nbsp;<span class="ident" id="3744218">nil</span>&nbsp;<span class="op" id="3744222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3744226">return</span>&nbsp;<span class="ident" id="3744233">nil</span><span class="op" id="3744236">,</span>&nbsp;<span class="ident" id="3744238">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3744243">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3744246">bp</span><span class="op" id="3744248">.</span><span class="ident" id="3744249">r</span>&nbsp;<span class="op" id="3744251">=</span>&nbsp;<span class="ident" id="3744253">partReader</span><span class="op" id="3744263">{</span><span class="ident" id="3744264">bp</span><span class="op" id="3744266">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3744269">const</span>&nbsp;<span class="ident" id="3744275">cte</span>&nbsp;<span class="op" id="3744279">=</span>&nbsp;<span class="string" id="3744281">&#34;Content-Transfer-Encoding&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3744310">if</span>&nbsp;<span class="ident" id="3744313">bp</span><span class="op" id="3744315">.</span><span class="ident" id="3744316">Header</span><span class="op" id="3744322">.</span><span class="ident" id="3744323">Get</span><span class="op" id="3744326">(</span><span class="ident" id="3744327">cte</span><span class="op" id="3744330">)</span>&nbsp;<span class="op" id="3744332">==</span>&nbsp;<span class="string" id="3744335">&#34;quoted-printable&#34;</span>&nbsp;<span class="op" id="3744354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3744358">bp</span><span class="op" id="3744360">.</span><span class="ident" id="3744361">Header</span><span class="op" id="3744367">.</span><span class="ident" id="3744368">Del</span><span class="op" id="3744371">(</span><span class="ident" id="3744372">cte</span><span class="op" id="3744375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3744379">bp</span><span class="op" id="3744381">.</span><span class="ident" id="3744382">r</span>&nbsp;<span class="op" id="3744384">=</span>&nbsp;<span class="ident" id="3744386">newQuotedPrintableReader</span><span class="op" id="3744410">(</span><span class="ident" id="3744411">bp</span><span class="op" id="3744413">.</span><span class="ident" id="3744414">r</span><span class="op" id="3744415">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3744418">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3744421">return</span>&nbsp;<span class="ident" id="3744428">bp</span><span class="op" id="3744430">,</span>&nbsp;<span class="ident" id="3744432">nil</span><br>
<span class="lineno"></span><span class="op" id="3744436">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3744439">func</span>&nbsp;<span class="op" id="3744444">(</span><span class="ident" id="3744445">bp</span>&nbsp;<span class="op" id="3744448">*</span><span class="ident" id="3744449">Part</span><span class="op" id="3744453">)</span>&nbsp;<span class="ident" id="3744455">populateHeaders</span><span class="op" id="3744470">(</span><span class="op" id="3744471">)</span>&nbsp;<span class="builtintype" id="3744473">error</span>&nbsp;<span class="op" id="3744479">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3744482">r</span>&nbsp;<span class="op" id="3744484">:=</span>&nbsp;<span class="ident" id="3744487">textproto</span><span class="op" id="3744496">.</span><span class="ident" id="3744497">NewReader</span><span class="op" id="3744506">(</span><span class="ident" id="3744507">bp</span><span class="op" id="3744509">.</span><span class="ident" id="3744510">mr</span><span class="op" id="3744512">.</span><span class="ident" id="3744513">bufReader</span><span class="op" id="3744522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3744525">header</span><span class="op" id="3744531">,</span>&nbsp;<span class="ident" id="3744533">err</span>&nbsp;<span class="op" id="3744537">:=</span>&nbsp;<span class="ident" id="3744540">r</span><span class="op" id="3744541">.</span><span class="ident" id="3744542">ReadMIMEHeader</span><span class="op" id="3744556">(</span><span class="op" id="3744557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3744560">if</span>&nbsp;<span class="ident" id="3744563">err</span>&nbsp;<span class="op" id="3744567">==</span>&nbsp;<span class="ident" id="3744570">nil</span>&nbsp;<span class="op" id="3744574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3744578">bp</span><span class="op" id="3744580">.</span><span class="ident" id="3744581">Header</span>&nbsp;<span class="op" id="3744588">=</span>&nbsp;<span class="ident" id="3744590">header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3744598">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3744601">return</span>&nbsp;<span class="ident" id="3744608">err</span><br>
<span class="lineno"></span><span class="op" id="3744612">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3744615">//&nbsp;Read&nbsp;reads&nbsp;the&nbsp;body&nbsp;of&nbsp;a&nbsp;part,&nbsp;after&nbsp;its&nbsp;headers&nbsp;and&nbsp;before&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3744682">//&nbsp;next&nbsp;part&nbsp;(if&nbsp;any)&nbsp;begins.</span><br>
<span class="lineno">130</span><span class="keyword" id="3744712">func</span>&nbsp;<span class="op" id="3744717">(</span><span class="ident" id="3744718">p</span>&nbsp;<span class="op" id="3744720">*</span><span class="ident" id="3744721">Part</span><span class="op" id="3744725">)</span>&nbsp;<span class="ident" id="3744727">Read</span><span class="op" id="3744731">(</span><span class="ident" id="3744732">d</span>&nbsp;<span class="op" id="3744734">[</span><span class="op" id="3744735">]</span><span class="builtintype" id="3744736">byte</span><span class="op" id="3744740">)</span>&nbsp;<span class="op" id="3744742">(</span><span class="ident" id="3744743">n</span>&nbsp;<span class="builtintype" id="3744745">int</span><span class="op" id="3744748">,</span>&nbsp;<span class="ident" id="3744750">err</span>&nbsp;<span class="builtintype" id="3744754">error</span><span class="op" id="3744759">)</span>&nbsp;<span class="op" id="3744761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3744764">return</span>&nbsp;<span class="ident" id="3744771">p</span><span class="op" id="3744772">.</span><span class="ident" id="3744773">r</span><span class="op" id="3744774">.</span><span class="ident" id="3744775">Read</span><span class="op" id="3744779">(</span><span class="ident" id="3744780">d</span><span class="op" id="3744781">)</span><br>
<span class="lineno"></span><span class="op" id="3744783">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3744786">//&nbsp;partReader&nbsp;implements&nbsp;io.Reader&nbsp;by&nbsp;reading&nbsp;raw&nbsp;bytes&nbsp;directly&nbsp;from&nbsp;the</span><br>
<span class="lineno">135</span><span class="comment" id="3744860">//&nbsp;wrapped&nbsp;*Part,&nbsp;without&nbsp;doing&nbsp;any&nbsp;Transfer-Encoding&nbsp;decoding.</span><br>
<span class="lineno"></span><span class="keyword" id="3744924">type</span>&nbsp;<span class="ident" id="3744929">partReader</span>&nbsp;<span class="keyword" id="3744940">struct</span>&nbsp;<span class="op" id="3744947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3744950">p</span>&nbsp;<span class="op" id="3744952">*</span><span class="ident" id="3744953">Part</span><br>
<span class="lineno"></span><span class="op" id="3744958">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="keyword" id="3744961">func</span>&nbsp;<span class="op" id="3744966">(</span><span class="ident" id="3744967">pr</span>&nbsp;<span class="ident" id="3744970">partReader</span><span class="op" id="3744980">)</span>&nbsp;<span class="ident" id="3744982">Read</span><span class="op" id="3744986">(</span><span class="ident" id="3744987">d</span>&nbsp;<span class="op" id="3744989">[</span><span class="op" id="3744990">]</span><span class="builtintype" id="3744991">byte</span><span class="op" id="3744995">)</span>&nbsp;<span class="op" id="3744997">(</span><span class="ident" id="3744998">n</span>&nbsp;<span class="builtintype" id="3745000">int</span><span class="op" id="3745003">,</span>&nbsp;<span class="ident" id="3745005">err</span>&nbsp;<span class="builtintype" id="3745009">error</span><span class="op" id="3745014">)</span>&nbsp;<span class="op" id="3745016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3745019">p</span>&nbsp;<span class="op" id="3745021">:=</span>&nbsp;<span class="ident" id="3745024">pr</span><span class="op" id="3745026">.</span><span class="ident" id="3745027">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3745030">defer</span>&nbsp;<span class="keyword" id="3745036">func</span><span class="op" id="3745040">(</span><span class="op" id="3745041">)</span>&nbsp;<span class="op" id="3745043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3745047">p</span><span class="op" id="3745048">.</span><span class="ident" id="3745049">bytesRead</span>&nbsp;<span class="op" id="3745059">+=</span>&nbsp;<span class="ident" id="3745062">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3745065">}</span><span class="op" id="3745066">(</span><span class="op" id="3745067">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3745070">if</span>&nbsp;<span class="ident" id="3745073">p</span><span class="op" id="3745074">.</span><span class="ident" id="3745075">buffer</span><span class="op" id="3745081">.</span><span class="ident" id="3745082">Len</span><span class="op" id="3745085">(</span><span class="op" id="3745086">)</span>&nbsp;<span class="op" id="3745088">&gt;=</span>&nbsp;<span class="builtinfunc" id="3745091">len</span><span class="op" id="3745094">(</span><span class="ident" id="3745095">d</span><span class="op" id="3745096">)</span>&nbsp;<span class="op" id="3745098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3745102">//&nbsp;Internal&nbsp;buffer&nbsp;of&nbsp;unconsumed&nbsp;data&nbsp;is&nbsp;large&nbsp;enough&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3745162">//&nbsp;the&nbsp;read&nbsp;request.&nbsp;&nbsp;No&nbsp;need&nbsp;to&nbsp;parse&nbsp;more&nbsp;at&nbsp;the&nbsp;moment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3745223">return</span>&nbsp;<span class="ident" id="3745230">p</span><span class="op" id="3745231">.</span><span class="ident" id="3745232">buffer</span><span class="op" id="3745238">.</span><span class="ident" id="3745239">Read</span><span class="op" id="3745243">(</span><span class="ident" id="3745244">d</span><span class="op" id="3745245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3745248">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3745251">peek</span><span class="op" id="3745255">,</span>&nbsp;<span class="ident" id="3745257">err</span>&nbsp;<span class="op" id="3745261">:=</span>&nbsp;<span class="ident" id="3745264">p</span><span class="op" id="3745265">.</span><span class="ident" id="3745266">mr</span><span class="op" id="3745268">.</span><span class="ident" id="3745269">bufReader</span><span class="op" id="3745278">.</span><span class="ident" id="3745279">Peek</span><span class="op" id="3745283">(</span><span class="num" id="3745284">4096</span><span class="op" id="3745288">)</span>&nbsp;<span class="comment" id="3745290">//&nbsp;TODO(bradfitz):&nbsp;add&nbsp;buffer&nbsp;size&nbsp;accessor</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3745336">//&nbsp;Look&nbsp;for&nbsp;an&nbsp;immediate&nbsp;empty&nbsp;part&nbsp;without&nbsp;a&nbsp;leading&nbsp;\r\n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3745396">//&nbsp;before&nbsp;the&nbsp;boundary&nbsp;separator.&nbsp;&nbsp;Some&nbsp;MIME&nbsp;code&nbsp;makes&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3745459">//&nbsp;parts&nbsp;like&nbsp;this.&nbsp;Most&nbsp;browsers,&nbsp;however,&nbsp;write&nbsp;the&nbsp;\r\n</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3745519">//&nbsp;before&nbsp;the&nbsp;subsequent&nbsp;boundary&nbsp;even&nbsp;for&nbsp;empty&nbsp;parts&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3745579">//&nbsp;won&#39;t&nbsp;hit&nbsp;this&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3745604">if</span>&nbsp;<span class="ident" id="3745607">p</span><span class="op" id="3745608">.</span><span class="ident" id="3745609">bytesRead</span>&nbsp;<span class="op" id="3745619">==</span>&nbsp;<span class="num" id="3745622">0</span>&nbsp;<span class="op" id="3745624">&amp;&amp;</span>&nbsp;<span class="ident" id="3745627">p</span><span class="op" id="3745628">.</span><span class="ident" id="3745629">mr</span><span class="op" id="3745631">.</span><span class="ident" id="3745632">peekBufferIsEmptyPart</span><span class="op" id="3745653">(</span><span class="ident" id="3745654">peek</span><span class="op" id="3745658">)</span>&nbsp;<span class="op" id="3745660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3745664">return</span>&nbsp;<span class="num" id="3745671">0</span><span class="op" id="3745672">,</span>&nbsp;<span class="ident" id="3745674">io</span><span class="op" id="3745676">.</span><span class="ident" id="3745677">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3745682">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3745685">unexpectedEOF</span>&nbsp;<span class="op" id="3745699">:=</span>&nbsp;<span class="ident" id="3745702">err</span>&nbsp;<span class="op" id="3745706">==</span>&nbsp;<span class="ident" id="3745709">io</span><span class="op" id="3745711">.</span><span class="ident" id="3745712">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3745717">if</span>&nbsp;<span class="ident" id="3745720">err</span>&nbsp;<span class="op" id="3745724">!=</span>&nbsp;<span class="ident" id="3745727">nil</span>&nbsp;<span class="op" id="3745731">&amp;&amp;</span>&nbsp;<span class="op" id="3745734">!</span><span class="ident" id="3745735">unexpectedEOF</span>&nbsp;<span class="op" id="3745749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3745753">return</span>&nbsp;<span class="num" id="3745760">0</span><span class="op" id="3745761">,</span>&nbsp;<span class="ident" id="3745763">fmt</span><span class="op" id="3745766">.</span><span class="ident" id="3745767">Errorf</span><span class="op" id="3745773">(</span><span class="string" id="3745774">&#34;multipart:&nbsp;Part&nbsp;Read:&nbsp;%v&#34;</span><span class="op" id="3745800">,</span>&nbsp;<span class="ident" id="3745802">err</span><span class="op" id="3745805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3745808">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3745811">if</span>&nbsp;<span class="ident" id="3745814">peek</span>&nbsp;<span class="op" id="3745819">==</span>&nbsp;<span class="ident" id="3745822">nil</span>&nbsp;<span class="op" id="3745826">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3745830">panic</span><span class="op" id="3745835">(</span><span class="string" id="3745836">&#34;nil&nbsp;peek&nbsp;buf&#34;</span><span class="op" id="3745850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3745853">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3745857">//&nbsp;Search&nbsp;the&nbsp;peek&nbsp;buffer&nbsp;for&nbsp;&#34;\r\n--boundary&#34;.&nbsp;If&nbsp;found,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3745916">//&nbsp;consume&nbsp;everything&nbsp;up&nbsp;to&nbsp;the&nbsp;boundary.&nbsp;If&nbsp;not,&nbsp;consume&nbsp;only</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3745980">//&nbsp;as&nbsp;much&nbsp;of&nbsp;the&nbsp;peek&nbsp;buffer&nbsp;as&nbsp;cannot&nbsp;hold&nbsp;the&nbsp;boundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3746039">//&nbsp;string.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3746051">nCopy</span>&nbsp;<span class="op" id="3746057">:=</span>&nbsp;<span class="num" id="3746060">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3746063">foundBoundary</span>&nbsp;<span class="op" id="3746077">:=</span>&nbsp;<span class="ident" id="3746080">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3746087">if</span>&nbsp;<span class="ident" id="3746090">idx</span>&nbsp;<span class="op" id="3746094">:=</span>&nbsp;<span class="ident" id="3746097">bytes</span><span class="op" id="3746102">.</span><span class="ident" id="3746103">Index</span><span class="op" id="3746108">(</span><span class="ident" id="3746109">peek</span><span class="op" id="3746113">,</span>&nbsp;<span class="ident" id="3746115">p</span><span class="op" id="3746116">.</span><span class="ident" id="3746117">mr</span><span class="op" id="3746119">.</span><span class="ident" id="3746120">nlDashBoundary</span><span class="op" id="3746134">)</span><span class="op" id="3746135">;</span>&nbsp;<span class="ident" id="3746137">idx</span>&nbsp;<span class="op" id="3746141">!=</span>&nbsp;<span class="op" id="3746144">-</span><span class="num" id="3746145">1</span>&nbsp;<span class="op" id="3746147">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3746151">nCopy</span>&nbsp;<span class="op" id="3746157">=</span>&nbsp;<span class="ident" id="3746159">idx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3746165">foundBoundary</span>&nbsp;<span class="op" id="3746179">=</span>&nbsp;<span class="ident" id="3746181">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3746187">}</span>&nbsp;<span class="keyword" id="3746189">else</span>&nbsp;<span class="keyword" id="3746194">if</span>&nbsp;<span class="ident" id="3746197">safeCount</span>&nbsp;<span class="op" id="3746207">:=</span>&nbsp;<span class="builtinfunc" id="3746210">len</span><span class="op" id="3746213">(</span><span class="ident" id="3746214">peek</span><span class="op" id="3746218">)</span>&nbsp;<span class="op" id="3746220">-</span>&nbsp;<span class="builtinfunc" id="3746222">len</span><span class="op" id="3746225">(</span><span class="ident" id="3746226">p</span><span class="op" id="3746227">.</span><span class="ident" id="3746228">mr</span><span class="op" id="3746230">.</span><span class="ident" id="3746231">nlDashBoundary</span><span class="op" id="3746245">)</span><span class="op" id="3746246">;</span>&nbsp;<span class="ident" id="3746248">safeCount</span>&nbsp;<span class="op" id="3746258">&gt;</span>&nbsp;<span class="num" id="3746260">0</span>&nbsp;<span class="op" id="3746262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3746266">nCopy</span>&nbsp;<span class="op" id="3746272">=</span>&nbsp;<span class="ident" id="3746274">safeCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3746285">}</span>&nbsp;<span class="keyword" id="3746287">else</span>&nbsp;<span class="keyword" id="3746292">if</span>&nbsp;<span class="ident" id="3746295">unexpectedEOF</span>&nbsp;<span class="op" id="3746309">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3746313">//&nbsp;If&nbsp;we&#39;ve&nbsp;run&nbsp;out&nbsp;of&nbsp;peek&nbsp;buffer&nbsp;and&nbsp;the&nbsp;boundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3746367">//&nbsp;wasn&#39;t&nbsp;found&nbsp;(and&nbsp;can&#39;t&nbsp;possibly&nbsp;fit),&nbsp;we&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3746424">//&nbsp;hit&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;file&nbsp;unexpectedly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3746467">return</span>&nbsp;<span class="num" id="3746474">0</span><span class="op" id="3746475">,</span>&nbsp;<span class="ident" id="3746477">io</span><span class="op" id="3746479">.</span><span class="ident" id="3746480">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3746498">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3746501">if</span>&nbsp;<span class="ident" id="3746504">nCopy</span>&nbsp;<span class="op" id="3746510">&gt;</span>&nbsp;<span class="num" id="3746512">0</span>&nbsp;<span class="op" id="3746514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3746518">if</span>&nbsp;<span class="ident" id="3746521">_</span><span class="op" id="3746522">,</span>&nbsp;<span class="ident" id="3746524">err</span>&nbsp;<span class="op" id="3746528">:=</span>&nbsp;<span class="ident" id="3746531">io</span><span class="op" id="3746533">.</span><span class="ident" id="3746534">CopyN</span><span class="op" id="3746539">(</span><span class="ident" id="3746540">p</span><span class="op" id="3746541">.</span><span class="ident" id="3746542">buffer</span><span class="op" id="3746548">,</span>&nbsp;<span class="ident" id="3746550">p</span><span class="op" id="3746551">.</span><span class="ident" id="3746552">mr</span><span class="op" id="3746554">.</span><span class="ident" id="3746555">bufReader</span><span class="op" id="3746564">,</span>&nbsp;<span class="ident" id="3746566">int64</span><span class="op" id="3746571">(</span><span class="ident" id="3746572">nCopy</span><span class="op" id="3746577">)</span><span class="op" id="3746578">)</span><span class="op" id="3746579">;</span>&nbsp;<span class="ident" id="3746581">err</span>&nbsp;<span class="op" id="3746585">!=</span>&nbsp;<span class="ident" id="3746588">nil</span>&nbsp;<span class="op" id="3746592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3746597">return</span>&nbsp;<span class="num" id="3746604">0</span><span class="op" id="3746605">,</span>&nbsp;<span class="ident" id="3746607">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3746613">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3746616">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3746619">n</span><span class="op" id="3746620">,</span>&nbsp;<span class="ident" id="3746622">err</span>&nbsp;<span class="op" id="3746626">=</span>&nbsp;<span class="ident" id="3746628">p</span><span class="op" id="3746629">.</span><span class="ident" id="3746630">buffer</span><span class="op" id="3746636">.</span><span class="ident" id="3746637">Read</span><span class="op" id="3746641">(</span><span class="ident" id="3746642">d</span><span class="op" id="3746643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3746646">if</span>&nbsp;<span class="ident" id="3746649">err</span>&nbsp;<span class="op" id="3746653">==</span>&nbsp;<span class="ident" id="3746656">io</span><span class="op" id="3746658">.</span><span class="ident" id="3746659">EOF</span>&nbsp;<span class="op" id="3746663">&amp;&amp;</span>&nbsp;<span class="op" id="3746666">!</span><span class="ident" id="3746667">foundBoundary</span>&nbsp;<span class="op" id="3746681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3746685">//&nbsp;If&nbsp;the&nbsp;boundary&nbsp;hasn&#39;t&nbsp;been&nbsp;reached&nbsp;there&#39;s&nbsp;more&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3746742">//&nbsp;read,&nbsp;so&nbsp;don&#39;t&nbsp;pass&nbsp;through&nbsp;an&nbsp;EOF&nbsp;from&nbsp;the&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3746798">err</span>&nbsp;<span class="op" id="3746802">=</span>&nbsp;<span class="ident" id="3746804">nil</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3746809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3746812">return</span><br>
<span class="lineno"></span><span class="op" id="3746819">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3746822">func</span>&nbsp;<span class="op" id="3746827">(</span><span class="ident" id="3746828">p</span>&nbsp;<span class="op" id="3746830">*</span><span class="ident" id="3746831">Part</span><span class="op" id="3746835">)</span>&nbsp;<span class="ident" id="3746837">Close</span><span class="op" id="3746842">(</span><span class="op" id="3746843">)</span>&nbsp;<span class="builtintype" id="3746845">error</span>&nbsp;<span class="op" id="3746851">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3746854">io</span><span class="op" id="3746856">.</span><span class="ident" id="3746857">Copy</span><span class="op" id="3746861">(</span><span class="ident" id="3746862">ioutil</span><span class="op" id="3746868">.</span><span class="ident" id="3746869">Discard</span><span class="op" id="3746876">,</span>&nbsp;<span class="ident" id="3746878">p</span><span class="op" id="3746879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3746882">return</span>&nbsp;<span class="ident" id="3746889">nil</span><br>
<span class="lineno"></span><span class="op" id="3746893">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3746896">//&nbsp;Reader&nbsp;is&nbsp;an&nbsp;iterator&nbsp;over&nbsp;parts&nbsp;in&nbsp;a&nbsp;MIME&nbsp;multipart&nbsp;body.</span><br>
<span class="lineno">205</span><span class="comment" id="3746958">//&nbsp;Reader&#39;s&nbsp;underlying&nbsp;parser&nbsp;consumes&nbsp;its&nbsp;input&nbsp;as&nbsp;needed.&nbsp;&nbsp;Seeking</span><br>
<span class="lineno"></span><span class="comment" id="3747027">//&nbsp;isn&#39;t&nbsp;supported.</span><br>
<span class="lineno"></span><span class="keyword" id="3747047">type</span>&nbsp;<span class="ident" id="3747052">Reader</span>&nbsp;<span class="keyword" id="3747059">struct</span>&nbsp;<span class="op" id="3747066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3747069">bufReader</span>&nbsp;<span class="op" id="3747079">*</span><span class="ident" id="3747080">bufio</span><span class="op" id="3747085">.</span><span class="ident" id="3747086">Reader</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3747095">currentPart</span>&nbsp;<span class="op" id="3747107">*</span><span class="ident" id="3747108">Part</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3747114">partsRead</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3747126">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3747132">nl</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3747149">[</span><span class="op" id="3747150">]</span><span class="builtintype" id="3747151">byte</span>&nbsp;<span class="comment" id="3747156">//&nbsp;&#34;\r\n&#34;&nbsp;or&nbsp;&#34;\n&#34;&nbsp;(set&nbsp;after&nbsp;seeing&nbsp;first&nbsp;boundary&nbsp;line)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3747214">nlDashBoundary</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3747231">[</span><span class="op" id="3747232">]</span><span class="builtintype" id="3747233">byte</span>&nbsp;<span class="comment" id="3747238">//&nbsp;nl&nbsp;+&nbsp;&#34;--boundary&#34;</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3747260">dashBoundaryDash</span>&nbsp;<span class="op" id="3747277">[</span><span class="op" id="3747278">]</span><span class="builtintype" id="3747279">byte</span>&nbsp;<span class="comment" id="3747284">//&nbsp;&#34;--boundary--&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3747303">dashBoundary</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3747320">[</span><span class="op" id="3747321">]</span><span class="builtintype" id="3747322">byte</span>&nbsp;<span class="comment" id="3747327">//&nbsp;&#34;--boundary&#34;</span><br>
<span class="lineno"></span><span class="op" id="3747343">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3747346">//&nbsp;NextPart&nbsp;returns&nbsp;the&nbsp;next&nbsp;part&nbsp;in&nbsp;the&nbsp;multipart&nbsp;or&nbsp;an&nbsp;error.</span><br>
<span class="lineno">220</span><span class="comment" id="3747410">//&nbsp;When&nbsp;there&nbsp;are&nbsp;no&nbsp;more&nbsp;parts,&nbsp;the&nbsp;error&nbsp;io.EOF&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="3747473">func</span>&nbsp;<span class="op" id="3747478">(</span><span class="ident" id="3747479">r</span>&nbsp;<span class="op" id="3747481">*</span><span class="ident" id="3747482">Reader</span><span class="op" id="3747488">)</span>&nbsp;<span class="ident" id="3747490">NextPart</span><span class="op" id="3747498">(</span><span class="op" id="3747499">)</span>&nbsp;<span class="op" id="3747501">(</span><span class="op" id="3747502">*</span><span class="ident" id="3747503">Part</span><span class="op" id="3747507">,</span>&nbsp;<span class="builtintype" id="3747509">error</span><span class="op" id="3747514">)</span>&nbsp;<span class="op" id="3747516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3747519">if</span>&nbsp;<span class="ident" id="3747522">r</span><span class="op" id="3747523">.</span><span class="ident" id="3747524">currentPart</span>&nbsp;<span class="op" id="3747536">!=</span>&nbsp;<span class="ident" id="3747539">nil</span>&nbsp;<span class="op" id="3747543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3747547">r</span><span class="op" id="3747548">.</span><span class="ident" id="3747549">currentPart</span><span class="op" id="3747560">.</span><span class="ident" id="3747561">Close</span><span class="op" id="3747566">(</span><span class="op" id="3747567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3747570">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3747574">expectNewPart</span>&nbsp;<span class="op" id="3747588">:=</span>&nbsp;<span class="ident" id="3747591">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3747598">for</span>&nbsp;<span class="op" id="3747602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3747606">line</span><span class="op" id="3747610">,</span>&nbsp;<span class="ident" id="3747612">err</span>&nbsp;<span class="op" id="3747616">:=</span>&nbsp;<span class="ident" id="3747619">r</span><span class="op" id="3747620">.</span><span class="ident" id="3747621">bufReader</span><span class="op" id="3747630">.</span><span class="ident" id="3747631">ReadSlice</span><span class="op" id="3747640">(</span><span class="string" id="3747641">&#39;\n&#39;</span><span class="op" id="3747645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3747649">if</span>&nbsp;<span class="ident" id="3747652">err</span>&nbsp;<span class="op" id="3747656">==</span>&nbsp;<span class="ident" id="3747659">io</span><span class="op" id="3747661">.</span><span class="ident" id="3747662">EOF</span>&nbsp;<span class="op" id="3747666">&amp;&amp;</span>&nbsp;<span class="ident" id="3747669">r</span><span class="op" id="3747670">.</span><span class="ident" id="3747671">isFinalBoundary</span><span class="op" id="3747686">(</span><span class="ident" id="3747687">line</span><span class="op" id="3747691">)</span>&nbsp;<span class="op" id="3747693">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3747698">//&nbsp;If&nbsp;the&nbsp;buffer&nbsp;ends&nbsp;in&nbsp;&#34;--boundary--&#34;&nbsp;without&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3747753">//&nbsp;trailing&nbsp;&#34;\r\n&#34;,&nbsp;ReadSlice&nbsp;will&nbsp;return&nbsp;an&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3747807">//&nbsp;(since&nbsp;it&#39;s&nbsp;missing&nbsp;the&nbsp;&#39;\n&#39;),&nbsp;but&nbsp;this&nbsp;is&nbsp;a&nbsp;valid</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3747864">//&nbsp;multipart&nbsp;EOF&nbsp;so&nbsp;we&nbsp;need&nbsp;to&nbsp;return&nbsp;io.EOF&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3747923">//&nbsp;a&nbsp;fmt-wrapped&nbsp;one.</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3747948">return</span>&nbsp;<span class="ident" id="3747955">nil</span><span class="op" id="3747958">,</span>&nbsp;<span class="ident" id="3747960">io</span><span class="op" id="3747962">.</span><span class="ident" id="3747963">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3747969">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3747973">if</span>&nbsp;<span class="ident" id="3747976">err</span>&nbsp;<span class="op" id="3747980">!=</span>&nbsp;<span class="ident" id="3747983">nil</span>&nbsp;<span class="op" id="3747987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3747992">return</span>&nbsp;<span class="ident" id="3747999">nil</span><span class="op" id="3748002">,</span>&nbsp;<span class="ident" id="3748004">fmt</span><span class="op" id="3748007">.</span><span class="ident" id="3748008">Errorf</span><span class="op" id="3748014">(</span><span class="string" id="3748015">&#34;multipart:&nbsp;NextPart:&nbsp;%v&#34;</span><span class="op" id="3748040">,</span>&nbsp;<span class="ident" id="3748042">err</span><span class="op" id="3748045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3748049">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3748054">if</span>&nbsp;<span class="ident" id="3748057">r</span><span class="op" id="3748058">.</span><span class="ident" id="3748059">isBoundaryDelimiterLine</span><span class="op" id="3748082">(</span><span class="ident" id="3748083">line</span><span class="op" id="3748087">)</span>&nbsp;<span class="op" id="3748089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3748094">r</span><span class="op" id="3748095">.</span><span class="ident" id="3748096">partsRead</span><span class="op" id="3748105">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3748111">bp</span><span class="op" id="3748113">,</span>&nbsp;<span class="ident" id="3748115">err</span>&nbsp;<span class="op" id="3748119">:=</span>&nbsp;<span class="ident" id="3748122">newPart</span><span class="op" id="3748129">(</span><span class="ident" id="3748130">r</span><span class="op" id="3748131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3748136">if</span>&nbsp;<span class="ident" id="3748139">err</span>&nbsp;<span class="op" id="3748143">!=</span>&nbsp;<span class="ident" id="3748146">nil</span>&nbsp;<span class="op" id="3748150">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3748156">return</span>&nbsp;<span class="ident" id="3748163">nil</span><span class="op" id="3748166">,</span>&nbsp;<span class="ident" id="3748168">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3748175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3748180">r</span><span class="op" id="3748181">.</span><span class="ident" id="3748182">currentPart</span>&nbsp;<span class="op" id="3748194">=</span>&nbsp;<span class="ident" id="3748196">bp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3748202">return</span>&nbsp;<span class="ident" id="3748209">bp</span><span class="op" id="3748211">,</span>&nbsp;<span class="ident" id="3748213">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3748219">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3748224">if</span>&nbsp;<span class="ident" id="3748227">r</span><span class="op" id="3748228">.</span><span class="ident" id="3748229">isFinalBoundary</span><span class="op" id="3748244">(</span><span class="ident" id="3748245">line</span><span class="op" id="3748249">)</span>&nbsp;<span class="op" id="3748251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3748256">//&nbsp;Expected&nbsp;EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3748275">return</span>&nbsp;<span class="ident" id="3748282">nil</span><span class="op" id="3748285">,</span>&nbsp;<span class="ident" id="3748287">io</span><span class="op" id="3748289">.</span><span class="ident" id="3748290">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3748296">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3748301">if</span>&nbsp;<span class="ident" id="3748304">expectNewPart</span>&nbsp;<span class="op" id="3748318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3748323">return</span>&nbsp;<span class="ident" id="3748330">nil</span><span class="op" id="3748333">,</span>&nbsp;<span class="ident" id="3748335">fmt</span><span class="op" id="3748338">.</span><span class="ident" id="3748339">Errorf</span><span class="op" id="3748345">(</span><span class="string" id="3748346">&#34;multipart:&nbsp;expecting&nbsp;a&nbsp;new&nbsp;Part;&nbsp;got&nbsp;line&nbsp;%q&#34;</span><span class="op" id="3748392">,</span>&nbsp;<span class="builtintype" id="3748394">string</span><span class="op" id="3748400">(</span><span class="ident" id="3748401">line</span><span class="op" id="3748405">)</span><span class="op" id="3748406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3748410">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3748415">if</span>&nbsp;<span class="ident" id="3748418">r</span><span class="op" id="3748419">.</span><span class="ident" id="3748420">partsRead</span>&nbsp;<span class="op" id="3748430">==</span>&nbsp;<span class="num" id="3748433">0</span>&nbsp;<span class="op" id="3748435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3748440">//&nbsp;skip&nbsp;line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3748456">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3748467">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3748472">//&nbsp;Consume&nbsp;the&nbsp;&#34;\n&#34;&nbsp;or&nbsp;&#34;\r\n&#34;&nbsp;separator&nbsp;between&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3748526">//&nbsp;body&nbsp;of&nbsp;the&nbsp;previous&nbsp;part&nbsp;and&nbsp;the&nbsp;boundary&nbsp;line&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3748582">//&nbsp;now&nbsp;expect&nbsp;will&nbsp;follow.&nbsp;(either&nbsp;a&nbsp;new&nbsp;part&nbsp;or&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3748637">//&nbsp;end&nbsp;boundary)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3748656">if</span>&nbsp;<span class="ident" id="3748659">bytes</span><span class="op" id="3748664">.</span><span class="ident" id="3748665">Equal</span><span class="op" id="3748670">(</span><span class="ident" id="3748671">line</span><span class="op" id="3748675">,</span>&nbsp;<span class="ident" id="3748677">r</span><span class="op" id="3748678">.</span><span class="ident" id="3748679">nl</span><span class="op" id="3748681">)</span>&nbsp;<span class="op" id="3748683">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3748688">expectNewPart</span>&nbsp;<span class="op" id="3748702">=</span>&nbsp;<span class="ident" id="3748704">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3748712">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3748723">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3748728">return</span>&nbsp;<span class="ident" id="3748735">nil</span><span class="op" id="3748738">,</span>&nbsp;<span class="ident" id="3748740">fmt</span><span class="op" id="3748743">.</span><span class="ident" id="3748744">Errorf</span><span class="op" id="3748750">(</span><span class="string" id="3748751">&#34;multipart:&nbsp;unexpected&nbsp;line&nbsp;in&nbsp;Next():&nbsp;%q&#34;</span><span class="op" id="3748793">,</span>&nbsp;<span class="ident" id="3748795">line</span><span class="op" id="3748799">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3748802">}</span><br>
<span class="lineno"></span><span class="op" id="3748804">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3748807">//&nbsp;isFinalBoundary&nbsp;reports&nbsp;whether&nbsp;line&nbsp;is&nbsp;the&nbsp;final&nbsp;boundary&nbsp;line</span><br>
<span class="lineno"></span><span class="comment" id="3748874">//&nbsp;indicating&nbsp;that&nbsp;all&nbsp;parts&nbsp;are&nbsp;over.</span><br>
<span class="lineno">280</span><span class="comment" id="3748913">//&nbsp;It&nbsp;matches&nbsp;`^--boundary--[&nbsp;\t]*(\r\n)?$`</span><br>
<span class="lineno"></span><span class="keyword" id="3748957">func</span>&nbsp;<span class="op" id="3748962">(</span><span class="ident" id="3748963">mr</span>&nbsp;<span class="op" id="3748966">*</span><span class="ident" id="3748967">Reader</span><span class="op" id="3748973">)</span>&nbsp;<span class="ident" id="3748975">isFinalBoundary</span><span class="op" id="3748990">(</span><span class="ident" id="3748991">line</span>&nbsp;<span class="op" id="3748996">[</span><span class="op" id="3748997">]</span><span class="builtintype" id="3748998">byte</span><span class="op" id="3749002">)</span>&nbsp;<span class="builtintype" id="3749004">bool</span>&nbsp;<span class="op" id="3749009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3749012">if</span>&nbsp;<span class="op" id="3749015">!</span><span class="ident" id="3749016">bytes</span><span class="op" id="3749021">.</span><span class="ident" id="3749022">HasPrefix</span><span class="op" id="3749031">(</span><span class="ident" id="3749032">line</span><span class="op" id="3749036">,</span>&nbsp;<span class="ident" id="3749038">mr</span><span class="op" id="3749040">.</span><span class="ident" id="3749041">dashBoundaryDash</span><span class="op" id="3749057">)</span>&nbsp;<span class="op" id="3749059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3749063">return</span>&nbsp;<span class="ident" id="3749070">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3749077">}</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3749080">rest</span>&nbsp;<span class="op" id="3749085">:=</span>&nbsp;<span class="ident" id="3749088">line</span><span class="op" id="3749092">[</span><span class="builtinfunc" id="3749093">len</span><span class="op" id="3749096">(</span><span class="ident" id="3749097">mr</span><span class="op" id="3749099">.</span><span class="ident" id="3749100">dashBoundaryDash</span><span class="op" id="3749116">)</span><span class="op" id="3749117">:</span><span class="op" id="3749118">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3749121">rest</span>&nbsp;<span class="op" id="3749126">=</span>&nbsp;<span class="ident" id="3749128">skipLWSPChar</span><span class="op" id="3749140">(</span><span class="ident" id="3749141">rest</span><span class="op" id="3749145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3749148">return</span>&nbsp;<span class="builtinfunc" id="3749155">len</span><span class="op" id="3749158">(</span><span class="ident" id="3749159">rest</span><span class="op" id="3749163">)</span>&nbsp;<span class="op" id="3749165">==</span>&nbsp;<span class="num" id="3749168">0</span>&nbsp;<span class="op" id="3749170">||</span>&nbsp;<span class="ident" id="3749173">bytes</span><span class="op" id="3749178">.</span><span class="ident" id="3749179">Equal</span><span class="op" id="3749184">(</span><span class="ident" id="3749185">rest</span><span class="op" id="3749189">,</span>&nbsp;<span class="ident" id="3749191">mr</span><span class="op" id="3749193">.</span><span class="ident" id="3749194">nl</span><span class="op" id="3749196">)</span><br>
<span class="lineno"></span><span class="op" id="3749198">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span><span class="keyword" id="3749201">func</span>&nbsp;<span class="op" id="3749206">(</span><span class="ident" id="3749207">mr</span>&nbsp;<span class="op" id="3749210">*</span><span class="ident" id="3749211">Reader</span><span class="op" id="3749217">)</span>&nbsp;<span class="ident" id="3749219">isBoundaryDelimiterLine</span><span class="op" id="3749242">(</span><span class="ident" id="3749243">line</span>&nbsp;<span class="op" id="3749248">[</span><span class="op" id="3749249">]</span><span class="builtintype" id="3749250">byte</span><span class="op" id="3749254">)</span>&nbsp;<span class="op" id="3749256">(</span><span class="ident" id="3749257">ret</span>&nbsp;<span class="builtintype" id="3749261">bool</span><span class="op" id="3749265">)</span>&nbsp;<span class="op" id="3749267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3749270">//&nbsp;http://tools.ietf.org/html/rfc2046#section-5.1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3749321">//&nbsp;&nbsp;&nbsp;The&nbsp;boundary&nbsp;delimiter&nbsp;line&nbsp;is&nbsp;then&nbsp;defined&nbsp;as&nbsp;a&nbsp;line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3749381">//&nbsp;&nbsp;&nbsp;consisting&nbsp;entirely&nbsp;of&nbsp;two&nbsp;hyphen&nbsp;characters&nbsp;(&#34;-&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3749438">//&nbsp;&nbsp;&nbsp;decimal&nbsp;value&nbsp;45)&nbsp;followed&nbsp;by&nbsp;the&nbsp;boundary&nbsp;parameter</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3749497">//&nbsp;&nbsp;&nbsp;value&nbsp;from&nbsp;the&nbsp;Content-Type&nbsp;header&nbsp;field,&nbsp;optional&nbsp;linear</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3749561">//&nbsp;&nbsp;&nbsp;whitespace,&nbsp;and&nbsp;a&nbsp;terminating&nbsp;CRLF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3749603">if</span>&nbsp;<span class="op" id="3749606">!</span><span class="ident" id="3749607">bytes</span><span class="op" id="3749612">.</span><span class="ident" id="3749613">HasPrefix</span><span class="op" id="3749622">(</span><span class="ident" id="3749623">line</span><span class="op" id="3749627">,</span>&nbsp;<span class="ident" id="3749629">mr</span><span class="op" id="3749631">.</span><span class="ident" id="3749632">dashBoundary</span><span class="op" id="3749644">)</span>&nbsp;<span class="op" id="3749646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3749650">return</span>&nbsp;<span class="ident" id="3749657">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3749664">}</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3749667">rest</span>&nbsp;<span class="op" id="3749672">:=</span>&nbsp;<span class="ident" id="3749675">line</span><span class="op" id="3749679">[</span><span class="builtinfunc" id="3749680">len</span><span class="op" id="3749683">(</span><span class="ident" id="3749684">mr</span><span class="op" id="3749686">.</span><span class="ident" id="3749687">dashBoundary</span><span class="op" id="3749699">)</span><span class="op" id="3749700">:</span><span class="op" id="3749701">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3749704">rest</span>&nbsp;<span class="op" id="3749709">=</span>&nbsp;<span class="ident" id="3749711">skipLWSPChar</span><span class="op" id="3749723">(</span><span class="ident" id="3749724">rest</span><span class="op" id="3749728">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3749732">//&nbsp;On&nbsp;the&nbsp;first&nbsp;part,&nbsp;see&nbsp;our&nbsp;lines&nbsp;are&nbsp;ending&nbsp;in&nbsp;\n&nbsp;instead&nbsp;of&nbsp;\r\n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3749802">//&nbsp;and&nbsp;switch&nbsp;into&nbsp;that&nbsp;mode&nbsp;if&nbsp;so.&nbsp;&nbsp;This&nbsp;is&nbsp;a&nbsp;violation&nbsp;of&nbsp;the&nbsp;spec,</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3749873">//&nbsp;but&nbsp;occurs&nbsp;in&nbsp;practice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3749901">if</span>&nbsp;<span class="ident" id="3749904">mr</span><span class="op" id="3749906">.</span><span class="ident" id="3749907">partsRead</span>&nbsp;<span class="op" id="3749917">==</span>&nbsp;<span class="num" id="3749920">0</span>&nbsp;<span class="op" id="3749922">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3749925">len</span><span class="op" id="3749928">(</span><span class="ident" id="3749929">rest</span><span class="op" id="3749933">)</span>&nbsp;<span class="op" id="3749935">==</span>&nbsp;<span class="num" id="3749938">1</span>&nbsp;<span class="op" id="3749940">&amp;&amp;</span>&nbsp;<span class="ident" id="3749943">rest</span><span class="op" id="3749947">[</span><span class="num" id="3749948">0</span><span class="op" id="3749949">]</span>&nbsp;<span class="op" id="3749951">==</span>&nbsp;<span class="string" id="3749954">&#39;\n&#39;</span>&nbsp;<span class="op" id="3749959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3749963">mr</span><span class="op" id="3749965">.</span><span class="ident" id="3749966">nl</span>&nbsp;<span class="op" id="3749969">=</span>&nbsp;<span class="ident" id="3749971">mr</span><span class="op" id="3749973">.</span><span class="ident" id="3749974">nl</span><span class="op" id="3749976">[</span><span class="num" id="3749977">1</span><span class="op" id="3749978">:</span><span class="op" id="3749979">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3749983">mr</span><span class="op" id="3749985">.</span><span class="ident" id="3749986">nlDashBoundary</span>&nbsp;<span class="op" id="3750001">=</span>&nbsp;<span class="ident" id="3750003">mr</span><span class="op" id="3750005">.</span><span class="ident" id="3750006">nlDashBoundary</span><span class="op" id="3750020">[</span><span class="num" id="3750021">1</span><span class="op" id="3750022">:</span><span class="op" id="3750023">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3750026">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3750029">return</span>&nbsp;<span class="ident" id="3750036">bytes</span><span class="op" id="3750041">.</span><span class="ident" id="3750042">Equal</span><span class="op" id="3750047">(</span><span class="ident" id="3750048">rest</span><span class="op" id="3750052">,</span>&nbsp;<span class="ident" id="3750054">mr</span><span class="op" id="3750056">.</span><span class="ident" id="3750057">nl</span><span class="op" id="3750059">)</span><br>
<span class="lineno"></span><span class="op" id="3750061">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3750064">//&nbsp;peekBufferIsEmptyPart&nbsp;reports&nbsp;whether&nbsp;the&nbsp;provided&nbsp;peek-ahead</span><br>
<span class="lineno"></span><span class="comment" id="3750129">//&nbsp;buffer&nbsp;represents&nbsp;an&nbsp;empty&nbsp;part.&nbsp;It&nbsp;is&nbsp;called&nbsp;only&nbsp;if&nbsp;we&#39;ve&nbsp;not</span><br>
<span class="lineno">315</span><span class="comment" id="3750196">//&nbsp;already&nbsp;read&nbsp;any&nbsp;bytes&nbsp;in&nbsp;this&nbsp;part&nbsp;and&nbsp;checks&nbsp;for&nbsp;the&nbsp;case&nbsp;of&nbsp;MIME</span><br>
<span class="lineno"></span><span class="comment" id="3750267">//&nbsp;software&nbsp;not&nbsp;writing&nbsp;the&nbsp;\r\n&nbsp;on&nbsp;empty&nbsp;parts.&nbsp;Some&nbsp;does,&nbsp;some</span><br>
<span class="lineno"></span><span class="comment" id="3750332">//&nbsp;doesn&#39;t.</span><br>
<span class="lineno"></span><span class="comment" id="3750344">//</span><br>
<span class="lineno"></span><span class="comment" id="3750347">//&nbsp;This&nbsp;checks&nbsp;that&nbsp;what&nbsp;follows&nbsp;the&nbsp;&#34;--boundary&#34;&nbsp;is&nbsp;actually&nbsp;the&nbsp;end</span><br>
<span class="lineno">320</span><span class="comment" id="3750417">//&nbsp;(&#34;--boundary--&#34;&nbsp;with&nbsp;optional&nbsp;whitespace)&nbsp;or&nbsp;optional&nbsp;whitespace</span><br>
<span class="lineno"></span><span class="comment" id="3750485">//&nbsp;and&nbsp;then&nbsp;a&nbsp;newline,&nbsp;so&nbsp;we&nbsp;don&#39;t&nbsp;catch&nbsp;&#34;--boundaryFAKE&#34;,&nbsp;in&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="3750553">//&nbsp;case&nbsp;the&nbsp;whole&nbsp;line&nbsp;is&nbsp;part&nbsp;of&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="3750597">func</span>&nbsp;<span class="op" id="3750602">(</span><span class="ident" id="3750603">mr</span>&nbsp;<span class="op" id="3750606">*</span><span class="ident" id="3750607">Reader</span><span class="op" id="3750613">)</span>&nbsp;<span class="ident" id="3750615">peekBufferIsEmptyPart</span><span class="op" id="3750636">(</span><span class="ident" id="3750637">peek</span>&nbsp;<span class="op" id="3750642">[</span><span class="op" id="3750643">]</span><span class="builtintype" id="3750644">byte</span><span class="op" id="3750648">)</span>&nbsp;<span class="builtintype" id="3750650">bool</span>&nbsp;<span class="op" id="3750655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3750658">//&nbsp;End&nbsp;of&nbsp;parts&nbsp;case.</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3750681">//&nbsp;Test&nbsp;whether&nbsp;peek&nbsp;matches&nbsp;`^--boundary--[&nbsp;\t]*(?:\r\n|$)`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3750743">if</span>&nbsp;<span class="ident" id="3750746">bytes</span><span class="op" id="3750751">.</span><span class="ident" id="3750752">HasPrefix</span><span class="op" id="3750761">(</span><span class="ident" id="3750762">peek</span><span class="op" id="3750766">,</span>&nbsp;<span class="ident" id="3750768">mr</span><span class="op" id="3750770">.</span><span class="ident" id="3750771">dashBoundaryDash</span><span class="op" id="3750787">)</span>&nbsp;<span class="op" id="3750789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3750793">rest</span>&nbsp;<span class="op" id="3750798">:=</span>&nbsp;<span class="ident" id="3750801">peek</span><span class="op" id="3750805">[</span><span class="builtinfunc" id="3750806">len</span><span class="op" id="3750809">(</span><span class="ident" id="3750810">mr</span><span class="op" id="3750812">.</span><span class="ident" id="3750813">dashBoundaryDash</span><span class="op" id="3750829">)</span><span class="op" id="3750830">:</span><span class="op" id="3750831">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3750835">rest</span>&nbsp;<span class="op" id="3750840">=</span>&nbsp;<span class="ident" id="3750842">skipLWSPChar</span><span class="op" id="3750854">(</span><span class="ident" id="3750855">rest</span><span class="op" id="3750859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3750863">return</span>&nbsp;<span class="ident" id="3750870">bytes</span><span class="op" id="3750875">.</span><span class="ident" id="3750876">HasPrefix</span><span class="op" id="3750885">(</span><span class="ident" id="3750886">rest</span><span class="op" id="3750890">,</span>&nbsp;<span class="ident" id="3750892">mr</span><span class="op" id="3750894">.</span><span class="ident" id="3750895">nl</span><span class="op" id="3750897">)</span>&nbsp;<span class="op" id="3750899">||</span>&nbsp;<span class="builtinfunc" id="3750902">len</span><span class="op" id="3750905">(</span><span class="ident" id="3750906">rest</span><span class="op" id="3750910">)</span>&nbsp;<span class="op" id="3750912">==</span>&nbsp;<span class="num" id="3750915">0</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3750918">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3750921">if</span>&nbsp;<span class="op" id="3750924">!</span><span class="ident" id="3750925">bytes</span><span class="op" id="3750930">.</span><span class="ident" id="3750931">HasPrefix</span><span class="op" id="3750940">(</span><span class="ident" id="3750941">peek</span><span class="op" id="3750945">,</span>&nbsp;<span class="ident" id="3750947">mr</span><span class="op" id="3750949">.</span><span class="ident" id="3750950">dashBoundary</span><span class="op" id="3750962">)</span>&nbsp;<span class="op" id="3750964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3750968">return</span>&nbsp;<span class="ident" id="3750975">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3750982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3750985">//&nbsp;Test&nbsp;whether&nbsp;rest&nbsp;matches&nbsp;`^[&nbsp;\t]*\r\n`)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3751030">rest</span>&nbsp;<span class="op" id="3751035">:=</span>&nbsp;<span class="ident" id="3751038">peek</span><span class="op" id="3751042">[</span><span class="builtinfunc" id="3751043">len</span><span class="op" id="3751046">(</span><span class="ident" id="3751047">mr</span><span class="op" id="3751049">.</span><span class="ident" id="3751050">dashBoundary</span><span class="op" id="3751062">)</span><span class="op" id="3751063">:</span><span class="op" id="3751064">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3751067">rest</span>&nbsp;<span class="op" id="3751072">=</span>&nbsp;<span class="ident" id="3751074">skipLWSPChar</span><span class="op" id="3751086">(</span><span class="ident" id="3751087">rest</span><span class="op" id="3751091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3751094">return</span>&nbsp;<span class="ident" id="3751101">bytes</span><span class="op" id="3751106">.</span><span class="ident" id="3751107">HasPrefix</span><span class="op" id="3751116">(</span><span class="ident" id="3751117">rest</span><span class="op" id="3751121">,</span>&nbsp;<span class="ident" id="3751123">mr</span><span class="op" id="3751125">.</span><span class="ident" id="3751126">nl</span><span class="op" id="3751128">)</span><br>
<span class="lineno"></span><span class="op" id="3751130">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span><span class="comment" id="3751133">//&nbsp;skipLWSPChar&nbsp;returns&nbsp;b&nbsp;with&nbsp;leading&nbsp;spaces&nbsp;and&nbsp;tabs&nbsp;removed.</span><br>
<span class="lineno"></span><span class="comment" id="3751197">//&nbsp;RFC&nbsp;822&nbsp;defines:</span><br>
<span class="lineno"></span><span class="comment" id="3751217">//&nbsp;&nbsp;&nbsp;&nbsp;LWSP-char&nbsp;=&nbsp;SPACE&nbsp;/&nbsp;HTAB</span><br>
<span class="lineno"></span><span class="keyword" id="3751248">func</span>&nbsp;<span class="ident" id="3751253">skipLWSPChar</span><span class="op" id="3751265">(</span><span class="ident" id="3751266">b</span>&nbsp;<span class="op" id="3751268">[</span><span class="op" id="3751269">]</span><span class="builtintype" id="3751270">byte</span><span class="op" id="3751274">)</span>&nbsp;<span class="op" id="3751276">[</span><span class="op" id="3751277">]</span><span class="builtintype" id="3751278">byte</span>&nbsp;<span class="op" id="3751283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3751286">for</span>&nbsp;<span class="builtinfunc" id="3751290">len</span><span class="op" id="3751293">(</span><span class="ident" id="3751294">b</span><span class="op" id="3751295">)</span>&nbsp;<span class="op" id="3751297">&gt;</span>&nbsp;<span class="num" id="3751299">0</span>&nbsp;<span class="op" id="3751301">&amp;&amp;</span>&nbsp;<span class="op" id="3751304">(</span><span class="ident" id="3751305">b</span><span class="op" id="3751306">[</span><span class="num" id="3751307">0</span><span class="op" id="3751308">]</span>&nbsp;<span class="op" id="3751310">==</span>&nbsp;<span class="string" id="3751313">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="3751317">||</span>&nbsp;<span class="ident" id="3751320">b</span><span class="op" id="3751321">[</span><span class="num" id="3751322">0</span><span class="op" id="3751323">]</span>&nbsp;<span class="op" id="3751325">==</span>&nbsp;<span class="string" id="3751328">&#39;\t&#39;</span><span class="op" id="3751332">)</span>&nbsp;<span class="op" id="3751334">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3751338">b</span>&nbsp;<span class="op" id="3751340">=</span>&nbsp;<span class="ident" id="3751342">b</span><span class="op" id="3751343">[</span><span class="num" id="3751344">1</span><span class="op" id="3751345">:</span><span class="op" id="3751346">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3751349">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3751352">return</span>&nbsp;<span class="ident" id="3751359">b</span><br>
<span class="lineno"></span><span class="op" id="3751361">}</span>
</div>
</body>
</html>
