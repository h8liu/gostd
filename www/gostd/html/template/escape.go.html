<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>html/template</h2>
<ul>
<li><a href="/gostd/html/template/attr.go.html">attr.go</a></li>
<li><a href="/gostd/html/template/clone_test.go.html">clone_test.go</a></li>
<li><a href="/gostd/html/template/content.go.html">content.go</a></li>
<li><a href="/gostd/html/template/content_test.go.html">content_test.go</a></li>
<li><a href="/gostd/html/template/context.go.html">context.go</a></li>
<li><a href="/gostd/html/template/css.go.html">css.go</a></li>
<li><a href="/gostd/html/template/css_test.go.html">css_test.go</a></li>
<li><a href="/gostd/html/template/doc.go.html">doc.go</a></li>
<li><a href="/gostd/html/template/error.go.html">error.go</a></li>
<li><a href="/gostd/html/template/escape.go.html">escape.go</a></li>
<li><a href="/gostd/html/template/escape_test.go.html">escape_test.go</a></li>
<li><a href="/gostd/html/template/html.go.html">html.go</a></li>
<li><a href="/gostd/html/template/html_test.go.html">html_test.go</a></li>
<li><a href="/gostd/html/template/js.go.html">js.go</a></li>
<li><a href="/gostd/html/template/js_test.go.html">js_test.go</a></li>
<li><a href="/gostd/html/template/template.go.html">template.go</a></li>
<li><a href="/gostd/html/template/transition.go.html">transition.go</a></li>
<li><a href="/gostd/html/template/url.go.html">url.go</a></li>
<li><a href="/gostd/html/template/url_test.go.html">url_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2830163">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2830218">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2830272">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="2830323">package</span>&nbsp;<span class="ident" id="2830331">template</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2830341">import</span>&nbsp;<span class="op" id="2830348">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2830351">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2830360">&#34;fmt&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2830367">&#34;html&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2830375">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2830381">&#34;text/template&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2830398">&#34;text/template/parse&#34;</span><br>
<span class="lineno"></span><span class="op" id="2830420">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="2830423">//&nbsp;escapeTemplate&nbsp;rewrites&nbsp;the&nbsp;named&nbsp;template,&nbsp;which&nbsp;must&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="2830484">//&nbsp;associated&nbsp;with&nbsp;t,&nbsp;to&nbsp;guarantee&nbsp;that&nbsp;the&nbsp;output&nbsp;of&nbsp;any&nbsp;of&nbsp;the&nbsp;named</span><br>
<span class="lineno"></span><span class="comment" id="2830555">//&nbsp;templates&nbsp;is&nbsp;properly&nbsp;escaped.&nbsp;&nbsp;If&nbsp;no&nbsp;error&nbsp;is&nbsp;returned,&nbsp;then&nbsp;the&nbsp;named&nbsp;templates&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="2830645">//&nbsp;been&nbsp;modified.&nbsp;&nbsp;Otherwise&nbsp;the&nbsp;named&nbsp;templates&nbsp;have&nbsp;been&nbsp;rendered</span><br>
<span class="lineno">20</span><span class="comment" id="2830713">//&nbsp;unusable.</span><br>
<span class="lineno"></span><span class="keyword" id="2830726">func</span>&nbsp;<span class="ident" id="2830731">escapeTemplate</span><span class="op" id="2830745">(</span><span class="ident" id="2830746">tmpl</span>&nbsp;<span class="op" id="2830751">*</span><span class="ident" id="2830752">Template</span><span class="op" id="2830760">,</span>&nbsp;<span class="ident" id="2830762">node</span>&nbsp;<span class="ident" id="2830767">parse</span><span class="op" id="2830772">.</span><span class="ident" id="2830773">Node</span><span class="op" id="2830777">,</span>&nbsp;<span class="ident" id="2830779">name</span>&nbsp;<span class="builtintype" id="2830784">string</span><span class="op" id="2830790">)</span>&nbsp;<span class="builtintype" id="2830792">error</span>&nbsp;<span class="op" id="2830798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2830801">e</span>&nbsp;<span class="op" id="2830803">:=</span>&nbsp;<span class="ident" id="2830806">newEscaper</span><span class="op" id="2830816">(</span><span class="ident" id="2830817">tmpl</span><span class="op" id="2830821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2830824">c</span><span class="op" id="2830825">,</span>&nbsp;<span class="ident" id="2830827">_</span>&nbsp;<span class="op" id="2830829">:=</span>&nbsp;<span class="ident" id="2830832">e</span><span class="op" id="2830833">.</span><span class="ident" id="2830834">escapeTree</span><span class="op" id="2830844">(</span><span class="ident" id="2830845">context</span><span class="op" id="2830852">{</span><span class="op" id="2830853">}</span><span class="op" id="2830854">,</span>&nbsp;<span class="ident" id="2830856">node</span><span class="op" id="2830860">,</span>&nbsp;<span class="ident" id="2830862">name</span><span class="op" id="2830866">,</span>&nbsp;<span class="num" id="2830868">0</span><span class="op" id="2830869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2830872">var</span>&nbsp;<span class="ident" id="2830876">err</span>&nbsp;<span class="builtintype" id="2830880">error</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2830887">if</span>&nbsp;<span class="ident" id="2830890">c</span><span class="op" id="2830891">.</span><span class="ident" id="2830892">err</span>&nbsp;<span class="op" id="2830896">!=</span>&nbsp;<span class="ident" id="2830899">nil</span>&nbsp;<span class="op" id="2830903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2830907">err</span><span class="op" id="2830910">,</span>&nbsp;<span class="ident" id="2830912">c</span><span class="op" id="2830913">.</span><span class="ident" id="2830914">err</span><span class="op" id="2830917">.</span><span class="ident" id="2830918">Name</span>&nbsp;<span class="op" id="2830923">=</span>&nbsp;<span class="ident" id="2830925">c</span><span class="op" id="2830926">.</span><span class="ident" id="2830927">err</span><span class="op" id="2830930">,</span>&nbsp;<span class="ident" id="2830932">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2830938">}</span>&nbsp;<span class="keyword" id="2830940">else</span>&nbsp;<span class="keyword" id="2830945">if</span>&nbsp;<span class="ident" id="2830948">c</span><span class="op" id="2830949">.</span><span class="ident" id="2830950">state</span>&nbsp;<span class="op" id="2830956">!=</span>&nbsp;<span class="ident" id="2830959">stateText</span>&nbsp;<span class="op" id="2830969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2830973">err</span>&nbsp;<span class="op" id="2830977">=</span>&nbsp;<span class="op" id="2830979">&amp;</span><span class="ident" id="2830980">Error</span><span class="op" id="2830985">{</span><span class="ident" id="2830986">ErrEndContext</span><span class="op" id="2830999">,</span>&nbsp;<span class="ident" id="2831001">nil</span><span class="op" id="2831004">,</span>&nbsp;<span class="ident" id="2831006">name</span><span class="op" id="2831010">,</span>&nbsp;<span class="num" id="2831012">0</span><span class="op" id="2831013">,</span>&nbsp;<span class="ident" id="2831015">fmt</span><span class="op" id="2831018">.</span><span class="ident" id="2831019">Sprintf</span><span class="op" id="2831026">(</span><span class="string" id="2831027">&#34;ends&nbsp;in&nbsp;a&nbsp;non-text&nbsp;context:&nbsp;%v&#34;</span><span class="op" id="2831059">,</span>&nbsp;<span class="ident" id="2831061">c</span><span class="op" id="2831062">)</span><span class="op" id="2831063">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2831066">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2831069">if</span>&nbsp;<span class="ident" id="2831072">err</span>&nbsp;<span class="op" id="2831076">!=</span>&nbsp;<span class="ident" id="2831079">nil</span>&nbsp;<span class="op" id="2831083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2831087">//&nbsp;Prevent&nbsp;execution&nbsp;of&nbsp;unsafe&nbsp;templates.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2831131">if</span>&nbsp;<span class="ident" id="2831134">t</span>&nbsp;<span class="op" id="2831136">:=</span>&nbsp;<span class="ident" id="2831139">tmpl</span><span class="op" id="2831143">.</span><span class="ident" id="2831144">set</span><span class="op" id="2831147">[</span><span class="ident" id="2831148">name</span><span class="op" id="2831152">]</span><span class="op" id="2831153">;</span>&nbsp;<span class="ident" id="2831155">t</span>&nbsp;<span class="op" id="2831157">!=</span>&nbsp;<span class="ident" id="2831160">nil</span>&nbsp;<span class="op" id="2831164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2831169">t</span><span class="op" id="2831170">.</span><span class="ident" id="2831171">escapeErr</span>&nbsp;<span class="op" id="2831181">=</span>&nbsp;<span class="ident" id="2831183">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2831190">t</span><span class="op" id="2831191">.</span><span class="ident" id="2831192">text</span><span class="op" id="2831196">.</span><span class="ident" id="2831197">Tree</span>&nbsp;<span class="op" id="2831202">=</span>&nbsp;<span class="ident" id="2831204">nil</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2831211">t</span><span class="op" id="2831212">.</span><span class="ident" id="2831213">Tree</span>&nbsp;<span class="op" id="2831218">=</span>&nbsp;<span class="ident" id="2831220">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2831226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2831230">return</span>&nbsp;<span class="ident" id="2831237">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2831242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2831245">e</span><span class="op" id="2831246">.</span><span class="ident" id="2831247">commit</span><span class="op" id="2831253">(</span><span class="op" id="2831254">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2831257">if</span>&nbsp;<span class="ident" id="2831260">t</span>&nbsp;<span class="op" id="2831262">:=</span>&nbsp;<span class="ident" id="2831265">tmpl</span><span class="op" id="2831269">.</span><span class="ident" id="2831270">set</span><span class="op" id="2831273">[</span><span class="ident" id="2831274">name</span><span class="op" id="2831278">]</span><span class="op" id="2831279">;</span>&nbsp;<span class="ident" id="2831281">t</span>&nbsp;<span class="op" id="2831283">!=</span>&nbsp;<span class="ident" id="2831286">nil</span>&nbsp;<span class="op" id="2831290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2831294">t</span><span class="op" id="2831295">.</span><span class="ident" id="2831296">escapeErr</span>&nbsp;<span class="op" id="2831306">=</span>&nbsp;<span class="ident" id="2831308">escapeOK</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2831319">t</span><span class="op" id="2831320">.</span><span class="ident" id="2831321">Tree</span>&nbsp;<span class="op" id="2831326">=</span>&nbsp;<span class="ident" id="2831328">t</span><span class="op" id="2831329">.</span><span class="ident" id="2831330">text</span><span class="op" id="2831334">.</span><span class="ident" id="2831335">Tree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2831341">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2831344">return</span>&nbsp;<span class="ident" id="2831351">nil</span><br>
<span class="lineno">45</span><span class="op" id="2831355">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2831358">//&nbsp;funcMap&nbsp;maps&nbsp;command&nbsp;names&nbsp;to&nbsp;functions&nbsp;that&nbsp;render&nbsp;their&nbsp;inputs&nbsp;safe.</span><br>
<span class="lineno"></span><span class="keyword" id="2831432">var</span>&nbsp;<span class="ident" id="2831436">funcMap</span>&nbsp;<span class="op" id="2831444">=</span>&nbsp;<span class="ident" id="2831446">template</span><span class="op" id="2831454">.</span><span class="ident" id="2831455">FuncMap</span><span class="op" id="2831462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2831465">&#34;html_template_attrescaper&#34;</span><span class="op" id="2831492">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2831498">attrEscaper</span><span class="op" id="2831509">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2831512">&#34;html_template_commentescaper&#34;</span><span class="op" id="2831542">:</span>&nbsp;&nbsp;<span class="ident" id="2831545">commentEscaper</span><span class="op" id="2831559">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2831562">&#34;html_template_cssescaper&#34;</span><span class="op" id="2831588">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2831595">cssEscaper</span><span class="op" id="2831605">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2831608">&#34;html_template_cssvaluefilter&#34;</span><span class="op" id="2831638">:</span>&nbsp;&nbsp;<span class="ident" id="2831641">cssValueFilter</span><span class="op" id="2831655">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2831658">&#34;html_template_htmlnamefilter&#34;</span><span class="op" id="2831688">:</span>&nbsp;&nbsp;<span class="ident" id="2831691">htmlNameFilter</span><span class="op" id="2831705">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2831708">&#34;html_template_htmlescaper&#34;</span><span class="op" id="2831735">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2831741">htmlEscaper</span><span class="op" id="2831752">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2831755">&#34;html_template_jsregexpescaper&#34;</span><span class="op" id="2831786">:</span>&nbsp;<span class="ident" id="2831788">jsRegexpEscaper</span><span class="op" id="2831803">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2831806">&#34;html_template_jsstrescaper&#34;</span><span class="op" id="2831834">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2831839">jsStrEscaper</span><span class="op" id="2831851">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2831854">&#34;html_template_jsvalescaper&#34;</span><span class="op" id="2831882">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2831887">jsValEscaper</span><span class="op" id="2831899">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2831902">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="2831932">:</span>&nbsp;&nbsp;<span class="ident" id="2831935">htmlNospaceEscaper</span><span class="op" id="2831953">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2831956">&#34;html_template_rcdataescaper&#34;</span><span class="op" id="2831985">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2831989">rcdataEscaper</span><span class="op" id="2832002">,</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2832005">&#34;html_template_urlescaper&#34;</span><span class="op" id="2832031">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2832038">urlEscaper</span><span class="op" id="2832048">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2832051">&#34;html_template_urlfilter&#34;</span><span class="op" id="2832076">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2832084">urlFilter</span><span class="op" id="2832093">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2832096">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="2832125">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2832129">urlNormalizer</span><span class="op" id="2832142">,</span><br>
<span class="lineno"></span><span class="op" id="2832144">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="2832147">//&nbsp;equivEscapers&nbsp;matches&nbsp;contextual&nbsp;escapers&nbsp;to&nbsp;equivalent&nbsp;template&nbsp;builtins.</span><br>
<span class="lineno"></span><span class="keyword" id="2832225">var</span>&nbsp;<span class="ident" id="2832229">equivEscapers</span>&nbsp;<span class="op" id="2832243">=</span>&nbsp;<span class="keyword" id="2832245">map</span><span class="op" id="2832248">[</span><span class="builtintype" id="2832249">string</span><span class="op" id="2832255">]</span><span class="builtintype" id="2832256">string</span><span class="op" id="2832262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2832265">&#34;html_template_attrescaper&#34;</span><span class="op" id="2832292">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2832297">&#34;html&#34;</span><span class="op" id="2832303">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2832306">&#34;html_template_htmlescaper&#34;</span><span class="op" id="2832333">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2832338">&#34;html&#34;</span><span class="op" id="2832344">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2832347">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="2832377">:</span>&nbsp;<span class="string" id="2832379">&#34;html&#34;</span><span class="op" id="2832385">,</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2832388">&#34;html_template_rcdataescaper&#34;</span><span class="op" id="2832417">:</span>&nbsp;&nbsp;<span class="string" id="2832420">&#34;html&#34;</span><span class="op" id="2832426">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2832429">&#34;html_template_urlescaper&#34;</span><span class="op" id="2832455">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2832461">&#34;urlquery&#34;</span><span class="op" id="2832471">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2832474">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="2832503">:</span>&nbsp;&nbsp;<span class="string" id="2832506">&#34;urlquery&#34;</span><span class="op" id="2832516">,</span><br>
<span class="lineno"></span><span class="op" id="2832518">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="comment" id="2832521">//&nbsp;escaper&nbsp;collects&nbsp;type&nbsp;inferences&nbsp;about&nbsp;templates&nbsp;and&nbsp;changes&nbsp;needed&nbsp;to&nbsp;make</span><br>
<span class="lineno"></span><span class="comment" id="2832600">//&nbsp;templates&nbsp;injection&nbsp;safe.</span><br>
<span class="lineno"></span><span class="keyword" id="2832629">type</span>&nbsp;<span class="ident" id="2832634">escaper</span>&nbsp;<span class="keyword" id="2832642">struct</span>&nbsp;<span class="op" id="2832649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2832652">tmpl</span>&nbsp;<span class="op" id="2832657">*</span><span class="ident" id="2832658">Template</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2832668">//&nbsp;output[templateName]&nbsp;is&nbsp;the&nbsp;output&nbsp;context&nbsp;for&nbsp;a&nbsp;templateName&nbsp;that</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2832739">//&nbsp;has&nbsp;been&nbsp;mangled&nbsp;to&nbsp;include&nbsp;its&nbsp;input&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2832790">output</span>&nbsp;<span class="keyword" id="2832797">map</span><span class="op" id="2832800">[</span><span class="builtintype" id="2832801">string</span><span class="op" id="2832807">]</span><span class="ident" id="2832808">context</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2832817">//&nbsp;derived[c.mangle(name)]&nbsp;maps&nbsp;to&nbsp;a&nbsp;template&nbsp;derived&nbsp;from&nbsp;the&nbsp;template</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2832890">//&nbsp;named&nbsp;name&nbsp;templateName&nbsp;for&nbsp;the&nbsp;start&nbsp;context&nbsp;c.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2832943">derived</span>&nbsp;<span class="keyword" id="2832951">map</span><span class="op" id="2832954">[</span><span class="builtintype" id="2832955">string</span><span class="op" id="2832961">]</span><span class="op" id="2832962">*</span><span class="ident" id="2832963">template</span><span class="op" id="2832971">.</span><span class="ident" id="2832972">Template</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2832982">//&nbsp;called[templateName]&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;called&nbsp;mangled&nbsp;template&nbsp;names.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2833050">called</span>&nbsp;<span class="keyword" id="2833057">map</span><span class="op" id="2833060">[</span><span class="builtintype" id="2833061">string</span><span class="op" id="2833067">]</span><span class="builtintype" id="2833068">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2833074">//&nbsp;xxxNodeEdits&nbsp;are&nbsp;the&nbsp;accumulated&nbsp;edits&nbsp;to&nbsp;apply&nbsp;during&nbsp;commit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2833141">//&nbsp;Such&nbsp;edits&nbsp;are&nbsp;not&nbsp;applied&nbsp;immediately&nbsp;in&nbsp;case&nbsp;a&nbsp;template&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2833207">//&nbsp;executes&nbsp;a&nbsp;given&nbsp;template&nbsp;in&nbsp;different&nbsp;escaping&nbsp;contexts.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2833269">actionNodeEdits</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="2833287">map</span><span class="op" id="2833290">[</span><span class="op" id="2833291">*</span><span class="ident" id="2833292">parse</span><span class="op" id="2833297">.</span><span class="ident" id="2833298">ActionNode</span><span class="op" id="2833308">]</span><span class="op" id="2833309">[</span><span class="op" id="2833310">]</span><span class="builtintype" id="2833311">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2833319">templateNodeEdits</span>&nbsp;<span class="keyword" id="2833337">map</span><span class="op" id="2833340">[</span><span class="op" id="2833341">*</span><span class="ident" id="2833342">parse</span><span class="op" id="2833347">.</span><span class="ident" id="2833348">TemplateNode</span><span class="op" id="2833360">]</span><span class="builtintype" id="2833361">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2833369">textNodeEdits</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2833387">map</span><span class="op" id="2833390">[</span><span class="op" id="2833391">*</span><span class="ident" id="2833392">parse</span><span class="op" id="2833397">.</span><span class="ident" id="2833398">TextNode</span><span class="op" id="2833406">]</span><span class="op" id="2833407">[</span><span class="op" id="2833408">]</span><span class="builtintype" id="2833409">byte</span><br>
<span class="lineno"></span><span class="op" id="2833414">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="2833417">//&nbsp;newEscaper&nbsp;creates&nbsp;a&nbsp;blank&nbsp;escaper&nbsp;for&nbsp;the&nbsp;given&nbsp;set.</span><br>
<span class="lineno"></span><span class="keyword" id="2833474">func</span>&nbsp;<span class="ident" id="2833479">newEscaper</span><span class="op" id="2833489">(</span><span class="ident" id="2833490">t</span>&nbsp;<span class="op" id="2833492">*</span><span class="ident" id="2833493">Template</span><span class="op" id="2833501">)</span>&nbsp;<span class="op" id="2833503">*</span><span class="ident" id="2833504">escaper</span>&nbsp;<span class="op" id="2833512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2833515">return</span>&nbsp;<span class="op" id="2833522">&amp;</span><span class="ident" id="2833523">escaper</span><span class="op" id="2833530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2833534">t</span><span class="op" id="2833535">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2833539">map</span><span class="op" id="2833542">[</span><span class="builtintype" id="2833543">string</span><span class="op" id="2833549">]</span><span class="ident" id="2833550">context</span><span class="op" id="2833557">{</span><span class="op" id="2833558">}</span><span class="op" id="2833559">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2833563">map</span><span class="op" id="2833566">[</span><span class="builtintype" id="2833567">string</span><span class="op" id="2833573">]</span><span class="op" id="2833574">*</span><span class="ident" id="2833575">template</span><span class="op" id="2833583">.</span><span class="ident" id="2833584">Template</span><span class="op" id="2833592">{</span><span class="op" id="2833593">}</span><span class="op" id="2833594">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2833598">map</span><span class="op" id="2833601">[</span><span class="builtintype" id="2833602">string</span><span class="op" id="2833608">]</span><span class="builtintype" id="2833609">bool</span><span class="op" id="2833613">{</span><span class="op" id="2833614">}</span><span class="op" id="2833615">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2833619">map</span><span class="op" id="2833622">[</span><span class="op" id="2833623">*</span><span class="ident" id="2833624">parse</span><span class="op" id="2833629">.</span><span class="ident" id="2833630">ActionNode</span><span class="op" id="2833640">]</span><span class="op" id="2833641">[</span><span class="op" id="2833642">]</span><span class="builtintype" id="2833643">string</span><span class="op" id="2833649">{</span><span class="op" id="2833650">}</span><span class="op" id="2833651">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2833655">map</span><span class="op" id="2833658">[</span><span class="op" id="2833659">*</span><span class="ident" id="2833660">parse</span><span class="op" id="2833665">.</span><span class="ident" id="2833666">TemplateNode</span><span class="op" id="2833678">]</span><span class="builtintype" id="2833679">string</span><span class="op" id="2833685">{</span><span class="op" id="2833686">}</span><span class="op" id="2833687">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2833691">map</span><span class="op" id="2833694">[</span><span class="op" id="2833695">*</span><span class="ident" id="2833696">parse</span><span class="op" id="2833701">.</span><span class="ident" id="2833702">TextNode</span><span class="op" id="2833710">]</span><span class="op" id="2833711">[</span><span class="op" id="2833712">]</span><span class="builtintype" id="2833713">byte</span><span class="op" id="2833717">{</span><span class="op" id="2833718">}</span><span class="op" id="2833719">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2833722">}</span><br>
<span class="lineno"></span><span class="op" id="2833724">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2833727">//&nbsp;filterFailsafe&nbsp;is&nbsp;an&nbsp;innocuous&nbsp;word&nbsp;that&nbsp;is&nbsp;emitted&nbsp;in&nbsp;place&nbsp;of&nbsp;unsafe&nbsp;values</span><br>
<span class="lineno"></span><span class="comment" id="2833808">//&nbsp;by&nbsp;sanitizer&nbsp;functions.&nbsp;It&nbsp;is&nbsp;not&nbsp;a&nbsp;keyword&nbsp;in&nbsp;any&nbsp;programming&nbsp;language,</span><br>
<span class="lineno">110</span><span class="comment" id="2833884">//&nbsp;contains&nbsp;no&nbsp;special&nbsp;characters,&nbsp;is&nbsp;not&nbsp;empty,&nbsp;and&nbsp;when&nbsp;it&nbsp;appears&nbsp;in&nbsp;output</span><br>
<span class="lineno"></span><span class="comment" id="2833963">//&nbsp;it&nbsp;is&nbsp;distinct&nbsp;enough&nbsp;that&nbsp;a&nbsp;developer&nbsp;can&nbsp;find&nbsp;the&nbsp;source&nbsp;of&nbsp;the&nbsp;problem</span><br>
<span class="lineno"></span><span class="comment" id="2834040">//&nbsp;via&nbsp;a&nbsp;search&nbsp;engine.</span><br>
<span class="lineno"></span><span class="keyword" id="2834064">const</span>&nbsp;<span class="ident" id="2834070">filterFailsafe</span>&nbsp;<span class="op" id="2834085">=</span>&nbsp;<span class="string" id="2834087">&#34;ZgotmplZ&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="comment" id="2834099">//&nbsp;escape&nbsp;escapes&nbsp;a&nbsp;template&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="2834134">func</span>&nbsp;<span class="op" id="2834139">(</span><span class="ident" id="2834140">e</span>&nbsp;<span class="op" id="2834142">*</span><span class="ident" id="2834143">escaper</span><span class="op" id="2834150">)</span>&nbsp;<span class="ident" id="2834152">escape</span><span class="op" id="2834158">(</span><span class="ident" id="2834159">c</span>&nbsp;<span class="ident" id="2834161">context</span><span class="op" id="2834168">,</span>&nbsp;<span class="ident" id="2834170">n</span>&nbsp;<span class="ident" id="2834172">parse</span><span class="op" id="2834177">.</span><span class="ident" id="2834178">Node</span><span class="op" id="2834182">)</span>&nbsp;<span class="ident" id="2834184">context</span>&nbsp;<span class="op" id="2834192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2834195">switch</span>&nbsp;<span class="ident" id="2834202">n</span>&nbsp;<span class="op" id="2834204">:=</span>&nbsp;<span class="ident" id="2834207">n</span><span class="op" id="2834208">.</span><span class="op" id="2834209">(</span><span class="keyword" id="2834210">type</span><span class="op" id="2834214">)</span>&nbsp;<span class="op" id="2834216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2834219">case</span>&nbsp;<span class="op" id="2834224">*</span><span class="ident" id="2834225">parse</span><span class="op" id="2834230">.</span><span class="ident" id="2834231">ActionNode</span><span class="op" id="2834241">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2834245">return</span>&nbsp;<span class="ident" id="2834252">e</span><span class="op" id="2834253">.</span><span class="ident" id="2834254">escapeAction</span><span class="op" id="2834266">(</span><span class="ident" id="2834267">c</span><span class="op" id="2834268">,</span>&nbsp;<span class="ident" id="2834270">n</span><span class="op" id="2834271">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2834274">case</span>&nbsp;<span class="op" id="2834279">*</span><span class="ident" id="2834280">parse</span><span class="op" id="2834285">.</span><span class="ident" id="2834286">IfNode</span><span class="op" id="2834292">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2834296">return</span>&nbsp;<span class="ident" id="2834303">e</span><span class="op" id="2834304">.</span><span class="ident" id="2834305">escapeBranch</span><span class="op" id="2834317">(</span><span class="ident" id="2834318">c</span><span class="op" id="2834319">,</span>&nbsp;<span class="op" id="2834321">&amp;</span><span class="ident" id="2834322">n</span><span class="op" id="2834323">.</span><span class="ident" id="2834324">BranchNode</span><span class="op" id="2834334">,</span>&nbsp;<span class="string" id="2834336">&#34;if&#34;</span><span class="op" id="2834340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2834343">case</span>&nbsp;<span class="op" id="2834348">*</span><span class="ident" id="2834349">parse</span><span class="op" id="2834354">.</span><span class="ident" id="2834355">ListNode</span><span class="op" id="2834363">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2834367">return</span>&nbsp;<span class="ident" id="2834374">e</span><span class="op" id="2834375">.</span><span class="ident" id="2834376">escapeList</span><span class="op" id="2834386">(</span><span class="ident" id="2834387">c</span><span class="op" id="2834388">,</span>&nbsp;<span class="ident" id="2834390">n</span><span class="op" id="2834391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2834394">case</span>&nbsp;<span class="op" id="2834399">*</span><span class="ident" id="2834400">parse</span><span class="op" id="2834405">.</span><span class="ident" id="2834406">RangeNode</span><span class="op" id="2834415">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2834419">return</span>&nbsp;<span class="ident" id="2834426">e</span><span class="op" id="2834427">.</span><span class="ident" id="2834428">escapeBranch</span><span class="op" id="2834440">(</span><span class="ident" id="2834441">c</span><span class="op" id="2834442">,</span>&nbsp;<span class="op" id="2834444">&amp;</span><span class="ident" id="2834445">n</span><span class="op" id="2834446">.</span><span class="ident" id="2834447">BranchNode</span><span class="op" id="2834457">,</span>&nbsp;<span class="string" id="2834459">&#34;range&#34;</span><span class="op" id="2834466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2834469">case</span>&nbsp;<span class="op" id="2834474">*</span><span class="ident" id="2834475">parse</span><span class="op" id="2834480">.</span><span class="ident" id="2834481">TemplateNode</span><span class="op" id="2834493">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2834497">return</span>&nbsp;<span class="ident" id="2834504">e</span><span class="op" id="2834505">.</span><span class="ident" id="2834506">escapeTemplate</span><span class="op" id="2834520">(</span><span class="ident" id="2834521">c</span><span class="op" id="2834522">,</span>&nbsp;<span class="ident" id="2834524">n</span><span class="op" id="2834525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2834528">case</span>&nbsp;<span class="op" id="2834533">*</span><span class="ident" id="2834534">parse</span><span class="op" id="2834539">.</span><span class="ident" id="2834540">TextNode</span><span class="op" id="2834548">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2834552">return</span>&nbsp;<span class="ident" id="2834559">e</span><span class="op" id="2834560">.</span><span class="ident" id="2834561">escapeText</span><span class="op" id="2834571">(</span><span class="ident" id="2834572">c</span><span class="op" id="2834573">,</span>&nbsp;<span class="ident" id="2834575">n</span><span class="op" id="2834576">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2834579">case</span>&nbsp;<span class="op" id="2834584">*</span><span class="ident" id="2834585">parse</span><span class="op" id="2834590">.</span><span class="ident" id="2834591">WithNode</span><span class="op" id="2834599">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2834603">return</span>&nbsp;<span class="ident" id="2834610">e</span><span class="op" id="2834611">.</span><span class="ident" id="2834612">escapeBranch</span><span class="op" id="2834624">(</span><span class="ident" id="2834625">c</span><span class="op" id="2834626">,</span>&nbsp;<span class="op" id="2834628">&amp;</span><span class="ident" id="2834629">n</span><span class="op" id="2834630">.</span><span class="ident" id="2834631">BranchNode</span><span class="op" id="2834641">,</span>&nbsp;<span class="string" id="2834643">&#34;with&#34;</span><span class="op" id="2834649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2834652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2834655">panic</span><span class="op" id="2834660">(</span><span class="string" id="2834661">&#34;escaping&nbsp;&#34;</span>&nbsp;<span class="op" id="2834673">+</span>&nbsp;<span class="ident" id="2834675">n</span><span class="op" id="2834676">.</span><span class="ident" id="2834677">String</span><span class="op" id="2834683">(</span><span class="op" id="2834684">)</span>&nbsp;<span class="op" id="2834686">+</span>&nbsp;<span class="string" id="2834688">&#34;&nbsp;is&nbsp;unimplemented&#34;</span><span class="op" id="2834707">)</span><br>
<span class="lineno"></span><span class="op" id="2834709">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="comment" id="2834712">//&nbsp;escapeAction&nbsp;escapes&nbsp;an&nbsp;action&nbsp;template&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="2834761">func</span>&nbsp;<span class="op" id="2834766">(</span><span class="ident" id="2834767">e</span>&nbsp;<span class="op" id="2834769">*</span><span class="ident" id="2834770">escaper</span><span class="op" id="2834777">)</span>&nbsp;<span class="ident" id="2834779">escapeAction</span><span class="op" id="2834791">(</span><span class="ident" id="2834792">c</span>&nbsp;<span class="ident" id="2834794">context</span><span class="op" id="2834801">,</span>&nbsp;<span class="ident" id="2834803">n</span>&nbsp;<span class="op" id="2834805">*</span><span class="ident" id="2834806">parse</span><span class="op" id="2834811">.</span><span class="ident" id="2834812">ActionNode</span><span class="op" id="2834822">)</span>&nbsp;<span class="ident" id="2834824">context</span>&nbsp;<span class="op" id="2834832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2834835">if</span>&nbsp;<span class="builtinfunc" id="2834838">len</span><span class="op" id="2834841">(</span><span class="ident" id="2834842">n</span><span class="op" id="2834843">.</span><span class="ident" id="2834844">Pipe</span><span class="op" id="2834848">.</span><span class="ident" id="2834849">Decl</span><span class="op" id="2834853">)</span>&nbsp;<span class="op" id="2834855">!=</span>&nbsp;<span class="num" id="2834858">0</span>&nbsp;<span class="op" id="2834860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2834864">//&nbsp;A&nbsp;local&nbsp;variable&nbsp;assignment,&nbsp;not&nbsp;an&nbsp;interpolation.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2834920">return</span>&nbsp;<span class="ident" id="2834927">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2834930">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2834933">c</span>&nbsp;<span class="op" id="2834935">=</span>&nbsp;<span class="ident" id="2834937">nudge</span><span class="op" id="2834942">(</span><span class="ident" id="2834943">c</span><span class="op" id="2834944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2834947">s</span>&nbsp;<span class="op" id="2834949">:=</span>&nbsp;<span class="builtinfunc" id="2834952">make</span><span class="op" id="2834956">(</span><span class="op" id="2834957">[</span><span class="op" id="2834958">]</span><span class="builtintype" id="2834959">string</span><span class="op" id="2834965">,</span>&nbsp;<span class="num" id="2834967">0</span><span class="op" id="2834968">,</span>&nbsp;<span class="num" id="2834970">3</span><span class="op" id="2834971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2834974">switch</span>&nbsp;<span class="ident" id="2834981">c</span><span class="op" id="2834982">.</span><span class="ident" id="2834983">state</span>&nbsp;<span class="op" id="2834989">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2834992">case</span>&nbsp;<span class="ident" id="2834997">stateError</span><span class="op" id="2835007">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2835011">return</span>&nbsp;<span class="ident" id="2835018">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2835021">case</span>&nbsp;<span class="ident" id="2835026">stateURL</span><span class="op" id="2835034">,</span>&nbsp;<span class="ident" id="2835036">stateCSSDqStr</span><span class="op" id="2835049">,</span>&nbsp;<span class="ident" id="2835051">stateCSSSqStr</span><span class="op" id="2835064">,</span>&nbsp;<span class="ident" id="2835066">stateCSSDqURL</span><span class="op" id="2835079">,</span>&nbsp;<span class="ident" id="2835081">stateCSSSqURL</span><span class="op" id="2835094">,</span>&nbsp;<span class="ident" id="2835096">stateCSSURL</span><span class="op" id="2835107">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2835111">switch</span>&nbsp;<span class="ident" id="2835118">c</span><span class="op" id="2835119">.</span><span class="ident" id="2835120">urlPart</span>&nbsp;<span class="op" id="2835128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2835132">case</span>&nbsp;<span class="ident" id="2835137">urlPartNone</span><span class="op" id="2835148">:</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2835153">s</span>&nbsp;<span class="op" id="2835155">=</span>&nbsp;<span class="builtinfunc" id="2835157">append</span><span class="op" id="2835163">(</span><span class="ident" id="2835164">s</span><span class="op" id="2835165">,</span>&nbsp;<span class="string" id="2835167">&#34;html_template_urlfilter&#34;</span><span class="op" id="2835192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2835197">fallthrough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2835211">case</span>&nbsp;<span class="ident" id="2835216">urlPartPreQuery</span><span class="op" id="2835231">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2835236">switch</span>&nbsp;<span class="ident" id="2835243">c</span><span class="op" id="2835244">.</span><span class="ident" id="2835245">state</span>&nbsp;<span class="op" id="2835251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2835256">case</span>&nbsp;<span class="ident" id="2835261">stateCSSDqStr</span><span class="op" id="2835274">,</span>&nbsp;<span class="ident" id="2835276">stateCSSSqStr</span><span class="op" id="2835289">:</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2835295">s</span>&nbsp;<span class="op" id="2835297">=</span>&nbsp;<span class="builtinfunc" id="2835299">append</span><span class="op" id="2835305">(</span><span class="ident" id="2835306">s</span><span class="op" id="2835307">,</span>&nbsp;<span class="string" id="2835309">&#34;html_template_cssescaper&#34;</span><span class="op" id="2835335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2835340">default</span><span class="op" id="2835347">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2835353">s</span>&nbsp;<span class="op" id="2835355">=</span>&nbsp;<span class="builtinfunc" id="2835357">append</span><span class="op" id="2835363">(</span><span class="ident" id="2835364">s</span><span class="op" id="2835365">,</span>&nbsp;<span class="string" id="2835367">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="2835396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2835401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2835405">case</span>&nbsp;<span class="ident" id="2835410">urlPartQueryOrFrag</span><span class="op" id="2835428">:</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2835433">s</span>&nbsp;<span class="op" id="2835435">=</span>&nbsp;<span class="builtinfunc" id="2835437">append</span><span class="op" id="2835443">(</span><span class="ident" id="2835444">s</span><span class="op" id="2835445">,</span>&nbsp;<span class="string" id="2835447">&#34;html_template_urlescaper&#34;</span><span class="op" id="2835473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2835477">case</span>&nbsp;<span class="ident" id="2835482">urlPartUnknown</span><span class="op" id="2835496">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2835501">return</span>&nbsp;<span class="ident" id="2835508">context</span><span class="op" id="2835515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2835521">state</span><span class="op" id="2835526">:</span>&nbsp;<span class="ident" id="2835528">stateError</span><span class="op" id="2835538">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2835544">err</span><span class="op" id="2835547">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2835551">errorf</span><span class="op" id="2835557">(</span><span class="ident" id="2835558">ErrAmbigContext</span><span class="op" id="2835573">,</span>&nbsp;<span class="ident" id="2835575">n</span><span class="op" id="2835576">,</span>&nbsp;<span class="ident" id="2835578">n</span><span class="op" id="2835579">.</span><span class="ident" id="2835580">Line</span><span class="op" id="2835584">,</span>&nbsp;<span class="string" id="2835586">&#34;%s&nbsp;appears&nbsp;in&nbsp;an&nbsp;ambiguous&nbsp;URL&nbsp;context&#34;</span><span class="op" id="2835626">,</span>&nbsp;<span class="ident" id="2835628">n</span><span class="op" id="2835629">)</span><span class="op" id="2835630">,</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2835635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2835639">default</span><span class="op" id="2835646">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2835651">panic</span><span class="op" id="2835656">(</span><span class="ident" id="2835657">c</span><span class="op" id="2835658">.</span><span class="ident" id="2835659">urlPart</span><span class="op" id="2835666">.</span><span class="ident" id="2835667">String</span><span class="op" id="2835673">(</span><span class="op" id="2835674">)</span><span class="op" id="2835675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2835679">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2835682">case</span>&nbsp;<span class="ident" id="2835687">stateJS</span><span class="op" id="2835694">:</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2835698">s</span>&nbsp;<span class="op" id="2835700">=</span>&nbsp;<span class="builtinfunc" id="2835702">append</span><span class="op" id="2835708">(</span><span class="ident" id="2835709">s</span><span class="op" id="2835710">,</span>&nbsp;<span class="string" id="2835712">&#34;html_template_jsvalescaper&#34;</span><span class="op" id="2835740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2835744">//&nbsp;A&nbsp;slash&nbsp;after&nbsp;a&nbsp;value&nbsp;starts&nbsp;a&nbsp;div&nbsp;operator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2835794">c</span><span class="op" id="2835795">.</span><span class="ident" id="2835796">jsCtx</span>&nbsp;<span class="op" id="2835802">=</span>&nbsp;<span class="ident" id="2835804">jsCtxDivOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2835816">case</span>&nbsp;<span class="ident" id="2835821">stateJSDqStr</span><span class="op" id="2835833">,</span>&nbsp;<span class="ident" id="2835835">stateJSSqStr</span><span class="op" id="2835847">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2835851">s</span>&nbsp;<span class="op" id="2835853">=</span>&nbsp;<span class="builtinfunc" id="2835855">append</span><span class="op" id="2835861">(</span><span class="ident" id="2835862">s</span><span class="op" id="2835863">,</span>&nbsp;<span class="string" id="2835865">&#34;html_template_jsstrescaper&#34;</span><span class="op" id="2835893">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2835896">case</span>&nbsp;<span class="ident" id="2835901">stateJSRegexp</span><span class="op" id="2835914">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2835918">s</span>&nbsp;<span class="op" id="2835920">=</span>&nbsp;<span class="builtinfunc" id="2835922">append</span><span class="op" id="2835928">(</span><span class="ident" id="2835929">s</span><span class="op" id="2835930">,</span>&nbsp;<span class="string" id="2835932">&#34;html_template_jsregexpescaper&#34;</span><span class="op" id="2835963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2835966">case</span>&nbsp;<span class="ident" id="2835971">stateCSS</span><span class="op" id="2835979">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2835983">s</span>&nbsp;<span class="op" id="2835985">=</span>&nbsp;<span class="builtinfunc" id="2835987">append</span><span class="op" id="2835993">(</span><span class="ident" id="2835994">s</span><span class="op" id="2835995">,</span>&nbsp;<span class="string" id="2835997">&#34;html_template_cssvaluefilter&#34;</span><span class="op" id="2836027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2836030">case</span>&nbsp;<span class="ident" id="2836035">stateText</span><span class="op" id="2836044">:</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2836048">s</span>&nbsp;<span class="op" id="2836050">=</span>&nbsp;<span class="builtinfunc" id="2836052">append</span><span class="op" id="2836058">(</span><span class="ident" id="2836059">s</span><span class="op" id="2836060">,</span>&nbsp;<span class="string" id="2836062">&#34;html_template_htmlescaper&#34;</span><span class="op" id="2836089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2836092">case</span>&nbsp;<span class="ident" id="2836097">stateRCDATA</span><span class="op" id="2836108">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2836112">s</span>&nbsp;<span class="op" id="2836114">=</span>&nbsp;<span class="builtinfunc" id="2836116">append</span><span class="op" id="2836122">(</span><span class="ident" id="2836123">s</span><span class="op" id="2836124">,</span>&nbsp;<span class="string" id="2836126">&#34;html_template_rcdataescaper&#34;</span><span class="op" id="2836155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2836158">case</span>&nbsp;<span class="ident" id="2836163">stateAttr</span><span class="op" id="2836172">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2836176">//&nbsp;Handled&nbsp;below&nbsp;in&nbsp;delim&nbsp;check.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2836210">case</span>&nbsp;<span class="ident" id="2836215">stateAttrName</span><span class="op" id="2836228">,</span>&nbsp;<span class="ident" id="2836230">stateTag</span><span class="op" id="2836238">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2836242">c</span><span class="op" id="2836243">.</span><span class="ident" id="2836244">state</span>&nbsp;<span class="op" id="2836250">=</span>&nbsp;<span class="ident" id="2836252">stateAttrName</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2836268">s</span>&nbsp;<span class="op" id="2836270">=</span>&nbsp;<span class="builtinfunc" id="2836272">append</span><span class="op" id="2836278">(</span><span class="ident" id="2836279">s</span><span class="op" id="2836280">,</span>&nbsp;<span class="string" id="2836282">&#34;html_template_htmlnamefilter&#34;</span><span class="op" id="2836312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2836315">default</span><span class="op" id="2836322">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2836326">if</span>&nbsp;<span class="ident" id="2836329">isComment</span><span class="op" id="2836338">(</span><span class="ident" id="2836339">c</span><span class="op" id="2836340">.</span><span class="ident" id="2836341">state</span><span class="op" id="2836346">)</span>&nbsp;<span class="op" id="2836348">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2836353">s</span>&nbsp;<span class="op" id="2836355">=</span>&nbsp;<span class="builtinfunc" id="2836357">append</span><span class="op" id="2836363">(</span><span class="ident" id="2836364">s</span><span class="op" id="2836365">,</span>&nbsp;<span class="string" id="2836367">&#34;html_template_commentescaper&#34;</span><span class="op" id="2836397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2836401">}</span>&nbsp;<span class="keyword" id="2836403">else</span>&nbsp;<span class="op" id="2836408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2836413">panic</span><span class="op" id="2836418">(</span><span class="string" id="2836419">&#34;unexpected&nbsp;state&nbsp;&#34;</span>&nbsp;<span class="op" id="2836439">+</span>&nbsp;<span class="ident" id="2836441">c</span><span class="op" id="2836442">.</span><span class="ident" id="2836443">state</span><span class="op" id="2836448">.</span><span class="ident" id="2836449">String</span><span class="op" id="2836455">(</span><span class="op" id="2836456">)</span><span class="op" id="2836457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2836461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2836464">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2836467">switch</span>&nbsp;<span class="ident" id="2836474">c</span><span class="op" id="2836475">.</span><span class="ident" id="2836476">delim</span>&nbsp;<span class="op" id="2836482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2836485">case</span>&nbsp;<span class="ident" id="2836490">delimNone</span><span class="op" id="2836499">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2836503">//&nbsp;No&nbsp;extra-escaping&nbsp;needed&nbsp;for&nbsp;raw&nbsp;text&nbsp;content.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2836554">case</span>&nbsp;<span class="ident" id="2836559">delimSpaceOrTagEnd</span><span class="op" id="2836577">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2836581">s</span>&nbsp;<span class="op" id="2836583">=</span>&nbsp;<span class="builtinfunc" id="2836585">append</span><span class="op" id="2836591">(</span><span class="ident" id="2836592">s</span><span class="op" id="2836593">,</span>&nbsp;<span class="string" id="2836595">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="2836625">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2836628">default</span><span class="op" id="2836635">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2836639">s</span>&nbsp;<span class="op" id="2836641">=</span>&nbsp;<span class="builtinfunc" id="2836643">append</span><span class="op" id="2836649">(</span><span class="ident" id="2836650">s</span><span class="op" id="2836651">,</span>&nbsp;<span class="string" id="2836653">&#34;html_template_attrescaper&#34;</span><span class="op" id="2836680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2836683">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2836686">e</span><span class="op" id="2836687">.</span><span class="ident" id="2836688">editActionNode</span><span class="op" id="2836702">(</span><span class="ident" id="2836703">n</span><span class="op" id="2836704">,</span>&nbsp;<span class="ident" id="2836706">s</span><span class="op" id="2836707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2836710">return</span>&nbsp;<span class="ident" id="2836717">c</span><br>
<span class="lineno">205</span><span class="op" id="2836719">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2836722">//&nbsp;allIdents&nbsp;returns&nbsp;the&nbsp;names&nbsp;of&nbsp;the&nbsp;identifiers&nbsp;under&nbsp;the&nbsp;Ident&nbsp;field&nbsp;of&nbsp;the&nbsp;node,</span><br>
<span class="lineno"></span><span class="comment" id="2836807">//&nbsp;which&nbsp;might&nbsp;be&nbsp;a&nbsp;singleton&nbsp;(Identifier)&nbsp;or&nbsp;a&nbsp;slice&nbsp;(Field).</span><br>
<span class="lineno"></span><span class="keyword" id="2836870">func</span>&nbsp;<span class="ident" id="2836875">allIdents</span><span class="op" id="2836884">(</span><span class="ident" id="2836885">node</span>&nbsp;<span class="ident" id="2836890">parse</span><span class="op" id="2836895">.</span><span class="ident" id="2836896">Node</span><span class="op" id="2836900">)</span>&nbsp;<span class="op" id="2836902">[</span><span class="op" id="2836903">]</span><span class="builtintype" id="2836904">string</span>&nbsp;<span class="op" id="2836911">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2836914">switch</span>&nbsp;<span class="ident" id="2836921">node</span>&nbsp;<span class="op" id="2836926">:=</span>&nbsp;<span class="ident" id="2836929">node</span><span class="op" id="2836933">.</span><span class="op" id="2836934">(</span><span class="keyword" id="2836935">type</span><span class="op" id="2836939">)</span>&nbsp;<span class="op" id="2836941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2836944">case</span>&nbsp;<span class="op" id="2836949">*</span><span class="ident" id="2836950">parse</span><span class="op" id="2836955">.</span><span class="ident" id="2836956">IdentifierNode</span><span class="op" id="2836970">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2836974">return</span>&nbsp;<span class="op" id="2836981">[</span><span class="op" id="2836982">]</span><span class="builtintype" id="2836983">string</span><span class="op" id="2836989">{</span><span class="ident" id="2836990">node</span><span class="op" id="2836994">.</span><span class="ident" id="2836995">Ident</span><span class="op" id="2837000">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2837003">case</span>&nbsp;<span class="op" id="2837008">*</span><span class="ident" id="2837009">parse</span><span class="op" id="2837014">.</span><span class="ident" id="2837015">FieldNode</span><span class="op" id="2837024">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2837028">return</span>&nbsp;<span class="ident" id="2837035">node</span><span class="op" id="2837039">.</span><span class="ident" id="2837040">Ident</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2837047">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2837050">panic</span><span class="op" id="2837055">(</span><span class="string" id="2837056">&#34;unidentified&nbsp;node&nbsp;type&nbsp;in&nbsp;allIdents&#34;</span><span class="op" id="2837093">)</span><br>
<span class="lineno"></span><span class="op" id="2837095">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2837098">//&nbsp;ensurePipelineContains&nbsp;ensures&nbsp;that&nbsp;the&nbsp;pipeline&nbsp;has&nbsp;commands&nbsp;with</span><br>
<span class="lineno">220</span><span class="comment" id="2837168">//&nbsp;the&nbsp;identifiers&nbsp;in&nbsp;s&nbsp;in&nbsp;order.</span><br>
<span class="lineno"></span><span class="comment" id="2837202">//&nbsp;If&nbsp;the&nbsp;pipeline&nbsp;already&nbsp;has&nbsp;some&nbsp;of&nbsp;the&nbsp;sanitizers,&nbsp;do&nbsp;not&nbsp;interfere.</span><br>
<span class="lineno"></span><span class="comment" id="2837275">//&nbsp;For&nbsp;example,&nbsp;if&nbsp;p&nbsp;is&nbsp;(.X&nbsp;|&nbsp;html)&nbsp;and&nbsp;s&nbsp;is&nbsp;[&#34;escapeJSVal&#34;,&nbsp;&#34;html&#34;]&nbsp;then&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="2837352">//&nbsp;has&nbsp;one&nbsp;matching,&nbsp;&#34;html&#34;,&nbsp;and&nbsp;one&nbsp;to&nbsp;insert,&nbsp;&#34;escapeJSVal&#34;,&nbsp;to&nbsp;produce</span><br>
<span class="lineno"></span><span class="comment" id="2837426">//&nbsp;(.X&nbsp;|&nbsp;escapeJSVal&nbsp;|&nbsp;html).</span><br>
<span class="lineno">225</span><span class="keyword" id="2837456">func</span>&nbsp;<span class="ident" id="2837461">ensurePipelineContains</span><span class="op" id="2837483">(</span><span class="ident" id="2837484">p</span>&nbsp;<span class="op" id="2837486">*</span><span class="ident" id="2837487">parse</span><span class="op" id="2837492">.</span><span class="ident" id="2837493">PipeNode</span><span class="op" id="2837501">,</span>&nbsp;<span class="ident" id="2837503">s</span>&nbsp;<span class="op" id="2837505">[</span><span class="op" id="2837506">]</span><span class="builtintype" id="2837507">string</span><span class="op" id="2837513">)</span>&nbsp;<span class="op" id="2837515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2837518">if</span>&nbsp;<span class="builtinfunc" id="2837521">len</span><span class="op" id="2837524">(</span><span class="ident" id="2837525">s</span><span class="op" id="2837526">)</span>&nbsp;<span class="op" id="2837528">==</span>&nbsp;<span class="num" id="2837531">0</span>&nbsp;<span class="op" id="2837533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2837537">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2837545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2837548">n</span>&nbsp;<span class="op" id="2837550">:=</span>&nbsp;<span class="builtinfunc" id="2837553">len</span><span class="op" id="2837556">(</span><span class="ident" id="2837557">p</span><span class="op" id="2837558">.</span><span class="ident" id="2837559">Cmds</span><span class="op" id="2837563">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2837566">//&nbsp;Find&nbsp;the&nbsp;identifiers&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;command&nbsp;chain.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2837624">idents</span>&nbsp;<span class="op" id="2837631">:=</span>&nbsp;<span class="ident" id="2837634">p</span><span class="op" id="2837635">.</span><span class="ident" id="2837636">Cmds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2837642">for</span>&nbsp;<span class="ident" id="2837646">i</span>&nbsp;<span class="op" id="2837648">:=</span>&nbsp;<span class="ident" id="2837651">n</span>&nbsp;<span class="op" id="2837653">-</span>&nbsp;<span class="num" id="2837655">1</span><span class="op" id="2837656">;</span>&nbsp;<span class="ident" id="2837658">i</span>&nbsp;<span class="op" id="2837660">&gt;=</span>&nbsp;<span class="num" id="2837663">0</span><span class="op" id="2837664">;</span>&nbsp;<span class="ident" id="2837666">i</span><span class="op" id="2837667">--</span>&nbsp;<span class="op" id="2837670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2837674">if</span>&nbsp;<span class="ident" id="2837677">cmd</span>&nbsp;<span class="op" id="2837681">:=</span>&nbsp;<span class="ident" id="2837684">p</span><span class="op" id="2837685">.</span><span class="ident" id="2837686">Cmds</span><span class="op" id="2837690">[</span><span class="ident" id="2837691">i</span><span class="op" id="2837692">]</span><span class="op" id="2837693">;</span>&nbsp;<span class="builtinfunc" id="2837695">len</span><span class="op" id="2837698">(</span><span class="ident" id="2837699">cmd</span><span class="op" id="2837702">.</span><span class="ident" id="2837703">Args</span><span class="op" id="2837707">)</span>&nbsp;<span class="op" id="2837709">!=</span>&nbsp;<span class="num" id="2837712">0</span>&nbsp;<span class="op" id="2837714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2837719">if</span>&nbsp;<span class="ident" id="2837722">_</span><span class="op" id="2837723">,</span>&nbsp;<span class="ident" id="2837725">ok</span>&nbsp;<span class="op" id="2837728">:=</span>&nbsp;<span class="ident" id="2837731">cmd</span><span class="op" id="2837734">.</span><span class="ident" id="2837735">Args</span><span class="op" id="2837739">[</span><span class="num" id="2837740">0</span><span class="op" id="2837741">]</span><span class="op" id="2837742">.</span><span class="op" id="2837743">(</span><span class="op" id="2837744">*</span><span class="ident" id="2837745">parse</span><span class="op" id="2837750">.</span><span class="ident" id="2837751">IdentifierNode</span><span class="op" id="2837765">)</span><span class="op" id="2837766">;</span>&nbsp;<span class="ident" id="2837768">ok</span>&nbsp;<span class="op" id="2837771">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2837777">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2837789">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2837793">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2837797">idents</span>&nbsp;<span class="op" id="2837804">=</span>&nbsp;<span class="ident" id="2837806">p</span><span class="op" id="2837807">.</span><span class="ident" id="2837808">Cmds</span><span class="op" id="2837812">[</span><span class="ident" id="2837813">i</span><span class="op" id="2837814">+</span><span class="num" id="2837815">1</span><span class="op" id="2837816">:</span><span class="op" id="2837817">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2837820">}</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2837823">dups</span>&nbsp;<span class="op" id="2837828">:=</span>&nbsp;<span class="num" id="2837831">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2837834">for</span>&nbsp;<span class="ident" id="2837838">_</span><span class="op" id="2837839">,</span>&nbsp;<span class="ident" id="2837841">idNode</span>&nbsp;<span class="op" id="2837848">:=</span>&nbsp;<span class="keyword" id="2837851">range</span>&nbsp;<span class="ident" id="2837857">idents</span>&nbsp;<span class="op" id="2837864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2837868">for</span>&nbsp;<span class="ident" id="2837872">_</span><span class="op" id="2837873">,</span>&nbsp;<span class="ident" id="2837875">ident</span>&nbsp;<span class="op" id="2837881">:=</span>&nbsp;<span class="keyword" id="2837884">range</span>&nbsp;<span class="ident" id="2837890">allIdents</span><span class="op" id="2837899">(</span><span class="ident" id="2837900">idNode</span><span class="op" id="2837906">.</span><span class="ident" id="2837907">Args</span><span class="op" id="2837911">[</span><span class="num" id="2837912">0</span><span class="op" id="2837913">]</span><span class="op" id="2837914">)</span>&nbsp;<span class="op" id="2837916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2837921">if</span>&nbsp;<span class="ident" id="2837924">escFnsEq</span><span class="op" id="2837932">(</span><span class="ident" id="2837933">s</span><span class="op" id="2837934">[</span><span class="ident" id="2837935">dups</span><span class="op" id="2837939">]</span><span class="op" id="2837940">,</span>&nbsp;<span class="ident" id="2837942">ident</span><span class="op" id="2837947">)</span>&nbsp;<span class="op" id="2837949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2837955">dups</span><span class="op" id="2837959">++</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2837966">if</span>&nbsp;<span class="ident" id="2837969">dups</span>&nbsp;<span class="op" id="2837974">==</span>&nbsp;<span class="builtinfunc" id="2837977">len</span><span class="op" id="2837980">(</span><span class="ident" id="2837981">s</span><span class="op" id="2837982">)</span>&nbsp;<span class="op" id="2837984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2837991">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2838002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2838007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2838011">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2838014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2838017">newCmds</span>&nbsp;<span class="op" id="2838025">:=</span>&nbsp;<span class="builtinfunc" id="2838028">make</span><span class="op" id="2838032">(</span><span class="op" id="2838033">[</span><span class="op" id="2838034">]</span><span class="op" id="2838035">*</span><span class="ident" id="2838036">parse</span><span class="op" id="2838041">.</span><span class="ident" id="2838042">CommandNode</span><span class="op" id="2838053">,</span>&nbsp;<span class="ident" id="2838055">n</span><span class="op" id="2838056">-</span><span class="builtinfunc" id="2838057">len</span><span class="op" id="2838060">(</span><span class="ident" id="2838061">idents</span><span class="op" id="2838067">)</span><span class="op" id="2838068">,</span>&nbsp;<span class="ident" id="2838070">n</span><span class="op" id="2838071">+</span><span class="builtinfunc" id="2838072">len</span><span class="op" id="2838075">(</span><span class="ident" id="2838076">s</span><span class="op" id="2838077">)</span><span class="op" id="2838078">-</span><span class="ident" id="2838079">dups</span><span class="op" id="2838083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2838086">copy</span><span class="op" id="2838090">(</span><span class="ident" id="2838091">newCmds</span><span class="op" id="2838098">,</span>&nbsp;<span class="ident" id="2838100">p</span><span class="op" id="2838101">.</span><span class="ident" id="2838102">Cmds</span><span class="op" id="2838106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2838109">//&nbsp;Merge&nbsp;existing&nbsp;identifier&nbsp;commands&nbsp;with&nbsp;the&nbsp;sanitizers&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2838176">for</span>&nbsp;<span class="ident" id="2838180">_</span><span class="op" id="2838181">,</span>&nbsp;<span class="ident" id="2838183">idNode</span>&nbsp;<span class="op" id="2838190">:=</span>&nbsp;<span class="keyword" id="2838193">range</span>&nbsp;<span class="ident" id="2838199">idents</span>&nbsp;<span class="op" id="2838206">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2838210">pos</span>&nbsp;<span class="op" id="2838214">:=</span>&nbsp;<span class="ident" id="2838217">idNode</span><span class="op" id="2838223">.</span><span class="ident" id="2838224">Args</span><span class="op" id="2838228">[</span><span class="num" id="2838229">0</span><span class="op" id="2838230">]</span><span class="op" id="2838231">.</span><span class="ident" id="2838232">Position</span><span class="op" id="2838240">(</span><span class="op" id="2838241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2838245">for</span>&nbsp;<span class="ident" id="2838249">_</span><span class="op" id="2838250">,</span>&nbsp;<span class="ident" id="2838252">ident</span>&nbsp;<span class="op" id="2838258">:=</span>&nbsp;<span class="keyword" id="2838261">range</span>&nbsp;<span class="ident" id="2838267">allIdents</span><span class="op" id="2838276">(</span><span class="ident" id="2838277">idNode</span><span class="op" id="2838283">.</span><span class="ident" id="2838284">Args</span><span class="op" id="2838288">[</span><span class="num" id="2838289">0</span><span class="op" id="2838290">]</span><span class="op" id="2838291">)</span>&nbsp;<span class="op" id="2838293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2838298">i</span>&nbsp;<span class="op" id="2838300">:=</span>&nbsp;<span class="ident" id="2838303">indexOfStr</span><span class="op" id="2838313">(</span><span class="ident" id="2838314">ident</span><span class="op" id="2838319">,</span>&nbsp;<span class="ident" id="2838321">s</span><span class="op" id="2838322">,</span>&nbsp;<span class="ident" id="2838324">escFnsEq</span><span class="op" id="2838332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2838337">if</span>&nbsp;<span class="ident" id="2838340">i</span>&nbsp;<span class="op" id="2838342">!=</span>&nbsp;<span class="op" id="2838345">-</span><span class="num" id="2838346">1</span>&nbsp;<span class="op" id="2838348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2838354">for</span>&nbsp;<span class="ident" id="2838358">_</span><span class="op" id="2838359">,</span>&nbsp;<span class="ident" id="2838361">name</span>&nbsp;<span class="op" id="2838366">:=</span>&nbsp;<span class="keyword" id="2838369">range</span>&nbsp;<span class="ident" id="2838375">s</span><span class="op" id="2838376">[</span><span class="op" id="2838377">:</span><span class="ident" id="2838378">i</span><span class="op" id="2838379">]</span>&nbsp;<span class="op" id="2838381">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2838388">newCmds</span>&nbsp;<span class="op" id="2838396">=</span>&nbsp;<span class="ident" id="2838398">appendCmd</span><span class="op" id="2838407">(</span><span class="ident" id="2838408">newCmds</span><span class="op" id="2838415">,</span>&nbsp;<span class="ident" id="2838417">newIdentCmd</span><span class="op" id="2838428">(</span><span class="ident" id="2838429">name</span><span class="op" id="2838433">,</span>&nbsp;<span class="ident" id="2838435">pos</span><span class="op" id="2838438">)</span><span class="op" id="2838439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2838445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2838451">s</span>&nbsp;<span class="op" id="2838453">=</span>&nbsp;<span class="ident" id="2838455">s</span><span class="op" id="2838456">[</span><span class="ident" id="2838457">i</span><span class="op" id="2838458">+</span><span class="num" id="2838459">1</span><span class="op" id="2838460">:</span><span class="op" id="2838461">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2838466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2838470">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2838474">newCmds</span>&nbsp;<span class="op" id="2838482">=</span>&nbsp;<span class="ident" id="2838484">appendCmd</span><span class="op" id="2838493">(</span><span class="ident" id="2838494">newCmds</span><span class="op" id="2838501">,</span>&nbsp;<span class="ident" id="2838503">idNode</span><span class="op" id="2838509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2838512">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2838515">//&nbsp;Create&nbsp;any&nbsp;remaining&nbsp;sanitizers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2838552">for</span>&nbsp;<span class="ident" id="2838556">_</span><span class="op" id="2838557">,</span>&nbsp;<span class="ident" id="2838559">name</span>&nbsp;<span class="op" id="2838564">:=</span>&nbsp;<span class="keyword" id="2838567">range</span>&nbsp;<span class="ident" id="2838573">s</span>&nbsp;<span class="op" id="2838575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2838579">newCmds</span>&nbsp;<span class="op" id="2838587">=</span>&nbsp;<span class="ident" id="2838589">appendCmd</span><span class="op" id="2838598">(</span><span class="ident" id="2838599">newCmds</span><span class="op" id="2838606">,</span>&nbsp;<span class="ident" id="2838608">newIdentCmd</span><span class="op" id="2838619">(</span><span class="ident" id="2838620">name</span><span class="op" id="2838624">,</span>&nbsp;<span class="ident" id="2838626">p</span><span class="op" id="2838627">.</span><span class="ident" id="2838628">Position</span><span class="op" id="2838636">(</span><span class="op" id="2838637">)</span><span class="op" id="2838638">)</span><span class="op" id="2838639">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2838642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2838645">p</span><span class="op" id="2838646">.</span><span class="ident" id="2838647">Cmds</span>&nbsp;<span class="op" id="2838652">=</span>&nbsp;<span class="ident" id="2838654">newCmds</span><br>
<span class="lineno"></span><span class="op" id="2838662">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2838665">//&nbsp;redundantFuncs[a][b]&nbsp;implies&nbsp;that&nbsp;funcMap[b](funcMap[a](x))&nbsp;==&nbsp;funcMap[a](x)</span><br>
<span class="lineno">275</span><span class="comment" id="2838745">//&nbsp;for&nbsp;all&nbsp;x.</span><br>
<span class="lineno"></span><span class="keyword" id="2838759">var</span>&nbsp;<span class="ident" id="2838763">redundantFuncs</span>&nbsp;<span class="op" id="2838778">=</span>&nbsp;<span class="keyword" id="2838780">map</span><span class="op" id="2838783">[</span><span class="builtintype" id="2838784">string</span><span class="op" id="2838790">]</span><span class="keyword" id="2838791">map</span><span class="op" id="2838794">[</span><span class="builtintype" id="2838795">string</span><span class="op" id="2838801">]</span><span class="builtintype" id="2838802">bool</span><span class="op" id="2838806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2838809">&#34;html_template_commentescaper&#34;</span><span class="op" id="2838839">:</span>&nbsp;<span class="op" id="2838841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2838845">&#34;html_template_attrescaper&#34;</span><span class="op" id="2838872">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2838877">true</span><span class="op" id="2838881">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2838885">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="2838915">:</span>&nbsp;<span class="builtintype" id="2838917">true</span><span class="op" id="2838921">,</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2838925">&#34;html_template_htmlescaper&#34;</span><span class="op" id="2838952">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2838957">true</span><span class="op" id="2838961">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2838964">}</span><span class="op" id="2838965">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2838968">&#34;html_template_cssescaper&#34;</span><span class="op" id="2838994">:</span>&nbsp;<span class="op" id="2838996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2839000">&#34;html_template_attrescaper&#34;</span><span class="op" id="2839027">:</span>&nbsp;<span class="builtintype" id="2839029">true</span><span class="op" id="2839033">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2839036">}</span><span class="op" id="2839037">,</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2839040">&#34;html_template_jsregexpescaper&#34;</span><span class="op" id="2839071">:</span>&nbsp;<span class="op" id="2839073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2839077">&#34;html_template_attrescaper&#34;</span><span class="op" id="2839104">:</span>&nbsp;<span class="builtintype" id="2839106">true</span><span class="op" id="2839110">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2839113">}</span><span class="op" id="2839114">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2839117">&#34;html_template_jsstrescaper&#34;</span><span class="op" id="2839145">:</span>&nbsp;<span class="op" id="2839147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2839151">&#34;html_template_attrescaper&#34;</span><span class="op" id="2839178">:</span>&nbsp;<span class="builtintype" id="2839180">true</span><span class="op" id="2839184">,</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2839187">}</span><span class="op" id="2839188">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2839191">&#34;html_template_urlescaper&#34;</span><span class="op" id="2839217">:</span>&nbsp;<span class="op" id="2839219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2839223">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="2839252">:</span>&nbsp;<span class="builtintype" id="2839254">true</span><span class="op" id="2839258">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2839261">}</span><span class="op" id="2839262">,</span><br>
<span class="lineno"></span><span class="op" id="2839264">}</span><br>
<span class="lineno">295</span><br>
<span class="lineno"></span><span class="comment" id="2839267">//&nbsp;appendCmd&nbsp;appends&nbsp;the&nbsp;given&nbsp;command&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;command&nbsp;pipeline</span><br>
<span class="lineno"></span><span class="comment" id="2839341">//&nbsp;unless&nbsp;it&nbsp;is&nbsp;redundant&nbsp;with&nbsp;the&nbsp;last&nbsp;command.</span><br>
<span class="lineno"></span><span class="keyword" id="2839390">func</span>&nbsp;<span class="ident" id="2839395">appendCmd</span><span class="op" id="2839404">(</span><span class="ident" id="2839405">cmds</span>&nbsp;<span class="op" id="2839410">[</span><span class="op" id="2839411">]</span><span class="op" id="2839412">*</span><span class="ident" id="2839413">parse</span><span class="op" id="2839418">.</span><span class="ident" id="2839419">CommandNode</span><span class="op" id="2839430">,</span>&nbsp;<span class="ident" id="2839432">cmd</span>&nbsp;<span class="op" id="2839436">*</span><span class="ident" id="2839437">parse</span><span class="op" id="2839442">.</span><span class="ident" id="2839443">CommandNode</span><span class="op" id="2839454">)</span>&nbsp;<span class="op" id="2839456">[</span><span class="op" id="2839457">]</span><span class="op" id="2839458">*</span><span class="ident" id="2839459">parse</span><span class="op" id="2839464">.</span><span class="ident" id="2839465">CommandNode</span>&nbsp;<span class="op" id="2839477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2839480">if</span>&nbsp;<span class="ident" id="2839483">n</span>&nbsp;<span class="op" id="2839485">:=</span>&nbsp;<span class="builtinfunc" id="2839488">len</span><span class="op" id="2839491">(</span><span class="ident" id="2839492">cmds</span><span class="op" id="2839496">)</span><span class="op" id="2839497">;</span>&nbsp;<span class="ident" id="2839499">n</span>&nbsp;<span class="op" id="2839501">!=</span>&nbsp;<span class="num" id="2839504">0</span>&nbsp;<span class="op" id="2839506">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2839510">last</span><span class="op" id="2839514">,</span>&nbsp;<span class="ident" id="2839516">ok</span>&nbsp;<span class="op" id="2839519">:=</span>&nbsp;<span class="ident" id="2839522">cmds</span><span class="op" id="2839526">[</span><span class="ident" id="2839527">n</span><span class="op" id="2839528">-</span><span class="num" id="2839529">1</span><span class="op" id="2839530">]</span><span class="op" id="2839531">.</span><span class="ident" id="2839532">Args</span><span class="op" id="2839536">[</span><span class="num" id="2839537">0</span><span class="op" id="2839538">]</span><span class="op" id="2839539">.</span><span class="op" id="2839540">(</span><span class="op" id="2839541">*</span><span class="ident" id="2839542">parse</span><span class="op" id="2839547">.</span><span class="ident" id="2839548">IdentifierNode</span><span class="op" id="2839562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2839566">next</span><span class="op" id="2839570">,</span>&nbsp;<span class="ident" id="2839572">_</span>&nbsp;<span class="op" id="2839574">:=</span>&nbsp;<span class="ident" id="2839577">cmd</span><span class="op" id="2839580">.</span><span class="ident" id="2839581">Args</span><span class="op" id="2839585">[</span><span class="num" id="2839586">0</span><span class="op" id="2839587">]</span><span class="op" id="2839588">.</span><span class="op" id="2839589">(</span><span class="op" id="2839590">*</span><span class="ident" id="2839591">parse</span><span class="op" id="2839596">.</span><span class="ident" id="2839597">IdentifierNode</span><span class="op" id="2839611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2839615">if</span>&nbsp;<span class="ident" id="2839618">ok</span>&nbsp;<span class="op" id="2839621">&amp;&amp;</span>&nbsp;<span class="ident" id="2839624">redundantFuncs</span><span class="op" id="2839638">[</span><span class="ident" id="2839639">last</span><span class="op" id="2839643">.</span><span class="ident" id="2839644">Ident</span><span class="op" id="2839649">]</span><span class="op" id="2839650">[</span><span class="ident" id="2839651">next</span><span class="op" id="2839655">.</span><span class="ident" id="2839656">Ident</span><span class="op" id="2839661">]</span>&nbsp;<span class="op" id="2839663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2839668">return</span>&nbsp;<span class="ident" id="2839675">cmds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2839682">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2839685">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2839688">return</span>&nbsp;<span class="builtinfunc" id="2839695">append</span><span class="op" id="2839701">(</span><span class="ident" id="2839702">cmds</span><span class="op" id="2839706">,</span>&nbsp;<span class="ident" id="2839708">cmd</span><span class="op" id="2839711">)</span><br>
<span class="lineno"></span><span class="op" id="2839713">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2839716">//&nbsp;indexOfStr&nbsp;is&nbsp;the&nbsp;first&nbsp;i&nbsp;such&nbsp;that&nbsp;eq(s,&nbsp;strs[i])&nbsp;or&nbsp;-1&nbsp;if&nbsp;s&nbsp;was&nbsp;not&nbsp;found.</span><br>
<span class="lineno">310</span><span class="keyword" id="2839796">func</span>&nbsp;<span class="ident" id="2839801">indexOfStr</span><span class="op" id="2839811">(</span><span class="ident" id="2839812">s</span>&nbsp;<span class="builtintype" id="2839814">string</span><span class="op" id="2839820">,</span>&nbsp;<span class="ident" id="2839822">strs</span>&nbsp;<span class="op" id="2839827">[</span><span class="op" id="2839828">]</span><span class="builtintype" id="2839829">string</span><span class="op" id="2839835">,</span>&nbsp;<span class="ident" id="2839837">eq</span>&nbsp;<span class="keyword" id="2839840">func</span><span class="op" id="2839844">(</span><span class="ident" id="2839845">a</span><span class="op" id="2839846">,</span>&nbsp;<span class="ident" id="2839848">b</span>&nbsp;<span class="builtintype" id="2839850">string</span><span class="op" id="2839856">)</span>&nbsp;<span class="builtintype" id="2839858">bool</span><span class="op" id="2839862">)</span>&nbsp;<span class="builtintype" id="2839864">int</span>&nbsp;<span class="op" id="2839868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2839871">for</span>&nbsp;<span class="ident" id="2839875">i</span><span class="op" id="2839876">,</span>&nbsp;<span class="ident" id="2839878">t</span>&nbsp;<span class="op" id="2839880">:=</span>&nbsp;<span class="keyword" id="2839883">range</span>&nbsp;<span class="ident" id="2839889">strs</span>&nbsp;<span class="op" id="2839894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2839898">if</span>&nbsp;<span class="ident" id="2839901">eq</span><span class="op" id="2839903">(</span><span class="ident" id="2839904">s</span><span class="op" id="2839905">,</span>&nbsp;<span class="ident" id="2839907">t</span><span class="op" id="2839908">)</span>&nbsp;<span class="op" id="2839910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2839915">return</span>&nbsp;<span class="ident" id="2839922">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2839926">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2839929">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2839932">return</span>&nbsp;<span class="op" id="2839939">-</span><span class="num" id="2839940">1</span><br>
<span class="lineno"></span><span class="op" id="2839942">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2839945">//&nbsp;escFnsEq&nbsp;reports&nbsp;whether&nbsp;the&nbsp;two&nbsp;escaping&nbsp;functions&nbsp;are&nbsp;equivalent.</span><br>
<span class="lineno">320</span><span class="keyword" id="2840016">func</span>&nbsp;<span class="ident" id="2840021">escFnsEq</span><span class="op" id="2840029">(</span><span class="ident" id="2840030">a</span><span class="op" id="2840031">,</span>&nbsp;<span class="ident" id="2840033">b</span>&nbsp;<span class="builtintype" id="2840035">string</span><span class="op" id="2840041">)</span>&nbsp;<span class="builtintype" id="2840043">bool</span>&nbsp;<span class="op" id="2840048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2840051">if</span>&nbsp;<span class="ident" id="2840054">e</span>&nbsp;<span class="op" id="2840056">:=</span>&nbsp;<span class="ident" id="2840059">equivEscapers</span><span class="op" id="2840072">[</span><span class="ident" id="2840073">a</span><span class="op" id="2840074">]</span><span class="op" id="2840075">;</span>&nbsp;<span class="ident" id="2840077">e</span>&nbsp;<span class="op" id="2840079">!=</span>&nbsp;<span class="string" id="2840082">&#34;&#34;</span>&nbsp;<span class="op" id="2840085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2840089">a</span>&nbsp;<span class="op" id="2840091">=</span>&nbsp;<span class="ident" id="2840093">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2840096">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2840099">if</span>&nbsp;<span class="ident" id="2840102">e</span>&nbsp;<span class="op" id="2840104">:=</span>&nbsp;<span class="ident" id="2840107">equivEscapers</span><span class="op" id="2840120">[</span><span class="ident" id="2840121">b</span><span class="op" id="2840122">]</span><span class="op" id="2840123">;</span>&nbsp;<span class="ident" id="2840125">e</span>&nbsp;<span class="op" id="2840127">!=</span>&nbsp;<span class="string" id="2840130">&#34;&#34;</span>&nbsp;<span class="op" id="2840133">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2840137">b</span>&nbsp;<span class="op" id="2840139">=</span>&nbsp;<span class="ident" id="2840141">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2840144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2840147">return</span>&nbsp;<span class="ident" id="2840154">a</span>&nbsp;<span class="op" id="2840156">==</span>&nbsp;<span class="ident" id="2840159">b</span><br>
<span class="lineno"></span><span class="op" id="2840161">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span><span class="comment" id="2840164">//&nbsp;newIdentCmd&nbsp;produces&nbsp;a&nbsp;command&nbsp;containing&nbsp;a&nbsp;single&nbsp;identifier&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="2840235">func</span>&nbsp;<span class="ident" id="2840240">newIdentCmd</span><span class="op" id="2840251">(</span><span class="ident" id="2840252">identifier</span>&nbsp;<span class="builtintype" id="2840263">string</span><span class="op" id="2840269">,</span>&nbsp;<span class="ident" id="2840271">pos</span>&nbsp;<span class="ident" id="2840275">parse</span><span class="op" id="2840280">.</span><span class="ident" id="2840281">Pos</span><span class="op" id="2840284">)</span>&nbsp;<span class="op" id="2840286">*</span><span class="ident" id="2840287">parse</span><span class="op" id="2840292">.</span><span class="ident" id="2840293">CommandNode</span>&nbsp;<span class="op" id="2840305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2840308">return</span>&nbsp;<span class="op" id="2840315">&amp;</span><span class="ident" id="2840316">parse</span><span class="op" id="2840321">.</span><span class="ident" id="2840322">CommandNode</span><span class="op" id="2840333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2840337">NodeType</span><span class="op" id="2840345">:</span>&nbsp;<span class="ident" id="2840347">parse</span><span class="op" id="2840352">.</span><span class="ident" id="2840353">NodeCommand</span><span class="op" id="2840364">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2840368">Args</span><span class="op" id="2840372">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2840378">[</span><span class="op" id="2840379">]</span><span class="ident" id="2840380">parse</span><span class="op" id="2840385">.</span><span class="ident" id="2840386">Node</span><span class="op" id="2840390">{</span><span class="ident" id="2840391">parse</span><span class="op" id="2840396">.</span><span class="ident" id="2840397">NewIdentifier</span><span class="op" id="2840410">(</span><span class="ident" id="2840411">identifier</span><span class="op" id="2840421">)</span><span class="op" id="2840422">.</span><span class="ident" id="2840423">SetTree</span><span class="op" id="2840430">(</span><span class="ident" id="2840431">nil</span><span class="op" id="2840434">)</span><span class="op" id="2840435">.</span><span class="ident" id="2840436">SetPos</span><span class="op" id="2840442">(</span><span class="ident" id="2840443">pos</span><span class="op" id="2840446">)</span><span class="op" id="2840447">}</span><span class="op" id="2840448">,</span>&nbsp;<span class="comment" id="2840450">//&nbsp;TODO:&nbsp;SetTree.</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2840469">}</span><br>
<span class="lineno"></span><span class="op" id="2840471">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2840474">//&nbsp;nudge&nbsp;returns&nbsp;the&nbsp;context&nbsp;that&nbsp;would&nbsp;result&nbsp;from&nbsp;following&nbsp;empty&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="2840549">//&nbsp;transitions&nbsp;from&nbsp;the&nbsp;input&nbsp;context.</span><br>
<span class="lineno">340</span><span class="comment" id="2840588">//&nbsp;For&nbsp;example,&nbsp;parsing:</span><br>
<span class="lineno"></span><span class="comment" id="2840613">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`&lt;a&nbsp;href=`</span><br>
<span class="lineno"></span><span class="comment" id="2840631">//&nbsp;will&nbsp;end&nbsp;in&nbsp;context{stateBeforeValue,&nbsp;attrURL},&nbsp;but&nbsp;parsing&nbsp;one&nbsp;extra&nbsp;rune:</span><br>
<span class="lineno"></span><span class="comment" id="2840710">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`&lt;a&nbsp;href=x`</span><br>
<span class="lineno"></span><span class="comment" id="2840729">//&nbsp;will&nbsp;end&nbsp;in&nbsp;context{stateURL,&nbsp;delimSpaceOrTagEnd,&nbsp;...}.</span><br>
<span class="lineno">345</span><span class="comment" id="2840788">//&nbsp;There&nbsp;are&nbsp;two&nbsp;transitions&nbsp;that&nbsp;happen&nbsp;when&nbsp;the&nbsp;&#39;x&#39;&nbsp;is&nbsp;seen:</span><br>
<span class="lineno"></span><span class="comment" id="2840851">//&nbsp;(1)&nbsp;Transition&nbsp;from&nbsp;a&nbsp;before-value&nbsp;state&nbsp;to&nbsp;a&nbsp;start-of-value&nbsp;state&nbsp;without</span><br>
<span class="lineno"></span><span class="comment" id="2840929">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;consuming&nbsp;any&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="2840961">//&nbsp;(2)&nbsp;Consume&nbsp;&#39;x&#39;&nbsp;and&nbsp;transition&nbsp;past&nbsp;the&nbsp;first&nbsp;value&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="2841027">//&nbsp;In&nbsp;this&nbsp;case,&nbsp;nudging&nbsp;produces&nbsp;the&nbsp;context&nbsp;after&nbsp;(1)&nbsp;happens.</span><br>
<span class="lineno">350</span><span class="keyword" id="2841092">func</span>&nbsp;<span class="ident" id="2841097">nudge</span><span class="op" id="2841102">(</span><span class="ident" id="2841103">c</span>&nbsp;<span class="ident" id="2841105">context</span><span class="op" id="2841112">)</span>&nbsp;<span class="ident" id="2841114">context</span>&nbsp;<span class="op" id="2841122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2841125">switch</span>&nbsp;<span class="ident" id="2841132">c</span><span class="op" id="2841133">.</span><span class="ident" id="2841134">state</span>&nbsp;<span class="op" id="2841140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2841143">case</span>&nbsp;<span class="ident" id="2841148">stateTag</span><span class="op" id="2841156">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2841160">//&nbsp;In&nbsp;`&lt;foo&nbsp;{{.}}`,&nbsp;the&nbsp;action&nbsp;should&nbsp;emit&nbsp;an&nbsp;attribute.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2841219">c</span><span class="op" id="2841220">.</span><span class="ident" id="2841221">state</span>&nbsp;<span class="op" id="2841227">=</span>&nbsp;<span class="ident" id="2841229">stateAttrName</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2841244">case</span>&nbsp;<span class="ident" id="2841249">stateBeforeValue</span><span class="op" id="2841265">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2841269">//&nbsp;In&nbsp;`&lt;foo&nbsp;bar={{.}}`,&nbsp;the&nbsp;action&nbsp;is&nbsp;an&nbsp;undelimited&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2841331">c</span><span class="op" id="2841332">.</span><span class="ident" id="2841333">state</span><span class="op" id="2841338">,</span>&nbsp;<span class="ident" id="2841340">c</span><span class="op" id="2841341">.</span><span class="ident" id="2841342">delim</span><span class="op" id="2841347">,</span>&nbsp;<span class="ident" id="2841349">c</span><span class="op" id="2841350">.</span><span class="ident" id="2841351">attr</span>&nbsp;<span class="op" id="2841356">=</span>&nbsp;<span class="ident" id="2841358">attrStartStates</span><span class="op" id="2841373">[</span><span class="ident" id="2841374">c</span><span class="op" id="2841375">.</span><span class="ident" id="2841376">attr</span><span class="op" id="2841380">]</span><span class="op" id="2841381">,</span>&nbsp;<span class="ident" id="2841383">delimSpaceOrTagEnd</span><span class="op" id="2841401">,</span>&nbsp;<span class="ident" id="2841403">attrNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2841413">case</span>&nbsp;<span class="ident" id="2841418">stateAfterName</span><span class="op" id="2841432">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2841436">//&nbsp;In&nbsp;`&lt;foo&nbsp;bar&nbsp;{{.}}`,&nbsp;the&nbsp;action&nbsp;is&nbsp;an&nbsp;attribute&nbsp;name.</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2841495">c</span><span class="op" id="2841496">.</span><span class="ident" id="2841497">state</span><span class="op" id="2841502">,</span>&nbsp;<span class="ident" id="2841504">c</span><span class="op" id="2841505">.</span><span class="ident" id="2841506">attr</span>&nbsp;<span class="op" id="2841511">=</span>&nbsp;<span class="ident" id="2841513">stateAttrName</span><span class="op" id="2841526">,</span>&nbsp;<span class="ident" id="2841528">attrNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2841538">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2841541">return</span>&nbsp;<span class="ident" id="2841548">c</span><br>
<span class="lineno"></span><span class="op" id="2841550">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="comment" id="2841553">//&nbsp;join&nbsp;joins&nbsp;the&nbsp;two&nbsp;contexts&nbsp;of&nbsp;a&nbsp;branch&nbsp;template&nbsp;node.&nbsp;The&nbsp;result&nbsp;is&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="2841628">//&nbsp;error&nbsp;context&nbsp;if&nbsp;either&nbsp;of&nbsp;the&nbsp;input&nbsp;contexts&nbsp;are&nbsp;error&nbsp;contexts,&nbsp;or&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2841707">//&nbsp;the&nbsp;input&nbsp;contexts&nbsp;differ.</span><br>
<span class="lineno"></span><span class="keyword" id="2841737">func</span>&nbsp;<span class="ident" id="2841742">join</span><span class="op" id="2841746">(</span><span class="ident" id="2841747">a</span><span class="op" id="2841748">,</span>&nbsp;<span class="ident" id="2841750">b</span>&nbsp;<span class="ident" id="2841752">context</span><span class="op" id="2841759">,</span>&nbsp;<span class="ident" id="2841761">node</span>&nbsp;<span class="ident" id="2841766">parse</span><span class="op" id="2841771">.</span><span class="ident" id="2841772">Node</span><span class="op" id="2841776">,</span>&nbsp;<span class="ident" id="2841778">nodeName</span>&nbsp;<span class="builtintype" id="2841787">string</span><span class="op" id="2841793">)</span>&nbsp;<span class="ident" id="2841795">context</span>&nbsp;<span class="op" id="2841803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2841806">if</span>&nbsp;<span class="ident" id="2841809">a</span><span class="op" id="2841810">.</span><span class="ident" id="2841811">state</span>&nbsp;<span class="op" id="2841817">==</span>&nbsp;<span class="ident" id="2841820">stateError</span>&nbsp;<span class="op" id="2841831">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2841835">return</span>&nbsp;<span class="ident" id="2841842">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2841845">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2841848">if</span>&nbsp;<span class="ident" id="2841851">b</span><span class="op" id="2841852">.</span><span class="ident" id="2841853">state</span>&nbsp;<span class="op" id="2841859">==</span>&nbsp;<span class="ident" id="2841862">stateError</span>&nbsp;<span class="op" id="2841873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2841877">return</span>&nbsp;<span class="ident" id="2841884">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2841887">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2841890">if</span>&nbsp;<span class="ident" id="2841893">a</span><span class="op" id="2841894">.</span><span class="ident" id="2841895">eq</span><span class="op" id="2841897">(</span><span class="ident" id="2841898">b</span><span class="op" id="2841899">)</span>&nbsp;<span class="op" id="2841901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2841905">return</span>&nbsp;<span class="ident" id="2841912">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2841915">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2841919">c</span>&nbsp;<span class="op" id="2841921">:=</span>&nbsp;<span class="ident" id="2841924">a</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2841927">c</span><span class="op" id="2841928">.</span><span class="ident" id="2841929">urlPart</span>&nbsp;<span class="op" id="2841937">=</span>&nbsp;<span class="ident" id="2841939">b</span><span class="op" id="2841940">.</span><span class="ident" id="2841941">urlPart</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2841950">if</span>&nbsp;<span class="ident" id="2841953">c</span><span class="op" id="2841954">.</span><span class="ident" id="2841955">eq</span><span class="op" id="2841957">(</span><span class="ident" id="2841958">b</span><span class="op" id="2841959">)</span>&nbsp;<span class="op" id="2841961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2841965">//&nbsp;The&nbsp;contexts&nbsp;differ&nbsp;only&nbsp;by&nbsp;urlPart.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2842007">c</span><span class="op" id="2842008">.</span><span class="ident" id="2842009">urlPart</span>&nbsp;<span class="op" id="2842017">=</span>&nbsp;<span class="ident" id="2842019">urlPartUnknown</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2842036">return</span>&nbsp;<span class="ident" id="2842043">c</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2842046">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2842050">c</span>&nbsp;<span class="op" id="2842052">=</span>&nbsp;<span class="ident" id="2842054">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2842057">c</span><span class="op" id="2842058">.</span><span class="ident" id="2842059">jsCtx</span>&nbsp;<span class="op" id="2842065">=</span>&nbsp;<span class="ident" id="2842067">b</span><span class="op" id="2842068">.</span><span class="ident" id="2842069">jsCtx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2842076">if</span>&nbsp;<span class="ident" id="2842079">c</span><span class="op" id="2842080">.</span><span class="ident" id="2842081">eq</span><span class="op" id="2842083">(</span><span class="ident" id="2842084">b</span><span class="op" id="2842085">)</span>&nbsp;<span class="op" id="2842087">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2842091">//&nbsp;The&nbsp;contexts&nbsp;differ&nbsp;only&nbsp;by&nbsp;jsCtx.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2842131">c</span><span class="op" id="2842132">.</span><span class="ident" id="2842133">jsCtx</span>&nbsp;<span class="op" id="2842139">=</span>&nbsp;<span class="ident" id="2842141">jsCtxUnknown</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2842156">return</span>&nbsp;<span class="ident" id="2842163">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2842166">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2842170">//&nbsp;Allow&nbsp;a&nbsp;nudged&nbsp;context&nbsp;to&nbsp;join&nbsp;with&nbsp;an&nbsp;unnudged&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2842227">//&nbsp;This&nbsp;means&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2842247">//&nbsp;&nbsp;&nbsp;&lt;p&nbsp;title={{if&nbsp;.C}}{{.}}{{end}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2842284">//&nbsp;ends&nbsp;in&nbsp;an&nbsp;unquoted&nbsp;value&nbsp;state&nbsp;even&nbsp;though&nbsp;the&nbsp;else&nbsp;branch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2842348">//&nbsp;ends&nbsp;in&nbsp;stateBeforeValue.</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2842378">if</span>&nbsp;<span class="ident" id="2842381">c</span><span class="op" id="2842382">,</span>&nbsp;<span class="ident" id="2842384">d</span>&nbsp;<span class="op" id="2842386">:=</span>&nbsp;<span class="ident" id="2842389">nudge</span><span class="op" id="2842394">(</span><span class="ident" id="2842395">a</span><span class="op" id="2842396">)</span><span class="op" id="2842397">,</span>&nbsp;<span class="ident" id="2842399">nudge</span><span class="op" id="2842404">(</span><span class="ident" id="2842405">b</span><span class="op" id="2842406">)</span><span class="op" id="2842407">;</span>&nbsp;<span class="op" id="2842409">!</span><span class="op" id="2842410">(</span><span class="ident" id="2842411">c</span><span class="op" id="2842412">.</span><span class="ident" id="2842413">eq</span><span class="op" id="2842415">(</span><span class="ident" id="2842416">a</span><span class="op" id="2842417">)</span>&nbsp;<span class="op" id="2842419">&amp;&amp;</span>&nbsp;<span class="ident" id="2842422">d</span><span class="op" id="2842423">.</span><span class="ident" id="2842424">eq</span><span class="op" id="2842426">(</span><span class="ident" id="2842427">b</span><span class="op" id="2842428">)</span><span class="op" id="2842429">)</span>&nbsp;<span class="op" id="2842431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2842435">if</span>&nbsp;<span class="ident" id="2842438">e</span>&nbsp;<span class="op" id="2842440">:=</span>&nbsp;<span class="ident" id="2842443">join</span><span class="op" id="2842447">(</span><span class="ident" id="2842448">c</span><span class="op" id="2842449">,</span>&nbsp;<span class="ident" id="2842451">d</span><span class="op" id="2842452">,</span>&nbsp;<span class="ident" id="2842454">node</span><span class="op" id="2842458">,</span>&nbsp;<span class="ident" id="2842460">nodeName</span><span class="op" id="2842468">)</span><span class="op" id="2842469">;</span>&nbsp;<span class="ident" id="2842471">e</span><span class="op" id="2842472">.</span><span class="ident" id="2842473">state</span>&nbsp;<span class="op" id="2842479">!=</span>&nbsp;<span class="ident" id="2842482">stateError</span>&nbsp;<span class="op" id="2842493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2842498">return</span>&nbsp;<span class="ident" id="2842505">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2842509">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2842512">}</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2842516">return</span>&nbsp;<span class="ident" id="2842523">context</span><span class="op" id="2842530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2842534">state</span><span class="op" id="2842539">:</span>&nbsp;<span class="ident" id="2842541">stateError</span><span class="op" id="2842551">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2842555">err</span><span class="op" id="2842558">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2842562">errorf</span><span class="op" id="2842568">(</span><span class="ident" id="2842569">ErrBranchEnd</span><span class="op" id="2842581">,</span>&nbsp;<span class="ident" id="2842583">node</span><span class="op" id="2842587">,</span>&nbsp;<span class="num" id="2842589">0</span><span class="op" id="2842590">,</span>&nbsp;<span class="string" id="2842592">&#34;{{%s}}&nbsp;branches&nbsp;end&nbsp;in&nbsp;different&nbsp;contexts:&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="2842643">,</span>&nbsp;<span class="ident" id="2842645">nodeName</span><span class="op" id="2842653">,</span>&nbsp;<span class="ident" id="2842655">a</span><span class="op" id="2842656">,</span>&nbsp;<span class="ident" id="2842658">b</span><span class="op" id="2842659">)</span><span class="op" id="2842660">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2842663">}</span><br>
<span class="lineno">410</span><span class="op" id="2842665">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2842668">//&nbsp;escapeBranch&nbsp;escapes&nbsp;a&nbsp;branch&nbsp;template&nbsp;node:&nbsp;&#34;if&#34;,&nbsp;&#34;range&#34;&nbsp;and&nbsp;&#34;with&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="2842742">func</span>&nbsp;<span class="op" id="2842747">(</span><span class="ident" id="2842748">e</span>&nbsp;<span class="op" id="2842750">*</span><span class="ident" id="2842751">escaper</span><span class="op" id="2842758">)</span>&nbsp;<span class="ident" id="2842760">escapeBranch</span><span class="op" id="2842772">(</span><span class="ident" id="2842773">c</span>&nbsp;<span class="ident" id="2842775">context</span><span class="op" id="2842782">,</span>&nbsp;<span class="ident" id="2842784">n</span>&nbsp;<span class="op" id="2842786">*</span><span class="ident" id="2842787">parse</span><span class="op" id="2842792">.</span><span class="ident" id="2842793">BranchNode</span><span class="op" id="2842803">,</span>&nbsp;<span class="ident" id="2842805">nodeName</span>&nbsp;<span class="builtintype" id="2842814">string</span><span class="op" id="2842820">)</span>&nbsp;<span class="ident" id="2842822">context</span>&nbsp;<span class="op" id="2842830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2842833">c0</span>&nbsp;<span class="op" id="2842836">:=</span>&nbsp;<span class="ident" id="2842839">e</span><span class="op" id="2842840">.</span><span class="ident" id="2842841">escapeList</span><span class="op" id="2842851">(</span><span class="ident" id="2842852">c</span><span class="op" id="2842853">,</span>&nbsp;<span class="ident" id="2842855">n</span><span class="op" id="2842856">.</span><span class="ident" id="2842857">List</span><span class="op" id="2842861">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2842864">if</span>&nbsp;<span class="ident" id="2842867">nodeName</span>&nbsp;<span class="op" id="2842876">==</span>&nbsp;<span class="string" id="2842879">&#34;range&#34;</span>&nbsp;<span class="op" id="2842887">&amp;&amp;</span>&nbsp;<span class="ident" id="2842890">c0</span><span class="op" id="2842892">.</span><span class="ident" id="2842893">state</span>&nbsp;<span class="op" id="2842899">!=</span>&nbsp;<span class="ident" id="2842902">stateError</span>&nbsp;<span class="op" id="2842913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2842917">//&nbsp;The&nbsp;&#34;true&#34;&nbsp;branch&nbsp;of&nbsp;a&nbsp;&#34;range&#34;&nbsp;node&nbsp;can&nbsp;execute&nbsp;multiple&nbsp;times.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2842986">//&nbsp;We&nbsp;check&nbsp;that&nbsp;executing&nbsp;n.List&nbsp;once&nbsp;results&nbsp;in&nbsp;the&nbsp;same&nbsp;context</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2843055">//&nbsp;as&nbsp;executing&nbsp;n.List&nbsp;twice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2843087">c1</span><span class="op" id="2843089">,</span>&nbsp;<span class="ident" id="2843091">_</span>&nbsp;<span class="op" id="2843093">:=</span>&nbsp;<span class="ident" id="2843096">e</span><span class="op" id="2843097">.</span><span class="ident" id="2843098">escapeListConditionally</span><span class="op" id="2843121">(</span><span class="ident" id="2843122">c0</span><span class="op" id="2843124">,</span>&nbsp;<span class="ident" id="2843126">n</span><span class="op" id="2843127">.</span><span class="ident" id="2843128">List</span><span class="op" id="2843132">,</span>&nbsp;<span class="ident" id="2843134">nil</span><span class="op" id="2843137">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2843141">c0</span>&nbsp;<span class="op" id="2843144">=</span>&nbsp;<span class="ident" id="2843146">join</span><span class="op" id="2843150">(</span><span class="ident" id="2843151">c0</span><span class="op" id="2843153">,</span>&nbsp;<span class="ident" id="2843155">c1</span><span class="op" id="2843157">,</span>&nbsp;<span class="ident" id="2843159">n</span><span class="op" id="2843160">,</span>&nbsp;<span class="ident" id="2843162">nodeName</span><span class="op" id="2843170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2843174">if</span>&nbsp;<span class="ident" id="2843177">c0</span><span class="op" id="2843179">.</span><span class="ident" id="2843180">state</span>&nbsp;<span class="op" id="2843186">==</span>&nbsp;<span class="ident" id="2843189">stateError</span>&nbsp;<span class="op" id="2843200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2843205">//&nbsp;Make&nbsp;clear&nbsp;that&nbsp;this&nbsp;is&nbsp;a&nbsp;problem&nbsp;on&nbsp;loop&nbsp;re-entry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2843262">//&nbsp;since&nbsp;developers&nbsp;tend&nbsp;to&nbsp;overlook&nbsp;that&nbsp;branch&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2843319">//&nbsp;debugging&nbsp;templates.</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2843346">c0</span><span class="op" id="2843348">.</span><span class="ident" id="2843349">err</span><span class="op" id="2843352">.</span><span class="ident" id="2843353">Line</span>&nbsp;<span class="op" id="2843358">=</span>&nbsp;<span class="ident" id="2843360">n</span><span class="op" id="2843361">.</span><span class="ident" id="2843362">Line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2843370">c0</span><span class="op" id="2843372">.</span><span class="ident" id="2843373">err</span><span class="op" id="2843376">.</span><span class="ident" id="2843377">Description</span>&nbsp;<span class="op" id="2843389">=</span>&nbsp;<span class="string" id="2843391">&#34;on&nbsp;range&nbsp;loop&nbsp;re-entry:&nbsp;&#34;</span>&nbsp;<span class="op" id="2843418">+</span>&nbsp;<span class="ident" id="2843420">c0</span><span class="op" id="2843422">.</span><span class="ident" id="2843423">err</span><span class="op" id="2843426">.</span><span class="ident" id="2843427">Description</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2843442">return</span>&nbsp;<span class="ident" id="2843449">c0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2843454">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2843457">}</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2843460">c1</span>&nbsp;<span class="op" id="2843463">:=</span>&nbsp;<span class="ident" id="2843466">e</span><span class="op" id="2843467">.</span><span class="ident" id="2843468">escapeList</span><span class="op" id="2843478">(</span><span class="ident" id="2843479">c</span><span class="op" id="2843480">,</span>&nbsp;<span class="ident" id="2843482">n</span><span class="op" id="2843483">.</span><span class="ident" id="2843484">ElseList</span><span class="op" id="2843492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2843495">return</span>&nbsp;<span class="ident" id="2843502">join</span><span class="op" id="2843506">(</span><span class="ident" id="2843507">c0</span><span class="op" id="2843509">,</span>&nbsp;<span class="ident" id="2843511">c1</span><span class="op" id="2843513">,</span>&nbsp;<span class="ident" id="2843515">n</span><span class="op" id="2843516">,</span>&nbsp;<span class="ident" id="2843518">nodeName</span><span class="op" id="2843526">)</span><br>
<span class="lineno"></span><span class="op" id="2843528">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2843531">//&nbsp;escapeList&nbsp;escapes&nbsp;a&nbsp;list&nbsp;template&nbsp;node.</span><br>
<span class="lineno">435</span><span class="keyword" id="2843575">func</span>&nbsp;<span class="op" id="2843580">(</span><span class="ident" id="2843581">e</span>&nbsp;<span class="op" id="2843583">*</span><span class="ident" id="2843584">escaper</span><span class="op" id="2843591">)</span>&nbsp;<span class="ident" id="2843593">escapeList</span><span class="op" id="2843603">(</span><span class="ident" id="2843604">c</span>&nbsp;<span class="ident" id="2843606">context</span><span class="op" id="2843613">,</span>&nbsp;<span class="ident" id="2843615">n</span>&nbsp;<span class="op" id="2843617">*</span><span class="ident" id="2843618">parse</span><span class="op" id="2843623">.</span><span class="ident" id="2843624">ListNode</span><span class="op" id="2843632">)</span>&nbsp;<span class="ident" id="2843634">context</span>&nbsp;<span class="op" id="2843642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2843645">if</span>&nbsp;<span class="ident" id="2843648">n</span>&nbsp;<span class="op" id="2843650">==</span>&nbsp;<span class="ident" id="2843653">nil</span>&nbsp;<span class="op" id="2843657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2843661">return</span>&nbsp;<span class="ident" id="2843668">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2843671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2843674">for</span>&nbsp;<span class="ident" id="2843678">_</span><span class="op" id="2843679">,</span>&nbsp;<span class="ident" id="2843681">m</span>&nbsp;<span class="op" id="2843683">:=</span>&nbsp;<span class="keyword" id="2843686">range</span>&nbsp;<span class="ident" id="2843692">n</span><span class="op" id="2843693">.</span><span class="ident" id="2843694">Nodes</span>&nbsp;<span class="op" id="2843700">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2843704">c</span>&nbsp;<span class="op" id="2843706">=</span>&nbsp;<span class="ident" id="2843708">e</span><span class="op" id="2843709">.</span><span class="ident" id="2843710">escape</span><span class="op" id="2843716">(</span><span class="ident" id="2843717">c</span><span class="op" id="2843718">,</span>&nbsp;<span class="ident" id="2843720">m</span><span class="op" id="2843721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2843724">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2843727">return</span>&nbsp;<span class="ident" id="2843734">c</span><br>
<span class="lineno"></span><span class="op" id="2843736">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span><span class="comment" id="2843739">//&nbsp;escapeListConditionally&nbsp;escapes&nbsp;a&nbsp;list&nbsp;node&nbsp;but&nbsp;only&nbsp;preserves&nbsp;edits&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="2843815">//&nbsp;inferences&nbsp;in&nbsp;e&nbsp;if&nbsp;the&nbsp;inferences&nbsp;and&nbsp;output&nbsp;context&nbsp;satisfy&nbsp;filter.</span><br>
<span class="lineno"></span><span class="comment" id="2843887">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;best&nbsp;guess&nbsp;at&nbsp;an&nbsp;output&nbsp;context,&nbsp;and&nbsp;the&nbsp;result&nbsp;of&nbsp;the&nbsp;filter</span><br>
<span class="lineno"></span><span class="comment" id="2843967">//&nbsp;which&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;whether&nbsp;e&nbsp;was&nbsp;updated.</span><br>
<span class="lineno"></span><span class="keyword" id="2844014">func</span>&nbsp;<span class="op" id="2844019">(</span><span class="ident" id="2844020">e</span>&nbsp;<span class="op" id="2844022">*</span><span class="ident" id="2844023">escaper</span><span class="op" id="2844030">)</span>&nbsp;<span class="ident" id="2844032">escapeListConditionally</span><span class="op" id="2844055">(</span><span class="ident" id="2844056">c</span>&nbsp;<span class="ident" id="2844058">context</span><span class="op" id="2844065">,</span>&nbsp;<span class="ident" id="2844067">n</span>&nbsp;<span class="op" id="2844069">*</span><span class="ident" id="2844070">parse</span><span class="op" id="2844075">.</span><span class="ident" id="2844076">ListNode</span><span class="op" id="2844084">,</span>&nbsp;<span class="ident" id="2844086">filter</span>&nbsp;<span class="keyword" id="2844093">func</span><span class="op" id="2844097">(</span><span class="op" id="2844098">*</span><span class="ident" id="2844099">escaper</span><span class="op" id="2844106">,</span>&nbsp;<span class="ident" id="2844108">context</span><span class="op" id="2844115">)</span>&nbsp;<span class="builtintype" id="2844117">bool</span><span class="op" id="2844121">)</span>&nbsp;<span class="op" id="2844123">(</span><span class="ident" id="2844124">context</span><span class="op" id="2844131">,</span>&nbsp;<span class="builtintype" id="2844133">bool</span><span class="op" id="2844137">)</span>&nbsp;<span class="op" id="2844139">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2844142">e1</span>&nbsp;<span class="op" id="2844145">:=</span>&nbsp;<span class="ident" id="2844148">newEscaper</span><span class="op" id="2844158">(</span><span class="ident" id="2844159">e</span><span class="op" id="2844160">.</span><span class="ident" id="2844161">tmpl</span><span class="op" id="2844165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2844168">//&nbsp;Make&nbsp;type&nbsp;inferences&nbsp;available&nbsp;to&nbsp;f.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2844209">for</span>&nbsp;<span class="ident" id="2844213">k</span><span class="op" id="2844214">,</span>&nbsp;<span class="ident" id="2844216">v</span>&nbsp;<span class="op" id="2844218">:=</span>&nbsp;<span class="keyword" id="2844221">range</span>&nbsp;<span class="ident" id="2844227">e</span><span class="op" id="2844228">.</span><span class="ident" id="2844229">output</span>&nbsp;<span class="op" id="2844236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2844240">e1</span><span class="op" id="2844242">.</span><span class="ident" id="2844243">output</span><span class="op" id="2844249">[</span><span class="ident" id="2844250">k</span><span class="op" id="2844251">]</span>&nbsp;<span class="op" id="2844253">=</span>&nbsp;<span class="ident" id="2844255">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2844258">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2844261">c</span>&nbsp;<span class="op" id="2844263">=</span>&nbsp;<span class="ident" id="2844265">e1</span><span class="op" id="2844267">.</span><span class="ident" id="2844268">escapeList</span><span class="op" id="2844278">(</span><span class="ident" id="2844279">c</span><span class="op" id="2844280">,</span>&nbsp;<span class="ident" id="2844282">n</span><span class="op" id="2844283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2844286">ok</span>&nbsp;<span class="op" id="2844289">:=</span>&nbsp;<span class="ident" id="2844292">filter</span>&nbsp;<span class="op" id="2844299">!=</span>&nbsp;<span class="ident" id="2844302">nil</span>&nbsp;<span class="op" id="2844306">&amp;&amp;</span>&nbsp;<span class="ident" id="2844309">filter</span><span class="op" id="2844315">(</span><span class="ident" id="2844316">e1</span><span class="op" id="2844318">,</span>&nbsp;<span class="ident" id="2844320">c</span><span class="op" id="2844321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2844324">if</span>&nbsp;<span class="ident" id="2844327">ok</span>&nbsp;<span class="op" id="2844330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2844334">//&nbsp;Copy&nbsp;inferences&nbsp;and&nbsp;edits&nbsp;from&nbsp;e1&nbsp;back&nbsp;into&nbsp;e.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2844386">for</span>&nbsp;<span class="ident" id="2844390">k</span><span class="op" id="2844391">,</span>&nbsp;<span class="ident" id="2844393">v</span>&nbsp;<span class="op" id="2844395">:=</span>&nbsp;<span class="keyword" id="2844398">range</span>&nbsp;<span class="ident" id="2844404">e1</span><span class="op" id="2844406">.</span><span class="ident" id="2844407">output</span>&nbsp;<span class="op" id="2844414">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2844419">e</span><span class="op" id="2844420">.</span><span class="ident" id="2844421">output</span><span class="op" id="2844427">[</span><span class="ident" id="2844428">k</span><span class="op" id="2844429">]</span>&nbsp;<span class="op" id="2844431">=</span>&nbsp;<span class="ident" id="2844433">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2844437">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2844441">for</span>&nbsp;<span class="ident" id="2844445">k</span><span class="op" id="2844446">,</span>&nbsp;<span class="ident" id="2844448">v</span>&nbsp;<span class="op" id="2844450">:=</span>&nbsp;<span class="keyword" id="2844453">range</span>&nbsp;<span class="ident" id="2844459">e1</span><span class="op" id="2844461">.</span><span class="ident" id="2844462">derived</span>&nbsp;<span class="op" id="2844470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2844475">e</span><span class="op" id="2844476">.</span><span class="ident" id="2844477">derived</span><span class="op" id="2844484">[</span><span class="ident" id="2844485">k</span><span class="op" id="2844486">]</span>&nbsp;<span class="op" id="2844488">=</span>&nbsp;<span class="ident" id="2844490">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2844494">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2844498">for</span>&nbsp;<span class="ident" id="2844502">k</span><span class="op" id="2844503">,</span>&nbsp;<span class="ident" id="2844505">v</span>&nbsp;<span class="op" id="2844507">:=</span>&nbsp;<span class="keyword" id="2844510">range</span>&nbsp;<span class="ident" id="2844516">e1</span><span class="op" id="2844518">.</span><span class="ident" id="2844519">called</span>&nbsp;<span class="op" id="2844526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2844531">e</span><span class="op" id="2844532">.</span><span class="ident" id="2844533">called</span><span class="op" id="2844539">[</span><span class="ident" id="2844540">k</span><span class="op" id="2844541">]</span>&nbsp;<span class="op" id="2844543">=</span>&nbsp;<span class="ident" id="2844545">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2844549">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2844553">for</span>&nbsp;<span class="ident" id="2844557">k</span><span class="op" id="2844558">,</span>&nbsp;<span class="ident" id="2844560">v</span>&nbsp;<span class="op" id="2844562">:=</span>&nbsp;<span class="keyword" id="2844565">range</span>&nbsp;<span class="ident" id="2844571">e1</span><span class="op" id="2844573">.</span><span class="ident" id="2844574">actionNodeEdits</span>&nbsp;<span class="op" id="2844590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2844595">e</span><span class="op" id="2844596">.</span><span class="ident" id="2844597">editActionNode</span><span class="op" id="2844611">(</span><span class="ident" id="2844612">k</span><span class="op" id="2844613">,</span>&nbsp;<span class="ident" id="2844615">v</span><span class="op" id="2844616">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2844620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2844624">for</span>&nbsp;<span class="ident" id="2844628">k</span><span class="op" id="2844629">,</span>&nbsp;<span class="ident" id="2844631">v</span>&nbsp;<span class="op" id="2844633">:=</span>&nbsp;<span class="keyword" id="2844636">range</span>&nbsp;<span class="ident" id="2844642">e1</span><span class="op" id="2844644">.</span><span class="ident" id="2844645">templateNodeEdits</span>&nbsp;<span class="op" id="2844663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2844668">e</span><span class="op" id="2844669">.</span><span class="ident" id="2844670">editTemplateNode</span><span class="op" id="2844686">(</span><span class="ident" id="2844687">k</span><span class="op" id="2844688">,</span>&nbsp;<span class="ident" id="2844690">v</span><span class="op" id="2844691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2844695">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2844699">for</span>&nbsp;<span class="ident" id="2844703">k</span><span class="op" id="2844704">,</span>&nbsp;<span class="ident" id="2844706">v</span>&nbsp;<span class="op" id="2844708">:=</span>&nbsp;<span class="keyword" id="2844711">range</span>&nbsp;<span class="ident" id="2844717">e1</span><span class="op" id="2844719">.</span><span class="ident" id="2844720">textNodeEdits</span>&nbsp;<span class="op" id="2844734">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2844739">e</span><span class="op" id="2844740">.</span><span class="ident" id="2844741">editTextNode</span><span class="op" id="2844753">(</span><span class="ident" id="2844754">k</span><span class="op" id="2844755">,</span>&nbsp;<span class="ident" id="2844757">v</span><span class="op" id="2844758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2844762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2844765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2844768">return</span>&nbsp;<span class="ident" id="2844775">c</span><span class="op" id="2844776">,</span>&nbsp;<span class="ident" id="2844778">ok</span><br>
<span class="lineno"></span><span class="op" id="2844781">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="2844784">//&nbsp;escapeTemplate&nbsp;escapes&nbsp;a&nbsp;{{template}}&nbsp;call&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="2844836">func</span>&nbsp;<span class="op" id="2844841">(</span><span class="ident" id="2844842">e</span>&nbsp;<span class="op" id="2844844">*</span><span class="ident" id="2844845">escaper</span><span class="op" id="2844852">)</span>&nbsp;<span class="ident" id="2844854">escapeTemplate</span><span class="op" id="2844868">(</span><span class="ident" id="2844869">c</span>&nbsp;<span class="ident" id="2844871">context</span><span class="op" id="2844878">,</span>&nbsp;<span class="ident" id="2844880">n</span>&nbsp;<span class="op" id="2844882">*</span><span class="ident" id="2844883">parse</span><span class="op" id="2844888">.</span><span class="ident" id="2844889">TemplateNode</span><span class="op" id="2844901">)</span>&nbsp;<span class="ident" id="2844903">context</span>&nbsp;<span class="op" id="2844911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2844914">c</span><span class="op" id="2844915">,</span>&nbsp;<span class="ident" id="2844917">name</span>&nbsp;<span class="op" id="2844922">:=</span>&nbsp;<span class="ident" id="2844925">e</span><span class="op" id="2844926">.</span><span class="ident" id="2844927">escapeTree</span><span class="op" id="2844937">(</span><span class="ident" id="2844938">c</span><span class="op" id="2844939">,</span>&nbsp;<span class="ident" id="2844941">n</span><span class="op" id="2844942">,</span>&nbsp;<span class="ident" id="2844944">n</span><span class="op" id="2844945">.</span><span class="ident" id="2844946">Name</span><span class="op" id="2844950">,</span>&nbsp;<span class="ident" id="2844952">n</span><span class="op" id="2844953">.</span><span class="ident" id="2844954">Line</span><span class="op" id="2844958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2844961">if</span>&nbsp;<span class="ident" id="2844964">name</span>&nbsp;<span class="op" id="2844969">!=</span>&nbsp;<span class="ident" id="2844972">n</span><span class="op" id="2844973">.</span><span class="ident" id="2844974">Name</span>&nbsp;<span class="op" id="2844979">{</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2844983">e</span><span class="op" id="2844984">.</span><span class="ident" id="2844985">editTemplateNode</span><span class="op" id="2845001">(</span><span class="ident" id="2845002">n</span><span class="op" id="2845003">,</span>&nbsp;<span class="ident" id="2845005">name</span><span class="op" id="2845009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2845012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2845015">return</span>&nbsp;<span class="ident" id="2845022">c</span><br>
<span class="lineno"></span><span class="op" id="2845024">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">490</span><span class="comment" id="2845027">//&nbsp;escapeTree&nbsp;escapes&nbsp;the&nbsp;named&nbsp;template&nbsp;starting&nbsp;in&nbsp;the&nbsp;given&nbsp;context&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="2845101">//&nbsp;necessary&nbsp;and&nbsp;returns&nbsp;its&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span><span class="keyword" id="2845146">func</span>&nbsp;<span class="op" id="2845151">(</span><span class="ident" id="2845152">e</span>&nbsp;<span class="op" id="2845154">*</span><span class="ident" id="2845155">escaper</span><span class="op" id="2845162">)</span>&nbsp;<span class="ident" id="2845164">escapeTree</span><span class="op" id="2845174">(</span><span class="ident" id="2845175">c</span>&nbsp;<span class="ident" id="2845177">context</span><span class="op" id="2845184">,</span>&nbsp;<span class="ident" id="2845186">node</span>&nbsp;<span class="ident" id="2845191">parse</span><span class="op" id="2845196">.</span><span class="ident" id="2845197">Node</span><span class="op" id="2845201">,</span>&nbsp;<span class="ident" id="2845203">name</span>&nbsp;<span class="builtintype" id="2845208">string</span><span class="op" id="2845214">,</span>&nbsp;<span class="ident" id="2845216">line</span>&nbsp;<span class="builtintype" id="2845221">int</span><span class="op" id="2845224">)</span>&nbsp;<span class="op" id="2845226">(</span><span class="ident" id="2845227">context</span><span class="op" id="2845234">,</span>&nbsp;<span class="builtintype" id="2845236">string</span><span class="op" id="2845242">)</span>&nbsp;<span class="op" id="2845244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2845247">//&nbsp;Mangle&nbsp;the&nbsp;template&nbsp;name&nbsp;with&nbsp;the&nbsp;input&nbsp;context&nbsp;to&nbsp;produce&nbsp;a&nbsp;reliable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2845321">//&nbsp;identifier.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2845337">dname</span>&nbsp;<span class="op" id="2845343">:=</span>&nbsp;<span class="ident" id="2845346">c</span><span class="op" id="2845347">.</span><span class="ident" id="2845348">mangle</span><span class="op" id="2845354">(</span><span class="ident" id="2845355">name</span><span class="op" id="2845359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2845362">e</span><span class="op" id="2845363">.</span><span class="ident" id="2845364">called</span><span class="op" id="2845370">[</span><span class="ident" id="2845371">dname</span><span class="op" id="2845376">]</span>&nbsp;<span class="op" id="2845378">=</span>&nbsp;<span class="builtintype" id="2845380">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2845386">if</span>&nbsp;<span class="ident" id="2845389">out</span><span class="op" id="2845392">,</span>&nbsp;<span class="ident" id="2845394">ok</span>&nbsp;<span class="op" id="2845397">:=</span>&nbsp;<span class="ident" id="2845400">e</span><span class="op" id="2845401">.</span><span class="ident" id="2845402">output</span><span class="op" id="2845408">[</span><span class="ident" id="2845409">dname</span><span class="op" id="2845414">]</span><span class="op" id="2845415">;</span>&nbsp;<span class="ident" id="2845417">ok</span>&nbsp;<span class="op" id="2845420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2845424">//&nbsp;Already&nbsp;escaped.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2845446">return</span>&nbsp;<span class="ident" id="2845453">out</span><span class="op" id="2845456">,</span>&nbsp;<span class="ident" id="2845458">dname</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2845465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2845468">t</span>&nbsp;<span class="op" id="2845470">:=</span>&nbsp;<span class="ident" id="2845473">e</span><span class="op" id="2845474">.</span><span class="ident" id="2845475">template</span><span class="op" id="2845483">(</span><span class="ident" id="2845484">name</span><span class="op" id="2845488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2845491">if</span>&nbsp;<span class="ident" id="2845494">t</span>&nbsp;<span class="op" id="2845496">==</span>&nbsp;<span class="ident" id="2845499">nil</span>&nbsp;<span class="op" id="2845503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2845507">//&nbsp;Two&nbsp;cases:&nbsp;The&nbsp;template&nbsp;exists&nbsp;but&nbsp;is&nbsp;empty,&nbsp;or&nbsp;has&nbsp;never&nbsp;been&nbsp;mentioned&nbsp;at</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2845588">//&nbsp;all.&nbsp;Distinguish&nbsp;the&nbsp;cases&nbsp;in&nbsp;the&nbsp;error&nbsp;messages.</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2845643">if</span>&nbsp;<span class="ident" id="2845646">e</span><span class="op" id="2845647">.</span><span class="ident" id="2845648">tmpl</span><span class="op" id="2845652">.</span><span class="ident" id="2845653">set</span><span class="op" id="2845656">[</span><span class="ident" id="2845657">name</span><span class="op" id="2845661">]</span>&nbsp;<span class="op" id="2845663">!=</span>&nbsp;<span class="ident" id="2845666">nil</span>&nbsp;<span class="op" id="2845670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2845675">return</span>&nbsp;<span class="ident" id="2845682">context</span><span class="op" id="2845689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2845695">state</span><span class="op" id="2845700">:</span>&nbsp;<span class="ident" id="2845702">stateError</span><span class="op" id="2845712">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2845718">err</span><span class="op" id="2845721">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2845725">errorf</span><span class="op" id="2845731">(</span><span class="ident" id="2845732">ErrNoSuchTemplate</span><span class="op" id="2845749">,</span>&nbsp;<span class="ident" id="2845751">node</span><span class="op" id="2845755">,</span>&nbsp;<span class="ident" id="2845757">line</span><span class="op" id="2845761">,</span>&nbsp;<span class="string" id="2845763">&#34;%q&nbsp;is&nbsp;an&nbsp;incomplete&nbsp;or&nbsp;empty&nbsp;template&#34;</span><span class="op" id="2845802">,</span>&nbsp;<span class="ident" id="2845804">name</span><span class="op" id="2845808">)</span><span class="op" id="2845809">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2845814">}</span><span class="op" id="2845815">,</span>&nbsp;<span class="ident" id="2845817">dname</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2845825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2845829">return</span>&nbsp;<span class="ident" id="2845836">context</span><span class="op" id="2845843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2845848">state</span><span class="op" id="2845853">:</span>&nbsp;<span class="ident" id="2845855">stateError</span><span class="op" id="2845865">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2845870">err</span><span class="op" id="2845873">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2845877">errorf</span><span class="op" id="2845883">(</span><span class="ident" id="2845884">ErrNoSuchTemplate</span><span class="op" id="2845901">,</span>&nbsp;<span class="ident" id="2845903">node</span><span class="op" id="2845907">,</span>&nbsp;<span class="ident" id="2845909">line</span><span class="op" id="2845913">,</span>&nbsp;<span class="string" id="2845915">&#34;no&nbsp;such&nbsp;template&nbsp;%q&#34;</span><span class="op" id="2845936">,</span>&nbsp;<span class="ident" id="2845938">name</span><span class="op" id="2845942">)</span><span class="op" id="2845943">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2845947">}</span><span class="op" id="2845948">,</span>&nbsp;<span class="ident" id="2845950">dname</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2845957">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2845960">if</span>&nbsp;<span class="ident" id="2845963">dname</span>&nbsp;<span class="op" id="2845969">!=</span>&nbsp;<span class="ident" id="2845972">name</span>&nbsp;<span class="op" id="2845977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2845981">//&nbsp;Use&nbsp;any&nbsp;template&nbsp;derived&nbsp;during&nbsp;an&nbsp;earlier&nbsp;call&nbsp;to&nbsp;escapeTemplate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2846052">//&nbsp;with&nbsp;different&nbsp;top&nbsp;level&nbsp;templates,&nbsp;or&nbsp;clone&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2846116">dt</span>&nbsp;<span class="op" id="2846119">:=</span>&nbsp;<span class="ident" id="2846122">e</span><span class="op" id="2846123">.</span><span class="ident" id="2846124">template</span><span class="op" id="2846132">(</span><span class="ident" id="2846133">dname</span><span class="op" id="2846138">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2846142">if</span>&nbsp;<span class="ident" id="2846145">dt</span>&nbsp;<span class="op" id="2846148">==</span>&nbsp;<span class="ident" id="2846151">nil</span>&nbsp;<span class="op" id="2846155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2846160">dt</span>&nbsp;<span class="op" id="2846163">=</span>&nbsp;<span class="ident" id="2846165">template</span><span class="op" id="2846173">.</span><span class="ident" id="2846174">New</span><span class="op" id="2846177">(</span><span class="ident" id="2846178">dname</span><span class="op" id="2846183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2846188">dt</span><span class="op" id="2846190">.</span><span class="ident" id="2846191">Tree</span>&nbsp;<span class="op" id="2846196">=</span>&nbsp;<span class="op" id="2846198">&amp;</span><span class="ident" id="2846199">parse</span><span class="op" id="2846204">.</span><span class="ident" id="2846205">Tree</span><span class="op" id="2846209">{</span><span class="ident" id="2846210">Name</span><span class="op" id="2846214">:</span>&nbsp;<span class="ident" id="2846216">dname</span><span class="op" id="2846221">,</span>&nbsp;<span class="ident" id="2846223">Root</span><span class="op" id="2846227">:</span>&nbsp;<span class="ident" id="2846229">t</span><span class="op" id="2846230">.</span><span class="ident" id="2846231">Root</span><span class="op" id="2846235">.</span><span class="ident" id="2846236">CopyList</span><span class="op" id="2846244">(</span><span class="op" id="2846245">)</span><span class="op" id="2846246">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2846251">e</span><span class="op" id="2846252">.</span><span class="ident" id="2846253">derived</span><span class="op" id="2846260">[</span><span class="ident" id="2846261">dname</span><span class="op" id="2846266">]</span>&nbsp;<span class="op" id="2846268">=</span>&nbsp;<span class="ident" id="2846270">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2846275">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2846279">t</span>&nbsp;<span class="op" id="2846281">=</span>&nbsp;<span class="ident" id="2846283">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2846287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2846290">return</span>&nbsp;<span class="ident" id="2846297">e</span><span class="op" id="2846298">.</span><span class="ident" id="2846299">computeOutCtx</span><span class="op" id="2846312">(</span><span class="ident" id="2846313">c</span><span class="op" id="2846314">,</span>&nbsp;<span class="ident" id="2846316">t</span><span class="op" id="2846317">)</span><span class="op" id="2846318">,</span>&nbsp;<span class="ident" id="2846320">dname</span><br>
<span class="lineno"></span><span class="op" id="2846326">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">530</span><span class="comment" id="2846329">//&nbsp;computeOutCtx&nbsp;takes&nbsp;a&nbsp;template&nbsp;and&nbsp;its&nbsp;start&nbsp;context&nbsp;and&nbsp;computes&nbsp;the&nbsp;output</span><br>
<span class="lineno"></span><span class="comment" id="2846409">//&nbsp;context&nbsp;while&nbsp;storing&nbsp;any&nbsp;inferences&nbsp;in&nbsp;e.</span><br>
<span class="lineno"></span><span class="keyword" id="2846455">func</span>&nbsp;<span class="op" id="2846460">(</span><span class="ident" id="2846461">e</span>&nbsp;<span class="op" id="2846463">*</span><span class="ident" id="2846464">escaper</span><span class="op" id="2846471">)</span>&nbsp;<span class="ident" id="2846473">computeOutCtx</span><span class="op" id="2846486">(</span><span class="ident" id="2846487">c</span>&nbsp;<span class="ident" id="2846489">context</span><span class="op" id="2846496">,</span>&nbsp;<span class="ident" id="2846498">t</span>&nbsp;<span class="op" id="2846500">*</span><span class="ident" id="2846501">template</span><span class="op" id="2846509">.</span><span class="ident" id="2846510">Template</span><span class="op" id="2846518">)</span>&nbsp;<span class="ident" id="2846520">context</span>&nbsp;<span class="op" id="2846528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2846531">//&nbsp;Propagate&nbsp;context&nbsp;over&nbsp;the&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2846568">c1</span><span class="op" id="2846570">,</span>&nbsp;<span class="ident" id="2846572">ok</span>&nbsp;<span class="op" id="2846575">:=</span>&nbsp;<span class="ident" id="2846578">e</span><span class="op" id="2846579">.</span><span class="ident" id="2846580">escapeTemplateBody</span><span class="op" id="2846598">(</span><span class="ident" id="2846599">c</span><span class="op" id="2846600">,</span>&nbsp;<span class="ident" id="2846602">t</span><span class="op" id="2846603">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2846606">if</span>&nbsp;<span class="op" id="2846609">!</span><span class="ident" id="2846610">ok</span>&nbsp;<span class="op" id="2846613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2846617">//&nbsp;Look&nbsp;for&nbsp;a&nbsp;fixed&nbsp;point&nbsp;by&nbsp;assuming&nbsp;c1&nbsp;as&nbsp;the&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2846683">if</span>&nbsp;<span class="ident" id="2846686">c2</span><span class="op" id="2846688">,</span>&nbsp;<span class="ident" id="2846690">ok2</span>&nbsp;<span class="op" id="2846694">:=</span>&nbsp;<span class="ident" id="2846697">e</span><span class="op" id="2846698">.</span><span class="ident" id="2846699">escapeTemplateBody</span><span class="op" id="2846717">(</span><span class="ident" id="2846718">c1</span><span class="op" id="2846720">,</span>&nbsp;<span class="ident" id="2846722">t</span><span class="op" id="2846723">)</span><span class="op" id="2846724">;</span>&nbsp;<span class="ident" id="2846726">ok2</span>&nbsp;<span class="op" id="2846730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2846735">c1</span><span class="op" id="2846737">,</span>&nbsp;<span class="ident" id="2846739">ok</span>&nbsp;<span class="op" id="2846742">=</span>&nbsp;<span class="ident" id="2846744">c2</span><span class="op" id="2846746">,</span>&nbsp;<span class="builtintype" id="2846748">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2846755">}</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2846759">//&nbsp;Use&nbsp;c1&nbsp;as&nbsp;the&nbsp;error&nbsp;context&nbsp;if&nbsp;neither&nbsp;assumption&nbsp;worked.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2846821">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2846824">if</span>&nbsp;<span class="op" id="2846827">!</span><span class="ident" id="2846828">ok</span>&nbsp;<span class="op" id="2846831">&amp;&amp;</span>&nbsp;<span class="ident" id="2846834">c1</span><span class="op" id="2846836">.</span><span class="ident" id="2846837">state</span>&nbsp;<span class="op" id="2846843">!=</span>&nbsp;<span class="ident" id="2846846">stateError</span>&nbsp;<span class="op" id="2846857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2846861">return</span>&nbsp;<span class="ident" id="2846868">context</span><span class="op" id="2846875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2846880">state</span><span class="op" id="2846885">:</span>&nbsp;<span class="ident" id="2846887">stateError</span><span class="op" id="2846897">,</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2846902">err</span><span class="op" id="2846905">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2846909">errorf</span><span class="op" id="2846915">(</span><span class="ident" id="2846916">ErrOutputContext</span><span class="op" id="2846932">,</span>&nbsp;<span class="ident" id="2846934">t</span><span class="op" id="2846935">.</span><span class="ident" id="2846936">Tree</span><span class="op" id="2846940">.</span><span class="ident" id="2846941">Root</span><span class="op" id="2846945">,</span>&nbsp;<span class="num" id="2846947">0</span><span class="op" id="2846948">,</span>&nbsp;<span class="string" id="2846950">&#34;cannot&nbsp;compute&nbsp;output&nbsp;context&nbsp;for&nbsp;template&nbsp;%s&#34;</span><span class="op" id="2846997">,</span>&nbsp;<span class="ident" id="2846999">t</span><span class="op" id="2847000">.</span><span class="ident" id="2847001">Name</span><span class="op" id="2847005">(</span><span class="op" id="2847006">)</span><span class="op" id="2847007">)</span><span class="op" id="2847008">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2847012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2847015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2847018">return</span>&nbsp;<span class="ident" id="2847025">c1</span><br>
<span class="lineno"></span><span class="op" id="2847028">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="comment" id="2847031">//&nbsp;escapeTemplateBody&nbsp;escapes&nbsp;the&nbsp;given&nbsp;template&nbsp;assuming&nbsp;the&nbsp;given&nbsp;output</span><br>
<span class="lineno"></span><span class="comment" id="2847106">//&nbsp;context,&nbsp;and&nbsp;returns&nbsp;the&nbsp;best&nbsp;guess&nbsp;at&nbsp;the&nbsp;output&nbsp;context&nbsp;and&nbsp;whether&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2847183">//&nbsp;assumption&nbsp;was&nbsp;correct.</span><br>
<span class="lineno"></span><span class="keyword" id="2847210">func</span>&nbsp;<span class="op" id="2847215">(</span><span class="ident" id="2847216">e</span>&nbsp;<span class="op" id="2847218">*</span><span class="ident" id="2847219">escaper</span><span class="op" id="2847226">)</span>&nbsp;<span class="ident" id="2847228">escapeTemplateBody</span><span class="op" id="2847246">(</span><span class="ident" id="2847247">c</span>&nbsp;<span class="ident" id="2847249">context</span><span class="op" id="2847256">,</span>&nbsp;<span class="ident" id="2847258">t</span>&nbsp;<span class="op" id="2847260">*</span><span class="ident" id="2847261">template</span><span class="op" id="2847269">.</span><span class="ident" id="2847270">Template</span><span class="op" id="2847278">)</span>&nbsp;<span class="op" id="2847280">(</span><span class="ident" id="2847281">context</span><span class="op" id="2847288">,</span>&nbsp;<span class="builtintype" id="2847290">bool</span><span class="op" id="2847294">)</span>&nbsp;<span class="op" id="2847296">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2847299">filter</span>&nbsp;<span class="op" id="2847306">:=</span>&nbsp;<span class="keyword" id="2847309">func</span><span class="op" id="2847313">(</span><span class="ident" id="2847314">e1</span>&nbsp;<span class="op" id="2847317">*</span><span class="ident" id="2847318">escaper</span><span class="op" id="2847325">,</span>&nbsp;<span class="ident" id="2847327">c1</span>&nbsp;<span class="ident" id="2847330">context</span><span class="op" id="2847337">)</span>&nbsp;<span class="builtintype" id="2847339">bool</span>&nbsp;<span class="op" id="2847344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2847348">if</span>&nbsp;<span class="ident" id="2847351">c1</span><span class="op" id="2847353">.</span><span class="ident" id="2847354">state</span>&nbsp;<span class="op" id="2847360">==</span>&nbsp;<span class="ident" id="2847363">stateError</span>&nbsp;<span class="op" id="2847374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2847379">//&nbsp;Do&nbsp;not&nbsp;update&nbsp;the&nbsp;input&nbsp;escaper,&nbsp;e.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2847421">return</span>&nbsp;<span class="builtintype" id="2847428">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2847436">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2847440">if</span>&nbsp;<span class="op" id="2847443">!</span><span class="ident" id="2847444">e1</span><span class="op" id="2847446">.</span><span class="ident" id="2847447">called</span><span class="op" id="2847453">[</span><span class="ident" id="2847454">t</span><span class="op" id="2847455">.</span><span class="ident" id="2847456">Name</span><span class="op" id="2847460">(</span><span class="op" id="2847461">)</span><span class="op" id="2847462">]</span>&nbsp;<span class="op" id="2847464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2847469">//&nbsp;If&nbsp;t&nbsp;is&nbsp;not&nbsp;recursively&nbsp;called,&nbsp;then&nbsp;c1&nbsp;is&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2847521">//&nbsp;accurate&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2847552">return</span>&nbsp;<span class="builtintype" id="2847559">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2847566">}</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2847570">//&nbsp;c1&nbsp;is&nbsp;accurate&nbsp;if&nbsp;it&nbsp;matches&nbsp;our&nbsp;assumed&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2847632">return</span>&nbsp;<span class="ident" id="2847639">c</span><span class="op" id="2847640">.</span><span class="ident" id="2847641">eq</span><span class="op" id="2847643">(</span><span class="ident" id="2847644">c1</span><span class="op" id="2847646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2847649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2847652">//&nbsp;We&nbsp;need&nbsp;to&nbsp;assume&nbsp;an&nbsp;output&nbsp;context&nbsp;so&nbsp;that&nbsp;recursive&nbsp;template&nbsp;calls</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2847725">//&nbsp;take&nbsp;the&nbsp;fast&nbsp;path&nbsp;out&nbsp;of&nbsp;escapeTree&nbsp;instead&nbsp;of&nbsp;infinitely&nbsp;recursing.</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2847799">//&nbsp;Naively&nbsp;assuming&nbsp;that&nbsp;the&nbsp;input&nbsp;context&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;the&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2847869">//&nbsp;works&nbsp;&gt;90%&nbsp;of&nbsp;the&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2847897">e</span><span class="op" id="2847898">.</span><span class="ident" id="2847899">output</span><span class="op" id="2847905">[</span><span class="ident" id="2847906">t</span><span class="op" id="2847907">.</span><span class="ident" id="2847908">Name</span><span class="op" id="2847912">(</span><span class="op" id="2847913">)</span><span class="op" id="2847914">]</span>&nbsp;<span class="op" id="2847916">=</span>&nbsp;<span class="ident" id="2847918">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2847921">return</span>&nbsp;<span class="ident" id="2847928">e</span><span class="op" id="2847929">.</span><span class="ident" id="2847930">escapeListConditionally</span><span class="op" id="2847953">(</span><span class="ident" id="2847954">c</span><span class="op" id="2847955">,</span>&nbsp;<span class="ident" id="2847957">t</span><span class="op" id="2847958">.</span><span class="ident" id="2847959">Tree</span><span class="op" id="2847963">.</span><span class="ident" id="2847964">Root</span><span class="op" id="2847968">,</span>&nbsp;<span class="ident" id="2847970">filter</span><span class="op" id="2847976">)</span><br>
<span class="lineno"></span><span class="op" id="2847978">}</span><br>
<span class="lineno">575</span><br>
<span class="lineno"></span><span class="comment" id="2847981">//&nbsp;delimEnds&nbsp;maps&nbsp;each&nbsp;delim&nbsp;to&nbsp;a&nbsp;string&nbsp;of&nbsp;characters&nbsp;that&nbsp;terminate&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="2848055">var</span>&nbsp;<span class="ident" id="2848059">delimEnds</span>&nbsp;<span class="op" id="2848069">=</span>&nbsp;<span class="op" id="2848071">[</span><span class="op" id="2848072">...</span><span class="op" id="2848075">]</span><span class="builtintype" id="2848076">string</span><span class="op" id="2848082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2848085">delimDoubleQuote</span><span class="op" id="2848101">:</span>&nbsp;<span class="string" id="2848103">`&#34;`</span><span class="op" id="2848106">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2848109">delimSingleQuote</span><span class="op" id="2848125">:</span>&nbsp;<span class="string" id="2848127">&#34;&#39;&#34;</span><span class="op" id="2848130">,</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2848133">//&nbsp;Determined&nbsp;empirically&nbsp;by&nbsp;running&nbsp;the&nbsp;below&nbsp;in&nbsp;various&nbsp;browsers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2848202">//&nbsp;var&nbsp;div&nbsp;=&nbsp;document.createElement(&#34;DIV&#34;);</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2848247">//&nbsp;for&nbsp;(var&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;0x10000;&nbsp;++i)&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2848287">//&nbsp;&nbsp;&nbsp;div.innerHTML&nbsp;=&nbsp;&#34;&lt;span&nbsp;title=x&#34;&nbsp;+&nbsp;String.fromCharCode(i)&nbsp;+&nbsp;&#34;-bar&gt;&#34;;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2848361">//&nbsp;&nbsp;&nbsp;if&nbsp;(div.getElementsByTagName(&#34;SPAN&#34;)[0].title.indexOf(&#34;bar&#34;)&nbsp;&lt;&nbsp;0)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2848433">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;document.write(&#34;&lt;p&gt;U+&#34;&nbsp;+&nbsp;i.toString(16));</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2848483">//&nbsp;}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2848489">delimSpaceOrTagEnd</span><span class="op" id="2848507">:</span>&nbsp;<span class="string" id="2848509">&#34;&nbsp;\t\n\f\r&gt;&#34;</span><span class="op" id="2848521">,</span><br>
<span class="lineno"></span><span class="op" id="2848523">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span><span class="keyword" id="2848526">var</span>&nbsp;<span class="ident" id="2848530">doctypeBytes</span>&nbsp;<span class="op" id="2848543">=</span>&nbsp;<span class="op" id="2848545">[</span><span class="op" id="2848546">]</span><span class="builtintype" id="2848547">byte</span><span class="op" id="2848551">(</span><span class="string" id="2848552">&#34;&lt;!DOCTYPE&#34;</span><span class="op" id="2848563">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2848566">//&nbsp;escapeText&nbsp;escapes&nbsp;a&nbsp;text&nbsp;template&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="2848610">func</span>&nbsp;<span class="op" id="2848615">(</span><span class="ident" id="2848616">e</span>&nbsp;<span class="op" id="2848618">*</span><span class="ident" id="2848619">escaper</span><span class="op" id="2848626">)</span>&nbsp;<span class="ident" id="2848628">escapeText</span><span class="op" id="2848638">(</span><span class="ident" id="2848639">c</span>&nbsp;<span class="ident" id="2848641">context</span><span class="op" id="2848648">,</span>&nbsp;<span class="ident" id="2848650">n</span>&nbsp;<span class="op" id="2848652">*</span><span class="ident" id="2848653">parse</span><span class="op" id="2848658">.</span><span class="ident" id="2848659">TextNode</span><span class="op" id="2848667">)</span>&nbsp;<span class="ident" id="2848669">context</span>&nbsp;<span class="op" id="2848677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2848680">s</span><span class="op" id="2848681">,</span>&nbsp;<span class="ident" id="2848683">written</span><span class="op" id="2848690">,</span>&nbsp;<span class="ident" id="2848692">i</span><span class="op" id="2848693">,</span>&nbsp;<span class="ident" id="2848695">b</span>&nbsp;<span class="op" id="2848697">:=</span>&nbsp;<span class="ident" id="2848700">n</span><span class="op" id="2848701">.</span><span class="ident" id="2848702">Text</span><span class="op" id="2848706">,</span>&nbsp;<span class="num" id="2848708">0</span><span class="op" id="2848709">,</span>&nbsp;<span class="num" id="2848711">0</span><span class="op" id="2848712">,</span>&nbsp;<span class="builtinfunc" id="2848714">new</span><span class="op" id="2848717">(</span><span class="ident" id="2848718">bytes</span><span class="op" id="2848723">.</span><span class="ident" id="2848724">Buffer</span><span class="op" id="2848730">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2848733">for</span>&nbsp;<span class="ident" id="2848737">i</span>&nbsp;<span class="op" id="2848739">!=</span>&nbsp;<span class="builtinfunc" id="2848742">len</span><span class="op" id="2848745">(</span><span class="ident" id="2848746">s</span><span class="op" id="2848747">)</span>&nbsp;<span class="op" id="2848749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2848753">c1</span><span class="op" id="2848755">,</span>&nbsp;<span class="ident" id="2848757">nread</span>&nbsp;<span class="op" id="2848763">:=</span>&nbsp;<span class="ident" id="2848766">contextAfterText</span><span class="op" id="2848782">(</span><span class="ident" id="2848783">c</span><span class="op" id="2848784">,</span>&nbsp;<span class="ident" id="2848786">s</span><span class="op" id="2848787">[</span><span class="ident" id="2848788">i</span><span class="op" id="2848789">:</span><span class="op" id="2848790">]</span><span class="op" id="2848791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2848795">i1</span>&nbsp;<span class="op" id="2848798">:=</span>&nbsp;<span class="ident" id="2848801">i</span>&nbsp;<span class="op" id="2848803">+</span>&nbsp;<span class="ident" id="2848805">nread</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2848813">if</span>&nbsp;<span class="ident" id="2848816">c</span><span class="op" id="2848817">.</span><span class="ident" id="2848818">state</span>&nbsp;<span class="op" id="2848824">==</span>&nbsp;<span class="ident" id="2848827">stateText</span>&nbsp;<span class="op" id="2848837">||</span>&nbsp;<span class="ident" id="2848840">c</span><span class="op" id="2848841">.</span><span class="ident" id="2848842">state</span>&nbsp;<span class="op" id="2848848">==</span>&nbsp;<span class="ident" id="2848851">stateRCDATA</span>&nbsp;<span class="op" id="2848863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2848868">end</span>&nbsp;<span class="op" id="2848872">:=</span>&nbsp;<span class="ident" id="2848875">i1</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2848881">if</span>&nbsp;<span class="ident" id="2848884">c1</span><span class="op" id="2848886">.</span><span class="ident" id="2848887">state</span>&nbsp;<span class="op" id="2848893">!=</span>&nbsp;<span class="ident" id="2848896">c</span><span class="op" id="2848897">.</span><span class="ident" id="2848898">state</span>&nbsp;<span class="op" id="2848904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2848910">for</span>&nbsp;<span class="ident" id="2848914">j</span>&nbsp;<span class="op" id="2848916">:=</span>&nbsp;<span class="ident" id="2848919">end</span>&nbsp;<span class="op" id="2848923">-</span>&nbsp;<span class="num" id="2848925">1</span><span class="op" id="2848926">;</span>&nbsp;<span class="ident" id="2848928">j</span>&nbsp;<span class="op" id="2848930">&gt;=</span>&nbsp;<span class="ident" id="2848933">i</span><span class="op" id="2848934">;</span>&nbsp;<span class="ident" id="2848936">j</span><span class="op" id="2848937">--</span>&nbsp;<span class="op" id="2848940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2848947">if</span>&nbsp;<span class="ident" id="2848950">s</span><span class="op" id="2848951">[</span><span class="ident" id="2848952">j</span><span class="op" id="2848953">]</span>&nbsp;<span class="op" id="2848955">==</span>&nbsp;<span class="string" id="2848958">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="2848962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2848970">end</span>&nbsp;<span class="op" id="2848974">=</span>&nbsp;<span class="ident" id="2848976">j</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2848984">break</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2848995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2849001">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2849006">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2849011">for</span>&nbsp;<span class="ident" id="2849015">j</span>&nbsp;<span class="op" id="2849017">:=</span>&nbsp;<span class="ident" id="2849020">i</span><span class="op" id="2849021">;</span>&nbsp;<span class="ident" id="2849023">j</span>&nbsp;<span class="op" id="2849025">&lt;</span>&nbsp;<span class="ident" id="2849027">end</span><span class="op" id="2849030">;</span>&nbsp;<span class="ident" id="2849032">j</span><span class="op" id="2849033">++</span>&nbsp;<span class="op" id="2849036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2849042">if</span>&nbsp;<span class="ident" id="2849045">s</span><span class="op" id="2849046">[</span><span class="ident" id="2849047">j</span><span class="op" id="2849048">]</span>&nbsp;<span class="op" id="2849050">==</span>&nbsp;<span class="string" id="2849053">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="2849057">&amp;&amp;</span>&nbsp;<span class="op" id="2849060">!</span><span class="ident" id="2849061">bytes</span><span class="op" id="2849066">.</span><span class="ident" id="2849067">HasPrefix</span><span class="op" id="2849076">(</span><span class="ident" id="2849077">bytes</span><span class="op" id="2849082">.</span><span class="ident" id="2849083">ToUpper</span><span class="op" id="2849090">(</span><span class="ident" id="2849091">s</span><span class="op" id="2849092">[</span><span class="ident" id="2849093">j</span><span class="op" id="2849094">:</span><span class="op" id="2849095">]</span><span class="op" id="2849096">)</span><span class="op" id="2849097">,</span>&nbsp;<span class="ident" id="2849099">doctypeBytes</span><span class="op" id="2849111">)</span>&nbsp;<span class="op" id="2849113">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2849120">b</span><span class="op" id="2849121">.</span><span class="ident" id="2849122">Write</span><span class="op" id="2849127">(</span><span class="ident" id="2849128">s</span><span class="op" id="2849129">[</span><span class="ident" id="2849130">written</span><span class="op" id="2849137">:</span><span class="ident" id="2849138">j</span><span class="op" id="2849139">]</span><span class="op" id="2849140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2849147">b</span><span class="op" id="2849148">.</span><span class="ident" id="2849149">WriteString</span><span class="op" id="2849160">(</span><span class="string" id="2849161">&#34;&amp;lt;&#34;</span><span class="op" id="2849167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2849174">written</span>&nbsp;<span class="op" id="2849182">=</span>&nbsp;<span class="ident" id="2849184">j</span>&nbsp;<span class="op" id="2849186">+</span>&nbsp;<span class="num" id="2849188">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2849194">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2849199">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2849203">}</span>&nbsp;<span class="keyword" id="2849205">else</span>&nbsp;<span class="keyword" id="2849210">if</span>&nbsp;<span class="ident" id="2849213">isComment</span><span class="op" id="2849222">(</span><span class="ident" id="2849223">c</span><span class="op" id="2849224">.</span><span class="ident" id="2849225">state</span><span class="op" id="2849230">)</span>&nbsp;<span class="op" id="2849232">&amp;&amp;</span>&nbsp;<span class="ident" id="2849235">c</span><span class="op" id="2849236">.</span><span class="ident" id="2849237">delim</span>&nbsp;<span class="op" id="2849243">==</span>&nbsp;<span class="ident" id="2849246">delimNone</span>&nbsp;<span class="op" id="2849256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2849261">switch</span>&nbsp;<span class="ident" id="2849268">c</span><span class="op" id="2849269">.</span><span class="ident" id="2849270">state</span>&nbsp;<span class="op" id="2849276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2849281">case</span>&nbsp;<span class="ident" id="2849286">stateJSBlockCmt</span><span class="op" id="2849301">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2849307">//&nbsp;http://es5.github.com/#x7.4:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2849343">//&nbsp;&#34;Comments&nbsp;behave&nbsp;like&nbsp;white&nbsp;space&nbsp;and&nbsp;are</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2849392">//&nbsp;discarded&nbsp;except&nbsp;that,&nbsp;if&nbsp;a&nbsp;MultiLineComment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2849444">//&nbsp;contains&nbsp;a&nbsp;line&nbsp;terminator&nbsp;character,&nbsp;then</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2849494">//&nbsp;the&nbsp;entire&nbsp;comment&nbsp;is&nbsp;considered&nbsp;to&nbsp;be&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2849542">//&nbsp;LineTerminator&nbsp;for&nbsp;purposes&nbsp;of&nbsp;parsing&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2849591">//&nbsp;the&nbsp;syntactic&nbsp;grammar.&#34;</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2849622">if</span>&nbsp;<span class="ident" id="2849625">bytes</span><span class="op" id="2849630">.</span><span class="ident" id="2849631">IndexAny</span><span class="op" id="2849639">(</span><span class="ident" id="2849640">s</span><span class="op" id="2849641">[</span><span class="ident" id="2849642">written</span><span class="op" id="2849649">:</span><span class="ident" id="2849650">i1</span><span class="op" id="2849652">]</span><span class="op" id="2849653">,</span>&nbsp;<span class="string" id="2849655">&#34;\n\r\u2028\u2029&#34;</span><span class="op" id="2849673">)</span>&nbsp;<span class="op" id="2849675">!=</span>&nbsp;<span class="op" id="2849678">-</span><span class="num" id="2849679">1</span>&nbsp;<span class="op" id="2849681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2849688">b</span><span class="op" id="2849689">.</span><span class="ident" id="2849690">WriteByte</span><span class="op" id="2849699">(</span><span class="string" id="2849700">&#39;\n&#39;</span><span class="op" id="2849704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2849710">}</span>&nbsp;<span class="keyword" id="2849712">else</span>&nbsp;<span class="op" id="2849717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2849724">b</span><span class="op" id="2849725">.</span><span class="ident" id="2849726">WriteByte</span><span class="op" id="2849735">(</span><span class="string" id="2849736">&#39;&nbsp;&#39;</span><span class="op" id="2849739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2849745">}</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2849750">case</span>&nbsp;<span class="ident" id="2849755">stateCSSBlockCmt</span><span class="op" id="2849771">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2849777">b</span><span class="op" id="2849778">.</span><span class="ident" id="2849779">WriteByte</span><span class="op" id="2849788">(</span><span class="string" id="2849789">&#39;&nbsp;&#39;</span><span class="op" id="2849792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2849797">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2849802">written</span>&nbsp;<span class="op" id="2849810">=</span>&nbsp;<span class="ident" id="2849812">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2849817">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2849821">if</span>&nbsp;<span class="ident" id="2849824">c</span><span class="op" id="2849825">.</span><span class="ident" id="2849826">state</span>&nbsp;<span class="op" id="2849832">!=</span>&nbsp;<span class="ident" id="2849835">c1</span><span class="op" id="2849837">.</span><span class="ident" id="2849838">state</span>&nbsp;<span class="op" id="2849844">&amp;&amp;</span>&nbsp;<span class="ident" id="2849847">isComment</span><span class="op" id="2849856">(</span><span class="ident" id="2849857">c1</span><span class="op" id="2849859">.</span><span class="ident" id="2849860">state</span><span class="op" id="2849865">)</span>&nbsp;<span class="op" id="2849867">&amp;&amp;</span>&nbsp;<span class="ident" id="2849870">c1</span><span class="op" id="2849872">.</span><span class="ident" id="2849873">delim</span>&nbsp;<span class="op" id="2849879">==</span>&nbsp;<span class="ident" id="2849882">delimNone</span>&nbsp;<span class="op" id="2849892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2849897">//&nbsp;Preserve&nbsp;the&nbsp;portion&nbsp;between&nbsp;written&nbsp;and&nbsp;the&nbsp;comment&nbsp;start.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2849963">cs</span>&nbsp;<span class="op" id="2849966">:=</span>&nbsp;<span class="ident" id="2849969">i1</span>&nbsp;<span class="op" id="2849972">-</span>&nbsp;<span class="num" id="2849974">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2849979">if</span>&nbsp;<span class="ident" id="2849982">c1</span><span class="op" id="2849984">.</span><span class="ident" id="2849985">state</span>&nbsp;<span class="op" id="2849991">==</span>&nbsp;<span class="ident" id="2849994">stateHTMLCmt</span>&nbsp;<span class="op" id="2850007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2850013">//&nbsp;&#34;&lt;!--&#34;&nbsp;instead&nbsp;of&nbsp;&#34;/*&#34;&nbsp;or&nbsp;&#34;//&#34;</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2850051">cs</span>&nbsp;<span class="op" id="2850054">-=</span>&nbsp;<span class="num" id="2850057">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2850062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2850067">b</span><span class="op" id="2850068">.</span><span class="ident" id="2850069">Write</span><span class="op" id="2850074">(</span><span class="ident" id="2850075">s</span><span class="op" id="2850076">[</span><span class="ident" id="2850077">written</span><span class="op" id="2850084">:</span><span class="ident" id="2850085">cs</span><span class="op" id="2850087">]</span><span class="op" id="2850088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2850093">written</span>&nbsp;<span class="op" id="2850101">=</span>&nbsp;<span class="ident" id="2850103">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2850108">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2850112">if</span>&nbsp;<span class="ident" id="2850115">i</span>&nbsp;<span class="op" id="2850117">==</span>&nbsp;<span class="ident" id="2850120">i1</span>&nbsp;<span class="op" id="2850123">&amp;&amp;</span>&nbsp;<span class="ident" id="2850126">c</span><span class="op" id="2850127">.</span><span class="ident" id="2850128">state</span>&nbsp;<span class="op" id="2850134">==</span>&nbsp;<span class="ident" id="2850137">c1</span><span class="op" id="2850139">.</span><span class="ident" id="2850140">state</span>&nbsp;<span class="op" id="2850146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2850151">panic</span><span class="op" id="2850156">(</span><span class="ident" id="2850157">fmt</span><span class="op" id="2850160">.</span><span class="ident" id="2850161">Sprintf</span><span class="op" id="2850168">(</span><span class="string" id="2850169">&#34;infinite&nbsp;loop&nbsp;from&nbsp;%v&nbsp;to&nbsp;%v&nbsp;on&nbsp;%q..%q&#34;</span><span class="op" id="2850208">,</span>&nbsp;<span class="ident" id="2850210">c</span><span class="op" id="2850211">,</span>&nbsp;<span class="ident" id="2850213">c1</span><span class="op" id="2850215">,</span>&nbsp;<span class="ident" id="2850217">s</span><span class="op" id="2850218">[</span><span class="op" id="2850219">:</span><span class="ident" id="2850220">i</span><span class="op" id="2850221">]</span><span class="op" id="2850222">,</span>&nbsp;<span class="ident" id="2850224">s</span><span class="op" id="2850225">[</span><span class="ident" id="2850226">i</span><span class="op" id="2850227">:</span><span class="op" id="2850228">]</span><span class="op" id="2850229">)</span><span class="op" id="2850230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2850234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2850238">c</span><span class="op" id="2850239">,</span>&nbsp;<span class="ident" id="2850241">i</span>&nbsp;<span class="op" id="2850243">=</span>&nbsp;<span class="ident" id="2850245">c1</span><span class="op" id="2850247">,</span>&nbsp;<span class="ident" id="2850249">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2850253">}</span><br>
<span class="lineno">650</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2850257">if</span>&nbsp;<span class="ident" id="2850260">written</span>&nbsp;<span class="op" id="2850268">!=</span>&nbsp;<span class="num" id="2850271">0</span>&nbsp;<span class="op" id="2850273">&amp;&amp;</span>&nbsp;<span class="ident" id="2850276">c</span><span class="op" id="2850277">.</span><span class="ident" id="2850278">state</span>&nbsp;<span class="op" id="2850284">!=</span>&nbsp;<span class="ident" id="2850287">stateError</span>&nbsp;<span class="op" id="2850298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2850302">if</span>&nbsp;<span class="op" id="2850305">!</span><span class="ident" id="2850306">isComment</span><span class="op" id="2850315">(</span><span class="ident" id="2850316">c</span><span class="op" id="2850317">.</span><span class="ident" id="2850318">state</span><span class="op" id="2850323">)</span>&nbsp;<span class="op" id="2850325">||</span>&nbsp;<span class="ident" id="2850328">c</span><span class="op" id="2850329">.</span><span class="ident" id="2850330">delim</span>&nbsp;<span class="op" id="2850336">!=</span>&nbsp;<span class="ident" id="2850339">delimNone</span>&nbsp;<span class="op" id="2850349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2850354">b</span><span class="op" id="2850355">.</span><span class="ident" id="2850356">Write</span><span class="op" id="2850361">(</span><span class="ident" id="2850362">n</span><span class="op" id="2850363">.</span><span class="ident" id="2850364">Text</span><span class="op" id="2850368">[</span><span class="ident" id="2850369">written</span><span class="op" id="2850376">:</span><span class="op" id="2850377">]</span><span class="op" id="2850378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2850382">}</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2850386">e</span><span class="op" id="2850387">.</span><span class="ident" id="2850388">editTextNode</span><span class="op" id="2850400">(</span><span class="ident" id="2850401">n</span><span class="op" id="2850402">,</span>&nbsp;<span class="ident" id="2850404">b</span><span class="op" id="2850405">.</span><span class="ident" id="2850406">Bytes</span><span class="op" id="2850411">(</span><span class="op" id="2850412">)</span><span class="op" id="2850413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2850416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2850419">return</span>&nbsp;<span class="ident" id="2850426">c</span><br>
<span class="lineno"></span><span class="op" id="2850428">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span><span class="comment" id="2850431">//&nbsp;contextAfterText&nbsp;starts&nbsp;in&nbsp;context&nbsp;c,&nbsp;consumes&nbsp;some&nbsp;tokens&nbsp;from&nbsp;the&nbsp;front&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="2850511">//&nbsp;s,&nbsp;then&nbsp;returns&nbsp;the&nbsp;context&nbsp;after&nbsp;those&nbsp;tokens&nbsp;and&nbsp;the&nbsp;unprocessed&nbsp;suffix.</span><br>
<span class="lineno"></span><span class="keyword" id="2850589">func</span>&nbsp;<span class="ident" id="2850594">contextAfterText</span><span class="op" id="2850610">(</span><span class="ident" id="2850611">c</span>&nbsp;<span class="ident" id="2850613">context</span><span class="op" id="2850620">,</span>&nbsp;<span class="ident" id="2850622">s</span>&nbsp;<span class="op" id="2850624">[</span><span class="op" id="2850625">]</span><span class="builtintype" id="2850626">byte</span><span class="op" id="2850630">)</span>&nbsp;<span class="op" id="2850632">(</span><span class="ident" id="2850633">context</span><span class="op" id="2850640">,</span>&nbsp;<span class="builtintype" id="2850642">int</span><span class="op" id="2850645">)</span>&nbsp;<span class="op" id="2850647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2850650">if</span>&nbsp;<span class="ident" id="2850653">c</span><span class="op" id="2850654">.</span><span class="ident" id="2850655">delim</span>&nbsp;<span class="op" id="2850661">==</span>&nbsp;<span class="ident" id="2850664">delimNone</span>&nbsp;<span class="op" id="2850674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2850678">c1</span><span class="op" id="2850680">,</span>&nbsp;<span class="ident" id="2850682">i</span>&nbsp;<span class="op" id="2850684">:=</span>&nbsp;<span class="ident" id="2850687">tSpecialTagEnd</span><span class="op" id="2850701">(</span><span class="ident" id="2850702">c</span><span class="op" id="2850703">,</span>&nbsp;<span class="ident" id="2850705">s</span><span class="op" id="2850706">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2850710">if</span>&nbsp;<span class="ident" id="2850713">i</span>&nbsp;<span class="op" id="2850715">==</span>&nbsp;<span class="num" id="2850718">0</span>&nbsp;<span class="op" id="2850720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2850725">//&nbsp;A&nbsp;special&nbsp;end&nbsp;tag&nbsp;(`&lt;/script&gt;`)&nbsp;has&nbsp;been&nbsp;seen&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2850781">//&nbsp;all&nbsp;content&nbsp;preceding&nbsp;it&nbsp;has&nbsp;been&nbsp;consumed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2850831">return</span>&nbsp;<span class="ident" id="2850838">c1</span><span class="op" id="2850840">,</span>&nbsp;<span class="num" id="2850842">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2850846">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2850850">//&nbsp;Consider&nbsp;all&nbsp;content&nbsp;up&nbsp;to&nbsp;any&nbsp;end&nbsp;tag.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2850895">return</span>&nbsp;<span class="ident" id="2850902">transitionFunc</span><span class="op" id="2850916">[</span><span class="ident" id="2850917">c</span><span class="op" id="2850918">.</span><span class="ident" id="2850919">state</span><span class="op" id="2850924">]</span><span class="op" id="2850925">(</span><span class="ident" id="2850926">c</span><span class="op" id="2850927">,</span>&nbsp;<span class="ident" id="2850929">s</span><span class="op" id="2850930">[</span><span class="op" id="2850931">:</span><span class="ident" id="2850932">i</span><span class="op" id="2850933">]</span><span class="op" id="2850934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2850937">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2850941">i</span>&nbsp;<span class="op" id="2850943">:=</span>&nbsp;<span class="ident" id="2850946">bytes</span><span class="op" id="2850951">.</span><span class="ident" id="2850952">IndexAny</span><span class="op" id="2850960">(</span><span class="ident" id="2850961">s</span><span class="op" id="2850962">,</span>&nbsp;<span class="ident" id="2850964">delimEnds</span><span class="op" id="2850973">[</span><span class="ident" id="2850974">c</span><span class="op" id="2850975">.</span><span class="ident" id="2850976">delim</span><span class="op" id="2850981">]</span><span class="op" id="2850982">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2850985">if</span>&nbsp;<span class="ident" id="2850988">i</span>&nbsp;<span class="op" id="2850990">==</span>&nbsp;<span class="op" id="2850993">-</span><span class="num" id="2850994">1</span>&nbsp;<span class="op" id="2850996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2851000">i</span>&nbsp;<span class="op" id="2851002">=</span>&nbsp;<span class="builtinfunc" id="2851004">len</span><span class="op" id="2851007">(</span><span class="ident" id="2851008">s</span><span class="op" id="2851009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2851012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2851015">if</span>&nbsp;<span class="ident" id="2851018">c</span><span class="op" id="2851019">.</span><span class="ident" id="2851020">delim</span>&nbsp;<span class="op" id="2851026">==</span>&nbsp;<span class="ident" id="2851029">delimSpaceOrTagEnd</span>&nbsp;<span class="op" id="2851048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2851052">//&nbsp;http://www.w3.org/TR/html5/syntax.html#attribute-value-(unquoted)-state</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2851129">//&nbsp;lists&nbsp;the&nbsp;runes&nbsp;below&nbsp;as&nbsp;error&nbsp;characters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2851177">//&nbsp;Error&nbsp;out&nbsp;because&nbsp;HTML&nbsp;parsers&nbsp;may&nbsp;differ&nbsp;on&nbsp;whether</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2851235">//&nbsp;&#34;&lt;a&nbsp;id=&nbsp;onclick=f(&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ends&nbsp;inside&nbsp;id&#39;s&nbsp;or&nbsp;onclick&#39;s&nbsp;value,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2851301">//&nbsp;&#34;&lt;a&nbsp;class=`foo&nbsp;&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ends&nbsp;inside&nbsp;a&nbsp;value,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2851351">//&nbsp;&#34;&lt;a&nbsp;style=font:&#39;Arial&#39;&#34;&nbsp;needs&nbsp;open-quote&nbsp;fixup.</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2851404">//&nbsp;IE&nbsp;treats&nbsp;&#39;`&#39;&nbsp;as&nbsp;a&nbsp;quotation&nbsp;character.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2851449">if</span>&nbsp;<span class="ident" id="2851452">j</span>&nbsp;<span class="op" id="2851454">:=</span>&nbsp;<span class="ident" id="2851457">bytes</span><span class="op" id="2851462">.</span><span class="ident" id="2851463">IndexAny</span><span class="op" id="2851471">(</span><span class="ident" id="2851472">s</span><span class="op" id="2851473">[</span><span class="op" id="2851474">:</span><span class="ident" id="2851475">i</span><span class="op" id="2851476">]</span><span class="op" id="2851477">,</span>&nbsp;<span class="string" id="2851479">&#34;\&#34;&#39;&lt;=`&#34;</span><span class="op" id="2851487">)</span><span class="op" id="2851488">;</span>&nbsp;<span class="ident" id="2851490">j</span>&nbsp;<span class="op" id="2851492">&gt;=</span>&nbsp;<span class="num" id="2851495">0</span>&nbsp;<span class="op" id="2851497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2851502">return</span>&nbsp;<span class="ident" id="2851509">context</span><span class="op" id="2851516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2851522">state</span><span class="op" id="2851527">:</span>&nbsp;<span class="ident" id="2851529">stateError</span><span class="op" id="2851539">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2851545">err</span><span class="op" id="2851548">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2851552">errorf</span><span class="op" id="2851558">(</span><span class="ident" id="2851559">ErrBadHTML</span><span class="op" id="2851569">,</span>&nbsp;<span class="ident" id="2851571">nil</span><span class="op" id="2851574">,</span>&nbsp;<span class="num" id="2851576">0</span><span class="op" id="2851577">,</span>&nbsp;<span class="string" id="2851579">&#34;%q&nbsp;in&nbsp;unquoted&nbsp;attr:&nbsp;%q&#34;</span><span class="op" id="2851604">,</span>&nbsp;<span class="ident" id="2851606">s</span><span class="op" id="2851607">[</span><span class="ident" id="2851608">j</span><span class="op" id="2851609">:</span><span class="ident" id="2851610">j</span><span class="op" id="2851611">+</span><span class="num" id="2851612">1</span><span class="op" id="2851613">]</span><span class="op" id="2851614">,</span>&nbsp;<span class="ident" id="2851616">s</span><span class="op" id="2851617">[</span><span class="op" id="2851618">:</span><span class="ident" id="2851619">i</span><span class="op" id="2851620">]</span><span class="op" id="2851621">)</span><span class="op" id="2851622">,</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2851627">}</span><span class="op" id="2851628">,</span>&nbsp;<span class="builtinfunc" id="2851630">len</span><span class="op" id="2851633">(</span><span class="ident" id="2851634">s</span><span class="op" id="2851635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2851639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2851642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2851645">if</span>&nbsp;<span class="ident" id="2851648">i</span>&nbsp;<span class="op" id="2851650">==</span>&nbsp;<span class="builtinfunc" id="2851653">len</span><span class="op" id="2851656">(</span><span class="ident" id="2851657">s</span><span class="op" id="2851658">)</span>&nbsp;<span class="op" id="2851660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2851664">//&nbsp;Remain&nbsp;inside&nbsp;the&nbsp;attribute.</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2851698">//&nbsp;Decode&nbsp;the&nbsp;value&nbsp;so&nbsp;non-HTML&nbsp;rules&nbsp;can&nbsp;easily&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2851756">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;button&nbsp;onclick=&#34;alert(&amp;quot;Hi!&amp;quot;)&#34;&gt;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2851807">//&nbsp;without&nbsp;having&nbsp;to&nbsp;entity&nbsp;decode&nbsp;token&nbsp;boundaries.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2851862">for</span>&nbsp;<span class="ident" id="2851866">u</span>&nbsp;<span class="op" id="2851868">:=</span>&nbsp;<span class="op" id="2851871">[</span><span class="op" id="2851872">]</span><span class="builtintype" id="2851873">byte</span><span class="op" id="2851877">(</span><span class="ident" id="2851878">html</span><span class="op" id="2851882">.</span><span class="ident" id="2851883">UnescapeString</span><span class="op" id="2851897">(</span><span class="builtintype" id="2851898">string</span><span class="op" id="2851904">(</span><span class="ident" id="2851905">s</span><span class="op" id="2851906">)</span><span class="op" id="2851907">)</span><span class="op" id="2851908">)</span><span class="op" id="2851909">;</span>&nbsp;<span class="builtinfunc" id="2851911">len</span><span class="op" id="2851914">(</span><span class="ident" id="2851915">u</span><span class="op" id="2851916">)</span>&nbsp;<span class="op" id="2851918">!=</span>&nbsp;<span class="num" id="2851921">0</span><span class="op" id="2851922">;</span>&nbsp;<span class="op" id="2851924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2851929">c1</span><span class="op" id="2851931">,</span>&nbsp;<span class="ident" id="2851933">i1</span>&nbsp;<span class="op" id="2851936">:=</span>&nbsp;<span class="ident" id="2851939">transitionFunc</span><span class="op" id="2851953">[</span><span class="ident" id="2851954">c</span><span class="op" id="2851955">.</span><span class="ident" id="2851956">state</span><span class="op" id="2851961">]</span><span class="op" id="2851962">(</span><span class="ident" id="2851963">c</span><span class="op" id="2851964">,</span>&nbsp;<span class="ident" id="2851966">u</span><span class="op" id="2851967">)</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2851972">c</span><span class="op" id="2851973">,</span>&nbsp;<span class="ident" id="2851975">u</span>&nbsp;<span class="op" id="2851977">=</span>&nbsp;<span class="ident" id="2851979">c1</span><span class="op" id="2851981">,</span>&nbsp;<span class="ident" id="2851983">u</span><span class="op" id="2851984">[</span><span class="ident" id="2851985">i1</span><span class="op" id="2851987">:</span><span class="op" id="2851988">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2851992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2851996">return</span>&nbsp;<span class="ident" id="2852003">c</span><span class="op" id="2852004">,</span>&nbsp;<span class="builtinfunc" id="2852006">len</span><span class="op" id="2852009">(</span><span class="ident" id="2852010">s</span><span class="op" id="2852011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2852014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2852017">if</span>&nbsp;<span class="ident" id="2852020">c</span><span class="op" id="2852021">.</span><span class="ident" id="2852022">delim</span>&nbsp;<span class="op" id="2852028">!=</span>&nbsp;<span class="ident" id="2852031">delimSpaceOrTagEnd</span>&nbsp;<span class="op" id="2852050">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2852054">//&nbsp;Consume&nbsp;any&nbsp;quote.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2852078">i</span><span class="op" id="2852079">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2852083">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2852086">//&nbsp;On&nbsp;exiting&nbsp;an&nbsp;attribute,&nbsp;we&nbsp;discard&nbsp;all&nbsp;state&nbsp;information</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2852148">//&nbsp;except&nbsp;the&nbsp;state&nbsp;and&nbsp;element.</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2852182">return</span>&nbsp;<span class="ident" id="2852189">context</span><span class="op" id="2852196">{</span><span class="ident" id="2852197">state</span><span class="op" id="2852202">:</span>&nbsp;<span class="ident" id="2852204">stateTag</span><span class="op" id="2852212">,</span>&nbsp;<span class="ident" id="2852214">element</span><span class="op" id="2852221">:</span>&nbsp;<span class="ident" id="2852223">c</span><span class="op" id="2852224">.</span><span class="ident" id="2852225">element</span><span class="op" id="2852232">}</span><span class="op" id="2852233">,</span>&nbsp;<span class="ident" id="2852235">i</span><br>
<span class="lineno"></span><span class="op" id="2852237">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2852240">//&nbsp;editActionNode&nbsp;records&nbsp;a&nbsp;change&nbsp;to&nbsp;an&nbsp;action&nbsp;pipeline&nbsp;for&nbsp;later&nbsp;commit.</span><br>
<span class="lineno"></span><span class="keyword" id="2852315">func</span>&nbsp;<span class="op" id="2852320">(</span><span class="ident" id="2852321">e</span>&nbsp;<span class="op" id="2852323">*</span><span class="ident" id="2852324">escaper</span><span class="op" id="2852331">)</span>&nbsp;<span class="ident" id="2852333">editActionNode</span><span class="op" id="2852347">(</span><span class="ident" id="2852348">n</span>&nbsp;<span class="op" id="2852350">*</span><span class="ident" id="2852351">parse</span><span class="op" id="2852356">.</span><span class="ident" id="2852357">ActionNode</span><span class="op" id="2852367">,</span>&nbsp;<span class="ident" id="2852369">cmds</span>&nbsp;<span class="op" id="2852374">[</span><span class="op" id="2852375">]</span><span class="builtintype" id="2852376">string</span><span class="op" id="2852382">)</span>&nbsp;<span class="op" id="2852384">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2852387">if</span>&nbsp;<span class="ident" id="2852390">_</span><span class="op" id="2852391">,</span>&nbsp;<span class="ident" id="2852393">ok</span>&nbsp;<span class="op" id="2852396">:=</span>&nbsp;<span class="ident" id="2852399">e</span><span class="op" id="2852400">.</span><span class="ident" id="2852401">actionNodeEdits</span><span class="op" id="2852416">[</span><span class="ident" id="2852417">n</span><span class="op" id="2852418">]</span><span class="op" id="2852419">;</span>&nbsp;<span class="ident" id="2852421">ok</span>&nbsp;<span class="op" id="2852424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2852428">panic</span><span class="op" id="2852433">(</span><span class="ident" id="2852434">fmt</span><span class="op" id="2852437">.</span><span class="ident" id="2852438">Sprintf</span><span class="op" id="2852445">(</span><span class="string" id="2852446">&#34;node&nbsp;%s&nbsp;shared&nbsp;between&nbsp;templates&#34;</span><span class="op" id="2852480">,</span>&nbsp;<span class="ident" id="2852482">n</span><span class="op" id="2852483">)</span><span class="op" id="2852484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2852487">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2852490">e</span><span class="op" id="2852491">.</span><span class="ident" id="2852492">actionNodeEdits</span><span class="op" id="2852507">[</span><span class="ident" id="2852508">n</span><span class="op" id="2852509">]</span>&nbsp;<span class="op" id="2852511">=</span>&nbsp;<span class="ident" id="2852513">cmds</span><br>
<span class="lineno"></span><span class="op" id="2852518">}</span><br>
<span class="lineno">720</span><br>
<span class="lineno"></span><span class="comment" id="2852521">//&nbsp;editTemplateNode&nbsp;records&nbsp;a&nbsp;change&nbsp;to&nbsp;a&nbsp;{{template}}&nbsp;callee&nbsp;for&nbsp;later&nbsp;commit.</span><br>
<span class="lineno"></span><span class="keyword" id="2852601">func</span>&nbsp;<span class="op" id="2852606">(</span><span class="ident" id="2852607">e</span>&nbsp;<span class="op" id="2852609">*</span><span class="ident" id="2852610">escaper</span><span class="op" id="2852617">)</span>&nbsp;<span class="ident" id="2852619">editTemplateNode</span><span class="op" id="2852635">(</span><span class="ident" id="2852636">n</span>&nbsp;<span class="op" id="2852638">*</span><span class="ident" id="2852639">parse</span><span class="op" id="2852644">.</span><span class="ident" id="2852645">TemplateNode</span><span class="op" id="2852657">,</span>&nbsp;<span class="ident" id="2852659">callee</span>&nbsp;<span class="builtintype" id="2852666">string</span><span class="op" id="2852672">)</span>&nbsp;<span class="op" id="2852674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2852677">if</span>&nbsp;<span class="ident" id="2852680">_</span><span class="op" id="2852681">,</span>&nbsp;<span class="ident" id="2852683">ok</span>&nbsp;<span class="op" id="2852686">:=</span>&nbsp;<span class="ident" id="2852689">e</span><span class="op" id="2852690">.</span><span class="ident" id="2852691">templateNodeEdits</span><span class="op" id="2852708">[</span><span class="ident" id="2852709">n</span><span class="op" id="2852710">]</span><span class="op" id="2852711">;</span>&nbsp;<span class="ident" id="2852713">ok</span>&nbsp;<span class="op" id="2852716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2852720">panic</span><span class="op" id="2852725">(</span><span class="ident" id="2852726">fmt</span><span class="op" id="2852729">.</span><span class="ident" id="2852730">Sprintf</span><span class="op" id="2852737">(</span><span class="string" id="2852738">&#34;node&nbsp;%s&nbsp;shared&nbsp;between&nbsp;templates&#34;</span><span class="op" id="2852772">,</span>&nbsp;<span class="ident" id="2852774">n</span><span class="op" id="2852775">)</span><span class="op" id="2852776">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2852779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2852782">e</span><span class="op" id="2852783">.</span><span class="ident" id="2852784">templateNodeEdits</span><span class="op" id="2852801">[</span><span class="ident" id="2852802">n</span><span class="op" id="2852803">]</span>&nbsp;<span class="op" id="2852805">=</span>&nbsp;<span class="ident" id="2852807">callee</span><br>
<span class="lineno"></span><span class="op" id="2852814">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2852817">//&nbsp;editTextNode&nbsp;records&nbsp;a&nbsp;change&nbsp;to&nbsp;a&nbsp;text&nbsp;node&nbsp;for&nbsp;later&nbsp;commit.</span><br>
<span class="lineno">730</span><span class="keyword" id="2852883">func</span>&nbsp;<span class="op" id="2852888">(</span><span class="ident" id="2852889">e</span>&nbsp;<span class="op" id="2852891">*</span><span class="ident" id="2852892">escaper</span><span class="op" id="2852899">)</span>&nbsp;<span class="ident" id="2852901">editTextNode</span><span class="op" id="2852913">(</span><span class="ident" id="2852914">n</span>&nbsp;<span class="op" id="2852916">*</span><span class="ident" id="2852917">parse</span><span class="op" id="2852922">.</span><span class="ident" id="2852923">TextNode</span><span class="op" id="2852931">,</span>&nbsp;<span class="ident" id="2852933">text</span>&nbsp;<span class="op" id="2852938">[</span><span class="op" id="2852939">]</span><span class="builtintype" id="2852940">byte</span><span class="op" id="2852944">)</span>&nbsp;<span class="op" id="2852946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2852949">if</span>&nbsp;<span class="ident" id="2852952">_</span><span class="op" id="2852953">,</span>&nbsp;<span class="ident" id="2852955">ok</span>&nbsp;<span class="op" id="2852958">:=</span>&nbsp;<span class="ident" id="2852961">e</span><span class="op" id="2852962">.</span><span class="ident" id="2852963">textNodeEdits</span><span class="op" id="2852976">[</span><span class="ident" id="2852977">n</span><span class="op" id="2852978">]</span><span class="op" id="2852979">;</span>&nbsp;<span class="ident" id="2852981">ok</span>&nbsp;<span class="op" id="2852984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2852988">panic</span><span class="op" id="2852993">(</span><span class="ident" id="2852994">fmt</span><span class="op" id="2852997">.</span><span class="ident" id="2852998">Sprintf</span><span class="op" id="2853005">(</span><span class="string" id="2853006">&#34;node&nbsp;%s&nbsp;shared&nbsp;between&nbsp;templates&#34;</span><span class="op" id="2853040">,</span>&nbsp;<span class="ident" id="2853042">n</span><span class="op" id="2853043">)</span><span class="op" id="2853044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2853047">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2853050">e</span><span class="op" id="2853051">.</span><span class="ident" id="2853052">textNodeEdits</span><span class="op" id="2853065">[</span><span class="ident" id="2853066">n</span><span class="op" id="2853067">]</span>&nbsp;<span class="op" id="2853069">=</span>&nbsp;<span class="ident" id="2853071">text</span><br>
<span class="lineno">735</span><span class="op" id="2853076">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2853079">//&nbsp;commit&nbsp;applies&nbsp;changes&nbsp;to&nbsp;actions&nbsp;and&nbsp;template&nbsp;calls&nbsp;needed&nbsp;to&nbsp;contextually</span><br>
<span class="lineno"></span><span class="comment" id="2853158">//&nbsp;autoescape&nbsp;content&nbsp;and&nbsp;adds&nbsp;any&nbsp;derived&nbsp;templates&nbsp;to&nbsp;the&nbsp;set.</span><br>
<span class="lineno"></span><span class="keyword" id="2853223">func</span>&nbsp;<span class="op" id="2853228">(</span><span class="ident" id="2853229">e</span>&nbsp;<span class="op" id="2853231">*</span><span class="ident" id="2853232">escaper</span><span class="op" id="2853239">)</span>&nbsp;<span class="ident" id="2853241">commit</span><span class="op" id="2853247">(</span><span class="op" id="2853248">)</span>&nbsp;<span class="op" id="2853250">{</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2853253">for</span>&nbsp;<span class="ident" id="2853257">name</span>&nbsp;<span class="op" id="2853262">:=</span>&nbsp;<span class="keyword" id="2853265">range</span>&nbsp;<span class="ident" id="2853271">e</span><span class="op" id="2853272">.</span><span class="ident" id="2853273">output</span>&nbsp;<span class="op" id="2853280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2853284">e</span><span class="op" id="2853285">.</span><span class="ident" id="2853286">template</span><span class="op" id="2853294">(</span><span class="ident" id="2853295">name</span><span class="op" id="2853299">)</span><span class="op" id="2853300">.</span><span class="ident" id="2853301">Funcs</span><span class="op" id="2853306">(</span><span class="ident" id="2853307">funcMap</span><span class="op" id="2853314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2853317">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2853320">for</span>&nbsp;<span class="ident" id="2853324">_</span><span class="op" id="2853325">,</span>&nbsp;<span class="ident" id="2853327">t</span>&nbsp;<span class="op" id="2853329">:=</span>&nbsp;<span class="keyword" id="2853332">range</span>&nbsp;<span class="ident" id="2853338">e</span><span class="op" id="2853339">.</span><span class="ident" id="2853340">derived</span>&nbsp;<span class="op" id="2853348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2853352">if</span>&nbsp;<span class="ident" id="2853355">_</span><span class="op" id="2853356">,</span>&nbsp;<span class="ident" id="2853358">err</span>&nbsp;<span class="op" id="2853362">:=</span>&nbsp;<span class="ident" id="2853365">e</span><span class="op" id="2853366">.</span><span class="ident" id="2853367">tmpl</span><span class="op" id="2853371">.</span><span class="ident" id="2853372">text</span><span class="op" id="2853376">.</span><span class="ident" id="2853377">AddParseTree</span><span class="op" id="2853389">(</span><span class="ident" id="2853390">t</span><span class="op" id="2853391">.</span><span class="ident" id="2853392">Name</span><span class="op" id="2853396">(</span><span class="op" id="2853397">)</span><span class="op" id="2853398">,</span>&nbsp;<span class="ident" id="2853400">t</span><span class="op" id="2853401">.</span><span class="ident" id="2853402">Tree</span><span class="op" id="2853406">)</span><span class="op" id="2853407">;</span>&nbsp;<span class="ident" id="2853409">err</span>&nbsp;<span class="op" id="2853413">!=</span>&nbsp;<span class="ident" id="2853416">nil</span>&nbsp;<span class="op" id="2853420">{</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2853425">panic</span><span class="op" id="2853430">(</span><span class="string" id="2853431">&#34;error&nbsp;adding&nbsp;derived&nbsp;template&#34;</span><span class="op" id="2853462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2853466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2853469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2853472">for</span>&nbsp;<span class="ident" id="2853476">n</span><span class="op" id="2853477">,</span>&nbsp;<span class="ident" id="2853479">s</span>&nbsp;<span class="op" id="2853481">:=</span>&nbsp;<span class="keyword" id="2853484">range</span>&nbsp;<span class="ident" id="2853490">e</span><span class="op" id="2853491">.</span><span class="ident" id="2853492">actionNodeEdits</span>&nbsp;<span class="op" id="2853508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2853512">ensurePipelineContains</span><span class="op" id="2853534">(</span><span class="ident" id="2853535">n</span><span class="op" id="2853536">.</span><span class="ident" id="2853537">Pipe</span><span class="op" id="2853541">,</span>&nbsp;<span class="ident" id="2853543">s</span><span class="op" id="2853544">)</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2853547">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2853550">for</span>&nbsp;<span class="ident" id="2853554">n</span><span class="op" id="2853555">,</span>&nbsp;<span class="ident" id="2853557">name</span>&nbsp;<span class="op" id="2853562">:=</span>&nbsp;<span class="keyword" id="2853565">range</span>&nbsp;<span class="ident" id="2853571">e</span><span class="op" id="2853572">.</span><span class="ident" id="2853573">templateNodeEdits</span>&nbsp;<span class="op" id="2853591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2853595">n</span><span class="op" id="2853596">.</span><span class="ident" id="2853597">Name</span>&nbsp;<span class="op" id="2853602">=</span>&nbsp;<span class="ident" id="2853604">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2853610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2853613">for</span>&nbsp;<span class="ident" id="2853617">n</span><span class="op" id="2853618">,</span>&nbsp;<span class="ident" id="2853620">s</span>&nbsp;<span class="op" id="2853622">:=</span>&nbsp;<span class="keyword" id="2853625">range</span>&nbsp;<span class="ident" id="2853631">e</span><span class="op" id="2853632">.</span><span class="ident" id="2853633">textNodeEdits</span>&nbsp;<span class="op" id="2853647">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2853651">n</span><span class="op" id="2853652">.</span><span class="ident" id="2853653">Text</span>&nbsp;<span class="op" id="2853658">=</span>&nbsp;<span class="ident" id="2853660">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2853663">}</span><br>
<span class="lineno"></span><span class="op" id="2853665">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2853668">//&nbsp;template&nbsp;returns&nbsp;the&nbsp;named&nbsp;template&nbsp;given&nbsp;a&nbsp;mangled&nbsp;template&nbsp;name.</span><br>
<span class="lineno">760</span><span class="keyword" id="2853738">func</span>&nbsp;<span class="op" id="2853743">(</span><span class="ident" id="2853744">e</span>&nbsp;<span class="op" id="2853746">*</span><span class="ident" id="2853747">escaper</span><span class="op" id="2853754">)</span>&nbsp;<span class="ident" id="2853756">template</span><span class="op" id="2853764">(</span><span class="ident" id="2853765">name</span>&nbsp;<span class="builtintype" id="2853770">string</span><span class="op" id="2853776">)</span>&nbsp;<span class="op" id="2853778">*</span><span class="ident" id="2853779">template</span><span class="op" id="2853787">.</span><span class="ident" id="2853788">Template</span>&nbsp;<span class="op" id="2853797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2853800">t</span>&nbsp;<span class="op" id="2853802">:=</span>&nbsp;<span class="ident" id="2853805">e</span><span class="op" id="2853806">.</span><span class="ident" id="2853807">tmpl</span><span class="op" id="2853811">.</span><span class="ident" id="2853812">text</span><span class="op" id="2853816">.</span><span class="ident" id="2853817">Lookup</span><span class="op" id="2853823">(</span><span class="ident" id="2853824">name</span><span class="op" id="2853828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2853831">if</span>&nbsp;<span class="ident" id="2853834">t</span>&nbsp;<span class="op" id="2853836">==</span>&nbsp;<span class="ident" id="2853839">nil</span>&nbsp;<span class="op" id="2853843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2853847">t</span>&nbsp;<span class="op" id="2853849">=</span>&nbsp;<span class="ident" id="2853851">e</span><span class="op" id="2853852">.</span><span class="ident" id="2853853">derived</span><span class="op" id="2853860">[</span><span class="ident" id="2853861">name</span><span class="op" id="2853865">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2853868">}</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2853871">return</span>&nbsp;<span class="ident" id="2853878">t</span><br>
<span class="lineno"></span><span class="op" id="2853880">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2853883">//&nbsp;Forwarding&nbsp;functions&nbsp;so&nbsp;that&nbsp;clients&nbsp;need&nbsp;only&nbsp;import&nbsp;this&nbsp;package</span><br>
<span class="lineno"></span><span class="comment" id="2853953">//&nbsp;to&nbsp;reach&nbsp;the&nbsp;general&nbsp;escaping&nbsp;functions&nbsp;of&nbsp;text/template.</span><br>
<span class="lineno">770</span><br>
<span class="lineno"></span><span class="comment" id="2854015">//&nbsp;HTMLEscape&nbsp;writes&nbsp;to&nbsp;w&nbsp;the&nbsp;escaped&nbsp;HTML&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="2854095">func</span>&nbsp;<span class="ident" id="2854100">HTMLEscape</span><span class="op" id="2854110">(</span><span class="ident" id="2854111">w</span>&nbsp;<span class="ident" id="2854113">io</span><span class="op" id="2854115">.</span><span class="ident" id="2854116">Writer</span><span class="op" id="2854122">,</span>&nbsp;<span class="ident" id="2854124">b</span>&nbsp;<span class="op" id="2854126">[</span><span class="op" id="2854127">]</span><span class="builtintype" id="2854128">byte</span><span class="op" id="2854132">)</span>&nbsp;<span class="op" id="2854134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2854137">template</span><span class="op" id="2854145">.</span><span class="ident" id="2854146">HTMLEscape</span><span class="op" id="2854156">(</span><span class="ident" id="2854157">w</span><span class="op" id="2854158">,</span>&nbsp;<span class="ident" id="2854160">b</span><span class="op" id="2854161">)</span><br>
<span class="lineno"></span><span class="op" id="2854163">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span><span class="comment" id="2854166">//&nbsp;HTMLEscapeString&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;HTML&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="2854248">func</span>&nbsp;<span class="ident" id="2854253">HTMLEscapeString</span><span class="op" id="2854269">(</span><span class="ident" id="2854270">s</span>&nbsp;<span class="builtintype" id="2854272">string</span><span class="op" id="2854278">)</span>&nbsp;<span class="builtintype" id="2854280">string</span>&nbsp;<span class="op" id="2854287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2854290">return</span>&nbsp;<span class="ident" id="2854297">template</span><span class="op" id="2854305">.</span><span class="ident" id="2854306">HTMLEscapeString</span><span class="op" id="2854322">(</span><span class="ident" id="2854323">s</span><span class="op" id="2854324">)</span><br>
<span class="lineno"></span><span class="op" id="2854326">}</span><br>
<span class="lineno">780</span><br>
<span class="lineno"></span><span class="comment" id="2854329">//&nbsp;HTMLEscaper&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;HTML&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;textual</span><br>
<span class="lineno"></span><span class="comment" id="2854395">//&nbsp;representation&nbsp;of&nbsp;its&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="keyword" id="2854431">func</span>&nbsp;<span class="ident" id="2854436">HTMLEscaper</span><span class="op" id="2854447">(</span><span class="ident" id="2854448">args</span>&nbsp;<span class="op" id="2854453">...</span><span class="keyword" id="2854456">interface</span><span class="op" id="2854465">{</span><span class="op" id="2854466">}</span><span class="op" id="2854467">)</span>&nbsp;<span class="builtintype" id="2854469">string</span>&nbsp;<span class="op" id="2854476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2854479">return</span>&nbsp;<span class="ident" id="2854486">template</span><span class="op" id="2854494">.</span><span class="ident" id="2854495">HTMLEscaper</span><span class="op" id="2854506">(</span><span class="ident" id="2854507">args</span><span class="op" id="2854511">...</span><span class="op" id="2854514">)</span><br>
<span class="lineno">785</span><span class="op" id="2854516">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2854519">//&nbsp;JSEscape&nbsp;writes&nbsp;to&nbsp;w&nbsp;the&nbsp;escaped&nbsp;JavaScript&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="2854603">func</span>&nbsp;<span class="ident" id="2854608">JSEscape</span><span class="op" id="2854616">(</span><span class="ident" id="2854617">w</span>&nbsp;<span class="ident" id="2854619">io</span><span class="op" id="2854621">.</span><span class="ident" id="2854622">Writer</span><span class="op" id="2854628">,</span>&nbsp;<span class="ident" id="2854630">b</span>&nbsp;<span class="op" id="2854632">[</span><span class="op" id="2854633">]</span><span class="builtintype" id="2854634">byte</span><span class="op" id="2854638">)</span>&nbsp;<span class="op" id="2854640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2854643">template</span><span class="op" id="2854651">.</span><span class="ident" id="2854652">JSEscape</span><span class="op" id="2854660">(</span><span class="ident" id="2854661">w</span><span class="op" id="2854662">,</span>&nbsp;<span class="ident" id="2854664">b</span><span class="op" id="2854665">)</span><br>
<span class="lineno">790</span><span class="op" id="2854667">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2854670">//&nbsp;JSEscapeString&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;JavaScript&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="2854756">func</span>&nbsp;<span class="ident" id="2854761">JSEscapeString</span><span class="op" id="2854775">(</span><span class="ident" id="2854776">s</span>&nbsp;<span class="builtintype" id="2854778">string</span><span class="op" id="2854784">)</span>&nbsp;<span class="builtintype" id="2854786">string</span>&nbsp;<span class="op" id="2854793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2854796">return</span>&nbsp;<span class="ident" id="2854803">template</span><span class="op" id="2854811">.</span><span class="ident" id="2854812">JSEscapeString</span><span class="op" id="2854826">(</span><span class="ident" id="2854827">s</span><span class="op" id="2854828">)</span><br>
<span class="lineno">795</span><span class="op" id="2854830">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2854833">//&nbsp;JSEscaper&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;JavaScript&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;textual</span><br>
<span class="lineno"></span><span class="comment" id="2854903">//&nbsp;representation&nbsp;of&nbsp;its&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="keyword" id="2854939">func</span>&nbsp;<span class="ident" id="2854944">JSEscaper</span><span class="op" id="2854953">(</span><span class="ident" id="2854954">args</span>&nbsp;<span class="op" id="2854959">...</span><span class="keyword" id="2854962">interface</span><span class="op" id="2854971">{</span><span class="op" id="2854972">}</span><span class="op" id="2854973">)</span>&nbsp;<span class="builtintype" id="2854975">string</span>&nbsp;<span class="op" id="2854982">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2854985">return</span>&nbsp;<span class="ident" id="2854992">template</span><span class="op" id="2855000">.</span><span class="ident" id="2855001">JSEscaper</span><span class="op" id="2855010">(</span><span class="ident" id="2855011">args</span><span class="op" id="2855015">...</span><span class="op" id="2855018">)</span><br>
<span class="lineno"></span><span class="op" id="2855020">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2855023">//&nbsp;URLQueryEscaper&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;value&nbsp;of&nbsp;the&nbsp;textual&nbsp;representation&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="2855101">//&nbsp;its&nbsp;arguments&nbsp;in&nbsp;a&nbsp;form&nbsp;suitable&nbsp;for&nbsp;embedding&nbsp;in&nbsp;a&nbsp;URL&nbsp;query.</span><br>
<span class="lineno">805</span><span class="keyword" id="2855167">func</span>&nbsp;<span class="ident" id="2855172">URLQueryEscaper</span><span class="op" id="2855187">(</span><span class="ident" id="2855188">args</span>&nbsp;<span class="op" id="2855193">...</span><span class="keyword" id="2855196">interface</span><span class="op" id="2855205">{</span><span class="op" id="2855206">}</span><span class="op" id="2855207">)</span>&nbsp;<span class="builtintype" id="2855209">string</span>&nbsp;<span class="op" id="2855216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2855219">return</span>&nbsp;<span class="ident" id="2855226">template</span><span class="op" id="2855234">.</span><span class="ident" id="2855235">URLQueryEscaper</span><span class="op" id="2855250">(</span><span class="ident" id="2855251">args</span><span class="op" id="2855255">...</span><span class="op" id="2855258">)</span><br>
<span class="lineno"></span><span class="op" id="2855260">}</span>
</div>
</body>
</html>
