<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="5488874">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5488929">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5488983">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5489034">package</span>&nbsp;<span class="ident" id="5489042">gif</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5489047">import</span>&nbsp;<span class="op" id="5489054">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5489057">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5489066">&#34;compress/lzw&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5489082">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5489092">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5489101">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5489116">&#34;image/color/palette&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5489139">&#34;image/draw&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5489153">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="5489158">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5489161">//&nbsp;Graphic&nbsp;control&nbsp;extension&nbsp;fields.</span><br>
<span class="lineno"></span><span class="keyword" id="5489198">const</span>&nbsp;<span class="op" id="5489204">(</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5489207">gcLabel</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5489219">=</span>&nbsp;<span class="num" id="5489221">0xF9</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5489227">gcBlockSize</span>&nbsp;<span class="op" id="5489239">=</span>&nbsp;<span class="num" id="5489241">0x04</span><br>
<span class="lineno"></span><span class="op" id="5489246">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5489249">var</span>&nbsp;<span class="ident" id="5489253">log2Lookup</span>&nbsp;<span class="op" id="5489264">=</span>&nbsp;<span class="op" id="5489266">[</span><span class="num" id="5489267">8</span><span class="op" id="5489268">]</span><span class="builtintype" id="5489269">int</span><span class="op" id="5489272">{</span><span class="num" id="5489273">2</span><span class="op" id="5489274">,</span>&nbsp;<span class="num" id="5489276">4</span><span class="op" id="5489277">,</span>&nbsp;<span class="num" id="5489279">8</span><span class="op" id="5489280">,</span>&nbsp;<span class="num" id="5489282">16</span><span class="op" id="5489284">,</span>&nbsp;<span class="num" id="5489286">32</span><span class="op" id="5489288">,</span>&nbsp;<span class="num" id="5489290">64</span><span class="op" id="5489292">,</span>&nbsp;<span class="num" id="5489294">128</span><span class="op" id="5489297">,</span>&nbsp;<span class="num" id="5489299">256</span><span class="op" id="5489302">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="5489305">func</span>&nbsp;<span class="ident" id="5489310">log2</span><span class="op" id="5489314">(</span><span class="ident" id="5489315">x</span>&nbsp;<span class="builtintype" id="5489317">int</span><span class="op" id="5489320">)</span>&nbsp;<span class="builtintype" id="5489322">int</span>&nbsp;<span class="op" id="5489326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5489329">for</span>&nbsp;<span class="ident" id="5489333">i</span><span class="op" id="5489334">,</span>&nbsp;<span class="ident" id="5489336">v</span>&nbsp;<span class="op" id="5489338">:=</span>&nbsp;<span class="keyword" id="5489341">range</span>&nbsp;<span class="ident" id="5489347">log2Lookup</span>&nbsp;<span class="op" id="5489358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5489362">if</span>&nbsp;<span class="ident" id="5489365">x</span>&nbsp;<span class="op" id="5489367">&lt;=</span>&nbsp;<span class="ident" id="5489370">v</span>&nbsp;<span class="op" id="5489372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5489377">return</span>&nbsp;<span class="ident" id="5489384">i</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5489388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5489391">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5489394">return</span>&nbsp;<span class="op" id="5489401">-</span><span class="num" id="5489402">1</span><br>
<span class="lineno"></span><span class="op" id="5489404">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="5489407">//&nbsp;Little-endian.</span><br>
<span class="lineno"></span><span class="keyword" id="5489425">func</span>&nbsp;<span class="ident" id="5489430">writeUint16</span><span class="op" id="5489441">(</span><span class="ident" id="5489442">b</span>&nbsp;<span class="op" id="5489444">[</span><span class="op" id="5489445">]</span><span class="builtintype" id="5489446">uint8</span><span class="op" id="5489451">,</span>&nbsp;<span class="ident" id="5489453">u</span>&nbsp;<span class="builtintype" id="5489455">uint16</span><span class="op" id="5489461">)</span>&nbsp;<span class="op" id="5489463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5489466">b</span><span class="op" id="5489467">[</span><span class="num" id="5489468">0</span><span class="op" id="5489469">]</span>&nbsp;<span class="op" id="5489471">=</span>&nbsp;<span class="builtintype" id="5489473">uint8</span><span class="op" id="5489478">(</span><span class="ident" id="5489479">u</span><span class="op" id="5489480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5489483">b</span><span class="op" id="5489484">[</span><span class="num" id="5489485">1</span><span class="op" id="5489486">]</span>&nbsp;<span class="op" id="5489488">=</span>&nbsp;<span class="builtintype" id="5489490">uint8</span><span class="op" id="5489495">(</span><span class="ident" id="5489496">u</span>&nbsp;<span class="op" id="5489498">&gt;&gt;</span>&nbsp;<span class="num" id="5489501">8</span><span class="op" id="5489502">)</span><br>
<span class="lineno"></span><span class="op" id="5489504">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="5489507">//&nbsp;writer&nbsp;is&nbsp;a&nbsp;buffered&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5489539">type</span>&nbsp;<span class="ident" id="5489544">writer</span>&nbsp;<span class="keyword" id="5489551">interface</span>&nbsp;<span class="op" id="5489561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5489564">Flush</span><span class="op" id="5489569">(</span><span class="op" id="5489570">)</span>&nbsp;<span class="builtintype" id="5489572">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5489579">io</span><span class="op" id="5489581">.</span><span class="ident" id="5489582">Writer</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5489590">io</span><span class="op" id="5489592">.</span><span class="ident" id="5489593">ByteWriter</span><br>
<span class="lineno"></span><span class="op" id="5489604">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5489607">//&nbsp;encoder&nbsp;encodes&nbsp;an&nbsp;image&nbsp;to&nbsp;the&nbsp;GIF&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword" id="5489654">type</span>&nbsp;<span class="ident" id="5489659">encoder</span>&nbsp;<span class="keyword" id="5489667">struct</span>&nbsp;<span class="op" id="5489674">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5489677">//&nbsp;w&nbsp;is&nbsp;the&nbsp;writer&nbsp;to&nbsp;write&nbsp;to.&nbsp;err&nbsp;is&nbsp;the&nbsp;first&nbsp;error&nbsp;encountered&nbsp;during</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5489752">//&nbsp;writing.&nbsp;All&nbsp;attempted&nbsp;writes&nbsp;after&nbsp;the&nbsp;first&nbsp;error&nbsp;become&nbsp;no-ops.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5489823">w</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5489827">writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5489835">err</span>&nbsp;<span class="builtintype" id="5489839">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5489846">//&nbsp;g&nbsp;is&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;data&nbsp;that&nbsp;is&nbsp;being&nbsp;encoded.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5489902">g</span>&nbsp;<span class="op" id="5489904">*</span><span class="ident" id="5489905">GIF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5489910">//&nbsp;buf&nbsp;is&nbsp;a&nbsp;scratch&nbsp;buffer.&nbsp;It&nbsp;must&nbsp;be&nbsp;at&nbsp;least&nbsp;768&nbsp;so&nbsp;we&nbsp;can&nbsp;write&nbsp;the&nbsp;color&nbsp;map.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5489994">buf</span>&nbsp;<span class="op" id="5489998">[</span><span class="num" id="5489999">1024</span><span class="op" id="5490003">]</span><span class="builtintype" id="5490004">byte</span><br>
<span class="lineno"></span><span class="op" id="5490009">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="5490012">//&nbsp;blockWriter&nbsp;writes&nbsp;the&nbsp;block&nbsp;structure&nbsp;of&nbsp;GIF&nbsp;image&nbsp;data,&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="5490079">//&nbsp;comprises&nbsp;(n,&nbsp;(n&nbsp;bytes))&nbsp;blocks,&nbsp;with&nbsp;1&nbsp;&lt;=&nbsp;n&nbsp;&lt;=&nbsp;255.&nbsp;It&nbsp;is&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5490145">//&nbsp;writer&nbsp;given&nbsp;to&nbsp;the&nbsp;LZW&nbsp;encoder,&nbsp;which&nbsp;is&nbsp;thus&nbsp;immune&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5490209">//&nbsp;blocking.</span><br>
<span class="lineno"></span><span class="keyword" id="5490222">type</span>&nbsp;<span class="ident" id="5490227">blockWriter</span>&nbsp;<span class="keyword" id="5490239">struct</span>&nbsp;<span class="op" id="5490246">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5490249">e</span>&nbsp;<span class="op" id="5490251">*</span><span class="ident" id="5490252">encoder</span><br>
<span class="lineno"></span><span class="op" id="5490260">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5490263">func</span>&nbsp;<span class="op" id="5490268">(</span><span class="ident" id="5490269">b</span>&nbsp;<span class="ident" id="5490271">blockWriter</span><span class="op" id="5490282">)</span>&nbsp;<span class="ident" id="5490284">Write</span><span class="op" id="5490289">(</span><span class="ident" id="5490290">data</span>&nbsp;<span class="op" id="5490295">[</span><span class="op" id="5490296">]</span><span class="builtintype" id="5490297">byte</span><span class="op" id="5490301">)</span>&nbsp;<span class="op" id="5490303">(</span><span class="builtintype" id="5490304">int</span><span class="op" id="5490307">,</span>&nbsp;<span class="builtintype" id="5490309">error</span><span class="op" id="5490314">)</span>&nbsp;<span class="op" id="5490316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5490319">if</span>&nbsp;<span class="ident" id="5490322">b</span><span class="op" id="5490323">.</span><span class="ident" id="5490324">e</span><span class="op" id="5490325">.</span><span class="ident" id="5490326">err</span>&nbsp;<span class="op" id="5490330">!=</span>&nbsp;<span class="ident" id="5490333">nil</span>&nbsp;<span class="op" id="5490337">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5490341">return</span>&nbsp;<span class="num" id="5490348">0</span><span class="op" id="5490349">,</span>&nbsp;<span class="ident" id="5490351">b</span><span class="op" id="5490352">.</span><span class="ident" id="5490353">e</span><span class="op" id="5490354">.</span><span class="ident" id="5490355">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5490360">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5490363">if</span>&nbsp;<span class="builtinfunc" id="5490366">len</span><span class="op" id="5490369">(</span><span class="ident" id="5490370">data</span><span class="op" id="5490374">)</span>&nbsp;<span class="op" id="5490376">==</span>&nbsp;<span class="num" id="5490379">0</span>&nbsp;<span class="op" id="5490381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5490385">return</span>&nbsp;<span class="num" id="5490392">0</span><span class="op" id="5490393">,</span>&nbsp;<span class="ident" id="5490395">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5490400">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5490403">total</span>&nbsp;<span class="op" id="5490409">:=</span>&nbsp;<span class="num" id="5490412">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5490415">for</span>&nbsp;<span class="ident" id="5490419">total</span>&nbsp;<span class="op" id="5490425">&lt;</span>&nbsp;<span class="builtinfunc" id="5490427">len</span><span class="op" id="5490430">(</span><span class="ident" id="5490431">data</span><span class="op" id="5490435">)</span>&nbsp;<span class="op" id="5490437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5490441">n</span>&nbsp;<span class="op" id="5490443">:=</span>&nbsp;<span class="builtinfunc" id="5490446">copy</span><span class="op" id="5490450">(</span><span class="ident" id="5490451">b</span><span class="op" id="5490452">.</span><span class="ident" id="5490453">e</span><span class="op" id="5490454">.</span><span class="ident" id="5490455">buf</span><span class="op" id="5490458">[</span><span class="num" id="5490459">1</span><span class="op" id="5490460">:</span><span class="num" id="5490461">256</span><span class="op" id="5490464">]</span><span class="op" id="5490465">,</span>&nbsp;<span class="ident" id="5490467">data</span><span class="op" id="5490471">[</span><span class="ident" id="5490472">total</span><span class="op" id="5490477">:</span><span class="op" id="5490478">]</span><span class="op" id="5490479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5490483">total</span>&nbsp;<span class="op" id="5490489">+=</span>&nbsp;<span class="ident" id="5490492">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5490496">b</span><span class="op" id="5490497">.</span><span class="ident" id="5490498">e</span><span class="op" id="5490499">.</span><span class="ident" id="5490500">buf</span><span class="op" id="5490503">[</span><span class="num" id="5490504">0</span><span class="op" id="5490505">]</span>&nbsp;<span class="op" id="5490507">=</span>&nbsp;<span class="builtintype" id="5490509">uint8</span><span class="op" id="5490514">(</span><span class="ident" id="5490515">n</span><span class="op" id="5490516">)</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5490521">n</span><span class="op" id="5490522">,</span>&nbsp;<span class="ident" id="5490524">b</span><span class="op" id="5490525">.</span><span class="ident" id="5490526">e</span><span class="op" id="5490527">.</span><span class="ident" id="5490528">err</span>&nbsp;<span class="op" id="5490532">=</span>&nbsp;<span class="ident" id="5490534">b</span><span class="op" id="5490535">.</span><span class="ident" id="5490536">e</span><span class="op" id="5490537">.</span><span class="ident" id="5490538">w</span><span class="op" id="5490539">.</span><span class="ident" id="5490540">Write</span><span class="op" id="5490545">(</span><span class="ident" id="5490546">b</span><span class="op" id="5490547">.</span><span class="ident" id="5490548">e</span><span class="op" id="5490549">.</span><span class="ident" id="5490550">buf</span><span class="op" id="5490553">[</span><span class="op" id="5490554">:</span><span class="ident" id="5490555">n</span><span class="op" id="5490556">+</span><span class="num" id="5490557">1</span><span class="op" id="5490558">]</span><span class="op" id="5490559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5490563">if</span>&nbsp;<span class="ident" id="5490566">b</span><span class="op" id="5490567">.</span><span class="ident" id="5490568">e</span><span class="op" id="5490569">.</span><span class="ident" id="5490570">err</span>&nbsp;<span class="op" id="5490574">!=</span>&nbsp;<span class="ident" id="5490577">nil</span>&nbsp;<span class="op" id="5490581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5490586">return</span>&nbsp;<span class="num" id="5490593">0</span><span class="op" id="5490594">,</span>&nbsp;<span class="ident" id="5490596">b</span><span class="op" id="5490597">.</span><span class="ident" id="5490598">e</span><span class="op" id="5490599">.</span><span class="ident" id="5490600">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5490606">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5490609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5490612">return</span>&nbsp;<span class="ident" id="5490619">total</span><span class="op" id="5490624">,</span>&nbsp;<span class="ident" id="5490626">b</span><span class="op" id="5490627">.</span><span class="ident" id="5490628">e</span><span class="op" id="5490629">.</span><span class="ident" id="5490630">err</span><br>
<span class="lineno"></span><span class="op" id="5490634">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5490637">func</span>&nbsp;<span class="op" id="5490642">(</span><span class="ident" id="5490643">e</span>&nbsp;<span class="op" id="5490645">*</span><span class="ident" id="5490646">encoder</span><span class="op" id="5490653">)</span>&nbsp;<span class="ident" id="5490655">flush</span><span class="op" id="5490660">(</span><span class="op" id="5490661">)</span>&nbsp;<span class="op" id="5490663">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5490666">if</span>&nbsp;<span class="ident" id="5490669">e</span><span class="op" id="5490670">.</span><span class="ident" id="5490671">err</span>&nbsp;<span class="op" id="5490675">!=</span>&nbsp;<span class="ident" id="5490678">nil</span>&nbsp;<span class="op" id="5490682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5490686">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5490694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5490697">e</span><span class="op" id="5490698">.</span><span class="ident" id="5490699">err</span>&nbsp;<span class="op" id="5490703">=</span>&nbsp;<span class="ident" id="5490705">e</span><span class="op" id="5490706">.</span><span class="ident" id="5490707">w</span><span class="op" id="5490708">.</span><span class="ident" id="5490709">Flush</span><span class="op" id="5490714">(</span><span class="op" id="5490715">)</span><br>
<span class="lineno"></span><span class="op" id="5490717">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="keyword" id="5490720">func</span>&nbsp;<span class="op" id="5490725">(</span><span class="ident" id="5490726">e</span>&nbsp;<span class="op" id="5490728">*</span><span class="ident" id="5490729">encoder</span><span class="op" id="5490736">)</span>&nbsp;<span class="ident" id="5490738">write</span><span class="op" id="5490743">(</span><span class="ident" id="5490744">p</span>&nbsp;<span class="op" id="5490746">[</span><span class="op" id="5490747">]</span><span class="builtintype" id="5490748">byte</span><span class="op" id="5490752">)</span>&nbsp;<span class="op" id="5490754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5490757">if</span>&nbsp;<span class="ident" id="5490760">e</span><span class="op" id="5490761">.</span><span class="ident" id="5490762">err</span>&nbsp;<span class="op" id="5490766">!=</span>&nbsp;<span class="ident" id="5490769">nil</span>&nbsp;<span class="op" id="5490773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5490777">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5490785">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5490788">_</span><span class="op" id="5490789">,</span>&nbsp;<span class="ident" id="5490791">e</span><span class="op" id="5490792">.</span><span class="ident" id="5490793">err</span>&nbsp;<span class="op" id="5490797">=</span>&nbsp;<span class="ident" id="5490799">e</span><span class="op" id="5490800">.</span><span class="ident" id="5490801">w</span><span class="op" id="5490802">.</span><span class="ident" id="5490803">Write</span><span class="op" id="5490808">(</span><span class="ident" id="5490809">p</span><span class="op" id="5490810">)</span><br>
<span class="lineno"></span><span class="op" id="5490812">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5490815">func</span>&nbsp;<span class="op" id="5490820">(</span><span class="ident" id="5490821">e</span>&nbsp;<span class="op" id="5490823">*</span><span class="ident" id="5490824">encoder</span><span class="op" id="5490831">)</span>&nbsp;<span class="ident" id="5490833">writeByte</span><span class="op" id="5490842">(</span><span class="ident" id="5490843">b</span>&nbsp;<span class="builtintype" id="5490845">byte</span><span class="op" id="5490849">)</span>&nbsp;<span class="op" id="5490851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5490854">if</span>&nbsp;<span class="ident" id="5490857">e</span><span class="op" id="5490858">.</span><span class="ident" id="5490859">err</span>&nbsp;<span class="op" id="5490863">!=</span>&nbsp;<span class="ident" id="5490866">nil</span>&nbsp;<span class="op" id="5490870">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5490874">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5490882">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5490885">e</span><span class="op" id="5490886">.</span><span class="ident" id="5490887">err</span>&nbsp;<span class="op" id="5490891">=</span>&nbsp;<span class="ident" id="5490893">e</span><span class="op" id="5490894">.</span><span class="ident" id="5490895">w</span><span class="op" id="5490896">.</span><span class="ident" id="5490897">WriteByte</span><span class="op" id="5490906">(</span><span class="ident" id="5490907">b</span><span class="op" id="5490908">)</span><br>
<span class="lineno"></span><span class="op" id="5490910">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="keyword" id="5490913">func</span>&nbsp;<span class="op" id="5490918">(</span><span class="ident" id="5490919">e</span>&nbsp;<span class="op" id="5490921">*</span><span class="ident" id="5490922">encoder</span><span class="op" id="5490929">)</span>&nbsp;<span class="ident" id="5490931">writeHeader</span><span class="op" id="5490942">(</span><span class="op" id="5490943">)</span>&nbsp;<span class="op" id="5490945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5490948">if</span>&nbsp;<span class="ident" id="5490951">e</span><span class="op" id="5490952">.</span><span class="ident" id="5490953">err</span>&nbsp;<span class="op" id="5490957">!=</span>&nbsp;<span class="ident" id="5490960">nil</span>&nbsp;<span class="op" id="5490964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5490968">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5490976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5490979">_</span><span class="op" id="5490980">,</span>&nbsp;<span class="ident" id="5490982">e</span><span class="op" id="5490983">.</span><span class="ident" id="5490984">err</span>&nbsp;<span class="op" id="5490988">=</span>&nbsp;<span class="ident" id="5490990">io</span><span class="op" id="5490992">.</span><span class="ident" id="5490993">WriteString</span><span class="op" id="5491004">(</span><span class="ident" id="5491005">e</span><span class="op" id="5491006">.</span><span class="ident" id="5491007">w</span><span class="op" id="5491008">,</span>&nbsp;<span class="string" id="5491010">&#34;GIF89a&#34;</span><span class="op" id="5491018">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5491021">if</span>&nbsp;<span class="ident" id="5491024">e</span><span class="op" id="5491025">.</span><span class="ident" id="5491026">err</span>&nbsp;<span class="op" id="5491030">!=</span>&nbsp;<span class="ident" id="5491033">nil</span>&nbsp;<span class="op" id="5491037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5491041">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5491049">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491053">pm</span>&nbsp;<span class="op" id="5491056">:=</span>&nbsp;<span class="ident" id="5491059">e</span><span class="op" id="5491060">.</span><span class="ident" id="5491061">g</span><span class="op" id="5491062">.</span><span class="ident" id="5491063">Image</span><span class="op" id="5491068">[</span><span class="num" id="5491069">0</span><span class="op" id="5491070">]</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5491073">//&nbsp;Logical&nbsp;screen&nbsp;width&nbsp;and&nbsp;height.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491110">writeUint16</span><span class="op" id="5491121">(</span><span class="ident" id="5491122">e</span><span class="op" id="5491123">.</span><span class="ident" id="5491124">buf</span><span class="op" id="5491127">[</span><span class="num" id="5491128">0</span><span class="op" id="5491129">:</span><span class="num" id="5491130">2</span><span class="op" id="5491131">]</span><span class="op" id="5491132">,</span>&nbsp;<span class="builtintype" id="5491134">uint16</span><span class="op" id="5491140">(</span><span class="ident" id="5491141">pm</span><span class="op" id="5491143">.</span><span class="ident" id="5491144">Bounds</span><span class="op" id="5491150">(</span><span class="op" id="5491151">)</span><span class="op" id="5491152">.</span><span class="ident" id="5491153">Dx</span><span class="op" id="5491155">(</span><span class="op" id="5491156">)</span><span class="op" id="5491157">)</span><span class="op" id="5491158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491161">writeUint16</span><span class="op" id="5491172">(</span><span class="ident" id="5491173">e</span><span class="op" id="5491174">.</span><span class="ident" id="5491175">buf</span><span class="op" id="5491178">[</span><span class="num" id="5491179">2</span><span class="op" id="5491180">:</span><span class="num" id="5491181">4</span><span class="op" id="5491182">]</span><span class="op" id="5491183">,</span>&nbsp;<span class="builtintype" id="5491185">uint16</span><span class="op" id="5491191">(</span><span class="ident" id="5491192">pm</span><span class="op" id="5491194">.</span><span class="ident" id="5491195">Bounds</span><span class="op" id="5491201">(</span><span class="op" id="5491202">)</span><span class="op" id="5491203">.</span><span class="ident" id="5491204">Dy</span><span class="op" id="5491206">(</span><span class="op" id="5491207">)</span><span class="op" id="5491208">)</span><span class="op" id="5491209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491212">e</span><span class="op" id="5491213">.</span><span class="ident" id="5491214">write</span><span class="op" id="5491219">(</span><span class="ident" id="5491220">e</span><span class="op" id="5491221">.</span><span class="ident" id="5491222">buf</span><span class="op" id="5491225">[</span><span class="op" id="5491226">:</span><span class="num" id="5491227">4</span><span class="op" id="5491228">]</span><span class="op" id="5491229">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5491233">//&nbsp;All&nbsp;frames&nbsp;have&nbsp;a&nbsp;local&nbsp;color&nbsp;table,&nbsp;so&nbsp;a&nbsp;global&nbsp;color&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5491298">//&nbsp;is&nbsp;not&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491317">e</span><span class="op" id="5491318">.</span><span class="ident" id="5491319">buf</span><span class="op" id="5491322">[</span><span class="num" id="5491323">0</span><span class="op" id="5491324">]</span>&nbsp;<span class="op" id="5491326">=</span>&nbsp;<span class="num" id="5491328">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491334">e</span><span class="op" id="5491335">.</span><span class="ident" id="5491336">buf</span><span class="op" id="5491339">[</span><span class="num" id="5491340">1</span><span class="op" id="5491341">]</span>&nbsp;<span class="op" id="5491343">=</span>&nbsp;<span class="num" id="5491345">0x00</span>&nbsp;<span class="comment" id="5491350">//&nbsp;Background&nbsp;Color&nbsp;Index.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491378">e</span><span class="op" id="5491379">.</span><span class="ident" id="5491380">buf</span><span class="op" id="5491383">[</span><span class="num" id="5491384">2</span><span class="op" id="5491385">]</span>&nbsp;<span class="op" id="5491387">=</span>&nbsp;<span class="num" id="5491389">0x00</span>&nbsp;<span class="comment" id="5491394">//&nbsp;Pixel&nbsp;Aspect&nbsp;Ratio.</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491418">e</span><span class="op" id="5491419">.</span><span class="ident" id="5491420">write</span><span class="op" id="5491425">(</span><span class="ident" id="5491426">e</span><span class="op" id="5491427">.</span><span class="ident" id="5491428">buf</span><span class="op" id="5491431">[</span><span class="op" id="5491432">:</span><span class="num" id="5491433">3</span><span class="op" id="5491434">]</span><span class="op" id="5491435">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5491439">//&nbsp;Add&nbsp;animation&nbsp;info&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5491476">if</span>&nbsp;<span class="builtinfunc" id="5491479">len</span><span class="op" id="5491482">(</span><span class="ident" id="5491483">e</span><span class="op" id="5491484">.</span><span class="ident" id="5491485">g</span><span class="op" id="5491486">.</span><span class="ident" id="5491487">Image</span><span class="op" id="5491492">)</span>&nbsp;<span class="op" id="5491494">&gt;</span>&nbsp;<span class="num" id="5491496">1</span>&nbsp;<span class="op" id="5491498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491502">e</span><span class="op" id="5491503">.</span><span class="ident" id="5491504">buf</span><span class="op" id="5491507">[</span><span class="num" id="5491508">0</span><span class="op" id="5491509">]</span>&nbsp;<span class="op" id="5491511">=</span>&nbsp;<span class="num" id="5491513">0x21</span>&nbsp;<span class="comment" id="5491518">//&nbsp;Extension&nbsp;Introducer.</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491545">e</span><span class="op" id="5491546">.</span><span class="ident" id="5491547">buf</span><span class="op" id="5491550">[</span><span class="num" id="5491551">1</span><span class="op" id="5491552">]</span>&nbsp;<span class="op" id="5491554">=</span>&nbsp;<span class="num" id="5491556">0xff</span>&nbsp;<span class="comment" id="5491561">//&nbsp;Application&nbsp;Label.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491585">e</span><span class="op" id="5491586">.</span><span class="ident" id="5491587">buf</span><span class="op" id="5491590">[</span><span class="num" id="5491591">2</span><span class="op" id="5491592">]</span>&nbsp;<span class="op" id="5491594">=</span>&nbsp;<span class="num" id="5491596">0x0b</span>&nbsp;<span class="comment" id="5491601">//&nbsp;Block&nbsp;Size.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491618">e</span><span class="op" id="5491619">.</span><span class="ident" id="5491620">write</span><span class="op" id="5491625">(</span><span class="ident" id="5491626">e</span><span class="op" id="5491627">.</span><span class="ident" id="5491628">buf</span><span class="op" id="5491631">[</span><span class="op" id="5491632">:</span><span class="num" id="5491633">3</span><span class="op" id="5491634">]</span><span class="op" id="5491635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491639">_</span><span class="op" id="5491640">,</span>&nbsp;<span class="ident" id="5491642">e</span><span class="op" id="5491643">.</span><span class="ident" id="5491644">err</span>&nbsp;<span class="op" id="5491648">=</span>&nbsp;<span class="ident" id="5491650">io</span><span class="op" id="5491652">.</span><span class="ident" id="5491653">WriteString</span><span class="op" id="5491664">(</span><span class="ident" id="5491665">e</span><span class="op" id="5491666">.</span><span class="ident" id="5491667">w</span><span class="op" id="5491668">,</span>&nbsp;<span class="string" id="5491670">&#34;NETSCAPE2.0&#34;</span><span class="op" id="5491683">)</span>&nbsp;<span class="comment" id="5491685">//&nbsp;Application&nbsp;Identifier.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5491714">if</span>&nbsp;<span class="ident" id="5491717">e</span><span class="op" id="5491718">.</span><span class="ident" id="5491719">err</span>&nbsp;<span class="op" id="5491723">!=</span>&nbsp;<span class="ident" id="5491726">nil</span>&nbsp;<span class="op" id="5491730">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5491735">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5491744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491748">e</span><span class="op" id="5491749">.</span><span class="ident" id="5491750">buf</span><span class="op" id="5491753">[</span><span class="num" id="5491754">0</span><span class="op" id="5491755">]</span>&nbsp;<span class="op" id="5491757">=</span>&nbsp;<span class="num" id="5491759">0x03</span>&nbsp;<span class="comment" id="5491764">//&nbsp;Block&nbsp;Size.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491781">e</span><span class="op" id="5491782">.</span><span class="ident" id="5491783">buf</span><span class="op" id="5491786">[</span><span class="num" id="5491787">1</span><span class="op" id="5491788">]</span>&nbsp;<span class="op" id="5491790">=</span>&nbsp;<span class="num" id="5491792">0x01</span>&nbsp;<span class="comment" id="5491797">//&nbsp;Sub-block&nbsp;Index.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491819">writeUint16</span><span class="op" id="5491830">(</span><span class="ident" id="5491831">e</span><span class="op" id="5491832">.</span><span class="ident" id="5491833">buf</span><span class="op" id="5491836">[</span><span class="num" id="5491837">2</span><span class="op" id="5491838">:</span><span class="num" id="5491839">4</span><span class="op" id="5491840">]</span><span class="op" id="5491841">,</span>&nbsp;<span class="builtintype" id="5491843">uint16</span><span class="op" id="5491849">(</span><span class="ident" id="5491850">e</span><span class="op" id="5491851">.</span><span class="ident" id="5491852">g</span><span class="op" id="5491853">.</span><span class="ident" id="5491854">LoopCount</span><span class="op" id="5491863">)</span><span class="op" id="5491864">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491868">e</span><span class="op" id="5491869">.</span><span class="ident" id="5491870">buf</span><span class="op" id="5491873">[</span><span class="num" id="5491874">4</span><span class="op" id="5491875">]</span>&nbsp;<span class="op" id="5491877">=</span>&nbsp;<span class="num" id="5491879">0x00</span>&nbsp;<span class="comment" id="5491884">//&nbsp;Block&nbsp;Terminator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5491907">e</span><span class="op" id="5491908">.</span><span class="ident" id="5491909">write</span><span class="op" id="5491914">(</span><span class="ident" id="5491915">e</span><span class="op" id="5491916">.</span><span class="ident" id="5491917">buf</span><span class="op" id="5491920">[</span><span class="op" id="5491921">:</span><span class="num" id="5491922">5</span><span class="op" id="5491923">]</span><span class="op" id="5491924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5491927">}</span><br>
<span class="lineno"></span><span class="op" id="5491929">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="keyword" id="5491932">func</span>&nbsp;<span class="op" id="5491937">(</span><span class="ident" id="5491938">e</span>&nbsp;<span class="op" id="5491940">*</span><span class="ident" id="5491941">encoder</span><span class="op" id="5491948">)</span>&nbsp;<span class="ident" id="5491950">writeColorTable</span><span class="op" id="5491965">(</span><span class="ident" id="5491966">p</span>&nbsp;<span class="ident" id="5491968">color</span><span class="op" id="5491973">.</span><span class="ident" id="5491974">Palette</span><span class="op" id="5491981">,</span>&nbsp;<span class="ident" id="5491983">size</span>&nbsp;<span class="builtintype" id="5491988">int</span><span class="op" id="5491991">)</span>&nbsp;<span class="op" id="5491993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5491996">if</span>&nbsp;<span class="ident" id="5491999">e</span><span class="op" id="5492000">.</span><span class="ident" id="5492001">err</span>&nbsp;<span class="op" id="5492005">!=</span>&nbsp;<span class="ident" id="5492008">nil</span>&nbsp;<span class="op" id="5492012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5492016">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5492024">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5492028">for</span>&nbsp;<span class="ident" id="5492032">i</span>&nbsp;<span class="op" id="5492034">:=</span>&nbsp;<span class="num" id="5492037">0</span><span class="op" id="5492038">;</span>&nbsp;<span class="ident" id="5492040">i</span>&nbsp;<span class="op" id="5492042">&lt;</span>&nbsp;<span class="ident" id="5492044">log2Lookup</span><span class="op" id="5492054">[</span><span class="ident" id="5492055">size</span><span class="op" id="5492059">]</span><span class="op" id="5492060">;</span>&nbsp;<span class="ident" id="5492062">i</span><span class="op" id="5492063">++</span>&nbsp;<span class="op" id="5492066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5492070">if</span>&nbsp;<span class="ident" id="5492073">i</span>&nbsp;<span class="op" id="5492075">&lt;</span>&nbsp;<span class="builtinfunc" id="5492077">len</span><span class="op" id="5492080">(</span><span class="ident" id="5492081">p</span><span class="op" id="5492082">)</span>&nbsp;<span class="op" id="5492084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5492089">r</span><span class="op" id="5492090">,</span>&nbsp;<span class="ident" id="5492092">g</span><span class="op" id="5492093">,</span>&nbsp;<span class="ident" id="5492095">b</span><span class="op" id="5492096">,</span>&nbsp;<span class="ident" id="5492098">_</span>&nbsp;<span class="op" id="5492100">:=</span>&nbsp;<span class="ident" id="5492103">p</span><span class="op" id="5492104">[</span><span class="ident" id="5492105">i</span><span class="op" id="5492106">]</span><span class="op" id="5492107">.</span><span class="ident" id="5492108">RGBA</span><span class="op" id="5492112">(</span><span class="op" id="5492113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5492118">e</span><span class="op" id="5492119">.</span><span class="ident" id="5492120">buf</span><span class="op" id="5492123">[</span><span class="num" id="5492124">3</span><span class="op" id="5492125">*</span><span class="ident" id="5492126">i</span><span class="op" id="5492127">+</span><span class="num" id="5492128">0</span><span class="op" id="5492129">]</span>&nbsp;<span class="op" id="5492131">=</span>&nbsp;<span class="builtintype" id="5492133">uint8</span><span class="op" id="5492138">(</span><span class="ident" id="5492139">r</span>&nbsp;<span class="op" id="5492141">&gt;&gt;</span>&nbsp;<span class="num" id="5492144">8</span><span class="op" id="5492145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5492150">e</span><span class="op" id="5492151">.</span><span class="ident" id="5492152">buf</span><span class="op" id="5492155">[</span><span class="num" id="5492156">3</span><span class="op" id="5492157">*</span><span class="ident" id="5492158">i</span><span class="op" id="5492159">+</span><span class="num" id="5492160">1</span><span class="op" id="5492161">]</span>&nbsp;<span class="op" id="5492163">=</span>&nbsp;<span class="builtintype" id="5492165">uint8</span><span class="op" id="5492170">(</span><span class="ident" id="5492171">g</span>&nbsp;<span class="op" id="5492173">&gt;&gt;</span>&nbsp;<span class="num" id="5492176">8</span><span class="op" id="5492177">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5492182">e</span><span class="op" id="5492183">.</span><span class="ident" id="5492184">buf</span><span class="op" id="5492187">[</span><span class="num" id="5492188">3</span><span class="op" id="5492189">*</span><span class="ident" id="5492190">i</span><span class="op" id="5492191">+</span><span class="num" id="5492192">2</span><span class="op" id="5492193">]</span>&nbsp;<span class="op" id="5492195">=</span>&nbsp;<span class="builtintype" id="5492197">uint8</span><span class="op" id="5492202">(</span><span class="ident" id="5492203">b</span>&nbsp;<span class="op" id="5492205">&gt;&gt;</span>&nbsp;<span class="num" id="5492208">8</span><span class="op" id="5492209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5492213">}</span>&nbsp;<span class="keyword" id="5492215">else</span>&nbsp;<span class="op" id="5492220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5492225">//&nbsp;Pad&nbsp;with&nbsp;black.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5492247">e</span><span class="op" id="5492248">.</span><span class="ident" id="5492249">buf</span><span class="op" id="5492252">[</span><span class="num" id="5492253">3</span><span class="op" id="5492254">*</span><span class="ident" id="5492255">i</span><span class="op" id="5492256">+</span><span class="num" id="5492257">0</span><span class="op" id="5492258">]</span>&nbsp;<span class="op" id="5492260">=</span>&nbsp;<span class="num" id="5492262">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5492270">e</span><span class="op" id="5492271">.</span><span class="ident" id="5492272">buf</span><span class="op" id="5492275">[</span><span class="num" id="5492276">3</span><span class="op" id="5492277">*</span><span class="ident" id="5492278">i</span><span class="op" id="5492279">+</span><span class="num" id="5492280">1</span><span class="op" id="5492281">]</span>&nbsp;<span class="op" id="5492283">=</span>&nbsp;<span class="num" id="5492285">0x00</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5492293">e</span><span class="op" id="5492294">.</span><span class="ident" id="5492295">buf</span><span class="op" id="5492298">[</span><span class="num" id="5492299">3</span><span class="op" id="5492300">*</span><span class="ident" id="5492301">i</span><span class="op" id="5492302">+</span><span class="num" id="5492303">2</span><span class="op" id="5492304">]</span>&nbsp;<span class="op" id="5492306">=</span>&nbsp;<span class="num" id="5492308">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5492315">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5492318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5492321">e</span><span class="op" id="5492322">.</span><span class="ident" id="5492323">write</span><span class="op" id="5492328">(</span><span class="ident" id="5492329">e</span><span class="op" id="5492330">.</span><span class="ident" id="5492331">buf</span><span class="op" id="5492334">[</span><span class="op" id="5492335">:</span><span class="num" id="5492336">3</span><span class="op" id="5492337">*</span><span class="ident" id="5492338">log2Lookup</span><span class="op" id="5492348">[</span><span class="ident" id="5492349">size</span><span class="op" id="5492353">]</span><span class="op" id="5492354">]</span><span class="op" id="5492355">)</span><br>
<span class="lineno"></span><span class="op" id="5492357">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="keyword" id="5492360">func</span>&nbsp;<span class="op" id="5492365">(</span><span class="ident" id="5492366">e</span>&nbsp;<span class="op" id="5492368">*</span><span class="ident" id="5492369">encoder</span><span class="op" id="5492376">)</span>&nbsp;<span class="ident" id="5492378">writeImageBlock</span><span class="op" id="5492393">(</span><span class="ident" id="5492394">pm</span>&nbsp;<span class="op" id="5492397">*</span><span class="ident" id="5492398">image</span><span class="op" id="5492403">.</span><span class="ident" id="5492404">Paletted</span><span class="op" id="5492412">,</span>&nbsp;<span class="ident" id="5492414">delay</span>&nbsp;<span class="builtintype" id="5492420">int</span><span class="op" id="5492423">)</span>&nbsp;<span class="op" id="5492425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5492428">if</span>&nbsp;<span class="ident" id="5492431">e</span><span class="op" id="5492432">.</span><span class="ident" id="5492433">err</span>&nbsp;<span class="op" id="5492437">!=</span>&nbsp;<span class="ident" id="5492440">nil</span>&nbsp;<span class="op" id="5492444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5492448">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5492456">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5492460">if</span>&nbsp;<span class="builtinfunc" id="5492463">len</span><span class="op" id="5492466">(</span><span class="ident" id="5492467">pm</span><span class="op" id="5492469">.</span><span class="ident" id="5492470">Palette</span><span class="op" id="5492477">)</span>&nbsp;<span class="op" id="5492479">==</span>&nbsp;<span class="num" id="5492482">0</span>&nbsp;<span class="op" id="5492484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5492488">e</span><span class="op" id="5492489">.</span><span class="ident" id="5492490">err</span>&nbsp;<span class="op" id="5492494">=</span>&nbsp;<span class="ident" id="5492496">errors</span><span class="op" id="5492502">.</span><span class="ident" id="5492503">New</span><span class="op" id="5492506">(</span><span class="string" id="5492507">&#34;gif:&nbsp;cannot&nbsp;encode&nbsp;image&nbsp;block&nbsp;with&nbsp;empty&nbsp;palette&#34;</span><span class="op" id="5492558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5492562">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5492570">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5492574">b</span>&nbsp;<span class="op" id="5492576">:=</span>&nbsp;<span class="ident" id="5492579">pm</span><span class="op" id="5492581">.</span><span class="ident" id="5492582">Bounds</span><span class="op" id="5492588">(</span><span class="op" id="5492589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5492592">if</span>&nbsp;<span class="ident" id="5492595">b</span><span class="op" id="5492596">.</span><span class="ident" id="5492597">Dx</span><span class="op" id="5492599">(</span><span class="op" id="5492600">)</span>&nbsp;<span class="op" id="5492602">&gt;=</span>&nbsp;<span class="num" id="5492605">1</span><span class="op" id="5492606">&lt;&lt;</span><span class="num" id="5492608">16</span>&nbsp;<span class="op" id="5492611">||</span>&nbsp;<span class="ident" id="5492614">b</span><span class="op" id="5492615">.</span><span class="ident" id="5492616">Dy</span><span class="op" id="5492618">(</span><span class="op" id="5492619">)</span>&nbsp;<span class="op" id="5492621">&gt;=</span>&nbsp;<span class="num" id="5492624">1</span><span class="op" id="5492625">&lt;&lt;</span><span class="num" id="5492627">16</span>&nbsp;<span class="op" id="5492630">||</span>&nbsp;<span class="ident" id="5492633">b</span><span class="op" id="5492634">.</span><span class="ident" id="5492635">Min</span><span class="op" id="5492638">.</span><span class="ident" id="5492639">X</span>&nbsp;<span class="op" id="5492641">&lt;</span>&nbsp;<span class="num" id="5492643">0</span>&nbsp;<span class="op" id="5492645">||</span>&nbsp;<span class="ident" id="5492648">b</span><span class="op" id="5492649">.</span><span class="ident" id="5492650">Min</span><span class="op" id="5492653">.</span><span class="ident" id="5492654">X</span>&nbsp;<span class="op" id="5492656">&gt;=</span>&nbsp;<span class="num" id="5492659">1</span><span class="op" id="5492660">&lt;&lt;</span><span class="num" id="5492662">16</span>&nbsp;<span class="op" id="5492665">||</span>&nbsp;<span class="ident" id="5492668">b</span><span class="op" id="5492669">.</span><span class="ident" id="5492670">Min</span><span class="op" id="5492673">.</span><span class="ident" id="5492674">Y</span>&nbsp;<span class="op" id="5492676">&lt;</span>&nbsp;<span class="num" id="5492678">0</span>&nbsp;<span class="op" id="5492680">||</span>&nbsp;<span class="ident" id="5492683">b</span><span class="op" id="5492684">.</span><span class="ident" id="5492685">Min</span><span class="op" id="5492688">.</span><span class="ident" id="5492689">Y</span>&nbsp;<span class="op" id="5492691">&gt;=</span>&nbsp;<span class="num" id="5492694">1</span><span class="op" id="5492695">&lt;&lt;</span><span class="num" id="5492697">16</span>&nbsp;<span class="op" id="5492700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5492704">e</span><span class="op" id="5492705">.</span><span class="ident" id="5492706">err</span>&nbsp;<span class="op" id="5492710">=</span>&nbsp;<span class="ident" id="5492712">errors</span><span class="op" id="5492718">.</span><span class="ident" id="5492719">New</span><span class="op" id="5492722">(</span><span class="string" id="5492723">&#34;gif:&nbsp;image&nbsp;block&nbsp;is&nbsp;too&nbsp;large&nbsp;to&nbsp;encode&#34;</span><span class="op" id="5492764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5492768">return</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5492776">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5492780">transparentIndex</span>&nbsp;<span class="op" id="5492797">:=</span>&nbsp;<span class="op" id="5492800">-</span><span class="num" id="5492801">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5492804">for</span>&nbsp;<span class="ident" id="5492808">i</span><span class="op" id="5492809">,</span>&nbsp;<span class="ident" id="5492811">c</span>&nbsp;<span class="op" id="5492813">:=</span>&nbsp;<span class="keyword" id="5492816">range</span>&nbsp;<span class="ident" id="5492822">pm</span><span class="op" id="5492824">.</span><span class="ident" id="5492825">Palette</span>&nbsp;<span class="op" id="5492833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5492837">if</span>&nbsp;<span class="ident" id="5492840">_</span><span class="op" id="5492841">,</span>&nbsp;<span class="ident" id="5492843">_</span><span class="op" id="5492844">,</span>&nbsp;<span class="ident" id="5492846">_</span><span class="op" id="5492847">,</span>&nbsp;<span class="ident" id="5492849">a</span>&nbsp;<span class="op" id="5492851">:=</span>&nbsp;<span class="ident" id="5492854">c</span><span class="op" id="5492855">.</span><span class="ident" id="5492856">RGBA</span><span class="op" id="5492860">(</span><span class="op" id="5492861">)</span><span class="op" id="5492862">;</span>&nbsp;<span class="ident" id="5492864">a</span>&nbsp;<span class="op" id="5492866">==</span>&nbsp;<span class="num" id="5492869">0</span>&nbsp;<span class="op" id="5492871">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5492876">transparentIndex</span>&nbsp;<span class="op" id="5492893">=</span>&nbsp;<span class="ident" id="5492895">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5492900">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5492908">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5492911">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5492915">if</span>&nbsp;<span class="ident" id="5492918">delay</span>&nbsp;<span class="op" id="5492924">&gt;</span>&nbsp;<span class="num" id="5492926">0</span>&nbsp;<span class="op" id="5492928">||</span>&nbsp;<span class="ident" id="5492931">transparentIndex</span>&nbsp;<span class="op" id="5492948">!=</span>&nbsp;<span class="op" id="5492951">-</span><span class="num" id="5492952">1</span>&nbsp;<span class="op" id="5492954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5492958">e</span><span class="op" id="5492959">.</span><span class="ident" id="5492960">buf</span><span class="op" id="5492963">[</span><span class="num" id="5492964">0</span><span class="op" id="5492965">]</span>&nbsp;<span class="op" id="5492967">=</span>&nbsp;<span class="ident" id="5492969">sExtension</span>&nbsp;&nbsp;<span class="comment" id="5492981">//&nbsp;Extension&nbsp;Introducer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493008">e</span><span class="op" id="5493009">.</span><span class="ident" id="5493010">buf</span><span class="op" id="5493013">[</span><span class="num" id="5493014">1</span><span class="op" id="5493015">]</span>&nbsp;<span class="op" id="5493017">=</span>&nbsp;<span class="ident" id="5493019">gcLabel</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5493031">//&nbsp;Graphic&nbsp;Control&nbsp;Label.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493059">e</span><span class="op" id="5493060">.</span><span class="ident" id="5493061">buf</span><span class="op" id="5493064">[</span><span class="num" id="5493065">2</span><span class="op" id="5493066">]</span>&nbsp;<span class="op" id="5493068">=</span>&nbsp;<span class="ident" id="5493070">gcBlockSize</span>&nbsp;<span class="comment" id="5493082">//&nbsp;Block&nbsp;Size.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5493099">if</span>&nbsp;<span class="ident" id="5493102">transparentIndex</span>&nbsp;<span class="op" id="5493119">!=</span>&nbsp;<span class="op" id="5493122">-</span><span class="num" id="5493123">1</span>&nbsp;<span class="op" id="5493125">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493130">e</span><span class="op" id="5493131">.</span><span class="ident" id="5493132">buf</span><span class="op" id="5493135">[</span><span class="num" id="5493136">3</span><span class="op" id="5493137">]</span>&nbsp;<span class="op" id="5493139">=</span>&nbsp;<span class="num" id="5493141">0x01</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5493148">}</span>&nbsp;<span class="keyword" id="5493150">else</span>&nbsp;<span class="op" id="5493155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493160">e</span><span class="op" id="5493161">.</span><span class="ident" id="5493162">buf</span><span class="op" id="5493165">[</span><span class="num" id="5493166">3</span><span class="op" id="5493167">]</span>&nbsp;<span class="op" id="5493169">=</span>&nbsp;<span class="num" id="5493171">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5493178">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493182">writeUint16</span><span class="op" id="5493193">(</span><span class="ident" id="5493194">e</span><span class="op" id="5493195">.</span><span class="ident" id="5493196">buf</span><span class="op" id="5493199">[</span><span class="num" id="5493200">4</span><span class="op" id="5493201">:</span><span class="num" id="5493202">6</span><span class="op" id="5493203">]</span><span class="op" id="5493204">,</span>&nbsp;<span class="builtintype" id="5493206">uint16</span><span class="op" id="5493212">(</span><span class="ident" id="5493213">delay</span><span class="op" id="5493218">)</span><span class="op" id="5493219">)</span>&nbsp;<span class="comment" id="5493221">//&nbsp;Delay&nbsp;Time&nbsp;(1/100ths&nbsp;of&nbsp;a&nbsp;second)</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5493261">//&nbsp;Transparent&nbsp;color&nbsp;index.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5493291">if</span>&nbsp;<span class="ident" id="5493294">transparentIndex</span>&nbsp;<span class="op" id="5493311">!=</span>&nbsp;<span class="op" id="5493314">-</span><span class="num" id="5493315">1</span>&nbsp;<span class="op" id="5493317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493322">e</span><span class="op" id="5493323">.</span><span class="ident" id="5493324">buf</span><span class="op" id="5493327">[</span><span class="num" id="5493328">6</span><span class="op" id="5493329">]</span>&nbsp;<span class="op" id="5493331">=</span>&nbsp;<span class="builtintype" id="5493333">uint8</span><span class="op" id="5493338">(</span><span class="ident" id="5493339">transparentIndex</span><span class="op" id="5493355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5493359">}</span>&nbsp;<span class="keyword" id="5493361">else</span>&nbsp;<span class="op" id="5493366">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493371">e</span><span class="op" id="5493372">.</span><span class="ident" id="5493373">buf</span><span class="op" id="5493376">[</span><span class="num" id="5493377">6</span><span class="op" id="5493378">]</span>&nbsp;<span class="op" id="5493380">=</span>&nbsp;<span class="num" id="5493382">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5493389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493393">e</span><span class="op" id="5493394">.</span><span class="ident" id="5493395">buf</span><span class="op" id="5493398">[</span><span class="num" id="5493399">7</span><span class="op" id="5493400">]</span>&nbsp;<span class="op" id="5493402">=</span>&nbsp;<span class="num" id="5493404">0x00</span>&nbsp;<span class="comment" id="5493409">//&nbsp;Block&nbsp;Terminator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493432">e</span><span class="op" id="5493433">.</span><span class="ident" id="5493434">write</span><span class="op" id="5493439">(</span><span class="ident" id="5493440">e</span><span class="op" id="5493441">.</span><span class="ident" id="5493442">buf</span><span class="op" id="5493445">[</span><span class="op" id="5493446">:</span><span class="num" id="5493447">8</span><span class="op" id="5493448">]</span><span class="op" id="5493449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5493452">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493455">e</span><span class="op" id="5493456">.</span><span class="ident" id="5493457">buf</span><span class="op" id="5493460">[</span><span class="num" id="5493461">0</span><span class="op" id="5493462">]</span>&nbsp;<span class="op" id="5493464">=</span>&nbsp;<span class="ident" id="5493466">sImageDescriptor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493484">writeUint16</span><span class="op" id="5493495">(</span><span class="ident" id="5493496">e</span><span class="op" id="5493497">.</span><span class="ident" id="5493498">buf</span><span class="op" id="5493501">[</span><span class="num" id="5493502">1</span><span class="op" id="5493503">:</span><span class="num" id="5493504">3</span><span class="op" id="5493505">]</span><span class="op" id="5493506">,</span>&nbsp;<span class="builtintype" id="5493508">uint16</span><span class="op" id="5493514">(</span><span class="ident" id="5493515">b</span><span class="op" id="5493516">.</span><span class="ident" id="5493517">Min</span><span class="op" id="5493520">.</span><span class="ident" id="5493521">X</span><span class="op" id="5493522">)</span><span class="op" id="5493523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493526">writeUint16</span><span class="op" id="5493537">(</span><span class="ident" id="5493538">e</span><span class="op" id="5493539">.</span><span class="ident" id="5493540">buf</span><span class="op" id="5493543">[</span><span class="num" id="5493544">3</span><span class="op" id="5493545">:</span><span class="num" id="5493546">5</span><span class="op" id="5493547">]</span><span class="op" id="5493548">,</span>&nbsp;<span class="builtintype" id="5493550">uint16</span><span class="op" id="5493556">(</span><span class="ident" id="5493557">b</span><span class="op" id="5493558">.</span><span class="ident" id="5493559">Min</span><span class="op" id="5493562">.</span><span class="ident" id="5493563">Y</span><span class="op" id="5493564">)</span><span class="op" id="5493565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493568">writeUint16</span><span class="op" id="5493579">(</span><span class="ident" id="5493580">e</span><span class="op" id="5493581">.</span><span class="ident" id="5493582">buf</span><span class="op" id="5493585">[</span><span class="num" id="5493586">5</span><span class="op" id="5493587">:</span><span class="num" id="5493588">7</span><span class="op" id="5493589">]</span><span class="op" id="5493590">,</span>&nbsp;<span class="builtintype" id="5493592">uint16</span><span class="op" id="5493598">(</span><span class="ident" id="5493599">b</span><span class="op" id="5493600">.</span><span class="ident" id="5493601">Dx</span><span class="op" id="5493603">(</span><span class="op" id="5493604">)</span><span class="op" id="5493605">)</span><span class="op" id="5493606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493609">writeUint16</span><span class="op" id="5493620">(</span><span class="ident" id="5493621">e</span><span class="op" id="5493622">.</span><span class="ident" id="5493623">buf</span><span class="op" id="5493626">[</span><span class="num" id="5493627">7</span><span class="op" id="5493628">:</span><span class="num" id="5493629">9</span><span class="op" id="5493630">]</span><span class="op" id="5493631">,</span>&nbsp;<span class="builtintype" id="5493633">uint16</span><span class="op" id="5493639">(</span><span class="ident" id="5493640">b</span><span class="op" id="5493641">.</span><span class="ident" id="5493642">Dy</span><span class="op" id="5493644">(</span><span class="op" id="5493645">)</span><span class="op" id="5493646">)</span><span class="op" id="5493647">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493650">e</span><span class="op" id="5493651">.</span><span class="ident" id="5493652">write</span><span class="op" id="5493657">(</span><span class="ident" id="5493658">e</span><span class="op" id="5493659">.</span><span class="ident" id="5493660">buf</span><span class="op" id="5493663">[</span><span class="op" id="5493664">:</span><span class="num" id="5493665">9</span><span class="op" id="5493666">]</span><span class="op" id="5493667">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493671">paddedSize</span>&nbsp;<span class="op" id="5493682">:=</span>&nbsp;<span class="ident" id="5493685">log2</span><span class="op" id="5493689">(</span><span class="builtinfunc" id="5493690">len</span><span class="op" id="5493693">(</span><span class="ident" id="5493694">pm</span><span class="op" id="5493696">.</span><span class="ident" id="5493697">Palette</span><span class="op" id="5493704">)</span><span class="op" id="5493705">)</span>&nbsp;<span class="comment" id="5493707">//&nbsp;Size&nbsp;of&nbsp;Local&nbsp;Color&nbsp;Table:&nbsp;2^(1+n).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5493747">//&nbsp;Interlacing&nbsp;is&nbsp;not&nbsp;supported.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493781">e</span><span class="op" id="5493782">.</span><span class="ident" id="5493783">writeByte</span><span class="op" id="5493792">(</span><span class="num" id="5493793">0x80</span>&nbsp;<span class="op" id="5493798">|</span>&nbsp;<span class="builtintype" id="5493800">uint8</span><span class="op" id="5493805">(</span><span class="ident" id="5493806">paddedSize</span><span class="op" id="5493816">)</span><span class="op" id="5493817">)</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5493821">//&nbsp;Local&nbsp;Color&nbsp;Table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493844">e</span><span class="op" id="5493845">.</span><span class="ident" id="5493846">writeColorTable</span><span class="op" id="5493861">(</span><span class="ident" id="5493862">pm</span><span class="op" id="5493864">.</span><span class="ident" id="5493865">Palette</span><span class="op" id="5493872">,</span>&nbsp;<span class="ident" id="5493874">paddedSize</span><span class="op" id="5493884">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493888">litWidth</span>&nbsp;<span class="op" id="5493897">:=</span>&nbsp;<span class="ident" id="5493900">paddedSize</span>&nbsp;<span class="op" id="5493911">+</span>&nbsp;<span class="num" id="5493913">1</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5493916">if</span>&nbsp;<span class="ident" id="5493919">litWidth</span>&nbsp;<span class="op" id="5493928">&lt;</span>&nbsp;<span class="num" id="5493930">2</span>&nbsp;<span class="op" id="5493932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493936">litWidth</span>&nbsp;<span class="op" id="5493945">=</span>&nbsp;<span class="num" id="5493947">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5493950">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5493953">e</span><span class="op" id="5493954">.</span><span class="ident" id="5493955">writeByte</span><span class="op" id="5493964">(</span><span class="builtintype" id="5493965">uint8</span><span class="op" id="5493970">(</span><span class="ident" id="5493971">litWidth</span><span class="op" id="5493979">)</span><span class="op" id="5493980">)</span>&nbsp;<span class="comment" id="5493982">//&nbsp;LZW&nbsp;Minimum&nbsp;Code&nbsp;Size.</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5494010">lzww</span>&nbsp;<span class="op" id="5494015">:=</span>&nbsp;<span class="ident" id="5494018">lzw</span><span class="op" id="5494021">.</span><span class="ident" id="5494022">NewWriter</span><span class="op" id="5494031">(</span><span class="ident" id="5494032">blockWriter</span><span class="op" id="5494043">{</span><span class="ident" id="5494044">e</span><span class="op" id="5494045">:</span>&nbsp;<span class="ident" id="5494047">e</span><span class="op" id="5494048">}</span><span class="op" id="5494049">,</span>&nbsp;<span class="ident" id="5494051">lzw</span><span class="op" id="5494054">.</span><span class="ident" id="5494055">LSB</span><span class="op" id="5494058">,</span>&nbsp;<span class="ident" id="5494060">litWidth</span><span class="op" id="5494068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5494071">if</span>&nbsp;<span class="ident" id="5494074">dx</span>&nbsp;<span class="op" id="5494077">:=</span>&nbsp;<span class="ident" id="5494080">b</span><span class="op" id="5494081">.</span><span class="ident" id="5494082">Dx</span><span class="op" id="5494084">(</span><span class="op" id="5494085">)</span><span class="op" id="5494086">;</span>&nbsp;<span class="ident" id="5494088">dx</span>&nbsp;<span class="op" id="5494091">==</span>&nbsp;<span class="ident" id="5494094">pm</span><span class="op" id="5494096">.</span><span class="ident" id="5494097">Stride</span>&nbsp;<span class="op" id="5494104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5494108">_</span><span class="op" id="5494109">,</span>&nbsp;<span class="ident" id="5494111">e</span><span class="op" id="5494112">.</span><span class="ident" id="5494113">err</span>&nbsp;<span class="op" id="5494117">=</span>&nbsp;<span class="ident" id="5494119">lzww</span><span class="op" id="5494123">.</span><span class="ident" id="5494124">Write</span><span class="op" id="5494129">(</span><span class="ident" id="5494130">pm</span><span class="op" id="5494132">.</span><span class="ident" id="5494133">Pix</span><span class="op" id="5494136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5494140">if</span>&nbsp;<span class="ident" id="5494143">e</span><span class="op" id="5494144">.</span><span class="ident" id="5494145">err</span>&nbsp;<span class="op" id="5494149">!=</span>&nbsp;<span class="ident" id="5494152">nil</span>&nbsp;<span class="op" id="5494156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5494161">lzww</span><span class="op" id="5494165">.</span><span class="ident" id="5494166">Close</span><span class="op" id="5494171">(</span><span class="op" id="5494172">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5494177">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5494186">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5494189">}</span>&nbsp;<span class="keyword" id="5494191">else</span>&nbsp;<span class="op" id="5494196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5494200">for</span>&nbsp;<span class="ident" id="5494204">i</span><span class="op" id="5494205">,</span>&nbsp;<span class="ident" id="5494207">y</span>&nbsp;<span class="op" id="5494209">:=</span>&nbsp;<span class="num" id="5494212">0</span><span class="op" id="5494213">,</span>&nbsp;<span class="ident" id="5494215">b</span><span class="op" id="5494216">.</span><span class="ident" id="5494217">Min</span><span class="op" id="5494220">.</span><span class="ident" id="5494221">Y</span><span class="op" id="5494222">;</span>&nbsp;<span class="ident" id="5494224">y</span>&nbsp;<span class="op" id="5494226">&lt;</span>&nbsp;<span class="ident" id="5494228">b</span><span class="op" id="5494229">.</span><span class="ident" id="5494230">Max</span><span class="op" id="5494233">.</span><span class="ident" id="5494234">Y</span><span class="op" id="5494235">;</span>&nbsp;<span class="ident" id="5494237">i</span><span class="op" id="5494238">,</span>&nbsp;<span class="ident" id="5494240">y</span>&nbsp;<span class="op" id="5494242">=</span>&nbsp;<span class="ident" id="5494244">i</span><span class="op" id="5494245">+</span><span class="ident" id="5494246">pm</span><span class="op" id="5494248">.</span><span class="ident" id="5494249">Stride</span><span class="op" id="5494255">,</span>&nbsp;<span class="ident" id="5494257">y</span><span class="op" id="5494258">+</span><span class="num" id="5494259">1</span>&nbsp;<span class="op" id="5494261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5494266">_</span><span class="op" id="5494267">,</span>&nbsp;<span class="ident" id="5494269">e</span><span class="op" id="5494270">.</span><span class="ident" id="5494271">err</span>&nbsp;<span class="op" id="5494275">=</span>&nbsp;<span class="ident" id="5494277">lzww</span><span class="op" id="5494281">.</span><span class="ident" id="5494282">Write</span><span class="op" id="5494287">(</span><span class="ident" id="5494288">pm</span><span class="op" id="5494290">.</span><span class="ident" id="5494291">Pix</span><span class="op" id="5494294">[</span><span class="ident" id="5494295">i</span>&nbsp;<span class="op" id="5494297">:</span>&nbsp;<span class="ident" id="5494299">i</span><span class="op" id="5494300">+</span><span class="ident" id="5494301">dx</span><span class="op" id="5494303">]</span><span class="op" id="5494304">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5494309">if</span>&nbsp;<span class="ident" id="5494312">e</span><span class="op" id="5494313">.</span><span class="ident" id="5494314">err</span>&nbsp;<span class="op" id="5494318">!=</span>&nbsp;<span class="ident" id="5494321">nil</span>&nbsp;<span class="op" id="5494325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5494331">lzww</span><span class="op" id="5494335">.</span><span class="ident" id="5494336">Close</span><span class="op" id="5494341">(</span><span class="op" id="5494342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5494348">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5494358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5494362">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5494365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5494368">lzww</span><span class="op" id="5494372">.</span><span class="ident" id="5494373">Close</span><span class="op" id="5494378">(</span><span class="op" id="5494379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5494382">e</span><span class="op" id="5494383">.</span><span class="ident" id="5494384">writeByte</span><span class="op" id="5494393">(</span><span class="num" id="5494394">0x00</span><span class="op" id="5494398">)</span>&nbsp;<span class="comment" id="5494400">//&nbsp;Block&nbsp;Terminator.</span><br>
<span class="lineno"></span><span class="op" id="5494421">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="comment" id="5494424">//&nbsp;Options&nbsp;are&nbsp;the&nbsp;encoding&nbsp;parameters.</span><br>
<span class="lineno"></span><span class="keyword" id="5494464">type</span>&nbsp;<span class="ident" id="5494469">Options</span>&nbsp;<span class="keyword" id="5494477">struct</span>&nbsp;<span class="op" id="5494484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5494487">//&nbsp;NumColors&nbsp;is&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;colors&nbsp;used&nbsp;in&nbsp;the&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5494552">//&nbsp;It&nbsp;ranges&nbsp;from&nbsp;1&nbsp;to&nbsp;256.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5494581">NumColors</span>&nbsp;<span class="builtintype" id="5494591">int</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5494597">//&nbsp;Quantizer&nbsp;is&nbsp;used&nbsp;to&nbsp;produce&nbsp;a&nbsp;palette&nbsp;with&nbsp;size&nbsp;NumColors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5494661">//&nbsp;palette.Plan9&nbsp;is&nbsp;used&nbsp;in&nbsp;place&nbsp;of&nbsp;a&nbsp;nil&nbsp;Quantizer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5494716">Quantizer</span>&nbsp;<span class="ident" id="5494726">draw</span><span class="op" id="5494730">.</span><span class="ident" id="5494731">Quantizer</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5494743">//&nbsp;Drawer&nbsp;is&nbsp;used&nbsp;to&nbsp;convert&nbsp;the&nbsp;source&nbsp;image&nbsp;to&nbsp;the&nbsp;desired&nbsp;palette.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5494814">//&nbsp;draw.FloydSteinberg&nbsp;is&nbsp;used&nbsp;in&nbsp;place&nbsp;of&nbsp;a&nbsp;nil&nbsp;Drawer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5494872">Drawer</span>&nbsp;<span class="ident" id="5494879">draw</span><span class="op" id="5494883">.</span><span class="ident" id="5494884">Drawer</span><br>
<span class="lineno"></span><span class="op" id="5494891">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="comment" id="5494894">//&nbsp;EncodeAll&nbsp;writes&nbsp;the&nbsp;images&nbsp;in&nbsp;g&nbsp;to&nbsp;w&nbsp;in&nbsp;GIF&nbsp;format&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5494958">//&nbsp;given&nbsp;loop&nbsp;count&nbsp;and&nbsp;delay&nbsp;between&nbsp;frames.</span><br>
<span class="lineno"></span><span class="keyword" id="5495004">func</span>&nbsp;<span class="ident" id="5495009">EncodeAll</span><span class="op" id="5495018">(</span><span class="ident" id="5495019">w</span>&nbsp;<span class="ident" id="5495021">io</span><span class="op" id="5495023">.</span><span class="ident" id="5495024">Writer</span><span class="op" id="5495030">,</span>&nbsp;<span class="ident" id="5495032">g</span>&nbsp;<span class="op" id="5495034">*</span><span class="ident" id="5495035">GIF</span><span class="op" id="5495038">)</span>&nbsp;<span class="builtintype" id="5495040">error</span>&nbsp;<span class="op" id="5495046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5495049">if</span>&nbsp;<span class="builtinfunc" id="5495052">len</span><span class="op" id="5495055">(</span><span class="ident" id="5495056">g</span><span class="op" id="5495057">.</span><span class="ident" id="5495058">Image</span><span class="op" id="5495063">)</span>&nbsp;<span class="op" id="5495065">==</span>&nbsp;<span class="num" id="5495068">0</span>&nbsp;<span class="op" id="5495070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5495074">return</span>&nbsp;<span class="ident" id="5495081">errors</span><span class="op" id="5495087">.</span><span class="ident" id="5495088">New</span><span class="op" id="5495091">(</span><span class="string" id="5495092">&#34;gif:&nbsp;must&nbsp;provide&nbsp;at&nbsp;least&nbsp;one&nbsp;image&#34;</span><span class="op" id="5495130">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5495133">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5495137">if</span>&nbsp;<span class="builtinfunc" id="5495140">len</span><span class="op" id="5495143">(</span><span class="ident" id="5495144">g</span><span class="op" id="5495145">.</span><span class="ident" id="5495146">Image</span><span class="op" id="5495151">)</span>&nbsp;<span class="op" id="5495153">!=</span>&nbsp;<span class="builtinfunc" id="5495156">len</span><span class="op" id="5495159">(</span><span class="ident" id="5495160">g</span><span class="op" id="5495161">.</span><span class="ident" id="5495162">Delay</span><span class="op" id="5495167">)</span>&nbsp;<span class="op" id="5495169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5495173">return</span>&nbsp;<span class="ident" id="5495180">errors</span><span class="op" id="5495186">.</span><span class="ident" id="5495187">New</span><span class="op" id="5495190">(</span><span class="string" id="5495191">&#34;gif:&nbsp;mismatched&nbsp;image&nbsp;and&nbsp;delay&nbsp;lengths&#34;</span><span class="op" id="5495232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5495235">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5495238">if</span>&nbsp;<span class="ident" id="5495241">g</span><span class="op" id="5495242">.</span><span class="ident" id="5495243">LoopCount</span>&nbsp;<span class="op" id="5495253">&lt;</span>&nbsp;<span class="num" id="5495255">0</span>&nbsp;<span class="op" id="5495257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5495261">g</span><span class="op" id="5495262">.</span><span class="ident" id="5495263">LoopCount</span>&nbsp;<span class="op" id="5495273">=</span>&nbsp;<span class="num" id="5495275">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5495278">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5495282">e</span>&nbsp;<span class="op" id="5495284">:=</span>&nbsp;<span class="ident" id="5495287">encoder</span><span class="op" id="5495294">{</span><span class="ident" id="5495295">g</span><span class="op" id="5495296">:</span>&nbsp;<span class="ident" id="5495298">g</span><span class="op" id="5495299">}</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5495302">if</span>&nbsp;<span class="ident" id="5495305">ww</span><span class="op" id="5495307">,</span>&nbsp;<span class="ident" id="5495309">ok</span>&nbsp;<span class="op" id="5495312">:=</span>&nbsp;<span class="ident" id="5495315">w</span><span class="op" id="5495316">.</span><span class="op" id="5495317">(</span><span class="ident" id="5495318">writer</span><span class="op" id="5495324">)</span><span class="op" id="5495325">;</span>&nbsp;<span class="ident" id="5495327">ok</span>&nbsp;<span class="op" id="5495330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5495334">e</span><span class="op" id="5495335">.</span><span class="ident" id="5495336">w</span>&nbsp;<span class="op" id="5495338">=</span>&nbsp;<span class="ident" id="5495340">ww</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5495344">}</span>&nbsp;<span class="keyword" id="5495346">else</span>&nbsp;<span class="op" id="5495351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5495355">e</span><span class="op" id="5495356">.</span><span class="ident" id="5495357">w</span>&nbsp;<span class="op" id="5495359">=</span>&nbsp;<span class="ident" id="5495361">bufio</span><span class="op" id="5495366">.</span><span class="ident" id="5495367">NewWriter</span><span class="op" id="5495376">(</span><span class="ident" id="5495377">w</span><span class="op" id="5495378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5495381">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5495385">e</span><span class="op" id="5495386">.</span><span class="ident" id="5495387">writeHeader</span><span class="op" id="5495398">(</span><span class="op" id="5495399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5495402">for</span>&nbsp;<span class="ident" id="5495406">i</span><span class="op" id="5495407">,</span>&nbsp;<span class="ident" id="5495409">pm</span>&nbsp;<span class="op" id="5495412">:=</span>&nbsp;<span class="keyword" id="5495415">range</span>&nbsp;<span class="ident" id="5495421">g</span><span class="op" id="5495422">.</span><span class="ident" id="5495423">Image</span>&nbsp;<span class="op" id="5495429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5495433">e</span><span class="op" id="5495434">.</span><span class="ident" id="5495435">writeImageBlock</span><span class="op" id="5495450">(</span><span class="ident" id="5495451">pm</span><span class="op" id="5495453">,</span>&nbsp;<span class="ident" id="5495455">g</span><span class="op" id="5495456">.</span><span class="ident" id="5495457">Delay</span><span class="op" id="5495462">[</span><span class="ident" id="5495463">i</span><span class="op" id="5495464">]</span><span class="op" id="5495465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5495468">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5495471">e</span><span class="op" id="5495472">.</span><span class="ident" id="5495473">writeByte</span><span class="op" id="5495482">(</span><span class="ident" id="5495483">sTrailer</span><span class="op" id="5495491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5495494">e</span><span class="op" id="5495495">.</span><span class="ident" id="5495496">flush</span><span class="op" id="5495501">(</span><span class="op" id="5495502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5495505">return</span>&nbsp;<span class="ident" id="5495512">e</span><span class="op" id="5495513">.</span><span class="ident" id="5495514">err</span><br>
<span class="lineno"></span><span class="op" id="5495518">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span><span class="comment" id="5495521">//&nbsp;Encode&nbsp;writes&nbsp;the&nbsp;Image&nbsp;m&nbsp;to&nbsp;w&nbsp;in&nbsp;GIF&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword" id="5495570">func</span>&nbsp;<span class="ident" id="5495575">Encode</span><span class="op" id="5495581">(</span><span class="ident" id="5495582">w</span>&nbsp;<span class="ident" id="5495584">io</span><span class="op" id="5495586">.</span><span class="ident" id="5495587">Writer</span><span class="op" id="5495593">,</span>&nbsp;<span class="ident" id="5495595">m</span>&nbsp;<span class="ident" id="5495597">image</span><span class="op" id="5495602">.</span><span class="ident" id="5495603">Image</span><span class="op" id="5495608">,</span>&nbsp;<span class="ident" id="5495610">o</span>&nbsp;<span class="op" id="5495612">*</span><span class="ident" id="5495613">Options</span><span class="op" id="5495620">)</span>&nbsp;<span class="builtintype" id="5495622">error</span>&nbsp;<span class="op" id="5495628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5495631">//&nbsp;Check&nbsp;for&nbsp;bounds&nbsp;and&nbsp;size&nbsp;restrictions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5495675">b</span>&nbsp;<span class="op" id="5495677">:=</span>&nbsp;<span class="ident" id="5495680">m</span><span class="op" id="5495681">.</span><span class="ident" id="5495682">Bounds</span><span class="op" id="5495688">(</span><span class="op" id="5495689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5495692">if</span>&nbsp;<span class="ident" id="5495695">b</span><span class="op" id="5495696">.</span><span class="ident" id="5495697">Dx</span><span class="op" id="5495699">(</span><span class="op" id="5495700">)</span>&nbsp;<span class="op" id="5495702">&gt;=</span>&nbsp;<span class="num" id="5495705">1</span><span class="op" id="5495706">&lt;&lt;</span><span class="num" id="5495708">16</span>&nbsp;<span class="op" id="5495711">||</span>&nbsp;<span class="ident" id="5495714">b</span><span class="op" id="5495715">.</span><span class="ident" id="5495716">Dy</span><span class="op" id="5495718">(</span><span class="op" id="5495719">)</span>&nbsp;<span class="op" id="5495721">&gt;=</span>&nbsp;<span class="num" id="5495724">1</span><span class="op" id="5495725">&lt;&lt;</span><span class="num" id="5495727">16</span>&nbsp;<span class="op" id="5495730">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5495734">return</span>&nbsp;<span class="ident" id="5495741">errors</span><span class="op" id="5495747">.</span><span class="ident" id="5495748">New</span><span class="op" id="5495751">(</span><span class="string" id="5495752">&#34;gif:&nbsp;image&nbsp;is&nbsp;too&nbsp;large&nbsp;to&nbsp;encode&#34;</span><span class="op" id="5495787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5495790">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5495794">opts</span>&nbsp;<span class="op" id="5495799">:=</span>&nbsp;<span class="ident" id="5495802">Options</span><span class="op" id="5495809">{</span><span class="op" id="5495810">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5495813">if</span>&nbsp;<span class="ident" id="5495816">o</span>&nbsp;<span class="op" id="5495818">!=</span>&nbsp;<span class="ident" id="5495821">nil</span>&nbsp;<span class="op" id="5495825">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5495829">opts</span>&nbsp;<span class="op" id="5495834">=</span>&nbsp;<span class="op" id="5495836">*</span><span class="ident" id="5495837">o</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5495840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5495843">if</span>&nbsp;<span class="ident" id="5495846">opts</span><span class="op" id="5495850">.</span><span class="ident" id="5495851">NumColors</span>&nbsp;<span class="op" id="5495861">&lt;</span>&nbsp;<span class="num" id="5495863">1</span>&nbsp;<span class="op" id="5495865">||</span>&nbsp;<span class="num" id="5495868">256</span>&nbsp;<span class="op" id="5495872">&lt;</span>&nbsp;<span class="ident" id="5495874">opts</span><span class="op" id="5495878">.</span><span class="ident" id="5495879">NumColors</span>&nbsp;<span class="op" id="5495889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5495893">opts</span><span class="op" id="5495897">.</span><span class="ident" id="5495898">NumColors</span>&nbsp;<span class="op" id="5495908">=</span>&nbsp;<span class="num" id="5495910">256</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5495915">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5495918">if</span>&nbsp;<span class="ident" id="5495921">opts</span><span class="op" id="5495925">.</span><span class="ident" id="5495926">Drawer</span>&nbsp;<span class="op" id="5495933">==</span>&nbsp;<span class="ident" id="5495936">nil</span>&nbsp;<span class="op" id="5495940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5495944">opts</span><span class="op" id="5495948">.</span><span class="ident" id="5495949">Drawer</span>&nbsp;<span class="op" id="5495956">=</span>&nbsp;<span class="ident" id="5495958">draw</span><span class="op" id="5495962">.</span><span class="ident" id="5495963">FloydSteinberg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5495979">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5495983">pm</span><span class="op" id="5495985">,</span>&nbsp;<span class="ident" id="5495987">ok</span>&nbsp;<span class="op" id="5495990">:=</span>&nbsp;<span class="ident" id="5495993">m</span><span class="op" id="5495994">.</span><span class="op" id="5495995">(</span><span class="op" id="5495996">*</span><span class="ident" id="5495997">image</span><span class="op" id="5496002">.</span><span class="ident" id="5496003">Paletted</span><span class="op" id="5496011">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5496014">if</span>&nbsp;<span class="op" id="5496017">!</span><span class="ident" id="5496018">ok</span>&nbsp;<span class="op" id="5496021">||</span>&nbsp;<span class="builtinfunc" id="5496024">len</span><span class="op" id="5496027">(</span><span class="ident" id="5496028">pm</span><span class="op" id="5496030">.</span><span class="ident" id="5496031">Palette</span><span class="op" id="5496038">)</span>&nbsp;<span class="op" id="5496040">&gt;</span>&nbsp;<span class="ident" id="5496042">opts</span><span class="op" id="5496046">.</span><span class="ident" id="5496047">NumColors</span>&nbsp;<span class="op" id="5496057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5496061">//&nbsp;TODO:&nbsp;Pick&nbsp;a&nbsp;better&nbsp;sub-sample&nbsp;of&nbsp;the&nbsp;Plan&nbsp;9&nbsp;palette.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496120">pm</span>&nbsp;<span class="op" id="5496123">=</span>&nbsp;<span class="ident" id="5496125">image</span><span class="op" id="5496130">.</span><span class="ident" id="5496131">NewPaletted</span><span class="op" id="5496142">(</span><span class="ident" id="5496143">b</span><span class="op" id="5496144">,</span>&nbsp;<span class="ident" id="5496146">palette</span><span class="op" id="5496153">.</span><span class="ident" id="5496154">Plan9</span><span class="op" id="5496159">[</span><span class="op" id="5496160">:</span><span class="ident" id="5496161">opts</span><span class="op" id="5496165">.</span><span class="ident" id="5496166">NumColors</span><span class="op" id="5496175">]</span><span class="op" id="5496176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5496180">if</span>&nbsp;<span class="ident" id="5496183">opts</span><span class="op" id="5496187">.</span><span class="ident" id="5496188">Quantizer</span>&nbsp;<span class="op" id="5496198">!=</span>&nbsp;<span class="ident" id="5496201">nil</span>&nbsp;<span class="op" id="5496205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496210">pm</span><span class="op" id="5496212">.</span><span class="ident" id="5496213">Palette</span>&nbsp;<span class="op" id="5496221">=</span>&nbsp;<span class="ident" id="5496223">opts</span><span class="op" id="5496227">.</span><span class="ident" id="5496228">Quantizer</span><span class="op" id="5496237">.</span><span class="ident" id="5496238">Quantize</span><span class="op" id="5496246">(</span><span class="builtinfunc" id="5496247">make</span><span class="op" id="5496251">(</span><span class="ident" id="5496252">color</span><span class="op" id="5496257">.</span><span class="ident" id="5496258">Palette</span><span class="op" id="5496265">,</span>&nbsp;<span class="num" id="5496267">0</span><span class="op" id="5496268">,</span>&nbsp;<span class="ident" id="5496270">opts</span><span class="op" id="5496274">.</span><span class="ident" id="5496275">NumColors</span><span class="op" id="5496284">)</span><span class="op" id="5496285">,</span>&nbsp;<span class="ident" id="5496287">m</span><span class="op" id="5496288">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5496292">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496296">opts</span><span class="op" id="5496300">.</span><span class="ident" id="5496301">Drawer</span><span class="op" id="5496307">.</span><span class="ident" id="5496308">Draw</span><span class="op" id="5496312">(</span><span class="ident" id="5496313">pm</span><span class="op" id="5496315">,</span>&nbsp;<span class="ident" id="5496317">b</span><span class="op" id="5496318">,</span>&nbsp;<span class="ident" id="5496320">m</span><span class="op" id="5496321">,</span>&nbsp;<span class="ident" id="5496323">image</span><span class="op" id="5496328">.</span><span class="ident" id="5496329">ZP</span><span class="op" id="5496331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5496334">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5496338">return</span>&nbsp;<span class="ident" id="5496345">EncodeAll</span><span class="op" id="5496354">(</span><span class="ident" id="5496355">w</span><span class="op" id="5496356">,</span>&nbsp;<span class="op" id="5496358">&amp;</span><span class="ident" id="5496359">GIF</span><span class="op" id="5496362">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496366">Image</span><span class="op" id="5496371">:</span>&nbsp;<span class="op" id="5496373">[</span><span class="op" id="5496374">]</span><span class="op" id="5496375">*</span><span class="ident" id="5496376">image</span><span class="op" id="5496381">.</span><span class="ident" id="5496382">Paletted</span><span class="op" id="5496390">{</span><span class="ident" id="5496391">pm</span><span class="op" id="5496393">}</span><span class="op" id="5496394">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496398">Delay</span><span class="op" id="5496403">:</span>&nbsp;<span class="op" id="5496405">[</span><span class="op" id="5496406">]</span><span class="builtintype" id="5496407">int</span><span class="op" id="5496410">{</span><span class="num" id="5496411">0</span><span class="op" id="5496412">}</span><span class="op" id="5496413">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5496416">}</span><span class="op" id="5496417">)</span><br>
<span class="lineno"></span><span class="op" id="5496419">}</span>
</div>
</body>
</html>
