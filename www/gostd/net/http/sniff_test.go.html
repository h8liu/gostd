<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html" class="current">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="558125">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="558180">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="558234">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="558285">package</span>&nbsp;<span class="ident" id="558293">http_test</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="558304">import</span>&nbsp;<span class="op" id="558311">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="558314">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="558323">&#34;fmt&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="558330">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="558336">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="558349">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="558356">.</span>&nbsp;<span class="string" id="558358">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="558370">&#34;net/http/httptest&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="558391">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="558402">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="558413">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="558424">&#34;testing&#34;</span><br>
<span class="lineno"></span><span class="op" id="558434">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="558437">var</span>&nbsp;<span class="ident" id="558441">sniffTests</span>&nbsp;<span class="op" id="558452">=</span>&nbsp;<span class="op" id="558454">[</span><span class="op" id="558455">]</span><span class="keyword" id="558456">struct</span>&nbsp;<span class="op" id="558463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="558466">desc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="558478">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="558486">data</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="558498">[</span><span class="op" id="558499">]</span><span class="builtintype" id="558500">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="558506">contentType</span>&nbsp;<span class="builtintype" id="558518">string</span><br>
<span class="lineno">25</span><span class="op" id="558525">}</span><span class="op" id="558526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="558529">//&nbsp;Some&nbsp;nonsense.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="558548">{</span><span class="string" id="558549">&#34;Empty&#34;</span><span class="op" id="558556">,</span>&nbsp;<span class="op" id="558558">[</span><span class="op" id="558559">]</span><span class="builtintype" id="558560">byte</span><span class="op" id="558564">{</span><span class="op" id="558565">}</span><span class="op" id="558566">,</span>&nbsp;<span class="string" id="558568">&#34;text/plain;&nbsp;charset=utf-8&#34;</span><span class="op" id="558595">}</span><span class="op" id="558596">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="558599">{</span><span class="string" id="558600">&#34;Binary&#34;</span><span class="op" id="558608">,</span>&nbsp;<span class="op" id="558610">[</span><span class="op" id="558611">]</span><span class="builtintype" id="558612">byte</span><span class="op" id="558616">{</span><span class="num" id="558617">1</span><span class="op" id="558618">,</span>&nbsp;<span class="num" id="558620">2</span><span class="op" id="558621">,</span>&nbsp;<span class="num" id="558623">3</span><span class="op" id="558624">}</span><span class="op" id="558625">,</span>&nbsp;<span class="string" id="558627">&#34;application/octet-stream&#34;</span><span class="op" id="558653">}</span><span class="op" id="558654">,</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="558658">{</span><span class="string" id="558659">&#34;HTML&nbsp;document&nbsp;#1&#34;</span><span class="op" id="558677">,</span>&nbsp;<span class="op" id="558679">[</span><span class="op" id="558680">]</span><span class="builtintype" id="558681">byte</span><span class="op" id="558685">(</span><span class="string" id="558686">`&lt;HtMl&gt;&lt;bOdY&gt;blah&nbsp;blah&nbsp;blah&lt;/body&gt;&lt;/html&gt;`</span><span class="op" id="558728">)</span><span class="op" id="558729">,</span>&nbsp;<span class="string" id="558731">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="558757">}</span><span class="op" id="558758">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="558761">{</span><span class="string" id="558762">&#34;HTML&nbsp;document&nbsp;#2&#34;</span><span class="op" id="558780">,</span>&nbsp;<span class="op" id="558782">[</span><span class="op" id="558783">]</span><span class="builtintype" id="558784">byte</span><span class="op" id="558788">(</span><span class="string" id="558789">`&lt;HTML&gt;&lt;/HTML&gt;`</span><span class="op" id="558804">)</span><span class="op" id="558805">,</span>&nbsp;<span class="string" id="558807">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="558833">}</span><span class="op" id="558834">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="558837">{</span><span class="string" id="558838">&#34;HTML&nbsp;document&nbsp;#3&nbsp;(leading&nbsp;whitespace)&#34;</span><span class="op" id="558877">,</span>&nbsp;<span class="op" id="558879">[</span><span class="op" id="558880">]</span><span class="builtintype" id="558881">byte</span><span class="op" id="558885">(</span><span class="string" id="558886">`&nbsp;&nbsp;&nbsp;&lt;!DOCTYPE&nbsp;HTML&gt;...`</span><span class="op" id="558909">)</span><span class="op" id="558910">,</span>&nbsp;<span class="string" id="558912">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="558938">}</span><span class="op" id="558939">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="558942">{</span><span class="string" id="558943">&#34;HTML&nbsp;document&nbsp;#4&nbsp;(leading&nbsp;CRLF)&#34;</span><span class="op" id="558976">,</span>&nbsp;<span class="op" id="558978">[</span><span class="op" id="558979">]</span><span class="builtintype" id="558980">byte</span><span class="op" id="558984">(</span><span class="string" id="558985">&#34;\r\n&lt;html&gt;...&#34;</span><span class="op" id="559000">)</span><span class="op" id="559001">,</span>&nbsp;<span class="string" id="559003">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="559029">}</span><span class="op" id="559030">,</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="559034">{</span><span class="string" id="559035">&#34;Plain&nbsp;text&#34;</span><span class="op" id="559047">,</span>&nbsp;<span class="op" id="559049">[</span><span class="op" id="559050">]</span><span class="builtintype" id="559051">byte</span><span class="op" id="559055">(</span><span class="string" id="559056">`This&nbsp;is&nbsp;not&nbsp;HTML.&nbsp;It&nbsp;has&nbsp;â˜ƒ&nbsp;though.`</span><span class="op" id="559094">)</span><span class="op" id="559095">,</span>&nbsp;<span class="string" id="559097">&#34;text/plain;&nbsp;charset=utf-8&#34;</span><span class="op" id="559124">}</span><span class="op" id="559125">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="559129">{</span><span class="string" id="559130">&#34;XML&#34;</span><span class="op" id="559135">,</span>&nbsp;<span class="op" id="559137">[</span><span class="op" id="559138">]</span><span class="builtintype" id="559139">byte</span><span class="op" id="559143">(</span><span class="string" id="559144">&#34;\n&lt;?xml!&#34;</span><span class="op" id="559154">)</span><span class="op" id="559155">,</span>&nbsp;<span class="string" id="559157">&#34;text/xml;&nbsp;charset=utf-8&#34;</span><span class="op" id="559182">}</span><span class="op" id="559183">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="559187">//&nbsp;Image&nbsp;types.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="559204">{</span><span class="string" id="559205">&#34;GIF&nbsp;87a&#34;</span><span class="op" id="559214">,</span>&nbsp;<span class="op" id="559216">[</span><span class="op" id="559217">]</span><span class="builtintype" id="559218">byte</span><span class="op" id="559222">(</span><span class="string" id="559223">`GIF87a`</span><span class="op" id="559231">)</span><span class="op" id="559232">,</span>&nbsp;<span class="string" id="559234">&#34;image/gif&#34;</span><span class="op" id="559245">}</span><span class="op" id="559246">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="559249">{</span><span class="string" id="559250">&#34;GIF&nbsp;89a&#34;</span><span class="op" id="559259">,</span>&nbsp;<span class="op" id="559261">[</span><span class="op" id="559262">]</span><span class="builtintype" id="559263">byte</span><span class="op" id="559267">(</span><span class="string" id="559268">`GIF89a...`</span><span class="op" id="559279">)</span><span class="op" id="559280">,</span>&nbsp;<span class="string" id="559282">&#34;image/gif&#34;</span><span class="op" id="559293">}</span><span class="op" id="559294">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="559298">//&nbsp;TODO(dsymonds):&nbsp;Re-enable&nbsp;this&nbsp;when&nbsp;the&nbsp;spec&nbsp;is&nbsp;sorted&nbsp;w.r.t.&nbsp;MP4.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="559369">//{&#34;MP4&nbsp;video&#34;,&nbsp;[]byte(&#34;\x00\x00\x00\x18ftypmp42\x00\x00\x00\x00mp42isom&lt;\x06t\xbfmdat&#34;),&nbsp;&#34;video/mp4&#34;},</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="559474">//{&#34;MP4&nbsp;audio&#34;,&nbsp;[]byte(&#34;\x00\x00\x00\x20ftypM4A&nbsp;\x00\x00\x00\x00M4A&nbsp;mp42isom\x00\x00\x00\x00&#34;),&nbsp;&#34;audio/mp4&#34;},</span><br>
<span class="lineno"></span><span class="op" id="559584">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="559587">func</span>&nbsp;<span class="ident" id="559592">TestDetectContentType</span><span class="op" id="559613">(</span><span class="ident" id="559614">t</span>&nbsp;<span class="op" id="559616">*</span><span class="ident" id="559617">testing</span><span class="op" id="559624">.</span><span class="ident" id="559625">T</span><span class="op" id="559626">)</span>&nbsp;<span class="op" id="559628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="559631">for</span>&nbsp;<span class="ident" id="559635">_</span><span class="op" id="559636">,</span>&nbsp;<span class="ident" id="559638">tt</span>&nbsp;<span class="op" id="559641">:=</span>&nbsp;<span class="keyword" id="559644">range</span>&nbsp;<span class="ident" id="559650">sniffTests</span>&nbsp;<span class="op" id="559661">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="559665">ct</span>&nbsp;<span class="op" id="559668">:=</span>&nbsp;<span class="ident" id="559671">DetectContentType</span><span class="op" id="559688">(</span><span class="ident" id="559689">tt</span><span class="op" id="559691">.</span><span class="ident" id="559692">data</span><span class="op" id="559696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="559700">if</span>&nbsp;<span class="ident" id="559703">ct</span>&nbsp;<span class="op" id="559706">!=</span>&nbsp;<span class="ident" id="559709">tt</span><span class="op" id="559711">.</span><span class="ident" id="559712">contentType</span>&nbsp;<span class="op" id="559724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="559729">t</span><span class="op" id="559730">.</span><span class="ident" id="559731">Errorf</span><span class="op" id="559737">(</span><span class="string" id="559738">&#34;%v:&nbsp;DetectContentType&nbsp;=&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="559775">,</span>&nbsp;<span class="ident" id="559777">tt</span><span class="op" id="559779">.</span><span class="ident" id="559780">desc</span><span class="op" id="559784">,</span>&nbsp;<span class="ident" id="559786">ct</span><span class="op" id="559788">,</span>&nbsp;<span class="ident" id="559790">tt</span><span class="op" id="559792">.</span><span class="ident" id="559793">contentType</span><span class="op" id="559804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="559808">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="559811">}</span><br>
<span class="lineno">55</span><span class="op" id="559813">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="559816">func</span>&nbsp;<span class="ident" id="559821">TestServerContentType</span><span class="op" id="559842">(</span><span class="ident" id="559843">t</span>&nbsp;<span class="op" id="559845">*</span><span class="ident" id="559846">testing</span><span class="op" id="559853">.</span><span class="ident" id="559854">T</span><span class="op" id="559855">)</span>&nbsp;<span class="op" id="559857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="559860">defer</span>&nbsp;<span class="ident" id="559866">afterTest</span><span class="op" id="559875">(</span><span class="ident" id="559876">t</span><span class="op" id="559877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="559880">ts</span>&nbsp;<span class="op" id="559883">:=</span>&nbsp;<span class="ident" id="559886">httptest</span><span class="op" id="559894">.</span><span class="ident" id="559895">NewServer</span><span class="op" id="559904">(</span><span class="ident" id="559905">HandlerFunc</span><span class="op" id="559916">(</span><span class="keyword" id="559917">func</span><span class="op" id="559921">(</span><span class="ident" id="559922">w</span>&nbsp;<span class="ident" id="559924">ResponseWriter</span><span class="op" id="559938">,</span>&nbsp;<span class="ident" id="559940">r</span>&nbsp;<span class="op" id="559942">*</span><span class="ident" id="559943">Request</span><span class="op" id="559950">)</span>&nbsp;<span class="op" id="559952">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="559956">i</span><span class="op" id="559957">,</span>&nbsp;<span class="ident" id="559959">_</span>&nbsp;<span class="op" id="559961">:=</span>&nbsp;<span class="ident" id="559964">strconv</span><span class="op" id="559971">.</span><span class="ident" id="559972">Atoi</span><span class="op" id="559976">(</span><span class="ident" id="559977">r</span><span class="op" id="559978">.</span><span class="ident" id="559979">FormValue</span><span class="op" id="559988">(</span><span class="string" id="559989">&#34;i&#34;</span><span class="op" id="559992">)</span><span class="op" id="559993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="559997">tt</span>&nbsp;<span class="op" id="560000">:=</span>&nbsp;<span class="ident" id="560003">sniffTests</span><span class="op" id="560013">[</span><span class="ident" id="560014">i</span><span class="op" id="560015">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="560019">n</span><span class="op" id="560020">,</span>&nbsp;<span class="ident" id="560022">err</span>&nbsp;<span class="op" id="560026">:=</span>&nbsp;<span class="ident" id="560029">w</span><span class="op" id="560030">.</span><span class="ident" id="560031">Write</span><span class="op" id="560036">(</span><span class="ident" id="560037">tt</span><span class="op" id="560039">.</span><span class="ident" id="560040">data</span><span class="op" id="560044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="560048">if</span>&nbsp;<span class="ident" id="560051">n</span>&nbsp;<span class="op" id="560053">!=</span>&nbsp;<span class="builtinfunc" id="560056">len</span><span class="op" id="560059">(</span><span class="ident" id="560060">tt</span><span class="op" id="560062">.</span><span class="ident" id="560063">data</span><span class="op" id="560067">)</span>&nbsp;<span class="op" id="560069">||</span>&nbsp;<span class="ident" id="560072">err</span>&nbsp;<span class="op" id="560076">!=</span>&nbsp;<span class="builtintype" id="560079">nil</span>&nbsp;<span class="op" id="560083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="560088">log</span><span class="op" id="560091">.</span><span class="ident" id="560092">Fatalf</span><span class="op" id="560098">(</span><span class="string" id="560099">&#34;%v:&nbsp;Write(%q)&nbsp;=&nbsp;%v,&nbsp;%v&nbsp;want&nbsp;%d,&nbsp;nil&#34;</span><span class="op" id="560136">,</span>&nbsp;<span class="ident" id="560138">tt</span><span class="op" id="560140">.</span><span class="ident" id="560141">desc</span><span class="op" id="560145">,</span>&nbsp;<span class="ident" id="560147">tt</span><span class="op" id="560149">.</span><span class="ident" id="560150">data</span><span class="op" id="560154">,</span>&nbsp;<span class="ident" id="560156">n</span><span class="op" id="560157">,</span>&nbsp;<span class="ident" id="560159">err</span><span class="op" id="560162">,</span>&nbsp;<span class="builtinfunc" id="560164">len</span><span class="op" id="560167">(</span><span class="ident" id="560168">tt</span><span class="op" id="560170">.</span><span class="ident" id="560171">data</span><span class="op" id="560175">)</span><span class="op" id="560176">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="560180">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="560183">}</span><span class="op" id="560184">)</span><span class="op" id="560185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="560188">defer</span>&nbsp;<span class="ident" id="560194">ts</span><span class="op" id="560196">.</span><span class="ident" id="560197">Close</span><span class="op" id="560202">(</span><span class="op" id="560203">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="560207">for</span>&nbsp;<span class="ident" id="560211">i</span><span class="op" id="560212">,</span>&nbsp;<span class="ident" id="560214">tt</span>&nbsp;<span class="op" id="560217">:=</span>&nbsp;<span class="keyword" id="560220">range</span>&nbsp;<span class="ident" id="560226">sniffTests</span>&nbsp;<span class="op" id="560237">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="560241">resp</span><span class="op" id="560245">,</span>&nbsp;<span class="ident" id="560247">err</span>&nbsp;<span class="op" id="560251">:=</span>&nbsp;<span class="ident" id="560254">Get</span><span class="op" id="560257">(</span><span class="ident" id="560258">ts</span><span class="op" id="560260">.</span><span class="ident" id="560261">URL</span>&nbsp;<span class="op" id="560265">+</span>&nbsp;<span class="string" id="560267">&#34;/?i=&#34;</span>&nbsp;<span class="op" id="560274">+</span>&nbsp;<span class="ident" id="560276">strconv</span><span class="op" id="560283">.</span><span class="ident" id="560284">Itoa</span><span class="op" id="560288">(</span><span class="ident" id="560289">i</span><span class="op" id="560290">)</span><span class="op" id="560291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="560295">if</span>&nbsp;<span class="ident" id="560298">err</span>&nbsp;<span class="op" id="560302">!=</span>&nbsp;<span class="builtintype" id="560305">nil</span>&nbsp;<span class="op" id="560309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="560314">t</span><span class="op" id="560315">.</span><span class="ident" id="560316">Errorf</span><span class="op" id="560322">(</span><span class="string" id="560323">&#34;%v:&nbsp;%v&#34;</span><span class="op" id="560331">,</span>&nbsp;<span class="ident" id="560333">tt</span><span class="op" id="560335">.</span><span class="ident" id="560336">desc</span><span class="op" id="560340">,</span>&nbsp;<span class="ident" id="560342">err</span><span class="op" id="560345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="560350">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="560361">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="560365">if</span>&nbsp;<span class="ident" id="560368">ct</span>&nbsp;<span class="op" id="560371">:=</span>&nbsp;<span class="ident" id="560374">resp</span><span class="op" id="560378">.</span><span class="ident" id="560379">Header</span><span class="op" id="560385">.</span><span class="ident" id="560386">Get</span><span class="op" id="560389">(</span><span class="string" id="560390">&#34;Content-Type&#34;</span><span class="op" id="560404">)</span><span class="op" id="560405">;</span>&nbsp;<span class="ident" id="560407">ct</span>&nbsp;<span class="op" id="560410">!=</span>&nbsp;<span class="ident" id="560413">tt</span><span class="op" id="560415">.</span><span class="ident" id="560416">contentType</span>&nbsp;<span class="op" id="560428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="560433">t</span><span class="op" id="560434">.</span><span class="ident" id="560435">Errorf</span><span class="op" id="560441">(</span><span class="string" id="560442">&#34;%v:&nbsp;Content-Type&nbsp;=&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="560474">,</span>&nbsp;<span class="ident" id="560476">tt</span><span class="op" id="560478">.</span><span class="ident" id="560479">desc</span><span class="op" id="560483">,</span>&nbsp;<span class="ident" id="560485">ct</span><span class="op" id="560487">,</span>&nbsp;<span class="ident" id="560489">tt</span><span class="op" id="560491">.</span><span class="ident" id="560492">contentType</span><span class="op" id="560503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="560507">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="560511">data</span><span class="op" id="560515">,</span>&nbsp;<span class="ident" id="560517">err</span>&nbsp;<span class="op" id="560521">:=</span>&nbsp;<span class="ident" id="560524">ioutil</span><span class="op" id="560530">.</span><span class="ident" id="560531">ReadAll</span><span class="op" id="560538">(</span><span class="ident" id="560539">resp</span><span class="op" id="560543">.</span><span class="ident" id="560544">Body</span><span class="op" id="560548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="560552">if</span>&nbsp;<span class="ident" id="560555">err</span>&nbsp;<span class="op" id="560559">!=</span>&nbsp;<span class="builtintype" id="560562">nil</span>&nbsp;<span class="op" id="560566">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="560571">t</span><span class="op" id="560572">.</span><span class="ident" id="560573">Errorf</span><span class="op" id="560579">(</span><span class="string" id="560580">&#34;%v:&nbsp;reading&nbsp;body:&nbsp;%v&#34;</span><span class="op" id="560602">,</span>&nbsp;<span class="ident" id="560604">tt</span><span class="op" id="560606">.</span><span class="ident" id="560607">desc</span><span class="op" id="560611">,</span>&nbsp;<span class="ident" id="560613">err</span><span class="op" id="560616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="560620">}</span>&nbsp;<span class="keyword" id="560622">else</span>&nbsp;<span class="keyword" id="560627">if</span>&nbsp;<span class="op" id="560630">!</span><span class="ident" id="560631">bytes</span><span class="op" id="560636">.</span><span class="ident" id="560637">Equal</span><span class="op" id="560642">(</span><span class="ident" id="560643">data</span><span class="op" id="560647">,</span>&nbsp;<span class="ident" id="560649">tt</span><span class="op" id="560651">.</span><span class="ident" id="560652">data</span><span class="op" id="560656">)</span>&nbsp;<span class="op" id="560658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="560663">t</span><span class="op" id="560664">.</span><span class="ident" id="560665">Errorf</span><span class="op" id="560671">(</span><span class="string" id="560672">&#34;%v:&nbsp;data&nbsp;is&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="560697">,</span>&nbsp;<span class="ident" id="560699">tt</span><span class="op" id="560701">.</span><span class="ident" id="560702">desc</span><span class="op" id="560706">,</span>&nbsp;<span class="ident" id="560708">data</span><span class="op" id="560712">,</span>&nbsp;<span class="ident" id="560714">tt</span><span class="op" id="560716">.</span><span class="ident" id="560717">data</span><span class="op" id="560721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="560725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="560729">resp</span><span class="op" id="560733">.</span><span class="ident" id="560734">Body</span><span class="op" id="560738">.</span><span class="ident" id="560739">Close</span><span class="op" id="560744">(</span><span class="op" id="560745">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="560748">}</span><br>
<span class="lineno"></span><span class="op" id="560750">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="560753">//&nbsp;Issue&nbsp;5953:&nbsp;shouldn&#39;t&nbsp;sniff&nbsp;if&nbsp;the&nbsp;handler&nbsp;set&nbsp;a&nbsp;Content-Type&nbsp;header,</span><br>
<span class="lineno"></span><span class="comment" id="560826">//&nbsp;even&nbsp;if&nbsp;it&#39;s&nbsp;the&nbsp;empty&nbsp;string.</span><br>
<span class="lineno">90</span><span class="keyword" id="560860">func</span>&nbsp;<span class="ident" id="560865">TestServerIssue5953</span><span class="op" id="560884">(</span><span class="ident" id="560885">t</span>&nbsp;<span class="op" id="560887">*</span><span class="ident" id="560888">testing</span><span class="op" id="560895">.</span><span class="ident" id="560896">T</span><span class="op" id="560897">)</span>&nbsp;<span class="op" id="560899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="560902">defer</span>&nbsp;<span class="ident" id="560908">afterTest</span><span class="op" id="560917">(</span><span class="ident" id="560918">t</span><span class="op" id="560919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="560922">ts</span>&nbsp;<span class="op" id="560925">:=</span>&nbsp;<span class="ident" id="560928">httptest</span><span class="op" id="560936">.</span><span class="ident" id="560937">NewServer</span><span class="op" id="560946">(</span><span class="ident" id="560947">HandlerFunc</span><span class="op" id="560958">(</span><span class="keyword" id="560959">func</span><span class="op" id="560963">(</span><span class="ident" id="560964">w</span>&nbsp;<span class="ident" id="560966">ResponseWriter</span><span class="op" id="560980">,</span>&nbsp;<span class="ident" id="560982">r</span>&nbsp;<span class="op" id="560984">*</span><span class="ident" id="560985">Request</span><span class="op" id="560992">)</span>&nbsp;<span class="op" id="560994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="560998">w</span><span class="op" id="560999">.</span><span class="ident" id="561000">Header</span><span class="op" id="561006">(</span><span class="op" id="561007">)</span><span class="op" id="561008">[</span><span class="string" id="561009">&#34;Content-Type&#34;</span><span class="op" id="561023">]</span>&nbsp;<span class="op" id="561025">=</span>&nbsp;<span class="op" id="561027">[</span><span class="op" id="561028">]</span><span class="builtintype" id="561029">string</span><span class="op" id="561035">{</span><span class="string" id="561036">&#34;&#34;</span><span class="op" id="561038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="561042">fmt</span><span class="op" id="561045">.</span><span class="ident" id="561046">Fprintf</span><span class="op" id="561053">(</span><span class="ident" id="561054">w</span><span class="op" id="561055">,</span>&nbsp;<span class="string" id="561057">&#34;&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;hi&lt;/body&gt;&lt;/html&gt;&#34;</span><span class="op" id="561100">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="561103">}</span><span class="op" id="561104">)</span><span class="op" id="561105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="561108">defer</span>&nbsp;<span class="ident" id="561114">ts</span><span class="op" id="561116">.</span><span class="ident" id="561117">Close</span><span class="op" id="561122">(</span><span class="op" id="561123">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="561127">resp</span><span class="op" id="561131">,</span>&nbsp;<span class="ident" id="561133">err</span>&nbsp;<span class="op" id="561137">:=</span>&nbsp;<span class="ident" id="561140">Get</span><span class="op" id="561143">(</span><span class="ident" id="561144">ts</span><span class="op" id="561146">.</span><span class="ident" id="561147">URL</span><span class="op" id="561150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="561153">if</span>&nbsp;<span class="ident" id="561156">err</span>&nbsp;<span class="op" id="561160">!=</span>&nbsp;<span class="builtintype" id="561163">nil</span>&nbsp;<span class="op" id="561167">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="561171">t</span><span class="op" id="561172">.</span><span class="ident" id="561173">Fatal</span><span class="op" id="561178">(</span><span class="ident" id="561179">err</span><span class="op" id="561182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="561185">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="561189">got</span>&nbsp;<span class="op" id="561193">:=</span>&nbsp;<span class="ident" id="561196">resp</span><span class="op" id="561200">.</span><span class="ident" id="561201">Header</span><span class="op" id="561207">[</span><span class="string" id="561208">&#34;Content-Type&#34;</span><span class="op" id="561222">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="561225">want</span>&nbsp;<span class="op" id="561230">:=</span>&nbsp;<span class="op" id="561233">[</span><span class="op" id="561234">]</span><span class="builtintype" id="561235">string</span><span class="op" id="561241">{</span><span class="string" id="561242">&#34;&#34;</span><span class="op" id="561244">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="561247">if</span>&nbsp;<span class="op" id="561250">!</span><span class="ident" id="561251">reflect</span><span class="op" id="561258">.</span><span class="ident" id="561259">DeepEqual</span><span class="op" id="561268">(</span><span class="ident" id="561269">got</span><span class="op" id="561272">,</span>&nbsp;<span class="ident" id="561274">want</span><span class="op" id="561278">)</span>&nbsp;<span class="op" id="561280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="561284">t</span><span class="op" id="561285">.</span><span class="ident" id="561286">Errorf</span><span class="op" id="561292">(</span><span class="string" id="561293">&#34;Content-Type&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="561321">,</span>&nbsp;<span class="ident" id="561323">got</span><span class="op" id="561326">,</span>&nbsp;<span class="ident" id="561328">want</span><span class="op" id="561332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="561335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="561338">resp</span><span class="op" id="561342">.</span><span class="ident" id="561343">Body</span><span class="op" id="561347">.</span><span class="ident" id="561348">Close</span><span class="op" id="561353">(</span><span class="op" id="561354">)</span><br>
<span class="lineno"></span><span class="op" id="561356">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="keyword" id="561359">func</span>&nbsp;<span class="ident" id="561364">TestContentTypeWithCopy</span><span class="op" id="561387">(</span><span class="ident" id="561388">t</span>&nbsp;<span class="op" id="561390">*</span><span class="ident" id="561391">testing</span><span class="op" id="561398">.</span><span class="ident" id="561399">T</span><span class="op" id="561400">)</span>&nbsp;<span class="op" id="561402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="561405">defer</span>&nbsp;<span class="ident" id="561411">afterTest</span><span class="op" id="561420">(</span><span class="ident" id="561421">t</span><span class="op" id="561422">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="561426">const</span>&nbsp;<span class="op" id="561432">(</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="561436">input</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="561445">=</span>&nbsp;<span class="string" id="561447">&#34;\n&lt;html&gt;\n\t&lt;head&gt;\n&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="561472">expected</span>&nbsp;<span class="op" id="561481">=</span>&nbsp;<span class="string" id="561483">&#34;text/html;&nbsp;charset=utf-8&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="561511">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="561515">ts</span>&nbsp;<span class="op" id="561518">:=</span>&nbsp;<span class="ident" id="561521">httptest</span><span class="op" id="561529">.</span><span class="ident" id="561530">NewServer</span><span class="op" id="561539">(</span><span class="ident" id="561540">HandlerFunc</span><span class="op" id="561551">(</span><span class="keyword" id="561552">func</span><span class="op" id="561556">(</span><span class="ident" id="561557">w</span>&nbsp;<span class="ident" id="561559">ResponseWriter</span><span class="op" id="561573">,</span>&nbsp;<span class="ident" id="561575">r</span>&nbsp;<span class="op" id="561577">*</span><span class="ident" id="561578">Request</span><span class="op" id="561585">)</span>&nbsp;<span class="op" id="561587">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="561591">//&nbsp;Use&nbsp;io.Copy&nbsp;from&nbsp;a&nbsp;bytes.Buffer&nbsp;to&nbsp;trigger&nbsp;ReadFrom.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="561649">buf</span>&nbsp;<span class="op" id="561653">:=</span>&nbsp;<span class="ident" id="561656">bytes</span><span class="op" id="561661">.</span><span class="ident" id="561662">NewBuffer</span><span class="op" id="561671">(</span><span class="op" id="561672">[</span><span class="op" id="561673">]</span><span class="builtintype" id="561674">byte</span><span class="op" id="561678">(</span><span class="ident" id="561679">input</span><span class="op" id="561684">)</span><span class="op" id="561685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="561689">n</span><span class="op" id="561690">,</span>&nbsp;<span class="ident" id="561692">err</span>&nbsp;<span class="op" id="561696">:=</span>&nbsp;<span class="ident" id="561699">io</span><span class="op" id="561701">.</span><span class="ident" id="561702">Copy</span><span class="op" id="561706">(</span><span class="ident" id="561707">w</span><span class="op" id="561708">,</span>&nbsp;<span class="ident" id="561710">buf</span><span class="op" id="561713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="561717">if</span>&nbsp;<span class="builtintype" id="561720">int</span><span class="op" id="561723">(</span><span class="ident" id="561724">n</span><span class="op" id="561725">)</span>&nbsp;<span class="op" id="561727">!=</span>&nbsp;<span class="builtinfunc" id="561730">len</span><span class="op" id="561733">(</span><span class="ident" id="561734">input</span><span class="op" id="561739">)</span>&nbsp;<span class="op" id="561741">||</span>&nbsp;<span class="ident" id="561744">err</span>&nbsp;<span class="op" id="561748">!=</span>&nbsp;<span class="builtintype" id="561751">nil</span>&nbsp;<span class="op" id="561755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="561760">t</span><span class="op" id="561761">.</span><span class="ident" id="561762">Errorf</span><span class="op" id="561768">(</span><span class="string" id="561769">&#34;io.Copy(w,&nbsp;%q)&nbsp;=&nbsp;%v,&nbsp;%v&nbsp;want&nbsp;%d,&nbsp;nil&#34;</span><span class="op" id="561807">,</span>&nbsp;<span class="ident" id="561809">input</span><span class="op" id="561814">,</span>&nbsp;<span class="ident" id="561816">n</span><span class="op" id="561817">,</span>&nbsp;<span class="ident" id="561819">err</span><span class="op" id="561822">,</span>&nbsp;<span class="builtinfunc" id="561824">len</span><span class="op" id="561827">(</span><span class="ident" id="561828">input</span><span class="op" id="561833">)</span><span class="op" id="561834">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="561838">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="561841">}</span><span class="op" id="561842">)</span><span class="op" id="561843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="561846">defer</span>&nbsp;<span class="ident" id="561852">ts</span><span class="op" id="561854">.</span><span class="ident" id="561855">Close</span><span class="op" id="561860">(</span><span class="op" id="561861">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="561865">resp</span><span class="op" id="561869">,</span>&nbsp;<span class="ident" id="561871">err</span>&nbsp;<span class="op" id="561875">:=</span>&nbsp;<span class="ident" id="561878">Get</span><span class="op" id="561881">(</span><span class="ident" id="561882">ts</span><span class="op" id="561884">.</span><span class="ident" id="561885">URL</span><span class="op" id="561888">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="561891">if</span>&nbsp;<span class="ident" id="561894">err</span>&nbsp;<span class="op" id="561898">!=</span>&nbsp;<span class="builtintype" id="561901">nil</span>&nbsp;<span class="op" id="561905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="561909">t</span><span class="op" id="561910">.</span><span class="ident" id="561911">Fatalf</span><span class="op" id="561917">(</span><span class="string" id="561918">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="561927">,</span>&nbsp;<span class="ident" id="561929">err</span><span class="op" id="561932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="561935">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="561938">if</span>&nbsp;<span class="ident" id="561941">ct</span>&nbsp;<span class="op" id="561944">:=</span>&nbsp;<span class="ident" id="561947">resp</span><span class="op" id="561951">.</span><span class="ident" id="561952">Header</span><span class="op" id="561958">.</span><span class="ident" id="561959">Get</span><span class="op" id="561962">(</span><span class="string" id="561963">&#34;Content-Type&#34;</span><span class="op" id="561977">)</span><span class="op" id="561978">;</span>&nbsp;<span class="ident" id="561980">ct</span>&nbsp;<span class="op" id="561983">!=</span>&nbsp;<span class="ident" id="561986">expected</span>&nbsp;<span class="op" id="561995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="561999">t</span><span class="op" id="562000">.</span><span class="ident" id="562001">Errorf</span><span class="op" id="562007">(</span><span class="string" id="562008">&#34;Content-Type&nbsp;=&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="562036">,</span>&nbsp;<span class="ident" id="562038">ct</span><span class="op" id="562040">,</span>&nbsp;<span class="ident" id="562042">expected</span><span class="op" id="562050">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="562053">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="562056">data</span><span class="op" id="562060">,</span>&nbsp;<span class="ident" id="562062">err</span>&nbsp;<span class="op" id="562066">:=</span>&nbsp;<span class="ident" id="562069">ioutil</span><span class="op" id="562075">.</span><span class="ident" id="562076">ReadAll</span><span class="op" id="562083">(</span><span class="ident" id="562084">resp</span><span class="op" id="562088">.</span><span class="ident" id="562089">Body</span><span class="op" id="562093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="562096">if</span>&nbsp;<span class="ident" id="562099">err</span>&nbsp;<span class="op" id="562103">!=</span>&nbsp;<span class="builtintype" id="562106">nil</span>&nbsp;<span class="op" id="562110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="562114">t</span><span class="op" id="562115">.</span><span class="ident" id="562116">Errorf</span><span class="op" id="562122">(</span><span class="string" id="562123">&#34;reading&nbsp;body:&nbsp;%v&#34;</span><span class="op" id="562141">,</span>&nbsp;<span class="ident" id="562143">err</span><span class="op" id="562146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="562149">}</span>&nbsp;<span class="keyword" id="562151">else</span>&nbsp;<span class="keyword" id="562156">if</span>&nbsp;<span class="op" id="562159">!</span><span class="ident" id="562160">bytes</span><span class="op" id="562165">.</span><span class="ident" id="562166">Equal</span><span class="op" id="562171">(</span><span class="ident" id="562172">data</span><span class="op" id="562176">,</span>&nbsp;<span class="op" id="562178">[</span><span class="op" id="562179">]</span><span class="builtintype" id="562180">byte</span><span class="op" id="562184">(</span><span class="ident" id="562185">input</span><span class="op" id="562190">)</span><span class="op" id="562191">)</span>&nbsp;<span class="op" id="562193">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="562197">t</span><span class="op" id="562198">.</span><span class="ident" id="562199">Errorf</span><span class="op" id="562205">(</span><span class="string" id="562206">&#34;data&nbsp;is&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="562227">,</span>&nbsp;<span class="ident" id="562229">data</span><span class="op" id="562233">,</span>&nbsp;<span class="ident" id="562235">input</span><span class="op" id="562240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="562243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="562246">resp</span><span class="op" id="562250">.</span><span class="ident" id="562251">Body</span><span class="op" id="562255">.</span><span class="ident" id="562256">Close</span><span class="op" id="562261">(</span><span class="op" id="562262">)</span><br>
<span class="lineno"></span><span class="op" id="562264">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="562267">func</span>&nbsp;<span class="ident" id="562272">TestSniffWriteSize</span><span class="op" id="562290">(</span><span class="ident" id="562291">t</span>&nbsp;<span class="op" id="562293">*</span><span class="ident" id="562294">testing</span><span class="op" id="562301">.</span><span class="ident" id="562302">T</span><span class="op" id="562303">)</span>&nbsp;<span class="op" id="562305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="562308">defer</span>&nbsp;<span class="ident" id="562314">afterTest</span><span class="op" id="562323">(</span><span class="ident" id="562324">t</span><span class="op" id="562325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="562328">ts</span>&nbsp;<span class="op" id="562331">:=</span>&nbsp;<span class="ident" id="562334">httptest</span><span class="op" id="562342">.</span><span class="ident" id="562343">NewServer</span><span class="op" id="562352">(</span><span class="ident" id="562353">HandlerFunc</span><span class="op" id="562364">(</span><span class="keyword" id="562365">func</span><span class="op" id="562369">(</span><span class="ident" id="562370">w</span>&nbsp;<span class="ident" id="562372">ResponseWriter</span><span class="op" id="562386">,</span>&nbsp;<span class="ident" id="562388">r</span>&nbsp;<span class="op" id="562390">*</span><span class="ident" id="562391">Request</span><span class="op" id="562398">)</span>&nbsp;<span class="op" id="562400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="562404">size</span><span class="op" id="562408">,</span>&nbsp;<span class="ident" id="562410">_</span>&nbsp;<span class="op" id="562412">:=</span>&nbsp;<span class="ident" id="562415">strconv</span><span class="op" id="562422">.</span><span class="ident" id="562423">Atoi</span><span class="op" id="562427">(</span><span class="ident" id="562428">r</span><span class="op" id="562429">.</span><span class="ident" id="562430">FormValue</span><span class="op" id="562439">(</span><span class="string" id="562440">&#34;size&#34;</span><span class="op" id="562446">)</span><span class="op" id="562447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="562451">written</span><span class="op" id="562458">,</span>&nbsp;<span class="ident" id="562460">err</span>&nbsp;<span class="op" id="562464">:=</span>&nbsp;<span class="ident" id="562467">io</span><span class="op" id="562469">.</span><span class="ident" id="562470">WriteString</span><span class="op" id="562481">(</span><span class="ident" id="562482">w</span><span class="op" id="562483">,</span>&nbsp;<span class="ident" id="562485">strings</span><span class="op" id="562492">.</span><span class="ident" id="562493">Repeat</span><span class="op" id="562499">(</span><span class="string" id="562500">&#34;a&#34;</span><span class="op" id="562503">,</span>&nbsp;<span class="ident" id="562505">size</span><span class="op" id="562509">)</span><span class="op" id="562510">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="562514">if</span>&nbsp;<span class="ident" id="562517">err</span>&nbsp;<span class="op" id="562521">!=</span>&nbsp;<span class="builtintype" id="562524">nil</span>&nbsp;<span class="op" id="562528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="562533">t</span><span class="op" id="562534">.</span><span class="ident" id="562535">Errorf</span><span class="op" id="562541">(</span><span class="string" id="562542">&#34;write&nbsp;of&nbsp;%d&nbsp;bytes:&nbsp;%v&#34;</span><span class="op" id="562565">,</span>&nbsp;<span class="ident" id="562567">size</span><span class="op" id="562571">,</span>&nbsp;<span class="ident" id="562573">err</span><span class="op" id="562576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="562581">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="562590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="562594">if</span>&nbsp;<span class="ident" id="562597">written</span>&nbsp;<span class="op" id="562605">!=</span>&nbsp;<span class="ident" id="562608">size</span>&nbsp;<span class="op" id="562613">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="562618">t</span><span class="op" id="562619">.</span><span class="ident" id="562620">Errorf</span><span class="op" id="562626">(</span><span class="string" id="562627">&#34;write&nbsp;of&nbsp;%d&nbsp;bytes&nbsp;wrote&nbsp;%d&nbsp;bytes&#34;</span><span class="op" id="562661">,</span>&nbsp;<span class="ident" id="562663">size</span><span class="op" id="562667">,</span>&nbsp;<span class="ident" id="562669">written</span><span class="op" id="562676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="562680">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="562683">}</span><span class="op" id="562684">)</span><span class="op" id="562685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="562688">defer</span>&nbsp;<span class="ident" id="562694">ts</span><span class="op" id="562696">.</span><span class="ident" id="562697">Close</span><span class="op" id="562702">(</span><span class="op" id="562703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="562706">for</span>&nbsp;<span class="ident" id="562710">_</span><span class="op" id="562711">,</span>&nbsp;<span class="ident" id="562713">size</span>&nbsp;<span class="op" id="562718">:=</span>&nbsp;<span class="keyword" id="562721">range</span>&nbsp;<span class="op" id="562727">[</span><span class="op" id="562728">]</span><span class="builtintype" id="562729">int</span><span class="op" id="562732">{</span><span class="num" id="562733">0</span><span class="op" id="562734">,</span>&nbsp;<span class="num" id="562736">1</span><span class="op" id="562737">,</span>&nbsp;<span class="num" id="562739">200</span><span class="op" id="562742">,</span>&nbsp;<span class="num" id="562744">600</span><span class="op" id="562747">,</span>&nbsp;<span class="num" id="562749">999</span><span class="op" id="562752">,</span>&nbsp;<span class="num" id="562754">1000</span><span class="op" id="562758">,</span>&nbsp;<span class="num" id="562760">1023</span><span class="op" id="562764">,</span>&nbsp;<span class="num" id="562766">1024</span><span class="op" id="562770">,</span>&nbsp;<span class="num" id="562772">512</span>&nbsp;<span class="op" id="562776">&lt;&lt;</span>&nbsp;<span class="num" id="562779">10</span><span class="op" id="562781">,</span>&nbsp;<span class="num" id="562783">1</span>&nbsp;<span class="op" id="562785">&lt;&lt;</span>&nbsp;<span class="num" id="562788">20</span><span class="op" id="562790">}</span>&nbsp;<span class="op" id="562792">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="562796">res</span><span class="op" id="562799">,</span>&nbsp;<span class="ident" id="562801">err</span>&nbsp;<span class="op" id="562805">:=</span>&nbsp;<span class="ident" id="562808">Get</span><span class="op" id="562811">(</span><span class="ident" id="562812">fmt</span><span class="op" id="562815">.</span><span class="ident" id="562816">Sprintf</span><span class="op" id="562823">(</span><span class="string" id="562824">&#34;%s/?size=%d&#34;</span><span class="op" id="562837">,</span>&nbsp;<span class="ident" id="562839">ts</span><span class="op" id="562841">.</span><span class="ident" id="562842">URL</span><span class="op" id="562845">,</span>&nbsp;<span class="ident" id="562847">size</span><span class="op" id="562851">)</span><span class="op" id="562852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="562856">if</span>&nbsp;<span class="ident" id="562859">err</span>&nbsp;<span class="op" id="562863">!=</span>&nbsp;<span class="builtintype" id="562866">nil</span>&nbsp;<span class="op" id="562870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="562875">t</span><span class="op" id="562876">.</span><span class="ident" id="562877">Fatalf</span><span class="op" id="562883">(</span><span class="string" id="562884">&#34;size&nbsp;%d:&nbsp;%v&#34;</span><span class="op" id="562897">,</span>&nbsp;<span class="ident" id="562899">size</span><span class="op" id="562903">,</span>&nbsp;<span class="ident" id="562905">err</span><span class="op" id="562908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="562912">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="562916">if</span>&nbsp;<span class="ident" id="562919">_</span><span class="op" id="562920">,</span>&nbsp;<span class="ident" id="562922">err</span>&nbsp;<span class="op" id="562926">:=</span>&nbsp;<span class="ident" id="562929">io</span><span class="op" id="562931">.</span><span class="ident" id="562932">Copy</span><span class="op" id="562936">(</span><span class="ident" id="562937">ioutil</span><span class="op" id="562943">.</span><span class="ident" id="562944">Discard</span><span class="op" id="562951">,</span>&nbsp;<span class="ident" id="562953">res</span><span class="op" id="562956">.</span><span class="ident" id="562957">Body</span><span class="op" id="562961">)</span><span class="op" id="562962">;</span>&nbsp;<span class="ident" id="562964">err</span>&nbsp;<span class="op" id="562968">!=</span>&nbsp;<span class="builtintype" id="562971">nil</span>&nbsp;<span class="op" id="562975">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="562980">t</span><span class="op" id="562981">.</span><span class="ident" id="562982">Fatalf</span><span class="op" id="562988">(</span><span class="string" id="562989">&#34;size&nbsp;%d:&nbsp;io.Copy&nbsp;of&nbsp;body&nbsp;=&nbsp;%v&#34;</span><span class="op" id="563020">,</span>&nbsp;<span class="ident" id="563022">size</span><span class="op" id="563026">,</span>&nbsp;<span class="ident" id="563028">err</span><span class="op" id="563031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="563035">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="563039">if</span>&nbsp;<span class="ident" id="563042">err</span>&nbsp;<span class="op" id="563046">:=</span>&nbsp;<span class="ident" id="563049">res</span><span class="op" id="563052">.</span><span class="ident" id="563053">Body</span><span class="op" id="563057">.</span><span class="ident" id="563058">Close</span><span class="op" id="563063">(</span><span class="op" id="563064">)</span><span class="op" id="563065">;</span>&nbsp;<span class="ident" id="563067">err</span>&nbsp;<span class="op" id="563071">!=</span>&nbsp;<span class="builtintype" id="563074">nil</span>&nbsp;<span class="op" id="563078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="563083">t</span><span class="op" id="563084">.</span><span class="ident" id="563085">Fatalf</span><span class="op" id="563091">(</span><span class="string" id="563092">&#34;size&nbsp;%d:&nbsp;body&nbsp;Close&nbsp;=&nbsp;%v&#34;</span><span class="op" id="563118">,</span>&nbsp;<span class="ident" id="563120">size</span><span class="op" id="563124">,</span>&nbsp;<span class="ident" id="563126">err</span><span class="op" id="563129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="563133">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="563136">}</span><br>
<span class="lineno"></span><span class="op" id="563138">}</span>
</div>
</body>
</html>
