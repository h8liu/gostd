<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>compress/lzw</h2>
<ul>
<li><a href="/gostd/compress/lzw/reader.go.html">reader.go</a></li>
<li><a href="/gostd/compress/lzw/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/compress/lzw/writer.go.html">writer.go</a></li>
<li><a href="/gostd/compress/lzw/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4580299">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4580354">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4580408">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4580459">package</span>&nbsp;<span class="ident" id="4580467">lzw</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4580472">import</span>&nbsp;<span class="op" id="4580479">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4580482">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4580491">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4580501">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4580508">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="4580513">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4580516">//&nbsp;A&nbsp;writer&nbsp;is&nbsp;a&nbsp;buffered,&nbsp;flushable&nbsp;writer.</span><br>
<span class="lineno">15</span><span class="keyword" id="4580561">type</span>&nbsp;<span class="ident" id="4580566">writer</span>&nbsp;<span class="keyword" id="4580573">interface</span>&nbsp;<span class="op" id="4580583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4580586">io</span><span class="op" id="4580588">.</span><span class="ident" id="4580589">ByteWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4580601">Flush</span><span class="op" id="4580606">(</span><span class="op" id="4580607">)</span>&nbsp;<span class="builtintype" id="4580609">error</span><br>
<span class="lineno"></span><span class="op" id="4580615">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="4580618">//&nbsp;An&nbsp;errWriteCloser&nbsp;is&nbsp;an&nbsp;io.WriteCloser&nbsp;that&nbsp;always&nbsp;returns&nbsp;a&nbsp;given&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="4580695">type</span>&nbsp;<span class="ident" id="4580700">errWriteCloser</span>&nbsp;<span class="keyword" id="4580715">struct</span>&nbsp;<span class="op" id="4580722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4580725">err</span>&nbsp;<span class="builtintype" id="4580729">error</span><br>
<span class="lineno"></span><span class="op" id="4580735">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="4580738">func</span>&nbsp;<span class="op" id="4580743">(</span><span class="ident" id="4580744">e</span>&nbsp;<span class="op" id="4580746">*</span><span class="ident" id="4580747">errWriteCloser</span><span class="op" id="4580761">)</span>&nbsp;<span class="ident" id="4580763">Write</span><span class="op" id="4580768">(</span><span class="op" id="4580769">[</span><span class="op" id="4580770">]</span><span class="builtintype" id="4580771">byte</span><span class="op" id="4580775">)</span>&nbsp;<span class="op" id="4580777">(</span><span class="builtintype" id="4580778">int</span><span class="op" id="4580781">,</span>&nbsp;<span class="builtintype" id="4580783">error</span><span class="op" id="4580788">)</span>&nbsp;<span class="op" id="4580790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4580793">return</span>&nbsp;<span class="num" id="4580800">0</span><span class="op" id="4580801">,</span>&nbsp;<span class="ident" id="4580803">e</span><span class="op" id="4580804">.</span><span class="ident" id="4580805">err</span><br>
<span class="lineno"></span><span class="op" id="4580809">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4580812">func</span>&nbsp;<span class="op" id="4580817">(</span><span class="ident" id="4580818">e</span>&nbsp;<span class="op" id="4580820">*</span><span class="ident" id="4580821">errWriteCloser</span><span class="op" id="4580835">)</span>&nbsp;<span class="ident" id="4580837">Close</span><span class="op" id="4580842">(</span><span class="op" id="4580843">)</span>&nbsp;<span class="builtintype" id="4580845">error</span>&nbsp;<span class="op" id="4580851">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4580854">return</span>&nbsp;<span class="ident" id="4580861">e</span><span class="op" id="4580862">.</span><span class="ident" id="4580863">err</span><br>
<span class="lineno"></span><span class="op" id="4580867">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4580870">const</span>&nbsp;<span class="op" id="4580876">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4580879">//&nbsp;A&nbsp;code&nbsp;is&nbsp;a&nbsp;12&nbsp;bit&nbsp;value,&nbsp;stored&nbsp;as&nbsp;a&nbsp;uint32&nbsp;when&nbsp;encoding&nbsp;to&nbsp;avoid</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4580951">//&nbsp;type&nbsp;conversions&nbsp;when&nbsp;shifting&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4580992">maxCode</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4581004">=</span>&nbsp;<span class="num" id="4581006">1</span><span class="op" id="4581007">&lt;&lt;</span><span class="num" id="4581009">12</span>&nbsp;<span class="op" id="4581012">-</span>&nbsp;<span class="num" id="4581014">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4581017">invalidCode</span>&nbsp;<span class="op" id="4581029">=</span>&nbsp;<span class="num" id="4581031">1</span><span class="op" id="4581032">&lt;&lt;</span><span class="num" id="4581034">32</span>&nbsp;<span class="op" id="4581037">-</span>&nbsp;<span class="num" id="4581039">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4581042">//&nbsp;There&nbsp;are&nbsp;1&lt;&lt;12&nbsp;possible&nbsp;codes,&nbsp;which&nbsp;is&nbsp;an&nbsp;upper&nbsp;bound&nbsp;on&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4581119">//&nbsp;valid&nbsp;hash&nbsp;table&nbsp;entries&nbsp;at&nbsp;any&nbsp;given&nbsp;point&nbsp;in&nbsp;time.&nbsp;tableSize&nbsp;is&nbsp;4x&nbsp;that.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4581198">tableSize</span>&nbsp;<span class="op" id="4581208">=</span>&nbsp;<span class="num" id="4581210">4</span>&nbsp;<span class="op" id="4581212">*</span>&nbsp;<span class="num" id="4581214">1</span>&nbsp;<span class="op" id="4581216">&lt;&lt;</span>&nbsp;<span class="num" id="4581219">12</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4581223">tableMask</span>&nbsp;<span class="op" id="4581233">=</span>&nbsp;<span class="ident" id="4581235">tableSize</span>&nbsp;<span class="op" id="4581245">-</span>&nbsp;<span class="num" id="4581247">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4581250">//&nbsp;A&nbsp;hash&nbsp;table&nbsp;entry&nbsp;is&nbsp;a&nbsp;uint32.&nbsp;Zero&nbsp;is&nbsp;an&nbsp;invalid&nbsp;entry&nbsp;since&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4581321">//&nbsp;lower&nbsp;12&nbsp;bits&nbsp;of&nbsp;a&nbsp;valid&nbsp;entry&nbsp;must&nbsp;be&nbsp;a&nbsp;non-literal&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4581384">invalidEntry</span>&nbsp;<span class="op" id="4581397">=</span>&nbsp;<span class="num" id="4581399">0</span><br>
<span class="lineno">45</span><span class="op" id="4581401">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4581404">//&nbsp;encoder&nbsp;is&nbsp;LZW&nbsp;compressor.</span><br>
<span class="lineno"></span><span class="keyword" id="4581434">type</span>&nbsp;<span class="ident" id="4581439">encoder</span>&nbsp;<span class="keyword" id="4581447">struct</span>&nbsp;<span class="op" id="4581454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4581457">//&nbsp;w&nbsp;is&nbsp;the&nbsp;writer&nbsp;that&nbsp;compressed&nbsp;bytes&nbsp;are&nbsp;written&nbsp;to.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4581515">w</span>&nbsp;<span class="ident" id="4581517">writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4581525">//&nbsp;order,&nbsp;write,&nbsp;bits,&nbsp;nBits&nbsp;and&nbsp;width&nbsp;are&nbsp;the&nbsp;state&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4581583">//&nbsp;converting&nbsp;a&nbsp;code&nbsp;stream&nbsp;into&nbsp;a&nbsp;byte&nbsp;stream.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4581632">order</span>&nbsp;<span class="ident" id="4581638">Order</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4581645">write</span>&nbsp;<span class="keyword" id="4581651">func</span><span class="op" id="4581655">(</span><span class="op" id="4581656">*</span><span class="ident" id="4581657">encoder</span><span class="op" id="4581664">,</span>&nbsp;<span class="builtintype" id="4581666">uint32</span><span class="op" id="4581672">)</span>&nbsp;<span class="builtintype" id="4581674">error</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4581681">bits</span>&nbsp;&nbsp;<span class="builtintype" id="4581687">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4581695">nBits</span>&nbsp;<span class="builtintype" id="4581701">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4581707">width</span>&nbsp;<span class="builtintype" id="4581713">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4581719">//&nbsp;litWidth&nbsp;is&nbsp;the&nbsp;width&nbsp;in&nbsp;bits&nbsp;of&nbsp;literal&nbsp;codes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4581771">litWidth</span>&nbsp;<span class="builtintype" id="4581780">uint</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4581786">//&nbsp;hi&nbsp;is&nbsp;the&nbsp;code&nbsp;implied&nbsp;by&nbsp;the&nbsp;next&nbsp;code&nbsp;emission.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4581840">//&nbsp;overflow&nbsp;is&nbsp;the&nbsp;code&nbsp;at&nbsp;which&nbsp;hi&nbsp;overflows&nbsp;the&nbsp;code&nbsp;width.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4581903">hi</span><span class="op" id="4581905">,</span>&nbsp;<span class="ident" id="4581907">overflow</span>&nbsp;<span class="builtintype" id="4581916">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4581924">//&nbsp;savedCode&nbsp;is&nbsp;the&nbsp;accumulated&nbsp;code&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;most&nbsp;recent&nbsp;Write</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4581998">//&nbsp;call.&nbsp;It&nbsp;is&nbsp;equal&nbsp;to&nbsp;invalidCode&nbsp;if&nbsp;there&nbsp;was&nbsp;no&nbsp;such&nbsp;call.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4582062">savedCode</span>&nbsp;<span class="builtintype" id="4582072">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4582080">//&nbsp;err&nbsp;is&nbsp;the&nbsp;first&nbsp;error&nbsp;encountered&nbsp;during&nbsp;writing.&nbsp;Closing&nbsp;the&nbsp;encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4582155">//&nbsp;will&nbsp;make&nbsp;any&nbsp;future&nbsp;Write&nbsp;calls&nbsp;return&nbsp;errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4582209">err</span>&nbsp;<span class="builtintype" id="4582213">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4582220">//&nbsp;table&nbsp;is&nbsp;the&nbsp;hash&nbsp;table&nbsp;from&nbsp;20-bit&nbsp;keys&nbsp;to&nbsp;12-bit&nbsp;values.&nbsp;Each&nbsp;table</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4582294">//&nbsp;entry&nbsp;contains&nbsp;key&lt;&lt;12|val&nbsp;and&nbsp;collisions&nbsp;resolve&nbsp;by&nbsp;linear&nbsp;probing.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4582367">//&nbsp;The&nbsp;keys&nbsp;consist&nbsp;of&nbsp;a&nbsp;12-bit&nbsp;code&nbsp;prefix&nbsp;and&nbsp;an&nbsp;8-bit&nbsp;byte&nbsp;suffix.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4582438">//&nbsp;The&nbsp;values&nbsp;are&nbsp;a&nbsp;12-bit&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4582472">table</span>&nbsp;<span class="op" id="4582478">[</span><span class="ident" id="4582479">tableSize</span><span class="op" id="4582488">]</span><span class="builtintype" id="4582489">uint32</span><br>
<span class="lineno"></span><span class="op" id="4582496">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="comment" id="4582499">//&nbsp;writeLSB&nbsp;writes&nbsp;the&nbsp;code&nbsp;c&nbsp;for&nbsp;&#34;Least&nbsp;Significant&nbsp;Bits&nbsp;first&#34;&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="4582570">func</span>&nbsp;<span class="op" id="4582575">(</span><span class="ident" id="4582576">e</span>&nbsp;<span class="op" id="4582578">*</span><span class="ident" id="4582579">encoder</span><span class="op" id="4582586">)</span>&nbsp;<span class="ident" id="4582588">writeLSB</span><span class="op" id="4582596">(</span><span class="ident" id="4582597">c</span>&nbsp;<span class="builtintype" id="4582599">uint32</span><span class="op" id="4582605">)</span>&nbsp;<span class="builtintype" id="4582607">error</span>&nbsp;<span class="op" id="4582613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4582616">e</span><span class="op" id="4582617">.</span><span class="ident" id="4582618">bits</span>&nbsp;<span class="op" id="4582623">|=</span>&nbsp;<span class="ident" id="4582626">c</span>&nbsp;<span class="op" id="4582628">&lt;&lt;</span>&nbsp;<span class="ident" id="4582631">e</span><span class="op" id="4582632">.</span><span class="ident" id="4582633">nBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4582640">e</span><span class="op" id="4582641">.</span><span class="ident" id="4582642">nBits</span>&nbsp;<span class="op" id="4582648">+=</span>&nbsp;<span class="ident" id="4582651">e</span><span class="op" id="4582652">.</span><span class="ident" id="4582653">width</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4582660">for</span>&nbsp;<span class="ident" id="4582664">e</span><span class="op" id="4582665">.</span><span class="ident" id="4582666">nBits</span>&nbsp;<span class="op" id="4582672">&gt;=</span>&nbsp;<span class="num" id="4582675">8</span>&nbsp;<span class="op" id="4582677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4582681">if</span>&nbsp;<span class="ident" id="4582684">err</span>&nbsp;<span class="op" id="4582688">:=</span>&nbsp;<span class="ident" id="4582691">e</span><span class="op" id="4582692">.</span><span class="ident" id="4582693">w</span><span class="op" id="4582694">.</span><span class="ident" id="4582695">WriteByte</span><span class="op" id="4582704">(</span><span class="builtintype" id="4582705">uint8</span><span class="op" id="4582710">(</span><span class="ident" id="4582711">e</span><span class="op" id="4582712">.</span><span class="ident" id="4582713">bits</span><span class="op" id="4582717">)</span><span class="op" id="4582718">)</span><span class="op" id="4582719">;</span>&nbsp;<span class="ident" id="4582721">err</span>&nbsp;<span class="op" id="4582725">!=</span>&nbsp;<span class="ident" id="4582728">nil</span>&nbsp;<span class="op" id="4582732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4582737">return</span>&nbsp;<span class="ident" id="4582744">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4582750">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4582754">e</span><span class="op" id="4582755">.</span><span class="ident" id="4582756">bits</span>&nbsp;<span class="op" id="4582761">&gt;&gt;=</span>&nbsp;<span class="num" id="4582765">8</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4582769">e</span><span class="op" id="4582770">.</span><span class="ident" id="4582771">nBits</span>&nbsp;<span class="op" id="4582777">-=</span>&nbsp;<span class="num" id="4582780">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4582783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4582786">return</span>&nbsp;<span class="ident" id="4582793">nil</span><br>
<span class="lineno"></span><span class="op" id="4582797">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="4582800">//&nbsp;writeMSB&nbsp;writes&nbsp;the&nbsp;code&nbsp;c&nbsp;for&nbsp;&#34;Most&nbsp;Significant&nbsp;Bits&nbsp;first&#34;&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="4582870">func</span>&nbsp;<span class="op" id="4582875">(</span><span class="ident" id="4582876">e</span>&nbsp;<span class="op" id="4582878">*</span><span class="ident" id="4582879">encoder</span><span class="op" id="4582886">)</span>&nbsp;<span class="ident" id="4582888">writeMSB</span><span class="op" id="4582896">(</span><span class="ident" id="4582897">c</span>&nbsp;<span class="builtintype" id="4582899">uint32</span><span class="op" id="4582905">)</span>&nbsp;<span class="builtintype" id="4582907">error</span>&nbsp;<span class="op" id="4582913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4582916">e</span><span class="op" id="4582917">.</span><span class="ident" id="4582918">bits</span>&nbsp;<span class="op" id="4582923">|=</span>&nbsp;<span class="ident" id="4582926">c</span>&nbsp;<span class="op" id="4582928">&lt;&lt;</span>&nbsp;<span class="op" id="4582931">(</span><span class="num" id="4582932">32</span>&nbsp;<span class="op" id="4582935">-</span>&nbsp;<span class="ident" id="4582937">e</span><span class="op" id="4582938">.</span><span class="ident" id="4582939">width</span>&nbsp;<span class="op" id="4582945">-</span>&nbsp;<span class="ident" id="4582947">e</span><span class="op" id="4582948">.</span><span class="ident" id="4582949">nBits</span><span class="op" id="4582954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4582957">e</span><span class="op" id="4582958">.</span><span class="ident" id="4582959">nBits</span>&nbsp;<span class="op" id="4582965">+=</span>&nbsp;<span class="ident" id="4582968">e</span><span class="op" id="4582969">.</span><span class="ident" id="4582970">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4582977">for</span>&nbsp;<span class="ident" id="4582981">e</span><span class="op" id="4582982">.</span><span class="ident" id="4582983">nBits</span>&nbsp;<span class="op" id="4582989">&gt;=</span>&nbsp;<span class="num" id="4582992">8</span>&nbsp;<span class="op" id="4582994">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4582998">if</span>&nbsp;<span class="ident" id="4583001">err</span>&nbsp;<span class="op" id="4583005">:=</span>&nbsp;<span class="ident" id="4583008">e</span><span class="op" id="4583009">.</span><span class="ident" id="4583010">w</span><span class="op" id="4583011">.</span><span class="ident" id="4583012">WriteByte</span><span class="op" id="4583021">(</span><span class="builtintype" id="4583022">uint8</span><span class="op" id="4583027">(</span><span class="ident" id="4583028">e</span><span class="op" id="4583029">.</span><span class="ident" id="4583030">bits</span>&nbsp;<span class="op" id="4583035">&gt;&gt;</span>&nbsp;<span class="num" id="4583038">24</span><span class="op" id="4583040">)</span><span class="op" id="4583041">)</span><span class="op" id="4583042">;</span>&nbsp;<span class="ident" id="4583044">err</span>&nbsp;<span class="op" id="4583048">!=</span>&nbsp;<span class="ident" id="4583051">nil</span>&nbsp;<span class="op" id="4583055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4583060">return</span>&nbsp;<span class="ident" id="4583067">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4583073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4583077">e</span><span class="op" id="4583078">.</span><span class="ident" id="4583079">bits</span>&nbsp;<span class="op" id="4583084">&lt;&lt;=</span>&nbsp;<span class="num" id="4583088">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4583092">e</span><span class="op" id="4583093">.</span><span class="ident" id="4583094">nBits</span>&nbsp;<span class="op" id="4583100">-=</span>&nbsp;<span class="num" id="4583103">8</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4583106">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4583109">return</span>&nbsp;<span class="ident" id="4583116">nil</span><br>
<span class="lineno"></span><span class="op" id="4583120">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4583123">//&nbsp;errOutOfCodes&nbsp;is&nbsp;an&nbsp;internal&nbsp;error&nbsp;that&nbsp;means&nbsp;that&nbsp;the&nbsp;encoder&nbsp;has&nbsp;run&nbsp;out</span><br>
<span class="lineno">105</span><span class="comment" id="4583201">//&nbsp;of&nbsp;unused&nbsp;codes&nbsp;and&nbsp;a&nbsp;clear&nbsp;code&nbsp;needs&nbsp;to&nbsp;be&nbsp;sent&nbsp;next.</span><br>
<span class="lineno"></span><span class="keyword" id="4583260">var</span>&nbsp;<span class="ident" id="4583264">errOutOfCodes</span>&nbsp;<span class="op" id="4583278">=</span>&nbsp;<span class="ident" id="4583280">errors</span><span class="op" id="4583286">.</span><span class="ident" id="4583287">New</span><span class="op" id="4583290">(</span><span class="string" id="4583291">&#34;lzw:&nbsp;out&nbsp;of&nbsp;codes&#34;</span><span class="op" id="4583310">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4583313">//&nbsp;incHi&nbsp;increments&nbsp;e.hi&nbsp;and&nbsp;checks&nbsp;for&nbsp;both&nbsp;overflow&nbsp;and&nbsp;running&nbsp;out&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4583386">//&nbsp;unused&nbsp;codes.&nbsp;In&nbsp;the&nbsp;latter&nbsp;case,&nbsp;incHi&nbsp;sends&nbsp;a&nbsp;clear&nbsp;code,&nbsp;resets&nbsp;the</span><br>
<span class="lineno">110</span><span class="comment" id="4583460">//&nbsp;encoder&nbsp;state&nbsp;and&nbsp;returns&nbsp;errOutOfCodes.</span><br>
<span class="lineno"></span><span class="keyword" id="4583504">func</span>&nbsp;<span class="op" id="4583509">(</span><span class="ident" id="4583510">e</span>&nbsp;<span class="op" id="4583512">*</span><span class="ident" id="4583513">encoder</span><span class="op" id="4583520">)</span>&nbsp;<span class="ident" id="4583522">incHi</span><span class="op" id="4583527">(</span><span class="op" id="4583528">)</span>&nbsp;<span class="builtintype" id="4583530">error</span>&nbsp;<span class="op" id="4583536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4583539">e</span><span class="op" id="4583540">.</span><span class="ident" id="4583541">hi</span><span class="op" id="4583543">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4583547">if</span>&nbsp;<span class="ident" id="4583550">e</span><span class="op" id="4583551">.</span><span class="ident" id="4583552">hi</span>&nbsp;<span class="op" id="4583555">==</span>&nbsp;<span class="ident" id="4583558">e</span><span class="op" id="4583559">.</span><span class="ident" id="4583560">overflow</span>&nbsp;<span class="op" id="4583569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4583573">e</span><span class="op" id="4583574">.</span><span class="ident" id="4583575">width</span><span class="op" id="4583580">++</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4583585">e</span><span class="op" id="4583586">.</span><span class="ident" id="4583587">overflow</span>&nbsp;<span class="op" id="4583596">&lt;&lt;=</span>&nbsp;<span class="num" id="4583600">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4583603">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4583606">if</span>&nbsp;<span class="ident" id="4583609">e</span><span class="op" id="4583610">.</span><span class="ident" id="4583611">hi</span>&nbsp;<span class="op" id="4583614">==</span>&nbsp;<span class="ident" id="4583617">maxCode</span>&nbsp;<span class="op" id="4583625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4583629">clear</span>&nbsp;<span class="op" id="4583635">:=</span>&nbsp;<span class="builtintype" id="4583638">uint32</span><span class="op" id="4583644">(</span><span class="num" id="4583645">1</span><span class="op" id="4583646">)</span>&nbsp;<span class="op" id="4583648">&lt;&lt;</span>&nbsp;<span class="ident" id="4583651">e</span><span class="op" id="4583652">.</span><span class="ident" id="4583653">litWidth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4583664">if</span>&nbsp;<span class="ident" id="4583667">err</span>&nbsp;<span class="op" id="4583671">:=</span>&nbsp;<span class="ident" id="4583674">e</span><span class="op" id="4583675">.</span><span class="ident" id="4583676">write</span><span class="op" id="4583681">(</span><span class="ident" id="4583682">e</span><span class="op" id="4583683">,</span>&nbsp;<span class="ident" id="4583685">clear</span><span class="op" id="4583690">)</span><span class="op" id="4583691">;</span>&nbsp;<span class="ident" id="4583693">err</span>&nbsp;<span class="op" id="4583697">!=</span>&nbsp;<span class="ident" id="4583700">nil</span>&nbsp;<span class="op" id="4583704">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4583709">return</span>&nbsp;<span class="ident" id="4583716">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4583722">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4583726">e</span><span class="op" id="4583727">.</span><span class="ident" id="4583728">width</span>&nbsp;<span class="op" id="4583734">=</span>&nbsp;<span class="builtintype" id="4583736">uint</span><span class="op" id="4583740">(</span><span class="ident" id="4583741">e</span><span class="op" id="4583742">.</span><span class="ident" id="4583743">litWidth</span><span class="op" id="4583751">)</span>&nbsp;<span class="op" id="4583753">+</span>&nbsp;<span class="num" id="4583755">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4583759">e</span><span class="op" id="4583760">.</span><span class="ident" id="4583761">hi</span>&nbsp;<span class="op" id="4583764">=</span>&nbsp;<span class="ident" id="4583766">clear</span>&nbsp;<span class="op" id="4583772">+</span>&nbsp;<span class="num" id="4583774">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4583778">e</span><span class="op" id="4583779">.</span><span class="ident" id="4583780">overflow</span>&nbsp;<span class="op" id="4583789">=</span>&nbsp;<span class="ident" id="4583791">clear</span>&nbsp;<span class="op" id="4583797">&lt;&lt;</span>&nbsp;<span class="num" id="4583800">1</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4583804">for</span>&nbsp;<span class="ident" id="4583808">i</span>&nbsp;<span class="op" id="4583810">:=</span>&nbsp;<span class="keyword" id="4583813">range</span>&nbsp;<span class="ident" id="4583819">e</span><span class="op" id="4583820">.</span><span class="ident" id="4583821">table</span>&nbsp;<span class="op" id="4583827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4583832">e</span><span class="op" id="4583833">.</span><span class="ident" id="4583834">table</span><span class="op" id="4583839">[</span><span class="ident" id="4583840">i</span><span class="op" id="4583841">]</span>&nbsp;<span class="op" id="4583843">=</span>&nbsp;<span class="ident" id="4583845">invalidEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4583860">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4583864">return</span>&nbsp;<span class="ident" id="4583871">errOutOfCodes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4583886">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4583889">return</span>&nbsp;<span class="ident" id="4583896">nil</span><br>
<span class="lineno"></span><span class="op" id="4583900">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4583903">//&nbsp;Write&nbsp;writes&nbsp;a&nbsp;compressed&nbsp;representation&nbsp;of&nbsp;p&nbsp;to&nbsp;e&#39;s&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4583978">func</span>&nbsp;<span class="op" id="4583983">(</span><span class="ident" id="4583984">e</span>&nbsp;<span class="op" id="4583986">*</span><span class="ident" id="4583987">encoder</span><span class="op" id="4583994">)</span>&nbsp;<span class="ident" id="4583996">Write</span><span class="op" id="4584001">(</span><span class="ident" id="4584002">p</span>&nbsp;<span class="op" id="4584004">[</span><span class="op" id="4584005">]</span><span class="builtintype" id="4584006">byte</span><span class="op" id="4584010">)</span>&nbsp;<span class="op" id="4584012">(</span><span class="ident" id="4584013">n</span>&nbsp;<span class="builtintype" id="4584015">int</span><span class="op" id="4584018">,</span>&nbsp;<span class="ident" id="4584020">err</span>&nbsp;<span class="builtintype" id="4584024">error</span><span class="op" id="4584029">)</span>&nbsp;<span class="op" id="4584031">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4584034">if</span>&nbsp;<span class="ident" id="4584037">e</span><span class="op" id="4584038">.</span><span class="ident" id="4584039">err</span>&nbsp;<span class="op" id="4584043">!=</span>&nbsp;<span class="ident" id="4584046">nil</span>&nbsp;<span class="op" id="4584050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4584054">return</span>&nbsp;<span class="num" id="4584061">0</span><span class="op" id="4584062">,</span>&nbsp;<span class="ident" id="4584064">e</span><span class="op" id="4584065">.</span><span class="ident" id="4584066">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4584071">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4584074">if</span>&nbsp;<span class="builtinfunc" id="4584077">len</span><span class="op" id="4584080">(</span><span class="ident" id="4584081">p</span><span class="op" id="4584082">)</span>&nbsp;<span class="op" id="4584084">==</span>&nbsp;<span class="num" id="4584087">0</span>&nbsp;<span class="op" id="4584089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4584093">return</span>&nbsp;<span class="num" id="4584100">0</span><span class="op" id="4584101">,</span>&nbsp;<span class="ident" id="4584103">nil</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4584108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4584111">n</span>&nbsp;<span class="op" id="4584113">=</span>&nbsp;<span class="builtinfunc" id="4584115">len</span><span class="op" id="4584118">(</span><span class="ident" id="4584119">p</span><span class="op" id="4584120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4584123">litMask</span>&nbsp;<span class="op" id="4584131">:=</span>&nbsp;<span class="builtintype" id="4584134">uint32</span><span class="op" id="4584140">(</span><span class="num" id="4584141">1</span><span class="op" id="4584142">&lt;&lt;</span><span class="ident" id="4584144">e</span><span class="op" id="4584145">.</span><span class="ident" id="4584146">litWidth</span>&nbsp;<span class="op" id="4584155">-</span>&nbsp;<span class="num" id="4584157">1</span><span class="op" id="4584158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4584161">code</span>&nbsp;<span class="op" id="4584166">:=</span>&nbsp;<span class="ident" id="4584169">e</span><span class="op" id="4584170">.</span><span class="ident" id="4584171">savedCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4584182">if</span>&nbsp;<span class="ident" id="4584185">code</span>&nbsp;<span class="op" id="4584190">==</span>&nbsp;<span class="ident" id="4584193">invalidCode</span>&nbsp;<span class="op" id="4584205">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4584209">//&nbsp;The&nbsp;first&nbsp;code&nbsp;sent&nbsp;is&nbsp;always&nbsp;a&nbsp;literal&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4584260">code</span><span class="op" id="4584264">,</span>&nbsp;<span class="ident" id="4584266">p</span>&nbsp;<span class="op" id="4584268">=</span>&nbsp;<span class="builtintype" id="4584270">uint32</span><span class="op" id="4584276">(</span><span class="ident" id="4584277">p</span><span class="op" id="4584278">[</span><span class="num" id="4584279">0</span><span class="op" id="4584280">]</span><span class="op" id="4584281">)</span><span class="op" id="4584282">&amp;</span><span class="ident" id="4584283">litMask</span><span class="op" id="4584290">,</span>&nbsp;<span class="ident" id="4584292">p</span><span class="op" id="4584293">[</span><span class="num" id="4584294">1</span><span class="op" id="4584295">:</span><span class="op" id="4584296">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4584299">}</span><br>
<span class="lineno"></span><span class="ident" id="4584301">loop</span><span class="op" id="4584305">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4584308">for</span>&nbsp;<span class="ident" id="4584312">_</span><span class="op" id="4584313">,</span>&nbsp;<span class="ident" id="4584315">x</span>&nbsp;<span class="op" id="4584317">:=</span>&nbsp;<span class="keyword" id="4584320">range</span>&nbsp;<span class="ident" id="4584326">p</span>&nbsp;<span class="op" id="4584328">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4584332">literal</span>&nbsp;<span class="op" id="4584340">:=</span>&nbsp;<span class="builtintype" id="4584343">uint32</span><span class="op" id="4584349">(</span><span class="ident" id="4584350">x</span><span class="op" id="4584351">)</span>&nbsp;<span class="op" id="4584353">&amp;</span>&nbsp;<span class="ident" id="4584355">litMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4584365">key</span>&nbsp;<span class="op" id="4584369">:=</span>&nbsp;<span class="ident" id="4584372">code</span><span class="op" id="4584376">&lt;&lt;</span><span class="num" id="4584378">8</span>&nbsp;<span class="op" id="4584380">|</span>&nbsp;<span class="ident" id="4584382">literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4584392">//&nbsp;If&nbsp;there&nbsp;is&nbsp;a&nbsp;hash&nbsp;table&nbsp;hit&nbsp;for&nbsp;this&nbsp;key&nbsp;then&nbsp;we&nbsp;continue&nbsp;the&nbsp;loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4584465">//&nbsp;and&nbsp;do&nbsp;not&nbsp;emit&nbsp;a&nbsp;code&nbsp;yet.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4584498">hash</span>&nbsp;<span class="op" id="4584503">:=</span>&nbsp;<span class="op" id="4584506">(</span><span class="ident" id="4584507">key</span><span class="op" id="4584510">&gt;&gt;</span><span class="num" id="4584512">12</span>&nbsp;<span class="op" id="4584515">^</span>&nbsp;<span class="ident" id="4584517">key</span><span class="op" id="4584520">)</span>&nbsp;<span class="op" id="4584522">&amp;</span>&nbsp;<span class="ident" id="4584524">tableMask</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4584536">for</span>&nbsp;<span class="ident" id="4584540">h</span><span class="op" id="4584541">,</span>&nbsp;<span class="ident" id="4584543">t</span>&nbsp;<span class="op" id="4584545">:=</span>&nbsp;<span class="ident" id="4584548">hash</span><span class="op" id="4584552">,</span>&nbsp;<span class="ident" id="4584554">e</span><span class="op" id="4584555">.</span><span class="ident" id="4584556">table</span><span class="op" id="4584561">[</span><span class="ident" id="4584562">hash</span><span class="op" id="4584566">]</span><span class="op" id="4584567">;</span>&nbsp;<span class="ident" id="4584569">t</span>&nbsp;<span class="op" id="4584571">!=</span>&nbsp;<span class="ident" id="4584574">invalidEntry</span><span class="op" id="4584586">;</span>&nbsp;<span class="op" id="4584588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4584593">if</span>&nbsp;<span class="ident" id="4584596">key</span>&nbsp;<span class="op" id="4584600">==</span>&nbsp;<span class="ident" id="4584603">t</span><span class="op" id="4584604">&gt;&gt;</span><span class="num" id="4584606">12</span>&nbsp;<span class="op" id="4584609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4584615">code</span>&nbsp;<span class="op" id="4584620">=</span>&nbsp;<span class="ident" id="4584622">t</span>&nbsp;<span class="op" id="4584624">&amp;</span>&nbsp;<span class="ident" id="4584626">maxCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4584638">continue</span>&nbsp;<span class="ident" id="4584647">loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4584655">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4584660">h</span>&nbsp;<span class="op" id="4584662">=</span>&nbsp;<span class="op" id="4584664">(</span><span class="ident" id="4584665">h</span>&nbsp;<span class="op" id="4584667">+</span>&nbsp;<span class="num" id="4584669">1</span><span class="op" id="4584670">)</span>&nbsp;<span class="op" id="4584672">&amp;</span>&nbsp;<span class="ident" id="4584674">tableMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4584687">t</span>&nbsp;<span class="op" id="4584689">=</span>&nbsp;<span class="ident" id="4584691">e</span><span class="op" id="4584692">.</span><span class="ident" id="4584693">table</span><span class="op" id="4584698">[</span><span class="ident" id="4584699">h</span><span class="op" id="4584700">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4584704">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4584708">//&nbsp;Otherwise,&nbsp;write&nbsp;the&nbsp;current&nbsp;code,&nbsp;and&nbsp;literal&nbsp;becomes&nbsp;the&nbsp;start&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4584781">//&nbsp;the&nbsp;next&nbsp;emitted&nbsp;code.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4584809">if</span>&nbsp;<span class="ident" id="4584812">e</span><span class="op" id="4584813">.</span><span class="ident" id="4584814">err</span>&nbsp;<span class="op" id="4584818">=</span>&nbsp;<span class="ident" id="4584820">e</span><span class="op" id="4584821">.</span><span class="ident" id="4584822">write</span><span class="op" id="4584827">(</span><span class="ident" id="4584828">e</span><span class="op" id="4584829">,</span>&nbsp;<span class="ident" id="4584831">code</span><span class="op" id="4584835">)</span><span class="op" id="4584836">;</span>&nbsp;<span class="ident" id="4584838">e</span><span class="op" id="4584839">.</span><span class="ident" id="4584840">err</span>&nbsp;<span class="op" id="4584844">!=</span>&nbsp;<span class="ident" id="4584847">nil</span>&nbsp;<span class="op" id="4584851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4584856">return</span>&nbsp;<span class="num" id="4584863">0</span><span class="op" id="4584864">,</span>&nbsp;<span class="ident" id="4584866">e</span><span class="op" id="4584867">.</span><span class="ident" id="4584868">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4584874">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4584878">code</span>&nbsp;<span class="op" id="4584883">=</span>&nbsp;<span class="ident" id="4584885">literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4584895">//&nbsp;Increment&nbsp;e.hi,&nbsp;the&nbsp;next&nbsp;implied&nbsp;code.&nbsp;If&nbsp;we&nbsp;run&nbsp;out&nbsp;of&nbsp;codes,&nbsp;reset</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4584969">//&nbsp;the&nbsp;encoder&nbsp;state&nbsp;(including&nbsp;clearing&nbsp;the&nbsp;hash&nbsp;table)&nbsp;and&nbsp;continue.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4585042">if</span>&nbsp;<span class="ident" id="4585045">err1</span>&nbsp;<span class="op" id="4585050">:=</span>&nbsp;<span class="ident" id="4585053">e</span><span class="op" id="4585054">.</span><span class="ident" id="4585055">incHi</span><span class="op" id="4585060">(</span><span class="op" id="4585061">)</span><span class="op" id="4585062">;</span>&nbsp;<span class="ident" id="4585064">err1</span>&nbsp;<span class="op" id="4585069">!=</span>&nbsp;<span class="ident" id="4585072">nil</span>&nbsp;<span class="op" id="4585076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4585081">if</span>&nbsp;<span class="ident" id="4585084">err1</span>&nbsp;<span class="op" id="4585089">==</span>&nbsp;<span class="ident" id="4585092">errOutOfCodes</span>&nbsp;<span class="op" id="4585106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4585112">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4585124">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4585129">e</span><span class="op" id="4585130">.</span><span class="ident" id="4585131">err</span>&nbsp;<span class="op" id="4585135">=</span>&nbsp;<span class="ident" id="4585137">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4585145">return</span>&nbsp;<span class="num" id="4585152">0</span><span class="op" id="4585153">,</span>&nbsp;<span class="ident" id="4585155">e</span><span class="op" id="4585156">.</span><span class="ident" id="4585157">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4585163">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4585167">//&nbsp;Otherwise,&nbsp;insert&nbsp;key&nbsp;-&gt;&nbsp;e.hi&nbsp;into&nbsp;the&nbsp;map&nbsp;that&nbsp;e.table&nbsp;represents.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4585240">for</span>&nbsp;<span class="op" id="4585244">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4585249">if</span>&nbsp;<span class="ident" id="4585252">e</span><span class="op" id="4585253">.</span><span class="ident" id="4585254">table</span><span class="op" id="4585259">[</span><span class="ident" id="4585260">hash</span><span class="op" id="4585264">]</span>&nbsp;<span class="op" id="4585266">==</span>&nbsp;<span class="ident" id="4585269">invalidEntry</span>&nbsp;<span class="op" id="4585282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4585288">e</span><span class="op" id="4585289">.</span><span class="ident" id="4585290">table</span><span class="op" id="4585295">[</span><span class="ident" id="4585296">hash</span><span class="op" id="4585300">]</span>&nbsp;<span class="op" id="4585302">=</span>&nbsp;<span class="op" id="4585304">(</span><span class="ident" id="4585305">key</span>&nbsp;<span class="op" id="4585309">&lt;&lt;</span>&nbsp;<span class="num" id="4585312">12</span><span class="op" id="4585314">)</span>&nbsp;<span class="op" id="4585316">|</span>&nbsp;<span class="ident" id="4585318">e</span><span class="op" id="4585319">.</span><span class="ident" id="4585320">hi</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4585327">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4585336">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4585341">hash</span>&nbsp;<span class="op" id="4585346">=</span>&nbsp;<span class="op" id="4585348">(</span><span class="ident" id="4585349">hash</span>&nbsp;<span class="op" id="4585354">+</span>&nbsp;<span class="num" id="4585356">1</span><span class="op" id="4585357">)</span>&nbsp;<span class="op" id="4585359">&amp;</span>&nbsp;<span class="ident" id="4585361">tableMask</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4585373">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4585376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4585379">e</span><span class="op" id="4585380">.</span><span class="ident" id="4585381">savedCode</span>&nbsp;<span class="op" id="4585391">=</span>&nbsp;<span class="ident" id="4585393">code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4585399">return</span>&nbsp;<span class="ident" id="4585406">n</span><span class="op" id="4585407">,</span>&nbsp;<span class="ident" id="4585409">nil</span><br>
<span class="lineno"></span><span class="op" id="4585413">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="4585416">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;encoder,&nbsp;flushing&nbsp;any&nbsp;pending&nbsp;output.&nbsp;It&nbsp;does&nbsp;not&nbsp;close&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="4585495">//&nbsp;flush&nbsp;e&#39;s&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4585527">func</span>&nbsp;<span class="op" id="4585532">(</span><span class="ident" id="4585533">e</span>&nbsp;<span class="op" id="4585535">*</span><span class="ident" id="4585536">encoder</span><span class="op" id="4585543">)</span>&nbsp;<span class="ident" id="4585545">Close</span><span class="op" id="4585550">(</span><span class="op" id="4585551">)</span>&nbsp;<span class="builtintype" id="4585553">error</span>&nbsp;<span class="op" id="4585559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4585562">if</span>&nbsp;<span class="ident" id="4585565">e</span><span class="op" id="4585566">.</span><span class="ident" id="4585567">err</span>&nbsp;<span class="op" id="4585571">!=</span>&nbsp;<span class="ident" id="4585574">nil</span>&nbsp;<span class="op" id="4585578">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4585582">if</span>&nbsp;<span class="ident" id="4585585">e</span><span class="op" id="4585586">.</span><span class="ident" id="4585587">err</span>&nbsp;<span class="op" id="4585591">==</span>&nbsp;<span class="ident" id="4585594">errClosed</span>&nbsp;<span class="op" id="4585604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4585609">return</span>&nbsp;<span class="ident" id="4585616">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4585622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4585626">return</span>&nbsp;<span class="ident" id="4585633">e</span><span class="op" id="4585634">.</span><span class="ident" id="4585635">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4585640">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4585643">//&nbsp;Make&nbsp;any&nbsp;future&nbsp;calls&nbsp;to&nbsp;Write&nbsp;return&nbsp;errClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4585696">e</span><span class="op" id="4585697">.</span><span class="ident" id="4585698">err</span>&nbsp;<span class="op" id="4585702">=</span>&nbsp;<span class="ident" id="4585704">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4585715">//&nbsp;Write&nbsp;the&nbsp;savedCode&nbsp;if&nbsp;valid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4585749">if</span>&nbsp;<span class="ident" id="4585752">e</span><span class="op" id="4585753">.</span><span class="ident" id="4585754">savedCode</span>&nbsp;<span class="op" id="4585764">!=</span>&nbsp;<span class="ident" id="4585767">invalidCode</span>&nbsp;<span class="op" id="4585779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4585783">if</span>&nbsp;<span class="ident" id="4585786">err</span>&nbsp;<span class="op" id="4585790">:=</span>&nbsp;<span class="ident" id="4585793">e</span><span class="op" id="4585794">.</span><span class="ident" id="4585795">write</span><span class="op" id="4585800">(</span><span class="ident" id="4585801">e</span><span class="op" id="4585802">,</span>&nbsp;<span class="ident" id="4585804">e</span><span class="op" id="4585805">.</span><span class="ident" id="4585806">savedCode</span><span class="op" id="4585815">)</span><span class="op" id="4585816">;</span>&nbsp;<span class="ident" id="4585818">err</span>&nbsp;<span class="op" id="4585822">!=</span>&nbsp;<span class="ident" id="4585825">nil</span>&nbsp;<span class="op" id="4585829">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4585834">return</span>&nbsp;<span class="ident" id="4585841">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4585847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4585851">if</span>&nbsp;<span class="ident" id="4585854">err</span>&nbsp;<span class="op" id="4585858">:=</span>&nbsp;<span class="ident" id="4585861">e</span><span class="op" id="4585862">.</span><span class="ident" id="4585863">incHi</span><span class="op" id="4585868">(</span><span class="op" id="4585869">)</span><span class="op" id="4585870">;</span>&nbsp;<span class="ident" id="4585872">err</span>&nbsp;<span class="op" id="4585876">!=</span>&nbsp;<span class="ident" id="4585879">nil</span>&nbsp;<span class="op" id="4585883">&amp;&amp;</span>&nbsp;<span class="ident" id="4585886">err</span>&nbsp;<span class="op" id="4585890">!=</span>&nbsp;<span class="ident" id="4585893">errOutOfCodes</span>&nbsp;<span class="op" id="4585907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4585912">return</span>&nbsp;<span class="ident" id="4585919">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4585925">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4585928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4585931">//&nbsp;Write&nbsp;the&nbsp;eof&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4585955">eof</span>&nbsp;<span class="op" id="4585959">:=</span>&nbsp;<span class="builtintype" id="4585962">uint32</span><span class="op" id="4585968">(</span><span class="num" id="4585969">1</span><span class="op" id="4585970">)</span><span class="op" id="4585971">&lt;&lt;</span><span class="ident" id="4585973">e</span><span class="op" id="4585974">.</span><span class="ident" id="4585975">litWidth</span>&nbsp;<span class="op" id="4585984">+</span>&nbsp;<span class="num" id="4585986">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4585989">if</span>&nbsp;<span class="ident" id="4585992">err</span>&nbsp;<span class="op" id="4585996">:=</span>&nbsp;<span class="ident" id="4585999">e</span><span class="op" id="4586000">.</span><span class="ident" id="4586001">write</span><span class="op" id="4586006">(</span><span class="ident" id="4586007">e</span><span class="op" id="4586008">,</span>&nbsp;<span class="ident" id="4586010">eof</span><span class="op" id="4586013">)</span><span class="op" id="4586014">;</span>&nbsp;<span class="ident" id="4586016">err</span>&nbsp;<span class="op" id="4586020">!=</span>&nbsp;<span class="ident" id="4586023">nil</span>&nbsp;<span class="op" id="4586027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4586031">return</span>&nbsp;<span class="ident" id="4586038">err</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4586043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4586046">//&nbsp;Write&nbsp;the&nbsp;final&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4586072">if</span>&nbsp;<span class="ident" id="4586075">e</span><span class="op" id="4586076">.</span><span class="ident" id="4586077">nBits</span>&nbsp;<span class="op" id="4586083">&gt;</span>&nbsp;<span class="num" id="4586085">0</span>&nbsp;<span class="op" id="4586087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4586091">if</span>&nbsp;<span class="ident" id="4586094">e</span><span class="op" id="4586095">.</span><span class="ident" id="4586096">order</span>&nbsp;<span class="op" id="4586102">==</span>&nbsp;<span class="ident" id="4586105">MSB</span>&nbsp;<span class="op" id="4586109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4586114">e</span><span class="op" id="4586115">.</span><span class="ident" id="4586116">bits</span>&nbsp;<span class="op" id="4586121">&gt;&gt;=</span>&nbsp;<span class="num" id="4586125">24</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4586130">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4586134">if</span>&nbsp;<span class="ident" id="4586137">err</span>&nbsp;<span class="op" id="4586141">:=</span>&nbsp;<span class="ident" id="4586144">e</span><span class="op" id="4586145">.</span><span class="ident" id="4586146">w</span><span class="op" id="4586147">.</span><span class="ident" id="4586148">WriteByte</span><span class="op" id="4586157">(</span><span class="builtintype" id="4586158">uint8</span><span class="op" id="4586163">(</span><span class="ident" id="4586164">e</span><span class="op" id="4586165">.</span><span class="ident" id="4586166">bits</span><span class="op" id="4586170">)</span><span class="op" id="4586171">)</span><span class="op" id="4586172">;</span>&nbsp;<span class="ident" id="4586174">err</span>&nbsp;<span class="op" id="4586178">!=</span>&nbsp;<span class="ident" id="4586181">nil</span>&nbsp;<span class="op" id="4586185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4586190">return</span>&nbsp;<span class="ident" id="4586197">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4586203">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4586206">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4586209">return</span>&nbsp;<span class="ident" id="4586216">e</span><span class="op" id="4586217">.</span><span class="ident" id="4586218">w</span><span class="op" id="4586219">.</span><span class="ident" id="4586220">Flush</span><span class="op" id="4586225">(</span><span class="op" id="4586226">)</span><br>
<span class="lineno"></span><span class="op" id="4586228">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4586231">//&nbsp;NewWriter&nbsp;creates&nbsp;a&nbsp;new&nbsp;io.WriteCloser.</span><br>
<span class="lineno"></span><span class="comment" id="4586274">//&nbsp;Writes&nbsp;to&nbsp;the&nbsp;returned&nbsp;io.WriteCloser&nbsp;are&nbsp;compressed&nbsp;and&nbsp;written&nbsp;to&nbsp;w.</span><br>
<span class="lineno">230</span><span class="comment" id="4586348">//&nbsp;It&nbsp;is&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;call&nbsp;Close&nbsp;on&nbsp;the&nbsp;WriteCloser&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="4586423">//&nbsp;finished&nbsp;writing.</span><br>
<span class="lineno"></span><span class="comment" id="4586444">//&nbsp;The&nbsp;number&nbsp;of&nbsp;bits&nbsp;to&nbsp;use&nbsp;for&nbsp;literal&nbsp;codes,&nbsp;litWidth,&nbsp;must&nbsp;be&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4586517">//&nbsp;range&nbsp;[2,8]&nbsp;and&nbsp;is&nbsp;typically&nbsp;8.</span><br>
<span class="lineno"></span><span class="keyword" id="4586552">func</span>&nbsp;<span class="ident" id="4586557">NewWriter</span><span class="op" id="4586566">(</span><span class="ident" id="4586567">w</span>&nbsp;<span class="ident" id="4586569">io</span><span class="op" id="4586571">.</span><span class="ident" id="4586572">Writer</span><span class="op" id="4586578">,</span>&nbsp;<span class="ident" id="4586580">order</span>&nbsp;<span class="ident" id="4586586">Order</span><span class="op" id="4586591">,</span>&nbsp;<span class="ident" id="4586593">litWidth</span>&nbsp;<span class="builtintype" id="4586602">int</span><span class="op" id="4586605">)</span>&nbsp;<span class="ident" id="4586607">io</span><span class="op" id="4586609">.</span><span class="ident" id="4586610">WriteCloser</span>&nbsp;<span class="op" id="4586622">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4586625">var</span>&nbsp;<span class="ident" id="4586629">write</span>&nbsp;<span class="keyword" id="4586635">func</span><span class="op" id="4586639">(</span><span class="op" id="4586640">*</span><span class="ident" id="4586641">encoder</span><span class="op" id="4586648">,</span>&nbsp;<span class="builtintype" id="4586650">uint32</span><span class="op" id="4586656">)</span>&nbsp;<span class="builtintype" id="4586658">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4586665">switch</span>&nbsp;<span class="ident" id="4586672">order</span>&nbsp;<span class="op" id="4586678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4586681">case</span>&nbsp;<span class="ident" id="4586686">LSB</span><span class="op" id="4586689">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4586693">write</span>&nbsp;<span class="op" id="4586699">=</span>&nbsp;<span class="op" id="4586701">(</span><span class="op" id="4586702">*</span><span class="ident" id="4586703">encoder</span><span class="op" id="4586710">)</span><span class="op" id="4586711">.</span><span class="ident" id="4586712">writeLSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4586722">case</span>&nbsp;<span class="ident" id="4586727">MSB</span><span class="op" id="4586730">:</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4586734">write</span>&nbsp;<span class="op" id="4586740">=</span>&nbsp;<span class="op" id="4586742">(</span><span class="op" id="4586743">*</span><span class="ident" id="4586744">encoder</span><span class="op" id="4586751">)</span><span class="op" id="4586752">.</span><span class="ident" id="4586753">writeMSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4586763">default</span><span class="op" id="4586770">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4586774">return</span>&nbsp;<span class="op" id="4586781">&amp;</span><span class="ident" id="4586782">errWriteCloser</span><span class="op" id="4586796">{</span><span class="ident" id="4586797">errors</span><span class="op" id="4586803">.</span><span class="ident" id="4586804">New</span><span class="op" id="4586807">(</span><span class="string" id="4586808">&#34;lzw:&nbsp;unknown&nbsp;order&#34;</span><span class="op" id="4586828">)</span><span class="op" id="4586829">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4586832">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4586835">if</span>&nbsp;<span class="ident" id="4586838">litWidth</span>&nbsp;<span class="op" id="4586847">&lt;</span>&nbsp;<span class="num" id="4586849">2</span>&nbsp;<span class="op" id="4586851">||</span>&nbsp;<span class="num" id="4586854">8</span>&nbsp;<span class="op" id="4586856">&lt;</span>&nbsp;<span class="ident" id="4586858">litWidth</span>&nbsp;<span class="op" id="4586867">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4586871">return</span>&nbsp;<span class="op" id="4586878">&amp;</span><span class="ident" id="4586879">errWriteCloser</span><span class="op" id="4586893">{</span><span class="ident" id="4586894">fmt</span><span class="op" id="4586897">.</span><span class="ident" id="4586898">Errorf</span><span class="op" id="4586904">(</span><span class="string" id="4586905">&#34;lzw:&nbsp;litWidth&nbsp;%d&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="4586936">,</span>&nbsp;<span class="ident" id="4586938">litWidth</span><span class="op" id="4586946">)</span><span class="op" id="4586947">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4586950">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4586953">bw</span><span class="op" id="4586955">,</span>&nbsp;<span class="ident" id="4586957">ok</span>&nbsp;<span class="op" id="4586960">:=</span>&nbsp;<span class="ident" id="4586963">w</span><span class="op" id="4586964">.</span><span class="op" id="4586965">(</span><span class="ident" id="4586966">writer</span><span class="op" id="4586972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4586975">if</span>&nbsp;<span class="op" id="4586978">!</span><span class="ident" id="4586979">ok</span>&nbsp;<span class="op" id="4586982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4586986">bw</span>&nbsp;<span class="op" id="4586989">=</span>&nbsp;<span class="ident" id="4586991">bufio</span><span class="op" id="4586996">.</span><span class="ident" id="4586997">NewWriter</span><span class="op" id="4587006">(</span><span class="ident" id="4587007">w</span><span class="op" id="4587008">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4587011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4587014">lw</span>&nbsp;<span class="op" id="4587017">:=</span>&nbsp;<span class="builtintype" id="4587020">uint</span><span class="op" id="4587024">(</span><span class="ident" id="4587025">litWidth</span><span class="op" id="4587033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4587036">return</span>&nbsp;<span class="op" id="4587043">&amp;</span><span class="ident" id="4587044">encoder</span><span class="op" id="4587051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4587055">w</span><span class="op" id="4587056">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4587066">bw</span><span class="op" id="4587068">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4587072">order</span><span class="op" id="4587077">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4587083">order</span><span class="op" id="4587088">,</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4587092">write</span><span class="op" id="4587097">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4587103">write</span><span class="op" id="4587108">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4587112">width</span><span class="op" id="4587117">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="4587123">1</span>&nbsp;<span class="op" id="4587125">+</span>&nbsp;<span class="ident" id="4587127">lw</span><span class="op" id="4587129">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4587133">litWidth</span><span class="op" id="4587141">:</span>&nbsp;&nbsp;<span class="ident" id="4587144">lw</span><span class="op" id="4587146">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4587150">hi</span><span class="op" id="4587152">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="4587161">1</span><span class="op" id="4587162">&lt;&lt;</span><span class="ident" id="4587164">lw</span>&nbsp;<span class="op" id="4587167">+</span>&nbsp;<span class="num" id="4587169">1</span><span class="op" id="4587170">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4587174">overflow</span><span class="op" id="4587182">:</span>&nbsp;&nbsp;<span class="num" id="4587185">1</span>&nbsp;<span class="op" id="4587187">&lt;&lt;</span>&nbsp;<span class="op" id="4587190">(</span><span class="ident" id="4587191">lw</span>&nbsp;<span class="op" id="4587194">+</span>&nbsp;<span class="num" id="4587196">1</span><span class="op" id="4587197">)</span><span class="op" id="4587198">,</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4587202">savedCode</span><span class="op" id="4587211">:</span>&nbsp;<span class="ident" id="4587213">invalidCode</span><span class="op" id="4587224">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4587227">}</span><br>
<span class="lineno"></span><span class="op" id="4587229">}</span>
</div>
</body>
</html>
