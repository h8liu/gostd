<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1381020">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1381075">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1381129">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1381180">package</span>&nbsp;<span class="ident" id="1381188">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1381194">import</span>&nbsp;<span class="op" id="1381201">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1381204">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1381219">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><span class="op" id="1381228">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1381231">//&nbsp;A&nbsp;WaitGroup&nbsp;waits&nbsp;for&nbsp;a&nbsp;collection&nbsp;of&nbsp;goroutines&nbsp;to&nbsp;finish.</span><br>
<span class="lineno"></span><span class="comment" id="1381294">//&nbsp;The&nbsp;main&nbsp;goroutine&nbsp;calls&nbsp;Add&nbsp;to&nbsp;set&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="1381347">//&nbsp;goroutines&nbsp;to&nbsp;wait&nbsp;for.&nbsp;&nbsp;Then&nbsp;each&nbsp;of&nbsp;the&nbsp;goroutines</span><br>
<span class="lineno">15</span><span class="comment" id="1381403">//&nbsp;runs&nbsp;and&nbsp;calls&nbsp;Done&nbsp;when&nbsp;finished.&nbsp;&nbsp;At&nbsp;the&nbsp;same&nbsp;time,</span><br>
<span class="lineno"></span><span class="comment" id="1381460">//&nbsp;Wait&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;block&nbsp;until&nbsp;all&nbsp;goroutines&nbsp;have&nbsp;finished.</span><br>
<span class="lineno"></span><span class="keyword" id="1381525">type</span>&nbsp;<span class="ident" id="1381530">WaitGroup</span>&nbsp;<span class="keyword" id="1381540">struct</span>&nbsp;<span class="op" id="1381547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1381550">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1381558">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1381565">counter</span>&nbsp;<span class="builtintype" id="1381573">int32</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1381580">waiters</span>&nbsp;<span class="builtintype" id="1381588">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1381595">sema</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1381603">*</span><span class="builtintype" id="1381604">uint32</span><br>
<span class="lineno"></span><span class="op" id="1381611">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1381614">//&nbsp;WaitGroup&nbsp;creates&nbsp;a&nbsp;new&nbsp;semaphore&nbsp;each&nbsp;time&nbsp;the&nbsp;old&nbsp;semaphore</span><br>
<span class="lineno">25</span><span class="comment" id="1381679">//&nbsp;is&nbsp;released.&nbsp;This&nbsp;is&nbsp;to&nbsp;avoid&nbsp;the&nbsp;following&nbsp;race:</span><br>
<span class="lineno"></span><span class="comment" id="1381732">//</span><br>
<span class="lineno"></span><span class="comment" id="1381735">//&nbsp;G1:&nbsp;Add(1)</span><br>
<span class="lineno"></span><span class="comment" id="1381749">//&nbsp;G1:&nbsp;go&nbsp;G2()</span><br>
<span class="lineno"></span><span class="comment" id="1381764">//&nbsp;G1:&nbsp;Wait()&nbsp;//&nbsp;Context&nbsp;switch&nbsp;after&nbsp;Unlock()&nbsp;and&nbsp;before&nbsp;Semacquire().</span><br>
<span class="lineno">30</span><span class="comment" id="1381836">//&nbsp;G2:&nbsp;Done()&nbsp;//&nbsp;Release&nbsp;semaphore:&nbsp;sema&nbsp;==&nbsp;1,&nbsp;waiters&nbsp;==&nbsp;0.&nbsp;G1&nbsp;doesn&#39;t&nbsp;run&nbsp;yet.</span><br>
<span class="lineno"></span><span class="comment" id="1381917">//&nbsp;G3:&nbsp;Wait()&nbsp;//&nbsp;Finds&nbsp;counter&nbsp;==&nbsp;0,&nbsp;waiters&nbsp;==&nbsp;0,&nbsp;doesn&#39;t&nbsp;block.</span><br>
<span class="lineno"></span><span class="comment" id="1381983">//&nbsp;G3:&nbsp;Add(1)&nbsp;//&nbsp;Makes&nbsp;counter&nbsp;==&nbsp;1,&nbsp;waiters&nbsp;==&nbsp;0.</span><br>
<span class="lineno"></span><span class="comment" id="1382034">//&nbsp;G3:&nbsp;go&nbsp;G4()</span><br>
<span class="lineno"></span><span class="comment" id="1382049">//&nbsp;G3:&nbsp;Wait()&nbsp;//&nbsp;G1&nbsp;still&nbsp;hasn&#39;t&nbsp;run,&nbsp;G3&nbsp;finds&nbsp;sema&nbsp;==&nbsp;1,&nbsp;unblocked!&nbsp;Bug.</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="1382124">//&nbsp;Add&nbsp;adds&nbsp;delta,&nbsp;which&nbsp;may&nbsp;be&nbsp;negative,&nbsp;to&nbsp;the&nbsp;WaitGroup&nbsp;counter.</span><br>
<span class="lineno"></span><span class="comment" id="1382192">//&nbsp;If&nbsp;the&nbsp;counter&nbsp;becomes&nbsp;zero,&nbsp;all&nbsp;goroutines&nbsp;blocked&nbsp;on&nbsp;Wait&nbsp;are&nbsp;released.</span><br>
<span class="lineno"></span><span class="comment" id="1382269">//&nbsp;If&nbsp;the&nbsp;counter&nbsp;goes&nbsp;negative,&nbsp;Add&nbsp;panics.</span><br>
<span class="lineno"></span><span class="comment" id="1382314">//</span><br>
<span class="lineno">40</span><span class="comment" id="1382317">//&nbsp;Note&nbsp;that&nbsp;calls&nbsp;with&nbsp;a&nbsp;positive&nbsp;delta&nbsp;that&nbsp;occur&nbsp;when&nbsp;the&nbsp;counter&nbsp;is&nbsp;zero</span><br>
<span class="lineno"></span><span class="comment" id="1382394">//&nbsp;must&nbsp;happen&nbsp;before&nbsp;a&nbsp;Wait.&nbsp;Calls&nbsp;with&nbsp;a&nbsp;negative&nbsp;delta,&nbsp;or&nbsp;calls&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1382469">//&nbsp;positive&nbsp;delta&nbsp;that&nbsp;start&nbsp;when&nbsp;the&nbsp;counter&nbsp;is&nbsp;greater&nbsp;than&nbsp;zero,&nbsp;may&nbsp;happen</span><br>
<span class="lineno"></span><span class="comment" id="1382548">//&nbsp;at&nbsp;any&nbsp;time.</span><br>
<span class="lineno"></span><span class="comment" id="1382564">//&nbsp;Typically&nbsp;this&nbsp;means&nbsp;the&nbsp;calls&nbsp;to&nbsp;Add&nbsp;should&nbsp;execute&nbsp;before&nbsp;the&nbsp;statement</span><br>
<span class="lineno">45</span><span class="comment" id="1382641">//&nbsp;creating&nbsp;the&nbsp;goroutine&nbsp;or&nbsp;other&nbsp;event&nbsp;to&nbsp;be&nbsp;waited&nbsp;for.</span><br>
<span class="lineno"></span><span class="comment" id="1382700">//&nbsp;See&nbsp;the&nbsp;WaitGroup&nbsp;example.</span><br>
<span class="lineno"></span><span class="keyword" id="1382730">func</span>&nbsp;<span class="op" id="1382735">(</span><span class="ident" id="1382736">wg</span>&nbsp;<span class="op" id="1382739">*</span><span class="ident" id="1382740">WaitGroup</span><span class="op" id="1382749">)</span>&nbsp;<span class="ident" id="1382751">Add</span><span class="op" id="1382754">(</span><span class="ident" id="1382755">delta</span>&nbsp;<span class="builtintype" id="1382761">int</span><span class="op" id="1382764">)</span>&nbsp;<span class="op" id="1382766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1382769">if</span>&nbsp;<span class="ident" id="1382772">raceenabled</span>&nbsp;<span class="op" id="1382784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1382788">_</span>&nbsp;<span class="op" id="1382790">=</span>&nbsp;<span class="ident" id="1382792">wg</span><span class="op" id="1382794">.</span><span class="ident" id="1382795">m</span><span class="op" id="1382796">.</span><span class="ident" id="1382797">state</span>&nbsp;<span class="comment" id="1382803">//&nbsp;trigger&nbsp;nil&nbsp;deref&nbsp;early</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1382832">if</span>&nbsp;<span class="ident" id="1382835">delta</span>&nbsp;<span class="op" id="1382841">&lt;</span>&nbsp;<span class="num" id="1382843">0</span>&nbsp;<span class="op" id="1382845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1382850">//&nbsp;Synchronize&nbsp;decrements&nbsp;with&nbsp;Wait.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1382890">raceReleaseMerge</span><span class="op" id="1382906">(</span><span class="ident" id="1382907">unsafe</span><span class="op" id="1382913">.</span><span class="ident" id="1382914">Pointer</span><span class="op" id="1382921">(</span><span class="ident" id="1382922">wg</span><span class="op" id="1382924">)</span><span class="op" id="1382925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1382929">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1382933">raceDisable</span><span class="op" id="1382944">(</span><span class="op" id="1382945">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1382949">defer</span>&nbsp;<span class="ident" id="1382955">raceEnable</span><span class="op" id="1382965">(</span><span class="op" id="1382966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1382969">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1382972">v</span>&nbsp;<span class="op" id="1382974">:=</span>&nbsp;<span class="ident" id="1382977">atomic</span><span class="op" id="1382983">.</span><span class="ident" id="1382984">AddInt32</span><span class="op" id="1382992">(</span><span class="op" id="1382993">&amp;</span><span class="ident" id="1382994">wg</span><span class="op" id="1382996">.</span><span class="ident" id="1382997">counter</span><span class="op" id="1383004">,</span>&nbsp;<span class="builtintype" id="1383006">int32</span><span class="op" id="1383011">(</span><span class="ident" id="1383012">delta</span><span class="op" id="1383017">)</span><span class="op" id="1383018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1383021">if</span>&nbsp;<span class="ident" id="1383024">raceenabled</span>&nbsp;<span class="op" id="1383036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1383040">if</span>&nbsp;<span class="ident" id="1383043">delta</span>&nbsp;<span class="op" id="1383049">&gt;</span>&nbsp;<span class="num" id="1383051">0</span>&nbsp;<span class="op" id="1383053">&amp;&amp;</span>&nbsp;<span class="ident" id="1383056">v</span>&nbsp;<span class="op" id="1383058">==</span>&nbsp;<span class="builtintype" id="1383061">int32</span><span class="op" id="1383066">(</span><span class="ident" id="1383067">delta</span><span class="op" id="1383072">)</span>&nbsp;<span class="op" id="1383074">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1383079">//&nbsp;The&nbsp;first&nbsp;increment&nbsp;must&nbsp;be&nbsp;synchronized&nbsp;with&nbsp;Wait.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1383137">//&nbsp;Need&nbsp;to&nbsp;model&nbsp;this&nbsp;as&nbsp;a&nbsp;read,&nbsp;because&nbsp;there&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1383194">//&nbsp;several&nbsp;concurrent&nbsp;wg.counter&nbsp;transitions&nbsp;from&nbsp;0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1383250">raceRead</span><span class="op" id="1383258">(</span><span class="ident" id="1383259">unsafe</span><span class="op" id="1383265">.</span><span class="ident" id="1383266">Pointer</span><span class="op" id="1383273">(</span><span class="op" id="1383274">&amp;</span><span class="ident" id="1383275">wg</span><span class="op" id="1383277">.</span><span class="ident" id="1383278">sema</span><span class="op" id="1383282">)</span><span class="op" id="1383283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1383287">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1383290">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1383293">if</span>&nbsp;<span class="ident" id="1383296">v</span>&nbsp;<span class="op" id="1383298">&lt;</span>&nbsp;<span class="num" id="1383300">0</span>&nbsp;<span class="op" id="1383302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1383306">panic</span><span class="op" id="1383311">(</span><span class="string" id="1383312">&#34;sync:&nbsp;negative&nbsp;WaitGroup&nbsp;counter&#34;</span><span class="op" id="1383346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1383349">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1383352">if</span>&nbsp;<span class="ident" id="1383355">v</span>&nbsp;<span class="op" id="1383357">&gt;</span>&nbsp;<span class="num" id="1383359">0</span>&nbsp;<span class="op" id="1383361">||</span>&nbsp;<span class="ident" id="1383364">atomic</span><span class="op" id="1383370">.</span><span class="ident" id="1383371">LoadInt32</span><span class="op" id="1383380">(</span><span class="op" id="1383381">&amp;</span><span class="ident" id="1383382">wg</span><span class="op" id="1383384">.</span><span class="ident" id="1383385">waiters</span><span class="op" id="1383392">)</span>&nbsp;<span class="op" id="1383394">==</span>&nbsp;<span class="num" id="1383397">0</span>&nbsp;<span class="op" id="1383399">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1383403">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1383411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1383414">wg</span><span class="op" id="1383416">.</span><span class="ident" id="1383417">m</span><span class="op" id="1383418">.</span><span class="ident" id="1383419">Lock</span><span class="op" id="1383423">(</span><span class="op" id="1383424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1383427">if</span>&nbsp;<span class="ident" id="1383430">atomic</span><span class="op" id="1383436">.</span><span class="ident" id="1383437">LoadInt32</span><span class="op" id="1383446">(</span><span class="op" id="1383447">&amp;</span><span class="ident" id="1383448">wg</span><span class="op" id="1383450">.</span><span class="ident" id="1383451">counter</span><span class="op" id="1383458">)</span>&nbsp;<span class="op" id="1383460">==</span>&nbsp;<span class="num" id="1383463">0</span>&nbsp;<span class="op" id="1383465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1383469">for</span>&nbsp;<span class="ident" id="1383473">i</span>&nbsp;<span class="op" id="1383475">:=</span>&nbsp;<span class="builtintype" id="1383478">int32</span><span class="op" id="1383483">(</span><span class="num" id="1383484">0</span><span class="op" id="1383485">)</span><span class="op" id="1383486">;</span>&nbsp;<span class="ident" id="1383488">i</span>&nbsp;<span class="op" id="1383490">&lt;</span>&nbsp;<span class="ident" id="1383492">wg</span><span class="op" id="1383494">.</span><span class="ident" id="1383495">waiters</span><span class="op" id="1383502">;</span>&nbsp;<span class="ident" id="1383504">i</span><span class="op" id="1383505">++</span>&nbsp;<span class="op" id="1383508">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1383513">runtime_Semrelease</span><span class="op" id="1383531">(</span><span class="ident" id="1383532">wg</span><span class="op" id="1383534">.</span><span class="ident" id="1383535">sema</span><span class="op" id="1383539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1383543">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1383547">wg</span><span class="op" id="1383549">.</span><span class="ident" id="1383550">waiters</span>&nbsp;<span class="op" id="1383558">=</span>&nbsp;<span class="num" id="1383560">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1383564">wg</span><span class="op" id="1383566">.</span><span class="ident" id="1383567">sema</span>&nbsp;<span class="op" id="1383572">=</span>&nbsp;<span class="ident" id="1383574">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1383579">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1383582">wg</span><span class="op" id="1383584">.</span><span class="ident" id="1383585">m</span><span class="op" id="1383586">.</span><span class="ident" id="1383587">Unlock</span><span class="op" id="1383593">(</span><span class="op" id="1383594">)</span><br>
<span class="lineno"></span><span class="op" id="1383596">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1383599">//&nbsp;Done&nbsp;decrements&nbsp;the&nbsp;WaitGroup&nbsp;counter.</span><br>
<span class="lineno"></span><span class="keyword" id="1383641">func</span>&nbsp;<span class="op" id="1383646">(</span><span class="ident" id="1383647">wg</span>&nbsp;<span class="op" id="1383650">*</span><span class="ident" id="1383651">WaitGroup</span><span class="op" id="1383660">)</span>&nbsp;<span class="ident" id="1383662">Done</span><span class="op" id="1383666">(</span><span class="op" id="1383667">)</span>&nbsp;<span class="op" id="1383669">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1383672">wg</span><span class="op" id="1383674">.</span><span class="ident" id="1383675">Add</span><span class="op" id="1383678">(</span><span class="op" id="1383679">-</span><span class="num" id="1383680">1</span><span class="op" id="1383681">)</span><br>
<span class="lineno"></span><span class="op" id="1383683">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1383686">//&nbsp;Wait&nbsp;blocks&nbsp;until&nbsp;the&nbsp;WaitGroup&nbsp;counter&nbsp;is&nbsp;zero.</span><br>
<span class="lineno"></span><span class="keyword" id="1383738">func</span>&nbsp;<span class="op" id="1383743">(</span><span class="ident" id="1383744">wg</span>&nbsp;<span class="op" id="1383747">*</span><span class="ident" id="1383748">WaitGroup</span><span class="op" id="1383757">)</span>&nbsp;<span class="ident" id="1383759">Wait</span><span class="op" id="1383763">(</span><span class="op" id="1383764">)</span>&nbsp;<span class="op" id="1383766">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1383769">if</span>&nbsp;<span class="ident" id="1383772">raceenabled</span>&nbsp;<span class="op" id="1383784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1383788">_</span>&nbsp;<span class="op" id="1383790">=</span>&nbsp;<span class="ident" id="1383792">wg</span><span class="op" id="1383794">.</span><span class="ident" id="1383795">m</span><span class="op" id="1383796">.</span><span class="ident" id="1383797">state</span>&nbsp;<span class="comment" id="1383803">//&nbsp;trigger&nbsp;nil&nbsp;deref&nbsp;early</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1383832">raceDisable</span><span class="op" id="1383843">(</span><span class="op" id="1383844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1383847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1383850">if</span>&nbsp;<span class="ident" id="1383853">atomic</span><span class="op" id="1383859">.</span><span class="ident" id="1383860">LoadInt32</span><span class="op" id="1383869">(</span><span class="op" id="1383870">&amp;</span><span class="ident" id="1383871">wg</span><span class="op" id="1383873">.</span><span class="ident" id="1383874">counter</span><span class="op" id="1383881">)</span>&nbsp;<span class="op" id="1383883">==</span>&nbsp;<span class="num" id="1383886">0</span>&nbsp;<span class="op" id="1383888">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1383892">if</span>&nbsp;<span class="ident" id="1383895">raceenabled</span>&nbsp;<span class="op" id="1383907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1383912">raceEnable</span><span class="op" id="1383922">(</span><span class="op" id="1383923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1383928">raceAcquire</span><span class="op" id="1383939">(</span><span class="ident" id="1383940">unsafe</span><span class="op" id="1383946">.</span><span class="ident" id="1383947">Pointer</span><span class="op" id="1383954">(</span><span class="ident" id="1383955">wg</span><span class="op" id="1383957">)</span><span class="op" id="1383958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1383962">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1383966">return</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1383974">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1383977">wg</span><span class="op" id="1383979">.</span><span class="ident" id="1383980">m</span><span class="op" id="1383981">.</span><span class="ident" id="1383982">Lock</span><span class="op" id="1383986">(</span><span class="op" id="1383987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1383990">w</span>&nbsp;<span class="op" id="1383992">:=</span>&nbsp;<span class="ident" id="1383995">atomic</span><span class="op" id="1384001">.</span><span class="ident" id="1384002">AddInt32</span><span class="op" id="1384010">(</span><span class="op" id="1384011">&amp;</span><span class="ident" id="1384012">wg</span><span class="op" id="1384014">.</span><span class="ident" id="1384015">waiters</span><span class="op" id="1384022">,</span>&nbsp;<span class="num" id="1384024">1</span><span class="op" id="1384025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1384028">//&nbsp;This&nbsp;code&nbsp;is&nbsp;racing&nbsp;with&nbsp;the&nbsp;unlocked&nbsp;path&nbsp;in&nbsp;Add&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1384089">//&nbsp;The&nbsp;code&nbsp;above&nbsp;modifies&nbsp;counter&nbsp;and&nbsp;then&nbsp;reads&nbsp;waiters.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1384149">//&nbsp;We&nbsp;must&nbsp;modify&nbsp;waiters&nbsp;and&nbsp;then&nbsp;read&nbsp;counter&nbsp;(the&nbsp;opposite&nbsp;order)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1384219">//&nbsp;to&nbsp;avoid&nbsp;missing&nbsp;an&nbsp;Add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1384248">if</span>&nbsp;<span class="ident" id="1384251">atomic</span><span class="op" id="1384257">.</span><span class="ident" id="1384258">LoadInt32</span><span class="op" id="1384267">(</span><span class="op" id="1384268">&amp;</span><span class="ident" id="1384269">wg</span><span class="op" id="1384271">.</span><span class="ident" id="1384272">counter</span><span class="op" id="1384279">)</span>&nbsp;<span class="op" id="1384281">==</span>&nbsp;<span class="num" id="1384284">0</span>&nbsp;<span class="op" id="1384286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1384290">atomic</span><span class="op" id="1384296">.</span><span class="ident" id="1384297">AddInt32</span><span class="op" id="1384305">(</span><span class="op" id="1384306">&amp;</span><span class="ident" id="1384307">wg</span><span class="op" id="1384309">.</span><span class="ident" id="1384310">waiters</span><span class="op" id="1384317">,</span>&nbsp;<span class="op" id="1384319">-</span><span class="num" id="1384320">1</span><span class="op" id="1384321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1384325">if</span>&nbsp;<span class="ident" id="1384328">raceenabled</span>&nbsp;<span class="op" id="1384340">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1384345">raceEnable</span><span class="op" id="1384355">(</span><span class="op" id="1384356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1384361">raceAcquire</span><span class="op" id="1384372">(</span><span class="ident" id="1384373">unsafe</span><span class="op" id="1384379">.</span><span class="ident" id="1384380">Pointer</span><span class="op" id="1384387">(</span><span class="ident" id="1384388">wg</span><span class="op" id="1384390">)</span><span class="op" id="1384391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1384396">raceDisable</span><span class="op" id="1384407">(</span><span class="op" id="1384408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1384412">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1384416">wg</span><span class="op" id="1384418">.</span><span class="ident" id="1384419">m</span><span class="op" id="1384420">.</span><span class="ident" id="1384421">Unlock</span><span class="op" id="1384427">(</span><span class="op" id="1384428">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1384432">if</span>&nbsp;<span class="ident" id="1384435">raceenabled</span>&nbsp;<span class="op" id="1384447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1384452">raceEnable</span><span class="op" id="1384462">(</span><span class="op" id="1384463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1384467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1384471">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1384479">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1384482">if</span>&nbsp;<span class="ident" id="1384485">raceenabled</span>&nbsp;<span class="op" id="1384497">&amp;&amp;</span>&nbsp;<span class="ident" id="1384500">w</span>&nbsp;<span class="op" id="1384502">==</span>&nbsp;<span class="num" id="1384505">1</span>&nbsp;<span class="op" id="1384507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1384511">//&nbsp;Wait&nbsp;must&nbsp;be&nbsp;synchronized&nbsp;with&nbsp;the&nbsp;first&nbsp;Add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1384562">//&nbsp;Need&nbsp;to&nbsp;model&nbsp;this&nbsp;is&nbsp;as&nbsp;a&nbsp;write&nbsp;to&nbsp;race&nbsp;with&nbsp;the&nbsp;read&nbsp;in&nbsp;Add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1384630">//&nbsp;As&nbsp;a&nbsp;consequence,&nbsp;can&nbsp;do&nbsp;the&nbsp;write&nbsp;only&nbsp;for&nbsp;the&nbsp;first&nbsp;waiter,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1384697">//&nbsp;otherwise&nbsp;concurrent&nbsp;Waits&nbsp;will&nbsp;race&nbsp;with&nbsp;each&nbsp;other.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1384756">raceWrite</span><span class="op" id="1384765">(</span><span class="ident" id="1384766">unsafe</span><span class="op" id="1384772">.</span><span class="ident" id="1384773">Pointer</span><span class="op" id="1384780">(</span><span class="op" id="1384781">&amp;</span><span class="ident" id="1384782">wg</span><span class="op" id="1384784">.</span><span class="ident" id="1384785">sema</span><span class="op" id="1384789">)</span><span class="op" id="1384790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1384793">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1384796">if</span>&nbsp;<span class="ident" id="1384799">wg</span><span class="op" id="1384801">.</span><span class="ident" id="1384802">sema</span>&nbsp;<span class="op" id="1384807">==</span>&nbsp;<span class="ident" id="1384810">nil</span>&nbsp;<span class="op" id="1384814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1384818">wg</span><span class="op" id="1384820">.</span><span class="ident" id="1384821">sema</span>&nbsp;<span class="op" id="1384826">=</span>&nbsp;<span class="builtinfunc" id="1384828">new</span><span class="op" id="1384831">(</span><span class="builtintype" id="1384832">uint32</span><span class="op" id="1384838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1384841">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1384844">s</span>&nbsp;<span class="op" id="1384846">:=</span>&nbsp;<span class="ident" id="1384849">wg</span><span class="op" id="1384851">.</span><span class="ident" id="1384852">sema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1384858">wg</span><span class="op" id="1384860">.</span><span class="ident" id="1384861">m</span><span class="op" id="1384862">.</span><span class="ident" id="1384863">Unlock</span><span class="op" id="1384869">(</span><span class="op" id="1384870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1384873">runtime_Semacquire</span><span class="op" id="1384891">(</span><span class="ident" id="1384892">s</span><span class="op" id="1384893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1384896">if</span>&nbsp;<span class="ident" id="1384899">raceenabled</span>&nbsp;<span class="op" id="1384911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1384915">raceEnable</span><span class="op" id="1384925">(</span><span class="op" id="1384926">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1384930">raceAcquire</span><span class="op" id="1384941">(</span><span class="ident" id="1384942">unsafe</span><span class="op" id="1384948">.</span><span class="ident" id="1384949">Pointer</span><span class="op" id="1384956">(</span><span class="ident" id="1384957">wg</span><span class="op" id="1384959">)</span><span class="op" id="1384960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1384963">}</span><br>
<span class="lineno"></span><span class="op" id="1384965">}</span>
</div>
</body>
</html>
