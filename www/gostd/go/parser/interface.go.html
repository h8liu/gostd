<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>go/parser</h2>
<ul>
<li><a href="/gostd/go/parser/error_test.go.html">error_test.go</a></li>
<li><a href="/gostd/go/parser/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/go/parser/interface.go.html" class="current">interface.go</a></li>
<li><a href="/gostd/go/parser/parser.go.html">parser.go</a></li>
<li><a href="/gostd/go/parser/parser_test.go.html">parser_test.go</a></li>
<li><a href="/gostd/go/parser/performance_test.go.html">performance_test.go</a></li>
<li><a href="/gostd/go/parser/short_test.go.html">short_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5616787">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5616842">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5616896">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5616947">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;exported&nbsp;entry&nbsp;points&nbsp;for&nbsp;invoking&nbsp;the&nbsp;parser.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5617021">package</span>&nbsp;<span class="ident" id="5617029">parser</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5617037">import</span>&nbsp;<span class="op" id="5617044">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5617047">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5617056">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5617066">&#34;go/ast&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5617076">&#34;go/token&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5617088">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5617094">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5617107">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5617113">&#34;path/filepath&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5617130">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="5617140">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="5617143">//&nbsp;If&nbsp;src&nbsp;!=&nbsp;nil,&nbsp;readSource&nbsp;converts&nbsp;src&nbsp;to&nbsp;a&nbsp;[]byte&nbsp;if&nbsp;possible;</span><br>
<span class="lineno"></span><span class="comment" id="5617210">//&nbsp;otherwise&nbsp;it&nbsp;returns&nbsp;an&nbsp;error.&nbsp;If&nbsp;src&nbsp;==&nbsp;nil,&nbsp;readSource&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="5617278">//&nbsp;the&nbsp;result&nbsp;of&nbsp;reading&nbsp;the&nbsp;file&nbsp;specified&nbsp;by&nbsp;filename.</span><br>
<span class="lineno"></span><span class="comment" id="5617335">//</span><br>
<span class="lineno">25</span><span class="keyword" id="5617338">func</span>&nbsp;<span class="ident" id="5617343">readSource</span><span class="op" id="5617353">(</span><span class="ident" id="5617354">filename</span>&nbsp;<span class="builtintype" id="5617363">string</span><span class="op" id="5617369">,</span>&nbsp;<span class="ident" id="5617371">src</span>&nbsp;<span class="keyword" id="5617375">interface</span><span class="op" id="5617384">{</span><span class="op" id="5617385">}</span><span class="op" id="5617386">)</span>&nbsp;<span class="op" id="5617388">(</span><span class="op" id="5617389">[</span><span class="op" id="5617390">]</span><span class="builtintype" id="5617391">byte</span><span class="op" id="5617395">,</span>&nbsp;<span class="builtintype" id="5617397">error</span><span class="op" id="5617402">)</span>&nbsp;<span class="op" id="5617404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617407">if</span>&nbsp;<span class="ident" id="5617410">src</span>&nbsp;<span class="op" id="5617414">!=</span>&nbsp;<span class="ident" id="5617417">nil</span>&nbsp;<span class="op" id="5617421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617425">switch</span>&nbsp;<span class="ident" id="5617432">s</span>&nbsp;<span class="op" id="5617434">:=</span>&nbsp;<span class="ident" id="5617437">src</span><span class="op" id="5617440">.</span><span class="op" id="5617441">(</span><span class="keyword" id="5617442">type</span><span class="op" id="5617446">)</span>&nbsp;<span class="op" id="5617448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617452">case</span>&nbsp;<span class="builtintype" id="5617457">string</span><span class="op" id="5617463">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617468">return</span>&nbsp;<span class="op" id="5617475">[</span><span class="op" id="5617476">]</span><span class="builtintype" id="5617477">byte</span><span class="op" id="5617481">(</span><span class="ident" id="5617482">s</span><span class="op" id="5617483">)</span><span class="op" id="5617484">,</span>&nbsp;<span class="ident" id="5617486">nil</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617492">case</span>&nbsp;<span class="op" id="5617497">[</span><span class="op" id="5617498">]</span><span class="builtintype" id="5617499">byte</span><span class="op" id="5617503">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617508">return</span>&nbsp;<span class="ident" id="5617515">s</span><span class="op" id="5617516">,</span>&nbsp;<span class="ident" id="5617518">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617524">case</span>&nbsp;<span class="op" id="5617529">*</span><span class="ident" id="5617530">bytes</span><span class="op" id="5617535">.</span><span class="ident" id="5617536">Buffer</span><span class="op" id="5617542">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5617547">//&nbsp;is&nbsp;io.Reader,&nbsp;but&nbsp;src&nbsp;is&nbsp;already&nbsp;available&nbsp;in&nbsp;[]byte&nbsp;form</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617611">if</span>&nbsp;<span class="ident" id="5617614">s</span>&nbsp;<span class="op" id="5617616">!=</span>&nbsp;<span class="ident" id="5617619">nil</span>&nbsp;<span class="op" id="5617623">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617629">return</span>&nbsp;<span class="ident" id="5617636">s</span><span class="op" id="5617637">.</span><span class="ident" id="5617638">Bytes</span><span class="op" id="5617643">(</span><span class="op" id="5617644">)</span><span class="op" id="5617645">,</span>&nbsp;<span class="ident" id="5617647">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5617654">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617658">case</span>&nbsp;<span class="ident" id="5617663">io</span><span class="op" id="5617665">.</span><span class="ident" id="5617666">Reader</span><span class="op" id="5617672">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617677">var</span>&nbsp;<span class="ident" id="5617681">buf</span>&nbsp;<span class="ident" id="5617685">bytes</span><span class="op" id="5617690">.</span><span class="ident" id="5617691">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617701">if</span>&nbsp;<span class="ident" id="5617704">_</span><span class="op" id="5617705">,</span>&nbsp;<span class="ident" id="5617707">err</span>&nbsp;<span class="op" id="5617711">:=</span>&nbsp;<span class="ident" id="5617714">io</span><span class="op" id="5617716">.</span><span class="ident" id="5617717">Copy</span><span class="op" id="5617721">(</span><span class="op" id="5617722">&amp;</span><span class="ident" id="5617723">buf</span><span class="op" id="5617726">,</span>&nbsp;<span class="ident" id="5617728">s</span><span class="op" id="5617729">)</span><span class="op" id="5617730">;</span>&nbsp;<span class="ident" id="5617732">err</span>&nbsp;<span class="op" id="5617736">!=</span>&nbsp;<span class="ident" id="5617739">nil</span>&nbsp;<span class="op" id="5617743">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617749">return</span>&nbsp;<span class="ident" id="5617756">nil</span><span class="op" id="5617759">,</span>&nbsp;<span class="ident" id="5617761">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5617768">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617773">return</span>&nbsp;<span class="ident" id="5617780">buf</span><span class="op" id="5617783">.</span><span class="ident" id="5617784">Bytes</span><span class="op" id="5617789">(</span><span class="op" id="5617790">)</span><span class="op" id="5617791">,</span>&nbsp;<span class="ident" id="5617793">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5617799">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617803">return</span>&nbsp;<span class="ident" id="5617810">nil</span><span class="op" id="5617813">,</span>&nbsp;<span class="ident" id="5617815">errors</span><span class="op" id="5617821">.</span><span class="ident" id="5617822">New</span><span class="op" id="5617825">(</span><span class="string" id="5617826">&#34;invalid&nbsp;source&#34;</span><span class="op" id="5617842">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5617845">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617848">return</span>&nbsp;<span class="ident" id="5617855">ioutil</span><span class="op" id="5617861">.</span><span class="ident" id="5617862">ReadFile</span><span class="op" id="5617870">(</span><span class="ident" id="5617871">filename</span><span class="op" id="5617879">)</span><br>
<span class="lineno"></span><span class="op" id="5617881">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5617884">//&nbsp;A&nbsp;Mode&nbsp;value&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;flags&nbsp;(or&nbsp;0).</span><br>
<span class="lineno">50</span><span class="comment" id="5617926">//&nbsp;They&nbsp;control&nbsp;the&nbsp;amount&nbsp;of&nbsp;source&nbsp;code&nbsp;parsed&nbsp;and&nbsp;other&nbsp;optional</span><br>
<span class="lineno"></span><span class="comment" id="5617994">//&nbsp;parser&nbsp;functionality.</span><br>
<span class="lineno"></span><span class="comment" id="5618019">//</span><br>
<span class="lineno"></span><span class="keyword" id="5618022">type</span>&nbsp;<span class="ident" id="5618027">Mode</span>&nbsp;<span class="builtintype" id="5618032">uint</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="5618038">const</span>&nbsp;<span class="op" id="5618044">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5618047">PackageClauseOnly</span>&nbsp;<span class="ident" id="5618065">Mode</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5618082">=</span>&nbsp;<span class="num" id="5618084">1</span>&nbsp;<span class="op" id="5618086">&lt;&lt;</span>&nbsp;<span class="ident" id="5618089">iota</span>&nbsp;<span class="comment" id="5618094">//&nbsp;stop&nbsp;parsing&nbsp;after&nbsp;package&nbsp;clause</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5618132">ImportsOnly</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5618179">//&nbsp;stop&nbsp;parsing&nbsp;after&nbsp;import&nbsp;declarations</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5618222">ParseComments</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5618269">//&nbsp;parse&nbsp;comments&nbsp;and&nbsp;add&nbsp;them&nbsp;to&nbsp;AST</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5618308">Trace</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5618355">//&nbsp;print&nbsp;a&nbsp;trace&nbsp;of&nbsp;parsed&nbsp;productions</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5618395">DeclarationErrors</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5618442">//&nbsp;report&nbsp;declaration&nbsp;errors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5618472">SpuriousErrors</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5618519">//&nbsp;same&nbsp;as&nbsp;AllErrors,&nbsp;for&nbsp;backward-compatibility</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5618569">AllErrors</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5618587">=</span>&nbsp;<span class="ident" id="5618589">SpuriousErrors</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5618616">//&nbsp;report&nbsp;all&nbsp;errors&nbsp;(not&nbsp;just&nbsp;the&nbsp;first&nbsp;10&nbsp;on&nbsp;different&nbsp;lines)</span><br>
<span class="lineno"></span><span class="op" id="5618680">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="5618683">//&nbsp;ParseFile&nbsp;parses&nbsp;the&nbsp;source&nbsp;code&nbsp;of&nbsp;a&nbsp;single&nbsp;Go&nbsp;source&nbsp;file&nbsp;and&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="5618758">//&nbsp;the&nbsp;corresponding&nbsp;ast.File&nbsp;node.&nbsp;The&nbsp;source&nbsp;code&nbsp;may&nbsp;be&nbsp;provided&nbsp;via</span><br>
<span class="lineno"></span><span class="comment" id="5618830">//&nbsp;the&nbsp;filename&nbsp;of&nbsp;the&nbsp;source&nbsp;file,&nbsp;or&nbsp;via&nbsp;the&nbsp;src&nbsp;parameter.</span><br>
<span class="lineno"></span><span class="comment" id="5618892">//</span><br>
<span class="lineno"></span><span class="comment" id="5618895">//&nbsp;If&nbsp;src&nbsp;!=&nbsp;nil,&nbsp;ParseFile&nbsp;parses&nbsp;the&nbsp;source&nbsp;from&nbsp;src&nbsp;and&nbsp;the&nbsp;filename&nbsp;is</span><br>
<span class="lineno">70</span><span class="comment" id="5618970">//&nbsp;only&nbsp;used&nbsp;when&nbsp;recording&nbsp;position&nbsp;information.&nbsp;The&nbsp;type&nbsp;of&nbsp;the&nbsp;argument</span><br>
<span class="lineno"></span><span class="comment" id="5619045">//&nbsp;for&nbsp;the&nbsp;src&nbsp;parameter&nbsp;must&nbsp;be&nbsp;string,&nbsp;[]byte,&nbsp;or&nbsp;io.Reader.</span><br>
<span class="lineno"></span><span class="comment" id="5619108">//&nbsp;If&nbsp;src&nbsp;==&nbsp;nil,&nbsp;ParseFile&nbsp;parses&nbsp;the&nbsp;file&nbsp;specified&nbsp;by&nbsp;filename.</span><br>
<span class="lineno"></span><span class="comment" id="5619175">//</span><br>
<span class="lineno"></span><span class="comment" id="5619178">//&nbsp;The&nbsp;mode&nbsp;parameter&nbsp;controls&nbsp;the&nbsp;amount&nbsp;of&nbsp;source&nbsp;text&nbsp;parsed&nbsp;and&nbsp;other</span><br>
<span class="lineno">75</span><span class="comment" id="5619252">//&nbsp;optional&nbsp;parser&nbsp;functionality.&nbsp;Position&nbsp;information&nbsp;is&nbsp;recorded&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5619326">//&nbsp;file&nbsp;set&nbsp;fset.</span><br>
<span class="lineno"></span><span class="comment" id="5619344">//</span><br>
<span class="lineno"></span><span class="comment" id="5619347">//&nbsp;If&nbsp;the&nbsp;source&nbsp;couldn&#39;t&nbsp;be&nbsp;read,&nbsp;the&nbsp;returned&nbsp;AST&nbsp;is&nbsp;nil&nbsp;and&nbsp;the&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="5619420">//&nbsp;indicates&nbsp;the&nbsp;specific&nbsp;failure.&nbsp;If&nbsp;the&nbsp;source&nbsp;was&nbsp;read&nbsp;but&nbsp;syntax</span><br>
<span class="lineno">80</span><span class="comment" id="5619489">//&nbsp;errors&nbsp;were&nbsp;found,&nbsp;the&nbsp;result&nbsp;is&nbsp;a&nbsp;partial&nbsp;AST&nbsp;(with&nbsp;ast.Bad*&nbsp;nodes</span><br>
<span class="lineno"></span><span class="comment" id="5619560">//&nbsp;representing&nbsp;the&nbsp;fragments&nbsp;of&nbsp;erroneous&nbsp;source&nbsp;code).&nbsp;Multiple&nbsp;errors</span><br>
<span class="lineno"></span><span class="comment" id="5619633">//&nbsp;are&nbsp;returned&nbsp;via&nbsp;a&nbsp;scanner.ErrorList&nbsp;which&nbsp;is&nbsp;sorted&nbsp;by&nbsp;file&nbsp;position.</span><br>
<span class="lineno"></span><span class="comment" id="5619707">//</span><br>
<span class="lineno"></span><span class="keyword" id="5619710">func</span>&nbsp;<span class="ident" id="5619715">ParseFile</span><span class="op" id="5619724">(</span><span class="ident" id="5619725">fset</span>&nbsp;<span class="op" id="5619730">*</span><span class="ident" id="5619731">token</span><span class="op" id="5619736">.</span><span class="ident" id="5619737">FileSet</span><span class="op" id="5619744">,</span>&nbsp;<span class="ident" id="5619746">filename</span>&nbsp;<span class="builtintype" id="5619755">string</span><span class="op" id="5619761">,</span>&nbsp;<span class="ident" id="5619763">src</span>&nbsp;<span class="keyword" id="5619767">interface</span><span class="op" id="5619776">{</span><span class="op" id="5619777">}</span><span class="op" id="5619778">,</span>&nbsp;<span class="ident" id="5619780">mode</span>&nbsp;<span class="ident" id="5619785">Mode</span><span class="op" id="5619789">)</span>&nbsp;<span class="op" id="5619791">(</span><span class="ident" id="5619792">f</span>&nbsp;<span class="op" id="5619794">*</span><span class="ident" id="5619795">ast</span><span class="op" id="5619798">.</span><span class="ident" id="5619799">File</span><span class="op" id="5619803">,</span>&nbsp;<span class="ident" id="5619805">err</span>&nbsp;<span class="builtintype" id="5619809">error</span><span class="op" id="5619814">)</span>&nbsp;<span class="op" id="5619816">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5619819">//&nbsp;get&nbsp;source</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5619834">text</span><span class="op" id="5619838">,</span>&nbsp;<span class="ident" id="5619840">err</span>&nbsp;<span class="op" id="5619844">:=</span>&nbsp;<span class="ident" id="5619847">readSource</span><span class="op" id="5619857">(</span><span class="ident" id="5619858">filename</span><span class="op" id="5619866">,</span>&nbsp;<span class="ident" id="5619868">src</span><span class="op" id="5619871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5619874">if</span>&nbsp;<span class="ident" id="5619877">err</span>&nbsp;<span class="op" id="5619881">!=</span>&nbsp;<span class="ident" id="5619884">nil</span>&nbsp;<span class="op" id="5619888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5619892">return</span>&nbsp;<span class="ident" id="5619899">nil</span><span class="op" id="5619902">,</span>&nbsp;<span class="ident" id="5619904">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5619909">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5619913">var</span>&nbsp;<span class="ident" id="5619917">p</span>&nbsp;<span class="ident" id="5619919">parser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5619927">defer</span>&nbsp;<span class="keyword" id="5619933">func</span><span class="op" id="5619937">(</span><span class="op" id="5619938">)</span>&nbsp;<span class="op" id="5619940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5619944">if</span>&nbsp;<span class="ident" id="5619947">e</span>&nbsp;<span class="op" id="5619949">:=</span>&nbsp;<span class="builtinfunc" id="5619952">recover</span><span class="op" id="5619959">(</span><span class="op" id="5619960">)</span><span class="op" id="5619961">;</span>&nbsp;<span class="ident" id="5619963">e</span>&nbsp;<span class="op" id="5619965">!=</span>&nbsp;<span class="ident" id="5619968">nil</span>&nbsp;<span class="op" id="5619972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5619977">_</span>&nbsp;<span class="op" id="5619979">=</span>&nbsp;<span class="ident" id="5619981">e</span><span class="op" id="5619982">.</span><span class="op" id="5619983">(</span><span class="ident" id="5619984">bailout</span><span class="op" id="5619991">)</span>&nbsp;<span class="comment" id="5619993">//&nbsp;re-panics&nbsp;if&nbsp;it&#39;s&nbsp;not&nbsp;a&nbsp;bailout</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5620030">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5620035">//&nbsp;set&nbsp;result&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5620058">if</span>&nbsp;<span class="ident" id="5620061">f</span>&nbsp;<span class="op" id="5620063">==</span>&nbsp;<span class="ident" id="5620066">nil</span>&nbsp;<span class="op" id="5620070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5620075">//&nbsp;source&nbsp;is&nbsp;not&nbsp;a&nbsp;valid&nbsp;Go&nbsp;source&nbsp;file&nbsp;-&nbsp;satisfy</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5620128">//&nbsp;ParseFile&nbsp;API&nbsp;and&nbsp;return&nbsp;a&nbsp;valid&nbsp;(but)&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5620179">//&nbsp;*ast.File</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620195">f</span>&nbsp;<span class="op" id="5620197">=</span>&nbsp;<span class="op" id="5620199">&amp;</span><span class="ident" id="5620200">ast</span><span class="op" id="5620203">.</span><span class="ident" id="5620204">File</span><span class="op" id="5620208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620214">Name</span><span class="op" id="5620218">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="5620221">new</span><span class="op" id="5620224">(</span><span class="ident" id="5620225">ast</span><span class="op" id="5620228">.</span><span class="ident" id="5620229">Ident</span><span class="op" id="5620234">)</span><span class="op" id="5620235">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620241">Scope</span><span class="op" id="5620246">:</span>&nbsp;<span class="ident" id="5620248">ast</span><span class="op" id="5620251">.</span><span class="ident" id="5620252">NewScope</span><span class="op" id="5620260">(</span><span class="ident" id="5620261">nil</span><span class="op" id="5620264">)</span><span class="op" id="5620265">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5620270">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5620274">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620279">p</span><span class="op" id="5620280">.</span><span class="ident" id="5620281">errors</span><span class="op" id="5620287">.</span><span class="ident" id="5620288">Sort</span><span class="op" id="5620292">(</span><span class="op" id="5620293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620297">err</span>&nbsp;<span class="op" id="5620301">=</span>&nbsp;<span class="ident" id="5620303">p</span><span class="op" id="5620304">.</span><span class="ident" id="5620305">errors</span><span class="op" id="5620311">.</span><span class="ident" id="5620312">Err</span><span class="op" id="5620315">(</span><span class="op" id="5620316">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5620319">}</span><span class="op" id="5620320">(</span><span class="op" id="5620321">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5620325">//&nbsp;parse&nbsp;source</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620342">p</span><span class="op" id="5620343">.</span><span class="ident" id="5620344">init</span><span class="op" id="5620348">(</span><span class="ident" id="5620349">fset</span><span class="op" id="5620353">,</span>&nbsp;<span class="ident" id="5620355">filename</span><span class="op" id="5620363">,</span>&nbsp;<span class="ident" id="5620365">text</span><span class="op" id="5620369">,</span>&nbsp;<span class="ident" id="5620371">mode</span><span class="op" id="5620375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620378">f</span>&nbsp;<span class="op" id="5620380">=</span>&nbsp;<span class="ident" id="5620382">p</span><span class="op" id="5620383">.</span><span class="ident" id="5620384">parseFile</span><span class="op" id="5620393">(</span><span class="op" id="5620394">)</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5620398">return</span><br>
<span class="lineno"></span><span class="op" id="5620405">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5620408">//&nbsp;ParseDir&nbsp;calls&nbsp;ParseFile&nbsp;for&nbsp;all&nbsp;files&nbsp;with&nbsp;names&nbsp;ending&nbsp;in&nbsp;&#34;.go&#34;&nbsp;in&nbsp;the</span><br>
<span class="lineno">120</span><span class="comment" id="5620484">//&nbsp;directory&nbsp;specified&nbsp;by&nbsp;path&nbsp;and&nbsp;returns&nbsp;a&nbsp;map&nbsp;of&nbsp;package&nbsp;name&nbsp;-&gt;&nbsp;package</span><br>
<span class="lineno"></span><span class="comment" id="5620560">//&nbsp;AST&nbsp;with&nbsp;all&nbsp;the&nbsp;packages&nbsp;found.</span><br>
<span class="lineno"></span><span class="comment" id="5620596">//</span><br>
<span class="lineno"></span><span class="comment" id="5620599">//&nbsp;If&nbsp;filter&nbsp;!=&nbsp;nil,&nbsp;only&nbsp;the&nbsp;files&nbsp;with&nbsp;os.FileInfo&nbsp;entries&nbsp;passing&nbsp;through</span><br>
<span class="lineno"></span><span class="comment" id="5620676">//&nbsp;the&nbsp;filter&nbsp;(and&nbsp;ending&nbsp;in&nbsp;&#34;.go&#34;)&nbsp;are&nbsp;considered.&nbsp;The&nbsp;mode&nbsp;bits&nbsp;are&nbsp;passed</span><br>
<span class="lineno">125</span><span class="comment" id="5620753">//&nbsp;to&nbsp;ParseFile&nbsp;unchanged.&nbsp;Position&nbsp;information&nbsp;is&nbsp;recorded&nbsp;in&nbsp;fset.</span><br>
<span class="lineno"></span><span class="comment" id="5620822">//</span><br>
<span class="lineno"></span><span class="comment" id="5620825">//&nbsp;If&nbsp;the&nbsp;directory&nbsp;couldn&#39;t&nbsp;be&nbsp;read,&nbsp;a&nbsp;nil&nbsp;map&nbsp;and&nbsp;the&nbsp;respective&nbsp;error&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="5620902">//&nbsp;returned.&nbsp;If&nbsp;a&nbsp;parse&nbsp;error&nbsp;occurred,&nbsp;a&nbsp;non-nil&nbsp;but&nbsp;incomplete&nbsp;map&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5620979">//&nbsp;first&nbsp;error&nbsp;encountered&nbsp;are&nbsp;returned.</span><br>
<span class="lineno">130</span><span class="comment" id="5621020">//</span><br>
<span class="lineno"></span><span class="keyword" id="5621023">func</span>&nbsp;<span class="ident" id="5621028">ParseDir</span><span class="op" id="5621036">(</span><span class="ident" id="5621037">fset</span>&nbsp;<span class="op" id="5621042">*</span><span class="ident" id="5621043">token</span><span class="op" id="5621048">.</span><span class="ident" id="5621049">FileSet</span><span class="op" id="5621056">,</span>&nbsp;<span class="ident" id="5621058">path</span>&nbsp;<span class="builtintype" id="5621063">string</span><span class="op" id="5621069">,</span>&nbsp;<span class="ident" id="5621071">filter</span>&nbsp;<span class="keyword" id="5621078">func</span><span class="op" id="5621082">(</span><span class="ident" id="5621083">os</span><span class="op" id="5621085">.</span><span class="ident" id="5621086">FileInfo</span><span class="op" id="5621094">)</span>&nbsp;<span class="builtintype" id="5621096">bool</span><span class="op" id="5621100">,</span>&nbsp;<span class="ident" id="5621102">mode</span>&nbsp;<span class="ident" id="5621107">Mode</span><span class="op" id="5621111">)</span>&nbsp;<span class="op" id="5621113">(</span><span class="ident" id="5621114">pkgs</span>&nbsp;<span class="keyword" id="5621119">map</span><span class="op" id="5621122">[</span><span class="builtintype" id="5621123">string</span><span class="op" id="5621129">]</span><span class="op" id="5621130">*</span><span class="ident" id="5621131">ast</span><span class="op" id="5621134">.</span><span class="ident" id="5621135">Package</span><span class="op" id="5621142">,</span>&nbsp;<span class="ident" id="5621144">first</span>&nbsp;<span class="builtintype" id="5621150">error</span><span class="op" id="5621155">)</span>&nbsp;<span class="op" id="5621157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5621160">fd</span><span class="op" id="5621162">,</span>&nbsp;<span class="ident" id="5621164">err</span>&nbsp;<span class="op" id="5621168">:=</span>&nbsp;<span class="ident" id="5621171">os</span><span class="op" id="5621173">.</span><span class="ident" id="5621174">Open</span><span class="op" id="5621178">(</span><span class="ident" id="5621179">path</span><span class="op" id="5621183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5621186">if</span>&nbsp;<span class="ident" id="5621189">err</span>&nbsp;<span class="op" id="5621193">!=</span>&nbsp;<span class="ident" id="5621196">nil</span>&nbsp;<span class="op" id="5621200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5621204">return</span>&nbsp;<span class="ident" id="5621211">nil</span><span class="op" id="5621214">,</span>&nbsp;<span class="ident" id="5621216">err</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5621221">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5621224">defer</span>&nbsp;<span class="ident" id="5621230">fd</span><span class="op" id="5621232">.</span><span class="ident" id="5621233">Close</span><span class="op" id="5621238">(</span><span class="op" id="5621239">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5621243">list</span><span class="op" id="5621247">,</span>&nbsp;<span class="ident" id="5621249">err</span>&nbsp;<span class="op" id="5621253">:=</span>&nbsp;<span class="ident" id="5621256">fd</span><span class="op" id="5621258">.</span><span class="ident" id="5621259">Readdir</span><span class="op" id="5621266">(</span><span class="op" id="5621267">-</span><span class="num" id="5621268">1</span><span class="op" id="5621269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5621272">if</span>&nbsp;<span class="ident" id="5621275">err</span>&nbsp;<span class="op" id="5621279">!=</span>&nbsp;<span class="ident" id="5621282">nil</span>&nbsp;<span class="op" id="5621286">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5621290">return</span>&nbsp;<span class="ident" id="5621297">nil</span><span class="op" id="5621300">,</span>&nbsp;<span class="ident" id="5621302">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5621307">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5621311">pkgs</span>&nbsp;<span class="op" id="5621316">=</span>&nbsp;<span class="builtinfunc" id="5621318">make</span><span class="op" id="5621322">(</span><span class="keyword" id="5621323">map</span><span class="op" id="5621326">[</span><span class="builtintype" id="5621327">string</span><span class="op" id="5621333">]</span><span class="op" id="5621334">*</span><span class="ident" id="5621335">ast</span><span class="op" id="5621338">.</span><span class="ident" id="5621339">Package</span><span class="op" id="5621346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5621349">for</span>&nbsp;<span class="ident" id="5621353">_</span><span class="op" id="5621354">,</span>&nbsp;<span class="ident" id="5621356">d</span>&nbsp;<span class="op" id="5621358">:=</span>&nbsp;<span class="keyword" id="5621361">range</span>&nbsp;<span class="ident" id="5621367">list</span>&nbsp;<span class="op" id="5621372">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5621376">if</span>&nbsp;<span class="ident" id="5621379">strings</span><span class="op" id="5621386">.</span><span class="ident" id="5621387">HasSuffix</span><span class="op" id="5621396">(</span><span class="ident" id="5621397">d</span><span class="op" id="5621398">.</span><span class="ident" id="5621399">Name</span><span class="op" id="5621403">(</span><span class="op" id="5621404">)</span><span class="op" id="5621405">,</span>&nbsp;<span class="string" id="5621407">&#34;.go&#34;</span><span class="op" id="5621412">)</span>&nbsp;<span class="op" id="5621414">&amp;&amp;</span>&nbsp;<span class="op" id="5621417">(</span><span class="ident" id="5621418">filter</span>&nbsp;<span class="op" id="5621425">==</span>&nbsp;<span class="ident" id="5621428">nil</span>&nbsp;<span class="op" id="5621432">||</span>&nbsp;<span class="ident" id="5621435">filter</span><span class="op" id="5621441">(</span><span class="ident" id="5621442">d</span><span class="op" id="5621443">)</span><span class="op" id="5621444">)</span>&nbsp;<span class="op" id="5621446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5621451">filename</span>&nbsp;<span class="op" id="5621460">:=</span>&nbsp;<span class="ident" id="5621463">filepath</span><span class="op" id="5621471">.</span><span class="ident" id="5621472">Join</span><span class="op" id="5621476">(</span><span class="ident" id="5621477">path</span><span class="op" id="5621481">,</span>&nbsp;<span class="ident" id="5621483">d</span><span class="op" id="5621484">.</span><span class="ident" id="5621485">Name</span><span class="op" id="5621489">(</span><span class="op" id="5621490">)</span><span class="op" id="5621491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5621496">if</span>&nbsp;<span class="ident" id="5621499">src</span><span class="op" id="5621502">,</span>&nbsp;<span class="ident" id="5621504">err</span>&nbsp;<span class="op" id="5621508">:=</span>&nbsp;<span class="ident" id="5621511">ParseFile</span><span class="op" id="5621520">(</span><span class="ident" id="5621521">fset</span><span class="op" id="5621525">,</span>&nbsp;<span class="ident" id="5621527">filename</span><span class="op" id="5621535">,</span>&nbsp;<span class="ident" id="5621537">nil</span><span class="op" id="5621540">,</span>&nbsp;<span class="ident" id="5621542">mode</span><span class="op" id="5621546">)</span><span class="op" id="5621547">;</span>&nbsp;<span class="ident" id="5621549">err</span>&nbsp;<span class="op" id="5621553">==</span>&nbsp;<span class="ident" id="5621556">nil</span>&nbsp;<span class="op" id="5621560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5621566">name</span>&nbsp;<span class="op" id="5621571">:=</span>&nbsp;<span class="ident" id="5621574">src</span><span class="op" id="5621577">.</span><span class="ident" id="5621578">Name</span><span class="op" id="5621582">.</span><span class="ident" id="5621583">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5621592">pkg</span><span class="op" id="5621595">,</span>&nbsp;<span class="ident" id="5621597">found</span>&nbsp;<span class="op" id="5621603">:=</span>&nbsp;<span class="ident" id="5621606">pkgs</span><span class="op" id="5621610">[</span><span class="ident" id="5621611">name</span><span class="op" id="5621615">]</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5621621">if</span>&nbsp;<span class="op" id="5621624">!</span><span class="ident" id="5621625">found</span>&nbsp;<span class="op" id="5621631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5621638">pkg</span>&nbsp;<span class="op" id="5621642">=</span>&nbsp;<span class="op" id="5621644">&amp;</span><span class="ident" id="5621645">ast</span><span class="op" id="5621648">.</span><span class="ident" id="5621649">Package</span><span class="op" id="5621656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5621664">Name</span><span class="op" id="5621668">:</span>&nbsp;&nbsp;<span class="ident" id="5621671">name</span><span class="op" id="5621675">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5621683">Files</span><span class="op" id="5621688">:</span>&nbsp;<span class="builtinfunc" id="5621690">make</span><span class="op" id="5621694">(</span><span class="keyword" id="5621695">map</span><span class="op" id="5621698">[</span><span class="builtintype" id="5621699">string</span><span class="op" id="5621705">]</span><span class="op" id="5621706">*</span><span class="ident" id="5621707">ast</span><span class="op" id="5621710">.</span><span class="ident" id="5621711">File</span><span class="op" id="5621715">)</span><span class="op" id="5621716">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5621723">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5621730">pkgs</span><span class="op" id="5621734">[</span><span class="ident" id="5621735">name</span><span class="op" id="5621739">]</span>&nbsp;<span class="op" id="5621741">=</span>&nbsp;<span class="ident" id="5621743">pkg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5621751">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5621757">pkg</span><span class="op" id="5621760">.</span><span class="ident" id="5621761">Files</span><span class="op" id="5621766">[</span><span class="ident" id="5621767">filename</span><span class="op" id="5621775">]</span>&nbsp;<span class="op" id="5621777">=</span>&nbsp;<span class="ident" id="5621779">src</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5621786">}</span>&nbsp;<span class="keyword" id="5621788">else</span>&nbsp;<span class="keyword" id="5621793">if</span>&nbsp;<span class="ident" id="5621796">first</span>&nbsp;<span class="op" id="5621802">==</span>&nbsp;<span class="ident" id="5621805">nil</span>&nbsp;<span class="op" id="5621809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5621815">first</span>&nbsp;<span class="op" id="5621821">=</span>&nbsp;<span class="ident" id="5621823">err</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5621830">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5621834">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5621837">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5621841">return</span><br>
<span class="lineno">165</span><span class="op" id="5621848">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5621851">//&nbsp;ParseExpr&nbsp;is&nbsp;a&nbsp;convenience&nbsp;function&nbsp;for&nbsp;obtaining&nbsp;the&nbsp;AST&nbsp;of&nbsp;an&nbsp;expression&nbsp;x.</span><br>
<span class="lineno"></span><span class="comment" id="5621932">//&nbsp;The&nbsp;position&nbsp;information&nbsp;recorded&nbsp;in&nbsp;the&nbsp;AST&nbsp;is&nbsp;undefined.&nbsp;The&nbsp;filename&nbsp;used</span><br>
<span class="lineno"></span><span class="comment" id="5622012">//&nbsp;in&nbsp;error&nbsp;messages&nbsp;is&nbsp;the&nbsp;empty&nbsp;string.</span><br>
<span class="lineno">170</span><span class="comment" id="5622054">//</span><br>
<span class="lineno"></span><span class="keyword" id="5622057">func</span>&nbsp;<span class="ident" id="5622062">ParseExpr</span><span class="op" id="5622071">(</span><span class="ident" id="5622072">x</span>&nbsp;<span class="builtintype" id="5622074">string</span><span class="op" id="5622080">)</span>&nbsp;<span class="op" id="5622082">(</span><span class="ident" id="5622083">ast</span><span class="op" id="5622086">.</span><span class="ident" id="5622087">Expr</span><span class="op" id="5622091">,</span>&nbsp;<span class="builtintype" id="5622093">error</span><span class="op" id="5622098">)</span>&nbsp;<span class="op" id="5622100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5622103">var</span>&nbsp;<span class="ident" id="5622107">p</span>&nbsp;<span class="ident" id="5622109">parser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5622117">p</span><span class="op" id="5622118">.</span><span class="ident" id="5622119">init</span><span class="op" id="5622123">(</span><span class="ident" id="5622124">token</span><span class="op" id="5622129">.</span><span class="ident" id="5622130">NewFileSet</span><span class="op" id="5622140">(</span><span class="op" id="5622141">)</span><span class="op" id="5622142">,</span>&nbsp;<span class="string" id="5622144">&#34;&#34;</span><span class="op" id="5622146">,</span>&nbsp;<span class="op" id="5622148">[</span><span class="op" id="5622149">]</span><span class="builtintype" id="5622150">byte</span><span class="op" id="5622154">(</span><span class="ident" id="5622155">x</span><span class="op" id="5622156">)</span><span class="op" id="5622157">,</span>&nbsp;<span class="num" id="5622159">0</span><span class="op" id="5622160">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5622164">//&nbsp;Set&nbsp;up&nbsp;pkg-level&nbsp;scopes&nbsp;to&nbsp;avoid&nbsp;nil-pointer&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5622221">//&nbsp;This&nbsp;is&nbsp;not&nbsp;needed&nbsp;for&nbsp;a&nbsp;correct&nbsp;expression&nbsp;x&nbsp;as&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5622278">//&nbsp;parser&nbsp;will&nbsp;be&nbsp;ok&nbsp;with&nbsp;a&nbsp;nil&nbsp;topScope,&nbsp;but&nbsp;be&nbsp;cautious</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5622337">//&nbsp;in&nbsp;case&nbsp;of&nbsp;an&nbsp;erroneous&nbsp;x.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5622368">p</span><span class="op" id="5622369">.</span><span class="ident" id="5622370">openScope</span><span class="op" id="5622379">(</span><span class="op" id="5622380">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5622383">p</span><span class="op" id="5622384">.</span><span class="ident" id="5622385">pkgScope</span>&nbsp;<span class="op" id="5622394">=</span>&nbsp;<span class="ident" id="5622396">p</span><span class="op" id="5622397">.</span><span class="ident" id="5622398">topScope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5622408">e</span>&nbsp;<span class="op" id="5622410">:=</span>&nbsp;<span class="ident" id="5622413">p</span><span class="op" id="5622414">.</span><span class="ident" id="5622415">parseRhsOrType</span><span class="op" id="5622429">(</span><span class="op" id="5622430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5622433">p</span><span class="op" id="5622434">.</span><span class="ident" id="5622435">closeScope</span><span class="op" id="5622445">(</span><span class="op" id="5622446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5622449">assert</span><span class="op" id="5622455">(</span><span class="ident" id="5622456">p</span><span class="op" id="5622457">.</span><span class="ident" id="5622458">topScope</span>&nbsp;<span class="op" id="5622467">==</span>&nbsp;<span class="ident" id="5622470">nil</span><span class="op" id="5622473">,</span>&nbsp;<span class="string" id="5622475">&#34;unbalanced&nbsp;scopes&#34;</span><span class="op" id="5622494">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5622498">//&nbsp;If&nbsp;a&nbsp;semicolon&nbsp;was&nbsp;inserted,&nbsp;consume&nbsp;it;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5622543">//&nbsp;report&nbsp;an&nbsp;error&nbsp;if&nbsp;there&#39;s&nbsp;more&nbsp;tokens.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5622587">if</span>&nbsp;<span class="ident" id="5622590">p</span><span class="op" id="5622591">.</span><span class="ident" id="5622592">tok</span>&nbsp;<span class="op" id="5622596">==</span>&nbsp;<span class="ident" id="5622599">token</span><span class="op" id="5622604">.</span><span class="ident" id="5622605">SEMICOLON</span>&nbsp;<span class="op" id="5622615">&amp;&amp;</span>&nbsp;<span class="ident" id="5622618">p</span><span class="op" id="5622619">.</span><span class="ident" id="5622620">lit</span>&nbsp;<span class="op" id="5622624">==</span>&nbsp;<span class="string" id="5622627">&#34;\n&#34;</span>&nbsp;<span class="op" id="5622632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5622636">p</span><span class="op" id="5622637">.</span><span class="ident" id="5622638">next</span><span class="op" id="5622642">(</span><span class="op" id="5622643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5622646">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5622649">p</span><span class="op" id="5622650">.</span><span class="ident" id="5622651">expect</span><span class="op" id="5622657">(</span><span class="ident" id="5622658">token</span><span class="op" id="5622663">.</span><span class="ident" id="5622664">EOF</span><span class="op" id="5622667">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5622671">if</span>&nbsp;<span class="ident" id="5622674">p</span><span class="op" id="5622675">.</span><span class="ident" id="5622676">errors</span><span class="op" id="5622682">.</span><span class="ident" id="5622683">Len</span><span class="op" id="5622686">(</span><span class="op" id="5622687">)</span>&nbsp;<span class="op" id="5622689">&gt;</span>&nbsp;<span class="num" id="5622691">0</span>&nbsp;<span class="op" id="5622693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5622697">p</span><span class="op" id="5622698">.</span><span class="ident" id="5622699">errors</span><span class="op" id="5622705">.</span><span class="ident" id="5622706">Sort</span><span class="op" id="5622710">(</span><span class="op" id="5622711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5622715">return</span>&nbsp;<span class="ident" id="5622722">nil</span><span class="op" id="5622725">,</span>&nbsp;<span class="ident" id="5622727">p</span><span class="op" id="5622728">.</span><span class="ident" id="5622729">errors</span><span class="op" id="5622735">.</span><span class="ident" id="5622736">Err</span><span class="op" id="5622739">(</span><span class="op" id="5622740">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5622743">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5622747">return</span>&nbsp;<span class="ident" id="5622754">e</span><span class="op" id="5622755">,</span>&nbsp;<span class="ident" id="5622757">nil</span><br>
<span class="lineno"></span><span class="op" id="5622761">}</span>
</div>
</body>
</html>
