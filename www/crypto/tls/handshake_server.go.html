<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="4204104">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4204159">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4204213">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4204264">package</span>&nbsp;<span class="ident" id="4204272">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4204277">import</span>&nbsp;<span class="op" id="4204284">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4204287">&#34;crypto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4204297">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4204313">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4204327">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4204344">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4204359">&#34;encoding/asn1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4204376">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4204386">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4204393">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="4204398">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4204401">//&nbsp;serverHandshakeState&nbsp;contains&nbsp;details&nbsp;of&nbsp;a&nbsp;server&nbsp;handshake&nbsp;in&nbsp;progress.</span><br>
<span class="lineno">20</span><span class="comment" id="4204477">//&nbsp;It&#39;s&nbsp;discarded&nbsp;once&nbsp;the&nbsp;handshake&nbsp;has&nbsp;completed.</span><br>
<span class="lineno"></span><span class="keyword" id="4204529">type</span>&nbsp;<span class="ident" id="4204534">serverHandshakeState</span>&nbsp;<span class="keyword" id="4204555">struct</span>&nbsp;<span class="op" id="4204562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4204565">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4204581">*</span><span class="ident" id="4204582"><a href="/crypto/tls/conn.go.html#4127599">Conn</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4204588">clientHello</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4204604">*</span><span class="ident" id="4204605"><a href="/crypto/tls/handshake_messages.go.html#4173962">clientHelloMsg</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4204621">hello</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4204637">*</span><span class="ident" id="4204638"><a href="/crypto/tls/handshake_messages.go.html#4185078">serverHelloMsg</a></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4204654">suite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4204670">*</span><span class="ident" id="4204671"><a href="/crypto/tls/cipher_suites.go.html#4100373">cipherSuite</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4204684">ellipticOk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4204700">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4204706">ecdsaOk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4204722">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4204728">sessionState</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4204744">*</span><span class="ident" id="4204745"><a href="/crypto/tls/ticket.go.html#4245080">sessionState</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4204759">finishedHash</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4204775"><a href="/crypto/tls/prf.go.html#4241479">finishedHash</a></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4204789">masterSecret</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4204805">[</span><span class="op" id="4204806">]</span><span class="builtintype" id="4204807">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4204813">certsFromClient</span>&nbsp;<span class="op" id="4204829">[</span><span class="op" id="4204830">]</span><span class="op" id="4204831">[</span><span class="op" id="4204832">]</span><span class="builtintype" id="4204833">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4204839">cert</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4204855">*</span><span class="ident" id="4204856"><a href="/crypto/tls/common.go.html#4123683">Certificate</a></span><br>
<span class="lineno"></span><span class="op" id="4204868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="4204871">//&nbsp;serverHandshake&nbsp;performs&nbsp;a&nbsp;TLS&nbsp;handshake&nbsp;as&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="keyword" id="4204928">func</span>&nbsp;<span class="op" id="4204933">(</span><span class="ident" id="4204934">c</span>&nbsp;<span class="op" id="4204936">*</span><span class="ident" id="4204937"><a href="/crypto/tls/conn.go.html#4127599">Conn</a></span><span class="op" id="4204941">)</span>&nbsp;<span class="ident" id="4204943">serverHandshake</span><span class="op" id="4204958">(</span><span class="op" id="4204959">)</span>&nbsp;<span class="builtintype" id="4204961">error</span>&nbsp;<span class="op" id="4204967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4204970">config</span>&nbsp;<span class="op" id="4204977">:=</span>&nbsp;<span class="ident" id="4204980"><a href="/crypto/tls/handshake_server.go.html#4204934">c</a></span><span class="op" id="4204981">.</span><span class="ident" id="4204982">config</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4204991">//&nbsp;If&nbsp;this&nbsp;is&nbsp;the&nbsp;first&nbsp;server&nbsp;handshake,&nbsp;we&nbsp;generate&nbsp;a&nbsp;random&nbsp;key&nbsp;to</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4205062">//&nbsp;encrypt&nbsp;the&nbsp;tickets&nbsp;with.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4205092"><a href="/crypto/tls/handshake_server.go.html#4204970">config</a></span><span class="op" id="4205098">.</span><span class="ident" id="4205099">serverInitOnce</span><span class="op" id="4205113">.</span><span class="ident" id="4205114">Do</span><span class="op" id="4205116">(</span><span class="ident" id="4205117"><a href="/crypto/tls/handshake_server.go.html#4204970">config</a></span><span class="op" id="4205123">.</span><span class="ident" id="4205124">serverInit</span><span class="op" id="4205134">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4205138">hs</span>&nbsp;<span class="op" id="4205141">:=</span>&nbsp;<span class="ident" id="4205144"><a href="/crypto/tls/handshake_server.go.html#4204534">serverHandshakeState</a></span><span class="op" id="4205164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4205168">c</span><span class="op" id="4205169">:</span>&nbsp;<span class="ident" id="4205171"><a href="/crypto/tls/handshake_server.go.html#4204934">c</a></span><span class="op" id="4205172">,</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4205175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4205178">isResume</span><span class="op" id="4205186">,</span>&nbsp;<span class="ident" id="4205188">err</span>&nbsp;<span class="op" id="4205192">:=</span>&nbsp;<span class="ident" id="4205195"><a href="/crypto/tls/handshake_server.go.html#4205138">hs</a></span><span class="op" id="4205197">.</span><span class="ident" id="4205198">readClientHello</span><span class="op" id="4205213">(</span><span class="op" id="4205214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4205217">if</span>&nbsp;<span class="ident" id="4205220"><a href="/crypto/tls/handshake_server.go.html#4205188">err</a></span>&nbsp;<span class="op" id="4205224">!=</span>&nbsp;<span class="ident" id="4205227">nil</span>&nbsp;<span class="op" id="4205231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4205235">return</span>&nbsp;<span class="ident" id="4205242"><a href="/crypto/tls/handshake_server.go.html#4205188">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4205247">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4205251">//&nbsp;For&nbsp;an&nbsp;overview&nbsp;of&nbsp;TLS&nbsp;handshaking,&nbsp;see&nbsp;https://tools.ietf.org/html/rfc5246#section-7.3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4205343">if</span>&nbsp;<span class="ident" id="4205346"><a href="/crypto/tls/handshake_server.go.html#4205178">isResume</a></span>&nbsp;<span class="op" id="4205355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4205359">//&nbsp;The&nbsp;client&nbsp;has&nbsp;included&nbsp;a&nbsp;session&nbsp;ticket&nbsp;and&nbsp;so&nbsp;we&nbsp;do&nbsp;an&nbsp;abbreviated&nbsp;handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4205444">if</span>&nbsp;<span class="ident" id="4205447">err</span>&nbsp;<span class="op" id="4205451">:=</span>&nbsp;<span class="ident" id="4205454"><a href="/crypto/tls/handshake_server.go.html#4205138">hs</a></span><span class="op" id="4205456">.</span><span class="ident" id="4205457">doResumeHandshake</span><span class="op" id="4205474">(</span><span class="op" id="4205475">)</span><span class="op" id="4205476">;</span>&nbsp;<span class="ident" id="4205478"><a href="/crypto/tls/handshake_server.go.html#4205447">err</a></span>&nbsp;<span class="op" id="4205482">!=</span>&nbsp;<span class="ident" id="4205485">nil</span>&nbsp;<span class="op" id="4205489">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4205494">return</span>&nbsp;<span class="ident" id="4205501"><a href="/crypto/tls/handshake_server.go.html#4205447">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4205507">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4205511">if</span>&nbsp;<span class="ident" id="4205514">err</span>&nbsp;<span class="op" id="4205518">:=</span>&nbsp;<span class="ident" id="4205521"><a href="/crypto/tls/handshake_server.go.html#4205138">hs</a></span><span class="op" id="4205523">.</span><span class="ident" id="4205524">establishKeys</span><span class="op" id="4205537">(</span><span class="op" id="4205538">)</span><span class="op" id="4205539">;</span>&nbsp;<span class="ident" id="4205541"><a href="/crypto/tls/handshake_server.go.html#4205514">err</a></span>&nbsp;<span class="op" id="4205545">!=</span>&nbsp;<span class="ident" id="4205548">nil</span>&nbsp;<span class="op" id="4205552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4205557">return</span>&nbsp;<span class="ident" id="4205564"><a href="/crypto/tls/handshake_server.go.html#4205514">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4205570">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4205574">if</span>&nbsp;<span class="ident" id="4205577">err</span>&nbsp;<span class="op" id="4205581">:=</span>&nbsp;<span class="ident" id="4205584"><a href="/crypto/tls/handshake_server.go.html#4205138">hs</a></span><span class="op" id="4205586">.</span><span class="ident" id="4205587">sendFinished</span><span class="op" id="4205599">(</span><span class="ident" id="4205600"><a href="/crypto/tls/handshake_server.go.html#4204934">c</a></span><span class="op" id="4205601">.</span><span class="ident" id="4205602">firstFinished</span><span class="op" id="4205615">[</span><span class="op" id="4205616">:</span><span class="op" id="4205617">]</span><span class="op" id="4205618">)</span><span class="op" id="4205619">;</span>&nbsp;<span class="ident" id="4205621"><a href="/crypto/tls/handshake_server.go.html#4205577">err</a></span>&nbsp;<span class="op" id="4205625">!=</span>&nbsp;<span class="ident" id="4205628">nil</span>&nbsp;<span class="op" id="4205632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4205637">return</span>&nbsp;<span class="ident" id="4205644"><a href="/crypto/tls/handshake_server.go.html#4205577">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4205650">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4205654">if</span>&nbsp;<span class="ident" id="4205657">err</span>&nbsp;<span class="op" id="4205661">:=</span>&nbsp;<span class="ident" id="4205664"><a href="/crypto/tls/handshake_server.go.html#4205138">hs</a></span><span class="op" id="4205666">.</span><span class="ident" id="4205667">readFinished</span><span class="op" id="4205679">(</span><span class="ident" id="4205680">nil</span><span class="op" id="4205683">)</span><span class="op" id="4205684">;</span>&nbsp;<span class="ident" id="4205686"><a href="/crypto/tls/handshake_server.go.html#4205657">err</a></span>&nbsp;<span class="op" id="4205690">!=</span>&nbsp;<span class="ident" id="4205693">nil</span>&nbsp;<span class="op" id="4205697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4205702">return</span>&nbsp;<span class="ident" id="4205709"><a href="/crypto/tls/handshake_server.go.html#4205657">err</a></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4205715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4205719"><a href="/crypto/tls/handshake_server.go.html#4204934">c</a></span><span class="op" id="4205720">.</span><span class="ident" id="4205721">didResume</span>&nbsp;<span class="op" id="4205731">=</span>&nbsp;<span class="ident" id="4205733">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4205739">}</span>&nbsp;<span class="keyword" id="4205741">else</span>&nbsp;<span class="op" id="4205746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4205750">//&nbsp;The&nbsp;client&nbsp;didn&#39;t&nbsp;include&nbsp;a&nbsp;session&nbsp;ticket,&nbsp;or&nbsp;it&nbsp;wasn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4205812">//&nbsp;valid&nbsp;so&nbsp;we&nbsp;do&nbsp;a&nbsp;full&nbsp;handshake.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4205850">if</span>&nbsp;<span class="ident" id="4205853">err</span>&nbsp;<span class="op" id="4205857">:=</span>&nbsp;<span class="ident" id="4205860"><a href="/crypto/tls/handshake_server.go.html#4205138">hs</a></span><span class="op" id="4205862">.</span><span class="ident" id="4205863">doFullHandshake</span><span class="op" id="4205878">(</span><span class="op" id="4205879">)</span><span class="op" id="4205880">;</span>&nbsp;<span class="ident" id="4205882"><a href="/crypto/tls/handshake_server.go.html#4205853">err</a></span>&nbsp;<span class="op" id="4205886">!=</span>&nbsp;<span class="ident" id="4205889">nil</span>&nbsp;<span class="op" id="4205893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4205898">return</span>&nbsp;<span class="ident" id="4205905"><a href="/crypto/tls/handshake_server.go.html#4205853">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4205911">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4205915">if</span>&nbsp;<span class="ident" id="4205918">err</span>&nbsp;<span class="op" id="4205922">:=</span>&nbsp;<span class="ident" id="4205925"><a href="/crypto/tls/handshake_server.go.html#4205138">hs</a></span><span class="op" id="4205927">.</span><span class="ident" id="4205928">establishKeys</span><span class="op" id="4205941">(</span><span class="op" id="4205942">)</span><span class="op" id="4205943">;</span>&nbsp;<span class="ident" id="4205945"><a href="/crypto/tls/handshake_server.go.html#4205918">err</a></span>&nbsp;<span class="op" id="4205949">!=</span>&nbsp;<span class="ident" id="4205952">nil</span>&nbsp;<span class="op" id="4205956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4205961">return</span>&nbsp;<span class="ident" id="4205968"><a href="/crypto/tls/handshake_server.go.html#4205918">err</a></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4205974">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4205978">if</span>&nbsp;<span class="ident" id="4205981">err</span>&nbsp;<span class="op" id="4205985">:=</span>&nbsp;<span class="ident" id="4205988"><a href="/crypto/tls/handshake_server.go.html#4205138">hs</a></span><span class="op" id="4205990">.</span><span class="ident" id="4205991">readFinished</span><span class="op" id="4206003">(</span><span class="ident" id="4206004"><a href="/crypto/tls/handshake_server.go.html#4204934">c</a></span><span class="op" id="4206005">.</span><span class="ident" id="4206006">firstFinished</span><span class="op" id="4206019">[</span><span class="op" id="4206020">:</span><span class="op" id="4206021">]</span><span class="op" id="4206022">)</span><span class="op" id="4206023">;</span>&nbsp;<span class="ident" id="4206025"><a href="/crypto/tls/handshake_server.go.html#4205981">err</a></span>&nbsp;<span class="op" id="4206029">!=</span>&nbsp;<span class="ident" id="4206032">nil</span>&nbsp;<span class="op" id="4206036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4206041">return</span>&nbsp;<span class="ident" id="4206048"><a href="/crypto/tls/handshake_server.go.html#4205981">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4206054">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4206058">if</span>&nbsp;<span class="ident" id="4206061">err</span>&nbsp;<span class="op" id="4206065">:=</span>&nbsp;<span class="ident" id="4206068"><a href="/crypto/tls/handshake_server.go.html#4205138">hs</a></span><span class="op" id="4206070">.</span><span class="ident" id="4206071">sendSessionTicket</span><span class="op" id="4206088">(</span><span class="op" id="4206089">)</span><span class="op" id="4206090">;</span>&nbsp;<span class="ident" id="4206092"><a href="/crypto/tls/handshake_server.go.html#4206061">err</a></span>&nbsp;<span class="op" id="4206096">!=</span>&nbsp;<span class="ident" id="4206099">nil</span>&nbsp;<span class="op" id="4206103">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4206108">return</span>&nbsp;<span class="ident" id="4206115"><a href="/crypto/tls/handshake_server.go.html#4206061">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4206121">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4206125">if</span>&nbsp;<span class="ident" id="4206128">err</span>&nbsp;<span class="op" id="4206132">:=</span>&nbsp;<span class="ident" id="4206135"><a href="/crypto/tls/handshake_server.go.html#4205138">hs</a></span><span class="op" id="4206137">.</span><span class="ident" id="4206138">sendFinished</span><span class="op" id="4206150">(</span><span class="ident" id="4206151">nil</span><span class="op" id="4206154">)</span><span class="op" id="4206155">;</span>&nbsp;<span class="ident" id="4206157"><a href="/crypto/tls/handshake_server.go.html#4206128">err</a></span>&nbsp;<span class="op" id="4206161">!=</span>&nbsp;<span class="ident" id="4206164">nil</span>&nbsp;<span class="op" id="4206168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4206173">return</span>&nbsp;<span class="ident" id="4206180"><a href="/crypto/tls/handshake_server.go.html#4206128">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4206186">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4206189">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4206192"><a href="/crypto/tls/handshake_server.go.html#4204934">c</a></span><span class="op" id="4206193">.</span><span class="ident" id="4206194">handshakeComplete</span>&nbsp;<span class="op" id="4206212">=</span>&nbsp;<span class="ident" id="4206214">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4206221">return</span>&nbsp;<span class="ident" id="4206228">nil</span><br>
<span class="lineno"></span><span class="op" id="4206232">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="4206235">//&nbsp;readClientHello&nbsp;reads&nbsp;a&nbsp;ClientHello&nbsp;message&nbsp;from&nbsp;the&nbsp;client&nbsp;and&nbsp;decides</span><br>
<span class="lineno"></span><span class="comment" id="4206310">//&nbsp;whether&nbsp;we&nbsp;will&nbsp;perform&nbsp;session&nbsp;resumption.</span><br>
<span class="lineno"></span><span class="keyword" id="4206357">func</span>&nbsp;<span class="op" id="4206362">(</span><span class="ident" id="4206363">hs</span>&nbsp;<span class="op" id="4206366">*</span><span class="ident" id="4206367"><a href="/crypto/tls/handshake_server.go.html#4204534">serverHandshakeState</a></span><span class="op" id="4206387">)</span>&nbsp;<span class="ident" id="4206389">readClientHello</span><span class="op" id="4206404">(</span><span class="op" id="4206405">)</span>&nbsp;<span class="op" id="4206407">(</span><span class="ident" id="4206408">isResume</span>&nbsp;<span class="builtintype" id="4206417">bool</span><span class="op" id="4206421">,</span>&nbsp;<span class="ident" id="4206423">err</span>&nbsp;<span class="builtintype" id="4206427">error</span><span class="op" id="4206432">)</span>&nbsp;<span class="op" id="4206434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4206437">config</span>&nbsp;<span class="op" id="4206444">:=</span>&nbsp;<span class="ident" id="4206447"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4206449">.</span><span class="ident" id="4206450">c</span><span class="op" id="4206451">.</span><span class="ident" id="4206452">config</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4206460">c</span>&nbsp;<span class="op" id="4206462">:=</span>&nbsp;<span class="ident" id="4206465"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4206467">.</span><span class="ident" id="4206468">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4206472">msg</span><span class="op" id="4206475">,</span>&nbsp;<span class="ident" id="4206477"><a href="/crypto/tls/handshake_server.go.html#4206423">err</a></span>&nbsp;<span class="op" id="4206481">:=</span>&nbsp;<span class="ident" id="4206484"><a href="/crypto/tls/handshake_server.go.html#4206460">c</a></span><span class="op" id="4206485">.</span><span class="ident" id="4206486">readHandshake</span><span class="op" id="4206499">(</span><span class="op" id="4206500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4206503">if</span>&nbsp;<span class="ident" id="4206506"><a href="/crypto/tls/handshake_server.go.html#4206423">err</a></span>&nbsp;<span class="op" id="4206510">!=</span>&nbsp;<span class="ident" id="4206513">nil</span>&nbsp;<span class="op" id="4206517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4206521">return</span>&nbsp;<span class="ident" id="4206528">false</span><span class="op" id="4206533">,</span>&nbsp;<span class="ident" id="4206535"><a href="/crypto/tls/handshake_server.go.html#4206423">err</a></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4206540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4206543">var</span>&nbsp;<span class="ident" id="4206547">ok</span>&nbsp;<span class="builtintype" id="4206550">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4206556"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4206558">.</span><span class="ident" id="4206559">clientHello</span><span class="op" id="4206570">,</span>&nbsp;<span class="ident" id="4206572"><a href="/crypto/tls/handshake_server.go.html#4206547">ok</a></span>&nbsp;<span class="op" id="4206575">=</span>&nbsp;<span class="ident" id="4206577"><a href="/crypto/tls/handshake_server.go.html#4206472">msg</a></span><span class="op" id="4206580">.</span><span class="op" id="4206581">(</span><span class="op" id="4206582">*</span><span class="ident" id="4206583"><a href="/crypto/tls/handshake_messages.go.html#4173962">clientHelloMsg</a></span><span class="op" id="4206597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4206600">if</span>&nbsp;<span class="op" id="4206603">!</span><span class="ident" id="4206604"><a href="/crypto/tls/handshake_server.go.html#4206547">ok</a></span>&nbsp;<span class="op" id="4206607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4206611"><a href="/crypto/tls/handshake_server.go.html#4206460">c</a></span><span class="op" id="4206612">.</span><span class="ident" id="4206613">sendAlert</span><span class="op" id="4206622">(</span><span class="ident" id="4206623"><a href="/crypto/tls/alert.go.html#4095992">alertUnexpectedMessage</a></span><span class="op" id="4206645">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4206649">return</span>&nbsp;<span class="ident" id="4206656">false</span><span class="op" id="4206661">,</span>&nbsp;<span class="ident" id="4206663"><a href="/crypto/tls/common.go.html#4127007">unexpectedMessageError</a></span><span class="op" id="4206685">(</span><span class="ident" id="4206686"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4206688">.</span><span class="ident" id="4206689">clientHello</span><span class="op" id="4206700">,</span>&nbsp;<span class="ident" id="4206702"><a href="/crypto/tls/handshake_server.go.html#4206472">msg</a></span><span class="op" id="4206705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4206708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4206711"><a href="/crypto/tls/handshake_server.go.html#4206460">c</a></span><span class="op" id="4206712">.</span><span class="ident" id="4206713">vers</span><span class="op" id="4206717">,</span>&nbsp;<span class="ident" id="4206719"><a href="/crypto/tls/handshake_server.go.html#4206547">ok</a></span>&nbsp;<span class="op" id="4206722">=</span>&nbsp;<span class="ident" id="4206724"><a href="/crypto/tls/handshake_server.go.html#4206437">config</a></span><span class="op" id="4206730">.</span><span class="ident" id="4206731">mutualVersion</span><span class="op" id="4206744">(</span><span class="ident" id="4206745"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4206747">.</span><span class="ident" id="4206748">clientHello</span><span class="op" id="4206759">.</span><span class="ident" id="4206760">vers</span><span class="op" id="4206764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4206767">if</span>&nbsp;<span class="op" id="4206770">!</span><span class="ident" id="4206771"><a href="/crypto/tls/handshake_server.go.html#4206547">ok</a></span>&nbsp;<span class="op" id="4206774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4206778"><a href="/crypto/tls/handshake_server.go.html#4206460">c</a></span><span class="op" id="4206779">.</span><span class="ident" id="4206780">sendAlert</span><span class="op" id="4206789">(</span><span class="ident" id="4206790"><a href="/crypto/tls/alert.go.html#4096632">alertProtocolVersion</a></span><span class="op" id="4206810">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4206814">return</span>&nbsp;<span class="ident" id="4206821">false</span><span class="op" id="4206826">,</span>&nbsp;<span class="ident" id="4206828"><a href="/crypto/tls/handshake_server.go.html#4204386">fmt</a></span><span class="op" id="4206831">.</span><span class="ident" id="4206832">Errorf</span><span class="op" id="4206838">(</span><span class="string" id="4206839">&#34;tls:&nbsp;client&nbsp;offered&nbsp;an&nbsp;unsupported,&nbsp;maximum&nbsp;protocol&nbsp;version&nbsp;of&nbsp;%x&#34;</span><span class="op" id="4206907">,</span>&nbsp;<span class="ident" id="4206909"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4206911">.</span><span class="ident" id="4206912">clientHello</span><span class="op" id="4206923">.</span><span class="ident" id="4206924">vers</span><span class="op" id="4206928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4206931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4206934"><a href="/crypto/tls/handshake_server.go.html#4206460">c</a></span><span class="op" id="4206935">.</span><span class="ident" id="4206936">haveVers</span>&nbsp;<span class="op" id="4206945">=</span>&nbsp;<span class="ident" id="4206947">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4206954"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4206956">.</span><span class="ident" id="4206957">finishedHash</span>&nbsp;<span class="op" id="4206970">=</span>&nbsp;<span class="ident" id="4206972"><a href="/crypto/tls/prf.go.html#4241128">newFinishedHash</a></span><span class="op" id="4206987">(</span><span class="ident" id="4206988"><a href="/crypto/tls/handshake_server.go.html#4206460">c</a></span><span class="op" id="4206989">.</span><span class="ident" id="4206990">vers</span><span class="op" id="4206994">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4206997"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4206999">.</span><span class="ident" id="4207000">finishedHash</span><span class="op" id="4207012">.</span><span class="ident" id="4207013">Write</span><span class="op" id="4207018">(</span><span class="ident" id="4207019"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4207021">.</span><span class="ident" id="4207022">clientHello</span><span class="op" id="4207033">.</span><span class="ident" id="4207034">marshal</span><span class="op" id="4207041">(</span><span class="op" id="4207042">)</span><span class="op" id="4207043">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4207047"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4207049">.</span><span class="ident" id="4207050">hello</span>&nbsp;<span class="op" id="4207056">=</span>&nbsp;<span class="builtinfunc" id="4207058">new</span><span class="op" id="4207061">(</span><span class="ident" id="4207062"><a href="/crypto/tls/handshake_messages.go.html#4185078">serverHelloMsg</a></span><span class="op" id="4207076">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4207080">supportedCurve</span>&nbsp;<span class="op" id="4207095">:=</span>&nbsp;<span class="ident" id="4207098">false</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4207105">preferredCurves</span>&nbsp;<span class="op" id="4207121">:=</span>&nbsp;<span class="ident" id="4207124"><a href="/crypto/tls/handshake_server.go.html#4206437">config</a></span><span class="op" id="4207130">.</span><span class="ident" id="4207131">curvePreferences</span><span class="op" id="4207147">(</span><span class="op" id="4207148">)</span><br>
<span class="lineno"></span><span class="ident" id="4207150">Curves</span><span class="op" id="4207156">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4207159">for</span>&nbsp;<span class="ident" id="4207163">_</span><span class="op" id="4207164">,</span>&nbsp;<span class="ident" id="4207166">curve</span>&nbsp;<span class="op" id="4207172">:=</span>&nbsp;<span class="keyword" id="4207175">range</span>&nbsp;<span class="ident" id="4207181"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4207183">.</span><span class="ident" id="4207184">clientHello</span><span class="op" id="4207195">.</span><span class="ident" id="4207196">supportedCurves</span>&nbsp;<span class="op" id="4207212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4207216">for</span>&nbsp;<span class="ident" id="4207220">_</span><span class="op" id="4207221">,</span>&nbsp;<span class="ident" id="4207223">supported</span>&nbsp;<span class="op" id="4207233">:=</span>&nbsp;<span class="keyword" id="4207236">range</span>&nbsp;<span class="ident" id="4207242"><a href="/crypto/tls/handshake_server.go.html#4207105">preferredCurves</a></span>&nbsp;<span class="op" id="4207258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4207263">if</span>&nbsp;<span class="ident" id="4207266"><a href="/crypto/tls/handshake_server.go.html#4207223">supported</a></span>&nbsp;<span class="op" id="4207276">==</span>&nbsp;<span class="ident" id="4207279"><a href="/crypto/tls/handshake_server.go.html#4207166">curve</a></span>&nbsp;<span class="op" id="4207285">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4207291"><a href="/crypto/tls/handshake_server.go.html#4207080">supportedCurve</a></span>&nbsp;<span class="op" id="4207306">=</span>&nbsp;<span class="ident" id="4207308">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4207317">break</span>&nbsp;<span class="ident" id="4207323">Curves</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4207333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4207337">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4207340">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4207344">supportedPointFormat</span>&nbsp;<span class="op" id="4207365">:=</span>&nbsp;<span class="ident" id="4207368">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4207375">for</span>&nbsp;<span class="ident" id="4207379">_</span><span class="op" id="4207380">,</span>&nbsp;<span class="ident" id="4207382">pointFormat</span>&nbsp;<span class="op" id="4207394">:=</span>&nbsp;<span class="keyword" id="4207397">range</span>&nbsp;<span class="ident" id="4207403"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4207405">.</span><span class="ident" id="4207406">clientHello</span><span class="op" id="4207417">.</span><span class="ident" id="4207418">supportedPoints</span>&nbsp;<span class="op" id="4207434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4207438">if</span>&nbsp;<span class="ident" id="4207441"><a href="/crypto/tls/handshake_server.go.html#4207382">pointFormat</a></span>&nbsp;<span class="op" id="4207453">==</span>&nbsp;<span class="ident" id="4207456"><a href="/crypto/tls/common.go.html#4110267">pointFormatUncompressed</a></span>&nbsp;<span class="op" id="4207480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4207485"><a href="/crypto/tls/handshake_server.go.html#4207344">supportedPointFormat</a></span>&nbsp;<span class="op" id="4207506">=</span>&nbsp;<span class="ident" id="4207508">true</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4207516">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4207524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4207527">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4207530"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4207532">.</span><span class="ident" id="4207533">ellipticOk</span>&nbsp;<span class="op" id="4207544">=</span>&nbsp;<span class="ident" id="4207546"><a href="/crypto/tls/handshake_server.go.html#4207080">supportedCurve</a></span>&nbsp;<span class="op" id="4207561">&amp;&amp;</span>&nbsp;<span class="ident" id="4207564"><a href="/crypto/tls/handshake_server.go.html#4207344">supportedPointFormat</a></span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4207587">foundCompression</span>&nbsp;<span class="op" id="4207604">:=</span>&nbsp;<span class="ident" id="4207607">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4207614">//&nbsp;We&nbsp;only&nbsp;support&nbsp;null&nbsp;compression,&nbsp;so&nbsp;check&nbsp;that&nbsp;the&nbsp;client&nbsp;offered&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4207689">for</span>&nbsp;<span class="ident" id="4207693">_</span><span class="op" id="4207694">,</span>&nbsp;<span class="ident" id="4207696">compression</span>&nbsp;<span class="op" id="4207708">:=</span>&nbsp;<span class="keyword" id="4207711">range</span>&nbsp;<span class="ident" id="4207717"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4207719">.</span><span class="ident" id="4207720">clientHello</span><span class="op" id="4207731">.</span><span class="ident" id="4207732">compressionMethods</span>&nbsp;<span class="op" id="4207751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4207755">if</span>&nbsp;<span class="ident" id="4207758"><a href="/crypto/tls/handshake_server.go.html#4207696">compression</a></span>&nbsp;<span class="op" id="4207770">==</span>&nbsp;<span class="ident" id="4207773"><a href="/crypto/tls/common.go.html#4109324">compressionNone</a></span>&nbsp;<span class="op" id="4207789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4207794"><a href="/crypto/tls/handshake_server.go.html#4207587">foundCompression</a></span>&nbsp;<span class="op" id="4207811">=</span>&nbsp;<span class="ident" id="4207813">true</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4207821">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4207829">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4207832">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4207836">if</span>&nbsp;<span class="op" id="4207839">!</span><span class="ident" id="4207840"><a href="/crypto/tls/handshake_server.go.html#4207587">foundCompression</a></span>&nbsp;<span class="op" id="4207857">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4207861"><a href="/crypto/tls/handshake_server.go.html#4206460">c</a></span><span class="op" id="4207862">.</span><span class="ident" id="4207863">sendAlert</span><span class="op" id="4207872">(</span><span class="ident" id="4207873"><a href="/crypto/tls/alert.go.html#4096192">alertHandshakeFailure</a></span><span class="op" id="4207894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4207898">return</span>&nbsp;<span class="ident" id="4207905">false</span><span class="op" id="4207910">,</span>&nbsp;<span class="ident" id="4207912"><a href="/crypto/tls/handshake_server.go.html#4204376">errors</a></span><span class="op" id="4207918">.</span><span class="ident" id="4207919">New</span><span class="op" id="4207922">(</span><span class="string" id="4207923">&#34;tls:&nbsp;client&nbsp;does&nbsp;not&nbsp;support&nbsp;uncompressed&nbsp;connections&#34;</span><span class="op" id="4207978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4207981">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4207985"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4207987">.</span><span class="ident" id="4207988">hello</span><span class="op" id="4207993">.</span><span class="ident" id="4207994">vers</span>&nbsp;<span class="op" id="4207999">=</span>&nbsp;<span class="ident" id="4208001"><a href="/crypto/tls/handshake_server.go.html#4206460">c</a></span><span class="op" id="4208002">.</span><span class="ident" id="4208003">vers</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4208009"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4208011">.</span><span class="ident" id="4208012">hello</span><span class="op" id="4208017">.</span><span class="ident" id="4208018">random</span>&nbsp;<span class="op" id="4208025">=</span>&nbsp;<span class="builtinfunc" id="4208027">make</span><span class="op" id="4208031">(</span><span class="op" id="4208032">[</span><span class="op" id="4208033">]</span><span class="builtintype" id="4208034">byte</span><span class="op" id="4208038">,</span>&nbsp;<span class="num" id="4208040">32</span><span class="op" id="4208042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4208045">_</span><span class="op" id="4208046">,</span>&nbsp;<span class="ident" id="4208048"><a href="/crypto/tls/handshake_server.go.html#4206423">err</a></span>&nbsp;<span class="op" id="4208052">=</span>&nbsp;<span class="ident" id="4208054"><a href="/crypto/tls/handshake_server.go.html#4204393">io</a></span><span class="op" id="4208056">.</span><span class="ident" id="4208057">ReadFull</span><span class="op" id="4208065">(</span><span class="ident" id="4208066"><a href="/crypto/tls/handshake_server.go.html#4206437">config</a></span><span class="op" id="4208072">.</span><span class="ident" id="4208073">rand</span><span class="op" id="4208077">(</span><span class="op" id="4208078">)</span><span class="op" id="4208079">,</span>&nbsp;<span class="ident" id="4208081"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4208083">.</span><span class="ident" id="4208084">hello</span><span class="op" id="4208089">.</span><span class="ident" id="4208090">random</span><span class="op" id="4208096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4208099">if</span>&nbsp;<span class="ident" id="4208102"><a href="/crypto/tls/handshake_server.go.html#4206423">err</a></span>&nbsp;<span class="op" id="4208106">!=</span>&nbsp;<span class="ident" id="4208109">nil</span>&nbsp;<span class="op" id="4208113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4208117"><a href="/crypto/tls/handshake_server.go.html#4206460">c</a></span><span class="op" id="4208118">.</span><span class="ident" id="4208119">sendAlert</span><span class="op" id="4208128">(</span><span class="ident" id="4208129"><a href="/crypto/tls/alert.go.html#4096712">alertInternalError</a></span><span class="op" id="4208147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4208151">return</span>&nbsp;<span class="ident" id="4208158">false</span><span class="op" id="4208163">,</span>&nbsp;<span class="ident" id="4208165"><a href="/crypto/tls/handshake_server.go.html#4206423">err</a></span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4208170">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4208173"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4208175">.</span><span class="ident" id="4208176">hello</span><span class="op" id="4208181">.</span><span class="ident" id="4208182">secureRenegotiation</span>&nbsp;<span class="op" id="4208202">=</span>&nbsp;<span class="ident" id="4208204"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4208206">.</span><span class="ident" id="4208207">clientHello</span><span class="op" id="4208218">.</span><span class="ident" id="4208219">secureRenegotiation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4208240"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4208242">.</span><span class="ident" id="4208243">hello</span><span class="op" id="4208248">.</span><span class="ident" id="4208249">compressionMethod</span>&nbsp;<span class="op" id="4208267">=</span>&nbsp;<span class="ident" id="4208269"><a href="/crypto/tls/common.go.html#4109324">compressionNone</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4208286">if</span>&nbsp;<span class="builtinfunc" id="4208289">len</span><span class="op" id="4208292">(</span><span class="ident" id="4208293"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4208295">.</span><span class="ident" id="4208296">clientHello</span><span class="op" id="4208307">.</span><span class="ident" id="4208308">serverName</span><span class="op" id="4208318">)</span>&nbsp;<span class="op" id="4208320">&gt;</span>&nbsp;<span class="num" id="4208322">0</span>&nbsp;<span class="op" id="4208324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4208328"><a href="/crypto/tls/handshake_server.go.html#4206460">c</a></span><span class="op" id="4208329">.</span><span class="ident" id="4208330">serverName</span>&nbsp;<span class="op" id="4208341">=</span>&nbsp;<span class="ident" id="4208343"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4208345">.</span><span class="ident" id="4208346">clientHello</span><span class="op" id="4208357">.</span><span class="ident" id="4208358">serverName</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4208370">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4208374">if</span>&nbsp;<span class="builtinfunc" id="4208377">len</span><span class="op" id="4208380">(</span><span class="ident" id="4208381"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4208383">.</span><span class="ident" id="4208384">clientHello</span><span class="op" id="4208395">.</span><span class="ident" id="4208396">alpnProtocols</span><span class="op" id="4208409">)</span>&nbsp;<span class="op" id="4208411">&gt;</span>&nbsp;<span class="num" id="4208413">0</span>&nbsp;<span class="op" id="4208415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4208419">if</span>&nbsp;<span class="ident" id="4208422">selectedProto</span><span class="op" id="4208435">,</span>&nbsp;<span class="ident" id="4208437">fallback</span>&nbsp;<span class="op" id="4208446">:=</span>&nbsp;<span class="ident" id="4208449"><a href="/crypto/tls/handshake_client.go.html#4173559">mutualProtocol</a></span><span class="op" id="4208463">(</span><span class="ident" id="4208464"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4208466">.</span><span class="ident" id="4208467">clientHello</span><span class="op" id="4208478">.</span><span class="ident" id="4208479">alpnProtocols</span><span class="op" id="4208492">,</span>&nbsp;<span class="ident" id="4208494"><a href="/crypto/tls/handshake_server.go.html#4206460">c</a></span><span class="op" id="4208495">.</span><span class="ident" id="4208496">config</span><span class="op" id="4208502">.</span><span class="ident" id="4208503">NextProtos</span><span class="op" id="4208513">)</span><span class="op" id="4208514">;</span>&nbsp;<span class="op" id="4208516">!</span><span class="ident" id="4208517"><a href="/crypto/tls/handshake_server.go.html#4208437">fallback</a></span>&nbsp;<span class="op" id="4208526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4208531"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4208533">.</span><span class="ident" id="4208534">hello</span><span class="op" id="4208539">.</span><span class="ident" id="4208540">alpnProtocol</span>&nbsp;<span class="op" id="4208553">=</span>&nbsp;<span class="ident" id="4208555"><a href="/crypto/tls/handshake_server.go.html#4208422">selectedProto</a></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4208572"><a href="/crypto/tls/handshake_server.go.html#4206460">c</a></span><span class="op" id="4208573">.</span><span class="ident" id="4208574">clientProtocol</span>&nbsp;<span class="op" id="4208589">=</span>&nbsp;<span class="ident" id="4208591"><a href="/crypto/tls/handshake_server.go.html#4208422">selectedProto</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4208607">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4208610">}</span>&nbsp;<span class="keyword" id="4208612">else</span>&nbsp;<span class="op" id="4208617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4208621">//&nbsp;Although&nbsp;sending&nbsp;an&nbsp;empty&nbsp;NPN&nbsp;extension&nbsp;is&nbsp;reasonable,&nbsp;Firefox&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4208693">//&nbsp;had&nbsp;a&nbsp;bug&nbsp;around&nbsp;this.&nbsp;Best&nbsp;to&nbsp;send&nbsp;nothing&nbsp;at&nbsp;all&nbsp;if</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4208752">//&nbsp;config.NextProtos&nbsp;is&nbsp;empty.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4208789">//&nbsp;https://code.google.com/p/go/issues/detail?id=5445.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4208846">if</span>&nbsp;<span class="ident" id="4208849"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4208851">.</span><span class="ident" id="4208852">clientHello</span><span class="op" id="4208863">.</span><span class="ident" id="4208864">nextProtoNeg</span>&nbsp;<span class="op" id="4208877">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4208880">len</span><span class="op" id="4208883">(</span><span class="ident" id="4208884"><a href="/crypto/tls/handshake_server.go.html#4206437">config</a></span><span class="op" id="4208890">.</span><span class="ident" id="4208891">NextProtos</span><span class="op" id="4208901">)</span>&nbsp;<span class="op" id="4208903">&gt;</span>&nbsp;<span class="num" id="4208905">0</span>&nbsp;<span class="op" id="4208907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4208912"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4208914">.</span><span class="ident" id="4208915">hello</span><span class="op" id="4208920">.</span><span class="ident" id="4208921">nextProtoNeg</span>&nbsp;<span class="op" id="4208934">=</span>&nbsp;<span class="ident" id="4208936">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4208944"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4208946">.</span><span class="ident" id="4208947">hello</span><span class="op" id="4208952">.</span><span class="ident" id="4208953">nextProtos</span>&nbsp;<span class="op" id="4208964">=</span>&nbsp;<span class="ident" id="4208966"><a href="/crypto/tls/handshake_server.go.html#4206437">config</a></span><span class="op" id="4208972">.</span><span class="ident" id="4208973">NextProtos</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4208986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4208989">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4208993">if</span>&nbsp;<span class="builtinfunc" id="4208996">len</span><span class="op" id="4208999">(</span><span class="ident" id="4209000"><a href="/crypto/tls/handshake_server.go.html#4206437">config</a></span><span class="op" id="4209006">.</span><span class="ident" id="4209007">Certificates</span><span class="op" id="4209019">)</span>&nbsp;<span class="op" id="4209021">==</span>&nbsp;<span class="num" id="4209024">0</span>&nbsp;<span class="op" id="4209026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4209030"><a href="/crypto/tls/handshake_server.go.html#4206460">c</a></span><span class="op" id="4209031">.</span><span class="ident" id="4209032">sendAlert</span><span class="op" id="4209041">(</span><span class="ident" id="4209042"><a href="/crypto/tls/alert.go.html#4096712">alertInternalError</a></span><span class="op" id="4209060">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4209064">return</span>&nbsp;<span class="ident" id="4209071">false</span><span class="op" id="4209076">,</span>&nbsp;<span class="ident" id="4209078"><a href="/crypto/tls/handshake_server.go.html#4204376">errors</a></span><span class="op" id="4209084">.</span><span class="ident" id="4209085">New</span><span class="op" id="4209088">(</span><span class="string" id="4209089">&#34;tls:&nbsp;no&nbsp;certificates&nbsp;configured&#34;</span><span class="op" id="4209122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4209125">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4209128"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4209130">.</span><span class="ident" id="4209131">cert</span>&nbsp;<span class="op" id="4209136">=</span>&nbsp;<span class="op" id="4209138">&amp;</span><span class="ident" id="4209139"><a href="/crypto/tls/handshake_server.go.html#4206437">config</a></span><span class="op" id="4209145">.</span><span class="ident" id="4209146">Certificates</span><span class="op" id="4209158">[</span><span class="num" id="4209159">0</span><span class="op" id="4209160">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4209163">if</span>&nbsp;<span class="builtinfunc" id="4209166">len</span><span class="op" id="4209169">(</span><span class="ident" id="4209170"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4209172">.</span><span class="ident" id="4209173">clientHello</span><span class="op" id="4209184">.</span><span class="ident" id="4209185">serverName</span><span class="op" id="4209195">)</span>&nbsp;<span class="op" id="4209197">&gt;</span>&nbsp;<span class="num" id="4209199">0</span>&nbsp;<span class="op" id="4209201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4209205">chi</span>&nbsp;<span class="op" id="4209209">:=</span>&nbsp;<span class="op" id="4209212">&amp;</span><span class="ident" id="4209213"><a href="/crypto/tls/common.go.html#4115067">ClientHelloInfo</a></span><span class="op" id="4209228">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4209233">CipherSuites</span><span class="op" id="4209245">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4209250"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4209252">.</span><span class="ident" id="4209253">clientHello</span><span class="op" id="4209264">.</span><span class="ident" id="4209265">cipherSuites</span><span class="op" id="4209277">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4209282">ServerName</span><span class="op" id="4209292">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4209299"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4209301">.</span><span class="ident" id="4209302">clientHello</span><span class="op" id="4209313">.</span><span class="ident" id="4209314">serverName</span><span class="op" id="4209324">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4209329">SupportedCurves</span><span class="op" id="4209344">:</span>&nbsp;<span class="ident" id="4209346"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4209348">.</span><span class="ident" id="4209349">clientHello</span><span class="op" id="4209360">.</span><span class="ident" id="4209361">supportedCurves</span><span class="op" id="4209376">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4209381">SupportedPoints</span><span class="op" id="4209396">:</span>&nbsp;<span class="ident" id="4209398"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4209400">.</span><span class="ident" id="4209401">clientHello</span><span class="op" id="4209412">.</span><span class="ident" id="4209413">supportedPoints</span><span class="op" id="4209428">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4209432">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4209436">if</span>&nbsp;<span class="ident" id="4209439"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4209441">.</span><span class="ident" id="4209442">cert</span><span class="op" id="4209446">,</span>&nbsp;<span class="ident" id="4209448"><a href="/crypto/tls/handshake_server.go.html#4206423">err</a></span>&nbsp;<span class="op" id="4209452">=</span>&nbsp;<span class="ident" id="4209454"><a href="/crypto/tls/handshake_server.go.html#4206437">config</a></span><span class="op" id="4209460">.</span><span class="ident" id="4209461">getCertificate</span><span class="op" id="4209475">(</span><span class="ident" id="4209476"><a href="/crypto/tls/handshake_server.go.html#4209205">chi</a></span><span class="op" id="4209479">)</span><span class="op" id="4209480">;</span>&nbsp;<span class="ident" id="4209482"><a href="/crypto/tls/handshake_server.go.html#4206423">err</a></span>&nbsp;<span class="op" id="4209486">!=</span>&nbsp;<span class="ident" id="4209489">nil</span>&nbsp;<span class="op" id="4209493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4209498"><a href="/crypto/tls/handshake_server.go.html#4206460">c</a></span><span class="op" id="4209499">.</span><span class="ident" id="4209500">sendAlert</span><span class="op" id="4209509">(</span><span class="ident" id="4209510"><a href="/crypto/tls/alert.go.html#4096712">alertInternalError</a></span><span class="op" id="4209528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4209533">return</span>&nbsp;<span class="ident" id="4209540">false</span><span class="op" id="4209545">,</span>&nbsp;<span class="ident" id="4209547"><a href="/crypto/tls/handshake_server.go.html#4206423">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4209553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4209556">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4209560">_</span><span class="op" id="4209561">,</span>&nbsp;<span class="ident" id="4209563"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4209565">.</span><span class="ident" id="4209566">ecdsaOk</span>&nbsp;<span class="op" id="4209574">=</span>&nbsp;<span class="ident" id="4209576"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4209578">.</span><span class="ident" id="4209579">cert</span><span class="op" id="4209583">.</span><span class="ident" id="4209584">PrivateKey</span><span class="op" id="4209594">.</span><span class="op" id="4209595">(</span><span class="op" id="4209596">*</span><span class="ident" id="4209597"><a href="/crypto/tls/handshake_server.go.html#4204297">ecdsa</a></span><span class="op" id="4209602">.</span><span class="ident" id="4209603">PrivateKey</span><span class="op" id="4209613">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4209617">if</span>&nbsp;<span class="ident" id="4209620"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4209622">.</span><span class="ident" id="4209623">checkForResumption</span><span class="op" id="4209641">(</span><span class="op" id="4209642">)</span>&nbsp;<span class="op" id="4209644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4209648">return</span>&nbsp;<span class="ident" id="4209655">true</span><span class="op" id="4209659">,</span>&nbsp;<span class="ident" id="4209661">nil</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4209666">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4209670">var</span>&nbsp;<span class="ident" id="4209674">preferenceList</span><span class="op" id="4209688">,</span>&nbsp;<span class="ident" id="4209690">supportedList</span>&nbsp;<span class="op" id="4209704">[</span><span class="op" id="4209705">]</span><span class="builtintype" id="4209706">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4209714">if</span>&nbsp;<span class="ident" id="4209717"><a href="/crypto/tls/handshake_server.go.html#4206460">c</a></span><span class="op" id="4209718">.</span><span class="ident" id="4209719">config</span><span class="op" id="4209725">.</span><span class="ident" id="4209726">PreferServerCipherSuites</span>&nbsp;<span class="op" id="4209751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4209755"><a href="/crypto/tls/handshake_server.go.html#4209674">preferenceList</a></span>&nbsp;<span class="op" id="4209770">=</span>&nbsp;<span class="ident" id="4209772"><a href="/crypto/tls/handshake_server.go.html#4206460">c</a></span><span class="op" id="4209773">.</span><span class="ident" id="4209774">config</span><span class="op" id="4209780">.</span><span class="ident" id="4209781">cipherSuites</span><span class="op" id="4209793">(</span><span class="op" id="4209794">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4209798"><a href="/crypto/tls/handshake_server.go.html#4209690">supportedList</a></span>&nbsp;<span class="op" id="4209812">=</span>&nbsp;<span class="ident" id="4209814"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4209816">.</span><span class="ident" id="4209817">clientHello</span><span class="op" id="4209828">.</span><span class="ident" id="4209829">cipherSuites</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4209843">}</span>&nbsp;<span class="keyword" id="4209845">else</span>&nbsp;<span class="op" id="4209850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4209854"><a href="/crypto/tls/handshake_server.go.html#4209674">preferenceList</a></span>&nbsp;<span class="op" id="4209869">=</span>&nbsp;<span class="ident" id="4209871"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4209873">.</span><span class="ident" id="4209874">clientHello</span><span class="op" id="4209885">.</span><span class="ident" id="4209886">cipherSuites</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4209901"><a href="/crypto/tls/handshake_server.go.html#4209690">supportedList</a></span>&nbsp;<span class="op" id="4209915">=</span>&nbsp;<span class="ident" id="4209917"><a href="/crypto/tls/handshake_server.go.html#4206460">c</a></span><span class="op" id="4209918">.</span><span class="ident" id="4209919">config</span><span class="op" id="4209925">.</span><span class="ident" id="4209926">cipherSuites</span><span class="op" id="4209938">(</span><span class="op" id="4209939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4209942">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4209946">for</span>&nbsp;<span class="ident" id="4209950">_</span><span class="op" id="4209951">,</span>&nbsp;<span class="ident" id="4209953">id</span>&nbsp;<span class="op" id="4209956">:=</span>&nbsp;<span class="keyword" id="4209959">range</span>&nbsp;<span class="ident" id="4209965"><a href="/crypto/tls/handshake_server.go.html#4209674">preferenceList</a></span>&nbsp;<span class="op" id="4209980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4209984">if</span>&nbsp;<span class="ident" id="4209987"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4209989">.</span><span class="ident" id="4209990">suite</span>&nbsp;<span class="op" id="4209996">=</span>&nbsp;<span class="ident" id="4209998"><a href="/crypto/tls/handshake_server.go.html#4206460">c</a></span><span class="op" id="4209999">.</span><span class="ident" id="4210000">tryCipherSuite</span><span class="op" id="4210014">(</span><span class="ident" id="4210015"><a href="/crypto/tls/handshake_server.go.html#4209953">id</a></span><span class="op" id="4210017">,</span>&nbsp;<span class="ident" id="4210019"><a href="/crypto/tls/handshake_server.go.html#4209690">supportedList</a></span><span class="op" id="4210032">,</span>&nbsp;<span class="ident" id="4210034"><a href="/crypto/tls/handshake_server.go.html#4206460">c</a></span><span class="op" id="4210035">.</span><span class="ident" id="4210036">vers</span><span class="op" id="4210040">,</span>&nbsp;<span class="ident" id="4210042"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4210044">.</span><span class="ident" id="4210045">ellipticOk</span><span class="op" id="4210055">,</span>&nbsp;<span class="ident" id="4210057"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4210059">.</span><span class="ident" id="4210060">ecdsaOk</span><span class="op" id="4210067">)</span><span class="op" id="4210068">;</span>&nbsp;<span class="ident" id="4210070"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4210072">.</span><span class="ident" id="4210073">suite</span>&nbsp;<span class="op" id="4210079">!=</span>&nbsp;<span class="ident" id="4210082">nil</span>&nbsp;<span class="op" id="4210086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4210091">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4210099">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4210102">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4210106">if</span>&nbsp;<span class="ident" id="4210109"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4210111">.</span><span class="ident" id="4210112">suite</span>&nbsp;<span class="op" id="4210118">==</span>&nbsp;<span class="ident" id="4210121">nil</span>&nbsp;<span class="op" id="4210125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4210129"><a href="/crypto/tls/handshake_server.go.html#4206460">c</a></span><span class="op" id="4210130">.</span><span class="ident" id="4210131">sendAlert</span><span class="op" id="4210140">(</span><span class="ident" id="4210141"><a href="/crypto/tls/alert.go.html#4096192">alertHandshakeFailure</a></span><span class="op" id="4210162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4210166">return</span>&nbsp;<span class="ident" id="4210173">false</span><span class="op" id="4210178">,</span>&nbsp;<span class="ident" id="4210180"><a href="/crypto/tls/handshake_server.go.html#4204376">errors</a></span><span class="op" id="4210186">.</span><span class="ident" id="4210187">New</span><span class="op" id="4210190">(</span><span class="string" id="4210191">&#34;tls:&nbsp;no&nbsp;cipher&nbsp;suite&nbsp;supported&nbsp;by&nbsp;both&nbsp;client&nbsp;and&nbsp;server&#34;</span><span class="op" id="4210249">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4210252">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4210256">//&nbsp;See&nbsp;https://tools.ietf.org/html/draft-ietf-tls-downgrade-scsv-00.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4210326">for</span>&nbsp;<span class="ident" id="4210330">_</span><span class="op" id="4210331">,</span>&nbsp;<span class="ident" id="4210333">id</span>&nbsp;<span class="op" id="4210336">:=</span>&nbsp;<span class="keyword" id="4210339">range</span>&nbsp;<span class="ident" id="4210345"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4210347">.</span><span class="ident" id="4210348">clientHello</span><span class="op" id="4210359">.</span><span class="ident" id="4210360">cipherSuites</span>&nbsp;<span class="op" id="4210373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4210377">if</span>&nbsp;<span class="ident" id="4210380"><a href="/crypto/tls/handshake_server.go.html#4210333">id</a></span>&nbsp;<span class="op" id="4210383">==</span>&nbsp;<span class="ident" id="4210386"><a href="/crypto/tls/cipher_suites.go.html#4107795">TLS_FALLBACK_SCSV</a></span>&nbsp;<span class="op" id="4210404">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4210409">//&nbsp;The&nbsp;client&nbsp;is&nbsp;doing&nbsp;a&nbsp;fallback&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4210458">if</span>&nbsp;<span class="ident" id="4210461"><a href="/crypto/tls/handshake_server.go.html#4206363">hs</a></span><span class="op" id="4210463">.</span><span class="ident" id="4210464">clientHello</span><span class="op" id="4210475">.</span><span class="ident" id="4210476">vers</span>&nbsp;<span class="op" id="4210481">&lt;</span>&nbsp;<span class="ident" id="4210483"><a href="/crypto/tls/handshake_server.go.html#4206460">c</a></span><span class="op" id="4210484">.</span><span class="ident" id="4210485">config</span><span class="op" id="4210491">.</span><span class="ident" id="4210492">MaxVersion</span>&nbsp;<span class="op" id="4210503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4210509"><a href="/crypto/tls/handshake_server.go.html#4206460">c</a></span><span class="op" id="4210510">.</span><span class="ident" id="4210511">sendAlert</span><span class="op" id="4210520">(</span><span class="ident" id="4210521"><a href="/crypto/tls/alert.go.html#4096752">alertInappropriateFallback</a></span><span class="op" id="4210547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4210553">return</span>&nbsp;<span class="ident" id="4210560">false</span><span class="op" id="4210565">,</span>&nbsp;<span class="ident" id="4210567"><a href="/crypto/tls/handshake_server.go.html#4204376">errors</a></span><span class="op" id="4210573">.</span><span class="ident" id="4210574">New</span><span class="op" id="4210577">(</span><span class="string" id="4210578">&#34;tls:&nbsp;client&nbsp;using&nbsp;inppropriate&nbsp;protocol&nbsp;fallback&#34;</span><span class="op" id="4210628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4210633">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4210638">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4210646">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4210649">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4210653">return</span>&nbsp;<span class="ident" id="4210660">false</span><span class="op" id="4210665">,</span>&nbsp;<span class="ident" id="4210667">nil</span><br>
<span class="lineno">240</span><span class="op" id="4210671">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4210674">//&nbsp;checkForResumption&nbsp;returns&nbsp;true&nbsp;if&nbsp;we&nbsp;should&nbsp;perform&nbsp;resumption&nbsp;on&nbsp;this&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4210761">func</span>&nbsp;<span class="op" id="4210766">(</span><span class="ident" id="4210767">hs</span>&nbsp;<span class="op" id="4210770">*</span><span class="ident" id="4210771"><a href="/crypto/tls/handshake_server.go.html#4204534">serverHandshakeState</a></span><span class="op" id="4210791">)</span>&nbsp;<span class="ident" id="4210793">checkForResumption</span><span class="op" id="4210811">(</span><span class="op" id="4210812">)</span>&nbsp;<span class="builtintype" id="4210814">bool</span>&nbsp;<span class="op" id="4210819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4210822">c</span>&nbsp;<span class="op" id="4210824">:=</span>&nbsp;<span class="ident" id="4210827"><a href="/crypto/tls/handshake_server.go.html#4210767">hs</a></span><span class="op" id="4210829">.</span><span class="ident" id="4210830">c</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4210834">if</span>&nbsp;<span class="ident" id="4210837"><a href="/crypto/tls/handshake_server.go.html#4210822">c</a></span><span class="op" id="4210838">.</span><span class="ident" id="4210839">config</span><span class="op" id="4210845">.</span><span class="ident" id="4210846">SessionTicketsDisabled</span>&nbsp;<span class="op" id="4210869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4210873">return</span>&nbsp;<span class="ident" id="4210880">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4210887">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4210891">var</span>&nbsp;<span class="ident" id="4210895">ok</span>&nbsp;<span class="builtintype" id="4210898">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4210904">if</span>&nbsp;<span class="ident" id="4210907"><a href="/crypto/tls/handshake_server.go.html#4210767">hs</a></span><span class="op" id="4210909">.</span><span class="ident" id="4210910">sessionState</span><span class="op" id="4210922">,</span>&nbsp;<span class="ident" id="4210924"><a href="/crypto/tls/handshake_server.go.html#4210895">ok</a></span>&nbsp;<span class="op" id="4210927">=</span>&nbsp;<span class="ident" id="4210929"><a href="/crypto/tls/handshake_server.go.html#4210822">c</a></span><span class="op" id="4210930">.</span><span class="ident" id="4210931">decryptTicket</span><span class="op" id="4210944">(</span><span class="ident" id="4210945"><a href="/crypto/tls/handshake_server.go.html#4210767">hs</a></span><span class="op" id="4210947">.</span><span class="ident" id="4210948">clientHello</span><span class="op" id="4210959">.</span><span class="ident" id="4210960">sessionTicket</span><span class="op" id="4210973">)</span><span class="op" id="4210974">;</span>&nbsp;<span class="op" id="4210976">!</span><span class="ident" id="4210977"><a href="/crypto/tls/handshake_server.go.html#4210895">ok</a></span>&nbsp;<span class="op" id="4210980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4210984">return</span>&nbsp;<span class="ident" id="4210991">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4210998">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4211002">if</span>&nbsp;<span class="ident" id="4211005"><a href="/crypto/tls/handshake_server.go.html#4210767">hs</a></span><span class="op" id="4211007">.</span><span class="ident" id="4211008">sessionState</span><span class="op" id="4211020">.</span><span class="ident" id="4211021">vers</span>&nbsp;<span class="op" id="4211026">&gt;</span>&nbsp;<span class="ident" id="4211028"><a href="/crypto/tls/handshake_server.go.html#4210767">hs</a></span><span class="op" id="4211030">.</span><span class="ident" id="4211031">clientHello</span><span class="op" id="4211042">.</span><span class="ident" id="4211043">vers</span>&nbsp;<span class="op" id="4211048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4211052">return</span>&nbsp;<span class="ident" id="4211059">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4211066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4211069">if</span>&nbsp;<span class="ident" id="4211072">vers</span><span class="op" id="4211076">,</span>&nbsp;<span class="ident" id="4211078">ok</span>&nbsp;<span class="op" id="4211081">:=</span>&nbsp;<span class="ident" id="4211084"><a href="/crypto/tls/handshake_server.go.html#4210822">c</a></span><span class="op" id="4211085">.</span><span class="ident" id="4211086">config</span><span class="op" id="4211092">.</span><span class="ident" id="4211093">mutualVersion</span><span class="op" id="4211106">(</span><span class="ident" id="4211107"><a href="/crypto/tls/handshake_server.go.html#4210767">hs</a></span><span class="op" id="4211109">.</span><span class="ident" id="4211110">sessionState</span><span class="op" id="4211122">.</span><span class="ident" id="4211123">vers</span><span class="op" id="4211127">)</span><span class="op" id="4211128">;</span>&nbsp;<span class="op" id="4211130">!</span><span class="ident" id="4211131"><a href="/crypto/tls/handshake_server.go.html#4211078">ok</a></span>&nbsp;<span class="op" id="4211134">||</span>&nbsp;<span class="ident" id="4211137"><a href="/crypto/tls/handshake_server.go.html#4211072">vers</a></span>&nbsp;<span class="op" id="4211142">!=</span>&nbsp;<span class="ident" id="4211145"><a href="/crypto/tls/handshake_server.go.html#4210767">hs</a></span><span class="op" id="4211147">.</span><span class="ident" id="4211148">sessionState</span><span class="op" id="4211160">.</span><span class="ident" id="4211161">vers</span>&nbsp;<span class="op" id="4211166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4211170">return</span>&nbsp;<span class="ident" id="4211177">false</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4211184">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4211188">cipherSuiteOk</span>&nbsp;<span class="op" id="4211202">:=</span>&nbsp;<span class="ident" id="4211205">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4211212">//&nbsp;Check&nbsp;that&nbsp;the&nbsp;client&nbsp;is&nbsp;still&nbsp;offering&nbsp;the&nbsp;ciphersuite&nbsp;in&nbsp;the&nbsp;session.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4211288">for</span>&nbsp;<span class="ident" id="4211292">_</span><span class="op" id="4211293">,</span>&nbsp;<span class="ident" id="4211295">id</span>&nbsp;<span class="op" id="4211298">:=</span>&nbsp;<span class="keyword" id="4211301">range</span>&nbsp;<span class="ident" id="4211307"><a href="/crypto/tls/handshake_server.go.html#4210767">hs</a></span><span class="op" id="4211309">.</span><span class="ident" id="4211310">clientHello</span><span class="op" id="4211321">.</span><span class="ident" id="4211322">cipherSuites</span>&nbsp;<span class="op" id="4211335">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4211339">if</span>&nbsp;<span class="ident" id="4211342"><a href="/crypto/tls/handshake_server.go.html#4211295">id</a></span>&nbsp;<span class="op" id="4211345">==</span>&nbsp;<span class="ident" id="4211348"><a href="/crypto/tls/handshake_server.go.html#4210767">hs</a></span><span class="op" id="4211350">.</span><span class="ident" id="4211351">sessionState</span><span class="op" id="4211363">.</span><span class="ident" id="4211364">cipherSuite</span>&nbsp;<span class="op" id="4211376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4211381"><a href="/crypto/tls/handshake_server.go.html#4211188">cipherSuiteOk</a></span>&nbsp;<span class="op" id="4211395">=</span>&nbsp;<span class="ident" id="4211397">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4211405">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4211413">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4211416">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4211419">if</span>&nbsp;<span class="op" id="4211422">!</span><span class="ident" id="4211423"><a href="/crypto/tls/handshake_server.go.html#4211188">cipherSuiteOk</a></span>&nbsp;<span class="op" id="4211437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4211441">return</span>&nbsp;<span class="ident" id="4211448">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4211455">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4211459">//&nbsp;Check&nbsp;that&nbsp;we&nbsp;also&nbsp;support&nbsp;the&nbsp;ciphersuite&nbsp;from&nbsp;the&nbsp;session.</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4211524"><a href="/crypto/tls/handshake_server.go.html#4210767">hs</a></span><span class="op" id="4211526">.</span><span class="ident" id="4211527">suite</span>&nbsp;<span class="op" id="4211533">=</span>&nbsp;<span class="ident" id="4211535"><a href="/crypto/tls/handshake_server.go.html#4210822">c</a></span><span class="op" id="4211536">.</span><span class="ident" id="4211537">tryCipherSuite</span><span class="op" id="4211551">(</span><span class="ident" id="4211552"><a href="/crypto/tls/handshake_server.go.html#4210767">hs</a></span><span class="op" id="4211554">.</span><span class="ident" id="4211555">sessionState</span><span class="op" id="4211567">.</span><span class="ident" id="4211568">cipherSuite</span><span class="op" id="4211579">,</span>&nbsp;<span class="ident" id="4211581"><a href="/crypto/tls/handshake_server.go.html#4210822">c</a></span><span class="op" id="4211582">.</span><span class="ident" id="4211583">config</span><span class="op" id="4211589">.</span><span class="ident" id="4211590">cipherSuites</span><span class="op" id="4211602">(</span><span class="op" id="4211603">)</span><span class="op" id="4211604">,</span>&nbsp;<span class="ident" id="4211606"><a href="/crypto/tls/handshake_server.go.html#4210767">hs</a></span><span class="op" id="4211608">.</span><span class="ident" id="4211609">sessionState</span><span class="op" id="4211621">.</span><span class="ident" id="4211622">vers</span><span class="op" id="4211626">,</span>&nbsp;<span class="ident" id="4211628"><a href="/crypto/tls/handshake_server.go.html#4210767">hs</a></span><span class="op" id="4211630">.</span><span class="ident" id="4211631">ellipticOk</span><span class="op" id="4211641">,</span>&nbsp;<span class="ident" id="4211643"><a href="/crypto/tls/handshake_server.go.html#4210767">hs</a></span><span class="op" id="4211645">.</span><span class="ident" id="4211646">ecdsaOk</span><span class="op" id="4211653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4211656">if</span>&nbsp;<span class="ident" id="4211659"><a href="/crypto/tls/handshake_server.go.html#4210767">hs</a></span><span class="op" id="4211661">.</span><span class="ident" id="4211662">suite</span>&nbsp;<span class="op" id="4211668">==</span>&nbsp;<span class="ident" id="4211671">nil</span>&nbsp;<span class="op" id="4211675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4211679">return</span>&nbsp;<span class="ident" id="4211686">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4211693">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4211697">sessionHasClientCerts</span>&nbsp;<span class="op" id="4211719">:=</span>&nbsp;<span class="builtinfunc" id="4211722">len</span><span class="op" id="4211725">(</span><span class="ident" id="4211726"><a href="/crypto/tls/handshake_server.go.html#4210767">hs</a></span><span class="op" id="4211728">.</span><span class="ident" id="4211729">sessionState</span><span class="op" id="4211741">.</span><span class="ident" id="4211742">certificates</span><span class="op" id="4211754">)</span>&nbsp;<span class="op" id="4211756">!=</span>&nbsp;<span class="num" id="4211759">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4211762">needClientCerts</span>&nbsp;<span class="op" id="4211778">:=</span>&nbsp;<span class="ident" id="4211781"><a href="/crypto/tls/handshake_server.go.html#4210822">c</a></span><span class="op" id="4211782">.</span><span class="ident" id="4211783">config</span><span class="op" id="4211789">.</span><span class="ident" id="4211790">ClientAuth</span>&nbsp;<span class="op" id="4211801">==</span>&nbsp;<span class="ident" id="4211804"><a href="/crypto/tls/common.go.html#4113687">RequireAnyClientCert</a></span>&nbsp;<span class="op" id="4211825">||</span>&nbsp;<span class="ident" id="4211828"><a href="/crypto/tls/handshake_server.go.html#4210822">c</a></span><span class="op" id="4211829">.</span><span class="ident" id="4211830">config</span><span class="op" id="4211836">.</span><span class="ident" id="4211837">ClientAuth</span>&nbsp;<span class="op" id="4211848">==</span>&nbsp;<span class="ident" id="4211851"><a href="/crypto/tls/common.go.html#4113734">RequireAndVerifyClientCert</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4211879">if</span>&nbsp;<span class="ident" id="4211882"><a href="/crypto/tls/handshake_server.go.html#4211762">needClientCerts</a></span>&nbsp;<span class="op" id="4211898">&amp;&amp;</span>&nbsp;<span class="op" id="4211901">!</span><span class="ident" id="4211902"><a href="/crypto/tls/handshake_server.go.html#4211697">sessionHasClientCerts</a></span>&nbsp;<span class="op" id="4211924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4211928">return</span>&nbsp;<span class="ident" id="4211935">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4211942">}</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4211945">if</span>&nbsp;<span class="ident" id="4211948"><a href="/crypto/tls/handshake_server.go.html#4211697">sessionHasClientCerts</a></span>&nbsp;<span class="op" id="4211970">&amp;&amp;</span>&nbsp;<span class="ident" id="4211973"><a href="/crypto/tls/handshake_server.go.html#4210822">c</a></span><span class="op" id="4211974">.</span><span class="ident" id="4211975">config</span><span class="op" id="4211981">.</span><span class="ident" id="4211982">ClientAuth</span>&nbsp;<span class="op" id="4211993">==</span>&nbsp;<span class="ident" id="4211996"><a href="/crypto/tls/common.go.html#4113632">NoClientCert</a></span>&nbsp;<span class="op" id="4212009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4212013">return</span>&nbsp;<span class="ident" id="4212020">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4212027">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4212031">return</span>&nbsp;<span class="ident" id="4212038">true</span><br>
<span class="lineno">290</span><span class="op" id="4212043">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4212046">func</span>&nbsp;<span class="op" id="4212051">(</span><span class="ident" id="4212052">hs</span>&nbsp;<span class="op" id="4212055">*</span><span class="ident" id="4212056"><a href="/crypto/tls/handshake_server.go.html#4204534">serverHandshakeState</a></span><span class="op" id="4212076">)</span>&nbsp;<span class="ident" id="4212078">doResumeHandshake</span><span class="op" id="4212095">(</span><span class="op" id="4212096">)</span>&nbsp;<span class="builtintype" id="4212098">error</span>&nbsp;<span class="op" id="4212104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4212107">c</span>&nbsp;<span class="op" id="4212109">:=</span>&nbsp;<span class="ident" id="4212112"><a href="/crypto/tls/handshake_server.go.html#4212052">hs</a></span><span class="op" id="4212114">.</span><span class="ident" id="4212115">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4212119"><a href="/crypto/tls/handshake_server.go.html#4212052">hs</a></span><span class="op" id="4212121">.</span><span class="ident" id="4212122">hello</span><span class="op" id="4212127">.</span><span class="ident" id="4212128">cipherSuite</span>&nbsp;<span class="op" id="4212140">=</span>&nbsp;<span class="ident" id="4212142"><a href="/crypto/tls/handshake_server.go.html#4212052">hs</a></span><span class="op" id="4212144">.</span><span class="ident" id="4212145">suite</span><span class="op" id="4212150">.</span><span class="ident" id="4212151">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4212155">//&nbsp;We&nbsp;echo&nbsp;the&nbsp;client&#39;s&nbsp;session&nbsp;ID&nbsp;in&nbsp;the&nbsp;ServerHello&nbsp;to&nbsp;let&nbsp;it&nbsp;know</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4212225">//&nbsp;that&nbsp;we&#39;re&nbsp;doing&nbsp;a&nbsp;resumption.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4212260"><a href="/crypto/tls/handshake_server.go.html#4212052">hs</a></span><span class="op" id="4212262">.</span><span class="ident" id="4212263">hello</span><span class="op" id="4212268">.</span><span class="ident" id="4212269">sessionId</span>&nbsp;<span class="op" id="4212279">=</span>&nbsp;<span class="ident" id="4212281"><a href="/crypto/tls/handshake_server.go.html#4212052">hs</a></span><span class="op" id="4212283">.</span><span class="ident" id="4212284">clientHello</span><span class="op" id="4212295">.</span><span class="ident" id="4212296">sessionId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4212307"><a href="/crypto/tls/handshake_server.go.html#4212052">hs</a></span><span class="op" id="4212309">.</span><span class="ident" id="4212310">finishedHash</span><span class="op" id="4212322">.</span><span class="ident" id="4212323">Write</span><span class="op" id="4212328">(</span><span class="ident" id="4212329"><a href="/crypto/tls/handshake_server.go.html#4212052">hs</a></span><span class="op" id="4212331">.</span><span class="ident" id="4212332">hello</span><span class="op" id="4212337">.</span><span class="ident" id="4212338">marshal</span><span class="op" id="4212345">(</span><span class="op" id="4212346">)</span><span class="op" id="4212347">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4212350"><a href="/crypto/tls/handshake_server.go.html#4212107">c</a></span><span class="op" id="4212351">.</span><span class="ident" id="4212352">writeRecord</span><span class="op" id="4212363">(</span><span class="ident" id="4212364"><a href="/crypto/tls/common.go.html#4108718">recordTypeHandshake</a></span><span class="op" id="4212383">,</span>&nbsp;<span class="ident" id="4212385"><a href="/crypto/tls/handshake_server.go.html#4212052">hs</a></span><span class="op" id="4212387">.</span><span class="ident" id="4212388">hello</span><span class="op" id="4212393">.</span><span class="ident" id="4212394">marshal</span><span class="op" id="4212401">(</span><span class="op" id="4212402">)</span><span class="op" id="4212403">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4212407">if</span>&nbsp;<span class="builtinfunc" id="4212410">len</span><span class="op" id="4212413">(</span><span class="ident" id="4212414"><a href="/crypto/tls/handshake_server.go.html#4212052">hs</a></span><span class="op" id="4212416">.</span><span class="ident" id="4212417">sessionState</span><span class="op" id="4212429">.</span><span class="ident" id="4212430">certificates</span><span class="op" id="4212442">)</span>&nbsp;<span class="op" id="4212444">&gt;</span>&nbsp;<span class="num" id="4212446">0</span>&nbsp;<span class="op" id="4212448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4212452">if</span>&nbsp;<span class="ident" id="4212455">_</span><span class="op" id="4212456">,</span>&nbsp;<span class="ident" id="4212458">err</span>&nbsp;<span class="op" id="4212462">:=</span>&nbsp;<span class="ident" id="4212465"><a href="/crypto/tls/handshake_server.go.html#4212052">hs</a></span><span class="op" id="4212467">.</span><span class="ident" id="4212468">processCertsFromClient</span><span class="op" id="4212490">(</span><span class="ident" id="4212491"><a href="/crypto/tls/handshake_server.go.html#4212052">hs</a></span><span class="op" id="4212493">.</span><span class="ident" id="4212494">sessionState</span><span class="op" id="4212506">.</span><span class="ident" id="4212507">certificates</span><span class="op" id="4212519">)</span><span class="op" id="4212520">;</span>&nbsp;<span class="ident" id="4212522"><a href="/crypto/tls/handshake_server.go.html#4212458">err</a></span>&nbsp;<span class="op" id="4212526">!=</span>&nbsp;<span class="ident" id="4212529">nil</span>&nbsp;<span class="op" id="4212533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4212538">return</span>&nbsp;<span class="ident" id="4212545"><a href="/crypto/tls/handshake_server.go.html#4212458">err</a></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4212551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4212554">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4212558"><a href="/crypto/tls/handshake_server.go.html#4212052">hs</a></span><span class="op" id="4212560">.</span><span class="ident" id="4212561">masterSecret</span>&nbsp;<span class="op" id="4212574">=</span>&nbsp;<span class="ident" id="4212576"><a href="/crypto/tls/handshake_server.go.html#4212052">hs</a></span><span class="op" id="4212578">.</span><span class="ident" id="4212579">sessionState</span><span class="op" id="4212591">.</span><span class="ident" id="4212592">masterSecret</span><br>
<span class="lineno"></span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4212607">return</span>&nbsp;<span class="ident" id="4212614">nil</span><br>
<span class="lineno"></span><span class="op" id="4212618">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4212621">func</span>&nbsp;<span class="op" id="4212626">(</span><span class="ident" id="4212627">hs</span>&nbsp;<span class="op" id="4212630">*</span><span class="ident" id="4212631"><a href="/crypto/tls/handshake_server.go.html#4204534">serverHandshakeState</a></span><span class="op" id="4212651">)</span>&nbsp;<span class="ident" id="4212653">doFullHandshake</span><span class="op" id="4212668">(</span><span class="op" id="4212669">)</span>&nbsp;<span class="builtintype" id="4212671">error</span>&nbsp;<span class="op" id="4212677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4212680">config</span>&nbsp;<span class="op" id="4212687">:=</span>&nbsp;<span class="ident" id="4212690"><a href="/crypto/tls/handshake_server.go.html#4212627">hs</a></span><span class="op" id="4212692">.</span><span class="ident" id="4212693">c</span><span class="op" id="4212694">.</span><span class="ident" id="4212695">config</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4212703">c</span>&nbsp;<span class="op" id="4212705">:=</span>&nbsp;<span class="ident" id="4212708"><a href="/crypto/tls/handshake_server.go.html#4212627">hs</a></span><span class="op" id="4212710">.</span><span class="ident" id="4212711">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4212715">if</span>&nbsp;<span class="ident" id="4212718"><a href="/crypto/tls/handshake_server.go.html#4212627">hs</a></span><span class="op" id="4212720">.</span><span class="ident" id="4212721">clientHello</span><span class="op" id="4212732">.</span><span class="ident" id="4212733">ocspStapling</span>&nbsp;<span class="op" id="4212746">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4212749">len</span><span class="op" id="4212752">(</span><span class="ident" id="4212753"><a href="/crypto/tls/handshake_server.go.html#4212627">hs</a></span><span class="op" id="4212755">.</span><span class="ident" id="4212756">cert</span><span class="op" id="4212760">.</span><span class="ident" id="4212761">OCSPStaple</span><span class="op" id="4212771">)</span>&nbsp;<span class="op" id="4212773">&gt;</span>&nbsp;<span class="num" id="4212775">0</span>&nbsp;<span class="op" id="4212777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4212781"><a href="/crypto/tls/handshake_server.go.html#4212627">hs</a></span><span class="op" id="4212783">.</span><span class="ident" id="4212784">hello</span><span class="op" id="4212789">.</span><span class="ident" id="4212790">ocspStapling</span>&nbsp;<span class="op" id="4212803">=</span>&nbsp;<span class="ident" id="4212805">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4212811">}</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4212815"><a href="/crypto/tls/handshake_server.go.html#4212627">hs</a></span><span class="op" id="4212817">.</span><span class="ident" id="4212818">hello</span><span class="op" id="4212823">.</span><span class="ident" id="4212824">ticketSupported</span>&nbsp;<span class="op" id="4212840">=</span>&nbsp;<span class="ident" id="4212842"><a href="/crypto/tls/handshake_server.go.html#4212627">hs</a></span><span class="op" id="4212844">.</span><span class="ident" id="4212845">clientHello</span><span class="op" id="4212856">.</span><span class="ident" id="4212857">ticketSupported</span>&nbsp;<span class="op" id="4212873">&amp;&amp;</span>&nbsp;<span class="op" id="4212876">!</span><span class="ident" id="4212877"><a href="/crypto/tls/handshake_server.go.html#4212680">config</a></span><span class="op" id="4212883">.</span><span class="ident" id="4212884">SessionTicketsDisabled</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4212908"><a href="/crypto/tls/handshake_server.go.html#4212627">hs</a></span><span class="op" id="4212910">.</span><span class="ident" id="4212911">hello</span><span class="op" id="4212916">.</span><span class="ident" id="4212917">cipherSuite</span>&nbsp;<span class="op" id="4212929">=</span>&nbsp;<span class="ident" id="4212931"><a href="/crypto/tls/handshake_server.go.html#4212627">hs</a></span><span class="op" id="4212933">.</span><span class="ident" id="4212934">suite</span><span class="op" id="4212939">.</span><span class="ident" id="4212940">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4212944"><a href="/crypto/tls/handshake_server.go.html#4212627">hs</a></span><span class="op" id="4212946">.</span><span class="ident" id="4212947">finishedHash</span><span class="op" id="4212959">.</span><span class="ident" id="4212960">Write</span><span class="op" id="4212965">(</span><span class="ident" id="4212966"><a href="/crypto/tls/handshake_server.go.html#4212627">hs</a></span><span class="op" id="4212968">.</span><span class="ident" id="4212969">hello</span><span class="op" id="4212974">.</span><span class="ident" id="4212975">marshal</span><span class="op" id="4212982">(</span><span class="op" id="4212983">)</span><span class="op" id="4212984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4212987"><a href="/crypto/tls/handshake_server.go.html#4212703">c</a></span><span class="op" id="4212988">.</span><span class="ident" id="4212989">writeRecord</span><span class="op" id="4213000">(</span><span class="ident" id="4213001"><a href="/crypto/tls/common.go.html#4108718">recordTypeHandshake</a></span><span class="op" id="4213020">,</span>&nbsp;<span class="ident" id="4213022"><a href="/crypto/tls/handshake_server.go.html#4212627">hs</a></span><span class="op" id="4213024">.</span><span class="ident" id="4213025">hello</span><span class="op" id="4213030">.</span><span class="ident" id="4213031">marshal</span><span class="op" id="4213038">(</span><span class="op" id="4213039">)</span><span class="op" id="4213040">)</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4213044">certMsg</span>&nbsp;<span class="op" id="4213052">:=</span>&nbsp;<span class="builtinfunc" id="4213055">new</span><span class="op" id="4213058">(</span><span class="ident" id="4213059"><a href="/crypto/tls/handshake_messages.go.html#4190456">certificateMsg</a></span><span class="op" id="4213073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4213076"><a href="/crypto/tls/handshake_server.go.html#4213044">certMsg</a></span><span class="op" id="4213083">.</span><span class="ident" id="4213084">certificates</span>&nbsp;<span class="op" id="4213097">=</span>&nbsp;<span class="ident" id="4213099"><a href="/crypto/tls/handshake_server.go.html#4212627">hs</a></span><span class="op" id="4213101">.</span><span class="ident" id="4213102">cert</span><span class="op" id="4213106">.</span><span class="ident" id="4213107">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4213120"><a href="/crypto/tls/handshake_server.go.html#4212627">hs</a></span><span class="op" id="4213122">.</span><span class="ident" id="4213123">finishedHash</span><span class="op" id="4213135">.</span><span class="ident" id="4213136">Write</span><span class="op" id="4213141">(</span><span class="ident" id="4213142"><a href="/crypto/tls/handshake_server.go.html#4213044">certMsg</a></span><span class="op" id="4213149">.</span><span class="ident" id="4213150">marshal</span><span class="op" id="4213157">(</span><span class="op" id="4213158">)</span><span class="op" id="4213159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4213162"><a href="/crypto/tls/handshake_server.go.html#4212703">c</a></span><span class="op" id="4213163">.</span><span class="ident" id="4213164">writeRecord</span><span class="op" id="4213175">(</span><span class="ident" id="4213176"><a href="/crypto/tls/common.go.html#4108718">recordTypeHandshake</a></span><span class="op" id="4213195">,</span>&nbsp;<span class="ident" id="4213197"><a href="/crypto/tls/handshake_server.go.html#4213044">certMsg</a></span><span class="op" id="4213204">.</span><span class="ident" id="4213205">marshal</span><span class="op" id="4213212">(</span><span class="op" id="4213213">)</span><span class="op" id="4213214">)</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4213218">if</span>&nbsp;<span class="ident" id="4213221"><a href="/crypto/tls/handshake_server.go.html#4212627">hs</a></span><span class="op" id="4213223">.</span><span class="ident" id="4213224">hello</span><span class="op" id="4213229">.</span><span class="ident" id="4213230">ocspStapling</span>&nbsp;<span class="op" id="4213243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4213247">certStatus</span>&nbsp;<span class="op" id="4213258">:=</span>&nbsp;<span class="builtinfunc" id="4213261">new</span><span class="op" id="4213264">(</span><span class="ident" id="4213265"><a href="/crypto/tls/handshake_messages.go.html#4192853">certificateStatusMsg</a></span><span class="op" id="4213285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4213289"><a href="/crypto/tls/handshake_server.go.html#4213247">certStatus</a></span><span class="op" id="4213299">.</span><span class="ident" id="4213300">statusType</span>&nbsp;<span class="op" id="4213311">=</span>&nbsp;<span class="ident" id="4213313"><a href="/crypto/tls/common.go.html#4110353">statusTypeOCSP</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4213330"><a href="/crypto/tls/handshake_server.go.html#4213247">certStatus</a></span><span class="op" id="4213340">.</span><span class="ident" id="4213341">response</span>&nbsp;<span class="op" id="4213350">=</span>&nbsp;<span class="ident" id="4213352"><a href="/crypto/tls/handshake_server.go.html#4212627">hs</a></span><span class="op" id="4213354">.</span><span class="ident" id="4213355">cert</span><span class="op" id="4213359">.</span><span class="ident" id="4213360">OCSPStaple</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4213373"><a href="/crypto/tls/handshake_server.go.html#4212627">hs</a></span><span class="op" id="4213375">.</span><span class="ident" id="4213376">finishedHash</span><span class="op" id="4213388">.</span><span class="ident" id="4213389">Write</span><span class="op" id="4213394">(</span><span class="ident" id="4213395"><a href="/crypto/tls/handshake_server.go.html#4213247">certStatus</a></span><span class="op" id="4213405">.</span><span class="ident" id="4213406">marshal</span><span class="op" id="4213413">(</span><span class="op" id="4213414">)</span><span class="op" id="4213415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4213419"><a href="/crypto/tls/handshake_server.go.html#4212703">c</a></span><span class="op" id="4213420">.</span><span class="ident" id="4213421">writeRecord</span><span class="op" id="4213432">(</span><span class="ident" id="4213433"><a href="/crypto/tls/common.go.html#4108718">recordTypeHandshake</a></span><span class="op" id="4213452">,</span>&nbsp;<span class="ident" id="4213454"><a href="/crypto/tls/handshake_server.go.html#4213247">certStatus</a></span><span class="op" id="4213464">.</span><span class="ident" id="4213465">marshal</span><span class="op" id="4213472">(</span><span class="op" id="4213473">)</span><span class="op" id="4213474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4213477">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4213481">keyAgreement</span>&nbsp;<span class="op" id="4213494">:=</span>&nbsp;<span class="ident" id="4213497"><a href="/crypto/tls/handshake_server.go.html#4212627">hs</a></span><span class="op" id="4213499">.</span><span class="ident" id="4213500">suite</span><span class="op" id="4213505">.</span><span class="ident" id="4213506">ka</span><span class="op" id="4213508">(</span><span class="ident" id="4213509"><a href="/crypto/tls/handshake_server.go.html#4212703">c</a></span><span class="op" id="4213510">.</span><span class="ident" id="4213511">vers</span><span class="op" id="4213515">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4213518">skx</span><span class="op" id="4213521">,</span>&nbsp;<span class="ident" id="4213523">err</span>&nbsp;<span class="op" id="4213527">:=</span>&nbsp;<span class="ident" id="4213530"><a href="/crypto/tls/handshake_server.go.html#4213481">keyAgreement</a></span><span class="op" id="4213542">.</span><span class="ident" id="4213543">generateServerKeyExchange</span><span class="op" id="4213568">(</span><span class="ident" id="4213569"><a href="/crypto/tls/handshake_server.go.html#4212680">config</a></span><span class="op" id="4213575">,</span>&nbsp;<span class="ident" id="4213577"><a href="/crypto/tls/handshake_server.go.html#4212627">hs</a></span><span class="op" id="4213579">.</span><span class="ident" id="4213580">cert</span><span class="op" id="4213584">,</span>&nbsp;<span class="ident" id="4213586"><a href="/crypto/tls/handshake_server.go.html#4212627">hs</a></span><span class="op" id="4213588">.</span><span class="ident" id="4213589">clientHello</span><span class="op" id="4213600">,</span>&nbsp;<span class="ident" id="4213602"><a href="/crypto/tls/handshake_server.go.html#4212627">hs</a></span><span class="op" id="4213604">.</span><span class="ident" id="4213605">hello</span><span class="op" id="4213610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4213613">if</span>&nbsp;<span class="ident" id="4213616"><a href="/crypto/tls/handshake_server.go.html#4213523">err</a></span>&nbsp;<span class="op" id="4213620">!=</span>&nbsp;<span class="ident" id="4213623">nil</span>&nbsp;<span class="op" id="4213627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4213631"><a href="/crypto/tls/handshake_server.go.html#4212703">c</a></span><span class="op" id="4213632">.</span><span class="ident" id="4213633">sendAlert</span><span class="op" id="4213642">(</span><span class="ident" id="4213643"><a href="/crypto/tls/alert.go.html#4096192">alertHandshakeFailure</a></span><span class="op" id="4213664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4213668">return</span>&nbsp;<span class="ident" id="4213675"><a href="/crypto/tls/handshake_server.go.html#4213523">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4213680">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4213683">if</span>&nbsp;<span class="ident" id="4213686"><a href="/crypto/tls/handshake_server.go.html#4213518">skx</a></span>&nbsp;<span class="op" id="4213690">!=</span>&nbsp;<span class="ident" id="4213693">nil</span>&nbsp;<span class="op" id="4213697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4213701"><a href="/crypto/tls/handshake_server.go.html#4212627">hs</a></span><span class="op" id="4213703">.</span><span class="ident" id="4213704">finishedHash</span><span class="op" id="4213716">.</span><span class="ident" id="4213717">Write</span><span class="op" id="4213722">(</span><span class="ident" id="4213723"><a href="/crypto/tls/handshake_server.go.html#4213518">skx</a></span><span class="op" id="4213726">.</span><span class="ident" id="4213727">marshal</span><span class="op" id="4213734">(</span><span class="op" id="4213735">)</span><span class="op" id="4213736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4213740"><a href="/crypto/tls/handshake_server.go.html#4212703">c</a></span><span class="op" id="4213741">.</span><span class="ident" id="4213742">writeRecord</span><span class="op" id="4213753">(</span><span class="ident" id="4213754"><a href="/crypto/tls/common.go.html#4108718">recordTypeHandshake</a></span><span class="op" id="4213773">,</span>&nbsp;<span class="ident" id="4213775"><a href="/crypto/tls/handshake_server.go.html#4213518">skx</a></span><span class="op" id="4213778">.</span><span class="ident" id="4213779">marshal</span><span class="op" id="4213786">(</span><span class="op" id="4213787">)</span><span class="op" id="4213788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4213791">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4213795">if</span>&nbsp;<span class="ident" id="4213798"><a href="/crypto/tls/handshake_server.go.html#4212680">config</a></span><span class="op" id="4213804">.</span><span class="ident" id="4213805">ClientAuth</span>&nbsp;<span class="op" id="4213816">&gt;=</span>&nbsp;<span class="ident" id="4213819"><a href="/crypto/tls/common.go.html#4113668">RequestClientCert</a></span>&nbsp;<span class="op" id="4213837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4213841">//&nbsp;Request&nbsp;a&nbsp;client&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4213875">certReq</span>&nbsp;<span class="op" id="4213883">:=</span>&nbsp;<span class="builtinfunc" id="4213886">new</span><span class="op" id="4213889">(</span><span class="ident" id="4213890"><a href="/crypto/tls/handshake_messages.go.html#4197001">certificateRequestMsg</a></span><span class="op" id="4213911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4213915"><a href="/crypto/tls/handshake_server.go.html#4213875">certReq</a></span><span class="op" id="4213922">.</span><span class="ident" id="4213923">certificateTypes</span>&nbsp;<span class="op" id="4213940">=</span>&nbsp;<span class="op" id="4213942">[</span><span class="op" id="4213943">]</span><span class="builtintype" id="4213944">byte</span><span class="op" id="4213948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="4213953">byte</span><span class="op" id="4213957">(</span><span class="ident" id="4213958"><a href="/crypto/tls/common.go.html#4110439">certTypeRSASign</a></span><span class="op" id="4213973">)</span><span class="op" id="4213974">,</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="4213979">byte</span><span class="op" id="4213983">(</span><span class="ident" id="4213984"><a href="/crypto/tls/common.go.html#4110737">certTypeECDSASign</a></span><span class="op" id="4214001">)</span><span class="op" id="4214002">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4214006">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4214010">if</span>&nbsp;<span class="ident" id="4214013"><a href="/crypto/tls/handshake_server.go.html#4212703">c</a></span><span class="op" id="4214014">.</span><span class="ident" id="4214015">vers</span>&nbsp;<span class="op" id="4214020">&gt;=</span>&nbsp;<span class="ident" id="4214023"><a href="/crypto/tls/common.go.html#4108205">VersionTLS12</a></span>&nbsp;<span class="op" id="4214036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4214041"><a href="/crypto/tls/handshake_server.go.html#4213875">certReq</a></span><span class="op" id="4214048">.</span><span class="ident" id="4214049">hasSignatureAndHash</span>&nbsp;<span class="op" id="4214069">=</span>&nbsp;<span class="ident" id="4214071">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4214079"><a href="/crypto/tls/handshake_server.go.html#4213875">certReq</a></span><span class="op" id="4214086">.</span><span class="ident" id="4214087">signatureAndHashes</span>&nbsp;<span class="op" id="4214106">=</span>&nbsp;<span class="ident" id="4214108"><a href="/crypto/tls/common.go.html#4111994">supportedClientCertSignatureAlgorithms</a></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4214149">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4214154">//&nbsp;An&nbsp;empty&nbsp;list&nbsp;of&nbsp;certificateAuthorities&nbsp;signals&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4214210">//&nbsp;the&nbsp;client&nbsp;that&nbsp;it&nbsp;may&nbsp;send&nbsp;any&nbsp;certificate&nbsp;in&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4214271">//&nbsp;to&nbsp;our&nbsp;request.&nbsp;When&nbsp;we&nbsp;know&nbsp;the&nbsp;CAs&nbsp;we&nbsp;trust,&nbsp;then</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4214328">//&nbsp;we&nbsp;can&nbsp;send&nbsp;them&nbsp;down,&nbsp;so&nbsp;that&nbsp;the&nbsp;client&nbsp;can&nbsp;choose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4214386">//&nbsp;an&nbsp;appropriate&nbsp;certificate&nbsp;to&nbsp;give&nbsp;to&nbsp;us.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4214433">if</span>&nbsp;<span class="ident" id="4214436"><a href="/crypto/tls/handshake_server.go.html#4212680">config</a></span><span class="op" id="4214442">.</span><span class="ident" id="4214443">ClientCAs</span>&nbsp;<span class="op" id="4214453">!=</span>&nbsp;<span class="ident" id="4214456">nil</span>&nbsp;<span class="op" id="4214460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4214465"><a href="/crypto/tls/handshake_server.go.html#4213875">certReq</a></span><span class="op" id="4214472">.</span><span class="ident" id="4214473">certificateAuthorities</span>&nbsp;<span class="op" id="4214496">=</span>&nbsp;<span class="ident" id="4214498"><a href="/crypto/tls/handshake_server.go.html#4212680">config</a></span><span class="op" id="4214504">.</span><span class="ident" id="4214505">ClientCAs</span><span class="op" id="4214514">.</span><span class="ident" id="4214515">Subjects</span><span class="op" id="4214523">(</span><span class="op" id="4214524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4214528">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4214532"><a href="/crypto/tls/handshake_server.go.html#4212627">hs</a></span><span class="op" id="4214534">.</span><span class="ident" id="4214535">finishedHash</span><span class="op" id="4214547">.</span><span class="ident" id="4214548">Write</span><span class="op" id="4214553">(</span><span class="ident" id="4214554"><a href="/crypto/tls/handshake_server.go.html#4213875">certReq</a></span><span class="op" id="4214561">.</span><span class="ident" id="4214562">marshal</span><span class="op" id="4214569">(</span><span class="op" id="4214570">)</span><span class="op" id="4214571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4214575"><a href="/crypto/tls/handshake_server.go.html#4212703">c</a></span><span class="op" id="4214576">.</span><span class="ident" id="4214577">writeRecord</span><span class="op" id="4214588">(</span><span class="ident" id="4214589"><a href="/crypto/tls/common.go.html#4108718">recordTypeHandshake</a></span><span class="op" id="4214608">,</span>&nbsp;<span class="ident" id="4214610"><a href="/crypto/tls/handshake_server.go.html#4213875">certReq</a></span><span class="op" id="4214617">.</span><span class="ident" id="4214618">marshal</span><span class="op" id="4214625">(</span><span class="op" id="4214626">)</span><span class="op" id="4214627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4214630">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4214634">helloDone</span>&nbsp;<span class="op" id="4214644">:=</span>&nbsp;<span class="builtinfunc" id="4214647">new</span><span class="op" id="4214650">(</span><span class="ident" id="4214651"><a href="/crypto/tls/handshake_messages.go.html#4194114">serverHelloDoneMsg</a></span><span class="op" id="4214669">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4214672"><a href="/crypto/tls/handshake_server.go.html#4212627">hs</a></span><span class="op" id="4214674">.</span><span class="ident" id="4214675">finishedHash</span><span class="op" id="4214687">.</span><span class="ident" id="4214688">Write</span><span class="op" id="4214693">(</span><span class="ident" id="4214694"><a href="/crypto/tls/handshake_server.go.html#4214634">helloDone</a></span><span class="op" id="4214703">.</span><span class="ident" id="4214704">marshal</span><span class="op" id="4214711">(</span><span class="op" id="4214712">)</span><span class="op" id="4214713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4214716"><a href="/crypto/tls/handshake_server.go.html#4212703">c</a></span><span class="op" id="4214717">.</span><span class="ident" id="4214718">writeRecord</span><span class="op" id="4214729">(</span><span class="ident" id="4214730"><a href="/crypto/tls/common.go.html#4108718">recordTypeHandshake</a></span><span class="op" id="4214749">,</span>&nbsp;<span class="ident" id="4214751"><a href="/crypto/tls/handshake_server.go.html#4214634">helloDone</a></span><span class="op" id="4214760">.</span><span class="ident" id="4214761">marshal</span><span class="op" id="4214768">(</span><span class="op" id="4214769">)</span><span class="op" id="4214770">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4214774">var</span>&nbsp;<span class="ident" id="4214778">pub</span>&nbsp;<span class="ident" id="4214782"><a href="/crypto/tls/handshake_server.go.html#4204287">crypto</a></span><span class="op" id="4214788">.</span><span class="ident" id="4214789">PublicKey</span>&nbsp;<span class="comment" id="4214799">//&nbsp;public&nbsp;key&nbsp;for&nbsp;client&nbsp;auth,&nbsp;if&nbsp;any</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4214839">msg</span><span class="op" id="4214842">,</span>&nbsp;<span class="ident" id="4214844"><a href="/crypto/tls/handshake_server.go.html#4213523">err</a></span>&nbsp;<span class="op" id="4214848">:=</span>&nbsp;<span class="ident" id="4214851"><a href="/crypto/tls/handshake_server.go.html#4212703">c</a></span><span class="op" id="4214852">.</span><span class="ident" id="4214853">readHandshake</span><span class="op" id="4214866">(</span><span class="op" id="4214867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4214870">if</span>&nbsp;<span class="ident" id="4214873"><a href="/crypto/tls/handshake_server.go.html#4213523">err</a></span>&nbsp;<span class="op" id="4214877">!=</span>&nbsp;<span class="ident" id="4214880">nil</span>&nbsp;<span class="op" id="4214884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4214888">return</span>&nbsp;<span class="ident" id="4214895"><a href="/crypto/tls/handshake_server.go.html#4213523">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4214900">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4214904">var</span>&nbsp;<span class="ident" id="4214908">ok</span>&nbsp;<span class="builtintype" id="4214911">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4214917">//&nbsp;If&nbsp;we&nbsp;requested&nbsp;a&nbsp;client&nbsp;certificate,&nbsp;then&nbsp;the&nbsp;client&nbsp;must&nbsp;send&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4214987">//&nbsp;certificate&nbsp;message,&nbsp;even&nbsp;if&nbsp;it&#39;s&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4215032">if</span>&nbsp;<span class="ident" id="4215035"><a href="/crypto/tls/handshake_server.go.html#4212680">config</a></span><span class="op" id="4215041">.</span><span class="ident" id="4215042">ClientAuth</span>&nbsp;<span class="op" id="4215053">&gt;=</span>&nbsp;<span class="ident" id="4215056"><a href="/crypto/tls/common.go.html#4113668">RequestClientCert</a></span>&nbsp;<span class="op" id="4215074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4215078">if</span>&nbsp;<span class="ident" id="4215081"><a href="/crypto/tls/handshake_server.go.html#4213044">certMsg</a></span><span class="op" id="4215088">,</span>&nbsp;<span class="ident" id="4215090"><a href="/crypto/tls/handshake_server.go.html#4214908">ok</a></span>&nbsp;<span class="op" id="4215093">=</span>&nbsp;<span class="ident" id="4215095"><a href="/crypto/tls/handshake_server.go.html#4214839">msg</a></span><span class="op" id="4215098">.</span><span class="op" id="4215099">(</span><span class="op" id="4215100">*</span><span class="ident" id="4215101"><a href="/crypto/tls/handshake_messages.go.html#4190456">certificateMsg</a></span><span class="op" id="4215115">)</span><span class="op" id="4215116">;</span>&nbsp;<span class="op" id="4215118">!</span><span class="ident" id="4215119"><a href="/crypto/tls/handshake_server.go.html#4214908">ok</a></span>&nbsp;<span class="op" id="4215122">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4215127"><a href="/crypto/tls/handshake_server.go.html#4212703">c</a></span><span class="op" id="4215128">.</span><span class="ident" id="4215129">sendAlert</span><span class="op" id="4215138">(</span><span class="ident" id="4215139"><a href="/crypto/tls/alert.go.html#4095992">alertUnexpectedMessage</a></span><span class="op" id="4215161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4215166">return</span>&nbsp;<span class="ident" id="4215173"><a href="/crypto/tls/common.go.html#4127007">unexpectedMessageError</a></span><span class="op" id="4215195">(</span><span class="ident" id="4215196"><a href="/crypto/tls/handshake_server.go.html#4213044">certMsg</a></span><span class="op" id="4215203">,</span>&nbsp;<span class="ident" id="4215205"><a href="/crypto/tls/handshake_server.go.html#4214839">msg</a></span><span class="op" id="4215208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4215212">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4215216"><a href="/crypto/tls/handshake_server.go.html#4212627">hs</a></span><span class="op" id="4215218">.</span><span class="ident" id="4215219">finishedHash</span><span class="op" id="4215231">.</span><span class="ident" id="4215232">Write</span><span class="op" id="4215237">(</span><span class="ident" id="4215238"><a href="/crypto/tls/handshake_server.go.html#4213044">certMsg</a></span><span class="op" id="4215245">.</span><span class="ident" id="4215246">marshal</span><span class="op" id="4215253">(</span><span class="op" id="4215254">)</span><span class="op" id="4215255">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4215260">if</span>&nbsp;<span class="builtinfunc" id="4215263">len</span><span class="op" id="4215266">(</span><span class="ident" id="4215267"><a href="/crypto/tls/handshake_server.go.html#4213044">certMsg</a></span><span class="op" id="4215274">.</span><span class="ident" id="4215275">certificates</span><span class="op" id="4215287">)</span>&nbsp;<span class="op" id="4215289">==</span>&nbsp;<span class="num" id="4215292">0</span>&nbsp;<span class="op" id="4215294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4215299">//&nbsp;The&nbsp;client&nbsp;didn&#39;t&nbsp;actually&nbsp;send&nbsp;a&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4215351">switch</span>&nbsp;<span class="ident" id="4215358"><a href="/crypto/tls/handshake_server.go.html#4212680">config</a></span><span class="op" id="4215364">.</span><span class="ident" id="4215365">ClientAuth</span>&nbsp;<span class="op" id="4215376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4215381">case</span>&nbsp;<span class="ident" id="4215386"><a href="/crypto/tls/common.go.html#4113687">RequireAnyClientCert</a></span><span class="op" id="4215406">,</span>&nbsp;<span class="ident" id="4215408"><a href="/crypto/tls/common.go.html#4113734">RequireAndVerifyClientCert</a></span><span class="op" id="4215434">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4215440"><a href="/crypto/tls/handshake_server.go.html#4212703">c</a></span><span class="op" id="4215441">.</span><span class="ident" id="4215442">sendAlert</span><span class="op" id="4215451">(</span><span class="ident" id="4215452"><a href="/crypto/tls/alert.go.html#4096232">alertBadCertificate</a></span><span class="op" id="4215471">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4215477">return</span>&nbsp;<span class="ident" id="4215484"><a href="/crypto/tls/handshake_server.go.html#4204376">errors</a></span><span class="op" id="4215490">.</span><span class="ident" id="4215491">New</span><span class="op" id="4215494">(</span><span class="string" id="4215495">&#34;tls:&nbsp;client&nbsp;didn&#39;t&nbsp;provide&nbsp;a&nbsp;certificate&#34;</span><span class="op" id="4215537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4215542">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4215546">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4215551"><a href="/crypto/tls/handshake_server.go.html#4214778">pub</a></span><span class="op" id="4215554">,</span>&nbsp;<span class="ident" id="4215556"><a href="/crypto/tls/handshake_server.go.html#4213523">err</a></span>&nbsp;<span class="op" id="4215560">=</span>&nbsp;<span class="ident" id="4215562"><a href="/crypto/tls/handshake_server.go.html#4212627">hs</a></span><span class="op" id="4215564">.</span><span class="ident" id="4215565">processCertsFromClient</span><span class="op" id="4215587">(</span><span class="ident" id="4215588"><a href="/crypto/tls/handshake_server.go.html#4213044">certMsg</a></span><span class="op" id="4215595">.</span><span class="ident" id="4215596">certificates</span><span class="op" id="4215608">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4215612">if</span>&nbsp;<span class="ident" id="4215615"><a href="/crypto/tls/handshake_server.go.html#4213523">err</a></span>&nbsp;<span class="op" id="4215619">!=</span>&nbsp;<span class="ident" id="4215622">nil</span>&nbsp;<span class="op" id="4215626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4215631">return</span>&nbsp;<span class="ident" id="4215638"><a href="/crypto/tls/handshake_server.go.html#4213523">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4215644">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4215649"><a href="/crypto/tls/handshake_server.go.html#4214839">msg</a></span><span class="op" id="4215652">,</span>&nbsp;<span class="ident" id="4215654"><a href="/crypto/tls/handshake_server.go.html#4213523">err</a></span>&nbsp;<span class="op" id="4215658">=</span>&nbsp;<span class="ident" id="4215660"><a href="/crypto/tls/handshake_server.go.html#4212703">c</a></span><span class="op" id="4215661">.</span><span class="ident" id="4215662">readHandshake</span><span class="op" id="4215675">(</span><span class="op" id="4215676">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4215680">if</span>&nbsp;<span class="ident" id="4215683"><a href="/crypto/tls/handshake_server.go.html#4213523">err</a></span>&nbsp;<span class="op" id="4215687">!=</span>&nbsp;<span class="ident" id="4215690">nil</span>&nbsp;<span class="op" id="4215694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4215699">return</span>&nbsp;<span class="ident" id="4215706"><a href="/crypto/tls/handshake_server.go.html#4213523">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4215712">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4215715">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4215719">//&nbsp;Get&nbsp;client&nbsp;key&nbsp;exchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4215747">ckx</span><span class="op" id="4215750">,</span>&nbsp;<span class="ident" id="4215752"><a href="/crypto/tls/handshake_server.go.html#4214908">ok</a></span>&nbsp;<span class="op" id="4215755">:=</span>&nbsp;<span class="ident" id="4215758"><a href="/crypto/tls/handshake_server.go.html#4214839">msg</a></span><span class="op" id="4215761">.</span><span class="op" id="4215762">(</span><span class="op" id="4215763">*</span><span class="ident" id="4215764"><a href="/crypto/tls/handshake_messages.go.html#4194449">clientKeyExchangeMsg</a></span><span class="op" id="4215784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4215787">if</span>&nbsp;<span class="op" id="4215790">!</span><span class="ident" id="4215791"><a href="/crypto/tls/handshake_server.go.html#4214908">ok</a></span>&nbsp;<span class="op" id="4215794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4215798"><a href="/crypto/tls/handshake_server.go.html#4212703">c</a></span><span class="op" id="4215799">.</span><span class="ident" id="4215800">sendAlert</span><span class="op" id="4215809">(</span><span class="ident" id="4215810"><a href="/crypto/tls/alert.go.html#4095992">alertUnexpectedMessage</a></span><span class="op" id="4215832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4215836">return</span>&nbsp;<span class="ident" id="4215843"><a href="/crypto/tls/common.go.html#4127007">unexpectedMessageError</a></span><span class="op" id="4215865">(</span><span class="ident" id="4215866"><a href="/crypto/tls/handshake_server.go.html#4215747">ckx</a></span><span class="op" id="4215869">,</span>&nbsp;<span class="ident" id="4215871"><a href="/crypto/tls/handshake_server.go.html#4214839">msg</a></span><span class="op" id="4215874">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4215877">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4215880"><a href="/crypto/tls/handshake_server.go.html#4212627">hs</a></span><span class="op" id="4215882">.</span><span class="ident" id="4215883">finishedHash</span><span class="op" id="4215895">.</span><span class="ident" id="4215896">Write</span><span class="op" id="4215901">(</span><span class="ident" id="4215902"><a href="/crypto/tls/handshake_server.go.html#4215747">ckx</a></span><span class="op" id="4215905">.</span><span class="ident" id="4215906">marshal</span><span class="op" id="4215913">(</span><span class="op" id="4215914">)</span><span class="op" id="4215915">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4215919">//&nbsp;If&nbsp;we&nbsp;received&nbsp;a&nbsp;client&nbsp;cert&nbsp;in&nbsp;response&nbsp;to&nbsp;our&nbsp;certificate&nbsp;request&nbsp;message,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4216000">//&nbsp;the&nbsp;client&nbsp;will&nbsp;send&nbsp;us&nbsp;a&nbsp;certificateVerifyMsg&nbsp;immediately&nbsp;after&nbsp;the</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4216073">//&nbsp;clientKeyExchangeMsg.&nbsp;&nbsp;This&nbsp;message&nbsp;is&nbsp;a&nbsp;digest&nbsp;of&nbsp;all&nbsp;preceding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4216142">//&nbsp;handshake-layer&nbsp;messages&nbsp;that&nbsp;is&nbsp;signed&nbsp;using&nbsp;the&nbsp;private&nbsp;key&nbsp;corresponding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4216222">//&nbsp;to&nbsp;the&nbsp;client&#39;s&nbsp;certificate.&nbsp;This&nbsp;allows&nbsp;us&nbsp;to&nbsp;verify&nbsp;that&nbsp;the&nbsp;client&nbsp;is&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4216302">//&nbsp;possession&nbsp;of&nbsp;the&nbsp;private&nbsp;key&nbsp;of&nbsp;the&nbsp;certificate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4216356">if</span>&nbsp;<span class="builtinfunc" id="4216359">len</span><span class="op" id="4216362">(</span><span class="ident" id="4216363"><a href="/crypto/tls/handshake_server.go.html#4212703">c</a></span><span class="op" id="4216364">.</span><span class="ident" id="4216365">peerCertificates</span><span class="op" id="4216381">)</span>&nbsp;<span class="op" id="4216383">&gt;</span>&nbsp;<span class="num" id="4216385">0</span>&nbsp;<span class="op" id="4216387">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4216391"><a href="/crypto/tls/handshake_server.go.html#4214839">msg</a></span><span class="op" id="4216394">,</span>&nbsp;<span class="ident" id="4216396"><a href="/crypto/tls/handshake_server.go.html#4213523">err</a></span>&nbsp;<span class="op" id="4216400">=</span>&nbsp;<span class="ident" id="4216402"><a href="/crypto/tls/handshake_server.go.html#4212703">c</a></span><span class="op" id="4216403">.</span><span class="ident" id="4216404">readHandshake</span><span class="op" id="4216417">(</span><span class="op" id="4216418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4216422">if</span>&nbsp;<span class="ident" id="4216425"><a href="/crypto/tls/handshake_server.go.html#4213523">err</a></span>&nbsp;<span class="op" id="4216429">!=</span>&nbsp;<span class="ident" id="4216432">nil</span>&nbsp;<span class="op" id="4216436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4216441">return</span>&nbsp;<span class="ident" id="4216448"><a href="/crypto/tls/handshake_server.go.html#4213523">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4216454">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4216458">certVerify</span><span class="op" id="4216468">,</span>&nbsp;<span class="ident" id="4216470">ok</span>&nbsp;<span class="op" id="4216473">:=</span>&nbsp;<span class="ident" id="4216476"><a href="/crypto/tls/handshake_server.go.html#4214839">msg</a></span><span class="op" id="4216479">.</span><span class="op" id="4216480">(</span><span class="op" id="4216481">*</span><span class="ident" id="4216482"><a href="/crypto/tls/handshake_messages.go.html#4200426">certificateVerifyMsg</a></span><span class="op" id="4216502">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4216506">if</span>&nbsp;<span class="op" id="4216509">!</span><span class="ident" id="4216510"><a href="/crypto/tls/handshake_server.go.html#4216470">ok</a></span>&nbsp;<span class="op" id="4216513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4216518"><a href="/crypto/tls/handshake_server.go.html#4212703">c</a></span><span class="op" id="4216519">.</span><span class="ident" id="4216520">sendAlert</span><span class="op" id="4216529">(</span><span class="ident" id="4216530"><a href="/crypto/tls/alert.go.html#4095992">alertUnexpectedMessage</a></span><span class="op" id="4216552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4216557">return</span>&nbsp;<span class="ident" id="4216564"><a href="/crypto/tls/common.go.html#4127007">unexpectedMessageError</a></span><span class="op" id="4216586">(</span><span class="ident" id="4216587"><a href="/crypto/tls/handshake_server.go.html#4216458">certVerify</a></span><span class="op" id="4216597">,</span>&nbsp;<span class="ident" id="4216599"><a href="/crypto/tls/handshake_server.go.html#4214839">msg</a></span><span class="op" id="4216602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4216606">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4216611">switch</span>&nbsp;<span class="ident" id="4216618">key</span>&nbsp;<span class="op" id="4216622">:=</span>&nbsp;<span class="ident" id="4216625"><a href="/crypto/tls/handshake_server.go.html#4214778">pub</a></span><span class="op" id="4216628">.</span><span class="op" id="4216629">(</span><span class="keyword" id="4216630">type</span><span class="op" id="4216634">)</span>&nbsp;<span class="op" id="4216636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4216640">case</span>&nbsp;<span class="op" id="4216645">*</span><span class="ident" id="4216646"><a href="/crypto/tls/handshake_server.go.html#4204297">ecdsa</a></span><span class="op" id="4216651">.</span><span class="ident" id="4216652">PublicKey</span><span class="op" id="4216661">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4216666">ecdsaSig</span>&nbsp;<span class="op" id="4216675">:=</span>&nbsp;<span class="builtinfunc" id="4216678">new</span><span class="op" id="4216681">(</span><span class="ident" id="4216682"><a href="/crypto/tls/common.go.html#4126536">ecdsaSignature</a></span><span class="op" id="4216696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4216701">if</span>&nbsp;<span class="ident" id="4216704">_</span><span class="op" id="4216705">,</span>&nbsp;<span class="ident" id="4216707"><a href="/crypto/tls/handshake_server.go.html#4213523">err</a></span>&nbsp;<span class="op" id="4216711">=</span>&nbsp;<span class="ident" id="4216713"><a href="/crypto/tls/handshake_server.go.html#4204359">asn1</a></span><span class="op" id="4216717">.</span><span class="ident" id="4216718">Unmarshal</span><span class="op" id="4216727">(</span><span class="ident" id="4216728"><a href="/crypto/tls/handshake_server.go.html#4216458">certVerify</a></span><span class="op" id="4216738">.</span><span class="ident" id="4216739">signature</span><span class="op" id="4216748">,</span>&nbsp;<span class="ident" id="4216750"><a href="/crypto/tls/handshake_server.go.html#4216666">ecdsaSig</a></span><span class="op" id="4216758">)</span><span class="op" id="4216759">;</span>&nbsp;<span class="ident" id="4216761"><a href="/crypto/tls/handshake_server.go.html#4213523">err</a></span>&nbsp;<span class="op" id="4216765">!=</span>&nbsp;<span class="ident" id="4216768">nil</span>&nbsp;<span class="op" id="4216772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4216778">break</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4216787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4216792">if</span>&nbsp;<span class="ident" id="4216795"><a href="/crypto/tls/handshake_server.go.html#4216666">ecdsaSig</a></span><span class="op" id="4216803">.</span><span class="ident" id="4216804">R</span><span class="op" id="4216805">.</span><span class="ident" id="4216806">Sign</span><span class="op" id="4216810">(</span><span class="op" id="4216811">)</span>&nbsp;<span class="op" id="4216813">&lt;=</span>&nbsp;<span class="num" id="4216816">0</span>&nbsp;<span class="op" id="4216818">||</span>&nbsp;<span class="ident" id="4216821"><a href="/crypto/tls/handshake_server.go.html#4216666">ecdsaSig</a></span><span class="op" id="4216829">.</span><span class="ident" id="4216830">S</span><span class="op" id="4216831">.</span><span class="ident" id="4216832">Sign</span><span class="op" id="4216836">(</span><span class="op" id="4216837">)</span>&nbsp;<span class="op" id="4216839">&lt;=</span>&nbsp;<span class="num" id="4216842">0</span>&nbsp;<span class="op" id="4216844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4216850"><a href="/crypto/tls/handshake_server.go.html#4213523">err</a></span>&nbsp;<span class="op" id="4216854">=</span>&nbsp;<span class="ident" id="4216856"><a href="/crypto/tls/handshake_server.go.html#4204376">errors</a></span><span class="op" id="4216862">.</span><span class="ident" id="4216863">New</span><span class="op" id="4216866">(</span><span class="string" id="4216867">&#34;ECDSA&nbsp;signature&nbsp;contained&nbsp;zero&nbsp;or&nbsp;negative&nbsp;values&#34;</span><span class="op" id="4216918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4216924">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4216933">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4216938">digest</span><span class="op" id="4216944">,</span>&nbsp;<span class="ident" id="4216946">_</span><span class="op" id="4216947">,</span>&nbsp;<span class="ident" id="4216949">_</span>&nbsp;<span class="op" id="4216951">:=</span>&nbsp;<span class="ident" id="4216954"><a href="/crypto/tls/handshake_server.go.html#4212627">hs</a></span><span class="op" id="4216956">.</span><span class="ident" id="4216957">finishedHash</span><span class="op" id="4216969">.</span><span class="ident" id="4216970">hashForClientCertificate</span><span class="op" id="4216994">(</span><span class="ident" id="4216995"><a href="/crypto/tls/common.go.html#4111314">signatureECDSA</a></span><span class="op" id="4217009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4217014">if</span>&nbsp;<span class="op" id="4217017">!</span><span class="ident" id="4217018"><a href="/crypto/tls/handshake_server.go.html#4204297">ecdsa</a></span><span class="op" id="4217023">.</span><span class="ident" id="4217024">Verify</span><span class="op" id="4217030">(</span><span class="ident" id="4217031"><a href="/crypto/tls/handshake_server.go.html#4216618">key</a></span><span class="op" id="4217034">,</span>&nbsp;<span class="ident" id="4217036"><a href="/crypto/tls/handshake_server.go.html#4216938">digest</a></span><span class="op" id="4217042">,</span>&nbsp;<span class="ident" id="4217044"><a href="/crypto/tls/handshake_server.go.html#4216666">ecdsaSig</a></span><span class="op" id="4217052">.</span><span class="ident" id="4217053">R</span><span class="op" id="4217054">,</span>&nbsp;<span class="ident" id="4217056"><a href="/crypto/tls/handshake_server.go.html#4216666">ecdsaSig</a></span><span class="op" id="4217064">.</span><span class="ident" id="4217065">S</span><span class="op" id="4217066">)</span>&nbsp;<span class="op" id="4217068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4217074"><a href="/crypto/tls/handshake_server.go.html#4213523">err</a></span>&nbsp;<span class="op" id="4217078">=</span>&nbsp;<span class="ident" id="4217080"><a href="/crypto/tls/handshake_server.go.html#4204376">errors</a></span><span class="op" id="4217086">.</span><span class="ident" id="4217087">New</span><span class="op" id="4217090">(</span><span class="string" id="4217091">&#34;ECDSA&nbsp;verification&nbsp;failure&#34;</span><span class="op" id="4217119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4217125">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4217134">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4217138">case</span>&nbsp;<span class="op" id="4217143">*</span><span class="ident" id="4217144"><a href="/crypto/tls/handshake_server.go.html#4204313">rsa</a></span><span class="op" id="4217147">.</span><span class="ident" id="4217148">PublicKey</span><span class="op" id="4217157">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4217162">digest</span><span class="op" id="4217168">,</span>&nbsp;<span class="ident" id="4217170">hashFunc</span><span class="op" id="4217178">,</span>&nbsp;<span class="ident" id="4217180">_</span>&nbsp;<span class="op" id="4217182">:=</span>&nbsp;<span class="ident" id="4217185"><a href="/crypto/tls/handshake_server.go.html#4212627">hs</a></span><span class="op" id="4217187">.</span><span class="ident" id="4217188">finishedHash</span><span class="op" id="4217200">.</span><span class="ident" id="4217201">hashForClientCertificate</span><span class="op" id="4217225">(</span><span class="ident" id="4217226"><a href="/crypto/tls/common.go.html#4111288">signatureRSA</a></span><span class="op" id="4217238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4217243"><a href="/crypto/tls/handshake_server.go.html#4213523">err</a></span>&nbsp;<span class="op" id="4217247">=</span>&nbsp;<span class="ident" id="4217249"><a href="/crypto/tls/handshake_server.go.html#4204313">rsa</a></span><span class="op" id="4217252">.</span><span class="ident" id="4217253">VerifyPKCS1v15</span><span class="op" id="4217267">(</span><span class="ident" id="4217268"><a href="/crypto/tls/handshake_server.go.html#4216618">key</a></span><span class="op" id="4217271">,</span>&nbsp;<span class="ident" id="4217273"><a href="/crypto/tls/handshake_server.go.html#4217170">hashFunc</a></span><span class="op" id="4217281">,</span>&nbsp;<span class="ident" id="4217283"><a href="/crypto/tls/handshake_server.go.html#4217162">digest</a></span><span class="op" id="4217289">,</span>&nbsp;<span class="ident" id="4217291"><a href="/crypto/tls/handshake_server.go.html#4216458">certVerify</a></span><span class="op" id="4217301">.</span><span class="ident" id="4217302">signature</span><span class="op" id="4217311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4217315">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4217319">if</span>&nbsp;<span class="ident" id="4217322"><a href="/crypto/tls/handshake_server.go.html#4213523">err</a></span>&nbsp;<span class="op" id="4217326">!=</span>&nbsp;<span class="ident" id="4217329">nil</span>&nbsp;<span class="op" id="4217333">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4217338"><a href="/crypto/tls/handshake_server.go.html#4212703">c</a></span><span class="op" id="4217339">.</span><span class="ident" id="4217340">sendAlert</span><span class="op" id="4217349">(</span><span class="ident" id="4217350"><a href="/crypto/tls/alert.go.html#4096232">alertBadCertificate</a></span><span class="op" id="4217369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4217374">return</span>&nbsp;<span class="ident" id="4217381"><a href="/crypto/tls/handshake_server.go.html#4204376">errors</a></span><span class="op" id="4217387">.</span><span class="ident" id="4217388">New</span><span class="op" id="4217391">(</span><span class="string" id="4217392">&#34;could&nbsp;not&nbsp;validate&nbsp;signature&nbsp;of&nbsp;connection&nbsp;nonces:&nbsp;&#34;</span>&nbsp;<span class="op" id="4217446">+</span>&nbsp;<span class="ident" id="4217448"><a href="/crypto/tls/handshake_server.go.html#4213523">err</a></span><span class="op" id="4217451">.</span><span class="ident" id="4217452">Error</span><span class="op" id="4217457">(</span><span class="op" id="4217458">)</span><span class="op" id="4217459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4217463">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4217468"><a href="/crypto/tls/handshake_server.go.html#4212627">hs</a></span><span class="op" id="4217470">.</span><span class="ident" id="4217471">finishedHash</span><span class="op" id="4217483">.</span><span class="ident" id="4217484">Write</span><span class="op" id="4217489">(</span><span class="ident" id="4217490"><a href="/crypto/tls/handshake_server.go.html#4216458">certVerify</a></span><span class="op" id="4217500">.</span><span class="ident" id="4217501">marshal</span><span class="op" id="4217508">(</span><span class="op" id="4217509">)</span><span class="op" id="4217510">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4217513">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4217517">preMasterSecret</span><span class="op" id="4217532">,</span>&nbsp;<span class="ident" id="4217534"><a href="/crypto/tls/handshake_server.go.html#4213523">err</a></span>&nbsp;<span class="op" id="4217538">:=</span>&nbsp;<span class="ident" id="4217541"><a href="/crypto/tls/handshake_server.go.html#4213481">keyAgreement</a></span><span class="op" id="4217553">.</span><span class="ident" id="4217554">processClientKeyExchange</span><span class="op" id="4217578">(</span><span class="ident" id="4217579"><a href="/crypto/tls/handshake_server.go.html#4212680">config</a></span><span class="op" id="4217585">,</span>&nbsp;<span class="ident" id="4217587"><a href="/crypto/tls/handshake_server.go.html#4212627">hs</a></span><span class="op" id="4217589">.</span><span class="ident" id="4217590">cert</span><span class="op" id="4217594">,</span>&nbsp;<span class="ident" id="4217596"><a href="/crypto/tls/handshake_server.go.html#4215747">ckx</a></span><span class="op" id="4217599">,</span>&nbsp;<span class="ident" id="4217601"><a href="/crypto/tls/handshake_server.go.html#4212703">c</a></span><span class="op" id="4217602">.</span><span class="ident" id="4217603">vers</span><span class="op" id="4217607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4217610">if</span>&nbsp;<span class="ident" id="4217613"><a href="/crypto/tls/handshake_server.go.html#4213523">err</a></span>&nbsp;<span class="op" id="4217617">!=</span>&nbsp;<span class="ident" id="4217620">nil</span>&nbsp;<span class="op" id="4217624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4217628"><a href="/crypto/tls/handshake_server.go.html#4212703">c</a></span><span class="op" id="4217629">.</span><span class="ident" id="4217630">sendAlert</span><span class="op" id="4217639">(</span><span class="ident" id="4217640"><a href="/crypto/tls/alert.go.html#4096192">alertHandshakeFailure</a></span><span class="op" id="4217661">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4217665">return</span>&nbsp;<span class="ident" id="4217672"><a href="/crypto/tls/handshake_server.go.html#4213523">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4217677">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4217680"><a href="/crypto/tls/handshake_server.go.html#4212627">hs</a></span><span class="op" id="4217682">.</span><span class="ident" id="4217683">masterSecret</span>&nbsp;<span class="op" id="4217696">=</span>&nbsp;<span class="ident" id="4217698"><a href="/crypto/tls/prf.go.html#4239699">masterFromPreMasterSecret</a></span><span class="op" id="4217723">(</span><span class="ident" id="4217724"><a href="/crypto/tls/handshake_server.go.html#4212703">c</a></span><span class="op" id="4217725">.</span><span class="ident" id="4217726">vers</span><span class="op" id="4217730">,</span>&nbsp;<span class="ident" id="4217732"><a href="/crypto/tls/handshake_server.go.html#4217517">preMasterSecret</a></span><span class="op" id="4217747">,</span>&nbsp;<span class="ident" id="4217749"><a href="/crypto/tls/handshake_server.go.html#4212627">hs</a></span><span class="op" id="4217751">.</span><span class="ident" id="4217752">clientHello</span><span class="op" id="4217763">.</span><span class="ident" id="4217764">random</span><span class="op" id="4217770">,</span>&nbsp;<span class="ident" id="4217772"><a href="/crypto/tls/handshake_server.go.html#4212627">hs</a></span><span class="op" id="4217774">.</span><span class="ident" id="4217775">hello</span><span class="op" id="4217780">.</span><span class="ident" id="4217781">random</span><span class="op" id="4217787">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4217791">return</span>&nbsp;<span class="ident" id="4217798">nil</span><br>
<span class="lineno">475</span><span class="op" id="4217802">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4217805">func</span>&nbsp;<span class="op" id="4217810">(</span><span class="ident" id="4217811">hs</span>&nbsp;<span class="op" id="4217814">*</span><span class="ident" id="4217815"><a href="/crypto/tls/handshake_server.go.html#4204534">serverHandshakeState</a></span><span class="op" id="4217835">)</span>&nbsp;<span class="ident" id="4217837">establishKeys</span><span class="op" id="4217850">(</span><span class="op" id="4217851">)</span>&nbsp;<span class="builtintype" id="4217853">error</span>&nbsp;<span class="op" id="4217859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4217862">c</span>&nbsp;<span class="op" id="4217864">:=</span>&nbsp;<span class="ident" id="4217867"><a href="/crypto/tls/handshake_server.go.html#4217811">hs</a></span><span class="op" id="4217869">.</span><span class="ident" id="4217870">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4217874">clientMAC</span><span class="op" id="4217883">,</span>&nbsp;<span class="ident" id="4217885">serverMAC</span><span class="op" id="4217894">,</span>&nbsp;<span class="ident" id="4217896">clientKey</span><span class="op" id="4217905">,</span>&nbsp;<span class="ident" id="4217907">serverKey</span><span class="op" id="4217916">,</span>&nbsp;<span class="ident" id="4217918">clientIV</span><span class="op" id="4217926">,</span>&nbsp;<span class="ident" id="4217928">serverIV</span>&nbsp;<span class="op" id="4217937">:=</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4217942"><a href="/crypto/tls/prf.go.html#4240268">keysFromMasterSecret</a></span><span class="op" id="4217962">(</span><span class="ident" id="4217963"><a href="/crypto/tls/handshake_server.go.html#4217862">c</a></span><span class="op" id="4217964">.</span><span class="ident" id="4217965">vers</span><span class="op" id="4217969">,</span>&nbsp;<span class="ident" id="4217971"><a href="/crypto/tls/handshake_server.go.html#4217811">hs</a></span><span class="op" id="4217973">.</span><span class="ident" id="4217974">masterSecret</span><span class="op" id="4217986">,</span>&nbsp;<span class="ident" id="4217988"><a href="/crypto/tls/handshake_server.go.html#4217811">hs</a></span><span class="op" id="4217990">.</span><span class="ident" id="4217991">clientHello</span><span class="op" id="4218002">.</span><span class="ident" id="4218003">random</span><span class="op" id="4218009">,</span>&nbsp;<span class="ident" id="4218011"><a href="/crypto/tls/handshake_server.go.html#4217811">hs</a></span><span class="op" id="4218013">.</span><span class="ident" id="4218014">hello</span><span class="op" id="4218019">.</span><span class="ident" id="4218020">random</span><span class="op" id="4218026">,</span>&nbsp;<span class="ident" id="4218028"><a href="/crypto/tls/handshake_server.go.html#4217811">hs</a></span><span class="op" id="4218030">.</span><span class="ident" id="4218031">suite</span><span class="op" id="4218036">.</span><span class="ident" id="4218037">macLen</span><span class="op" id="4218043">,</span>&nbsp;<span class="ident" id="4218045"><a href="/crypto/tls/handshake_server.go.html#4217811">hs</a></span><span class="op" id="4218047">.</span><span class="ident" id="4218048">suite</span><span class="op" id="4218053">.</span><span class="ident" id="4218054">keyLen</span><span class="op" id="4218060">,</span>&nbsp;<span class="ident" id="4218062"><a href="/crypto/tls/handshake_server.go.html#4217811">hs</a></span><span class="op" id="4218064">.</span><span class="ident" id="4218065">suite</span><span class="op" id="4218070">.</span><span class="ident" id="4218071">ivLen</span><span class="op" id="4218076">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4218080">var</span>&nbsp;<span class="ident" id="4218084">clientCipher</span><span class="op" id="4218096">,</span>&nbsp;<span class="ident" id="4218098">serverCipher</span>&nbsp;<span class="keyword" id="4218111">interface</span><span class="op" id="4218120">{</span><span class="op" id="4218121">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4218124">var</span>&nbsp;<span class="ident" id="4218128">clientHash</span><span class="op" id="4218138">,</span>&nbsp;<span class="ident" id="4218140">serverHash</span>&nbsp;<span class="ident" id="4218151"><a href="/crypto/tls/cipher_suites.go.html#4103068">macFunction</a></span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4218165">if</span>&nbsp;<span class="ident" id="4218168"><a href="/crypto/tls/handshake_server.go.html#4217811">hs</a></span><span class="op" id="4218170">.</span><span class="ident" id="4218171">suite</span><span class="op" id="4218176">.</span><span class="ident" id="4218177">aead</span>&nbsp;<span class="op" id="4218182">==</span>&nbsp;<span class="ident" id="4218185">nil</span>&nbsp;<span class="op" id="4218189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4218193"><a href="/crypto/tls/handshake_server.go.html#4218084">clientCipher</a></span>&nbsp;<span class="op" id="4218206">=</span>&nbsp;<span class="ident" id="4218208"><a href="/crypto/tls/handshake_server.go.html#4217811">hs</a></span><span class="op" id="4218210">.</span><span class="ident" id="4218211">suite</span><span class="op" id="4218216">.</span><span class="ident" id="4218217">cipher</span><span class="op" id="4218223">(</span><span class="ident" id="4218224"><a href="/crypto/tls/handshake_server.go.html#4217896">clientKey</a></span><span class="op" id="4218233">,</span>&nbsp;<span class="ident" id="4218235"><a href="/crypto/tls/handshake_server.go.html#4217918">clientIV</a></span><span class="op" id="4218243">,</span>&nbsp;<span class="ident" id="4218245">true</span>&nbsp;<span class="comment" id="4218250">/*&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="4218267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4218271"><a href="/crypto/tls/handshake_server.go.html#4218128">clientHash</a></span>&nbsp;<span class="op" id="4218282">=</span>&nbsp;<span class="ident" id="4218284"><a href="/crypto/tls/handshake_server.go.html#4217811">hs</a></span><span class="op" id="4218286">.</span><span class="ident" id="4218287">suite</span><span class="op" id="4218292">.</span><span class="ident" id="4218293">mac</span><span class="op" id="4218296">(</span><span class="ident" id="4218297"><a href="/crypto/tls/handshake_server.go.html#4217862">c</a></span><span class="op" id="4218298">.</span><span class="ident" id="4218299">vers</span><span class="op" id="4218303">,</span>&nbsp;<span class="ident" id="4218305"><a href="/crypto/tls/handshake_server.go.html#4217874">clientMAC</a></span><span class="op" id="4218314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4218318"><a href="/crypto/tls/handshake_server.go.html#4218098">serverCipher</a></span>&nbsp;<span class="op" id="4218331">=</span>&nbsp;<span class="ident" id="4218333"><a href="/crypto/tls/handshake_server.go.html#4217811">hs</a></span><span class="op" id="4218335">.</span><span class="ident" id="4218336">suite</span><span class="op" id="4218341">.</span><span class="ident" id="4218342">cipher</span><span class="op" id="4218348">(</span><span class="ident" id="4218349"><a href="/crypto/tls/handshake_server.go.html#4217907">serverKey</a></span><span class="op" id="4218358">,</span>&nbsp;<span class="ident" id="4218360"><a href="/crypto/tls/handshake_server.go.html#4217928">serverIV</a></span><span class="op" id="4218368">,</span>&nbsp;<span class="ident" id="4218370">false</span>&nbsp;<span class="comment" id="4218376">/*&nbsp;not&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="4218397">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4218401"><a href="/crypto/tls/handshake_server.go.html#4218140">serverHash</a></span>&nbsp;<span class="op" id="4218412">=</span>&nbsp;<span class="ident" id="4218414"><a href="/crypto/tls/handshake_server.go.html#4217811">hs</a></span><span class="op" id="4218416">.</span><span class="ident" id="4218417">suite</span><span class="op" id="4218422">.</span><span class="ident" id="4218423">mac</span><span class="op" id="4218426">(</span><span class="ident" id="4218427"><a href="/crypto/tls/handshake_server.go.html#4217862">c</a></span><span class="op" id="4218428">.</span><span class="ident" id="4218429">vers</span><span class="op" id="4218433">,</span>&nbsp;<span class="ident" id="4218435"><a href="/crypto/tls/handshake_server.go.html#4217885">serverMAC</a></span><span class="op" id="4218444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4218447">}</span>&nbsp;<span class="keyword" id="4218449">else</span>&nbsp;<span class="op" id="4218454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4218458"><a href="/crypto/tls/handshake_server.go.html#4218084">clientCipher</a></span>&nbsp;<span class="op" id="4218471">=</span>&nbsp;<span class="ident" id="4218473"><a href="/crypto/tls/handshake_server.go.html#4217811">hs</a></span><span class="op" id="4218475">.</span><span class="ident" id="4218476">suite</span><span class="op" id="4218481">.</span><span class="ident" id="4218482">aead</span><span class="op" id="4218486">(</span><span class="ident" id="4218487"><a href="/crypto/tls/handshake_server.go.html#4217896">clientKey</a></span><span class="op" id="4218496">,</span>&nbsp;<span class="ident" id="4218498"><a href="/crypto/tls/handshake_server.go.html#4217918">clientIV</a></span><span class="op" id="4218506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4218510"><a href="/crypto/tls/handshake_server.go.html#4218098">serverCipher</a></span>&nbsp;<span class="op" id="4218523">=</span>&nbsp;<span class="ident" id="4218525"><a href="/crypto/tls/handshake_server.go.html#4217811">hs</a></span><span class="op" id="4218527">.</span><span class="ident" id="4218528">suite</span><span class="op" id="4218533">.</span><span class="ident" id="4218534">aead</span><span class="op" id="4218538">(</span><span class="ident" id="4218539"><a href="/crypto/tls/handshake_server.go.html#4217907">serverKey</a></span><span class="op" id="4218548">,</span>&nbsp;<span class="ident" id="4218550"><a href="/crypto/tls/handshake_server.go.html#4217928">serverIV</a></span><span class="op" id="4218558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4218561">}</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4218565"><a href="/crypto/tls/handshake_server.go.html#4217862">c</a></span><span class="op" id="4218566">.</span><span class="ident" id="4218567">in</span><span class="op" id="4218569">.</span><span class="ident" id="4218570">prepareCipherSpec</span><span class="op" id="4218587">(</span><span class="ident" id="4218588"><a href="/crypto/tls/handshake_server.go.html#4217862">c</a></span><span class="op" id="4218589">.</span><span class="ident" id="4218590">vers</span><span class="op" id="4218594">,</span>&nbsp;<span class="ident" id="4218596"><a href="/crypto/tls/handshake_server.go.html#4218084">clientCipher</a></span><span class="op" id="4218608">,</span>&nbsp;<span class="ident" id="4218610"><a href="/crypto/tls/handshake_server.go.html#4218128">clientHash</a></span><span class="op" id="4218620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4218623"><a href="/crypto/tls/handshake_server.go.html#4217862">c</a></span><span class="op" id="4218624">.</span><span class="ident" id="4218625">out</span><span class="op" id="4218628">.</span><span class="ident" id="4218629">prepareCipherSpec</span><span class="op" id="4218646">(</span><span class="ident" id="4218647"><a href="/crypto/tls/handshake_server.go.html#4217862">c</a></span><span class="op" id="4218648">.</span><span class="ident" id="4218649">vers</span><span class="op" id="4218653">,</span>&nbsp;<span class="ident" id="4218655"><a href="/crypto/tls/handshake_server.go.html#4218098">serverCipher</a></span><span class="op" id="4218667">,</span>&nbsp;<span class="ident" id="4218669"><a href="/crypto/tls/handshake_server.go.html#4218140">serverHash</a></span><span class="op" id="4218679">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4218683">return</span>&nbsp;<span class="ident" id="4218690">nil</span><br>
<span class="lineno">500</span><span class="op" id="4218694">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4218697">func</span>&nbsp;<span class="op" id="4218702">(</span><span class="ident" id="4218703">hs</span>&nbsp;<span class="op" id="4218706">*</span><span class="ident" id="4218707"><a href="/crypto/tls/handshake_server.go.html#4204534">serverHandshakeState</a></span><span class="op" id="4218727">)</span>&nbsp;<span class="ident" id="4218729">readFinished</span><span class="op" id="4218741">(</span><span class="ident" id="4218742">out</span>&nbsp;<span class="op" id="4218746">[</span><span class="op" id="4218747">]</span><span class="builtintype" id="4218748">byte</span><span class="op" id="4218752">)</span>&nbsp;<span class="builtintype" id="4218754">error</span>&nbsp;<span class="op" id="4218760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4218763">c</span>&nbsp;<span class="op" id="4218765">:=</span>&nbsp;<span class="ident" id="4218768"><a href="/crypto/tls/handshake_server.go.html#4218703">hs</a></span><span class="op" id="4218770">.</span><span class="ident" id="4218771">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4218775"><a href="/crypto/tls/handshake_server.go.html#4218763">c</a></span><span class="op" id="4218776">.</span><span class="ident" id="4218777">readRecord</span><span class="op" id="4218787">(</span><span class="ident" id="4218788"><a href="/crypto/tls/common.go.html#4108630">recordTypeChangeCipherSpec</a></span><span class="op" id="4218814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4218817">if</span>&nbsp;<span class="ident" id="4218820">err</span>&nbsp;<span class="op" id="4218824">:=</span>&nbsp;<span class="ident" id="4218827"><a href="/crypto/tls/handshake_server.go.html#4218763">c</a></span><span class="op" id="4218828">.</span><span class="ident" id="4218829">in</span><span class="op" id="4218831">.</span><span class="builtintype" id="4218832">error</span><span class="op" id="4218837">(</span><span class="op" id="4218838">)</span><span class="op" id="4218839">;</span>&nbsp;<span class="ident" id="4218841"><a href="/crypto/tls/handshake_server.go.html#4218820">err</a></span>&nbsp;<span class="op" id="4218845">!=</span>&nbsp;<span class="ident" id="4218848">nil</span>&nbsp;<span class="op" id="4218852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4218856">return</span>&nbsp;<span class="ident" id="4218863"><a href="/crypto/tls/handshake_server.go.html#4218820">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4218868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4218872">if</span>&nbsp;<span class="ident" id="4218875"><a href="/crypto/tls/handshake_server.go.html#4218703">hs</a></span><span class="op" id="4218877">.</span><span class="ident" id="4218878">hello</span><span class="op" id="4218883">.</span><span class="ident" id="4218884">nextProtoNeg</span>&nbsp;<span class="op" id="4218897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4218901">msg</span><span class="op" id="4218904">,</span>&nbsp;<span class="ident" id="4218906">err</span>&nbsp;<span class="op" id="4218910">:=</span>&nbsp;<span class="ident" id="4218913"><a href="/crypto/tls/handshake_server.go.html#4218763">c</a></span><span class="op" id="4218914">.</span><span class="ident" id="4218915">readHandshake</span><span class="op" id="4218928">(</span><span class="op" id="4218929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4218933">if</span>&nbsp;<span class="ident" id="4218936"><a href="/crypto/tls/handshake_server.go.html#4218906">err</a></span>&nbsp;<span class="op" id="4218940">!=</span>&nbsp;<span class="ident" id="4218943">nil</span>&nbsp;<span class="op" id="4218947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4218952">return</span>&nbsp;<span class="ident" id="4218959"><a href="/crypto/tls/handshake_server.go.html#4218906">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4218965">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4218969">nextProto</span><span class="op" id="4218978">,</span>&nbsp;<span class="ident" id="4218980">ok</span>&nbsp;<span class="op" id="4218983">:=</span>&nbsp;<span class="ident" id="4218986"><a href="/crypto/tls/handshake_server.go.html#4218901">msg</a></span><span class="op" id="4218989">.</span><span class="op" id="4218990">(</span><span class="op" id="4218991">*</span><span class="ident" id="4218992"><a href="/crypto/tls/handshake_messages.go.html#4195916">nextProtoMsg</a></span><span class="op" id="4219004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4219008">if</span>&nbsp;<span class="op" id="4219011">!</span><span class="ident" id="4219012"><a href="/crypto/tls/handshake_server.go.html#4218980">ok</a></span>&nbsp;<span class="op" id="4219015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4219020"><a href="/crypto/tls/handshake_server.go.html#4218763">c</a></span><span class="op" id="4219021">.</span><span class="ident" id="4219022">sendAlert</span><span class="op" id="4219031">(</span><span class="ident" id="4219032"><a href="/crypto/tls/alert.go.html#4095992">alertUnexpectedMessage</a></span><span class="op" id="4219054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4219059">return</span>&nbsp;<span class="ident" id="4219066"><a href="/crypto/tls/common.go.html#4127007">unexpectedMessageError</a></span><span class="op" id="4219088">(</span><span class="ident" id="4219089"><a href="/crypto/tls/handshake_server.go.html#4218969">nextProto</a></span><span class="op" id="4219098">,</span>&nbsp;<span class="ident" id="4219100"><a href="/crypto/tls/handshake_server.go.html#4218901">msg</a></span><span class="op" id="4219103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4219107">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4219111"><a href="/crypto/tls/handshake_server.go.html#4218703">hs</a></span><span class="op" id="4219113">.</span><span class="ident" id="4219114">finishedHash</span><span class="op" id="4219126">.</span><span class="ident" id="4219127">Write</span><span class="op" id="4219132">(</span><span class="ident" id="4219133"><a href="/crypto/tls/handshake_server.go.html#4218969">nextProto</a></span><span class="op" id="4219142">.</span><span class="ident" id="4219143">marshal</span><span class="op" id="4219150">(</span><span class="op" id="4219151">)</span><span class="op" id="4219152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4219156"><a href="/crypto/tls/handshake_server.go.html#4218763">c</a></span><span class="op" id="4219157">.</span><span class="ident" id="4219158">clientProtocol</span>&nbsp;<span class="op" id="4219173">=</span>&nbsp;<span class="ident" id="4219175"><a href="/crypto/tls/handshake_server.go.html#4218969">nextProto</a></span><span class="op" id="4219184">.</span><span class="ident" id="4219185">proto</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4219192">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4219196">msg</span><span class="op" id="4219199">,</span>&nbsp;<span class="ident" id="4219201">err</span>&nbsp;<span class="op" id="4219205">:=</span>&nbsp;<span class="ident" id="4219208"><a href="/crypto/tls/handshake_server.go.html#4218763">c</a></span><span class="op" id="4219209">.</span><span class="ident" id="4219210">readHandshake</span><span class="op" id="4219223">(</span><span class="op" id="4219224">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4219227">if</span>&nbsp;<span class="ident" id="4219230"><a href="/crypto/tls/handshake_server.go.html#4219201">err</a></span>&nbsp;<span class="op" id="4219234">!=</span>&nbsp;<span class="ident" id="4219237">nil</span>&nbsp;<span class="op" id="4219241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4219245">return</span>&nbsp;<span class="ident" id="4219252"><a href="/crypto/tls/handshake_server.go.html#4219201">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4219257">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4219260">clientFinished</span><span class="op" id="4219274">,</span>&nbsp;<span class="ident" id="4219276">ok</span>&nbsp;<span class="op" id="4219279">:=</span>&nbsp;<span class="ident" id="4219282"><a href="/crypto/tls/handshake_server.go.html#4219196">msg</a></span><span class="op" id="4219285">.</span><span class="op" id="4219286">(</span><span class="op" id="4219287">*</span><span class="ident" id="4219288"><a href="/crypto/tls/handshake_messages.go.html#4195289">finishedMsg</a></span><span class="op" id="4219299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4219302">if</span>&nbsp;<span class="op" id="4219305">!</span><span class="ident" id="4219306"><a href="/crypto/tls/handshake_server.go.html#4219276">ok</a></span>&nbsp;<span class="op" id="4219309">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4219313"><a href="/crypto/tls/handshake_server.go.html#4218763">c</a></span><span class="op" id="4219314">.</span><span class="ident" id="4219315">sendAlert</span><span class="op" id="4219324">(</span><span class="ident" id="4219325"><a href="/crypto/tls/alert.go.html#4095992">alertUnexpectedMessage</a></span><span class="op" id="4219347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4219351">return</span>&nbsp;<span class="ident" id="4219358"><a href="/crypto/tls/common.go.html#4127007">unexpectedMessageError</a></span><span class="op" id="4219380">(</span><span class="ident" id="4219381"><a href="/crypto/tls/handshake_server.go.html#4219260">clientFinished</a></span><span class="op" id="4219395">,</span>&nbsp;<span class="ident" id="4219397"><a href="/crypto/tls/handshake_server.go.html#4219196">msg</a></span><span class="op" id="4219400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4219403">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4219407">verify</span>&nbsp;<span class="op" id="4219414">:=</span>&nbsp;<span class="ident" id="4219417"><a href="/crypto/tls/handshake_server.go.html#4218703">hs</a></span><span class="op" id="4219419">.</span><span class="ident" id="4219420">finishedHash</span><span class="op" id="4219432">.</span><span class="ident" id="4219433">clientSum</span><span class="op" id="4219442">(</span><span class="ident" id="4219443"><a href="/crypto/tls/handshake_server.go.html#4218703">hs</a></span><span class="op" id="4219445">.</span><span class="ident" id="4219446">masterSecret</span><span class="op" id="4219458">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4219461">if</span>&nbsp;<span class="builtinfunc" id="4219464">len</span><span class="op" id="4219467">(</span><span class="ident" id="4219468"><a href="/crypto/tls/handshake_server.go.html#4219407">verify</a></span><span class="op" id="4219474">)</span>&nbsp;<span class="op" id="4219476">!=</span>&nbsp;<span class="builtinfunc" id="4219479">len</span><span class="op" id="4219482">(</span><span class="ident" id="4219483"><a href="/crypto/tls/handshake_server.go.html#4219260">clientFinished</a></span><span class="op" id="4219497">.</span><span class="ident" id="4219498">verifyData</span><span class="op" id="4219508">)</span>&nbsp;<span class="op" id="4219510">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4219515"><a href="/crypto/tls/handshake_server.go.html#4204327">subtle</a></span><span class="op" id="4219521">.</span><span class="ident" id="4219522">ConstantTimeCompare</span><span class="op" id="4219541">(</span><span class="ident" id="4219542"><a href="/crypto/tls/handshake_server.go.html#4219407">verify</a></span><span class="op" id="4219548">,</span>&nbsp;<span class="ident" id="4219550"><a href="/crypto/tls/handshake_server.go.html#4219260">clientFinished</a></span><span class="op" id="4219564">.</span><span class="ident" id="4219565">verifyData</span><span class="op" id="4219575">)</span>&nbsp;<span class="op" id="4219577">!=</span>&nbsp;<span class="num" id="4219580">1</span>&nbsp;<span class="op" id="4219582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4219586"><a href="/crypto/tls/handshake_server.go.html#4218763">c</a></span><span class="op" id="4219587">.</span><span class="ident" id="4219588">sendAlert</span><span class="op" id="4219597">(</span><span class="ident" id="4219598"><a href="/crypto/tls/alert.go.html#4096192">alertHandshakeFailure</a></span><span class="op" id="4219619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4219623">return</span>&nbsp;<span class="ident" id="4219630"><a href="/crypto/tls/handshake_server.go.html#4204376">errors</a></span><span class="op" id="4219636">.</span><span class="ident" id="4219637">New</span><span class="op" id="4219640">(</span><span class="string" id="4219641">&#34;tls:&nbsp;client&#39;s&nbsp;Finished&nbsp;message&nbsp;is&nbsp;incorrect&#34;</span><span class="op" id="4219686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4219689">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4219693"><a href="/crypto/tls/handshake_server.go.html#4218703">hs</a></span><span class="op" id="4219695">.</span><span class="ident" id="4219696">finishedHash</span><span class="op" id="4219708">.</span><span class="ident" id="4219709">Write</span><span class="op" id="4219714">(</span><span class="ident" id="4219715"><a href="/crypto/tls/handshake_server.go.html#4219260">clientFinished</a></span><span class="op" id="4219729">.</span><span class="ident" id="4219730">marshal</span><span class="op" id="4219737">(</span><span class="op" id="4219738">)</span><span class="op" id="4219739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4219742">copy</span><span class="op" id="4219746">(</span><span class="ident" id="4219747"><a href="/crypto/tls/handshake_server.go.html#4218742">out</a></span><span class="op" id="4219750">,</span>&nbsp;<span class="ident" id="4219752"><a href="/crypto/tls/handshake_server.go.html#4219407">verify</a></span><span class="op" id="4219758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4219761">return</span>&nbsp;<span class="ident" id="4219768">nil</span><br>
<span class="lineno"></span><span class="op" id="4219772">}</span><br>
<span class="lineno">545</span><br>
<span class="lineno"></span><span class="keyword" id="4219775">func</span>&nbsp;<span class="op" id="4219780">(</span><span class="ident" id="4219781">hs</span>&nbsp;<span class="op" id="4219784">*</span><span class="ident" id="4219785"><a href="/crypto/tls/handshake_server.go.html#4204534">serverHandshakeState</a></span><span class="op" id="4219805">)</span>&nbsp;<span class="ident" id="4219807">sendSessionTicket</span><span class="op" id="4219824">(</span><span class="op" id="4219825">)</span>&nbsp;<span class="builtintype" id="4219827">error</span>&nbsp;<span class="op" id="4219833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4219836">if</span>&nbsp;<span class="op" id="4219839">!</span><span class="ident" id="4219840"><a href="/crypto/tls/handshake_server.go.html#4219781">hs</a></span><span class="op" id="4219842">.</span><span class="ident" id="4219843">hello</span><span class="op" id="4219848">.</span><span class="ident" id="4219849">ticketSupported</span>&nbsp;<span class="op" id="4219865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4219869">return</span>&nbsp;<span class="ident" id="4219876">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4219881">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4219885">c</span>&nbsp;<span class="op" id="4219887">:=</span>&nbsp;<span class="ident" id="4219890"><a href="/crypto/tls/handshake_server.go.html#4219781">hs</a></span><span class="op" id="4219892">.</span><span class="ident" id="4219893">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4219896">m</span>&nbsp;<span class="op" id="4219898">:=</span>&nbsp;<span class="builtinfunc" id="4219901">new</span><span class="op" id="4219904">(</span><span class="ident" id="4219905"><a href="/crypto/tls/handshake_messages.go.html#4202153">newSessionTicketMsg</a></span><span class="op" id="4219924">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4219928">var</span>&nbsp;<span class="ident" id="4219932">err</span>&nbsp;<span class="builtintype" id="4219936">error</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4219943">state</span>&nbsp;<span class="op" id="4219949">:=</span>&nbsp;<span class="ident" id="4219952"><a href="/crypto/tls/ticket.go.html#4245080">sessionState</a></span><span class="op" id="4219964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4219968">vers</span><span class="op" id="4219972">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219982"><a href="/crypto/tls/handshake_server.go.html#4219885">c</a></span><span class="op" id="4219983">.</span><span class="ident" id="4219984">vers</span><span class="op" id="4219988">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4219992">cipherSuite</span><span class="op" id="4220003">:</span>&nbsp;&nbsp;<span class="ident" id="4220006"><a href="/crypto/tls/handshake_server.go.html#4219781">hs</a></span><span class="op" id="4220008">.</span><span class="ident" id="4220009">suite</span><span class="op" id="4220014">.</span><span class="ident" id="4220015">id</span><span class="op" id="4220017">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4220021">masterSecret</span><span class="op" id="4220033">:</span>&nbsp;<span class="ident" id="4220035"><a href="/crypto/tls/handshake_server.go.html#4219781">hs</a></span><span class="op" id="4220037">.</span><span class="ident" id="4220038">masterSecret</span><span class="op" id="4220050">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4220054">certificates</span><span class="op" id="4220066">:</span>&nbsp;<span class="ident" id="4220068"><a href="/crypto/tls/handshake_server.go.html#4219781">hs</a></span><span class="op" id="4220070">.</span><span class="ident" id="4220071">certsFromClient</span><span class="op" id="4220086">,</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4220089">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4220092"><a href="/crypto/tls/handshake_server.go.html#4219896">m</a></span><span class="op" id="4220093">.</span><span class="ident" id="4220094">ticket</span><span class="op" id="4220100">,</span>&nbsp;<span class="ident" id="4220102"><a href="/crypto/tls/handshake_server.go.html#4219932">err</a></span>&nbsp;<span class="op" id="4220106">=</span>&nbsp;<span class="ident" id="4220108"><a href="/crypto/tls/handshake_server.go.html#4219885">c</a></span><span class="op" id="4220109">.</span><span class="ident" id="4220110">encryptTicket</span><span class="op" id="4220123">(</span><span class="op" id="4220124">&amp;</span><span class="ident" id="4220125"><a href="/crypto/tls/handshake_server.go.html#4219943">state</a></span><span class="op" id="4220130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4220133">if</span>&nbsp;<span class="ident" id="4220136"><a href="/crypto/tls/handshake_server.go.html#4219932">err</a></span>&nbsp;<span class="op" id="4220140">!=</span>&nbsp;<span class="ident" id="4220143">nil</span>&nbsp;<span class="op" id="4220147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4220151">return</span>&nbsp;<span class="ident" id="4220158"><a href="/crypto/tls/handshake_server.go.html#4219932">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4220163">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4220167"><a href="/crypto/tls/handshake_server.go.html#4219781">hs</a></span><span class="op" id="4220169">.</span><span class="ident" id="4220170">finishedHash</span><span class="op" id="4220182">.</span><span class="ident" id="4220183">Write</span><span class="op" id="4220188">(</span><span class="ident" id="4220189"><a href="/crypto/tls/handshake_server.go.html#4219896">m</a></span><span class="op" id="4220190">.</span><span class="ident" id="4220191">marshal</span><span class="op" id="4220198">(</span><span class="op" id="4220199">)</span><span class="op" id="4220200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4220203"><a href="/crypto/tls/handshake_server.go.html#4219885">c</a></span><span class="op" id="4220204">.</span><span class="ident" id="4220205">writeRecord</span><span class="op" id="4220216">(</span><span class="ident" id="4220217"><a href="/crypto/tls/common.go.html#4108718">recordTypeHandshake</a></span><span class="op" id="4220236">,</span>&nbsp;<span class="ident" id="4220238"><a href="/crypto/tls/handshake_server.go.html#4219896">m</a></span><span class="op" id="4220239">.</span><span class="ident" id="4220240">marshal</span><span class="op" id="4220247">(</span><span class="op" id="4220248">)</span><span class="op" id="4220249">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4220253">return</span>&nbsp;<span class="ident" id="4220260">nil</span><br>
<span class="lineno">570</span><span class="op" id="4220264">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4220267">func</span>&nbsp;<span class="op" id="4220272">(</span><span class="ident" id="4220273">hs</span>&nbsp;<span class="op" id="4220276">*</span><span class="ident" id="4220277"><a href="/crypto/tls/handshake_server.go.html#4204534">serverHandshakeState</a></span><span class="op" id="4220297">)</span>&nbsp;<span class="ident" id="4220299">sendFinished</span><span class="op" id="4220311">(</span><span class="ident" id="4220312">out</span>&nbsp;<span class="op" id="4220316">[</span><span class="op" id="4220317">]</span><span class="builtintype" id="4220318">byte</span><span class="op" id="4220322">)</span>&nbsp;<span class="builtintype" id="4220324">error</span>&nbsp;<span class="op" id="4220330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4220333">c</span>&nbsp;<span class="op" id="4220335">:=</span>&nbsp;<span class="ident" id="4220338"><a href="/crypto/tls/handshake_server.go.html#4220273">hs</a></span><span class="op" id="4220340">.</span><span class="ident" id="4220341">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4220345"><a href="/crypto/tls/handshake_server.go.html#4220333">c</a></span><span class="op" id="4220346">.</span><span class="ident" id="4220347">writeRecord</span><span class="op" id="4220358">(</span><span class="ident" id="4220359"><a href="/crypto/tls/common.go.html#4108630">recordTypeChangeCipherSpec</a></span><span class="op" id="4220385">,</span>&nbsp;<span class="op" id="4220387">[</span><span class="op" id="4220388">]</span><span class="builtintype" id="4220389">byte</span><span class="op" id="4220393">{</span><span class="num" id="4220394">1</span><span class="op" id="4220395">}</span><span class="op" id="4220396">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4220400">finished</span>&nbsp;<span class="op" id="4220409">:=</span>&nbsp;<span class="builtinfunc" id="4220412">new</span><span class="op" id="4220415">(</span><span class="ident" id="4220416"><a href="/crypto/tls/handshake_messages.go.html#4195289">finishedMsg</a></span><span class="op" id="4220427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4220430"><a href="/crypto/tls/handshake_server.go.html#4220400">finished</a></span><span class="op" id="4220438">.</span><span class="ident" id="4220439">verifyData</span>&nbsp;<span class="op" id="4220450">=</span>&nbsp;<span class="ident" id="4220452"><a href="/crypto/tls/handshake_server.go.html#4220273">hs</a></span><span class="op" id="4220454">.</span><span class="ident" id="4220455">finishedHash</span><span class="op" id="4220467">.</span><span class="ident" id="4220468">serverSum</span><span class="op" id="4220477">(</span><span class="ident" id="4220478"><a href="/crypto/tls/handshake_server.go.html#4220273">hs</a></span><span class="op" id="4220480">.</span><span class="ident" id="4220481">masterSecret</span><span class="op" id="4220493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4220496"><a href="/crypto/tls/handshake_server.go.html#4220273">hs</a></span><span class="op" id="4220498">.</span><span class="ident" id="4220499">finishedHash</span><span class="op" id="4220511">.</span><span class="ident" id="4220512">Write</span><span class="op" id="4220517">(</span><span class="ident" id="4220518"><a href="/crypto/tls/handshake_server.go.html#4220400">finished</a></span><span class="op" id="4220526">.</span><span class="ident" id="4220527">marshal</span><span class="op" id="4220534">(</span><span class="op" id="4220535">)</span><span class="op" id="4220536">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4220539"><a href="/crypto/tls/handshake_server.go.html#4220333">c</a></span><span class="op" id="4220540">.</span><span class="ident" id="4220541">writeRecord</span><span class="op" id="4220552">(</span><span class="ident" id="4220553"><a href="/crypto/tls/common.go.html#4108718">recordTypeHandshake</a></span><span class="op" id="4220572">,</span>&nbsp;<span class="ident" id="4220574"><a href="/crypto/tls/handshake_server.go.html#4220400">finished</a></span><span class="op" id="4220582">.</span><span class="ident" id="4220583">marshal</span><span class="op" id="4220590">(</span><span class="op" id="4220591">)</span><span class="op" id="4220592">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4220596"><a href="/crypto/tls/handshake_server.go.html#4220333">c</a></span><span class="op" id="4220597">.</span><span class="ident" id="4220598">cipherSuite</span>&nbsp;<span class="op" id="4220610">=</span>&nbsp;<span class="ident" id="4220612"><a href="/crypto/tls/handshake_server.go.html#4220273">hs</a></span><span class="op" id="4220614">.</span><span class="ident" id="4220615">suite</span><span class="op" id="4220620">.</span><span class="ident" id="4220621">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4220625">copy</span><span class="op" id="4220629">(</span><span class="ident" id="4220630"><a href="/crypto/tls/handshake_server.go.html#4220312">out</a></span><span class="op" id="4220633">,</span>&nbsp;<span class="ident" id="4220635"><a href="/crypto/tls/handshake_server.go.html#4220400">finished</a></span><span class="op" id="4220643">.</span><span class="ident" id="4220644">verifyData</span><span class="op" id="4220654">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4220658">return</span>&nbsp;<span class="ident" id="4220665">nil</span><br>
<span class="lineno"></span><span class="op" id="4220669">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4220672">//&nbsp;processCertsFromClient&nbsp;takes&nbsp;a&nbsp;chain&nbsp;of&nbsp;client&nbsp;certificates&nbsp;either&nbsp;from&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4220749">//&nbsp;Certificates&nbsp;message&nbsp;or&nbsp;from&nbsp;a&nbsp;sessionState&nbsp;and&nbsp;verifies&nbsp;them.&nbsp;It&nbsp;returns</span><br>
<span class="lineno">590</span><span class="comment" id="4220826">//&nbsp;the&nbsp;public&nbsp;key&nbsp;of&nbsp;the&nbsp;leaf&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="4220869">func</span>&nbsp;<span class="op" id="4220874">(</span><span class="ident" id="4220875">hs</span>&nbsp;<span class="op" id="4220878">*</span><span class="ident" id="4220879"><a href="/crypto/tls/handshake_server.go.html#4204534">serverHandshakeState</a></span><span class="op" id="4220899">)</span>&nbsp;<span class="ident" id="4220901">processCertsFromClient</span><span class="op" id="4220923">(</span><span class="ident" id="4220924">certificates</span>&nbsp;<span class="op" id="4220937">[</span><span class="op" id="4220938">]</span><span class="op" id="4220939">[</span><span class="op" id="4220940">]</span><span class="builtintype" id="4220941">byte</span><span class="op" id="4220945">)</span>&nbsp;<span class="op" id="4220947">(</span><span class="ident" id="4220948"><a href="/crypto/tls/handshake_server.go.html#4204287">crypto</a></span><span class="op" id="4220954">.</span><span class="ident" id="4220955">PublicKey</span><span class="op" id="4220964">,</span>&nbsp;<span class="builtintype" id="4220966">error</span><span class="op" id="4220971">)</span>&nbsp;<span class="op" id="4220973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4220976">c</span>&nbsp;<span class="op" id="4220978">:=</span>&nbsp;<span class="ident" id="4220981"><a href="/crypto/tls/handshake_server.go.html#4220875">hs</a></span><span class="op" id="4220983">.</span><span class="ident" id="4220984">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4220988"><a href="/crypto/tls/handshake_server.go.html#4220875">hs</a></span><span class="op" id="4220990">.</span><span class="ident" id="4220991">certsFromClient</span>&nbsp;<span class="op" id="4221007">=</span>&nbsp;<span class="ident" id="4221009"><a href="/crypto/tls/handshake_server.go.html#4220924">certificates</a></span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4221023">certs</span>&nbsp;<span class="op" id="4221029">:=</span>&nbsp;<span class="builtinfunc" id="4221032">make</span><span class="op" id="4221036">(</span><span class="op" id="4221037">[</span><span class="op" id="4221038">]</span><span class="op" id="4221039">*</span><span class="ident" id="4221040"><a href="/crypto/tls/handshake_server.go.html#4204344">x509</a></span><span class="op" id="4221044">.</span><span class="ident" id="4221045">Certificate</span><span class="op" id="4221056">,</span>&nbsp;<span class="builtinfunc" id="4221058">len</span><span class="op" id="4221061">(</span><span class="ident" id="4221062"><a href="/crypto/tls/handshake_server.go.html#4220924">certificates</a></span><span class="op" id="4221074">)</span><span class="op" id="4221075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4221078">var</span>&nbsp;<span class="ident" id="4221082">err</span>&nbsp;<span class="builtintype" id="4221086">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4221093">for</span>&nbsp;<span class="ident" id="4221097">i</span><span class="op" id="4221098">,</span>&nbsp;<span class="ident" id="4221100">asn1Data</span>&nbsp;<span class="op" id="4221109">:=</span>&nbsp;<span class="keyword" id="4221112">range</span>&nbsp;<span class="ident" id="4221118"><a href="/crypto/tls/handshake_server.go.html#4220924">certificates</a></span>&nbsp;<span class="op" id="4221131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4221135">if</span>&nbsp;<span class="ident" id="4221138"><a href="/crypto/tls/handshake_server.go.html#4221023">certs</a></span><span class="op" id="4221143">[</span><span class="ident" id="4221144"><a href="/crypto/tls/handshake_server.go.html#4221097">i</a></span><span class="op" id="4221145">]</span><span class="op" id="4221146">,</span>&nbsp;<span class="ident" id="4221148"><a href="/crypto/tls/handshake_server.go.html#4221082">err</a></span>&nbsp;<span class="op" id="4221152">=</span>&nbsp;<span class="ident" id="4221154"><a href="/crypto/tls/handshake_server.go.html#4204344">x509</a></span><span class="op" id="4221158">.</span><span class="ident" id="4221159">ParseCertificate</span><span class="op" id="4221175">(</span><span class="ident" id="4221176"><a href="/crypto/tls/handshake_server.go.html#4221100">asn1Data</a></span><span class="op" id="4221184">)</span><span class="op" id="4221185">;</span>&nbsp;<span class="ident" id="4221187"><a href="/crypto/tls/handshake_server.go.html#4221082">err</a></span>&nbsp;<span class="op" id="4221191">!=</span>&nbsp;<span class="ident" id="4221194">nil</span>&nbsp;<span class="op" id="4221198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4221203"><a href="/crypto/tls/handshake_server.go.html#4220976">c</a></span><span class="op" id="4221204">.</span><span class="ident" id="4221205">sendAlert</span><span class="op" id="4221214">(</span><span class="ident" id="4221215"><a href="/crypto/tls/alert.go.html#4096232">alertBadCertificate</a></span><span class="op" id="4221234">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4221239">return</span>&nbsp;<span class="ident" id="4221246">nil</span><span class="op" id="4221249">,</span>&nbsp;<span class="ident" id="4221251"><a href="/crypto/tls/handshake_server.go.html#4204376">errors</a></span><span class="op" id="4221257">.</span><span class="ident" id="4221258">New</span><span class="op" id="4221261">(</span><span class="string" id="4221262">&#34;tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;client&nbsp;certificate:&nbsp;&#34;</span>&nbsp;<span class="op" id="4221306">+</span>&nbsp;<span class="ident" id="4221308"><a href="/crypto/tls/handshake_server.go.html#4221082">err</a></span><span class="op" id="4221311">.</span><span class="ident" id="4221312">Error</span><span class="op" id="4221317">(</span><span class="op" id="4221318">)</span><span class="op" id="4221319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4221323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4221326">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4221330">if</span>&nbsp;<span class="ident" id="4221333"><a href="/crypto/tls/handshake_server.go.html#4220976">c</a></span><span class="op" id="4221334">.</span><span class="ident" id="4221335">config</span><span class="op" id="4221341">.</span><span class="ident" id="4221342">ClientAuth</span>&nbsp;<span class="op" id="4221353">&gt;=</span>&nbsp;<span class="ident" id="4221356"><a href="/crypto/tls/common.go.html#4113709">VerifyClientCertIfGiven</a></span>&nbsp;<span class="op" id="4221380">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4221383">len</span><span class="op" id="4221386">(</span><span class="ident" id="4221387"><a href="/crypto/tls/handshake_server.go.html#4221023">certs</a></span><span class="op" id="4221392">)</span>&nbsp;<span class="op" id="4221394">&gt;</span>&nbsp;<span class="num" id="4221396">0</span>&nbsp;<span class="op" id="4221398">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4221402">opts</span>&nbsp;<span class="op" id="4221407">:=</span>&nbsp;<span class="ident" id="4221410"><a href="/crypto/tls/handshake_server.go.html#4204344">x509</a></span><span class="op" id="4221414">.</span><span class="ident" id="4221415">VerifyOptions</span><span class="op" id="4221428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4221433">Roots</span><span class="op" id="4221438">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4221448"><a href="/crypto/tls/handshake_server.go.html#4220976">c</a></span><span class="op" id="4221449">.</span><span class="ident" id="4221450">config</span><span class="op" id="4221456">.</span><span class="ident" id="4221457">ClientCAs</span><span class="op" id="4221466">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4221471">CurrentTime</span><span class="op" id="4221482">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4221486"><a href="/crypto/tls/handshake_server.go.html#4220976">c</a></span><span class="op" id="4221487">.</span><span class="ident" id="4221488">config</span><span class="op" id="4221494">.</span><span class="ident" id="4221495">time</span><span class="op" id="4221499">(</span><span class="op" id="4221500">)</span><span class="op" id="4221501">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4221506">Intermediates</span><span class="op" id="4221519">:</span>&nbsp;<span class="ident" id="4221521"><a href="/crypto/tls/handshake_server.go.html#4204344">x509</a></span><span class="op" id="4221525">.</span><span class="ident" id="4221526">NewCertPool</span><span class="op" id="4221537">(</span><span class="op" id="4221538">)</span><span class="op" id="4221539">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4221544">KeyUsages</span><span class="op" id="4221553">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4221559">[</span><span class="op" id="4221560">]</span><span class="ident" id="4221561"><a href="/crypto/tls/handshake_server.go.html#4204344">x509</a></span><span class="op" id="4221565">.</span><span class="ident" id="4221566">ExtKeyUsage</span><span class="op" id="4221577">{</span><span class="ident" id="4221578"><a href="/crypto/tls/handshake_server.go.html#4204344">x509</a></span><span class="op" id="4221582">.</span><span class="ident" id="4221583">ExtKeyUsageClientAuth</span><span class="op" id="4221604">}</span><span class="op" id="4221605">,</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4221609">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4221614">for</span>&nbsp;<span class="ident" id="4221618">_</span><span class="op" id="4221619">,</span>&nbsp;<span class="ident" id="4221621">cert</span>&nbsp;<span class="op" id="4221626">:=</span>&nbsp;<span class="keyword" id="4221629">range</span>&nbsp;<span class="ident" id="4221635"><a href="/crypto/tls/handshake_server.go.html#4221023">certs</a></span><span class="op" id="4221640">[</span><span class="num" id="4221641">1</span><span class="op" id="4221642">:</span><span class="op" id="4221643">]</span>&nbsp;<span class="op" id="4221645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4221650"><a href="/crypto/tls/handshake_server.go.html#4221402">opts</a></span><span class="op" id="4221654">.</span><span class="ident" id="4221655">Intermediates</span><span class="op" id="4221668">.</span><span class="ident" id="4221669">AddCert</span><span class="op" id="4221676">(</span><span class="ident" id="4221677"><a href="/crypto/tls/handshake_server.go.html#4221621">cert</a></span><span class="op" id="4221681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4221685">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4221690">chains</span><span class="op" id="4221696">,</span>&nbsp;<span class="ident" id="4221698">err</span>&nbsp;<span class="op" id="4221702">:=</span>&nbsp;<span class="ident" id="4221705"><a href="/crypto/tls/handshake_server.go.html#4221023">certs</a></span><span class="op" id="4221710">[</span><span class="num" id="4221711">0</span><span class="op" id="4221712">]</span><span class="op" id="4221713">.</span><span class="ident" id="4221714">Verify</span><span class="op" id="4221720">(</span><span class="ident" id="4221721"><a href="/crypto/tls/handshake_server.go.html#4221402">opts</a></span><span class="op" id="4221725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4221729">if</span>&nbsp;<span class="ident" id="4221732"><a href="/crypto/tls/handshake_server.go.html#4221698">err</a></span>&nbsp;<span class="op" id="4221736">!=</span>&nbsp;<span class="ident" id="4221739">nil</span>&nbsp;<span class="op" id="4221743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4221748"><a href="/crypto/tls/handshake_server.go.html#4220976">c</a></span><span class="op" id="4221749">.</span><span class="ident" id="4221750">sendAlert</span><span class="op" id="4221759">(</span><span class="ident" id="4221760"><a href="/crypto/tls/alert.go.html#4096232">alertBadCertificate</a></span><span class="op" id="4221779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4221784">return</span>&nbsp;<span class="ident" id="4221791">nil</span><span class="op" id="4221794">,</span>&nbsp;<span class="ident" id="4221796"><a href="/crypto/tls/handshake_server.go.html#4204376">errors</a></span><span class="op" id="4221802">.</span><span class="ident" id="4221803">New</span><span class="op" id="4221806">(</span><span class="string" id="4221807">&#34;tls:&nbsp;failed&nbsp;to&nbsp;verify&nbsp;client&#39;s&nbsp;certificate:&nbsp;&#34;</span>&nbsp;<span class="op" id="4221854">+</span>&nbsp;<span class="ident" id="4221856"><a href="/crypto/tls/handshake_server.go.html#4221698">err</a></span><span class="op" id="4221859">.</span><span class="ident" id="4221860">Error</span><span class="op" id="4221865">(</span><span class="op" id="4221866">)</span><span class="op" id="4221867">)</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4221871">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4221876">ok</span>&nbsp;<span class="op" id="4221879">:=</span>&nbsp;<span class="ident" id="4221882">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4221890">for</span>&nbsp;<span class="ident" id="4221894">_</span><span class="op" id="4221895">,</span>&nbsp;<span class="ident" id="4221897">ku</span>&nbsp;<span class="op" id="4221900">:=</span>&nbsp;<span class="keyword" id="4221903">range</span>&nbsp;<span class="ident" id="4221909"><a href="/crypto/tls/handshake_server.go.html#4221023">certs</a></span><span class="op" id="4221914">[</span><span class="num" id="4221915">0</span><span class="op" id="4221916">]</span><span class="op" id="4221917">.</span><span class="ident" id="4221918">ExtKeyUsage</span>&nbsp;<span class="op" id="4221930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4221935">if</span>&nbsp;<span class="ident" id="4221938"><a href="/crypto/tls/handshake_server.go.html#4221897">ku</a></span>&nbsp;<span class="op" id="4221941">==</span>&nbsp;<span class="ident" id="4221944"><a href="/crypto/tls/handshake_server.go.html#4204344">x509</a></span><span class="op" id="4221948">.</span><span class="ident" id="4221949">ExtKeyUsageClientAuth</span>&nbsp;<span class="op" id="4221971">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4221977"><a href="/crypto/tls/handshake_server.go.html#4221876">ok</a></span>&nbsp;<span class="op" id="4221980">=</span>&nbsp;<span class="ident" id="4221982">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4221991">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4222000">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4222004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4222008">if</span>&nbsp;<span class="op" id="4222011">!</span><span class="ident" id="4222012"><a href="/crypto/tls/handshake_server.go.html#4221876">ok</a></span>&nbsp;<span class="op" id="4222015">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4222020"><a href="/crypto/tls/handshake_server.go.html#4220976">c</a></span><span class="op" id="4222021">.</span><span class="ident" id="4222022">sendAlert</span><span class="op" id="4222031">(</span><span class="ident" id="4222032"><a href="/crypto/tls/alert.go.html#4096192">alertHandshakeFailure</a></span><span class="op" id="4222053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4222058">return</span>&nbsp;<span class="ident" id="4222065">nil</span><span class="op" id="4222068">,</span>&nbsp;<span class="ident" id="4222070"><a href="/crypto/tls/handshake_server.go.html#4204376">errors</a></span><span class="op" id="4222076">.</span><span class="ident" id="4222077">New</span><span class="op" id="4222080">(</span><span class="string" id="4222081">&#34;tls:&nbsp;client&#39;s&nbsp;certificate&#39;s&nbsp;extended&nbsp;key&nbsp;usage&nbsp;doesn&#39;t&nbsp;permit&nbsp;it&nbsp;to&nbsp;be&nbsp;used&nbsp;for&nbsp;client&nbsp;authentication&#34;</span><span class="op" id="4222184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4222188">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4222193"><a href="/crypto/tls/handshake_server.go.html#4220976">c</a></span><span class="op" id="4222194">.</span><span class="ident" id="4222195">verifiedChains</span>&nbsp;<span class="op" id="4222210">=</span>&nbsp;<span class="ident" id="4222212"><a href="/crypto/tls/handshake_server.go.html#4221690">chains</a></span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4222220">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4222224">if</span>&nbsp;<span class="builtinfunc" id="4222227">len</span><span class="op" id="4222230">(</span><span class="ident" id="4222231"><a href="/crypto/tls/handshake_server.go.html#4221023">certs</a></span><span class="op" id="4222236">)</span>&nbsp;<span class="op" id="4222238">&gt;</span>&nbsp;<span class="num" id="4222240">0</span>&nbsp;<span class="op" id="4222242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4222246">var</span>&nbsp;<span class="ident" id="4222250">pub</span>&nbsp;<span class="ident" id="4222254"><a href="/crypto/tls/handshake_server.go.html#4204287">crypto</a></span><span class="op" id="4222260">.</span><span class="ident" id="4222261">PublicKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4222273">switch</span>&nbsp;<span class="ident" id="4222280">key</span>&nbsp;<span class="op" id="4222284">:=</span>&nbsp;<span class="ident" id="4222287"><a href="/crypto/tls/handshake_server.go.html#4221023">certs</a></span><span class="op" id="4222292">[</span><span class="num" id="4222293">0</span><span class="op" id="4222294">]</span><span class="op" id="4222295">.</span><span class="ident" id="4222296">PublicKey</span><span class="op" id="4222305">.</span><span class="op" id="4222306">(</span><span class="keyword" id="4222307">type</span><span class="op" id="4222311">)</span>&nbsp;<span class="op" id="4222313">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4222317">case</span>&nbsp;<span class="op" id="4222322">*</span><span class="ident" id="4222323"><a href="/crypto/tls/handshake_server.go.html#4204297">ecdsa</a></span><span class="op" id="4222328">.</span><span class="ident" id="4222329">PublicKey</span><span class="op" id="4222338">,</span>&nbsp;<span class="op" id="4222340">*</span><span class="ident" id="4222341"><a href="/crypto/tls/handshake_server.go.html#4204313">rsa</a></span><span class="op" id="4222344">.</span><span class="ident" id="4222345">PublicKey</span><span class="op" id="4222354">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4222359"><a href="/crypto/tls/handshake_server.go.html#4222250">pub</a></span>&nbsp;<span class="op" id="4222363">=</span>&nbsp;<span class="ident" id="4222365"><a href="/crypto/tls/handshake_server.go.html#4222280">key</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4222371">default</span><span class="op" id="4222378">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4222383"><a href="/crypto/tls/handshake_server.go.html#4220976">c</a></span><span class="op" id="4222384">.</span><span class="ident" id="4222385">sendAlert</span><span class="op" id="4222394">(</span><span class="ident" id="4222395"><a href="/crypto/tls/alert.go.html#4096272">alertUnsupportedCertificate</a></span><span class="op" id="4222422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4222427">return</span>&nbsp;<span class="ident" id="4222434">nil</span><span class="op" id="4222437">,</span>&nbsp;<span class="ident" id="4222439"><a href="/crypto/tls/handshake_server.go.html#4204386">fmt</a></span><span class="op" id="4222442">.</span><span class="ident" id="4222443">Errorf</span><span class="op" id="4222449">(</span><span class="string" id="4222450">&#34;tls:&nbsp;client&#39;s&nbsp;certificate&nbsp;contains&nbsp;an&nbsp;unsupported&nbsp;public&nbsp;key&nbsp;of&nbsp;type&nbsp;%T&#34;</span><span class="op" id="4222523">,</span>&nbsp;<span class="ident" id="4222525"><a href="/crypto/tls/handshake_server.go.html#4221023">certs</a></span><span class="op" id="4222530">[</span><span class="num" id="4222531">0</span><span class="op" id="4222532">]</span><span class="op" id="4222533">.</span><span class="ident" id="4222534">PublicKey</span><span class="op" id="4222543">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4222547">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4222551"><a href="/crypto/tls/handshake_server.go.html#4220976">c</a></span><span class="op" id="4222552">.</span><span class="ident" id="4222553">peerCertificates</span>&nbsp;<span class="op" id="4222570">=</span>&nbsp;<span class="ident" id="4222572"><a href="/crypto/tls/handshake_server.go.html#4221023">certs</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4222580">return</span>&nbsp;<span class="ident" id="4222587"><a href="/crypto/tls/handshake_server.go.html#4222250">pub</a></span><span class="op" id="4222590">,</span>&nbsp;<span class="ident" id="4222592">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4222597">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4222601">return</span>&nbsp;<span class="ident" id="4222608">nil</span><span class="op" id="4222611">,</span>&nbsp;<span class="ident" id="4222613">nil</span><br>
<span class="lineno"></span><span class="op" id="4222617">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4222620">//&nbsp;tryCipherSuite&nbsp;returns&nbsp;a&nbsp;cipherSuite&nbsp;with&nbsp;the&nbsp;given&nbsp;id&nbsp;if&nbsp;that&nbsp;cipher&nbsp;suite</span><br>
<span class="lineno"></span><span class="comment" id="4222699">//&nbsp;is&nbsp;acceptable&nbsp;to&nbsp;use.</span><br>
<span class="lineno">655</span><span class="keyword" id="4222724">func</span>&nbsp;<span class="op" id="4222729">(</span><span class="ident" id="4222730">c</span>&nbsp;<span class="op" id="4222732">*</span><span class="ident" id="4222733"><a href="/crypto/tls/conn.go.html#4127599">Conn</a></span><span class="op" id="4222737">)</span>&nbsp;<span class="ident" id="4222739">tryCipherSuite</span><span class="op" id="4222753">(</span><span class="ident" id="4222754">id</span>&nbsp;<span class="builtintype" id="4222757">uint16</span><span class="op" id="4222763">,</span>&nbsp;<span class="ident" id="4222765">supportedCipherSuites</span>&nbsp;<span class="op" id="4222787">[</span><span class="op" id="4222788">]</span><span class="builtintype" id="4222789">uint16</span><span class="op" id="4222795">,</span>&nbsp;<span class="ident" id="4222797">version</span>&nbsp;<span class="builtintype" id="4222805">uint16</span><span class="op" id="4222811">,</span>&nbsp;<span class="ident" id="4222813">ellipticOk</span><span class="op" id="4222823">,</span>&nbsp;<span class="ident" id="4222825">ecdsaOk</span>&nbsp;<span class="builtintype" id="4222833">bool</span><span class="op" id="4222837">)</span>&nbsp;<span class="op" id="4222839">*</span><span class="ident" id="4222840"><a href="/crypto/tls/cipher_suites.go.html#4100373">cipherSuite</a></span>&nbsp;<span class="op" id="4222852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4222855">for</span>&nbsp;<span class="ident" id="4222859">_</span><span class="op" id="4222860">,</span>&nbsp;<span class="ident" id="4222862">supported</span>&nbsp;<span class="op" id="4222872">:=</span>&nbsp;<span class="keyword" id="4222875">range</span>&nbsp;<span class="ident" id="4222881"><a href="/crypto/tls/handshake_server.go.html#4222765">supportedCipherSuites</a></span>&nbsp;<span class="op" id="4222903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4222907">if</span>&nbsp;<span class="ident" id="4222910"><a href="/crypto/tls/handshake_server.go.html#4222754">id</a></span>&nbsp;<span class="op" id="4222913">==</span>&nbsp;<span class="ident" id="4222916"><a href="/crypto/tls/handshake_server.go.html#4222862">supported</a></span>&nbsp;<span class="op" id="4222926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4222931">var</span>&nbsp;<span class="ident" id="4222935">candidate</span>&nbsp;<span class="op" id="4222945">*</span><span class="ident" id="4222946"><a href="/crypto/tls/cipher_suites.go.html#4100373">cipherSuite</a></span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4222962">for</span>&nbsp;<span class="ident" id="4222966">_</span><span class="op" id="4222967">,</span>&nbsp;<span class="ident" id="4222969">s</span>&nbsp;<span class="op" id="4222971">:=</span>&nbsp;<span class="keyword" id="4222974">range</span>&nbsp;<span class="ident" id="4222980"><a href="/crypto/tls/cipher_suites.go.html#4100787">cipherSuites</a></span>&nbsp;<span class="op" id="4222993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4222999">if</span>&nbsp;<span class="ident" id="4223002"><a href="/crypto/tls/handshake_server.go.html#4222969">s</a></span><span class="op" id="4223003">.</span><span class="ident" id="4223004">id</span>&nbsp;<span class="op" id="4223007">==</span>&nbsp;<span class="ident" id="4223010"><a href="/crypto/tls/handshake_server.go.html#4222754">id</a></span>&nbsp;<span class="op" id="4223013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4223020"><a href="/crypto/tls/handshake_server.go.html#4222935">candidate</a></span>&nbsp;<span class="op" id="4223030">=</span>&nbsp;<span class="ident" id="4223032"><a href="/crypto/tls/handshake_server.go.html#4222969">s</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4223039">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4223049">}</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4223054">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4223059">if</span>&nbsp;<span class="ident" id="4223062"><a href="/crypto/tls/handshake_server.go.html#4222935">candidate</a></span>&nbsp;<span class="op" id="4223072">==</span>&nbsp;<span class="ident" id="4223075">nil</span>&nbsp;<span class="op" id="4223079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4223085">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4223097">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4223102">//&nbsp;Don&#39;t&nbsp;select&nbsp;a&nbsp;ciphersuite&nbsp;which&nbsp;we&nbsp;can&#39;t</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4223150">//&nbsp;support&nbsp;for&nbsp;this&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4223181">if</span>&nbsp;<span class="op" id="4223184">(</span><span class="ident" id="4223185"><a href="/crypto/tls/handshake_server.go.html#4222935">candidate</a></span><span class="op" id="4223194">.</span><span class="ident" id="4223195">flags</span><span class="op" id="4223200">&amp;</span><span class="ident" id="4223201"><a href="/crypto/tls/cipher_suites.go.html#4099848">suiteECDHE</a></span>&nbsp;<span class="op" id="4223212">!=</span>&nbsp;<span class="num" id="4223215">0</span><span class="op" id="4223216">)</span>&nbsp;<span class="op" id="4223218">&amp;&amp;</span>&nbsp;<span class="op" id="4223221">!</span><span class="ident" id="4223222"><a href="/crypto/tls/handshake_server.go.html#4222813">ellipticOk</a></span>&nbsp;<span class="op" id="4223233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4223239">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4223251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4223256">if</span>&nbsp;<span class="op" id="4223259">(</span><span class="ident" id="4223260"><a href="/crypto/tls/handshake_server.go.html#4222935">candidate</a></span><span class="op" id="4223269">.</span><span class="ident" id="4223270">flags</span><span class="op" id="4223275">&amp;</span><span class="ident" id="4223276"><a href="/crypto/tls/cipher_suites.go.html#4100089">suiteECDSA</a></span>&nbsp;<span class="op" id="4223287">!=</span>&nbsp;<span class="num" id="4223290">0</span><span class="op" id="4223291">)</span>&nbsp;<span class="op" id="4223293">!=</span>&nbsp;<span class="ident" id="4223296"><a href="/crypto/tls/handshake_server.go.html#4222825">ecdsaOk</a></span>&nbsp;<span class="op" id="4223304">{</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4223310">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4223322">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4223327">if</span>&nbsp;<span class="ident" id="4223330"><a href="/crypto/tls/handshake_server.go.html#4222797">version</a></span>&nbsp;<span class="op" id="4223338">&lt;</span>&nbsp;<span class="ident" id="4223340"><a href="/crypto/tls/common.go.html#4108205">VersionTLS12</a></span>&nbsp;<span class="op" id="4223353">&amp;&amp;</span>&nbsp;<span class="ident" id="4223356"><a href="/crypto/tls/handshake_server.go.html#4222935">candidate</a></span><span class="op" id="4223365">.</span><span class="ident" id="4223366">flags</span><span class="op" id="4223371">&amp;</span><span class="ident" id="4223372"><a href="/crypto/tls/cipher_suites.go.html#4100211">suiteTLS12</a></span>&nbsp;<span class="op" id="4223383">!=</span>&nbsp;<span class="num" id="4223386">0</span>&nbsp;<span class="op" id="4223388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4223394">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4223406">}</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4223411">return</span>&nbsp;<span class="ident" id="4223418"><a href="/crypto/tls/handshake_server.go.html#4222935">candidate</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4223430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4223433">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4223437">return</span>&nbsp;<span class="ident" id="4223444">nil</span><br>
<span class="lineno">685</span><span class="op" id="4223448">}</span>
</div>
</body>
</html>
