<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/internal</h2>
<ul>
<li><a href="/gostd/net/http/internal/chunked.go.html">chunked.go</a></li>
<li><a href="/gostd/net/http/internal/chunked_test.go.html">chunked_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4528195">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4528250">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4528304">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4528355">//&nbsp;The&nbsp;wire&nbsp;protocol&nbsp;for&nbsp;HTTP&#39;s&nbsp;&#34;chunked&#34;&nbsp;Transfer-Encoding.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4528417">//&nbsp;Package&nbsp;internal&nbsp;contains&nbsp;HTTP&nbsp;internals&nbsp;shared&nbsp;by&nbsp;net/http&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4528484">//&nbsp;net/http/httputil.</span><br>
<span class="lineno"></span><span class="keyword" id="4528506">package</span>&nbsp;<span class="ident" id="4528514">internal</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="4528524">import</span>&nbsp;<span class="op" id="4528531">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4528534">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4528543">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4528552">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4528562">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4528569">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="4528574">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4528577">const</span>&nbsp;<span class="ident" id="4528583">maxLineLength</span>&nbsp;<span class="op" id="4528597">=</span>&nbsp;<span class="num" id="4528599">4096</span>&nbsp;<span class="comment" id="4528604">//&nbsp;assumed&nbsp;&lt;=&nbsp;bufio.defaultBufSize</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="4528640">var</span>&nbsp;<span class="ident" id="4528644">ErrLineTooLong</span>&nbsp;<span class="op" id="4528659">=</span>&nbsp;<span class="ident" id="4528661">errors</span><span class="op" id="4528667">.</span><span class="ident" id="4528668">New</span><span class="op" id="4528671">(</span><span class="string" id="4528672">&#34;header&nbsp;line&nbsp;too&nbsp;long&#34;</span><span class="op" id="4528694">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4528697">//&nbsp;NewChunkedReader&nbsp;returns&nbsp;a&nbsp;new&nbsp;chunkedReader&nbsp;that&nbsp;translates&nbsp;the&nbsp;data&nbsp;read&nbsp;from&nbsp;r</span><br>
<span class="lineno"></span><span class="comment" id="4528782">//&nbsp;out&nbsp;of&nbsp;HTTP&nbsp;&#34;chunked&#34;&nbsp;format&nbsp;before&nbsp;returning&nbsp;it.</span><br>
<span class="lineno">25</span><span class="comment" id="4528835">//&nbsp;The&nbsp;chunkedReader&nbsp;returns&nbsp;io.EOF&nbsp;when&nbsp;the&nbsp;final&nbsp;0-length&nbsp;chunk&nbsp;is&nbsp;read.</span><br>
<span class="lineno"></span><span class="comment" id="4528910">//</span><br>
<span class="lineno"></span><span class="comment" id="4528913">//&nbsp;NewChunkedReader&nbsp;is&nbsp;not&nbsp;needed&nbsp;by&nbsp;normal&nbsp;applications.&nbsp;The&nbsp;http&nbsp;package</span><br>
<span class="lineno"></span><span class="comment" id="4528988">//&nbsp;automatically&nbsp;decodes&nbsp;chunking&nbsp;when&nbsp;reading&nbsp;response&nbsp;bodies.</span><br>
<span class="lineno"></span><span class="keyword" id="4529052">func</span>&nbsp;<span class="ident" id="4529057">NewChunkedReader</span><span class="op" id="4529073">(</span><span class="ident" id="4529074">r</span>&nbsp;<span class="ident" id="4529076">io</span><span class="op" id="4529078">.</span><span class="ident" id="4529079">Reader</span><span class="op" id="4529085">)</span>&nbsp;<span class="ident" id="4529087">io</span><span class="op" id="4529089">.</span><span class="ident" id="4529090">Reader</span>&nbsp;<span class="op" id="4529097">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4529100">br</span><span class="op" id="4529102">,</span>&nbsp;<span class="ident" id="4529104">ok</span>&nbsp;<span class="op" id="4529107">:=</span>&nbsp;<span class="ident" id="4529110">r</span><span class="op" id="4529111">.</span><span class="op" id="4529112">(</span><span class="op" id="4529113">*</span><span class="ident" id="4529114">bufio</span><span class="op" id="4529119">.</span><span class="ident" id="4529120">Reader</span><span class="op" id="4529126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529129">if</span>&nbsp;<span class="op" id="4529132">!</span><span class="ident" id="4529133">ok</span>&nbsp;<span class="op" id="4529136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4529140">br</span>&nbsp;<span class="op" id="4529143">=</span>&nbsp;<span class="ident" id="4529145">bufio</span><span class="op" id="4529150">.</span><span class="ident" id="4529151">NewReader</span><span class="op" id="4529160">(</span><span class="ident" id="4529161">r</span><span class="op" id="4529162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4529165">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529168">return</span>&nbsp;<span class="op" id="4529175">&amp;</span><span class="ident" id="4529176">chunkedReader</span><span class="op" id="4529189">{</span><span class="ident" id="4529190">r</span><span class="op" id="4529191">:</span>&nbsp;<span class="ident" id="4529193">br</span><span class="op" id="4529195">}</span><br>
<span class="lineno">35</span><span class="op" id="4529197">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4529200">type</span>&nbsp;<span class="ident" id="4529205">chunkedReader</span>&nbsp;<span class="keyword" id="4529219">struct</span>&nbsp;<span class="op" id="4529226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4529229">r</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4529233">*</span><span class="ident" id="4529234">bufio</span><span class="op" id="4529239">.</span><span class="ident" id="4529240">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4529248">n</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4529252">uint64</span>&nbsp;<span class="comment" id="4529259">//&nbsp;unread&nbsp;bytes&nbsp;in&nbsp;chunk</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4529285">err</span>&nbsp;<span class="builtintype" id="4529289">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4529296">buf</span>&nbsp;<span class="op" id="4529300">[</span><span class="num" id="4529301">2</span><span class="op" id="4529302">]</span><span class="builtintype" id="4529303">byte</span><br>
<span class="lineno"></span><span class="op" id="4529308">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4529311">func</span>&nbsp;<span class="op" id="4529316">(</span><span class="ident" id="4529317">cr</span>&nbsp;<span class="op" id="4529320">*</span><span class="ident" id="4529321">chunkedReader</span><span class="op" id="4529334">)</span>&nbsp;<span class="ident" id="4529336">beginChunk</span><span class="op" id="4529346">(</span><span class="op" id="4529347">)</span>&nbsp;<span class="op" id="4529349">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4529352">//&nbsp;chunk-size&nbsp;CRLF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529372">var</span>&nbsp;<span class="ident" id="4529376">line</span>&nbsp;<span class="op" id="4529381">[</span><span class="op" id="4529382">]</span><span class="builtintype" id="4529383">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4529389">line</span><span class="op" id="4529393">,</span>&nbsp;<span class="ident" id="4529395">cr</span><span class="op" id="4529397">.</span><span class="ident" id="4529398">err</span>&nbsp;<span class="op" id="4529402">=</span>&nbsp;<span class="ident" id="4529404">readLine</span><span class="op" id="4529412">(</span><span class="ident" id="4529413">cr</span><span class="op" id="4529415">.</span><span class="ident" id="4529416">r</span><span class="op" id="4529417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529420">if</span>&nbsp;<span class="ident" id="4529423">cr</span><span class="op" id="4529425">.</span><span class="ident" id="4529426">err</span>&nbsp;<span class="op" id="4529430">!=</span>&nbsp;<span class="ident" id="4529433">nil</span>&nbsp;<span class="op" id="4529437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529441">return</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4529449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4529452">cr</span><span class="op" id="4529454">.</span><span class="ident" id="4529455">n</span><span class="op" id="4529456">,</span>&nbsp;<span class="ident" id="4529458">cr</span><span class="op" id="4529460">.</span><span class="ident" id="4529461">err</span>&nbsp;<span class="op" id="4529465">=</span>&nbsp;<span class="ident" id="4529467">parseHexUint</span><span class="op" id="4529479">(</span><span class="ident" id="4529480">line</span><span class="op" id="4529484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529487">if</span>&nbsp;<span class="ident" id="4529490">cr</span><span class="op" id="4529492">.</span><span class="ident" id="4529493">err</span>&nbsp;<span class="op" id="4529497">!=</span>&nbsp;<span class="ident" id="4529500">nil</span>&nbsp;<span class="op" id="4529504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529508">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4529516">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529519">if</span>&nbsp;<span class="ident" id="4529522">cr</span><span class="op" id="4529524">.</span><span class="ident" id="4529525">n</span>&nbsp;<span class="op" id="4529527">==</span>&nbsp;<span class="num" id="4529530">0</span>&nbsp;<span class="op" id="4529532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4529536">cr</span><span class="op" id="4529538">.</span><span class="ident" id="4529539">err</span>&nbsp;<span class="op" id="4529543">=</span>&nbsp;<span class="ident" id="4529545">io</span><span class="op" id="4529547">.</span><span class="ident" id="4529548">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4529553">}</span><br>
<span class="lineno"></span><span class="op" id="4529555">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="4529558">func</span>&nbsp;<span class="op" id="4529563">(</span><span class="ident" id="4529564">cr</span>&nbsp;<span class="op" id="4529567">*</span><span class="ident" id="4529568">chunkedReader</span><span class="op" id="4529581">)</span>&nbsp;<span class="ident" id="4529583">chunkHeaderAvailable</span><span class="op" id="4529603">(</span><span class="op" id="4529604">)</span>&nbsp;<span class="builtintype" id="4529606">bool</span>&nbsp;<span class="op" id="4529611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4529614">n</span>&nbsp;<span class="op" id="4529616">:=</span>&nbsp;<span class="ident" id="4529619">cr</span><span class="op" id="4529621">.</span><span class="ident" id="4529622">r</span><span class="op" id="4529623">.</span><span class="ident" id="4529624">Buffered</span><span class="op" id="4529632">(</span><span class="op" id="4529633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529636">if</span>&nbsp;<span class="ident" id="4529639">n</span>&nbsp;<span class="op" id="4529641">&gt;</span>&nbsp;<span class="num" id="4529643">0</span>&nbsp;<span class="op" id="4529645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4529649">peek</span><span class="op" id="4529653">,</span>&nbsp;<span class="ident" id="4529655">_</span>&nbsp;<span class="op" id="4529657">:=</span>&nbsp;<span class="ident" id="4529660">cr</span><span class="op" id="4529662">.</span><span class="ident" id="4529663">r</span><span class="op" id="4529664">.</span><span class="ident" id="4529665">Peek</span><span class="op" id="4529669">(</span><span class="ident" id="4529670">n</span><span class="op" id="4529671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529675">return</span>&nbsp;<span class="ident" id="4529682">bytes</span><span class="op" id="4529687">.</span><span class="ident" id="4529688">IndexByte</span><span class="op" id="4529697">(</span><span class="ident" id="4529698">peek</span><span class="op" id="4529702">,</span>&nbsp;<span class="string" id="4529704">&#39;\n&#39;</span><span class="op" id="4529708">)</span>&nbsp;<span class="op" id="4529710">&gt;=</span>&nbsp;<span class="num" id="4529713">0</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4529716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529719">return</span>&nbsp;<span class="builtintype" id="4529726">false</span><br>
<span class="lineno"></span><span class="op" id="4529732">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4529735">func</span>&nbsp;<span class="op" id="4529740">(</span><span class="ident" id="4529741">cr</span>&nbsp;<span class="op" id="4529744">*</span><span class="ident" id="4529745">chunkedReader</span><span class="op" id="4529758">)</span>&nbsp;<span class="ident" id="4529760">Read</span><span class="op" id="4529764">(</span><span class="ident" id="4529765">b</span>&nbsp;<span class="op" id="4529767">[</span><span class="op" id="4529768">]</span><span class="builtintype" id="4529769">uint8</span><span class="op" id="4529774">)</span>&nbsp;<span class="op" id="4529776">(</span><span class="ident" id="4529777">n</span>&nbsp;<span class="builtintype" id="4529779">int</span><span class="op" id="4529782">,</span>&nbsp;<span class="ident" id="4529784">err</span>&nbsp;<span class="builtintype" id="4529788">error</span><span class="op" id="4529793">)</span>&nbsp;<span class="op" id="4529795">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529798">for</span>&nbsp;<span class="ident" id="4529802">cr</span><span class="op" id="4529804">.</span><span class="ident" id="4529805">err</span>&nbsp;<span class="op" id="4529809">==</span>&nbsp;<span class="ident" id="4529812">nil</span>&nbsp;<span class="op" id="4529816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529820">if</span>&nbsp;<span class="ident" id="4529823">cr</span><span class="op" id="4529825">.</span><span class="ident" id="4529826">n</span>&nbsp;<span class="op" id="4529828">==</span>&nbsp;<span class="num" id="4529831">0</span>&nbsp;<span class="op" id="4529833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529838">if</span>&nbsp;<span class="ident" id="4529841">n</span>&nbsp;<span class="op" id="4529843">&gt;</span>&nbsp;<span class="num" id="4529845">0</span>&nbsp;<span class="op" id="4529847">&amp;&amp;</span>&nbsp;<span class="op" id="4529850">!</span><span class="ident" id="4529851">cr</span><span class="op" id="4529853">.</span><span class="ident" id="4529854">chunkHeaderAvailable</span><span class="op" id="4529874">(</span><span class="op" id="4529875">)</span>&nbsp;<span class="op" id="4529877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4529883">//&nbsp;We&#39;ve&nbsp;read&nbsp;enough.&nbsp;Don&#39;t&nbsp;potentially&nbsp;block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4529933">//&nbsp;reading&nbsp;a&nbsp;new&nbsp;chunk&nbsp;header.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529968">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4529977">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4529982">cr</span><span class="op" id="4529984">.</span><span class="ident" id="4529985">beginChunk</span><span class="op" id="4529995">(</span><span class="op" id="4529996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4530001">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4530012">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4530016">if</span>&nbsp;<span class="builtinfunc" id="4530019">len</span><span class="op" id="4530022">(</span><span class="ident" id="4530023">b</span><span class="op" id="4530024">)</span>&nbsp;<span class="op" id="4530026">==</span>&nbsp;<span class="num" id="4530029">0</span>&nbsp;<span class="op" id="4530031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4530036">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4530044">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4530048">rbuf</span>&nbsp;<span class="op" id="4530053">:=</span>&nbsp;<span class="ident" id="4530056">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4530060">if</span>&nbsp;<span class="ident" id="4530063">uint64</span><span class="op" id="4530069">(</span><span class="builtinfunc" id="4530070">len</span><span class="op" id="4530073">(</span><span class="ident" id="4530074">rbuf</span><span class="op" id="4530078">)</span><span class="op" id="4530079">)</span>&nbsp;<span class="op" id="4530081">&gt;</span>&nbsp;<span class="ident" id="4530083">cr</span><span class="op" id="4530085">.</span><span class="ident" id="4530086">n</span>&nbsp;<span class="op" id="4530088">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4530093">rbuf</span>&nbsp;<span class="op" id="4530098">=</span>&nbsp;<span class="ident" id="4530100">rbuf</span><span class="op" id="4530104">[</span><span class="op" id="4530105">:</span><span class="ident" id="4530106">cr</span><span class="op" id="4530108">.</span><span class="ident" id="4530109">n</span><span class="op" id="4530110">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4530114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4530118">var</span>&nbsp;<span class="ident" id="4530122">n0</span>&nbsp;<span class="builtintype" id="4530125">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4530131">n0</span><span class="op" id="4530133">,</span>&nbsp;<span class="ident" id="4530135">cr</span><span class="op" id="4530137">.</span><span class="ident" id="4530138">err</span>&nbsp;<span class="op" id="4530142">=</span>&nbsp;<span class="ident" id="4530144">cr</span><span class="op" id="4530146">.</span><span class="ident" id="4530147">r</span><span class="op" id="4530148">.</span><span class="ident" id="4530149">Read</span><span class="op" id="4530153">(</span><span class="ident" id="4530154">rbuf</span><span class="op" id="4530158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4530162">n</span>&nbsp;<span class="op" id="4530164">+=</span>&nbsp;<span class="ident" id="4530167">n0</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4530172">b</span>&nbsp;<span class="op" id="4530174">=</span>&nbsp;<span class="ident" id="4530176">b</span><span class="op" id="4530177">[</span><span class="ident" id="4530178">n0</span><span class="op" id="4530180">:</span><span class="op" id="4530181">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4530185">cr</span><span class="op" id="4530187">.</span><span class="ident" id="4530188">n</span>&nbsp;<span class="op" id="4530190">-=</span>&nbsp;<span class="ident" id="4530193">uint64</span><span class="op" id="4530199">(</span><span class="ident" id="4530200">n0</span><span class="op" id="4530202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4530206">//&nbsp;If&nbsp;we&#39;re&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;a&nbsp;chunk,&nbsp;read&nbsp;the&nbsp;next&nbsp;two</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4530261">//&nbsp;bytes&nbsp;to&nbsp;verify&nbsp;they&nbsp;are&nbsp;&#34;\r\n&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4530299">if</span>&nbsp;<span class="ident" id="4530302">cr</span><span class="op" id="4530304">.</span><span class="ident" id="4530305">n</span>&nbsp;<span class="op" id="4530307">==</span>&nbsp;<span class="num" id="4530310">0</span>&nbsp;<span class="op" id="4530312">&amp;&amp;</span>&nbsp;<span class="ident" id="4530315">cr</span><span class="op" id="4530317">.</span><span class="ident" id="4530318">err</span>&nbsp;<span class="op" id="4530322">==</span>&nbsp;<span class="ident" id="4530325">nil</span>&nbsp;<span class="op" id="4530329">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4530334">if</span>&nbsp;<span class="ident" id="4530337">_</span><span class="op" id="4530338">,</span>&nbsp;<span class="ident" id="4530340">cr</span><span class="op" id="4530342">.</span><span class="ident" id="4530343">err</span>&nbsp;<span class="op" id="4530347">=</span>&nbsp;<span class="ident" id="4530349">io</span><span class="op" id="4530351">.</span><span class="ident" id="4530352">ReadFull</span><span class="op" id="4530360">(</span><span class="ident" id="4530361">cr</span><span class="op" id="4530363">.</span><span class="ident" id="4530364">r</span><span class="op" id="4530365">,</span>&nbsp;<span class="ident" id="4530367">cr</span><span class="op" id="4530369">.</span><span class="ident" id="4530370">buf</span><span class="op" id="4530373">[</span><span class="op" id="4530374">:</span><span class="num" id="4530375">2</span><span class="op" id="4530376">]</span><span class="op" id="4530377">)</span><span class="op" id="4530378">;</span>&nbsp;<span class="ident" id="4530380">cr</span><span class="op" id="4530382">.</span><span class="ident" id="4530383">err</span>&nbsp;<span class="op" id="4530387">==</span>&nbsp;<span class="ident" id="4530390">nil</span>&nbsp;<span class="op" id="4530394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4530400">if</span>&nbsp;<span class="ident" id="4530403">cr</span><span class="op" id="4530405">.</span><span class="ident" id="4530406">buf</span><span class="op" id="4530409">[</span><span class="num" id="4530410">0</span><span class="op" id="4530411">]</span>&nbsp;<span class="op" id="4530413">!=</span>&nbsp;<span class="string" id="4530416">&#39;\r&#39;</span>&nbsp;<span class="op" id="4530421">||</span>&nbsp;<span class="ident" id="4530424">cr</span><span class="op" id="4530426">.</span><span class="ident" id="4530427">buf</span><span class="op" id="4530430">[</span><span class="num" id="4530431">1</span><span class="op" id="4530432">]</span>&nbsp;<span class="op" id="4530434">!=</span>&nbsp;<span class="string" id="4530437">&#39;\n&#39;</span>&nbsp;<span class="op" id="4530442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4530449">cr</span><span class="op" id="4530451">.</span><span class="ident" id="4530452">err</span>&nbsp;<span class="op" id="4530456">=</span>&nbsp;<span class="ident" id="4530458">errors</span><span class="op" id="4530464">.</span><span class="ident" id="4530465">New</span><span class="op" id="4530468">(</span><span class="string" id="4530469">&#34;malformed&nbsp;chunked&nbsp;encoding&#34;</span><span class="op" id="4530497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4530503">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4530508">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4530512">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4530515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4530518">return</span>&nbsp;<span class="ident" id="4530525">n</span><span class="op" id="4530526">,</span>&nbsp;<span class="ident" id="4530528">cr</span><span class="op" id="4530530">.</span><span class="ident" id="4530531">err</span><br>
<span class="lineno"></span><span class="op" id="4530535">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="4530538">//&nbsp;Read&nbsp;a&nbsp;line&nbsp;of&nbsp;bytes&nbsp;(up&nbsp;to&nbsp;\n)&nbsp;from&nbsp;b.</span><br>
<span class="lineno"></span><span class="comment" id="4530581">//&nbsp;Give&nbsp;up&nbsp;if&nbsp;the&nbsp;line&nbsp;exceeds&nbsp;maxLineLength.</span><br>
<span class="lineno"></span><span class="comment" id="4530627">//&nbsp;The&nbsp;returned&nbsp;bytes&nbsp;are&nbsp;a&nbsp;pointer&nbsp;into&nbsp;storage&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="4530679">//&nbsp;the&nbsp;bufio,&nbsp;so&nbsp;they&nbsp;are&nbsp;only&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;bufio&nbsp;read.</span><br>
<span class="lineno"></span><span class="keyword" id="4530743">func</span>&nbsp;<span class="ident" id="4530748">readLine</span><span class="op" id="4530756">(</span><span class="ident" id="4530757">b</span>&nbsp;<span class="op" id="4530759">*</span><span class="ident" id="4530760">bufio</span><span class="op" id="4530765">.</span><span class="ident" id="4530766">Reader</span><span class="op" id="4530772">)</span>&nbsp;<span class="op" id="4530774">(</span><span class="ident" id="4530775">p</span>&nbsp;<span class="op" id="4530777">[</span><span class="op" id="4530778">]</span><span class="builtintype" id="4530779">byte</span><span class="op" id="4530783">,</span>&nbsp;<span class="ident" id="4530785">err</span>&nbsp;<span class="builtintype" id="4530789">error</span><span class="op" id="4530794">)</span>&nbsp;<span class="op" id="4530796">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4530799">if</span>&nbsp;<span class="ident" id="4530802">p</span><span class="op" id="4530803">,</span>&nbsp;<span class="ident" id="4530805">err</span>&nbsp;<span class="op" id="4530809">=</span>&nbsp;<span class="ident" id="4530811">b</span><span class="op" id="4530812">.</span><span class="ident" id="4530813">ReadSlice</span><span class="op" id="4530822">(</span><span class="string" id="4530823">&#39;\n&#39;</span><span class="op" id="4530827">)</span><span class="op" id="4530828">;</span>&nbsp;<span class="ident" id="4530830">err</span>&nbsp;<span class="op" id="4530834">!=</span>&nbsp;<span class="ident" id="4530837">nil</span>&nbsp;<span class="op" id="4530841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4530845">//&nbsp;We&nbsp;always&nbsp;know&nbsp;when&nbsp;EOF&nbsp;is&nbsp;coming.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4530885">//&nbsp;If&nbsp;the&nbsp;caller&nbsp;asked&nbsp;for&nbsp;a&nbsp;line,&nbsp;there&nbsp;should&nbsp;be&nbsp;a&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4530946">if</span>&nbsp;<span class="ident" id="4530949">err</span>&nbsp;<span class="op" id="4530953">==</span>&nbsp;<span class="ident" id="4530956">io</span><span class="op" id="4530958">.</span><span class="ident" id="4530959">EOF</span>&nbsp;<span class="op" id="4530963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4530968">err</span>&nbsp;<span class="op" id="4530972">=</span>&nbsp;<span class="ident" id="4530974">io</span><span class="op" id="4530976">.</span><span class="ident" id="4530977">ErrUnexpectedEOF</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4530996">}</span>&nbsp;<span class="keyword" id="4530998">else</span>&nbsp;<span class="keyword" id="4531003">if</span>&nbsp;<span class="ident" id="4531006">err</span>&nbsp;<span class="op" id="4531010">==</span>&nbsp;<span class="ident" id="4531013">bufio</span><span class="op" id="4531018">.</span><span class="ident" id="4531019">ErrBufferFull</span>&nbsp;<span class="op" id="4531033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4531038">err</span>&nbsp;<span class="op" id="4531042">=</span>&nbsp;<span class="ident" id="4531044">ErrLineTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4531061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4531065">return</span>&nbsp;<span class="ident" id="4531072">nil</span><span class="op" id="4531075">,</span>&nbsp;<span class="ident" id="4531077">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4531082">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4531085">if</span>&nbsp;<span class="builtinfunc" id="4531088">len</span><span class="op" id="4531091">(</span><span class="ident" id="4531092">p</span><span class="op" id="4531093">)</span>&nbsp;<span class="op" id="4531095">&gt;=</span>&nbsp;<span class="ident" id="4531098">maxLineLength</span>&nbsp;<span class="op" id="4531112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4531116">return</span>&nbsp;<span class="ident" id="4531123">nil</span><span class="op" id="4531126">,</span>&nbsp;<span class="ident" id="4531128">ErrLineTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4531144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4531147">return</span>&nbsp;<span class="ident" id="4531154">trimTrailingWhitespace</span><span class="op" id="4531176">(</span><span class="ident" id="4531177">p</span><span class="op" id="4531178">)</span><span class="op" id="4531179">,</span>&nbsp;<span class="ident" id="4531181">nil</span><br>
<span class="lineno"></span><span class="op" id="4531185">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="4531188">func</span>&nbsp;<span class="ident" id="4531193">trimTrailingWhitespace</span><span class="op" id="4531215">(</span><span class="ident" id="4531216">b</span>&nbsp;<span class="op" id="4531218">[</span><span class="op" id="4531219">]</span><span class="builtintype" id="4531220">byte</span><span class="op" id="4531224">)</span>&nbsp;<span class="op" id="4531226">[</span><span class="op" id="4531227">]</span><span class="builtintype" id="4531228">byte</span>&nbsp;<span class="op" id="4531233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4531236">for</span>&nbsp;<span class="builtinfunc" id="4531240">len</span><span class="op" id="4531243">(</span><span class="ident" id="4531244">b</span><span class="op" id="4531245">)</span>&nbsp;<span class="op" id="4531247">&gt;</span>&nbsp;<span class="num" id="4531249">0</span>&nbsp;<span class="op" id="4531251">&amp;&amp;</span>&nbsp;<span class="ident" id="4531254">isASCIISpace</span><span class="op" id="4531266">(</span><span class="ident" id="4531267">b</span><span class="op" id="4531268">[</span><span class="builtinfunc" id="4531269">len</span><span class="op" id="4531272">(</span><span class="ident" id="4531273">b</span><span class="op" id="4531274">)</span><span class="op" id="4531275">-</span><span class="num" id="4531276">1</span><span class="op" id="4531277">]</span><span class="op" id="4531278">)</span>&nbsp;<span class="op" id="4531280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4531284">b</span>&nbsp;<span class="op" id="4531286">=</span>&nbsp;<span class="ident" id="4531288">b</span><span class="op" id="4531289">[</span><span class="op" id="4531290">:</span><span class="builtinfunc" id="4531291">len</span><span class="op" id="4531294">(</span><span class="ident" id="4531295">b</span><span class="op" id="4531296">)</span><span class="op" id="4531297">-</span><span class="num" id="4531298">1</span><span class="op" id="4531299">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4531302">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4531305">return</span>&nbsp;<span class="ident" id="4531312">b</span><br>
<span class="lineno"></span><span class="op" id="4531314">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4531317">func</span>&nbsp;<span class="ident" id="4531322">isASCIISpace</span><span class="op" id="4531334">(</span><span class="ident" id="4531335">b</span>&nbsp;<span class="builtintype" id="4531337">byte</span><span class="op" id="4531341">)</span>&nbsp;<span class="builtintype" id="4531343">bool</span>&nbsp;<span class="op" id="4531348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4531351">return</span>&nbsp;<span class="ident" id="4531358">b</span>&nbsp;<span class="op" id="4531360">==</span>&nbsp;<span class="string" id="4531363">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="4531367">||</span>&nbsp;<span class="ident" id="4531370">b</span>&nbsp;<span class="op" id="4531372">==</span>&nbsp;<span class="string" id="4531375">&#39;\t&#39;</span>&nbsp;<span class="op" id="4531380">||</span>&nbsp;<span class="ident" id="4531383">b</span>&nbsp;<span class="op" id="4531385">==</span>&nbsp;<span class="string" id="4531388">&#39;\n&#39;</span>&nbsp;<span class="op" id="4531393">||</span>&nbsp;<span class="ident" id="4531396">b</span>&nbsp;<span class="op" id="4531398">==</span>&nbsp;<span class="string" id="4531401">&#39;\r&#39;</span><br>
<span class="lineno">135</span><span class="op" id="4531406">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4531409">//&nbsp;NewChunkedWriter&nbsp;returns&nbsp;a&nbsp;new&nbsp;chunkedWriter&nbsp;that&nbsp;translates&nbsp;writes&nbsp;into&nbsp;HTTP</span><br>
<span class="lineno"></span><span class="comment" id="4531490">//&nbsp;&#34;chunked&#34;&nbsp;format&nbsp;before&nbsp;writing&nbsp;them&nbsp;to&nbsp;w.&nbsp;Closing&nbsp;the&nbsp;returned&nbsp;chunkedWriter</span><br>
<span class="lineno"></span><span class="comment" id="4531571">//&nbsp;sends&nbsp;the&nbsp;final&nbsp;0-length&nbsp;chunk&nbsp;that&nbsp;marks&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;stream.</span><br>
<span class="lineno">140</span><span class="comment" id="4531639">//</span><br>
<span class="lineno"></span><span class="comment" id="4531642">//&nbsp;NewChunkedWriter&nbsp;is&nbsp;not&nbsp;needed&nbsp;by&nbsp;normal&nbsp;applications.&nbsp;The&nbsp;http</span><br>
<span class="lineno"></span><span class="comment" id="4531709">//&nbsp;package&nbsp;adds&nbsp;chunking&nbsp;automatically&nbsp;if&nbsp;handlers&nbsp;don&#39;t&nbsp;set&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4531772">//&nbsp;Content-Length&nbsp;header.&nbsp;Using&nbsp;newChunkedWriter&nbsp;inside&nbsp;a&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="4531838">//&nbsp;would&nbsp;result&nbsp;in&nbsp;double&nbsp;chunking&nbsp;or&nbsp;chunking&nbsp;with&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno">145</span><span class="comment" id="4531907">//&nbsp;length,&nbsp;both&nbsp;of&nbsp;which&nbsp;are&nbsp;wrong.</span><br>
<span class="lineno"></span><span class="keyword" id="4531943">func</span>&nbsp;<span class="ident" id="4531948">NewChunkedWriter</span><span class="op" id="4531964">(</span><span class="ident" id="4531965">w</span>&nbsp;<span class="ident" id="4531967">io</span><span class="op" id="4531969">.</span><span class="ident" id="4531970">Writer</span><span class="op" id="4531976">)</span>&nbsp;<span class="ident" id="4531978">io</span><span class="op" id="4531980">.</span><span class="ident" id="4531981">WriteCloser</span>&nbsp;<span class="op" id="4531993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4531996">return</span>&nbsp;<span class="op" id="4532003">&amp;</span><span class="ident" id="4532004">chunkedWriter</span><span class="op" id="4532017">{</span><span class="ident" id="4532018">w</span><span class="op" id="4532019">}</span><br>
<span class="lineno"></span><span class="op" id="4532021">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="4532024">//&nbsp;Writing&nbsp;to&nbsp;chunkedWriter&nbsp;translates&nbsp;to&nbsp;writing&nbsp;in&nbsp;HTTP&nbsp;chunked&nbsp;Transfer</span><br>
<span class="lineno"></span><span class="comment" id="4532099">//&nbsp;Encoding&nbsp;wire&nbsp;format&nbsp;to&nbsp;the&nbsp;underlying&nbsp;Wire&nbsp;chunkedWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="4532161">type</span>&nbsp;<span class="ident" id="4532166">chunkedWriter</span>&nbsp;<span class="keyword" id="4532180">struct</span>&nbsp;<span class="op" id="4532187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4532190">Wire</span>&nbsp;<span class="ident" id="4532195">io</span><span class="op" id="4532197">.</span><span class="ident" id="4532198">Writer</span><br>
<span class="lineno"></span><span class="op" id="4532205">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="4532208">//&nbsp;Write&nbsp;the&nbsp;contents&nbsp;of&nbsp;data&nbsp;as&nbsp;one&nbsp;chunk&nbsp;to&nbsp;Wire.</span><br>
<span class="lineno"></span><span class="comment" id="4532260">//&nbsp;NOTE:&nbsp;Note&nbsp;that&nbsp;the&nbsp;corresponding&nbsp;chunk-writing&nbsp;procedure&nbsp;in&nbsp;Conn.Write&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="4532339">//&nbsp;a&nbsp;bug&nbsp;since&nbsp;it&nbsp;does&nbsp;not&nbsp;check&nbsp;for&nbsp;success&nbsp;of&nbsp;io.WriteString</span><br>
<span class="lineno"></span><span class="keyword" id="4532402">func</span>&nbsp;<span class="op" id="4532407">(</span><span class="ident" id="4532408">cw</span>&nbsp;<span class="op" id="4532411">*</span><span class="ident" id="4532412">chunkedWriter</span><span class="op" id="4532425">)</span>&nbsp;<span class="ident" id="4532427">Write</span><span class="op" id="4532432">(</span><span class="ident" id="4532433">data</span>&nbsp;<span class="op" id="4532438">[</span><span class="op" id="4532439">]</span><span class="builtintype" id="4532440">byte</span><span class="op" id="4532444">)</span>&nbsp;<span class="op" id="4532446">(</span><span class="ident" id="4532447">n</span>&nbsp;<span class="builtintype" id="4532449">int</span><span class="op" id="4532452">,</span>&nbsp;<span class="ident" id="4532454">err</span>&nbsp;<span class="builtintype" id="4532458">error</span><span class="op" id="4532463">)</span>&nbsp;<span class="op" id="4532465">{</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4532469">//&nbsp;Don&#39;t&nbsp;send&nbsp;0-length&nbsp;data.&nbsp;It&nbsp;looks&nbsp;like&nbsp;EOF&nbsp;for&nbsp;chunked&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4532539">if</span>&nbsp;<span class="builtinfunc" id="4532542">len</span><span class="op" id="4532545">(</span><span class="ident" id="4532546">data</span><span class="op" id="4532550">)</span>&nbsp;<span class="op" id="4532552">==</span>&nbsp;<span class="num" id="4532555">0</span>&nbsp;<span class="op" id="4532557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4532561">return</span>&nbsp;<span class="num" id="4532568">0</span><span class="op" id="4532569">,</span>&nbsp;<span class="ident" id="4532571">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4532576">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4532580">if</span>&nbsp;<span class="ident" id="4532583">_</span><span class="op" id="4532584">,</span>&nbsp;<span class="ident" id="4532586">err</span>&nbsp;<span class="op" id="4532590">=</span>&nbsp;<span class="ident" id="4532592">fmt</span><span class="op" id="4532595">.</span><span class="ident" id="4532596">Fprintf</span><span class="op" id="4532603">(</span><span class="ident" id="4532604">cw</span><span class="op" id="4532606">.</span><span class="ident" id="4532607">Wire</span><span class="op" id="4532611">,</span>&nbsp;<span class="string" id="4532613">&#34;%x\r\n&#34;</span><span class="op" id="4532621">,</span>&nbsp;<span class="builtinfunc" id="4532623">len</span><span class="op" id="4532626">(</span><span class="ident" id="4532627">data</span><span class="op" id="4532631">)</span><span class="op" id="4532632">)</span><span class="op" id="4532633">;</span>&nbsp;<span class="ident" id="4532635">err</span>&nbsp;<span class="op" id="4532639">!=</span>&nbsp;<span class="ident" id="4532642">nil</span>&nbsp;<span class="op" id="4532646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4532650">return</span>&nbsp;<span class="num" id="4532657">0</span><span class="op" id="4532658">,</span>&nbsp;<span class="ident" id="4532660">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4532665">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4532668">if</span>&nbsp;<span class="ident" id="4532671">n</span><span class="op" id="4532672">,</span>&nbsp;<span class="ident" id="4532674">err</span>&nbsp;<span class="op" id="4532678">=</span>&nbsp;<span class="ident" id="4532680">cw</span><span class="op" id="4532682">.</span><span class="ident" id="4532683">Wire</span><span class="op" id="4532687">.</span><span class="ident" id="4532688">Write</span><span class="op" id="4532693">(</span><span class="ident" id="4532694">data</span><span class="op" id="4532698">)</span><span class="op" id="4532699">;</span>&nbsp;<span class="ident" id="4532701">err</span>&nbsp;<span class="op" id="4532705">!=</span>&nbsp;<span class="ident" id="4532708">nil</span>&nbsp;<span class="op" id="4532712">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4532716">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4532724">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4532727">if</span>&nbsp;<span class="ident" id="4532730">n</span>&nbsp;<span class="op" id="4532732">!=</span>&nbsp;<span class="builtinfunc" id="4532735">len</span><span class="op" id="4532738">(</span><span class="ident" id="4532739">data</span><span class="op" id="4532743">)</span>&nbsp;<span class="op" id="4532745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4532749">err</span>&nbsp;<span class="op" id="4532753">=</span>&nbsp;<span class="ident" id="4532755">io</span><span class="op" id="4532757">.</span><span class="ident" id="4532758">ErrShortWrite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4532774">return</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4532782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4532785">_</span><span class="op" id="4532786">,</span>&nbsp;<span class="ident" id="4532788">err</span>&nbsp;<span class="op" id="4532792">=</span>&nbsp;<span class="ident" id="4532794">io</span><span class="op" id="4532796">.</span><span class="ident" id="4532797">WriteString</span><span class="op" id="4532808">(</span><span class="ident" id="4532809">cw</span><span class="op" id="4532811">.</span><span class="ident" id="4532812">Wire</span><span class="op" id="4532816">,</span>&nbsp;<span class="string" id="4532818">&#34;\r\n&#34;</span><span class="op" id="4532824">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4532828">return</span><br>
<span class="lineno"></span><span class="op" id="4532835">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span><span class="keyword" id="4532838">func</span>&nbsp;<span class="op" id="4532843">(</span><span class="ident" id="4532844">cw</span>&nbsp;<span class="op" id="4532847">*</span><span class="ident" id="4532848">chunkedWriter</span><span class="op" id="4532861">)</span>&nbsp;<span class="ident" id="4532863">Close</span><span class="op" id="4532868">(</span><span class="op" id="4532869">)</span>&nbsp;<span class="builtintype" id="4532871">error</span>&nbsp;<span class="op" id="4532877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4532880">_</span><span class="op" id="4532881">,</span>&nbsp;<span class="ident" id="4532883">err</span>&nbsp;<span class="op" id="4532887">:=</span>&nbsp;<span class="ident" id="4532890">io</span><span class="op" id="4532892">.</span><span class="ident" id="4532893">WriteString</span><span class="op" id="4532904">(</span><span class="ident" id="4532905">cw</span><span class="op" id="4532907">.</span><span class="ident" id="4532908">Wire</span><span class="op" id="4532912">,</span>&nbsp;<span class="string" id="4532914">&#34;0\r\n&#34;</span><span class="op" id="4532921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4532924">return</span>&nbsp;<span class="ident" id="4532931">err</span><br>
<span class="lineno"></span><span class="op" id="4532935">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span><span class="keyword" id="4532938">func</span>&nbsp;<span class="ident" id="4532943">parseHexUint</span><span class="op" id="4532955">(</span><span class="ident" id="4532956">v</span>&nbsp;<span class="op" id="4532958">[</span><span class="op" id="4532959">]</span><span class="builtintype" id="4532960">byte</span><span class="op" id="4532964">)</span>&nbsp;<span class="op" id="4532966">(</span><span class="ident" id="4532967">n</span>&nbsp;<span class="ident" id="4532969">uint64</span><span class="op" id="4532975">,</span>&nbsp;<span class="ident" id="4532977">err</span>&nbsp;<span class="builtintype" id="4532981">error</span><span class="op" id="4532986">)</span>&nbsp;<span class="op" id="4532988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4532991">for</span>&nbsp;<span class="ident" id="4532995">_</span><span class="op" id="4532996">,</span>&nbsp;<span class="ident" id="4532998">b</span>&nbsp;<span class="op" id="4533000">:=</span>&nbsp;<span class="keyword" id="4533003">range</span>&nbsp;<span class="ident" id="4533009">v</span>&nbsp;<span class="op" id="4533011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4533015">n</span>&nbsp;<span class="op" id="4533017">&lt;&lt;=</span>&nbsp;<span class="num" id="4533021">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4533025">switch</span>&nbsp;<span class="op" id="4533032">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4533036">case</span>&nbsp;<span class="string" id="4533041">&#39;0&#39;</span>&nbsp;<span class="op" id="4533045">&lt;=</span>&nbsp;<span class="ident" id="4533048">b</span>&nbsp;<span class="op" id="4533050">&amp;&amp;</span>&nbsp;<span class="ident" id="4533053">b</span>&nbsp;<span class="op" id="4533055">&lt;=</span>&nbsp;<span class="string" id="4533058">&#39;9&#39;</span><span class="op" id="4533061">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4533066">b</span>&nbsp;<span class="op" id="4533068">=</span>&nbsp;<span class="ident" id="4533070">b</span>&nbsp;<span class="op" id="4533072">-</span>&nbsp;<span class="string" id="4533074">&#39;0&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4533080">case</span>&nbsp;<span class="string" id="4533085">&#39;a&#39;</span>&nbsp;<span class="op" id="4533089">&lt;=</span>&nbsp;<span class="ident" id="4533092">b</span>&nbsp;<span class="op" id="4533094">&amp;&amp;</span>&nbsp;<span class="ident" id="4533097">b</span>&nbsp;<span class="op" id="4533099">&lt;=</span>&nbsp;<span class="string" id="4533102">&#39;f&#39;</span><span class="op" id="4533105">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4533110">b</span>&nbsp;<span class="op" id="4533112">=</span>&nbsp;<span class="ident" id="4533114">b</span>&nbsp;<span class="op" id="4533116">-</span>&nbsp;<span class="string" id="4533118">&#39;a&#39;</span>&nbsp;<span class="op" id="4533122">+</span>&nbsp;<span class="num" id="4533124">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4533129">case</span>&nbsp;<span class="string" id="4533134">&#39;A&#39;</span>&nbsp;<span class="op" id="4533138">&lt;=</span>&nbsp;<span class="ident" id="4533141">b</span>&nbsp;<span class="op" id="4533143">&amp;&amp;</span>&nbsp;<span class="ident" id="4533146">b</span>&nbsp;<span class="op" id="4533148">&lt;=</span>&nbsp;<span class="string" id="4533151">&#39;F&#39;</span><span class="op" id="4533154">:</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4533159">b</span>&nbsp;<span class="op" id="4533161">=</span>&nbsp;<span class="ident" id="4533163">b</span>&nbsp;<span class="op" id="4533165">-</span>&nbsp;<span class="string" id="4533167">&#39;A&#39;</span>&nbsp;<span class="op" id="4533171">+</span>&nbsp;<span class="num" id="4533173">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4533178">default</span><span class="op" id="4533185">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4533190">return</span>&nbsp;<span class="num" id="4533197">0</span><span class="op" id="4533198">,</span>&nbsp;<span class="ident" id="4533200">errors</span><span class="op" id="4533206">.</span><span class="ident" id="4533207">New</span><span class="op" id="4533210">(</span><span class="string" id="4533211">&#34;invalid&nbsp;byte&nbsp;in&nbsp;chunk&nbsp;length&#34;</span><span class="op" id="4533241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4533245">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4533249">n</span>&nbsp;<span class="op" id="4533251">|=</span>&nbsp;<span class="ident" id="4533254">uint64</span><span class="op" id="4533260">(</span><span class="ident" id="4533261">b</span><span class="op" id="4533262">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4533265">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4533268">return</span><br>
<span class="lineno"></span><span class="op" id="4533275">}</span>
</div>
</body>
</html>
