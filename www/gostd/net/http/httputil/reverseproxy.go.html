<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html" class="current">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6352587">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6352642">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6352696">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6352747">//&nbsp;HTTP&nbsp;reverse&nbsp;proxy&nbsp;handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6352778">package</span>&nbsp;<span class="ident" id="6352786">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6352796">import</span>&nbsp;<span class="op" id="6352803">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6352806">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6352812">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6352819">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6352826">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6352838">&#34;net/url&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6352849">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6352860">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6352868">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6352875">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="6352878">//&nbsp;onExitFlushLoop&nbsp;is&nbsp;a&nbsp;callback&nbsp;set&nbsp;by&nbsp;tests&nbsp;to&nbsp;detect&nbsp;the&nbsp;state&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6352951">//&nbsp;flushLoop()&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="6352977">var</span>&nbsp;<span class="ident" id="6352981">onExitFlushLoop</span>&nbsp;<span class="keyword" id="6352997">func</span><span class="op" id="6353001">(</span><span class="op" id="6353002">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6353005">//&nbsp;ReverseProxy&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;Handler&nbsp;that&nbsp;takes&nbsp;an&nbsp;incoming&nbsp;request&nbsp;and</span><br>
<span class="lineno">25</span><span class="comment" id="6353075">//&nbsp;sends&nbsp;it&nbsp;to&nbsp;another&nbsp;server,&nbsp;proxying&nbsp;the&nbsp;response&nbsp;back&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6353140">//&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="6353151">type</span>&nbsp;<span class="ident" id="6353156">ReverseProxy</span>&nbsp;<span class="keyword" id="6353169">struct</span>&nbsp;<span class="op" id="6353176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6353179">//&nbsp;Director&nbsp;must&nbsp;be&nbsp;a&nbsp;function&nbsp;which&nbsp;modifies</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6353226">//&nbsp;the&nbsp;request&nbsp;into&nbsp;a&nbsp;new&nbsp;request&nbsp;to&nbsp;be&nbsp;sent</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6353272">//&nbsp;using&nbsp;Transport.&nbsp;Its&nbsp;response&nbsp;is&nbsp;then&nbsp;copied</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6353321">//&nbsp;back&nbsp;to&nbsp;the&nbsp;original&nbsp;client&nbsp;unmodified.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353365">Director</span>&nbsp;<span class="keyword" id="6353374">func</span><span class="op" id="6353378">(</span><span class="op" id="6353379">*</span><span class="ident" id="6353380">http</span><span class="op" id="6353384">.</span><span class="ident" id="6353385">Request</span><span class="op" id="6353392">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6353396">//&nbsp;The&nbsp;transport&nbsp;used&nbsp;to&nbsp;perform&nbsp;proxy&nbsp;requests.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6353446">//&nbsp;If&nbsp;nil,&nbsp;http.DefaultTransport&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353489">Transport</span>&nbsp;<span class="ident" id="6353499">http</span><span class="op" id="6353503">.</span><span class="ident" id="6353504">RoundTripper</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6353519">//&nbsp;FlushInterval&nbsp;specifies&nbsp;the&nbsp;flush&nbsp;interval</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6353566">//&nbsp;to&nbsp;flush&nbsp;to&nbsp;the&nbsp;client&nbsp;while&nbsp;copying&nbsp;the</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6353611">//&nbsp;response&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6353630">//&nbsp;If&nbsp;zero,&nbsp;no&nbsp;periodic&nbsp;flushing&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353673">FlushInterval</span>&nbsp;<span class="ident" id="6353687">time</span><span class="op" id="6353691">.</span><span class="ident" id="6353692">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6353703">//&nbsp;ErrorLog&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;logger&nbsp;for&nbsp;errors</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6353756">//&nbsp;that&nbsp;occur&nbsp;when&nbsp;attempting&nbsp;to&nbsp;proxy&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6353809">//&nbsp;If&nbsp;nil,&nbsp;logging&nbsp;goes&nbsp;to&nbsp;os.Stderr&nbsp;via&nbsp;the&nbsp;log&nbsp;package&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6353869">//&nbsp;standard&nbsp;logger.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353890">ErrorLog</span>&nbsp;<span class="op" id="6353899">*</span><span class="ident" id="6353900">log</span><span class="op" id="6353903">.</span><span class="ident" id="6353904">Logger</span><br>
<span class="lineno"></span><span class="op" id="6353911">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="6353914">func</span>&nbsp;<span class="ident" id="6353919">singleJoiningSlash</span><span class="op" id="6353937">(</span><span class="ident" id="6353938">a</span><span class="op" id="6353939">,</span>&nbsp;<span class="ident" id="6353941">b</span>&nbsp;<span class="builtintype" id="6353943">string</span><span class="op" id="6353949">)</span>&nbsp;<span class="builtintype" id="6353951">string</span>&nbsp;<span class="op" id="6353958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353961">aslash</span>&nbsp;<span class="op" id="6353968">:=</span>&nbsp;<span class="ident" id="6353971">strings</span><span class="op" id="6353978">.</span><span class="ident" id="6353979">HasSuffix</span><span class="op" id="6353988">(</span><span class="ident" id="6353989">a</span><span class="op" id="6353990">,</span>&nbsp;<span class="string" id="6353992">&#34;/&#34;</span><span class="op" id="6353995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353998">bslash</span>&nbsp;<span class="op" id="6354005">:=</span>&nbsp;<span class="ident" id="6354008">strings</span><span class="op" id="6354015">.</span><span class="ident" id="6354016">HasPrefix</span><span class="op" id="6354025">(</span><span class="ident" id="6354026">b</span><span class="op" id="6354027">,</span>&nbsp;<span class="string" id="6354029">&#34;/&#34;</span><span class="op" id="6354032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6354035">switch</span>&nbsp;<span class="op" id="6354042">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6354045">case</span>&nbsp;<span class="ident" id="6354050">aslash</span>&nbsp;<span class="op" id="6354057">&amp;&amp;</span>&nbsp;<span class="ident" id="6354060">bslash</span><span class="op" id="6354066">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6354070">return</span>&nbsp;<span class="ident" id="6354077">a</span>&nbsp;<span class="op" id="6354079">+</span>&nbsp;<span class="ident" id="6354081">b</span><span class="op" id="6354082">[</span><span class="num" id="6354083">1</span><span class="op" id="6354084">:</span><span class="op" id="6354085">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6354088">case</span>&nbsp;<span class="op" id="6354093">!</span><span class="ident" id="6354094">aslash</span>&nbsp;<span class="op" id="6354101">&amp;&amp;</span>&nbsp;<span class="op" id="6354104">!</span><span class="ident" id="6354105">bslash</span><span class="op" id="6354111">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6354115">return</span>&nbsp;<span class="ident" id="6354122">a</span>&nbsp;<span class="op" id="6354124">+</span>&nbsp;<span class="string" id="6354126">&#34;/&#34;</span>&nbsp;<span class="op" id="6354130">+</span>&nbsp;<span class="ident" id="6354132">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6354135">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6354138">return</span>&nbsp;<span class="ident" id="6354145">a</span>&nbsp;<span class="op" id="6354147">+</span>&nbsp;<span class="ident" id="6354149">b</span><br>
<span class="lineno"></span><span class="op" id="6354151">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6354154">//&nbsp;NewSingleHostReverseProxy&nbsp;returns&nbsp;a&nbsp;new&nbsp;ReverseProxy&nbsp;that&nbsp;rewrites</span><br>
<span class="lineno"></span><span class="comment" id="6354224">//&nbsp;URLs&nbsp;to&nbsp;the&nbsp;scheme,&nbsp;host,&nbsp;and&nbsp;base&nbsp;path&nbsp;provided&nbsp;in&nbsp;target.&nbsp;If&nbsp;the</span><br>
<span class="lineno">65</span><span class="comment" id="6354294">//&nbsp;target&#39;s&nbsp;path&nbsp;is&nbsp;&#34;/base&#34;&nbsp;and&nbsp;the&nbsp;incoming&nbsp;request&nbsp;was&nbsp;for&nbsp;&#34;/dir&#34;,</span><br>
<span class="lineno"></span><span class="comment" id="6354363">//&nbsp;the&nbsp;target&nbsp;request&nbsp;will&nbsp;be&nbsp;for&nbsp;/base/dir.</span><br>
<span class="lineno"></span><span class="keyword" id="6354408">func</span>&nbsp;<span class="ident" id="6354413">NewSingleHostReverseProxy</span><span class="op" id="6354438">(</span><span class="ident" id="6354439">target</span>&nbsp;<span class="op" id="6354446">*</span><span class="ident" id="6354447">url</span><span class="op" id="6354450">.</span><span class="ident" id="6354451">URL</span><span class="op" id="6354454">)</span>&nbsp;<span class="op" id="6354456">*</span><span class="ident" id="6354457">ReverseProxy</span>&nbsp;<span class="op" id="6354470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6354473">targetQuery</span>&nbsp;<span class="op" id="6354485">:=</span>&nbsp;<span class="ident" id="6354488">target</span><span class="op" id="6354494">.</span><span class="ident" id="6354495">RawQuery</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6354505">director</span>&nbsp;<span class="op" id="6354514">:=</span>&nbsp;<span class="keyword" id="6354517">func</span><span class="op" id="6354521">(</span><span class="ident" id="6354522">req</span>&nbsp;<span class="op" id="6354526">*</span><span class="ident" id="6354527">http</span><span class="op" id="6354531">.</span><span class="ident" id="6354532">Request</span><span class="op" id="6354539">)</span>&nbsp;<span class="op" id="6354541">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6354545">req</span><span class="op" id="6354548">.</span><span class="ident" id="6354549">URL</span><span class="op" id="6354552">.</span><span class="ident" id="6354553">Scheme</span>&nbsp;<span class="op" id="6354560">=</span>&nbsp;<span class="ident" id="6354562">target</span><span class="op" id="6354568">.</span><span class="ident" id="6354569">Scheme</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6354578">req</span><span class="op" id="6354581">.</span><span class="ident" id="6354582">URL</span><span class="op" id="6354585">.</span><span class="ident" id="6354586">Host</span>&nbsp;<span class="op" id="6354591">=</span>&nbsp;<span class="ident" id="6354593">target</span><span class="op" id="6354599">.</span><span class="ident" id="6354600">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6354607">req</span><span class="op" id="6354610">.</span><span class="ident" id="6354611">URL</span><span class="op" id="6354614">.</span><span class="ident" id="6354615">Path</span>&nbsp;<span class="op" id="6354620">=</span>&nbsp;<span class="ident" id="6354622">singleJoiningSlash</span><span class="op" id="6354640">(</span><span class="ident" id="6354641">target</span><span class="op" id="6354647">.</span><span class="ident" id="6354648">Path</span><span class="op" id="6354652">,</span>&nbsp;<span class="ident" id="6354654">req</span><span class="op" id="6354657">.</span><span class="ident" id="6354658">URL</span><span class="op" id="6354661">.</span><span class="ident" id="6354662">Path</span><span class="op" id="6354666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6354670">if</span>&nbsp;<span class="ident" id="6354673">targetQuery</span>&nbsp;<span class="op" id="6354685">==</span>&nbsp;<span class="string" id="6354688">&#34;&#34;</span>&nbsp;<span class="op" id="6354691">||</span>&nbsp;<span class="ident" id="6354694">req</span><span class="op" id="6354697">.</span><span class="ident" id="6354698">URL</span><span class="op" id="6354701">.</span><span class="ident" id="6354702">RawQuery</span>&nbsp;<span class="op" id="6354711">==</span>&nbsp;<span class="string" id="6354714">&#34;&#34;</span>&nbsp;<span class="op" id="6354717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6354722">req</span><span class="op" id="6354725">.</span><span class="ident" id="6354726">URL</span><span class="op" id="6354729">.</span><span class="ident" id="6354730">RawQuery</span>&nbsp;<span class="op" id="6354739">=</span>&nbsp;<span class="ident" id="6354741">targetQuery</span>&nbsp;<span class="op" id="6354753">+</span>&nbsp;<span class="ident" id="6354755">req</span><span class="op" id="6354758">.</span><span class="ident" id="6354759">URL</span><span class="op" id="6354762">.</span><span class="ident" id="6354763">RawQuery</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6354774">}</span>&nbsp;<span class="keyword" id="6354776">else</span>&nbsp;<span class="op" id="6354781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6354786">req</span><span class="op" id="6354789">.</span><span class="ident" id="6354790">URL</span><span class="op" id="6354793">.</span><span class="ident" id="6354794">RawQuery</span>&nbsp;<span class="op" id="6354803">=</span>&nbsp;<span class="ident" id="6354805">targetQuery</span>&nbsp;<span class="op" id="6354817">+</span>&nbsp;<span class="string" id="6354819">&#34;&amp;&#34;</span>&nbsp;<span class="op" id="6354823">+</span>&nbsp;<span class="ident" id="6354825">req</span><span class="op" id="6354828">.</span><span class="ident" id="6354829">URL</span><span class="op" id="6354832">.</span><span class="ident" id="6354833">RawQuery</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6354844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6354847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6354850">return</span>&nbsp;<span class="op" id="6354857">&amp;</span><span class="ident" id="6354858">ReverseProxy</span><span class="op" id="6354870">{</span><span class="ident" id="6354871">Director</span><span class="op" id="6354879">:</span>&nbsp;<span class="ident" id="6354881">director</span><span class="op" id="6354889">}</span><br>
<span class="lineno">80</span><span class="op" id="6354891">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6354894">func</span>&nbsp;<span class="ident" id="6354899">copyHeader</span><span class="op" id="6354909">(</span><span class="ident" id="6354910">dst</span><span class="op" id="6354913">,</span>&nbsp;<span class="ident" id="6354915">src</span>&nbsp;<span class="ident" id="6354919">http</span><span class="op" id="6354923">.</span><span class="ident" id="6354924">Header</span><span class="op" id="6354930">)</span>&nbsp;<span class="op" id="6354932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6354935">for</span>&nbsp;<span class="ident" id="6354939">k</span><span class="op" id="6354940">,</span>&nbsp;<span class="ident" id="6354942">vv</span>&nbsp;<span class="op" id="6354945">:=</span>&nbsp;<span class="keyword" id="6354948">range</span>&nbsp;<span class="ident" id="6354954">src</span>&nbsp;<span class="op" id="6354958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6354962">for</span>&nbsp;<span class="ident" id="6354966">_</span><span class="op" id="6354967">,</span>&nbsp;<span class="ident" id="6354969">v</span>&nbsp;<span class="op" id="6354971">:=</span>&nbsp;<span class="keyword" id="6354974">range</span>&nbsp;<span class="ident" id="6354980">vv</span>&nbsp;<span class="op" id="6354983">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6354988">dst</span><span class="op" id="6354991">.</span><span class="ident" id="6354992">Add</span><span class="op" id="6354995">(</span><span class="ident" id="6354996">k</span><span class="op" id="6354997">,</span>&nbsp;<span class="ident" id="6354999">v</span><span class="op" id="6355000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6355004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6355007">}</span><br>
<span class="lineno"></span><span class="op" id="6355009">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="6355012">//&nbsp;Hop-by-hop&nbsp;headers.&nbsp;These&nbsp;are&nbsp;removed&nbsp;when&nbsp;sent&nbsp;to&nbsp;the&nbsp;backend.</span><br>
<span class="lineno"></span><span class="comment" id="6355079">//&nbsp;http://www.w3.org/Protocols/rfc2616/rfc2616-sec13.html</span><br>
<span class="lineno"></span><span class="keyword" id="6355137">var</span>&nbsp;<span class="ident" id="6355141">hopHeaders</span>&nbsp;<span class="op" id="6355152">=</span>&nbsp;<span class="op" id="6355154">[</span><span class="op" id="6355155">]</span><span class="builtintype" id="6355156">string</span><span class="op" id="6355162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6355165">&#34;Connection&#34;</span><span class="op" id="6355177">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6355180">&#34;Keep-Alive&#34;</span><span class="op" id="6355192">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6355195">&#34;Proxy-Authenticate&#34;</span><span class="op" id="6355215">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6355218">&#34;Proxy-Authorization&#34;</span><span class="op" id="6355239">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6355242">&#34;Te&#34;</span><span class="op" id="6355246">,</span>&nbsp;<span class="comment" id="6355248">//&nbsp;canonicalized&nbsp;version&nbsp;of&nbsp;&#34;TE&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6355282">&#34;Trailers&#34;</span><span class="op" id="6355292">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6355295">&#34;Transfer-Encoding&#34;</span><span class="op" id="6355314">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6355317">&#34;Upgrade&#34;</span><span class="op" id="6355326">,</span><br>
<span class="lineno"></span><span class="op" id="6355328">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6355331">func</span>&nbsp;<span class="op" id="6355336">(</span><span class="ident" id="6355337">p</span>&nbsp;<span class="op" id="6355339">*</span><span class="ident" id="6355340">ReverseProxy</span><span class="op" id="6355352">)</span>&nbsp;<span class="ident" id="6355354">ServeHTTP</span><span class="op" id="6355363">(</span><span class="ident" id="6355364">rw</span>&nbsp;<span class="ident" id="6355367">http</span><span class="op" id="6355371">.</span><span class="ident" id="6355372">ResponseWriter</span><span class="op" id="6355386">,</span>&nbsp;<span class="ident" id="6355388">req</span>&nbsp;<span class="op" id="6355392">*</span><span class="ident" id="6355393">http</span><span class="op" id="6355397">.</span><span class="ident" id="6355398">Request</span><span class="op" id="6355405">)</span>&nbsp;<span class="op" id="6355407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6355410">transport</span>&nbsp;<span class="op" id="6355420">:=</span>&nbsp;<span class="ident" id="6355423">p</span><span class="op" id="6355424">.</span><span class="ident" id="6355425">Transport</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6355436">if</span>&nbsp;<span class="ident" id="6355439">transport</span>&nbsp;<span class="op" id="6355449">==</span>&nbsp;<span class="ident" id="6355452">nil</span>&nbsp;<span class="op" id="6355456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6355460">transport</span>&nbsp;<span class="op" id="6355470">=</span>&nbsp;<span class="ident" id="6355472">http</span><span class="op" id="6355476">.</span><span class="ident" id="6355477">DefaultTransport</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6355495">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6355499">outreq</span>&nbsp;<span class="op" id="6355506">:=</span>&nbsp;<span class="builtinfunc" id="6355509">new</span><span class="op" id="6355512">(</span><span class="ident" id="6355513">http</span><span class="op" id="6355517">.</span><span class="ident" id="6355518">Request</span><span class="op" id="6355525">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6355528">*</span><span class="ident" id="6355529">outreq</span>&nbsp;<span class="op" id="6355536">=</span>&nbsp;<span class="op" id="6355538">*</span><span class="ident" id="6355539">req</span>&nbsp;<span class="comment" id="6355543">//&nbsp;includes&nbsp;shallow&nbsp;copies&nbsp;of&nbsp;maps,&nbsp;but&nbsp;okay</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6355590">p</span><span class="op" id="6355591">.</span><span class="ident" id="6355592">Director</span><span class="op" id="6355600">(</span><span class="ident" id="6355601">outreq</span><span class="op" id="6355607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6355610">outreq</span><span class="op" id="6355616">.</span><span class="ident" id="6355617">Proto</span>&nbsp;<span class="op" id="6355623">=</span>&nbsp;<span class="string" id="6355625">&#34;HTTP/1.1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6355637">outreq</span><span class="op" id="6355643">.</span><span class="ident" id="6355644">ProtoMajor</span>&nbsp;<span class="op" id="6355655">=</span>&nbsp;<span class="num" id="6355657">1</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6355660">outreq</span><span class="op" id="6355666">.</span><span class="ident" id="6355667">ProtoMinor</span>&nbsp;<span class="op" id="6355678">=</span>&nbsp;<span class="num" id="6355680">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6355683">outreq</span><span class="op" id="6355689">.</span><span class="ident" id="6355690">Close</span>&nbsp;<span class="op" id="6355696">=</span>&nbsp;<span class="builtintype" id="6355698">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6355706">//&nbsp;Remove&nbsp;hop-by-hop&nbsp;headers&nbsp;to&nbsp;the&nbsp;backend.&nbsp;&nbsp;Especially</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6355764">//&nbsp;important&nbsp;is&nbsp;&#34;Connection&#34;&nbsp;because&nbsp;we&nbsp;want&nbsp;a&nbsp;persistent</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6355823">//&nbsp;connection,&nbsp;regardless&nbsp;of&nbsp;what&nbsp;the&nbsp;client&nbsp;sent&nbsp;to&nbsp;us.&nbsp;&nbsp;This</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6355887">//&nbsp;is&nbsp;modifying&nbsp;the&nbsp;same&nbsp;underlying&nbsp;map&nbsp;from&nbsp;req&nbsp;(shallow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6355946">//&nbsp;copied&nbsp;above)&nbsp;so&nbsp;we&nbsp;only&nbsp;copy&nbsp;it&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6355997">copiedHeaders</span>&nbsp;<span class="op" id="6356011">:=</span>&nbsp;<span class="builtintype" id="6356014">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6356021">for</span>&nbsp;<span class="ident" id="6356025">_</span><span class="op" id="6356026">,</span>&nbsp;<span class="ident" id="6356028">h</span>&nbsp;<span class="op" id="6356030">:=</span>&nbsp;<span class="keyword" id="6356033">range</span>&nbsp;<span class="ident" id="6356039">hopHeaders</span>&nbsp;<span class="op" id="6356050">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6356054">if</span>&nbsp;<span class="ident" id="6356057">outreq</span><span class="op" id="6356063">.</span><span class="ident" id="6356064">Header</span><span class="op" id="6356070">.</span><span class="ident" id="6356071">Get</span><span class="op" id="6356074">(</span><span class="ident" id="6356075">h</span><span class="op" id="6356076">)</span>&nbsp;<span class="op" id="6356078">!=</span>&nbsp;<span class="string" id="6356081">&#34;&#34;</span>&nbsp;<span class="op" id="6356084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6356089">if</span>&nbsp;<span class="op" id="6356092">!</span><span class="ident" id="6356093">copiedHeaders</span>&nbsp;<span class="op" id="6356107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6356113">outreq</span><span class="op" id="6356119">.</span><span class="ident" id="6356120">Header</span>&nbsp;<span class="op" id="6356127">=</span>&nbsp;<span class="builtinfunc" id="6356129">make</span><span class="op" id="6356133">(</span><span class="ident" id="6356134">http</span><span class="op" id="6356138">.</span><span class="ident" id="6356139">Header</span><span class="op" id="6356145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6356151">copyHeader</span><span class="op" id="6356161">(</span><span class="ident" id="6356162">outreq</span><span class="op" id="6356168">.</span><span class="ident" id="6356169">Header</span><span class="op" id="6356175">,</span>&nbsp;<span class="ident" id="6356177">req</span><span class="op" id="6356180">.</span><span class="ident" id="6356181">Header</span><span class="op" id="6356187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6356193">copiedHeaders</span>&nbsp;<span class="op" id="6356207">=</span>&nbsp;<span class="builtintype" id="6356209">true</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6356217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6356222">outreq</span><span class="op" id="6356228">.</span><span class="ident" id="6356229">Header</span><span class="op" id="6356235">.</span><span class="ident" id="6356236">Del</span><span class="op" id="6356239">(</span><span class="ident" id="6356240">h</span><span class="op" id="6356241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6356245">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6356248">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6356252">if</span>&nbsp;<span class="ident" id="6356255">clientIP</span><span class="op" id="6356263">,</span>&nbsp;<span class="ident" id="6356265">_</span><span class="op" id="6356266">,</span>&nbsp;<span class="ident" id="6356268">err</span>&nbsp;<span class="op" id="6356272">:=</span>&nbsp;<span class="ident" id="6356275">net</span><span class="op" id="6356278">.</span><span class="ident" id="6356279">SplitHostPort</span><span class="op" id="6356292">(</span><span class="ident" id="6356293">req</span><span class="op" id="6356296">.</span><span class="ident" id="6356297">RemoteAddr</span><span class="op" id="6356307">)</span><span class="op" id="6356308">;</span>&nbsp;<span class="ident" id="6356310">err</span>&nbsp;<span class="op" id="6356314">==</span>&nbsp;<span class="ident" id="6356317">nil</span>&nbsp;<span class="op" id="6356321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6356325">//&nbsp;If&nbsp;we&nbsp;aren&#39;t&nbsp;the&nbsp;first&nbsp;proxy&nbsp;retain&nbsp;prior</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6356372">//&nbsp;X-Forwarded-For&nbsp;information&nbsp;as&nbsp;a&nbsp;comma+space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6356422">//&nbsp;separated&nbsp;list&nbsp;and&nbsp;fold&nbsp;multiple&nbsp;headers&nbsp;into&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6356478">if</span>&nbsp;<span class="ident" id="6356481">prior</span><span class="op" id="6356486">,</span>&nbsp;<span class="ident" id="6356488">ok</span>&nbsp;<span class="op" id="6356491">:=</span>&nbsp;<span class="ident" id="6356494">outreq</span><span class="op" id="6356500">.</span><span class="ident" id="6356501">Header</span><span class="op" id="6356507">[</span><span class="string" id="6356508">&#34;X-Forwarded-For&#34;</span><span class="op" id="6356525">]</span><span class="op" id="6356526">;</span>&nbsp;<span class="ident" id="6356528">ok</span>&nbsp;<span class="op" id="6356531">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6356536">clientIP</span>&nbsp;<span class="op" id="6356545">=</span>&nbsp;<span class="ident" id="6356547">strings</span><span class="op" id="6356554">.</span><span class="ident" id="6356555">Join</span><span class="op" id="6356559">(</span><span class="ident" id="6356560">prior</span><span class="op" id="6356565">,</span>&nbsp;<span class="string" id="6356567">&#34;,&nbsp;&#34;</span><span class="op" id="6356571">)</span>&nbsp;<span class="op" id="6356573">+</span>&nbsp;<span class="string" id="6356575">&#34;,&nbsp;&#34;</span>&nbsp;<span class="op" id="6356580">+</span>&nbsp;<span class="ident" id="6356582">clientIP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6356593">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6356597">outreq</span><span class="op" id="6356603">.</span><span class="ident" id="6356604">Header</span><span class="op" id="6356610">.</span><span class="ident" id="6356611">Set</span><span class="op" id="6356614">(</span><span class="string" id="6356615">&#34;X-Forwarded-For&#34;</span><span class="op" id="6356632">,</span>&nbsp;<span class="ident" id="6356634">clientIP</span><span class="op" id="6356642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6356645">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6356649">res</span><span class="op" id="6356652">,</span>&nbsp;<span class="ident" id="6356654">err</span>&nbsp;<span class="op" id="6356658">:=</span>&nbsp;<span class="ident" id="6356661">transport</span><span class="op" id="6356670">.</span><span class="ident" id="6356671">RoundTrip</span><span class="op" id="6356680">(</span><span class="ident" id="6356681">outreq</span><span class="op" id="6356687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6356690">if</span>&nbsp;<span class="ident" id="6356693">err</span>&nbsp;<span class="op" id="6356697">!=</span>&nbsp;<span class="ident" id="6356700">nil</span>&nbsp;<span class="op" id="6356704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6356708">p</span><span class="op" id="6356709">.</span><span class="ident" id="6356710">logf</span><span class="op" id="6356714">(</span><span class="string" id="6356715">&#34;http:&nbsp;proxy&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="6356738">,</span>&nbsp;<span class="ident" id="6356740">err</span><span class="op" id="6356743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6356747">rw</span><span class="op" id="6356749">.</span><span class="ident" id="6356750">WriteHeader</span><span class="op" id="6356761">(</span><span class="ident" id="6356762">http</span><span class="op" id="6356766">.</span><span class="ident" id="6356767">StatusInternalServerError</span><span class="op" id="6356792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6356796">return</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6356804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6356807">defer</span>&nbsp;<span class="ident" id="6356813">res</span><span class="op" id="6356816">.</span><span class="ident" id="6356817">Body</span><span class="op" id="6356821">.</span><span class="ident" id="6356822">Close</span><span class="op" id="6356827">(</span><span class="op" id="6356828">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6356832">for</span>&nbsp;<span class="ident" id="6356836">_</span><span class="op" id="6356837">,</span>&nbsp;<span class="ident" id="6356839">h</span>&nbsp;<span class="op" id="6356841">:=</span>&nbsp;<span class="keyword" id="6356844">range</span>&nbsp;<span class="ident" id="6356850">hopHeaders</span>&nbsp;<span class="op" id="6356861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6356865">res</span><span class="op" id="6356868">.</span><span class="ident" id="6356869">Header</span><span class="op" id="6356875">.</span><span class="ident" id="6356876">Del</span><span class="op" id="6356879">(</span><span class="ident" id="6356880">h</span><span class="op" id="6356881">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6356884">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6356888">copyHeader</span><span class="op" id="6356898">(</span><span class="ident" id="6356899">rw</span><span class="op" id="6356901">.</span><span class="ident" id="6356902">Header</span><span class="op" id="6356908">(</span><span class="op" id="6356909">)</span><span class="op" id="6356910">,</span>&nbsp;<span class="ident" id="6356912">res</span><span class="op" id="6356915">.</span><span class="ident" id="6356916">Header</span><span class="op" id="6356922">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6356926">rw</span><span class="op" id="6356928">.</span><span class="ident" id="6356929">WriteHeader</span><span class="op" id="6356940">(</span><span class="ident" id="6356941">res</span><span class="op" id="6356944">.</span><span class="ident" id="6356945">StatusCode</span><span class="op" id="6356955">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6356958">p</span><span class="op" id="6356959">.</span><span class="ident" id="6356960">copyResponse</span><span class="op" id="6356972">(</span><span class="ident" id="6356973">rw</span><span class="op" id="6356975">,</span>&nbsp;<span class="ident" id="6356977">res</span><span class="op" id="6356980">.</span><span class="ident" id="6356981">Body</span><span class="op" id="6356985">)</span><br>
<span class="lineno"></span><span class="op" id="6356987">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6356990">func</span>&nbsp;<span class="op" id="6356995">(</span><span class="ident" id="6356996">p</span>&nbsp;<span class="op" id="6356998">*</span><span class="ident" id="6356999">ReverseProxy</span><span class="op" id="6357011">)</span>&nbsp;<span class="ident" id="6357013">copyResponse</span><span class="op" id="6357025">(</span><span class="ident" id="6357026">dst</span>&nbsp;<span class="ident" id="6357030">io</span><span class="op" id="6357032">.</span><span class="ident" id="6357033">Writer</span><span class="op" id="6357039">,</span>&nbsp;<span class="ident" id="6357041">src</span>&nbsp;<span class="ident" id="6357045">io</span><span class="op" id="6357047">.</span><span class="ident" id="6357048">Reader</span><span class="op" id="6357054">)</span>&nbsp;<span class="op" id="6357056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6357059">if</span>&nbsp;<span class="ident" id="6357062">p</span><span class="op" id="6357063">.</span><span class="ident" id="6357064">FlushInterval</span>&nbsp;<span class="op" id="6357078">!=</span>&nbsp;<span class="num" id="6357081">0</span>&nbsp;<span class="op" id="6357083">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6357087">if</span>&nbsp;<span class="ident" id="6357090">wf</span><span class="op" id="6357092">,</span>&nbsp;<span class="ident" id="6357094">ok</span>&nbsp;<span class="op" id="6357097">:=</span>&nbsp;<span class="ident" id="6357100">dst</span><span class="op" id="6357103">.</span><span class="op" id="6357104">(</span><span class="ident" id="6357105">writeFlusher</span><span class="op" id="6357117">)</span><span class="op" id="6357118">;</span>&nbsp;<span class="ident" id="6357120">ok</span>&nbsp;<span class="op" id="6357123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6357128">mlw</span>&nbsp;<span class="op" id="6357132">:=</span>&nbsp;<span class="op" id="6357135">&amp;</span><span class="ident" id="6357136">maxLatencyWriter</span><span class="op" id="6357152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6357158">dst</span><span class="op" id="6357161">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6357167">wf</span><span class="op" id="6357169">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6357175">latency</span><span class="op" id="6357182">:</span>&nbsp;<span class="ident" id="6357184">p</span><span class="op" id="6357185">.</span><span class="ident" id="6357186">FlushInterval</span><span class="op" id="6357199">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6357205">done</span><span class="op" id="6357209">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6357214">make</span><span class="op" id="6357218">(</span><span class="keyword" id="6357219">chan</span>&nbsp;<span class="builtintype" id="6357224">bool</span><span class="op" id="6357228">)</span><span class="op" id="6357229">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6357234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6357239">go</span>&nbsp;<span class="ident" id="6357242">mlw</span><span class="op" id="6357245">.</span><span class="ident" id="6357246">flushLoop</span><span class="op" id="6357255">(</span><span class="op" id="6357256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6357261">defer</span>&nbsp;<span class="ident" id="6357267">mlw</span><span class="op" id="6357270">.</span><span class="ident" id="6357271">stop</span><span class="op" id="6357275">(</span><span class="op" id="6357276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6357281">dst</span>&nbsp;<span class="op" id="6357285">=</span>&nbsp;<span class="ident" id="6357287">mlw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6357293">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6357296">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6357300">io</span><span class="op" id="6357302">.</span><span class="ident" id="6357303">Copy</span><span class="op" id="6357307">(</span><span class="ident" id="6357308">dst</span><span class="op" id="6357311">,</span>&nbsp;<span class="ident" id="6357313">src</span><span class="op" id="6357316">)</span><br>
<span class="lineno"></span><span class="op" id="6357318">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="6357321">func</span>&nbsp;<span class="op" id="6357326">(</span><span class="ident" id="6357327">p</span>&nbsp;<span class="op" id="6357329">*</span><span class="ident" id="6357330">ReverseProxy</span><span class="op" id="6357342">)</span>&nbsp;<span class="ident" id="6357344">logf</span><span class="op" id="6357348">(</span><span class="ident" id="6357349">format</span>&nbsp;<span class="builtintype" id="6357356">string</span><span class="op" id="6357362">,</span>&nbsp;<span class="ident" id="6357364">args</span>&nbsp;<span class="op" id="6357369">...</span><span class="keyword" id="6357372">interface</span><span class="op" id="6357381">{</span><span class="op" id="6357382">}</span><span class="op" id="6357383">)</span>&nbsp;<span class="op" id="6357385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6357388">if</span>&nbsp;<span class="ident" id="6357391">p</span><span class="op" id="6357392">.</span><span class="ident" id="6357393">ErrorLog</span>&nbsp;<span class="op" id="6357402">!=</span>&nbsp;<span class="ident" id="6357405">nil</span>&nbsp;<span class="op" id="6357409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6357413">p</span><span class="op" id="6357414">.</span><span class="ident" id="6357415">ErrorLog</span><span class="op" id="6357423">.</span><span class="ident" id="6357424">Printf</span><span class="op" id="6357430">(</span><span class="ident" id="6357431">format</span><span class="op" id="6357437">,</span>&nbsp;<span class="ident" id="6357439">args</span><span class="op" id="6357443">...</span><span class="op" id="6357446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6357449">}</span>&nbsp;<span class="keyword" id="6357451">else</span>&nbsp;<span class="op" id="6357456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6357460">log</span><span class="op" id="6357463">.</span><span class="ident" id="6357464">Printf</span><span class="op" id="6357470">(</span><span class="ident" id="6357471">format</span><span class="op" id="6357477">,</span>&nbsp;<span class="ident" id="6357479">args</span><span class="op" id="6357483">...</span><span class="op" id="6357486">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6357489">}</span><br>
<span class="lineno"></span><span class="op" id="6357491">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6357494">type</span>&nbsp;<span class="ident" id="6357499">writeFlusher</span>&nbsp;<span class="keyword" id="6357512">interface</span>&nbsp;<span class="op" id="6357522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6357525">io</span><span class="op" id="6357527">.</span><span class="ident" id="6357528">Writer</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6357536">http</span><span class="op" id="6357540">.</span><span class="ident" id="6357541">Flusher</span><br>
<span class="lineno"></span><span class="op" id="6357549">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6357552">type</span>&nbsp;<span class="ident" id="6357557">maxLatencyWriter</span>&nbsp;<span class="keyword" id="6357574">struct</span>&nbsp;<span class="op" id="6357581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6357584">dst</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6357592">writeFlusher</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6357606">latency</span>&nbsp;<span class="ident" id="6357614">time</span><span class="op" id="6357618">.</span><span class="ident" id="6357619">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6357630">lk</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6357635">sync</span><span class="op" id="6357639">.</span><span class="ident" id="6357640">Mutex</span>&nbsp;<span class="comment" id="6357646">//&nbsp;protects&nbsp;Write&nbsp;+&nbsp;Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6357673">done</span>&nbsp;<span class="keyword" id="6357678">chan</span>&nbsp;<span class="builtintype" id="6357683">bool</span><br>
<span class="lineno"></span><span class="op" id="6357688">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="keyword" id="6357691">func</span>&nbsp;<span class="op" id="6357696">(</span><span class="ident" id="6357697">m</span>&nbsp;<span class="op" id="6357699">*</span><span class="ident" id="6357700">maxLatencyWriter</span><span class="op" id="6357716">)</span>&nbsp;<span class="ident" id="6357718">Write</span><span class="op" id="6357723">(</span><span class="ident" id="6357724">p</span>&nbsp;<span class="op" id="6357726">[</span><span class="op" id="6357727">]</span><span class="builtintype" id="6357728">byte</span><span class="op" id="6357732">)</span>&nbsp;<span class="op" id="6357734">(</span><span class="builtintype" id="6357735">int</span><span class="op" id="6357738">,</span>&nbsp;<span class="builtintype" id="6357740">error</span><span class="op" id="6357745">)</span>&nbsp;<span class="op" id="6357747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6357750">m</span><span class="op" id="6357751">.</span><span class="ident" id="6357752">lk</span><span class="op" id="6357754">.</span><span class="ident" id="6357755">Lock</span><span class="op" id="6357759">(</span><span class="op" id="6357760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6357763">defer</span>&nbsp;<span class="ident" id="6357769">m</span><span class="op" id="6357770">.</span><span class="ident" id="6357771">lk</span><span class="op" id="6357773">.</span><span class="ident" id="6357774">Unlock</span><span class="op" id="6357780">(</span><span class="op" id="6357781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6357784">return</span>&nbsp;<span class="ident" id="6357791">m</span><span class="op" id="6357792">.</span><span class="ident" id="6357793">dst</span><span class="op" id="6357796">.</span><span class="ident" id="6357797">Write</span><span class="op" id="6357802">(</span><span class="ident" id="6357803">p</span><span class="op" id="6357804">)</span><br>
<span class="lineno">205</span><span class="op" id="6357806">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6357809">func</span>&nbsp;<span class="op" id="6357814">(</span><span class="ident" id="6357815">m</span>&nbsp;<span class="op" id="6357817">*</span><span class="ident" id="6357818">maxLatencyWriter</span><span class="op" id="6357834">)</span>&nbsp;<span class="ident" id="6357836">flushLoop</span><span class="op" id="6357845">(</span><span class="op" id="6357846">)</span>&nbsp;<span class="op" id="6357848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6357851">t</span>&nbsp;<span class="op" id="6357853">:=</span>&nbsp;<span class="ident" id="6357856">time</span><span class="op" id="6357860">.</span><span class="ident" id="6357861">NewTicker</span><span class="op" id="6357870">(</span><span class="ident" id="6357871">m</span><span class="op" id="6357872">.</span><span class="ident" id="6357873">latency</span><span class="op" id="6357880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6357883">defer</span>&nbsp;<span class="ident" id="6357889">t</span><span class="op" id="6357890">.</span><span class="ident" id="6357891">Stop</span><span class="op" id="6357895">(</span><span class="op" id="6357896">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6357899">for</span>&nbsp;<span class="op" id="6357903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6357907">select</span>&nbsp;<span class="op" id="6357914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6357918">case</span>&nbsp;<span class="op" id="6357923">&lt;-</span><span class="ident" id="6357925">m</span><span class="op" id="6357926">.</span><span class="ident" id="6357927">done</span><span class="op" id="6357931">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6357936">if</span>&nbsp;<span class="ident" id="6357939">onExitFlushLoop</span>&nbsp;<span class="op" id="6357955">!=</span>&nbsp;<span class="ident" id="6357958">nil</span>&nbsp;<span class="op" id="6357962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6357968">onExitFlushLoop</span><span class="op" id="6357983">(</span><span class="op" id="6357984">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6357989">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6357994">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6358003">case</span>&nbsp;<span class="op" id="6358008">&lt;-</span><span class="ident" id="6358010">t</span><span class="op" id="6358011">.</span><span class="ident" id="6358012">C</span><span class="op" id="6358013">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6358018">m</span><span class="op" id="6358019">.</span><span class="ident" id="6358020">lk</span><span class="op" id="6358022">.</span><span class="ident" id="6358023">Lock</span><span class="op" id="6358027">(</span><span class="op" id="6358028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6358033">m</span><span class="op" id="6358034">.</span><span class="ident" id="6358035">dst</span><span class="op" id="6358038">.</span><span class="ident" id="6358039">Flush</span><span class="op" id="6358044">(</span><span class="op" id="6358045">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6358050">m</span><span class="op" id="6358051">.</span><span class="ident" id="6358052">lk</span><span class="op" id="6358054">.</span><span class="ident" id="6358055">Unlock</span><span class="op" id="6358061">(</span><span class="op" id="6358062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6358066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6358069">}</span><br>
<span class="lineno"></span><span class="op" id="6358071">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="6358074">func</span>&nbsp;<span class="op" id="6358079">(</span><span class="ident" id="6358080">m</span>&nbsp;<span class="op" id="6358082">*</span><span class="ident" id="6358083">maxLatencyWriter</span><span class="op" id="6358099">)</span>&nbsp;<span class="ident" id="6358101">stop</span><span class="op" id="6358105">(</span><span class="op" id="6358106">)</span>&nbsp;<span class="op" id="6358108">{</span>&nbsp;<span class="ident" id="6358110">m</span><span class="op" id="6358111">.</span><span class="ident" id="6358112">done</span>&nbsp;<span class="op" id="6358117">&lt;-</span>&nbsp;<span class="builtintype" id="6358120">true</span>&nbsp;<span class="op" id="6358125">}</span>
</div>
</body>
</html>
