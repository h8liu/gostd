<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="6280147">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6280202">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6280256">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6280307">package</span>&nbsp;<span class="ident" id="6280315">jpeg</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6280321">import</span>&nbsp;<span class="op" id="6280328">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6280331">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="6280336">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="6280339">//&nbsp;maxCodeLength&nbsp;is&nbsp;the&nbsp;maximum&nbsp;(inclusive)&nbsp;number&nbsp;of&nbsp;bits&nbsp;in&nbsp;a&nbsp;Huffman&nbsp;code.</span><br>
<span class="lineno"></span><span class="keyword" id="6280417">const</span>&nbsp;<span class="ident" id="6280423">maxCodeLength</span>&nbsp;<span class="op" id="6280437">=</span>&nbsp;<span class="num" id="6280439">16</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6280443">//&nbsp;maxNCodes&nbsp;is&nbsp;the&nbsp;maximum&nbsp;(inclusive)&nbsp;number&nbsp;of&nbsp;codes&nbsp;in&nbsp;a&nbsp;Huffman&nbsp;tree.</span><br>
<span class="lineno">15</span><span class="keyword" id="6280518">const</span>&nbsp;<span class="ident" id="6280524">maxNCodes</span>&nbsp;<span class="op" id="6280534">=</span>&nbsp;<span class="num" id="6280536">256</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6280541">//&nbsp;lutSize&nbsp;is&nbsp;the&nbsp;log-2&nbsp;size&nbsp;of&nbsp;the&nbsp;Huffman&nbsp;decoder&#39;s&nbsp;look-up&nbsp;table.</span><br>
<span class="lineno"></span><span class="keyword" id="6280610">const</span>&nbsp;<span class="ident" id="6280616">lutSize</span>&nbsp;<span class="op" id="6280624">=</span>&nbsp;<span class="num" id="6280626">8</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="6280629">//&nbsp;huffman&nbsp;is&nbsp;a&nbsp;Huffman&nbsp;decoder,&nbsp;specified&nbsp;in&nbsp;section&nbsp;C.</span><br>
<span class="lineno"></span><span class="keyword" id="6280686">type</span>&nbsp;<span class="ident" id="6280691">huffman</span>&nbsp;<span class="keyword" id="6280699">struct</span>&nbsp;<span class="op" id="6280706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6280709">//&nbsp;length&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;codes&nbsp;in&nbsp;the&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6280756">nCodes</span>&nbsp;<span class="builtintype" id="6280763">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6280770">//&nbsp;lut&nbsp;is&nbsp;the&nbsp;look-up&nbsp;table&nbsp;for&nbsp;the&nbsp;next&nbsp;lutSize&nbsp;bits&nbsp;in&nbsp;the&nbsp;bit-stream.</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6280844">//&nbsp;The&nbsp;high&nbsp;8&nbsp;bits&nbsp;of&nbsp;the&nbsp;uint16&nbsp;are&nbsp;the&nbsp;encoded&nbsp;value.&nbsp;The&nbsp;low&nbsp;8&nbsp;bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6280916">//&nbsp;are&nbsp;1&nbsp;plus&nbsp;the&nbsp;code&nbsp;length,&nbsp;or&nbsp;0&nbsp;if&nbsp;the&nbsp;value&nbsp;is&nbsp;too&nbsp;large&nbsp;to&nbsp;fit&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6280989">//&nbsp;lutSize&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6281007">lut</span>&nbsp;<span class="op" id="6281011">[</span><span class="num" id="6281012">1</span>&nbsp;<span class="op" id="6281014">&lt;&lt;</span>&nbsp;<span class="ident" id="6281017">lutSize</span><span class="op" id="6281024">]</span><span class="builtintype" id="6281025">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6281033">//&nbsp;vals&nbsp;are&nbsp;the&nbsp;decoded&nbsp;values,&nbsp;sorted&nbsp;by&nbsp;their&nbsp;encoding.</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6281092">vals</span>&nbsp;<span class="op" id="6281097">[</span><span class="ident" id="6281098">maxNCodes</span><span class="op" id="6281107">]</span><span class="builtintype" id="6281108">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6281115">//&nbsp;minCodes[i]&nbsp;is&nbsp;the&nbsp;minimum&nbsp;code&nbsp;of&nbsp;length&nbsp;i,&nbsp;or&nbsp;-1&nbsp;if&nbsp;there&nbsp;are&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6281186">//&nbsp;codes&nbsp;of&nbsp;that&nbsp;length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6281212">minCodes</span>&nbsp;<span class="op" id="6281221">[</span><span class="ident" id="6281222">maxCodeLength</span><span class="op" id="6281235">]</span><span class="builtintype" id="6281236">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6281243">//&nbsp;maxCodes[i]&nbsp;is&nbsp;the&nbsp;maximum&nbsp;code&nbsp;of&nbsp;length&nbsp;i,&nbsp;or&nbsp;-1&nbsp;if&nbsp;there&nbsp;are&nbsp;no</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6281314">//&nbsp;codes&nbsp;of&nbsp;that&nbsp;length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6281340">maxCodes</span>&nbsp;<span class="op" id="6281349">[</span><span class="ident" id="6281350">maxCodeLength</span><span class="op" id="6281363">]</span><span class="builtintype" id="6281364">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6281371">//&nbsp;valsIndices[i]&nbsp;is&nbsp;the&nbsp;index&nbsp;into&nbsp;vals&nbsp;of&nbsp;minCodes[i].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6281429">valsIndices</span>&nbsp;<span class="op" id="6281441">[</span><span class="ident" id="6281442">maxCodeLength</span><span class="op" id="6281455">]</span><span class="builtintype" id="6281456">int32</span><br>
<span class="lineno"></span><span class="op" id="6281462">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="6281465">//&nbsp;errShortHuffmanData&nbsp;means&nbsp;that&nbsp;an&nbsp;unexpected&nbsp;EOF&nbsp;occurred&nbsp;while&nbsp;decoding</span><br>
<span class="lineno"></span><span class="comment" id="6281541">//&nbsp;Huffman&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="6281558">var</span>&nbsp;<span class="ident" id="6281562">errShortHuffmanData</span>&nbsp;<span class="op" id="6281582">=</span>&nbsp;<span class="ident" id="6281584">FormatError</span><span class="op" id="6281595">(</span><span class="string" id="6281596">&#34;short&nbsp;Huffman&nbsp;data&#34;</span><span class="op" id="6281616">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="6281619">//&nbsp;ensureNBits&nbsp;reads&nbsp;bytes&nbsp;from&nbsp;the&nbsp;byte&nbsp;buffer&nbsp;to&nbsp;ensure&nbsp;that&nbsp;d.bits.n&nbsp;is&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="6281697">//&nbsp;least&nbsp;n.&nbsp;For&nbsp;best&nbsp;performance&nbsp;(avoiding&nbsp;function&nbsp;calls&nbsp;inside&nbsp;hot&nbsp;loops),</span><br>
<span class="lineno"></span><span class="comment" id="6281774">//&nbsp;the&nbsp;caller&nbsp;is&nbsp;the&nbsp;one&nbsp;responsible&nbsp;for&nbsp;first&nbsp;checking&nbsp;that&nbsp;d.bits.n&nbsp;&lt;&nbsp;n.</span><br>
<span class="lineno"></span><span class="keyword" id="6281849">func</span>&nbsp;<span class="op" id="6281854">(</span><span class="ident" id="6281855">d</span>&nbsp;<span class="op" id="6281857">*</span><span class="ident" id="6281858">decoder</span><span class="op" id="6281865">)</span>&nbsp;<span class="ident" id="6281867">ensureNBits</span><span class="op" id="6281878">(</span><span class="ident" id="6281879">n</span>&nbsp;<span class="builtintype" id="6281881">int32</span><span class="op" id="6281886">)</span>&nbsp;<span class="builtintype" id="6281888">error</span>&nbsp;<span class="op" id="6281894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6281897">for</span>&nbsp;<span class="op" id="6281901">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6281905">c</span><span class="op" id="6281906">,</span>&nbsp;<span class="ident" id="6281908">err</span>&nbsp;<span class="op" id="6281912">:=</span>&nbsp;<span class="ident" id="6281915">d</span><span class="op" id="6281916">.</span><span class="ident" id="6281917">readByteStuffedByte</span><span class="op" id="6281936">(</span><span class="op" id="6281937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6281941">if</span>&nbsp;<span class="ident" id="6281944">err</span>&nbsp;<span class="op" id="6281948">!=</span>&nbsp;<span class="ident" id="6281951">nil</span>&nbsp;<span class="op" id="6281955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6281960">if</span>&nbsp;<span class="ident" id="6281963">err</span>&nbsp;<span class="op" id="6281967">==</span>&nbsp;<span class="ident" id="6281970">io</span><span class="op" id="6281972">.</span><span class="ident" id="6281973">EOF</span>&nbsp;<span class="op" id="6281977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6281983">return</span>&nbsp;<span class="ident" id="6281990">errShortHuffmanData</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6282013">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6282018">return</span>&nbsp;<span class="ident" id="6282025">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6282031">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6282035">d</span><span class="op" id="6282036">.</span><span class="ident" id="6282037">bits</span><span class="op" id="6282041">.</span><span class="ident" id="6282042">a</span>&nbsp;<span class="op" id="6282044">=</span>&nbsp;<span class="ident" id="6282046">d</span><span class="op" id="6282047">.</span><span class="ident" id="6282048">bits</span><span class="op" id="6282052">.</span><span class="ident" id="6282053">a</span><span class="op" id="6282054">&lt;&lt;</span><span class="num" id="6282056">8</span>&nbsp;<span class="op" id="6282058">|</span>&nbsp;<span class="builtintype" id="6282060">uint32</span><span class="op" id="6282066">(</span><span class="ident" id="6282067">c</span><span class="op" id="6282068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6282072">d</span><span class="op" id="6282073">.</span><span class="ident" id="6282074">bits</span><span class="op" id="6282078">.</span><span class="ident" id="6282079">n</span>&nbsp;<span class="op" id="6282081">+=</span>&nbsp;<span class="num" id="6282084">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6282088">if</span>&nbsp;<span class="ident" id="6282091">d</span><span class="op" id="6282092">.</span><span class="ident" id="6282093">bits</span><span class="op" id="6282097">.</span><span class="ident" id="6282098">m</span>&nbsp;<span class="op" id="6282100">==</span>&nbsp;<span class="num" id="6282103">0</span>&nbsp;<span class="op" id="6282105">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6282110">d</span><span class="op" id="6282111">.</span><span class="ident" id="6282112">bits</span><span class="op" id="6282116">.</span><span class="ident" id="6282117">m</span>&nbsp;<span class="op" id="6282119">=</span>&nbsp;<span class="num" id="6282121">1</span>&nbsp;<span class="op" id="6282123">&lt;&lt;</span>&nbsp;<span class="num" id="6282126">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6282130">}</span>&nbsp;<span class="keyword" id="6282132">else</span>&nbsp;<span class="op" id="6282137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6282142">d</span><span class="op" id="6282143">.</span><span class="ident" id="6282144">bits</span><span class="op" id="6282148">.</span><span class="ident" id="6282149">m</span>&nbsp;<span class="op" id="6282151">&lt;&lt;=</span>&nbsp;<span class="num" id="6282155">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6282159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6282163">if</span>&nbsp;<span class="ident" id="6282166">d</span><span class="op" id="6282167">.</span><span class="ident" id="6282168">bits</span><span class="op" id="6282172">.</span><span class="ident" id="6282173">n</span>&nbsp;<span class="op" id="6282175">&gt;=</span>&nbsp;<span class="ident" id="6282178">n</span>&nbsp;<span class="op" id="6282180">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6282185">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6282193">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6282196">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6282199">return</span>&nbsp;<span class="ident" id="6282206">nil</span><br>
<span class="lineno"></span><span class="op" id="6282210">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="comment" id="6282213">//&nbsp;receiveExtend&nbsp;is&nbsp;the&nbsp;composition&nbsp;of&nbsp;RECEIVE&nbsp;and&nbsp;EXTEND,&nbsp;specified&nbsp;in&nbsp;section</span><br>
<span class="lineno"></span><span class="comment" id="6282293">//&nbsp;F.2.2.1.</span><br>
<span class="lineno"></span><span class="keyword" id="6282305">func</span>&nbsp;<span class="op" id="6282310">(</span><span class="ident" id="6282311">d</span>&nbsp;<span class="op" id="6282313">*</span><span class="ident" id="6282314">decoder</span><span class="op" id="6282321">)</span>&nbsp;<span class="ident" id="6282323">receiveExtend</span><span class="op" id="6282336">(</span><span class="ident" id="6282337">t</span>&nbsp;<span class="builtintype" id="6282339">uint8</span><span class="op" id="6282344">)</span>&nbsp;<span class="op" id="6282346">(</span><span class="builtintype" id="6282347">int32</span><span class="op" id="6282352">,</span>&nbsp;<span class="builtintype" id="6282354">error</span><span class="op" id="6282359">)</span>&nbsp;<span class="op" id="6282361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6282364">if</span>&nbsp;<span class="ident" id="6282367">d</span><span class="op" id="6282368">.</span><span class="ident" id="6282369">bits</span><span class="op" id="6282373">.</span><span class="ident" id="6282374">n</span>&nbsp;<span class="op" id="6282376">&lt;</span>&nbsp;<span class="builtintype" id="6282378">int32</span><span class="op" id="6282383">(</span><span class="ident" id="6282384">t</span><span class="op" id="6282385">)</span>&nbsp;<span class="op" id="6282387">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6282391">if</span>&nbsp;<span class="ident" id="6282394">err</span>&nbsp;<span class="op" id="6282398">:=</span>&nbsp;<span class="ident" id="6282401">d</span><span class="op" id="6282402">.</span><span class="ident" id="6282403">ensureNBits</span><span class="op" id="6282414">(</span><span class="builtintype" id="6282415">int32</span><span class="op" id="6282420">(</span><span class="ident" id="6282421">t</span><span class="op" id="6282422">)</span><span class="op" id="6282423">)</span><span class="op" id="6282424">;</span>&nbsp;<span class="ident" id="6282426">err</span>&nbsp;<span class="op" id="6282430">!=</span>&nbsp;<span class="ident" id="6282433">nil</span>&nbsp;<span class="op" id="6282437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6282442">return</span>&nbsp;<span class="num" id="6282449">0</span><span class="op" id="6282450">,</span>&nbsp;<span class="ident" id="6282452">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6282458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6282461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6282464">d</span><span class="op" id="6282465">.</span><span class="ident" id="6282466">bits</span><span class="op" id="6282470">.</span><span class="ident" id="6282471">n</span>&nbsp;<span class="op" id="6282473">-=</span>&nbsp;<span class="builtintype" id="6282476">int32</span><span class="op" id="6282481">(</span><span class="ident" id="6282482">t</span><span class="op" id="6282483">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6282486">d</span><span class="op" id="6282487">.</span><span class="ident" id="6282488">bits</span><span class="op" id="6282492">.</span><span class="ident" id="6282493">m</span>&nbsp;<span class="op" id="6282495">&gt;&gt;=</span>&nbsp;<span class="ident" id="6282499">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6282502">s</span>&nbsp;<span class="op" id="6282504">:=</span>&nbsp;<span class="builtintype" id="6282507">int32</span><span class="op" id="6282512">(</span><span class="num" id="6282513">1</span><span class="op" id="6282514">)</span>&nbsp;<span class="op" id="6282516">&lt;&lt;</span>&nbsp;<span class="ident" id="6282519">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6282522">x</span>&nbsp;<span class="op" id="6282524">:=</span>&nbsp;<span class="builtintype" id="6282527">int32</span><span class="op" id="6282532">(</span><span class="ident" id="6282533">d</span><span class="op" id="6282534">.</span><span class="ident" id="6282535">bits</span><span class="op" id="6282539">.</span><span class="ident" id="6282540">a</span><span class="op" id="6282541">&gt;&gt;</span><span class="builtintype" id="6282543">uint8</span><span class="op" id="6282548">(</span><span class="ident" id="6282549">d</span><span class="op" id="6282550">.</span><span class="ident" id="6282551">bits</span><span class="op" id="6282555">.</span><span class="ident" id="6282556">n</span><span class="op" id="6282557">)</span><span class="op" id="6282558">)</span>&nbsp;<span class="op" id="6282560">&amp;</span>&nbsp;<span class="op" id="6282562">(</span><span class="ident" id="6282563">s</span>&nbsp;<span class="op" id="6282565">-</span>&nbsp;<span class="num" id="6282567">1</span><span class="op" id="6282568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6282571">if</span>&nbsp;<span class="ident" id="6282574">x</span>&nbsp;<span class="op" id="6282576">&lt;</span>&nbsp;<span class="ident" id="6282578">s</span><span class="op" id="6282579">&gt;&gt;</span><span class="num" id="6282581">1</span>&nbsp;<span class="op" id="6282583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6282587">x</span>&nbsp;<span class="op" id="6282589">+=</span>&nbsp;<span class="op" id="6282592">(</span><span class="op" id="6282593">(</span><span class="op" id="6282594">-</span><span class="num" id="6282595">1</span><span class="op" id="6282596">)</span>&nbsp;<span class="op" id="6282598">&lt;&lt;</span>&nbsp;<span class="ident" id="6282601">t</span><span class="op" id="6282602">)</span>&nbsp;<span class="op" id="6282604">+</span>&nbsp;<span class="num" id="6282606">1</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6282609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6282612">return</span>&nbsp;<span class="ident" id="6282619">x</span><span class="op" id="6282620">,</span>&nbsp;<span class="ident" id="6282622">nil</span><br>
<span class="lineno"></span><span class="op" id="6282626">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6282629">//&nbsp;processDHT&nbsp;processes&nbsp;a&nbsp;Define&nbsp;Huffman&nbsp;Table&nbsp;marker,&nbsp;and&nbsp;initializes&nbsp;a&nbsp;huffman</span><br>
<span class="lineno">90</span><span class="comment" id="6282710">//&nbsp;struct&nbsp;from&nbsp;its&nbsp;contents.&nbsp;Specified&nbsp;in&nbsp;section&nbsp;B.2.4.2.</span><br>
<span class="lineno"></span><span class="keyword" id="6282769">func</span>&nbsp;<span class="op" id="6282774">(</span><span class="ident" id="6282775">d</span>&nbsp;<span class="op" id="6282777">*</span><span class="ident" id="6282778">decoder</span><span class="op" id="6282785">)</span>&nbsp;<span class="ident" id="6282787">processDHT</span><span class="op" id="6282797">(</span><span class="ident" id="6282798">n</span>&nbsp;<span class="builtintype" id="6282800">int</span><span class="op" id="6282803">)</span>&nbsp;<span class="builtintype" id="6282805">error</span>&nbsp;<span class="op" id="6282811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6282814">for</span>&nbsp;<span class="ident" id="6282818">n</span>&nbsp;<span class="op" id="6282820">&gt;</span>&nbsp;<span class="num" id="6282822">0</span>&nbsp;<span class="op" id="6282824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6282828">if</span>&nbsp;<span class="ident" id="6282831">n</span>&nbsp;<span class="op" id="6282833">&lt;</span>&nbsp;<span class="num" id="6282835">17</span>&nbsp;<span class="op" id="6282838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6282843">return</span>&nbsp;<span class="ident" id="6282850">FormatError</span><span class="op" id="6282861">(</span><span class="string" id="6282862">&#34;DHT&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="6282884">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6282888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6282892">if</span>&nbsp;<span class="ident" id="6282895">err</span>&nbsp;<span class="op" id="6282899">:=</span>&nbsp;<span class="ident" id="6282902">d</span><span class="op" id="6282903">.</span><span class="ident" id="6282904">readFull</span><span class="op" id="6282912">(</span><span class="ident" id="6282913">d</span><span class="op" id="6282914">.</span><span class="ident" id="6282915">tmp</span><span class="op" id="6282918">[</span><span class="op" id="6282919">:</span><span class="num" id="6282920">17</span><span class="op" id="6282922">]</span><span class="op" id="6282923">)</span><span class="op" id="6282924">;</span>&nbsp;<span class="ident" id="6282926">err</span>&nbsp;<span class="op" id="6282930">!=</span>&nbsp;<span class="ident" id="6282933">nil</span>&nbsp;<span class="op" id="6282937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6282942">return</span>&nbsp;<span class="ident" id="6282949">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6282955">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6282959">tc</span>&nbsp;<span class="op" id="6282962">:=</span>&nbsp;<span class="ident" id="6282965">d</span><span class="op" id="6282966">.</span><span class="ident" id="6282967">tmp</span><span class="op" id="6282970">[</span><span class="num" id="6282971">0</span><span class="op" id="6282972">]</span>&nbsp;<span class="op" id="6282974">&gt;&gt;</span>&nbsp;<span class="num" id="6282977">4</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6282981">if</span>&nbsp;<span class="ident" id="6282984">tc</span>&nbsp;<span class="op" id="6282987">&gt;</span>&nbsp;<span class="ident" id="6282989">maxTc</span>&nbsp;<span class="op" id="6282995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6283000">return</span>&nbsp;<span class="ident" id="6283007">FormatError</span><span class="op" id="6283018">(</span><span class="string" id="6283019">&#34;bad&nbsp;Tc&nbsp;value&#34;</span><span class="op" id="6283033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6283037">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6283041">th</span>&nbsp;<span class="op" id="6283044">:=</span>&nbsp;<span class="ident" id="6283047">d</span><span class="op" id="6283048">.</span><span class="ident" id="6283049">tmp</span><span class="op" id="6283052">[</span><span class="num" id="6283053">0</span><span class="op" id="6283054">]</span>&nbsp;<span class="op" id="6283056">&amp;</span>&nbsp;<span class="num" id="6283058">0x0f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6283065">if</span>&nbsp;<span class="ident" id="6283068">th</span>&nbsp;<span class="op" id="6283071">&gt;</span>&nbsp;<span class="ident" id="6283073">maxTh</span>&nbsp;<span class="op" id="6283079">||</span>&nbsp;<span class="op" id="6283082">!</span><span class="ident" id="6283083">d</span><span class="op" id="6283084">.</span><span class="ident" id="6283085">progressive</span>&nbsp;<span class="op" id="6283097">&amp;&amp;</span>&nbsp;<span class="ident" id="6283100">th</span>&nbsp;<span class="op" id="6283103">&gt;</span>&nbsp;<span class="num" id="6283105">1</span>&nbsp;<span class="op" id="6283107">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6283112">return</span>&nbsp;<span class="ident" id="6283119">FormatError</span><span class="op" id="6283130">(</span><span class="string" id="6283131">&#34;bad&nbsp;Th&nbsp;value&#34;</span><span class="op" id="6283145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6283149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6283153">h</span>&nbsp;<span class="op" id="6283155">:=</span>&nbsp;<span class="op" id="6283158">&amp;</span><span class="ident" id="6283159">d</span><span class="op" id="6283160">.</span><span class="ident" id="6283161">huff</span><span class="op" id="6283165">[</span><span class="ident" id="6283166">tc</span><span class="op" id="6283168">]</span><span class="op" id="6283169">[</span><span class="ident" id="6283170">th</span><span class="op" id="6283172">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6283177">//&nbsp;Read&nbsp;nCodes&nbsp;and&nbsp;h.vals&nbsp;(and&nbsp;derive&nbsp;h.nCodes).</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6283228">//&nbsp;nCodes[i]&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;codes&nbsp;with&nbsp;code&nbsp;length&nbsp;i.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6283286">//&nbsp;h.nCodes&nbsp;is&nbsp;the&nbsp;total&nbsp;number&nbsp;of&nbsp;codes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6283330">h</span><span class="op" id="6283331">.</span><span class="ident" id="6283332">nCodes</span>&nbsp;<span class="op" id="6283339">=</span>&nbsp;<span class="num" id="6283341">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6283345">var</span>&nbsp;<span class="ident" id="6283349">nCodes</span>&nbsp;<span class="op" id="6283356">[</span><span class="ident" id="6283357">maxCodeLength</span><span class="op" id="6283370">]</span><span class="builtintype" id="6283371">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6283379">for</span>&nbsp;<span class="ident" id="6283383">i</span>&nbsp;<span class="op" id="6283385">:=</span>&nbsp;<span class="keyword" id="6283388">range</span>&nbsp;<span class="ident" id="6283394">nCodes</span>&nbsp;<span class="op" id="6283401">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6283406">nCodes</span><span class="op" id="6283412">[</span><span class="ident" id="6283413">i</span><span class="op" id="6283414">]</span>&nbsp;<span class="op" id="6283416">=</span>&nbsp;<span class="builtintype" id="6283418">int32</span><span class="op" id="6283423">(</span><span class="ident" id="6283424">d</span><span class="op" id="6283425">.</span><span class="ident" id="6283426">tmp</span><span class="op" id="6283429">[</span><span class="ident" id="6283430">i</span><span class="op" id="6283431">+</span><span class="num" id="6283432">1</span><span class="op" id="6283433">]</span><span class="op" id="6283434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6283439">h</span><span class="op" id="6283440">.</span><span class="ident" id="6283441">nCodes</span>&nbsp;<span class="op" id="6283448">+=</span>&nbsp;<span class="ident" id="6283451">nCodes</span><span class="op" id="6283457">[</span><span class="ident" id="6283458">i</span><span class="op" id="6283459">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6283463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6283467">if</span>&nbsp;<span class="ident" id="6283470">h</span><span class="op" id="6283471">.</span><span class="ident" id="6283472">nCodes</span>&nbsp;<span class="op" id="6283479">==</span>&nbsp;<span class="num" id="6283482">0</span>&nbsp;<span class="op" id="6283484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6283489">return</span>&nbsp;<span class="ident" id="6283496">FormatError</span><span class="op" id="6283507">(</span><span class="string" id="6283508">&#34;Huffman&nbsp;table&nbsp;has&nbsp;zero&nbsp;length&#34;</span><span class="op" id="6283539">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6283543">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6283547">if</span>&nbsp;<span class="ident" id="6283550">h</span><span class="op" id="6283551">.</span><span class="ident" id="6283552">nCodes</span>&nbsp;<span class="op" id="6283559">&gt;</span>&nbsp;<span class="ident" id="6283561">maxNCodes</span>&nbsp;<span class="op" id="6283571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6283576">return</span>&nbsp;<span class="ident" id="6283583">FormatError</span><span class="op" id="6283594">(</span><span class="string" id="6283595">&#34;Huffman&nbsp;table&nbsp;has&nbsp;excessive&nbsp;length&#34;</span><span class="op" id="6283631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6283635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6283639">n</span>&nbsp;<span class="op" id="6283641">-=</span>&nbsp;<span class="builtintype" id="6283644">int</span><span class="op" id="6283647">(</span><span class="ident" id="6283648">h</span><span class="op" id="6283649">.</span><span class="ident" id="6283650">nCodes</span><span class="op" id="6283656">)</span>&nbsp;<span class="op" id="6283658">+</span>&nbsp;<span class="num" id="6283660">17</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6283665">if</span>&nbsp;<span class="ident" id="6283668">n</span>&nbsp;<span class="op" id="6283670">&lt;</span>&nbsp;<span class="num" id="6283672">0</span>&nbsp;<span class="op" id="6283674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6283679">return</span>&nbsp;<span class="ident" id="6283686">FormatError</span><span class="op" id="6283697">(</span><span class="string" id="6283698">&#34;DHT&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="6283720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6283724">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6283728">if</span>&nbsp;<span class="ident" id="6283731">err</span>&nbsp;<span class="op" id="6283735">:=</span>&nbsp;<span class="ident" id="6283738">d</span><span class="op" id="6283739">.</span><span class="ident" id="6283740">readFull</span><span class="op" id="6283748">(</span><span class="ident" id="6283749">h</span><span class="op" id="6283750">.</span><span class="ident" id="6283751">vals</span><span class="op" id="6283755">[</span><span class="op" id="6283756">:</span><span class="ident" id="6283757">h</span><span class="op" id="6283758">.</span><span class="ident" id="6283759">nCodes</span><span class="op" id="6283765">]</span><span class="op" id="6283766">)</span><span class="op" id="6283767">;</span>&nbsp;<span class="ident" id="6283769">err</span>&nbsp;<span class="op" id="6283773">!=</span>&nbsp;<span class="ident" id="6283776">nil</span>&nbsp;<span class="op" id="6283780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6283785">return</span>&nbsp;<span class="ident" id="6283792">err</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6283798">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6283803">//&nbsp;Derive&nbsp;the&nbsp;look-up&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6283834">for</span>&nbsp;<span class="ident" id="6283838">i</span>&nbsp;<span class="op" id="6283840">:=</span>&nbsp;<span class="keyword" id="6283843">range</span>&nbsp;<span class="ident" id="6283849">h</span><span class="op" id="6283850">.</span><span class="ident" id="6283851">lut</span>&nbsp;<span class="op" id="6283855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6283860">h</span><span class="op" id="6283861">.</span><span class="ident" id="6283862">lut</span><span class="op" id="6283865">[</span><span class="ident" id="6283866">i</span><span class="op" id="6283867">]</span>&nbsp;<span class="op" id="6283869">=</span>&nbsp;<span class="num" id="6283871">0</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6283875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6283879">var</span>&nbsp;<span class="ident" id="6283883">x</span><span class="op" id="6283884">,</span>&nbsp;<span class="ident" id="6283886">code</span>&nbsp;<span class="builtintype" id="6283891">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6283900">for</span>&nbsp;<span class="ident" id="6283904">i</span>&nbsp;<span class="op" id="6283906">:=</span>&nbsp;<span class="builtintype" id="6283909">uint32</span><span class="op" id="6283915">(</span><span class="num" id="6283916">0</span><span class="op" id="6283917">)</span><span class="op" id="6283918">;</span>&nbsp;<span class="ident" id="6283920">i</span>&nbsp;<span class="op" id="6283922">&lt;</span>&nbsp;<span class="ident" id="6283924">lutSize</span><span class="op" id="6283931">;</span>&nbsp;<span class="ident" id="6283933">i</span><span class="op" id="6283934">++</span>&nbsp;<span class="op" id="6283937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6283942">code</span>&nbsp;<span class="op" id="6283947">&lt;&lt;=</span>&nbsp;<span class="num" id="6283951">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6283956">for</span>&nbsp;<span class="ident" id="6283960">j</span>&nbsp;<span class="op" id="6283962">:=</span>&nbsp;<span class="builtintype" id="6283965">int32</span><span class="op" id="6283970">(</span><span class="num" id="6283971">0</span><span class="op" id="6283972">)</span><span class="op" id="6283973">;</span>&nbsp;<span class="ident" id="6283975">j</span>&nbsp;<span class="op" id="6283977">&lt;</span>&nbsp;<span class="ident" id="6283979">nCodes</span><span class="op" id="6283985">[</span><span class="ident" id="6283986">i</span><span class="op" id="6283987">]</span><span class="op" id="6283988">;</span>&nbsp;<span class="ident" id="6283990">j</span><span class="op" id="6283991">++</span>&nbsp;<span class="op" id="6283994">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6284000">//&nbsp;The&nbsp;codeLength&nbsp;is&nbsp;1+i,&nbsp;so&nbsp;shift&nbsp;code&nbsp;by&nbsp;8-(1+i)&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6284058">//&nbsp;calculate&nbsp;the&nbsp;high&nbsp;bits&nbsp;for&nbsp;every&nbsp;8-bit&nbsp;sequence</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6284114">//&nbsp;whose&nbsp;codeLength&#39;s&nbsp;high&nbsp;bits&nbsp;matches&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6284164">//&nbsp;The&nbsp;high&nbsp;8&nbsp;bits&nbsp;of&nbsp;lutValue&nbsp;are&nbsp;the&nbsp;encoded&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6284222">//&nbsp;The&nbsp;low&nbsp;8&nbsp;bits&nbsp;are&nbsp;1&nbsp;plus&nbsp;the&nbsp;codeLength.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284271">base</span>&nbsp;<span class="op" id="6284276">:=</span>&nbsp;<span class="builtintype" id="6284279">uint8</span><span class="op" id="6284284">(</span><span class="ident" id="6284285">code</span>&nbsp;<span class="op" id="6284290">&lt;&lt;</span>&nbsp;<span class="op" id="6284293">(</span><span class="num" id="6284294">7</span>&nbsp;<span class="op" id="6284296">-</span>&nbsp;<span class="ident" id="6284298">i</span><span class="op" id="6284299">)</span><span class="op" id="6284300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284306">lutValue</span>&nbsp;<span class="op" id="6284315">:=</span>&nbsp;<span class="builtintype" id="6284318">uint16</span><span class="op" id="6284324">(</span><span class="ident" id="6284325">h</span><span class="op" id="6284326">.</span><span class="ident" id="6284327">vals</span><span class="op" id="6284331">[</span><span class="ident" id="6284332">x</span><span class="op" id="6284333">]</span><span class="op" id="6284334">)</span><span class="op" id="6284335">&lt;&lt;</span><span class="num" id="6284337">8</span>&nbsp;<span class="op" id="6284339">|</span>&nbsp;<span class="builtintype" id="6284341">uint16</span><span class="op" id="6284347">(</span><span class="num" id="6284348">2</span><span class="op" id="6284349">+</span><span class="ident" id="6284350">i</span><span class="op" id="6284351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6284357">for</span>&nbsp;<span class="ident" id="6284361">k</span>&nbsp;<span class="op" id="6284363">:=</span>&nbsp;<span class="builtintype" id="6284366">uint8</span><span class="op" id="6284371">(</span><span class="num" id="6284372">0</span><span class="op" id="6284373">)</span><span class="op" id="6284374">;</span>&nbsp;<span class="ident" id="6284376">k</span>&nbsp;<span class="op" id="6284378">&lt;</span>&nbsp;<span class="num" id="6284380">1</span><span class="op" id="6284381">&lt;&lt;</span><span class="op" id="6284383">(</span><span class="num" id="6284384">7</span><span class="op" id="6284385">-</span><span class="ident" id="6284386">i</span><span class="op" id="6284387">)</span><span class="op" id="6284388">;</span>&nbsp;<span class="ident" id="6284390">k</span><span class="op" id="6284391">++</span>&nbsp;<span class="op" id="6284394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284401">h</span><span class="op" id="6284402">.</span><span class="ident" id="6284403">lut</span><span class="op" id="6284406">[</span><span class="ident" id="6284407">base</span><span class="op" id="6284411">|</span><span class="ident" id="6284412">k</span><span class="op" id="6284413">]</span>&nbsp;<span class="op" id="6284415">=</span>&nbsp;<span class="ident" id="6284417">lutValue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6284430">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284436">code</span><span class="op" id="6284440">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284447">x</span><span class="op" id="6284448">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6284454">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6284458">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6284463">//&nbsp;Derive&nbsp;minCodes,&nbsp;maxCodes,&nbsp;and&nbsp;valsIndices.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6284512">var</span>&nbsp;<span class="ident" id="6284516">c</span><span class="op" id="6284517">,</span>&nbsp;<span class="ident" id="6284519">index</span>&nbsp;<span class="builtintype" id="6284525">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6284533">for</span>&nbsp;<span class="ident" id="6284537">i</span><span class="op" id="6284538">,</span>&nbsp;<span class="ident" id="6284540">n</span>&nbsp;<span class="op" id="6284542">:=</span>&nbsp;<span class="keyword" id="6284545">range</span>&nbsp;<span class="ident" id="6284551">nCodes</span>&nbsp;<span class="op" id="6284558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6284563">if</span>&nbsp;<span class="ident" id="6284566">n</span>&nbsp;<span class="op" id="6284568">==</span>&nbsp;<span class="num" id="6284571">0</span>&nbsp;<span class="op" id="6284573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284579">h</span><span class="op" id="6284580">.</span><span class="ident" id="6284581">minCodes</span><span class="op" id="6284589">[</span><span class="ident" id="6284590">i</span><span class="op" id="6284591">]</span>&nbsp;<span class="op" id="6284593">=</span>&nbsp;<span class="op" id="6284595">-</span><span class="num" id="6284596">1</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284602">h</span><span class="op" id="6284603">.</span><span class="ident" id="6284604">maxCodes</span><span class="op" id="6284612">[</span><span class="ident" id="6284613">i</span><span class="op" id="6284614">]</span>&nbsp;<span class="op" id="6284616">=</span>&nbsp;<span class="op" id="6284618">-</span><span class="num" id="6284619">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284625">h</span><span class="op" id="6284626">.</span><span class="ident" id="6284627">valsIndices</span><span class="op" id="6284638">[</span><span class="ident" id="6284639">i</span><span class="op" id="6284640">]</span>&nbsp;<span class="op" id="6284642">=</span>&nbsp;<span class="op" id="6284644">-</span><span class="num" id="6284645">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6284650">}</span>&nbsp;<span class="keyword" id="6284652">else</span>&nbsp;<span class="op" id="6284657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284663">h</span><span class="op" id="6284664">.</span><span class="ident" id="6284665">minCodes</span><span class="op" id="6284673">[</span><span class="ident" id="6284674">i</span><span class="op" id="6284675">]</span>&nbsp;<span class="op" id="6284677">=</span>&nbsp;<span class="ident" id="6284679">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284685">h</span><span class="op" id="6284686">.</span><span class="ident" id="6284687">maxCodes</span><span class="op" id="6284695">[</span><span class="ident" id="6284696">i</span><span class="op" id="6284697">]</span>&nbsp;<span class="op" id="6284699">=</span>&nbsp;<span class="ident" id="6284701">c</span>&nbsp;<span class="op" id="6284703">+</span>&nbsp;<span class="ident" id="6284705">n</span>&nbsp;<span class="op" id="6284707">-</span>&nbsp;<span class="num" id="6284709">1</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284715">h</span><span class="op" id="6284716">.</span><span class="ident" id="6284717">valsIndices</span><span class="op" id="6284728">[</span><span class="ident" id="6284729">i</span><span class="op" id="6284730">]</span>&nbsp;<span class="op" id="6284732">=</span>&nbsp;<span class="ident" id="6284734">index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284744">c</span>&nbsp;<span class="op" id="6284746">+=</span>&nbsp;<span class="ident" id="6284749">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284755">index</span>&nbsp;<span class="op" id="6284761">+=</span>&nbsp;<span class="ident" id="6284764">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6284769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284774">c</span>&nbsp;<span class="op" id="6284776">&lt;&lt;=</span>&nbsp;<span class="num" id="6284780">1</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6284784">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6284787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6284790">return</span>&nbsp;<span class="ident" id="6284797">nil</span><br>
<span class="lineno"></span><span class="op" id="6284801">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="comment" id="6284804">//&nbsp;decodeHuffman&nbsp;returns&nbsp;the&nbsp;next&nbsp;Huffman-coded&nbsp;value&nbsp;from&nbsp;the&nbsp;bit-stream,</span><br>
<span class="lineno"></span><span class="comment" id="6284879">//&nbsp;decoded&nbsp;according&nbsp;to&nbsp;h.</span><br>
<span class="lineno"></span><span class="keyword" id="6284906">func</span>&nbsp;<span class="op" id="6284911">(</span><span class="ident" id="6284912">d</span>&nbsp;<span class="op" id="6284914">*</span><span class="ident" id="6284915">decoder</span><span class="op" id="6284922">)</span>&nbsp;<span class="ident" id="6284924">decodeHuffman</span><span class="op" id="6284937">(</span><span class="ident" id="6284938">h</span>&nbsp;<span class="op" id="6284940">*</span><span class="ident" id="6284941">huffman</span><span class="op" id="6284948">)</span>&nbsp;<span class="op" id="6284950">(</span><span class="builtintype" id="6284951">uint8</span><span class="op" id="6284956">,</span>&nbsp;<span class="builtintype" id="6284958">error</span><span class="op" id="6284963">)</span>&nbsp;<span class="op" id="6284965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6284968">if</span>&nbsp;<span class="ident" id="6284971">h</span><span class="op" id="6284972">.</span><span class="ident" id="6284973">nCodes</span>&nbsp;<span class="op" id="6284980">==</span>&nbsp;<span class="num" id="6284983">0</span>&nbsp;<span class="op" id="6284985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6284989">return</span>&nbsp;<span class="num" id="6284996">0</span><span class="op" id="6284997">,</span>&nbsp;<span class="ident" id="6284999">FormatError</span><span class="op" id="6285010">(</span><span class="string" id="6285011">&#34;uninitialized&nbsp;Huffman&nbsp;table&#34;</span><span class="op" id="6285040">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6285043">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6285047">if</span>&nbsp;<span class="ident" id="6285050">d</span><span class="op" id="6285051">.</span><span class="ident" id="6285052">bits</span><span class="op" id="6285056">.</span><span class="ident" id="6285057">n</span>&nbsp;<span class="op" id="6285059">&lt;</span>&nbsp;<span class="num" id="6285061">8</span>&nbsp;<span class="op" id="6285063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6285067">if</span>&nbsp;<span class="ident" id="6285070">err</span>&nbsp;<span class="op" id="6285074">:=</span>&nbsp;<span class="ident" id="6285077">d</span><span class="op" id="6285078">.</span><span class="ident" id="6285079">ensureNBits</span><span class="op" id="6285090">(</span><span class="num" id="6285091">8</span><span class="op" id="6285092">)</span><span class="op" id="6285093">;</span>&nbsp;<span class="ident" id="6285095">err</span>&nbsp;<span class="op" id="6285099">!=</span>&nbsp;<span class="ident" id="6285102">nil</span>&nbsp;<span class="op" id="6285106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6285111">if</span>&nbsp;<span class="ident" id="6285114">err</span>&nbsp;<span class="op" id="6285118">!=</span>&nbsp;<span class="ident" id="6285121">errMissingFF00</span>&nbsp;<span class="op" id="6285136">&amp;&amp;</span>&nbsp;<span class="ident" id="6285139">err</span>&nbsp;<span class="op" id="6285143">!=</span>&nbsp;<span class="ident" id="6285146">errShortHuffmanData</span>&nbsp;<span class="op" id="6285166">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6285172">return</span>&nbsp;<span class="num" id="6285179">0</span><span class="op" id="6285180">,</span>&nbsp;<span class="ident" id="6285182">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6285189">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6285194">//&nbsp;There&nbsp;are&nbsp;no&nbsp;more&nbsp;bytes&nbsp;of&nbsp;data&nbsp;in&nbsp;this&nbsp;segment,&nbsp;but&nbsp;we&nbsp;may&nbsp;still</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6285266">//&nbsp;be&nbsp;able&nbsp;to&nbsp;read&nbsp;the&nbsp;next&nbsp;symbol&nbsp;out&nbsp;of&nbsp;the&nbsp;previously&nbsp;read&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6285337">//&nbsp;First,&nbsp;undo&nbsp;the&nbsp;readByte&nbsp;that&nbsp;the&nbsp;ensureNBits&nbsp;call&nbsp;made.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6285400">d</span><span class="op" id="6285401">.</span><span class="ident" id="6285402">unreadByteStuffedByte</span><span class="op" id="6285423">(</span><span class="op" id="6285424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6285429">goto</span>&nbsp;<span class="ident" id="6285434">slowPath</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6285445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6285448">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6285451">if</span>&nbsp;<span class="ident" id="6285454">v</span>&nbsp;<span class="op" id="6285456">:=</span>&nbsp;<span class="ident" id="6285459">h</span><span class="op" id="6285460">.</span><span class="ident" id="6285461">lut</span><span class="op" id="6285464">[</span><span class="op" id="6285465">(</span><span class="ident" id="6285466">d</span><span class="op" id="6285467">.</span><span class="ident" id="6285468">bits</span><span class="op" id="6285472">.</span><span class="ident" id="6285473">a</span><span class="op" id="6285474">&gt;&gt;</span><span class="builtintype" id="6285476">uint32</span><span class="op" id="6285482">(</span><span class="ident" id="6285483">d</span><span class="op" id="6285484">.</span><span class="ident" id="6285485">bits</span><span class="op" id="6285489">.</span><span class="ident" id="6285490">n</span><span class="op" id="6285491">-</span><span class="ident" id="6285492">lutSize</span><span class="op" id="6285499">)</span><span class="op" id="6285500">)</span><span class="op" id="6285501">&amp;</span><span class="num" id="6285502">0xff</span><span class="op" id="6285506">]</span><span class="op" id="6285507">;</span>&nbsp;<span class="ident" id="6285509">v</span>&nbsp;<span class="op" id="6285511">!=</span>&nbsp;<span class="num" id="6285514">0</span>&nbsp;<span class="op" id="6285516">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6285520">n</span>&nbsp;<span class="op" id="6285522">:=</span>&nbsp;<span class="op" id="6285525">(</span><span class="ident" id="6285526">v</span>&nbsp;<span class="op" id="6285528">&amp;</span>&nbsp;<span class="num" id="6285530">0xff</span><span class="op" id="6285534">)</span>&nbsp;<span class="op" id="6285536">-</span>&nbsp;<span class="num" id="6285538">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6285542">d</span><span class="op" id="6285543">.</span><span class="ident" id="6285544">bits</span><span class="op" id="6285548">.</span><span class="ident" id="6285549">n</span>&nbsp;<span class="op" id="6285551">-=</span>&nbsp;<span class="builtintype" id="6285554">int32</span><span class="op" id="6285559">(</span><span class="ident" id="6285560">n</span><span class="op" id="6285561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6285565">d</span><span class="op" id="6285566">.</span><span class="ident" id="6285567">bits</span><span class="op" id="6285571">.</span><span class="ident" id="6285572">m</span>&nbsp;<span class="op" id="6285574">&gt;&gt;=</span>&nbsp;<span class="ident" id="6285578">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6285582">return</span>&nbsp;<span class="builtintype" id="6285589">uint8</span><span class="op" id="6285594">(</span><span class="ident" id="6285595">v</span>&nbsp;<span class="op" id="6285597">&gt;&gt;</span>&nbsp;<span class="num" id="6285600">8</span><span class="op" id="6285601">)</span><span class="op" id="6285602">,</span>&nbsp;<span class="ident" id="6285604">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6285609">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="ident" id="6285612">slowPath</span><span class="op" id="6285620">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6285623">for</span>&nbsp;<span class="ident" id="6285627">i</span><span class="op" id="6285628">,</span>&nbsp;<span class="ident" id="6285630">code</span>&nbsp;<span class="op" id="6285635">:=</span>&nbsp;<span class="num" id="6285638">0</span><span class="op" id="6285639">,</span>&nbsp;<span class="builtintype" id="6285641">int32</span><span class="op" id="6285646">(</span><span class="num" id="6285647">0</span><span class="op" id="6285648">)</span><span class="op" id="6285649">;</span>&nbsp;<span class="ident" id="6285651">i</span>&nbsp;<span class="op" id="6285653">&lt;</span>&nbsp;<span class="ident" id="6285655">maxCodeLength</span><span class="op" id="6285668">;</span>&nbsp;<span class="ident" id="6285670">i</span><span class="op" id="6285671">++</span>&nbsp;<span class="op" id="6285674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6285678">if</span>&nbsp;<span class="ident" id="6285681">d</span><span class="op" id="6285682">.</span><span class="ident" id="6285683">bits</span><span class="op" id="6285687">.</span><span class="ident" id="6285688">n</span>&nbsp;<span class="op" id="6285690">==</span>&nbsp;<span class="num" id="6285693">0</span>&nbsp;<span class="op" id="6285695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6285700">if</span>&nbsp;<span class="ident" id="6285703">err</span>&nbsp;<span class="op" id="6285707">:=</span>&nbsp;<span class="ident" id="6285710">d</span><span class="op" id="6285711">.</span><span class="ident" id="6285712">ensureNBits</span><span class="op" id="6285723">(</span><span class="num" id="6285724">1</span><span class="op" id="6285725">)</span><span class="op" id="6285726">;</span>&nbsp;<span class="ident" id="6285728">err</span>&nbsp;<span class="op" id="6285732">!=</span>&nbsp;<span class="ident" id="6285735">nil</span>&nbsp;<span class="op" id="6285739">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6285745">return</span>&nbsp;<span class="num" id="6285752">0</span><span class="op" id="6285753">,</span>&nbsp;<span class="ident" id="6285755">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6285762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6285766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6285770">if</span>&nbsp;<span class="ident" id="6285773">d</span><span class="op" id="6285774">.</span><span class="ident" id="6285775">bits</span><span class="op" id="6285779">.</span><span class="ident" id="6285780">a</span><span class="op" id="6285781">&amp;</span><span class="ident" id="6285782">d</span><span class="op" id="6285783">.</span><span class="ident" id="6285784">bits</span><span class="op" id="6285788">.</span><span class="ident" id="6285789">m</span>&nbsp;<span class="op" id="6285791">!=</span>&nbsp;<span class="num" id="6285794">0</span>&nbsp;<span class="op" id="6285796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6285801">code</span>&nbsp;<span class="op" id="6285806">|=</span>&nbsp;<span class="num" id="6285809">1</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6285813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6285817">d</span><span class="op" id="6285818">.</span><span class="ident" id="6285819">bits</span><span class="op" id="6285823">.</span><span class="ident" id="6285824">n</span><span class="op" id="6285825">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6285830">d</span><span class="op" id="6285831">.</span><span class="ident" id="6285832">bits</span><span class="op" id="6285836">.</span><span class="ident" id="6285837">m</span>&nbsp;<span class="op" id="6285839">&gt;&gt;=</span>&nbsp;<span class="num" id="6285843">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6285847">if</span>&nbsp;<span class="ident" id="6285850">code</span>&nbsp;<span class="op" id="6285855">&lt;=</span>&nbsp;<span class="ident" id="6285858">h</span><span class="op" id="6285859">.</span><span class="ident" id="6285860">maxCodes</span><span class="op" id="6285868">[</span><span class="ident" id="6285869">i</span><span class="op" id="6285870">]</span>&nbsp;<span class="op" id="6285872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6285877">return</span>&nbsp;<span class="ident" id="6285884">h</span><span class="op" id="6285885">.</span><span class="ident" id="6285886">vals</span><span class="op" id="6285890">[</span><span class="ident" id="6285891">h</span><span class="op" id="6285892">.</span><span class="ident" id="6285893">valsIndices</span><span class="op" id="6285904">[</span><span class="ident" id="6285905">i</span><span class="op" id="6285906">]</span><span class="op" id="6285907">+</span><span class="ident" id="6285908">code</span><span class="op" id="6285912">-</span><span class="ident" id="6285913">h</span><span class="op" id="6285914">.</span><span class="ident" id="6285915">minCodes</span><span class="op" id="6285923">[</span><span class="ident" id="6285924">i</span><span class="op" id="6285925">]</span><span class="op" id="6285926">]</span><span class="op" id="6285927">,</span>&nbsp;<span class="ident" id="6285929">nil</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6285935">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6285939">code</span>&nbsp;<span class="op" id="6285944">&lt;&lt;=</span>&nbsp;<span class="num" id="6285948">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6285951">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6285954">return</span>&nbsp;<span class="num" id="6285961">0</span><span class="op" id="6285962">,</span>&nbsp;<span class="ident" id="6285964">FormatError</span><span class="op" id="6285975">(</span><span class="string" id="6285976">&#34;bad&nbsp;Huffman&nbsp;code&#34;</span><span class="op" id="6285994">)</span><br>
<span class="lineno"></span><span class="op" id="6285996">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="keyword" id="6285999">func</span>&nbsp;<span class="op" id="6286004">(</span><span class="ident" id="6286005">d</span>&nbsp;<span class="op" id="6286007">*</span><span class="ident" id="6286008">decoder</span><span class="op" id="6286015">)</span>&nbsp;<span class="ident" id="6286017">decodeBit</span><span class="op" id="6286026">(</span><span class="op" id="6286027">)</span>&nbsp;<span class="op" id="6286029">(</span><span class="builtintype" id="6286030">bool</span><span class="op" id="6286034">,</span>&nbsp;<span class="builtintype" id="6286036">error</span><span class="op" id="6286041">)</span>&nbsp;<span class="op" id="6286043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6286046">if</span>&nbsp;<span class="ident" id="6286049">d</span><span class="op" id="6286050">.</span><span class="ident" id="6286051">bits</span><span class="op" id="6286055">.</span><span class="ident" id="6286056">n</span>&nbsp;<span class="op" id="6286058">==</span>&nbsp;<span class="num" id="6286061">0</span>&nbsp;<span class="op" id="6286063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6286067">if</span>&nbsp;<span class="ident" id="6286070">err</span>&nbsp;<span class="op" id="6286074">:=</span>&nbsp;<span class="ident" id="6286077">d</span><span class="op" id="6286078">.</span><span class="ident" id="6286079">ensureNBits</span><span class="op" id="6286090">(</span><span class="num" id="6286091">1</span><span class="op" id="6286092">)</span><span class="op" id="6286093">;</span>&nbsp;<span class="ident" id="6286095">err</span>&nbsp;<span class="op" id="6286099">!=</span>&nbsp;<span class="ident" id="6286102">nil</span>&nbsp;<span class="op" id="6286106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6286111">return</span>&nbsp;<span class="ident" id="6286118">false</span><span class="op" id="6286123">,</span>&nbsp;<span class="ident" id="6286125">err</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6286131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6286134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6286137">ret</span>&nbsp;<span class="op" id="6286141">:=</span>&nbsp;<span class="ident" id="6286144">d</span><span class="op" id="6286145">.</span><span class="ident" id="6286146">bits</span><span class="op" id="6286150">.</span><span class="ident" id="6286151">a</span><span class="op" id="6286152">&amp;</span><span class="ident" id="6286153">d</span><span class="op" id="6286154">.</span><span class="ident" id="6286155">bits</span><span class="op" id="6286159">.</span><span class="ident" id="6286160">m</span>&nbsp;<span class="op" id="6286162">!=</span>&nbsp;<span class="num" id="6286165">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6286168">d</span><span class="op" id="6286169">.</span><span class="ident" id="6286170">bits</span><span class="op" id="6286174">.</span><span class="ident" id="6286175">n</span><span class="op" id="6286176">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6286180">d</span><span class="op" id="6286181">.</span><span class="ident" id="6286182">bits</span><span class="op" id="6286186">.</span><span class="ident" id="6286187">m</span>&nbsp;<span class="op" id="6286189">&gt;&gt;=</span>&nbsp;<span class="num" id="6286193">1</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6286196">return</span>&nbsp;<span class="ident" id="6286203">ret</span><span class="op" id="6286206">,</span>&nbsp;<span class="ident" id="6286208">nil</span><br>
<span class="lineno"></span><span class="op" id="6286212">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6286215">func</span>&nbsp;<span class="op" id="6286220">(</span><span class="ident" id="6286221">d</span>&nbsp;<span class="op" id="6286223">*</span><span class="ident" id="6286224">decoder</span><span class="op" id="6286231">)</span>&nbsp;<span class="ident" id="6286233">decodeBits</span><span class="op" id="6286243">(</span><span class="ident" id="6286244">n</span>&nbsp;<span class="builtintype" id="6286246">int32</span><span class="op" id="6286251">)</span>&nbsp;<span class="op" id="6286253">(</span><span class="builtintype" id="6286254">uint32</span><span class="op" id="6286260">,</span>&nbsp;<span class="builtintype" id="6286262">error</span><span class="op" id="6286267">)</span>&nbsp;<span class="op" id="6286269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6286272">if</span>&nbsp;<span class="ident" id="6286275">d</span><span class="op" id="6286276">.</span><span class="ident" id="6286277">bits</span><span class="op" id="6286281">.</span><span class="ident" id="6286282">n</span>&nbsp;<span class="op" id="6286284">&lt;</span>&nbsp;<span class="ident" id="6286286">n</span>&nbsp;<span class="op" id="6286288">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6286292">if</span>&nbsp;<span class="ident" id="6286295">err</span>&nbsp;<span class="op" id="6286299">:=</span>&nbsp;<span class="ident" id="6286302">d</span><span class="op" id="6286303">.</span><span class="ident" id="6286304">ensureNBits</span><span class="op" id="6286315">(</span><span class="ident" id="6286316">n</span><span class="op" id="6286317">)</span><span class="op" id="6286318">;</span>&nbsp;<span class="ident" id="6286320">err</span>&nbsp;<span class="op" id="6286324">!=</span>&nbsp;<span class="ident" id="6286327">nil</span>&nbsp;<span class="op" id="6286331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6286336">return</span>&nbsp;<span class="num" id="6286343">0</span><span class="op" id="6286344">,</span>&nbsp;<span class="ident" id="6286346">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6286352">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6286355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6286358">ret</span>&nbsp;<span class="op" id="6286362">:=</span>&nbsp;<span class="ident" id="6286365">d</span><span class="op" id="6286366">.</span><span class="ident" id="6286367">bits</span><span class="op" id="6286371">.</span><span class="ident" id="6286372">a</span>&nbsp;<span class="op" id="6286374">&gt;&gt;</span>&nbsp;<span class="builtintype" id="6286377">uint32</span><span class="op" id="6286383">(</span><span class="ident" id="6286384">d</span><span class="op" id="6286385">.</span><span class="ident" id="6286386">bits</span><span class="op" id="6286390">.</span><span class="ident" id="6286391">n</span><span class="op" id="6286392">-</span><span class="ident" id="6286393">n</span><span class="op" id="6286394">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6286397">ret</span>&nbsp;<span class="op" id="6286401">&amp;=</span>&nbsp;<span class="op" id="6286404">(</span><span class="num" id="6286405">1</span>&nbsp;<span class="op" id="6286407">&lt;&lt;</span>&nbsp;<span class="builtintype" id="6286410">uint32</span><span class="op" id="6286416">(</span><span class="ident" id="6286417">n</span><span class="op" id="6286418">)</span><span class="op" id="6286419">)</span>&nbsp;<span class="op" id="6286421">-</span>&nbsp;<span class="num" id="6286423">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6286426">d</span><span class="op" id="6286427">.</span><span class="ident" id="6286428">bits</span><span class="op" id="6286432">.</span><span class="ident" id="6286433">n</span>&nbsp;<span class="op" id="6286435">-=</span>&nbsp;<span class="ident" id="6286438">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6286441">d</span><span class="op" id="6286442">.</span><span class="ident" id="6286443">bits</span><span class="op" id="6286447">.</span><span class="ident" id="6286448">m</span>&nbsp;<span class="op" id="6286450">&gt;&gt;=</span>&nbsp;<span class="builtintype" id="6286454">uint32</span><span class="op" id="6286460">(</span><span class="ident" id="6286461">n</span><span class="op" id="6286462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6286465">return</span>&nbsp;<span class="ident" id="6286472">ret</span><span class="op" id="6286475">,</span>&nbsp;<span class="ident" id="6286477">nil</span><br>
<span class="lineno"></span><span class="op" id="6286481">}</span>
</div>
</body>
</html>
