<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="6128504">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6128559">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6128613">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6128664">//&nbsp;HTTP&nbsp;reverse&nbsp;proxy&nbsp;handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6128695">package</span>&nbsp;<span class="ident" id="6128703">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6128713">import</span>&nbsp;<span class="op" id="6128720">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6128723">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6128729">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6128736">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6128743">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6128755">&#34;net/url&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6128766">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6128777">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6128785">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6128792">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="6128795">//&nbsp;onExitFlushLoop&nbsp;is&nbsp;a&nbsp;callback&nbsp;set&nbsp;by&nbsp;tests&nbsp;to&nbsp;detect&nbsp;the&nbsp;state&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6128868">//&nbsp;flushLoop()&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="6128894">var</span>&nbsp;<span class="ident" id="6128898">onExitFlushLoop</span>&nbsp;<span class="keyword" id="6128914">func</span><span class="op" id="6128918">(</span><span class="op" id="6128919">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6128922">//&nbsp;ReverseProxy&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;Handler&nbsp;that&nbsp;takes&nbsp;an&nbsp;incoming&nbsp;request&nbsp;and</span><br>
<span class="lineno">25</span><span class="comment" id="6128992">//&nbsp;sends&nbsp;it&nbsp;to&nbsp;another&nbsp;server,&nbsp;proxying&nbsp;the&nbsp;response&nbsp;back&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6129057">//&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="6129068">type</span>&nbsp;<span class="ident" id="6129073">ReverseProxy</span>&nbsp;<span class="keyword" id="6129086">struct</span>&nbsp;<span class="op" id="6129093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6129096">//&nbsp;Director&nbsp;must&nbsp;be&nbsp;a&nbsp;function&nbsp;which&nbsp;modifies</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6129143">//&nbsp;the&nbsp;request&nbsp;into&nbsp;a&nbsp;new&nbsp;request&nbsp;to&nbsp;be&nbsp;sent</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6129189">//&nbsp;using&nbsp;Transport.&nbsp;Its&nbsp;response&nbsp;is&nbsp;then&nbsp;copied</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6129238">//&nbsp;back&nbsp;to&nbsp;the&nbsp;original&nbsp;client&nbsp;unmodified.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6129282">Director</span>&nbsp;<span class="keyword" id="6129291">func</span><span class="op" id="6129295">(</span><span class="op" id="6129296">*</span><span class="ident" id="6129297">http</span><span class="op" id="6129301">.</span><span class="ident" id="6129302">Request</span><span class="op" id="6129309">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6129313">//&nbsp;The&nbsp;transport&nbsp;used&nbsp;to&nbsp;perform&nbsp;proxy&nbsp;requests.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6129363">//&nbsp;If&nbsp;nil,&nbsp;http.DefaultTransport&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6129406">Transport</span>&nbsp;<span class="ident" id="6129416">http</span><span class="op" id="6129420">.</span><span class="ident" id="6129421">RoundTripper</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6129436">//&nbsp;FlushInterval&nbsp;specifies&nbsp;the&nbsp;flush&nbsp;interval</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6129483">//&nbsp;to&nbsp;flush&nbsp;to&nbsp;the&nbsp;client&nbsp;while&nbsp;copying&nbsp;the</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6129528">//&nbsp;response&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6129547">//&nbsp;If&nbsp;zero,&nbsp;no&nbsp;periodic&nbsp;flushing&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6129590">FlushInterval</span>&nbsp;<span class="ident" id="6129604">time</span><span class="op" id="6129608">.</span><span class="ident" id="6129609">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6129620">//&nbsp;ErrorLog&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;logger&nbsp;for&nbsp;errors</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6129673">//&nbsp;that&nbsp;occur&nbsp;when&nbsp;attempting&nbsp;to&nbsp;proxy&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6129726">//&nbsp;If&nbsp;nil,&nbsp;logging&nbsp;goes&nbsp;to&nbsp;os.Stderr&nbsp;via&nbsp;the&nbsp;log&nbsp;package&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6129786">//&nbsp;standard&nbsp;logger.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6129807">ErrorLog</span>&nbsp;<span class="op" id="6129816">*</span><span class="ident" id="6129817">log</span><span class="op" id="6129820">.</span><span class="ident" id="6129821">Logger</span><br>
<span class="lineno"></span><span class="op" id="6129828">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="6129831">func</span>&nbsp;<span class="ident" id="6129836">singleJoiningSlash</span><span class="op" id="6129854">(</span><span class="ident" id="6129855">a</span><span class="op" id="6129856">,</span>&nbsp;<span class="ident" id="6129858">b</span>&nbsp;<span class="builtintype" id="6129860">string</span><span class="op" id="6129866">)</span>&nbsp;<span class="builtintype" id="6129868">string</span>&nbsp;<span class="op" id="6129875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6129878">aslash</span>&nbsp;<span class="op" id="6129885">:=</span>&nbsp;<span class="ident" id="6129888">strings</span><span class="op" id="6129895">.</span><span class="ident" id="6129896">HasSuffix</span><span class="op" id="6129905">(</span><span class="ident" id="6129906">a</span><span class="op" id="6129907">,</span>&nbsp;<span class="string" id="6129909">&#34;/&#34;</span><span class="op" id="6129912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6129915">bslash</span>&nbsp;<span class="op" id="6129922">:=</span>&nbsp;<span class="ident" id="6129925">strings</span><span class="op" id="6129932">.</span><span class="ident" id="6129933">HasPrefix</span><span class="op" id="6129942">(</span><span class="ident" id="6129943">b</span><span class="op" id="6129944">,</span>&nbsp;<span class="string" id="6129946">&#34;/&#34;</span><span class="op" id="6129949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6129952">switch</span>&nbsp;<span class="op" id="6129959">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6129962">case</span>&nbsp;<span class="ident" id="6129967">aslash</span>&nbsp;<span class="op" id="6129974">&amp;&amp;</span>&nbsp;<span class="ident" id="6129977">bslash</span><span class="op" id="6129983">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6129987">return</span>&nbsp;<span class="ident" id="6129994">a</span>&nbsp;<span class="op" id="6129996">+</span>&nbsp;<span class="ident" id="6129998">b</span><span class="op" id="6129999">[</span><span class="num" id="6130000">1</span><span class="op" id="6130001">:</span><span class="op" id="6130002">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6130005">case</span>&nbsp;<span class="op" id="6130010">!</span><span class="ident" id="6130011">aslash</span>&nbsp;<span class="op" id="6130018">&amp;&amp;</span>&nbsp;<span class="op" id="6130021">!</span><span class="ident" id="6130022">bslash</span><span class="op" id="6130028">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6130032">return</span>&nbsp;<span class="ident" id="6130039">a</span>&nbsp;<span class="op" id="6130041">+</span>&nbsp;<span class="string" id="6130043">&#34;/&#34;</span>&nbsp;<span class="op" id="6130047">+</span>&nbsp;<span class="ident" id="6130049">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6130052">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6130055">return</span>&nbsp;<span class="ident" id="6130062">a</span>&nbsp;<span class="op" id="6130064">+</span>&nbsp;<span class="ident" id="6130066">b</span><br>
<span class="lineno"></span><span class="op" id="6130068">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6130071">//&nbsp;NewSingleHostReverseProxy&nbsp;returns&nbsp;a&nbsp;new&nbsp;ReverseProxy&nbsp;that&nbsp;rewrites</span><br>
<span class="lineno"></span><span class="comment" id="6130141">//&nbsp;URLs&nbsp;to&nbsp;the&nbsp;scheme,&nbsp;host,&nbsp;and&nbsp;base&nbsp;path&nbsp;provided&nbsp;in&nbsp;target.&nbsp;If&nbsp;the</span><br>
<span class="lineno">65</span><span class="comment" id="6130211">//&nbsp;target&#39;s&nbsp;path&nbsp;is&nbsp;&#34;/base&#34;&nbsp;and&nbsp;the&nbsp;incoming&nbsp;request&nbsp;was&nbsp;for&nbsp;&#34;/dir&#34;,</span><br>
<span class="lineno"></span><span class="comment" id="6130280">//&nbsp;the&nbsp;target&nbsp;request&nbsp;will&nbsp;be&nbsp;for&nbsp;/base/dir.</span><br>
<span class="lineno"></span><span class="keyword" id="6130325">func</span>&nbsp;<span class="ident" id="6130330">NewSingleHostReverseProxy</span><span class="op" id="6130355">(</span><span class="ident" id="6130356">target</span>&nbsp;<span class="op" id="6130363">*</span><span class="ident" id="6130364">url</span><span class="op" id="6130367">.</span><span class="ident" id="6130368">URL</span><span class="op" id="6130371">)</span>&nbsp;<span class="op" id="6130373">*</span><span class="ident" id="6130374">ReverseProxy</span>&nbsp;<span class="op" id="6130387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6130390">targetQuery</span>&nbsp;<span class="op" id="6130402">:=</span>&nbsp;<span class="ident" id="6130405">target</span><span class="op" id="6130411">.</span><span class="ident" id="6130412">RawQuery</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6130422">director</span>&nbsp;<span class="op" id="6130431">:=</span>&nbsp;<span class="keyword" id="6130434">func</span><span class="op" id="6130438">(</span><span class="ident" id="6130439">req</span>&nbsp;<span class="op" id="6130443">*</span><span class="ident" id="6130444">http</span><span class="op" id="6130448">.</span><span class="ident" id="6130449">Request</span><span class="op" id="6130456">)</span>&nbsp;<span class="op" id="6130458">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6130462">req</span><span class="op" id="6130465">.</span><span class="ident" id="6130466">URL</span><span class="op" id="6130469">.</span><span class="ident" id="6130470">Scheme</span>&nbsp;<span class="op" id="6130477">=</span>&nbsp;<span class="ident" id="6130479">target</span><span class="op" id="6130485">.</span><span class="ident" id="6130486">Scheme</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6130495">req</span><span class="op" id="6130498">.</span><span class="ident" id="6130499">URL</span><span class="op" id="6130502">.</span><span class="ident" id="6130503">Host</span>&nbsp;<span class="op" id="6130508">=</span>&nbsp;<span class="ident" id="6130510">target</span><span class="op" id="6130516">.</span><span class="ident" id="6130517">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6130524">req</span><span class="op" id="6130527">.</span><span class="ident" id="6130528">URL</span><span class="op" id="6130531">.</span><span class="ident" id="6130532">Path</span>&nbsp;<span class="op" id="6130537">=</span>&nbsp;<span class="ident" id="6130539">singleJoiningSlash</span><span class="op" id="6130557">(</span><span class="ident" id="6130558">target</span><span class="op" id="6130564">.</span><span class="ident" id="6130565">Path</span><span class="op" id="6130569">,</span>&nbsp;<span class="ident" id="6130571">req</span><span class="op" id="6130574">.</span><span class="ident" id="6130575">URL</span><span class="op" id="6130578">.</span><span class="ident" id="6130579">Path</span><span class="op" id="6130583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6130587">if</span>&nbsp;<span class="ident" id="6130590">targetQuery</span>&nbsp;<span class="op" id="6130602">==</span>&nbsp;<span class="string" id="6130605">&#34;&#34;</span>&nbsp;<span class="op" id="6130608">||</span>&nbsp;<span class="ident" id="6130611">req</span><span class="op" id="6130614">.</span><span class="ident" id="6130615">URL</span><span class="op" id="6130618">.</span><span class="ident" id="6130619">RawQuery</span>&nbsp;<span class="op" id="6130628">==</span>&nbsp;<span class="string" id="6130631">&#34;&#34;</span>&nbsp;<span class="op" id="6130634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6130639">req</span><span class="op" id="6130642">.</span><span class="ident" id="6130643">URL</span><span class="op" id="6130646">.</span><span class="ident" id="6130647">RawQuery</span>&nbsp;<span class="op" id="6130656">=</span>&nbsp;<span class="ident" id="6130658">targetQuery</span>&nbsp;<span class="op" id="6130670">+</span>&nbsp;<span class="ident" id="6130672">req</span><span class="op" id="6130675">.</span><span class="ident" id="6130676">URL</span><span class="op" id="6130679">.</span><span class="ident" id="6130680">RawQuery</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6130691">}</span>&nbsp;<span class="keyword" id="6130693">else</span>&nbsp;<span class="op" id="6130698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6130703">req</span><span class="op" id="6130706">.</span><span class="ident" id="6130707">URL</span><span class="op" id="6130710">.</span><span class="ident" id="6130711">RawQuery</span>&nbsp;<span class="op" id="6130720">=</span>&nbsp;<span class="ident" id="6130722">targetQuery</span>&nbsp;<span class="op" id="6130734">+</span>&nbsp;<span class="string" id="6130736">&#34;&amp;&#34;</span>&nbsp;<span class="op" id="6130740">+</span>&nbsp;<span class="ident" id="6130742">req</span><span class="op" id="6130745">.</span><span class="ident" id="6130746">URL</span><span class="op" id="6130749">.</span><span class="ident" id="6130750">RawQuery</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6130761">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6130764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6130767">return</span>&nbsp;<span class="op" id="6130774">&amp;</span><span class="ident" id="6130775">ReverseProxy</span><span class="op" id="6130787">{</span><span class="ident" id="6130788">Director</span><span class="op" id="6130796">:</span>&nbsp;<span class="ident" id="6130798">director</span><span class="op" id="6130806">}</span><br>
<span class="lineno">80</span><span class="op" id="6130808">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6130811">func</span>&nbsp;<span class="ident" id="6130816">copyHeader</span><span class="op" id="6130826">(</span><span class="ident" id="6130827">dst</span><span class="op" id="6130830">,</span>&nbsp;<span class="ident" id="6130832">src</span>&nbsp;<span class="ident" id="6130836">http</span><span class="op" id="6130840">.</span><span class="ident" id="6130841">Header</span><span class="op" id="6130847">)</span>&nbsp;<span class="op" id="6130849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6130852">for</span>&nbsp;<span class="ident" id="6130856">k</span><span class="op" id="6130857">,</span>&nbsp;<span class="ident" id="6130859">vv</span>&nbsp;<span class="op" id="6130862">:=</span>&nbsp;<span class="keyword" id="6130865">range</span>&nbsp;<span class="ident" id="6130871">src</span>&nbsp;<span class="op" id="6130875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6130879">for</span>&nbsp;<span class="ident" id="6130883">_</span><span class="op" id="6130884">,</span>&nbsp;<span class="ident" id="6130886">v</span>&nbsp;<span class="op" id="6130888">:=</span>&nbsp;<span class="keyword" id="6130891">range</span>&nbsp;<span class="ident" id="6130897">vv</span>&nbsp;<span class="op" id="6130900">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6130905">dst</span><span class="op" id="6130908">.</span><span class="ident" id="6130909">Add</span><span class="op" id="6130912">(</span><span class="ident" id="6130913">k</span><span class="op" id="6130914">,</span>&nbsp;<span class="ident" id="6130916">v</span><span class="op" id="6130917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6130921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6130924">}</span><br>
<span class="lineno"></span><span class="op" id="6130926">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="6130929">//&nbsp;Hop-by-hop&nbsp;headers.&nbsp;These&nbsp;are&nbsp;removed&nbsp;when&nbsp;sent&nbsp;to&nbsp;the&nbsp;backend.</span><br>
<span class="lineno"></span><span class="comment" id="6130996">//&nbsp;http://www.w3.org/Protocols/rfc2616/rfc2616-sec13.html</span><br>
<span class="lineno"></span><span class="keyword" id="6131054">var</span>&nbsp;<span class="ident" id="6131058">hopHeaders</span>&nbsp;<span class="op" id="6131069">=</span>&nbsp;<span class="op" id="6131071">[</span><span class="op" id="6131072">]</span><span class="builtintype" id="6131073">string</span><span class="op" id="6131079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6131082">&#34;Connection&#34;</span><span class="op" id="6131094">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6131097">&#34;Keep-Alive&#34;</span><span class="op" id="6131109">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6131112">&#34;Proxy-Authenticate&#34;</span><span class="op" id="6131132">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6131135">&#34;Proxy-Authorization&#34;</span><span class="op" id="6131156">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6131159">&#34;Te&#34;</span><span class="op" id="6131163">,</span>&nbsp;<span class="comment" id="6131165">//&nbsp;canonicalized&nbsp;version&nbsp;of&nbsp;&#34;TE&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6131199">&#34;Trailers&#34;</span><span class="op" id="6131209">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6131212">&#34;Transfer-Encoding&#34;</span><span class="op" id="6131231">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6131234">&#34;Upgrade&#34;</span><span class="op" id="6131243">,</span><br>
<span class="lineno"></span><span class="op" id="6131245">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6131248">func</span>&nbsp;<span class="op" id="6131253">(</span><span class="ident" id="6131254">p</span>&nbsp;<span class="op" id="6131256">*</span><span class="ident" id="6131257">ReverseProxy</span><span class="op" id="6131269">)</span>&nbsp;<span class="ident" id="6131271">ServeHTTP</span><span class="op" id="6131280">(</span><span class="ident" id="6131281">rw</span>&nbsp;<span class="ident" id="6131284">http</span><span class="op" id="6131288">.</span><span class="ident" id="6131289">ResponseWriter</span><span class="op" id="6131303">,</span>&nbsp;<span class="ident" id="6131305">req</span>&nbsp;<span class="op" id="6131309">*</span><span class="ident" id="6131310">http</span><span class="op" id="6131314">.</span><span class="ident" id="6131315">Request</span><span class="op" id="6131322">)</span>&nbsp;<span class="op" id="6131324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6131327">transport</span>&nbsp;<span class="op" id="6131337">:=</span>&nbsp;<span class="ident" id="6131340">p</span><span class="op" id="6131341">.</span><span class="ident" id="6131342">Transport</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6131353">if</span>&nbsp;<span class="ident" id="6131356">transport</span>&nbsp;<span class="op" id="6131366">==</span>&nbsp;<span class="ident" id="6131369">nil</span>&nbsp;<span class="op" id="6131373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6131377">transport</span>&nbsp;<span class="op" id="6131387">=</span>&nbsp;<span class="ident" id="6131389">http</span><span class="op" id="6131393">.</span><span class="ident" id="6131394">DefaultTransport</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6131412">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6131416">outreq</span>&nbsp;<span class="op" id="6131423">:=</span>&nbsp;<span class="builtinfunc" id="6131426">new</span><span class="op" id="6131429">(</span><span class="ident" id="6131430">http</span><span class="op" id="6131434">.</span><span class="ident" id="6131435">Request</span><span class="op" id="6131442">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6131445">*</span><span class="ident" id="6131446">outreq</span>&nbsp;<span class="op" id="6131453">=</span>&nbsp;<span class="op" id="6131455">*</span><span class="ident" id="6131456">req</span>&nbsp;<span class="comment" id="6131460">//&nbsp;includes&nbsp;shallow&nbsp;copies&nbsp;of&nbsp;maps,&nbsp;but&nbsp;okay</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6131507">p</span><span class="op" id="6131508">.</span><span class="ident" id="6131509">Director</span><span class="op" id="6131517">(</span><span class="ident" id="6131518">outreq</span><span class="op" id="6131524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6131527">outreq</span><span class="op" id="6131533">.</span><span class="ident" id="6131534">Proto</span>&nbsp;<span class="op" id="6131540">=</span>&nbsp;<span class="string" id="6131542">&#34;HTTP/1.1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6131554">outreq</span><span class="op" id="6131560">.</span><span class="ident" id="6131561">ProtoMajor</span>&nbsp;<span class="op" id="6131572">=</span>&nbsp;<span class="num" id="6131574">1</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6131577">outreq</span><span class="op" id="6131583">.</span><span class="ident" id="6131584">ProtoMinor</span>&nbsp;<span class="op" id="6131595">=</span>&nbsp;<span class="num" id="6131597">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6131600">outreq</span><span class="op" id="6131606">.</span><span class="ident" id="6131607">Close</span>&nbsp;<span class="op" id="6131613">=</span>&nbsp;<span class="ident" id="6131615">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6131623">//&nbsp;Remove&nbsp;hop-by-hop&nbsp;headers&nbsp;to&nbsp;the&nbsp;backend.&nbsp;&nbsp;Especially</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6131681">//&nbsp;important&nbsp;is&nbsp;&#34;Connection&#34;&nbsp;because&nbsp;we&nbsp;want&nbsp;a&nbsp;persistent</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6131740">//&nbsp;connection,&nbsp;regardless&nbsp;of&nbsp;what&nbsp;the&nbsp;client&nbsp;sent&nbsp;to&nbsp;us.&nbsp;&nbsp;This</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6131804">//&nbsp;is&nbsp;modifying&nbsp;the&nbsp;same&nbsp;underlying&nbsp;map&nbsp;from&nbsp;req&nbsp;(shallow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6131863">//&nbsp;copied&nbsp;above)&nbsp;so&nbsp;we&nbsp;only&nbsp;copy&nbsp;it&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6131914">copiedHeaders</span>&nbsp;<span class="op" id="6131928">:=</span>&nbsp;<span class="ident" id="6131931">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6131938">for</span>&nbsp;<span class="ident" id="6131942">_</span><span class="op" id="6131943">,</span>&nbsp;<span class="ident" id="6131945">h</span>&nbsp;<span class="op" id="6131947">:=</span>&nbsp;<span class="keyword" id="6131950">range</span>&nbsp;<span class="ident" id="6131956">hopHeaders</span>&nbsp;<span class="op" id="6131967">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6131971">if</span>&nbsp;<span class="ident" id="6131974">outreq</span><span class="op" id="6131980">.</span><span class="ident" id="6131981">Header</span><span class="op" id="6131987">.</span><span class="ident" id="6131988">Get</span><span class="op" id="6131991">(</span><span class="ident" id="6131992">h</span><span class="op" id="6131993">)</span>&nbsp;<span class="op" id="6131995">!=</span>&nbsp;<span class="string" id="6131998">&#34;&#34;</span>&nbsp;<span class="op" id="6132001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6132006">if</span>&nbsp;<span class="op" id="6132009">!</span><span class="ident" id="6132010">copiedHeaders</span>&nbsp;<span class="op" id="6132024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6132030">outreq</span><span class="op" id="6132036">.</span><span class="ident" id="6132037">Header</span>&nbsp;<span class="op" id="6132044">=</span>&nbsp;<span class="builtinfunc" id="6132046">make</span><span class="op" id="6132050">(</span><span class="ident" id="6132051">http</span><span class="op" id="6132055">.</span><span class="ident" id="6132056">Header</span><span class="op" id="6132062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6132068">copyHeader</span><span class="op" id="6132078">(</span><span class="ident" id="6132079">outreq</span><span class="op" id="6132085">.</span><span class="ident" id="6132086">Header</span><span class="op" id="6132092">,</span>&nbsp;<span class="ident" id="6132094">req</span><span class="op" id="6132097">.</span><span class="ident" id="6132098">Header</span><span class="op" id="6132104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6132110">copiedHeaders</span>&nbsp;<span class="op" id="6132124">=</span>&nbsp;<span class="ident" id="6132126">true</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6132134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6132139">outreq</span><span class="op" id="6132145">.</span><span class="ident" id="6132146">Header</span><span class="op" id="6132152">.</span><span class="ident" id="6132153">Del</span><span class="op" id="6132156">(</span><span class="ident" id="6132157">h</span><span class="op" id="6132158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6132162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6132165">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6132169">if</span>&nbsp;<span class="ident" id="6132172">clientIP</span><span class="op" id="6132180">,</span>&nbsp;<span class="ident" id="6132182">_</span><span class="op" id="6132183">,</span>&nbsp;<span class="ident" id="6132185">err</span>&nbsp;<span class="op" id="6132189">:=</span>&nbsp;<span class="ident" id="6132192">net</span><span class="op" id="6132195">.</span><span class="ident" id="6132196">SplitHostPort</span><span class="op" id="6132209">(</span><span class="ident" id="6132210">req</span><span class="op" id="6132213">.</span><span class="ident" id="6132214">RemoteAddr</span><span class="op" id="6132224">)</span><span class="op" id="6132225">;</span>&nbsp;<span class="ident" id="6132227">err</span>&nbsp;<span class="op" id="6132231">==</span>&nbsp;<span class="ident" id="6132234">nil</span>&nbsp;<span class="op" id="6132238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6132242">//&nbsp;If&nbsp;we&nbsp;aren&#39;t&nbsp;the&nbsp;first&nbsp;proxy&nbsp;retain&nbsp;prior</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6132289">//&nbsp;X-Forwarded-For&nbsp;information&nbsp;as&nbsp;a&nbsp;comma+space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6132339">//&nbsp;separated&nbsp;list&nbsp;and&nbsp;fold&nbsp;multiple&nbsp;headers&nbsp;into&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6132395">if</span>&nbsp;<span class="ident" id="6132398">prior</span><span class="op" id="6132403">,</span>&nbsp;<span class="ident" id="6132405">ok</span>&nbsp;<span class="op" id="6132408">:=</span>&nbsp;<span class="ident" id="6132411">outreq</span><span class="op" id="6132417">.</span><span class="ident" id="6132418">Header</span><span class="op" id="6132424">[</span><span class="string" id="6132425">&#34;X-Forwarded-For&#34;</span><span class="op" id="6132442">]</span><span class="op" id="6132443">;</span>&nbsp;<span class="ident" id="6132445">ok</span>&nbsp;<span class="op" id="6132448">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6132453">clientIP</span>&nbsp;<span class="op" id="6132462">=</span>&nbsp;<span class="ident" id="6132464">strings</span><span class="op" id="6132471">.</span><span class="ident" id="6132472">Join</span><span class="op" id="6132476">(</span><span class="ident" id="6132477">prior</span><span class="op" id="6132482">,</span>&nbsp;<span class="string" id="6132484">&#34;,&nbsp;&#34;</span><span class="op" id="6132488">)</span>&nbsp;<span class="op" id="6132490">+</span>&nbsp;<span class="string" id="6132492">&#34;,&nbsp;&#34;</span>&nbsp;<span class="op" id="6132497">+</span>&nbsp;<span class="ident" id="6132499">clientIP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6132510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6132514">outreq</span><span class="op" id="6132520">.</span><span class="ident" id="6132521">Header</span><span class="op" id="6132527">.</span><span class="ident" id="6132528">Set</span><span class="op" id="6132531">(</span><span class="string" id="6132532">&#34;X-Forwarded-For&#34;</span><span class="op" id="6132549">,</span>&nbsp;<span class="ident" id="6132551">clientIP</span><span class="op" id="6132559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6132562">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6132566">res</span><span class="op" id="6132569">,</span>&nbsp;<span class="ident" id="6132571">err</span>&nbsp;<span class="op" id="6132575">:=</span>&nbsp;<span class="ident" id="6132578">transport</span><span class="op" id="6132587">.</span><span class="ident" id="6132588">RoundTrip</span><span class="op" id="6132597">(</span><span class="ident" id="6132598">outreq</span><span class="op" id="6132604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6132607">if</span>&nbsp;<span class="ident" id="6132610">err</span>&nbsp;<span class="op" id="6132614">!=</span>&nbsp;<span class="ident" id="6132617">nil</span>&nbsp;<span class="op" id="6132621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6132625">p</span><span class="op" id="6132626">.</span><span class="ident" id="6132627">logf</span><span class="op" id="6132631">(</span><span class="string" id="6132632">&#34;http:&nbsp;proxy&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="6132655">,</span>&nbsp;<span class="ident" id="6132657">err</span><span class="op" id="6132660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6132664">rw</span><span class="op" id="6132666">.</span><span class="ident" id="6132667">WriteHeader</span><span class="op" id="6132678">(</span><span class="ident" id="6132679">http</span><span class="op" id="6132683">.</span><span class="ident" id="6132684">StatusInternalServerError</span><span class="op" id="6132709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6132713">return</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6132721">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6132724">defer</span>&nbsp;<span class="ident" id="6132730">res</span><span class="op" id="6132733">.</span><span class="ident" id="6132734">Body</span><span class="op" id="6132738">.</span><span class="ident" id="6132739">Close</span><span class="op" id="6132744">(</span><span class="op" id="6132745">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6132749">for</span>&nbsp;<span class="ident" id="6132753">_</span><span class="op" id="6132754">,</span>&nbsp;<span class="ident" id="6132756">h</span>&nbsp;<span class="op" id="6132758">:=</span>&nbsp;<span class="keyword" id="6132761">range</span>&nbsp;<span class="ident" id="6132767">hopHeaders</span>&nbsp;<span class="op" id="6132778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6132782">res</span><span class="op" id="6132785">.</span><span class="ident" id="6132786">Header</span><span class="op" id="6132792">.</span><span class="ident" id="6132793">Del</span><span class="op" id="6132796">(</span><span class="ident" id="6132797">h</span><span class="op" id="6132798">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6132801">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6132805">copyHeader</span><span class="op" id="6132815">(</span><span class="ident" id="6132816">rw</span><span class="op" id="6132818">.</span><span class="ident" id="6132819">Header</span><span class="op" id="6132825">(</span><span class="op" id="6132826">)</span><span class="op" id="6132827">,</span>&nbsp;<span class="ident" id="6132829">res</span><span class="op" id="6132832">.</span><span class="ident" id="6132833">Header</span><span class="op" id="6132839">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6132843">rw</span><span class="op" id="6132845">.</span><span class="ident" id="6132846">WriteHeader</span><span class="op" id="6132857">(</span><span class="ident" id="6132858">res</span><span class="op" id="6132861">.</span><span class="ident" id="6132862">StatusCode</span><span class="op" id="6132872">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6132875">p</span><span class="op" id="6132876">.</span><span class="ident" id="6132877">copyResponse</span><span class="op" id="6132889">(</span><span class="ident" id="6132890">rw</span><span class="op" id="6132892">,</span>&nbsp;<span class="ident" id="6132894">res</span><span class="op" id="6132897">.</span><span class="ident" id="6132898">Body</span><span class="op" id="6132902">)</span><br>
<span class="lineno"></span><span class="op" id="6132904">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6132907">func</span>&nbsp;<span class="op" id="6132912">(</span><span class="ident" id="6132913">p</span>&nbsp;<span class="op" id="6132915">*</span><span class="ident" id="6132916">ReverseProxy</span><span class="op" id="6132928">)</span>&nbsp;<span class="ident" id="6132930">copyResponse</span><span class="op" id="6132942">(</span><span class="ident" id="6132943">dst</span>&nbsp;<span class="ident" id="6132947">io</span><span class="op" id="6132949">.</span><span class="ident" id="6132950">Writer</span><span class="op" id="6132956">,</span>&nbsp;<span class="ident" id="6132958">src</span>&nbsp;<span class="ident" id="6132962">io</span><span class="op" id="6132964">.</span><span class="ident" id="6132965">Reader</span><span class="op" id="6132971">)</span>&nbsp;<span class="op" id="6132973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6132976">if</span>&nbsp;<span class="ident" id="6132979">p</span><span class="op" id="6132980">.</span><span class="ident" id="6132981">FlushInterval</span>&nbsp;<span class="op" id="6132995">!=</span>&nbsp;<span class="num" id="6132998">0</span>&nbsp;<span class="op" id="6133000">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6133004">if</span>&nbsp;<span class="ident" id="6133007">wf</span><span class="op" id="6133009">,</span>&nbsp;<span class="ident" id="6133011">ok</span>&nbsp;<span class="op" id="6133014">:=</span>&nbsp;<span class="ident" id="6133017">dst</span><span class="op" id="6133020">.</span><span class="op" id="6133021">(</span><span class="ident" id="6133022">writeFlusher</span><span class="op" id="6133034">)</span><span class="op" id="6133035">;</span>&nbsp;<span class="ident" id="6133037">ok</span>&nbsp;<span class="op" id="6133040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6133045">mlw</span>&nbsp;<span class="op" id="6133049">:=</span>&nbsp;<span class="op" id="6133052">&amp;</span><span class="ident" id="6133053">maxLatencyWriter</span><span class="op" id="6133069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6133075">dst</span><span class="op" id="6133078">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6133084">wf</span><span class="op" id="6133086">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6133092">latency</span><span class="op" id="6133099">:</span>&nbsp;<span class="ident" id="6133101">p</span><span class="op" id="6133102">.</span><span class="ident" id="6133103">FlushInterval</span><span class="op" id="6133116">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6133122">done</span><span class="op" id="6133126">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6133131">make</span><span class="op" id="6133135">(</span><span class="keyword" id="6133136">chan</span>&nbsp;<span class="builtintype" id="6133141">bool</span><span class="op" id="6133145">)</span><span class="op" id="6133146">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6133151">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6133156">go</span>&nbsp;<span class="ident" id="6133159">mlw</span><span class="op" id="6133162">.</span><span class="ident" id="6133163">flushLoop</span><span class="op" id="6133172">(</span><span class="op" id="6133173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6133178">defer</span>&nbsp;<span class="ident" id="6133184">mlw</span><span class="op" id="6133187">.</span><span class="ident" id="6133188">stop</span><span class="op" id="6133192">(</span><span class="op" id="6133193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6133198">dst</span>&nbsp;<span class="op" id="6133202">=</span>&nbsp;<span class="ident" id="6133204">mlw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6133210">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6133213">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6133217">io</span><span class="op" id="6133219">.</span><span class="ident" id="6133220">Copy</span><span class="op" id="6133224">(</span><span class="ident" id="6133225">dst</span><span class="op" id="6133228">,</span>&nbsp;<span class="ident" id="6133230">src</span><span class="op" id="6133233">)</span><br>
<span class="lineno"></span><span class="op" id="6133235">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="6133238">func</span>&nbsp;<span class="op" id="6133243">(</span><span class="ident" id="6133244">p</span>&nbsp;<span class="op" id="6133246">*</span><span class="ident" id="6133247">ReverseProxy</span><span class="op" id="6133259">)</span>&nbsp;<span class="ident" id="6133261">logf</span><span class="op" id="6133265">(</span><span class="ident" id="6133266">format</span>&nbsp;<span class="builtintype" id="6133273">string</span><span class="op" id="6133279">,</span>&nbsp;<span class="ident" id="6133281">args</span>&nbsp;<span class="op" id="6133286">...</span><span class="keyword" id="6133289">interface</span><span class="op" id="6133298">{</span><span class="op" id="6133299">}</span><span class="op" id="6133300">)</span>&nbsp;<span class="op" id="6133302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6133305">if</span>&nbsp;<span class="ident" id="6133308">p</span><span class="op" id="6133309">.</span><span class="ident" id="6133310">ErrorLog</span>&nbsp;<span class="op" id="6133319">!=</span>&nbsp;<span class="ident" id="6133322">nil</span>&nbsp;<span class="op" id="6133326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6133330">p</span><span class="op" id="6133331">.</span><span class="ident" id="6133332">ErrorLog</span><span class="op" id="6133340">.</span><span class="ident" id="6133341">Printf</span><span class="op" id="6133347">(</span><span class="ident" id="6133348">format</span><span class="op" id="6133354">,</span>&nbsp;<span class="ident" id="6133356">args</span><span class="op" id="6133360">...</span><span class="op" id="6133363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6133366">}</span>&nbsp;<span class="keyword" id="6133368">else</span>&nbsp;<span class="op" id="6133373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6133377">log</span><span class="op" id="6133380">.</span><span class="ident" id="6133381">Printf</span><span class="op" id="6133387">(</span><span class="ident" id="6133388">format</span><span class="op" id="6133394">,</span>&nbsp;<span class="ident" id="6133396">args</span><span class="op" id="6133400">...</span><span class="op" id="6133403">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6133406">}</span><br>
<span class="lineno"></span><span class="op" id="6133408">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6133411">type</span>&nbsp;<span class="ident" id="6133416">writeFlusher</span>&nbsp;<span class="keyword" id="6133429">interface</span>&nbsp;<span class="op" id="6133439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6133442">io</span><span class="op" id="6133444">.</span><span class="ident" id="6133445">Writer</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6133453">http</span><span class="op" id="6133457">.</span><span class="ident" id="6133458">Flusher</span><br>
<span class="lineno"></span><span class="op" id="6133466">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6133469">type</span>&nbsp;<span class="ident" id="6133474">maxLatencyWriter</span>&nbsp;<span class="keyword" id="6133491">struct</span>&nbsp;<span class="op" id="6133498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6133501">dst</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6133509">writeFlusher</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6133523">latency</span>&nbsp;<span class="ident" id="6133531">time</span><span class="op" id="6133535">.</span><span class="ident" id="6133536">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6133547">lk</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6133552">sync</span><span class="op" id="6133556">.</span><span class="ident" id="6133557">Mutex</span>&nbsp;<span class="comment" id="6133563">//&nbsp;protects&nbsp;Write&nbsp;+&nbsp;Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6133590">done</span>&nbsp;<span class="keyword" id="6133595">chan</span>&nbsp;<span class="builtintype" id="6133600">bool</span><br>
<span class="lineno"></span><span class="op" id="6133605">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="keyword" id="6133608">func</span>&nbsp;<span class="op" id="6133613">(</span><span class="ident" id="6133614">m</span>&nbsp;<span class="op" id="6133616">*</span><span class="ident" id="6133617">maxLatencyWriter</span><span class="op" id="6133633">)</span>&nbsp;<span class="ident" id="6133635">Write</span><span class="op" id="6133640">(</span><span class="ident" id="6133641">p</span>&nbsp;<span class="op" id="6133643">[</span><span class="op" id="6133644">]</span><span class="builtintype" id="6133645">byte</span><span class="op" id="6133649">)</span>&nbsp;<span class="op" id="6133651">(</span><span class="builtintype" id="6133652">int</span><span class="op" id="6133655">,</span>&nbsp;<span class="builtintype" id="6133657">error</span><span class="op" id="6133662">)</span>&nbsp;<span class="op" id="6133664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6133667">m</span><span class="op" id="6133668">.</span><span class="ident" id="6133669">lk</span><span class="op" id="6133671">.</span><span class="ident" id="6133672">Lock</span><span class="op" id="6133676">(</span><span class="op" id="6133677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6133680">defer</span>&nbsp;<span class="ident" id="6133686">m</span><span class="op" id="6133687">.</span><span class="ident" id="6133688">lk</span><span class="op" id="6133690">.</span><span class="ident" id="6133691">Unlock</span><span class="op" id="6133697">(</span><span class="op" id="6133698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6133701">return</span>&nbsp;<span class="ident" id="6133708">m</span><span class="op" id="6133709">.</span><span class="ident" id="6133710">dst</span><span class="op" id="6133713">.</span><span class="ident" id="6133714">Write</span><span class="op" id="6133719">(</span><span class="ident" id="6133720">p</span><span class="op" id="6133721">)</span><br>
<span class="lineno">205</span><span class="op" id="6133723">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6133726">func</span>&nbsp;<span class="op" id="6133731">(</span><span class="ident" id="6133732">m</span>&nbsp;<span class="op" id="6133734">*</span><span class="ident" id="6133735">maxLatencyWriter</span><span class="op" id="6133751">)</span>&nbsp;<span class="ident" id="6133753">flushLoop</span><span class="op" id="6133762">(</span><span class="op" id="6133763">)</span>&nbsp;<span class="op" id="6133765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6133768">t</span>&nbsp;<span class="op" id="6133770">:=</span>&nbsp;<span class="ident" id="6133773">time</span><span class="op" id="6133777">.</span><span class="ident" id="6133778">NewTicker</span><span class="op" id="6133787">(</span><span class="ident" id="6133788">m</span><span class="op" id="6133789">.</span><span class="ident" id="6133790">latency</span><span class="op" id="6133797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6133800">defer</span>&nbsp;<span class="ident" id="6133806">t</span><span class="op" id="6133807">.</span><span class="ident" id="6133808">Stop</span><span class="op" id="6133812">(</span><span class="op" id="6133813">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6133816">for</span>&nbsp;<span class="op" id="6133820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6133824">select</span>&nbsp;<span class="op" id="6133831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6133835">case</span>&nbsp;<span class="op" id="6133840">&lt;-</span><span class="ident" id="6133842">m</span><span class="op" id="6133843">.</span><span class="ident" id="6133844">done</span><span class="op" id="6133848">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6133853">if</span>&nbsp;<span class="ident" id="6133856">onExitFlushLoop</span>&nbsp;<span class="op" id="6133872">!=</span>&nbsp;<span class="ident" id="6133875">nil</span>&nbsp;<span class="op" id="6133879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6133885">onExitFlushLoop</span><span class="op" id="6133900">(</span><span class="op" id="6133901">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6133906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6133911">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6133920">case</span>&nbsp;<span class="op" id="6133925">&lt;-</span><span class="ident" id="6133927">t</span><span class="op" id="6133928">.</span><span class="ident" id="6133929">C</span><span class="op" id="6133930">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6133935">m</span><span class="op" id="6133936">.</span><span class="ident" id="6133937">lk</span><span class="op" id="6133939">.</span><span class="ident" id="6133940">Lock</span><span class="op" id="6133944">(</span><span class="op" id="6133945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6133950">m</span><span class="op" id="6133951">.</span><span class="ident" id="6133952">dst</span><span class="op" id="6133955">.</span><span class="ident" id="6133956">Flush</span><span class="op" id="6133961">(</span><span class="op" id="6133962">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6133967">m</span><span class="op" id="6133968">.</span><span class="ident" id="6133969">lk</span><span class="op" id="6133971">.</span><span class="ident" id="6133972">Unlock</span><span class="op" id="6133978">(</span><span class="op" id="6133979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6133983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6133986">}</span><br>
<span class="lineno"></span><span class="op" id="6133988">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="6133991">func</span>&nbsp;<span class="op" id="6133996">(</span><span class="ident" id="6133997">m</span>&nbsp;<span class="op" id="6133999">*</span><span class="ident" id="6134000">maxLatencyWriter</span><span class="op" id="6134016">)</span>&nbsp;<span class="ident" id="6134018">stop</span><span class="op" id="6134022">(</span><span class="op" id="6134023">)</span>&nbsp;<span class="op" id="6134025">{</span>&nbsp;<span class="ident" id="6134027">m</span><span class="op" id="6134028">.</span><span class="ident" id="6134029">done</span>&nbsp;<span class="op" id="6134034">&lt;-</span>&nbsp;<span class="ident" id="6134037">true</span>&nbsp;<span class="op" id="6134042">}</span>
</div>
</body>
</html>
